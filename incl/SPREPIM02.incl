*          DATA SET SPREPIM02  AT LEVEL 029 AS OF 05/01/02                      
         TITLE 'SPREPIM02 DETAIL MISSED/MAKEGOOD REPORT'                        
SPIM02   CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 0,SPIM02                                                         
         L     RA,0(R1)                                                         
         LA    RC,2048(RA)                                                      
         LA    RC,2048(RC)                                                      
         USING SPWORKD,RA,RC                                                    
         LA    R2,2048(RB)                                                      
         LA    R2,2048(R2)                                                      
         USING SPIM02+4096,R2                                                   
         STM   RA,RC,SPIMRA                                                     
         ST    R2,SPIMR2                                                        
         SPACE 2                                                                
         CLI   MODE,REQFRST                                                     
         BE    IMRQF                                                            
         CLI   MODE,PROCBUY                                                     
         BE    IMBY                                                             
         CLI   MODE,ESTFRST                                                     
         BNE   IMSFRST                                                          
         MVC   SVREQPRD,QPRD                                                    
         MVC   QPRD,=C'POL'                                                     
         GOTO1 MEDPRDRD,DMCB,(RA)                                               
         MVC   QPRD,SVREQPRD                                                    
         GOTO1 DATCON,DMCB,(0,QSTART),(2,BQSTARTP)                              
         GOTO1 DATCON,DMCB,(0,QEND),(2,BQENDP)                                  
         B     IMEXIT                                                           
IMSFRST  CLI   MODE,STAFRST                                                     
         BNE   IMSLAST                                                          
         BAS   R9,ALLOCT           RESET BUFFERS                                
         MVI   MGMODE,C'N'                                                      
         MVI   ACTIVE,C'N'                                                      
         MVI   FORCEHED,C'Y'                                                    
         LA    R1,FPSTA                                                         
         USING FPDEF,R1                                                         
         LH    RF,FPIENT           GET TABLE LENGTH                             
         MH    RF,FPENTLN                                                       
         L     RE,FPSADDR          GET START ADDRESS                            
         XCEF                                                                   
         B     IMEXIT                                                           
         SPACE 2                                                                
IMSLAST  CLI   MODE,STALAST                                                     
         BNE   IMEXIT                                                           
         CLI   ACTIVE,C'N'         ANY ACTIVITY                                 
         BE    IMEXIT                                                           
         BAS   RE,GETSADDR                                                      
         BAS   RE,SRTSPT           SORT SPOTS INTO DAY/TIME ORDER               
         BAS   RE,PSPT             PRINT DETAIL REPORT                          
         BAS   RE,PRTSTOT          PRINT STATION TOTALS                         
         B     IMEXIT                                                           
IMEXIT   XMOD1 1                                                                
         EJECT                                                                  
IMRQF    BAS   R9,ALLOCT                                                        
         LA    RF,MYHEAD                                                        
         ST    RF,HEADHOOK                                                      
         B     IMEXIT                                                           
         EJECT                                                                  
IMBY     DS    0C                                                               
         L     R5,ADBUY                                                         
         CLC   4(2,R5),KEY+4       SPILL                                        
         BNE   IMEXIT                                                           
         SPACE 2                                                                
BLDPRG   L     R5,ADBUY            BUILD A PROGRAM NAME ENTRY                   
         LA    R5,24(R5)                                                        
         USING BDELEM,R5                                                        
         MVC   CBDCOST,BDCOST      SET BUY RECORD COST AND TIME                 
         MVC   CBDTIME,BDTIMST                                                  
         LA    R6,FPPRG                                                         
         GOTO1 SCAN,INP,(R6),BDPROGRM,0,16                                      
         LA    R1,FPPRG            SET TO PROGRAM ADDRESS                       
         USING FPDEF,R1                                                         
         OC    FPLASTA,FPLASTA                                                  
         BNZ   BLDPRGX                                                          
         GOTO1 ADDENT,INP,(R6),BDPROGRM                                         
BLDPRGX  LA    R1,FPPRG                                                         
         MVC   CPRGLNK,FPLASTI                                                  
         DROP  R5                                                               
         BAS   R9,BLDID                                                         
         BAS   R9,BLDDT                                                         
         BAS   R9,BLDCOM                                                        
         BAS   R9,BLDLIN                                                        
         BAS   RE,PREG                                                          
* MAKE SURE THAT ALL SLAVES ARE READ                                            
         CLI   MGMODE,C'Y'         RETURN IF IN MGMODE                          
         BE    IMEXIT                                                           
         L     R5,ADBUY                                                         
         LA    R5,24(R5)                                                        
         USING PKGELEM,R5                                                       
IMMST    CLI   PKGELEM,0           EOR - EXIT                                   
         BE    IMEXIT                                                           
         CLI   PKGELEM,X'05'       LINKAGE ELEMENT                              
         BE    IMMST2              YES                                          
         ZIC   R0,1(R5)                                                         
         AR    R5,R0                                                            
         B     IMMST                                                            
         SPACE 2                                                                
IMMST2   CLI   PKGIND,X'07'        MAKEGOOD MASTER                              
         BNE   IMEXIT              NO - EXIT                                    
         MVI   MGMODE,C'Y'         SET MAKEGOOD MODE                            
         GOTO1 RDMGSLV             PROCESS THE SLAVE LINES                      
         B     IMEXIT                                                           
         EJECT                                                                  
BLDID    L     R5,ADBUY            SAVE THE ID NUMBER                           
         LA    R5,24(R5)                                                        
         USING IDELEM,R5                                                        
         XC    CCONLNK,CCONLNK                                                  
BLDID2   CLI   IDELEM,0                                                         
         BE    BLDIDX                                                           
         CLI   IDELEM,X'70'        ELEMENT OK                                   
         BE    BLDID4                                                           
         ZIC   R0,1(R5)                                                         
         AR    R5,R0                                                            
         B     BLDID2                                                           
BLDID4   LA    R6,FPCON                                                         
         USING FPDEF,R6                                                         
         GOTO1 SCAN,INP,(R6),3(R5),0,11                                         
         OC    FPLASTI,FPLASTI                                                  
         BNZ   BLDIDX                                                           
         GOTO1 ADDENT,INP,(R6),3(R5)                                            
BLDID6   MVC   CCONLNK,FPLASTI+1                                                
         L     R6,FPLASTA                                                       
         USING CONDEF,R6                                                        
         MVC   CDORGSLT,CCONLNK                                                 
BLDIDX   BR    R9                                                               
         EJECT                                                                  
BLDDT    L     R5,ADBUY                                                         
         LA    R5,24(R5)           SCAN FOR MAKEGOOD SLAVE ELEMENT              
         USING PKGELEM,R5                                                       
SETREF   CLI   PKGELEM,0                                                        
         BE    SETREFX                                                          
         CLI   PKGELEM,X'05'                                                    
         BNE   SETREF2                                                          
         CLI   PKGIND,8            IS IT A MG SLAVE                             
         BE    SETREF3                                                          
SETREF2  ZIC   R0,1(R5)                                                         
         AR    R5,R0                                                            
         B     SETREF                                                           
SETREF3  CLI   MGMODE,C'N'         PROCESS MASTER PASS                          
         BE    IMEXIT              YES - BYPASS THIS BUY                        
         MVC   CMASTER,PKGLINES    SET MASTER LINE NUMBER                       
SETREFX  DS    0C                                                               
         DROP  R5                                                               
         SPACE 2                                                                
         L     R5,ADBUY            SAVE BUY DESC CONSTANTS                      
         USING BUYREC,R5                                                        
         MVC   EST,BUYKEST                                                      
         MVC   LIN,BUYKBUY                                                      
         MVC   CMGDATE,BDMGDATE                                                 
         MVC   CMGSPOT,BDMGSPOT                                                 
         SPACE 2                                                                
         EJECT                                                                  
         LA    R6,BLDAREA                                                       
         USING DTDEF,R6                                                         
         XC    BLDAREA(DTDEFLN),BLDAREA                                         
         GOTO1 DATCON,DMCB,(X'03',BDSTART),(X'02',DTSDAT)                       
         MVC   DTTIME,BDPROG                                                    
BLDDT2   LA    R6,FPDT             ENTRY POINT FOR SPOT DETAILS                 
         USING FPDEF,R6                                                         
         GOTO1 SCAN,INP,(R6),BLDAREA,0,6                                        
         MVC   CDTLNK,FPLASTI                                                   
         OC    FPLASTI,FPLASTI                                                  
         BNZ   BLDDTX                                                           
         GOTO1 ADDENT,INP,(R6),BLDAREA                                          
         MVC   CDTLNK,FPLASTI                                                   
         L     R6,FPLASTA                                                       
         USING DTDEF,R6                                                         
         MVC   DTORGSLT,CDTLNK                                                  
BLDDTX   BR    R9                                                               
         EJECT                                                                  
BLDLIN   LA    R6,BLDAREA          BUILD LINE CONSTANTS                         
         USING LINDEF,R6                                                        
         L     R5,ADBUY                                                         
         MVC   LDEST,EST                                                        
         MVC   LDLIN,LIN                                                        
         MVC   LDPRGLNK,CPRGLNK                                                 
         MVC   LDCOMLNK,CCOMLNK                                                 
         MVC   LDCONLNK,CCONLNK                                                 
         MVC   LDDTLNK,CDTLNK                                                   
         MVC   LDSLN,BDSEC                                                      
         MVC   LDDAYS,BDDAY                                                     
         LA    R6,FPLIN                                                         
         GOTO1 ADDENT,INP,(R6),BLDAREA                                          
         BR    R9                                                               
         EJECT                                                                  
* BUILD A COMMENT BUFFER ENTRY                                                  
BLDCOM   L     R5,ADBUY            POINT TO BUY RECORD                          
         LA    R5,24(R5)                                                        
         USING COMELEM,R5                                                       
         XC    CCOMLNK,CCOMLNK                                                  
         LA    RE,BLDAREA          CLEAR BUILD AREA                             
         LA    RF,3000                                                          
         XCEF                                                                   
         LA    RE,BLDAREA                                                       
BLDCOM2  CLI   CMCODE,0            END                                          
         BE    BLDCOM6                                                          
         CLI   CMCODE,X'66'        COMMENT ELEMENT CODE                         
         BE    BLDCOM4                                                          
BLDCOM3  SR    R0,R0               NEXT ELEMENT                                 
         IC    R0,CMLEN                                                         
         AR    R5,R0                                                            
         B     BLDCOM2                                                          
BLDCOM4  SR    R1,R1               GET PREV. BUFFER LENGTH                      
         LA    RE,BLDAREA                                                       
         ZIC   R0,CMLEN            LENGTH OF COMMENT ELEMENT                    
         ICM   R1,3,BLDAREA        GET PREV. BUFFER LENGTH                      
         BNZ   *+8                                                              
         LA    R1,2                                                             
         AR    RE,R1               DISPLACE TO END OF BUFFER                    
         AR    R1,R0               ADD IN THIS ELEMENT LENGTH                   
         STCM  R1,3,BLDAREA        SET TOTAL LENGTH                             
         LR    R1,R0               SET THIS ELEMENT LENGTH                      
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),0(R5)       *EXECUTED* MOVE COMMENT                      
         B     BLDCOM3                                                          
         SPACE 2                                                                
BLDCOM6  OC    BLDAREA(2),BLDAREA  ANY COMMENTS                                 
         BZR   R9                  NO - EXIT                                    
         LA    R1,FPCOM            SET CONTROL TABLE                            
         ST    R1,INP                                                           
         LA    R1,BLDAREA                                                       
         ST    R1,INP+4            SET DATA AREA                                
         BAS   RE,VADDENT                                                       
         LA    R1,FPCOM                                                         
         MVC   CCOMLNK,FPLASTI                                                  
         BR    R9                                                               
         SPACE 2                                                                
PREG     NTR1                      BUILD PRODUCT/SPOT TABLES                    
         MVI   SPOTNO,0            SET FIRST SPOT                               
         XC    PRVRDAT,PRVRDAT                                                  
         L     R5,ADBUY                                                         
         LA    R5,24(R5)                                                        
         USING REGELEM,R5                                                       
PREG1    XC    CURRSPT,CURRSPT                                                  
         CLI   0(R5),0                                                          
         BE    PREGXIT                                                          
         CLI   0(R5),X'06'                                                      
         BL    PREG2                                                            
         CLI   0(R5),X'08'                                                      
         BH    *+8                                                              
         BAS   R9,REGBRD                                                        
         CLI   0(R5),X'0B'                                                      
         BL    PREG2                                                            
         CLI   0(R5),X'0D'                                                      
         BH    PREG2                                                            
         BAS   R9,REGPOL                                                        
PREG2    CLI   CSACT,0                                                          
         BE    PREGNXT                                                          
         MVI   ACTIVE,C'Y'               TURN ON ACTIVITY SWITCH                
         LA    R6,BLDAREA                                                       
         USING PRDDEF,R6                                                        
         XC    0(PRDDEFLN,R6),0(R6)                                             
         MVC   PRPRD1,CSPRD1                                                    
         MVC   PRSLN1,CSSLN1                                                    
         MVC   PRPRD2,CSPRD2                                                    
         MVC   PRSLN2,CSSLN2                                                    
         LA    R6,FPPRD                                                         
         GOTO1 SCAN,INP,(R6),BLDAREA,0,PRDDEFLN                                 
         LA    R1,FPPRD                                                         
         USING FPDEF,R1                                                         
         OC    FPLASTA,FPLASTA                                                  
         BNZ   PREG4                                                            
         GOTO1 ADDENT,INP,(R6),BLDAREA                                          
PREG4    LA    R1,FPPRD                                                         
         MVC   CPRDLNK,FPLASTI                                                  
         LA    R6,BLDAREA                                                       
         USING SPTDEF,R6                                                        
         XC    0(SPTDEFLN,R6),0(R6)                                             
         MVC   SDEST,EST                                                        
         MVC   SDLIN,LIN                                                        
         MVC   SDSPTNO,SPOTNO                                                   
         MVC   SDCOST,CSCOST                                                    
         MVC   SDPRLNK,CPRDLNK                                                  
         MVC   SDDATE,CSDATE                                                    
         MVC   SDAFFTM,CSDATE                                                   
         LA    R6,FPSPT                                                         
         GOTO1 ADDENT,INP,(R6),BLDAREA                                          
         LA    R6,BLDAREA                                                       
         MVC   CSDATE,SDDATE       SAVE THIS SPOT DAY/TIME                      
         MVC   CSTIME,CBDTIME                                                   
         CLI   SDAFFDY,0           ANY AFFIDS                                   
         BE    PREG6                                                            
         MVC   CSDATE,SDAFFDY                                                   
         MVC   CSTIME,SDAFFTM                                                   
         USING DTDEF,R6                                                         
PREG6    XC    BLDAREA(DTDEFLN),BLDAREA SET DATE TIME LINK                      
         MVC   DTSDAT,CSDATE                                                    
         MVC   DTTIME,CSTIME                                                    
         BAS   R9,BLDDT2           SAVE DAY/TIME                                
         LA    R1,FPSPT                                                         
         USING FPDEF,R1                                                         
         L     R6,FPLASTA                                                       
         USING SPTDEF,R6                                                        
         MVC   SDDATE,CDTLNK       SET DATE LINK                                
         OC    CMGDATE,CMGDATE     SET THE STATUS BITS                          
         BZ    *+8                                                              
         OI    SDSTATUS,X'02'      FLAG AS MAKEGOOD                             
         TM    RSTATUS,X'02'                                                    
         BZ    *+8                                                              
         OI    SDSTATUS,X'01'      FLAG AS MISSED                               
         EJECT                                                                  
* GET THE ACTUAL SPOTS AND DOLLARS FOR THIS BUY                                 
         L     R9,ADBUY                                                         
         USING BUYREC,R9                                                        
*   INCLUDE TAX                                                                 
         GOTO1 GETRATE,DMCB,(X'FF',GRSPOTS),(CSSLN1,(R9)),(R5)                  
*   EXCLUDE TAX                                                                 
         MVC   HALF,BDNTAX                                                      
         XC    BDNTAX,BDNTAX                                                    
         GOTO1 (RF),(R1),(X'FF',GXTSPOTS)                                       
         MVC   BDNTAX,HALF                                                      
         DROP  R9                                                               
*                                                                               
         TM    RSTATUS,X'02'       MISSED SPOT                                  
         BZ    PREG8                                                            
         CLC   RDATE,BQENDP        ZERO SPOTS AND COST IF OUTSIDE               
         BH    *+14                REQUESTED DATES                              
         CLC   RDATE,BQSTARTP                                                   
         BNL   PREG8                                                            
         XC    GRGROSS,GRGROSS                                                  
         XC    GRNET,GRNET                                                      
         XC    GRSPOTS,GRSPOTS                                                  
         XC    GXTNET,GXTNET                                                    
         XC    GXTGROSS,GROSS                                                   
*                                                                               
PREG8    OC    CMGDATE,CMGDATE                                                  
         BZ    PREG9                                                            
         XC    GRGROSS,GRGROSS                                                  
         XC    GRNET,GRNET                                                      
         XC    GXTGROSS,GXTGROSS                                                
         XC    GXTNET,GXTNET                                                    
*                                                                               
PREG9    CLC   CMGDATE,BQSTARTP    MISSED WITHIN REQUEST                        
         BL    PRECTOT              YES - CLEAR SPOTS                           
         XC    GRSPOTS,GRSPOTS                                                  
* ADD INTO STATION TOTALS                                                       
PRECTOT  LA    R0,2                                                             
         ZIC   R8,SDSTATUS         INDEX TO CORRECT BUCKET                      
         LA    R1,FPSTA                                                         
PREGTOT2 MH    R8,FPENTLN          ADD UP SPOTS AND DOLLARS                     
         A     R8,FPSADDR                                                       
         USING STADEF,R8                                                        
         L     RE,GRSPOTS                                                       
         A     RE,STSPOTS                                                       
         ST    RE,STSPOTS                                                       
         L     RE,GXTGROSS                                                      
         A     RE,STGROSS                                                       
         ST    RE,STGROSS                                                       
         L     RE,GXTNET                                                        
         A     RE,STNET                                                         
         ST    RE,STNET                                                         
         L     RF,GRNET                                                         
         S     RF,GXTNET                                                        
         A     RF,STTAX                                                         
         ST    RF,STTAX                                                         
         LA    R8,3                SET TO STATION TOTAL SLOT                    
         BCT   R0,PREGTOT2                                                      
         DROP  R8                                                               
         EJECT                                                                  
         OC    CMGDATE,CMGDATE     CHECK FOR MAKEGOOD                           
         BZ    PREGNXT                                                          
         BAS   RE,SETMKGD          SET UP MAKEGOOD DATA                         
PREGNXT  SR    R0,R0                                                            
         IC    R0,1(R5)                                                         
         AR    R5,R0                                                            
         B     PREG1                                                            
PREGXIT  XIT1                                                                   
         SPACE 2                                                                
REGBRD   XC    CURRSPT,CURRSPT     INITIALIZE                                   
         ZIC   RF,SPOTNO                                                        
         LA    RF,1(RF)                                                         
         STC   RF,SPOTNO                                                        
         TM    RSTATUS,X'C0'       MISSED/MAKEGOOD                              
         BNZR  R9                                                               
         MVI   CSACT,1                                                          
         MVC   CSPRD1,CBPRD        FILL IN COMMON AREA                          
         MVC   CSSLN1,CBDSEC                                                    
         MVC   CSCOST,CBDCOST                                                   
         MVC   CSDATE,RDATE                                                     
         BR    R9                                                               
         SPACE 2                                                                
* DIG OUT POL SPOT INFO                                                         
REGPOL   XC    CURRSPT,CURRSPT                                                  
         CLC   RDATE,PRVRDAT                                                    
         BE    *+8                                                              
         MVI   SPOTNO,0                                                         
         MVC   PRVRDAT,RDATE                                                    
         ZIC   RF,SPOTNO                                                        
         TM    RSTATUS,X'80'                                                    
         BO    *+8                                                              
         LA    RF,1(RF)                                                         
         STC   RF,SPOTNO                                                        
         TM    RSTATUS,X'02'       MSSD SPOT WITH MKGD                          
         BO    *+10                YES - ACCEPT IT                              
         TM    RSTATUS,X'C4'       MISSED/MAKEGOOD/HIATUS                       
         BNZR  R9                                                               
         CLI   RLEN,14                                                          
         BLR   R9                  UNALLOCATED                                  
         CLC   QPRD,=C'POL'                                                     
         BE    *+12                                                             
         CLC   BPRD,RPPRD          CHECK PRODUCT                                
         BNER  R9                                                               
         OC    CMGDATE,CMGDATE     ALLOW MAKEGOODS BEFORE START                 
         BNZ   CHKMDT                                                           
         TM    RSTATUS,X'02'                                                    
         BO    *+12                                                             
         CLC   RDATE,BQSTARTP                                                   
         BLR   R9                                                               
         OC    CMGDATE,CMGDATE     ALLOW MKGDS AFTER END DATE                   
         BNZ   CHKMDT              CHECK FOR POSSIBLE WITHIN PERIOD             
         TM    RSTATUS,X'02'       MSSD SPOT WITH MKGD                          
         BO    *+10                YES - ACCEPT IT                              
         CLC   RDATE,BQENDP        NOT ACTIVE BYPASS                            
         BHR   R9                                                               
         SPACE 2                                                                
REGPOL2  MVI   CSACT,1                                                          
         MVC   CSPRD1,RPPRD                                                     
         MVC   CSDATE,RDATE                                                     
         MVC   CSSLN1,RPTIME                                                    
         MVC   CSCOST,CBDCOST                                                   
         TM    RSTATUS,X'20'       RATE OVERRIDE                                
         BZ    *+10                                                             
         MVC   CSCOST,RPCOST                                                    
         CLC   RDATE,BQSTARTP      MISSED CAN BE LESS                           
         BNL   *+10                                                             
         XC    CSCOST,CSCOST       CLEAR COST                                   
         CLI   RLEN,18             PIGGYBACK                                    
         BLR   R9                                                               
         MVC   CSPRD2,RPPRD+4                                                   
         MVC   CSSLN2,RPTIME+4                                                  
         BR    R9                                                               
         SPACE 2                                                                
* IF SPOT IS A MKGD THEN BYPASS IF BOTH MISSED AND MAKEGOOD                     
* DATES ARE OUTSIDE THE REQUESTED PERIOD.                                       
CHKMDT   CLC   CMGDATE,BQSTARTP                                                 
         BNL   *+12                                                             
         CLC   RDATE,BQSTARTP                                                   
         BLR   R9                                                               
         CLC   RDATE,BQENDP                                                     
         BNH   REGPOL2                                                          
         CLC   CMGDATE,BQSTARTP                                                 
         BLR   R9                                                               
         CLC   CMGDATE,BQENDP                                                   
         BHR   R9                                                               
         B     REGPOL2                                                          
         EJECT                                                                  
* SET UP MAKEGOOD AND LINK TO MISSED LINE                                       
SETMKGD  NTR1                                                                   
         LA    R7,BLDAREA                                                       
         USING MMDEF,R7                                                         
         XC    BLDAREA(MMDEFLN),BLDAREA                                         
         MVC   MMEST,SDEST         BUILD MKGD DEFINITION FROM                   
         MVC   MMLIN,SDLIN         CURRENT LINE                                 
         MVC   MMDTLNK,SDDATE                                                   
         MVC   MMCOST,SDCOST                                                    
         MVC   MMPRLNK,SDPRLNK                                                  
         MVC   MMPDLNK,CPRGLNK                                                  
         MVC   MMCDLINK,CCOMLNK                                                 
         MVC   MMESTREF,SDEST                                                   
         MVC   MMLINREF,CMASTER                                                 
         LA    R8,FPMM                                                          
         DROP  R7                                                               
         GOTO1 ADDENT,INP,(R8),BLDAREA                                          
         LA    R1,FPSPT            POINT TO SPOT JUST ADDED                     
         MVC   SVMGSPT,FPLASTA     SAVE ORIGINAL ADDRESS                        
         CLC   CMGDATE,BQENDP                                                   
         BH    FMSD0                                                            
         CLC   CMGDATE,BQSTARTP    LESS THAN START                              
         BL    FMSD0               SET UP MSSD REF                              
         TM    SDSTATUS,X'03'      MISSED MAKEGOOD                              
         BO    FMSD0               INCLUDE IT                                   
         LH    R6,FPNOI            DELETE LAST SPOT ADDED                       
         BCTR  R6,0                                                             
         STH   R6,FPNOI                                                         
         L     R6,FPCADDR                                                       
         LA    R7,SPTDEFLN                                                      
         SR    R6,R7                                                            
         ST    R6,FPCADDR                                                       
FMSD0    L     R6,FPSADDR          POINT TO SPOT TABLE                          
         USING SPTDEF,R6                                                        
         MVC   HALF(1),EST                                                      
         MVC   HALF+1(1),CMASTER                                                
         LH    R8,FPNOI                                                         
         LTR   R8,R8                                                            
         BZ    FMSDX                                                            
FMSD     CLC   SDEST(2),HALF       FIND THE MASTER LINE                         
         BE    FMSD2                                                            
FMSD1    LA    R6,SPTDEFLN(R6)                                                  
         BCT   R8,FMSD                                                          
         B     FMSDX               DID NOT FIND THE LINE                        
FMSD2    LA    R1,FPDT             ATTACH THE MAKEGOOD                          
         SR    RE,RE                                                            
         ICM   RE,3,SDDATE                                                      
         BCTR  RE,0                                                             
         MH    RE,FPENTLN                                                       
         A     RE,FPSADDR                                                       
         USING DTDEF,RE                                                         
         CLC   CMGDATE,DTSDAT                                                   
         BNE   FMSD1                                                            
         CLC   CMGSPOT,SDSPTNO     CHECK SPOT NUMBER                            
         BNE   FMSD1                                                            
         DROP  RE                                                               
         SPACE 2                                                                
         OC    SDMMREF,SDMMREF     ALREADY REFERENCED                           
         BZ    FMSD4                                                            
         MVC   BLDAREA(SPTDEFLN),SPTDEFST  CREATE NEW MASTER                    
         LA    R6,BLDAREA                                                       
         XC    SDCOST,SDCOST                                                    
         XC    SDMMREF,SDMMREF                                                  
         LA    R6,FPSPT                                                         
         GOTO1 ADDENT,INP,(R6),BLDAREA                                          
         LA    R1,FPSPT                                                         
         L     R6,FPLASTA                                                       
         SPACE 2                                                                
FMSD4    CLC   CMGDATE,BQSTARTP    MSSD LT FIRST REQUEST                        
         BL    SWMGMS              SWAP MISSED AND MAKEGOOD                     
         CLC   CMGDATE,BQENDP      OR MSSD GT LAST REQUEST                      
         BH    SWMGMS                                                           
         LA    R1,FPMM SET MAKEGOOD REFERENCE                                   
         MVC   SDMMREF,FPLASTI                                                  
         B     FMSDX                                                            
         SPACE 2                                                                
* SWAP THE MISSED AND MAKEGOOD ENTRIES                                          
SWMGMS   LA    R7,BLDAREA                                                       
         USING MMDEF,R7                                                         
         XC    BLDAREA(MMDEFLN),BLDAREA                                         
         MVC   MMEST,SDEST         BUILD MSSD DEFINITION FROM                   
         MVC   MMLIN,SDLIN         MISSED LINE                                  
         MVC   MMDTLNK,SDDATE                                                   
         MVC   MMCOST,SDCOST                                                    
         MVC   MMPRLNK,SDPRLNK                                                  
         MVC   MMPDLNK,CPRGLNK                                                  
         MVC   MMCDLINK,CCOMLNK                                                 
         MVC   MMESTREF,SDEST                                                   
         MVC   MMLINREF,CMASTER                                                 
         LA    R8,FPMM                                                          
         DROP  R7                                                               
         GOTO1 ADDENT,INP,(R8),BLDAREA                                          
         L     R6,SVMGSPT                                                       
         LA    R1,FPMM                                                          
         MVC   SDMMREF,FPLASTI     POINT MAKEGOOD TO MISSED                     
FMSDX    XIT1                                                                   
         EJECT                                                                  
* SORT SPOTS INTO DAY TIME ORDER                                                
SRTSPT   NTR1                                                                   
         LA    R1,FPDT             SET TO SORT ON DATES                         
         L     R6,FPSADDR                                                       
         USING DTDEF,R6                                                         
         LH    R7,FPNOI                                                         
         LTR   R7,R7                                                            
         BZ    SRTSPTX                                                          
         CH    R7,=H'250'          TO MANY DATE ENTIES                          
         BNH   *+6                                                              
         DC    H'0'                                                             
         GOTO1 XSORT,DMCB,(0,(R6)),(R7),DTDEFLN,DTDEFLN,0                       
         LA    RE,BLDAREA                                                       
         LA    RF,3000                                                          
         XCEF                                                                   
         LA    RF,1                SET SLOT COUNTER                             
SETLDT   LH    RE,DTORGSLT         SET UP DATE LINK EQUATE TABLE                
         BCTR  RE,0                                                             
         SLL   RE,1                                                             
         LA    RE,BLDAREA(RE)      POINT TO EQUATE SLOT                         
         STCM  RF,3,0(RE)                                                       
         LA    RF,1(RF)            BUMP SLOT POINTER                            
         LA    R6,DTDEFLN(R6)      BUMP DATE                                    
         BCT   R7,SETLDT           LOOP TILL DONE                               
         SPACE 2                                                                
* RELINK THE SPOT POINTERS                                                      
         LA    R1,FPSPT                                                         
         L     R6,FPSADDR                                                       
         USING SPTDEF,R6                                                        
         LH    R7,FPNOI                                                         
         LTR   R7,R7                                                            
         BZ    SRTSPTX                                                          
FIXLSPT  SR    RE,RE                                                            
         ICM   RE,3,SDDATE                                                      
         BCTR  RE,0                                                             
         SLL   RE,1                                                             
         LA    RE,BLDAREA(RE)                                                   
         MVC   SDDATE,0(RE)                                                     
         LA    R6,SPTDEFLN(R6)                                                  
         BCT   R7,FIXLSPT                                                       
         SPACE 2                                                                
* RELINK THE LINE DATE POINTERS                                                 
         LA    R1,FPLIN                                                         
         L     R6,FPSADDR                                                       
         USING LINDEF,R6                                                        
         LH    R7,FPNOI                                                         
FIXLLIN  SR    RE,RE                                                            
         ICM   RE,3,LDDTLNK                                                     
         BCTR  RE,0                                                             
         SLL   RE,1                                                             
         LA    RE,BLDAREA(RE)                                                   
         MVC   LDDTLNK,0(RE)                                                    
         LA    R6,LINDEFLN(R6)                                                  
         BCT   R7,FIXLLIN                                                       
         SPACE 2                                                                
* RELINK THE MISSED/MAKEGOOD POINTERS                                           
         LA    R1,FPMM                                                          
         L     R6,FPSADDR                                                       
         USING MMDEF,R6                                                         
         LH    R7,FPNOI                                                         
         LTR   R7,R7                                                            
         BZ    FIXDTLX                                                          
FIXLMM   SR    RE,RE                                                            
         ICM   RE,3,MMDTLNK                                                     
         BCTR  RE,0                                                             
         SLL   RE,1                                                             
         LA    RE,BLDAREA(RE)                                                   
         MVC   MMDTLNK,0(RE)                                                    
         LA    R6,MMDEFLN(R6)                                                   
         BCT   R7,FIXLMM                                                        
         DROP  R6                                                               
         SPACE 2                                                                
* NOW SORT THE SPOTS                                                            
FIXDTLX  LA    R1,FPSPT                                                         
         L     R6,FPSADDR                                                       
         USING SPTDEF,R6                                                        
         LH    R7,FPNOI                                                         
         LA    R8,SDDATE-SPTDEFST                                               
         GOTO1 XSORT,DMCB,(0,(R6)),(R7),SPTDEFLN,2,(R8)                         
SRTSPTX  XIT1                                                                   
         EJECT                                                                  
* PRINT THE REPORT                                                              
PSPT     NTR1                                                                   
         LA    R1,FPSPT            SET TABLE ADDRESS                            
         USING FPDEF,R1                                                         
         L     R6,FPSADDR          SET ENTRY DEFINITION                         
         USING SPTDEF,R6                                                        
         LA    R3,P1               SET PRINT LINE DEF                           
         USING D1DEF,R3                                                         
         SPACE 2                                                                
         SR    R5,R5               SET NUMBER OF ENTRIES                        
         ICM   R5,3,FPNOI                                                       
         LTR   R5,R5               CHECK FOR ACTIVITY                           
         BZ    PSPTX                                                            
PSPT2    TM    SDSTATUS,X'01'                                                   
         BZ    PSPT2A                                                           
         MVC   CDTLNK,SDDATE       SET DATE LINK                                
         LA    R1,FPDT             POINT TO DAY/TIME ENTRY                      
         SR    R9,R9                                                            
         ICM   R9,3,CDTLNK                                                      
         BCTR  R9,0                                                             
         MH    R9,FPENTLN                                                       
         A     R9,FPSADDR                                                       
         USING DTDEF,R9                                                         
         CLC   DTSDAT,BQENDP       BYPASS SPOTS OUTSIDE DATES IF THEY           
         BH    *+14                ARE UNREFERENCED                             
         CLC   DTSDAT,BQSTARTP                                                  
         BH    PSPT2A                                                           
         OC    SDMMREF,SDMMREF     ANY MG REFERENCE                             
         BZ    PSPTNXT                                                          
         DROP  R9                                                               
PSPT2A   LA    R1,FPLIN            GET DAYS                                     
         L     R9,FPSADDR                                                       
         USING LINDEF,R9                                                        
PSPTFL   CLC   SDEST(2),LDEST      MATCH ON ESTIMATE/LIN                        
         BE    PSPTFL2                                                          
         LA    R9,LINDEFLN(R9)     TRY NEXT                                     
         CLI   0(R9),0                                                          
         BNE   PSPTFL                                                           
         DC    H'0'                                                             
PSPTFL2  GOTO1 CODAY,DMCB,LDDAYS,D1DAYS                                         
         MVC   CCOMLNK,LDCOMLNK                                                 
         MVC   CPRGLNK,LDPRGLNK                                                 
         DROP  R9                                                               
         SPACE 2                                                                
         MVC   COMPOS,=F'132'                                                   
         MVI   BYTE,C'O'           SET FOR ORIGINAL COMMENTS                    
         BAS   R9,PGETCOM                                                       
         EDIT  SDEST,(3,D1EST)                                                  
         EDIT  SDLIN,(3,D1LIN),,ALIGN=LEFT                                      
         MVI   D1ELDSH,C'-'                                                     
         EDIT  SDCOST,(12,D1OCOST),2,COMMAS=YES,MINUS=YES                       
         TM    SDSTATUS,X'02'      MAKEGOOD SPOT                                
         BZ    PSPT3                                                            
         XC    D1OCOST,D1OCOST                                                  
         MVC   D1OCOST+8(4),=C'MKGD'                                            
PSPT3    GOTO1 DATCON,DMCB,(2,SDAFFTM),(5,D1DAT)                                
         MVC   CDTLNK,SDDATE       SET DATE LINK                                
         LA    R1,FPDT             POINT TO DAY/TIME ENTRY                      
         SR    R9,R9                                                            
         ICM   R9,3,CDTLNK                                                      
         BCTR  R9,0                                                             
         MH    R9,FPENTLN                                                       
         A     R9,FPSADDR                                                       
         USING DTDEF,R9                                                         
*        GOTO1 DATCON,DMCB,(2,DTSDAT),(5,D1DAT)                                 
         GOTO1 UNTIME,DMCB,DTTIME,D1TIME                                        
         DROP  R9                                                               
         MVC   CPRDLNK,SDPRLNK     GET PRODUCT/LEN LINK                         
         LA    R1,FPPRD                                                         
         SR    R9,R9                                                            
         ICM   R9,3,CPRDLNK                                                     
         BCTR  R9,0                                                             
         MH    R9,FPENTLN                                                       
         A     R9,FPSADDR                                                       
         USING PRDDEF,R9                                                        
         ZIC   RF,PRSLN1           DO LENGTH 1                                  
         EDIT  (RF),(3,D1LEN)                                                   
         ZIC   RE,PRPRD1                                                        
         BCTR  RE,0                                                             
         MH    RE,PRDBUFLN                                                      
         A     RE,PRDBUFF                                                       
         MVC   D1PRD1,1(RE)         DO PRODUCT 1                                
         DROP  R9                                                               
         LA    R1,FPPRG            GET PROGRAM NAME                             
         SR    R9,R9                                                            
         ICM   R9,3,CPRGLNK                                                     
         BCTR  R9,0                                                             
         MH    R9,FPENTLN                                                       
         A     R9,FPSADDR                                                       
         USING PRGDEF,R9                                                        
         MVC   D1PRG,PDNAME                                                     
         DROP  R9                                                               
         TM    SDSTATUS,X'01'                                                   
         BZ    *+10                                                             
         MVC   D1MTYP,=C'MSSD'                                                  
         OC    SDMMREF,SDMMREF     ANY MISSED/MAKEGOOD REF                      
         BZ    PSPTRPT             NO PRINT REPORT                              
         LA    R1,FPMM             SET TO MM SLOT                               
         SR    R9,R9                                                            
         ICM   R9,3,SDMMREF                                                     
         BCTR  R9,0                                                             
         MH    R9,FPENTLN                                                       
         A     R9,FPSADDR                                                       
         USING MMDEF,R9                                                         
         MVC   D1MTYP,=C'MSSD'                                                  
         TM    SDSTATUS,X'01'                                                   
         BZ    *+10                                                             
         MVC   D1MTYP,=C'MKGD'                                                  
         EDIT  MMEST,(3,D1MEST)                                                 
         MVI   D1MELDSH,C'-'                                                    
         EDIT  MMLIN,(3,D1MLIN),,ALIGN=LEFT                                     
         MVC   CDTLNK,MMDTLNK                                                   
         CLC   MMPRLNK,CPRDLNK     MSSD AND MG FOR SAME PRD                     
         BE    PMSAMPRD            YES DONT PRINT IT                            
         LA    R3,132(R3)                                                       
         MVC   CPRDLNK,MMPRLNK                                                  
         BAS   RE,MMPRDNME                                                      
         MVC   D1MDAT(8),=C'PRODUCT='                                           
         MVC   D1MDAT+8(3),FULL                                                 
         S     R3,=F'132'                                                       
         MVC   COMPOS,=F'264'                                                   
         SPACE 2                                                                
PMSAMPRD MVC   CPRDLNK,MMPRLNK                                                  
         MVC   HALF(1),MMEST                                                    
         MVC   HALF+1(1),MMLIN                                                  
         DROP  R9                                                               
         LA    R1,FPLIN            GET DAYS                                     
         L     R9,FPSADDR                                                       
         USING LINDEF,R9                                                        
PMGFL    CLC   HALF(2),LDEST      MATCH ON ESTIMATE/LIN                         
         BE    PMGFL2                                                           
         LA    R9,LINDEFLN(R9)     TRY NEXT                                     
         CLI   0(R9),0                                                          
         BNE   PMGFL                                                            
         DC    H'0'                                                             
PMGFL2   GOTO1 CODAY,DMCB,LDDAYS,D1MDAYS                                        
         MVC   CCOMLNK,LDCOMLNK                                                 
         DROP  R9                                                               
         MVI   BYTE,C'M'           SET FOR MSSD/MKGD COMMENTS                   
         BAS   R9,PGETCOM                                                       
         SPACE 2                                                                
         LA    R1,FPDT             POINT TO DAY/TIME ENTRY                      
         SR    R9,R9                                                            
         ICM   R9,3,CDTLNK                                                      
         BCTR  R9,0                                                             
         MH    R9,FPENTLN                                                       
         A     R9,FPSADDR                                                       
         USING DTDEF,R9                                                         
         GOTO1 DATCON,DMCB,(2,DTSDAT),(5,D1MDAT)                                
         GOTO1 UNTIME,DMCB,DTTIME,D1MTIM                                        
         DROP  R9                                                               
PSPTRPT  GOTO1 REPORT                                                           
PSPTNXT  LA    R6,SPTDEFLN(R6)                                                  
         BCT   R5,PSPT2            DO NEXT ENTRY                                
PSPTX    XIT1                                                                   
         EJECT                                                                  
PGETCOM  SR    RE,RE               PRINTOUT COMMENTS                            
         ICM   RE,3,CCOMLNK                                                     
         LTR   RE,RE                                                            
         BZ    PCOMEX                                                           
         LA    R1,FPCOM            SET TO COMMENT TABLE                         
         L     R8,FPSADDR                                                       
PCOM     BCT   RE,*+8              SEARCH FOR COMMENT                           
         B     PCOM2                                                            
         SR    R7,R7               NEXT COMMENT                                 
         ICM   R7,3,0(R8)                                                       
         AR    R8,R7                                                            
         B     PCOM                                                             
PCOM2    LR    R0,R3               SAVE PRINT LINE ADDRESS                      
         A     R3,COMPOS                                                        
         BAS   RE,PCOMSET          SET UP COMMENT STREAM                        
         LA    R3,D1OCOM           ORIGINAL COMMENTS                            
         CLI   BYTE,C'M'                                                        
         BNE   *+8                                                              
         LA    R3,D1MCOM           MSSD/MKGD COMMENTS                           
         SR    R7,R7               CHOP COMMENTS                                
         ICM   R7,3,BLDAREA                                                     
         LA    RF,BLDAREA+2                                                     
         GOTO1 CHOPPER,DMCB,((R7),(RF)),(36,(R3)),(C'P',10),0,0                 
         L     RF,8(R1)            GET NUMBER OF LINES                          
         MH    RF,=H'132'          SET 0 IN NEXT PRINT LINE                     
         AR    RF,R3                                                            
         MVI   0(RF),0                                                          
         LR    R3,R0                                                            
PCOMEX   BR    R9                                                               
         SPACE 2                                                                
MMPRDNME NTR1                                                                   
         LA    R1,FPPRD            DIG OUT MAKEGOOD PRODUCT                     
         SR    R9,R9                                                            
         ICM   R9,3,CPRDLNK                                                     
         BCTR  R9,0                                                             
         MH    R9,FPENTLN                                                       
         A     R9,FPSADDR                                                       
         USING PRDDEF,R9                                                        
         ZIC   RE,PRPRD1                                                        
         BCTR  RE,0                                                             
         MH    RE,PRDBUFLN                                                      
         A     RE,PRDBUFF                                                       
         MVC   FULL(3),1(RE)                                                    
         DROP  R9                                                               
         XIT                                                                    
* R8 = START OF SLOT                                                            
PCOMSET  NTR1                                                                   
         LA    RE,BLDAREA          CLEAR OUTPUT                                 
         LA    RF,3000                                                          
         XCEF                                                                   
         LA    R5,BLDAREA+2        SET TO OUTPUT START                          
         SR    R6,R6                                                            
         ICM   R6,3,0(R8)          TOTAL LENGTH                                 
         LA    R8,2(R8)            SET TO FIRST COMMENT                         
         SH    R6,=H'2'                                                         
PCOMSET1 LTR   R6,R6               END                                          
         BNP   PCOMSETX                                                         
         ZIC   R7,1(R8)                                                         
         SR    R6,R7               DECREMENT COUNT                              
         SR    R1,R1                                                            
         ICM   R1,3,BLDAREA        UPDATE BUFFER LENGTH                         
         SH    R7,=H'4'            ADJUST FOR HEADER LENGTH                     
         AR    R1,R7                                                            
         LA    R1,2(R1)            ADJUST FOR SPACE AND DECREMENT               
         STCM  R1,3,BLDAREA                                                     
         MVI   0(R5),C' '                                                       
         LA    R5,1(R5)                                                         
         EX    R7,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R5),3(R8)                                                    
         ZIC   R7,1(R8)                                                         
         AR    R8,R7                                                            
         B     PCOMSET1                                                         
PCOMSETX XIT1                                                                   
         EJECT                                                                  
GETSADDR NTR1                                                                   
         MVC   SASVKEY,KEY                                                      
         LA    R6,KEY                                                           
         USING ADDRREC,R6                                                       
         MVI   KEY,C'0'                                                         
         MVC   KEY+1(16),KEY                                                    
         MVI   ADDKTYPE,C'A'                                                    
         MVC   ADDKMED,QMED                                                     
         MVC   ADDKCALL,STA                                                     
         CLI   ADDKCALL+4,C' '                                                  
         BNE   *+10                                                             
         MVC   ADDKCALL+4(1),QMED                                               
         MVC   ADDKAGY,AGY                                                      
         GOTO1 HIGHSTAD                                                         
         L     R6,ADSTATAD                                                      
         CLC   ADDKCALL(4),STA                                                  
         BE    M84                                                              
         MVC   ANAME(86),SPACES                                                 
         MVC   ANAME(4),STA                                                     
         MVC   ANAME+5(15),=C'ADDRESS MISSING'                                  
M84      MVC   KEY,SASVKEY                                                      
         XIT1                                                                   
         EJECT                                                                  
* PRINT STATION TOTALS                                                          
PRTSTOT  NTR1                                                                   
         MVI   ALLOWLIN,9                                                       
         MVI   P1,X'00'                                                         
         MVC   P2(41),=C'-------------------------ORDERED---------'             
         MVC   P2+41(24),=C'------------------------'                           
         MVI   P3,X'00'                                                         
         MVC   P4(41),=C'REPORT TOTALS     SPOTS   GROSS COST     '             
         MVC   P4+41(22),=C'NET COST           TAX'                             
         MVC   P4+63(28),=C'  GROSS + TAX    NET + TAX  '                       
         MVC   P5(41),=C'-------------     -----   ----------     '             
         MVC   P5+41(22),=C'--------           ---'                             
         MVC   P5+63(28),=C' ------------- -------------'                       
         GOTO1 REPORT                                                           
         LA    R1,FPSTA                                                         
         LA    R3,STOTCAPS                                                      
         LA    R4,4                                                             
         L     R6,FPSADDR                                                       
         USING STADEF,R6                                                        
         LA    R7,P1                                                            
         USING D2DEF,R7                                                         
PRTSTOT2 MVC   D2RPTCAP,0(R3)                                                   
         LA    R3,L'D2RPTCAP(R3)                                                
         EDIT  STSPOTS,(5,D2SPT)                                                
         EDIT  STGROSS,(13,D2GRS),2,COMMAS=YES,MINUS=YES                        
         EDIT  STNET,(13,D2NET),2,COMMAS=YES,MINUS=YES                          
         EDIT  STTAX,(13,D2TAX),2,COMMAS=YES,MINUS=YES                          
         L     R9,STGROSS                                                       
         A     R9,STTAX                                                         
         EDIT  (R9),(13,D2TGR),2,COMMAS=YES,MINUS=YES                           
         L     R9,STNET                                                         
         A     R9,STTAX                                                         
         EDIT  (R9),(13,D2TNE),2,COMMAS=YES,MINUS=YES                           
         LA    R7,132(R7)                                                       
         LA    R6,STADEFLN(R6)                                                  
         BCT   R4,PRTSTOT2                                                      
         GOTO1 REPORT                                                           
         XIT1                                                                   
         EJECT                                                                  
* PROCESS MAKEGOOD SLAVE LINES                                                  
RDMGSLV  NTR1                                                                   
         MVC   SXBKEY,KEY          SAVE CURRENT KEYS                            
         MVC   SXBKSAVE,KEYSAVE                                                 
         LR    R4,R5                                                            
         ZIC   R0,1(R4)            EL LENGTH                                    
         SH    R0,=H'3'                                                         
         LA    R4,3(R4)                                                         
         MVC   SVREFLIN,0(R4)                                                   
         LA    R4,SVREFLIN                                                      
RDMGSLV2 LA    R5,KEY              SET TO READ POL POINTERS                     
         USING BUYREC,R5                                                        
         MVI   BUYKPRD,X'FF'                                                    
         XC    BUYKBUY,BUYKBUY                                                  
         MVC   BUYKBUY+1(1),0(R4)                                               
         MVI   BUYKBUY+2,X'01'                                                  
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   AREC,ADBUY                                                       
         GOTO1 GET                                                              
         GOTO1 =V(SPIM02),DMCB,(RA)                                             
         LA    R4,1(R4)                                                         
         BCT   R0,RDMGSLV2                                                      
         MVI   MGMODE,C'N'                                                      
         MVC   KEY,SXBKEY                                                       
         MVC   KEYSAVE,SXBKSAVE                                                 
         GOTO1 HIGH                                                             
         MVC   AREC,ADBUY                                                       
         GOTO1 GET                                                              
         XIT1                                                                   
         EJECT                                                                  
* ADD AN ITEM TO A TABLE                                                        
* INP = A(TABLE CONTROL ENTRY) A(INPUT DATA)                                    
ADDENT   NTR1  ADDENT                                                           
         L     R1,INP                                                           
         USING FPDEF,R1                                                         
         BAS   R9,CHKFULL          ENSURE ENOUGH ROOM                           
         L     RE,FPCADDR          SET MOVE TO ADDRESS                          
         L     R9,INP+4            SET MOVE FROM ADDRESS                        
         LH    R8,FPENTLN          SET LENGTH OF MOVE                           
         BCTR  R8,0                                                             
         EX    R8,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),0(R9)       MOVE TO CURRENT END +1                       
         ST    RE,FPLASTA          ADDRESS OF LAST REFERENCED ENTRY             
         LA    RE,1(RE)            UPDATE CURRENT END                           
         AR    RE,R8                                                            
         ST    RE,FPCADDR                                                       
         LH    RE,FPNOI            BUMP ITEM COUNTER                            
         LA    RE,1(RE)                                                         
         STH   RE,FPNOI            SET MAX COUNT                                
         STH   RE,FPLASTI          SET LAST REFERENCED COUNT                    
         XIT1                                                                   
         DROP  R1                                                               
         SPACE 2                                                                
* ADD A VARIABLE LENGTH ITEM TO A TABLE                                         
* INP = A(TABLE CONTROL ENTRY) A(INPUT DATA)                                    
VADDENT  NTR1  VADDENT                                                          
         L     R1,INP                                                           
         USING FPDEF,R1                                                         
         BAS   R9,CHKFULL          INSURE ENOUGH ROOM                           
         L     RE,12(R1)           SET MOVE TO ADDRESS                          
         L     R9,INP+4            SET MOVE FROM ADDRESS                        
         SR    R8,R8                                                            
         ICM   R8,3,0(R9)          SET LENGTH OF MOVE                           
         STM   RE,R1,DMCB                                                       
         LR    RF,RE               SETUP FOR VARIABLE LENGTH MOVE               
         LR    RE,R9                                                            
         LR    R1,R8                                                            
         MOVE  ((RF),(R1)),(RE)                                                 
         LM    RE,R1,DMCB                                                       
         ST    RE,FPLASTA          ADDRESS OF LAST REFERENCED ENTRY             
         AR    RE,R8                                                            
         ST    RE,FPCADDR                                                       
         LH    RE,FPNOI            BUMP ITEM COUNTER                            
         LA    RE,1(RE)                                                         
         STH   RE,FPNOI            SET MAX COUNT                                
         STH   RE,FPLASTI          SET REFERENCED COUNT                         
         XIT1                                                                   
         DROP  R1                                                               
         SPACE 2                                                                
* MAKE SURE THAT ONE ENTRY CAN FIT IN BUFFER                                    
* R1 = A(TABLE CONTROL ENTRY)                                                   
CHKFULL  L     RF,4(R1)            END OF ALLOCATED TABLE                       
         S     RF,12(R1)           END OF CURRENT TABLE                         
         CH    RF,10(R1)           WILL IT FIT                                  
         BNLR  R9                                                               
         BAS   RE,SLIDE            ADD SOME MORE TO THIS TABLE                  
         BR    R9                                                               
         EJECT                                                                  
* FIND A MATCHING ENTRY IN A BUFFER TABLE                                       
* INP= A(CONTROL TABLE),A(MATCH DATA),(DISP OF MATCH DATA),                     
*      (LENGTH OF MATCH DATA)                                                   
* RETURNS ENTRY NUMBER IN FPLASTI, A(ENTRY) IN FPLASTA                          
*   (OR)  ZERO IN FPLASTI, FPLASTA IF ITEM NOT FOUND                            
SCAN     NTR1                                                                   
         LM    R3,R6,0(R1)                                                      
         USING FPDEF,R3                                                         
         XC    FPLASTI,FPLASTI                                                  
         XC    FPLASTA,FPLASTA                                                  
         LH    R7,FPNOI            ANY ACTIVE ENTRIES                           
         LTR   R7,R7                                                            
         BZ    SCANX                                                            
         LA    R9,0                                                             
         L     R8,FPSADDR          GET START ADDRESS                            
         BCTR  R6,R0                                                            
         LH    RE,FPENTLN          GET LENGTH OF TABLE ENTRY                    
SCAN2    LA    R9,1(R9)                                                         
         LA    RF,0((R5),(R8))     SET FOR DISPLACEMENT                         
         EX    R6,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R4),0(RF)       SEE IF MATCH                                 
         BE    SCAN4                                                            
         AR    R8,RE                                                            
         BCT   R7,SCAN2            NO - TRY NEXT ENTRY                          
         B     SCANX                                                            
SCAN4    STH   R9,FPLASTI          SAVE INDEX                                   
         ST    R8,FPLASTA          SAVE ADDRESS                                 
SCANX    XIT1                                                                   
         EJECT                                                                  
* ALLOCATE CORE FOR VARIABLE LENGTH TABLES                                      
ALLOCT   L     RE,=V(COREBUF)                                                   
         LA    R1,FPSTA                                                         
         LR    RF,R9               SAVE RETURN                                  
ALLOCT2  CLI   0(R1),X'FF'         END                                          
         BER   RF                                                               
         SR    R8,R8                                                            
         SR    R9,R9                                                            
         LH    R8,8(R1)            GET NUMBER OF ENTRIES                        
         LH    R9,10(R1)           GET LENGTH OF EACH ENTRY                     
         MR    R8,R8               SET TABLE LENGTH                             
         ST    RE,0(R1)            SAVE START                                   
         ST    RE,12(R1)           SAVE CURRENT END                             
         AR    RE,R9                                                            
         ST    RE,4(R1)            SAVE TABLE END                               
         A     RE,=F'1'                                                         
         XC    16(8,R1),16(R1)     CLEAR OUT COUNTERS                           
         LA    R1,FPLN(R1)         DO NEXT                                      
         B     ALLOCT2                                                          
         EJECT                                                                  
* OPEN UP AN EXTRA CHUNK IN BUFFER                                              
* R1 POINTS TO TABLE DEFINITION                                                 
SLIDE    NTR1  SLIDE                                                            
         LA    RE,FPLN                                                          
         STH   RE,HALF                                                          
         LR    RE,R1               SEARCH FOR TABLE END                         
         LA    RE,FPLN(RE)                                                      
         CLI   0(RE),X'FF'         CHECK FOR END                                
         BNE   *-8                                                              
         SH    RE,HALF           DECREMENT 1 ENTRY                              
         LR    R4,R1               SAVE INTIAL POINTER                          
         L     R9,4(RE)            GET TABLE END                                
         L     R8,4(R1)                                                         
         LA    R8,1(R8)            SET FIRST POSITION TO MOVE                   
         SR    R9,R8               GET TOTAL LENGTH OF MOVE                     
         SR    R8,R8                                                            
         LH    R6,8(R1)            GET NUIMBER OF ENTRIES TO EXPAND             
         LH    R7,10(R1)           GET LENGTH OF EACH ENTRY                     
         MR    R6,R6               GET LENGTH OF SLOT TO OPEN                   
         LR    R6,R7               SAVE IT                                      
         CR    R1,RE               EXPAND LAST SLOT                             
         BE    SLDADJ              YES - ONLY ADJUST END POINTER                
         DR    R8,R7               GET NO. OF MOVES + REMAINDER                 
         SPACE 2                                                                
* NOW SLIDE TABLES                                                              
         L     RF,4(RE)            SET TO END OF CURRENT BUFFER                 
         LA    RE,0(RF)            SET MOVE TO ADDRESS                          
SLIDE1   LTR   R9,R9               ANY FIXED LENGTH MOVES                       
         BZ    SLIDE3              NO - SLIDE FOR REMAINDER                     
         SR    RF,R7               SET MOVE FROM START ADDRESS                  
         LR    R1,R7               LENGTH OF MOVE                               
         LR    R0,RF               SAVE IT                                      
         LR    RF,RE               INTERCHANGE REGISTERS                        
         LR    RE,R0                                                            
         MOVE  ((RF),(R1)),(RE)    MOVE IT                                      
         LR    RE,R0               SET NEXT MOVE TO                             
         LR    RF,RE               SET UP FOR NEXT MOVE                         
         BCT   R9,SLIDE1           DO IT AGAIN                                  
         SPACE 2                                                                
SLIDE2   LTR   R8,R8               ANY MORE TO MOVE                             
         BZ    SLDADJ               NO - ADJUST POINTERS                        
         SR    RF,R8               SET MOVE FROM                                
         LR    R1,R8               SET LENGTH                                   
         LR    R0,RF               INTERCHANGE REGISTERS                        
         LR    RF,RE                                                            
         LR    R9,R6               ADJUST THE POINTERS                          
         SR    R9,R8                                                            
         AR    RF,R9                                                            
         LR    RE,R0                                                            
         MOVE  ((RF),(R1)),(RE)    MOVE THE REST                                
         B     SLDADJ                                                           
SLIDE3   SR    RE,R8               BACK UP REMAINING LENGTH                     
         LR    RF,RE               SET TO START OF TABLE                        
         AR    RF,R6               BUMP BY SLIDE LENGTH                         
         LR    R1,R8               SET MOVE LENGTH                              
         MOVE  ((RF),(R1)),(RE)                                                 
         SPACE 2                                                                
* ADJUST POINTERS                                                               
SLDADJ   LR    R1,R4               RESTORE PARAMETER                            
         L     RE,4(R1)            ADJUST FIRST END                             
         AR    RE,R6                                                            
         ST    RE,4(R1)                                                         
SLDADJ2  LA    R1,FPLN(R1)         NEXT ENTRY                                   
         CLI   0(R1),X'FF'         END                                          
         BE    SLDXIT                                                           
         L     RE,0(R1)            ADJUST TABLE START                           
         AR    RE,R6                                                            
         ST    RE,0(R1)                                                         
         L     RE,4(R1)            ADJUST TABLE END                             
         AR    RE,R6                                                            
         ST    RE,4(R1)                                                         
         L     RE,12(R1)           ADJUST CURRENT END                           
         AR    RE,R6                                                            
         ST    RE,12(R1)                                                        
         L     RE,20(R1)           ADJUST LAST ACTIVE POINTER                   
         LTR   RE,RE                                                            
         BZ    SLDADJ2             NOT ACTIVE                                   
         AR    RE,R6                                                            
         ST    RE,20(R1)                                                        
         B     SLDADJ2             DO THE NEXT ONE                              
         SPACE 2                                                                
SLDXIT   XIT                                                                    
         LTORG                                                                  
         EJECT                                                                  
         DS    0D                                                               
         USING *,RF                                                             
MYHEAD   NTR1  BASE=SPIMRB                                                      
         L     R2,SPIMR2                                                        
         LM    RA,RC,SPIMRA                                                     
         DROP  RF                                                               
         L     R6,ADSTATAD                                                      
         USING ADDRREC,R6                                                       
         MVC   H4+44(20),ANAME                                                  
         MVC   H5+44(20),A1LINE                                                 
         MVC   H6+44(24),A2LINE                                                 
         MVC   H7+44(3),A3LINE                                                  
         MVC   H8+96(7),=C'STATION'                                             
         MVC   H8+108(7),BIGSTA                                                 
         CLI   QBYID,C'Y'                                                       
         BNE   MYH2                                                             
         MVC   H9(12),BUYIDNAM                                                  
         MVC   H9+13(12),BUYID                                                  
MYH2     DS    0H                                                               
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
SPIMRA   DS    F                                                                
SPIMRB   DS    F                                                                
SPIMRC   DS    F                                                                
SPIMR2   DS    F                                                                
COMPOS   DS    F                                                                
INP      DS    6D                                                               
***************************************************************                 
* START ADDRESS/END ADDRESS/NO. OF ENTRIES TO ADD WHEN FULL/  *                 
* LENGTH OF EACH ENTRY/CURRENT END                            *                 
* NUMBER OF ACTIVE ENTRIES/LAST ENTRY REFERENCED              *                 
* A(LAST ENTRY REFERENCED)                                    *                 
***************************************************************                 
FPSTA    DC    A(0),A(0),AL2(4),AL2(STADEFLN),A(0),AL2(0),AL2(0),A(0)           
FPCON    DC    A(0),A(0),AL2(20),AL2(CONDEFLN),A(0),AL2(0),AL2(0),A(0)          
FPPRG    DC    A(0),A(0),AL2(150),AL2(PRGDEFLN),A(0),AL2(0),AL2(0),A(0)         
FPLIN    DC    A(0),A(0),AL2(240),AL2(LINDEFLN),A(0),AL2(0),AL2(0),A(0)         
FPPRD    DC    A(0),A(0),AL2(20),AL2(PRDDEFLN),A(0),AL2(0),AL2(0),A(0)          
FPMM     DC    A(0),A(0),AL2(080),AL2(MMDEFLN),A(0),AL2(0),AL2(0),A(0)          
FPSPT    DC    A(0),A(0),AL2(080),AL2(SPTDEFLN),A(0),AL2(0),AL2(0),A(0)         
FPDT     DC    A(0),A(0),AL2(080),AL2(DTDEFLN),A(0),AL2(0),AL2(0),A(0)          
FPCOM    DC    A(0),A(0),AL2(3),AL2(3000),A(0),AL2(0),AL2(0),A(0)               
         DC    X'FF'                                                            
         SPACE 2                                                                
STOTCAPS DC    CL13'REGULAR'                                                    
         DC    CL13'MISSED'                                                     
         DC    CL13'MADEGOOD'                                                   
         DC    CL13'TOTAL'                                                      
SASVKEY  DS    CL30                                                             
PRVRDAT  DS    CL2                                                              
SVREQPRD DS    CL3                                                              
MGMODE   DS    C                                                                
ACTIVE   DS    C                                                                
SXBKEY   DS    CL13                                                             
SXBKSAVE DS    CL13                                                             
SVREFLIN DS    CL50                                                             
EST      DS    C                   CURRENT BUY DETAILS                          
LIN      DS    C                                                                
CBPRD    DS    CL1                                                              
CBDSEC   DS    CL1                                                              
CBDDAY   DS    CL1                                                              
CBBDMGD  DS    CL2                                                              
CBDMGS   DS    CL1                                                              
CBDCOST  DS    CL3                                                              
CBDTIME  DS    CL4                                                              
CMASTER  DS    C                   CURRENT MASTER LINE REFERENCE                
CMGDATE  DS    CL2                 CURRENT MAKEGOOD DATE                        
CMGSPOT  DS    CL1                                                              
         SPACE 2                                                                
CURRSPT  DS    0CL18               CURRENT ELEMENT DETAILS                      
CSACT    DS    C                                                                
CSPRD1   DS    C                                                                
CSSLN1   DS    C                                                                
CSPRD2   DS    C                                                                
CSSLN2   DS    C                                                                
CSDATE   DS    CL2                                                              
CSTIME   DS    CL4                                                              
CSCOST   DS    CL3                                                              
CSAFFTM  DS    CL2                                                              
CSAFFDY  DS    CL2                                                              
SPOTNO   DS    CL1                                                              
CPRGLNK  DS    CL2                 CURRENT PROGRAM LINK                         
CPRDLNK  DS    CL2                 CURRENT PRODUCT LINK                         
CCOMLNK  DS    CL2                 CURRENT COMMENT LINK                         
CCONLNK  DS    C                   CURRENT CONTRACT LINK                        
CDTLNK   DS    CL2                 CURRENT DAY/TIME LINK                        
         SPACE 2                                                                
GRSPOTS  DS    F                   GETRATE OUTPUT BUCKETS                       
GRGROSS  DS    F                   (TAX INCLUDED)                               
GRNET    DS    F                                                                
GRFAC    DS    F                                                                
GXTSPOTS DS    F                   GETRATE OUTPUT BUCKETS                       
GXTGROSS DS    F                   (TAX EXCLUDED)                               
GXTNET   DS    F                                                                
GXTFAC   DS    F                                                                
SVMGSPT  DS    F                                                                
BLDAREA  DS    3000C                                                            
COREBUF  CSECT                                                                  
         DS    180000C                                                          
FPDEF    DSECT                                                                  
FPDEFST  DS    0C                                                               
FPSADDR  DS    CL4                 START OF TABLE                               
FPEADDR  DS    CL4                 END OF TABLE SPACE                           
FPIENT   DS    CL2                 NUMBER OF ENTRIES TO ADD WHEN FULL           
FPENTLN  DS    CL2                 ENTRY LEN (MAX SIZE FOR VLEN ITEMS)          
FPCADDR  DS    CL4                 CURRENT END                                  
FPNOI    DS    CL2                 NUMER OF ACTIVE ITEMS                        
FPLASTI  DS    CL2                 NUMBER OF LAST ITEM REFERENCED               
FPLASTA  DS    CL4                 ADDR OF LAST ITEM REFERENCED                 
FPDEFEN  DS    0C                                                               
FPLN     EQU   FPDEFEN-FPDEFST                                                  
         EJECT                                                                  
CONDEF   DSECT                     ***CONTRACT DEFINITION TABLE***              
CDCONNUM DS    CL11                CONTRACT NUMBER                              
CDORGSLT DS    C                   ORIGINAL TABLE SLOT                          
CONDEFEN DS    0C                                                               
CONDEFLN EQU   CONDEFEN-CDCONNUM                                                
         SPACE 2                                                                
PRGDEF   DSECT                     ***PROGRAM NAME TABLE***                     
PRGDEFST DS    0C                                                               
PDNAME   DS    CL16                PROGRAM NAME                                 
PDORGSLT DS    C                   ORIG. SLOT NUMBER                            
PRGDEFEN DS    0C                                                               
PRGDEFLN EQU   PRGDEFEN-PRGDEFST                                                
         SPACE 2                                                                
COMDEF   DSECT                     ***COMMENT SAVE AREA***                      
CDLKNXT  DS    CL2                 DISP. TO NEXT COMMENT GROUP                  
CDLN     DS    C                   LENGTH OF THIS COMMENT                       
CDCOMENT DS    0C                  ACTUAL COMMENT                               
         SPACE 2                                                                
LINDEF   DSECT                     ***LINE DEFINITION TABLE                     
LINDEFST DS    0C                                                               
LDEST    DS    C                   ESTIMATE NUMBER                              
LDLIN    DS    C                   LINE NUMBER                                  
LDPRGLNK DS    CL2                 LINK TO PROGRAM NAME TABLE                   
LDCOMLNK DS    CL2                 LINK TO COMMENT TABLE                        
LDCONLNK DS    C                   LINK TO CONTACT TABLE                        
LDDTLNK  DS    CL2                 LINK TO DAY/TIME TABLE                       
LDSLN    DS    C                   SPOT LENGTH                                  
LDDAYS   DS    C                   DAYS                                         
LINDEFEN DS    0C                                                               
LINDEFLN EQU   LINDEFEN-LINDEFST                                                
         SPACE 2                                                                
PRDDEF   DSECT                     ***PRODUCT DEFINFITION TABLE                 
PRDDEFST DS    0C                                                               
PRPRD1   DS    CL1                 PRODUCT 1                                    
PRSLN1   DS    C                   SPOT LENGTH 1                                
PRPRD2   DS    CL1                 PRODUCT 2                                    
PRSLN2   DS    CL1                 SPOT LENGTH 2                                
PRDDEFEN DS    0C                                                               
PRDDEFLN EQU   PRDDEFEN-PRDDEFST                                                
         SPACE 2                                                                
DTDEF    DSECT                     ***DAY/TIME DEFINITION TABLE***              
DTDEFST  DS    0C                                                               
DTSDAT   DS    CL2                 START DATE                                   
DTTIME   DS    CL4                 START/END TIME                               
DTORGSLT DS    CL2                 ORIGINAL SLOT                                
DTDEFEN  DS    0C                                                               
DTDEFLN  EQU   DTDEFEN-DTDEFST                                                  
         SPACE 2                                                                
MMDEF    DSECT                     ***MISSED/MAKEGOOD REF.TABLE                 
MMDEFST  DS    0C                                                               
MMESTREF DS    C                   REF. EST                                     
MMLINREF DS    C                   REF. LINE                                    
MMDTLNK  DS    CL2                 DAY/TIME LINK                                
MMPRLNK  DS    CL2                 PRODUCT/SLN LINK                             
MMCOST   DS    CL4                 SPOT COST                                    
MMPDLNK  DS    CL1                 PROGRAM TABLE LINK                           
MMCDLINK DS    CL1                 COMMENT TABLE LINK                           
MMEST    DS    C                   EST FOR THIS SPOT                            
MMLIN    DS    C                   LIN FOR THIS SPOT                            
MMDEFEN  DS    0C                                                               
MMDEFLN  EQU   MMDEFEN-MMDEFST                                                  
         SPACE 2                                                                
SPTDEF   DSECT                     ***SPOT DEFINITION TABLE***                  
SPTDEFST DS    0C                                                               
SDEST    DS    CL1                 ESTIMATE                                     
SDLIN    DS    CL1                 LINE                                         
SDSPTNO  DS    CL1                 SPOT NUMBER WITHIN LINE                      
SDDATE   DS    CL2                 SPOT DATE                                    
SDCOST   DS    CL3                 COST                                         
SDPRLNK  DS    CL2                 PRODUCT/SPOT LENGTH LINK                     
SDSTATUS DS    CL1                 X'01'=MISSED/X'02'=MKGD                      
SDAFFTM  DS    CL2                 AFFIDAVIT TIME                               
SDAFFDY  DS    CL2                 AFFIDAVIT DAY                                
SDMMREF  DS    CL2                 MISSED/MKGD REF.                             
SPTDEFEN DS    0C                                                               
SPTDEFLN EQU   SPTDEFEN-SPTDEFST                                                
         SPACE 2                                                                
STADEF   DSECT                     ***STATION TOTAL BUCKETS***                  
STDEFST  DS    0C                                                               
STSPOTS  DS    CL4                                                              
STGROSS  DS    CL4                                                              
STNET    DS    CL4                                                              
STTAX    DS    CL4                                                              
STDEFEN  DS    0C                                                               
STADEFLN EQU   STDEFEN-STDEFST                                                  
         EJECT                                                                  
* PRINTLINE DSECTS                                                              
D1DEF    DSECT                                                                  
D1DEFST  DS    0C                                                               
D1DAT    DS    CL8                                                              
         DS    CL5                                                              
D1DAYS   DS    CL8                                                              
         DS    CL3                                                              
D1TIME   DS    CL12                                                             
         DS    CL1                                                              
D1LEN    DS    CL3                                                              
         DS    CL1                                                              
D1PRDS   DS    0CL7                                                             
D1PRD1   DS    CL3                                                              
D1PRDSH  DS    C                                                                
D1PRD2   DS    CL3                                                              
         DS    CL1                                                              
D1OCOST  DS    CL12                                                             
         DS    CL2                                                              
D1EL     DS    0CL7                                                             
D1EST    DS    CL3                                                              
D1ELDSH  DS    C                                                                
D1LIN    DS    CL3                                                              
         DS    CL1                                                              
D1PRG    DS    CL10                                                             
         DS    CL1                                                              
D1MTYP   DS    CL4                                                              
         DS    CL2                                                              
D1MDAT   DS    CL8                                                              
         DS    CL6                                                              
D1MDAYS  DS    CL6                                                              
         DS    CL1                                                              
D1MTIM   DS    CL11                                                             
         DS    CL1                                                              
D1MEL    DS    0CL7                                                             
D1MEST   DS    CL3                                                              
D1MELDSH DS    C                                                                
D1MLIN   DS    CL3                                                              
D1DEFEN  DS    0C                                                               
         ORG   D1DAYS                                                           
D1OCOM   DS    CL40                                                             
         ORG   D1MTYP                                                           
D1MCOM   DS    CL40                                                             
         ORG   D1DEFEN                                                          
D1DEFLN  EQU   D1DEFEN-D1DEFST                                                  
         SPACE 2                                                                
D2DEF    DSECT                                                                  
D2DEFST  DS    0C                                                               
D2RPTCAP DS    CL13                                                             
         DS    CL4                                                              
D2SPT    DS    CL5                                                              
         DS    CL1                                                              
D2GRS    DS    CL13                                                             
         DS    CL1                                                              
D2NET    DS    CL13                                                             
         DS    CL1                                                              
D2TAX    DS    CL13                                                             
         DS    CL1                                                              
D2TGR    DS    CL13                                                             
         DS    CL1                                                              
D2TNE    DS    CL13                                                             
D2DEFEN  DS    0C                                                               
D2DEFLN  EQU   D2DEFEN-D2DEFST                                                  
         PRINT OFF                                                              
       ++INCLUDE SPREPWORKD                                                     
       ++INCLUDE SPREPMODES                                                     
       ++INCLUDE SPGENBUY                                                       
       ++INCLUDE SPGENADD                                                       
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'029SPREPIM02 05/01/02'                                      
         END                                                                    
