*          DATA SET REDARLR01  AT LEVEL 157 AS OF 12/21/02                      
         TITLE 'REDARLR01 - LR ROUTINE COMMON CODE '                            
***********************************************************************         
*                                                                     *         
*  REDARLR01                                                          *         
*                                                                     *         
* ------------------------------------------------------------------- *         
* UPDATE HISTORY:                                                     *         
* 20DEC02 (BU ) INITIAL RELEASE                                       *         
*                                                                     *         
*                                                                     *         
*               ***  END TOMBSTONE  ***                               *         
***********************************************************************         
LR       DS    0H                                                               
         GOTO1 =A(LRADDR),RR=RELO                                               
LR10     DS    0H                                                               
         CLI   DE1HDLNH+5,0                                                     
         BE    LR40                                                             
*                                                                               
         LR    RF,RA                                                            
         AHI   RF,DARPROFS-CONHEADH                                             
         USING SVDSECT,RF                                                       
         TM    DMISFLGX,X'40'      MASTER REP SIGNED ON?                        
         BO    LR40                YES - USE LONG SCREEN                        
*                                                                               
         DROP  RF                                                               
*                                                                               
         GOTO1 =A(SWAPHDRS),DMCB,DE5LHEDH,RR=RELO                               
         CLI   MYSCRNUM,X'E5'      SHORT LIST SCREEN ALREADY LOADED?            
         BNE   LR20                                                             
         TWAXC DE5AGYCH,DE5ESTH    YES, CLEAR IT                                
         TWAXC DE5SELH,DE5LLINH,PROT=Y                                          
         B     LR30                                                             
                                                                                
* LOAD LOWER SCREEN                                                             
LR20     DS    0H                                                               
         GOTO1 CALLOV,DMCB,DE1TAGH,X'D9080FE5'                                  
         CLI   DMCB+4,X'FF'                                                     
         BNE   *+6                                                              
         DC    H'0'                                                             
         MVI   MYSCRNUM,X'E5'                                                   
LR30     DS    0H                                                               
         LA    R2,DE5SELH          SET FOR GENCON CURSOR POSITION               
         ST    R2,AFRSTREC                                                      
         LA    R2,DE5STATH                                                      
         ST    R2,ATHISLST                                                      
         OI    DE5SELH+6,X'40'     FORCE CURSOR HERE                            
                                                                                
*                                  DISPLAY CONTRACT INFORMATION                 
         GOTO1 =A(SUBROUT),DMCB,(RC),('QDISCON',0),RR=RELO                      
         MVC   DE5LAST+1(2),=X'0101' RETRANSMIT ENTIRE SCREEN                   
         B     LR70                                                             
                                                                                
LR40     DS    0H                                                               
         CLI   ONELINE,C'Y'        SINGLE LINE DISPLAY?                         
         BNE   LR45                NO  - DO DOUBLE LINE CHECK                   
         CLI   MYSCRNUM,X'E6'      LONG LIST SCREEN ALREADY LOADED?             
         BNE   LR50                                                             
         CLC   =C'Act',DE6HDR1                                                  
         BNE   LR50                ADDITIONAL CHECK TO INSURE SCREEN IS         
*                                  LOADED                                       
         TWAXC DE6SELH,DE6LLIN,PROT=Y YES, CLEAR IT                             
**       MVC   DE6PFLN(17),=C'PF2 Makegood List'                                
         B     LR60                                                             
                                                                                
* LOAD LOWER SCREEN                                                             
LR45     DS    0H                                                               
         CLI   MYSCRNUM,X'E3'      LONG LIST SCREEN ALREADY LOADED?             
         BNE   LR50                                                             
         CLC   =C'ACT',DARHDR1                                                  
         BNE   LR50                ADDITIONAL CHECK TO INSURE SCREEN IS         
*                                  LOADED                                       
         TWAXC DARSELH,DARLLIN,PROT=Y YES, CLEAR IT                             
**       MVC   DARPFLN(17),=C'PF2 MAKEGOOD LIST'                                
         B     LR60                                                             
                                                                                
* LOAD LOWER SCREEN                                                             
LR50     DS    0H                                                               
         CLI   ONELINE,C'Y'        SINGLE LINE DISPLAY?                         
         BNE   LR55                NO  - LOAD DOUBLE LINE SCREEN                
         GOTO1 CALLOV,DMCB,DE1TAGH,X'D9080FE6'                                  
*                                  LOAD SINGLE LINE SCREEN                      
         MVI   MYSCRNUM,X'E6'                                                   
         B     LR57                                                             
LR55     DS    0H                                                               
         GOTO1 CALLOV,DMCB,DE1TAGH,X'D9080FE3'                                  
*                                  LOAD DOUBLE LINE SCREEN                      
         MVI   MYSCRNUM,X'E3'                                                   
LR57     DS    0H                                                               
         CLI   DMCB+4,X'FF'                                                     
         BNE   *+6                                                              
         DC    H'0'                                                             
*                                                                               
LR60     DS    0H                                                               
         CLI   ONELINE,C'Y'        SINGLE LINE DISPLAY?                         
         BNE   LR62                NO  - LOAD DOUBLE LINE SCREEN                
         GOTO1 =A(SWAPHDRS),DMCB,DE6HDR1H,RR=RELO                               
         LA    R2,DE6SELH          SET FOR GENCON CURSOR POSITION               
         ST    R2,AFRSTREC                                                      
         LA    R2,DE6STATH                                                      
         ST    R2,ATHISLST                                                      
         OI    DE6SELH+6,X'40'     FORCE CURSOR HERE                            
*                                                                               
         MVC   DE6LAST+1(2),=X'0101' RETRANSMIT ENTIRE SCREEN                   
*                                                                               
         B     LR65                                                             
LR62     EQU   *                                                                
         GOTO1 =A(SWAPHDRS),DMCB,DARHDR1H,RR=RELO                               
         LA    R2,DARSELH          SET FOR GENCON CURSOR POSITION               
         ST    R2,AFRSTREC                                                      
         LA    R2,DARSTATH                                                      
         ST    R2,ATHISLST                                                      
         OI    DARSELH+6,X'40'     FORCE CURSOR HERE                            
*                                                                               
         MVC   DARLAST+1(2),=X'0101' RETRANSMIT ENTIRE SCREEN                   
*                                                                               
LR65     DS    0H                                                               
         L     R3,ATHISLST                                                      
         CLI   MODE,PRINTREP       PRINT REPORT?                                
         BNE   LR650010            NO                                           
         LA    R3,PRNTWORK         SET A(PRINT LINE)                            
LR650010 EQU   *                                                                
         CLI   DE1HDLNH+5,0        CONTRACT # ENTERED?                          
         BE    LR70                NO                                           
*                                                                               
         LR    RF,RA               YES                                          
         AHI   RF,DARPROFS-CONHEADH                                             
         USING SVDSECT,RF                                                       
         TM    DMISFLGX,X'40'      MASTER REP SIGNED ON?                        
         BNO   LR70                NO  - REGULAR PROCESSING                     
*                                                                               
         DROP  RF                                                               
*                                                                               
LR650020 EQU   *                                                                
         GOTO1 =A(CYCLCON),DMCB,(RC),RR=RELO                                    
*                                                                               
         CLI   HALF,X'FF'          FINISHED?                                    
         BE    LRX                 YES - END OF DISPLAY                         
         CLI   HALF,X'00'          AGENCY ORDER FOUND?                          
         BE    LR210               YES - DISPLAY IT                             
*                                                                               
*   LR210    MAY OR MAY NOT BE THE CORRECT ENTRY POINT FOR DISPLAY              
*                                                                               
         DC    H'0'                UNIDENTIFIED RETURN                          
LR70     DS    0H                                                               
         XC    MYLISTDA,MYLISTDA   BUILD LIST OF DISK ADDRESSES                 
         LA    R4,MYLISTDA         FOR ACTION PRINT                             
                                                                                
         TM    CTLRFLG1,CF11STKY   REDISPLAY PAGE?                              
         BZ    LR80                                                             
         NI    CTLRFLG1,X'FF'-CF11STKY                                          
         MVC   SELCTKEY,FIRSTKEY                                                
*                                                                               
LR80     DS    0H                                                               
         CLC   =C'BRAND',CONREC                                                 
         BE    LR90                                                             
         TM    CTLRFLG1,CF1BRDQ                                                 
         BO    LR90                                                             
         OC    SELCTKEY(27),SELCTKEY                                            
         BZ    LR90                                                             
         MVC   KEY,SELCTKEY                                                     
         MVC   REDITYPE,KEY+1      RESET SUBKEY TYPE                            
         LA    R3,KEY              RESET R3 FOR ADDRESSABILITY IN LR100         
         XC    SELCTKEY,SELCTKEY                                                
         MVI   DUB+1,1             TEST INDICATOR                               
         B     LR100                                                            
*                                                                               
LR90     DS    0H                                                               
         LA    R6,KEY                                                           
         USING RDARKEY,R6                                                       
*                                                                               
         NI    CTLRFLG1,X'FF'-CF1BRDQ                                           
         CLI   KEY,X'41'           KEY ALREADY SET TO DARE REC?                 
         BE    LR900020            YES                                          
         CLI   KEY,X'51'           KEY ALREADY SET TO DARE REC?                 
         BNE   LR900040            NO                                           
LR900020 EQU   *                                                                
         MVC   KEY(27),SAVRADKY    YES - RESET IT TO RADKEY                     
         MVC   KEYLOOK,KEY         SAVE CHARACTERISTICS OF KEY                  
         LA    R3,KEY              RESET A(KEY) FOR USING                       
         GOTO1 HIGH                READ (ACTUALLY, REREAD) THIS KEY             
         MVI   DMINBTS,0                                                        
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                 READ THE NEXT KEY FOR RESTART                
         B     LR110                                                            
LR900040 EQU   *                                                                
         DROP  R6                                                               
*                                                                               
         LA    R3,KEY                                                           
         USING RDARKEY,R3                                                       
         MVI   RED01TYP,X'D0'      SET TO 'MASTER/UNWIRED'                      
*                                                                               
*   FOR THE TIME BEING, MASTER IDENTIFICATION IS HARD-CODED.  WE CAN            
*        MAKE IT NEEDLESSLY COMPLICATED AT A LATER DATE.                        
*                                                                               
         CLC   =C'MR',AGENCY       KATZ TV?                                     
         BE    LR98                YES                                          
         CLC   =C'K3',AGENCY       KATZ RADIO?                                  
         BE    LR98                YES                                          
         CLC   =C'IR',AGENCY       INTEREP?                                     
         BE    LR98                YES                                          
         CLC   =C'MS',AGENCY       TEST?                                        
         BE    LR98                YES                                          
         MVI   RED01TYP,X'D1'      NO  - SET TO 'SPOT'                          
         ZIC   RF,REDITYPE         BUMP KEY TYPE BY 1                           
         LA    RF,1(RF)                                                         
         STC   RF,REDITYPE                                                      
         CLI   DE1UNW,C'Y'         SPECIAL OVERRIDE TO UNWIRED?                 
         BNE   LR98                NO  - PROCEED WITH KEY AS SET                
         MVI   RED01TYP,X'D0'      NO  - SET TO 'UNWIRED' - NOW IT'S            
*                                     'UNWIRED/NON-MASTER'                      
LR98     EQU   *                                                                
         MVC   RED01MRP,AGENCY     INSERT AGENCY OF SIGNON                      
         CLI   RED01TYP,X'D0'      MASTER REP IN PROGRESS?                      
         BNE   LR100               NO  - DON'T OVERRIDE SUB REP                 
*                                                                               
         OC    COMPREP,COMPREP     YES - COMPANY CODE ENTERED?                  
         BZ    LR100               NO  - LEAVE ALONE                            
         MVC   RED01MRP,COMPREP    YES - INSERT COMPANY REP INTO KEY            
         CLC   =C'UNW',DE1RQTR     SPECIAL OVERRIDE TO UNWIRED?                 
         BE    LR100               YES - REDITYPE ALREADY ADVANCED              
         ZIC   RF,REDITYPE         BUMP KEY TYPE BY 1 TO SUB REP                
         LA    RF,1(RF)                                                         
         STC   RF,REDITYPE                                                      
LR100    DS    0H                                                               
         MVC   RED01TYP+1(1),REDITYPE                                           
*                                  SET SUBKEY TYPE                              
         MVC   KEYLOOK,RED01KEY    SAVE CHARACTERISTICS OF KEY                  
LR100020 EQU   *                                                                
         MVI   DMINBTS,0                                                        
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
                                                                                
LR110    DS    0H                                                               
         CLI   CONFILT,C'Y'        WAS CON# REQUESTED FOUND?                    
         BE    LRX                 YES - NO FURTHER SEARCH                      
         CLC   KEYLOOK,KEY         SAME KEY TYPE/REP?                           
         BNE   LRX                 NO  - FINISHED SCAN                          
*                                                                               
         GOTO1 =A(RECDATCK),RR=RELO                                             
         BNZ   LRSEQ               FILTERED OUT BY RECV DATE                    
*                                                                               
         GOTO1 =A(INBOXCHK),DMCB,KEYDEFTB,RR=RELO                               
         BNZ   LRSEQ               FILTERED OUT BY INBOX CHECK                  
*                                                                               
         GOTO1 =A(STATNCHK),DMCB,KEYDEFTB,RR=RELO                               
         BNZ   LRSEQ               FILTERED OUT BY STATION CHECK                
*                                                                               
*   TEST DUMP                                                                   
*&&DO                                                                           
         LA    RF,KEY-8                                                         
         CLI   KEY+27,X'FF'        DELETED KEY?                                 
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLC   =X'23250021',KEY+20 PROCESS ONLY A SINGLE ORDER                  
         BNE   LRSEQ                                                            
****     MVC   DIE(2),=X'0000'                                                  
TEST0020 EQU   *                                                                
*&&                                                                             
         MVI   PENDCF,0            CLEAR FLAG                                   
*                                                                               
         CLI   DE1HDLNH+5,0        ANY CON # ENTERED?                           
         BE    LR115010            NO  -                                        
         OC    CDARNUM,CDARNUM     SKIP IF THERE ARE NONE                       
         BZ    LRX                                                              
         LA    RF,KEYDEFTB         SET A(KEY DEFINITION TABLE)                  
LR115005 EQU   *                                                                
         CLI   0(RF),X'FF'         END OF TABLE?                                
         BNE   *+6                 NO                                           
         DC    H'0'                MUST BE IN TABLE                             
         CLC   RED01TYP+1(1),DREDTYPE(RF)                                       
*                                  RECORD TYPE FOUND IN TABLE?                  
         BE    LR115006            YES                                          
         LA    RF,KEYDEFLN(RF)     NO  - BUMP TO NEXT TABLE ENTRY               
         B     LR115005            GO BACK FOR NEXT                             
LR115006 EQU   *                                                                
         ZIC   RE,DORDER#(RF)      GET DISPLACEMENT TO ORDER NUMBER             
         LA    RF,KEY              SET A(KEY IN PROGRESS)                       
         AR    RF,RE               DISPLACE TO ORDER NUMBER                     
         CLC   CDARNUM,0(RF)       LOOKING FOR THIS CONTRACT NUMBER?            
         BNE   LRSEQ               NO  - SKIP IT                                
         B     LR270               YES - ACCEPT ORDER                           
*                                                                               
LR115010 EQU   *                                                                
         CLI   STATFILT,C'F'       FILTER ON CONFIRMED?                         
         BNE   LR115020            NO  -                                        
         TM    KEY+27,X'04'        YES - 'CONFIRMED' SET IN STATUS?             
         BO    LR270               YES - ACCEPT THIS ORDER                      
         MVI   PENDCF,1            NO  - SET 'F-FILTER, NOT CF'                 
         B     LR213B10                                                         
*                                                                               
LR115020 EQU   *                                                                
*                                                                               
*   NOT 'FILTER ON CONFIRMED': REJECT ALL CONFIRMED FOR DISPLAY                 
*                                                                               
DIE      DS    0H                                                               
         LR    RF,RA                                                            
         AH    RF,=AL2(DARPROFS-CONHEADH)                                       
         USING SVDSECT,RF                                                       
         OC    CAMPFLD1(12),CAMPFLD1                                            
*                                  ANY CAMPAIGN FILTER?                         
         BNZ   LR120               YES - INCLUDE 'CONFIRMED' ORDERS             
*                                                                               
         DROP  RF                                                               
*                                                                               
         TM    KEY+27,X'04'        YES - 'CONFIRMED' SET IN STATUS?             
         BO    LRSEQ               YES - REJECT THIS ORDER                      
         B     LR120                                                            
         EJECT                                                                  
********************************************************************            
*   KEY DEFINITION FOR FIELDS:                                                  
*        BYTE  1  =  RECORD SUBKEY TYPE                                         
*        BYTE  2  =  DISPLACEMENT TO STATION IN KEY: X'FF' = READ               
*                                  RECORD FOR DATA                              
*        BYTE  3  =  DISPLACEMENT TO                                            
*        BYTE  4  =  DISPLACEMENT TO                                            
*                                                                               
*   TYPE 1 RECORD                                                               
KEYDEFTB DC    AL1(1,255)                                                       
         DC    AL1(RED01RAG-RED01TYP)                                           
         DC    AL1(RED01ORD-RED01TYP)                                           
         DC    AL1(254)            DUMMY: NO DATA FOR THIS RECORD TYPE          
         DC    AL1(254)            DUMMY: NO DATA FOR THIS RECORD TYPE          
KEYDEFLN EQU   *-KEYDEFTB                                                       
*   TYPE 2 RECORD                                                               
         DC    AL1(2,255)                                                       
         DC    AL1(RED02RAG-RED02TYP)                                           
         DC    AL1(RED02ORD-RED02TYP)                                           
         DC    AL1(254)            DUMMY: NO DATA FOR THIS RECORD TYPE          
         DC    AL1(254)            DUMMY: NO DATA FOR THIS RECORD TYPE          
*   TYPE 3 RECORD                                                               
         DC    AL1(3,RED03STA-RED03TYP)                                         
         DC    AL1(RED03RAG-RED03TYP)                                           
         DC    AL1(RED03ORD-RED03TYP)                                           
         DC    AL1(RED03PP-RED03TYP)                                            
         DC    AL1(254)            DUMMY: NO DATA FOR THIS RECORD TYPE          
*   TYPE 4 RECORD                                                               
         DC    AL1(4,RED04STA-RED04TYP)                                         
         DC    AL1(RED04RAG-RED04TYP)                                           
         DC    AL1(RED04ORD-RED04TYP)                                           
         DC    AL1(RED04PP-RED04TYP)                                            
         DC    AL1(254)            DUMMY: NO DATA FOR THIS RECORD TYPE          
*   TYPE 5 RECORD                                                               
         DC    AL1(5,RED05STA-RED05TYP)                                         
         DC    AL1(RED05RAG-RED05TYP)                                           
         DC    AL1(RED05ORD-RED05TYP)                                           
         DC    AL1(RED05PP-RED05TYP)                                            
         DC    AL1(RED05BYR-RED05TYP)                                           
*   TYPE 6 RECORD                                                               
         DC    AL1(6,RED06STA-RED06TYP)                                         
         DC    AL1(RED06RAG-RED06TYP)                                           
         DC    AL1(RED06ORD-RED06TYP)                                           
         DC    AL1(RED06PP-RED06TYP)                                            
         DC    AL1(RED06BYR-RED06TYP)                                           
*   TYPE 7 RECORD                                                               
         DC    AL1(7,RED07STA-RED07TYP)                                         
         DC    AL1(RED07RAG-RED07TYP)                                           
         DC    AL1(RED07ORD-RED07TYP)                                           
         DC    AL1(RED07PP-RED07TYP)                                            
         DC    AL1(254)            DUMMY: NO DATA FOR THIS RECORD TYPE          
*   TYPE 8 RECORD                                                               
         DC    AL1(8,RED08STA-RED08TYP)                                         
         DC    AL1(RED08RAG-RED08TYP)                                           
         DC    AL1(RED08ORD-RED08TYP)                                           
         DC    AL1(RED08PP-RED08TYP)                                            
         DC    AL1(254)            DUMMY: NO DATA FOR THIS RECORD TYPE          
*   TYPE 9 RECORD                                                               
         DC    AL1(9,RED09STA-RED09TYP)                                         
         DC    AL1(RED09RAG-RED09TYP)                                           
         DC    AL1(RED09ORD-RED09TYP)                                           
         DC    AL1(RED09PP-RED09TYP)                                            
         DC    AL1(254)            DUMMY: NO DATA FOR THIS RECORD TYPE          
*   TYPE 10 RECORD                                                              
         DC    AL1(10,RED0ASTA-RED0ATYP)                                        
         DC    AL1(RED0ARAG-RED0ATYP)                                           
         DC    AL1(RED0AORD-RED0ATYP)                                           
         DC    AL1(RED0APP-RED0ATYP)                                            
         DC    AL1(254)            DUMMY: NO DATA FOR THIS RECORD TYPE          
*   DELIMITER                                                                   
         DC    X'FF'                                                            
         DS    0H                                                               
*                                                                               
*                                                                               
DREDTYPE EQU   0                                                                
DSTATION EQU   1                                                                
DAGENCY  EQU   2                                                                
DORDER#  EQU   3                                                                
DPOINTP  EQU   4                                                                
DBUYER   EQU   5                                                                
*                                                                               
LR120    DS    0H                                                               
         CLI   DE1AGYH+5,0         FILTER ON AGENCY                             
         BE    LR140                                                            
         LA    RF,KEYDEFTB         SET A(KEY DEFINITION TABLE)                  
LR120020 EQU   *                                                                
         CLI   0(RF),X'FF'         END OF TABLE?                                
         BNE   *+6                 NO                                           
         DC    H'0'                MUST BE IN TABLE                             
         CLC   RED01TYP+1(1),DREDTYPE(RF)                                       
*                                  RECORD TYPE FOUND IN TABLE?                  
         BE    LR120040            YES                                          
         LA    RF,KEYDEFLN(RF)     NO  - BUMP TO NEXT TABLE ENTRY               
         B     LR120020            GO BACK FOR NEXT                             
LR120040 EQU   *                                                                
         ZIC   RE,DAGENCY(RF)      GET DISPLACEMENT TO AGENCY CODE              
         LA    RF,KEY              SET A(KEY IN PROGRESS)                       
         AR    RF,RE               DISPLACE TO AGENCY CODE                      
         LA    RE,AGYFILT          LOAD A(EQUIV AGENCY CODE FILTERS)            
         LA    R1,4                                                             
LR130    DS    0H                                                               
         OC    0(5,RE),0(RE)                                                    
         BZ    LRSEQ                                                            
         CLC   0(5,RE),SPACES                                                   
         BE    LRSEQ                                                            
         CLC   0(5,RE),0(RF)       COMPARE VS AGENCY IN KEY                     
         BE    LR140                                                            
         LA    RE,5(RE)                                                         
         BCT   R1,LR130                                                         
         B     LRSEQ                                                            
*                                                                               
LR140    DS    0H                                                               
*                                                                               
         MVI   ERRFLAG,C'N'                                                     
         CLI   DE1HDLNH+5,0        IF CON# SPECIFIED, LIST ONLY THE             
         BE    LR150                AGENCY ORDER LINKED TO THIS CON#            
         MVI   CONFILT,C'N'        SET 'CONTRACT NOT FOUND' FLAG                
         OC    CDARNUM,CDARNUM     SKIP IF THERE ARE NONE                       
         BZ    LRX                                                              
         LA    RF,KEYDEFTB         SET A(KEY DEFINITION TABLE)                  
LR140020 EQU   *                                                                
         CLI   0(RF),X'FF'         END OF TABLE?                                
         BNE   *+6                 NO                                           
         DC    H'0'                MUST BE IN TABLE                             
         CLC   RED01TYP+1(1),DREDTYPE(RF)                                       
*                                  RECORD TYPE FOUND IN TABLE?                  
         BE    LR140040            YES                                          
         LA    RF,KEYDEFLN(RF)     NO  - BUMP TO NEXT TABLE ENTRY               
         B     LR140020            GO BACK FOR NEXT                             
LR140040 EQU   *                                                                
         ZIC   RE,DORDER#(RF)      GET DISPLACEMENT TO ORDER NUMBER             
         LA    RF,KEY              SET A(KEY IN PROGRESS)                       
         AR    RF,RE               DISPLACE TO ORDER NUMBER                     
         CLC   CDARNUM,0(RF)       LOOKING FOR THIS CONTRACT NUMBER?            
         BNE   LRSEQ               NO  - SKIP IT                                
         MVI   CONFILT,C'Y'        SET 'CONTRACT FOUND' FLAG                    
         DROP  R3                                                               
                                                                                
LR150    DS    0H                                                               
*                                                                               
*   RECEIVED DATE FILTER WAS AT THIS POINT.  UNDER CERTAIN CONDITIONS,          
*        IT WASN'T BEING TESTED.  IT HAS BEEN MOVED TO EARLIER IN THE           
*        CYCLE.  IT HAS BEEN SET AS A LABEL=* FOR ADDRESSABILITY.               
*                                                                               
         CLI   DE1GRPH+5,0         IF EITHER GROUP OR TEAM FILTER               
         BNE   LR160               REQUESTED, READ STATION RECORD               
         CLI   DE1TEAMH+5,0        IN ORDER TO VALIDATE                         
         BE    LR205                                                            
                                                                                
LR160    DS    0H                  GET GROUP AND TEAM CODES                     
         LA    R3,KEY                                                           
         USING RDARKEY,R3                                                       
         XC    MYWORK,MYWORK                                                    
         LA    RF,KEYDEFTB         SET A(KEY DEFINITION TABLE)                  
LR160020 EQU   *                                                                
         CLI   0(RF),X'FF'         END OF TABLE?                                
         BNE   *+6                 NO                                           
         DC    H'0'                MUST BE IN TABLE                             
         CLC   RED01TYP+1(1),DREDTYPE(RF)                                       
*                                  RECORD TYPE FOUND IN TABLE?                  
         BE    LR160040            YES                                          
         LA    RF,KEYDEFLN(RF)     NO  - BUMP TO NEXT TABLE ENTRY               
         B     LR160020            GO BACK FOR NEXT                             
LR160040 EQU   *                                                                
*                                                                               
*   FOR D001/D002/D102 KEYS, STATION IS NOT IN THE KEY. RECORD                  
*        MUST BE READ TO GET THE STATION.  CAN THEN PROCEED.                    
*                                                                               
         CLI   DSTATION(RF),X'FF'  READ STATION INDICATOR?                      
         BNE   LR160060            NO                                           
         GOTO1 =A(READAGYO),RR=RELO                                             
*                                  YES - READ,TEST D001/D002/D102 KEYS          
         BNZ   LRSEQ               NOT EQUAL - SKIP THIS ORDER                  
         L     R6,AIO                                                           
U        USING RDARREC,R6                                                       
         LA    RE,U.RDARKSTA       SET A(STATION IN AGY ORDER REC)              
         B     LR160080                                                         
*                                                                               
         DROP  U                                                                
*                                                                               
*   POINT RF TO STATION CALLS IN AGY ORD REC, AND PROCEED.                      
*                                                                               
LR160060 EQU   *                                                                
         LA    RE,KEY              SET A(KEY IN PROGRESS)                       
LR160070 EQU   *                                                                
         ZIC   R1,DSTATION(RF)     GET DISPLACEMENT TO STA CALLS                
         AR    RE,R1               DISPLACE TO STATION CALL LETTERS             
LR160080 EQU   *                                                                
         MVC   MYWORK+8(4),0(RE)   TAKE STATION FROM KEY                        
         MVI   MYWORK+5,4                                                       
         CLI   3(RE),C' '                                                       
         BNE   *+8                                                              
         MVI   MYWORK+5,3          IF 3 LETTER CALL LETTERS                     
         MVI   MYWORK+2,X'40'      SET ALPHA                                    
         CLI   4(RE),C'T'          NO NEED FOR TV BAND                          
         BE    LR170                                                            
         MVI   MYWORK+12,C'-'                                                   
         MVC   MYWORK+13(1),4(RE)                                               
         MVI   MYWORK+5,6                                                       
         CLI   3(RE),C' '                                                       
         BNE   LR170                                                            
         MVC   MYWORK+11(2),MYWORK+12                                           
         MVI   MYWORK+13,0         IF 3 LETTER CALL LETTERS                     
         MVI   MYWORK+5,5                                                       
                                                                                
LR170    DS    0H                                                               
         MVC   SVKEY,KEY                                                        
         LA    R2,MYWORK                                                        
         GOTO1 VALISTA                                                          
         MVC   KEY,SVKEY                                                        
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
*   TEST                                                                        
*        MVC   KEY-7(1),DMINBTS                                                 
*        MVC   KEY-6(1),GENSTAT1                                                
*        MVI   KEY-5,C'C'                                                       
*   TEST END                                                                    
*                                                                               
         MVI   DMINBTS,0                                                        
         GOTO1 HIGH                RE-ESTABLISH SEQ ORDER                       
                                                                                
         CLI   DE1GRPH+5,0         GROUP FILTER?                                
         BE    LR180                                                            
         ZIC   RF,DE1GRPH+5                                                     
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   GRPFILT(0),WORK+31                                               
         BNE   LRSEQ                                                            
                                                                                
LR180    DS    0H                                                               
         CLI   DE1TEAMH+5,0        TEAM FILTER?                                 
         BE    LR205               NO                                           
                                                                                
         L     R6,AIO3             STATION RECORD IS IN IO3                     
         MVI   ELCODE,X'04'                                                     
         BRAS  RE,GETEL                                                         
         BNE   LRSEQ                                                            
                                                                                
         USING RSTAOTEL,R6                                                      
LR190    CLC   RSTAOTOF,RDARKAOF   LOOK FOR MATCHING OFFICE                     
         BE    LR200                                                            
         BRAS  RE,NEXTEL                                                        
         BE    LR190                                                            
         B     LRSEQ                                                            
                                                                                
LR200    DS    0H                                                               
         ZIC   RF,DE1TEAMH+5                                                    
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   TEAMFILT(0),RSTAOTTM                                             
         BNE   LRSEQ                                                            
         DROP  R3,R6                                                            
                                                                                
LR205    DS    0H                                                               
LR210    DS    0H                                                               
         MVC   ORDLSTDA,KEY+28                                                  
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
*   TEST                                                                        
         MVI   KEY-8,C'D'                                                       
*   TEST END                                                                    
*                                                                               
         GOTO1 =A(MYGETREC),RR=RELO                                             
         BZ    LR210010            NOT DELETED                                  
         CLI   KEY+27,X'FF'        DELETED BY REGENDTR?                         
         BE    LRSEQ               YES - SKIP THIS RECORD                       
LR210010 EQU   *                                                                
*                                                                               
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
         TM    RDARCNTL,X'80'      !!!NEVER GET A DELETED RECORD!!!             
         BZ    LR210A                                                           
         TM    RDARDELS,X'20'      FOR DELETES, PASS ONLY IF RECALL             
         BZ    LRSEQ               CANCELLED                                    
         DROP  R6                                                               
*                                                                               
LR210A   DS    0H                                                               
         NI    BITFLAG2,X'FF'-B2SENT                                            
         L     R6,AIO                                                           
         MVI   ELCODE,X'0F'                                                     
         BRAS  RE,GETEL                                                         
         BNE   LR210A10                                                         
         USING RDARFLEM,R6                                                      
         TM    RDARFLG1,X'40'      SENT TO STATION (-S)?                        
         BZ    LR210A10                                                         
         OI    BITFLAG2,B2SENT                                                  
         DROP  R6                                                               
*                                                                               
LR210A10 EQU   *                                                                
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
         LR    R1,RA                                                            
         AH    R1,=AL2(DARPROFS-CONHEADH)                                       
         USING SVDSECT,R1                                                       
*                                                                               
         OC    CAMPFLD1(12),CAMPFLD1                                            
*                                  ANY CAMPAIGN FILTER?                         
         BZ    LR210A20            NO                                           
         CLC   CAMPFLD3+1(3),RDAREST#                                           
*                                  ESTIMATE NUMBER MATCH?                       
         BNE   LRSEQ               NO  - SKIP THIS ORDER                        
         LA    RF,RDARELEM                                                      
         ZIC   RE,1(RF)            BUMP TO X'02' ELEMENT                        
         AR    RF,RE                                                            
         CLI   0(RF),2             2ND DESCRIPTION ELEMENT?                     
         BNE   LRSEQ               NO  - SKIP THIS ORDER                        
         CLC   CAMPFLD1(4),RDARCLI-RDARCLEM(RF)                                 
         BNE   LRSEQ               NO CLIENT MATCH                              
         CLC   CAMPFLD2(4),RDARPRD1-RDARCLEM(RF)                                
         BNE   LRSEQ               NO PRODUCT MATCH                             
*                                                                               
         DROP  R1,R6                                                            
*                                                                               
LR210A20 EQU   *                                                                
         LR    R1,RA                                                            
         AH    R1,=AL2(DARPROFS-CONHEADH)                                       
         USING SVDSECT,R1                                                       
         TM    SVPGPBIT+CNTRPEAB,CNTRPEAA                                       
         BZ    LR210AA                                                          
         DROP  R1                                                               
*                                                                               
         GOTO1 =A(CHKLOCAL),RR=RELO                                             
         BNZ   LRSEQ               CHECK IF LOCAL ORDER                         
*                                                                               
LR210AA  DS    0H                                                               
         LR    R1,RA                                                            
         AH    R1,=AL2(DARPROFS-CONHEADH)                                       
         USING SVDSECT,R1                                                       
         TM    SVPGPBIT+CNTDIRCB,CNTDIRCA                                       
         BZ    LR210AB                                                          
         DROP  R1                                                               
*                                                                               
         GOTO1 =A(CHKDIREC),RR=RELO                                             
         BNZ   LRSEQ               CHECK IF DIRECT ORDER IN USE                 
*                                                                               
LR210AB  DS    0H                                                               
         OC    CDARNUM,CDARNUM     FILTERING ON SPECIFIC CONTRACT?              
         BNZ   LR210B              YES - NO OFFICE CHECK                        
         CLI   DE1OFFH+5,0         FILTER ON OFFICE?                            
         BE    LR210B                                                           
         CLC   =C'C=',DE1OFF                                                    
         BE    LR210B                                                           
         GOTO1 =A(CHECKOFF),RR=RELO                                             
         BNZ   LRSEQ                                                            
*                                  CHECK IF LOCAL ORDER IN USE                  
LR210B   DS    0H                                                               
         CLC   =C'BRAND',CONREC                                                 
         BE    LR211                                                            
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
         TM    RDARMISC,X'08'      DON'T SHOW BRAND ORDERS IN                   
         BZ    LR211                                                            
         CLI   RDARKTYP,X'51'      UNLESS IT'S CONFIRMED                        
         BNE   LRSEQ               NO                                           
         DROP  R6                                                               
*                                                                               
LR211    DS    0H                                                               
         CLI   DE1TYPEH+5,0        FILTER ON TYPE                               
         BE    LR270                                                            
*                                                                               
         CLI   STATFILT,C'F'       CONFIR                                       
         BE    LR270                                                            
*                                                                               
         CLI   STATFILT,C'I'       UNTOUCHED/INCOMING                           
         BNE   LR212                                                            
         MVI   ELCODE,X'30'        PRESENCE OF FIRST TOUCHED ELEMENT            
         BRAS  RE,GETEL            MEANS THE RECORD HAS BEEN LOOKED AT          
         BE    LRSEQ                                                            
         B     LR270                                                            
*                                                                               
LR212    DS    0H                                                               
         CLI   STATFILT,C'*'       TOUCHED/PRINTED BY USER                      
         BNE   LR213                                                            
         MVI   ELCODE,X'30'        PRESENCE OF FIRST TOUCHED ELEMENT            
         BRAS  RE,GETEL            MEANS THE RECORD HAS BEEN PRINTED            
         BNE   LRSEQ                                                            
         CLI   STATFILT+1,C' '                                                  
         BE    LR270                                                            
*                                                                               
LR213    DS    0H                                                               
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
         CLI   STATFILT+1,C'V'     VARIOUS/CORPORATE                            
         BNE   LR213AA                                                          
         CLI   STATFILT,C' '       COMBINATION??                                
         BE    LR213A                                                           
         TM    CTLRFLG1,CF1BRDQ    YES, VARIOUS AND SOME OTHER STATUS           
         BO    LR214                                                            
         TM    RDARMISC,X'10'                                                   
         BO    LR214                                                            
         CLC   =C'*CORPORATE*',RDARPRN1                                         
         BE    LR214                                                            
         B     LRSEQ                                                            
*                                                                               
LR213A   DS    0H                  NO, SHOW ME ALL VARIOUS ORDERS               
         TM    CTLRFLG1,CF1BRDQ                                                 
         BO    LR270                                                            
         TM    RDARMISC,X'10'                                                   
         BO    LR270                                                            
         CLC   =C'*CORPORATE*',RDARPRN1                                         
         BE    LR270                                                            
         B     LRSEQ                                                            
                                                                                
LR213AA  DS    0H                                                               
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
         GOTO1 =A(TSTFLTR),RR=RELO NEW FILTERS?                                 
         BL    LR213AAA            NO                                           
         BE    LR270               YES,AND ORDER DOES SATISFY FILTER            
         BH    LRSEQ               YES,BUT ORDER DOES NOT SATISFY FILTR         
*                                                                               
LR213AAA DS    0H                                                               
         CLI   STATFILT,C'M'       FILTER ON AMEND?                             
         BNE   LR213B              NO                                           
         TM    RDARBSTS,C'M'       YES - AMEND STATUS?                          
         BNO   LRSEQ               NO  - SKIP IT                                
*                                                                               
         L     R6,AIO              YES - CHECK STACF/PENDCF                     
         MVI   ELCODE,X'0F'                                                     
         BRAS  RE,GETEL                                                         
         BNE   LRSEQ                                                            
         USING RDARFLEM,R6                                                      
*                                                                               
         TM    RDARFLG1,X'10'      STACF?                                       
         BO    LRSEQ               YES - NOT AMEND: SKIP                        
         TM    RDARFLG1,X'20'      PENDCF?                                      
         BO    LRSEQ               YES - NOT AMEND: SKIP                        
         B     LR270               NO  - REALLY AN AMEND                        
*                                                                               
LR213B   DS    0H                                                               
         CLI   STATFILT,C'W'       STACF?                                       
         BNE   LR213B10                                                         
*                                                                               
         MVI   ELCODE,X'0F'                                                     
         BRAS  RE,GETEL                                                         
         BNE   LRSEQ                                                            
         USING RDARFLEM,R6                                                      
*                                                                               
         TM    RDARFLG1,X'10'      STACF?                                       
         BO    LR270               YES                                          
         B     LRSEQ                                                            
*                                                                               
LR213B10 DS    0H                                                               
***>>>                                                                          
         CLI   STATFILT,C'P'       FILTER PENDCF ONLY?                          
         BE    LR213B40            YES -                                        
         CLI   STATFILT,C'F'       FILTER CF/PENDCF?                            
         BNE   LR213BB             NO  -                                        
*                                                                               
*   FILTER = 'F':  WASN'T A 'CONFIRMED' ORDER.  BRANCH TO HERE                  
*        DIRECTLY FROM THE 'CONFIRMED' TEST SKIPS THE READ OF                   
*        THE CURRENT KEY.  THEREFORE, THE RECORD IS READ AT THIS                
*        STAGE TO PERMIT THE NEXT TEST TO BE AGAINST THE CORRECT                
*        RECORD.                                                                
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
*   SET FLAG                                                                    
         MVI   KEY-8,C'K'                                                       
*   SET FLAG                                                                    
*                                                                               
         GOTO1 =A(MYGETREC),RR=RELO                                             
         BNZ   LRSEQ                                                            
*                                                                               
LR213B40 DS    0H                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'0F'                                                     
         BRAS  RE,GETEL                                                         
         BNE   LRSEQ                                                            
         USING RDARFLEM,R6                                                      
*                                                                               
         TM    RDARFLG1,X'20'      PENDCF?                                      
         BO    LR270               YES - ACCEPT                                 
         B     LRSEQ               NO  - SKIP THIS ORDER                        
*                                                                               
LR213BB  DS    0H                                                               
         USING RDARREC,R6                                                       
         CLI   STATFILT+1,C'E'     REVISION?                                    
         BNE   LR214                                                            
         CLI   STATFILT,C' '       COMBINATION??                                
         BE    LR213AB                                                          
         OC    RDARRNUM,RDARRNUM                                                
         BZ    LRSEQ                                                            
         CLI   STATFILT,C'*'       COMBINATION??                                
         BE    LR270                                                            
         B     LR214                                                            
*                                                                               
LR213AB  DS    0H                  NO, SHOW ME ALL REVISION ORDERS              
         OC    RDARRNUM,RDARRNUM                                                
         BNZ   LR270                                                            
         B     LRSEQ                                                            
                                                                                
LR214    DS    0H                                                               
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
         CLI   STATFILT,C'N'       NOTDARE                                      
         BNE   LR215                                                            
         TM    RDARMISC,X'20'                                                   
         BO    LR270                                                            
         B     LRSEQ                                                            
                                                                                
LR215    DS    0H                                                               
         CLI   STATFILT,C'S'       RESENT?                                      
         BNE   LR220                                                            
         TM    RDARMISC,X'80'      YES                                          
         BZ    LRSEQ                                                            
         OC    RDARBSTS,RDARBSTS   MAKE SURE WE DIDN'T APP/REJ                  
         BZ    LR270                                                            
         CLI   RDARBSTS,C' '                                                    
         BE    LR270                                                            
         B     LRSEQ                                                            
                                                                                
LR220    DS    0H                                                               
         CLI   STATFILT,C'C'       RECALL?                                      
         BNE   LR225                                                            
         CLI   RDARBSTS,C'C'       YES                                          
         BNE   LRSEQ                                                            
         B     LR270                                                            
                                                                                
LR225    DS    0H                                                               
         OC    RDARREP#,RDARREP#                                                
         BZ    LR240                                                            
                                                                                
         CLI   STATFILT,C'L'       LINKED                                       
         BE    LR230                                                            
         CLI   STATFILT,C'B'       BOTH                                         
         BE    LR230                                                            
         CLC   RDARBSTS,STATFILT   OPENED/REJECTED                              
         BE    LR270                                                            
         B     LRSEQ                                                            
                                                                                
LR230    DS    0H                  FOR LINKED/BOTH                              
         TM    RDARMISC,X'80'      IGNORE RESENT FOR ALL OTHER FILTERS          
         BO    LRSEQ                                                            
         OC    RDARBSTS,RDARBSTS   BUT NOT OPENED NOR REJECTED                  
         BZ    LR270                                                            
         CLI   RDARBSTS,C' '                                                    
         BE    LR270                                                            
         B     LRSEQ                                                            
                                                                                
LR240    DS    0H                  NOT LINKED                                   
         CLI   STATFILT,C'R'       REJECTED                                     
         BNE   LR250                                                            
         CLI   RDARBSTS,C'R'                                                    
         BE    LR270                                                            
         B     LRSEQ                                                            
                                                                                
LR250    DS    0H                                                               
         CLI   STATFILT,C'U'       UNLINKED                                     
         BE    LR260                                                            
         CLI   STATFILT,C'B'       BOTH                                         
         BNE   LRSEQ                                                            
                                                                                
LR260    DS    0H                                                               
         TM    RDARMISC,X'80'      IGNORE RESENT FOR ALL OTHER FILTERS          
         BO    LRSEQ                                                            
         OC    RDARBSTS,RDARBSTS   STATUS IF NEITHER OPENED                     
         BZ    LR270                 NOR REJECTED                               
         CLI   RDARBSTS,C' '                                                    
         BNE   LRSEQ                                                            
                                                                                
LR270    DS    0H                                                               
*                                                                               
*   AT THIS POINT, THE AGENCY ORDER SHOULD BE IN THE IO AREA.                   
*        IF IT ISN'T, IT IS RETRIEVED INTO THAT SPACE.                          
*                                                                               
         L     RF,AIO              YES - SEE IF RECORD READ                     
         CLC   KEY(27),0(RF)       RECORD IN IO AREA?                           
         BE    LR270010            YES - DON'T REREAD                           
*                                  NO  - READ IN THE RECORD                     
         GOTO1 =A(MYGETREC),RR=RELO                                             
         BNZ   LRSEQ               NOT FOUND OR DELETED                         
*                                                                               
LR270010 DS    0H                                                               
         CLI   STATFILT,C'F'       CONFIRMED?                                   
         BNE   LR275               NO  -                                        
*                                                                               
         CLI   DE1OFFH+5,0         ANY OFFICE FILTER?                           
         BE    LR270020            NO  - DON'T FILTER                           
         CLC   =C'C=',DE1OFF       YES - SPECIAL OVERRIDE?                      
         BE    LR270020            YES - DONT CHECK OFFICE                      
         GOTO1 =A(CHECKOFF),RR=RELO                                             
*                                  NO  - CHECK OFFICE                           
         BNZ   LRSEQ               NO MATCH: SKIP THIS ORDER                    
*                                                                               
LR270020 EQU   *                                                                
         CLI   TWAOFFC,C'*'        DDS TERMINAL, SHOW EVERYTHING                
         BE    LR275                                                            
         L     R6,AIO                                                           
         MVI   ELCODE,X'01'                                                     
         BRAS  RE,GETEL                                                         
         BNE   LRSEQ                                                            
         GOTO1 DATCON,DMCB,(5,0),(2,HALF)                                       
         PUSH  USING                                                            
         USING RDARELEM,R6                                                      
         CLI   RDARRNUM,0                                                       
         BNE   LR275               FOR ORIGINAL ORDERS, DON'T LIST IF           
         CLC   HALF,RDARESEN       PAST END OF FLIGHT?                          
         BH    LRSEQ               YES - SKIP IT                                
         DROP  R6                                                               
         POP   USING                                                            
                                                                                
LR275    DS    0H                                                               
         L     R6,AIO              POINT R6 TO BEGINNING OF REC AGAIN           
         XC    AGYOFF,AGYOFF                                                    
         XC    AGYSALP,AGYSALP                                                  
                                                                                
LR280    DS    0H                                                               
         OC    RDARREP#,RDARREP#   ONLY LINKED ORDERS ARE PASSED FOR            
         BNZ   LR290                SALESPERSON FILTERS                         
         CLI   DE1SALPH+5,0        FILTER ON SALESPERSON?                       
         BNE   LRSEQ               IF YES, LINKED ORDERS ONLY                   
         B     LR340                                                            
                                                                                
LR290    DS    0H                  GET CONTRACT RECORD                          
         MVC   SVKEY,KEY                                                        
*                                                                               
         ZAP   WORK+5(5),=P'99999999'                                           
         ZAP   WORK+10(5),=P'0'                                                 
         MVO   WORK+10(5),RDARREP#                                              
         SP    WORK+5(5),WORK+10(5)                                             
         MVO   WORK(5),WORK+5(5)                                                
*                                                                               
         XC    KEY,KEY                                                          
CONKEYD  USING RCONKEY,KEY                                                      
         MVI   CONKEYD.RCONPTYP,X'8C'                                           
         MVC   CONKEYD.RCONPREP,AGENCY                                          
         MVC   CONKEYD.RCONPCON,WORK                                            
*                                                                               
         LR    R2,RA                                                            
         AHI   R2,DARPROFS-CONHEADH                                             
         USING SVDSECT,R2                                                       
         TM    DMISFLGX,X'40'                                                   
         BZ    *+10                MASTER REP SIGNED ON?                        
         MVC   CONKEYD.RCONPREP,RDARKREP   YES, USE SUB REP                     
*                                                                               
         DROP  CONKEYD,R2,R6                                                    
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         MVI   ERRFLAG,C'N'                                                     
         CLC   KEY(L'RCONKEY),KEYSAVE                                           
         BE    LR295                                                            
*        CLI   TWAOFFC,C'*'        DDS TERMINAL?                                
*        BNE   LR320                                                            
         MVI   ERRFLAG,C'Y'        SHOW THE ORDER IN ERROR STAT                 
         B     LR330               CONTRACT RECORD DELETED                      
*                                  THIS SHOULD NEVER HAPPEN...BUT IF IT         
*                                  DOES, SKIP ORDER INSTEAD OF DUMPING          
LR295    DS    0H                                                               
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
*   TEST                                                                        
         MVI   KEY-8,C'E'                                                       
*   TEST END                                                                    
*                                                                               
         GOTO1 =A(MYGETREC),RR=RELO                                             
*                                  CONTRACT RECORD READ                         
         L     R6,AIO                                                           
         USING RCONREC,R6                                                       
         MVC   AGYOFF,RCONKOFF                                                  
         MVC   AGYSALP,RCONSAL                                                  
         DROP  R6                                                               
*&&DO                                                                           
*                                                                               
* FOR OPENED ORDERS, CHECK IF CONTRACT SENT TO STATION                          
*                                                                               
         NI    BITFLAG2,X'FF'-B2SENT                                            
         MVI   ELCODE,X'1D'                                                     
         BRAS  RE,GETEL                                                         
         BNE   LR320               CONTRACT NOT A DARE ORDER ANYMORE            
         LR    R3,R6                                                            
DARELEMD USING RCONDREL,R3                                                      
         TM    DARELEMD.RCONDRFG,X'40'      OPENED?                             
         BZ    LR300                                                            
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'20'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING RCONSEND,R6                                                      
*        TM    RCONSENF,X'80'      LAST SENT BY REP?                            
*        BZ    LR300                                                            
*                                                                               
* CHECK IF DARE APPROVAL DATE IS LATER THAN LAST SENT TO STATION DATE           
*                                                                               
         CLC   DARELEMD.RCONDRDA,RCONSRDT                                       
         BH    LR300                                                            
         BL    LR298                                                            
         GOTO1 HEXIN,DMCB,RCONSRTI,WORK,4                                       
         CLC   DARELEMD.RCONDRTA,WORK                                           
         BH    LR300                                                            
*                                                                               
         DROP  DARELEMD                                                         
*                                                                               
LR298    DS    0H                                                               
         OI    BITFLAG2,B2SENT                                                  
         DROP  R6                                                               
*&&                                                                             
*                                                                               
LR300    DS    0H                                                               
         CLI   DE1OFFH+5,0         FILTER ON OFFICE OR                          
         BE    LR310                                                            
         CLC   =C'C=',DE1OFF                                                    
         BNE   LR310                                                            
         CLC   AGYOFF,DE1OFF+2                                                  
         BE    LR310                                                            
LR310    DS    0H                                                               
         CLI   DE1SALPH+5,0         ON SALESPERSON?                             
         BE    LR330                                                            
         CLC   SALFILT,AGYSALP                                                  
         BE    LR330                                                            
                                                                                
LR320    DS    0H                  NO MATCH, RESTORE KEY AND SEQ NEXT           
         MVC   KEY,SVKEY                                                        
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
         MVI   DMINBTS,0                                                        
         GOTO1 HIGH                                                             
         B     LRSEQ                                                            
*                                                                               
* DON'T LIST CONFIRMED VARIOUS ORDERS IF:                                       
* - NO BRAND ORDER HAS BEEN RECEIVED OR                                         
* - ALL BRAND ORDERS HAVE BEEN CONFIRMED                                        
*                                                                               
LR330    DS    0H                                                               
         MVC   KEY,SVKEY           RESTORE CURRENT LIST DARE RECORD             
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
         MVI   DMINBTS,0                                                        
         GOTO1 HIGH                                                             
*        CLC   KEY(L'RDARKEY),KEYSAVE                                           
*        BE    *+6                                                              
*        DC    H'0'                                                             
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
         GOTO1 =A(MYGETREC),RR=RELO                                             
         BNZ   LRSEQ                                                            
*                                                                               
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
         TM    RDARMISC,X'04'      COFIRMED VARIOUS ORDER?                      
         BZ    LR340                                                            
         DROP  R6                                                               
*                                                                               
         MVC   KEY,SVKEY           YES, GET BRAND RECORD                        
         MVI   KEY+24,X'35'                                                     
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(RDARKSEQ-RDARKEY),KEYSAVE                                    
         BNE   LR335                                                            
*                                                                               
LR333    DS    0H                                                               
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
         GOTO1 =A(MYGETREC),RR=RELO                                             
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
         TM    RDARPDFG,X'40'      BRAND ORDER RECEIVED                         
         BZ    LR334                                                            
         TM    RDARPDFG,X'80'      BRAND ORDER NOT CONFIRMED                    
         BZ    LR335                                                            
*                                                                               
LR334    DS    0H                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
         CLC   KEY(RDARKSEQ-RDARKEY),KEYSAVE                                    
         BE    LR333                                                            
         DROP  R6                                                               
*                                  NO MATCH, RESTORE KEY AND SEQ NEXT           
         MVC   KEY,SVKEY                                                        
         MVI   RDUPDATE,C'N'                                                    
*                                                                               
         MVI   DMINBTS,0                                                        
         GOTO1 HIGH                                                             
         B     LRSEQ                                                            
*                                                                               
