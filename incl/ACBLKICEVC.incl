*          DATA SET ACBLKICEVC AT LEVEL 042 AS OF 07/08/20                      
       ++INCLUDE IEBUPDTHDR                                                     
                                                                                
**** SUPP=N IS FOR DEBUGGING ONLY. USE THIS WHEN NO SUPPORT DATA IS             
****     AVAILABLE, SO THAT ACC TRANSACTIONS WILL BE PROCESSED THAT             
****     WOULD OTHERWISE ONLY GO TO THE EXCEPTION FILE.                         
* SET DEFAULT TO SUPP=Y. CAN BE OVERRIDDEN IN THE JCL TO SUPP=N.                
*&&      SET   SUPP=Y                                                           
                                                                                
***********************************************************************         
                                                                                
       SAP MEDIA VENDOR CLEARANCE EXPORT: XML FILE GENERATION                   
       BC_AP.xsd                                                                
IMPORTANT NOTE: this ICETOOL application sets RC=4 if there are no data         
records in the generated XML file. We do this by using the NULLOFL              
option. The JCL downstream from this ICETOOL step tests for RC=4, and           
does not transmit the XML file if this step completes with a non-zero           
return code. Therefore, if any COUNT operators are added to this                
program which may set the return code to a non-zero value, then the             
JCL may need to be changed!                                                     
                                                                                
***********************************************************************         
./ ADD NAME=SYMNAMES   ** SYMBOLICS USED IN CONTROL CARDS                       
*                                                                               
PIPE,C'|'                          DELIMITER                                    
TAB,X'05'                          DELIMITER                                    
*                                                                               
F1_ONLY,C'1'                       JOIN RESULT INDICATORS (AS PER IBM)          
F2_ONLY,C'2'                                                                    
BOTH_F1_AND_F2,C'B'                                                             
*                                                                               
* Parsed record variables (for the ACC extract dataset)                         
*                                                                               
P_AXG$RTYP,%105                    RECORD TYPE                                  
P_AXG$TTYP,%106                    TRANSACTION TYPE                             
P_AXG$ACCD,%107                    ACCOUNT CODE                                 
P_AXG$OFFC,%109                    OFFICE CODE                                  
P_AXG$TRDT,%110                    TRANSACTION DATE                             
P_AXG$TRRF,%111                    REFERENCE                                    
P_AXG$TRSR,%112                    SUB-REFERENCE                                
P_AXG$SYS,%113                     SYSTEM CODE                                  
P_AXG$MED,%114                     MEDIA                                        
P_AXG$CLT,%115                     CLIENT                                       
P_AXG$PRD,%116                     CLIENT/PRODUCT                               
P_AXG$EST,%117                     ESTIMATE                                     
P_AXG$CR,%119                      DEBIT                                        
P_AXG$ACDT,%122                    ACTIVITY DATE                                
P_AXG$MOS,%124                     MOS                                          
P_AXG$BINC,%128                    BILLING INCOME (COMMISSION)                  
P_AXG$DUDT,%135                    DUE DATE                                     
P_AXG$INV,%138                     INVOICE NUMBER (LONG)                        
P_AXG$NARR,%153                    NARRATIVE                                    
P_AXG$CURR,%154                    CURRENCY (USD/CND)                           
P_AXG$STYP,%155                    TRANACTION TYPE                              
P_AXG$NETW,%156                    NETWORK                                      
P_AXG$PID,%164                     PID                                          
P_AXG$ITMN,%165                    ITEM NO                                      
P_AXG$VNDC,%166                    VENDOR CODE                                  
P_AXG$VNDN,%167                    VENDOR NAME                                  
P_AXG$GRS,%168                     VENDOR NAME                                  
P_AXG$NET,%169                     NET AMOUNT                                   
P_AXG$TAXA,%170                    Tax Amount                                   
P_AXG$TAXC,%171                    TAx Code                                     
P_AXG$INSO,%172                    INSERTION ORDER NUMBER                       
P_AXG$CMPG,%173                    CAMPAIGN                                     
P_AXG$AGY,%174                     AGENCY                                       
P_AXG$MEDA,%175                    MEDIA AUTHORIZATION NUMBER                   
P_AXG$ESTU,%176                    ESTIMATE UNIQUE NUMBER                       
P_AXG$BUYU,%177                    BUY UNIQUE NUBMER                            
P_AXG$VOUC,%178                    VOUCHER NUMBER                               
P_AXG$VOID,%179                    VOID FLAG                                    
P_AXG$MKTC,%180                    MARKET CODE                                  
P_AXG$MKTN,%181                    MARKET NAME                                  
P_AXG$NSPT,%182                    NUMBER OF SPOTS                              
P_AXG$PONM,%183                    PURCHASE ORDER NUMBER                        
P_AXG$CLNM,%184                    CLIENT NAME                                  
P_AXG$PRNM,%185                    PRODUCT NAME                                 
P_AXG$ESNM,%186                    ESTIMATE NAME                                
P_AXG$SBMT,%187                    SUB-MEDIA TYPE NAME                          
P_AXG$SBMN,%188                    SUB-MEDIA NAME                               
P_AXG$PUD1,%189                    PRODUCT UDEF 1                               
P_AXG$PUD2,%190                    PRODUCT UDEF 2                               
P_AXG$EUD1,%191                    ESTIMATE UDEF 1                              
P_AXG$EUD2,%192                    ESTIMATE UDEF 2                              
P_AXG$CPYI,%193                    COMPANY ID (USERID)                          
P_AXG$LINI,%194                    LINE ITEM                                    
P_AXG$AXN,%197                     ACTION                                       
*                                                                               
*                                                                               
./ ADD NAME=TOOLIN     ** CONTROL CARDS FOR ICETOOL                             
*                                                                               
* Parse the ACC extract file, keeping only Spot and Print transactions.         
COPY FROM(XTRACTIN) USING(PARS)                                                 
*                                                                               
* Discard all transactions with errors, producing an FB dataset of              
* transactions to be joined with vendor data. This is the "detail               
* work file".                                                                   
COPY FROM(ALLRECS) TO(GOODTRNS) USING(COPG)                                     
*                                                                               
* Copy GOODTRNS to another dataset, so we can join it with itself.              
COPY FROM(GOODTRNS) TO(TEMP1)                                                   
*                                                                               
* Seed the invoice gross $ into the detail work file.                           
COPY JKFROM TO(JOINVEND) USING(JONH)                                            
*                                                                               
* Sort the detail work file by invoice number.                                  
SORT FROM(JOINVEND) TO(SRTITEMS) USING(SRTI)                                    
*                                                                               
* Copy FINAL to a tab-delimited file we can import into Excel (for              
*  debugging).                                                                  
COPY FROM(JOINVEND) TO(JOINTAB) USING(JDEB)                                     
*                                                                               
* Generate an XML output file. This file is syntactically correct, but          
* contains the more verbose syntax for empty fields.                            
COPY FROM(SRTITEMS) USING(COPX)                                                 
*                                                                               
* Prettify the XML output file by shortening tags with empty fields.            
COPY FROM(TEMPXML) TO(XMLOUT) USING(CPTX)                                       
                                                                                
                                                                                
./ ADD NAME=PARSCNTL                                                            
*                                                                               
 INCLUDE COND=(5,5,CH,EQ,C'05081')  Note: RECTYPE is always in column 5         
*                                                                               
 INREC PARSE=(%=(ENDBEFR=PIPE,REPEAT=5),                                        
           P_AXG$RTYP=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$RTYP),                       
           P_AXG$TTYP=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$TTYP),                       
           P_AXG$ACCD=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$ACCD), for debugging         
           %=(ENDBEFR=PIPE),                                                    
           P_AXG$OFFC=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$OFFC),                       
           P_AXG$TRDT=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$TRDT),                       
           P_AXG$TRRF=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$TRRF),                       
           P_AXG$TRSR=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$TRSR),                       
           P_AXG$SYS=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$SYS),                         
           P_AXG$MED=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$MED),                         
           P_AXG$CLT=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$CLT),                         
           P_AXG$PRD=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$PRD),  CLIENT/PRODUCT         
           P_AXG$EST=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$EST),                         
           %=(ENDBEFR=PIPE),                                                    
           P_AXG$CR=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$CR),                           
           %=(ENDBEFR=PIPE),                                                    
           P_AXG$ACDT=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$ACDT),                       
           %=(ENDBEFR=PIPE),                                                    
           P_AXG$MOS=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$MOS),                         
           %=(ENDBEFR=PIPE),                                                    
           P_AXG$BINC=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$BINC),                       
           %=(ENDBEFR=PIPE,REPEAT=6),                                           
           P_AXG$DUDT=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$DUDT),                       
           P_AXG$INV=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$INV),                         
           %=(ENDBEFR=PIPE,REPEAT=12),                                          
           P_AXG$NARR=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$NARR),                       
           P_AXG$CURR=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$CURR),                       
           P_AXG$STYP=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$STYP),                       
           P_AXG$NETW=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$NETW),                       
           %=(ENDBEFR=PIPE,REPEAT=7),                                           
           P_AXG$PID=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$PID),                         
           P_AXG$ITMN=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$ITMN),                       
           P_AXG$VNDC=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$VNDC),                       
           P_AXG$VNDN=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$VNDN),                       
           P_AXG$GRS=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$GRS),                         
           P_AXG$NET=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$NET),                         
           P_AXG$TAXA=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$TAXA),                       
           P_AXG$TAXC=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$TAXC),                       
           P_AXG$INSO=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$INSO),                       
           P_AXG$CMPG=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$CMPG),                       
           P_AXG$AGY=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$AGY),                         
           P_AXG$MEDA=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$MEDA),                       
           P_AXG$ESTU=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$ESTU),                       
           P_AXG$BUYU=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$BUYU),                       
           P_AXG$VOUC=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$VOUC),                       
           P_AXG$VOID=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$VOID),                       
           P_AXG$MKTC=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$MKTC),                       
           P_AXG$MKTN=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$MKTN),                       
           P_AXG$NSPT=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$NSPT),                       
           P_AXG$PONM=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$PONM),                       
           P_AXG$CLNM=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$CLNM),                       
           P_AXG$PRNM=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$PRNM),                       
           P_AXG$ESNM=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$ESNM),                       
           P_AXG$SBMT=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$SBMT),                       
           P_AXG$SBMN=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$SBMN),                       
           P_AXG$PUD1=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$PUD1),                       
           P_AXG$PUD2=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$PUD2),                       
           P_AXG$EUD1=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$EUD1),                       
           P_AXG$EUD2=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$EUD2),                       
           P_AXG$CPYI=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$CPYI),                       
           P_AXG$LINI=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$LINI),                       
           %=(ENDBEFR=PIPE,REPEAT=2),                                           
           P_AXG$AXN=(ENDBEFR=PIPE,FIXLEN=LEN_AXG$AXN)),                        
    BUILD=(AXG$LEN,                                                             
           AXG$RTYP:P_AXG$RTYP,                                                 
           AXG$TTYP:P_AXG$TTYP,                                                 
           AXG$ACCD:P_AXG$ACCD,                                                 
           AXG$OFFC:P_AXG$OFFC,                                                 
           AXG$TRDT:P_AXG$TRDT,                                                 
           AXG$TRRF:P_AXG$TRRF,                                                 
           AXG$TRSR:P_AXG$TRSR,                                                 
           AXG$SYS:P_AXG$SYS,                                                   
           AXG$MED:P_AXG$MED,                                                   
           AXG$CLT:P_AXG$CLT,                                                   
           AXG$PRD:P_AXG$PRD,                                                   
           AXG$EST:P_AXG$EST,                                                   
           AXG$CR:P_AXG$CR,SFF,TO=ZD,                                           
           AXG$ACDT:P_AXG$ACDT,                                                 
           AXG$MOS:P_AXG$MOS,                                                   
           AXG$BINC:P_AXG$BINC,SFF,TO=ZD,                                       
           AXG$DUDT:P_AXG$DUDT,                                                 
           AXG$INV:P_AXG$INV,                                                   
           AXG$NARR:P_AXG$NARR,                                                 
           AXG$CURR:P_AXG$CURR,                                                 
           AXG$STYP:P_AXG$STYP,                                                 
           AXG$NETW:P_AXG$NETW,                                                 
           AXG$PID:P_AXG$PID,                                                   
           AXG$ITMN:P_AXG$ITMN,                                                 
           AXG$VNDC:P_AXG$VNDC,                                                 
           AXG$VNDN:P_AXG$VNDN,                                                 
           AXG$GRS:P_AXG$GRS,SFF,TO=ZD,                                         
           AXG$NET:P_AXG$NET,SFF,TO=ZD,                                         
           AXG$TAXA:P_AXG$TAXA,SFF,TO=ZD,                                       
           AXG$TAXC:P_AXG$TAXC,                                                 
           AXG$INSO:P_AXG$INSO,                                                 
           AXG$CMPG:P_AXG$CMPG,                                                 
           AXG$AGY:P_AXG$AGY,                                                   
           AXG$MEDA:P_AXG$MEDA,                                                 
           AXG$ESTU:P_AXG$ESTU,                                                 
           AXG$BUYU:P_AXG$BUYU,                                                 
           AXG$VOUC:P_AXG$VOUC,                                                 
           AXG$VOID:P_AXG$VOID,                                                 
           AXG$MKTC:P_AXG$MKTC,                                                 
           AXG$MKTN:P_AXG$MKTN,                                                 
           AXG$NSPT:P_AXG$NSPT,                                                 
           AXG$PONM:P_AXG$PONM,                                                 
           AXG$CLNM:P_AXG$CLNM,                                                 
           AXG$PRNM:P_AXG$PRNM,                                                 
           AXG$ESNM:P_AXG$ESNM,                                                 
           AXG$SBMT:P_AXG$SBMT,                                                 
           AXG$SBMN:P_AXG$SBMN,                                                 
           AXG$PUD1:P_AXG$PUD1,                                                 
           AXG$PUD2:P_AXG$PUD2,                                                 
           AXG$EUD1:P_AXG$EUD1,                                                 
           AXG$EUD2:P_AXG$EUD2,                                                 
           AXG$CPYI:P_AXG$CPYI,                                                 
           AXG$LINI:P_AXG$LINI,                                                 
           AXG$AXN:P_AXG$AXN,                                                   
           A_ACC_SEQNUM:SEQNUM,LEN_A_ACC_SEQNUM,PD)                             
                                                                                
*                                                                               
* Include only payables for Spot and Print. Split the output records            
* into multiple output files:                                                   
*  1. Only VAR transactions                                                     
*  2. All other transactions                                                    
*                                                                               
*                                                                               
*OUTFIL FNAMES=ONLYVAR,              ** VAR transactions only                   
*  INCLUDE=(AXG$SYS,EQ,C'SP',AND,                                               
*           AXG$UNIT_LEDGER,NE,C'SR',AND,                                       
*           AXG$STYP,EQ,C'VAR'),                                                
*  VTOF,                                                                        
*  BUILD=(D_AXG$SYS:AXG$SYS,         ** only save what we need later on         
*         D_AXG$MED:AXG$MED,                                                    
*         D_AXG$CLT:AXG$PRD_CLT,                                                
*         D_AXG$PRD:AXG$PRD_PRD,                                                
*         D_AXG$EST:AXG$EST_EST,                                                
*         D_AXG$INV:AXG$INV,                                                    
*         D_AXG$MOS:AXG$MOS,                                                    
*         D_AXG$NETW:AXG$NETW,                                                  
*         D_AXG$NETA:AXG$NET,                                                   
*                                                                               
*                                                                               
 OUTFIL FNAMES=ALLRECS,              ** "real" transactions only                
*                                                                               
* Include all system payables that are not variable                             
   INCLUDE=(AXG$RTYP,EQ,C'PAY',AND,AXG$STYP,NE,C'VAR'),                         
   VTOF,                                                                        
** Start building in column 5, to account for the absence of the RDW !          
   BUILD=(5:AXG$RECORD,              *** start in column 5                      
          A_ACC_SEQNUM:A_ACC_SEQNUM)                                            
                                                                                
./ ADD NAME=COPGCNTL                                                            
*                                                                               
* Discard all records which were kept around only so that they could            
* be written to the exception file.                                             
*                                                                               
 OUTFIL VTOF,BUILD=(D_AXG$SYS:AXG$SYS,                                          
                    D_AXG$MED:AXG$MED,                                          
                    D_AXG$CLT:AXG$CLT,                                          
                    D_AXG$PRD:AXG$PRD_PRD,                                      
                    D_AXG$VOUC:AXG$VOUC,                                        
                    D_AXG$EST:AXG$EST,                                          
                    D_AXG$INV:AXG$INV,                                          
                    D_AXG$AGY:AXG$AGY,                                          
                    D_AXG$ACCD:AXG$ACCD,                                        
                    D_AXG$OFFC:AXG$OFFC,                                        
                    D_AXG$TRDT:AXG$TRDT,                                        
                    D_AXG$TRRF:AXG$TRRF,                                        
                    D_AXG$CR:AXG$CR,                                            
                    D_AXG$MOA:AXG$MOA,                                          
                    D_AXG$ACDT:AXG$ACDT,                                        
                    D_AXG$MOS:AXG$MOS,                                          
                    D_AXG$PID:AXG$PID,                                          
                    D_AXG$DUDT:AXG$DUDT,                                        
                    D_AXG$ITMN:AXG$ITMN,                                        
                    D_AXG$NARR:AXG$NARR,                                        
                    D_AXG$CURR:AXG$CURR,                                        
                    D_AXG$STYP:AXG$STYP,                                        
                    D_AXG$NETW:AXG$NETW,                                        
                    D_AXG$VNDC:AXG$VNDC,                                        
                    D_AXG$VNDN:AXG$VNDN,                                        
                    D_AXG$GRS:AXG$GRS,                                          
                    D_AXG$NETA:AXG$NET,                                         
                    D_AXG$TAXA:AXG$TAXA,                                        
                    D_AXG$TAXC:AXG$TAXC,                                        
                    D_AXG$INSO:AXG$INSO,                                        
                    D_AXG$MEDA:AXG$MEDA,                                        
                    D_AXG$BUYU:AXG$BUYU,                                        
*                   D_AXG$VOUC:AXG$VOUC,                                        
                    D_AXG$VOID:AXG$VOID,                                        
                    D_AXG$MKTC:AXG$MKTC,                                        
                    D_AXG$MKTN:AXG$MKTN,                                        
                    D_AXG$NSPT:AXG$NSPT,                                        
                    D_AXG$PONM:AXG$PONM,                                        
                    D_AXG$CLNM:AXG$CLNM,                                        
                    D_AXG$PRNM:AXG$PRNM,                                        
                    D_AXG$ESNM:AXG$ESNM,                                        
                    D_AXG$SBMT:AXG$SBMT,                                        
                    D_AXG$SBMN:AXG$SBMN,                                        
                    D_AXG$PUD1:AXG$PUD1,                                        
                    D_AXG$PUD2:AXG$PUD2,                                        
                    D_AXG$EUD1:AXG$EUD1,                                        
                    D_AXG$EUD2:AXG$EUD2,                                        
                    D_AXG$CPYI:AXG$CPYI,                                        
                    D_AXG$LINI:AXG$LINI,                                        
                    D_AXG$AXN:AXG$AXN)                                          
                                                                                
                                                                                
./ ADD NAME=JONHCNTL                                                            
*                                                                               
* Produce gross $ totals across months-of-service for each invoice.             
*                                                                               
 JOINKEYS F1=GOODTRNS,                                                          
             FIELDS=(D_AXG$SYS,A,                                               
                     D_AXG$MED,A,                                               
                     D_AXG$CLT,A,                                               
                     D_AXG$PRD,A,                                               
                     D_AXG$VOUC,A)                                              
*                    D_AXG$EST,A,                                               
*                    D_AXG$INV,A)                                               
 JOINKEYS F2=TEMP1,                                                             
             TASKID=T1,          <<<< SEE T1F2CNTL                              
             FIELDS=(D_AXG$SYS,A,                                               
                     D_AXG$MED,A,                                               
                     D_AXG$CLT,A,                                               
                     D_AXG$PRD,A,                                               
                     D_AXG$VOUC,A)                                              
*                    D_AXG$EST,A,                                               
*                    D_AXG$INV,A)                                               
*REFORMAT FIELDS=(F2:D_AXG$CR,      <===== computed gross (from totals)         
 REFORMAT FIELDS=(F2:D_AXG$GRS,    <===== computed gross (from totals)          
                  F1:D_JOINED_DATA)                                             
*                                                                               
* Build our work record from the reformatted fields.                            
 INREC BUILD=(D_GROSS$:REFH_D_GROSS$,                                           
              D_JOINED_DATA:REFH_D_JOINED_DATA)                                 
                                                                                
                                                                                
./ ADD NAME=T1F2CNTL                                                            
*                                                                               
* This collapses F2 *after* the sort (where the sort key is defined             
* by the F2 JOINKEYS fields above), retaining only the first duplicate.         
* The gross $ (i.e., the SUM) winds up in the totalled record.                  
*                                                                               
*SUM FIELDS=(D_AXG$CR)                                                          
 SUM FIELDS=(D_AXG$GRS)                                                         
                                                                                
                                                                                
./ ADD NAME=SRTICNTL                                                            
*                                                                               
* Sort the detail records into the sequence that we want them to appear         
* in the XML file, and fill in all other available (and relevant) data          
* fields. Assign the Item_Number value to each remaining detail line.           
* The Item_Number is restarted at value 1 at the start of each Header           
* (System, Media, Client, Product, Estimate, Invoice#).                         
*                                                                               
 INREC IFTHEN=(WHEN=INIT,OVERLAY=(D_AXG$STYP:C'INV'))                           
*                                                                               
 SORT FIELDS=(D_AXG$SYS,A,                                                      
              D_AXG$MED,A,                                                      
              D_AXG$CLT,A,                                                      
              D_AXG$PRD,A,                                                      
              D_AXG$VOUC,A,                                                     
              D_SORT_SEQUENCE,A),                                               
      EQUALS                               *** makes debugging easier!          
*                                                                               
 OUTREC IFTHEN=(WHEN=INIT,                 *** initialization                   
         OVERLAY=(X_AXG$SYS:D_AXG$SYS,                                          
                  X_AXG$MED:D_AXG$MED,                                          
                  X_AXG$CLT:D_AXG$CLT,                                          
                  X_AXG$PRD:D_AXG$PRD,                                          
                  X_AXG$VOUC:D_AXG$VOUC))                                       
 OUTFIL OVERLAY=(D_ITEM_NUMBER:SEQNUM,LEN_D_ITEM_NUMBER,ZD,                     
                   RESTART=(D_ITEM_#_KEY))                                      
                                                                                
                                                                                
./ ADD NAME=JDEBCNTL                                                            
*                                                                               
* Produce a tab-delimited file for debugging (this can easily be                
* imported into Excel).                                                         
*                                                                               
 OUTREC IFTHEN=(WHEN=GROUP,KEYBEGIN=(D_ITEM_#_KEY),                             
                PUSH=(D_GROSS$:D_GROSS$))                                       
                                                                                
 OUTFIL REMOVECC,                                                               
        HEADER1=('SEP=',TAB,/,         *** SEP= only works in Excel!!!          
                 'SYSTEM',TAB,                                                  
                 'MEDIA',TAB,                                                   
                 'CLT',TAB,                                                     
                 'PRD',TAB,                                                     
                 'EST',TAB,                                                     
                 'INV',TAB,                                                     
                 'AGY',TAB,                                                     
                 'ACCT CODE',TAB,                                               
                 'OFFICE',TAB,                                                  
                 'INVOICE DATE',TAB,                                            
                 'REFNUM',TAB,                                                  
                 'CR',TAB,                                                      
                 'MOA',TAB,                                                     
                 'ACTIV DATE',TAB,                                              
                 'MOS',TAB,                                                     
                 'USERID',TAB,                                                  
                 'DUE DATE',TAB,                                                
                 'CURRENCY',TAB,                                                
                 'TRANSACTION TYPE',TAB,                                        
                 'NETWORK',TAB,                                                 
                 'ITEM NO',TAB,                                                 
                 'GROSS',TAB,                                                   
                 'TAX AMOUNT',TAB,                                              
                 'TAX CODE',TAB,                                                
                 'INSERTION NUM',TAB,                                           
                 'MEDIA AUTH',TAB,                                              
                 'BUY UNIQUE NO',TAB,                                           
                 'VOUCHER NUM',TAB,                                             
                 'VOID',TAB),                                                   
       BUILD=(D_AXG$SYS,TAB,                                                    
              D_AXG$MED,TAB,                                                    
              D_AXG$CLT,TAB,                                                    
              D_AXG$PRD,TAB,                                                    
              D_AXG$EST,TAB,                                                    
              D_AXG$INV,TAB,                                                    
              D_AXG$AGY,TAB,                                                    
              D_AXG$ACCD,TAB,                                                   
              D_AXG$OFFC,TAB,                                                   
              D_AXG$TRDT,TAB,                                                   
              D_AXG$TRRF,TAB,                                                   
              D_AXG$CR,TAB,                                                     
              D_AXG$MOA,TAB,                                                    
              D_AXG$ACDT,TAB,                                                   
              D_AXG$MOS,TAB,                                                    
              D_AXG$PID,TAB,                                                    
              D_AXG$DUDT,TAB,                                                   
              D_AXG$CURR,TAB,                                                   
              D_AXG$STYP,TAB,                                                   
              D_AXG$NETW,TAB,                                                   
              D_AXG$ITMN,TAB,                                                   
              D_GROSS$,TAB,                                                     
              D_AXG$TAXA,TAB,                                                   
              D_AXG$TAXC,TAB,                                                   
              D_AXG$INSO,TAB,                                                   
              D_AXG$MEDA,TAB,                                                   
              D_AXG$BUYU,TAB,                                                   
              D_AXG$VOUC,TAB,                                                   
              D_AXG$VOID,TAB)                                                   
                                                                                
                                                                                
                                                                                
./ ADD NAME=COPHCNTL                                                            
*                                                                               
* Produce a tab-delimited file which can be imported into Excel.                
*                                                                               
 OUTFIL REMOVECC,                                                               
        VTOF,                                                                   
        HEADER1=('Canadian agency',TAB,                                         
                 'Acct#',TAB,                                                   
                 'Ref#',TAB,                                                    
                 'System',TAB,                                                  
                 'Media',TAB,                                                   
                 'Client',TAB,                                                  
                 'Product',TAB,                                                 
                 'Est',TAB,                                                     
                 'Media Office',TAB,                                            
                 'Activity Date',TAB,                                           
                 'Month of Service',TAB,                                        
                 'Invoice Number',TAB,                                          
                 'Payee',TAB,                                                   
                 'Payee Type',TAB,                                              
                 'Error Message',TAB),                                          
       BUILD=(A_RESOURCES_AGY,TAB,                                              
              AXG$ACCD,TAB,                                                     
              AXG$TRRF,TAB,                                                     
              AXG$SYS,TAB,                                                      
              AXG$MED,TAB,                                                      
              AXG$PRD_CLT,TAB,                                                  
              AXG$PRD_PRD,TAB,                                                  
              AXG$EST_EST,TAB,                                                  
              AXG$ACDT,TAB,                                                     
              AXG$MOS,TAB,                                                      
              AXG$INV,TAB,                                                      
              AXG$PAYE,TAB,                                                     
              AXG$VORR,TAB,                                                     
              A_ERROR_TEXT,TAB,                                                 
              200:X)         *** record must be long enough for header          
                                                                                
                                                                                
./ ADD NAME=COPXCNTL                                                            
*                                                                               
* Generate the almost-final XML dataset.                                        
*                                                                               
* This OUTREC is used to format the Invoice Header field lines in XML           
* format. This is necessary because the formatting features are not             
* available under HEADER3.                                                      
*                                                                               
 OUTREC OVERLAY=(X_MEDIA_SYSTEM:                                                
        C'<Media_System>MEDIAOCEAN_US</Media_System>',                          
     X_AGY_ALPHA:D_AXG$AGY,JFY=(SHIFT=LEFT,LEAD=C'<Agency_Alpha_Code>',         
      TRAIL=C'</Agency_Alpha_Code>',LENGTH=80),                                 
     Z_VOUCHER:D_AXG$VOUC,JFY=(SHIFT=LEFT,LEAD=C'<Voucher_No>',                 
      TRAIL=C'</Voucher_No>',LENGTH=80),                                        
     X_NETWORK:D_AXG$NETW,JFY=(SHIFT=LEFT,LEAD=C'<Network>',                    
      TRAIL=C'</Network>',LENGTH=80),                                           
     X_VENDOR:D_AXG$VNDN,JFY=(SHIFT=LEFT,LEAD=C'<Vendor>',                      
      TRAIL=C'</Vendor>',LENGTH=80),                                            
     X_INVOICE_NO:D_AXG$INV,JFY=(SHIFT=LEFT,                                    
      LEAD=C'<Invoice_No>',TRAIL=C'</Invoice_No>',LENGTH=80),                   
     X_COMPANY_CODE:D_AXG$OFFC,JFY=(SHIFT=LEFT,                                 
      LEAD=C'<Company_Code>',TRAIL=C'</Company_Code>',LENGTH=80),               
     X_GROSS$:D_GROSS$,EDIT=(SIIIIIIIIIIIT.TT),SIGNS=(,-),                      
     X_NETA:D_AXG$NETA,EDIT=(SIIIIIIIIIIIT.TT),SIGNS=(,-),                      
     X_TAXA:D_AXG$TAXA,EDIT=(SIIIIIIIIIIIT.TT),SIGNS=(,-),                      
     X_GROSS_AMOUNT:X_GROSS$,JFY=(SHIFT=LEFT,                                   
      LEAD=C'<Gross_Amount>',TRAIL=C'</Gross_Amount>',LENGTH=80),               
     X_CURRENCY:D_AXG$CURR,JFY=(SHIFT=LEFT,                                     
      LEAD=C'<Currency>',TRAIL=C'</Currency>',LENGTH=80),                       
     X_INVOICE_DATE:D_AXG$TRDT,JFY=(SHIFT=LEFT,                                 
      LEAD=C'<Invoice_Date>',TRAIL=C'</Invoice_Date>',LENGTH=80),               
     X_DUE_DATE:D_AXG$DUDT,JFY=(SHIFT=LEFT,                                     
      LEAD=C'<Due_Date>',TRAIL=C'</Due_Date>',LENGTH=80),                       
     X_TRANS_TYPE:D_AXG$STYP,JFY=(SHIFT=LEFT,                                   
      LEAD=C'<Trans_Type>',TRAIL=C'</Trans_Type>',LENGTH=80),                   
     X_USERID:D_AXG$PID,JFY=(SHIFT=LEFT,                                        
      LEAD=C'<User_Id>',TRAIL=C'</User_Id>',LENGTH=80),                         
     X_ADVERTISER:D_AXG$CLT,JFY=(SHIFT=LEFT,                                    
      LEAD=C'<Advertiser>',TRAIL=C'</Advertiser>',LENGTH=80),                   
     X_LOCCOD:D_AXG$CPYI,JFY=(SHIFT=LEFT,                                       
      LEAD=C'<Location_Code>',TRAIL=C'</Location_Code>',LENGTH=80),             
     X_ADVERNAME:D_AXG$CLNM,JFY=(SHIFT=LEFT,                                    
      LEAD=C'<Advertiser_Name>',                                                
      TRAIL=C'</Advertiser_Name>',LENGTH=80),                                   
*    X_PUD1:D_AXG$PUD1,JFY=(SHIFT=LEFT,                                         
*     LEAD=C'<UDEF_Product_1>',TRAIL=C'</UDEF_Product_1>',LENGTH=80),           
*    X_PUD2:D_AXG$PUD2,JFY=(SHIFT=LEFT,                                         
*     LEAD=C'<UDEF_Product_2>',TRAIL=C'</UDEF_Product_2>',LENGTH=80),           
*    X_EUD1:D_AXG$EUD1,JFY=(SHIFT=LEFT,                                         
*     LEAD=C'<UDEF_Estimate_1>',TRAIL=C'</UDEF_Estimate_1>',LENGTH=80),         
*    X_EUD2:D_AXG$EUD2,JFY=(SHIFT=LEFT,                                         
*     LEAD=C'<UDEF_Estimate_2>',TRAIL=C'</UDEF_Estimate_2>',LENGTH=80),         
     X_POSTING_DATE:D_AXG$TRDT,JFY=(SHIFT=LEFT,                                 
      LEAD=C'<Posting_Date>',TRAIL=C'</Posting_Date>',LENGTH=80))               
*                                                                               
 OUTFIL FNAMES=TEMPXML,                                                         
        REMOVECC,                                                               
        NULLOFL=RC4,          *** SET RC=4 IF THERE ARE NO DATA RECORDS         
 BUILD=(05:C'<LineItems>',/,                                                    
     07:D_AXG$LINI,JFY=(SHIFT=LEFT,                                             
        LEAD=C'<Item_No>',TRAIL=C'</Item_No>',LENGTH=74),/,                     
     07:C'<GL_Account/>'/,        *** REQUIRED BY XSD SCHEMA                    
     07:X_NETA,JFY=(SHIFT=LEFT,                                                 
        LEAD=C'<Net_Amount>',TRAIL=C'</Net_Amount>',LENGTH=74),/,               
     07:D_AXG$TAXC,JFY=(SHIFT=LEFT,                                             
        LEAD=C'<Tax_Code>',TRAIL=C'</Tax_Code>',LENGTH=74),/,                   
     07:X_TAXA,JFY=(SHIFT=LEFT,                                                 
        LEAD=C'<Tax_Amount>',TRAIL=C'</Tax_Amount>',LENGTH=74),/,               
     07:D_AXG$CLT,JFY=(SHIFT=LEFT,                                              
        LEAD=C'<Customer>',TRAIL=C'</Customer>',LENGTH=80),/,                   
     07:C'<Bill_Ind>B</Bill_Ind>'/,                                             
     07:D_AXG$MOS,JFY=(SHIFT=LEFT,                                              
        LEAD=C'<MOS>',TRAIL=C'</MOS>',LENGTH=74),/,                             
     07:D_AXG$SYS,JFY=(SHIFT=LEFT,                                              
        LEAD=C'<Media_Type>',TRAIL=C'</Media_Type>',LENGTH=74),/,               
     07:D_AXG$MED,JFY=(SHIFT=LEFT,                                              
        LEAD=C'<Submedia>',TRAIL=C'</Submedia>',LENGTH=74),/,                   
     07:D_AXG$SBMT,JFY=(SHIFT=LEFT,                                             
        LEAD=C'<Submedia_Name>',TRAIL=C'</Submedia_Name>',LENGTH=74),/,         
     07:D_AXG$SBMN,JFY=(SHIFT=LEFT,                                             
        LEAD=C'<Submedia_Type>',TRAIL=C'</Submedia_Type>',LENGTH=74),/,         
     07:D_AXG$NARR,JFY=(SHIFT=LEFT,                                             
        LEAD=C'<Item_Text>',TRAIL=C'</Item_Text>',LENGTH=230),/,                
     07:D_AXG$PRD,JFY=(SHIFT=LEFT,                                              
        LEAD=C'<Product>',TRAIL=C'</Product>',LENGTH=74),/,                     
     07:D_AXG$PRNM,JFY=(SHIFT=LEFT,                                             
        LEAD=C'<Product_Name>',TRAIL=C'</Product_Name>',LENGTH=74),/,           
     07:D_AXG$EST,JFY=(SHIFT=LEFT,                                              
        LEAD=C'<Estimate>',TRAIL=C'</Estimate>',LENGTH=74),/,                   
     07:D_AXG$ESNM,JFY=(SHIFT=LEFT,                                             
        LEAD=C'<Estimate_Name>',TRAIL=C'</Estimate_Name>',LENGTH=74),/,         
     07:D_AXG$INSO,JFY=(SHIFT=LEFT,                                             
        LEAD=C'<Insertion_Order>',                                              
        TRAIL=C'</Insertion_Order>',LENGTH=74),/,                               
     07:D_AXG$MEDA,JFY=(SHIFT=LEFT,LEAD=C'<Media_Authorization>',               
        TRAIL=C'</Media_Authorization>',LENGTH=74),/,                           
     07:D_AXG$BUYU,JFY=(SHIFT=LEFT,LEAD=C'<Buy_Unique_Num>',                    
        TRAIL=C'</Buy_Unique_Num>',LENGTH=100),/,                               
*    07:D_AXG$AXN,JFY=(SHIFT=LEFT,LEAD=C'<Action>',                             
*       TRAIL=C'</Action>',LENGTH=60),/,                                        
     05:C'</LineItems>',80:X),                                                  
 HEADER1=('<?xml version="1.0" encoding="UTF-8" ?>',/,                          
          '<n1:MediaVendorClearance ',                                          
          'xmlns:n1="urn:publicis.com:0054:PUBLICIS_I_PUR_MEDIA1.0">'),         
 SECTIONS=(D_AXG$SYS,                                                           
           D_AXG$MED,                                                           
           D_AXG$CLT,                                                           
           D_AXG$PRD,                                                           
           D_AXG$VOUC,                                                          
*          D_AXG$EST,                                                           
*          D_AXG$INV,                                                           
       HEADER3=(03:'<Header>',/,                                                
                05:X_MEDIA_SYSTEM,/,                                            
                05:X_AGY_ALPHA,/,                                               
                05:Z_VOUCHER,/,                                                 
                05:X_NETWORK,/,                                                 
                05:X_VENDOR,/,                                                  
                05:X_INVOICE_NO,/,                                              
                05:X_COMPANY_CODE,/,                                            
                05:X_GROSS_AMOUNT,/,                                            
                05:X_CURRENCY,/,                                                
                05:'<Exchange_Rate/>',/,                                        
                05:X_INVOICE_DATE,/,                                            
                05:X_DUE_DATE,/,                                                
                05:X_TRANS_TYPE,/,                                              
                05:X_USERID,/,                                                  
                05:X_ADVERTISER,/,                                              
                05:X_ADVERNAME,/,                                               
                05:X_LOCCOD,/,                                                  
                05:X_POSTING_DATE),                                             
       TRAILER3=(03:'</Header>')),                                              
 TRAILER1=('</n1:MediaVendorClearance>')                                        
                                                                                
                                                                                
./ ADD NAME=CPTXCNTL                                                            
*                                                                               
* Generate the final XML dataset. Simplify all XML tags that contain            
* empty fields.                                                                 
*                                                                               
 OUTFIL FINDREP=(INOUT=(C'<MOS></MOS>',C'<MOS/>',                               
      C'<Media_System></Media_System>',C'<Media_System/>',                      
      C'<Invoice_No></Invoice_No>',C'<Invoice_No/>',                            
      C'<Company_Code></Company_Code>',C'<Company_Code/>',                      
      C'<Gross_Amount></Gross_Amount>',C'<Gross_Amount/>',                      
      C'<Currency></Currency>',C'<Currency/>',                                  
      C'<Voucher></Voucher>',C'<Voucher/>',                                     
      C'<Exchange_Rate></Exchange_Rate>',C'<Exchange_Rate/>',                   
      C'<Invoice_Date></Invoice_Date>',C'<Invoice_Date/>',                      
      C'<Due_Date></Due_Date>',C'<Due_Date/>',                                  
      C'<Trans_Type></Trans_Type>',C'<Trans_Type/>',                            
      C'<Media_Client></Media_Client>',C'<Media_Client/>',                      
      C'<Media_Product></Media_Product>',C'<Media_Product/>',                   
      C'<Campaign_Ref></Campaign_Ref>',C'<Campaign_Ref/>',                      
      C'<Discount></Discount>',C'<Discount/>',                                  
      C'<Accrual></Accrual>',C'<Accrual/>',                                     
      C'<Advertiser></Advertiser>',C'<Advertiser/>',                            
      C'<Advertiser_Name></Advertiser_Name>',C'<Advertiser_Name/>',             
      C'<Customer></Customer>',C'<Customer/>',                                  
      C'<Posting_Date></Posting_Date>',C'<Posting_Date/>',                      
      C'<Item_No></Item_No>',C'<Item_No/>',                                     
      C'<Net_Amount></Net_Amount>',C'<Net_Amount/>',                            
      C'<Tax_Code></Tax_Code>',C'<Tax_Code/>',                                  
      C'<Tax_Amount></Tax_Amount>',C'<Tax_Amount/>',                            
      C'<Vendor></Vendor>',C'<Vendor/>',                                        
      C'<MOS></MOS>',C'<MOS/>',                                                 
      C'<Media_Type></Media_Type>',C'<Media_Type/>',                            
      C'<Submedia></Submedia>',C'<Submedia/>',                                  
      C'<Submedia_Name></Submedia_Name>',C'<Submedia_Name/>',                   
      C'<Submedia_Type></Submedia_Type>',C'<Submedia_Type/>',                   
      C'<Item_Text></Item_Text>',C'<Item_Text/>',                               
      C'<Media_Campaign></Media_Campaign>',C'<Media_Campaign/>',                
      C'<Network></Network>',C'<Network/>',                                     
      C'<Estimate_Name></Estimate_Name>',C'<Estimate_Name/>',                   
      C'<Estimate></Estimate>',C'<Estimate/>',                                  
      C'<Insertion_Order></Insertion_Order>',C'<Insertion_Order/>',             
      C'<Product></Product>',C'<Product/>',                                     
      C'<Product_Name></Product_Name>',C'<Product_Name/>',                      
*     C'<UDEF_Product_1></UDEF_Product_1>',C'<UDEF_Product_1/>',                
*     C'<UDEF_Product_2></UDEF_Product_2>',C'<UDEF_Product_2/>',                
*     C'<UDEF_Estimate_1></UDEF_Estimate_1>',C'<UDEF_Estimate_1/>',             
*     C'<UDEF_Estimate_2></UDEF_Estimate_2>',C'<UDEF_Estimate_2/>',             
      C'<Media_Authorization></Media_Authorization>',                           
      C'<Media_Authorization/>',                                                
      C'<Estimate_Unique_Num></Estimate_Unique_Num>',                           
      C'<Estimate_Unique_Num/>',                                                
      C'<Buy_Unique_Num></Buy_Unique_Num>',C'<Buy_Unique_Num/>'))               
                                                                                
