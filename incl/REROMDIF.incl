*          DATA SET REROMDIF   AT LEVEL 126 AS OF 06/18/04                      
***********************************************************************         
*                                                                               
* APPROVAL LOGIC                                                                
*                                                                               
***********************************************************************         
APPROVE  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
*        GOTOR DUMPTSAR                                                         
*                                                                               
         GOTOR DATETIME                                                         
*                                                                               
* CHECK IF DAILY PACING IN USE                                                  
*                                                                               
         GOTOR CDALYPAZ                                                         
*                                                                               
* CHECK IF FLIGHT HEADERS DATES CHANGED                                         
*                                                                               
         MVI   FLTKEYFG,C'N'       DEFAULT DON'T REWRITE 8D/8E POINTERS         
*                                  OVERRIDE REP CON'S FLIGHT DATES              
*                                     WITH AGENCY ORDER'S DATES                 
         GOTO1 DATCON,DMCB,(2,FLTDATES),(3,WORK)                                
         GOTO1 DATCON,(R1),(2,FLTDATES+2),(3,WORK+3)                            
*                                                                               
         L     R6,AIO3                                                          
         USING RCONREC,R6                                                       
*                                                                               
         GOTO1 DATCON,DMCB,(3,RCONDATE),(2,CONFLTDT)                            
         GOTO1 DATCON,(R1),(3,RCONDATE+3),(2,CONFLTDT+2)                        
*                                  SAVE ORIGINAL CONTRACT DATES                 
         CLC   RCONDATE,WORK       IF DIFFERENT, FLAG TO UPDATE                 
         BE    AP20                8E/8D KEYS TO CONTRACT                       
*                                                                               
         CLC   RCONDATE(3),WORK    KEEP EARLIER START DATE                      
         BL    *+10                                                             
         MVC   RCONDATE(3),WORK                                                 
*                                                                               
         CLC   RCONDATE+3(3),WORK+3  KEEP LATER END DATE                        
         BH    *+10                                                             
         MVC   RCONDATE+3(3),WORK+3                                             
*                                                                               
*        MVC   RCONDATE,WORK                                                    
         MVI   FLTKEYFG,C'Y'                                                    
*                                                                               
AP20     DS    0H                                                               
         CLC   RTKODATE,RCONDATE   DATE CHOPPING??                              
         BNH   AP30                                                             
*                                                                               
         MVC   RCONDATE(3),RTKODATE                                             
         MVI   FLTKEYFG,C'Y'                                                    
*                                                                               
AP30     DS    0H                  OVERRIDE BUYER NAME WITH A/O NAME            
         MVC   RCONBUYR(20),SAVEBUYR                                            
         DROP  R6                                                               
*                                                                               
         MVI   ACTCODE,C'A'                                                     
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,X'0B'                                                  
         GOTO1 GOTSAR,TSARDH                                                    
         BL    AP500                                                            
*                                                                               
         MVI   AMSTRLN#,0          INIT COUNTERS                                
         MVI   AMSTRLNK,0          AGENCY MASTER LINE # AND OFFSET              
         MVI   SVMSTRLK,0          SAVED AGENCY MASTER LINE                     
*                                                                               
AP40     DS    0H                                                               
         CLI   TR.TLKTYP,X'0B'                                                  
         BNE   AP500                                                            
*                                                                               
         MVI   SMATFLAG,0          INIT SPECIAL FLAGS FOR C/O, DAILYS           
*                                                                               
*        TM    TR.TLBYFLG3,X'10'   MUST CHECK FOR AGENCY SEGMENT                
*        BO    AP43                                                             
*        TM    TR.TLBYFLG3,X'80'   MATCHED PERFECTLY                            
*        BZ    AP43                BUT WE STILL NEED TO MAKE SURE THE           
*        GOTOR PROCLINK            LINKS ARE CORRECT                            
*        B     AP100                                                            
*                                                                               
*                                                                               
         TM    TR.TLBYFLG3,X'80'   MATCHED PERFECTLY                            
         BZ    AP43                                                             
         TM    TR.TLBYFLG3,X'10'   MUST CHECK FOR AGENCY SEGMENT                
         BO    AP44                BUT WE STILL NEED TO MAKE SURE THE           
         GOTOR PROCLINK            LINKS ARE CORRECT                            
         B     AP100                                                            
*                                                                               
AP43     DS    0H                                                               
         CLI   TR.TLBYFLG,C'M'                                                  
         BNE   AP50                                                             
         CLI   TR.TLBYTYPA,C'A'    SKIP AGENCY SEGMENT                          
         BE    AP100                                                            
*                                                                               
         OC    TR.TLBYMLNK,TR.TLBYMLNK                                          
         BZ    AP45                SPECIAL FOR DAILY/COST OVERRIDE AND          
*                                                                               
         CLC   AMSTRLNK,TR.TLBYMLNK FIND WHERE WE ARE IN THE GROUP              
         BNE   AP44                                                             
         ZIC   RE,AMSTRLN#                                                      
         AHI   RE,1                                                             
         STC   RE,AMSTRLN#                                                      
*                                                                               
AP44     DS    0H                                                               
         GOTOR DOSMATCH            EARLY END DATE                               
*                                                                               
         CLC   AMSTRLNK,TR.TLBYMLNK                                             
         BE    AP100                                                            
         MVI   AMSTRLN#,0          INIT COUNTER                                 
         MVC   AMSTRLNK,TR.TLBYMLNK                                             
         B     AP100                                                            
*                                                                               
AP45     DS    0H                                                               
         GOTOR DOMATCH                                                          
         B     AP100                                                            
*                                                                               
AP50     DS    0H                                                               
         OC    TR.TLBYMLNK,TR.TLBYMLNK                                          
         BZ    AP60                SPECIAL FOR DAILY/COST OVERRIDE AND          
         GOTOR DOSUMTCH            EARLY END DATE                               
         B     AP100                                                            
*                                                                               
AP60     DS    0H                                                               
         GOTOR DOUNMTCH                                                         
*                                                                               
AP100    DS    0H                                                               
         GOTO1 GOTSAR,TSANXT                                                    
         BE    AP40                                                             
*                                                                               
* UPDATE CONTRACT RECORD                                                        
*                                                                               
AP500    DS    0H                                                               
         L     R6,AIO3                                                          
         MVI   ELCODE,X'1D'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING RCONDREL,R6                                                      
         OI    RCONDRFG,X'40'      SET APPROVED AND NOT REJECT/RECALL           
         NI    RCONDRFG,X'FF'-X'20'-X'10'                                       
         MVC   RCONDRDA,ACTDATE                                                 
         MVC   RCONDRTA,ACTTIME                                                 
         DROP  R6                                                               
*                                                                               
         L     R6,AIO3                                                          
         MVI   ELCODE,X'1F'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING RCONXEL,R6                                                       
         TM    RCONCONF,X'40'      CONFIRMED NOW                                
         BZ    AP530                                                            
*                                                                               
         NI    RCONCONF,X'FF'-X'40' TURN OFF CONFIRMED NOW                      
         OI    RCONCONF,X'20'      TURN ON CONFIRMED PREVIOUSLY                 
AP530    OI    RCONCONF,X'80'      NOT CONFIRMED                                
         DROP  R6                                                               
*                                                                               
         TM    FLAGS2,FG2DEMO      UPDATE DARE DEMO CATEGORIES ?                
         BZ    AP540                                                            
         OC    SVDEMCAT,SVDEMCAT                                                
         BZ    AP540                                                            
         GOTO1 HELLO,DMCB,(C'D',=C'REPFILE'),(X'DD',AIO3),0,0                   
         CLI   SVDEMCAT+1,2        NO DEMO, SKIP ELEMENT ADD                    
         BNH   AP540                                                            
         XC    ELEM,ELEM                                                        
         MVC   ELEM(L'SVDEMCAT),SVDEMCAT                                        
         MVC   AIO,AIO3                                                         
         GOTO1 ADDELEM                                                          
*                                                                               
AP540    DS    0H                                                               
         TM    MISCFLAG,MFCONOK    IF NOT ALREADY                               
         BO    APX                                                              
         L     RF,AIO3                                                          
         MVC   KEY(L'RCONKEY),0(RF)                                             
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(L'RCONKEY),KEYSAVE                                           
         BE    *+6                                                              
         DC    H'0'                                                             
         MVI   RDUPDATE,C'Y'                                                    
         MVC   AIO,AIOAREA         WRITE OUT CONTRACT RECORD                    
         GOTO1 GETREC                                                           
         MVC   AIO,AIO3                                                         
         GOTO1 PUTREC                                                           
*                                                                               
         CLI   FLTKEYFG,C'Y'       NEED TO REFRESH 8D/E POINTER?                
         BNE   APX                                                              
*                                  YES! CONFLTDT HAS OLD DATES                  
         GOTOR GEN8DEKY                                                         
*                                                                               
APX      DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* CHECK IF DAILY PACING IN USE                                                  
***********************************************************************         
CDALYPAZ NTR1  BASE=*,WORK=(R2,500),LABEL=*                                     
*                                                                               
         NI    BUCKFLGS,X'FF'-X'08' DEFAULT WEEKLY PACING                       
*                                                                               
         XC    KEY,KEY             GET REP RECORD                               
         MVI   KEY,X'01'                                                        
         MVC   KEY+25(2),TWAAGY                                                 
         XC    DUB,DUB                                                          
         MVC   DUB(4),ACOMFACS                                                  
         MVC   DUB+4(2),TWAAGY                                                  
*                                                                               
         GOTOX (RFGETREC,REPFACS),DMCB,KEY,(R2),0,DUB                           
         BNE   CDPX                REC NOT FOUND                                
*                                                                               
         USING RREPREC,R2                                                       
         CLI   RREPPROF+27,C'Y'    DAILY PACING?                                
         BNE   *+8                 NO                                           
         OI    BUCKFLGS,X'08'      YES - SET DAILY PACING FLAG                  
*                                                                               
CDPX     DS    0H                                                               
         B     EXIT                                                             
         DROP  R2                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* PROCESS MATCHED BUYS                                                          
***********************************************************************         
DOMATCH  NTR1  BASE=*,WORK=(R2,500),LABEL=*                                     
         XC    ABUYGRID,ABUYGRID                                                
         XC    RBUYGRID,RBUYGRID                                                
         NI    MISCFLG2,X'FF'-MF2FORCE                                          
         MVI   SVREPNPW,0                                                       
*                                                                               
         MVI   ABUYLINK,0                                                       
*                                                                               
         OC    TR.TLBYLNK,TR.TLBYLNK FORCED MATCH?                              
         BNZ   DOMT500                                                          
*                                                                               
* BUILD SPOT GRID FOR ALL AGENCY BUYS WITH THIS DAY/TIME/LEN/RATE               
* SEMENT                                                                        
*                                                                               
         OC    TR.TLBYALNK,TR.TLBYALNK                                          
         BZ    DOMT100             ANY AGENCY BUY(S)?                           
         LA    R3,TR.TLBYALNK                                                   
         TM    TR.TLBYAFLG,X'40'   BUY OR LIST OF BUYS?                         
         BZ    DOMT15                                                           
*                                                                               
* INDEX TO BUY LIST. RETRIEVE LIST AND PROCESS                                  
*                                                                               
         MVC   DMSVTR#,TXNUM                                                    
*                                                                               
         XC    TSARKEY,TSARKEY                                                  
TKEY     USING TLKEY,TSARKEY                                                    
         MVI   TKEY.TLKTYP,C'A'                                                 
         MVC   TKEY.TLBLINDX,TR.TLBYALNK                                        
         DROP  TKEY                                                             
*                                                                               
         MVC   TR.TLKEY,TSARKEY                                                 
         GOTO1 GOTSAR,TSARDH       RETRIEVE BUY LNK FOR CURRENT SEGMENT         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,TR.TLBLBUY#                                                   
*                                                                               
DOMT15   DS    0H                                                               
         XC    KEY,KEY                                                          
REPBUY   USING RBUYKEY,KEY                                                      
         MVC   REPBUY.RBUYKTYP(2),=X'0B01'                                      
         MVC   REPBUY.RBUYKREP,TWAAGY                                           
         MVC   REPBUY.RBUYKCON,COMPCON                                          
         MVC   REPBUY.RBUYKPLN,=X'FFFFFF'                                       
         MVC   REPBUY.RBUYKMLN,0(R3)                                            
*                                                                               
         CLI   ABUYLINK,0                                                       
         BNE   *+10                                                             
         MVC   ABUYLINK,0(R3)      ESTABLISH AGENCY BUY LINK                    
*                                                                               
         NI    DMINBTS,X'FF'-X'08' SKIP DELETED                                 
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(RBUYKLIN-RBUYKEY),KEYSAVE                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   AIO,AIO2                                                         
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC                                                           
*                                                                               
         LR    R0,R2                                                            
         LA    R1,4000                                                          
         L     RE,AIO2                                                          
         LR    RF,R1                                                            
         MVCL  (R0),(RE)           SAVE OFF AIO2 AGENCY BUY RECORD              
*                                                                               
         GOTOR BLDBGRID,DMCB,AIO,(X'41',ABUYGRID)                               
*                                                                               
         CLI   TR.TLKTYP,X'0B'     BUY SEGMENT OR LIST OF BUYS?                 
         BE    DOMT100                                                          
*                                                                               
         AHI   R3,TLBLLENQ                                                      
         CLI   0(R3),0                                                          
         BE    DOMT60                                                           
*                                                                               
         LH    RF,TR.TLLEN                                                      
         LA    RE,TSARREC(RF)                                                   
         CR    R3,RE               BOUNDARY CHECK                               
         BL    DOMT15                                                           
*                                                                               
DOMT60   DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,DMSVTR#                                                    
         GOTO1 GOTSAR,TSAGET       RESTORE                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
* BUILD SPOT GRID FOR ALL REP BUYS WITH THIS DAY/TIME/LEN/RATE                  
* SEMENT                                                                        
*                                                                               
DOMT100  DS    0H                                                               
         OC    TR.TLBYRLNK,TR.TLBYRLNK                                          
         BZ    DOMT200             ANY REP BUY(S)?                              
         LA    R3,TR.TLBYRLNK                                                   
         TM    TR.TLBYRFLG,X'40'   BUY OR LIST OF BUYS?                         
         BZ    DOMT115                                                          
*                                                                               
* INDEX TO BUY LIST. RETRIEVE LIST AND PROCESS                                  
*                                                                               
         MVC   DMSVTR#,TXNUM                                                    
*                                                                               
         XC    TSARKEY,TSARKEY                                                  
TKEY     USING TLKEY,TSARKEY                                                    
         MVI   TKEY.TLKTYP,C'R'                                                 
         MVC   TKEY.TLBLINDX,TR.TLBYRLNK                                        
         DROP  TKEY                                                             
*                                                                               
         MVC   TR.TLKEY,TSARKEY                                                 
         GOTO1 GOTSAR,TSARDH       RETRIEVE BUY LNK FOR CURRENT SEGMENT         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,TR.TLBLBUY#                                                   
*                                                                               
DOMT115  DS    0H                                                               
         XC    KEY,KEY                                                          
REPBUY   USING RBUYKEY,KEY                                                      
         MVI   REPBUY.RBUYKTYP,X'0B'                                            
         MVC   REPBUY.RBUYKREP,TWAAGY                                           
         MVC   REPBUY.RBUYKCON,COMPCON                                          
         MVC   REPBUY.RBUYKPLN,=X'FFFFFF'                                       
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
DOMT120  DS    0H                                                               
         CLC   KEY(RBUYKMLN-RBUYKEY),KEYSAVE                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   REPBUY.RBUYKLIN,0(R3)                                            
         BE    DOMT130                                                          
*                                                                               
         GOTO1 SEQ                                                              
         B     DOMT120                                                          
*                                                                               
DOMT130  DS    0H                                                               
         MVC   AIO,AIO2                                                         
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC                                                           
*                                                                               
         GOTOR BLDBGRID,DMCB,AIO,(X'41',RBUYGRID)                               
*                                                                               
         CLI   TR.TLKTYP,X'0B'     BUY SEGMENT OR LIST OF BUYS?                 
         BE    DOMT200                                                          
*                                                                               
         AHI   R3,TLBLLENQ                                                      
         CLI   0(R3),0                                                          
         BE    DOMT160                                                          
*                                                                               
         LH    RF,TR.TLLEN                                                      
         LA    RE,TSARREC(RF)                                                   
         CR    R3,RE               BOUNDARY CHECK                               
         BL    DOMT115                                                          
*                                                                               
DOMT160  DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,DMSVTR#                                                    
         GOTO1 GOTSAR,TSAGET       RESTORE                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
* COMPARE AGENCY AND REP BUY GRIDS TO DETERMINE SPOT ADDITION OR                
* REMOVAL                                                                       
*                                                                               
DOMT200  DS    0H                                                               
         LR    RE,R2               RESTORE AGENCY RECORD TO AIO2                
         LA    RF,4000                                                          
         L     R2,AIO2                                                          
         LR    R3,RF                                                            
         MVCL  (R2),(RE)           SAVE OFF AIO2 AGENCY BUY RECORD              
*                                                                               
         GOTOR COMPGRID                                                         
*                                                                               
         B     DOMTX                                                            
*                                                                               
* AGY AND REP BUYS' DAY/TIME/LEN/RATE DO NOT MATCH BUT THE BUYS ARE             
* FORCEABLY MATCHED BY USER                                                     
*                                                                               
DOMT500  DS    0H                                                               
*                                                                               
* BUILD SPOT GRID FOR ALL REP BUYS WITH THIS SEGMENT                            
*                                                                               
         OC    TR.TLBYRLNK,TR.TLBYRLNK                                          
         BNZ   *+6                                                              
         DC    H'0'                MUST HAVE REP BUY(S)                         
*                                                                               
         LA    R3,TR.TLBYRLNK                                                   
         MVC   DMSVTR#,TXNUM                                                    
*                                                                               
         TM    TR.TLBYRFLG,X'40'   BUY OR LIST OF BUYS?                         
         BZ    DOMT515                                                          
*                                                                               
* INDEX TO BUY LIST. RETRIEVE LIST AND PROCESS                                  
*                                                                               
         XC    TSARKEY,TSARKEY                                                  
TKEY     USING TLKEY,TSARKEY                                                    
         MVI   TKEY.TLKTYP,C'R'                                                 
         MVC   TKEY.TLBLINDX,TR.TLBYRLNK                                        
         DROP  TKEY                                                             
*                                                                               
         MVC   TR.TLKEY,TSARKEY                                                 
         GOTO1 GOTSAR,TSARDH       RETRIEVE BUY LNK FOR CURRENT SEGMENT         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,TR.TLBLBUY#                                                   
*                                                                               
DOMT515  DS    0H                                                               
         XC    KEY,KEY                                                          
REPBUY   USING RBUYKEY,KEY                                                      
         MVI   REPBUY.RBUYKTYP,X'0B'                                            
         MVC   REPBUY.RBUYKREP,TWAAGY                                           
         MVC   REPBUY.RBUYKCON,COMPCON                                          
         MVC   REPBUY.RBUYKPLN,=X'FFFFFF'                                       
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
DOMT520  DS    0H                                                               
         CLC   KEY(RBUYKMLN-RBUYKEY),KEYSAVE                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   REPBUY.RBUYKLIN,0(R3)                                            
         BE    DOMT530                                                          
*                                                                               
         GOTO1 SEQ                                                              
         B     DOMT520                                                          
*                                                                               
DOMT530  DS    0H                                                               
         MVC   AIO,AIO2                                                         
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC                                                           
*                                                                               
         GOTOR BLDBGRID,DMCB,AIO,(X'41',RBUYGRID)                               
*                                                                               
         CLI   TR.TLKTYP,X'0B'     BUY SEGMENT OR LIST OF BUYS?                 
         BE    DOMT600                                                          
*                                                                               
         AHI   R3,TLBLLENQ                                                      
         CLI   0(R3),0                                                          
         BE    DOMT560                                                          
*                                                                               
         LH    RF,TR.TLLEN                                                      
         LA    RE,TSARREC(RF)                                                   
         CR    R3,RE               BOUNDARY CHECK                               
         BL    DOMT515                                                          
*                                                                               
DOMT560  DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,DMSVTR#                                                    
         GOTO1 GOTSAR,TSAGET       RESTORE                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
* BUILD SPOT GRID FOR ALL AGENCY BUYS WITH THIS DAY/TIME/LEN/RATE               
* SEMENT                                                                        
*                                                                               
DOMT600  DS    0H                                                               
         MVC   DMSVTR#,TXNUM       SAVE OFF CURRENT TSAR REC #                  
*                                                                               
         XC    TSARKEY,TSARKEY                                                  
         MVC   TSARKEY,TR.TLKEY                                                 
         XC    TR.TLKEY,TR.TLKEY                                                
         MVC   TR.TLKEY(TLINDXLQ),TSARKEY                                       
         MVI   TR.TLBYTYPA,TLTYPAQ                                              
         MVC   TSARKEY,TR.TLKEY                                                 
*************                                                                   
*                                                                               
         GOTO1 GOTSAR,TSARDH                                                    
*                                                                               
DOMT610  DS    0H                                                               
         CLC   TR.TLKEY(TLINDXLQ),TSARKEY                                       
         BE    *+6                                                              
         DC    H'0'                                                             
         TM    TR.TLBYFLG3,X'08'   ALREADY PROCESSED?                           
         BZ    DOMT613                                                          
         GOTO1 GOTSAR,TSANXT                                                    
         B     DOMT610                                                          
*                                                                               
DOMT613  DS    0H                                                               
         OI    TR.TLBYFLG3,X'08'   MARKED PROCESSED                             
*                                                                               
         GOTO1 GOTSAR,TSAWRT                                                    
         TM    TB.TSERRS,TSERNF                                                 
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
*************                                                                   
*                                                                               
         LA    R3,TR.TLBYALNK                                                   
         TM    TR.TLBYAFLG,X'40'   BUY OR LIST OF BUYS?                         
         BZ    DOMT615                                                          
*                                                                               
* INDEX TO BUY LIST. RETRIEVE LIST AND PROCESS                                  
*                                                                               
*                                                                               
         XC    TSARKEY,TSARKEY                                                  
TKEY     USING TLKEY,TSARKEY                                                    
         MVI   TKEY.TLKTYP,C'A'                                                 
         MVC   TKEY.TLBLINDX,TR.TLBYALNK                                        
         DROP  TKEY                                                             
*                                                                               
         MVC   TR.TLKEY,TSARKEY                                                 
         GOTO1 GOTSAR,TSARDH       RETRIEVE BUY LNK FOR CURRENT SEGMENT         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,TR.TLBLBUY#                                                   
*                                                                               
DOMT615  DS    0H                                                               
         XC    KEY,KEY                                                          
REPBUY   USING RBUYKEY,KEY                                                      
         MVC   REPBUY.RBUYKTYP(2),=X'0B01'                                      
         MVC   REPBUY.RBUYKREP,TWAAGY                                           
         MVC   REPBUY.RBUYKCON,COMPCON                                          
         MVC   REPBUY.RBUYKPLN,=X'FFFFFF'                                       
         MVC   REPBUY.RBUYKMLN,0(R3)                                            
*                                                                               
         CLI   ABUYLINK,0                                                       
         BNE   *+10                                                             
         MVC   ABUYLINK,0(R3)      ESTABLISH AGENCY BUY LINK                    
*                                                                               
         NI    DMINBTS,X'FF'-X'08' SKIP DELETED                                 
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(RBUYKLIN-RBUYKEY),KEYSAVE                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
DOMT630  DS    0H                                                               
         MVC   AIO,AIO2                                                         
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC                                                           
*                                                                               
         GOTOR BLDBGRID,DMCB,AIO,(X'41',ABUYGRID)                               
*                                                                               
         CLI   TR.TLKTYP,X'0B'     BUY SEGMENT OR LIST OF BUYS?                 
         BE    DOMT660                                                          
*                                                                               
         AHI   R3,TLBLLENQ                                                      
         CLI   0(R3),0                                                          
         BE    DOMT660                                                          
*                                                                               
         LH    RF,TR.TLLEN                                                      
         LA    RE,TSARREC(RF)                                                   
         CR    R3,RE               BOUNDARY CHECK                               
         BL    DOMT615                                                          
*                                                                               
DOMT660  DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,DMSVTR#                                                    
         GOTO1 GOTSAR,TSAGET       RESTORE                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
DOMT700  DS    0H                                                               
         OI    MISCFLG2,MF2FORCE                                                
         GOTOR COMPGRID                                                         
*                                                                               
DOMTX    DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* UPDATE LINKS IN REP BUY(S)                                                    
* MULTIPLE AGENCY LINES UPDATING A SINGLE REP LINE WILL TAKE THE LOWEST         
* AGENCY LINE NUMBER AS ITS LINK                                                
* A SINGLE AGENCY LINE UPDATES MULTIPL REP LINES WILL ALL BE UPDATED TO         
* LINK TO THE SINGLE AGENCY LINE                                                
***********************************************************************         
PROCLINK NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   DMSVTR#,TXNUM                                                    
*                                                                               
         MVC   TSARREC2,TSARREC                                                 
*                                                                               
TR2      USING TLSTD,TSARREC2                                                   
*                                                                               
         MVC   ABUYLINK,TR.TLBYALNK                                             
         TM    TR.TLBYAFLG,X'40'    SINGLE AGY BUY OR LIST OF BUYS?             
         BZ    PLINK10                                                          
*                                                                               
* INDEX TO BUY LIST. RETRIEVE LIST AND PROCESS                                  
*                                                                               
         XC    TSARKEY,TSARKEY                                                  
TKEY     USING TLKEY,TSARKEY                                                    
         MVI   TKEY.TLKTYP,C'A'                                                 
         MVC   TKEY.TLBLINDX,TR.TLBYALNK                                        
         DROP  TKEY                                                             
*                                                                               
         MVC   TR.TLKEY,TSARKEY                                                 
         GOTO1 GOTSAR,TSARDH       RETRIEVE BUY LNK FOR CURRENT SEGMENT         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   ABUYLINK,TR.TLBLBUY#                                             
*                                                                               
PLINK10  DS    0H                                                               
         LA    R3,TR2.TLBYRLNK                                                  
*                                                                               
         TM    TR2.TLBYRFLG,X'40'   SINGLE REP BUY OR LIST OF BUYS?             
         BZ    PLINK20                                                          
*                                                                               
* INDEX TO BUY LIST. RETRIEVE LIST AND PROCESS                                  
*                                                                               
         XC    TSARKEY,TSARKEY                                                  
TKEY     USING TLKEY,TSARKEY                                                    
         MVI   TKEY.TLKTYP,C'R'                                                 
         MVC   TKEY.TLBLINDX,TR2.TLBYRLNK                                       
         DROP  TKEY                                                             
*                                                                               
         MVC   TR.TLKEY,TSARKEY                                                 
         GOTO1 GOTSAR,TSARDH       RETRIEVE BUY LNK FOR CURRENT SEGMENT         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,TR.TLBLBUY#                                                   
*                                                                               
PLINK20  DS    0H                                                               
         XC    KEY,KEY                                                          
REPBUY   USING RBUYKEY,KEY                                                      
         MVI   REPBUY.RBUYKTYP,X'0B'                                            
         MVC   REPBUY.RBUYKREP,TWAAGY                                           
         MVC   REPBUY.RBUYKCON,COMPCON                                          
         MVC   REPBUY.RBUYKPLN,=X'FFFFFF'                                       
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
PLINK30  DS    0H                                                               
         CLC   KEY(RBUYKMLN-RBUYKEY),KEYSAVE                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   REPBUY.RBUYKLIN,0(R3)                                            
         BE    PLINK40                                                          
*                                                                               
         GOTO1 SEQ                                                              
         B     PLINK30                                                          
*                                                                               
PLINK40  DS    0H                                                               
         MVC   AIO,AIO2                                                         
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO                                                           
         USING RBUYREC,R6                                                       
         CLC   RBUYAGBL,ABUYLINK                                                
         BE    PLINK50                                                          
         MVC   RBUYAGBL,ABUYLINK                                                
         GOTO1 PUTREC                                                           
         DROP  R6                                                               
*                                                                               
PLINK50  DS    0H                                                               
         CLI   TR.TLKTYP,C'R'      BUY SEGMENT OR LIST OF BUYS?                 
         BNE   PLINKX                                                           
*                                                                               
         AHI   R3,TLBLLENQ                                                      
         CLI   0(R3),0                                                          
         BE    PLINKX                                                           
*                                                                               
         LH    RF,TR.TLLEN                                                      
         LA    RE,TSARREC(RF)                                                   
         CR    R3,RE               BOUNDARY CHECK                               
         BL    PLINK20                                                          
*                                                                               
PLINKX   DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,DMSVTR#                                                    
         GOTO1 GOTSAR,TSAGET       RESTORE                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* PROCESS SPECIAL MATCHED BUYS (COST OVERRIDE, DAILY AND EARLY END)             
***********************************************************************         
DOSMATCH NTR1  BASE=*,WORK=(R2,DOSMWKQ),LABEL=*                                 
         USING DOSMWKD,R2                                                       
*                                                                               
         XC    ABUYGRID,ABUYGRID                                                
         XC    RBUYGRID,RBUYGRID                                                
         XC    TSARREC2,TSARREC2   BUY SEGMENT RECORD                           
         XC    RTSARREC,RTSARREC   REP BUY LINK RECORD                          
         XC    ATSARREC,ATSARREC   AGY BUY LINK RECORD                          
         NI    MISCFLG2,X'FF'-MF2FORCE                                          
         NI    MISCFLG3,X'FF'-MF3BASEG                                          
         MVI   ABUYLINK,0                                                       
         MVI   SVREPNPW,0                                                       
*                                                                               
         MVC   TSARREC2,TSARREC                                                 
*                                                                               
TR2      USING TLSTD,TSARREC2                                                   
TRA      USING TLSTD,ATSARREC                                                   
TRR      USING TLSTD,RTSARREC                                                   
*                                                                               
* BUILD SPOT GRID FOR THE REP BUY WITH THIS SEGMENT                             
*                                                                               
         OC    TR2.TLBYRLNK,TR2.TLBYRLNK                                        
         BNZ   *+6                                                              
         DC    H'0'                MUST HAVE REP BUY(S)                         
*                                                                               
         LA    R3,TR2.TLBYRLNK                                                  
         LA    R4,TR2.TLBYALNK                                                  
*                                                                               
         MVC   DMSVTR#,TXNUM                                                    
         MVC   DOSSVTR#,TXNUM                                                   
*                                                                               
         TM    TR2.TLBYRFLG,X'40'  BUY OR LIST OF BUYS?                         
         BZ    DOSMT515                                                         
*                                                                               
* INDEX TO BUY LIST. RETRIEVE LIST AND PROCESS                                  
*                                                                               
         XC    TSARKEY,TSARKEY                                                  
TKEY     USING TLKEY,TSARKEY                                                    
         MVI   TKEY.TLKTYP,C'R'                                                 
         MVC   TKEY.TLBLINDX,TR2.TLBYRLNK                                       
         DROP  TKEY                                                             
*                                                                               
         MVC   TR.TLKEY,TSARKEY                                                 
         GOTO1 GOTSAR,TSARDH       RETRIEVE BUY LNK FOR CURRENT SEGMENT         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   RTSARREC,TSARREC                                                 
*                                                                               
         LA    R3,TRR.TLBLBUY#                                                  
*                                                                               
DOSMT515 DS    0H                                                               
         XC    KEY,KEY                                                          
REPBUY   USING RBUYKEY,KEY                                                      
         MVI   REPBUY.RBUYKTYP,X'0B'                                            
         MVC   REPBUY.RBUYKREP,TWAAGY                                           
         MVC   REPBUY.RBUYKCON,COMPCON                                          
         MVC   REPBUY.RBUYKPLN,=X'FFFFFF'                                       
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
DOSMT520 DS    0H                                                               
         CLC   KEY(RBUYKMLN-RBUYKEY),KEYSAVE                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   REPBUY.RBUYKLIN,0(R3)                                            
         BE    DOSMT530                                                         
*                                                                               
         GOTO1 SEQ                                                              
         B     DOSMT520                                                         
*                                                                               
DOSMT530 DS    0H                                                               
         MVC   AIO,AIO2                                                         
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC                                                           
*                                                                               
         L     RE,AIO                                                           
         USING RBUYREC,RE                                                       
         MVC   SVREPNPW,RBUYNW                                                  
         DROP  RE                                                               
*                                                                               
         GOTOR BLDBGRID,DMCB,AIO,(X'41',RBUYGRID)                               
*                                                                               
* BUILD SPOT GRID FOR AGENCY BUY WITH THIS DAY/TIME/LEN/RATE                    
*                                                                               
         CLI   TRA.TLKTYP,C'A'     ARE WE IN THE MIDDLE OF AN AGY LIST          
         BE    DOSMT615            PROCESSING?                                  
*                                                                               
DOSMT535 DS    0H                                                               
         OC    TR2.TLBYALNK,TR2.TLBYALNK                                        
         BNZ   DOSMT613                                                         
*                                                                               
         XC    TSARKEY,TSARKEY                                                  
         MVC   TSARKEY,TR2.TLKEY                                                
         XC    TR.TLKEY,TR.TLKEY                                                
         MVC   TR.TLKEY(TLINDXLQ),TSARKEY                                       
         MVI   TR.TLBYTYPA,TLTYPAQ                                              
         MVC   TSARKEY,TR.TLKEY                                                 
*                                                                               
         GOTO1 GOTSAR,TSARDH                                                    
*                                                                               
DOSMT538 DS    0H                                                               
         CLC   TR.TLKEY(TLINDXLQ),TSARKEY                                       
         BNE   DOSMT600                                                         
         TM    TR.TLBYFLG3,X'08'   ALREADY PROCESSED?                           
         BZ    DOSMT550                                                         
         GOTO1 GOTSAR,TSANXT                                                    
         B     DOSMT538                                                         
*                                                                               
*&&DO                                                                           
         CLI   AMSTRLN#,0                                                       
         BE    DOSMT550                                                         
         ZIC   R6,AMSTRLN#                                                      
*                                                                               
DOSMT540 DS    0H                  BUMP TO CORRESPONDING AGENCY SEG             
         GOTO1 GOTSAR,TSANXT                                                    
         CLC   TR.TLKEY(TLINDXLQ),TSARKEY                                       
         BNE   DOSMT600                                                         
         BCT   R6,DOSMT540                                                      
         CLC   TR.TLKEY(TLINDXLQ),TSARKEY                                       
         BNE   DOSMT600                                                         
*&&                                                                             
*                                                                               
DOSMT550 DS    0H                                                               
         OI    TR.TLBYFLG3,X'08'   MARKED PROCESSED                             
*                                                                               
         GOTO1 GOTSAR,TSAWRT                                                    
         TM    TB.TSERRS,TSERNF                                                 
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
*        MVC   TSARREC2,TSARREC                                                 
         MVC   DOSSVTR#,TXNUM                                                   
*        OI    MISCFLG3,MF3BASEG                                                
*                                                                               
         LA    R4,TR.TLBYALNK                                                   
         TM    TR.TLBYAFLG,X'40'  BUY OR LIST OF BUYS?                          
         BZ    DOSMT615                                                         
         B     DOSMT614                                                         
*                                                                               
* MATCHED AGENCY BUY NOT FOUND, MUST BE REP BUYS THAT NEED TO BE                
* CANCELLED                                                                     
*                                                                               
DOSMT600 DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,DMSVTR#                                                    
         GOTO1 GOTSAR,TSAGET       RESTORE                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         GOTOR DOSUMTCH            CANCEL REP BUYS SPOTS                        
         B     DOSMTX                                                           
*                                                                               
DOSMT613 DS    0H                                                               
         TM    TR2.TLBYAFLG,X'40'  BUY OR LIST OF BUYS?                         
         BZ    DOSMT615                                                         
*                                                                               
* INDEX TO BUY LIST. RETRIEVE LIST AND PROCESS                                  
*                                                                               
DOSMT614 DS    0H                                                               
         CLI   TRA.TLKTYP,C'A'                                                  
         BE    DOSMT615                                                         
*                                                                               
         XC    TSARKEY,TSARKEY                                                  
TKEY     USING TLKEY,TSARKEY                                                    
         MVI   TKEY.TLKTYP,C'A'                                                 
         MVC   TKEY.TLBLINDX,TR2.TLBYALNK                                       
*                                                                               
         CLI   TR.TLBYTYPA,TLTYPAQ BUY AGENCY SEGMENT?                          
         BNE   *+10                                                             
         MVC   TKEY.TLBLINDX,TR.TLBYALNK                                        
         DROP  TKEY                                                             
*                                                                               
         MVC   TR.TLKEY,TSARKEY                                                 
         GOTO1 GOTSAR,TSARDH       RETRIEVE BUY LNK FOR CURRENT SEGMENT         
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   ATSARREC,TSARREC                                                 
*                                                                               
         LA    R4,TRA.TLBLBUY#                                                  
*                                                                               
DOSMT615 DS    0H                                                               
         XC    KEY,KEY                                                          
REPBUY   USING RBUYKEY,KEY                                                      
         MVC   REPBUY.RBUYKTYP(2),=X'0B01'                                      
         MVC   REPBUY.RBUYKREP,TWAAGY                                           
         MVC   REPBUY.RBUYKCON,COMPCON                                          
         MVC   REPBUY.RBUYKPLN,=X'FFFFFF'                                       
         MVC   REPBUY.RBUYKMLN,0(R4)                                            
*                                                                               
         MVC   ABUYLINK,0(R4)      ESTABLISH AGENCY BUY LINK                    
*                                                                               
         MVC   REPBUY.RBUYKLIN,2(R4)                                            
*                                                                               
         NI    DMINBTS,X'FF'-X'08' SKIP DELETED                                 
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(27),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   AIO,AIO2                                                         
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC                                                           
*                                                                               
         GOTOR BLDBGRID,DMCB,AIO,(X'41',ABUYGRID)                               
*                                                                               
         OI    MISCFLG2,MF2FORCE                                                
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,DMSVTR#                                                    
         CLC   DMSVTR#,DOSSVTR#                                                 
         BE    *+10                                                             
         MVC   TXNUM,DOSSVTR#                                                   
*                                                                               
         GOTO1 GOTSAR,TSAGET       RESTORE                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                  PASS ORIGINAL X'0B' TXNUM                    
         GOTOR SCMPGRID                                                         
*                                                                               
*        MVC   TXNUM,DMSVTR#                                                    
*        GOTO1 GOTSAR,TSAGET       RESTORE                                      
*        BE    *+6                                                              
*        DC    H'0'                                                             
*                                                                               
         XC    ABUYGRID,ABUYGRID                                                
         XC    RBUYGRID,RBUYGRID                                                
*                                                                               
*        TM    TR2.TLBYRFLG,X'40'  BUY OR LIST OF BUYS?                         
*        BZ    DOSMT630                                                         
*                                                                               
         CLI   TRR.TLKTYP,C'R'     BUY OR LIST OF BUYS?                         
         BNE   DOSMT630                                                         
*                                                                               
         AHI   R3,TLBLLENQ                                                      
         CLI   0(R3),0                                                          
         BE    DOSMT630                                                         
*                                                                               
         LH    RF,TRR.TLLEN                                                     
         LA    RE,RTSARREC(RF)                                                  
         CR    R3,RE               BOUNDARY CHECK                               
         BL    DOSMT640                                                         
*                                                                               
DOSMT630 DS    0H                                                               
         OI    SMATFLAG,SMATROKQ                                                
*                                                                               
DOSMT640 DS    0H                                                               
*        TM    TR2.TLBYAFLG,X'40'  AGY BUY SEGMENT OR LIST OF BUYS?             
*        BZ    DOSMT650                                                         
*                                                                               
         CLI   TRA.TLKTYP,C'A'     BUY OR LIST OF BUYS?                         
         BNE   DOSMT650                                                         
*                                                                               
         AHI   R4,TLBLLENQ                                                      
         CLI   0(R4),0                                                          
         BE    DOSMT650                                                         
*                                                                               
         LH    RF,TRA.TLLEN                                                     
         LA    RE,ATSARREC(RF)                                                  
         CR    R4,RE               BOUNDARY CHECK                               
         BNL   DOSMT650                                                         
*                                                                               
         TM    SMATFLAG,SMATROKQ                                                
         BZ    DOSMT515                                                         
*        TM    SMATFLAG,SMATAOKQ                                                
*        BZ    DOSMT615                                                         
         OI    SMATFLAG,SMATDALY                                                
         B     DOSMT710                                                         
*                                                                               
DOSMT650 DS    0H                                                               
         CLI   TR.TLBYTYPA,TLTYPAQ                                              
         BNE   DOSMT660                                                         
         TM    SMATFLAG,SMATROKQ                                                
         BZ    DOSMT515                                                         
*                                                                               
DOSMT660 DS    0H                                                               
         OI    SMATFLAG,SMATAOKQ                                                
         TM    TR2.TLBYFLG3,X'10'  NEED TO READ AGY SEGMENT?                    
         BNZ   DOSMT700                                                         
         TM    TR2.TLBYFLG3,X'80'        PERFECT MATCHED?                       
         BNZ   DOSMT670            SEGMENT MATCHED?                             
         CLI   TR2.TLBYLNK,0       NO, NEED TO READ ADDITIONAL                  
         BNE   DOSMT700            AGY BUY SEG                                  
*                                                                               
DOSMT670 DS    0H                                                               
*        OI    MISCFLG3,MF3BASEG                                                
*                                                                               
DOSMT700 DS    0H                                                               
         TM    SMATFLAG,SMATROKQ+SMATAOKQ                                       
         BO    DOSMTX                                                           
*                                                                               
DOSMT710 DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,DMSVTR#                                                    
         CLC   DMSVTR#,DOSSVTR#                                                 
         BE    *+10                                                             
         MVC   TXNUM,DOSSVTR#                                                   
*                                                                               
         GOTO1 GOTSAR,TSAGET       RESTORE                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         GOTOR DOSUMTCH            REMAINING ARE UNMATCHED                      
*                                                                               
DOSMTX   DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,DMSVTR#                                                    
         GOTO1 GOTSAR,TSAGET       RESTORE                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   TSARKEY,TR.TLKEY                                                 
*                                                                               
         TM    MISCFLG3,MF3BASEG   BUY AGENCY SEGMENT ALREADY PROCESSED         
         BO    DOSMTXX             SKIP                                         
*                                                                               
*        TM    TR.TLBYFLG3,X'10'   CHECK FLAG TO SEE IF WE NEED TO              
*        BZ    DOSMTX10            READ AGENCY BUY SEGMENTS                     
         GOTO1 GOTSAR,TSANXT       ONLY IF THIS SEGMENT IS LAST IN THE          
         CLC   TR.TLKEY(TLINDXLQ),TSARKEY                       GROUP           
         BE    DOSMTXX                                                          
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,DMSVTR#                                                    
         GOTO1 GOTSAR,TSAGET       RESTORE                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
DOSMTX10 DS    0H                                                               
         NI    SMATFLAG,X'FF'-SMATROKQ-SMATAOKQ                                 
         GOTOR DOCOADDS            PROCESS COST OVERRIDE ADDS IF ANY            
*                                                                               
DOSMTXX  DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,DMSVTR#                                                    
         GOTO1 GOTSAR,TSAGET       RESTORE                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         B     EXIT                                                             
         DROP  TR2                                                              
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* PROCESS COST OVERRIDE ADDS IF ANY                                             
***********************************************************************         
DOCOADDS NTR1  BASE=*,WORK=(R2,DOCADDQ),LABEL=*                                 
         USING DOCADDD,R2                                                       
*                                                                               
*        CLC   SVMSTRLK,TR.TLBYLNK HAVE WE PROCESSED THESE                      
*        BE    DOCOAX              AGENCY BUY SEGMENTS ALREADY?                 
*                                                                               
DOCOA10  DS    0H                                                               
         XC    DOCASVKY,DOCASVKY                                                
         MVC   DOCASVKY,TR.TLKEY                                                
         XC    TR.TLKEY,TR.TLKEY                                                
         MVC   TR.TLKEY(TLINDXLQ),DOCASVKY                                      
         MVI   TR.TLBYTYPA,TLTYPAQ                                              
         MVC   DOCASVKY,TR.TLKEY                                                
*                                                                               
         GOTO1 GOTSAR,TSARDH                                                    
*                                                                               
DOCOA20  DS    0H                                                               
         CLC   TR.TLKEY(TLINDXLQ),DOCASVKY                                      
         BNE   DOCOAX                                                           
*                                                                               
         TM    TR.TLBYFLG3,X'08'   PROCESSED ALREADY?                           
         BO    DOCOA30             YES, SKIP                                    
*                                                                               
*        TM    TR.TLBYAFLG,X'40'   SHOULD BE ACTUAL BUY # FOR C/O               
*        BO    DOCOAX              IF LIST, THEN THIS IS A DAILY                
*                                  SO EXIT                                      
         GOTOR DOSUMTCH                                                         
*                                                                               
DOCOA30  DS    0H                                                               
         GOTO1 GOTSAR,TSANXT                                                    
         B     DOCOA20                                                          
*                                                                               
DOCOAX   DS    0H                                                               
*        MVC   SVMSTRLK,DOCASVKY+(TLBYLNK-TLKEY)                                
         B     EXIT                                                             
         DROP  R2                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* PROCESS UNMATCHED BUYS                                                        
***********************************************************************         
DOUNMTCH NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         OC    TR.TLBYRLNK,TR.TLBYRLNK REP?                                     
         BNZ   DOUM10                                                           
         OC    TR.TLBYALNK,TR.TLBYALNK AGENCY?                                  
         BNZ   DOUM100                                                          
         DC    H'0'                                                             
*                                                                               
* PROCESS UNMATCHED REP BUYS                                                    
* ALL SPOTS WILL BE ZEROED OUT                                                  
*                                                                               
DOUM10   DS    0H                                                               
         LA    R3,TR.TLBYRLNK                                                   
         TM    TR.TLBYRFLG,X'40'   BUY OR LIST OF BUYS?                         
         BZ    DOUM15                                                           
*                                                                               
* INDEX TO BUY LIST. RETRIEVE LIST AND PROCESS                                  
*                                                                               
         MVC   DUSVTR#,TXNUM                                                    
*                                                                               
         XC    TSARKEY,TSARKEY                                                  
TKEY     USING TLKEY,TSARKEY                                                    
         MVI   TKEY.TLKTYP,C'R'                                                 
         MVC   TKEY.TLBLINDX,TR.TLBYRLNK                                        
         DROP  TKEY                                                             
*                                                                               
         MVC   TR.TLKEY,TSARKEY                                                 
         GOTO1 GOTSAR,TSARDH       RETRIEVE BUY LNK FOR CURRENT SEGMENT         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,TR.TLBLBUY#                                                   
*                                                                               
DOUM15   DS    0H                                                               
         XC    KEY,KEY                                                          
REPBUY   USING RBUYKEY,KEY                                                      
         MVI   REPBUY.RBUYKTYP,X'0B'                                            
         MVC   REPBUY.RBUYKREP,TWAAGY                                           
         MVC   REPBUY.RBUYKCON,COMPCON                                          
         MVC   REPBUY.RBUYKPLN,=X'FFFFFF'                                       
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
DOUM20   DS    0H                                                               
         CLC   KEY(RBUYKMLN-RBUYKEY),KEYSAVE                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   REPBUY.RBUYKLIN,0(R3)                                            
         BE    DOUM30                                                           
*                                                                               
         GOTO1 SEQ                                                              
         B     DOUM20                                                           
*                                                                               
DOUM30   DS    0H                                                               
         MVC   AIO,AIO2                                                         
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC                                                           
*                                                                               
         MVI   BUCKFLAG,X'FF'      SET TO BACK OUT FIGURES                      
         OI    BUCKFLGS,X'10'      DON'T IGNORE CANCELLED BUYS                  
*                                  BACK OUT BUCKETS                             
         GOTOR BUCKUPDT                                                         
*                                                                               
         NI    BUCKFLGS,X'FF'-X'10' RESET                                       
*                                                                               
         GOTOR DOORDCMT            GENERATE ORD COMMENT FOR CANCELLED           
*                                  SPOTS                                        
*                                                                               
         SR    R4,R4                                                            
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'03'                                                     
         BRAS  RE,GETEL                                                         
         BNE   DOUM50                                                           
*                                                                               
DOUM40   DS    0H                                                               
         USING RBUYDTEL,R6                                                      
         CLI   RBUYDTNW,0                                                       
         BE    DOUM45                                                           
         LA    R4,1                                                             
*                                                                               
         OI    RBUYDTIN,X'01'      OVERRIDE TO ZERO                             
         MVI   RBUYDTNW,0                                                       
*                                                                               
DOUM45   DS    0H                                                               
         BRAS  RE,NEXTEL                                                        
         BE    DOUM40                                                           
         DROP  R6                                                               
*                                                                               
DOUM50   DS    0H                                                               
         L     R6,AIO                                                           
         USING RBUYREC,R6                                                       
         LTR   R4,R4               ALL WEEKS ALREADY ZEROED OUT?                
         BNZ   DOUM53                                                           
         CLI   RBUYAGBL,0          AGENCY LINK STILL PRESENT?                   
         BE    DOUM58              DON'T NEED TO UPDATE THIS REP BUY            
         B     DOUM55                                                           
*                                                                               
DOUM53   DS    0H                                                               
         XC    RBUYTSPT,RBUYTSPT   ZERO OUT TOTAL SPOTS AND COST                
         XC    RBUYTCOS,RBUYTCOS                                                
*                                                                               
         GOTOR UPDTMOD,DMCB,(C'S',AIO)                                          
*                                                                               
DOUM55   DS    0H                                                               
         MVI   RBUYAGBL,0          ZERO OUT LINK                                
         GOTO1 PUTREC                                                           
         DROP  R6                                                               
*                                                                               
DOUM58   DS    0H                                                               
         CLI   TR.TLKTYP,X'0B'     BUY SEGMENT OR LIST OF BUYS?                 
         BE    DOUM100                                                          
*                                                                               
         AHI   R3,TLBLLENQ                                                      
         CLI   0(R3),0                                                          
         BE    DOUM60                                                           
*                                                                               
         LH    RF,TR.TLLEN                                                      
         LA    RE,TSARREC(RF)                                                   
         CR    R3,RE               BOUNDARY CHECK                               
         BL    DOUM15                                                           
*                                                                               
DOUM60   DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,DUSVTR#                                                    
         GOTO1 GOTSAR,TSAGET       RESTORE                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
* PROCESS UNMATCHED AGENCY BUYS                                                 
* THESE WILL BE ADDED AS NEW BUYS TO CONTRACT                                   
*                                                                               
DOUM100  DS    0H                                                               
         OC    TR.TLBYALNK,TR.TLBYALNK                                          
         BZ    DOUMX               NO AGENCY BUYS FOUND, EXIT                   
*                                                                               
         LA    R3,TR.TLBYALNK                                                   
         TM    TR.TLBYAFLG,X'40'   BUY OR LIST OF BUYS?                         
         BZ    DOUM115                                                          
*                                                                               
* INDEX TO BUY LIST. RETRIEVE LIST AND PROCESS                                  
*                                                                               
         MVC   DUSVTR#,TXNUM                                                    
*                                                                               
         XC    TSARKEY,TSARKEY                                                  
TKEY     USING TLKEY,TSARKEY                                                    
         MVI   TKEY.TLKTYP,C'A'                                                 
         MVC   TKEY.TLBLINDX,TR.TLBYALNK                                        
         DROP  TKEY                                                             
*                                                                               
         MVC   TR.TLKEY,TSARKEY                                                 
         GOTO1 GOTSAR,TSARDH       RETRIEVE BUY LNK FOR CURRENT SEGMENT         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,TR.TLBLBUY#                                                   
*                                                                               
DOUM115  DS    0H                                                               
         XC    KEY,KEY                                                          
REPBUY   USING RBUYKEY,KEY                                                      
         MVI   REPBUY.RBUYKTYP,X'0B'                                            
         MVI   REPBUY.RBUYKTYP+1,X'01'                                          
         MVC   REPBUY.RBUYKREP,TWAAGY                                           
         MVC   REPBUY.RBUYKCON,COMPCON                                          
         MVC   REPBUY.RBUYKPLN,=X'FFFFFF'                                       
         MVC   REPBUY.RBUYKMLN,0(R3)                                            
*                                                                               
         NI    DMINBTS,X'FF'-X'08' SKIP DELETED                                 
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(RBUYKLIN-RBUYKEY),KEYSAVE                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   AIO,AIO2                                                         
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO                                                           
         USING RBUYREC,R6                                                       
         MVI   RBUYKTYP+1,0        CHANGE FROM AGENCY SHADOW TO REAL            
         DROP  R6                  REP BUY                                      
*                                                                               
         GOTOR ADDBUY                                                           
*                                                                               
         CLI   TR.TLKTYP,X'0B'     BUY SEGMENT OR LIST OF BUYS?                 
         BE    DOUMX                                                            
*                                                                               
         AHI   R3,TLBLLENQ                                                      
         CLI   0(R3),0                                                          
         BE    DOUM160                                                          
*                                                                               
         LH    RF,TR.TLLEN                                                      
         LA    RE,TSARREC(RF)                                                   
         CR    R3,RE               BOUNDARY CHECK                               
         BL    DOUM115                                                          
*                                                                               
DOUM160  DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,DUSVTR#                                                    
         GOTO1 GOTSAR,TSAGET       RESTORE                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
DOUMX    DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* PROCESS SPECIAL UNMATCHED BUYS (COST OVERRIDE, DAILY AND EARLY END)           
* USES R2 FOR WORK AREA SHARED BY DOSMATCH                                      
***********************************************************************         
DOSUMTCH NTR1  BASE=*,LABEL=*                                                   
         USING DOSMWKD,R2                                                       
*                                                                               
         MVC   DUSVTR#,TXNUM                                                    
*                                                                               
         TM    SMATFLAG,SMATROKQ+SMATAOKQ                                       
         BZ    DOSU05              CHECK IF WE CAN FROM MATCH ROUTINE           
         TM    SMATFLAG,SMATROKQ                                                
         BZ    DOSU15                                                           
         B     DOSU110                                                          
*                                                                               
DOSU05   DS    0H                                                               
         OC    TR.TLBYRLNK,TR.TLBYRLNK REP?                                     
         BNZ   DOSU10                                                           
         OC    TR.TLBYALNK,TR.TLBYALNK AGENCY?                                  
         BNZ   DOSU100                                                          
         DC    H'0'                                                             
*                                                                               
* PROCESS UNMATCHED REP BUYS                                                    
* ALL SPOTS WILL BE ZEROED OUT                                                  
*                                                                               
DOSU10   DS    0H                                                               
         TM    SMATFLAG,SMATROKQ+SMATAOKQ                                       
         BNZ   DOSU15                                                           
         LA    R3,TR.TLBYRLNK                                                   
         TM    TR.TLBYRFLG,X'40'   BUY OR LIST OF BUYS?                         
         BZ    DOSU15                                                           
*                                                                               
* INDEX TO BUY LIST. RETRIEVE LIST AND PROCESS                                  
*                                                                               
         XC    TSARKEY,TSARKEY                                                  
TKEY     USING TLKEY,TSARKEY                                                    
         MVI   TKEY.TLKTYP,C'R'                                                 
         MVC   TKEY.TLBLINDX,TR.TLBYRLNK                                        
         DROP  TKEY                                                             
*                                                                               
         MVC   TR.TLKEY,TSARKEY                                                 
         GOTO1 GOTSAR,TSARDH       RETRIEVE BUY LNK FOR CURRENT SEGMENT         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,TR.TLBLBUY#                                                   
*                                                                               
DOSU15   DS    0H                                                               
         XC    KEY,KEY                                                          
REPBUY   USING RBUYKEY,KEY                                                      
         MVI   REPBUY.RBUYKTYP,X'0B'                                            
         MVC   REPBUY.RBUYKREP,TWAAGY                                           
         MVC   REPBUY.RBUYKCON,COMPCON                                          
         MVC   REPBUY.RBUYKPLN,=X'FFFFFF'                                       
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
DOSU20   DS    0H                                                               
         CLC   KEY(RBUYKMLN-RBUYKEY),KEYSAVE                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   REPBUY.RBUYKLIN,0(R3)                                            
         BE    DOSU30                                                           
*                                                                               
         GOTO1 SEQ                                                              
         B     DOSU20                                                           
*                                                                               
DOSU30   DS    0H                                                               
         MVC   AIO,AIO2                                                         
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC                                                           
*                                                                               
         MVI   BUCKFLAG,X'FF'      SET TO BACK OUT FIGURES                      
         OI    BUCKFLGS,X'10'      DON'T IGNORE CANCELLED BUYS                  
*                                  BACK OUT BUCKETS                             
         GOTOR BUCKUPDT                                                         
*                                                                               
         NI    BUCKFLGS,X'FF'-X'10' RESET                                       
*                                                                               
         GOTOR DOORDCMT            GENERATE ORD COMMENT FOR CANCELLED           
*                                  SPOTS                                        
         L     R6,AIO                                                           
         MVI   ELCODE,X'03'                                                     
         BRAS  RE,GETEL                                                         
         BNE   DOSU50                                                           
*                                                                               
DOSU40   DS    0H                                                               
         USING RBUYDTEL,R6                                                      
         OI    RBUYDTIN,X'01'      OVERRIDE TO ZERO                             
         MVI   RBUYDTNW,0                                                       
         BRAS  RE,NEXTEL                                                        
         BE    DOSU40                                                           
         DROP  R6                                                               
*                                                                               
DOSU50   DS    0H                                                               
         L     R6,AIO                                                           
         USING RBUYREC,R6                                                       
         MVI   RBUYAGBL,0          ZERO OUT LINK                                
         XC    RBUYTSPT,RBUYTSPT   ZERO OUT TOTAL SPOTS AND COST                
         XC    RBUYTCOS,RBUYTCOS                                                
         DROP  R6                                                               
*                                                                               
         GOTOR UPDTMOD,DMCB,(C'S',AIO)                                          
*                                                                               
         GOTO1 PUTREC                                                           
*                                                                               
         TM    SMATFLAG,SMATROKQ+SMATAOKQ                                       
         BNZ   DOSUX                                                            
*                                                                               
         CLI   TR.TLKTYP,X'0B'     BUY SEGMENT OR LIST OF BUYS?                 
         BE    DOSU100                                                          
*                                                                               
         AHI   R3,TLBLLENQ                                                      
         CLI   0(R3),0                                                          
         BE    DOSU60                                                           
*                                                                               
         LH    RF,TR.TLLEN                                                      
         LA    RE,TSARREC(RF)                                                   
         CR    R3,RE               BOUNDARY CHECK                               
         BL    DOSU15                                                           
*                                                                               
DOSU60   DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,DUSVTR#                                                    
         GOTO1 GOTSAR,TSAGET       RESTORE                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
* PROCESS UNMATCHED AGENCY BUYS                                                 
* THESE WILL BE ADDED AS NEW BUYS TO CONTRACT                                   
*                                                                               
DOSU100  DS    0H                                                               
         TM    TR.TLBYFLG3,X'08'   PROCESSED ALREADY?                           
         BO    DOSU160             SKIP AND EXIT                                
         OI    TR.TLBYFLG3,X'08'   MARK PROCESSED                               
*                                                                               
         GOTO1 GOTSAR,TSAWRT                                                    
         TM    TB.TSERRS,TSERNF                                                 
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
DOSU110  DS    0H                                                               
         TM    SMATFLAG,SMATROKQ+SMATAOKQ                                       
         BNZ   DOSU115                                                          
*                                                                               
         OC    TR.TLBYALNK,TR.TLBYALNK                                          
         BZ    DOSUX               NO AGENCY BUYS FOUND, EXIT                   
*                                                                               
         LA    R4,TR.TLBYALNK                                                   
         TM    TR.TLBYAFLG,X'40'   BUY OR LIST OF BUYS?                         
         BZ    DOSU115                                                          
*                                                                               
* INDEX TO BUY LIST. RETRIEVE LIST AND PROCESS                                  
*                                                                               
         MVC   DUSVTR#,TXNUM                                                    
*                                                                               
         XC    TSARKEY,TSARKEY                                                  
TKEY     USING TLKEY,TSARKEY                                                    
         MVI   TKEY.TLKTYP,C'A'                                                 
         MVC   TKEY.TLBLINDX,TR.TLBYALNK                                        
         DROP  TKEY                                                             
*                                                                               
         MVC   TR.TLKEY,TSARKEY                                                 
         GOTO1 GOTSAR,TSARDH       RETRIEVE BUY LNK FOR CURRENT SEGMENT         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R4,TR.TLBLBUY#                                                   
*                                                                               
DOSU115  DS    0H                                                               
         XC    KEY,KEY                                                          
REPBUY   USING RBUYKEY,KEY                                                      
         MVI   REPBUY.RBUYKTYP,X'0B'                                            
         MVI   REPBUY.RBUYKTYP+1,X'01'                                          
         MVC   REPBUY.RBUYKREP,TWAAGY                                           
         MVC   REPBUY.RBUYKCON,COMPCON                                          
         MVC   REPBUY.RBUYKPLN,=X'FFFFFF'                                       
         MVC   REPBUY.RBUYKMLN,0(R4)                                            
*                                                                               
         MVC   REPBUY.RBUYKLIN,TR.TLBYASUB                                      
*                                                                               
         TM    SMATFLAG,SMATDALY   SPECIAL DAILY PROCESSING?                    
         BO    DOSU120                                                          
         CLI   TR.TLKTYP,C'A'                                                   
         BNE   DOSU130                                                          
DOSU120  MVC   REPBUY.RBUYKLIN,2(R4)                                            
*                                                                               
DOSU130  DS    0H                                                               
         NI    DMINBTS,X'FF'-X'08' SKIP DELETED                                 
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(RBUYKLIN-RBUYKEY),KEYSAVE                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   AIO,AIO2                                                         
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO                                                           
         USING RBUYREC,R6                                                       
         MVI   RBUYKTYP+1,0        CHANGE FROM AGENCY SHADOW TO REAL            
         DROP  R6                  REP BUY                                      
*                                                                               
         GOTOR ADDBUY                                                           
*                                                                               
         TM    SMATFLAG,SMATDALY   SPECIAL DAILY PROCESSING?                    
         BO    DOSU140                                                          
*                                                                               
         TM    SMATFLAG,SMATROKQ+SMATAOKQ                                       
         BNZ   DOSU160                                                          
*                                                                               
         CLI   TR.TLKTYP,X'0B'     BUY SEGMENT OR LIST OF BUYS?                 
         BE    DOSUX                                                            
*                                                                               
         AHI   R4,TLBLLENQ                                                      
         CLI   0(R4),0                                                          
         BE    DOSU160                                                          
*                                                                               
         LH    RF,TR.TLLEN                                                      
         LA    RE,TSARREC(RF)                                                   
         CR    R4,RE               BOUNDARY CHECK                               
         BL    DOSU115                                                          
         B     DOSU160                                                          
*                                                                               
DOSU140  DS    0H                                                               
         AHI   R4,TLBLLENQ                                                      
         CLI   0(R4),0                                                          
         BE    DOSU160                                                          
*        B     DOSU115                                                          
*                                                                               
*        LH    RF,TRA.TLLEN                                                     
         ZICM  RF,ATSARREC,2                                                    
         LA    RE,ATSARREC(RF)                                                  
         CR    R4,RE               BOUNDARY CHECK                               
         BL    DOSU115                                                          
*                                                                               
DOSU160  DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,DUSVTR#                                                    
         GOTO1 GOTSAR,TSAGET       RESTORE                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
DOSUX    DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*&&DO                                                                           
***********************************************************************         
* ADD SPOT(S) CANCELLED COMMENTS                                                
***********************************************************************         
DOORDCMT NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    MYELEM,MYELEM                                                    
         XC    ELTBUILD,ELTBUILD                                                
*                                                                               
         L     R6,AIO2             CHAIN AND SAVE OFF CURRENT COMMENTS          
         MVI   ELCODE,X'84'                                                     
         BRAS  RE,GETEL                                                         
         BNE   DOOC20                                                           
         ZIC   RF,1(R6)                                                         
         SHI   RF,4                OVERHEAD + EXECUTED MOVE                     
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   MYELEM(0),3(R6)                                                  
         LA    R4,MYELEM                                                        
         LA    R4,1(R4,RF)                                                      
*                                                                               
         BRAS  RE,NEXTEL                                                        
         BNE   DOOC05                                                           
         ZIC   RF,1(R6)                                                         
         SHI   RF,4                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),0(R6)                                                    
         LA    R4,1(R4,RF)                                                      
*                                                                               
DOOC05   DS    0H                                                               
         MVI   0(R4),C','                                                       
         AHI   R4,1                                                             
*                                                                               
* REPLACE EXISTING BUY ORDER COMMENT                                            
DOOC10   DS    0H                                                               
         GOTO1 HELLO,DMCB,(C'D',=C'REPFILE'),(X'84',AIO2),0,0                   
*                                                                               
DOOC20   DS    0H                                                               
         LA    R2,MYELEM                                                        
         LA    R1,120              MAX 2 ORD COMMENTS                           
*                                                                               
DOOC30   DS    0H                                                               
         CLI   0(R2),0                                                          
         BE    DOOC40                                                           
         AHI   R2,1                                                             
         BCT   R1,DOOC30                                                        
         B     DOOCX                                                            
*                                                                               
DOOC40   DS    0H                                                               
         L     R6,AIO2                                                          
         MVI   ELCODE,X'03'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
DOOC45   DS    0H                                                               
         USING RBUYDTEL,R6                                                      
         CLI   RBUYDTNW,0                                                       
         BE    DOOC95                                                           
*                                                                               
         GOTO1 DATCON,DMCB,(3,RBUYDTST),(4,(R2))                                
         AHI   R2,5                                                             
         CLI   RBUYDTWK,1                                                       
         BNH   DOOC50                                                           
         MVI   0(R2),C'-'                                                       
         AHI   R2,1                                                             
         EDIT  RBUYDTWK,(3,0(R2)),ALIGN=LEFT                                    
         AR    R2,R0                                                            
         MVC   0(4,R2),=C'WKS,'                                                 
         AHI   R2,4                                                             
*                                                                               
DOOC50   DS    0H                                                               
         MVC   0(11,R2),=C' #SPTS WAS '                                         
         AHI   R2,11                                                            
*                                                                               
         EDIT  RBUYDTNW,(3,0(R2)),ALIGN=LEFT,ZERO=NOBLANK                       
*                                  BUILD AND ADD CHANGE BUY ORD CMTS            
DOOC60   DS    0H                                                               
         BAS   RE,BUILDBOC                                                      
*                                  USE HELLO FOR FIRST LINE                     
DOOC95   DS    0H                                                               
         BRAS  RE,NEXTEL                                                        
         BE    DOOC45                                                           
         DROP  R6                                                               
*                                                                               
         OC    ELTBUILD,ELTBUILD                                                
         BNZ   DOOC98                                                           
*                                                                               
         BAS   RE,BUILDBOC                                                      
*                                                                               
DOOC98   DS    0H                                                               
         L     R6,AIO2                                                          
         MVI   ELCODE,X'84'                                                     
         BRAS  RE,GETEL                                                         
         BE    DOOC100                                                          
*                                                                               
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),AIO2,ELTBUILD,0                    
*                                                                               
         OC    MYELEM+60(60),SPACES                                             
         CLC   MYELEM+60(60),SPACES                                             
         BE    DOOCX                                                            
         L     R6,AIO2                                                          
         MVI   ELCODE,X'84'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         B     DOOC60              GO ADD SECOND ELEMENT                        
*                                                                               
DOOC100  DS    0H                  SECOND LINE MUST USE RECUP FOR               
         ZIC   R1,1(R6)            PROPER ORDERING                              
         AR    R6,R1                                                            
         GOTO1 VRECUP,DMCB,(2,AIO2),ELTBUILD,(R6),0                             
*                                                                               
DOOCX    DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*&&                                                                             
***********************************************************************         
* ADD SPOT(S) CANCELLED COMMENTS                                                
***********************************************************************         
DOORDCMT NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    MYELEM,MYELEM                                                    
         XC    ELTBUILD,ELTBUILD                                                
*                                                                               
         L     R6,AIO2             CHAIN AND SAVE OFF CURRENT COMMENTS          
         MVI   ELCODE,X'84'                                                     
         BRAS  RE,GETEL                                                         
         BNE   DOOC20                                                           
         ZIC   RF,1(R6)                                                         
         SHI   RF,4                OVERHEAD + EXECUTED MOVE                     
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   MYELEM(0),3(R6)                                                  
         LA    R4,MYELEM                                                        
         LA    R4,1(R4,RF)                                                      
*                                                                               
         BRAS  RE,NEXTEL                                                        
         BNE   DOOC05                                                           
         ZIC   RF,1(R6)                                                         
         SHI   RF,4                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),0(R6)                                                    
         LA    R4,1(R4,RF)                                                      
*                                                                               
DOOC05   DS    0H                                                               
         MVI   0(R4),C','                                                       
         AHI   R4,1                                                             
*                                                                               
* REPLACE EXISTING BUY ORDER COMMENT                                            
DOOC10   DS    0H                                                               
         GOTO1 HELLO,DMCB,(C'D',=C'REPFILE'),(X'84',AIO2),0,0                   
*                                                                               
DOOC20   DS    0H                                                               
         LA    R2,MYELEM                                                        
         LA    R1,120              MAX 2 ORD COMMENTS                           
*                                                                               
DOOC30   DS    0H                                                               
         CLI   0(R2),0                                                          
         BE    DOOC40                                                           
         AHI   R2,1                                                             
         BCT   R1,DOOC30                                                        
         B     DOOCX                                                            
*                                                                               
DOOC40   DS    0H                                                               
         L     R6,AIO2                                                          
         MVI   ELCODE,X'03'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
DOOC45   DS    0H                                                               
         USING RBUYDTEL,R6                                                      
         CLI   RBUYDTNW,0                                                       
         BE    DOOC95                                                           
*                                                                               
         MVC   0(10,R2),=C'#SPTS CHGD'                                          
         AHI   R2,10                                                            
*                                  BUILD AND ADD CHANGE BUY ORD CMTS            
DOOC60   DS    0H                                                               
         BAS   RE,BUILDBOC                                                      
         B     DOOC98                                                           
*                                  USE HELLO FOR FIRST LINE                     
DOOC95   DS    0H                                                               
         BRAS  RE,NEXTEL                                                        
         BE    DOOC45                                                           
         DROP  R6                                                               
*                                                                               
         OC    ELTBUILD,ELTBUILD                                                
         BNZ   DOOC98                                                           
*                                                                               
         BAS   RE,BUILDBOC                                                      
*                                                                               
DOOC98   DS    0H                                                               
         L     R6,AIO2                                                          
         MVI   ELCODE,X'84'                                                     
         BRAS  RE,GETEL                                                         
         BE    DOOC100                                                          
*                                                                               
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),AIO2,ELTBUILD,0                    
*                                                                               
         OC    MYELEM+60(60),SPACES                                             
         CLC   MYELEM+60(60),SPACES                                             
         BE    DOOCX                                                            
         L     R6,AIO2                                                          
         MVI   ELCODE,X'84'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         B     DOOC60              GO ADD SECOND ELEMENT                        
*                                                                               
DOOC100  DS    0H                  SECOND LINE MUST USE RECUP FOR               
         ZIC   R1,1(R6)            PROPER ORDERING                              
         AR    R6,R1                                                            
         GOTO1 VRECUP,DMCB,(2,AIO2),ELTBUILD,(R6),0                             
*                                                                               
DOOCX    DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* BUILD BUY ORDER COMMENT                                                       
* USES ELTBUILD AND MYELEM                                                      
***********************************************************************         
BUILDBOC NTR1                                                                   
*                                                                               
         XC    ELTBUILD,ELTBUILD                                                
         MVC   ELTBUILD+3(60),MYELEM                                            
         LA    R1,60                                                            
         LA    R2,ELTBUILD+63                                                   
BBOC05   CLI   0(R2),0                                                          
         BE    BBOC10                                                           
         CLI   0(R2),C' '                                                       
         BNE   BBOC20                                                           
BBOC10   BCTR  R2,0                                                             
         BCT   R1,BBOC05                                                        
         B     BBOCX                                                            
*                                                                               
BBOC20   DS    0H                                                               
         CLI   0(R2),C','          LINE SHOULDN'T END IN A COMMA                
         BNE   *+6                                                              
         BCTR  R1,0                                                             
         AHI   R1,4                OVERHEAD                                     
         STC   R1,ELTBUILD+1                                                    
         MVI   ELTBUILD,X'84'                                                   
         MVI   ELTBUILD+2,X'80'    FLAG AS REP ORDER COMMENT                    
*                                  USE HELLO FOR FIRST LINE                     
*                                                                               
BBOCX    DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                               
* COMPARE AGENCY AND REP BUY GRIDS TO DETERMINE SPOT ADDITION OR                
* REMOVAL                                                                       
*                                                                               
* USES RBUYGRID AND ABUYGRID FOR COMPARISON                                     
* ASSUMES IO2 HAS AN AGENCY (X'0B01') BUY                                       
* ASSUMES TSAR BUFFER HAS BUY SEGMENT RECORD                                    
***********************************************************************         
COMPGRID NTR1  BASE=*,WORK=(R2,500),LABEL=*                                     
*                                                                               
         ST    R2,MYSVAIO                                                       
         LA    R3,4000                                                          
         L     RE,AIO2                                                          
         LR    RF,R3                                                            
         MVCL  (R2),(RE)           SAVE OFF AIO2 AGENCY BUY RECORD              
*                                                                               
         NI    MISCFLG3,X'FF'-MF3SPTCH                                          
         MVC   CGSVTR#,TXNUM                                                    
*                                                                               
         LA    R6,ABUYGRID         AGENCY BUY GRID                              
         LA    R4,RBUYGRID         REP BUY GRID                                 
         LA    R2,0                                                             
         NI    MISCFLG2,X'FF'-MF2BUYUP                                          
*                                                                               
CGRID10  DS    0H                                                               
         CLC   0(1,R6),0(R4)                                                    
         BH    CGRID20                                                          
         BL    CGRID200                                                         
*                                                                               
CGRID15  DS    0H                  BUMP TO NEXT WEEK                            
         NI    MISCFLG3,X'FF'-MF3PRBUY                                          
*                                                                               
         AHI   R6,2                                                             
         AHI   R4,2                                                             
         AHI   R2,1                                                             
         CHI   R2,53                                                            
         BL    CGRID10                                                          
*                                                                               
         TM    MISCFLG2,MF2BUYUP                                                
         BZ    CGRID18                                                          
*                                                                               
         TM    MISCFLG3,MF3EFFDT                                                
         BZ    CGRID16                                                          
         GOTOR UPDTMOD,DMCB,(C'E',AIO2)                                         
*                                                                               
CGRID16  DS    0H                                                               
         GOTO1 PUTREC                                                           
*                                                                               
CGRID18  DS    0H                                                               
*        TM    MISCFLG2,MF2FORCE   FORCE MATCHING                               
*        BZ    CGRIDX              NEED TO LOOP THRU REP BUYS AND               
*                                  CHG DAY/TIME/LEN/RATE                        
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,CGSVTR#                                                    
         GOTO1 GOTSAR,TSAGET       RESTORE                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
*        TM    MISCFLG3,MF3SPTCH   SPOT CHANGED DETECTED, COMMENT WERE          
*        BO    CGRIDX              ALREADY BUILT                                
         GOTOR FORCEBUY,DMCB,MYSVAIO                                            
         B     CGRIDX                                                           
*                                                                               
* AGENCY BUY HAS MORE SPOT(S). ADD SPOT(S) TO REP BUY                           
*                                                                               
CGRID20  DS    0H                                                               
         CLI   0(R4),0                                                          
         BNE   CGRID25                                                          
         TM    1(R4),X'01'                                                      
         BO    CGRID25                                                          
         OI    MISCFLG3,MF3EFFDT                                                
*                                                                               
CGRID25  DS    0H                                                               
         CLC   SVREPNPW,0(R6)                                                   
         BE    *+8                                                              
         OI    MISCFLG3,MF3SPTCH   SPOT CHANGE DETECTED                         
*                                                                               
         LA    R3,TR.TLBYRLNK                                                   
         TM    TR.TLBYRFLG,X'40'   BUY OR LIST OF BUYS?                         
         BZ    CGRID30                                                          
*                                                                               
* INDEX TO BUY LIST. RETRIEVE FIRST REP BUY TO ADD SPOTS                        
*                                                                               
         XC    TSARKEY,TSARKEY                                                  
TKEY     USING TLKEY,TSARKEY                                                    
         MVI   TKEY.TLKTYP,C'R'                                                 
         MVC   TKEY.TLBLINDX,TR.TLBYRLNK                                        
         DROP  TKEY                                                             
*                                                                               
         MVC   TR.TLKEY,TSARKEY                                                 
         GOTO1 GOTSAR,TSARDH       RETRIEVE BUY LNK FOR CURRENT SEGMENT         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,TR.TLBLBUY#                                                   
*                                                                               
* CHECK IF WE NEED TO WRITE UPDATED BUY RECORD TO FILE                          
*                                                                               
CGRID30  DS    0H                                                               
         TM    MISCFLG2,MF2BUYUP                                                
         BZ    CGRID35                                                          
REPBUY   USING RBUYKEY,KEY                                                      
         CLC   REPBUY.RBUYKLIN,0(R3)                                            
         BE    CGRID55                                                          
         GOTO1 PUTREC                                                           
         NI    MISCFLG2,X'FF'-MF2BUYUP                                          
         DROP  REPBUY                                                           
*                                                                               
CGRID35  DS    0H                                                               
         XC    KEY,KEY                                                          
REPBUY   USING RBUYKEY,KEY                                                      
         MVI   REPBUY.RBUYKTYP,X'0B'                                            
         MVC   REPBUY.RBUYKREP,TWAAGY                                           
         MVC   REPBUY.RBUYKCON,COMPCON                                          
         MVC   REPBUY.RBUYKPLN,=X'FFFFFF'                                       
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
CGRID40  DS    0H                                                               
         CLC   KEY(RBUYKMLN-RBUYKEY),KEYSAVE                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   REPBUY.RBUYKLIN,0(R3)                                            
         BE    CGRID50                                                          
*                                                                               
         GOTO1 SEQ                                                              
         B     CGRID40                                                          
         DROP  REPBUY                                                           
*                                                                               
CGRID50  DS    0H                                                               
         MVC   AIO,AIO2                                                         
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC                                                           
*                                                                               
         L     R1,AIO              UPDATE REP BUY LINK TO AGENCY                
REPBUY   USING RBUYREC,R1                                                       
         MVC   REPBUY.RBUYAGBL,ABUYLINK                                         
         MVC   SVREPNPW,REPBUY.RBUYNW                                           
         DROP  REPBUY                                                           
*                                                                               
         NI    MISCFLG3,X'FF'-MF3BYCMT                                          
*                                                                               
         L     RF,MYSVAIO                                                       
         GOTOR BLDBOCMT,DMCB,(RF),AIO2                                          
*                                                                               
CGRID55  DS    0H                                                               
         XC    REPGRID,REPGRID                                                  
         GOTOR BLDBGRID,DMCB,AIO,(X'41',REPGRID)                                
         MVC   SVGRID,REPGRID                                                   
*                                                                               
         MVI   BUCKFLAG,X'FF'      SET TO BACK OUT FIGURES                      
         OI    BUCKFLGS,X'10'      DON'T IGNORE CANCELLED BUYS                  
*                                  BACK OUT BUCKETS                             
         GOTOR BUCKUPDT                                                         
                                                                                
         NI    BUCKFLGS,X'FF'-X'10' RESET                                       
*                                                                               
         GOTO1 DELELT,DMCB,AIO     REMOVE X'03' ELEMENTS                        
*                                                                               
* BUMP TO WEEK WITH MORE AGENCY SPOTS AND ADD TO THAT WEEK IN REP BUY           
*                                                                               
CGRID60  DS    0H                                                               
         LA    R1,REPGRID                                                       
         AR    R1,R2                                                            
         AR    R1,R2                                                            
*                                                                               
         ZIC   RE,0(R6)                                                         
         ZIC   RF,0(R4)                                                         
*                                                                               
         LTR   RF,RF                                                            
         BNZ   *+8                                                              
         OI    MISCFLG3,MF3EFFDT                                                
*                                                                               
         SR    RE,RF               ADDITIONAL SPOTS                             
*                                                                               
         ZIC   RF,0(R1)            ADD TO FIRST REP BUY                         
         AR    RE,RF                                                            
         STC   RE,0(R1)                                                         
*                                                                               
         OI    1(R1),X'01'         SET NPW OVERRIDE                             
*                                                                               
         TM    MISCFLG2,MF2FORCE                                                
         BZ    CGRID70                                                          
         GOTOR CHDTLRP,DMCB,MYSVAIO CHG TO AGENCY'S DAY/TIME/LEN/RATE           
*                                                                               
CGRID70  DS    0H                                                               
         GOTOR REBLDBUY,DMCB,REPGRID                                            
*                                                                               
         MVI   BUCKFLAG,X'00'      SET TO ADD NEW FIGURES                       
*                                  ADD NEW BUCKETS                              
         GOTOR BUCKUPDT                                                         
*                                                                               
         OI    MISCFLG2,MF2BUYUP                                                
*        GOTO1 PUTREC                                                           
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,CGSVTR#                                                    
         GOTO1 GOTSAR,TSAGET       RESTORE                                      
         BE    *+6                                                              
         DC    H'0'                                                             
         B     CGRID15                                                          
*                                                                               
* AGENCY BUY HAS LESS SPOT(S). REMOVE SPOT(S) FROM REP BUY                      
*                                                                               
CGRID200 DS    0H                                                               
*        ZIC   RE,0(R4)            # REP SPOTS FOR THIS WEEK                    
*        ZIC   RF,0(R6)            # AGY SPOTS FOR THIS WEEK                    
*        SR    RE,RF                                                            
*        STC   RE,REPSPDIF         # SPTS NEEDED TO BE REMOVED FROM REP         
*                                                                               
         CLI   0(R6),0             IF SPOTS ARE ZEROED OUT                      
         BNE   CGRID210            #SPOTS DIDN'T REALLY CHANGE                  
         TM    1(R6),X'01'         ZERO OVERRIDE?                               
         BO    CGRID220            IF SO, DATE WILL REMAIN                      
         OI    MISCFLG3,MF3EFFDT   DATE CHANGE DETECTED                         
         B     CGRID220                                                         
*                                                                               
CGRID210 DS    0H                                                               
         CLC   SVREPNPW,0(R6)                                                   
         BE    *+8                                                              
         OI    MISCFLG3,MF3SPTCH   SPOT CHANGE DETECTED                         
*                                                                               
CGRID220 DS    0H                                                               
         LA    R3,TR.TLBYRLNK                                                   
         TM    TR.TLBYRFLG,X'40'   BUY OR LIST OF BUYS?                         
         BZ    CGRID230                                                         
*                                                                               
* INDEX TO BUY LIST. RETRIEVE FIRST REP BUY TO REMOVE SPOTS                     
*                                                                               
         XC    TSARKEY,TSARKEY                                                  
TKEY     USING TLKEY,TSARKEY                                                    
         MVI   TKEY.TLKTYP,C'R'                                                 
         MVC   TKEY.TLBLINDX,TR.TLBYRLNK                                        
         DROP  TKEY                                                             
*                                                                               
         MVC   TR.TLKEY,TSARKEY                                                 
         GOTO1 GOTSAR,TSARDH       RETRIEVE BUY LNK FOR CURRENT SEGMENT         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,TR.TLBLBUY#                                                   
*                                                                               
*                                                                               
* CHECK IF WE NEED TO WRITE UPDATED BUY RECORD TO FILE                          
*                                                                               
CGRID230 DS    0H                                                               
         TM    MISCFLG2,MF2BUYUP                                                
         BZ    CGRID235                                                         
REPBUY   USING RBUYKEY,KEY                                                      
         CLC   REPBUY.RBUYKLIN,0(R3)                                            
         BE    CGRID255                                                         
         GOTO1 PUTREC                                                           
         NI    MISCFLG2,X'FF'-MF2BUYUP                                          
         DROP  REPBUY                                                           
*                                                                               
CGRID235 DS    0H                                                               
         XC    KEY,KEY                                                          
REPBUY   USING RBUYKEY,KEY                                                      
         MVI   REPBUY.RBUYKTYP,X'0B'                                            
         MVC   REPBUY.RBUYKREP,TWAAGY                                           
         MVC   REPBUY.RBUYKCON,COMPCON                                          
         MVC   REPBUY.RBUYKPLN,=X'FFFFFF'                                       
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
CGRID240 DS    0H                                                               
         CLC   KEY(RBUYKMLN-RBUYKEY),KEYSAVE                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   REPBUY.RBUYKLIN,0(R3)                                            
         BE    CGRID250                                                         
*                                                                               
         GOTO1 SEQ                                                              
         B     CGRID240                                                         
*                                                                               
CGRID250 DS    0H                                                               
         MVC   AIO,AIO2                                                         
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC                                                           
*                                                                               
         L     R1,AIO              UPDATE REP BUY LINK TO AGENCY                
REPBUY   USING RBUYREC,R1                                                       
         MVC   REPBUY.RBUYAGBL,ABUYLINK                                         
         MVC   SVREPNPW,REPBUY.RBUYNW                                           
         DROP  REPBUY                                                           
*                                                                               
         NI    MISCFLG3,X'FF'-MF3BYCMT                                          
*                                                                               
         PRINT GEN                                                              
         L     RF,MYSVAIO                                                       
         GOTOR BLDBOCMT,DMCB,(RF),AIO2                                          
         PRINT NOGEN                                                            
*                                                                               
CGRID255 DS    0H                                                               
         XC    REPGRID,REPGRID                                                  
         GOTOR BLDBGRID,DMCB,AIO,(X'41',REPGRID)                                
         MVC   SVGRID,REPGRID                                                   
*                                                                               
* BUMP TO WEEK WITH MORE REP SPOTS AND SEE IF WE CAN REMOVE THE SPOTS           
* FROM THE REP BUY. IF NOT, WE WILL NEED TO KEEP READING REP BUYS               
* UNTIL WE FIND A REP BUY WITH SPOT(S) WE CAN REMOVE                            
*                                                                               
         LA    R8,REPGRID                                                       
         AR    R8,R2                                                            
         AR    R8,R2                                                            
         CLI   0(R8),0                                                          
         BE    CGRID270                                                         
*                                                                               
         MVI   BUCKFLAG,X'FF'      SET TO BACK OUT FIGURES                      
         OI    BUCKFLGS,X'10'      DON'T IGNORE CANCELLED BUYS                  
*                                  BACK OUT BUCKETS                             
         GOTOR BUCKUPDT                                                         
*                                                                               
         GOTO1 DELELT,DMCB,AIO     REMOVE X'03' ELEMENTS                        
*                                                                               
         NI    BUCKFLGS,X'FF'-X'10' RESET                                       
*                                                                               
         ZIC   RE,0(R4)            TOTAL REP GRID                               
         ZIC   RF,0(R6)                                                         
         SR    RE,RF               # OF SPOTS NEEDED TO REMOVE FROM REP         
*                                                                               
         ZIC   RF,0(R8)            SINGLE REP BUY GRID                          
         CR    RF,RE                                                            
         BL    CGRID265                                                         
*                                                                               
         SR    RF,RE                                                            
         STC   RF,0(R8)                                                         
*                                                                               
         ZIC   RF,0(R4)                                                         
         SR    RF,RE                                                            
         STC   RF,0(R4)            REDUCE TOTAL REP SPOTS                       
*                                                                               
*        OI    MISCFLG3,MF3PRBUY                                                
*                                                                               
         B     CGRID266                                                         
*                                                                               
CGRID265 DS    0H                                                               
         ZIC   RE,0(R4)            TOTAL REP SPOTS                              
         ZIC   RF,0(R8)            SINGLE REP SPOTS                             
         MVI   0(R8),0                                                          
         SR    RE,RF                                                            
         STC   RE,0(R4)                                                         
*                                                                               
CGRID266 DS    0H                                                               
*        CLI   0(R6),0                                                          
*        BNE   CGRID267                                                         
*        TM    1(R6),X'02'         NOT PART OF AGENCY BUY WEEK?                 
*        BNZ   CGRID268                                                         
*                                                                               
CGRID267 DS    0H                                                               
         OI    1(R8),X'01'         SET NPW OVERRIDE                             
*                                                                               
CGRID268 DS    0H                                                               
         TM    MISCFLG2,MF2FORCE                                                
         BZ    CGRID269                                                         
         GOTOR CHDTLRP,DMCB,MYSVAIO CHG TO AGENCY'S DAY/TIME/LEN/RATE           
*                                                                               
CGRID269 DS    0H                                                               
         GOTOR REBLDBUY,DMCB,REPGRID                                            
*                                                                               
         MVI   BUCKFLAG,X'00'      SET TO ADD NEW FIGURES                       
*                                  ADD NEW BUCKETS                              
         GOTOR BUCKUPDT                                                         
*                                                                               
         OI    MISCFLG2,MF2BUYUP                                                
*                                                                               
*        TM    MISCFLG3,MF3PRBUY   ZERO OUT REMAINING BUYS FOR THIS WK?         
*        BO    CGRID270                                                         
*                                                                               
         CLI   TR.TLKTYP,X'0B'     BUY SEGMENT OR LIST OF BUYS?                 
         BE    CGRID10                                                          
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,CGSVTR#                                                    
         GOTO1 GOTSAR,TSAGET       RESTORE                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         B     CGRID10                                                          
*                                                                               
CGRID270 DS    0H                                                               
         CLI   TR.TLKTYP,X'0B'     BUY SEGMENT OR LIST OF BUYS?                 
         BE    CGRID15                                                          
*                                                                               
         CLI   TR.TLKTYP,C'R'      BUY SEGMENT OR LIST OF BUYS?                 
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         AHI   R3,TLBLLENQ                                                      
         CLI   0(R3),0                                                          
         BE    CGRID15                                                          
*                                                                               
         LH    RF,TR.TLLEN                                                      
         LA    RE,TSARREC(RF)                                                   
         CR    R3,RE               BOUNDARY CHECK                               
         BL    CGRID230                                                         
*                                                                               
CGRIDX   DS    0H                                                               
         CLI   TR.TLKTYP,X'0B'     BUY SEGMENT OR LIST OF BUYS?                 
         BE    CGRIDXX                                                          
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,CGSVTR#                                                    
         GOTO1 GOTSAR,TSAGET       RESTORE                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
CGRIDXX  DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*&&DO                                                                           
***********************************************************************         
* ROUTINE FOR DEBUGGING                                                         
***********************************************************************         
CHKCON   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     RF,AIO2                                                          
         USING RBUYREC,RF                                                       
         CLI   RBUYKLIN,15                                                      
         BNE   CHKCONX                                                          
         DC    H'0'                                                             
         B     CHKCONX                                                          
*                                                                               
         L     R6,AIO3                                                          
         SR    R2,R2                                                            
         SR    R3,R3                                                            
         MVI   ELCODE,X'03'                                                     
         BAS   RE,GETEL                                                         
         USING RCONBKEL,R6                                                      
CHKCON10 CLC   =X'6801',RCONBKYR                                                
         BNE   CHKCON20                                                         
         ZICM  RE,6(R6),4                                                       
         AR    R2,RE                                                            
CHKCON20 DS    0H                                                               
         CLC   =X'6802',RCONBKYR                                                
         BNE   CHKCON30                                                         
         ZICM  RE,6(R6),4                                                       
         AR    R3,RE                                                            
CHKCON30 BAS   RE,NEXTEL                                                        
         BE    CHKCON10                                                         
         C     R3,=F'129000'                                                    
         BNE   *+6                                                              
         DC    H'0'                                                             
         DROP  R6                                                               
*                                                                               
         L     RF,AIO                                                           
         USING RBUYREC,RF                                                       
         CLI   RBUYKLIN,4                                                       
         BNE   *+6                                                              
         DC    H'0'                                                             
CHKCONX  XIT1                                                                   
         DROP  RF                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*&&                                                                             
***********************************************************************         
* SPECIAL COMPARE GRID ROUTINE FOR DAILIES, COST OVERRIDES & EARLY END          
*                                                                               
* COMPARE AGENCY AND REP BUY GRIDS TO DETERMINE SPOT ADDITION OR                
* REMOVAL                                                                       
*                                                                               
* P1 BYTE 1 HAS TXNUM OF ORIGINAL X'0B' TSAR RECORD                             
* USES RBUYGRID AND ABUYGRID FOR COMPARISON                                     
* ASSUMES IO2 HAS AN AGENCY (X'0B01') BUY                                       
* ASSUMES TSAR BUFFER HAS BUY SEGMENT RECORD                                    
* ASSUMES R3 POINTING TO BUY# OR LIST WITH BUY#                                 
***********************************************************************         
SCMPGRID NTR1  BASE=*,WORK=(R2,500),LABEL=*                                     
*                                                                               
         ST    R2,MYSVAIO                                                       
         LR    R0,R2                                                            
         LA    R1,4000                                                          
         L     RE,AIO2                                                          
         LR    RF,R1                                                            
         MVCL  (R0),(RE)           SAVE OFF AIO2 AGENCY BUY RECORD              
*                                                                               
         NI    MISCFLG3,X'FF'-MF3SPTCH                                          
         MVC   CGSVTR#,TXNUM                                                    
*                                                                               
         LA    R6,ABUYGRID         AGENCY BUY GRID                              
         LA    R4,RBUYGRID         REP BUY GRID                                 
         LA    R2,0                                                             
         NI    MISCFLG2,X'FF'-MF2BUYUP                                          
*                                                                               
SCGRD10  DS    0H                                                               
         CLC   0(1,R6),0(R4)                                                    
         BH    SCGRD20                                                          
         BL    SCGRD200                                                         
*                                                                               
SCGRD15  DS    0H                  BUMP TO NEXT WEEK                            
         NI    MISCFLG3,X'FF'-MF3PRBUY                                          
*                                                                               
         AHI   R6,2                                                             
         AHI   R4,2                                                             
         AHI   R2,1                                                             
         CHI   R2,53                                                            
         BL    SCGRD10                                                          
*                                                                               
SCGRD16  DS    0H                                                               
         TM    MISCFLG2,MF2BUYUP                                                
         BZ    SCGRD18                                                          
*                                                                               
         TM    MISCFLG3,MF3EFFDT                                                
         BZ    SCGRD17                                                          
*                                                                               
         GOTOR UPDTMOD,DMCB,(C'E',AIO2)                                         
*                                                                               
SCGRD17  DS    0H                                                               
         GOTO1 PUTREC                                                           
*                                                                               
SCGRD18  DS    0H                                                               
*                                  CHG DAY/TIME/LEN/RATE                        
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,DMSVTR#                                                    
         GOTO1 GOTSAR,TSAGET       RESTORE BACK TO ORIGINAL BUY SEG             
         BE    *+6                 BEFORE GOING TO FORCEBUY                     
         DC    H'0'                                                             
*                                                                               
*        CLI   0(R3),0             ANY REP BUYS TO UPDATE?                      
*        BE    SCGRD19             NO, SKIP                                     
         GOTOR SFORZBUY,DMCB,MYSVAIO                                            
*                                                                               
SCGRD19  DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,CGSVTR#                                                    
         GOTO1 GOTSAR,TSAGET       RESTORE BACK TO ORIGINAL BUY SEG             
         BE    *+6                 BEFORE GOING TO FORCEBUY                     
         DC    H'0'                                                             
         B     SCGRDXX                                                          
*                                                                               
* AGENCY BUY HAS MORE SPOT(S). ADD SPOT(S) TO REP BUY                           
*                                                                               
SCGRD20  DS    0H                                                               
         CLI   0(R4),0                                                          
         BNE   SCGRD25                                                          
         TM    1(R4),X'01'                                                      
         BO    SCGRD25                                                          
         OI    MISCFLG3,MF3EFFDT                                                
*                                                                               
SCGRD25  DS    0H                                                               
         CLC   SVREPNPW,0(R6)                                                   
         BE    *+8                                                              
         OI    MISCFLG3,MF3SPTCH   SPOT CHANGE DETECTED                         
*                                                                               
* CHECK IF WE NEED TO WRITE UPDATED BUY RECORD TO FILE                          
*                                                                               
SCGRD33  DS    0H                                                               
         TM    MISCFLG2,MF2BUYUP                                                
         BZ    SCGRD35                                                          
REPBUY   USING RBUYKEY,KEY                                                      
         CLC   REPBUY.RBUYKLIN,0(R3)                                            
         BE    SCGRD55                                                          
         GOTO1 PUTREC                                                           
         NI    MISCFLG2,X'FF'-MF2BUYUP                                          
         DROP  REPBUY                                                           
*                                                                               
SCGRD35  DS    0H                                                               
         XC    KEY,KEY                                                          
REPBUY   USING RBUYKEY,KEY                                                      
         MVI   REPBUY.RBUYKTYP,X'0B'                                            
         MVC   REPBUY.RBUYKREP,TWAAGY                                           
         MVC   REPBUY.RBUYKCON,COMPCON                                          
         MVC   REPBUY.RBUYKPLN,=X'FFFFFF'                                       
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
SCGRD40  DS    0H                                                               
         CLC   KEY(RBUYKMLN-RBUYKEY),KEYSAVE                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   REPBUY.RBUYKLIN,0(R3)                                            
         BE    SCGRD50                                                          
*                                                                               
         GOTO1 SEQ                                                              
         B     SCGRD40                                                          
         DROP  REPBUY                                                           
*                                                                               
SCGRD50  DS    0H                                                               
         MVC   AIO,AIO2                                                         
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC                                                           
*                                                                               
         L     R1,AIO              UPDATE REP BUY LINK TO AGENCY                
REPBUY   USING RBUYREC,R1                                                       
         MVC   REPBUY.RBUYAGBL,ABUYLINK                                         
         MVC   SVREPNPW,REPBUY.RBUYNW                                           
         DROP  REPBUY                                                           
*                                                                               
         NI    MISCFLG3,X'FF'-MF3BYCMT                                          
*                                                                               
         L     RF,MYSVAIO                                                       
         GOTOR BLDBOCMT,DMCB,(RF),AIO2                                          
*                                                                               
SCGRD55  DS    0H                                                               
         XC    REPGRID,REPGRID                                                  
         GOTOR BLDBGRID,DMCB,AIO,(X'41',REPGRID)                                
         MVC   SVGRID,REPGRID                                                   
*                                                                               
         MVI   BUCKFLAG,X'FF'      SET TO BACK OUT FIGURES                      
         OI    BUCKFLGS,X'10'      DON'T IGNORE CANCELLED BUYS                  
*                                  BACK OUT BUCKETS                             
         GOTOR BUCKUPDT                                                         
                                                                                
         NI    BUCKFLGS,X'FF'-X'10' RESET                                       
*                                                                               
         GOTO1 DELELT,DMCB,AIO     REMOVE X'03' ELEMENTS                        
*                                                                               
* BUMP TO WEEK WITH MORE AGENCY SPOTS AND ADD TO THAT WEEK IN REP BUY           
*                                                                               
SCGRD60  DS    0H                                                               
         LA    R1,REPGRID                                                       
         AR    R1,R2                                                            
         AR    R1,R2                                                            
*                                                                               
         ZIC   RE,0(R6)                                                         
         ZIC   RF,0(R4)                                                         
*                                                                               
         LTR   RF,RF                                                            
         BNZ   *+8                                                              
         OI    MISCFLG3,MF3EFFDT                                                
*                                                                               
         SR    RE,RF               ADDITIONAL SPOTS                             
*                                                                               
         ZIC   RF,0(R1)            ADD TO FIRST REP BUY                         
         AR    RE,RF                                                            
         STC   RE,0(R1)                                                         
*                                                                               
         OI    1(R1),X'01'         SET NPW OVERRIDE                             
*                                                                               
         TM    MISCFLG2,MF2FORCE                                                
         BZ    SCGRD70                                                          
         GOTOR CHDTLRP,DMCB,MYSVAIO CHG TO AGENCY'S DAY/TIME/LEN/RATE           
*                                                                               
SCGRD70  DS    0H                                                               
         GOTOR REBLDBUY,DMCB,REPGRID                                            
*                                                                               
         MVI   BUCKFLAG,X'00'      SET TO ADD NEW FIGURES                       
*                                  ADD NEW BUCKETS                              
         GOTOR BUCKUPDT                                                         
*                                                                               
         OI    MISCFLG2,MF2BUYUP                                                
*        GOTO1 PUTREC                                                           
*                                                                               
         B     SCGRD15                                                          
*                                                                               
* AGENCY BUY HAS LESS SPOT(S). REMOVE SPOT(S) FROM REP BUY                      
*                                                                               
SCGRD200 DS    0H                                                               
*        ZIC   RE,0(R4)            # REP SPOTS FOR THIS WEEK                    
*        ZIC   RF,0(R6)            # AGY SPOTS FOR THIS WEEK                    
*        SR    RE,RF                                                            
*        STC   RE,REPSPDIF         # SPTS NEEDED TO BE REMOVED FROM REP         
*                                                                               
         CLI   0(R6),0             IF SPOTS ARE ZEROED OUT                      
         BNE   SCGRD210            #SPOTS DIDN'T REALLY CHANGE                  
         TM    1(R6),X'01'         ZERO OVERRIDE?                               
         BO    SCGRD220            IF SO, DATE WILL REMAIN                      
         OI    MISCFLG3,MF3EFFDT   DATE CHANGE DETECTED                         
         B     SCGRD220                                                         
*                                                                               
SCGRD210 DS    0H                                                               
         CLC   SVREPNPW,0(R6)                                                   
         BE    *+8                                                              
         OI    MISCFLG3,MF3SPTCH   SPOT CHANGE DETECTED                         
*                                                                               
* CHECK IF WE NEED TO WRITE UPDATED BUY RECORD TO FILE                          
*                                                                               
SCGRD220 DS    0H                                                               
         TM    MISCFLG2,MF2BUYUP                                                
         BZ    SCGRD235                                                         
REPBUY   USING RBUYKEY,KEY                                                      
         CLC   REPBUY.RBUYKLIN,0(R3)                                            
         BE    SCGRD255                                                         
         GOTO1 PUTREC                                                           
         NI    MISCFLG2,X'FF'-MF2BUYUP                                          
         DROP  REPBUY                                                           
*                                                                               
SCGRD235 DS    0H                                                               
         XC    KEY,KEY                                                          
REPBUY   USING RBUYKEY,KEY                                                      
         MVI   REPBUY.RBUYKTYP,X'0B'                                            
         MVC   REPBUY.RBUYKREP,TWAAGY                                           
         MVC   REPBUY.RBUYKCON,COMPCON                                          
         MVC   REPBUY.RBUYKPLN,=X'FFFFFF'                                       
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
SCGRD240 DS    0H                                                               
         CLC   KEY(RBUYKMLN-RBUYKEY),KEYSAVE                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   REPBUY.RBUYKLIN,0(R3)                                            
         BE    SCGRD250                                                         
*                                                                               
         GOTO1 SEQ                                                              
         B     SCGRD240                                                         
*                                                                               
SCGRD250 DS    0H                                                               
         MVC   AIO,AIO2                                                         
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC                                                           
*                                                                               
         L     R1,AIO              UPDATE REP BUY LINK TO AGENCY                
REPBUY   USING RBUYREC,R1                                                       
         MVC   REPBUY.RBUYAGBL,ABUYLINK                                         
         MVC   SVREPNPW,REPBUY.RBUYNW                                           
         DROP  REPBUY                                                           
*                                                                               
         NI    MISCFLG3,X'FF'-MF3BYCMT                                          
*                                                                               
         PRINT GEN                                                              
         L     RF,MYSVAIO                                                       
         GOTOR BLDBOCMT,DMCB,(RF),AIO2                                          
         PRINT NOGEN                                                            
*                                                                               
SCGRD255 DS    0H                                                               
         XC    REPGRID,REPGRID                                                  
         GOTOR BLDBGRID,DMCB,AIO,(X'41',REPGRID)                                
         MVC   SVGRID,REPGRID                                                   
*                                                                               
* BUMP TO WEEK WITH MORE REP SPOTS AND SEE IF WE CAN REMOVE THE SPOTS           
* FROM THE REP BUY. IF NOT, WE WILL NEED TO KEEP READING REP BUYS               
* UNTIL WE FIND A REP BUY WITH SPOT(S) WE CAN REMOVE                            
*                                                                               
         LA    R8,REPGRID                                                       
         AR    R8,R2                                                            
         AR    R8,R2                                                            
         CLI   0(R8),0                                                          
         BE    SCGRD16                                                          
*                                                                               
         MVI   BUCKFLAG,X'FF'      SET TO BACK OUT FIGURES                      
         OI    BUCKFLGS,X'10'      DON'T IGNORE CANCELLED BUYS                  
*                                  BACK OUT BUCKETS                             
         GOTOR BUCKUPDT                                                         
*                                                                               
         GOTO1 DELELT,DMCB,AIO     REMOVE X'03' ELEMENTS                        
*                                                                               
         NI    BUCKFLGS,X'FF'-X'10' RESET                                       
*                                                                               
         ZIC   RE,0(R4)            TOTAL REP GRID                               
         ZIC   RF,0(R6)                                                         
         SR    RE,RF               # OF SPOTS NEEDED TO REMOVE FROM REP         
*                                                                               
         ZIC   RF,0(R8)            SINGLE REP BUY GRID                          
         CR    RF,RE                                                            
         BL    SCGRD265                                                         
*                                                                               
         SR    RF,RE                                                            
         STC   RF,0(R8)                                                         
*                                                                               
         ZIC   RF,0(R4)                                                         
         SR    RF,RE                                                            
         STC   RF,0(R4)            REDUCE TOTAL REP SPOTS                       
*                                                                               
*        OI    MISCFLG3,MF3PRBUY                                                
*                                                                               
         B     SCGRD267                                                         
*                                                                               
SCGRD265 DS    0H                                                               
         ZIC   RE,0(R4)            TOTAL REP SPOTS                              
         ZIC   RF,0(R8)            SINGLE REP SPOTS                             
         MVI   0(R8),0                                                          
         SR    RE,RF                                                            
         STC   RE,0(R4)                                                         
*                                                                               
SCGRD267 DS    0H                                                               
         OI    1(R8),X'01'         SET NPW OVERRIDE                             
*                                                                               
         TM    MISCFLG2,MF2FORCE                                                
         BZ    SCGRD268                                                         
         GOTOR CHDTLRP,DMCB,MYSVAIO CHG TO AGENCY'S DAY/TIME/LEN/RATE           
*                                                                               
SCGRD268 DS    0H                                                               
         GOTOR REBLDBUY,DMCB,REPGRID                                            
*                                                                               
         MVI   BUCKFLAG,X'00'      SET TO ADD NEW FIGURES                       
*                                  ADD NEW BUCKETS                              
         GOTOR BUCKUPDT                                                         
*                                                                               
         OI    MISCFLG2,MF2BUYUP                                                
*                                                                               
         B     SCGRD10                                                          
*                                                                               
SCGRDX   DS    0H                                                               
         CLI   TR.TLKTYP,X'0B'     BUY SEGMENT OR LIST OF BUYS?                 
         BE    SCGRDXX                                                          
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,CGSVTR#                                                    
         GOTO1 GOTSAR,TSAGET       RESTORE                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
SCGRDXX  DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* FORCED MATCHING. THERE MIGHT BE NO SPOT CHANGES BUT ONLY                      
* DAY/TIME/RATE/LEN CHANGES.                                                    
*                                                                               
* LOOP THRU REP BUYS AND UPDATE TO AGENCY'S DAY/TIME/RATE/LEN                   
***********************************************************************         
FORCEBUY NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R3,0(R1)            ADDRESS OF AGENCY BUY                        
         L     R6,0(R3)                                                         
AGYBUY   USING RBUYREC,R6                                                       
         LR    R2,R6               SAVE OFF IO                                  
*                                                                               
         LA    R3,TR.TLBYRLNK                                                   
         TM    TR.TLBYRFLG,X'40'   BUY OR LIST OF BUYS?                         
         BZ    FORCEB10                                                         
*                                                                               
* INDEX TO BUY LIST. RETRIEVE FIRST REP BUY                                     
*                                                                               
         MVC   DLSVTR#,TXNUM                                                    
*                                                                               
         XC    TSARKEY,TSARKEY                                                  
TKEY     USING TLKEY,TSARKEY                                                    
         MVI   TKEY.TLKTYP,C'R'                                                 
         MVC   TKEY.TLBLINDX,TR.TLBYRLNK                                        
         DROP  TKEY                                                             
*                                                                               
         MVC   TR.TLKEY,TSARKEY                                                 
         GOTO1 GOTSAR,TSARDH       RETRIEVE BUY LNK FOR CURRENT SEGMENT         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,TR.TLBLBUY#                                                   
*                                                                               
FORCEB10 DS    0H                                                               
         LR    R6,R2               RESTORE IO TO R6                             
         XC    KEY,KEY                                                          
REPBUY   USING RBUYKEY,KEY                                                      
         MVI   REPBUY.RBUYKTYP,X'0B'                                            
         MVC   REPBUY.RBUYKREP,TWAAGY                                           
         MVC   REPBUY.RBUYKCON,COMPCON                                          
         MVC   REPBUY.RBUYKPLN,=X'FFFFFF'                                       
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
FORCEB20 DS    0H                                                               
         CLC   KEY(RBUYKMLN-RBUYKEY),KEYSAVE                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   REPBUY.RBUYKLIN,0(R3)                                            
         BE    FORCEB30                                                         
*                                                                               
         GOTO1 SEQ                                                              
         B     FORCEB20                                                         
         DROP  REPBUY                                                           
*                                                                               
FORCEB30 DS    0H                                                               
         MVC   AIO,AIO2                                                         
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC                                                           
*                                                                               
         L     R4,AIO                                                           
REPBUY   USING RBUYREC,R4                                                       
*                                  UPDATE REP BUY LINK TO AGENCY                
         MVC   REPBUY.RBUYAGBL,ABUYLINK                                         
         MVC   SVREPNPW,REPBUY.RBUYNW                                           
*                                                                               
*        TM    MISCFLG3,MF3SPTCH   SPOT CHANGED DETECTED, COMMENT WERE          
*        BO    FORCEB35            ALREADY BUILT                                
*                                                                               
         NI    MISCFLG3,X'FF'-MF3BYCMT                                          
*                                                                               
         CLI   TR.TLKTYP,X'0B'     BUY SEGMENT OR LIST OF BUYS?                 
         BE    FORCEB33                                                         
         GOTOR BLDBOCMT,DMCB,(R2),(X'80',AIO2)                                  
         B     FORCEB35                                                         
*                                                                               
FORCEB33 DS    0H                                                               
         GOTOR BLDBOCMT,DMCB,(R2),AIO2                                          
*                                                                               
FORCEB35 DS    0H                                                               
*        NI    MISCFLG3,X'FF'-MF3SPTCH                                          
*                                                                               
         CLC   AGYBUY.RBUYCOS,REPBUY.RBUYCOS                                    
         BNE   FORCEB60                                                         
         CLC   AGYBUY.RBUYDUR,REPBUY.RBUYDUR                                    
         BNE   FORCEB60                                                         
*                                                                               
         AHI   R6,34+43            START OF X'02' ELEMENT                       
         AHI   R4,34+43            START OF X'02' ELEMENT                       
*                                                                               
FORCEB40 DS    0H                                                               
         CLC   0(9,R6),0(R4)                                                    
         BNE   FORCEB60                                                         
         AHI   R6,9                                                             
         AHI   R4,9                                                             
         CLI   0(R6),X'02'                                                      
         BE    FORCEB50                                                         
         CLI   0(R4),X'02'                                                      
         BE    FORCEB60                                                         
         B     FORCEB70            NO CHANGES DETECTED                          
*                                                                               
FORCEB50 DS    0H                                                               
         CLI   0(R4),X'02'                                                      
         BE    FORCEB40                                                         
*                                                                               
FORCEB60 DS    0H                                                               
         XC    REPGRID,REPGRID                                                  
         GOTOR BLDBGRID,DMCB,AIO,(X'41',REPGRID)                                
         MVC   SVGRID,REPGRID                                                   
*                                                                               
         MVI   BUCKFLAG,X'FF'      SET TO BACK OUT FIGURES                      
         OI    BUCKFLGS,X'10'      DON'T IGNORE CANCELLED BUYS                  
*                                  BACK OUT BUCKETS                             
         GOTOR BUCKUPDT                                                         
*                                                                               
         GOTO1 DELELT,DMCB,AIO     REMOVE X'03' ELEMENTS                        
*                                                                               
         NI    BUCKFLGS,X'FF'-X'10' RESET                                       
*                                                                               
         GOTOR CHDTLRP,DMCB,MYSVAIO CHG TO AGENCY'S DAY/TIME/LEN/RATE           
*                                                                               
         GOTOR REBLDBUY,DMCB,REPGRID                                            
*                                                                               
         MVI   BUCKFLAG,X'00'      SET TO ADD NEW FIGURES                       
*                                  ADD NEW BUCKETS                              
         GOTOR BUCKUPDT                                                         
*                                                                               
         GOTO1 PUTREC                                                           
*                                                                               
FORCEB70 DS    0H                                                               
         CLI   TR.TLKTYP,X'0B'     BUY SEGMENT OR LIST OF BUYS?                 
         BE    FORCEBX                                                          
*                                                                               
         AHI   R3,TLBLLENQ                                                      
         CLI   0(R3),0                                                          
         BE    FORCEBX                                                          
*                                                                               
         LH    RF,TR.TLLEN                                                      
         LA    RE,TSARREC(RF)                                                   
         CR    R3,RE               BOUNDARY CHECK                               
         BL    FORCEB10                                                         
*                                                                               
FORCEBX  DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* SPECIAL FOR COST OVERRIDE, DAILYS AND EARLY END PROCESSING                    
* FORCED MATCHING. THERE MIGHT BE NO SPOT CHANGES BUT ONLY                      
* DAY/TIME/RATE/LEN CHANGES.                                                    
*                                                                               
* LOOP THRU REP BUYS AND UPDATE TO AGENCY'S DAY/TIME/RATE/LEN                   
* ASSUMES R3 POINTING TO BUY# OR LIST WITH BUY#                                 
***********************************************************************         
SFORZBUY NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     RE,0(R1)            ADDRESS OF AGENCY BUY                        
         L     R6,0(RE)                                                         
AGYBUY   USING RBUYREC,R6                                                       
         LR    R2,R6               SAVE OFF IO                                  
*                                                                               
         XC    KEY,KEY                                                          
REPBUY   USING RBUYKEY,KEY                                                      
         MVI   REPBUY.RBUYKTYP,X'0B'                                            
         MVC   REPBUY.RBUYKREP,TWAAGY                                           
         MVC   REPBUY.RBUYKCON,COMPCON                                          
         MVC   REPBUY.RBUYKPLN,=X'FFFFFF'                                       
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
SFORZB20 DS    0H                                                               
         CLC   KEY(RBUYKMLN-RBUYKEY),KEYSAVE                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLI   0(R3),0             WAS I CALLED FROM A LIST?                    
         BNE   SFORZB25                                                         
         TM    TR.TLBYRFLG,X'40'                                                
         BZ    *+6                 MUST BE A SINGLE BUY NUMBER                  
         DC    H'0'                                                             
         CLC   REPBUY.RBUYKLIN,TR.TLBYRLNK                                      
         BE    SFORZB30                                                         
         B     SFORZB28                                                         
*                                                                               
SFORZB25 DS    0H                                                               
         CLC   REPBUY.RBUYKLIN,0(R3)                                            
         BE    SFORZB30                                                         
*                                                                               
SFORZB28 DS    0H                                                               
         GOTO1 SEQ                                                              
         B     SFORZB20                                                         
         DROP  REPBUY                                                           
*                                                                               
SFORZB30 DS    0H                                                               
         MVC   AIO,AIO2                                                         
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC                                                           
*                                                                               
         L     R4,AIO                                                           
REPBUY   USING RBUYREC,R4                                                       
*                                  UPDATE REP BUY LINK TO AGENCY                
         MVC   REPBUY.RBUYAGBL,ABUYLINK                                         
         MVC   SVREPNPW,REPBUY.RBUYNW                                           
*                                                                               
*        TM    MISCFLG3,MF3SPTCH   SPOT CHANGED DETECTED, COMMENT WERE          
*        BO    SFORZB35            ALREADY BUILT                                
*                                                                               
         NI    MISCFLG3,X'FF'-MF3BYCMT                                          
*                                                                               
         GOTOR BLDBOCMT,DMCB,(R2),AIO2                                          
*                                                                               
SFORZB35 DS    0H                                                               
*        NI    MISCFLG3,X'FF'-MF3SPTCH                                          
*                                                                               
         CLC   AGYBUY.RBUYCOS,REPBUY.RBUYCOS                                    
         BNE   SFORZB60                                                         
         CLC   AGYBUY.RBUYDUR,REPBUY.RBUYDUR                                    
         BNE   SFORZB60                                                         
*                                                                               
         AHI   R6,34+43            START OF X'02' ELEMENT                       
         AHI   R4,34+43            START OF X'02' ELEMENT                       
*                                                                               
SFORZB40 DS    0H                                                               
         CLC   0(9,R6),0(R4)                                                    
         BNE   SFORZB60                                                         
         AHI   R6,9                                                             
         AHI   R4,9                                                             
         CLI   0(R6),X'02'                                                      
         BE    SFORZB50                                                         
         CLI   0(R4),X'02'                                                      
         BE    SFORZB60                                                         
         B     SFORZBX             NO CHANGES DETECTED                          
*                                                                               
SFORZB50 DS    0H                                                               
         CLI   0(R4),X'02'                                                      
         BE    SFORZB40                                                         
*                                                                               
SFORZB60 DS    0H                                                               
         XC    REPGRID,REPGRID                                                  
         GOTOR BLDBGRID,DMCB,AIO,(X'41',REPGRID)                                
         MVC   SVGRID,REPGRID                                                   
*                                                                               
         MVI   BUCKFLAG,X'FF'      SET TO BACK OUT FIGURES                      
         OI    BUCKFLGS,X'10'      DON'T IGNORE CANCELLED BUYS                  
*                                  BACK OUT BUCKETS                             
         GOTOR BUCKUPDT                                                         
*                                                                               
         GOTO1 DELELT,DMCB,AIO     REMOVE X'03' ELEMENTS                        
*                                                                               
         NI    BUCKFLGS,X'FF'-X'10' RESET                                       
*                                                                               
         GOTOR CHDTLRP,DMCB,MYSVAIO CHG TO AGENCY'S DAY/TIME/LEN/RATE           
*                                                                               
         GOTOR REBLDBUY,DMCB,REPGRID                                            
*                                                                               
         MVI   BUCKFLAG,X'00'      SET TO ADD NEW FIGURES                       
*                                  ADD NEW BUCKETS                              
         GOTOR BUCKUPDT                                                         
*                                                                               
         GOTO1 PUTREC                                                           
*                                                                               
SFORZBX DS     0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* BUILD BUY ORDER COMMENT WITH SPECIFIC CHANGES TO THE BUY                      
* P1 = AGENCY BUY                                                               
* P2 = BYTE 1 = X'80' SKIP DATE CHECK                                           
* P2 = BYTE 2-4 REP BUY                                                         
* USES R8, NO SPOOLD VARIABLES ARE USED IN THIS ROUTINE                         
***********************************************************************         
BLDBOCMT NTR1  BASE=*,WORK=(R8,BBCWORKQ),LABEL=*                                
         USING BBCWORKD,R8                                                      
*                                                                               
         L     R4,0(R1)            SET A(AGENCY BUY RECORD)                     
         ST    R4,BBCAIO                                                        
***TESTING                                                                      
         L     RF,BBCAIO                                                        
         CLI   0(RF),X'0B'                                                      
         BE    *+6                                                              
         DC    H'0'                                                             
***TESTING                                                                      
AGYBUY   USING RBUYREC,R4                                                       
         MVC   BBCFLAG,4(R1)       SAVE OFF FLAG                                
         L     R6,4(R1)            SET A(REP BUY RECORD)                        
         ST    R6,BBCRIO                                                        
REPBUY   USING RBUYREC,R6                                                       
*                                                                               
         CLC   REPBUY.RBUYVER,VERDFLT                                           
         BL    BBC05                                                            
         CLI   REPBUY.RBUYCHGI,C'A' DON'T UPDATE CODE IF ADD                    
         BE    BBCX                                                             
*                                                                               
BBC05    DS    0H                                                               
         XC    BBCELEM,BBCELEM     USE TO STORE CHANGE COMMENTS                 
         LA    R2,BBCELEM                                                       
*                                                                               
         XC    BBCMODCD,BBCMODCD   CLEAR STORAGE AREA FOR CHG CODES             
*                                                                               
         LA    R3,BBCMODCD                                                      
         CLC   AGYBUY.RBUYDUR,REPBUY.RBUYDUR                                    
*                                  SAME DURATION?                               
         BE    BBC20               YES                                          
         MVI   0(R3),C'L'          NO  - INSERT 'LENGTH CHANGE'                 
         LA    R3,1(R3)            BUMP TO NEXT POSITION                        
*&&DO                                                                           
*                                                                               
* EXPRESS CHANGE AS COMMENT                                                     
*                                                                               
         ZICM  RE,AGYBUY.RBUYDUR,2                                              
         ZICM  RF,REPBUY.RBUYDUR,2                                              
         CR    RE,RF                                                            
         BL    BBC10                                                            
         MVI   0(R2),C'+'                                                       
         LA    R2,1(R2)                                                         
BBC10    DS    0H                                                               
         SR    RE,RF                                                            
         ST    RE,FULL                                                          
         EDIT  FULL,(4,0(R2)),FLOAT=-,ALIGN=LEFT                                
         AR    R2,R0                                                            
         MVC   0(5,R2),=C' SEC,'                                                
         TM    AGYBUY.RBUYDUR,X'80'                                             
         BZ    *+10                                                             
         MVC   1(3,R2),=C'MIN'                                                  
         LA    R2,5(R2)                                                         
*&&                                                                             
*                                                                               
         MVC   0(8,R2),=C'LEN WAS '                                             
         AHI   R2,8                                                             
         EDIT  REPBUY.RBUYDUR,(4,0(R2)),FLOAT=-,ALIGN=LEFT                      
         AR    R2,R0                                                            
         MVI   0(R2),C','                                                       
         AHI   R2,1                                                             
*                                                                               
BBC20    EQU   *                                                                
         CLC   AGYBUY.RBUYCOS,REPBUY.RBUYCOS                                    
*                                  SAME COST?                                   
         BE    BBC70               YES                                          
         MVI   0(R3),C'R'          NO  - INSERT 'RATE CHG'                      
         LA    R3,1(R3)            BUMP TO NEXT POSITION                        
*&&DO                                                                           
* EXPRESS CHANGE AS COMMENT                                                     
*                                                                               
         ZICM  RE,AGYBUY.RBUYCOS,4                                              
         ZICM  RF,REPBUY.RBUYCOS,4                                              
         MVC   0(4,R2),=C'RATE'                                                 
         LA    R2,4(R2)                                                         
         MVI   0(R2),C'-'                                                       
         CR    RE,RF                                                            
         BL    BBC30                                                            
         MVI   0(R2),C'+'                                                       
BBC30    DS    0H                                                               
         MVI   1(R2),C'$'                                                       
         LA    R2,2(R2)                                                         
         SR    RE,RF                                                            
         ST    RE,FULL                                                          
         EDIT  FULL,(12,0(R2)),2,ALIGN=LEFT                                     
         AR    R2,R0                                                            
         MVI   0(R2),C','                                                       
         LA    R2,1(R2)                                                         
*&&                                                                             
*                                                                               
         MVC   0(9,R2),=C'RATE WAS '                                            
         AHI   R2,9                                                             
         EDIT  REPBUY.RBUYCOS,(12,0(R2)),2,ALIGN=LEFT                           
         AR    R2,R0                                                            
         MVI   0(R2),C','                                                       
         AHI   R2,1                                                             
*                                                                               
         DROP  AGYBUY,REPBUY                                                    
         EJECT                                                                  
***********************************************************************         
* CHECK BUY COMMENTS                                                            
***********************************************************************         
BBC70    DS    0H                                                               
         L     R6,BBCRIO                                                        
         L     R4,BBCAIO                                                        
*                                                                               
         MVI   ELCODE,X'04'        NO BUY COMMENTS PRESENT                      
         BAS   RE,GETEL                                                         
         BNE   BBC80                                                            
REPBUY   USING RBUYCMEL,R6                                                      
         CLC   =C'P=',REPBUY.RBUYCMNT SKIP PROGRAM NAME COMMENT                 
         BE    BBC73                                                            
         CLC   =C'MG=',REPBUY.RBUYCMNT IF CREDIT/MAKEGOOD, FIRST LINE           
         BE    BBC73               IS RESERVED FOR MG=/CR= REFERENCE            
         CLC   =C'CR=',REPBUY.RBUYCMNT                                          
         BNE   BBC75                                                            
*                                                                               
BBC73    DS    0H                                                               
         BAS   RE,NEXTEL                                                        
         BNE   BBC80                                                            
*                                                                               
BBC75    DS    0H                                                               
         MVI   ELCODE,X'04'                                                     
         BAS   RE,GETEL2                                                        
         BNE   BBC130                                                           
         B     BBC90                                                            
*                                                                               
BBC80    DS    0H                                                               
         MVI   ELCODE,X'04'                                                     
         BAS   RE,GETEL2                                                        
         BE    BBC110                                                           
         B     BBC130                                                           
*                                                                               
BBC90    DS    0H                                                               
AGYBUY   USING RBUYCMEL,R4                                                      
REPBUY   USING RBUYCMEL,R6                                                      
         CLC   AGYBUY.RBUYCMLN,REPBUY.RBUYCMLN                                  
         BNE   BBC110                                                           
         ZIC   R1,AGYBUY.RBUYCMLN                                               
         BCTR  R1,0                                                             
         EX    R1,BBC120                                                        
         BE    BBC130                                                           
*                                                                               
BBC110   DS    0H                                                               
         MVI   0(R3),C'Z'          NO  - INSERT 'BUY COMMENT CHG'               
         LA    R3,1(R3)            BUMP TO NEXT POSITION                        
*                                                                               
* EXPRESS CHANGE AS COMMENT                                                     
*                                                                               
         MVC   0(9,R2),=C'CMT CHGD,'                                            
         LA    R2,9(R2)                                                         
         B     BBC130                                                           
*                                                                               
BBC120   CLC   AGYBUY.RBUYCMEL(0),REPBUY.RBUYCMEL                               
         DROP  AGYBUY,REPBUY                                                    
         EJECT                                                                  
***********************************************************************         
* CHECK IF PROGRAM NAME CHANGED                                                 
***********************************************************************         
BBC130   EQU   *                                                                
* SKIP PROGRAM NAME CHECK FOR NOW                                               
*                                                                               
*&&DO                                                                           
         L     R4,BBCAIO                                                        
         L     R6,BBCRIO                                                        
*                                                                               
         MVI   ELCODE,X'21'                                                     
         BAS   RE,GETEL                                                         
         BNE   BBC140                                                           
*                                                                               
         MVI   ELCODE,X'21'                                                     
         BAS   RE,GETEL2                                                        
         BE    BBC150                                                           
         B     BBC200                                                           
*                                                                               
BBC140   EQU   *                                                                
         MVI   ELCODE,X'21'                                                     
         BAS   RE,GETEL2                                                        
         BNE   BBC200                                                           
*                                                                               
BBC150   DS    0H                                                               
AGYBUY   USING RBUYPGEL,R4                                                      
REPBUY   USING RBUYPGEL,R6                                                      
         CLC   AGYBUY.RBUYPGLN,REPBUY.RBUYPGLN                                  
         BNE   BBC170                                                           
         ZIC   R1,AGYBUY.RBUYPGLN                                               
         BCTR  R1,0                                                             
         EX    R1,BBC190                                                        
         BE    BBC200                                                           
*                                                                               
BBC170   DS    0H                                                               
         LR    RE,R3                                                            
         SHI   RE,1                                                             
         CLI   0(RE),C'Z'          CHECK PREVIOUS MOD CODE                      
         BE    BBC180              CHANGE CODE Z ALREADY SET?                   
         MVI   0(R3),C'Z'          NO  - INSERT 'PGM CHGD'                      
         LA    R3,1(R3)            BUMP TO NEXT POSITION                        
*                                                                               
* EXPRESS CHANGE AS COMMENT                                                     
*                                                                               
BBC180   DS    0H                                                               
         OI    MISCFLG3,MF3PGNAM                                                
         MVC   0(9,R2),=C'PGM CHGD,'                                            
         LA    R2,9(R2)                                                         
         B     BBC200                                                           
*                                                                               
BBC190   CLC   AGYBUY.RBUYPGEL(0),REPBUY.RBUYPGEL                               
         DROP  AGYBUY,REPBUY                                                    
         EJECT                                                                  
*&&                                                                             
***********************************************************************         
* CHECK DAY/TIME ELEMENTS                                                       
***********************************************************************         
BBC200   EQU   *                                                                
         L     R4,BBCAIO                                                        
         L     R6,BBCRIO                                                        
*                                                                               
         MVI   ELCODE,X'02'                                                     
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVI   ELCODE,X'02'                                                     
         BAS   RE,GETEL2                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
BBC210   DS    0H                  MAX 1 TIME AND 1 DAY CHANGES NOTED           
AGYBUY   USING RBUYDYEL,R4                                                      
REPBUY   USING RBUYDYEL,R6                                                      
         CLC   AGYBUY.RBUYDYIN,REPBUY.RBUYDYIN                                  
         BNE   BBC215                                                           
*                                                                               
         MVC   WORK(1),AGYBUY.RBUYDAYS                                          
         MVC   WORK+1(1),REPBUY.RBUYDAYS                                        
         NI    WORK,X'FF'-X'80'    REMOVE CC OVERRIDE                           
         NI    WORK+1,X'FF'-X'80'  FOR DAYS COMPARISON                          
         CLC   WORK(1),WORK+1                                                   
         BE    BBC230                                                           
*                                                                               
BBC215   DS    0H                                                               
         CLI   0(R3),C'T'                                                       
         BNE   BBC220                                                           
         MVI   1(R3),C'D'                                                       
         LA    R3,2(R3)                                                         
         B     BBC221                                                           
*                                                                               
BBC220   DS    0H                                                               
         MVI   0(R3),C'D'                                                       
*                                                                               
* EXPRESS CHANGE AS COMMENT                                                     
*                                                                               
BBC221   DS    0H                                                               
         MVC   0(8,R2),=C'DAY WAS '                                             
         LA    R2,8(R2)                                                         
         GOTO1 VOUTDAY,DMCB,REPBUY.RBUYDAYS,REPBUY.RBUYDYIN,0(R2)               
BBC223   CLI   0(R2),0                                                          
         BE    BBC225                                                           
         CLI   0(R2),C' '                                                       
         BE    BBC225                                                           
         LA    R2,1(R2)                                                         
         B     BBC223                                                           
*                                                                               
BBC225   DS    0H                                                               
         MVI   0(R2),C','                                                       
         LA    R2,1(R2)                                                         
         CLI   0(R3),C'D'                                                       
         BNE   BBC300                                                           
*                                                                               
BBC230   DS    0H                                                               
         CLC   AGYBUY.RBUYDYT1(4),REPBUY.RBUYDYT1                               
         BE    BBC250                                                           
         CLI   0(R3),C'D'                                                       
         BNE   BBC240                                                           
         MVI   1(R3),C'T'                                                       
         LA    R3,2(R3)                                                         
         B     BBC241                                                           
*                                                                               
BBC240   DS    0H                                                               
         MVI   0(R3),C'T'                                                       
*                                                                               
* EXPRESS CHANGE AS COMMENT                                                     
*                                                                               
BBC241   DS    0H                                                               
         MVC   0(9,R2),=C'TIME WAS '                                            
         LA    R2,9(R2)                                                         
*                                                                               
         GOTO1 UNTIME,DMCB,REPBUY.RBUYDYT1,0(R2)                                
*                                                                               
BBC243   CLI   0(R2),0                                                          
         BE    BBC245                                                           
         CLI   0(R2),C' '                                                       
         BE    BBC245                                                           
         LA    R2,1(R2)                                                         
         B     BBC243                                                           
*                                                                               
BBC245   DS    0H                                                               
         MVI   0(R2),C','                                                       
         LA    R2,1(R2)                                                         
         CLI   0(R3),C'T'                                                       
         BNE   BBC300                                                           
*                                                                               
BBC250   DS    0H                                                               
         BAS   RE,NEXTEL                                                        
         BNE   BBC260                                                           
         BAS   RE,NEXTEL2                                                       
         BE    BBC210                                                           
         B     BBC270                                                           
*                                                                               
BBC260   DS    0H                                                               
         BAS   RE,NEXTEL2                                                       
         BNE   BBC300                                                           
*                                                                               
BBC270   DS    0H                  NEW ORBIT FOUND, DAY/TIME CHANGED            
         MVC   0(2,R3),=C'DT'                                                   
         LA    R3,2(R3)            BUMP TO NEXT POSITION                        
*                                                                               
* EXPRESS CHANGE AS COMMENT                                                     
*                                                                               
         MVC   0(13,R2),=C'NEW DAY/TIME,'                                       
         LA    R2,13(R2)                                                        
         DROP  AGYBUY,REPBUY                                                    
         EJECT                                                                  
***********************************************************************         
* CHECK EFFECTIVE DATE ELEMENTS                                                 
***********************************************************************         
BBC300   EQU   *                                                                
         TM    BBCFLAG,X'80'       SKIP PROCESSING DATES?                       
         BO    BBC393                                                           
         TM    MISCFLG3,MF3BYCMT   BUY COMMENT ALREADY PROCESSED                
         BO    BBC393              FOR DATE/SPOT CHANGES?                       
         OI    MISCFLG3,MF3BYCMT   IT IS NOW                                    
*                                                                               
         NI    MISCFLG3,X'FF'-MF3EFFDT-MF3#SPTS-MF3PGNAM                        
*                                                                               
         XC    BBCAGRID,BBCAGRID                                                
         XC    BBCRGRID,BBCRGRID                                                
         GOTOR BLDBGRID,DMCB,BBCAIO,(X'41',BBCAGRID)                            
         GOTOR BLDBGRID,DMCB,BBCRIO,(X'41',BBCRGRID)                            
*                                                                               
         LA    R4,BBCAGRID                                                      
         LA    R6,BBCRGRID                                                      
         MVI   BBCCTR,1                                                         
         MVI   BBCWKLSC,0                                                       
*                                                                               
         CLC   BBCAGRID,BBCRGRID                                                
         BE    BBC393              NO CHANGE? SKIP ALL CHECKS                   
*                                                                               
BBC310   DS    0H                                                               
         CLC   0(1,R4),0(R6)                                                    
         BE    BBC390                                                           
*                                                                               
         CLI   0(R4),0                                                          
         BNE   BBC320                                                           
         TM    1(R4),X'01'                                                      
         BZ    BBC315                                                           
         MVI   1(R3),C'S'                                                       
         B     BBC390                                                           
BBC315   MVI   0(R3),C'E'                                                       
         B     BBC390                                                           
*                                                                               
BBC320   DS    0H                                                               
         CLI   0(R6),0                                                          
         BNE   BBC330                                                           
         TM    1(R6),X'01'                                                      
         BZ    BBC325                                                           
         MVI   1(R3),C'S'                                                       
         B     BBC390                                                           
BBC325   MVI   0(R3),C'E'                                                       
         B     BBC390                                                           
*                                                                               
BBC330   DS    0H                                                               
         MVI   1(R3),C'S'                                                       
         OI    MISCFLG3,MF3SPTCH                                                
*                                                                               
         TM    MISCFLG3,MF3SPTCH                                                
         BZ    BBC390                                                           
         NI    MISCFLG3,X'FF'-MF3SPTCH                                          
         OI    MISCFLG3,MF3#SPTS                                                
         CLI   BBCCTR,1                                                         
         BE    BBC340                                                           
*                                                                               
         ZIC   RE,BBCWKLSC                                                      
         ZIC   RF,BBCCTR                                                        
         SHI   RF,1                                                             
         CR    RE,RF                                                            
         BE    BBC350                                                           
*                                                                               
BBC340   DS    0H                                                               
*&&DO                                                                           
         MVC   0(10,R2),=C'#SPTS WAS '                                          
         LA    R2,10(R2)                                                        
         EDIT  (1,0(R6)),(3,0(R2)),ALIGN=LEFT,ZERO=NOBLANK                      
         AR    R2,R0                                                            
*&&                                                                             
         OI    MISCFLG3,MF3SPTCH                                                
         MVC   0(10,R2),=C'#SPTS CHGD'                                          
         AHI   R2,10                                                            
*                                                                               
         MVI   0(R2),C','                                                       
         LA    R2,1(R2)                                                         
*                                                                               
BBC350   DS    0H                                                               
         MVC   BBCWKLSC,BBCCTR                                                  
*                                                                               
BBC390   DS    0H                                                               
         AHI   R4,2                                                             
         AHI   R6,2                                                             
         ZIC   RF,BBCCTR                                                        
         AHI   RF,1                                                             
         STC   RF,BBCCTR                                                        
         CHI   RF,53                                                            
         BNH   BBC310                                                           
*                                                                               
         OC    0(2,R3),0(R3)                                                    
         BZ    BBC393                                                           
         CLI   0(R3),0                                                          
         BNE   BBC391                                                           
         MVI   0(R3),C'S'                                                       
         MVI   1(R3),0                                                          
         AHI   R3,1                                                             
         B     BBC393                                                           
*                                                                               
* EXPRESS CHANGE AS COMMENT                                                     
*                                                                               
BBC391   DS    0H                                                               
         CLI   1(R3),0                                                          
         BNE   BBC392                                                           
         AHI   R3,1                                                             
         B     BBC392A                                                          
*                                                                               
BBC392   DS    0H                                                               
         AHI   R3,2                                                             
*                                                                               
BBC392A  DS    0H                                                               
         OI    MISCFLG3,MF3EFFDT                                                
         MVC   0(9,R2),=C'DATE CHGD'                                            
         LA    R2,9(R2)                                                         
*                                                                               
* ADD CHANGE COMMENT(S)                                                         
*                                                                               
BBC393   DS    0H                                                               
         CLI   BBCMODCD+2,0                                                     
         BE    BBC394                                                           
         MVC   BBCMODCD(2),=C'* '                                               
*                                                                               
BBC394   DS    0H                  INSERT DEVELOPED CHANGE CODES                
         OC    BBCELEM,BBCELEM     EXIT IF NO CHANGES                           
         BZ    BBCX                                                             
*                                                                               
* ALWAYS REPLACE EXISTING BUY ORDER COMMENT                                     
*                                                                               
         GOTO1 HELLO,DMCB,(C'D',=C'REPFILE'),(X'84',AIO2),0,0                   
*                                                                               
BBC395   DS    0H                  BUILD AND ADD CHANGE BUY ORD CMTS            
         XC    ELTBUILD,ELTBUILD                                                
         MVC   ELTBUILD+3(60),BBCELEM                                           
BBC398   LA    R1,60                                                            
         LA    R2,ELTBUILD+63                                                   
BBC400   CLI   0(R2),0                                                          
         BE    BBC405                                                           
         CLI   0(R2),C' '                                                       
         BNE   BBC410                                                           
BBC405   BCTR  R2,0                                                             
         BCT   R1,BBC400                                                        
         B     BBCX                                                             
*                                                                               
BBC410   DS    0H                                                               
         CLI   0(R2),C','          LINE SHOULDN'T END IN A COMMA                
         BNE   *+6                                                              
         BCTR  R1,0                                                             
         LA    R1,4(R1)                                                         
         STC   R1,ELTBUILD+1                                                    
         MVI   ELTBUILD,X'84'                                                   
         MVI   ELTBUILD+2,X'80'    FLAG AS REP ORDER COMMENT                    
*                                  USE HELLO FOR FIRST LINE                     
         L     R4,BBCRIO                                                        
         MVI   ELCODE,X'84'                                                     
         BAS   RE,GETEL2                                                        
         BE    BBC420                                                           
*                                                                               
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),AIO2,ELTBUILD,0                    
*                                                                               
         OC    BBCELEM+60(60),=60C' '                                           
         CLC   BBCELEM+60(60),=60C' '                                           
         BE    BBCX                                                             
         L     R4,BBCRIO                                                        
         MVI   ELCODE,X'84'                                                     
         BAS   RE,GETEL2                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         LR    R6,R4               SAVE OFF LOCATION FOR SECOND ELEMENT         
*                                                                               
         XC    ELTBUILD,ELTBUILD                                                
         MVC   ELTBUILD+3(60),BBCELEM+60                                        
         B     BBC398              GO ADD SECOND ELEMENT                        
*                                                                               
BBC420   DS    0H                  SECOND LINE MUST USE RECUP FOR               
         ZIC   R1,1(R4)            PROPER ORDERING                              
         AR    R4,R1                                                            
         GOTO1 VRECUP,DMCB,(2,AIO2),ELTBUILD,(R4),0                             
*                                                                               
BBCX     DS    0H                                                               
         B     EXIT                                                             
         DROP  R8                                                               
         USING SPOOLD,R8                                                        
         GETELN R4,DATADISP,ELCODE,2                                            
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* CHANGE DAY/TIME/LEN/RATE/PROGRAM NAME                                         
* WE NEED TO CHANGE THE REP'S BUY TO BE THE SAME AS                             
* THE AGENCY'S DAY/TIME/LEN/RATE/PROGRAM NAME                                   
*                                                                               
* P1 HAS A(AGENCY BUY)                                                          
*                                                                               
* AIO2 HAS A(REP BUY)                                                           
***********************************************************************         
CHDTLRP  NTR1  BASE=*,LABEL=*                                                   
         L     R3,0(R1)            ADDRESS OF AGENCY BUY                        
         L     R6,0(R3)                                                         
         LR    R8,R6               SAVE OFF AGENCY BUY                          
*                                                                               
AGYBUY   USING RBUYREC,R6                                                       
*                                                                               
* UPDATE APPROPRIATE CHANGE CODE                                                
*                                                                               
         L     R3,AIO2             RATE CHANGE?                                 
REPBUY   USING RBUYREC,R3                                                       
*                                                                               
         CLC   REPBUY.RBUYCOS,AGYBUY.RBUYCOS                                    
         BE    CDTLR10                                                          
         MVC   REPBUY.RBUYCOS,AGYBUY.RBUYCOS                                    
         GOTOR UPDTMOD,DMCB,(C'R',AIO2)                                         
*                                                                               
CDTLR10  DS    0H                  LENGTH CHANGE?                               
         CLC   REPBUY.RBUYDUR,AGYBUY.RBUYDUR                                    
         BE    CDTLR13                                                          
         MVC   REPBUY.RBUYDUR,AGYBUY.RBUYDUR                                    
         GOTOR UPDTMOD,DMCB,(C'L',AIO2)                                         
*                                                                               
CDTLR13  DS    0H                  LENGTH CHANGE?                               
         LA    R2,AGYBUY.RBUYDYEL                                               
         LA    R4,REPBUY.RBUYDYEL                                               
         DROP  AGYBUY,REPBUY                                                    
*                                                                               
CDTLR15  DS    0H                  DAY/TIME CHANGE?                             
AGYBUY   USING RBUYDYEL,R2                                                      
REPBUY   USING RBUYDYEL,R4                                                      
         CLC   AGYBUY.RBUYDYIN(2),REPBUY.RBUYDYIN                               
         BE    CDTLR18                                                          
         GOTOR UPDTMOD,DMCB,(C'D',AIO2)                                         
*                                                                               
CDTLR18  DS    0H                  CHANGE IN START/END DAY IMPLIES              
         CLC   AGYBUY.RBUYDYIN,REPBUY.RBUYDYIN                                  
         BE    CDTLR20             CHANGE IN EFF DATES                          
         GOTOR UPDTMOD,DMCB,(C'E',AIO2)                                         
*                                                                               
CDTLR20  DS    0H                                                               
         CLC   AGYBUY.RBUYDYT1(4),REPBUY.RBUYDYT1                               
         BE    CDTLR25                                                          
         GOTOR UPDTMOD,DMCB,(C'T',AIO2)                                         
*                                                                               
CDTLR25  DS    0H                                                               
         ZIC   R1,1(R2)                                                         
         AR    R2,R1                                                            
         ZIC   R1,1(R4)                                                         
         AR    R4,R1                                                            
*                                                                               
         CLI   0(R2),X'02'                                                      
         BE    CDTLR28                                                          
         CLI   0(R4),X'02'                                                      
         BNE   CDTLR30                                                          
*                                                                               
CDTLR28  DS    0H                                                               
         CLI   0(R4),X'02'                                                      
         BE    CDTLR15                                                          
         GOTOR UPDTMOD,DMCB,(C'T',AIO2)                                         
         GOTOR UPDTMOD,DMCB,(C'D',AIO2)                                         
         DROP  AGYBUY,REPBUY                                                    
*                                                                               
* REMOVE ALL DAY/TIME ELEMENTS FROM REP BUY                                     
*                                                                               
CDTLR30  DS    0H                                                               
         MVC   AIO,AIO2                                                         
         MVI   ELCODE,X'02'                                                     
         GOTO1 REMELEM                                                          
*                                                                               
         MVI   ELCODE,X'02'        LOCATE AGENCY'S DAY/TIME ELEMENT             
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R4,AIO2             GET START OF X'02' ELEMENT                   
         AHI   R4,34+43            KEY+CTRL+X'01' ELEMENT                       
*                                                                               
* ADD AGENCY'S DAY/TIME ELEMENT(S) TO THE REP BUY                               
*                                                                               
CDTLR50  DS    0H                                                               
         XC    ELEM,ELEM                                                        
         ZIC   R1,1(R6)                                                         
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ELEM(0),0(R6)                                                    
*                                                                               
         GOTO1 VRECUP,DMCB,(2,AIO2),ELEM,(R4),0                                 
         ZIC   R1,1(R4)                                                         
         AR    R4,R1                                                            
*                                                                               
         BRAS  RE,NEXTEL                                                        
         BE    CDTLR50                                                          
*                                                                               
* USE AGENCY'S NEW PROGRAM NAME IF CHANGED                                      
*                                                                               
         L     R4,AIO2             REP BUY                                      
         LR    R6,R8               RESTORE START OF AGENCY BUY                  
*                                                                               
         MVI   ELCODE,X'21'                                                     
         BRAS  RE,GETEL                                                         
         BNE   CDTLR55                                                          
*                                                                               
         MVI   ELCODE,X'21'                                                     
         BRAS  RE,GETEL3                                                        
         BE    CDTLR57                                                          
         B     CDTLR58                                                          
*                                                                               
CDTLR55  EQU   *                                                                
         MVI   ELCODE,X'21'                                                     
         BRAS  RE,GETEL3                                                        
         BNE   CDTLR59                                                          
*                                                                               
CDTLR57  DS    0H                                                               
         GOTO1 HELLO,DMCB,(C'D',=C'REPFILE'),(X'21',AIO2),0,0                   
*                                                                               
CDTLR58  DS    0H                                                               
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),AIO2,(R6),0                        
*                                                                               
CDTLR59  DS    0H                                                               
         TM    MISCFLG3,MF3EFFDT                                                
         BZ    CDTLR60                                                          
         GOTOR UPDTMOD,DMCB,(C'E',AIO2)                                         
*                                                                               
CDTLR60  DS    0H                                                               
         TM    MISCFLG3,MF3#SPTS                                                
         BZ    CDTLRX                                                           
         GOTOR UPDTMOD,DMCB,(C'S',AIO2)                                         
*                                                                               
CDTLRX   DS    0H                                                               
         B     EXIT                                                             
         GETELN R4,DATADISP,ELCODE,3                                            
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* UPDATE MOD CODE IN BUY RECORD                                                 
***********************************************************************         
UPDTMOD  NTR1  BASE=*,WORK=(R2,1),LABEL=*                                       
*                                                                               
         ZICM  R6,1(R1),3          IO AREA FOR BUY RECORD                       
         MVC   0(1,R2),0(R1)       MOD CODE                                     
*                                                                               
         USING RBUYREC,R6                                                       
         CLC   RBUYVER,VERDFLT                                                  
         BL    UMOD30                                                           
         CLI   RBUYCHGI,C'A'       DON'T UPDATE CODE IF ADD                     
         BE    UMODX                                                            
         CLI   RBUYCHGI,C'*'                                                    
         BE    UMODX                                                            
         OC    RBUYCHGI,=C'  '                                                  
         CLC   RBUYCHGI(1),0(R2)                                                
         BE    UMODX                                                            
         CLC   RBUYCHGI+1(1),0(R2)                                              
         BE    UMODX                                                            
         CLI   RBUYCHGI,C' '                                                    
         BE    UMOD30                                                           
         CLI   RBUYCHGI+1,C' '                                                  
         BNE   UMOD20                                                           
         MVC   RBUYCHGI+1(1),0(R2)                                              
         B     UMODX                                                            
*                                                                               
UMOD20   DS    0H                                                               
         MVC   RBUYCHGI,=C'* '                                                  
         B     UMODX                                                            
*                                                                               
UMOD30   DS    0H                                                               
         MVC   RBUYVER,VERDFLT     STORE REP VERSION NO. IN BUY                 
         MVC   RBUYKMOD,CONMOD#    INSERT CONTRACT MOD #                        
         MVC   RBUYCHGI(1),0(R2)                                                
         MVI   RBUYCHGI+1,C' '                                                  
*                                                                               
UMODX    DS    0H                                                               
         B     EXIT                                                             
         DROP  R6                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* REBUILD X'03' ELEMENT FROM BUY GRID                                           
* BEWARE: R8 IS USED HERE, SO NO SPOOLING FUNCTIONALITIES ARE ALLOWED           
***********************************************************************         
REBLDBUY NTR1  BASE=*,LABEL=*                                                   
         L     R8,0(R1)            ADDRESS OF BUY GRID TO BE REBUILD            
*                                                                               
         L     R6,AIO2                                                          
         MVI   ELCODE,X'02'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING RBUYDYEL,R6                                                      
         ZIC   R1,RBUYDYIN                                                      
         SRL   R1,4                SHIFT START DAY TO LOWER HALF BYTE           
         STC   R1,MSSTRDAY                                                      
*                                                                               
RBLD10   DS    0H                  POINT TO LAST X'02' ELEMENT TO GET           
         LR    R2,R6               END DAY                                      
         BRAS  RE,NEXTEL                                                        
         BE    RBLD10                                                           
         LR    R6,R2                                                            
         USING RBUYDYEL,R6                                                      
         MVI   MSENDDAY,0     GET END DAY                                       
         MVN   MSENDDAY,RBUYDYIN                                                
         DROP  R6                                                               
*&&DO                                                                           
         L     R6,AIO2                                                          
         MVI   ELCODE,X'03'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING RBUYDTEL,R6         SAVE OFF BUY START DATE                      
         GOTO1 DATCON,DMCB,(3,RBUYDTST),(0,MSSTDT)                              
*&&                                                                             
*                                                                               
* IF WE ARE DOING ADDITION TO SCHEDULE, THE START DATE IS ACTUALLY THE          
* GRID'S START DATE AND NOT THE BUY'S ORIGINAL START DATE                       
*                                                                               
*        TM    FLAGS,FGADDSPQ                                                   
*        BZ    RBLD15                                                           
*        CLI   METHOD,CHGBUYQ                                                   
*        BE    RBLD15                                                           
         GOTO1 DATCON,DMCB,(3,GSTRDATE),(0,MSSTDT)                              
*        DROP  R6                                                               
*                                                                               
* DELETE OLD X'03'S                                                             
*                                                                               
RBLD15   DS    0H                                                               
         MVI   ELCODE,X'03'                                                     
         GOTO1 REMELEM                                                          
*                                                                               
         SR    R3,R3                                                            
         NI    MISCFLG3,X'FF'-MF303ELM SET NO X'03' ELEM FLAG                   
*                                                                               
         L     R6,AIO2                                                          
         USING RBUYREC,R6                                                       
*                                                                               
*        CLC   SVGRID,0(R8)        ANY SPOT(S) PER WK CHANGES?                  
*        BE    RBLD35                                                           
*                                                                               
         LA    RE,SVGRID                                                        
         LR    RF,R8                                                            
         LA    R1,53                                                            
*                                                                               
RBLD20   DS    0H                                                               
         CLC   0(1,RE),0(RF)                                                    
         BE    RBLD25                                                           
*        CLI   0(RF),0                                                          
*        BE    RBLD25                                                           
         CLC   SVREPNPW,0(RF)                                                   
         BE    RBLD25                                                           
         GOTOR UPDTMOD,DMCB,(C'S',AIO2)                                         
         B     RBLD35                                                           
*                                                                               
RBLD25   DS    0H                                                               
         AHI   RE,2                                                             
         AHI   RF,2                                                             
         BCT   R1,RBLD20                                                        
*                                                                               
RBLD35   DS    0H                  NEW BUY ORDER COMMENTS ADDED?                
         OC    CMTSTRDT,CMTSTRDT                                                
         BZ    RBLD40                                                           
         GOTOR UPDTMOD,DMCB,(C'O',AIO2)                                         
*                                                                               
RBLD40   DS    0H                                                               
         XC    RBUYTSPT,RBUYTSPT   CLEAR AND RECALCULATE TOTALS                 
         XC    RBUYTCOS,RBUYTCOS                                                
         XC    RBUYTWKS,RBUYTWKS                                                
*                                                                               
RBLD50   DS    0H                                                               
         LA    R4,1                                                             
         XC    ELEM,ELEM                                                        
WKD      USING RBUYDTEL,ELEM                                                    
*                                                                               
         MVI   WKD.RBUYDTCD,X'03'                                               
         MVI   WKD.RBUYDTLN,11                                                  
*                                                                               
RBLD60   DS    0H                                                               
         CLI   0(R8),0                                                          
         BNE   RBLD70                                                           
         TM    1(R8),X'01'         OVERRIDE??                                   
         BZ    RBLD160                                                          
*                                                                               
RBLD70   DS    0H                                                               
         OC    WKD.RBUYDTST,WKD.RBUYDTST                                        
         BNZ   RBLD90              NEED TO FIND START DATE                      
         TM    MISCFLG3,MF303ELM                                                
         BO    RBLD80                                                           
*        LTR   R3,R3                                                            
*        BNZ   RBLD80                                                           
*                                                                               
* NEED TO MAKE SURE START DATE DAY IS SAME AS FIRST DAY IN X'02' ELEM           
*                                                                               
         OI    MISCFLG3,MF303ELM                                                
         MVC   WKD.RBUYDTST,MSSTDT                                              
         MVC   MSSTDT2,MSSTDT                                                   
         GOTO1 DATCON,DMCB,(0,MSSTDT),(3,WKD.RBUYDTST)                          
*                                                                               
         GOTO1 GETDAY,DMCB,MSSTDT,FULL                                          
         ZIC   R2,MSSTRDAY                                                      
         ZIC   RF,DMCB                                                          
         CR    R2,RF                                                            
*        BE    RBLD90                                                           
         BE    RBLD80                                                           
         BL    RBLD75                                                           
         SR    R2,RF                                                            
         B     RBLD78                                                           
*                                                                               
RBLD75   DS    0H                                                               
         LA    RE,7                OOWR                                         
         SR    RE,RF                                                            
         AR    R2,RE                                                            
*                                                                               
RBLD78   DS    0H                                                               
         GOTO1 ADDAY,DMCB,MSSTDT,MSSTDT,(R2)                                    
         GOTO1 DATCON,DMCB,(0,MSSTDT),(3,WKD.RBUYDTST)                          
*        B     RBLD90                                                           
*                                                                               
RBLD80   DS    0H                  SUBSEQUENT X'03'S NEED TO COMPUTE            
         LR    R2,R3               START DATES RELATIVE TO INITIAL              
         MHI   R2,7                FLIGHT START FOR THIS BUY                    
         GOTO1 ADDAY,DMCB,MSSTDT,MSSTDT2,(R2)                                   
         GOTO1 DATCON,DMCB,(0,MSSTDT2),(3,WKD.RBUYDTST)                         
*&&DO                                                                           
         GOTO1 GETDAY,DMCB,MSSTDT2,FULL                                         
         ZIC   R2,MSSTRDAY                                                      
         ZIC   RF,DMCB                                                          
         SR    R2,RF                                                            
         BZ    RBLD90                                                           
*                                                                               
         GOTO1 ADDAY,DMCB,MSSTDT2,MSSTDT2,(R2)                                  
         GOTO1 DATCON,DMCB,(0,MSSTDT2),(3,WKD.RBUYDTST)                         
*&&                                                                             
RBLD90   DS    0H                                                               
         CLC   0(1,R8),2(R8)                                                    
         BNE   RBLD110                                                          
         CLI   0(R8),0             INCASE ALL SPOTS CREDITED OUT FOR            
         BNE   RBLD100             THIS WEEK, CHECK IF ZERO SPOT                
         TM    3(R8),X'01'         OVERRIDE FLAG IS SET                         
         BZ    RBLD110                                                          
*                                                                               
RBLD100  DS    0H                                                               
         AHI   R8,2                                                             
         AHI   R4,1                                                             
         AHI   R3,1                                                             
         CHI   R3,53                                                            
         BL    RBLD60              BUMP TO NEXT CELL                            
*                                                                               
RBLD110  DS    0H                                                               
         MVC   WKD.RBUYDTNW,0(R8)                                               
         STC   R4,WKD.RBUYDTWK                                                  
*** CHECK IF OVERRIDE OR ALTERNATE WEEKS                                        
         OI    WKD.RBUYDTIN,X'80'  DEFAULT IS WEEKLY                            
*        TM    1(R8),X'01'         OVERRIDE??                                   
*        BZ    *+8                                                              
*        OI    WKD.RBUYDTIN,X'01'                                               
*** CHECK IF OVERRIDE OR ALTERNATE WEEKS                                        
*** CHECK IF OVERRIDE OR ALTERNATE WEEKS                                        
         L     R2,AIO2                                                          
TBUYD    USING RBUYREC,R2                                                       
         CLC   TBUYD.RBUYNW,0(R8)                                               
         BE    RBLD120                                                          
         OI    WKD.RBUYDTIN,X'01'                                               
         DROP  TBUYD                                                            
***********                                                                     
***********                                                                     
*                                                                               
* CALCULATE END DATE                                                            
*                                                                               
RBLD120  DS    0H                                                               
         ZIC   R2,WKD.RBUYDTWK                                                  
         MHI   R2,7                                                             
         GOTO1 ADDAY,DMCB,MSSTDT2,MSSTDT2,(R2)                                  
*                                                                               
         GOTO1 GETDAY,DMCB,MSSTDT2,FULL                                         
         ZIC   RE,MSENDDAY                                                      
         ZIC   RF,DMCB                                                          
         SR    RE,RF                                                            
         BZ    RBLD140                                                          
         BP    RBLD130                                                          
*                                                                               
* HANDLE OUT OF WEEK ROTATIONS                                                  
*                                                                               
         LR    R2,RE                                                            
         B     RBLD150                                                          
*                                                                               
RBLD130  DS    0H                                                               
         LA    R2,7                                                             
         LNR   R2,R2                                                            
         AR    R2,RE                                                            
         B     RBLD150                                                          
*                                                                               
RBLD140  DS    0H                  SAME START END DAY, BACK UP A WEEK           
         LA    R2,7                                                             
         LNR   R2,R2                                                            
*                                                                               
RBLD150  DS    0H                                                               
         GOTO1 ADDAY,DMCB,MSSTDT2,MSSTDT2,(R2)                                  
         GOTO1 DATCON,DMCB,(0,MSSTDT2),(3,WKD.RBUYDTED)                         
*                                                                               
         SR    RE,RE               CALCULATE TOTAL SPOTS                        
         ZIC   RF,WKD.RBUYDTNW                                                  
         ZIC   R1,WKD.RBUYDTWK                                                  
         MR    RE,R1                                                            
         ZICM  R1,RBUYTSPT,2                                                    
         AR    R1,RF                                                            
         STCM  R1,3,RBUYTSPT                                                    
*                                                                               
         ZIC   RE,WKD.RBUYDTWK     CALCULATE TOTAL WEEKS                        
         ZIC   RF,RBUYTWKS                                                      
         AR    RE,RF                                                            
         STC   RE,RBUYTWKS                                                      
*                                                                               
         GOTO1 ADDELEM                                                          
*                                                                               
RBLD160  DS    0H                                                               
         AHI   R8,2                                                             
         LA    R3,1(R3)                                                         
         CH    R3,=H'53'                                                        
         BL    RBLD50              BUMP TO NEXT CELL                            
*                                                                               
         SR    RE,RE               CALCULATE TOTAL COST                         
         ZICM  RF,RBUYCOS,4                                                     
         ZICM  R1,RBUYTSPT,2                                                    
         MR    RE,R1                                                            
         STCM  RF,15,RBUYTCOS                                                   
*                                                                               
         B     EXIT                                                             
         DROP  WKD,R6                                                           
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                               
* BUILD GRID OF AVALIABLE SPOTS TO BE REMOVED/ADDED                             
* POPULATE GRID BY SEEDING WITH X'03' ELEMENT                                   
* REMOVE RESERVED SPOTS IN X'06', X'07' AND X'66' ELEMENTS                      
*                                                                               
* P1 A(IO AREA)                                                                 
* P2 BYTE 1:X'80'         X'80'=DO NO INITIALIZE 'BUYGRID' TO NULL              
*          :X'40'         X'40'=ADD RESULT OF BUYGRID TO A(GRID)                
*          :X'08'         X'08'=DIE                                             
*          :X'01'         X'01'=USE CONTRACT START AND END DATE                 
* P2 A(GRID)                                                                    
***********************************************************************         
BLDBGRID NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R6,0(R1)            AIO                                          
         ST    R6,MYSVIO                                                        
         L     R3,4(R1)            POINT TO START OF GRID                       
         TM    4(R1),X'80'         X'80'=DO NO INITIALIZE TO NULL               
         BO    *+10                CALLER DO INITIALIZATION                     
         XC    BUYGRID,BUYGRID                                                  
*                                                                               
         TM    4(R1),X'08'                                                      
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVI   ELCODE,X'03'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING RBUYDTEL,R6                                                      
*                                                                               
         ST    R3,DMCB+4                                                        
         TM    DMCB+4,X'01'                                                     
         BZ    BBGRID05                                                         
*                                                                               
         L     R2,AIO3                                                          
         USING RCONREC,R2                                                       
*                                                                               
* CHECK IF ORIGINAL CONTRACT START DATE IS EARLIER. IF SO, USE IT               
*                                                                               
         GOTO1 DATCON,DMCB,(2,CONFLTDT),(3,GSTRDATE)                            
         CLC   GSTRDATE,RCONDATE                                                
         BNH   *+10                                                             
         MVC   GSTRDATE,RCONDATE                                                
*                                                                               
         GOTO1 DATCON,DMCB,(2,CONFLTDT+2),(3,GENDDATE)                          
         CLC   GENDDATE,RCONDATE+3                                              
         BH    *+10                                                             
         MVC   GENDDATE,RCONDATE+3                                              
         B     BBGRID08                                                         
         DROP  R2                                                               
*                                                                               
BBGRID05 DS    0H                                                               
         MVC   GSTRDATE,RBUYDTST   GET BUY START DATE                           
         MVC   GENDDATE,RBUYDTED   GET BUY END DATE                             
*                                                                               
BBGRID08 DS    0H                                                               
         LA    R4,BUYGRID          START OF GRID                                
*        B     BBGRID20            SKIP OFFSET FOR FIRST DATES                  
*                                                                               
BBGRID10 DS    0H                                                               
         ST    R3,DMCB+4                                                        
         TM    DMCB+4,X'01'                                                     
         BNZ   BBGRID15                                                         
*                                                                               
         CLC   GENDDATE,RBUYDTED                                                
         BNL   *+10                                                             
         MVC   GENDDATE,RBUYDTED                                                
*                                                                               
BBGRID15 DS    0H                                                               
         LA    R4,BUYGRID          RESET TO START OF GRID                       
         XC    ELEM,ELEM                                                        
         XC    WORK2,WORK2                                                      
         GOTO1 DATCON,DMCB,(3,GSTRDATE),(5,ELEM)                                
         GOTO1 DATCON,DMCB,(3,RBUYDTST),(5,ELEM+9)                              
         MVI   ELEM+8,C'-'                                                      
         GOTO1 PERVAL,DMCB,(17,ELEM),WORK2                                      
         CLI   DMCB+4,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
WKD      USING PERVALD,WORK2                                                    
         ZICM  R1,WKD.PVALNWKS,2   # WEEKS ROUNDED UP                           
         BCTR  R1,0                ADJUST FOR ROUNDING                          
         DROP  WKD                                                              
*                                                                               
         SLL   R1,1                MULTIPLY BY 2                                
         AR    R4,R1               BUMP TO STARTING CELL FOR THIS DATE          
*                                                                               
BBGRID20 DS    0H                                                               
         ZIC   R1,RBUYDTWK                                                      
*                                                                               
BBGRID30 DS    0H                                                               
         CLI   0(R4),0             IS THERE SPOT IN THIS GRID?                  
         BE    BBGRID33                                                         
         CLI   RBUYDTNW,0                                                       
         BE    BBGRID38                                                         
BBGRID33 DS    0H                                                               
         MVC   0(1,R4),RBUYDTNW                                                 
*                                                                               
         CLI   RBUYDTNW,0          IF ZERO SPOT, FORCE OVERRIDE                 
         BE    BBGRID35                                                         
         TM    RBUYDTIN,X'01'      NPW OVERRIDE??                               
         BZ    BBGRID38                                                         
*                                                                               
BBGRID35 DS    0H                                                               
         OI    1(R4),X'01'                                                      
*                                                                               
BBGRID38 DS    0H                                                               
         AHI   R4,2                BUMP TO NEXT WEEK                            
         TM    RBUYDTIN,X'40'      ALTERNATE WEEKS??                            
         BZ    *+8                                                              
         AHI   R4,2                YES, BUMP ONE MORE                           
         LTR   R1,R1                                                            
         BZ    BBGRID40                                                         
         BCT   R1,BBGRID30         PROCESS FOR SPECIFIED NUMBER OF WKS          
*                                                                               
BBGRID40 DS    0H                  INCASE OF MULTIPLE EFFECTIVE DATES           
         BRAS  RE,NEXTEL                                                        
         BE    BBGRID10                                                         
         DROP  R6                                                               
*                                                                               
* REMOVE RESERVED SPOTS FROM GRID                                               
*                                                                               
         L     R6,MYSVIO           CHECK OLD STYLE MAKEGOOD                     
         MVI   ELCODE,X'06'                                                     
         BRAS  RE,GETEL                                                         
         BNE   BBGRID60                                                         
         USING RBUYMSEL,R6                                                      
BBGRID50 MVC   BSTRDATE,RBUYMSDT                                                
         MVC   BMSS#SPT,RBUYMSSP                                                
         DROP  R6                                                               
*                                                                               
*        GOTOX (C'-',ADJSPTS)                                                   
         GOTOR ADJSPTS,DMCB,(C'-',0)                                            
         BZ    *+6                                                              
         DC    H'0'                SHOULD NOT HAPPEN!                           
         BRAS  RE,NEXTEL                                                        
         BE    BBGRID50                                                         
*                                                                               
BBGRID60 DS    0H                  CHECK CREDIT                                 
         L     R6,MYSVIO                                                        
         MVI   ELCODE,X'07'                                                     
         BRAS  RE,GETEL                                                         
         BNE   BBGRID80                                                         
         USING RBUYCREL,R6                                                      
BBGRID70 MVC   BSTRDATE,RBUYCRDT                                                
         MVC   BMSS#SPT,RBUYCRSP                                                
         DROP  R6                                                               
*                                                                               
*        GOTOX (C'-',ADJSPTS)                                                   
         GOTOR ADJSPTS,DMCB,(C'-',0)                                            
         BZ    *+6                                                              
         DC    H'0'                SHOULD NOT HAPPEN!                           
         BRAS  RE,NEXTEL                                                        
         BE    BBGRID70                                                         
*                                                                               
BBGRID80 DS    0H                  CHECK MAKEGOOD OFFERS                        
*&&DO                                                                           
         L     R6,MYSVIO                                                        
         MVI   ELCODE,X'66'                                                     
         BRAS  RE,GETEL                                                         
         BNE   BBGRID95                                                         
         USING RBMGMSEL,R6                                                      
BBGRID90 MVC   BSTRDATE,RBMGMSDT                                                
         MVC   BMSS#SPT,RBMGMSSP                                                
         DROP  R6                                                               
*                                                                               
*        GOTOX (C'-',ADJSPTS)                                                   
         GOTOR ADJSPTS,DMCB,(C'-',0)                                            
         BZ    *+6                                                              
         DC    H'0'                SHOULD NOT HAPPEN!                           
         BRAS  RE,NEXTEL                                                        
         BE    BBGRID90                                                         
*&&                                                                             
*                                                                               
* CHECK IF WE WERE PASSED A GRID TO BE AGGREGATED WITH BUYGRID                  
*                                                                               
BBGRID95 DS    0H                                                               
         ST    R3,DMCB+4                                                        
         TM    DMCB+4,X'40'                                                     
         BZ    BBGRIDX                                                          
*                                                                               
         LA    R4,BUYGRID                                                       
         LA    R2,53                                                            
*                                                                               
BBGRID98 DS    0H                                                               
         ZIC   RE,0(R3)                                                         
         ZIC   RF,0(R4)                                                         
         AR    RE,RF                                                            
         STC   RE,0(R3)                                                         
*                                                                               
         TM    1(R4),X'01'         OVERRIDE FLAG SET?                           
         BZ    *+8                                                              
         OI    1(R3),X'01'         SET OVERRIDE TO TARGET GRID                  
*                                                                               
         AHI   R3,2                                                             
         AHI   R4,2                                                             
         BCT   R2,BBGRID98                                                      
*                                                                               
BBGRIDX  DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
