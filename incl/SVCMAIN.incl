*          DATA SET SVCMAIN    AT LEVEL 001 AS OF 04/08/08                      
**  NEW VERSION HAS RUNNER SMF CALL, BRANCH (NOT LINK) TO SMF MOD               
**      R0 = -8 CALL NO-OP'D                                                    
**  THIS SOURCE IS LIVE IN NY AS OF 12/16/07                                    
DDSSVC   CSECT                                                                  
DDSSVC   AMODE  31   CHANGED TO AMODE 31 5/19/99                                
DDSSVC   RMODE  24                                                              
**                                                                              
**    SEE ALSO DAISY DOCUMENTATION,  F.W. ROE  12/16/2007                       
**                                                                              
***********************************************************************         
*                                                                     *         
*   THIS CODE EXECUTES AS A TYPE 3/4 SVC AND MUST CONFORM TO THE      *         
*   APPROPRIATE CONVENTIONS                                           *         
*                                                                     *         
*   THE INPUT REGS FOR SVCS ARE AS FOLLOWS (REFER TO SPL: SUPERVISOR) *         
*      R0 & R1  INPUT DATA  (SEE BELOW)                               *         
*      R2       UNPREDICTABLE         R5   SVRB ADDRESS               *         
*      R3       CVT POINTER           R6   ENTRY POINT ADDRESS        *         
*      R4       TCB ADDRESS           R7   ASCB                       *         
*                                                                     *         
*   AS AN SVC THE ROUTINE IS ENTERED IN KEY 0, SUPERVISOR STATE       *         
*   AND MUST BE REENTRANT                                             *         
*                                                                     *         
*    FUNCTION CODES IN REG0   -1   SPECIAL LOAD TO STORAGE            *         
*                             -2   CACHE DEB -- LOAD MODE  REG1=DEB   *         
*                             -3   CACHE DEB -- DUMP MODE  REG1=DEB   *         
*                             -4   SRM  DON'T SWAP                    *         
*                             -5   SRM  OKSWAP                        *         
*                             -6   WRITE DDS SMF RECORDS              *         
*                             -7   JES STATUS                         *         
*                             -8   SPARE/TRACE                        *         
*                             -9   ISSUE WTO WITH MODULE LINK DATE    *         
*                            -10                                      *         
*                            -11   END OF CONTROLLER                  *         
*                            -12   SEQUENTIAL MODE         REG1=DCB   *         
*                            -13   DDS ENQ/DEQ SMF REC                *         
*                            -14   MONSOON START                      *         
*                            -15   MONSOON END                        *         
*                            -16   MONSOON INIT                       *         
*                            -17   IMPROVED REQUEST RECORDING         *         
*                            -18                                                
*                            -19                                                
*                            -20   TRANSACTION ACCOUNTING                       
*                            -21   DATASPACE SERVICES                           
*                            -22   DARE SMF RECORD                              
*                            -23   FILE BALANCING SMF RECORD                    
*                            -24   STORAGE KEY MANIPULATIONS                    
*                            -25   SMF RECORD                                   
*                            -26   SMF RECORD                                   
*                            -27   DATASPACE SERVICES - SPECIAL 2               
*                            -28   DATASPACE SERVICES - SPECIAL 3               
*                            -29 TO -30 FOR EXPANSION DEVELOPMENT               
*                            -31   RUNNER SMF RECORD                            
***********************************************************************         
         USING *,R6                                                             
         BASR  RC,0                                                             
         USING *,RC                                                             
         LR    R2,R1          SAVE INPUT PARM REG                               
         LPR   R8,R0                                                            
         B     LOOKUP                                                           
**     FOLLOWING IS INVOKED WITH R0 = -9                                        
WTOID    WTO   'SVC247 ASSEMBLED: &SYSDATE &SYSTIME',ROUTCDE=11                 
         B     QUIKEXIT       RETURN                                            
         SPACE                                                                  
         CNOP     0,4                                                           
FUNCUNK  LH    R2,ABENDCD2                                                      
         ABEND    (R2),DUMP,STEP,SYSTEM                                         
         EJECT                                                                  
LOOKUP   LA    R1,CODETBL                                                       
         SR    R9,R9                                                            
         SLL   R8,3                MULTIPLE BY 8 (2*3)                          
         LA    R9,0(R8,R1)         GET ENTRY ADDRESS                            
         USING TABLEMAP,R9                                                      
**       SR    R7,R7                                                            
**       ICM   R7,8,ETNRYNO                                                     
         CLI   ENTRYTYP,X'02'                                                   
         BE    TYPE2RTN                                                         
         CLI   ENTRYTYP,X'01'                                                   
         BE    TYPE1RTN                                                         
         DC    H'0'                                                             
         SPACE                                                                  
TYPE1RTN L     R3,ADR2USE                                                       
         BR    R3                                                               
         SPACE                                                                  
TYPE2RTN L     R3,ADR2USE                                                       
*NOP     WTO   'TYPE 2 ENTRY FOUND'                                             
         LR    R1,R2            RESTORE INPUT PARM                              
         BR    R3                                                               
         DS    0D                                                               
CODETBL  DC    AL1(00),X'01',CL2'00',A(0)       DUMMY FIRST ENTRY               
         DC    AL1(01),X'01',CL2'00',A(LOADER)                                  
         DC    AL1(02),X'01',CL2'00',A(CACHECTL)                                
         DC    AL1(03),X'01',CL2'00',A(CACHECTL)                                
         DC    AL1(04),X'01',CL2'00',A(SRMNSWAP)                                
         DC    AL1(05),X'01',CL2'00',A(SRMOK)                                   
         DC    AL1(06),X'02',CL2'00',A(DDSSMF)                                  
         DC    AL1(07),X'02',CL2'00',A(DDSJES)                                  
         DC    AL1(08),X'02',CL2'00',A(QUIKEXIT)   DISABLED                     
         DC    AL1(09),X'01',CL2'00',A(WTOID)      DISPLAY MODULE DATE          
         DC    AL1(10),X'02',CL2'00',A(DDSSMF2)                                 
         DC    AL1(11),X'00',CL2'00',A(DDSEOJ)                                  
         DC    AL1(12),X'00',CL2'00',A(CACHECTL)                                
         DC    AL1(13),X'02',CL2'00',A(DDSENQ)                                  
         DC    AL1(14),X'02',CL2'00',A(DDSMNSN1)                                
         DC    AL1(15),X'02',CL2'00',A(DDSMNSN2)                                
         DC    AL1(16),X'02',CL2'00',A(DDSMNSN3)                                
         DC    AL1(17),X'02',CL2'00',A(DDSSMF3)                                 
         DC    AL1(18),X'02',CL2'00',A(DDSINIT)                                 
         DC    AL1(19),X'02',CL2'00',A(NMLCACHE)                                
         DC    AL1(20),X'02',CL2'00',A(TRXACCNT)                                
         DC    AL1(21),X'02',CL2'00',A(DATASPC)                                 
         DC    AL1(22),X'02',CL2'00',A(DDSSMF9)                                 
         DC    AL1(23),X'02',CL2'00',A(DDSSMFA)                                 
         DC    AL1(24),X'02',CL2'00',A(DDSKEY)                                  
         DC    AL1(25),X'02',CL2'00',A(DDSSMFB)                                 
         DC    AL1(26),X'02',CL2'00',A(DDSSMFC)                                 
         DC    AL1(27),X'00',CL2'00',A(DATASPC2)   ?                            
         DC    AL1(28),X'00',CL2'00',A(DATASPC3)   ?                            
         DC    AL1(29),X'00',CL2'00',A(DATASPC4)   ?                            
         DC    AL1(30),X'00',CL2'00',A(DDSEXPN4)   DYNAMIC UPDATE?              
         DC    AL1(31),X'02',CL2'00',A(DDSSMFD)    RUNNER SMF RECORD            
         DC    AL1(32),X'00',CL2'00',A(0)                                       
         DC    AL1(33),X'00',CL2'00',A(0)                                       
         SPACE 5                                                                
QUIKEXIT SVC   3              RETURN                                            
         EJECT                                                                  
LOADER   EQU      *                                                             
         USING    TCB,R4                                                        
         USING    CVT,R3                                                        
         L        R3,CVTGDA      GET ADDRESS OF GDA                             
         DROP     R3                                                            
         USING    GDA,R3                                                        
*                                                                     *         
*   SWITCH IMMEDIATELY TO THE CALLER'S KEY AND PERFORM ALL FUNCTIONS  *         
*                                                                     *         
         MODESET  EXTKEY=TCB,WORKREG=8                                          
         DROP     R4             DONE WITH TCB                                  
         L        R0,DATALNG     GET LENGTH NEEDED                              
         GETMAIN  R,LV=(0)       OBTAIN WORK AREA STORAGE                       
         LR       R11,R1         SAVE WORK AREA                                 
         USING    DATA,R11                                                      
         ST       R13,SAVE13     SAVE REG13                                     
         LA       R13,SAVE       CREATE NEW SAVE AREA                           
         ST       R2,INPUTR1     SAVE USER'S REG1                               
         MVI      AUTHFLG,AUTHOFF                                               
*                                                                               
         MVC      ESTAGM(ESTALNG),ESTAAREA                                      
         LA       R1,ESTAGM                                                     
         ESTAE ABENDEX,CT,TERM=NO,RECORD=YES,PARAM=(R5),MF=(E,(R1))             
*                                                                               
         L        EPNREG,0(R2)  PICK UP ENTRY POINT POINTER                     
*                                                                               
*     TARGET ADDRESS VALIDATION - MUST BE IN PRIVATE AREA, USER KEY             
*                                                                               
         L        TGTREG,8(R2)  PICK UP TARGET ADDRESS FOR LOAD                 
         B        SKIP                                                          
         LA       R4,PVTASTAR                                                   
         O        R4,HIBITON                                                    
         BASSM    R1,R4          GO TO 31 BIT MODE                              
PVTASTAR L        R5,PASTRT      GET START OF PRIVATE AREA FROM GDA             
         LR       R4,R5                                                         
         A        R4,PASIZE      DETERMINE TOP OF PRIVATE                       
         DROP     R3             END USE OF GDA                                 
         LA       R3,COMPAR1     GET A 31 BIT ADDRESS                           
         N        R3,HIGHOFF     SWITCH IT TO 24 BIT MODE                       
         BASSM    R1,R3                                                         
COMPAR1  CR       TGTREG,R5      COMPARE TARGET ADDRESS WITH PRIVATE            
         BL       BADTGT                                                        
         CR       TGTREG,R5      COMPARE WITH UPPER BOUND                       
         BH       BADTGT                                                        
SKIP     EQU      *                                                             
*                                                                               
*     TARGET ADDRESS IS IN PRIVATE AREA, NOW SEE IF USER CAN WRITE              
*     INTO IT, IF CANT THIS ROUTINE WILL ABEND.                                 
*                                                                               
         MVI      0(TGTREG),X'FF' STORE INTO AREA                               
         SPACE    1                                                             
*                                                                               
*     PROCESS THE DCB AND ASSOCIATED MMB                                        
*                                                                               
         L        DCBREG,4(R2)  PICK UP DCB ADDRESS                             
         USING    IHADCB,DCBREG                                                 
         TM       DCBOFLGS,X'10' IS DCB OPEN?                                   
         BZ       NOTOPEN        ERROR IF NOT                                   
         DEBCHK   (DCBREG),TYPE=VERIFY,BRANCH=NO                                
         LTR      RF,RF          IS DEB VALID                                   
         BNZ      BADDEB         EXIT IF NOT                                    
         ICM      R5,7,DCBDEBA   GET 3 BYTE DEB ADDRESS                         
         USING    DEBBASIC,R5                                                   
         TM       DEBFLGS1,DEBAPFIN   THIS DATA SET AUTHORIZED ?                
         DROP     DCBREG                                                        
         BNZ      AUTHOK         AUTHORIZED LIBRARY                             
         MODESET  EXTKEY=DATAMGT,SAVEKEY=(2)                                    
         OI       DEBFLGS1,DEBAPFIN   AUTHORIZE DS                              
         MODESET  KEYADDR=(2)                                                   
         MVI      AUTHFLG,DEBMOD  REMEMBER DEB HAS BEEN MODIFIED                
*                                                                               
AUTHOK   MVC      LOADGM(LOADLNG),LOADAREA   COPY LOAD PARM LIST                
         LA       R2,LOADGM                  GET PTR TO PARM LIST               
         LOAD     EPLOC=(EPNREG),DCB=(DCBREG),ADDR=(TGTREG),           X        
               SF=(E,(R2)),ERRET=LOADERR                                        
         CLI      AUTHFLG,DEBMOD  WAS DEB MODIFIED?                             
         BNE      RECORD         SKIP IF NOT MODIFIED                           
         MODESET  EXTKEY=DATAMGT,SAVEKEY=(2)                                    
         NI       DEBFLGS1,APFOFF     RETURN TO NON-AUTH                        
         MODESET  KEYADDR=(2)                                                   
         MVI      AUTHFLG,DEBREST  INDICATE DEB HAS BEEN RESTORED               
RECORD   EQU      *                                                             
         LR       R4,R0          PRESERVE LOAD RESULTS                          
         LR       R5,R1          ACCROSS SYSTEM FUNCTIONS                       
         BAL      R2,GETSSCT                                                    
         SR       R8,R8          SET RETURN CODE REGISTER TO ZERO               
*                                                                               
*** CHANGED TO USE R3 INSTEAD OF R2  FOR TESTING                                
EXIT     L        R3,DATALNG     GET LENGTH NEEDED                              
         L        R9,SAVE13      GET ORIGINAL 13 BEFORE FREEMAIN                
         FREEMAIN R,LV=(R3),A=(R11),SP=0 FREE DYNAMIC AREA                      
         MODESET  EXTKEY=ZERO    RETURN TO SUPERVISOR KEY                       
         ESTAE    0                                                             
         LR       R0,R4          PROPAGATE LOAD RESULTS TO USER                 
         LR       R1,R5                                                         
         LR       R13,R9         RESTORE CALLERS REG 13                         
         LR       R15,R8         SET RETURN CODE                                
         B        QUIKEXIT       RETURN                                         
         EJECT                                                                  
         DS       0F                                                            
HIBITON  DC       X'80000000'                                                   
HIGHOFF  DC       X'7FFFFFFF'                                                   
**                                                                              
**   THIS SUBROUTINE BUILDS THE NECESSARY CONTROL BLOCKS AND THEN               
**   ISSUES A VERIFY SUBSYSTEM SSI CALL FOR THE '#DDS' SUBSYSTEM                
**   TO GET THE USER FIELD FROM THE SSCT.                                       
**                                                                              
**                                                                              
GETSSCT  LA    R7,SSIBAREA      GET ADDRESS OF SSIBAREA                         
         USING SSIB,R7                                                          
         MVC   SSIBID,MYSSIBID  INSERT SSIB IDENT                               
         LA    R8,SSIBSIZE(0)   GET SSIB LENGTH                                 
         STH   R8,SSIBLEN       SET SSIB LENGTH INTO SSIB                       
         MVC   SSIBSSNM,MSTRID  INDENTIFY MASTER SUBSYSTEM                      
DDSSUBS  MVC   SSIBJBID,DDSSSI  STORE DDS SUBSYSTEM NAME                        
         SPACE                                                                  
MAKESSOB LA    R6,SSOBAREA      GET ADDRESS OF SSOB STORAGE                     
         USING SSOB,R6                                                          
         LA    R8,SSVSSIZE(0)   GET SSVS LENGTH                                 
         STH   R8,SSVSLEN       SET SSVS LENGTH INTO SSOB                       
         SPACE                                                                  
         MVC   SSOBID,MYSSOBID                                                  
         LA    R8,SSOBHSIZ(0)                                                   
         STH   R8,SSOBLEN       SET SSOB LENGTH                                 
         LA    R8,SSOBVERS(0)   GET VERIFY FUNCTION CODE                        
         STH   R8,SSOBFUNC                                                      
         LA    R8,SSVSBGN                                                       
         ST    R8,SSOBINDV      POINT TO SSVS                                   
         ST    R7,SSOBSSIB      POINT TO SSIB                                   
         ST    R6,SSOBPTR       POINT TO SSOB                                   
         LA    R1,SSOBPTR       GET ADDRESS OF SSOB POINTER                     
         IEFSSREQ               ISSUE SSI REQUEST                               
         DROP  R7               DONE WITH SSIB                                  
         SPACE                                                                  
         SR    R7,R7            CLEAR REG                                       
         LTR   RF,RF            TEST SSI RETURN CODE                            
         BNE   EXITSSI          RF IS NON-ZERO PASS IT BACK TO CALLER           
         LA    R1,SSVSSNAM(0,0) GET SUCCESSFUL RETURN CODE                      
         C     R1,SSOBRETN      IS IT A SUBSYSTEM?                              
         BNE   EXITSSI2                                                         
         L     R8,SSVSSCTP      GET SSCT ADDRESS                                
         USING SSCT,R8          ADDRESSIBILITY ON SSCT                          
         L     R7,SSCTSUSE      GET SUBSYSTEM OWNED FIELD                       
EXITSSI  BR    R2               RETURN TO CALLER                                
EXITSSI2 LA    RF,128           SET RETURN CODE                                 
         BR    R2               RETURN TO CALLER                                
**   FOLLOWING CODE APPEARS NOT TO BE IN USE  5/12/99                           
         USING DDSCOMON,R7                                                      
         MODESET  EXTKEY=ZERO,SAVEKEY=(2)                                       
         L     R9,CNTLOAD                                                       
         LA    R9,1(R9)                                                         
         ST    R9,CNTLOAD                                                       
         MODESET  KEYADDR=(2)                                                   
         DROP  R7                                                               
         SPACE    3                                                             
         LH       RF,=H'4'                                                      
         B        ABENDIT                                                       
NOTOPEN  LH       R15,=H'8'                                                     
         B        ABENDIT                                                       
*                     COULD NOT ESTABLISH AN ESTAE - ABEND                      
ESTAEER  LR       R2,R15         SAVE ERROR RETURN CODE                         
         LH       R15,=H'12'     INDICATE ESTAE PROBLEM                         
         B        ABENDIT                                                       
         SPACE    2                                                             
BADTGT   LH       R15,=H'20'     TARGET ADDRESS NOT IN ALLOWABLE RANGE          
         B        ABENDIT                                                       
         SPACE    2                                                             
BADDEB   LR       R2,R15         SAVE DEBCHECK RETURN CODE                      
         LH       R15,=H'24'     DEB CHECK FAILED                               
         B        ABENDIT                                                       
         SPACE    2                                                             
*                                                                               
*                     LOAD FUNCTION FAILED - TELL USER                          
*                                                                               
LOADERR  LR       R4,R0          PRESERVE REG 0                                 
         LR       R5,R1          PRESERVE REG 1                                 
         LR       R6,R15         PRESERVE REG 15                                
         LH       R8,=H'16'                                                     
         B        EXIT           GO TO COMMON RETURN POINT                      
ABENDIT  LR       R2,R15         SAVE REG 15  IN WORK REG                       
         ESTAE   0               CANCEL THE RECOVERY ENVIRONMENT                
         LR       R15,R2                                                        
         L        R2,INPUTR1     PUT USER'S REG1 INTO R2 FOR DUMP               
ABEND3   LH       R1,ABENDCDE                                                   
         ABEND    (R1),DUMP,STEP,SYSTEM                                         
         EJECT                                                                  
*                                                                               
*                                                                               
*         SECTION FOR HANDLING CACHE PROCESSING OF DEB                          
*                                                                               
*                                                                               
         USING RBBASIC,R5                                                       
CACHECTL SAC   0                                                                
         SYSSTATE ASCENV=P                                                      
         L     R8,RBLINK                                                        
*NOP     WTO   'TYPE X ENTRY FOUND'                                             
         DROP  R5                                                               
         USING RBBASIC,R8                                                       
         L     R4,RBOPSW+4                                                      
         N     R4,HIBITON      GET JUST BIT 31 FROM CALLERS PSW                 
         BNZ   CACHE31B        31 BIT MODE BRANCH                               
         DROP  R8                                                               
         LR    R1,R2           AVOID AR 2                                       
         N     R1,CLEARHOB     24 BIT CALLER, 0 HIGH ORDER BYTE                 
         L     DCBREG,0(R1)    PICKUP DCB POINTER                               
         N     DCBREG,CLEARHOB FORCE IT TO BE 24 BIT                            
         LHI   RF,20                                                            
**       DC    H'0'                                                             
         B CACHE2                                                               
CACHE31B L     DCBREG,0(R2)    GET A 31BIT DCB ADDRESS                          
CACHE2   SAC   0                                                                
*NOP     WTO   'TYPE 4 ENTRY FOUND'                                             
         SYSSTATE ASCENV=P                                                      
         L     R0,DATALNG    GET LENGTH NEEDED                                  
         GETMAIN R,LV=(0)       OBTAIN WORK AREA STORAGE                        
         LR    R11,R1          SAVE WORK AREA                                   
         USING DATA,R11                                                         
         ST    R13,SAVE13     SAVE REG13                                        
         LA    R13,SAVE       CREATE NEW SAVE AREA                              
         MVI   AUTHFLG,AUTHOFF                                                  
         USING IHADCB,DCBREG                                                    
         DEBCHK (DCBREG),TYPE=VERIFY,BRANCH=NO                                  
         LTR   RF,RF                                                            
         BNZ   BADDEB                                                           
         LHI   RF,30                                                            
         ICM   R5,7,DCBDEBA      GET 3 BYTE DEB ADDRESS                         
         USING DEBBASIC,R5                                                      
         ICM   R6,7,DEBAPPB      GET DEB APPENDAGE ADDRESS                      
         USING DEB,R6                                                           
         L     R7,DEBXTNP        GET DEB EXTENSION ADDRESS                      
         DROP  R6                                                               
         USING DEBXTN,R7                                                        
         MODESET EXTKEY=DATAMGT,SAVEKEY=(2)                                     
* DEB IS VALID, NOW MODIFY IT AS REQUIRED BY INPUT PARM REG3                    
         CHI      R3,1             LOAD MODE REQUEST?                           
         BNE      SEQMODE                                                       
         MVI      DEBGATTR,DEBICACH  INHIBIT CACHE LOADING                      
         B        CONT2                                                         
SEQMODE  MVI      DEBGATTR,DEBSCACH   SET FOR SEQUENTIAL ACCESS                 
CONT2    OI       DEBDEFG1,DEBXVDEF   INDICATE BYTE VALID                       
         MODESET  EXTKEY=ZERO    RETURN TO SUPERVISOR KEY                       
         SR       R4,R4                                                         
         SR       R5,R5                                                         
         SVC      3    TEST****                                                 
         B        EXIT           RETURN                                         
         EJECT                                                                  
*                                                                               
*                                                                               
*         SECTION FOR HANDLING SRM SWAP CONTROLS                                
*                                                                               
*                                                                               
SRMNSWAP LR       R2,R0            SAVE FUNC CODE REG                           
         SYSEVENT DONTSWAP                                                      
         B        TESTRET                                                       
         SPACE                                                                  
SRMOK    EQU      *                                                             
         LR       R2,R0            SAVE FUNC CODE REG                           
         SYSEVENT OKSWAP                                                        
         SPACE 3                                                                
TESTRET  EQU      *                                                             
         N        R1,=X'000000FF'  GET JUST 3RD BYTE FOR RETURN CODE            
         LTR      R1,R1           CHECK RETURN CODE                             
         BNZ      SRMABEND                                                      
         B        QUIKEXIT                                                      
SRMABEND EQU      *                                                             
         LR       R3,R1                                                         
         B        ABEND3                                                        
         EJECT                                                                  
*                                                                               
*                                                                               
*         SECTION FOR WRITING DDS' SMF RECORDS                                  
*                                                                               
DDSEOJ   EQU      *               HANDLE END OF 'DDS JOB'                       
         B        QUIKEXIT                                                      
*                                                                               
DDSSMF   EQU      *               R0 = -6                                       
         L        RF,VFWRSMF                                                    
**       LTR      RF,RF                                                         
**       B        LFWRSMF                                                       
         BASR     RE,RF                                                         
         B        QUIKEXIT                                                      
*FWRSMF  LINK     EP=FWRSMF       GO TO SMF RECORD WRITING ROUTINE              
         B        QUIKEXIT                                                      
***                                                                             
DDSSMF2  EQU      *               R0 = -10, RECORD REQUEST DATA                 
         L        RF,VFWRSMF2                                                   
**       LTR      RF,RF                                                         
**       B        LFWRSMF2  8/26/07 TEMP DISABLE                                
         BASR     RE,RF                                                         
         B        QUIKEXIT                                                      
**WRSMF2 LINK     EP=FWRSMF2      GO TO SMF RECORD WRITING ROUTINE              
         B        QUIKEXIT                                                      
***                                                                             
DDSSMF3  EQU      *                                                             
         B        QUIKEXIT        NOT USED                                      
         LTR      RF,RF                                                         
         B        LFWRSMF7  8/26/07 TEMP DISABLE                                
         BASR     RE,RF                                                         
LFWRSMF7 LINK     EP=FWRSMF7      GO TO SMF RECORD WRITING ROUTINE              
         B        QUIKEXIT                                                      
***                                                                             
DDSENQ   EQU      *      R0 = -13,ENQ/DEQ PROCESSING                            
         L        RF,VFWRSMF3                                                   
**       LTR      RF,RF                                                         
**       B        LFWRSMF3 8/26/07 TEMP DISABLE                                 
         BASR     RE,RF                                                         
         B        QUIKEXIT                                                      
**WRSMF3 LINK     EP=FWRSMF3      GO TO SMF RECORD WRITING ROUTINE              
**       B        QUIKEXIT                                                      
***                                                                             
DDSMNSN1 EQU      *               R0 = -14, MONSOON PROCESSING                  
         L        RF,VFWRSMF4                                                   
**       LTR      RF,RF                                                         
**       B        LFWRSMF4        8/26/07 TEMP DISABLE                          
         BASR     RE,RF                                                         
         B        QUIKEXIT                                                      
**WRSMF4 LINK     EP=FWRSMF4      GO TO SMF RECORD WRITING ROUTINE              
**       B        QUIKEXIT                                                      
***                                                                             
DDSMNSN2 EQU      *               R0 = -15, MONSOON PROCESSING                  
         L        RF,VFWRSMF5                                                   
**       LTR      RF,RF                                                         
**       B        LFWRSMF5        8/26/07 TEMP DISABLE                          
         BASR     RE,RF                                                         
         B        QUIKEXIT                                                      
**WRSMF5 LINK     EP=FWRSMF5      GO TO SMF RECORD WRITING ROUTINE              
**       B        QUIKEXIT                                                      
***                                                                             
DDSMNSN3 EQU      *               MONSOON PROCESSING                            
         L        RF,VFWRSMF6                                                   
         LTR      RF,RF                                                         
**       B        LFWRSMF6        8/26/07 TEMP DISABLE                          
**       BASR     RE,RF                                                         
         B        QUIKEXIT                                                      
**WRSMF6 LINK     EP=FWRSMF6      GO TO SMF RECORD WRITING ROUTINE              
**       B        QUIKEXIT                                                      
DDSINIT  EQU      *               MONSOON PROCESSING                            
         LINK     EP=FWRSMFI      GO TO SMF RECORD WRITING ROUTINE              
         B        QUIKEXIT                                                      
TRXACCNT EQU      *   R0 = -20,   GENERAL/UTILITY RECORD                        
         L        RF,VFWRSMF8                                                   
**       LTR      RF,RF                                                         
**       B        LFWRSMF8        8/26/07 TEMP DISABLE                          
         BASR     RE,RF                                                         
         B        QUIKEXIT                                                      
**WRSMF8 LINK     EP=FWRSMF8      GO TO SMF RECORD WRITING ROUTINE              
**       B        QUIKEXIT                                                      
DDSABEND EQU      *               ABEND A TCB                                   
         LINK     EP=FWRABEND     GO TO CALLRTM SUBROUTINE                      
DDSJES   EQU      *                                                             
         LINK     EP=FWRJES       GO TO JES STATUS ROUTINE                      
         B        QUIKEXIT                                                      
DDSJEST  DC       CL8'FWRJES'                                                   
TAPEBLP  EQU      *                                                             
         LINK     EP=FWRBLP       GO TO BLP TAPE ALLOC ROUTINE                  
         B        QUIKEXIT                                                      
NMLCACHE EQU      *               SET CACHING CONTROL TO NORMAL                 
         LINK     EP=FWRCACHE     GO TO CACHE CNTL ROUTINE                      
         B        QUIKEXIT                                                      
DATASPC  EQU      *               DATASPACE SERVICES                            
         USING    RBBASIC,R5                                                    
         L        R8,RBLINK                                                     
         DROP     R5                                                            
         USING    RBBASIC,R8                                                    
         L        R4,RBOPSW+4                                                   
         N        R4,HIBITON      GET JUST BIT 31 FROM CALLERS PSW              
         BNZ      DATASPCB                                                      
         DROP     R8                                                            
         N        R1,CLEARHOB     24 BIT CALLER, 0 HIGH ORDER BYTE              
DATASPCB L        RF,DSPCRTN1     CHECK IF ROUTINE IS LINKED IN                 
         LTR      RF,RF                                                         
         BZ       LINK21          NO - THEN LINK TO IT                          
         BASR     RE,RF                                                         
         B        QUIKEXIT                                                      
LINK21   LINK     EP=FWRDSPC1     GO TO DATASPACE SERVICES ROUTINE              
         B        QUIKEXIT                                                      
DATASPC2 EQU      *               DATASPACE SERVICES                            
**   REGS R1 & R2 HAVE INPUT PARM AT THIS POINT                                 
**  HAVE TO DEAL WITH THE RE-ENTRANCY CONSIDERATIONS                            
         STORAGE  OBTAIN,LENGTH=500                                             
         LR    R4,R1                                                            
         USING RELOAREA,R4                                                      
         MVC   DCBRELO(LOADDCBL),LOADDCB                                        
         LA    R5,DCBRELO         DCB ADDRESS                                   
         MVC   OPENRELO(OPENLFL),OPENLF                                         
         LA    R6,OPENRELO        LISTFORM                                      
         OPEN  (R5),MF=(E,(R6))                                                 
*                                                                               
         MVC   LINKRELO(LOADLFL),LOADLF                                         
         LA    R6,LINKRELO                                                      
         LR    R1,R2                                                            
         LINKX EP=FWRDSPC1,       GO TO DATASPACE SERVICES ROUTINE     X        
               DCB=(R5),SF=(E,(R6))  FOUND IN SPECIFED LIBRARY                  
         DROP  R4                                                               
DATASPC3 EQU   *                                                                
         B     QUIKEXIT                                                         
BADSSCT  LA    R1,1001                                                          
         B     ABENDIT                                                          
NOUSE    LA    R1,1002                                                          
         B     ABENDIT                                                          
NOTINIT  LA    R1,1003                                                          
         B     ABENDIT                                                          
SPC3A    DS    0H                                                               
         LINK  EP=FWRDSPC1     GO TO DATASPACE SERVICES ROUTINE                 
         SPACE 2                                                                
         B     QUIKEXIT                                                         
         DROP  R9,RB           DONE WITH DYNAMIC AREA & DDSVT                   
DATASPC4 EQU   *                                                                
**                   R1 IS ASSUMED TO HAVE PARM LIST AT THIS POINT              
         L     RF,DSPCRTN                                                       
         BASR  RE,RF                                                            
         B     QUIKEXIT                                                         
**       WXTRN    FWRDSPC1                                                      
DSPCRTN  DC    V(FWRDSPC1)                                                      
*        WXTRN FWRSMF                                                           
VFWRSMF  DC    V(DDSSMF)               ENTRYPOINT NOT ALIAS                     
VFWRSMF2 DC    V(FWRSMF2)                                                       
VFWRSMF3 DC    V(FWRSMF3)                                                       
VFWRSMF4 DC    V(FWRSMF4)                                                       
VFWRSMF5 DC    V(FWRSMF5)                                                       
VFWRSMF6 DC    V(FWRSMF6)                                                       
**WRSMF7 DC    V(FWRSMF7)                                                       
VFWRSMF8 DC    V(FWRSMF8)                                                       
VFWRSMF9 DC    V(FWRSMF9)                                                       
VFWRSMFA DC    V(FWRSMFA)                                                       
VFWRSMFB DC    V(FWRSMFB)                                                       
RUNNERSM DC    V(RUNSMFR)                                                       
**                                                                              
DDSSMF9  EQU      *       R0= -22 DARE SMF RECORD - SUBTYPE 6                   
         L        RF,VFWRSMF9                                                   
         BASR     RE,RF                                                         
         B        QUIKEXIT                                                      
**       LINK     EP=FWRSMF9      GO TO SMF RECORD WRITING ROUTINE              
**       B        QUIKEXIT                                                      
DDSSMFA  EQU      *          R0= -23, FILE BALANCING SMF RECORD                 
         L        RF,VFWRSMFA         SUBTYPE  7                                
         BASR     RE,RF                                                         
         B        QUIKEXIT                                                      
**       LINK     EP=FWRSMFA      GO TO SMF RECORD WRITING ROUTINE              
         B        QUIKEXIT                                                      
DDSSMFB  EQU      *                                                             
         L        RF,VFWRSMFB    SUBTYPE 9 TO REPLACE 1, 2 &                    
**       LTR      RF,RF          POSSIBLY MORE                                  
         BASR     RE,RF                                                         
         B        QUIKEXIT                                                      
LFWRSMFB LINK     EP=FWRSMFB      GO TO SMF RECORD WRITING ROUTINE              
         B        QUIKEXIT                                                      
DDSSMFC  EQU      *               EXPANSION SMF RECORD                          
         USING    RBBASIC,R5      ALIAS FOR FWRSMF8                             
         L        R8,RBLINK                                                     
         DROP     R5                                                            
         USING    RBBASIC,R8                                                    
         L        R4,RBOPSW+4                                                   
         N        R4,HIBITON      GET JUST BIT 31 FROM CALLERS PSW              
         BNZ      DDSSMFCB                                                      
         DROP     R8                                                            
         N        R1,CLEARHOB     24 BIT CALLER, 0 HIGH ORDER BYTE              
DDSSMFCB L        RF,VFWRSMF8                                                   
         LTR      RF,RF                                                         
         BZ       LINKSMF8                                                      
         BASR     RE,RF                                                         
         B        QUIKEXIT                                                      
LINKSMF8 LINK     EP=FWRSMF8      GO TO SMF RECORD WRITING ROUTINE              
         B        QUIKEXIT                                                      
DDSSMFD  EQU      *       R0= -31, SMF RECORD FOR RUNNER                        
         USING    RBBASIC,R5                                                    
         L        R8,RBLINK                                                     
         DROP     R5                                                            
         USING    RBBASIC,R8                                                    
         L        R4,RBOPSW+4                                                   
         N        R4,HIBITON      GET JUST BIT 31 FROM CALLERS PSW              
         BNZ      DDSSMFDB                                                      
         DROP     R8                                                            
         N        R1,CLEARHOB     24 BIT CALLER, 0 HIGH ORDER BYTE              
DDSSMFDB L        RF,RUNNERSM        R0 = -                                     
         BASR     RE,RF              SUBTYPE 10                                 
         B        QUIKEXIT                                                      
DDSKEY   EQU      *               STORAGE KEY PROCESSING                        
         LINK     EP=FWRKEYA      GO TO SUBROUTINE FOR THIS (TEMP)              
         B        QUIKEXIT                                                      
         SPACE                                                                  
DDSEXPN1 EQU      *               EXPANSION / DEVELOPMENT                       
         LINK     EP=FWREXPN1     GO TO EXPANSION/DEVELOPMENT RTN               
         B        QUIKEXIT                                                      
         SPACE                                                                  
DDSEXPN2 EQU      *               EXPANSION / DEVELOPMENT                       
         LINK     EP=FWREXPN2     GO TO EXPANSION/DEVELOPMENT RTN               
         B        QUIKEXIT                                                      
         SPACE                                                                  
DDSEXPN3 EQU      *               EXPANSION / DEVELOPMENT                       
         LINK     EP=FWREXPN3     GO TO EXPANSION/DEVELOPMENT RTN               
         B        QUIKEXIT                                                      
         SPACE                                                                  
DDSEXPN4 EQU    *               EXPANSION / DEVELOPMENT                         
         L      R5,16             GET CVT  FROM 10 HEX                          
         USING  CVTMAP,R5                                                       
         L      R5,CVTSMCA        GET SMCA                                      
         CLC    SMCASID-SMCABASE(R5),=C'SYT '    TEST LPAR ID                   
         BNE    QUIKEXIT                                                        
         DC     H'0'                                                            
         DROP   R5                                                              
         USING    RBBASIC,R5                                                    
         L        R8,RBLINK                                                     
         DROP     R5                                                            
         USING    RBBASIC,R8                                                    
         L        R2,RBOPSW                                                     
         L        R3,RBOPSW+4                                                   
         L        R4,RBOPSW+4                                                   
         N        R4,HIBITON      GET JUST BIT 31 FROM CALLERS PSW              
         DC       H'0'                                                          
         B        QUIKEXIT                                                      
CLEARHOB DC       X'00FFFFFF'                                                   
DSPCRTN1 DC       V(FWRDSPC1)                                                   
SMF9     DC       V(FWRSMF9)                                                    
         EJECT                                                                  
*                     THIS IS THE ESTAE ROUTINE                                 
* SHOULD TAKE A DUMP HERE                                                       
*                                                                               
ABENDEX  DS       0H                                                            
         BASR     RC,0                                                          
         USING    *,RC                                                          
*NOP     CH       R0,NOSDWACD   DID WE GET AN SDWA?                             
         BE       NOSDWA                                                        
         LR       R5,RE         SAVE RETURN ADDRESS                             
         LR       R2,R1                                                         
* LOGIC GOES HERE                                                               
         LR       R1,R2                                                         
         SETRP    DUMP=NO,RC=4,FRESDWA=YES,RETADDR=(R6)                         
         BR       R5            RETURN TO MVS                                   
NOSDWA   ESTAE    0                                                             
         DC       H'0'                                                          
         SPACE    3                                                             
         EJECT                                                                  
LOADLF   LINKX    SF=L                                                          
LOADLFL  EQU      *-LOADLF                                                      
OPENLF   OPEN     (,INPUT),MF=L,MODE=24                                         
OPENLFL  EQU      *-OPENLF                                                      
**  HAVE TO DEAL WITH THE RE-ENTRANCY CONSIDERATIONS                            
LOADDCB  DCB   DSORG=PO,MACRF=(R),DDNAME=LOADLIB                                
LOADDCBL EQU   *-LOADDCB                                                        
         SPACE    2                                                             
         EJECT                                                                  
**                                                                              
**      REGISTER CONVENTIONS ARE AS FOLLOWS:                                    
**                                                                              
**       0  WORK                         8   DCBPTR                             
**       1  INPUT PARMS                  9   EP NAME PTR                        
**       2  WORK                        10   TARGET ADDRESS                     
**       3  SVC/CVT/GDA                 11   DYNAMIC DATA AREA                  
**       4  TCB   SAVE                  12   BASE REGISTER                      
**       5  RB    REGS                  13   SAVE AREA                          
**       6                              14                                      
**       7                              15   RETURN CODES                       
**                                                                              
ABENDCDE DC      XL2'0F7'                                                       
ABENDCD2 DC      XL2'2F7'   -- SVC 247 INVALID FUNCTION                         
MODID    DS      0D                                                             
         DC      C'FRED ROE LOAD ROUTINE'                                       
LOADAREA EQU      *                                                             
LOADLIST LOAD     SF=L        GENERATE LIST FORM OF LOAD                        
LOADLNG  EQU      *-LOADAREA  CALCULATE LENGTH FOR LIST FORM AREA               
LOADIT   DC    A(LOADLNG)                                                       
ESTAAREA EQU      *                                                             
         ESTAE   0,MF=L                                                         
ESTALNG  EQU      *-ESTAAREA  CALCULATE LENGTH FOR LIST FORM AREA               
TABLEMAP DSECT                                                                  
ETNRYNO  DS    AL1                                                              
ENTRYTYP DS    XL1                                                              
FLAG1    DS    XL1                                                              
FLAG2    DS    XL1                                                              
ADR2USE  DS    AL4                 ADDRESS TO USE                               
DDSVT    DSECT                                                                  
DDSVTID  DS    CL4                                                              
DDSJOBNM DS    CL8                                                              
DDSJOBID DS    CL8                                                              
DDSCDATE DS    F           DATE OF CREATION                                     
DDSCTIME DS    F           TIME OF CREATION                                     
DDSVTSIZ DS    F           SIZE OF THIS AREA                                    
DDSETRYA DS    A           ADDRESS OF DATASPACE ENTRIES                         
DDSRTN1  DS    A           ADDRESS OF PRELOADED COPY OF THIS MODULE             
         DS    A           EXPANSION 2                                          
DDSVTLEN EQU   *-DDSVT                                                          
DDSARRAY DS    X                                                                
DATA     DSECT                                                                  
SSOBPTR  DS    A                PTR TO SSOB                                     
SSOBAREA DS    XL28             SSOBLN1A SHOULD BE THE EQUATE USED.             
SSIBAREA DS    XL24            SSIB AREA                                        
INPUTR1  DS    1F          COPY OF PASSED VALUE OF REG1                         
SSCTADDR DS    1F                                                               
SAVE13   DS    1F                                                               
SAVE     DS    50F                                                              
AUTHFLG  DS    X                                                                
AUTHOFF  EQU   X'00'                                                            
DEBMOD   EQU   X'EE'                                                            
DEBREST  EQU   X'88'                                                            
LOADGM   DS    XL(LOADLNG)                                                      
ESTAGM   DS    XL(ESTALNG)                                                      
ENDDATA  DS    X                                                                
DDSCOMON DSECT                                                                  
CNTLOAD  DS    1F                                                               
CNTSVC99 DS    1F                                                               
         SPACE 2                                                                
RELOAREA DSECT                                                                  
OPENRELO DS    XL(OPENLFL)                                                      
LINKRELO DS    XL(LOADLFL)                                                      
DCBRELO  DS    XL(LOADDCBL)                                                     
         SPACE 2                                                                
DDSSVC   CSECT                                                                  
SIZE     DC    F'200'                                                           
DATALNG  DC    A(ENDDATA-DATA)                                                  
MYSSIBID DC    C'SSIB'                                                          
MYSSOBID DC    C'SSOB'                                                          
MSTRID   DC    C'MSTR'                                                          
DDSSSI   DC    C'#DDS    '     NAME OF DDS SUBSYSTEM                            
BRREG    EQU    15                                                              
RETREG   EQU    14                                                              
BASEREG  EQU    12                                                              
SAVEREG  EQU    13                                                              
DATAPTR  EQU    5                                                               
R0       EQU    00                                                              
R1       EQU    01                                                              
R2       EQU    02                                                              
R3       EQU    03                                                              
R4       EQU    04                                                              
R5       EQU    05                                                              
R6       EQU    06                                                              
R7       EQU    07                                                              
R8       EQU    08                                                              
R9       EQU    09                                                              
R10      EQU    10                                                              
RA       EQU    10                                                              
R11      EQU    11                                                              
RB       EQU    11                                                              
R12      EQU    12                                                              
RC       EQU    12                                                              
R13      EQU    13                                                              
RD       EQU    13                                                              
R14      EQU    14                                                              
RE       EQU    14                                                              
R15      EQU    15                                                              
RF       EQU    15                                                              
DCBREG   EQU    R8                                                              
EPNREG   EQU    R9                                                              
TGTREG   EQU    RA                                                              
         EJECT                                                                  
         DCBD   DSORG=XA                                                        
         IKJTCB                                                                 
         IHAGDA       GLOBAL DATA AREA                                          
         IHARB                                                                  
         IHASDWA                                                                
**       IHAPSA                                                                 
**       IHASCB                                                                 
         IEZDEB  LIST=NO                                                        
APFOFF   EQU  X'FF'-DEBAPFIN                                                    
         PRINT  NOGEN                                                           
         CVT    DSECT=YES                                                       
         IEESMCA                                                                
         IEFJESCT                                                               
         IEFJSCVT                                                               
         IEFJSSIB                                                               
         IEFJSSOB VS                                                            
**                                                                              
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'001SVCMAIN   04/08/08'                                      
         END                                                                    
