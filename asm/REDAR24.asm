*          DATA SET REDAR24    AT LEVEL 001 AS OF 04/16/10                      
*PHASE T80F24A                                                                  
*&&      SET   DB=N,TK=Y,DT=N,TT=N,CD=Y,CT=N,AM=N,AN=Y,RD=N,XM=N,LP=Y           
*&&      SET   LN=N                                                             
         TITLE 'T80F24 - REDAR24 - DAR REVISION PROCESSING'                     
***********************************************************************         
*                                                                     *         
*  REDAR24 (T80F24) --- DARE REVISION APPROVE/REJECT/AMEND            *         
*                                                                     *         
*  NOTE: R7 IS RESERVED AS BASE REGISTER FOR COMMON ROUTINES          *         
*                                                                     *         
* ------------------------------------------------------------------- *         
* UPDATE HISTORY:                                                     *         
*                                                                     *         
* 24MAR10 KUI SKIP XML OOW FIX FROM 2/4/08 FOR ESPERANTO              *         
* 06NOV08 SKU EPORT/XML SUPPORT                                       *         
* 04FEB08 SKU FIX OOWR FOR XML ORDERS                                 *         
* 09JUL07 SKU DISALLOW UNDARE OF REVISIONS                            *         
* 18MAY07 HQ  FIX BUG THAT BREAKS MULTI MAKEGOOD INTO SINGLE LINES    *         
* 14DEC05 HQ  KEEP D0 ELEMENT FOR STATION EXPRESS                     *         
* 28OCT05 HQ  FIX COST OVERRIDE TABLE ENTRY BUG                       *         
* 28JUL05 HQ  FIX OVERRIDE INFORMATION END OF LINE BUG                *         
* 05JUL05 KUI SAVE OFF ACTUAL AGENCY BUY LINK FOR XML ORDERS (2 BYTES)*         
* 29JUN05 HQ  FIX SECOND LINE BUY GRID PRINTING                       *         
* 11APR05 HQ  FIX ZERO SPOT REP BUY LINK SEGMENT PROCESSING           *         
* 08MAR05 HQ  FIX TOTALLY MATCH DAILYS                                *         
* 28FEB05 HQ  FIX LINK SEGMENT KEY LOOKUP                             *         
*             ZERO DOLLAR BONUS MAKEGOOD FIX                          *         
* 04FEB05 HQ  FIX TOTALLY MATCH DAILY BUYS MATCHING LOGIC             *         
* 03JAN05 HQ  FIX BUYGRID COMPARISON WHEN MATCHING BUYS               *         
*             DAILY BUY ENHANCEMENT                                   *         
*             PARTIAL CONFIRM COMMENT FIX                             *         
* 08OCT04 HQ  SUPPRESS FULLY MATCH DAILY BUYS                         *         
* 24SEP04 HQ  FIX PROPOSE MATCH ZERO OUT LINES THAT SHOULD ONLY BE    *         
*             MODIFIED                                                *         
*                                                                     *         
*                    ***  END TOMBSTONE  ***                          *         
* ------------------------------------------------------------------- *         
* EXPLANATION OF TERMINOLOGIES USED:                                  *         
*                                                                     *         
* A BUY SEGMENT IS DEFINED AS SPOT(S) BOUGHT FOR A PARTICULAR WEEK.   *         
* IT HAS THE FOLLOWING FORMAT:                                        *         
* DAY/TIMES/LENGTH/RATE/PROGRAM NAME/WEEK-OF                          *         
*                                                                     *         
* FOR EACH PARTICULAR BUY SEGMENT, THE SEGMENT CAN POINT (LINK) TO    *         
* A MAXIMUM OF TWO BUY-LINK RECORDS, ONE FOR THE REP AND ONE FOR THE  *         
* AGENCY. A BUY-LINK RECORD IS A LIST OF BUY LINES THAT CONTAINS      *         
* SPOTS AS DESCRIBED BY THE ATTACHED BUY SEGMENT. THE LIST ALSO       *         
* INCLUDES THE NUMBER OF SPOTS NEXT TO EACH BUY LINE. IF A BUY        *         
* SEGMENT IS ONLY MATCHED WITH ONE BUYLINE (REP OR AGY), THE ACTUAL   *         
* BUY NUMBER AND SPOTS ARE KEPT IN THE BUY SEGMENT ITSELF IN LIEU OF  *         
* A POINTER TO A BUY-LINK RECORD.                                     *         
* ------------------------------------------------------------------- *         
* DB=DEBUG                                                            *         
* DT=DUMPTSAR                                                         *         
* TT=TESTING                                                          *         
* CD=CONFLICT END DATE                                                *         
* CT=ON=REVERT TO CHANGE BEFORE CONFLICT END DATE                     *         
* AM=AMEND DEFAULT TO N FOR TV,AN=Y FOR TV                            *         
* XM=XML CODE                                                         *         
* RD=CODES FOR RADIO                                                  *         
* LP=Y=LONG PROGRAM NAME                                              *         
* LN=N=LONG PROGRAM NAME                                              *         
* LP=N=SHORT PROGRAM NAME                                             *         
* LN=Y=SHORT PROGRAM NAME                                             *         
* AMEND FEATURE, SET AM=Y,AN=N                                        *         
***********************************************************************         
T80F24   CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 WORKLQ,*T80F24*,RR=R3,CLEAR=Y                                    
         LR    R5,RC                                                            
         USING MYAREAD,R5                                                       
         L     RC,0(R1)            STANDARD CODING                              
         USING GEND,RC                                                          
         LR    R7,RB                                                            
         A     R7,=A(COMMON-T80F24)                                             
         USING COMMON,R7           COMMON ROUTINES                              
         L     R8,ASPOOLD                                                       
         USING SPOOLD,R8                                                        
         L     RA,ATWA                                                          
         USING CONHEADH-64,RA      BASE SCREEN + OUR SCREEN                     
         L     R9,ASYSD                                                         
         USING SYSD,R9                                                          
         ST    R3,RELO                                                          
TB       USING TSARD,TBLOCK        TSAR BLOCK                                   
TR       USING TLSTD,TSARREC       TSAR RECORD                                  
*                                                                               
*                                                                               
         MVC   PRTSTAT,4(R1)       PRINT STATUS, IF ANY                         
*                                                                               
         CLI   PRTSTAT,0           PRINT REQUESTED                              
         BE    MAIN10                                                           
*                                                                               
         OI    GENSTAT1,RDUPAPPL   ALLOW UPDATE FOR ACTION LIST                 
         B     VALRECRD                                                         
*                                                                               
* INCASE OF RETURN FROM GLOBBER, NEEDS TO RETRANSMIT ENTIRE SCREEN              
*                                                                               
MAIN10   DS    0H                                                               
*&&DO                                                                           
         LR    R4,RA                                                            
         AHI   R4,DARPROFS-CONHEADH                                             
         USING SVDSECT,R4                                                       
         TM    DMISFLGX,X'08'                                                   
         BZ    *+8                                                              
         NI    DMISFLGX,X'FF'-X'10'-X'08' CLEAR "RETURN TO DIFF" FLAG           
         DROP  R4                                                               
*&&                                                                             
*                                                                               
         GOTOR CKGLOB              COME BACK FROM CONTRACT?                     
         MVC   DIFLAST+1(2),=X'0101'                                            
         CLC   =C'DIF',CONACT      IF APP OR REJ                                
         BE    MAIN20              RETRANSMIT DIFFERENT SCREEN                  
         MVC   AORLAST+1(2),=X'0101'                                            
*                                                                               
MAIN20   DS    0H                                                               
         BAS   RE,SETPFKYS         SETUP THE PFKEYS                             
*                                                                               
         CLI   MODE,VALKEY         VALIDATE KEY?                                
         BE    VK                  YES                                          
         CLI   MODE,VALREC         VALIDATE RECORD?                             
         BE    VALRECRD            YES                                          
*                                  NO OTHER ACTIONS RECOGNIZED                  
         B     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* VALIDATE KEY                                                                  
***********************************************************************         
VK       DS    0H                                                               
*&&DO                                                                           
         CLC   =C'AMEND',CONACT                                                 
         BE    VKX                                                              
*                                                                               
VK10     DS    0H                                                               
         CLI   CALLSP,0            MUST BE CALLED TO GET HERE                   
         BNE   VKX                                                              
         LA    R2,CONRECH                                                       
         B     INVLRCAC            INVALID REC/ACTION                           
*&&                                                                             
*                                                                               
VKX      DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* VALIDATE RECORD                                                               
***********************************************************************         
VALRECRD DS    0H                                                               
*                                                                               
         MVC   KEY(L'SELECTKY),SELECTKY                                         
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEYSAVE(27),KEY                                                  
         BNE   RETURN                                                           
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         XC    SVDARFL2,SVDARFL2                                                
         MVC   AIO,AIO1                                                         
         L     R6,AIO                                                           
         MVI   ELCODE,X'0F'                                                     
         BRAS  RE,GETEL                                                         
         BNE   *+10                                                             
         MVC   SVDARFL2,RDARFLG2-RDARFLEM(R6)                                   
*                                                                               
         CLC   =C'#OPEN',CONACT    SPECIAL OPEN ACTION TO BYPASS                
         BNE   VR03                DIFFERENCES LOGIC                            
*                                  JUST SEND OPEN TO AGENCY                     
         GOTOR SENDOPEN                                                         
         B     EXIT                                                             
*                                                                               
VR03     DS    0H                                                               
         CLI   PRTSTAT,0                                                        
         BNE   VR10                                                             
         MVI   ACTCODE,C'R'        REJECTION/AMEND?                             
         MVI   MYSCRNUM,X'F8'      SET SCREEN NUMBER                            
         CLC   =C'REJ',CONACT                                                   
         BE    VR10                                                             
*                                                                               
VR05     DS    0H                                                               
         MVI   ACTCODE,0                                                        
         MVI   MYSCRNUM,X'EB'                                                   
         B     VR13                                                             
*                                                                               
VR10     DS    0H                                                               
*&&XM                                                                           
         TM    SVDARFL2,SF2XML                                                  
         BZ    VR13                                                             
         CLI   PRTSTAT,0                                                        
         BNE   VR13                                                             
*                                                                               
         TM    AORREASH+4,X'80'    FIELD INPUT THIS TIME?                       
         BO    VR10010             YES                                          
         TM    AORREASH+4,X'40'    FIELD INPUT BEFORE?                          
         BO    VR10010             YES                                          
         MVC   AORREAS(XMLMS1Q),XMLMS1   MUST BE FIRST TIME IN                  
*                                                                               
VR10010  DS    0H                                                               
         TM    AORREA2H+4,X'80'                                                 
         BO    VR10020                                                          
         TM    AORREA2H+4,X'40'                                                 
         BO    VR10020                                                          
         MVC   AORREA2(XMLMS2Q),XMLMS2                                          
*                                                                               
VR10020  DS    0H                                                               
         LA    R2,AORREA2H         THIRD LINE                                   
         ZIC   R1,0(R2)                                                         
         AR    R2,R1                                                            
         TM    4(R2),X'80'                                                      
         BO    VR10025                                                          
         TM    4(R2),X'40'                                                      
         BO    VR10025                                                          
         MVC   8(XMLMS3Q,R2),XMLMS3                                             
*                                                                               
VR10025  DS    0H                  FORTH LINE                                   
         ZIC   R1,0(R2)                                                         
         AR    R2,R1                                                            
*                                                                               
         TM    4(R2),X'80'                                                      
         BO    VR10030                                                          
         TM    4(R2),X'40'                                                      
         BO    VR10030                                                          
         MVC   8(XMLMS4Q,R2),XMLMS4                                             
*                                                                               
VR10030  DS    0H                                                               
         LA    RE,AORREASH         Turn on lower case to make                   
         LA    RF,AORENDH          consistent STYLE                             
VR04040  DS    0H                                                               
         CR    RE,RF                                                            
         BE    VR04050                                                          
         OI    1(RE),X'40'                                                      
         OI    6(RE),X'80'         XMIT                                         
         ZIC   R1,0(RE)                                                         
         AR    RE,R1                                                            
         B     VR04040                                                          
VR04050  DS    0H                                                               
*&&                                                                             
VR13     DS    0H                                                               
         TM    PRTSTAT,PRTCLOSE    CLOSE THE PRINTQ?                            
         BO    VR50                NO                                           
*                                                                               
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
*                                                                               
         LR    R4,RA               USE R2 TO COVER THE ENTRY                    
         AHI   R4,DARPROFS-CONHEADH                                             
         USING SVDSECT,R4                                                       
         TM    DMISFLGX,X'40'      AM I MASTER?                                 
         BZ    VR15                                                             
         MVC   TWAAGY,RDARKREP     YES, GET ACTUAL SUB REP CODE                 
         MVC   AGENCY,RDARKREP                                                  
         DROP  R4                                                               
*                                                                               
VR15     DS    0H                                                               
         CLI   PFKEY,10            APPROVE?                                     
         BNE   VR20                                                             
         CLI   RDARBSTS,C'A'                                                    
         BE    WASAPR                                                           
         B     VR30                                                             
*                                                                               
VR20     DS    0H                                                               
         CLI   PFKEY,11            REJECT?                                      
         BNE   VR30                                                             
         CLI   RDARBSTS,C'R'                                                    
         BE    WASREJ                                                           
*&&AM                                                                           
         CLI   RDARBSTS,C'M'                                                    
         BNE   VR30                                                             
         CLC   =C'UNDARE',AORREAS                                               
         BNE   WASAMD                                                           
*&&                                                                             
*                                                                               
* READ STATION RECORD FOR REVISION AUTO METHOD OVERRIDE, IF ANY                 
* DEFAULT IF ADD SPOT TO NEW LINES                                              
* NOTE THAT METHOD 1, CANCEL AND SUPERSEDE, IS NO LONGER SUPPORTED              
*                                                                               
VR30     DS    0H                                                               
         XC    ELTBUILD,ELTBUILD                                                
         MVC   ELTBUILD+8(4),RDARKSTA                                           
         MVI   ELTBUILD+5,4                                                     
         CLI   RDARKSTA+3,C' '                                                  
         BNE   *+8                                                              
         MVI   ELTBUILD+5,3        IF 3 LETTER CALL LETTERS                     
         MVI   ELTBUILD+2,X'40'    SET ALPHA                                    
         CLI   RDARKSTA+4,C'T'      NO NEED FOR TV BAND                         
         BE    VR35                                                             
         MVI   ELTBUILD+12,C'-'                                                 
         MVC   ELTBUILD+13(1),RDARKSTA+4                                        
         MVI   ELTBUILD+5,6                                                     
         CLI   RDARKSTA+3,C' '                                                  
         BNE   VR35                                                             
         MVC   ELTBUILD+11(2),ELTBUILD+12                                       
         MVI   ELTBUILD+13,0       IF 3 LETTER CALL LETTERS                     
         MVI   ELTBUILD+5,5                                                     
                                                                                
VR35     DS    0H                                                               
         LA    R2,ELTBUILD                                                      
         GOTO1 VALISTA                                                          
*                                                                               
         OC    RDARREP#,RDARREP#   UNLINKED?                                    
         BZ    VR1100                                                           
*                                                                               
         ZAP   WORK+20(5),=P'0'                                                 
         MVO   WORK+20(5),RDARREP#                                              
         XC    ELEM,ELEM                                                        
         LA    R2,ELEM             SETUP FAKE FIELD HEADER                      
         EDIT  (P5,WORK+20),(8,8(R2)),ALIGN=LEFT TO CALL VCON WITH              
         STC   R0,5(R2)            SET LENGTH OF FIELD                          
         MVI   0(R2),16            FIELD HEADER LENGTH                          
         MVI   4(R2),X'08'         SET VALID NUMERIC                            
*                                                                               
VR38     DS    0H                                                               
         GOTO1 VALICON,DMCB,(R2)   GET CONTRACT INFO AND STORE IT               
         GOTOR GETCON              RETRIEVE CONTRACT RECORD                     
         BZ    VR40                EXIT:  NO CONTRACT NUMBER                    
*                                  ERROR IN GETCON:  MESSAGE CODE               
*                                     ALREADY SET IN RERROR                     
         LA    R2,CONACTH          SET CURSOR TO 'ACTION' FIELD                 
         B     INVLCON             EXIT WITH ERROR                              
*                                                                               
VR40     DS    0H                                                               
         CLI   ACTCODE,C'R'        REJECTION?                                   
         BNE   VR45                                                             
         CLI   PFKEY,2             PROCESS REJECTION UNLESS WE ARE              
         BE    VR200               ACTUALLY TRYING TO JUMP TO CONTRACT          
*                                                                               
         CLI   PFKEY,12            RETURN TO CONTRACT                           
         BNE   VR1100              ONLY IF WE CAN HERE W/O                      
         CLI   CALLSP,0            GOING THRU ORDER/LIST/SELECT                 
         BNE   VR1100                                                           
         OI    FLAGS2,FG2FORC                                                   
         B     VR200                                                            
*                                                                               
VR45     DS    0H                                                               
         TM    FLAGS,FGINITQ                                                    
         BO    VR60                                                             
*                                                                               
         GOTOR GETPROF1            GET DARE MATCHING PROFILE                    
*                                                                               
         GOTOR INIT                GENERAL INITIALIZATION DUMP                  
*                                                                               
         GOTOR SETCMTF             SET COMMENT FLAG                             
*                                                                               
         GOTOR SVAGYDEM            SAVE AGENCY DEMO CATEGORIES                  
*                                                                               
         GOTOR SHADOW              CONVERT DARE AGENCY BUYS TO                  
*                                  REPPAK BUYS WITH KEY X'0B01'                 
         GOTOR INITTSAR                                                         
*                                                                               
         GOTOR TABLEBUY            !!! do not use myelem !!!                    
*                                                                               
         GOTOR BLDTSREC            !!! do not use myelem !!!                    
*                                                                               
         GOTOR BLDRPTR,DMCB,(X'40',0) THIS SETS X'80' FOR TLBYFLG3              
*                                  SO THAT MAKEGOOD GROUPS THAT ARE             
*                                  TOTALLY MATCHE WON'T BE BROKEN APART         
         GOTOR BRKMKG              BREAK MUTILPLE MATCH MAKEGOOD                
*                                                                               
         GOTOR SORTSREC            SORT TSREC BY MATCH/UNMATCH/LINKED           
*                                                                               
         GOTOR BLDRPTR,DMCB,(X'40',0) THIS SETS X'80' FOR TLBYFLG3              
*                                  SO THAT PROCLNK CAN PROCESS                  
*                                  DAILYS CORRECTLY                             
                                                                                
         GOTOR PROCLNK             PROCESS LINKED SEGMENT                       
*                                                                               
         GOTOR PROCLNK2            PROCESS LINKED SEGMENT AGAIN                 
*                                                                               
         GOTOR RESORTR             SORT AGAIN                                   
*                                                                               
         GOTOR DAILYMTH            SET DAILY MATCH FLAG                         
*                                                                               
         GOTOR PUTMNUM                                                          
*                                                                               
         GOTOR BLDRPTR,DMCB,0      BUILD REVERSE POINTER                        
*                                                                               
         GOTOR BLDMTAB             BUILD MATCH TABLE                            
*                                                                               
         GOTOR SETDATE,DMCB,EARLIEST SET EARLIEST DATE TO MONDAY                
         MVC   GRSTDATE,EARLIEST                                                
         GOTOR GETFDTE               GET AGENCY FLIGHT DATE                     
*                                                                               
         GOTOR AGYTOT                                                           
*                                                                               
         OI    FLAGS,FGINITQ                                                    
*                                                                               
         CLI   PRTSTAT,0           PRINT WORKSHEET                              
         BE    VR70                                                             
*                                                                               
VR50     DS    0H                                                               
         OI    FLAGS,FGPRTQ                                                     
         OI    OFLAG1,OUMATCHQ+OMATCHQ+OPMATCHQ                                 
*        GOTOR PRDAO,DMCB,(RC)                                                  
         GOTO1 =A(PRDAO),DMCB,(RC),RR=RELO                                      
         NI    FLAGS,X'FF'-FGPRTQ                                               
*        GOTO1 VTOUCHED                                                         
         NI    FLAGS,X'FF'-FGINITQ RESET INCASE OF MULTIPLE PRINTS              
*&&AN                                                                           
         B     EXIT                                                             
*&&                                                                             
*&&AM                                                                           
         CLI   ACTNUM,ACTAMD                                                    
         BNE   EXIT                                                             
         CLI   PFKEY,3             AFTER AMEND SENT TO BUYER                    
         BNE   EXIT                SWAP TO CONTRACT AND SEND                    
         OI    FLAGS2,FG2STAY+FG2SEND   CONTRACT TO STATION                     
         GOTOR SWAP2CON                                                         
         B     EXIT                                                             
*&&                                                                             
VR60     DS    0H                                                               
         GOTOX GOTSAR,TSARES                                                    
*                                                                               
VR70     DS    0H                                                               
         NI    FLAGS2,X'FF'-FG2STAY-FG2RGHT                                     
         GOTOR GETDOPT             GET DISPLAY OPTION                           
*                                                                               
         CLI   PFKEY,2             SWITCH TO CONTRACT                           
         BE    VR200                                                            
         CLI   PFKEY,3             SWTICH TO BUY/LIST SCREEN                    
         BE    VR300                                                            
         CLI   PFKEY,4             SCROLL UP                                    
         BE    VR400                                                            
         CLI   PFKEY,5             PRINT REPORT                                 
         BE    VR500                                                            
         CLI   PFKEY,6             SCROLL BUY GRID RIGHT                        
         BE    VR600                                                            
         CLI   PFKEY,7             EXPAND/SQUEEZE                               
         BE    VR700                                                            
         CLI   PFKEY,8             PREVIEW                                      
         BE    VR800                                                            
         CLI   PFKEY,9             REFRESH                                      
         BE    VR900                                                            
         CLI   PFKEY,10            OPEN REVISION                                
         BE    VR1000                                                           
         CLI   PFKEY,11            REJECT REVISION                              
         BE    VR1100                                                           
*&&AM                                                                           
         CLI   PFKEY,12            RETURN TO CONTRACT                           
         BNE   VR90                                                             
         CLI   CALLSP,0                                                         
         BNE   VR90                                                             
         OI    FLAGS2,FG2STAY                                                   
         B     VR200                                                            
*&&                                                                             
*                                                                               
VR90     DS    0H                                                               
         GOTOR DIFFLIST            RESTORE                                      
         OI    CONRECH+6,X'40'     FORCE CURSOR HERE                            
         NI    FLAGS2,X'FF'-FG2RGHT  CLEAR FLAG                                 
         MVI   PFKEY,0                                                          
         B     VREND                                                            
*                                                                               
         EJECT                                                                  
*---------------------------------------------------------------------*         
* PF2:SWAP TO CONTRACT                                                          
*---------------------------------------------------------------------*         
VR200    DS    0H                                                               
*&&AM                                                                           
         CLI   ACTNUM,ACTAMD       AMEND SUICIDE SWAP TO CONTRACT               
         BNE   *+8                                                              
         OI    FLAGS2,FG2STAY                                                   
*&&                                                                             
*                                                                               
         NI    FLAGS,X'FF'-FGINITQ SET TO REFRESH WHEN WE COME BACK             
         GOTOR SWAP2CON                                                         
         CLI   ACTCODE,C'R'        SAVE TSAR BUFFER UNLESS WE ARE               
         BE    EXIT                IN REJECTION SCREEN                          
         B     VREND                                                            
         EJECT                                                                  
*---------------------------------------------------------------------*         
* PF3:TOGGLE BUYLIST SCREEN AND DIFF SCREEN                                     
*---------------------------------------------------------------------*         
VR300    B     VREND                                                            
         EJECT                                                                  
*---------------------------------------------------------------------*         
* PF4:   SCROLL UP                                                              
*---------------------------------------------------------------------*         
VR400    LH    RF,SCRNUM                                                        
         BCTR  RF,0                                                             
         LTR   RF,RF                                                            
         BZ    VREND                                                            
*                                                                               
VR450    DS    0H                                                               
         OI    FLAGS2,FG2BACK                                                   
*                                                                               
         STH   RF,SCRNUM                                                        
*                                                                               
         NI    DISFLG1,FF-DCONBAKQ                                              
         GOTOR GETSCREC,DMCB,SCRNUM                                             
         BNE   VREND                                                            
D        USING TLSCPTR,DMCB                                                     
         MVC   LISTLAST,D.TLSCPTR                                               
*                                                                               
         TM    D.TLSCFLG,X'40'                                                  
         BZ    *+8                                                              
         OI    DISFLG3,D3ORBAG                                                  
*                                                                               
         TM    D.TLSCFLG,X'80'                                                  
         BZ    VR420                                                            
         OI    DISFLG1,DCONBAKQ                                                 
         MVC   BUY#,D.TLSCBY#                                                   
         MVC   SUBBUY#,D.TLSCSUBL                                               
         MVC   TYP,D.TLSCCTYP                                                   
*                                                                               
VR420    DS    0H                                                               
         MVC   SVTYPE,D.TLSCTYP                                                 
         MVC   DISFLG2,D.TLSCFLG2                                               
         DROP  D                                                                
*                                                                               
         GOTOR DIFFLIST                                                         
         NI    FLAGS2,FF-FG2BACK                                                
         NI    DISFLG1,FF-DCONBAKQ                                              
         B     VREND                                                            
         EJECT                                                                  
*---------------------------------------------------------------------*         
* PF5:REVISION WORKSHEET PRINT                                                  
*---------------------------------------------------------------------*         
VR500    OI    FLAGS,FGPRTQ                                                     
*        GOTOR PRDAO,DMCB,(RC)                                                  
         GOTO1 =A(PRDAO),DMCB,(RC),RR=RELO                                      
         GOTO1 VTOUCHED                                                         
         NI    FLAGS,FF-FGPRTQ                                                  
         LA    R2,CONRECH                                                       
         B     VREND                                                            
*---------------------------------------------------------------------*         
* PF6:   SCROLL RIGHT                                                           
*---------------------------------------------------------------------*         
VR600    GOTOR GETGSTD                                                          
         BNE   VREND                                                            
         OI    FLAGS2,FG2RGHT                                                   
         B     RDISPAGE            RE-DISPLAY PAGE                              
*---------------------------------------------------------------------*         
* PF7:   TOGGLE BETWEEN EXPAND/SQUEEZE VIEW                                     
*---------------------------------------------------------------------*         
VR700    XI    FLAGS2,FG2EXPD                                                   
         CLC   DIFPFLN+37(3),=C'Sqz'                                            
         BNE   VR710                                                            
         MVC   DIFPFLN+37(3),=C'Exp'                                            
         B     VR710X                                                           
VR710    DS    0H                                                               
         MVC   DIFPFLN+37(3),=C'Sqz'                                            
VR710X   DS    0H                                                               
*                                                                               
RDISPAGE DS    0H                                                               
         GOTOR GETSCREC,DMCB,SCRNUM                                             
         BNE   VREND                                                            
         NI    DISFLG1,FF-DCONBAKQ                                              
         TM    DMCB+2,X'80'                                                     
         BZ    *+8                                                              
         OI    DISFLG1,DCONBAKQ                                                 
*                                                                               
         NI    DISFLG3,FF-D3ORBAG                                               
         TM    DMCB+2,X'40'                                                     
         BZ    VR750                                                            
         OI    DISFLG3,D3ORBAG                                                  
VR750    DS    0H                                                               
         MVC   SVTYPE,DMCB+4                                                    
         MVC   DISFLG2,DMCB+5                                                   
*                                                                               
         MVC   LISTLAST,LISTSTRT   REDISPLAY PAGE                               
         B     VR90                                                             
*---------------------------------------------------------------------*         
* PF8:   PREVIEW MATCH                                                          
*---------------------------------------------------------------------*         
VR800    OI    FLAGS,FGPVIEWQ                                                   
         XC    LISTSTRT,LISTSTRT                                                
         XC    LISTLAST,LISTLAST                                                
*                                                                               
         GOTOR PROCSCR                                                          
*                                                                               
         GOTOR PROCSEG             PROCESS SEGMENTS                             
*                                                                               
         GOTOR RESORTR             RE-SORT RECORD                               
*                                                                               
         GOTOR RESORTR             DOUBLE PASS                                  
*                                                                               
         GOTOR PROCLNK2            CLEAN UP LINK RECORD                         
*                                                                               
         GOTOR PUTMNUM                                                          
*                                                                               
         GOTOR BLDRPTR,DMCB,(X'80',0)   BUILD REVERSE POINTER                   
*                                                                               
         MVI   PFKEY,0                                                          
         NI    DISFLG1,FF-D1UNMTHQ                                              
*                                                                               
         B     VR90                                                             
         EJECT                                                                  
*---------------------------------------------------------------------*         
* PF9:   REFRESH                                                                
*---------------------------------------------------------------------*         
VR900    NI    FLAGS,FF-FGINITQ    SET TO REBUILD TSAR RECORDS                  
         XC    SVTYPE,SVTYPE                                                    
         MVI   DISFLG2,0                                                        
         MVI   PFKEY,0                                                          
         XC    DIFATOT,DIFATOT     REDISPLAY TOTAL                              
         NI    DISFLG1,FF-D1UNMTHQ RELEASE LOCK                                 
         B     VR40                                                             
*---------------------------------------------------------------------*         
* PF10: REVISION OPEN PROCESSING                                                
*---------------------------------------------------------------------*         
VR1000   GOTOR PROCSCR                                                          
         GOTOR PROCSEG                                                          
         GOTOR RESORTR             RE-SORT RECORD                               
         GOTOR PROCLNK2            CLEAN UP LINK RECORD                         
         GOTOR BLDRPTR             BUILD REVERSE POINTER                        
*                                                                               
* REBUILD TSAR RECORDS INCASE THERE ARE LAST MINUTE CHANGES TO THE              
* CONTRACT BUYS THAT WERE NOT REFLECTED IN THE DISPLAY                          
*                                                                               
*        GOTOR INITTSAR                                                         
*        GOTOR BLDTSREC                                                         
*                                                                               
         GOTOR PREAPRV                                                          
         GOTOR APPROVE                                                          
         GOTOR DEMOPROC                                                         
         GOTOR DELCFC                                                           
         GOTOR TRAP                                                             
         GOTOR POSTAPRJ                                                         
*                                                                               
         B     VREND                                                            
         EJECT                                                                  
*---------------------------------------------------------------------*         
* PF11: REVISION REJECTION                                                      
*---------------------------------------------------------------------*         
VR1100   DS    0H                                                               
*&&AM                                                                           
         CLI   ACTNUM,ACTAMD                                                    
         BE    VR1200                                                           
*&&                                                                             
         MVC   AIO,AIO1                                                         
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
         GOTO1 HEXOUT,DMCB,RDARREP#,AORHDLN,4,=C'TOG'                           
         OI    AORHDLNH+6,X'80'    XMIT                                         
         GOTO1 HEXOUT,DMCB,RDARKORD,AORAORD,4,=C'TOG'                           
         OI    AORAORDH+6,X'80'    XMIT                                         
*                                                                               
         TM    RDARMISC,X'20'      NOTDARE?                                     
         BZ    VR1101                                                           
         MVC   AORREAS(6),=C'UNDARE'   YES, STICK UNDARE IN                     
         B     VR1104                                                           
*                                                                               
VR1101   DS    0H                                                               
         LA    R2,CONRECH                                                       
         CLI   RDARBSTS,C'R'       REJECTED ALREADY?                            
         BE    WASREJ                                                           
*&&AM                                                                           
         CLI   RDARBSTS,C'M'       AMENDED ALREADY?                             
         BNE   VR1102                                                           
         CLC   =C'UNDARE',AORREAS                                               
         BNE   WASAMD                                                           
*&&                                                                             
         DROP  R6                                                               
*                                                                               
VR1102   DS    0H                                                               
         LA    R2,AORREASH         YES - MUST HAVE AT LEAST 1 LINE              
         CLI   5(R2),0             ANYTHING ON FIRST LINE?                      
         BNE   VR1103                                                           
         OI    AORREASH+6,X'80'+X'40' STICK CURSOR HERE                         
         B     REJERR                                                           
*                                                                               
VR1103   DS    0H                                                               
         CLC   AORREAS(6),=C'UNDARE'                                            
         BNE   VR1110                                                           
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
         CLI   RDARRNUM,0                                                       
         BNE   UNDERR                                                           
         DROP  R6                                                               
*                                                                               
VR1104   DS    0H                                                               
         GOTO1 CALLOV,DMCB,(X'20',0),0                                          
         CLI   DMCB+4,X'FF'        LET OVERLAY 20 HANDLE RADIO UNDARE           
         BNE   *+6                                                              
         DC    H'0'                                                             
         L     RF,DMCB                                                          
         GOTO1 (RF),DMCB,(RC),(X'80',0)                                         
         B     EXIT                                                             
*&&AM                                                                           
VR1105   DS    0H                                                               
         CLI   PFKEY,3             SEND AMEND TO BUYER?                         
         BE    VR1110                                                           
         MVC   RERROR,=AL2(932)    SET ERROR TYPE = PF3 TO REJECT               
         LA    R2,AORREASH         SET CURSOR HERE                              
         GOTO1 MYERROR                                                          
*&&                                                                             
VR1110   DS    0H                                                               
*                                                                               
         GOTOR DATETIME                                                         
*                                  SEND MESSAGE: ORDER REJECTED                 
         GOTOR POSTAPRJ                                                         
*                                                                               
         OI    PRTSTAT,PRTONE                                                   
         NI    FLAGS,FF-FGINITQ                                                 
                                                                                
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
         OC    RDARREP#,RDARREP#                                                
         BNZ   VR45                SKIP DIFFERENCES WORKSHEET                   
         GOTO1 VLOAD,DMCB,(X'30',0),('QPRONE',0)                                
         B     EXIT                DO REGULAR WORKSHEET INSTEAD                 
         DROP  R6                                                               
         EJECT                                                                  
*---------------------------------------------------------------------*         
* PROCESS AMEND - THIS IS COMMENTED OUT FOR TV                                  
*---------------------------------------------------------------------*         
*&&AM                                                                           
VR1200   DS    0H                                                               
*                                                                               
         XC    WORK,WORK                                                        
         MVC   WORK(4),ACOMFACS                                                 
         MVC   WORK+4(2),TWAAGY                                                 
*                                                                               
         GOTOX (RFGETDAR,REPFACS),DMCB,AIO3,KEY,0,WORK                          
*                                                                               
         MVC   SELECTKY,KEY                                                     
         MVC   AIO,AIO1                                                         
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
VR1210   DS    0H                                                               
         MVC   AIO,AIO1                                                         
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
         GOTO1 HEXOUT,DMCB,RDARREP#,AORHDLN,4,=C'TOG'                           
         OI    AORHDLNH+6,X'80'    XMIT                                         
         GOTO1 HEXOUT,DMCB,RDARKORD,AORAORD,4,=C'TOG'                           
         OI    AORAORDH+6,X'80'    XMIT                                         
*                                                                               
         CLI   PFKEY,3             SEND AMEND TO BUYER?                         
         BE    VR1220                                                           
         CLI   PFKEY,10            DIFFERENCES?                                 
         BE    VRX                                                              
         CLI   PFKEY,12            RETURN TO CONTRAT?                           
         BNE   VR1215                                                           
         OI    FLAGS2,FG2STAY                                                   
         B     VR200                                                            
*                                                                               
VR1215   DS    0H                                                               
         LA    R2,AORREASH         YES - MUST HAVE AT LEAST 1 LINE              
         CLI   5(R2),0             ANYTHING ON FIRST LINE?                      
         BE    AMDERR                                                           
         B     VRX                                                              
*                                                                               
VR1220   DS    0H                                                               
         CLI   RDARBSTS,C'M'       AMENDED ALREADY?                             
         BE    WASAMD                                                           
*                                                                               
         GOTOR DATETIME                                                         
*                                  SEND MESSAGE: ORDER REJECTED                 
         GOTOR POSTAPRJ                                                         
*                                                                               
         OI    PRTSTAT,PRTONE                                                   
         NI    FLAGS,FF-FGINITQ                                                 
         B     VR45                                                             
         DROP  R6                                                               
*&&                                                                             
*---------------------------------------------------------------------*         
* SAVE OFF FOR RETRIEVAL                                                        
*---------------------------------------------------------------------*         
VREND    DS    0H                                                               
         TM    FLAGS,FGTBSVDQ      TSAR BUFFER WAS SAVED?                       
         BO    VRE10                                                            
         GOTO1 GOTSAR,TSASAV       RESTORE                                      
*                                                                               
VRE10    DS    0H                                                               
         TM    MYFLAG1,X'01'       PRINT MESSAGE?                               
         BO    NEXTSCR             YES, PUT OUT MESSAGE                         
VRX      DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* SET THE PFKEY INFORMATION                                                     
***********************************************************************         
SETPFKYS NTR1                                                                   
         MVC   KEY(L'SELECTKY),SELECTKY                                         
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEYSAVE(27),KEY                                                  
         BE    STPFK01                                                          
         CLI   ACTNUM,ACTAMD                                                    
         BE    STPFK01             IF AMEND, IT IS OK                           
         CLI   PFKEY,12                                                         
         BNE   RETURN                                                           
*                                                                               
STPFK01  DS    0H                                                               
         SR    R2,R2               NO PFKEY AT TABLE FIRST                      
*                                                                               
         CLI   ACTNUM,ACTAMD       ACTION AMEND?                                
         BE    STPFK05                                                          
         CLI   ACTNUM,ACTREJ       FOR REJECTION                                
         BNE   STPFK03                                                          
         CLI   PFKEY,3             IF PF 3 IS PRESS                             
         BNE   STPFK03                                                          
         LA    R2,APFTABLE         USE THE AMEND PF TABLE                       
         B     STPFINIT                                                         
*                                                                               
STPFK03  DS    0H                  ELSE                                         
         CLI   PFKEY,3             PF3 GOES TO BUY/LIST OVERLAY                 
         BNE   STPFK05                                                          
                                                                                
         LR    R2,RA                                                            
         AHI   R2,DARPROFS-CONHEADH                                             
         USING SVDSECT,R2                                                       
         OI    DMISFLGX,X'10'      RETURN TO DIFFERENCE FROM BUY/LIST           
         DROP  R2                                                               
*                                                                               
STPFK05  DS    0H                                                               
         CLI   PFKEY,12            IF USER HITS PF12                            
         BNE   STPFK10             SUICIDE SWAP TO CONTRACT                     
         CLI   CALLSP,0            CAME DIRECTLY FROM CONTRACT W/O              
         BNE   STPFK10             GOING THRU ORDER/LIST/SELECT                 
         LA    R2,APF12DIF                                                      
         B     STPFINIT                                                         
*                                                                               
STPFK10  DS    0H                                                               
         CLI   ACTNUM,ACTDIF       ACTION DIFFERENCE?                           
         BE    STPFK60                                                          
         CLI   ACTNUM,ACTREJ       ACTION REJECT?                               
         BNE   STPFK30                                                          
         LA    R2,RPFTABLE                                                      
         B     STPFINIT                                                         
*                                                                               
STPFK30  DS    0H                                                               
         CLI   ACTNUM,ACTAMD       ACTION AMEND?                                
         BNE   STPFINIT                                                         
         LA    R2,APFTABLE                                                      
         B     STPFINIT                                                         
*                                                                               
STPFK60  LA    R2,SPFTABLE         YES, USE LIST PFKEY TABLE                    
*                                                                               
STPFINIT GOTO1 INITIAL,DMCB,(R2)   INITIALIZE THE PFKEYS                        
*                                                                               
         CLI   PFKEY,11            REJECT                                       
         BE    STPFK70                                                          
*                                                                               
         CLI   ACTNUM,ACTAMD       ACTION AMEND?                                
         BNE   STPFX                                                            
         CLI   PFKEY,10            DIFFERENCES                                  
         BNE   STPFX                                                            
         LA    R2,APFTABLE                                                      
         B     STPFK80                                                          
*                                                                               
STPFK70  DS    0H                                                               
         LA    R2,SPFTABLE                                                      
*                                                                               
STPFK80  DS    0H                                                               
         ZIC   R1,PFKEY                                                         
         AHI   R1,12                                                            
         STC   R1,PFKEY                                                         
*                                                                               
         GOTO1 INITIAL,DMCB,(R2)                                                
*                                                                               
STPFX    B     EXIT                                                             
*                                                                               
***********************************************************************         
* APPROVE/REJECT PFKEY TABLE DEFINITIONS                                        
*----------------------------------------------------------------------         
SPFTABLE  DS    0C                                                              
*                                                                               
* JUMP TO THE CONTRACT PROGRAM                                                  
         DC    AL1(SPF02X-*,02,0,0,0,PFTRETRN)                                  
         DC    CL3' ',CL8' ',CL8' '                                             
SPF02X   EQU   *                                                                
*                                                                               
* BUY LIST SCREEN                                                               
         DC    AL1(SPF03X-*,03,0,0,(SPF03X-SPF03)/KEYLNQ,0)                     
         DC    CL3' ',CL8'BUY',CL8'LIST'                                        
SPF03    DC    AL1(KEYTYTWA,L'DIFHDLN-1),AL2(DIFHDLN-T80FFFD)                   
SPF03X   EQU   *                                                                
*                                                                               
* SCROLL BACK                                                                   
         DC    AL1(SPF04X-*,04,0,0,0,PFTRETRN)                                  
         DC    CL3' ',CL8' ',CL8' '                                             
SPF04X   EQU   *                                                                
*                                                                               
* PRINT ORDER WORKSHEET                                                         
         DC    AL1(SPF05X-*,05,0,0,0,PFTRETRN)                                  
         DC    CL3' ',CL8' ',CL8' '                                             
SPF05X   EQU   *                                                                
*                                                                               
* PAN GRID RIGHT ==>>                                                           
         DC    AL1(SPF06X-*,06,0,0,0,PFTRETRN)                                  
         DC    CL3' ',CL8' ',CL8' '                                             
SPF06X   EQU   *                                                                
*                                                                               
* TOGGLE BETWEEN EXPAND AND SQUEEZE VIEW                                        
         DC    AL1(SPF07X-*,07,0,0,0,PFTRETRN)                                  
         DC    CL3' ',CL8' ',CL8' '                                             
SPF07X   EQU   *                                                                
*                                                                               
* TOGGLE BETWEEN EXPLODED AND COLLASPED VIEW                                    
         DC    AL1(SPF08X-*,08,0,0,0,PFTRETRN)                                  
         DC    CL3' ',CL8' ',CL8' '                                             
SPF08X   EQU   *                                                                
*                                                                               
* REFRESH DISPLAY BY REFRESHING READ TO TSAR BUFFER                             
         DC    AL1(SPF09X-*,09,0,0,0,PFTRETRN)                                  
         DC    CL3' ',CL8' ',CL8' '                                             
SPF09X   EQU   *                                                                
*                                                                               
* APPROVE REVISION ORDER                                                        
         DC    AL1(SPF10X-*,10,0,0,0,PFTRETRN)                                  
         DC    CL3' ',CL8' ',CL8' '                                             
SPF10X   EQU   *                                                                
*                                                                               
* REJECT REVISION ORDER                                                         
         DC    AL1(SPF11X-*,11,0,0,0,PFTRETRN)                                  
         DC    CL3' ',CL8' ',CL8' '                                             
SPF11X   EQU   *                                                                
*                                                                               
* RETURN TO CALLER                                                              
*        DC    AL1(SPF12X-*,12,PFTRPROG,0,0,0)                                  
*        DC    CL3' ',CL8' ',CL8' '                                             
*SPF12X   EQU   *                                                               
*06/21/2004                                                                     
         DC    AL1(SPF12X-*,12,0,0,(SPF12X-SPF12)/KEYLNQ,0)                     
         DC    CL3' ',CL8'ORDER',CL8'SELECT '                                   
SPF12    DC    AL1(KEYTYTWA,L'DIFHDLN-1),AL2(DIFHDLN-T80FFFD)                   
SPF12X   EQU   *                                                                
* 06/21/2004                                                                    
* 01/01/2003                                                                    
*        DC    AL1(SPF12X-*,12,PFTRPROG,0,0,0)                                  
*        DC    CL3' ',CL8'ORDER',CL8'SELECT'                                    
*SPF12X   EQU   *                                                               
* 01/01/2003                                                                    
*                                                                               
* ACTUAL REJECT                                                                 
         DC    AL1(SPF23X-*,23,0,0,0,0)                                         
SPF22RRQ EQU   *                                                                
         DC    CL3' ',CL8'REVISION',CL8'REJECT'                                 
SPF23X   EQU   *                                                                
                                                                                
         DC    X'FF'                                                            
         EJECT                                                                  
*----------------------------------------------------------------------         
* REJECT PFKEY TABLE DEFINITIONS                                                
*                                                                               
RPFTABLE  DS    0C                                                              
*                                                                               
* JUMP TO THE CONTRACT PROGRAM                                                  
         DC    AL1(RPF02X-*,02,0,0,0,PFTRETRN)                                  
         DC    CL3' ',CL8' ',CL8' '                                             
RPF02X   EQU   *                                                                
*                                                                               
* RETURN TO CALLER                                                              
         DC    AL1(RPF12X-*,12,0,0,0,0)                                         
         DC    CL3' ',CL8'ORDER',CL8'SELECT '                                   
RPF12X   EQU   *                                                                
                                                                                
         DC    X'FF'                                                            
         EJECT                                                                  
*---------------------------------------------------------------------*         
* AMEND PFKEY TABLE DEFINITIONS                                                 
*                                                                               
APFTABLE  DS    0C                                                              
*                                                                               
* SWAP TO THE CONTRACT PROGRAM                                                  
         DC    AL1(APF02X-*,02,0,0,0,PFTRETRN)                                  
         DC    CL3' ',CL8' ',CL8' '                                             
APF02X   EQU   *                                                                
*                                                                               
* SEND AMEND TO BUY                                                             
         DC    AL1(APF03X-*,03,0,0,0,PFTRETRN)                                  
         DC    CL3' ',CL8' ',CL8' '                                             
APF03X   EQU   *                                                                
*                                                                               
* JUMP TO DIFFERENECES                                                          
         DC    AL1(APF10X-*,10,0,0,0,PFTRETRN)                                  
         DC    CL3' ',CL8' ',CL8' '                                             
APF10X   EQU   *                                                                
*                                                                               
* RETURN TO CONTRACT                                                            
*        DC    AL1(APF12X-*,12,PFTRPROG,0,0,0)                                  
APF12DIF DC    AL1(APF12X-*,12,0,0,0,PFTRETRN)                                  
         DC    CL3' ',CL8' ',CL8' '                                             
APF12X   EQU   *                                                                
*                                                                               
* ACTUAL DIFFERENCES                                                            
         DC    AL1(APF22X-*,22,0,0,0,0)                                         
         DC    CL3' ',CL8'REVISION',CL8'DIFFEREN'                               
APF22X   EQU   *                                                                
                                                                                
         DC    X'FF'                                                            
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* COMMON ROUTINES AND ERROR MESSAGES (ADDRESSABLE EXCLUSIVELY BY R7)            
***********************************************************************         
         DROP  RB                                                               
COMMON   DS    0H                                                               
***********************************************************************         
* ROUTINE TO INTERFACE WITH TSAR BUFFER                               *         
* NTRY: R1 = REQUESTED ACTION                                         *         
*                                                                     *         
* EXIT: CC LOW FOR END OF FILE ERROR                                  *         
*       CC HIGH FOR RECORD NOT FOUND                                  *         
***********************************************************************         
GOTSAR   NTR1                                                                   
         STCM  R1,1,TLACTN         REQUESTED ACTION                             
*                                                                               
         CLI   TLACTN,TSARES       EXPLICIT RESTORE?                            
         BE    GOTSAR03                                                         
         CLI   TLACTN,TSASAV       EXPLICIT SAVE?                               
         BE    GOTSAR03                                                         
         CLI   TLACTN,TSAINI       EXPLICIT INITIALISE?                         
         BNE   GOTSAR05                                                         
*                                                                               
GOTSAR03 DS    0H                  INITIALIZE TSAR BLOCK                        
         LA    RE,TBLOCK                                                        
         LA    RF,TSARDL                                                        
         XCEF                                                                   
*                                                                               
GOTSAR05 DS    0H                                                               
         MVC   TB.TSACTN,TLACTN                                                 
*                                                                               
         LA    RF,TSARREC                                                       
         ST    RF,TB.TSAREC                                                     
*                                                                               
         CLI   TLACTN,TSARES       EXPLICIT RESTORE?                            
         BE    GOTSAR10                                                         
         CLI   TLACTN,TSASAV       EXPLICIT SAVE?                               
         BE    GOTSAR10                                                         
         CLI   TLACTN,TSAINI       EXPLICIT INITIALISE?                         
         BNE   GOTSAR30                                                         
*                                                                               
GOTSAR10 DS    0H                                                               
         MVI   TB.TSPAGL,1         USE TEMPSTR PAGE 1                           
         MVI   TB.TSPAGN,10                                                     
         MVC   TB.TSACOM,ACOMFACS  SET A(COMFACS)                               
         MVI   TB.TSKEYL,L'TLKEY   SET KEY LENGTH                               
         MVI   TB.TSRECI,TSRVAR    SET VARIABLE                                 
         MVC   TB.TSRECL,=Y(255)   SET MAXIMUM RECORD LENGTH                    
         OI    TB.TSINDS,TSIXTTWA  14K RECORDS                                  
*                                                                               
GOTSAR20 GOTOX VTSAR,TB.TSARD      CALL TO INITIALISE/RESTORE                   
         BE    GOTSARX                                                          
         DC    H'0'                ABEND                                        
*                                                                               
GOTSAR30 DS    0H                                                               
         MVC   TB.TSRNUM,TXNUM     SET TSAR NUMBER                              
*                                                                               
* SET MINIMUM LENGTH FOR VARIABLE LENGTH RECORDS                                
*                                                                               
         CLI   TLACTN,TSAADD       TEST ADDING                                  
         BNE   GOTSAR50                                                         
         CLC   TR.TLLEN,=Y(L'TLKEY+2+1)                                         
         BNL   GOTSAR50                                                         
*TRAP                                                                           
         CLI   TR.TLKTYP,X'0E'                                                  
         BNE   *+6                                                              
         DC    H'0'                                                             
*TRAP                                                                           
         MVC   TR.TLLEN,=Y(L'TLKEY+2+1)                                         
*                                                                               
GOTSAR50 DS    0H                                                               
         GOTOX VTSAR,TB.TSARD                                                   
*&&DO                                                                           
* FOR GET NEXT, DON'T UPDATE RECORD NUMBER (TXNUM) IF                           
* EOF OR REC NOT FOUND WAS ENCOUNTERED                                          
*                                                                               
         CLI   TLACTN,TSANXT                                                    
         BNE   GOTSAR60                                                         
         TM    TB.TSERRS,TSEEOF+TSERNF                                          
         BNZ   GOTSAR70                                                         
*                                                                               
GOTSAR60 DS    0H                                                               
*&&                                                                             
         MVC   TXNUM,TB.TSRNUM     SET RECORD LIST NUMBER                       
*                                                                               
         CLI   TLACTN,TSAADD       CHECK IF END-OF-FILE ERROR                   
         BNE   GOTSAR70                                                         
         TM    TB.TSERRS,TSEEOF    DON'T DIE, DISPLAY ERROR INSTEAD             
         BZ    GOTSARX             ASK USER TO REQUEST REPORT OFFLINE           
         MVC   RERROR,=AL2(801)                                                 
         L     R2,ATWA                                                          
         LA    R2,CONRECH-CONHEADH+64(R2)                                       
         GOTO1 MYERROR                                                          
*                                                                               
GOTSAR70 DS    0H                                                               
         TM    TB.TSERRS,TSEEOF    RETURN CC=LOW FOR END-OF-FILE ERROR          
         BO    EXITL                                                            
         TM    TB.TSERRS,TSERNF    RETURN CC=HIGH IF RECORD NOT FOUND           
         BO    EXITH                                                            
*                                                                               
GOTSARX  DS    0H                                                               
         B     EXITOK                                                           
         EJECT                                                                  
*---------------------------------------------------------------------*         
*   LOADELT : LOADS ELEMENT IN WORKSPACE (ELTBUILD) TO RECORD.                  
*---------------------------------------------------------------------*         
LOADELT  NTR1                                                                   
         L     R2,0(R1)            RESET A(TARGET RECORD)                       
         L     R3,4(R1)            RESET A(ELEMENT BUILD AREA)                  
         L     R4,8(R1)            RESET A(COMMAND EXTENSION)                   
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),(R2),(R3),(R4)                     
*                                  ADD ELT TO RECORD                            
         B     EXIT                                                             
         EJECT                                                                  
*---------------------------------------------------------------------*         
*   DELELT :  DROPS X'03' ELEMENT FROM BUYRECS                                  
*---------------------------------------------------------------------*         
DELELT   NTR1                                                                   
         L     R2,0(R1)            RESET A(TARGET RECORD)                       
         GOTO1 HELLO,DMCB,(C'D',=C'REPFILE'),(3,(R2)),0,0                       
*                                  DROP X'03' ELTS FROM BUYRECORD               
         B      EXIT                                                            
         EJECT                                                                  
*---------------------------------------------------------------------*         
*   DELELT02 :  DROPS X'02' ELEMENT(S) (DAY/TIME) FROM BUYRECS                  
*        WHEN THEY WERE GENERATED BY AN ORBIT RECORD, AND THE BUYS              
*        ARE 'DAILY'                                                            
*---------------------------------------------------------------------*         
DELELT02 NTR1                                                                   
         L     R2,0(R1)            RESET A(TARGET RECORD)                       
         GOTO1 HELLO,DMCB,(C'D',=C'REPFILE'),(2,(R2)),0,0                       
*                                  DROP X'02' ELTS FROM BUYRECORD               
         B     EXIT                                                             
         EJECT                                                                  
*---------------------------------------------------------------------*         
* PRINT A LINE                                                                  
*---------------------------------------------------------------------*         
PRINT    NTR1                                                                   
         GOTO1 SPOOL,DMCB,(R8)                                                  
         B     EXIT                                                             
         EJECT                                                                  
*---------------------------------------------------------------------*         
* SET DATE IN P1 TO BE MONDAY DATE                                              
*---------------------------------------------------------------------*         
SETDATE  NTR1                                                                   
*        CLC   EARLIEST,=X'FFFFFF'                                              
*        BNE   *+                                                               
*        GOTO1 DATCON,DMCB,(2,RDARESST),(5,PRACODE)                             
*                                                                               
         L     R2,0(R1)                                                         
         GOTO1 DATCON,DMCB,(3,(R2)),(0,ELEM)                                    
         GOTO1 GETDAY,DMCB,ELEM,ELEM+6                                          
         ZIC   RF,DMCB                                                          
         BCTR  RF,0                MAKE DAY ZERO RELATIVE                       
         LTR   RF,RF               MONDAY?                                      
         BZ    SETDATEX            YES - LEAVE                                  
         LNR   RF,RF               NEGATE REGISTER                              
         GOTO1 ADDAY,DMCB,ELEM,ELEM+6,(RF)                                      
         MVC   ELEM(6),ELEM+6                                                   
         GOTO1 DATCON,DMCB,(0,ELEM),(3,(R2))                                    
*                                                                               
SETDATEX DS    0H                                                               
         B     EXIT                                                             
*---------------------------------------------------------------------*         
* GET AGENCY ORDER FLIGHT DATE                                                  
*---------------------------------------------------------------------*         
GETFDTE  NTR1                                                                   
         MVC   KEY(L'SELECTKY),SELECTKY                                         
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(27),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                SHOULD NEVER HAPPEN!                         
*                                                                               
         MVC   AIO,AIO1                                                         
*                                                                               
         GOTO1 GETREC                                                           
                                                                                
         L     R4,AIO                                                           
         USING RDARREC,R4                                                       
*                                                                               
         MVC   FLTDATES,RDARESST   SAVE FLIGHT START/END                        
*                                                                               
         DROP  R4                                                               
*                                                                               
GETFDTEX DS    0H                                                               
         B     EXIT                                                             
*---------------------------------------------------------------------*         
*   DATETIME:  DEVELOPS THE DATE AND TIME FOR STAMPING                          
*---------------------------------------------------------------------*         
DATETIME NTR1                                                                   
*                                                                               
         GOTO1 DATCON,DMCB,(5,WORK),(2,ACTDATE)                                 
*                                  FETCH TODAY'S DATE                           
         THMS  DDSTIME=YES                                                      
         ST    R0,DUB              ACTUAL TIME ADJUSTMENT                       
         ST    R1,DUB+4            DDS TIME                                     
         AP    DUB(4),DUB+4(4)                                                  
         ICM   R1,15,DUB                                                        
         SRL   R1,12               SHIFT OFF SECONDS AND SIGN                   
         STCM  R1,3,ACTTIME                                                     
                                                                                
         B     EXIT                                                             
         LTORG                                                                  
*---------------------------------------------------------------------*         
* EXITS                                                                         
*                                                                               
EXITOK   CR    RB,RB                                                            
         B     EXIT                                                             
EXITL    CLI   *,X'FF'                                                          
         B     EXIT                                                             
EXITH    CLI   *,0                                                              
*                                                                               
EXIT     DS    0H                                                               
         XIT1                                                                   
*                                                                               
* ERROR MESSAGES                                                                
*                                                                               
ERNOPRD  DS    0H                  PLEASE ADD PRODUCT CODE                      
         LA    R3,976                                                           
         B     ERDUMP                                                           
*                                                                               
ERDUMP   DS    0H                                                               
         ZAP   WORK+20(5),=P'0'                                                 
         MVO   WORK+20(5),CCONKNUM                                              
         EDIT  (P5,WORK+20),(8,WORK+30),ALIGN=LEFT                              
         LA    R1,WORK+30                                                       
         ST    R1,DMCB+12                                                       
         MVI   DMCB+12,8                                                        
         GOTO1 GETTXT,DMCB,(R3),0,(C'E',0),,0,0                                 
         DC    H'0',C'$ABEND'      ABEND                                        
*                                                                               
ERNOSAL  DS    0H                                                               
         LA    R3,980                                                           
         GOTO1 GETTXT,DMCB,(R3),0,(C'E',0),0,0,0                                
         DC    H'0',C'$ABEND'      ABEND                                        
*                                                                               
ER1K     DS    0H                                                               
         LA    R3,998                                                           
         GOTO1 GETTXT,DMCB,(R3),0,(C'E',0),0,0,0                                
         DC    H'0',C'$ABEND'      ABEND                                        
*                                                                               
ERPRDDAT MVC   RERROR,=AL2(959)    ORDER DATES FALL OUTSIDE PRD DATE            
         B     ERREND                                                           
*                                                                               
CALLDDS  MVC   RERROR,=AL2(440)                                                 
         B     ERREND                                                           
*                                                                               
NEXTSCR  MVC   RERROR,=AL2(938)    BUYLINES DISPLAYED                           
         B     INFRTEXT                                                         
*                                                                               
RETURN   MVC   RERROR,=AL2(986)    ORDER CONFIRMED, PLEASE RETURN               
         B     ERREND                                                           
*                                                                               
INVLOPT  MVC   RERROR,=AL2(960)                                                 
         B     ERREND                                                           
*                                                                               
MISSLIN  MVC   RERROR,=AL2(972)                                                 
         B     ERREND                                                           
*                                                                               
MISSM    MVC   RERROR,=AL2(973)                                                 
         B     ERREND                                                           
*                                                                               
ERPVIEW  MVC   RERROR,=AL2(975)                                                 
         B     ERREND                                                           
*                                                                               
MISSINP  MVC   RERROR,=AL2(974)                                                 
         B     ERREND                                                           
*                                                                               
MISSFLD  MVC   RERROR,=AL2(1)                                                   
         B     ERREND                                                           
*                                                                               
MATCHER  MVC   RERROR,=AL2(967)                                                 
         B     ERREND                                                           
*                                                                               
MATCHER1 MVC   RERROR,=AL2(969)                                                 
         B     ERREND                                                           
*                                                                               
DAILYERR MVC   RERROR,=AL2(979)                                                 
         B     ERREND                                                           
*                                                                               
ERNOLINE MVC   RERROR,=AL2(968)                                                 
         B     ERREND                                                           
*                                                                               
INVLFLD  MVC   RERROR,=AL2(2)                                                   
         B     ERREND                                                           
*                                                                               
INVLACT  MVC   RERROR,=AL2(INVACT)                                              
         B     ERREND                                                           
*                                                                               
INVLCON  MVC   RERROR,=AL2(82)                                                  
         B     ERREND                                                           
*                                                                               
MAXBUYER MVC   RERROR,=AL2(93)                                                  
         B     ERREND                                                           
*                                                                               
INVMETH  MVC   RERROR,=AL2(728)                                                 
         B     ERREND                                                           
*                                                                               
MUSTMAN  MVC   RERROR,=AL2(737)                                                 
         B     ERREND                                                           
*                                                                               
WASAPR   MVC   RERROR,=AL2(424)                                                 
         B     ERREND                                                           
*                                                                               
WASREJ   MVC   RERROR,=AL2(425)                                                 
         B     ERREND                                                           
*                                                                               
WASAMD   MVC   RERROR,=AL2(942)                                                 
         B     ERREND                                                           
*                                                                               
REJERR   MVC   RERROR,=AL2(433)                                                 
         B     ERREND                                                           
*                                                                               
AMDERR   MVC   RERROR,=AL2(930)                                                 
         B     ERREND                                                           
*                                                                               
UNDERR   MVC   RERROR,=AL2(958)                                                 
         B     ERREND                                                           
*                                                                               
INVLRCAC MVC   RERROR,=AL2(INVRCACT)                                            
         B     ERREND                                                           
*                                                                               
RECNTFND MVI   GERROR1,53          RECORD NOT FOUND                             
         B     ERREND                                                           
*                                                                               
INFRTEXT DS    0H                  SUBSTITUTION TEXT                            
         XC    GETTXTCB,GETTXTCB                                                
         LA    RF,GETTXTCB                                                      
         USING GETTXTD,RF                                                       
         LA    RE,BLOCK                                                         
         STCM  RE,7,GTASUBST                                                    
         DROP  RF                                                               
         B     INFEND                                                           
*                                                                               
ERREND   DS    0H                                                               
         MVI   RMSGTYPE,C'E'                                                    
         B     *+8                                                              
INFEND   MVI   RMSGTYPE,C'I'                                                    
*        LA    R2,CONRECH          SET CURSOR HERE FOR ALL ERROR/INFO           
*                                                                               
         GOTO1 MYERROR                                                          
*                                                                               
         GETEL R6,DATADISP,ELCODE  USED FOR THE GETEL OPERATIONS                
*                                                                               
*---------------------------------------------------------------------*         
* PRINT LINE HEADINGS - 132 CHARACTER LENGTH                                    
*---------------------------------------------------------------------*         
SUMTITLE DS    0C                                                               
         DC    C'M Ag# Rp# Day/Times,Len,Rate,Program'                          
SUMTITLQ EQU   *-SUMTITLE                                                       
*                                                                               
SUMTIT2E DS    0C                                                               
         DC    C'M Ag# Rp# Day     Times       Len    Rate Pgm'                 
SUMTIT2Q EQU   *-SUMTIT2E                                                       
         EJECT                                                                  
         LTORG                                                                  
*&&AM                                                                           
RJECTPFK DC    C'3 REJECT to Buyer  PF12 Return'                                
RJECTPFQ EQU   *-RJECTPFK                                                       
AMENDPFK DC    C'3 AMEND to Buyer  PF10 Differences  PF12 Return'               
AMENDPFQ EQU   *-AMENDPFK                                                       
AMENDMS1 DC    C'As we discussed, this order required changes before '          
         DC    C'it was sent to the'                                            
AMENDM1Q EQU   *-AMENDMS1                                                       
AMENDMS2 DC    C'station. Please make the changes and Re-Send. A '              
         DC    C'confirm notice'                                                
AMENDM2Q EQU   *-AMENDMS2                                                       
AMENDMS3 DC    C'cannot be sent until the order is Re-Sent to us.'              
AMENDM3Q EQU   *-AMENDMS3                                                       
*&&                                                                             
*&&XM                                                                           
XMLMS1   DC    C'This is an XML order. The buyer must be notified '             
         DC    C'through other means'                                           
XMLMS1Q  EQU   *-XMLMS1                                                         
XMLMS2   DC    C'that this order is rejected and why.  Using the REJEC'         
         DC    C'T command will'                                                
XMLMS2Q  EQU   *-XMLMS2                                                         
XMLMS3   DC    C'update the DARE order status, but not send an '                
         DC    C'electronic notice'                                             
XMLMS3Q  EQU   *-XMLMS3                                                         
XMLMS4   DC    C'to the buyer.'                                                 
XMLMS4Q  EQU   *-XMLMS4                                                         
*&&                                                                             
GRPTERM2 DC    X'0000'                                                          
TABTERM  DC    X'00000000'                                                      
*                                                                               
*---------------------------------------------------------------------*         
* BUMP THE DISPLAY LINE TO THE NEXT LINE                                        
* ASSUME R2 IS THE DISPLAY LINE                                                 
* LISTLENP = LIST LINE LENGTH FOR THE PRINT LINE                                
* LISTLEN  = LIST LINE LENGTH FOR THE DISPLAY LINE                              
*---------------------------------------------------------------------*         
BUMPLINE DS    0H                                                               
         TM    FLAGS,FGPRTQ        PRINTING?                                    
         BZ    BUMP0030                                                         
*                                                                               
         LA    R2,LISTLENP(R2)     YES, ADD LISTLENP                            
         B     BUMP0040                                                         
*                                                                               
BUMP0030 DS    0H                                                               
         LA    R2,LISTLEN(R2)      NO, ADD LISTLEN                              
*                                                                               
BUMP0040 DS    0H                                                               
         BR    RE                                                               
*                                                                               
*---------------------------------------------------------------------*         
* TEST TO SEE IF WE REACH THE END OF SCREEN                                     
* ASSUME R2 IS THE DISPLAY LINE                                                 
* CALLER SHOULD TEST FOR CONDITION CODE HIGH TO EXIT DISPLAY                    
*---------------------------------------------------------------------*         
ISEOSCR  DS    0H                                                               
         TM    FLAGS,FGPRTQ        PRINTING - SKIP                              
         BO    ISEOS100                                                         
*                                                                               
         LA    RF,DIFEND           REACH END OF SCREEN?                         
         SHI   RF,LISTLEN                                                       
         SLL   R2,8                CLEAR HIGH BYTE                              
         SRL   R2,8                                                             
         CR    R2,RF                                                            
         BR    RE                  SET CC                                       
*                                                                               
ISEOS100 DS    0H                                                               
         CR    RE,RE               CLEAR CC                                     
         BR    RE                                                               
*                                                                               
*---------------------------------------------------------------------*         
* ADVANCE TO END OF THE MATCH TABLE                                             
* R3->MATCH TABLE                                                               
*---------------------------------------------------------------------*         
ENDOFTAB DS    0H                                                               
         LA    R3,MTCHTAB                                                       
EOTB0100 DS    0H                                                               
         CLC   0(L'TABTERM,R3),TABTERM    END OF TABLE - DONE                   
         BE    EOTB0200                                                         
*                                                                               
         LA    R3,MTCHTABL(R3)     NEXT ENTRY                                   
         B     EOTB0100            LOOP                                         
EOTB0200 DS    0H                                                               
         BR    RE                                                               
*                                                                               
*---------------------------------------------------------------------*         
* DISPLAY * FOR MAKEGOOD LINES                                                  
* ASSUMING R2 IS THE DISPLAY LINE, 0(R1) HAS THE FLAG                           
* 0(R1) = X'80' = THIS IS A MAKEGOOD                                            
*---------------------------------------------------------------------*         
DISMKG   DS    0H                                                               
BUYSEG   USING TLSTD,GNXSVREC                                                   
         CLI   BUYSEG.TLBYMKG,C'Y'                                              
         BNE   DMKGX               NOT A MAKEGOOD - SKIP                        
*                                                                               
         MVI   DSMKG-DIFFSUM(R2),C'*'                                           
*                                                                               
DMKGX    DS    0H                                                               
         BR    RE                                                               
         DROP  BUYSEG                                                           
*&&DO                                                                           
*---------------------------------------------------------------------*         
* DISPLAY * FOR MAKEGOOD LINES                                                  
* ASSUMING R2 IS THE DISPLAY LINE, 0(R1) HAS THE FLAG                           
* 0(R1) = X'80' = THIS IS A MAKEGOOD                                            
*---------------------------------------------------------------------*         
DISMKG   DS    0H                                                               
         TM    0(R1),X'80'                                                      
         BZ    DMKGX               NOT A MAKEGOOD - SKIP                        
*                                                                               
         MVI   DSMKG-DIFFSUM(R2),C'*'                                           
*                                                                               
DMKGX    DS    0H                                                               
         BR    RE                                                               
*&&                                                                             
*---------------------------------------------------------------------*         
* DISPLAY COLOR FOR STEREO                                                      
* ASSUMING R2 IS THE DISPLAY LINE, 4TH BYTE OF R1 HAS COLOR CODE                
*---------------------------------------------------------------------*         
DISCOLOR DS    0H                                                               
         NI    DSLINEH+1-DIFFSUM(R2),X'FF'-X'08'                                
         STCM  R1,1,DSCOLOR-DIFFSUM(R2)                                         
         TM    STEREOFG,STFINUSE                                                
         BO    *+8                                                              
         MVI   DSCOLOR-DIFFSUM(R2),C' '                                         
DCOLORX  DS    0H                                                               
         BR    RE                                                               
*---------------------------------------------------------------------*         
* END OF COMMON ROUTINES                                                        
*---------------------------------------------------------------------*         
         EJECT                                                                  
***********************************************************************         
*                                                                               
***********************************************************************         
CKGLOB   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         NI    MISCFLG4,X'FF'-MF4GLOB                                           
*                                                                               
         L     R4,ACOMFACS                                                      
         USING COMFACSD,R4                                                      
*                                                                               
         GOTO1 CGLOBBER,DMCB,=C'GETD',BLOCK,14,GLVXCTL                          
         CLI   DMCB+8,0                                                         
         BNE   CKGLOBX                                                          
         GOTO1 CGLOBBER,DMCB,=C'DELE',,,GLVXCTL                                 
         DROP  R4                                                               
*                                                                               
         LA    R1,BLOCK                                                         
         USING GLVXFRSY,R1                                                      
         CLC   GLVXFRPR,=C'CON'    CON PROGRAM                                  
         BNE   CKGLOBX                                                          
         OI    MISCFLG4,MF4GLOB                                                 
         DROP  R1                                                               
*                                                                               
CKGLOBX  DS    0H                                                               
         B     EXIT                                                             
         LTORG                                                                  
         EJECT                                                                  
*---------------------------------------------------------------------*         
* READ CONTRACT TO IO AREA 3                                                    
* SET UP ALT CALENDER FLAGS, VERSION, ETC.                                      
*---------------------------------------------------------------------*         
NOCONREC EQU   82                                                               
*                                                                               
GETCON   NTR1  BASE=*,LABEL=*                                                   
*                                  GET 9'S REVERSE FOR BUYS LATER               
         PACK  COMPCON+0(1),CCONNUM+3(1)                                        
         PACK  COMPCON+1(1),CCONNUM+2(1)                                        
         PACK  COMPCON+2(1),CCONNUM+1(1)                                        
         PACK  COMPCON+3(1),CCONNUM+0(1)                                        
*                                                                               
         LA    R6,KEY                                                           
         USING RCONKEY,R6                                                       
         XC    KEY,KEY                                                          
         MVI   RCONPTYP,X'8C'                                                   
         MVC   RCONPREP,TWAAGY                                                  
         MVC   RCONPCON,CCONNUM                                                 
         DROP  R6                                                               
*                                                                               
         GOTO1 HIGH                                                             
         CLC   KEY(L'RCONKEY),KEYSAVE                                           
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   AIO,AIO3                                                         
         GOTO1 GETREC                                                           
*                                                                               
         NI    MISCFLG4,X'FF'-MF4TKO                                            
         L     R6,AIO3                                                          
         MVI   ELCODE,X'1C'                                                     
         BRAS  RE,GETEL                                                         
         BNE   *+8                                                              
         OI    MISCFLG4,MF4TKO                                                  
*                                                                               
         L     R4,AIO3                                                          
         USING RCONREC,R4                                                       
         MVC   SVCONADV,RCONKADV   SAVE OFF CON ADV CODE                        
         MVC   SVCONPRD,RCONPRD             CON PRD CODE                        
         MVC   SVCONREP,RCONKREP            CON REP CODE                        
*                                  DELETE  ALT CAL CTL  ELT                     
         XC    WORK,WORK                                                        
         MVC   WORK(4),ACOMFACS                                                 
         MVC   WORK+4(2),TWAAGY                                                 
*                                                                               
         GOTOX (RFVALTCL,REPFACS),DMCB,(X'FF',RCONREC),GETBROAD,0,WORK          
         BE    GETC0140            ALT CALENDAR(S) TEST PASSED                  
         MVC   RERROR,=AL2(780)    SET ERROR MESSAGE                            
         B     ERREXIT             EXIT CC NOT ZERO                             
*                                                                               
GETC0140 EQU   *                                                                
         GOTOX (RFCHKALT,REPFACS),DMCB,(0,RCONREC),ACOMFACS                     
         MVC   BUCKFLGS(1),0(R1)                                                
*                                  SET ALT CAL FLAGS FOR STATION                
***>>>                                                                          
         CLI   ACTCODE,C'R'        'REJECT' ACTION?                             
         BE    GETC0360            YES - DON'T DUMP BUYS                        
         DROP  R4                                                               
*                                                                               
         NI    MISCFLAG,FF-MFMANUAL                                             
*                                                                               
         L     R6,AIO3                                                          
         MVI   ELCODE,X'1D'        RETRIEVE                                     
         BRAS  RE,GETEL                                                         
         BNE   GETC0050                                                         
         USING RCONDREL,R6                                                      
         CLI   RCONDRLN,RCONDL2Q                                                
         BL    GETC0050                                                         
         TM    RCONDRF2,X'04'                                                   
         BZ    GETC0050                                                         
         OI    MISCFLAG,MFMANUAL   SET MANUAL CHANGES STARTED                   
         DROP  R6                                                               
*                                                                               
GETC0050 EQU   *                                                                
         BAS   RE,GETVERSN         RETRIEVE VERSION NUMBER                      
*                                                                               
* CALL TO REGENVER MIGHT HAVE FLAGGED CONTRACT UPDATED MANUALLY                 
* IF SO, RESET MANUAL FLAG BACK IF CONTRACT WAS NOT PREVIOUSLY                  
* UPDATE MANUALLY                                                               
*                                                                               
         L     R6,AIO3                                                          
         MVI   ELCODE,X'1D'        RETRIEVE                                     
         BRAS  RE,GETEL                                                         
         BNE   GETC0060                                                         
         USING RCONDREL,R6                                                      
         CLI   RCONDRLN,RCONDL2Q                                                
         BL    GETC0060                                                         
         TM    MISCFLAG,MFMANUAL                                                
         BNZ   GETC0060                                                         
         NI    RCONDRF2,X'FF'-X'04'                                             
         DROP  R6                                                               
*                                                                               
*   RETRIEVE REP RECORD IN ALL CASES TO GET DAILY PACING PROFILE                
*                                                                               
GETC0060 EQU   *                                                                
*                                                                               
         MVC   AIO,AIOAREA         SET ALTERNATE READ AREA                      
*                                     FOR SPOT CODES                            
         L     R2,AIO                                                           
         USING RREPRECD,R2                                                      
         XC    RREPKEY,RREPKEY                                                  
         MVI   RREPKEY,1           INSERT RECORD CODE                           
         MVC   RREPKREP,TWAAGY     INSERT POWER CODE                            
         MVC   KEY,RREPKEY         LOAD KEY                                     
         MVI   RDUPDATE,C'N'       SET UPDATE TO NO                             
         GOTO1 HIGH                                                             
         CLC   KEY(27),KEYSAVE                                                  
         BE    *+6                 RECORD FOUND                                 
         DC    H'0'                ??                                           
         MVI   RDUPDATE,C'N'       SET UPDATE TO NO                             
         GOTO1 GETREC                                                           
         MVC   DAILYFLG,RREPPROF+27                                             
*                                                                               
         L     R4,AIO3                                                          
         USING RCONREC,R4                                                       
*                                                                               
* SKIP VALIDATION FOR TRAINING IDS                                              
*                                                                               
         CLC   =C'MS',AGENCY                                                    
         BE    GETC0360                                                         
         CLC   =C'U1',AGENCY                                                    
         BE    GETC0360                                                         
         CLC   =C'U2',AGENCY                                                    
         BE    GETC0360                                                         
         CLC   =C'UR',AGENCY                                                    
         BE    GETC0360                                                         
*                                                                               
         CLI   RCONTYPE,C'N'       REP-TO-SPOT TRANSFER NEEDED?                 
         BE    GETC0160            YES                                          
         CLI   RCONTYPE,C'X'       REP-TO-SPOT TRANSFER NEEDED?                 
         BNE   GETC0360            NO                                           
GETC0160 EQU   *                                                                
         LR    RF,RA               USE R3 TO COVER THE ENTRY                    
         AHI   RF,DARPROFS-CONHEADH                                             
         USING SVDSECT,RF                                                       
*                                                                               
         TM    SVPGPBIT+CNTSPOTB,CNTSPOTA                                       
         BZ    GETC0360                                                         
         DROP  RF                                                               
*                                                                               
         MVC   IFELCODE,=X'0830'   INSERT CODE/LENGTH                           
*                                                                               
         MVC   RERROR,=AL2(940)    SET ERROR MESSAGE                            
         LA    R3,RREPELEM         FIND X'05' ELEMENT                           
GETC0200 EQU   *                                                                
         CLI   0(R3),0             END OF RECORD?                               
         BNE   GETC0210                                                         
         LA    R2,CONRECH                                                       
         GOTO1 MYERROR             EXIT WITH ERROR                              
GETC0210 EQU   *                                                                
         CLI   0(R3),X'05'         SPOT INTERFACE ELEMENT?                      
         BE    GETC0240            YES                                          
         ZIC   RF,1(R3)            NO  - BUMP TO NEXT ELEMENT                   
         AR    R3,RF                                                            
         B     GETC0200            GO BACK FOR NEXT                             
GETC0240 EQU   *                                                                
         MVC   IFSPAG,RREPSPPC-RREPSPOT(R3)                                     
*                                  INSERT SPOT AGENCY CODE                      
         MVC   IFSPMD,RREPMED-RREPSPOT(R3)                                      
*                                  INSERT SPOT MEDIA                            
         DROP R2                                                                
*                                                                               
         L     R2,AIO                                                           
         USING RPRDREC,R2                                                       
         XC    RPRDKEY,RPRDKEY                                                  
         MVI   RPRDKEY,9           INSERT RECORD CODE                           
         MVC   RPRDKADV,RCONKADV   INSERT ADVERTISER CODE                       
         MVC   RPRDKPRD,RCONPRD    INSERT PRODUCT CODE                          
         MVC   RPRDKREP,TWAAGY     INSERT POWER CODE                            
         MVC   KEY,RPRDKEY         LOAD KEY                                     
         MVI   RDUPDATE,C'N'       SET UPDATE TO NO                             
         GOTO1 HIGH                                                             
         CLC   KEY(27),KEYSAVE                                                  
         BNE   ERNOPRD             RECORD FOUND                                 
*        DC    H'0'                ??                                           
         MVI   RDUPDATE,C'N'       SET UPDATE TO NO                             
         GOTO1 GETREC                                                           
         MVC   RERROR,=AL2(940)    SET ERROR MESSAGE                            
         LA    R3,RPRDELEM         FIND X'03' ELEMENT                           
GETC0280 EQU   *                                                                
         CLI   0(R3),0             END OF RECORD?                               
         BNE   GETC0290                                                         
         LA    R2,CONRECH                                                       
         GOTO1 MYERROR             EXIT WITH ERROR                              
GETC0290 EQU   *                                                                
         CLI   0(R3),X'03'         SPOT INTERFACE ELEMENT?                      
         BE    GETC0320            YES                                          
         ZIC   RF,1(R3)            NO  - BUMP TO NEXT ELEMENT                   
         AR    R3,RF                                                            
         B     GETC0280            GO BACK FOR NEXT                             
GETC0320 EQU   *                                                                
         MVC   IFSPCL,RPRDSPCL-RPRDSPOT(R3)                                     
*                                  INSERT SPOT CLIENT CODE                      
         MVC   IFSPPRD,RPRDSPP1-RPRDSPOT(R3)                                    
*                                  INSERT SPOT PRODUCT CODE                     
         MVC   IFSPES,RPRDSPES-RPRDSPOT(R3)                                     
*                                  INSERT SPOT ESTIMATE NUMBER                  
         MVC   IFSPPP,RPRDSPP2-RPRDSPOT(R3)                                     
*                                  INSERT SPOT PRODUCT PIGGY                    
         MVC   IFSPP1,RPRDSPS1-RPRDSPOT(R3)                                     
*                                  INSERT SPOT PRODUCT PIGGY SPLIT 1            
         MVC   IFSPP2,RPRDSPS2-RPRDSPOT(R3)                                     
*                                  INSERT SPOT PRODUCT PIGGY SPLIT 2            
         MVC   IFSPST,RCONKSTA     INSERT STATION CALL LETTERS                  
         MVC   IFSPADV,RCONKADV    INSERT REP ADVERTISER                        
         MVC   IFSPRD,RCONPRD      INSERT REP PRODUCT CODE                      
GETC0360 EQU   *                                                                
         MVC   CONMOD#,RCONMOD     SAVE MOD #                                   
*                                                                               
GETC0370 EQU   *                                                                
         SR    R4,R4               SET CC ZERO - CLEAN END                      
ERREXIT  LTR   R4,R4                                                            
         MVC   AIO,AIOAREA         RESTORE AIO TO AIO1                          
         B     EXIT                                                             
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
*    GETVERSN:  RETRIEVE X'20' ELEMENT FROM CONTRACT, SAVE THE                  
*        REP VERSION NUMBER.  BUMP THE NUMBER IF CONTRACT IF                    
*        IT HAS NOT ALREADY                                                     
*        TO SUPPORT WIP IN CONTRACT, THE NEXT REP VERSION NUMBER MUST           
*        BE THE HIGHER OF CURRENT REP NUMBER PLUS 2 *OR* CURRENT STA            
*        NUMBER PLUS 1.                                                         
***********************************************************************         
GETVERSN NTR1                                                                   
         MVI   VERDFLT,1           SET REP VERSION DEFAULT                      
         NI    MYFLAG2,X'FF'-X'80'                                              
*                                                                               
         L     R6,AIO3             SET WORK AREA FOR BUYS                       
         MVI   ELCODE,X'20'                                                     
         BRAS  RE,GETEL                                                         
         BNE   GETVX                                                            
*                                  SAVE THE REP VERSION NUMBER                  
*        CLI   RESENT,C'Y'         CONTRACT IS RESENT?                          
*        BE    GETV0010            YES - NEED VERSION BUMP                      
*                                                                               
*        L     R4,AIO1                                                          
*        USING RDARREC,R4                                                       
*        TM    RDARMISC,X'10'      IF VARIOUS, THIS MIGHT BE A                  
*        BZ    GETV0100            POOL RESENT AFTER ALL                        
*        DROP  R4                                                               
                                                                                
* BUMP REP VERSION IF REP VERSION WAS NOT ADVANCED, ELSE EXIT                   
GETV0010 EQU   *                                                                
         USING RCONSEND,R6                                                      
         TM    RCONSENF,X'20'                                                   
         BZ    GETV0100                                                         
         DROP  R6                                                               
*                                                                               
         OI    MYFLAG2,X'80'       CONTRACT WAS BUMPED                          
         MVC   WORK(4),HELLO                                                    
         MVC   WORK+4(4),DATCON                                                 
         GOTOX (RFGENVER,REPFACS),DMCB,(C'R',AIO3),WORK                         
         BNZ   INVLFLD                                                          
*                                                                               
GETV0100 EQU   *                                                                
         L     R6,AIO3             SET WORK AREA FOR BUYS                       
         MVI   ELCODE,X'20'                                                     
         BRAS  RE,GETEL                                                         
         BNE   GETVX                                                            
         USING RCONSEND,R6                                                      
         MVC   VERDFLT,RCONSRV                                                  
         DROP  R6                                                               
*                                                                               
GETVX    EQU   *                                                                
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
* SET COMMENT FLAG                                                              
**********************************************************************          
SETCMTF  NTR1  BASE=*,LABEL=*                                                   
         XC    CMTFLAG,CMTFLAG                                                  
         XC    KEY,KEY                                                          
         MVC   KEY(RDARKRT-RDARKEY),SELECTKY                                    
         LA    R6,KEY                                                           
         USING RDARKEY,R6                                                       
         MVI   RDARKRT,X'20'       TYPE STANDARD COMMENT                        
         DROP  R6                                                               
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(L'RDARKEY),KEYSAVE                                           
         BNE   SCMT0020            IF STANDARD COMMENT                          
         OI    CMTFLAG,CMTSTAND                                                 
*                                                                               
SCMT0020 DS    0H                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(RDARKRT-RDARKEY),SELECTKY                                    
         LA    R6,KEY                                                           
         USING RDARKEY,R6                                                       
         MVI   RDARKRT,X'30'       TYPE ORDER COMMENT                           
         DROP  R6                                                               
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(L'RDARKEY),KEYSAVE                                           
         BNE   SCMT0050            IF ORDER COMMENT                             
         OI    CMTFLAG,CMTORD                                                   
*                                                                               
SCMT0050 DS    0H                  PRINT REJECTION CMTS IF REQUESTED            
*&&DO                                                                           
         XC    KEY,KEY                                                          
         MVC   KEY(RDARKRT-RDARKEY),SELECTKY                                    
         LA    R6,KEY                                                           
         USING RDARKEY,R6                                                       
         MVI   RDARKRT,X'10'       REJECT CMT IS IN THE HEADER                  
         DROP  R6                                                               
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(L'RDARKEY),KEYSAVE                                           
         BNE   SCMT0070                                                         
*                                                                               
         GOTO1 GETREC                                                           
*&&                                                                             
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   *+8                                                              
         OI    CMTFLAG,CMTREJ                                                   
*                                                                               
SCMT0070 DS    0H                                                               
         XC    KEY,KEY             LOOP THROUGH ALL BUYS FOR COMMENTS           
         MVC   KEY(RDARKRT-RDARKEY),SELECTKY                                    
K        USING RDARKEY,KEY                                                      
         MVI   K.RDARKRT,X'40'                                                  
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
SCMT0075 DS    0H                                                               
         CLC   KEY(RDARKSEQ-RDARKEY),KEYSAVE                                    
         BNE   SCMT0100                                                         
         CLI   K.RDARKSRT,X'20'    BUY COMMENTS?                                
         BNE   SCMT0080            NEXT                                         
         DROP  K                                                                
*                                                                               
         GOTO1 GETREC                                                           
         L     R6,AIO                                                           
         MVI   ELCODE,X'02'                                                     
         BRAS  RE,GETEL                                                         
         BE    SCMT0090                                                         
*                                                                               
SCMT0080 DS    0H                  NEXT                                         
         GOTO1 SEQ                                                              
         B     SCMT0075                                                         
SCMT0090 DS    0H                  HAS BUY COMMENTS, MARK FLAG                  
         OI    CMTFLAG,CMTBUY                                                   
SCMT0100 DS    00H                                                              
*                                                                               
SETCMTFX DS    0H                                                               
         B     EXIT                                                             
***********************************************************************         
* CONVERT AND BUILD DEMO CATEGORIES ELEMENT                                     
* CHECK TO SEE IF THE DEMO CATEGORIES HAVE BEEN CHANGED BETWEEN                 
*  THE AGENCY AND THE REP                                                       
***********************************************************************         
SVAGYDEM NTR1  BASE=*,LABEL=*                                                   
*                                                                               
* SAVE OFF DEMO CATEGORIES TO LATER STORE IN CONTRACT RECORD                    
*                                                                               
         XC    WORK,WORK                                                        
         XC    SVDEMCAT,SVDEMCAT                                                
*                                                                               
         L     R6,AIO1                                                          
         MVI   ELCODE,X'03'                                                     
         BRAS  RE,GETEL                                                         
         BNE   SVDCX                                                            
         USING RDARDMEL,R6                                                      
         ZIC   R1,RDARDMLN                                                      
         SHI   R1,3                SUBTRACT OVERHEAD, AND 1 FOR EX              
         LTR   R1,R1                                                            
         BNZ   *+8                                                              
         LA    R1,L'RDARDEM1       MOVE AT LEAST ONE CATEGORY                   
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   WORK(0),RDARDEM1                                                 
         OC    WORK,SPACES                                                      
         DROP  R6                                                               
*                                                                               
ELEMD    USING RCONDDEL,SVDEMCAT                                                
         MVI   ELEMD.RCONDDCD,X'DD'                                             
         MVI   ELEMD.RCONDDLN,2                                                 
*                                                                               
         LA    R3,10                                                            
         LA    R6,WORK                                                          
         LA    R4,ELEMD.RCONDDCT                                                
*                                                                               
SVDC10   DS    0H                                                               
         CLC   0(L'RDARDEM1,R6),SPACES                                          
         BE    SVDC30                                                           
         CLI   0(R6),C'('          USER DEFINED DEMO?                           
         BNE   *+14                                                             
         MVC   0(3,R4),0(R6)                                                    
         B     SVDC20                                                           
*                                                                               
         MVC   1(1,R4),0(R6)                                                    
         PACK  DUB(8),1(3,R6)                                                   
         CVB   RF,DUB                                                           
         STC   RF,2(R4)                                                         
*                                                                               
SVDC20   DS    0H                                                               
         ZIC   RE,ELEMD.RCONDDLN                                                
         AHI   RE,L'RCONDDCT                                                    
         STC   RE,ELEMD.RCONDDLN                                                
*                                                                               
         AHI   R4,L'RCONDDCT                                                    
         AHI   R6,L'RDARDEM1                                                    
         BCT   R3,SVDC10                                                        
*                                                                               
* CHECK IF THE AGENCY HAS CHANGED THE DEMO CATEGORIES                           
*                                                                               
SVDC30   DS    0H                                                               
         CLC   ELEMD.RCONDDCT,SPACES                                            
         BE    SVDCX                                                            
*                                                                               
         OI    FLAGS2,FG2DEMO      DEFAULT DEMO CHANGED                         
         L     R6,AIO3                                                          
         MVI   ELCODE,X'DD'                                                     
         BRAS  RE,GETEL                                                         
         BNE   SVDCX                                                            
         USING RCONDDEL,R6                                                      
         CLC   ELEMD.RCONDDLN,RCONDDLN                                          
         BNE   SVDCX                                                            
         ZIC   R1,RCONDDLN                                                      
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         CLC   ELEMD.RCONDDCT(0),RCONDDCT                                       
         BNE   SVDCX                                                            
*                                                                               
         NI    FLAGS2,X'FF'-FG2DEMO                                             
*                                                                               
SVDCX    DS    0H                                                               
         XIT1                                                                   
         DROP  R6,ELEMD                                                         
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*---------------------------------------------------------------------          
* DELETE PARTIAL CONFIRM COMMENTS WHEN CONTRACT VERSION GO UP                   
*---------------------------------------------------------------------          
DELCFC   NTR1  BASE=*,WORK=(R4,IMWORKQ),LABEL=*                                 
*                                                                               
         USING IMWORKD,R4                                                       
         MVC   IMSVKEY,KEY                                                      
         MVC   IMSVIO,AIO                                                       
*                                                                               
         L     R2,AIO3                                                          
CON      USING RCONREC,R2                                                       
*                                                                               
         LA    RE,IMIO                                                          
         ST    RE,AIO                                                           
*                                                                               
         XC    KEY,KEY             READ CFC REC                                 
         LA    R6,KEY                                                           
         USING RCFCREC,R6                                                       
*                                                                               
         MVI   RCFCKTYP,RCFCKTYQ   47 RECORD                                    
         MVC   RCFCKREP,CON.RCONKREP                                            
         MVC   RCFCKCON,CON.RCONKCON                                            
         DROP  CON                                                              
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(L'RCFCKEY),KEYSAVE   HAVE CFC REC?                           
         BNE   DELCFCX                  NO - GET OUT                            
*                                                                               
         MVI   RDUPDATE,C'Y'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO                                                           
         OI    RCFCCNTL,X'80'          DELETE RECORD                            
         GOTO1 PUTREC                                                           
*                                                                               
         LA    R6,KEY                                                           
         OI    RCFCKEY+27,X'80'        DELETE KEY                               
         GOTO1 WRITE                                                            
*                                                                               
DELCFCX  DS    0H                                                               
         MVC   AIO,IMSVIO                                                       
         MVC   KEY,IMSVKEY                                                      
         B     EXIT                                                             
         DROP  R4,R6                                                            
         LTORG                                                                  
         EJECT                                                                  
         LTORG                                                                  
***********************************************************************         
* AGENCY BUY PREPROCESSING:                                                     
* DARE AGENCY BUYS WILL BE CONVERTED TO REPPAK BUY FORMAT WITH KEY TYPE         
* X'0B01'                                                                       
***********************************************************************         
SHADOW   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         BAS   RE,DELOLD           DEL EXISTING X'0B01' RECORDS FOR             
*                                  THIS CONTRACT                                
         MVC   KEY(L'SELECTKY),SELECTKY                                         
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(27),KEYSAVE                                                  
         BE    SHAD03              ORDER PROBABLY CONFIRMED                     
         LA    R2,CONACTH          SET CURSOR TO 'ACTION' FIELD                 
         MVC   RERROR,=AL2(53)     SET ERROR MESSAGE                            
         GOTO1 MYERROR             EXIT WITH ERROR                              
*                                                                               
SHAD03   DS    0H                                                               
         MVC   AIO,AIO1            SET IO AREA FOR X'41' RECS                   
         GOTO1 GETREC                                                           
                                                                                
         L     R4,AIO2             SET WORK AREA FOR BUYS                       
         USING RBUYREC,R4                                                       
*                                                                               
         L     R3,AIO                                                           
         USING RDARREC,R3                                                       
*                                                                               
         MVI   RDARKRT,X'40'       SET REC TYPE TO 'BUY'                        
         XC    RDARKSEQ(2),RDARKSEQ                                             
*                                  CLEAR SEQ # AND SUB TYPE                     
         MVC   KEY,RDARKEY         RETRIEVE FIRST BUY HEADER                    
         MVI   RDUPDATE,C'N'       SET UPDATE TO NO                             
         NI    DMINBTS,X'FF'-X'08' SKIP DELETED                                 
         GOTO1 HIGH                                                             
         CLC   KEY(25),KEYSAVE     SAME KEY? THROUGH REC TYPE                   
         BNE   SHADOWX             YES                                          
*                                                                               
         MVI   RDUPDATE,C'N'       SET UPDATE TO NO                             
         MVI   BUYUPDAT,C'Y'       SET 'WRITE OUTPUT RECORD'                    
         GOTO1 GETREC              RETRIEVE RECORD                              
         GOTOR CHKDAREC,DMCB,(R3)                                               
*                                  ROUTINE SETS 'BUYUPDAT' TO NO                
*                                     WHEN HEADER IS SOFT-DELETED.              
*                                     THIS WILL PREVENT OUTPUT.                 
*                                  ALSO SETS 'SKIP RECORD' FLAG FOR             
*                                     OTHER RECORD TYPES                        
         MVI   BUYLINE#,0          INIT BUY NUMBER                              
*                                                                               
SHAD05   EQU   *                                                                
         BAS   RE,BLDBTAB                                                       
         MVI   ORBSTDAY,0          CLEAR 'ORBIT START DAY'                      
         MVI   ORBFLAG,C'N'        SET   'ORBIT NOT PRESENT'                    
         MVI   DETLFLAG,C'N'       CLEAR COUNT OF DETAILS                       
         XCEFL RBUYREC,1024        CLEAR BUY BUILD AREA                         
         MVC   RBUYKTYP(2),=X'0B01' AGENCY BUY SHADOW RECORD TYPE               
         MVC   RBUYKREP,TWAAGY     INSERT REP CODE                              
         MVC   RBUYKCON,COMPCON    INSERT CONTRACT #, 9/COMP/REV                
         MVC   RBUYKPLN,=X'FFFFFF' INSERT PLAN CODE                             
         ZIC   RF,BUYLINE#         GET NEXT BUYLINE NUMBER                      
         LA    RF,1(RF)                                                         
         STC   RF,BUYLINE#         PUT IT BACK                                  
*                                                                               
* STORE AGENCY'S BUY NUMBER IN MASTER LINE NUMBER                               
*                                                                               
*        STC   RF,RBUYKMLN         INSERT MASTER LINE NUMBER                    
         MVC   RBUYKMLN,RDARKSEQ   INSERT AGENCY BUY LINE NUMBER                
*                                                                               
         STC   RF,RBUYKLIN         INSERT LINE NUMBER                           
         MVC   RBUYLEN,=X'004D'    INSERT RECORD LENGTH:                        
*                                     34+43 = 77 = X'4D'                        
         MVC   RBUYELEM(2),=X'012B'                                             
*                                  INSERT ELEMENT CODE/LENGTH                   
         LA    R6,RDARELEM                                                      
         USING RDARBYEL,R6                                                      
         MVC   PROGNAME,RDARBYPN   SAVE BUY HDR PROGRAM NAME                    
         MVC   RBUYCOS,RDARBYCO    INSERT COST                                  
         MVC   BUYCOST,RDARBYCO    SAVE COST FOR CALCULATIONS                   
         MVC   RBUYCLS(6),SPACES   SET CLASS/SECTION TO SPACES                  
         GOTO1 DATCON,DMCB,(5,WORK),(3,RBUYCREA)                                
*                                  INSERT CREATION DATE                         
         MVC   RBUYKMOD,CONMOD#    INSERT CONTRACT MOD #                        
         MVI   RBUYCHGI,C'A'       INSERT CHANGE INDICATOR                      
         MVC   RBUYAGBL,RDARKSEQ   INSERT AGENCY BUY LINE NUMBER                
         XC    STARTDAY(2),STARTDAY                                             
*                                  CLEAR START/END DAYS OF WEEK                 
         GOTOR STARTEND,DMCB,RDARBYRO,RBUYSTED                                  
*                                  CONVERT ONE-BYTE START/END DATE              
         GOTOR EFFDATEL,DMCB,RDARREC                                            
*                                                                               
         MVC   RBUYDUR,RDARBYSL    INSERT TOTAL SPOT LENGTH                     
         CLI   RDARBYSL,C'M'       LENGTH IN MINUTES?                           
         BNE   SHAD10              NO                                           
         OI    RBUYDUR,X'80'       YES - SET 'MINUTES' INDICATOR                
SHAD10   EQU   *                                                                
*                                                                               
         MVC   RBUYVER,VERDFLT     INSERT VERSION NUMBER                        
*                                     FROM REP VERSION NUMBER                   
         OC    IFELCODE(IFELLEN),IFELCODE SPOTPAK XFER ELEMENT?                 
         BZ    SHAD20              NO                                           
         GOTO1 LOADELT,DMCB,(R4),IFELCODE,=C'ADD=CODE'                          
         DROP  R6                                                               
*                                                                               
SHAD20   EQU   *                                                                
         GOTOR SAVEXLNK                                                         
*        GOTOR PROGRAM             SAVE OFF PROGRAM NAME                        
         GOTOR SAVEDEMO            SAVE OFF DEMO VALUES, IF ANY                 
*                                                                               
         L     R6,AIO              IF AGENCY BUY IS A MAKEGOOD                  
         MVI   AGBUYMTR,0                                                       
         MVI   ELCODE,X'10'        NEED TO SAVE OFF TARGET/MASTER               
         BRAS  RE,GETEL            AGENCY BUY FOR BETTER MATCHING               
         BNE   SHAD30                                                           
         USING RDARRVEL,R6                                                      
         MVC   AGBUYMTR,RDARRVBY                                                
         DROP  R6                                                               
*                                                                               
SHAD30   EQU   *                                                                
         MVI   RDUPDATE,C'N'       SET UPDATE TO NO                             
         NI    DMINBTS,X'FF'-X'08' SKIP DELETED                                 
         GOTO1 SEQ                 ACCESS NEXT X'41' RECORD                     
         MVC   SAVEKEY,KEY                                                      
         CLC   KEY(25),KEYSAVE     SAME KEY? THROUGH RECORD TYPE?               
         BE    SHAD40              YES - CONTINUE                               
         CLI   BUYUPDAT,C'Y'       WRITE THIS RECORD?                           
         BNE   SHADOWX             NO  - SKIP THE REWRITE                       
         TM    MISCFLAG,X'80'      'DAILY' BUY?                                 
         BO    SHADOWX             YES - ALREADY WRITTEN                        
*&&CD                                                                           
         TM    MISCFLAG,MFCDATE    CONFLICT END DATE                            
         BO    SHADOWX             YES-ALREADY WRITTEN                          
*&&                                                                             
         GOTOR GENREC                                                           
         B     SHADOWX                                                          
*                                                                               
SHAD40   EQU   *                                                                
         CLC   KEY+25(1),KEYSAVE+25                                             
*                                  SAME BUYLINE #?                              
         BE    SHAD60              YES - CONTINUE                               
         CLI   BUYUPDAT,C'Y'       WRITE THIS RECORD?                           
         BNE   SHAD60              NO  - SKIP THE REWRITE                       
         TM    MISCFLAG,X'80'      'DAILY' BUY?                                 
         BO    SHAD45              YES - DON'T PUT IT OUT                       
         TM    MISCFLAG,MFCDATE    CONFLICT END DATE BUY                        
         BZ    SHAD50              NO  - GO PUT IT OUT                          
SHAD45   EQU   *                                                                
*                                                                               
*   NOTE:  'DAILY'S ARE GENERATED FROM WITHIN THE BUYDETL ROUTINE.              
*      AS SUCH, THE BUYLINE# IS BUMPED AFTER THE RECORD IS WRITTEN.             
*      WHEN THE AGENCY BUY IS COMPLETED, THE BUYLINE # IS SET TO                
*      THE NEXT EXPECTED BUYLINE.  TO ENSURE THAT IT IS NOT DOUBLE-             
*      INCREMENTED, IT IS BACKED OFF HERE.                                      
*      THIS ALSO APPLIES TO CONFLICT END DATE BUYS                              
*                                                                               
         ZIC   RF,BUYLINE#         YES - DROP BUYLINE # BY 1                    
         BCTR  RF,0                                                             
         STC   RF,BUYLINE#                                                      
         B     SHAD60              DON'T PUT IT OUT AGAIN                       
SHAD50   EQU   *                                                                
         GOTOR GENREC                                                           
*                                  NO  - OUTPUT PREVIOUS RECORD                 
SHAD60   EQU   *                                                                
         MVC   AIO,AIO1            SET A(IO AREA 1)                             
         GOTO1 GETREC              RETRIEVE RECORD                              
         GOTOR CHKDAREC,DMCB,(R3)                                               
*                                  ROUTINE SETS 'BUYUPDAT' TO NO                
*                                     WHEN HEADER IS SOFT-DELETED.              
*                                     THIS WILL PREVENT OUTPUT.                 
*                                  ALSO SETS 'SKIP RECORD' FLAG FOR             
*                                     OTHER RECORD TYPES                        
*                                                                               
         CLI   KEY+26,X'00'        BUY HEADER?                                  
         BE    SHAD05              YES - START NEXT HEADER                      
         CLI   KEY+26,X'10'        BUY ORBIT?                                   
         BNE   SHAD70              NO                                           
         CLI   SKIPRECS,C'Y'       SKIP THIS RECORD?                            
         BE    SHAD30              YES - GO BACK FOR NEXT                       
         GOTOR BUYORBIT,DMCB,(R3)                                               
*                                  PROCESS BUY ORBIT RECORD                     
         B     SHAD30              GO BACK FOR NEXT RECORD                      
SHAD70   EQU   *                                                                
         CLI   KEY+26,X'20'        BUY COMMENT?                                 
         BNE   SHAD80              NO                                           
         CLI   SKIPRECS,C'Y'       SKIP THIS RECORD?                            
         BE    SHAD30              YES - GO BACK FOR NEXT                       
         GOTOR BUYCOMMT,DMCB,(R3)                                               
*                                  PROCESS BUY COMMENT RECORD                   
         B     SHAD30              GO BACK FOR NEXT RECORD                      
SHAD80   EQU   *                                                                
         CLI   KEY+26,X'30'        BUY DETAIL?                                  
         BE    *+6                 NO  - ONLY TRAILER LEFT                      
         DC    H'0'                UNKNOWN RECORD SUBTYPE                       
         CLI   SKIPRECS,C'Y'       SKIP THIS RECORD?                            
         BE    SHAD30              YES - GO BACK FOR NEXT                       
         CLC   PROGNAME,SPACES     ANY PROGRAM NAME?                            
         BE    SHAD110             NO  - DON'T NEED COMMENT                     
         CLI   KATZEDI,C'Y'        KATZ/EDI USES ONLY THE FIRST 32              
         BNE   SHAD90              WITH THE LAST 2 FOR DAYPART                  
         CLC   PROGNAME(32),SPACES ANY PROGRAM NAME?                            
         BE    SHAD110             NO  - DON'T NEED COMMENT                     
SHAD90   DS    0H                                                               
         GOTOR GENCOMMT,DMCB,RBUYREC                                            
SHAD110  DS    0H                                                               
         MVC   SAVEKEY,KEY                                                      
         GOTOR BUYDETL,DMCB,(R3)                                                
         BZ    SHAD120                                                          
         MVI   BUYUPDAT,C'N'                                                    
         B     SHAD30                                                           
*                                                                               
SHAD120  DS    0H                                                               
         MVC   KEY,SAVEKEY                                                      
         GOTO1 HIGH                                                             
         B     SHAD30              GO BACK FOR NEXT RECORD                      
         DROP  R3,R4                                                            
*                                                                               
SHADOWX  DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* BLDBTAB: BUILD BUY TABLE                                                      
*          AGENCY INTERNAL BUY (2 BYTES) HAS A ONE TO ONE RELATIONSHIP          
*          WITH THE AGENCY EXTERNAL BUY (1 BYTE)                                
*          THIS IS DONE TO ACOOMODATE XML ORDERS WITH BUY NUMBERS               
*          LARGER THAN 255                                                      
* PARAM: R3->AIO->A(AGENCY DARE BUY RECORD)                                     
* OUTPUT: TABLE ROW IN 2 BYTES AGENCY INTERNAL BUY <-> 1 BYTE EXT BUY           
***********************************************************************         
REC      USING RDARREC,R3                                                       
BLDBTAB  NTR1                                                                   
         L     R6,AIO                                                           
*                                                                               
         MVI   ELCODE,X'10'        ELEMENT CONTAINING INTERNAL BUY#             
         BRAS  RE,GETEL                                                         
         BNE   BUYTX               EXIT                                         
*                                                                               
         USING RDARRVEL,R6                                                      
         OC    RDARLXML,RDARLXML                                                
         BZ    BUYTX                                                            
*                                                                               
         L     RE,ABUYTAB                                                       
         AH    RE,EOBUYTAB                                                      
*                                                                               
         USING BUYTABD,RE          LOAD BUY# INTO THE TABLE                     
         MVC   INTBUY#,REC.RDARKSEQ                                             
         MVC   EXTBUY#,RDARLXML                                                 
*                                                                               
         LH    RE,EOBUYTAB                                                      
         AHI   RE,BUYTABL                                                       
         STH   RE,EOBUYTAB                                                      
*                                                                               
BUYTX    DS    0H                                                               
         B     EXIT                                                             
         DROP  REC                                                              
         DROP  R6                                                               
***********************************************************************         
* DELETE X'0B01' RECORDS FOR THIS DARE ORDER, IF ANY                            
***********************************************************************         
DELOLD   NTR1                                                                   
         LA    R6,KEY                                                           
         USING RBUYREC,R6                                                       
         XC    KEY,KEY                                                          
         MVC   RBUYKTYP(2),=X'0B01' AGENCY BUY SHADOW RECORD TYPE               
         MVC   RBUYKREP,TWAAGY     INSERT REP CODE                              
         MVC   RBUYKCON,COMPCON    INSERT CONTRACT #, 9/COMP/REV                
*                                                                               
         MVC   KEYSAVE,KEY                                                      
         MVI   RDUPDATE,C'Y'                                                    
         GOTO1 HIGH                                                             
*                                                                               
DELOLD10 DS    0H                                                               
         CLC   KEY(RBUYKPLN-RBUYKEY),KEYSAVE                                    
         BNE   DELOLDX                                                          
*                                                                               
         MVC   AIO,AIO2                                                         
         L     R6,AIO                                                           
         USING RBUYREC,R6                                                       
         MVI   RDUPDATE,C'Y'                                                    
         GOTO1 GETREC                                                           
         OI    RBUYCNTL,X'80'      MARK DELETED                                 
         GOTO1 PUTREC                                                           
         DROP  R6                                                               
*                                                                               
         OI    KEY+27,X'80'                                                     
         GOTO1 WRITE                                                            
*                                                                               
         MVI   RDUPDATE,C'Y'                                                    
         GOTO1 SEQ                                                              
         B     DELOLD10                                                         
*                                                                               
DELOLDX  DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*   CHKDAREC:  CHECKS FOR TYPE OF DARE RECORD.  IF SOFT DELETE                  
*        BIT OR HARD DELETE BIT IS SET, CC IS SET TO NON-ZERO,                  
*        INDICATING THAT RECORD IS TO BE SKIPPED/NOT PROCESSED.                 
*        SOFT DELETE BIT (X'80') WILL ALWAYS BE SET WHEN HARD BIT               
*        (X'40') IS SET.  THEREFORE, ONLY SOFT BIT IS TESTED.                   
***********************************************************************         
CHKDAREC NTR1  BASE=*,LABEL=*                                                   
         L     R2,0(R1)            RESET A(DARE RECORD IN PROCESS)              
         USING RDARREC,R2                                                       
*                                                                               
         MVI   SKIPRECS,C'N'       SET 'SKIP RECORD' TO NO                      
*                                                                               
         CLI   RDARKRT,X'10'       AGENCY ORDER HEADER?                         
         BNE   CDAR0040            NO                                           
         LA    R3,RDARELEM         YES -                                        
         USING RDARELEM,R3                                                      
*                                                                               
         TM    RDARDELS,X'80'      SOFT DELETE SET?                             
         BNO   CDAR0900            NO  - EXIT WITH 'PROCESS RECORD'             
         ZIC   RF,BUYLINE#         YES - BUMP LINE NUMBER                       
         LA    RF,1(RF)                                                         
         STC   RF,BUYLINE#         PUT IT BACK                                  
         B     CDAR0800            EXIT WITH 'SKIP RECORD'                      
         DROP  R3                                                               
CDAR0040 EQU   *                                                                
         CLI   RDARKRT,X'40'       BUY?                                         
         BNE   CDAR0080            NO                                           
         CLI   RDARKSRT,X'00'      BUY HEADER?                                  
         BNE   CDAR0120            NO  - ORB/COMMT/DETAIL                       
*                                                                               
         LA    R3,RDARELEM         YES -                                        
         USING RDARBYEL,R3                                                      
*                                                                               
         MVI   BUYUPDAT,C'Y'       SET WRITE FLAG TO YES                        
         ZIC   RF,RDARBYLN         CHECK LENGTH                                 
         LA    RE,RDARBYOL         SET OLD ELEMENT LENGTH                       
         CR    RF,RE               COMPARE OLD VS NEW                           
         BE    CDAR0900            EQUAL: OLD LENGTH FOUND -                    
*                                     NOT KEY-DELETED:  MUST NOT                
*                                     BE SOFT DELETED.                          
CDAR0050 EQU   *                                                                
         TM    RDARBYDL,X'80'      SOFT DELETE SET?                             
         BNO   CDAR0900            NO  - EXIT WITH 'PROCESS RECORD'             
         MVI   BUYUPDAT,C'N'       YES - SET WRITE FLAG TO NO                   
         B     CDAR0800            EXIT WITH 'SKIP RECORD'                      
         DROP  R3                                                               
CDAR0080 EQU   *                                                                
         BH    CDAR0800            SKIP OVER RECORD TYPES                       
*                                     50 (TRAILER) + 60 (EQUIVS)                
*                                        THESE AREN'T SOFT-DELETED.             
CDAR0120 EQU   *                                                                
*                                                                               
*                                  ONLY BUYS WILL HAVE RDARKSRT                 
*                                     SET - STANDARD AND ORDER                  
*                                        COMMENTS WILL NOT                      
         CLI   RDARKSRT,X'30'      BUY DETAIL?                                  
         BL    CDAR0280            NO  - ORB/COMMT                              
         LA    R3,RDARELEM         YES - CHECK FOR MULTI RATES                  
         USING RDARBDEL,R3                                                      
*                                                                               
         TM    RDARBDDL,X'80'      SOFT DELETE SET?                             
         BNO   CDAR0900            NO  - EXIT WITH 'PROCESS RECORD'             
         MVI   SKIPRECS,C'Y'       YES - SET SKIP RECORD TO YES                 
         B     CDAR0800            FINISHED                                     
         DROP  R3                                                               
*                                                                               
CDAR0280 EQU   *                                                                
*                                                                               
*   REMAINING RECORD TYPES ARE 15, 20, 30, 40/10, 40/20, AND                    
*        SOFT/HARD DELETE BYTE IS IN SAME PLACE IN ALL ELEMENTS.                
*        STANDARD COMMENT ELEMENT FORMAT USED, ARBITRARILY.                     
*                                                                               
         LA    R3,RDARELEM                                                      
         USING RDARELE2,R3                                                      
*                                                                               
         TM    RDARELDL,X'80'      SOFT DELETE SET?                             
         BNO   CDAR0900            NO  - EXIT WITH 'PROCESS RECORD'             
         MVI   SKIPRECS,C'Y'       YES - SET SKIP RECORD TO YES                 
         B     CDAR0800            EXIT WITH 'SKIP RECORD'                      
         DROP  R3                                                               
CDAR0800 EQU   *                                                                
         LTR   RB,RB               SET CC NOT = ZERO                            
         B     CDAR1000                                                         
CDAR0900 EQU   *                                                                
         SR    R0,R0               SET CC = ZERO                                
CDAR1000 EQU   *                                                                
         B     EXIT                                                             
         DROP  R2                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
* BUILDS ACTUAL AGENCY LINK FOR XML ORDERS IN X'1D' ELEMENT IN BUY              
**********************************************************************          
SAVEXLNK NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R6,AIO1                                                          
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   SVXLXIT                                                          
         USING RDARRVEL,R6                                                      
         OC    RDARLXML,RDARLXML                                                
         BZ    SVXLXIT                                                          
*                                                                               
         XC    ELEM,ELEM                                                        
ELEMD    USING RBUYDREL,ELEM                                                    
         MVI   ELEMD.RBUYDRCD,RBUYDRCQ                                          
         MVI   ELEMD.RBUYDRLN,RBUYDRLQ                                          
         MVC   ELEMD.RBUYDRXL,RDARLXML                                          
*                                                                               
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),AIO2,ELEM,=C'ADD=CODE'             
*                                                                               
SVXLXIT  DS    0H                                                               
         B     EXIT                                                             
         DROP  R6,ELEMD                                                         
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
* BUILDS DEMO ELEMENT                                                           
**********************************************************************          
SAVEDEMO NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R6,AIO1                                                          
         MVI   ELCODE,X'20'                                                     
         BRAS  RE,GETEL                                                         
         BNE   SVDEMX                                                           
         USING RDARBMEL,R6                                                      
*                                                                               
         SR    R2,R2                                                            
         ZIC   R3,RDARBMLN                                                      
         SHI   R3,2                SUBTRACT OVERHEAD                            
         LA    RE,L'RDARBDM1                                                    
         DR    R2,RE               GET NUMBER OF DEMOS TO PROCESS               
*                                                                               
         LA    R6,RDARBDM1                                                      
         DROP  R6                                                               
*                                                                               
         XC    ELEM,ELEM                                                        
ELEMD    USING RBUYDMEL,ELEM                                                    
         MVI   ELEMD.RBUYDMCD,RBUYDMCQ                                          
         MVI   ELEMD.RBUYDMLN,2                                                 
         LA    R4,ELEMD.RBUYDMCT                                                
         LA    R2,SVDEMCAT+2                                                    
*                                                                               
SVDEM10  DS    0H                                                               
         MVC   0(L'RBUYDMCT,R4),0(R2)                                           
         AHI   R4,L'RBUYDMCT                                                    
         MVC   0(8,R4),=8X'FF'     -1 MEANS VALUE NOT PROVIDED                  
         CLC   0(L'RDARBDM1,R6),SPACES                                          
         BE    SVDEM20                                                          
         PACK  DUB(8),0(7,R6)                                                   
         L     RF,DUB+4                                                         
         SRL   RF,4                DUMP THE SIGN                                
         STCM  RF,15,0(R4)                                                      
*                                                                               
SVDEM20  DS    0H                                                               
         AHI   R6,L'RDARBDM1                                                    
         AHI   R4,L'RBUYDMDM+L'RBUYDM2M                                         
         ZIC   RE,ELEMD.RBUYDMLN                                                
         AHI   RE,L'RBUYDMCT+L'RBUYDMDM+L'RBUYDM2M                              
         STC   RE,ELEMD.RBUYDMLN                                                
*                                                                               
         AHI   R2,L'RCONDDCT                                                    
*                                                                               
         BCT   R3,SVDEM10                                                       
*                                                                               
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),AIO2,ELEM,=C'ADD=CODE'             
*                                                                               
SVDEMX   DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*   BUYORBIT:  BUILDS DAY-TIME ELEMENT FROM THE ORBIT ELEMENTS                  
*        IN THE RECORD, INSERTS THEM INTO THE NEW BUY RECORD.                   
***********************************************************************         
BUYORBIT NTR1  BASE=*,LABEL=*                                                   
         L     R3,0(R1)            RESET A(X'41' RECORD)                        
         USING RDARREC,R3                                                       
         LA    R8,RDARELEM         SET A(X'01' ELEMENT)                         
         ZIC   RF,1(R8)            GET LENGTH                                   
         AR    R8,RF               BUMP TO 1ST ORBIT ELEMENT                    
         MVI   ORBFLAG,C'Y'        SET 'ORBIT PRESENT' INDICATOR                
*                                     ORBIT TAKES PRIORITY OVER                 
*                                     BUY DAY/TIME ELTS                         
BORB0040 EQU   *                                                                
*                                  CLEAR START/END DAYS                         
         CLI   0(R8),0             END OF RECORD?                               
         BE    BORB0400            YES - FINISHED                               
*                                                                               
         USING RDAROEEL,R8                                                      
*                                                                               
         XC    ELTBUILD,ELTBUILD   CLEAR ELEMENT BUILD AREA                     
         XC    STARTDAY(2),STARTDAY                                             
*                                  CLEAR START/END DAYS                         
         MVC   ELTBUILD(2),=X'0209'                                             
*                                  INSERT ELEMENT CODE/LENGTH                   
         GOTOR STARTEND,DMCB,RDAROERO,ELTBUILD+2                                
*                                  INSERT START/END DAY                         
         CLI   ORBSTDAY,0          ANY ENTRY IN ORBIT START DAY?                
         BNE   BORB0060            YES - DON'T REPLACE IT                       
         MVC   ORBSTDAY,STARTDAY   NO  - SAVE FIRST ORBIT START DAY             
*                                                                               
* EARLIEST ORBIT START DAY MIGHT BE LATER THAN CURRENT STAY DAY AS              
* SPECIFIED IN THE BUY HEADER. WE'LL TAKE THE FIRST ORBIT START DAY             
* AS THE OVERALL BUY START DAY                                                  
*                                                                               
* NOTE THAT THIS ASSUMES DAILYS SHOULD NEVER BE ACCOMPANIED WITH                
* ORBITS!!                                                                      
*                                                                               
         L     R2,AIO2             A(BUY RECORD IN PROGRESS)                    
         USING RBUYREC,R2                                                       
         ZIC   RF,ORBSTDAY                                                      
         SLL   RF,4                SHIFT TO LOW ORDER, HI NIBBLE                
         ZIC   RE,RBUYSTED                                                      
         SLL   RE,8+8+8+4          SHIFT OFF HI NIBBLE OR CURRENT               
         SRL   RE,8+8+8+4          START DAY                                    
         AR    RE,RF                                                            
         STC   RE,RBUYSTED                                                      
         DROP  R2                                                               
*                                                                               
BORB0060 EQU   *                                                                
         SR    RE,RE               INITIALIZE FINAL OUTPUT                      
         LA    RF,7                SET LOOP CONTROL                             
         LA    R1,RDAROERO         SET A(ROTATION ARRAY)                        
BORB0080 EQU   *                                                                
         CLI   0(R1),C' '          DAY SET?                                     
         BE    BORB0120            NO                                           
         CLI   0(R1),0             DAY SET?                                     
         BE    BORB0120            NO                                           
         LA    RE,1(RE)            YES - TURN ON LOW-ORDER BIT                  
BORB0120 EQU   *                                                                
         SLL   RE,1                SHIFT UP 1 'DAY'                             
         LA    R1,1(R1)            BUMP TO NEXT ARRAY POSITION                  
         BCT   RF,BORB0080         GO BACK AND TEST NEXT                        
         SRL   RE,1                SHIFT BACK 1 'DAY'                           
         STC   RE,ELTBUILD+3       INSERT DAYS INTO ELEMENT                     
         MVC   ELTBUILD+4(4),RDAROEST                                           
*                                  INSERT START/END TIMES INTO ELEMENT          
         MVI   ELTBUILD+8,1        INSERT WEIGHT OF 1                           
*                                  THIS DOESN'T SEEM TO CHANGE                  
*                                     NO IDEA WHY.....                          
         L     R2,AIO2             A(BUY RECORD IN PROGRESS)                    
         GOTO1 LOADELT,DMCB,(R2),ELTBUILD,=C'ADD=CODE'                          
*                                                                               
*   NOTE:  DAY/TIME ELEMENTS ENTERED VIA ORBITS WILL BE DELETED IF              
*      BUY HAS BEEN ENTERED AS A 'DAILY' BUY.  THIS SHOULD NOT HAPPEN,          
*      BUT HAS BEEN HANDLED IF IT DOES.                                         
*                                                                               
         ZIC   RF,1(R8)                                                         
         AR    R8,RF                                                            
         B     BORB0040            GO BACK FOR NEXT ELEMENT                     
BORB0400 EQU   *                                                                
         B     EXIT                                                             
         DROP  R3,R8                                                            
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*   BUYCOMMT:  BUILDS BUY COMMENT ELEMENT FOR THE FIRST TWO COMMENTS            
*        IN THE RECORD, INSERTS THEM INTO THE NEW BUY RECORD.                   
***********************************************************************         
BUYCOMMT NTR1  BASE=*,LABEL=*                                                   
         L     R3,0(R1)            RESET A(X'41' RECORD)                        
         USING RDARREC,R3                                                       
*                                                                               
         L     R2,AIO2             A(BUY RECORD IN PROGRESS)                    
         LA    R4,2                LOOP CONTROL:                                
*                                     FIRST TWO ARE BUY COMMENTS                
*                                     NEXT  TWO ARE BUY ORDER COMMENTS          
         L     R8,ASPOOLD                                                       
         USING SPOOLD,R8                                                        
         CLC   PROGNAME,SPACES     ANY PROGRAM NAME?                            
         BE    BCOM0020            NO  - PROCEED                                
         CLI   KATZEDI,C'Y'        KATZ/EDI USES ONLY THE FIRST 32              
         BNE   BCOM0005            WITH THE LAST 2 FOR DAYPART                  
*                                                                               
*                                  REMOVE OLD X'ED' DAYPART CODE                
         GOTO1 HELLO,DMCB,(C'D',=C'REPFILE'),(X'ED',(R2)),0,0                   
         XC    ELEMENT,ELEMENT     FOR KATZ/EDI ADD THE DAYPART CODE            
         LA    R6,ELEMENT          ELEMENT                                      
         USING RBUYEDEL,R6                                                      
         MVI   RBUYEDCD,X'ED'                                                   
         MVI   RBUYEDLN,RBUYEDLQ                                                
         MVC   RBUYEDDP,PROGNAME+32                                             
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),(R2),ELEMENT,0                     
         DROP  R6                                                               
*                                                                               
         CLC   PROGNAME(32),SPACES ANY PROGRAM NAME?                            
         BE    BCOM0020            NO  - DON'T NEED COMMENT                     
         DROP  R8                                                               
*                                                                               
BCOM0005 EQU   *                                                                
         XC    ELTBUILD,ELTBUILD   CLEAR ELEMENT BUILD AREA                     
         MVI   ELTBUILD,X'04'      INSERT ELEMENT CODE                          
*                                  CLEAR WORKSPACE                              
         LA    R6,PROGNAME+33      SCAN PROGRAM NAME FOR BLANKS                 
         LA    RF,34               LOOP CONTROL                                 
         CLI   KATZEDI,C'Y'        KATZ/EDI USES ONLY THE FIRST 32              
         BNE   BCOM0010            WITH THE LAST 2 FOR DAYPART                  
         LA    R6,PROGNAME+31      SCAN PROGRAM NAME FOR BLANKS                 
         LA    RF,32               LOOP CONTROL                                 
BCOM0010 EQU   *                                                                
         CLI   0(R6),C' '          CHARACTER = SPACE?                           
         BNE   BCOM0015            NO  - LAST CHARACTER FOUND                   
         BCTR  R6,0                YES - BACK UP 1 SPACE                        
         BCT   RF,BCOM0010         LOOP THROUGH ALL                             
         DC    H'0'                SHOULDN'T HAPPEN:  SPACES CHECKED            
BCOM0015 EQU   *                                                                
         LA    RF,1(RF)            ADD 1 FOR KEYWORD (+2 -1 FOR EX)             
         MVC   ELTBUILD+2(2),=C'P='                                             
*                                  INSERT KEYWORD                               
         EX    RF,BCOM0505         MOVE PROGRAM NAME BY LENGTH                  
         LA    RF,3(RF)            RESTORE LENGTH + L(CONTROLS)                 
         STC   RF,ELTBUILD+1       INSERT LENGTH INTO ELEMENT                   
*                                                                               
* SKIP BUILDING P= COMMENT PROGRAM NAME ELEMENT                                 
*                                                                               
*        GOTO1 LOADELT,DMCB,(R2),ELTBUILD,=C'ADD=CODE'                          
*                                                                               
* BUILD DEDICATED PROGRAM NAME ELEMENT                                          
*                                                                               
         MVI   ELTBUILD,X'21'      PROGRAM NAME ELEMENT                         
         XC    ELTBUILD+2(L'ELTBUILD-2),ELTBUILD+2                              
         ZIC   RF,ELTBUILD+1       REUSE LENGTH FROM THE P= COMMENT             
         SHI   RF,2                ELEMENT TO BUILD LENGTH OF                   
         STC   RF,ELTBUILD+1       PROGRAM NAME ELEMENT                         
         SHI   RF,1                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   ELTBUILD+2(0),PROGNAME                                           
         GOTO1 LOADELT,DMCB,(R2),ELTBUILD,=C'ADD=CODE'                          
*                                                                               
         MVI   PROGNAME,C' '       CLEAR THE PROGRAM NAME                       
         MVC   PROGNAME+1(L'PROGNAME-1),PROGNAME                                
         BCTR  R4,0                SUBTRACT 1 FROM COMMENT COUNT                
BCOM0020 EQU   *                                                                
         LA    R8,RDARELEM         SET A(X'01' ELEMENT)                         
         ZIC   RF,1(R8)            GET LENGTH                                   
         AR    R8,RF               BUMP TO 1ST COMMT ELEMENT                    
BCOM0040 EQU   *                                                                
****                                                                            
**** SKIP FOR REVISION                                                          
****                                                                            
         B     BCOM0400            SKIP REST OF COMMENTS                        
****                                                                            
         CLI   0(R8),0             END OF RECORD?                               
         BE    BCOM0400            YES - FINISHED                               
*                                                                               
         USING RDARCTEL,R8                                                      
*                                                                               
         XC    ELTBUILD,ELTBUILD   CLEAR ELEMENT BUILD AREA                     
         MVI   ELTBUILD,X'04'      INSERT ELEMENT CODE                          
         ZIC   R1,1(R8)            GET ELEMENT LENGTH                           
         LA    RF,3                DECREMENT FOR EX + CTRL                      
         SR    R1,RF                                                            
         LA    RE,59               MAX SIZE FOR REP COMMENTS = 60               
         CR    R1,RE               NEW INPUT VS REP MAX                         
         BNH   BCOM0060            ACCEPTABLE                                   
         LR    R1,RE               NOT ACCEPTABLE                               
BCOM0060 EQU   *                                                                
         EX    R1,BCOM0500         MOVE ELEMENT TO BUILT AREA                   
         LA    R1,3(R1)            SET ELEMENT LENGTH                           
         STC   R1,ELTBUILD+1       INSERT ELEMENT LENGTH                        
         GOTO1 LOADELT,DMCB,(R2),ELTBUILD,=C'ADD=CODE'                          
         ZIC   RF,1(R8)                                                         
         AR    R8,RF                                                            
         BCT   R4,BCOM0040         GO BACK FOR NEXT ELEMENT                     
*                                     IF COUNT < 2                              
         LA    R4,2                IF MORE COMMENTS, PUT TO                     
*                                     BUY ORDER COMMENT RECORDS                 
BCOM0080 EQU   *                                                                
         CLI   0(R8),0             END OF RECORD?                               
         BE    BCOM0400            YES - FINISHED                               
*                                                                               
         XC    ELTBUILD,ELTBUILD   CLEAR ELEMENT BUILD AREA                     
         MVI   ELTBUILD,X'84'      INSERT ELEMENT CODE                          
         ZIC   R1,1(R8)            GET ELEMENT LENGTH                           
         LA    RF,3                DECREMENT FOR EX + CTRL                      
         SR    R1,RF                                                            
*                                                                               
         CH    R1,=H'60'           TRUNCATE IF MORE THAN 60 CHARS.              
         BL    BCOM0090                                                         
         LA    R1,59               MAX - 1 FOR EX                               
*                                                                               
BCOM0090 EQU   *                                                                
         EX    R1,BCOM0510         MOVE ELEMENT TO BUILD AREA                   
         LA    R1,4(R1)            RESET ELEMENT LENGTH                         
         STC   R1,ELTBUILD+1       INSERT ELEMENT LENGTH                        
         MVI   ELTBUILD+2,X'80'    TURN ON 'SENT BY REP'                        
         GOTO1 LOADELT,DMCB,(R2),ELTBUILD,=C'ADD=CODE'                          
         ZIC   RF,1(R8)                                                         
         AR    R8,RF                                                            
         BCT   R4,BCOM0080         GO BACK FOR NEXT ELEMENT                     
*                                     IF COUNT < 2                              
BCOM0400 EQU   *                                                                
         B     EXIT                                                             
*                                                                               
BCOM0500 MVC   ELTBUILD+2(0),2(R8) SET UP BUY COMMENT                           
*                                                                               
BCOM0505 MVC   ELTBUILD+4(0),PROGNAME                                           
*                                  SET UP PROGRAM NAME COMMENT                  
BCOM0510 MVC   ELTBUILD+3(0),2(R8) SET UP BUY ORDER COMMENT                     
*                                                                               
         DROP  R3,R8                                                            
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*   EFFDATEL:  BUILD AN ALTERNATE X'02' ELEMENT IN EVENT THERE                  
*        ARE NO ORBIT RECORDS.                                                  
***********************************************************************         
EFFDATEL NTR1  BASE=*,LABEL=*                                                   
         L     R3,0(R1)            RESET A(X'41' RECORD)                        
         USING RDARREC,R3                                                       
         LA    R8,RDARELEM         SET A(X'01' ELEMENT)                         
         USING RDARBYEL,R8                                                      
*                                                                               
         XC    STARTDAY(2),STARTDAY                                             
*                                  CLEAR START/END DAY WORK AREA                
         XC    ELTBILD2,ELTBILD2   CLEAR ELEMENT BUILD AREA                     
         MVC   ELTBILD2(2),=X'0209'                                             
*                                  INSERT ELEMENT CODE/LENGTH                   
         GOTOR STARTEND,DMCB,RDARBYRO,ELTBILD2+2                                
*                                  INSERT START/END DAY                         
                                                                                
         SR    RE,RE               INITIALIZE FINAL OUTPUT                      
         LA    RF,7                SET LOOP CONTROL                             
         LA    R1,RDARBYRO         SET A(ROTATION ARRAY)                        
EFFD0080 EQU   *                                                                
         CLI   0(R1),C' '          DAY SET?                                     
         BE    EFFD0120            NO                                           
         CLI   0(R1),0             DAY SET?                                     
         BE    EFFD0120            NO                                           
         LA    RE,1(RE)            YES - TURN ON LOW-ORDER BIT                  
EFFD0120 EQU   *                                                                
         SLL   RE,1                SHIFT UP 1 'DAY'                             
         LA    R1,1(R1)            BUMP TO NEXT ARRAY POSITION                  
         BCT   RF,EFFD0080         GO BACK AND TEST NEXT                        
         SRL   RE,1                SHIFT DOWN 1 'DAY' FOR                       
*                                     PROPER ALIGNMENT                          
         STC   RE,ELTBILD2+3       INSERT DAYS INTO ELEMENT                     
         ZICM  RF,RDARBYST,2       CHECK START TIME                             
         C     RF,=F'2400'         AFTER MIDNIGHT?                              
         BNH   EFFD0160            NO  - LEAVE AS IS.....                       
         S     RF,=F'2400'         YES - SUBTRACT 2400 FROM FIGURE              
EFFD0160 EQU   *                                                                
         STCM  RF,3,ELTBILD2+4     SAVE START TIME                              
*                                                                               
         CLC   RDARBYST,RDARBYET   IF SAME, SKIP END TIME                       
         BE    EFFD0210                                                         
*                                                                               
         ZICM  RF,RDARBYET,2       CHECK END   TIME                             
         C     RF,=F'2400'         AFTER MIDNIGHT?                              
         BNH   EFFD0200            NO  - LEAVE AS IS.....                       
         S     RF,=F'2400'         YES - SUBTRACT 2400 FROM FIGURE              
EFFD0200 EQU   *                                                                
         STCM  RF,3,ELTBILD2+6     SAVE END   TIME                              
*                                  INSERT START/END TIMES INTO ELEMENT          
EFFD0210 EQU   *                                                                
         MVI   ELTBILD2+8,1        INSERT WEIGHT OF 1                           
*                                  THIS DOESN'T SEEM TO CHANGE                  
*                                     NO IDEA WHY.....                          
         B     EXIT                                                             
*                                                                               
         DROP  R3,R8                                                            
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*   STARTEND:  CONVERTS ROTATION MATRIX AND START DAY TO ONE-BYTE               
*        START/END DAY, INSERTS INTO ADDRESS                                    
***********************************************************************         
STARTEND NTR1  BASE=*,LABEL=*                                                   
         L     R2,0(R1)            A(INPUT: ROTATION+START DAY)                 
         L     R3,4(R1)            A(RECEIVING FIELD)                           
*                                                                               
         ZIC   RF,7(R2)            ROTATION START DAY                           
         SLL   RF,28               STRIP OFF ZONE BITS                          
         SRL   RF,28               SHIFT START DAY BACK                         
         STC   RF,ROTATDAY         SAVE ROTATION START DAY                      
*                                                                               
         TM    SVDARFL2,SF2XML     USE ORDER ROTATION START DAY IF XML          
         BZ    STEX0020                                                         
         CLI   ORDROTST,0                                                       
         BE    STEX0020                                                         
         ZIC   RF,ORDROTST         ROTATION START DAY                           
         SLL   RF,28               STRIP OFF ZONE BITS                          
         SRL   RF,28               SHIFT START DAY BACK                         
         STC   RF,ROTATDAY         SAVE ROTATION START DAY                      
*                                                                               
STEX0020 EQU   *                                                                
         LA    R8,0(R2)            A(ROTATION FIELD)                            
         LR    RE,R8               CALCULATE END OF ROTATION FIELD              
         LA    RE,7(RE)                                                         
         AR    R8,RF               GET A(1ST DAY+1)                             
         BCTR  R8,0                BACK OFF TO A(1ST ENTRY)                     
         LR    RF,R8               SAVE A(1ST ENTRY)                            
*                                     FOR WHEN 1ST ENTRY IS ONLY ENTRY          
         LA    R0,7                SET LOOP CONTROL TO SIX DAYS                 
STEX0040 EQU   *                                                                
         CR    R8,RE               END OF ROTATION FIELD REACHED?               
         BNE   STEX0080            NO                                           
         LA    R8,0(R2)            YES  - GO BACK TO FIRST LOCATION             
STEX0080 EQU   *                                                                
         CLI   0(R8),C' '          ARRAY POSITION USED?                         
         BE    STEX0200            NO  - SKIP IT                                
         CLI   0(R8),0             ARRAY POSITION USED?                         
         BE    STEX0200            NO  - SKIP IT                                
         CLI   STARTDAY,0          ANYTHING IN START DAY?                       
         BNE   STEX0120            YES - DON'T REPLACE                          
         LA    R4,7                NO  - CALCULATE STARTDAY                     
         SR    R4,R0               SUBTRACT REMAINING DAYS                      
         ZIC   R1,ROTATDAY         OFFSET BY ROTATION START DAY                 
         AR    R4,R1                                                            
         CH    R4,=H'7'            WRAPAROUND?                                  
         BNH   STEX0100            NO                                           
         SH    R4,=H'7'            YES - SUBTRACT 7                             
STEX0100 EQU   *                                                                
         STC   R4,STARTDAY         SAVE CALCULATED STARTDAY                     
STEX0120 EQU   *                                                                
         OC    0(1,R3),0(R3)       RECEIVING FIELD ENTRY MADE?                  
         BNZ   STEX0160            YES - START DAY ENTERED                      
         SLL   R4,4                NO  - MOVE START DAY TO HIGH NYBBLE          
         STC   R4,0(R3)            INSERT INTO RECORD                           
STEX0160 EQU   *                                                                
         LR    RF,R8               YES - SAVE NEW ARRAY POSITION                
STEX0200 EQU   *                                                                
         LA    R8,1(R8)            BUMP TO NEXT ARRAY LOCATION                  
         BCT   R0,STEX0040         GO BACK AND CHECK NEXT                       
         LA    R8,0(R2)            A(START OF ARRAY)                            
         BCTR  R8,0                BACK UP 1 POSITION                           
         SR    RF,R8               CALCULATED DISPLACEMENT                      
         STC   RF,ENDDAY           SAVE END DAY FOR EFF DATE SETTING            
         ZIC   RE,0(R3)            RETRIEVE START DAY                           
         AR    RF,RE               ADD START TO END                             
         STC   RF,0(R3)            PUT IT BACK IN RECORD                        
         LA    R8,0(R2)            COUNT NUMBER OF DAYS                         
         SR    RF,RF                                                            
         LA    R0,7                                                             
STEX0240 EQU   *                                                                
         CLI   0(R8),C' '          DAY ACTIVE?                                  
         BE    STEX0280            NO                                           
         CLI   0(R8),0             DAY ACTIVE?                                  
         BE    STEX0280            NO                                           
         LA    RF,1(RF)            YES - ADD 1                                  
STEX0280 EQU   *                                                                
         LA    R8,1(R8)            BUMP TO NEXT POSITION                        
         BCT   R0,STEX0240         GO BACK AND CHECK NEXT                       
         C     RF,=F'1'            COUNT = 1?                                   
         BH    STEX0320            NO  - HIGHER - EXIT                          
         BE    *+6                 YES - SET START=END IN RECORD                
         DC    H'0'                SHOULD NEVER HAPPEN                          
*                                     MEANS EMPTY ARRAY!!!                      
         ZIC   RF,0(R3)            RETRIEVE START/END DAY                       
         SLL   RF,28               DROP START DAY                               
         SRL   RF,24               MOVE END DAY BACK TO HI NYBBLE               
         NI    0(R3),X'0F'         CLEAR START DAY                              
         ZIC   RE,0(R3)            RETRIEVE 0/END DAY                           
         AR    RE,RF               ADD NEW START DAY                            
         STC   RE,0(R3)            MOVE IT BACK                                 
STEX0320 EQU   *                                                                
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*   BUYDETL:  BUILDS BUY EFFECTIVE DATE ELEMENTS, THEN INSERTS                  
*        THEM INTO THE NEW BUY RECORD.                                          
***********************************************************************         
BUYDETL  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R3,0(R1)            RESET A(X'41' RECORD)                        
         USING RDARREC,R3                                                       
*                                                                               
         GOTO1 DATCON,DMCB,(2,FLTDATES),(3,WORK)                                
         CLC   RTKODATE,WORK                                                    
         BNH   BDET0010                                                         
*                                                                               
         ST    R3,DMCB             SETUP CHOPPING CALL                          
         MVC   DMCB+4(3),RTKODATE                                               
         MVC   DMCB+8(1),STARTDAY                                               
         MVC   DMCB+9(1),ENDDAY                                                 
         MVC   DMCB+10(1),ROTATDAY                                              
         MVC   DMCB+11(1),ORBSTDAY                                              
         XC    WORK,WORK                                                        
         MVC   WORK(4),DATCON                                                   
         MVC   WORK+4(4),GETDAY                                                 
         MVC   WORK+8(4),ADDAY                                                  
         MVC   WORK+12(4),PERVERT                                               
         LA    RE,WORK                                                          
         ST    RE,DMCB+12                                                       
*                                                                               
         GOTO1 VREDARTK,DMCB                                                    
         BNE   BDETNO              BUY DELETED, EXIT                            
*                                                                               
BDET0010 EQU   *                                                                
         TM    FLAGS,FGTOTALQ      TOTAL ONLY, SKIP REST OF PROCESSING?         
         BO    BDETYES                                                          
*                                                                               
         LA    R8,RDARELEM         SET A(X'01' ELEMENT)                         
         DROP  R3                                                               
         USING RDARBDEL,R8         BUY DETAIL DESCRIP ELEMENT                   
*                                                                               
         L     R2,AIO2             A(BUY RECORD IN PROGRESS)                    
         USING RBUYREC,R2                                                       
*&&CD                                                                           
         NI    MISCFLAG,X'FF'-MFCDATE                                           
         TM    RDARBDFL,X'10'                                                   
         BNO   BDET0015                                                         
         OI    MISCFLAG,MFCDATE    MARK COST OVERRIDE FLAG                      
*&&                                                                             
BDET0015 EQU   *                                                                
         NI    MISCFLAG,X'7F'      TURN OFF 'DAILY' BUY FLAG                    
         TM    RDARBDFL,X'80'      'DAILY' BUY?                                 
         BNO   BDET0020            NO                                           
         OI    MISCFLAG,X'80'      SET FLAG FOR 'DAILY' BUY                     
BDET0020 EQU   *                                                                
         TM    MISCFLAG,X'80'      'DAILY' BUY?                                 
         BNO   BDET0030            NO                                           
         CLI   ORBFLAG,C'Y'        ANY ORBIT RECORDS?                           
         BNE   BDET0040            NO                                           
         GOTO1 DELELT02,DMCB,RBUYREC                                            
*                                  CLEAR ORBIT X'02' DAY/TIME ELTS              
         MVI   ORBFLAG,C'N'        SET ORBIT FLAG TO NO                         
         OI    MISCFLAG,X'40'      SET 'ORBIT DROPPED' FLAG                     
         B     BDET0040                                                         
BDET0030 EQU   *                                                                
         CLI   ORBFLAG,C'Y'        ANY ORBIT RECORDS?                           
         BE    BDET0060            YES - DON'T NEED SECONDARY -                 
*                                  ORBIT HAS ALREADY ADDED THE X'02'            
*                                     ELT.  SHOULD NEVER ABE ORB W/             
*                                        'DAILY' RECORDS                        
BDET0040 EQU   *                                                                
         GOTO1 LOADELT,DMCB,(R2),ELTBILD2,=C'ADD=CODE'                          
         XC    ELTBILD2,ELTBILD2                                                
BDET0060 EQU   *                                                                
*                                  MOVE FROM DESCRIP ELT TO DETAIL              
         ZIC   RF,1(R8)            GET LENGTH                                   
         AR    R8,RF               BUMP TO 1ST DETAIL ELEMENT                   
BDET0080 EQU   *                                                                
         CLI   0(R8),0             END OF RECORD?                               
         BE    BDETYES             YES - FINISHED                               
*                                                                               
         USING RDARBUEL,R8                                                      
*                                                                               
*&&CD                                                                           
         CLI   RDARBULN,RDARBUL2   CONFLICT END DATE?                           
         BNE   BDET0090                                                         
*                                                                               
* DEAL WITH CONFLICT END DATE!!! -- START                                       
*                                                                               
         XC    RBUYSTED,RBUYSTED                                                
         XC    STARTDAY(2),STARTDAY                                             
         GOTOR STARTEND,DMCB,RDARBURO,RBUYSTED                                  
*                                                                               
         SR    RE,RE               INITIALIZE FINAL OUTPUT                      
         LA    RF,7                SET LOOP CONTROL                             
         LA    R1,RDARBURO         SET A(ROTATION ARRAY)                        
BDETCD30 EQU   *                                                                
         CLI   0(R1),C' '          DAY SET?                                     
         BE    BDETCD80            NO                                           
         CLI   0(R1),0             DAY SET?                                     
         BE    BDETCD80            NO                                           
         LA    RE,1(RE)            YES - TURN ON LOW-ORDER BIT                  
BDETCD80 EQU   *                                                                
         SLL   RE,1                SHIFT UP 1 'DAY'                             
         LA    R1,1(R1)            BUMP TO NEXT ARRAY POSITION                  
         BCT   RF,BDETCD30         GO BACK AND TEST NEXT                        
         SRL   RE,1                SHIFT DOWN 1 'DAY' FOR                       
*                                     PROPER ALIGNMENT                          
         STC   RE,BYTE             INSERT DAYS INTO ELEMENT                     
         LR    R6,R2                                                            
         MVI   ELCODE,X'02'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
R        USING RBUYDYEL,R6                                                      
         MVC   R.RBUYDAYS,BYTE                                                  
         DROP  R                                                                
*                                                                               
         DC    X'0770'                                                          
*                                                                               
* DEAL WITH CONFLICT END DATE!!!  -- END                                        
*                                                                               
*                                                                               
*&&                                                                             
BDET0090 EQU   *                                                                
         TM    MISCFLAG,X'80'      'DAILY' BUY?                                 
         BO    BDET0100            YES - SKIP CHECK FOR COST BREAK ->           
*                                     EACH ELEMENT BECOMES A BUY REC            
         GOTO1 DETLBRAK,DMCB,(RC),(R8),(R2)                                     
*                                  CHECK FOR COST BREAK                         
BDET0100 EQU   *                                                                
         MVI   DETLFLAG,C'Y'       SET DETAILS TO YES                           
         OC    RBUYNW,RBUYNW       NUMBER/WEEK FILLED IN?                       
         BNZ   BDET0120            YES                                          
*                                                                               
         MVC   RBUYNW,RDARBUSW     NO  - INSERT NUMBER PER WEEK                 
BDET0120 EQU   *                                                                
         XC    ELTBUILD,ELTBUILD   CLEAR ELEMENT BUILD AREA                     
         MVC   ELTBUILD(2),=X'030B'                                             
*                                  INSERT ELEMENT CODE/LENGTH                   
         GOTO1 DATCON,DMCB,(2,RDARBUSD),(0,WORK)                                
*                                  CONVERT START DATE TO EBCDIC                 
         TM    MISCFLAG,X'80'      'DAILY' BUY?                                 
         BNO   BDET0130            NO  -                                        
         MVC   WORK+12(6),WORK     YES - USE START AS IS, THEN                  
*                                     SET END TO START                          
         B     BDET0190                                                         
BDET0130 EQU   *                                                                
         ZIC   RF,RDARBUWK         CALCULATE NUMBER OF DAYS                     
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         BCTR  RF,0                MAKE WEEKS ZERO RELATIVE                     
         MH    RF,=H'7'            MULTIPLY WEEKS BY 7                          
         GOTO1 ADDAY,DMCB,WORK,WORK+6,(RF)                                      
*                                                                               
         GOTO1 GETDAY,DMCB,WORK,WORK+12                                         
*                                  GET DAY OF START WEEK                        
         ZIC   RF,DMCB             GET DAY OF WEEK                              
         BCTR  RF,0                MAKE DAY ZERO RELATIVE                       
*                                                                               
         LTR   RF,RF               MONDAY?                                      
         BNZ   BDET0133                                                         
         TM    SVDARFL2,SF2XML     DON'T CHECK MONDAY IF XML                    
         BZ    BDET0140                                                         
*                                                                               
BDET0133 DS    0H                                                               
         LNR   RF,RF               NEGATE REGISTER                              
         GOTO1 ADDAY,DMCB,WORK,WORK+12,(RF)                                     
*                                  BACK UP TO MONDAY                            
*                                                                               
* IN CASE OF OUT OF WEEK ROTATORS, COMPARE BUY START DAY AND ROTATION           
* START DAY TO GET THE CORRECT MONDAY DATE                                      
*                                                                               
         CLC   STARTDAY,ROTATDAY                                                
         BNL   BDET0135                                                         
         MVC   WORK(6),WORK+12                                                  
         LA    RF,7                                                             
         GOTO1 ADDAY,DMCB,WORK,WORK+12,(RF)                                     
*                                                                               
BDET0135 DS    0H                                                               
         MVC   WORK(6),WORK+12                                                  
*                                                                               
BDET0140 EQU   *                                                                
         CLI   ORBSTDAY,0          ANY ORBIT START DAY?                         
         BZ    BDET0160            NO  - USE HEADER START DAY                   
         ZIC   RF,ORBSTDAY         YES - USE IT                                 
         B     BDET0180                                                         
BDET0160 EQU   *                                                                
         ZIC   RF,STARTDAY         ADD START DAY                                
BDET0180 EQU   *                                                                
         BCTR  RF,0                MAKE ZERO RELATIVE                           
         GOTO1 ADDAY,DMCB,WORK,WORK+12,(RF)                                     
*                                  BUMP TO START DAY IN WEEK                    
BDET0190 EQU   *                                                                
         GOTO1 DATCON,DMCB,(0,WORK+12),(3,ELTBUILD+2)                           
*                                  INSERT START DATE INTO ELEMENT               
         TM    MISCFLAG,X'80'      'DAILY' BUY?                                 
         BNO   BDET0200            NO                                           
         MVC   ELTBUILD+5(3),ELTBUILD+2                                         
*                                  YES - SET END DATE = START DATE              
         B     BDET0260                                                         
BDET0200 EQU   *                                                                
*                                                                               
         GOTO1 GETDAY,DMCB,WORK+6,WORK+12                                       
*                                  GET DAY OF END   WEEK                        
         ZIC   RF,DMCB             GET DAY OF WEEK                              
         BCTR  RF,0                MAKE DAY ZERO RELATIVE                       
         LTR   RF,RF               MONDAY?                                      
         BZ    BDET0240            YES - LEAVE                                  
         LNR   RF,RF               NEGATE REGISTER                              
         CLC   STARTDAY,ENDDAY     START/END ON SAME DAY?                       
*                                     (SINGLE-DAY BUY?)                         
         BE    BDET0220            YES - DON'T BUMP TO NEXT WEEK                
         BL    BDET0220            START < END DAY:  NOT AN                     
*                                     OOWR - DON'T BUMP                         
         LA    RF,7(RF)            BUMP IT INTO NEXT WEEK                       
BDET0220 EQU   *                                                                
         GOTO1 ADDAY,DMCB,WORK+6,WORK+12,(RF)                                   
*                                  BACK UP TO MONDAY                            
*                                                                               
* IN CASE OF OUT OF WEEK ROTATORS, COMPARE BUY START DAY AND ROTATION           
* START DAY TO GET THE CORRECT MONDAY DATE                                      
*                                                                               
* SKIP FOR XML ORDERS, NO ADJUSTMENT NEEDED                                     
*                                                                               
*        TM    SVDARFL2,SF2XML                                                  
*        BNZ   BDET0230                                                         
         CLC   STARTDAY,ROTATDAY                                                
         BNL   BDET0230                                                         
         MVC   WORK+6(6),WORK+12                                                
         LA    RF,7                                                             
         GOTO1 ADDAY,DMCB,WORK+6,WORK+12,(RF)                                   
*                                                                               
BDET0230 DS    0H                                                               
         MVC   WORK+6(6),WORK+12                                                
*                                                                               
BDET0240 EQU   *                                                                
         ZIC   RF,ENDDAY           ADD END   DAY                                
         BCTR  RF,0                MAKE ZERO RELATIVE                           
         GOTO1 ADDAY,DMCB,WORK+6,WORK+12,(RF)                                   
*                                  BUMP TO END   DAY IN WEEK                    
         GOTO1 DATCON,DMCB,(0,WORK+12),(3,ELTBUILD+5)                           
*                                  INSERT END   DATE INTO ELEMENT               
*                                                                               
BDET0260 EQU   *                                                                
         MVI   ELTBUILD+8,X'80'    SET TO 'EVERY WEEK'                          
         CLC   RBUYNW,RDARBUSW     HEADER #/WK = DETAIL #/WK?                   
         BE    BDET0280            YES                                          
         OI    ELTBUILD+8,X'01'    NO  - PUT IN 'OVERRIDE' FLAG                 
         B     BDET0290                                                         
BDET0280 EQU   *                                                                
         CLI   RDARBUSW,0          SPOT PER WEEK ZERO??                         
         BNE   BDET0290            RBUYNW MIGHT GET SET TO SOMETHING            
         OI    ELTBUILD+8,X'01'    ELSE LATER, SET OVERRIDE ANYWAY              
*                                                                               
BDET0290 EQU   *                                                                
         MVC   ELTBUILD+9(1),RDARBUSW                                           
*                                  INSERT NUMBER PER WEEK                       
         MVC   ELTBUILD+10(1),RDARBUWK                                          
*                                  INSERT NUMBER OF WEEKS                       
         ZIC   RF,RDARBUWK         ACCUMULATE NUMBER OF WEEKS                   
         SR    R0,R0                  AND CALC # SPOTS                          
         ZIC   R1,RDARBUSW         NUMBER SPOTS PER WEEK                        
         MR    R0,RF               # SPOTS X # WEEKS                            
         L     RE,SPOTCTR                                                       
         AR    RE,R1               ACCUMULATE NUMBER OF SPOTS                   
         ST    RE,SPOTCTR          STORE IT BACK                                
         A     RF,WEEKCTR          ACCUMULATE NUMBER OF WEEKS                   
         ST    RF,WEEKCTR          STORE IT BACK                                
         L     R2,AIO2             A(BUY RECORD IN PROGRESS)                    
         GOTO1 LOADELT,DMCB,(R2),ELTBUILD,=C'ADD=CODE'                          
         GOTOR SETMKG              SET MAKEGOOD FLAG FOR AGY BUY                
         TM    MISCFLAG,X'80'      'DAILY' BUY?                                 
*&&CT                                                                           
         BNO   BDET0300            NO  - GO BACK FOR NEXT ELEMENT               
         BAS   RE,GENDAILY         YES - GENERATE A BUY RECORD                  
*&&                                                                             
*&&CD                                                                           
** CONFLICT END DATE                                                            
         BZ    BDET0295            NO  - GO BACK FOR NEXT ELEMENT               
         BAS   RE,GENDAILY         YES - GENERATE A BUY RECORD                  
         B     BDET0300                                                         
BDET0295 EQU   *                                                                
         TM    MISCFLAG,MFCDATE    CONFLICT END DATE?                           
         BZ    BDET0300                                                         
         BAS   RE,GENCDATE         GENERATE A BUY RECORD                        
** CONFLICT END DATE                                                            
*&&                                                                             
BDET0300 EQU   *                                                                
         ZIC   RF,1(R8)                                                         
         AR    R8,RF                                                            
         B     BDET0080            GO BACK FOR NEXT ELEMENT                     
BDETYES  SR    RC,RC                                                            
BDETNO   LTR   RC,RC                                                            
         B     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
*   GENDAILY:  FOR 'DAILY' BUYS, EACH DETAIL IS TO BE A SEPARATE BUY            
*        RECORD.  THE DETAIL'S DETAILS ARE INSERTED INTO THE HEADER,            
*        AND THE RECORD WRITTEN TO THE FILE.                                    
***********************************************************************         
GENDAILY NTR1                                                                   
         OI    RBUYFLG2,X'80'      SET 'DAILY ORDER' FLAG                       
         MVC   RBUYNW,RDARBUSW     INSERT NUMBER SPOTS/WEEK                     
         MVC   RBUYTSPT,RDARBUSW   INSERT TOTAL SPOT: SAME AS SPTS/WK           
         MVC   RBUYCOS,RDARBU$$    INSERT SPOT COST                             
         MVC   BUYCOST,RDARBU$$    SAVE   SPOT COST FOR CALCULATION             
*                                  INSERT ELEMENT CODE/LENGTH                   
         GOTO1 DATCON,DMCB,(2,RDARBUSD),(0,WORK)                                
*                                  CONVERT START DATE TO EBCDIC                 
         GOTO1 GETDAY,DMCB,WORK,WORK+12                                         
*                                  GET DAY OF WEEK OF START DAY                 
         ZIC   RF,DMCB             GET DAY OF WEEK:  START DAY                  
         SLL   RF,4                SHIFT TO LOW ORDER, HI NYBBLE                
         ZIC   RE,DMCB             GET DAY OF WEEK:  END   DAY                  
         AR    RF,RE               ADD END DAY TO START DAY                     
         STC   RF,RBUYSTED         INSERT START/END DAYS                        
         LA    RF,RBUYELEM         SET A(01 ELEMENT)                            
GDAI0020 EQU   *                                                                
         ZIC   RE,1(RF)            GET LENGTH                                   
         AR    RF,RE               BUMP TO NEXT                                 
         CLI   0(RF),0             END OF RECORD?                               
         BNE   *+6                 NO                                           
         DC    H'0'                YES - SHOULDN'T HAPPEN                       
         CLI   0(RF),2             DAY/TIME ELEMENT?                            
         BNE   GDAI0020            NO  - GO BACK FOR NEXT                       
         MVC   RBUYDYIN-RBUYDYEL(1,RF),RBUYSTED                                 
*                                  YES - INSERT START/END FROM HDR              
         ZIC   RE,RBUYSTED         GET ST/END DAYS                              
         SRL   RE,4                DROP THE END DAY                             
         LA    R3,DAYTABLE                                                      
         AR    R3,RE               ADD DAY TO TABLE ADDR                        
         MVC   RBUYDAYS-RBUYDYEL(1,RF),0(R3)                                    
*                                  INSERT DAYS INTO ELEMENT -                   
*                                     ALWAYS A SINGLE DAY                       
         GOTOR GENREC                                                           
*                                                                               
         ZIC   RF,BUYLINE#         BUMP BUYLINE #                               
         LA    RF,1(RF)                                                         
         STC   RF,BUYLINE#                                                      
*                                                                               
* KEEP CURRENT AGENCY BUY 'MASTER LINE NUMBER'                                  
*        STC   RF,RBUYKMLN         INSERT NEW NUMBER IN MASTER LINE#            
         STC   RF,RBUYKLIN         INSERT NEW NUMBER IN LINE #                  
         GOTO1 DELELT,DMCB,RBUYREC                                              
         MVI   DETLFLAG,C'N'       RESET DETAIL COUNT TO NONE                   
         B     EXIT                                                             
*                                                                               
DAYTABLE DC    X'8040201008040201'                                              
*                                                                               
*&&CD                                                                           
*                                                                               
*   GENCDATE:  FOR 'CONFLICT END DATE' BUYS, THE LAST BUY SHOULD                
*              BECOME A SEPERATE BUY LINE                                       
*                                                                               
GENCDATE NTR1                                                                   
         LR    R6,R4                                                            
         MVI   ELCODE,X'10'        MISC FLAG ELEMENT                            
         BRAS  RE,GETEL                                                         
         BE    CDTE0050                                                         
*                                                                               
WKD      USING RBUYXXEL,ELEM                                                    
         XC    ELEM,ELEM                                                        
         MVI   WKD.RBUYXXCD,RBUYXXCQ                                            
         MVI   WKD.RBUYXXLN,RBUYXXLQ                                            
         OI    WKD.RBUYXXFG,X'10'  MARK CONFLICT END DATE FLAG                  
         DROP  WKD                                                              
         GOTO1 LOADELT,DMCB,(R4),ELEM,=C'ADD=CODE'                              
         B     CDTE0055                                                         
*                                                                               
CDTE0050 EQU   *                                                                
         USING RBUYXXEL,R6                                                      
         OI    RBUYXXFG,X'10'      MARK CONFLICT END DATE FLAG                  
         DROP  R6                                                               
*                                                                               
CDTE0055 EQU   *                                                                
         MVC   RBUYNW,RDARBUSW     INSERT NUMBER SPOTS/WEEK                     
         MVC   RBUYTSPT,RDARBUSW   INSERT TOTAL SPOT: SAME AS SPTS/WK           
         MVC   RBUYCOS,RDARBU$$    INSERT SPOT COST                             
         MVC   BUYCOST,RDARBU$$    SAVE   SPOT COST FOR CALCULATION             
*                                  INSERT ELEMENT CODE/LENGTH                   
                                                                                
         CLI   RDARBULN,RDARBUL2                                                
         BNE   *+10                                                             
         MVC   RBUYDYIN,RBUYSTED                                                
*                                                                               
         GOTO1 GENREC,DMCB,(RC),RBUYREC                                         
*                                  OUTPUT THE BUY RECORD                        
         ZIC   RF,BUYLINE#         BUMP BUYLINE #                               
         LA    RF,1(RF)                                                         
         STC   RF,BUYLINE#                                                      
         STC   RF,RBUYKLIN         INSERT NEW NUMBER IN LINE #                  
         GOTO1 DELELT,DMCB,RBUYREC                                              
         MVI   DETLFLAG,C'N'       RESET DETAIL COUNT TO NONE                   
         XIT1                                                                   
         EJECT                                                                  
*&&                                                                             
         DROP  R2,R8                                                            
***********************************************************************         
*   DETLBRAK:  IF DETAIL COST IS DIFFERENT THAN BUYHDR COST, AND                
*      PREVIOUS DETAILS HAVE BEEN ENCOUNTERED WITHIN THE BUYHDR                 
*      GROUP, THE FOLLOWING STEPS MUST BE TAKEN:                                
*         1.  THE BUY MUST BE OUTPUT                                            
*         2.  THE NEXT BUYLINE NUMBER MUST BE CALCULATED                        
*         3.  THE RECORD MUST BE CLEARED OF DETAIL INFORMATION                  
*         4.  PROCESSING OF THE NEW DETAIL WILL THEN CONTINUE                   
***********************************************************************         
DETLBRAK NTR1                                                                   
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R3,4(R1)            RESET A(DETAIL ELEMENT)                      
         USING RDARBUEL,R3         BUY DETAIL ELEMENT                           
*                                                                               
         L     R4,8(R1)            RESET A(RBUYREC)                             
         USING RBUYREC,R4                                                       
*                                                                               
         CLI   DETLFLAG,C'N'       ANY DETAILS ENCOUNTERED?                     
         BNE   DBRA0040            YES - CHECK FOR $$ CHANGE                    
         MVC   RBUYCOS,RDARBU$$    NO  - INSERT BUY COST IN CASE                
*                                     DIFFERENT FROM HEADER COST                
         MVC   BUYCOST,RBUYCOS     SAVE COST FOR CALCULATION                    
         MVC   RBUYNW,RDARBUSW     INSERT SPOTS/WK IN CASE DIFFERENT            
*                                                                               
         B     DBRA0200            EXIT                                         
DBRA0040 EQU   *                                                                
         CLC   RBUYCOS,RDARBU$$    BUY COST = DETAIL COST?                      
         BE    DBRA0200            YES - FINISHED                               
*                                                                               
         LR    R6,R4                                                            
         MVI   ELCODE,X'10'        MISC FLAG ELEMENT                            
         BRAS  RE,GETEL                                                         
         BE    DBRA0050                                                         
*                                                                               
         XC    ELEM,ELEM                                                        
WKD      USING RBUYXXEL,ELEM                                                    
         MVI   WKD.RBUYXXCD,RBUYXXCQ                                            
         MVI   WKD.RBUYXXLN,RBUYXXLQ                                            
         OI    WKD.RBUYXXFG,X'40'  MARK COST OVERRIDE FLAG                      
         DROP  WKD                                                              
         GOTO1 LOADELT,DMCB,(R4),ELEM,=C'ADD=CODE'                              
*                                                                               
         B     DBRA0055                                                         
*                                                                               
DBRA0050 EQU   *                                                                
         USING RBUYXXEL,R6                                                      
         OI    RBUYXXFG,X'40'      MARK COST OVERRIDE FLAG                      
         DROP  R6                                                               
*                                                                               
DBRA0055 EQU   *                                                                
         GOTOR GENREC                                                           
*                                                                               
         MVC   RBUYCOS,RDARBU$$    INSERT NEW COST                              
         MVC   BUYCOST,RBUYCOS     SAVE COST FOR CALCULATION                    
         MVC   RBUYNW,RDARBUSW     INSERT SPOTS/WK IN CASE DIFFERENT            
         ZIC   RF,BUYLINE#         BUMP BUYLINE #                               
         LA    RF,1(RF)                                                         
         STC   RF,BUYLINE#                                                      
*                                                                               
* KEEP CURRENT AGENCY BUY 'MASTER LINE NUMBER'                                  
*        STC   RF,RBUYKMLN         INSERT NEW NUMBER IN MASTER LINE#            
         STC   RF,RBUYKLIN         INSERT NEW NUMBER IN LINE #                  
         GOTO1 DELELT,DMCB,RBUYREC                                              
         MVI   DETLFLAG,C'N'       RESET DETAIL COUNT TO NONE                   
DBRA0200 EQU   *                                                                
         B     EXIT                                                             
         DROP  R3,R4                                                            
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*--------------------------------------------------------------------           
* SET AGENCY MAKEGOOD FLAG IN SHADOW RECORD                                     
*--------------------------------------------------------------------           
SETMKG   NTR1  BASE=*,LABEL=*                                                   
         CLI   AGBUYMTR,0          IS THIS AN AGENCY MAKEGOOD?                  
         BE    SMKGX               NO                                           
*                                                                               
         LR    R6,R4                                                            
         MVI   ELCODE,X'10'        MISC FLAG ELEMENT                            
         BRAS  RE,GETEL                                                         
         BE    SMKG0050                                                         
*                                                                               
WKD      USING RBUYXXEL,ELEM                                                    
         XC    ELEM,ELEM                                                        
*                                                                               
         MVI   WKD.RBUYXXCD,RBUYXXCQ                                            
         MVI   WKD.RBUYXXLN,RBUYXXLQ                                            
         OI    WKD.RBUYXXFG,X'20'  MARK AGENCY MAKEGOOD FLAG                    
         DROP  WKD                                                              
*                                                                               
         GOTO1 LOADELT,DMCB,(R4),ELEM,=C'ADD=CODE'                              
         B     SMKGX                                                            
*                                                                               
SMKG0050 EQU   *                                                                
         OI    RBUYXXFG-RBUYXXEL(R6),X'20'                                      
*                                                                               
SMKGX    EQU   *                                                                
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*   GENCOMMT:  GENERATE A COMMENT RECORD IN THOSE INSTANCES WHEN                
*      A PROGRAM NAME IS PRESENT, AND NO DARE COMMENTS HAVE BEEN                
*      FOUND.  OTHERWISE, THE PROGRAM NAME AS A COMMENT WILL BE                 
*      SKIPPED.                                                                 
***********************************************************************         
GENCOMMT NTR1  BASE=*,LABEL=*                                                   
         L     R2,0(R1)            RESET A(BUYREC)                              
         USING RBUYREC,R2                                                       
*                                                                               
         CLI   KATZEDI,C'Y'        KATZ/EDI USES ONLY THE FIRST 32              
         BNE   GCOM0005            WITH THE LAST 2 FOR DAYPART                  
*                                                                               
*                                  REMOVE OLD X'ED' DAYPART CODE                
         GOTO1 HELLO,DMCB,(C'D',=C'REPFILE'),(X'ED',(R2)),0,0                   
         XC    ELEMENT,ELEMENT     FOR KATZ/EDI ADD THE DAYPART CODE            
         LA    R6,ELEMENT          ELEMENT                                      
         USING RBUYEDEL,R6                                                      
         MVI   RBUYEDCD,X'ED'                                                   
         MVI   RBUYEDLN,RBUYEDLQ                                                
         MVC   RBUYEDDP,PROGNAME+32                                             
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),(R2),ELEMENT,0                     
         DROP  R6                                                               
*                                                                               
GCOM0005 EQU   *                                                                
         XC    ELTBUILD,ELTBUILD   CLEAR ELEMENT BUILD AREA                     
         MVI   ELTBUILD,X'04'      INSERT ELEMENT CODE                          
*                                  CLEAR WORKSPACE                              
         LA    R6,PROGNAME+33      SCAN PROGRAM NAME FOR BLANKS                 
         LA    RF,34               LOOP CONTROL                                 
         CLI   KATZEDI,C'Y'        KATZ/EDI USES ONLY THE FIRST 32              
         BNE   GCOM0010            WITH THE LAST 2 FOR DAYPART                  
         LA    R6,PROGNAME+31      SCAN PROGRAM NAME FOR BLANKS                 
         LA    RF,32               LOOP CONTROL                                 
GCOM0010 EQU   *                                                                
         CLI   0(R6),C' '          CHARACTER = SPACE?                           
         BNE   GCOM0015            NO  - LAST CHARACTER FOUND                   
         BCTR  R6,0                YES - BACK UP 1 SPACE                        
         BCT   RF,GCOM0010         LOOP THROUGH ALL                             
         DC    H'0'                SHOULDN'T HAPPEN:  SPACES CHECKED            
GCOM0015 EQU   *                                                                
         LA    RF,1(RF)            ADD 1 FOR KEYWORD (+2 -1 FOR EX)             
         MVC   ELTBUILD+2(2),=C'P='                                             
*                                  INSERT KEYWORK                               
         EX    RF,GCOM0505         MOVE PROGRAM NAME BY LENGTH                  
         LA    RF,3(RF)            RESTORE LENGTH + L(CONTROLS)                 
         STC   RF,ELTBUILD+1       INSERT LENGTH INTO ELEMENT                   
*                                                                               
* SKIP BUILDING P= COMMENT PROGRAM NAME ELEMENT                                 
*                                                                               
*        GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),RBUYREC,ELTBUILD,         X        
               =C'ADD=CODE'                                                     
*                                                                               
* BUILD DEDICATED PROGRAM NAME ELEMENT                                          
*                                                                               
         MVI   ELTBUILD,X'21'      PROGRAM NAME ELEMENT                         
         XC    ELTBUILD+2(L'ELTBUILD-2),ELTBUILD+2                              
         ZIC   RF,ELTBUILD+1       REUSE LENGTH FROM THE P= COMMENT             
         SHI   RF,2                ELEMENT TO BUILD LENGTH OF                   
         STC   RF,ELTBUILD+1       PROGRAM NAME ELEMENT                         
         SHI   RF,1                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   ELTBUILD+2(0),PROGNAME                                           
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),RBUYREC,ELTBUILD,         X        
               =C'ADD=CODE'                                                     
*                                                                               
         MVI   PROGNAME,C' '       CLEAR THE PROGRAM NAME                       
         MVC   PROGNAME+1(L'PROGNAME-1),PROGNAME                                
         B     EXIT                                                             
*                                                                               
GCOM0505 MVC   ELTBUILD+4(0),PROGNAME                                           
*                                                                               
         DROP  R2                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* ROUTINE RIPPED FROM REDAR20                                                   
* ADD OR UPDATE RECORD TO FILE                                                  
***********************************************************************         
GENREC   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   AIO,AIO2            SET IO AREA = IOAREA2                        
         L     R2,AIO                                                           
         USING RBUYREC,R2                                                       
*                                                                               
*   INSERT TOTAL SPOTS, TOTAL COST, AND TOTAL WEEKS FIGURES                     
*                                                                               
         MVC   RBUYTSPT,SPOTCTR+2  LAST TWO POSITIONS ONLY                      
         L     RF,SPOTCTR          ACCUMULATE TOTAL SPOTS                       
         A     RF,ORDTOTSP                                                      
         ST    RF,ORDTOTSP         SAVE ORDER TOTAL SPOTS                       
         MVC   RBUYTWKS,WEEKCTR+3  LAST POSITION ONLY                           
         ZICM  RF,RBUYTSPT,2       LOAD TOTAL SPOTS                             
         SR    R0,R0                                                            
         L     R1,BUYCOST          LOAD COST PER SPOT                           
         MR    R0,RF               # SPOTS X COST/SPOT                          
         STCM  R1,15,RBUYTCOS      INSERT TOTAL COST                            
         A     R1,ORDTOT$$         ACCUMULATE ORDER TOTAL DOLLARS               
         ST    R1,ORDTOT$$         SAVE ORDER TOTAL DOLLARS                     
         XC    SPOTCTR,SPOTCTR     CLEAR ACCUMULATORS                           
         XC    WEEKCTR,WEEKCTR                                                  
         XC    BUYCOST,BUYCOST                                                  
*                                                                               
         MVC   SAVEKEY,KEY         SAVE CURRENT KEY FOR RESTART                 
         MVC   KEY,RBUYKEY         GET KEY OF BUY                               
*                                  LOOK FOR OLD RECORD                          
*                                     GENCON DOESN'T LIKE 'ADDREC'              
         MVC   KEYSAVE,KEY                                                      
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         OI    DMINBTS,X'08'       RETURN DELETED KEYS ALSO                     
         GOTO1 HIGH                READ THE KEY                                 
         CLC   KEYSAVE(27),KEY     KEY ALREADY ON FILE?                         
         BE    GENR0040            YES - RECORD/KEY MUST BE REPLACED            
*                                                                               
         MVC   KEY(27),KEYSAVE     NO  - RESET NEW KEY                          
         CLI   RBUYVER,1           VERSION = 1?                                 
         BE    GENR0020            YES - ORIGINAL CREATION                      
         MVI   RBUYCHGI,C'A'       NO  - ADDED ON THIS PASS                     
         MVI   RBUYCHGI+1,0        CLEAR SECOND CHG BYTE                        
GENR0020 EQU   *                                                                
         GOTO1 ADDREC              ADD THE RECORD/KEY                           
*                                     GENCON TRAPS ERRORS                       
         B     GENR0080            RECORD ADDED SUCCESSFULLY                    
GENR0040 EQU   *                                                                
*                                                                               
*                                     OLD RECORD MAY HAVE BEEN DELETED:         
*                                     STILL MUST ACCESS KEY/RECORD              
*                                        FOR UPDATE                             
*                                                                               
*                                                                               
         NI    KEY+27,X'FF'-X'80'  RESTORE KEY                                  
         MVC   AIO,AIOAREA         SET ALTERNATE IO AREA                        
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         OI    DMINBTS,X'08'       RETURN DELETED KEYS ALSO                     
         GOTO1 GETREC              RETRIEVE ORIGINAL RECORD                     
*                                                                               
         MVC   AIO,AIO2            SET IO AREA FOR NEW BUY                      
         GOTO1 PUTREC              WRITE UPDATED RECORD TO FILE                 
         GOTO1 WRITE               REWRITE CLEARED KEY FOR RECORD               
GENR0080 EQU   *                                                                
GENR0100 EQU   *                                                                
         MVC   AIO,AIO1            RESET A(X'41' RECORD AREA)                   
         MVC   KEY,SAVEKEY         RESET KEY FOR X'41' RECS                     
         GOTO1 HIGH                                                             
         B     EXIT                                                             
         DROP  R2                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* INITIALIZE TSAR                                                               
***********************************************************************         
INITTSAR NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         ICM   R0,14,=X'D9000A'                                                 
         ICM   R0,1,=AL1(QTSAR)                                                 
         GOTOX CALLOV,DMCB,0,(R0)                                               
         MVC   VTSAR,0(R1)         VTSAR                                        
*                                                                               
         XC    TBLOCK,TBLOCK                                                    
         GOTOX GOTSAR,TSAINI                                                    
*                                                                               
         XC    LISTSTRT,LISTSTRT                                                
         XC    LISTLAST,LISTLAST                                                
*                                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*----------------------------------------------------------------------         
* GENERAL INITIALIZATION DUMPING TOGETHER                                       
*----------------------------------------------------------------------         
INIT     NTR1  BASE=*,LABEL=*                                                   
         NI    MISCFLG4,FF-MF4DIFF                                              
         NI    MISCFLG2,X'FF'-MF2TRADE                                          
*                                                                               
         XC    EOBUYTAB,EOBUYTAB   CLEAR END OF BUY TABLE                       
*                                                                               
         LA    R2,MTCHTAB                                                       
         LA    R2,MTCHTABQ(R2)                                                  
         ST    R2,ABUYTAB          SET A(BUYTAB)                                
*                                                                               
         LR    RE,R2                                                            
         XCEF  (RE),'BUYTABX'                                                   
*                                                                               
         AHI   R2,BUYTABX                                                       
         MVI   0(R2),X'FF'                                                      
*                                                                               
         LA    R2,MTCHTAB          INITIALIZE TABLE TO ALL X'FF'                
         ST    R2,AEOTBLE                                                       
*                                                                               
         XCEFL MTCHTAB,L'MTCHTAB                                                
*                                                                               
         CLI   ACTCODE,C'R'        FOR DIFFERENCE SCREEN                        
         BE    INIT0050            ONLY                                         
*                                                                               
         CLI   PRTSTAT,0           PRINT WORKSHEET?                             
         BNE   INIT0050            YES, SKIP OVER                               
*                                                                               
         TM    MISCFLG4,MF4GLOB    RETURN FROM GLOBBER?                         
         BO    INIT0050            YES, SKIP                                    
*                                                                               
         MVC   DIFMOPT(3),=C'MPU'  INSERT DEFAULT VIEWING OPTION                
*                                                                               
         TM    CFLAG,CSPDIFQ       SHOW SPOT DIFFERENCE +/-?                    
         BZ    *+8                                                              
*                                                                               
         MVI   DIFMOPT+3,C'C'      YES                                          
*                                                                               
INIT0050 DS    0H                                                               
*                                                                               
         L     R6,AIO1                                                          
         LR    R4,R6                                                            
R        USING RDARREC,R4                                                       
*                                                                               
         CLI   ACTCODE,C'R'                                                     
         BNE   INIT0100                                                         
         MVC   STATUS,=C'REJECT'                                                
         CLI   R.RDARRNUM,0                                                     
         BE    INITX                                                            
         MVC   STATUS,=C'REVREJ'                                                
         B     INITX                                                            
*                                                                               
INIT0100 DS    0H                                                               
         CLI   R.RDARCORT,C'T'                                                  
         BNE   *+8                                                              
         OI    MISCFLG2,MF2TRADE                                                
*                                                                               
         MVI   ELCODE,X'0F'                                                     
         BRAS  RE,GETEL                                                         
         BNE   INIT0200                                                         
*                                                                               
         USING RDARFLEM,R6                                                      
         MVC   BYTE,RDARFLG1                                                    
         NI    BYTE,FF-X'40'                                                    
         TM    R.RDARMISC,X'20'    NOTDARE?                                     
         BZ    *+8                                                              
         OI    BYTE,X'40'          NOT DARE                                     
*                                                                               
         LA    R3,DARSTAB2                                                      
INIT0150 DS    0H                                                               
         CLI   0(R3),X'FF'                                                      
         BE    INIT0180                                                         
**TEST                                                                          
*        CLI   0(R3),X'80'                                                      
*        BNE   *+6                                                              
*        DC    H'0'                                                             
**TEST                                                                          
         MVC   WORK(1),BYTE                                                     
         NC    WORK(1),0(R3)                                                    
         BZ    INIT0170                                                         
         LA    R3,1(R3)                                                         
         B     INIT0300            POINT TO RESULT                              
*                                                                               
INIT0170 DS    0H                                                               
         AHI   R3,2                                                             
         B     INIT0150                                                         
INIT0180 DS    0H                                                               
*                                                                               
* SEARCH TABLE 2                                                                
*                                                                               
INIT0200 DS    0H                                                               
         MVI   WORK,0                                                           
         CLI   R.RDARRNUM,0                                                     
         BE    *+8                                                              
         MVI   WORK,1                                                           
*                                                                               
         MVC   WORK+1(L'RDARBSTS),R.RDARBSTS                                    
         CLI   WORK+1,0                                                         
         BNE   INIT0230                                                         
         TM    R.RDARMISC,X'80'                                                 
         BZ    INIT0230                                                         
         MVI   WORK+1,C'S'         MARK AS RESENT                               
*                                                                               
INIT0230 DS    0H                                                               
         LA    R3,DARSTAB3                                                      
INIT0250 DS    0H                                                               
         CLI   0(R3),X'FF'                                                      
         BE    INIT0280                                                         
         CLC   WORK(2),0(R3)                                                    
         BNE   INIT0270                                                         
         LA    R3,2(R3)                                                         
         B     INIT0300                                                         
INIT0270 DS    0H                                                               
         LA    R3,3(R3)                                                         
         B     INIT0250                                                         
INIT0280 DS    0H                                                               
         DC    H'0'                                                             
*                                                                               
INIT0300 DS    0H                                                               
         LA    R1,DARSTAB1                                                      
INIT0320 DS    0H                                                               
         CLI   0(R1),X'FF'                                                      
         BE    INIT0400                                                         
         CLC   0(1,R3),0(R1)                                                    
         BE    INIT0500                                                         
         LA    R1,7(R1)                                                         
         B     INIT0320                                                         
INIT0400 DS    0H                                                               
         DC    H'0'                                                             
*                                                                               
INIT0500 DS    0H                                                               
         MVC   STATUS,1(R1)                                                     
         LA    RF,DARPTR1                                                       
         CR    R1,RF                                                            
         BNL   INITX               NO NEED TO CHECK -S FLAG                     
*                                                                               
         TM    RDARFLG1,X'40'      -S?                                          
         BZ    INITX                                                            
*                                                                               
         OC    CCONVER#,CCONVER#                                                
         BZ    INITX                                                            
         EDIT  CCONVER#,(2,STATUS2),ZERO=NOBLANK,FILL=0                         
*                                                                               
*                                                                               
INITX    DS    0H                                                               
         B     EXIT                                                             
*                                                                               
*                                                                               
DARSTAB1 DS    0C                                                               
         DC    X'01',C'OPENED'                                                  
         DC    X'02',C'AMNDED'                                                  
         DC    X'03',C'REVOPN'                                                  
         DC    X'04',C'REVAMD'                                                  
         DC    X'05',C'MATCH '                                                  
DARPTR1  DS    0C                                                               
****ENTRIES ABOVE NEED TO LOOK AT -S FLAG                                       
         DC    X'06',C'RECALL'                                                  
         DC    X'07',C'REJECT'                                                  
         DC    X'08',C'RESENT'                                                  
*                                                                               
         DC    X'09',C'REVREC'                                                  
         DC    X'10',C'REVREJ'                                                  
         DC    X'11',C'REVRES'                                                  
         DC    X'12',C'NTDARE'                                                  
         DC    X'14',C'PENCF '                                                  
         DC    X'15',C'STACF '                                                  
         DC    X'16',C'NEW   '                                                  
         DC    X'17',C'REVNEW'                                                  
         DC    X'FF'                                                            
*                                                                               
DARSTAB2 DS    0C                                                               
         DC    X'10',X'15'              STACF                                   
         DC    X'20',X'14'              PENDCF                                  
         DC    X'80',X'05'              MATCH                                   
         DC    X'40',X'12'              NTDARE                                  
         DC    X'FF'                                                            
*                                                                               
DARSTAB3 DS    0C                                                               
*              REV/ORG,STATUS                                                   
         DC    X'00',C'C',X'06'         RECALL                                  
         DC    X'00',C'A',X'01'         OPEN                                    
         DC    X'00',C'R',X'07'         REJECT                                  
         DC    X'00',C'M',X'02'         AMEND                                   
         DC    X'00',C'S',X'08'         RESENT                                  
         DC    X'00',X'00',X'16'        NEW                                     
*                                                                               
         DC    X'01',C'C',X'09'         REVREC                                  
         DC    X'01',C'A',X'03'         REVOPN                                  
         DC    X'01',C'R',X'10'         REVREJ                                  
         DC    X'01',C'M',X'04'         REVAMD                                  
         DC    X'01',C'S',X'11'         REVRES                                  
         DC    X'01',X'00',X'17'        REVNEW                                  
         DC    X'FF'                                                            
         DROP  R6                                                               
         DROP  R                                                                
***********************************************************************         
* TABLE UP ALL BUYS FROM AGENCY SIDE AND DELETE IF FIND REP BUYS THAT           
* LINKS TO THEM                                                                 
* OUTPUT: TABLE WITH ONLY AGENCY BUYS THAT HAVE NO REP LINE LINK TO IT          
* TABLE FORMAT: 2 BYTE HALF WORD BUY NUMBER                                     
* THIS TABLE OVERLAYS MYELEM, REJMESS AS THIS ONLY INTENDS TO BE A              
* TEMPORARY TABLE, DO NOT USE MYELEM, REJMESS HERE THROUGHOUT BLDTSREC          
***********************************************************************         
         USING COMFACSD,R4                                                      
TABLEBUY NTR1  BASE=*,LABEL=*                                                   
         L     R4,ACOMFACS                                                      
*                                                                               
         XCEF  AGYBTAB,L'AGYBTAB                                                
         XC    TABCT,TABCT                                                      
*                                                                               
         MVC   AIO,AIO1            SET IO AREA                                  
         XC    KEY,KEY                                                          
         LA    R6,KEY                                                           
         USING RBUYKEY,R6                                                       
         MVC   RBUYKTYP(2),=X'0B01' REP BUY RECORD TYPE                         
         MVC   RBUYKREP,TWAAGY     INSERT REP CODE                              
         MVC   RBUYKCON,COMPCON    INSERT CONTRACT #, 9/COMP/REV                
*                                                                               
TABLE10  NI    DMINBTS,X'FF'-X'08' DON'T PASS DELETES                           
         GOTO1 HIGH                                                             
*                                                                               
TABLE20  L     R2,TABCT                                                         
         CLC   KEY(22),KEYSAVE                                                  
         BNE   TABLE200            AGENCY CANCELLED ALL BUYS                    
         CLC   RBUYKTYP(2),=X'0B01'                                             
         BE    TABLE30             ONLY DO ADD FOR AGENCY LINES                 
         DROP  R6                       DO DEL FOR REP LINES                    
*                                                                               
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO                                                           
         USING RBUYREC,R6          CHECK AND SKIP                               
         CLI   RBUYCHGI,C'C'       CANCELLED BUT NOT DELETED                    
         BE    TABLE40                                                          
         CLI   RBUYAGBL,0                                                       
         BE    TABLE40             SKIP IF NOT LINK TO AGENCY LINE              
K        USING RBUYKEY,KEY                                                      
*                                                                               
TABLE28  ZIC   R1,RBUYAGBL                                                      
         STH   R1,HALF                                                          
         GOTO1 CBINSRCH,DMCB,(X'80',HALF),AGYBTAB,(R2),2,              X        
               (0,2),L'AGYBTAB/2                                                
         MVC   TABCT,DMCB+8        UPDATE TABLE COUNTER                         
         B     TABLE40                                                          
*                                                                               
TABLE30  ZIC   R1,K.RBUYKMLN                                                    
         STH   R1,HALF                                                          
         GOTO1 CBINSRCH,DMCB,(X'01',HALF),AGYBTAB,(R2),2,              X        
               (0,2),L'AGYBTAB/2                                                
         MVC   TABCT,DMCB+8        UPDATE TABLE COUNTER                         
TABLE40  DS    0H                                                               
*                                                                               
         DROP  K                                                                
         DROP  R6                                                               
*                                                                               
         NI    DMINBTS,X'FF'-X'08' DON'T PASS DELETES                           
         GOTO1 SEQ                                                              
         B     TABLE20                                                          
*                                                                               
* PROCESS AGENCY BUYS 0B01                                                      
*                                                                               
TABLE200 CLC   =X'0B00',KEYSAVE    AGY SHADOW BUYS PROCESSED ALREADY?           
         BE    TABLEX                                                           
         XC    KEY,KEY                                                          
         LA    R6,KEY                                                           
         USING RBUYKEY,R6                                                       
         MVC   RBUYKTYP(2),=X'0B00'   AGY SHADOW BUY                            
         MVC   RBUYKREP,TWAAGY     INSERT REP CODE                              
         MVC   RBUYKCON,COMPCON    INSERT CONTRACT #, 9/COMP/REV                
         B     TABLE10                                                          
         DROP  R6                                                               
*                                                                               
TABLEX   XIT1                                                                   
         DROP  R4                                                               
***********************************************************************         
* FOR ALL X'0B01' AND X'0B' BUY RECORDS:                                        
* BUILD BUY ATTRIBUTE TSAR RECORDS FOR DAYS, TIMES AND PROGRAM NAME             
* BUILD BUY SEGMENTS                                                            
* FIRST AND SECOND LOOP BUILD BUY ATTRIBUTE RECORDS FOR BOTH BUY TYPES          
* THIRD AND FORTH LOOP BUILD BUY SEGMENT RECORDS FOR BOTH BUY TYPES             
* X'0B00' RECORDS ARE PROCESSED FIRST                                           
***********************************************************************         
BLDTSREC NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         NI    FLAGS,X'FF'-FGBSEGQ BUY SEGMENT NOT YET BUILD                    
         XC    RPSPTTOT,RPSPTTOT   CLEAR TOTALS FOR PRINTING                    
         XC    RPORDTOT,RPORDTOT                                                
         XC    AGSPTTOT,AGSPTTOT                                                
         XC    AGORDTOT,AGORDTOT                                                
*                                                                               
* PROCESS REP BUYS X'0B00'                                                      
*                                                                               
BLDTR05  DS    0H                                                               
         MVC   AIO,AIO1            SET IO AREA                                  
         XC    KEY,KEY                                                          
         LA    R6,KEY                                                           
         USING RBUYKEY,R6                                                       
         MVC   RBUYKTYP(2),=X'0B00' REP BUY RECORD TYPE                         
         MVC   RBUYKREP,TWAAGY     INSERT REP CODE                              
         MVC   RBUYKCON,COMPCON    INSERT CONTRACT #, 9/COMP/REV                
         DROP  R6                                                               
*                                                                               
BLDTR10  DS    0H                                                               
         NI    DMINBTS,X'FF'-X'08' DON'T PASS DELETES                           
         GOTO1 HIGH                                                             
*                                                                               
BLDTR20  DS    0H                                                               
         CLC   KEY(22),KEYSAVE                                                  
         BNE   BLDTR200            AGENCY CANCELLED ALL BUYS                    
*                                                                               
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO                                                           
         USING RBUYREC,R6          CHECK AND SKIP                               
         CLI   RBUYCHGI,C'C'       CANCELLED BUT NOT DELETED                    
         BE    BLDTR40                                                          
         DROP  R6                                                               
*                                                                               
         TM    FLAGS,FGBSEGQ       WHICH TSAR RECORDS ARE WE BUILDING?          
         BO    BLDTR30                                                          
*                                                                               
* BUILD DAYS, TIMES AND PROGRAM NAME TSAR RECORDS                               
*                                                                               
         GOTOX (X'01',=A(BLDDTP)),RR=RELO                                       
         GOTO1 GOTSAR,TSAADD                                                    
*                                                                               
         GOTOX (X'02',=A(BLDDTP)),RR=RELO                                       
         GOTO1 GOTSAR,TSAADD                                                    
*                                                                               
         GOTOX (X'05',=A(BLDDTP)),RR=RELO                                       
         GOTO1 GOTSAR,TSAADD                                                    
*                                                                               
         GOTOX (X'03',=A(BLDDTP)),RR=RELO                                       
         BH    BLDTR25                                                          
         GOTO1 GOTSAR,TSAADD                                                    
*                                                                               
BLDTR25  DS    0H                                                               
         GOTOX (X'04',=A(BLDDTP)),RR=RELO                                       
         GOTO1 GOTSAR,TSAADD                                                    
*                                                                               
         B     BLDTR40             TSAR RECORDS                                 
*                                                                               
BLDTR30  DS    0H                  BUILD BUY SEGMENTS                           
         GOTOR CALTOT                                                           
*                                                                               
         GOTOR CHKLNK              SKIP TOTALLY MATCH LINK LINES                
         BNE   BLDTR40                                                          
*                                                                               
         GOTOR BLDSEGS                                                          
*                                                                               
BLDTR40  DS    0H                                                               
         NI    DMINBTS,X'FF'-X'08' DON'T PASS DELETES                           
         GOTO1 SEQ                                                              
         B     BLDTR20                                                          
*                                                                               
* PROCESS AGENCY BUYS 0B01                                                      
*                                                                               
BLDTR200 DS    0H                                                               
         CLC   =X'0B01',KEYSAVE    AGY SHADOW BUYS PROCESSED ALREADY?           
         BE    BLDTR300                                                         
         XC    KEY,KEY                                                          
         LA    R6,KEY                                                           
         USING RBUYKEY,R6                                                       
         MVC   RBUYKTYP(2),=X'0B01'   AGY SHADOW BUY                            
         MVC   RBUYKREP,TWAAGY     INSERT REP CODE                              
         MVC   RBUYKCON,COMPCON    INSERT CONTRACT #, 9/COMP/REV                
         B     BLDTR10                                                          
         DROP  R6                                                               
*                                                                               
BLDTR300 DS    0H                                                               
         TM    FLAGS,FGBSEGQ                                                    
         BO    BLDTRX                                                           
         OI    FLAGS,FGBSEGQ                                                    
         B     BLDTR05                                                          
*                                                                               
BLDTRX   DS    0H                                                               
         B     EXIT                                                             
*---------------------------------------------------------------------*         
* CALCULATE TOTAL SPOTS AND DOLLARS FOR BOTH REP AND AGENCY                     
*---------------------------------------------------------------------*         
CALTOT   NTR1                                                                   
         L     R4,AIO                                                           
         USING RBUYREC,R4                                                       
         CLC   =X'0B01',RBUYKEY                                                 
         BE    CTOT0100                                                         
         ZICM  RE,RPSPTTOT,2                                                    
         ZICM  RF,RBUYTSPT,2                                                    
         AR    RE,RF                                                            
         STCM  RE,3,RPSPTTOT                                                    
*                                                                               
         ZICM  RE,RPORDTOT,4                                                    
         ZICM  RF,RBUYTCOS,4                                                    
         AR    RE,RF                                                            
         STCM  RE,15,RPORDTOT                                                   
         B     CTOTX                                                            
*                                                                               
CTOT0100 DS    0H                                                               
         ZICM  RE,AGSPTTOT,2                                                    
         ZICM  RF,RBUYTSPT,2                                                    
         AR    RE,RF                                                            
         STCM  RE,3,AGSPTTOT                                                    
*                                                                               
         ZICM  RE,AGORDTOT,4                                                    
         ZICM  RF,RBUYTCOS,4                                                    
         AR    RE,RF                                                            
         STCM  RE,15,AGORDTOT                                                   
CTOTX    DS    0H                                                               
         B     EXIT                                                             
         DROP  R4                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* LOOP THROUGH ALL BUY SEGMENT AND SORT THEM BY                                 
* MATCH/UNMATCH/LINKED                                                          
***********************************************************************         
SORTSREC NTR1  BASE=*,WORK=(R4,DLWORKQ),LABEL=*                                 
         USING DLWORKD,R4                                                       
*        XC    HALF,HALF                                                        
         XC    TSARREC,TSARREC                                                  
         XC    TSARREC2,TSARREC2                                                
         MVI   DLBYTE,0            USE TO SAVE OFF DAILY BYTE NUMBER            
         MVI   TR.TLKTYP,X'0B'                                                  
         GOTO1 GOTSAR,TSARDH                                                    
         BL    SORTRX                                                           
*                                                                               
SORT0030 DS    0H                                                               
*&&TT                                                                           
         CLC   TR.TLBYDAY(6),=X'00010004003C'                                   
         BNE   *+6                                                              
         DC    X'0770'                                                          
*&&                                                                             
         MVC   DLTSRNUM,TB.TSRNUM                                               
         MVC   DLWORK,TSARREC                                                   
*                                                                               
         OC    TR.TLBYFLG2,TR.TLBYFLG2                                          
         BZ    SORT0100            NEXT                                         
*                                                                               
         MVC   TSARREC2,TSARREC                                                 
         GOTO1 GOTSAR,TSADEL                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   TSARREC,TSARREC2                                                 
*                                                                               
         MVC   TR.TLBYFLG,TR.TLBYFLG2                                           
         MVC   TR.TLBYSUBL,TR.TLBYSUB1                                          
*                                                                               
         CLI   TR.TLBYFLG,TLLNKQ                                                
         BNE   *+10                                                             
         MVC   TR.TLBYLNK,TR.TLBYLNKT                                           
*                                                                               
         CLI   TR.TLBYFLG,TLUMTHQ                                               
         BE    SORT0090                                                         
         CLI   TR.TLBYFLG,TLMTHQ2                                               
         BE    SORT0090                                                         
         CLI   TR.TLBYFLG,TLMTHQ3                                               
         BE    SORT0090                                                         
*                                                                               
         MVC   WORK(1),TR.TLBYFLG                                               
         MVC   WORK+1(1),MFLAG                                                  
         MVC   WORK+2(1),LFLAG                                                  
*                                                                               
         LA    R2,MTABLE2                                                       
SORT0040 DS    0H                                                               
         CLI   0(R2),GRPTERM                                                    
         BE    SORT0080                                                         
         CLC   0(3,R2),WORK                                                     
         BE    SORT0050                                                         
         LA    R2,MTABLEQ2(R2)                                                  
         B     SORT0040                                                         
SORT0050 DS    0H                                                               
         CLI   WORK,TLLNKQ         IF LINK IS TREATED AS UNMATCH+UNLINK         
         BNE   SORT0055                                                         
         CLI   3(R2),X'FF'         THEN CLEAR OUT THE LINK NUMBER               
         BNE   SORT0055                                                         
         MVI   TR.TLBYLNK,0        SO IT WILL SORT CORRECTLY                    
*                                                                               
*--------------------------------------------------------------------*          
* CHECK TO SEE IF DAILY BUYS ONLY HAVE ONE COMPONENT ON BOTH                    
* AGENCY SIDE AND THE REP SIDE                                                  
* IF IT IS, TREAT IT AS A NON-DAILY                                             
*--------------------------------------------------------------------*          
SORT0055 DS    0H                                                               
         CLI   TR.TLBYMLNK,0       CHECK TO SEE IF THESE ARE NWS DAILY          
         BE    SORT0070            BUYS(DAILY WITH ONLY ONE COMPONENT)          
*                                                                               
         CLC   TR.TLBYMLNK,DLBYTE  SAME GROUP AS THE PREVIOUS SEGMENT?          
         BE    SORT0060            YES, SKIP                                    
         TM    TR.TLBYRFLG,X'40'                                                
         BO    SORT0060            REP BUY LINK - SKIP                          
         TM    TR.TLBYAFLG,X'40'                                                
         BO    SORT0060            AGY BUY LINK - SKIP                          
*                                                                               
         OC    TR.TLBYALNK,TR.TLBYALNK                                          
         BZ    SORT0060                                                         
         OC    TR.TLBYRLNK,TR.TLBYRLNK                                          
         BZ    SORT0060            NOT MATCH - SKIP                             
*                                                                               
*        MVC   TXNUM,DLTSRNUM      GET THE NEXT SEGMENT                         
*        XC    TXNUM,TXNUM                                                      
         MVC   DLWORK2,TSARREC     FOR COMPARISON                               
         XC    TSARREC,TSARREC                                                  
         MVC   TSARREC+2(TLINDXLQ),TSARREC2+2                                   
TR2      USING TLSTD,DLWORK2                                                    
         GOTO1 GOTSAR,TSARDH                                                    
*                                                                               
         XC    TSARREC,DLWORK2     SWAP THE TWO AREA                            
         XC    DLWORK2,TSARREC                                                  
         XC    TSARREC,DLWORK2                                                  
*&&TT                                                                           
         CLC   TR.TLBYRLNK,=X'000B'                                             
         BNE   *+6                                                              
         DC    X'0770'                                                          
*&&                                                                             
         CLI   TR2.TLKTYP,X'0B'    LAST BUYSEGMENT                              
         BNE   SORT0057            TREAT IT AS A NON DAILY                      
*                                                                               
         CLC   TR.TLBYMLNK,TR2.TLBYMLNK                                         
         BE    SORT0060            NORMAL DAILY - SKIP                          
*                                                                               
SORT0057 MVC   DLWORK2,TSARREC     LOOK FOR TOTALLY MATCH                       
         XC    TSARREC,TSARREC                                                  
         MVC   TSARREC+2(TLINDXLQ),TSARREC2+2                                   
         MVI   TR.TLBYFLG,TLMTHQ3                                               
TR2      USING TLSTD,DLWORK2                                                    
                                                                                
         GOTO1 GOTSAR,TSARDH                                                    
*                                                                               
         XC    TSARREC,DLWORK2     SWAP THE TWO AREA                            
         XC    DLWORK2,TSARREC                                                  
         XC    TSARREC,DLWORK2                                                  
*                                                                               
         CLC   TR.TLBYMLNK,TR2.TLBYMLNK                                         
         BE    SORT0060            NORMAL DAILY - SKIP                          
*                                                                               
SORT0058 DS    0H                                                               
         MVC   DLBYTE,TR.TLBYMLNK                                               
         MVC   TR.TLBYUID,TR.TLBYMLNK                                           
         XC    TR.TLBYMLNK(2),TR.TLBYMLNK  TREAT IT AS A NON-DAILY              
         XC    TR.TLBYMLKT(2),TR.TLBYMLKT                                       
*        XC    TR.TLBYSUB1,TR.TLBYSUB1                                          
         B     SORT0070                                                         
         DROP  TR2                                                              
*                                                                               
SORT0060 DS    0H                                                               
         MVC   DLBYTE,TR.TLBYMLNK                                               
         MVI   TR.TLBYFLG,TLLNKQ   FORCE DAILY/C.O TO PROPOSED LINK             
         MVI   TR.TLBYFLG2,TLLNKQ  FORCE DAILY/C.O TO PROPOSED LINK             
         MVC   TR.TLBYLNK,TR.TLBYMLNK THEN COPY MASTER LINK INTO LINK           
         MVC   TR.TLBYLNKT,TR.TLBYMLNK THEN COPY MASTER LINK INTO LINK          
*                                                                               
         CLI   WORK,TLMTHQ         IF MATCH IS TREATED AS LINK                  
         BNE   SORT0090                                                         
         OI    TR.TLBYFLG3,X'10'                                                
         B     SORT0090                                                         
*                                                                               
SORT0070 DS    0H                                                               
         MVC   TR.TLBYFLG,3(R2)                                                 
         MVC   TR.TLBYFLG2,3(R2)                                                
         B     SORT0090                                                         
                                                                                
SORT0080 DS    0H                                                               
         DC    H'0'                                                             
                                                                                
SORT0090 DS    0H                                                               
*        CLI   TR.TLBYMLNK,7       SAME GROUP AS THE PREVIOUS SEGMENT?          
*        BNE   *+6                 YES, SKIP                                    
*        DC    X'0770'                                                          
*                                                                               
         GOTO1 GOTSAR,TSAADD                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         TM    TB.TSERRS,TSEDUP                                                 
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
SORT0100 DS    0H                                                               
         CLC   DLTSRNUM,TB.TSRNUM                                               
         BE    SORT0130                                                         
*                                                                               
         MVC   TXNUM,DLTSRNUM                                                   
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
*        CLC   TSARREC,DLWORK                                                   
*        BNE   SORT0150                                                         
SORT0130 DS    0H                                                               
*        CLI   TR.TLBYMLNK,7       SAME GROUP AS THE PREVIOUS SEGMENT?          
*        BNE   *+6                 YES, SKIP                                    
*        DC    X'0770'                                                          
         MVC   DLWORK,TSARREC                                                   
         GOTO1 GOTSAR,TSANXT                                                    
         BL    SORT0200                                                         
SORT0150 DS    0H                                                               
         CLI   TR.TLKTYP,X'0B'                                                  
         BE    SORT0030                                                         
*                                                                               
SORT0200 DS    0H                                                               
*                                                                               
SORTRX   DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
MTABLE2  DS    0C                                                               
*              TYPE,MFLG,LFLG,OUT                                               
         DC    C'M',C'P',C'A',C'T'                                              
MTABLEQ2 EQU   *-MTABLE2                                                        
         DC    C'M',C'P',C'P',C'Q'                                              
         DC    C'M',C'P',C'U',C'T'                                              
         DC    C'M',C'A',C'A',C'M'                                              
         DC    C'M',C'A',C'P',C'M'                                              
         DC    C'M',C'A',C'U',C'M'                                              
         DC    C'M',C'U',C'A',X'FF'                                             
         DC    C'M',C'U',C'P',X'FF'                                             
         DC    C'M',C'U',C'U',X'FF'                                             
*                                                                               
         DC    C'Q',C'A',C'A',C'Q'                                              
         DC    C'Q',C'P',C'A',C'Q'                                              
         DC    C'Q',C'U',C'A',C'Q'                                              
         DC    C'Q',C'A',C'P',C'Q'                                              
         DC    C'Q',C'P',C'P',C'Q'                                              
         DC    C'Q',C'U',C'P',C'Q'                                              
         DC    C'Q',C'A',C'U',X'FF'                                             
         DC    C'Q',C'P',C'U',X'FF'                                             
         DC    C'Q',C'U',C'U',X'FF'                                             
         DC    X'FE'                                                            
*---------------------------------------------------------------------*         
* CALCULATE TOTAL SPOTS AND DOLLARS FOR AGENCY                                  
*---------------------------------------------------------------------*         
AGYTOT   NTR1  BASE=*,WORK=(R4,IMWORKQ),LABEL=*                                 
         USING IMWORKD,R4                                                       
         MVC   IMSVKEY,KEY                                                      
         MVC   IMSVIO,AIO                                                       
*                                                                               
         LA    RE,IMIO                                                          
         ST    RE,AIO                                                           
*                                                                               
         XC    GTOTAL$,GTOTAL$                                                  
         XC    GSPT#,GSPT#                                                      
         OI    FLAGS,FGTOTALQ                                                   
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(RDARKRT-RDARKEY),SELECTKY                                    
*                                                                               
         MVI   KEY+RDARKRT-RDARKEY,X'40' BUY RECORD                             
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
ATOT10   DS    0H                                                               
         CLC   KEY(RDARKSEQ-RDARKEY),KEYSAVE                                    
         BNE   ATOTX                                                            
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         CLI   KEY+RDARKSRT-RDARKEY,X'00' BUY HEADER                            
         BE    ATOT20                                                           
         CLI   KEY+RDARKSRT-RDARKEY,X'10' BUY ORBITS                            
         BE    ATOT30                                                           
         CLI   KEY+RDARKSRT-RDARKEY,X'30' BUY DETAIL                            
         BE    ATOT40                                                           
         B     ATOT60                                                           
*                                                                               
* PROCESS HEADER RECORD                                                         
*                                                                               
ATOT20   DS    0H                                                               
         L     R6,AIO                                                           
         USING RDARBYEL,R6                                                      
         MVI   ELCODE,X'01'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         TM    RDARBYDL,X'80'+X'40' HARD/SOFT DELETED??                         
         BNZ   ATOT60              SKIP                                         
         MVC   BUYCOST,RDARBYCO                                                 
         MVI   STARTDAY,0          CLEAR START/END DAYS OF WEEK                 
         MVI   ENDDAY,0                                                         
         GOTOR STARTEND,DMCB,RDARBYRO,WORK                                      
         B     ATOT60                                                           
         DROP  R6                                                               
*                                                                               
ATOT30   DS    0H                                                               
         L     R6,AIO                                                           
         USING RDAROBEL,R6                                                      
         MVI   ELCODE,X'01'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         TM    RDAROBDL,X'80'+X'40' HARD/SOFT DELETED??                         
         BNZ   ATOT60              SKIP                                         
         DROP  R6                                                               
*                                                                               
         GOTOR BUYORBIT,DMCB,AIO                                                
         B     ATOT60              READ NEXT                                    
*                                                                               
ATOT40   DS    0H                                                               
         L     R6,AIO                                                           
         USING RDARBDEL,R6                                                      
         MVI   ELCODE,X'01'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         TM    RDARBDDL,X'80'+X'40' HARD/SOFT DELETED??                         
         BNZ   ATOT60              SKIP                                         
         DROP  R6                                                               
*                                                                               
         GOTOR BUYDETL,DMCB,AIO                                                 
         BNE   ATOT60              READ NEXT                                    
*                                                                               
         L     R6,AIO                                                           
         USING RDARBUEL,R6                                                      
         MVI   ELCODE,X'02'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
ATOT50   DS    0H                                                               
         ZIC   R1,RDARBUWK                                                      
         XC    HALF,HALF                                                        
         MVC   HALF+1(1),RDARBUSW                                               
         MH    R1,HALF                                                          
         ZICM  R0,GSPT#,4                                                       
         AR    R0,R1                                                            
         STCM  R0,15,GSPT#                                                      
         MVC   FULL,RDARBU$$                                                    
         M     R0,FULL                                                          
         ZICM  R0,GTOTAL$,4                                                     
         AR    R0,R1                                                            
         STCM  R0,15,GTOTAL$                                                    
*                                                                               
         BRAS  RE,NEXTEL                                                        
         BE    ATOT50                                                           
         DROP  R6                                                               
*                                                                               
ATOT60   DS    0H                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
         B     ATOT10                                                           
*                                                                               
ATOTX    DS    0H                                                               
         MVC   KEY,IMSVKEY                                                      
         MVC   AIO,IMSVIO                                                       
         NI    FLAGS,X'FF'-FGTOTALQ                                             
         B     EXIT                                                             
         DROP  R4                                                               
***********************************************************************         
* PROCESS LINK SEGMENT AND ENFORCE INTEGRITY.                                   
* LINES THAT ARE MATCHED SHOULDN'T HAVE A LINK RELATIONSHIP WITH OTHER          
* SEGMENTS, THOSE LINKS NEED TO BE BROKEN UP AND SEGMENTS NEED TO BE            
* CLEAN UP ACCORDINGLY                                                          
***********************************************************************         
PROCLNK  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,X'0B'                                                  
         MVI   TR.TLBYFLG,TLLNKQ                                                
         GOTO1 GOTSAR,TSARDH                                                    
         BL    PLNKX                                                            
*                                                                               
PLNK0030 DS    0H                                                               
         CLI   TR.TLBYFLG,TLLNKQ   TYPE LINK                                    
         BNE   PLNKX               NO, WE ARE DONE                              
*                                                                               
         MVC   SAVEKEY(L'TSARKEY),TSARREC+2  SAVE OFF THIS KEY                  
         MVC   TSARREC2,TSARREC    SAVE OFF THIS RECRD                          
TR2      USING TLSTD,TSARREC2                                                   
*                                                                               
         OC    TR.TLBYMLNK,TR.TLBYMLNK                                          
         BNZ   PLNK0032            DAILY/C.O?                                   
*                                                                               
         CLI   TR.TLBYLNK,0        MATCH YET PROPOSED?                          
         BE    PLNK0150            SKIP                                         
         B     PLNK0040                                                         
*                                                                               
PLNK0032 DS    0H                                                               
*                                                                               
* INNER LOOP START : TO PROCESS DAILY/COST OVERRIDE                             
*                                                                               
*&&DO                                                                           
         TM    TR.TLBYFLG3,X'10'                                                
         BZ    PLNK0034                                                         
         CLC   TR.TLBYRSPT,TR.TLBYASPT                                          
         BE    PLNK0080            TOTALLY MATCH, SKIP                          
         TM    TR.TLBYFLG3,X'80'                                                
         BO    PLNK0080                                                         
*&&                                                                             
PLNK0034 DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TSARREC+2(TLINDXLQ),TSARREC2+2                                   
         MVI   TR.TLBYFLG,TLUMTHQ  SEEK CO-LINES                                
         MVI   TR.TLBYTYPA,0                                                    
         MVI   TR.TLBYLNK,0                                                     
         MVC   KEYSAVE(L'TLKEY),TSARREC+2                                       
         GOTO1 GOTSAR,TSARDH                                                    
*                                                                               
PLNK0036 DS    0H                                                               
         CLC   KEYSAVE(TLINDXLQ),TSARREC+2                                      
         BNE   PLNK0080            NOTHING, GET NEXT RECORD                     
*                                                                               
         GOTO1 GOTSAR,TSADEL       YES, CHANGE UNMATCH TO LINK                  
         BE    *+6                                                              
         DC    H'0'                                                             
         MVI   TR.TLBYFLG,TLLNKQ   CHANGE UNMATCH TO LINK                       
         MVI   TR.TLBYFLG2,TLLNKQ                                               
         MVC   TR.TLBYLNK,TR2.TLBYLNKT                                          
         MVC   TR.TLBYLNKT,TR2.TLBYLNKT THIS FIELD IS PERMANENT                 
         MVI   TR.TLBYTYPA,TLTYPAQ                                              
         MVI   TR.TLBYTYP2,TLTYPAQ                                              
         GOTO1 GOTSAR,TSAADD                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         XC    TSARREC,TSARREC                                                  
*                                                                               
PLNK0039 DS    0H                  NO, GET NEXT RECORD                          
         GOTO1 GOTSAR,TSANXT                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         CLI   TR.TLKTYP,X'0B'     BUY RECORD?                                  
         BNE   PLNK0080            NO, RESTORE SEQUENCE AND  NEXT               
*                                                                               
         B     PLNK0036                                                         
*                                                                               
* LOOP END                                                                      
*                                                                               
PLNK0040 DS    0H                                                               
         CLI   TR2.TLBYTYPA,TLTYPAQ                                             
         BE    PLNK0150                                                         
         OC    TR2.TLBYRSPT,TR2.TLBYRSPT  ZERO REP SPOTS?                       
         BNZ   PLNK0045            NO, NORMAL PROCESSING                        
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSANXT                                                    
         BNE   PLNK0100            END OF FILE,MARK AS UNMATCH                  
*                                                                               
         CLC   SAVEKEY(TLBYMLNK-TLKTYP),TSARREC+2                               
         BE    PLNK0100            NOT END OF GROUP,MARK AS UNMATCH             
*                                                                               
PLNK0045 DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,TLXTYPQ   TYPE Z                                       
         MVC   TR.TLXYBY#,TR2.TLBYLNKT                                          
         GOTO1 GOTSAR,TSARDH                                                    
         TM    TB.TSERRS,TSERNF    YES                                          
         BO    PLNK0100            AGY LINE IS CANCELLED, MARK REP AS           
*                                                                               
         MVC   ELEM(L'TSARREC),TSARREC                                          
TR3      USING TLSTD,ELEM                                                       
*                                                                               
         XC    TSARREC,TSARREC     SEE IF THIS LINE HAD BEEN MATCHED            
         MVI   TR.TLKTYP,X'0B'                                                  
         MVI   TR.TLBYFLG,TLMTHQ                                                
         MVC   TR.TLBYDAY(TLXKEYQ),TR3.TLXYDAY                                  
*                                                                               
         GOTO1 GOTSAR,TSARDH                                                    
         TM    TB.TSERRS,TSERNF    YES                                          
         BZ    PLNK0100            LINE THAT THIS LINK TO IS MATCHED            
*                                                                               
         XC    TSARREC,TSARREC     SEE IF THIS LINE HAD BEEN MATCHED            
         MVI   TR.TLKTYP,X'0B'                                                  
         MVI   TR.TLBYFLG,TLMTHQ2  MATCH TYPE 2                                 
         MVC   TR.TLBYDAY(TLXKEYQ),TR3.TLXYDAY                                  
*                                                                               
         GOTO1 GOTSAR,TSARDH                                                    
         TM    TB.TSERRS,TSERNF    YES                                          
         BZ    PLNK0100            LINE THAT THIS LINK TO IS MATCHED            
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,X'0B'     FIND UNMATCHED LINE                          
         MVI   TR.TLBYFLG,TLUMTHQ                                               
         MVC   TR.TLBYMLNK,TR2.TLBYMLNK                                         
         MVC   TR.TLBYDAY(TLXKEYQ),TR3.TLXYDAY                                  
*                                                                               
         GOTO1 GOTSAR,TSARDH                                                    
         BE    PLNK0050                                                         
*                                                                               
         OC    TR2.TLBYMLNK,TR2.TLBYMLNK                                        
         BNZ   PLNK0080            YES                                          
*                                                                               
         B     PLNK0100                                                         
*                                                                               
PLNK0050 DS    0H                                                               
         OC    TR.TLBYALNK,TR.TLBYALNK                                          
         BZ    PLNK0100                                                         
         GOTO1 GOTSAR,TSADEL       DELETE                                       
         BE    *+6                                                              
         DC    H'0'                                                             
         MVI   TR.TLBYFLG,TLLNKQ   CHANGE UNMATCH TO LINK                       
         MVI   TR.TLBYFLG2,TLLNKQ                                               
         MVC   TR.TLBYLNK,TR2.TLBYLNKT                                          
         MVC   TR.TLBYLNKT,TR2.TLBYLNKT THIS FIELD IS PERMANENT                 
         MVI   TR.TLBYTYPA,TLTYPAQ                                              
         MVI   TR.TLBYTYP2,TLTYPAQ                                              
         GOTO1 GOTSAR,TSAADD                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
PLNK0080 DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TSARREC+2(L'TSARKEY),SAVEKEY                                     
         GOTO1 GOTSAR,TSARDH        RESTORE SEQUENCE                            
         B     PLNK0150                                                         
*                                                                               
PLNK0100 DS    0H                  MOVE ORIGINAL L SEGMENT INTO UNMATCH         
         XC    TSARREC,TSARREC                                                  
         MVC   TSARREC+2(L'TSARKEY),SAVEKEY                                     
*                                                                               
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   HALF,TB.TSRNUM                                                   
*                                                                               
         GOTO1 GOTSAR,TSADEL                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVI   TR.TLBYFLG,TLUMTHQ                                               
         MVI   TR.TLBYFLG2,TLUMTHQ                                              
         GOTO1 GOTSAR,TSAADD                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   TXNUM,HALF                                                       
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSAGET                                                    
         BE    PLNK0180                                                         
         DC    H'0'                                                             
*                                                                               
PLNK0150 DS    0H                                                               
         GOTO1 GOTSAR,TSANXT                                                    
         BL    PLNK0200                                                         
PLNK0180 DS    0H                                                               
         CLI   TR.TLKTYP,X'0B'                                                  
         BE    PLNK0030                                                         
*                                                                               
PLNK0200 DS    0H                                                               
*                                                                               
PLNKX    DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
         DROP  TR2,TR3                                                          
***********************************************************************         
* PROCESS LINK SEGMENT AND ENFORCE INTEGRITY.                                   
* LINES THAT ARE MATCHED SHOULDN'T HAVE A LINK RELATIONSHIP WITH OTHER          
* SEGMENTS, THOSE LINKS NEED TO BE BROKEN UP AND SEGMENTS NEED TO BE            
* CLEAN UP ACCORDINGLY                                                          
***********************************************************************         
PROCLNK2 NTR1  BASE=*,WORK=(R4,DLWORKQ),LABEL=*                                 
         USING DLWORKD,R4                                                       
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,X'0B'                                                  
         MVI   TR.TLBYFLG,TLLNKQ                                                
         GOTO1 GOTSAR,TSARDH                                                    
         BL    PLN1X                                                            
*                                                                               
* LOOP FOR DAILY BUYS/COST OVERRIDE                                             
PLN10030 DS    0H                                                               
         MVC   DLWORK,TSARREC                                                   
         MVC   DLTSRNUM,TB.TSRNUM                                               
         OC    TR.TLBYMLNK,TR.TLBYMLNK                                          
         BZ    PLN1NXT                                                          
         TM    TR.TLBYFLG4,X'10'   ADD-TO-SKED?                                 
         BO    PLN1NXT                                                          
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TSARREC+2(TLINDXLQ),DLWORK+2                                     
         MVI   TR.TLBYFLG,TLMTHQ                                                
*                                                                               
         CLI   TR.TLBYTYPA,TLTYPAQ                                              
         BNE   *+8                                                              
         MVI   TR.TLBYTYPA,0                                                    
*                                                                               
         MVC   DLSVKEY(TLINDXLQ),TSARREC+2                                      
         GOTO1 GOTSAR,TSARDH                                                    
         CLC   DLSVKEY(TLINDXLQ),TSARREC+2                                      
         BNE   PLN1NXT                                                          
*                                                                               
         MVC   TSARREC,DLWORK                                                   
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         GOTO1 GOTSAR,TSADEL                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         MVI   TR.TLBYFLG,TLMTHQ                                                
         GOTO1 GOTSAR,TSAADD                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
PLN1NXT  DS    0H                                                               
         CLC   DLTSRNUM,TB.TSRNUM                                               
         BE    PLN1NXT1                                                         
         MVC   TXNUM,DLTSRNUM                                                   
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   TSARREC,DLWORK                                                   
         BNE   PLN10030                                                         
*                                                                               
PLN1NXT1 DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSANXT                                                    
         BL    PLN1X                                                            
         CLI   TR.TLKTYP,X'0B'                                                  
         BE    PLN10030                                                         
PLN1X    DS    0H                                                               
*                                                                               
         XC    DLBYTE,DLBYTE                                                    
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,X'0B'                                                  
         MVI   TR.TLBYFLG,TLLNKQ                                                
         GOTO1 GOTSAR,TSARDH                                                    
         BL    PLN2X                                                            
*                                                                               
PLN20030 DS    0H                                                               
*&&TT                                                                           
         CLI   TR.TLBYLNK,2                                                     
         BNE   *+6                                                              
         DC    X'0770'                                                          
*&&                                                                             
         MVC   DLWORK,TSARREC                                                   
         MVC   DLTSRNUM,TB.TSRNUM                                               
*                                                                               
PLN20040 DS    0H                                                               
         CLI   TR.TLBYFLG,TLLNKQ   TYPE LINK                                    
         BE    PLN20050            YES, PROCESS                                 
         CLI   TR.TLBYFLG,TLMTHQ2                                               
         BNE   PLN2X                                                            
         OC    TR.TLBYALNK,TR.TLBYALNK  CLEAN UP MATCH TSAR AS WELL             
         BZ    PLN20600                                                         
         OC    TR.TLBYRLNK,TR.TLBYRLNK                                          
         BZ    PLN20600                                                         
         B     PLN2NXT                                                          
*                                                                               
PLN20050 DS    0H                                                               
         CLI   TR.TLBYTYPA,TLTYPAQ TYPE AGENCY?                                 
         BE    PLN20500            YES                                          
*                                                                               
         GOTOR DAILYAGY            IS THERE DAILY AGENCY BUYS IN GROUP          
         BE    PLN2NXT             YES - SKIP                                   
*                                                                               
         CLI   TR.TLBYLNK,0        IF MATCH SEGMENT THAT GO TURNED              
         BNE   PLN20080            INTO PROPOSED                                
         OC    TR.TLBYALNK,TR.TLBYALNK                                          
         BZ    PLN20600            NEED TO CHECK IF IT STILL HAS                
         OC    TR.TLBYRLNK,TR.TLBYRLNK                                          
         BZ    PLN20600            BOTH AGY+REP LINES                           
         B     PLN2NXT                                                          
*                                                                               
PLN20080 DS    0H                                                               
         OC    TR.TLBYALNK,TR.TLBYALNK                                          
         BZ    PLN20100                                                         
         OC    TR.TLBYRLNK,TR.TLBYRLNK                                          
         BZ    PLN20100                                                         
         B     PLN2NXT             THOUGH IT HAS LINK NUMBER                    
*                                  BUT IT IS A MATCH, SO SKIP                   
*                                                                               
PLN20100 DS    0H                                                               
*&&TT                                                                           
         CLI   DLWORK+TLBYLNK-TLREC,2                                           
         BNE   *+6                                                              
         DC    X'0770'                                                          
*&&                                                                             
         XC    TSARREC,TSARREC                                                  
         MVC   TSARREC+2(TLINDXLQ),DLWORK+2                                     
         MVI   TR.TLBYTYPA,TLTYPAQ                                              
         MVC   DLSVKEY(TLINDXLQ),TSARREC+2                                      
         GOTO1 GOTSAR,TSARDH                                                    
         CLC   DLSVKEY(TLINDXLQ),TSARREC+2                                      
         BE    PLN2NXT                                                          
*                                                                               
         B     PLN20600                                                         
*                                                                               
PLN20500 DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TSARREC+2(TLINDXLQ),DLWORK+2                                     
         MVI   TR.TLBYTYPA,0                                                    
         MVC   DLSVKEY(TLINDXLQ),TSARREC+2                                      
         GOTO1 GOTSAR,TSARDH                                                    
         CLC   DLSVKEY(TLINDXLQ),TSARREC+2                                      
         BE    PLN2NXT                                                          
*                                                                               
PLN20600 DS    0H                                                               
         MVC   TSARREC,DLWORK                                                   
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         XC    TB.TSRNUM,TB.TSRNUM                                              
         GOTO1 GOTSAR,TSADEL                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVI   TR.TLBYFLG,TLUMTHQ                                               
         MVI   TR.TLBYMLNK,0                                                    
         MVI   TR.TLBYSUBL,0                                                    
         MVI   TR.TLBYLNK,0        CLEAR LINK NUMBER                            
         MVI   TR.TLBYTYPA,0                                                    
*                                                                               
         OI    TR.TLBYFLG3,X'04'   ALREADY PROCESSED                            
         GOTO1 GOTSAR,TSAADD                                                    
         TM    TB.TSERRS,TSEDUP                                                 
         BZ    PLN2NXT                                                          
         GOTOR MERGES              MERGE SEGMENTS                               
*                                                                               
         OC    TR.TLBYALNK,TR.TLBYALNK                                          
         BZ    PLN2NXT                                                          
         OC    TR.TLBYRLNK,TR.TLBYRLNK                                          
         BZ    PLN2NXT                                                          
*                                                                               
         GOTO1 GOTSAR,TSADEL                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVI   TR.TLBYFLG,TLMTHQ      MATCH                                     
         OI    TR.TLBYFLG3,X'04'   ALREADY PROCESSED                            
         GOTO1 GOTSAR,TSAADD                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
**TESTING                                                                       
*&&DO                                                                           
         BE    *+6                                                              
         DC    H'0'                                                             
*&&                                                                             
*                                                                               
PLN2NXT  DS    0H                                                               
         MVC   TXNUM,DLTSRNUM                                                   
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   TSARREC,DLWORK      ORDER OF TSAR REC HASN'T CHANGED             
         BE    PLN20700            PROCESS THE NEXT RECORD                      
         TM    TR.TLBYFLG3,X'04'   ORDER OF TSAR REC HAS CHANGED                
         BZ    PLN20030            AND THIS REC HASN'T BEEN PROCESSED           
*                                                                               
*                                                                               
PLN20700 DS    0H                  GET NEXT TSAR RECORD                         
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSANXT                                                    
         BL    PLN2X                                                            
         CLI   TR.TLKTYP,X'0B'                                                  
         BE    PLN20030                                                         
*                                                                               
*&&DO                                                                           
         CLC   DLTSRNUM,TB.TSRNUM                                               
         BE    PLN20700                                                         
*                                                                               
         MVC   TXNUM,DLTSRNUM                                                   
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
PLN20700 DS    0H                                                               
         GOTO1 GOTSAR,TSANXT                                                    
         BL    PLN20900                                                         
PLN20800 DS    0H                                                               
         CLI   TR.TLKTYP,X'0B'                                                  
         BE    PLN20030                                                         
*&&                                                                             
*                                                                               
PLN20900 DS    0H                                                               
*                                                                               
PLN2X    DS    0H                                                               
         GOTOR CLEARFLG            CLEAR "PROCESSED" FLAG                       
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
         DROP  R4                                                               
***********************************************************************         
* LOOP THROUGH ALL BUY SEGMENT AND CLEAR TLFBYFLG3,X'04' BIT                    
***********************************************************************         
CLEARFLG NTR1  BASE=*,LABEL=*                                                   
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,X'0B'                                                  
         GOTO1 GOTSAR,TSARDH                                                    
         BL    CFLGX                                                            
*                                                                               
CFLG0030 DS    0H                                                               
         TM    TR.TLBYFLG3,X'04'                                                
         BZ    CFLGNXT                                                          
         NI    TR.TLBYFLG3,X'FF'-X'04'                                          
         GOTO1 GOTSAR,TSAWRT                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
CFLGNXT  DS    0H                                                               
         GOTO1 GOTSAR,TSANXT                                                    
         BL    CFLGX                                                            
         CLI   TR.TLKTYP,X'0B'                                                  
         BE    CFLG0030                                                         
*                                                                               
CFLGX    DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
******************************************************************              
* IS THERE AGENCY LINE IN  THIS BUY GROUP                                       
******************************************************************              
         USING SMWORKD,R4                                                       
DAILYAGY NTR1  BASE=*,WORK=(R4,SMWORKQ),LABEL=*                                 
         MVC   SMWORK1,TSARREC                                                  
         MVC   SMTXNUM,TXNUM                                                    
*                                                                               
         OC    TR.TLBYMLNK,TR.TLBYMLNK                                          
         BZ    DAGYNO                                                           
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TSARREC+2(TLINDXLQ),SMWORK1+2                                    
         GOTO1 GOTSAR,TSARDH                                                    
*                                                                               
DAGY10   DS    0H                                                               
         CLC   SMWORK1+2(TLINDXLQ),TSARREC+2                                    
         BNE   DAGY50                                                           
*                                                                               
         OC    TR.TLBYALNK,TR.TLBYALNK                                          
         BNZ   DAGYYES             YES,THERE IS AGY LINES                       
         GOTO1 GOTSAR,TSANXT                                                    
         B     DAGY10                                                           
*                                                                               
DAGY50   DS    0H                  SEARCH FOR AGY LINES IN                      
         XC    TSARREC,TSARREC     TOTALLY MATCH SEGMENTS                       
         MVC   TSARREC+2(TLINDXLQ),SMWORK1+2                                    
         MVI   TR.TLBYFLG,TLMTHQ3                                               
         MVI   TR.TLBYLNK,0                                                     
         MVC   SAVEKEY,TSARREC                                                  
*                                                                               
         GOTO1 GOTSAR,TSARDH                                                    
         CLC   SAVEKEY+2(TLINDXLQ),TSARREC+2                                    
         BNE   DAGYNO                                                           
*                                                                               
         OC    TR.TLBYALNK,TR.TLBYALNK                                          
         BZ    DAGYNO              YES,THERE IS AGY LINES                       
*                                                                               
DAGYYES  SR    RC,RC                                                            
DAGYNO   LTR   RC,RC                                                            
         MVC   TSARREC,SMWORK1                                                  
         MVC   TXNUM,SMTXNUM                                                    
         B     EXIT                                                             
*                                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
         DROP  R4                                                               
***********************************************************************         
* BUILD DAYS, TIMES AND PROGRAM NAMES TSAR RECORDS                              
* BUY RECORD ALREADY DELIVERED TO AIO                                           
* P1,HOB, X'01' = DAYS                                                          
*         X'02' = TIMES                                                         
*         X'03' = PROGRAM NAME                                                  
*         X'04' = GRID                                                          
***********************************************************************         
BLDDTP   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    TSARREC,TSARREC                                                  
         XC    TEMPFLAG,TEMPFLAG                                                
         STCM  RF,8,TR.TLKTYP                                                   
*                                                                               
         MVC   SVELCODE,ELCODE                                                  
*                                                                               
         CLI   TR.TLKTYP,X'01'     DAYS                                         
         BE    BLDDTP10                                                         
         CLI   TR.TLKTYP,X'02'     TIMES                                        
         BE    BLDDTP10                                                         
         CLI   TR.TLKTYP,X'03'     PROGRAM NAME                                 
         BE    BLDDTP50                                                         
         CLI   TR.TLKTYP,X'04'     GRID                                         
         BE    BLDDTP80                                                         
         CLI   TR.TLKTYP,X'05'     PROGRAM NAME BASE ON BUY LINE #              
         BE    BLDDT150                                                         
         DC    H'0'                                                             
*                                                                               
BLDDTP10 DS    0H                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'02'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING RBUYDYEL,R6                                                      
*                                                                               
         LA    R3,TR.TLDATA                                                     
*                                                                               
BLDDTP20 DS    0H                                                               
         CLI   TR.TLKTYP,X'01'     DAYS                                         
         BNE   BLDDTP30                                                         
         MVC   0(2,R3),RBUYDYIN                                                 
*                                                                               
* IF SINGLE DAY, CHANGE LEFTMOST NIBBLE TO X'F' SO SINGLE DAY WILL SORT         
* AFTER DAY RANGES (IE: WED, X'33' WILL BECOME 'F3')                            
*                                                                               
         XC    HALF,HALF                                                        
         MVZ   HALF(1),RBUYDYIN                                                 
         ZIC   R1,HALF                                                          
         SRL   R1,4                                                             
         STC   R1,HALF             SHIFT START DAY TO LOWER HALF BYTE           
         MVN   HALF+1(1),RBUYDYIN                                               
         CLC   HALF(1),HALF+1      SINGLE DAY?                                  
         BNE   BLDDTP25                                                         
         OI    0(R3),X'F0'         START DAY NIBBLE IS SET TO X'F'              
*                                                                               
BLDDTP25 DS    0H                                                               
         AHI   R3,2                                                             
         B     BLDDTP40                                                         
*                                                                               
BLDDTP30 DS    0H                  TIMES                                        
         MVC   0(4,R3),RBUYDYT1                                                 
*                                                                               
         CLC   RBUYDYT1,=Y(0459)   00:01AM - 04:59AM                            
         BH    BLDDTP35            SORTS LATER SINCE BROADCAST DAY              
         ZICM  RE,RBUYDYT1,2       ENDS AT 4:59AM                               
         AHI   RE,2400                                                          
         STCM  RE,3,0(R3)                                                       
*                                                                               
BLDDTP35 DS    0H                                                               
         OC    RBUYDYT2,RBUYDYT2   SINGLE TIME?                                 
         BZ    BLDDTP38                                                         
         CLC   RBUYDYT2,=Y(0459)                                                
         BH    BLDDTP38                                                         
         ZICM  RE,RBUYDYT2,2                                                    
         AHI   RE,2400                                                          
         STCM  RE,3,2(R3)                                                       
*                                                                               
BLDDTP38 DS    0H                                                               
         AHI   R3,4                                                             
*                                                                               
BLDDTP40 DS    0H                                                               
         BRAS  RE,NEXTEL                                                        
         BE    BLDDTP20                                                         
         DROP  R6                                                               
*                                                                               
         LA    RE,TR.TLKTYP        INSERT VARIABLE LENGTH                       
         SR    R3,RE                                                            
         AHI   R3,2                OVERHEAD                                     
         STCM  R3,3,TR.TLLEN                                                    
         CHI   R3,255              CHECK IF ENOUGH ROOM                         
         BNH   BLDDTPX                                                          
         DC    H'0'                                                             
*                                                                               
* PROGRAM NAME                                                                  
*                                                                               
BLDDTP50 DS    0H                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'21'                                                     
         BRAS  RE,GETEL                                                         
         BE    BLDDTP60                                                         
         MVC   ELCODE,SVELCODE                                                  
         B     EXITH                                                            
*                                                                               
BLDDTP60 DS    0H                                                               
         USING RBUYPGEL,R6                                                      
         ZIC   R1,RBUYPGLN                                                      
         SHI   R1,2                OVERHEAD                                     
         STCM  R1,3,TR.TLPGLEN                                                  
*                                                                               
         SHI   R1,1                EX LENGTH                                    
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   TR.TLPGNAME(0),RBUYPGM                                           
*                                                                               
         AHI   R1,4                TYPE+OVERHEAD                                
         STCM  R1,3,TR.TLLEN       INSERT VARIABLE LENGTH                       
         B     BLDDTPX                                                          
*                                                                               
* GRID                                                                          
*                                                                               
BLDDTP80 DS    0H                  BUILD GRID TSAR RECORD                       
         L     R6,AIO                                                           
         LR    R4,R6                                                            
R        USING RBUYREC,R4                                                       
*                                                                               
         CLC   0(2,R6),=X'0B01'                                                 
         BNE   BLDDTP81                                                         
         GOTOR FAKEZERO            MAKE UP LEADING/TRAILING ZERO                
BLDDTP81 DS    0H                  BUILD GRID TSAR RECORD                       
         MVI   TR.TLGTYP,C'R'                                                   
         MVC   TR.TLGLN#,R.RBUYKLIN                                             
         CLC   0(2,R6),=X'0B01'                                                 
         BNE   BLDDTP85                                                         
         MVI   TR.TLGTYP,C'A'                                                   
         MVC   TR.TLGLN#,R.RBUYKMLN  SHADOW RECORD                              
         TM    R.RBUYFLG2,X'80'                                                 
         BO    BLDDTP83            DAILY?                                       
*                                                                               
         MVI   ELCODE,RBUYXXCQ                                                  
         BRAS  RE,GETEL                                                         
         BNE   BLDDTP85                                                         
         USING RBUYXXEL,R6                                                      
*&&CT                                                                           
         TM    RBUYXXFG,X'40'      COST OVERRIRDE?                              
         BNO   BLDDTP85                                                         
*&&                                                                             
*&&CD                                                                           
         TM    RBUYXXFG,X'40'      COST OVERRIRDE?                              
         BO    BLDDTP83                                                         
         TM    RBUYXXFG,X'10'      CONFLICT END DATE                            
         BNO   BLDDTP85                                                         
*&&                                                                             
         DROP  R6                                                               
*                                                                               
BLDDTP83 DS    0H                                                               
         MVC   TR.TLGSUB#,R.RBUYKLIN                                            
*                                                                               
BLDDTP85 DS    0H                  BUILD GRID TSAR RECORD                       
         GOTOR BLDBGRID,DMCB,AIO,BUYGRID                                        
*                                                                               
         MVC   TR.TLGSTD,GSTRDATE  SAVE START DATE                              
         GOTOR SETDATE,DMCB,GENDDATE SET DATE TO MONDAY                         
*                                                                               
         MVC   TR.TLGEND,GENDDATE  SAVE END DATE                                
         MVC   TR.TLGRID,BUYGRID                                                
         MVC   TR.TLGTOT,HALF                                                   
         MVC   TR.TLGRIDX,=X'FFFF'    MARK END OF TABLE                         
*                                                                               
         MVC   TR.TLLEN,=Y(TLGRLQ)    INSERT LENGTH                             
         B     BLDDTPX                                                          
*                                                                               
* PROGRAM NAME                                                                  
*                                                                               
BLDDT150 DS    0H                                                               
         L     R6,AIO                                                           
         LR    R4,R6                                                            
         MVI   ELCODE,X'21'                                                     
         BRAS  RE,GETEL                                                         
         BE    BLDDT160                                                         
         MVC   ELCODE,SVELCODE                                                  
         B     EXITH                                                            
*                                                                               
BLDDT160 DS    0H                                                               
         MVI   TR.TLPTYP,C'A'                                                   
         MVC   TR.TLPLN#,R.RBUYKMLN  SHADOW RECORD                              
         CLC   R.RBUYKEY(2),=X'0B01'                                            
         BE    BLDDT180                                                         
         MVC   TR.TLPLN#,R.RBUYKLIN                                             
         MVI   TR.TLPTYP,C'R'                                                   
BLDDT180 DS    0H                                                               
*                                                                               
         USING RBUYPGEL,R6                                                      
         ZIC   R1,RBUYPGLN                                                      
         SHI   R1,3                CODE+LENGTH+OVERHEAD                         
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   TR.TLPGM(0),RBUYPGM                                              
*                                                                               
         AHI   R1,1+TLPGM-TLREC     OVERHEAD+KEY                                
         STCM  R1,3,TR.TLLEN       INSERT VARIABLE LENGTH                       
         B     BLDDTPX                                                          
*                                                                               
BLDDTPX  DS    0H                                                               
         MVC   ELCODE,SVELCODE                                                  
         B     EXITOK                                                           
         DROP  R6                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
* FAKEZERO: FAKE UP LEADING AND TRALING ZEROS                        *          
*           READS THE SHADOW RECORD AND ATTEMPT TO FIGURE OUT WHAT   *          
*           GOT CANCELLED.                                           *          
*           AIO -> 0B01 RECORD                                       *          
*           THIS ROUTINE CONVERTS 02 ELEMENT IN DARE RECORD INTO     *          
*           03 ELEMENT AND PUT IT IN THE 0B01 RECORD                 *          
*           FOR TEMPORARY USE BY BLDBGRID TO GENERATE LEADING        *          
*           AND TRAILING ZEROS, THE ELEMENT THAT GOT PUT IN          *          
*           WON'T BE SAVE IN THE 0B01 SINCE THERE IS NO PUTREC       *          
*           TO UPDATE THE RECORD                                     *          
*           IF THERE IS A NEED TO DO PUTREC, THEN WE WILL HAVE TO    *          
*           REMOVE EXACTLY WHAT WE JUST PUT IN                       *          
**********************************************************************          
FAKEZERO NTR1  BASE=*,WORK=(R4,ELWORKQ),LABEL=*                                 
         USING ELWORKD,R4                                                       
         MVC   ELSVIO,AIO                                                       
         MVC   ELSVKEY,KEY                                                      
         LA    RE,ELIO3                                                         
         ST    RE,AIO                                                           
         L     R3,ELSVIO                                                        
         USING RBUYREC,R3                                                       
         XC    ELBYTE,ELBYTE                                                    
*                                                                               
         TM    RBUYFLG2,X'80'      DAILY?                                       
         BO    FKZRX                                                            
         LR    R6,R3                                                            
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   FKZR0050                                                         
         TM    RBUYXXFG-RBUYXXEL(R6),X'40'+X'10'                                
         BNZ   FKZRX               SKIP C.O/CONFLICT END DATE                   
*                                                                               
FKZR0050 DS    0H                                                               
         MVC   KEY(L'SELECTKY),SELECTKY                                         
         GOTO1 HIGH                                                             
         CLC   KEY(27),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
         TM    RDARMISC,X'80'       IS THIS A RESENT?                           
         BO    FKZR0100             YES                                         
         CLI   RDARRNUM,0           NO, IF REV# = 0                             
         BE    FKZR0100                                                         
         OI    ELBYTE,X'80'         THIS IS A NEW REVISION                      
*                                   READ 51 FOR COMPARISON!                     
FKZR0100 DS    0H                                                               
         MVC   KEY(2),=X'4101'                                                  
         TM    ELBYTE,X'80'        REVNEW?                                      
         BZ    *+10                                                             
         MVC   KEY(2),=X'5100'     YES, READ 51 BUY DETAIL REC                  
*                                                                               
K        USING RDARREC,KEY                                                      
         MVC   K.RDARKSEQ,RBUYKMLN                                              
         MVI   K.RDARKRT,X'40'     BUY DETAIL RECORD                            
         MVI   K.RDARKSRT,X'30'                                                 
         NI    DMINBTS,X'FF'-X'08' SKIP DELETE                                  
         GOTO1 HIGH                                                             
         DROP  K                                                                
         MVI   RDUPDATE,C'N'                                                    
         CLC   KEY(27),KEYSAVE                                                  
         BNE   FKZRX                                                            
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'01'                                                     
         BRAS  RE,GETEL                                                         
         BNE   FKZRX                                                            
         TM    RDARBDFL-RDARBDEL(R6),X'80'+X'10'                                
         BNZ   FKZRX               SKIP DAILY/CONFLICT END DATE                 
*                                                                               
         LR    R6,R3                                                            
         MVI   ELCODE,X'02'        GET DATE/TIME ELEMENT FROM BUY REC           
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   ELBYTE2,RBUYDYIN-RBUYDYEL(R6)                                    
*                                  SAVE OFF START-END DAY                       
         L     R6,AIO                                                           
         MVI   ELCODE,X'02'        FIND BUY ELEMENT                             
         BRAS  RE,GETEL                                                         
         BNE   FKZRX                                                            
         USING RDARBUEL,R6                                                      
* CONVERT 02 TO 03 IN 0B RECORD                                                 
*                                                                               
FKZR0120 EQU   *                                                                
         XC    ELTBUILD,ELTBUILD   CLEAR ELEMENT BUILD AREA                     
DETLD    USING RBUYDTEL,ELTBUILD                                                
         MVC   ELTBUILD(2),=X'030B'                                             
*                                  INSERT ELEMENT CODE/LENGTH                   
         GOTO1 DATCON,DMCB,(2,RDARBUSD),(0,WORK)                                
*                                                                               
* READJUST PREVIOUS VERSION OF THE BUY'S START DATE                             
* IF IT HAS A DIFFERENT ROTATION THAN CURRENT BUY                               
* THIS IS SO THAT WHEN TU-F IS CHANGED TO M-F, WE CAN STILL CORRECTLY           
* CALCULTE THE WEEKS IN BETWEEN THE FAKE ELEMENT WE PUT IN                      
* AND THE ELEMENT ALREADY ON BUY RECORD TK#1907981 BY HQIU 9/15/2004            
* BECAUSE TU  - NEXT MON  IS ONE WEEK                                           
* WHERE   MON - NEXT MON  IS TWO WEEKS                                          
*                                                                               
         GOTO1 GETDAY,DMCB,WORK,WORK+30                                         
         ZIC   RE,DMCB             MONDAY=1,TUESDAY=2...                        
*                                                                               
         ZIC   RF,ELBYTE2          ELBYTE2=STARTEND DAY  IN BUY RECORD          
         SRL   RF,4                SHIFT TO GET START DAY                       
         SR    RF,RE               CALCULATE DIFFERENCE                         
         LTR   RF,RF                                                            
         BZ    FKZR0130            NO DIFFERENCE - SKIP                         
*                                                                               
         GOTO1 ADDAY,DMCB,WORK,WORK+30,(RF)   RE-ADJUST START DATE              
         MVC   WORK(6),WORK+30                                                  
*                                  CONVERT START DATE TO EBCDIC                 
FKZR0130 EQU   *                                                                
         ZIC   RF,RDARBUWK         CALCULATE NUMBER OF DAYS                     
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         BCTR  RF,0                MAKE WEEKS ZERO RELATIVE                     
         MHI   RF,7                MULTIPLY WEEKS BY 7                          
         GOTO1 ADDAY,DMCB,WORK,WORK+6,(RF)                                      
*                                                                               
FKZR0190 EQU   *                                                                
         GOTO1 DATCON,DMCB,(0,WORK),(3,DETLD.RBUYDTST)                          
*                                                                               
         GOTO1 DATCON,DMCB,(0,WORK+6),(3,DETLD.RBUYDTED)                        
*                                  INSERT END   DATE INTO ELEMENT               
FKZR0260 EQU   *                                                                
         OI    DETLD.RBUYDTIN,X'81'   ELSE LATER, SET OVERRIDE ANYWAY           
         MVI   DETLD.RBUYDTNW,0    ZERO OUT ALL SPOTS                           
*                                                                               
         MVC   DETLD.RBUYDTWK,RDARBUWK                                          
*                                  INSERT NUMBER OF WEEKS                       
         LR    R2,R6                                                            
         LR    R6,R3                                                            
         MVI   ELCODE,X'03'                                                     
         BRAS  RE,GETEL                                                         
         BNE   FKZRX                                                            
*                                                                               
         XC    DMCB+8(8),DMCB+8                                                 
                                                                                
         CLC   DETLD.RBUYDTST,RBUYDTST-RBUYDTEL(R6)                             
         BL    FKZR0280                                                         
         ZIC   RE,1(R6)                                                         
         AR    R6,RE                                                            
FKZR0280 DS    0H                                                               
         ST    R6,DMCB+8                                                        
*                                                                               
FKZR0300 DS    0H                                                               
         GOTO1 VRECUP,DMCB,(C'R',(R3)),ELTBUILD                                 
         LR    R6,R2               RELOAD R6 TO AGY ORDER REC                   
         MVI   ELCODE,X'02'                                                     
         BRAS  RE,NEXTEL                                                        
         BE    FKZR0120                                                         
*                                                                               
*        DC    H'0'                                                             
FKZRX    DS    0H                                                               
         MVC   KEY,ELSVKEY                                                      
         MVC   AIO,ELSVIO                                                       
         GOTO1 HIGH                                                             
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
         DROP  R4                                                               
         DROP  R3                                                               
         DROP  R6                                                               
***********************************************************************         
* CHK TO SEE IF THE LINE THIS IS LINK TO TOTALLY MATCH UP WITH THIS             
* LINE, IF SO, SKIP TSAR PROCESSING FOR THIS LINE                               
***********************************************************************         
CHKLNK   NTR1  BASE=*,WORK=(R2,DLWORKQ),LABEL=*                                 
         USING DLWORKD,R2                                                       
         USING RBUYREC,R4                                                       
*                                                                               
         L     R4,AIO                                                           
*                                                                               
         CLC   RBUYREC(2),=X'0B01'                                              
         BE    CLNK0200                                                         
*                                                                               
         CLI   RBUYAGBL,0                                                       
         BE    EXITOK                                                           
*                                                                               
         LA    RE,MTCHTAB                                                       
         L     RF,AEOTBLE                                                       
         USING MTCHTABD,RE                                                      
*                                                                               
CLNK0020 DS    0H                                                               
         CR    RE,RF                                                            
         BNL   CLNK0025                                                         
         CLC   ABUY#,RBUYAGBL      SKIP THIS AGENCY BUY                         
         BE    EXITOK              IF IT ALREADY MATCH TOTALLY                  
         LA    RE,MTCHTABL(RE)     TO A LINKED REP BUY                          
         B     CLNK0020                                                         
         DROP  RE                                                               
*                                                                               
CLNK0025 DS    0H                                                               
TR2      USING TLSTD,TSARREC2                                                   
*                                                                               
         XC    TSARREC,TSARREC                                                  
*                                                                               
         MVI   TR.TLKTYP,X'04'                                                  
         MVI   TR.TLGTYP,C'R'                                                   
         MVC   TR.TLGLN#,RBUYKLIN                                               
*                                                                               
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   TSARREC2,TSARREC                                                 
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,X'04'                                                  
         MVI   TR.TLGTYP,C'A'                                                   
         MVC   TR.TLGLN#,RBUYAGBL                                               
*                                                                               
         GOTO1 GOTSAR,TSARDH                                                    
         BNE   EXITOK              LINE CANCELED                                
*                                                                               
         MVC   DLBYTE,RBUYAGBL                                                  
         MVC   DLSVIO,AIO                                                       
         MVC   DLSVKEY,KEY                                                      
*                                                                               
         LA    RE,DLIO                                                          
         ST    RE,AIO                                                           
*                                                                               
         MVI   KEY+1,X'01'         READ 0B01 RECORD FOR COMPARISON              
K        USING RBUYKEY,KEY                                                      
         MVC   K.RBUYKMLN,DLBYTE                                                
         MVI   K.RBUYKLIN,0                                                     
         DROP  K                                                                
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEYSAVE(26),KEY                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         GOTO1 GETREC                                                           
*                                                                               
         L     R4,AIO                                                           
         L     R6,DLSVIO                                                        
*                                                                               
ABUYD    USING RBUYREC,R4                                                       
RBUYD    USING RBUYREC,R6                                                       
*                                                                               
         CLC   ABUYD.RBUYCOS,RBUYD.RBUYCOS                                      
         BNE   CLNKY                                                            
*                                                                               
         CLC   ABUYD.RBUYDUR,RBUYD.RBUYDUR                                      
         BNE   CLNKY                                                            
*                                                                               
         CLC   ABUYD.RBUYTSPT,RBUYD.RBUYTSPT                                    
         BNE   CLNKY                                                            
         CLC   ABUYD.RBUYTSPT,=X'0000'                                          
         BE    CLNK0030            TOTAL REP SPOT = TOTAL AGY SPOT = 0          
*                                  THEN ASSUME THEY ARE EQUAL                   
         DROP  ABUYD,RBUYD                                                      
*                                                                               
         GOTOR GRIDDIFF,DMCB,TR.TLGSTD,TR2.TLGSTD,DLSVBLRC                      
         BE    CLNKY               BUY GRID DIFFERS                             
*                                                                               
CLNK0030 DS    0H                                                               
ABUYD    USING RBUYDYEL,R4                                                      
RBUYD    USING RBUYDYEL,R6                                                      
*                                                                               
         L     R6,AIO              AIO=AGENCY BUY                               
         MVI   ELCODE,X'02'                                                     
*                                                                               
         BRAS  RE,GETEL                                                         
         BNE   CLNKY                                                            
         LR    R4,R6                                                            
*                                                                               
         L     R6,DLSVIO           DLSVIO=REP BUY                               
         MVI   ELCODE,X'02'                                                     
*                                                                               
         BRAS  RE,GETEL                                                         
         BNE   CLNKY                                                            
*                                                                               
CLNK0050 DS    0H                                                               
         CLC   ABUYD.RBUYDYIN,RBUYD.RBUYDYIN                                    
         BNE   CLNKY                                                            
*                                                                               
         CLC   ABUYD.RBUYDAYS,RBUYD.RBUYDAYS                                    
         BNE   CLNKY                                                            
*                                                                               
         CLC   ABUYD.RBUYDYT1,RBUYD.RBUYDYT1                                    
         BNE   CLNKY                                                            
*                                                                               
         CLC   ABUYD.RBUYDYT2,RBUYD.RBUYDYT2                                    
         BNE   CLNKY                                                            
*                                                                               
         BRAS  RE,NEXTEL           ANOTHER 02?                                  
         BNE   CLNK0100            NO                                           
         LR    R3,R6               SAVE OFF                                     
*                                                                               
         LR    R6,R4               YES, ANOTHER 02 IN AGY BUY?                  
         BRAS  RE,NEXTEL                                                        
         BNE   CLNKY               NO, THEY ARE NOT THE SAME                    
*                                                                               
         LR    R4,R6               RELOAD CORRECT REGISTERS                     
         LR    R6,R3                                                            
         B     CLNK0050            COMPARE NEXT PAIR OF 02 ELEMENT              
*                                                                               
CLNK0100 DS    0H                                                               
         LR    R6,R4               ANOTHER 02 IN AGY? RECORD?                   
         BRAS  RE,NEXTEL                                                        
         BE    CLNKY               YES, AGY BUY /= REP BUY                      
*                                                                               
         DROP  ABUYD,RBUYD                                                      
*                                                                               
CLNK0150 DS    0H                                                               
*                                                                               
ABUYD    USING RBUYPGEL,R4                                                      
RBUYD    USING RBUYPGEL,R6                                                      
*                                                                               
         L     R6,AIO              AIO=AGENCY BUY                               
         MVI   ELCODE,X'21'                                                     
         BRAS  RE,GETEL                                                         
         BNE   CLNKY                                                            
         LR    R4,R6                                                            
*                                                                               
         L     R6,DLSVIO           DLSVIO=REP BUY                               
         MVI   ELCODE,X'21'                                                     
         BRAS  RE,GETEL                                                         
         BNE   CLNKY                                                            
*                                                                               
         CLC   ABUYD.RBUYPGLN,RBUYD.RBUYPGLN                                    
         BNE   CLNKY                                                            
*                                                                               
         ZIC   RF,ABUYD.RBUYPGLN                                                
         SHI   RF,3                OVERHEAD                                     
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   ABUYD.RBUYPGM(0),RBUYD.RBUYPGM                                   
         BNE   CLNKY                                                            
         DROP  ABUYD,RBUYD                                                      
*                                                                               
         L     R4,AIO                                                           
         L     R6,DLSVIO                                                        
*                                                                               
ABUYD    USING RBUYREC,R4                                                       
RBUYD    USING RBUYREC,R6                                                       
*                                                                               
         L     RF,AEOTBLE          A(END OF TABLE)                              
         USING MTCHTABD,RF                                                      
         MVC   ABUY#,ABUYD.RBUYKMLN                                             
         MVC   RBUY#,RBUYD.RBUYKLIN                                             
*                                                                               
         LA    RF,MTCHTABL(RF)                                                  
         MVC   ABUY#(L'GRPTERM2),GRPTERM2                                       
         LA    RF,MTCHTABL(RF)                                                  
         ST    RF,AEOTBLE          UPDATE A(END OF TABLE)                       
*                                                                               
         MVC   KEY,DLSVKEY                                                      
         MVC   AIO,DLSVIO                                                       
         NI    DMINBTS,X'FF'-X'08' DON'T PASS DELETES                           
         GOTO1 HIGH                                                             
         CLC   KEYSAVE(27),KEY                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         B     CLNKN                                                            
         DROP  RF                                                               
*                                                                               
CLNK0200 DS    0H                                                               
         TM    RBUYFLG2,X'80'      DAILY?                                       
         BO    EXITOK                                                           
*                                                                               
         LA    RE,MTCHTAB                                                       
         L     RF,AEOTBLE                                                       
         USING MTCHTABD,RE                                                      
*                                                                               
CLNK0250 DS    0H                                                               
         CR    RE,RF                                                            
         BNL   EXITOK                                                           
         CLC   ABUY#,RBUYAGBL      SKIP THIS AGENCY BUY                         
         BE    EXITL               IF IT ALREADY MATCH TOTALLY                  
         LA    RE,MTCHTABL(RE)     TO ITS LINKED REP BUY                        
         B     CLNK0250                                                         
         DROP  RE                                                               
*                                                                               
CLNKY    DS    0H                                                               
         MVC   KEY,DLSVKEY                                                      
         MVC   AIO,DLSVIO                                                       
         GOTO1 HIGH                                                             
         SR    RC,RC                                                            
CLNKN    LTR   RC,RC                                                            
CLNKX    DS    0H                                                               
         B     EXIT                                                             
*                                                                               
         DROP  TR2                                                              
         DROP  R4                                                               
         DROP  R2                                                               
***********************************************************************         
* LOOP THROUGH ALL X'0B01'/X'0B' RECORDS. FOR EACH RECORD, LOOP THROUGH         
* X'03' EFFECTIVE DATE ELEMENTS AND BUILD BUY SEGMENTS BASE ON SINGLE           
* WEEK-OF DATE.                                                                 
***********************************************************************         
BLDSEGS  NTR1  BASE=*,LABEL=*                                                   
         L     R4,AIO                                                           
BUYD     USING RBUYREC,R4                                                       
         MVC   SAVEKEY,KEY                                                      
         MVI   BUYGRID2,X'FF'                                                   
         MVC   BUYGRID2+1(L'BUYGRID2-1),BUYGRID2                                
*                                                                               
BLDSEG04 DS    0H                                                               
         NI    MISCFLG4,FF-MF4MKG                                               
         CLC   =X'0B01',BUYD.RBUYKEY                                            
         BE    BSEG006                                                          
*                                                                               
         CLC   BUYD.RBUYKLIN,BUYD.RBUYKMLN   MASTERLINE = BUYLINE?              
         BNE   BSEG018             NO, MAKEGOOD                                 
*                                                                               
         TM    BUYD.RBUYRTS,X'20'+X'08'+X'04' BONUS/LATE RUN/LR W/BONUS         
         BNZ   BSEG018             YES, MAKEGOOD                                
         B     BSEG020             NO, THIS IS A REP MAKEGOOD                   
*                                                                               
BSEG006  DS    0H                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   BSEG016                                                          
         TM    RBUYXXFG-RBUYXXEL(R6),X'20'                                      
         BO    BSEG018             AGENCY MAKEGOOD FLAG IS NOT SET              
*                                                                               
BSEG016  DS    0H                                                               
         L     R6,AIO                                                           
         USING RBUYREC,R6                                                       
         OC    RBUYCOS,RBUYCOS     ZERO DOLLARS - ASSUME BONUS MG               
         BNZ   BSEG020                                                          
         DC    X'0770'                                                          
*                                                                               
BSEG018  DS    0H                                                               
         OI    MISCFLG4,MF4MKG                                                  
*                                                                               
BSEG020  DS    0H                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'03'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING RBUYDTEL,R6                                                      
*                                                                               
         XC    TSARREC,TSARREC                                                  
         XC    TSARREC2,TSARREC2                                                
SEG      USING TLSTD,TSARREC2                                                   
*                                                                               
* IF DAILY, STICK IN AN EXTRA MASTER LINK TO GROUP THESE COMPONENTS             
* TOGETHER                                                                      
*                                                                               
         NI    MISCFLG4,FF-MF4NOAGY                                             
         GOTOR ISDAILY,DMCB,(R4)                                                
         BE    BSEG030                                                          
*                                                                               
         TM    DMCB,X'20'          IS AGENCY LINE CANCELLED?                    
         BZ    *+8                                                              
         OI    MISCFLG4,MF4NOAGY   YES, SET FLAG                                
*                                                                               
         TM    DMCB,X'40'          SINGLE DAILY TREATED AS NON-DAILY?           
         BZ    BSEG040                                                          
         MVC   SEG.TLBYASUB,BUYD.RBUYKLIN   YES, MOVE SUB LINE                  
         B     BSEG040                                                          
*                                                                               
BSEG030  MVC   SEG.TLBYMLNK,BUYD.RBUYAGBL                                       
         TM    DMCB,X'10'                                                       
         BZ    *+8                                                              
         OI    SEG.TLBYFLG4,X'01'                                               
*                                                                               
         CLC   =X'0B01',BUYD.RBUYKEY                                            
         BNE   BSEG038                                                          
*                                                                               
         MVC   SEG.TLBYMLNK,BUYD.RBUYKMLN                                       
         MVC   SEG.TLBYASUB,BUYD.RBUYKLIN                                       
*                                                                               
BSEG038  DS    0H                                                               
         MVC   SEG.TLBYMLKT,SEG.TLBYMLNK                                        
*        MVC   SEG.TLBYSUB1,BUYD.RBUYKLIN   DISABLE BECAUSE SORTING BUG         
*                                                                               
BSEG040  DS    0H                                                               
         MVC   COMPTSAR,TSARREC2                                                
SVSEG    USING TLSTD,COMPTSAR                                                   
*                                                                               
         MVC   SEG.TLLEN,=Y(TLBYLQ)                                             
         MVI   SEG.TLKTYP,X'0B'    TYPE BUY SEGMENT                             
         MVI   SEG.TLBYFLG,TLUMTHQ DEFAULT TO UNMATCH                           
*                                                                               
* FIND DAY(S) ATTRIBUTE RECORD INDEX                                            
*                                                                               
         GOTOX (X'01',=A(BLDDTP)),RR=RELO                                       
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                MUST BE FOUND                                
*                                                                               
         MVC   SEG.TLBYDAY,TB.TSRNUM RECORD NUMBER IS THE INDEX                 
*        MVC   SEG.TLBYSID1,TR.TLDYSTEN  DAY                                    
*                                                                               
* FIND TIME(S) ATTRIBUTE RECORD INDEX                                           
*                                                                               
         XC    TSARREC,TSARREC                                                  
         GOTOX (X'02',=A(BLDDTP)),RR=RELO                                       
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                MUST BE FOUND                                
*                                                                               
         MVC   SEG.TLBYTIME,TB.TSRNUM  RECORD NUMBER IS THE INDEX               
*                                                                               
* FIND PROGRAM NAME ATTRIBUTE RECORD INDEX                                      
*                                                                               
         XC    TSARREC,TSARREC                                                  
         GOTOX (X'03',=A(BLDDTP)),RR=RELO                                       
         GOTO1 GOTSAR,TSARDH                                                    
         BNE   *+10                PROGRAM NAME IS OPTIONAL FOR NOW             
*        BE    *+6                                                              
*        DC    H'0'                THAT HAS CHANGED                             
         MVC   SEG.TLBYPROG,TB.TSRNUM  RECORD NUMBER IS THE INDEX               
*                                                                               
         MVC   SEG.TLBYLEN,BUYD.RBUYDUR                                         
         MVC   SEG.TLBYRATE,BUYD.RBUYCOS                                        
*                                                                               
BLDSEG05 DS    0H                                                               
         GOTO1 DATCON,DMCB,(3,RBUYDTST),(0,WORK)                                
*                                                                               
BLDSEG10 DS    0H                                                               
         GOTO1 DATCON,DMCB,(0,WORK),(2,SEG.TLBYWKOF)                            
*                                                                               
* CLEAR FLAGS AND POINTER TO LIST OF BUY LINKS                                  
*                                                                               
         MVI   SEG.TLBYRFLG,0                                                   
         MVI   SEG.TLBYAFLG,0                                                   
         XC    SEG.TLBYRLNK,SEG.TLBYRLNK                                        
         XC    SEG.TLBYALNK,SEG.TLBYALNK                                        
*                                                                               
         CLC   =X'0B01',BUYD.RBUYKEY                                            
         BE    BLDSEG20                                                         
*                                                                               
* RECORD IS A REPPAK BUY                                                        
*                                                                               
         TM    BUYD.RBUYDUR,X'80'       MINUTES?                                
         BZ    *+8                                                              
         OI    SEG.TLBYRFLG,X'80'  SET LENGTH IN MINUTES                        
         B     BLDSEG30                                                         
*                                                                               
* RECORD IS AN AGENCY CONVERTED BUY                                             
*                                                                               
BLDSEG20 DS    0H                                                               
         TM    BUYD.RBUYDUR,X'80'       MINUTES?                                
         BZ    *+8                                                              
         OI    SEG.TLBYAFLG,X'80'  SET LENGTH IN MINUTES                        
*                                                                               
BLDSEG30 DS    0H                                                               
         MVI   SEG.TLBYMKG,C'N'                                                 
         TM    MISCFLG4,MF4MKG                                                  
         BZ    *+8                                                              
         MVI   SEG.TLBYMKG,C'Y'                                                 
*                                                                               
         MVC   TSARREC,TSARREC2                                                 
         GOTO1 GOTSAR,TSARDH                                                    
         BE    BLDSEG50            DUPLICATE TSAR RECORD!!!                     
*&&TT                                                                           
         CLC   =X'0B01',BUYD.RBUYKEY                                            
         BNE   TEST101                                                          
         CLI   BUYD.RBUYKLIN,2                                                  
         BNE   *+6                                                              
         DC    X'0770'                                                          
TEST101  DS    0H                                                               
*&&                                                                             
*                                                                               
****>>   TM    TB.TSERRS,TSEDUP                                                 
****>>   BO    BLDSEG50                                                         
*                                                                               
* NEW BUY SEGMENT RECORD, NEED TO SPECIFY BUY NUMBER WHERE THIS SEGMENT         
* CAME FROM                                                                     
*                                                                               
         CLC   =X'0B01',BUYD.RBUYKEY                                            
         BE    BLDSEG40                                                         
*                                                                               
         MVC   SEG.TLBYRLNK(1),BUYD.RBUYKLIN                                    
         MVC   SEG.TLBYRSPT,BUYD.RBUYTSPT                                       
         TM    MISCFLG4,MF4MKG                                                  
         BZ    *+8                                                              
         OI    SEG.TLBYRFG2,X'80'                                               
*                                                                               
         OC    BUYD.RBUYAGBL,BUYD.RBUYAGBL                                      
         BZ    BLDSEG45            NOT LINK TO ANYTHING                         
         TM    MISCFLG4,MF4NOAGY                                                
         BO    BLDSEG45            OR LINE LINK TO IS CANCELLED                 
*                                                                               
BLDSEG35 DS    0H                                                               
         MVI   SEG.TLBYFLG2,TLLNKQ   UNMATCHED, BUT LINKED                      
         MVC   SEG.TLBYLNKT,BUYD.RBUYAGBL  AGYENCY LINK NUMBER                  
*                                                                               
         GOTOR BLDLNK                                                           
         B     BLDSEG45                                                         
*                                                                               
BLDSEG40 DS    0H                                                               
         MVC   SEG.TLBYALNK(1),BUYD.RBUYAGBL                                    
         MVC   SEG.TLBYASPT,BUYD.RBUYTSPT                                       
         TM    MISCFLG4,MF4MKG                                                  
         BZ    *+8                                                              
         OI    SEG.TLBYAFG2,X'80'                                               
*                                                                               
BLDSEG45 DS    0H                                                               
         MVC   TSARREC,TSARREC2                                                 
         GOTO1 GOTSAR,TSAADD                                                    
         TM    TB.TSERRS,TSEDUP                                                 
         BZ    BLDSEG80                                                         
         DC    H'0'                                                             
*                                                                               
BLDSEG50 DS    0H                                                               
*                                                                               
         CLC   =X'0B01',BUYD.RBUYKEY                                            
         BNE   TEST10                                                           
         CLI   BUYD.RBUYKLIN,X'13'                                              
         BNE   *+6                                                              
         DC    X'0770'                                                          
TEST10   DS    0H                                                               
*                                                                               
         GOTO1 GOTSAR,TSAGET       RECORD EXISTS, GET IT                        
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
* BUY SEGMENT RECORD EXISTS. SPECIFY REP OR AGENCY BUY#/#SPT IF NOT             
* ALREADY. OTHERWISE, WE WILL NEED TO ADD OR CREATE BUY LINK RECORD             
* SINCE TWO OR MORE BUYS REFER TO THIS SEGMENT                                  
*                                                                               
         CLC   =X'0B00',BUYD.RBUYKEY                                            
         BE    BLDSEG52            EXIT IF REP LINE                             
*                                                                               
         GOTOR CHKMATCH                                                         
         BE    BLDSEGX                                                          
*                                                                               
BLDSEG52 MVC   GNXSVREC,TSARREC2                                                
         MVC   TSARREC2,TSARREC                                                 
         CLC   =X'0B01',BUYD.RBUYKEY  REP OR AGENCY SEGMENT?                    
         BE    BLDSEG60                                                         
*                                                                               
         CLI   BUYD.RBUYAGBL,0     IS THIS BUY LINK TO AGY BUY?                 
         BE    BLDSEG55            NO                                           
         TM    MISCFLG4,MF4NOAGY   IS THE AGY LINK BROKEN?                      
         BO    BLDSEG55            YES                                          
*                                                                               
         OC    SEG.TLBYALNK,SEG.TLBYALNK                                        
         BNZ   BLDSEG55            THIS SEGMENT HAS AGENCY BUY?                 
*                                  YES, THEN THIS IS A MATCH SEGMENT            
                                                                                
         CLI   SEG.TLBYFLG2,TLLNKQ ELSE, IF THIS IS A LINK SEGMENT              
         BE    BLDSEG55            THEN BUILD BUY LINK RECORD                   
*                                                                               
*        MVI   SEG.TLBYFLG,TLLNKQ  NO, THEN ADD AS A LINK SEGMENT               
         MVI   SEG.TLBYFLG2,TLLNKQ                                              
         MVC   SEG.TLBYLNK,BUYD.RBUYAGBL                                        
         XC    SEG.TLBYRFLG(TLBYALLQ),SEG.TLBYRFLG                              
         B     BLDSEG30                                                         
*                                                                               
BLDSEG55 DS    0H                                                               
         OC    SEG.TLBYRLNK,SEG.TLBYRLNK                                        
         BNZ   BLDSEG70                                                         
         MVC   SEG.TLBYRLNK(1),BUYD.RBUYKLIN                                    
         MVC   SEG.TLBYRSPT,BUYD.RBUYTSPT                                       
         B     BLDSEG65                                                         
*                                                                               
BLDSEG60 DS    0H                                                               
         OC    SEG.TLBYALNK,SEG.TLBYALNK                                        
         BNZ   BLDSEG70                                                         
         MVC   SEG.TLBYALNK(1),BUYD.RBUYAGBL                                    
         MVC   SEG.TLBYASPT,BUYD.RBUYTSPT                                       
         MVC   SEG.TLBYASUB,SVSEG.TLBYASUB                                      
*                                                                               
BLDSEG65 DS    0H                                                               
         MVC   TSARREC,TSARREC2                                                 
         GOTO1 GOTSAR,TSAWRT                                                    
         TM    TB.TSERRS,TSERNF                                                 
         BZ    BLDSEG80                                                         
         DC    H'0'                                                             
*                                                                               
BLDSEG70 DS    0H                                                               
         GOTOR BLDBLINK                                                         
         B     BLDSEGX             ONE BUY PER ENTRY                            
*                                                                               
BLDSEG80 DS    0H                                                               
         GOTOR MRKSEG                                                           
         DROP  R6                                                               
*                                                                               
BLDSEGX  DS    0H                                                               
*                                                                               
         B     EXIT                                                             
         DROP  SEG,BUYD,SVSEG                                                   
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* BUILD SEGMENT BASE ON A REP BUY RECORD                                        
* P1 = A(SEGMENT)                                                               
***********************************************************************         
BLDSEG1  NTR1  BASE=*,WORK=(R2,DLWORKQ),LABEL=*                                 
         XC    TSARREC,TSARREC                                                  
*                                                                               
         L     R4,0(R1)                                                         
SEG      USING TLBYDAY,R4                                                       
*                                                                               
         L     R6,AIO                                                           
BUYD     USING RBUYREC,R6                                                       
*                                                                               
* FIND DAY(S) ATTRIBUTE RECORD INDEX                                            
*                                                                               
         GOTOX (X'01',=A(BLDDTP)),RR=RELO                                       
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                MUST BE FOUND                                
*                                                                               
         MVC   SEG.TLBYDAY,TB.TSRNUM RECORD NUMBER IS THE INDEX                 
*                                                                               
* FIND TIME(S) ATTRIBUTE RECORD INDEX                                           
*                                                                               
         XC    TSARREC,TSARREC                                                  
         GOTOX (X'02',=A(BLDDTP)),RR=RELO                                       
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                MUST BE FOUND                                
*                                                                               
         MVC   SEG.TLBYTIME,TB.TSRNUM  RECORD NUMBER IS THE INDEX               
*                                                                               
* FIND PROGRAM NAME ATTRIBUTE RECORD INDEX                                      
*                                                                               
         XC    TSARREC,TSARREC                                                  
         GOTOX (X'03',=A(BLDDTP)),RR=RELO                                       
         GOTO1 GOTSAR,TSARDH                                                    
         BNE   *+10                PROGRAM NAME IS OPTIONAL FOR NOW             
         MVC   SEG.TLBYPROG,TB.TSRNUM  RECORD NUMBER IS THE INDEX               
*                                                                               
         MVC   SEG.TLBYLEN,BUYD.RBUYDUR                                         
         MVC   SEG.TLBYRATE,BUYD.RBUYCOS                                        
*                                                                               
         MVI   SEG.TLBYMKG,C'N'    MAKEGOOD                                     
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   BSEGX                                                            
         TM    RBUYXXFG-RBUYXXEL(R6),X'20'                                      
         BZ    BSEGX                                                            
         MVI   SEG.TLBYMKG,C'Y'    MAKEGOOD                                     
*                                                                               
BSEGX    DS    0H                                                               
*                                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* LOOP THROUGH BUY SEGMENTS TO BREAK MULTIPLE MATCH MAKEGOOD                    
* THIS IS DONE SO THAT USER GETS A CHANCE TO MANUALLY MATCH                     
* THE MAKEGOODS BY THEMSELVES                                                   
* R8 IS USED IN THIS ROUTINE, SO NO PRINTING HERE!!!                            
***********************************************************************         
BRKMKG   NTR1  BASE=*,WORK=(R4,DLWORKQ),LABEL=*                                 
         USING DLWORKD,R4                                                       
         ST    R8,DLSVIO           SAVE R8                                      
         XC    TSARREC,TSARREC                                                  
         XC    TSARREC2,TSARREC2                                                
         MVI   TR.TLKTYP,X'0B'                                                  
         GOTO1 GOTSAR,TSARDH                                                    
         BL    BMKGX                                                            
*                                                                               
BMKG0030 DS    0H                                                               
*&&TT                                                                           
         CLC   TR.TLBYDAY(6),=X'00010004003C'                                   
         BNE   *+6                                                              
         DC    X'0770'                                                          
*&&                                                                             
         MVC   DLTSRNUM,TB.TSRNUM                                               
         MVC   DLWORK,TSARREC                                                   
*                                                                               
BUYSEG   USING TLSTD,DLWORK                                                     
         CLI   BUYSEG.TLBYMKG,C'Y'                                              
         BNE   BMKG0500            NOT MAKEGOOD - NEXT SEGMENT                  
*                                                                               
         TM    BUYSEG.TLBYFLG3,X'80'                                            
         BO    BMKG0500            TOTALLY MATCH- NEXT SEGMENT                  
*                                                                               
         OC    BUYSEG.TLBYRLNK,BUYSEG.TLBYRLNK                                  
         BZ    BMKG0150            NO REP LINES                                 
*                                                                               
         OC    BUYSEG.TLBYALNK,BUYSEG.TLBYALNK                                  
         BZ    BMKG0200            NO AGENCY LINES                              
*                                                                               
         TM    BUYSEG.TLBYAFLG,X'40'                                            
         BO    BREAK               AGY IS A COMBO - BREAK                       
*                                                                               
         TM    BUYSEG.TLBYRFLG,X'40'                                            
         BO    BREAK               REP IS A COMBO - BREAK                       
*                                                                               
         B     BMKG0500            OR ONE TO ONE MATCH - SKIP                   
*                                                                               
BMKG0150 DS    0H                  NO REP LINES                                 
         TM    BUYSEG.TLBYAFLG,X'40'                                            
         BZ    BMKG0500            AGY IS A SINGLE LINE - SKIP                  
         B     BREAK                                                            
*                                                                               
BMKG0200 DS    0H                  NO AGY LINES                                 
         TM    BUYSEG.TLBYRFLG,X'40'                                            
         BZ    BMKG0500            REP IS A SINGLE LINE -SKIP                   
         B     BREAK                                                            
*                                                                               
BREAK    DS    0H                  BREAK MAKEGOODS INTO SINGLE                  
         GOTO1 GOTSAR,TSADEL       UNMATCH LINES                                
         BE    *+6                 DELETE EXISTING TSAR RECORD                  
         DC    H'0'                                                             
*                                                                               
NEWBUY   USING TLSTD,TSARREC2                                                   
*                                                                               
         LA    R6,BUYSEG.TLBYALNK                                               
         LR    R3,R6                                                            
         LA    R8,BUYSEG.TLBYAFLG                                               
         LA    R2,NEWBUY.TLBYALNK                                               
         MVI   DLBYTE,C'A'         PROCESS AGENCY BUY FIRST                     
*                                                                               
BMKG0250 DS    0H                                                               
         OC    0(L'TLBYALNK,R6),0(R6)                                           
         BZ    BMKGREP             NO LINE INFO - SKIP                          
*                                                                               
         XC    TSARREC2,TSARREC2   CLEAR AREA FOR NEW BUY                       
         TM    0(R8),X'40'         SINGLE LINE OR MULTI LINE?                   
         BZ    BMKG0300            SINGLE                                       
*                                                                               
         XC    TSARREC,TSARREC     MULTI - READ BUY LINK RECORD                 
         MVC   TR.TLBLINDX,0(R6)                                                
         MVC   TR.TLKTYP,DLBYTE    A/R                                          
         GOTO1 GOTSAR,TSARDH       READ BUYLINK RECORD                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
BUYLNK   USING TLSTD,DLWORK2                                                    
*                                                                               
         MVC   DLWORK2,TSARREC                                                  
         LA    R3,BUYLNK.TLBLBUY#                                               
*                                                                               
BMKG0300 DS    0H                                                               
         MVC   NEWBUY.TLREC(L'TLKEY+2),BUYSEG.TLREC                             
         MVC   NEWBUY.TLBYMIDT,DLBYTE A/R                                       
         MVC   NEWBUY.TLBYMID,0(R3)   LINE #                                    
         MVC   0(TLBYRLNQ,R2),0(R3)   LINE DETAILS                              
         MVC   TSARREC,TSARREC2                                                 
         GOTO1 GOTSAR,TSAADD                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         TM    TB.TSERRS,TSEDUP                                                 
         BZ    BMKG0400                                                         
*                                                                               
         MVC   TSARREC,TSARREC2    ADD AGAIN WITH UNIQUE IDENTIFIER             
         MVC   TR.TLBYUID,TLBLSUB#-TLBLBUY#(R3)                                 
         GOTO1 GOTSAR,TSAADD                                                    
         CLI   TB.TSERRS,0                                                      
         BE    BMKG0400                                                         
         DC    H'0'                                                             
*                                                                               
BMKG0400 TM    0(R8),X'40'         BUY LINK?                                    
         BZ    BMKGREP             NO,PROCESS REP LINES                         
         LA    R3,TLBLLENQ(R3)     NEXT BUY                                     
         CLI   0(R3),0             END OF THIS BUY LINK?                        
         BNE   BMKG0300            NO, NEXT BUY                                 
*                                                                               
BMKGREP  DS    0H                                                               
         CLI   DLBYTE,C'R'         PROCESS REP LINES                            
         BE    BMKGDONE                                                         
*                                                                               
         MVI   DLBYTE,C'R'         POINT TO REP AREA                            
         LA    R6,BUYSEG.TLBYRLNK                                               
         LR    R3,R6                                                            
         LA    R8,BUYSEG.TLBYRFLG                                               
         LA    R2,NEWBUY.TLBYRLNK                                               
         B     BMKG0250            LOOP BACK AND PROCESS REP                    
*                                                                               
BMKGDONE DS    0H                  DONE BREAKING UP THIS BUY SEGMENT            
*                                  LEAVE THE BUYLINK AS IT IS                   
BMKG0500 DS    0H                                                               
         CLC   DLTSRNUM,TB.TSRNUM                                               
         BE    BMKG0630                                                         
*                                                                               
         MVC   TXNUM,DLTSRNUM                                                   
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
*        CLC   TSARREC,DLWORK                                                   
*        BNE   BMKG0650                                                         
BMKG0630 DS    0H                                                               
*        CLI   TR.TLBYMLNK,7       SAME GROUP AS THE PREVIOUS SEGMENT?          
*        BNE   *+6                 YES, SKIP                                    
*        DC    X'0770'                                                          
         MVC   DLWORK,TSARREC                                                   
         GOTO1 GOTSAR,TSANXT                                                    
         BL    BMKG0700                                                         
BMKG0650 DS    0H                                                               
         CLI   TR.TLKTYP,X'0B'                                                  
         BE    BMKG0030                                                         
*                                                                               
BMKG0700 DS    0H                                                               
*                                                                               
BMKGX    DS    0H                                                               
         ICM   R8,15,DLSVIO        RESTORE R8                                   
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
         DROP  R4                                                               
***********************************************************************         
* BUILD AGENCY LINK RECORD                                                      
***********************************************************************         
BLDLNK   NTR1  BASE=*,WORK=(R2,ELWORKQ),LABEL=*                                 
*                                                                               
         USING ELWORKD,R2                                                       
         MVC   ELWORK,TSARREC                                                   
         MVC   ELWORK2,TSARREC2                                                 
         XC    TSARREC,TSARREC                                                  
         XC    TSARREC2,TSARREC2                                                
*                                                                               
         L     R4,AIO                                                           
BUYD     USING RBUYREC,R4                                                       
BLNK0050 DS    0H                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'03'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING RBUYDTEL,R6                                                      
*                                                                               
SEG      USING TLSTD,TSARREC2                                                   
         MVC   SEG.TLLEN,=Y(TLXYLQ)                                             
         MVI   SEG.TLKTYP,TLXTYPQ  TYPE BUY SEGMENT                             
         MVC   SEG.TLXYBY#,BUYD.RBUYAGBL                                        
*                                                                               
         MVC   ELSVIO,AIO                                                       
         MVC   ELSVKEY,KEY                                                      
         LA    RE,ELIO3                                                         
         ST    RE,AIO                                                           
         XC    KEY,KEY                                                          
         MVC   KEY(RBUYKMLN-RBUYKEY),BUYD.RBUYKEY                               
*                                                                               
K        USING RBUYKEY,KEY                                                      
         MVI   KEY+1,X'01'                                                      
         MVC   K.RBUYKMLN,BUYD.RBUYAGBL                                         
         DROP  K                                                                
*                                                                               
         GOTO1 HIGH                                                             
         CLC   KEYSAVE(26),KEY                                                  
         BNE   BLNKNO              AGY LINE IS CANCELLED                        
*        DC    H'0'                                                             
*                                                                               
         GOTO1 GETREC                                                           
*                                                                               
         GOTOR BLDSEG1,DMCB,ELWORK3                                             
         MVC   SEG.TLXYDAY(TLXKEYQ),ELWORK3                                     
         MVC   TSARREC,TSARREC2                                                 
         GOTO1 GOTSAR,TSAADD                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*TESTING                                                                        
*&&TT                                                                           
         CLI   BUYD.RBUYAGBL,X'FF'                                              
         BNE   *+6                                                              
         DC    X'0770'                                                          
*&&                                                                             
*TESTING                                                                        
*                                                                               
BLNKYES  DS    0H                                                               
         MVI   ELBYTE,0                                                         
         B     BLNKX                                                            
BLNKNO   DS    0H                                                               
         OI    ELBYTE,X'80'                                                     
BLNKX    DS    0H                                                               
         MVC   TSARREC,ELWORK                                                   
         MVC   TSARREC2,ELWORK2                                                 
         MVC   AIO,ELSVIO                                                       
         MVC   KEY,ELSVKEY                                                      
         GOTO1 HIGH                                                             
         TM    ELBYTE,X'80'                                                     
*                                                                               
         B     EXIT                                                             
         DROP  SEG,BUYD,R2                                                      
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* CHECK MATCHING LINE, IF LINES MATCH TOTALLY, THEN GIVE IT A DIFFERENT         
* RECORD TYPE                                                                   
* ONLY DO THIS FOR AGENCY LINE, SINCE WE BUILD REP SEGMENT FIRST                
* ASSUME R4->RBUYREC                                                            
* TSARREC CONTAINS BUY SEGMENT                                                  
* TSARREC2 CONTAINS THE AGENCY SEGMENT                                          
***********************************************************************         
         USING DLWORKD,R3                                                       
BUYD     USING RBUYREC,R4                                                       
BUYSEG   USING TLSTD,DLWORK                                                     
BUYLNK   USING TLSTD,DLWORK2                                                    
SEG      USING TLSTD,TSARREC2                                                   
*                                                                               
CHKMATCH NTR1  BASE=*,WORK=(R3,DLWORKQ),LABEL=*                                 
         MVC   DLWORK,TSARREC      SAVE OFF TSARREC                             
         MVC   DLHALF,TB.TSRNUM                                                 
         OC    BUYSEG.TLBYRLNK,BUYSEG.TLBYRLNK                                  
         BZ    CHKMNO              REP LINES IN THIS BUY SEGMENT?               
*                                                                               
         LA    R2,BUYSEG.TLBYRLNK                                               
         TM    BUYSEG.TLBYRFLG,X'40'  BUY LINK?                                 
         BZ    CHKM0300                                                         
         XC    TSARREC,TSARREC                                                  
         MVC   TR.TLBLINDX,BUYSEG.TLBYRLNK                                      
         MVI   TR.TLKTYP,C'R'                                                   
         GOTO1 GOTSAR,TSARDH       YES,READ BUYLINK RECORD                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   DLWORK2,TSARREC                                                  
         LA    R2,BUYLNK.TLBLBUY#                                               
*                                                                               
CHKM0300 DS    0H                                                               
         OC    0(L'TLBLBUY#,R2),0(R2)                                           
         BZ    CHKMNO              NO MORE LINES TO READ                        
                                                                                
         XC    TSARREC,TSARREC                                                  
*                                                                               
         MVI   TR.TLKTYP,X'04'                                                  
         MVI   TR.TLGTYP,C'R'                                                   
         MVC   TR.TLGLN#,0(R2)                                                  
         GOTO1 GOTSAR,TSARDH                                                    
         BNE   CHKMNO                                                           
*        DC    H'0'                                                             
*                                                                               
         MVC   DLWORK3,TSARREC                                                  
REPGRD   USING TLSTD,DLWORK3                                                    
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,X'04'                                                  
         MVI   TR.TLGTYP,C'A'                                                   
         MVC   TR.TLGLN#,BUYD.RBUYKMLN  SHADOW RECORD                           
*                                                                               
         TM    SEG.TLBYFLG4,X'01'  DAILY?                                       
         BZ    *+10                                                             
         MVC   TR.TLGSUB#,BUYD.RBUYKLIN                                         
*                                                                               
         GOTO1 GOTSAR,TSARDH                                                    
         BNE   CHKMNO                                                           
*                                                                               
         GOTOR GRIDDIFF,DMCB,TR.TLGSTD,REPGRD.TLGSTD,DLWORK4                    
         BNE   CHKM0500            SAME                                         
*                                                                               
         TM    BUYSEG.TLBYRFLG,X'40' NOT A BUY LINK                             
         BZ    CHKMNO              EXIT                                         
         LA    R2,TLBLLENQ(R2)     BUY LINK, READ NEXT LINE                     
         B     CHKM0300                                                         
*                                                                               
CHKM0500 DS    0H                                                               
         TM    BUYSEG.TLBYRFLG,X'40'                                            
         BZ    CHKM0550            REP POINTS TO A BUY LINK RECORD              
*                                                                               
         MVC   TSARREC,DLWORK      NOW REMOVE THE REFERENCE IN BUYLINK          
         GOTOR KILLME,DMCB,(C'R',(R2))                                          
*&&TT                                                                           
         CLI   BUYD.RBUYKMLN,55                                                 
         BNE   *+6                                                              
         DC    X'0770'                                                          
*&&                                                                             
*                                                                               
         B     CHKM0800            ADD TOTALLY MATCH LINE                       
*                                                                               
CHKM0550 DS    0H                  REP IS A SINGLE BUY LINE                     
         OC    BUYSEG.TLBYALNK,BUYSEG.TLBYALNK                                  
         BNZ   CHKM0700            AGENCY IS A SINGLE LINE AS WELL              
*                                                                               
         MVC   TSARREC,DLWORK                                                   
         XC    TXNUM,TXNUM         DELETE ORIGINAL UNMATCH SEGMENT              
         GOTO1 GOTSAR,TSADEL                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         B     CHKM0800            ADD TOTALLY MATCH LINE                       
*                                                                               
CHKM0700 DS    0H                  REP IS A SINGLE BUY LINE                     
*                                  AGY IS NOT                                   
         MVC   TSARREC,DLWORK                                                   
         XC    TR.TLBYRLNK(TLBYRLNQ),TR.TLBYRLNK                                
         MVI   TR.TLBYFLG2,TLUMTHQ MARK AS UNMATCHED                            
         GOTO1 GOTSAR,TSAWRT       DELETE REP LINES IN OLD SEGMENT              
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
CHKM0800 DS    0H                  REP IS A SINGLE BUY LINE                     
         MVC   TSARREC,DLWORK                                                   
         MVI   TR.TLBYFLG,TLMTHQ3                                               
         MVI   TR.TLBYFLG2,TLMTHQ3                                              
*                                                                               
         XC    TR.TLBYRFLG(TLBYALLQ),TR.TLBYRFLG                                
         MVC   TR.TLBYALNK,BUYD.RBUYAGBL                                        
*                                                                               
         TM    SEG.TLBYFLG4,X'01'  DAILY?                                       
         BZ    *+10                                                             
         MVC   TR.TLBYASUB,BUYD.RBUYKLIN                                        
*                                                                               
         MVC   TR.TLBYASPT,BUYD.RBUYTSPT                                        
         MVC   TR.TLBYRLNK(1),0(R2)                                             
         MVC   TR.TLBYRSPT,BUYD.RBUYTSPT                                        
         OI    TR.TLBYFLG3,X'80'                                                
*                                                                               
         MVC   DLWORK2,TSARREC                                                  
         GOTO1 GOTSAR,TSAADD                                                    
         TM    TB.TSERRS,TSEEOF                                                 
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         TM    TB.TSERRS,TSEDUP    DUPLICATE RECORD?                            
         BZ    CHKM0850                                                         
         MVC   TSARREC,DLWORK2     ADD AGAIN WITH DIFFERENCIATOR                
         MVC   TR.TLBYLNK,TR.TLBYRLNK                                           
*                                                                               
         GOTO1 GOTSAR,TSAADD                                                    
         TM    TB.TSERRS,TSEEOF+TSEDUP                                          
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
CHKM0850 DS    0H                                                               
         TM    SEG.TLBYFLG4,X'01'  DAILY?                                       
         BO    CHKMYES                                                          
*&&TT                                                                           
         CLI   TR.TLBYALNK,28                                                   
         BNE   *+6                                                              
         DC    X'0770'                                                          
*&&                                                                             
         L     RF,AEOTBLE          A(END OF TABLE)                              
         USING MTCHTABD,RF                                                      
         MVC   ABUY#,TR.TLBYALNK                                                
         MVC   RBUY#,TR.TLBYRLNK                                                
*                                                                               
         LA    RF,MTCHTABL(RF)                                                  
         MVC   ABUY#(L'GRPTERM2),GRPTERM2                                       
         LA    RF,MTCHTABL(RF)                                                  
         ST    RF,AEOTBLE          UPDATE A(END OF TABLE)                       
         DROP  RF                                                               
*                                                                               
CHKMYES  SR    RC,RC                                                            
CHKMNO   LTR   RC,RC                                                            
CHKMX    DS    0H                                                               
         MVC   TSARREC,DLWORK                                                   
         MVC   TB.TSRNUM,DLHALF                                                 
         B     EXIT                                                             
         DROP  BUYSEG,BUYD                                                      
         DROP  R3                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* CREATE NEW BUY LINK RECORD IF IT DOES NOT EXIST, ELSE APPEND EXISTING         
* BUY LINK RECORD WITH CURRENT BUY NUMBER AND NUMBER OF SPOTS                   
*                                                                               
* R6 IS POINTING TO CURRENT BUY EFFECTIVE ELEMENT                               
*                                                                               
***********************************************************************         
BLDBLINK NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   TSARREC2,TSARREC                                                 
*                                                                               
         L     R4,AIO                                                           
BUYD     USING RBUYREC,R4                                                       
         USING RBUYDTEL,R6                                                      
*                                                                               
         MVC   SVTSAR#,TB.TSRNUM   SAVE OFF BUY SEGMENT REC NUMBER              
*                                                                               
TKEY     USING TLKEY,TSARKEY                                                    
         XC    TSARKEY,TSARKEY                                                  
*                                                                               
         CLC   =X'0B00',BUYD.RBUYKEY                                            
         BE    BLDBL05                                                          
*                                                                               
         MVI   TKEY.TLKTYP,C'A'    AGENCY OR REP BUY?                           
         TM    TR.TLBYAFLG,X'40'   LINK OR ACTUAL BUY #?                        
         BZ    BLDBL50                                                          
         MVC   TKEY.TLBLINDX,TR.TLBYALNK                                        
         B     BLDBL10                                                          
*                                                                               
BLDBL05  DS    0H                                                               
         MVI   TKEY.TLKTYP,C'R'                                                 
         TM    TR.TLBYRFLG,X'40'   LINK OR ACTUAL BUY #?                        
         BZ    BLDBL50                                                          
         MVC   TKEY.TLBLINDX,TR.TLBYRLNK                                        
*                                                                               
BLDBL10  DS    0H                                                               
         OC    TKEY.TLBLINDX,TKEY.TLBLINDX                                      
         BZ    BLDBL50             NEED TO CREATE NEW BUY LINK RECORD           
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TSARREC+2(L'TLKEY),TSARKEY                                       
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
* INDEX POINTER MUST BE POINTING TO AN EXISTING BUY LINK RECORD                 
*                                                                               
         CLC   TR.TLKEY(TLBLTSPT-TLKEY),TKEY.TLKEY                              
         BE    *+6                                                              
         DC    H'0'                MUST BE IN TSAR BUFFER                       
*                                                                               
* BUY LINK RECORD FOUND, ADD THIS BUY TO THE LIST OF BUYS AND SPOTS             
*                                                                               
         LA    R3,TR.TLBLBUY#                                                   
*                                                                               
BLDBL20  DS    0H                                                               
         CLI   0(R3),0                                                          
         BE    BLDBL100                                                         
         AHI   R3,TLBLLENQ                                                      
*                                                                               
         LA    RE,TSARREC+L'TSARREC                                             
         CR    R3,RE               BOUNDARY CHECK                               
         BL    BLDBL20                                                          
         DC    H'0'                                                             
*                                                                               
* NEED TO CREATE NEW BUY LINK RECORD FOR THIS BUY SEGMENT                       
*                                                                               
BLDBL50  DS    0H                  FIND HIGHEST INDEX NUMBER                    
         XC    TBLINDEX,TBLINDEX                                                
         XC    TSARREC,TSARREC                                                  
         MVC   TSARREC+2(L'TLKEY),TSARKEY                                       
         GOTO1 GOTSAR,TSARDH                                                    
*                                                                               
BLDBL55  DS    0H                                                               
         CLC   TR.TLKTYP,TKEY.TLKTYP                                            
         BNE   BLDBL60                                                          
         MVC   TBLINDEX,TR.TLBLINDX                                             
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSANXT                                                    
         TM    TB.TSERRS,TSEEOF                                                 
         BZ    BLDBL55                                                          
*                                                                               
BLDBL60  DS    0H                                                               
         SR    R1,R1                                                            
         ICM   R1,3,TBLINDEX                                                    
         AHI   R1,1                                                             
         STCM  R1,3,TBLINDEX                                                    
*                                                                               
TR2      USING TLSTD,TSARREC2                                                   
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TR.TLKTYP,TKEY.TLKTYP                                            
         MVC   TR.TLBLINDX,TBLINDEX                                             
*                                                                               
* SAVE OFF PREVIOUSLY SAVED LINE NUMBER AND NUMBER OF SPOTS                     
*                                                                               
         CLI   TR.TLKTYP,C'A'                                                   
         BE    BLDBL70                                                          
*        MVC   TR.TLBLBUY#(2),TR2.TLBYRLNK                                      
         MVC   TR.TLBLBUY#,TR2.TLBYRLNK                                         
         MVC   TR.TLBL#SPT,TR2.TLBYRSPT                                         
         MVC   TR.TLBLFLG,TR2.TLBYRFG2                                          
         B     BLDBL80                                                          
*                                                                               
BLDBL70  DS    0H                                                               
         MVC   TR.TLBLBUY#,TR2.TLBYALNK                                         
         MVC   TR.TLBLSUB#,TR2.TLBYASUB                                         
         MVC   TR.TLBL#SPT,TR2.TLBYASPT                                         
         MVC   TR.TLBLFLG,TR2.TLBYAFG2                                          
*        MVC   TR.TLBLBUY#(3),TR2.TLBYALNK                                      
*                                                                               
BLDBL80  DS    0H                                                               
         MVC   TR.TLBLTSPT,TR.TLBL#SPT                                          
*                                                                               
* APPEND CURRENT LINE NUMBER AND NUMBER OF SPOTS                                
*                                                                               
         LA    R3,TR.TLBLLIST                                                   
*                                                                               
BLDBL100 DS    0H                                                               
BL       USING TLBLBUY#,R3         REP OR AGENCY BUY NUMBER                     
         TM    MISCFLG4,MF4MKG                                                  
         BZ    *+8                                                              
         OI    BL.TLBLFLG,X'80'    SET MAKEGOOD FLAG                            
*                                                                               
         MVC   BL.TLBLBUY#,BUYD.RBUYKLIN                                        
         CLI   TR.TLKTYP,C'R'                                                   
         BE    BLDBL103                                                         
         MVC   BL.TLBLBUY#,BUYD.RBUYAGBL                                        
*                                                                               
*        CLI   TR2.TLBYMLNK,0      DAILY/C.O?                                   
*        BE    BLDBL103            NO                                           
BTR      USING TLSTD,GNXSVREC      BACK UP                                      
         MVC   BL.TLBLSUB#,BTR.TLBYASUB AGENCY SUBLINE                          
         DROP  BTR                                                              
                                                                                
BLDBL103 DS    0H                                                               
*                                  NUMBER OF SPOTS COVERED                      
         MVC   BL.TLBL#SPT,BUYD.RBUYTSPT                                        
*                                                                               
         ZIC   RF,BL.TLBL#SPT      CALCULATE TOTAL SPOTS FOR THIS WEEK          
         ZIC   RE,TR.TLBLTSPT                                                   
         AR    RE,RF                                                            
         STC   RE,TR.TLBLTSPT                                                   
         DROP  BL                                                               
*                                                                               
* CALCULATE NEW VARIABLE LENGTH AND ADD/PUT RECORD TO TSAR                      
*                                                                               
         AHI   R3,TLBLLENQ                                                      
*                                                                               
         LA    RE,TR.TLREC                                                      
         SR    R3,RE                                                            
         STCM  R3,3,TR.TLLEN                                                    
*                                                                               
* ADD OR PUT NEW BUY LINK RECORD                                                
*                                                                               
         CLI   TR.TLBLLIST+TLBLLENQ,0                                           
         BE    BLDBL105                                                         
         GOTO1 GOTSAR,TSAWRT                                                    
         TM    TB.TSERRS,TSERNF                                                 
         BZ    BLDBLX                                                           
         DC    H'0'                                                             
*                                                                               
BLDBL105 DS    0H                                                               
         GOTO1 GOTSAR,TSAADD                                                    
         TM    TB.TSERRS,TSEDUP+TSEEOF                                          
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
*                                                                               
*                                                                               
* UPDATE BUY SEGMENT RECORD WITH INDEX OF NEW BUY LINK RECORD                   
*                                                                               
         MVC   TXNUM,SVTSAR#                                                    
         GOTO1 GOTSAR,TSAGET                                                    
         TM    TB.TSERRS,TSERNF                                                 
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   =X'0B01',BUYD.RBUYKEY                                            
         BE    BLDBL110                                                         
         MVC   TR.TLBYRLNK,TBLINDEX                                             
         OI    TR.TLBYRFLG,X'40'   FIELD IS A LINK POINTER                      
         B     BLDBL120                                                         
*                                                                               
BLDBL110 DS    0H                                                               
         MVC   TR.TLBYALNK,TBLINDEX                                             
         OI    TR.TLBYAFLG,X'40'   FIELD IS A LINK POINTER                      
*                                                                               
BLDBL120 DS    0H                                                               
         GOTO1 GOTSAR,TSAPUT                                                    
         TM    TB.TSERRS,TSERNF                                                 
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
BLDBLX   DS    0H                                                               
         B     EXIT                                                             
         DROP  R6,BUYD                                                          
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* MARK SEGMENT AS MATCHED/UNMATCHED/LINK                                        
***********************************************************************         
MRKSEG   NTR1  BASE=*,LABEL=*                                                   
         L     R4,AIO                                                           
BUYD     USING RBUYREC,R4                                                       
SEG      USING TLSTD,TSARREC2                                                   
         CLC   =X'0B01',BUYD.RBUYKEY  REP OR AGENCY SEGMENT?                    
         BE    MRKS0060                                                         
         OC    SEG.TLBYALNK,SEG.TLBYALNK                                        
         BZ    MRKS0500                                                         
         MVI   SEG.TLBYFLG2,TLMTHQ MATCHED                                      
         MVI   SEG.TLBYLNKT,0                                                   
         B     MRKS0100                                                         
*                                                                               
MRKS0060 DS    0H                                                               
         OC    SEG.TLBYRLNK,SEG.TLBYRLNK                                        
         BZ    MRKS0500                                                         
         MVI   SEG.TLBYFLG2,TLMTHQ MATCHED                                      
         MVI   SEG.TLBYLNKT,0                                                   
*                                                                               
MRKS0100 DS    0H                                                               
         MVC   TSARREC,TSARREC2                                                 
         GOTO1 GOTSAR,TSAWRT                                                    
         TM    TB.TSERRS,TSERNF                                                 
         BZ    MRKSEGX                                                          
         DC    H'0'                                                             
*                                                                               
MRKS0500 DS    0H                                                               
*                                                                               
MRKSEGX  DS    0H                                                               
         B     EXIT                                                             
         DROP  BUYD,SEG                                                         
***********************************************************************         
* DUMP CONTENTS OF TSAR BUFFER TO DISPLAY                                       
***********************************************************************         
DIFFLIST NTR1  BASE=*,WORK=(R4,ELWORKQ),LABEL=*                                 
*                                                                               
         USING ELWORKD,R4                                                       
*                                                                               
         L     R8,ASPOOLD                                                       
         USING SPOOLD,R8                                                        
*                                                                               
         MVC   DIFMTCH+1(14),=C'MATCHED LINES:'                                 
         TM    OFLAG1,OMATCHQ                                                   
         BO    *+10                                                             
         XC    DIFMTCH,DIFMTCH                                                  
*                                                                               
         LA    R2,DIFLISTH         LINE 1 FOR MATCH HEADING                     
*                                                                               
         OC    DIFATOT,DIFATOT     TOTALS ALREADY DISPLAYED?                    
         BNZ   DL03                                                             
*                                                                               
         GOTOR DISTOTAL                                                         
*                                                                               
DL03     DS    0H                                                               
         GOTOR PROCSCR             PROCESS SCREEN INPUT                         
         TM    DISFLG1,D1UNMTHQ    UNMATCHING LINES?                            
         BO    ERPVIEW             HAVE TO PREVIEW TO GO ON                     
*                                                                               
         GOTOR PROTSCR             PROTECT THE WHOLE SCREEN                     
         TWAXC (R2),DIFEND2H,PROT=Y CLEAN UP THE SCREEN                         
*                                                                               
         GOTOR DISWKH,DMCB,GRSTDATE,DIFHLN2+MONTHQ,DIFHL3D                      
         GOTOR DISMORE             DISPLAY "MORE>>"                             
         GOTOR CHGHEAD             CHANGE HEADING FOR EXPAND FORMAT             
*                                                                               
         OC    LISTLAST,LISTLAST   FIRST TIME IN?                               
         BZ    DL05                YES                                          
*                                                                               
         GOTOR SETCONT             HANDLE CONTINUATION                          
*                                                                               
         MVC   TXNUM,LISTLAST                                                   
         GOTO1 GOTSAR,TSAGET                                                    
         BE    DL08                                                             
         DC    H'0'                                                             
*                                                                               
DL05     DS    0H                                                               
         BAS   RE,DIFFHEAD                                                      
         XC    DISFLG1(CLEARQ),DISFLG1   CLEAN UP A CHUNK OF SPACE              
         XC    TSARREC,TSARREC                                                  
         XC    TB.TSRNUM,TB.TSRNUM                                              
         MVI   TR.TLKTYP,X'0B'                                                  
         GOTO1 GOTSAR,TSARDH                                                    
         BL    DLX                                                              
*                                                                               
DL08     DS    0H                                                               
         XC    LISTSTRT,LISTSTRT                                                
*                                                                               
DL10     DS    0H                                                               
         CLI   TR.TLKTYP,X'0B'     END OF BUY SEGMENT?                          
         BNE   DLX                 EXIT                                         
*                                                                               
         TM    DISFLG1,DCONTEEQ                                                 
         BO    *+10                                                             
         XC    COMPTSAR,COMPTSAR                                                
*                                                                               
         MVC   ELTSRNUM,TB.TSRNUM                                               
         MVC   ELWORK2,TSARREC                                                  
*                                                                               
         OC    LISTSTRT,LISTSTRT                                                
         BNZ   *+10                                                             
         MVC   LISTSTRT,TB.TSRNUM  SAVE OFF LIST START                          
         MVC   LISTLAST,TB.TSRNUM  SAVE OFF LIST END                            
*                                                                               
         TM    TR.TLBYFLG3,X'80'                                                
*                                                                               
         BO    DL70                                                             
         B     DL10030                                                          
*        BO    DL70                SKIP BUYS THAT MATCHES TOTALLY               
*&&DO                                                                           
         BZ    DL10030                                                          
         OC    TR.TLBYMLNK,TR.TLBYMLNK                                          
         BZ    DL70                                                             
         TM    TR.TLBYFLG3,X'02'   DAILY BUY GROUP NOT MATCH                    
         BZ    DL30                                                             
*        B     DL30                                                             
*&&                                                                             
*                                                                               
DL10030  DS    0H                                                               
         GOTOR ZEROSPT                                                          
         BE    DL70                YES, SKIP                                    
*                                                                               
DL10050  DS    0H                                                               
         TM    DISFLG3,D3ORBAG     LAST TRANSACTION WAS IN THE MIDDLE           
         BO    DL10100             OF DISPLAYING AGY SEGMENT?                   
         CLI   TR.TLBYTYPA,TLTYPAQ NO                                           
         BNE   DL10100             SKIP AGENCY LINK SEGMENT                     
         TM    TR.TLBYFLG4,X'10'   ADD-TO-SKED?                                 
         BZ    DL70                NO-SKIP                                      
*                                                                               
DL10100  DS    0H                                                               
         OI    DISFLG1,DBUYDISQ    AT LEAST ONE SEGMENT ON SCREEN               
*                                                                               
         GOTOR VALSEG              SATISFY "MPU" OPTION                         
         BZ    DL70                NO                                           
***********************************************************************         
* BUILD SCROLL RECORD                                                           
***********************************************************************         
         LA    RF,DIFLISTH         BUILD SCROLL RECORD IF THIS IS FIRST         
         CR    R2,RF               ON PAGE. THIS IS NEEDED SO WE CAN            
         BNE   DL11X               SCROLL BACKWARDS                             
*                                                                               
         TM    FLAGS2,FG2BACK                                                   
         BO    DL11X               ONLY BUILD SCROLL REC GOING FORWARD          
         TM    FLAGS2,FG2RGHT                                                   
         BO    DL11X               SCROLL RIGHT?                                
         CLI   PFKEY,7                                                          
         BE    DL11X               SWITCHING BETWEEN SQZ/EXPAND FORMAT?         
         GOTOR BLDSCREC                                                         
*                                                                               
DL11X    DS    0H                  SET UP 'MATCHED LINES:' HEADING              
         NI    DIFMTCHH+1,FF-X'0C'                                              
         OI    DIFMTCHH+1,X'08'                                                 
         MVI   DIFMTCH,NOCOLOR                                                  
         TM    STEREOFG,STFINUSE                                                
         BO    *+8                                                              
         MVI   DIFMTCH,C' '                                                     
*                                                                               
         CLC   SCRNUM,=H'1'        FIRST PAGE WILL HAVE MATCH HEADING           
         BE    *+8                                                              
         OI    DIFMTCHH+1,X'0C'                                                 
**********************************************************************          
* DISPLAY SECTION HEADING (MATCH/UNMATCH/PROPOSE MATCH)                         
**********************************************************************          
DL13     DS    0H                                                               
         LA    RF,DIFLISTH         DISPLAY SECTION HEADER                       
         CR    R2,RF               IF THIS IS THE FIRST LINE                    
         BNE   DL13A                                                            
         CLC   SCRNUM,=H'1'                                                     
         BNE   DL14                                                             
*                                                                               
DL13A    DS    0H                                                               
         CLC   SVTYPE,TR.TLBYFLG   WE NEED TO BREAK ON                          
         BE    DL30                DIFFERENT SECTIONS                           
*                                                                               
         CLI   SVTYPE,TLLNKQ       DO NOT PUT OUT HEADING FOR                   
         BNE   *+12                                                             
         CLI   TR.TLBYFLG,TLMTHQ2  PROPOSED MATCH TWICE                         
         BE    DL15                                                             
*                                                                               
DL14     DS    0H                                                               
         GOTOR DISECTN,DMCB,(R2)   DISPLAY SECTION HEADER                       
         BE    DL15                                                             
         MVC   LISTLAST,ELTSRNUM                                                
         B     DL400                                                            
                                                                                
DL15     DS    0H                                                               
         L     R2,DMCB                                                          
         MVC   SVTYPE,TR.TLBYFLG   SAVE OFF TYPE                                
*                                                                               
**********************************************************************          
* DISPLAY REP TSAR CONTENT                                                      
**********************************************************************          
DL30     DS    0H                                                               
         TM    DISFLG3,D3ORBAG    ONLY DISPLAY AGY LINE?                        
         BO    DL33               YES                                           
         TM    TR.TLBYFLG3,X'80'  TOTALLY MATCH                                 
         BO    DL33                                                             
*                                                                               
DL30C    DS    0H                                                               
         NI    OVRDFLG,FF-OVPGMQ                                                
         GOTOR COMPPGM             COMPARE PROGRAM NAME                         
         BE    *+8                                                              
         OI    OVRDFLG,OVPGMQ                                                   
*                                                                               
         ST    R2,SAVER2           SAVE OFF WHERE WE BEGIN                      
         GOTOR GETNDX              RETREIVE INDEXED ITEMS                       
         BNE   DL400               PASS SCREEN END?                             
*                                                                               
         OC    TR.TLBYMLNK,TR.TLBYMLNK                                          
         BZ    DL32                MULTIPLE DUE TO C.O/DAILY/C.E.D              
         OI    DISFLG3,D3MINI      YEAH                                         
*                                                                               
DL32     DS    0H                                                               
         L     R2,DMCB                                                          
         USING DIFFSUM,R2                                                       
*                                                                               
**********************************************************************          
* DISPLAY AGENCY TSAR CONTENT                                                   
**********************************************************************          
DL33     DS    0H                                                               
*        NI    DISFLG3,FF-D3ORBAG                                               
         TM    TR.TLBYFLG4,X'44'   CANCELLATION                                 
         BNZ   DL3500                                                           
         CLI   TR.TLBYTYPA,TLTYPAQ AGY SEG OF THE PAIR                          
         BE    DL70                NEXT                                         
         CLI   TR.TLBYLNK,0        NO LINK                                      
         BE    DL70                NEXT                                         
         TM    TR.TLBYFLG3,X'10'   MATCHED DAILY/C.O?                           
         BZ    DL3390                                                           
*                                                                               
         MVC   ELWORK4,TSARREC                                                  
         MVC   TXNUM,ELTSRNUM                                                   
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         XC    TSARREC,TSARREC                                                  
*                                                                               
DL3330   DS    0H                                                               
         GOTO1 GOTSAR,TSANXT                                                    
         CLC   TSARREC+2(TLBYMLNK-TLKTYP),ELWORK2+2                             
         BNE   DL3350              LAST LINE OF THE GROUP                       
         TM    TR.TLBYFLG3,X'80'                                                
         BO    DL3330              LOOP                                         
         B     DL70                NOT END OF GROUP                             
*                                                                               
DL3350   DS    0H                                                               
         MVC   TSARREC,ELWORK4                                                  
*                                                                               
DL3390   DS    0H                                                               
         MVI   BYTE,TLLNKQ                                                      
         CLI   TR.TLBYFLG,TLLNKQ   LINK/MATCH SEGMENTS NEED TO                  
         BE    DL35                RETRIEVE THE AGENCY LINE                     
         MVI   BYTE,TLMTHQ                                                      
         CLI   TR.TLBYFLG,TLMTHQ                                                
         BNE   DL70                                                             
*                                                                               
         MVC   COMPTSAR,TSARREC    FOR COMPARING PURPOSE                        
         TM    TR.TLBYFLG3,X'10'   MATCHED DAILY/C.O?                           
         BO    DL3310                                                           
         TM    DISFLG3,D3ORBAG     DISPLAYING CONTINUATION?                     
         BZ    DL35                                                             
         TM    DISFLG3,D3EOGRP     END OF GROUP?                                
         BZ    DL35                                                             
DL3310   DS    0H                  YES                                          
         XC    COMPTSAR,COMPTSAR                                                
*                                                                               
DL35     DS    0H                                                               
         TM    TR.TLBYFLG4,X'44'   ORPHAN SEGMENT                               
         BNZ   DL3500                                                           
*                                                                               
         MVC   TSARREC2,TSARREC    SAVE OFF CURRENT BUY SEGMENT                 
         XC    TSARREC,TSARREC                                                  
SEG      USING TLSTD,TSARREC2                                                   
*                                                                               
         MVI   TR.TLKTYP,X'0B'                                                  
         MVC   TR.TLBYFLG,BYTE                                                  
         MVI   TR.TLBYTYPA,TLTYPAQ                                              
         MVC   TR.TLBYLNK,TR2.TLBYLNK                                           
         MVC   SAVEKEY(L'TSARKEY),TSARREC+2                                     
*                                                                               
         GOTO1 GOTSAR,TSARDH                                                    
         CLC   TSARREC+2(TLBYMLNK-TLKTYP),SAVEKEY                               
         BE    DL3504              SAME GROUP                                   
*                                                                               
         CLI   TR2.TLBYMLNK,0      NO, IS THIS DAILY/C.O?                       
         BE    DL3503              NO, DIE                                      
*                                                                               
         TM    DISFLG3,D3EOGRP     END OF GROUP?                                
         BO    DL3501              YES                                          
*                                                                               
*    FAKE AGY COMPONENT WITH ZERO SPOTS                                         
*                                                                               
         MVC   TSARREC,TSARREC2                                                 
         TM    TR.TLBYFLG4,X'40'   CANCELLED REP BUYS?                          
         BZ    DL70                                                             
*                                                                               
DL3500   OI    CFLAG,CFKAGYQ       SET "FAKING AGY LINE" FLAG - DAILY           
         GOTOR GETNDX              DISPLAY THE REP LINE AGAIN                   
         L     R2,DMCB                                                          
*                                                                               
         NI    CFLAG,X'FF'-CFKAGYQ                                              
*                                                                               
         CLI   DISFLG2,DMATCHQ                                                  
         BNE   DL70                                                             
*                                                                               
         TM    TR.TLBYFLG4,X'44'   CANCELLED REP BUYS?                          
         BNZ   DL3501                                                           
         OC    TR2.TLBYALNK,TR2.TLBYALNK                                        
         BNZ   DL70                AGY LINE DISPLAYED ALREADY - SKIP            
*                                                                               
DL3501   OI    OVRDFLG,OVCNCLQ     NO, THIS IS A REP LINE WITHOUT               
         GOTOR DISOVRD,DMCB,(X'80',(R2))  AGY LINE TO MATCH UP TO               
         BNE   DL400               REACH SCREEN END? YES=EXIT                   
         L     R2,DMCB             UPDATE NEXT SCREEN LINE                      
         B     DL70                SO IT SHOULD BE CANCELLED.                   
*                                                                               
DL3502   DS    0H                                                               
         NI    DISFLG3,FF-D3MINI   YES, CLEAR FLAG                              
         B     DL70                                                             
*                                                                               
DL3503   DS    0H                                                               
         DC    H'0'                                                             
*                                                                               
DL3504   DS    0H                                                               
         CLI   TR2.TLBYMLNK,0      DAILY/C.O?                                   
         BE    DL3510              NO,NO NEED TO LOOP                           
         LH    R3,COUNT1                                                        
         CHI   R3,0                                                             
         BE    DL3510              FIRST TIME, DON'T LOOP                       
*                                                                               
DL3506   DS    0H                                                               
         GOTO1 GOTSAR,TSANXT       LOOP UNTIL WE GOT THE RIGHT ONE              
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         BCT   R3,DL3506                                                        
*                                                                               
DL3508   DS    0H                                                               
         CLC   TSARREC+2(TLBYMLNK-TLKTYP),SAVEKEY                               
         BE    DL3510              SAME GROUP?                                  
         TM    DISFLG3,D3EOGRP                                                  
         BO    DL70                                                             
         CLI   DISFLG2,DMATCHQ                                                  
         BNE   DL70                                                             
*                                                                               
         OI    OVRDFLG,OVCNCLQ     NO, REP LINE WILL BE CANCELLED               
         GOTOR DISOVRD,DMCB,(X'80',(R2))                                        
*        NI    OVRDFLG,FF-OVCNCLQ  CLEAR FLAG                                   
         BNE   DL400               REACH SCREEN END? YES=EXIT                   
         L     R2,DMCB             UPDATE NEXT SCREEN LINE                      
*                                                                               
         B     DL70                                                             
*                                                                               
DL3510   DS    0H                                                               
         OI    DISFLG1,DBUYDISQ    AT LEAST ONE SEGMENT ON SCREEN               
         GOTOR GETNDX                                                           
         BE    DL3550                                                           
         OI    DISFLG3,D3ORBAG     NEXT DISPLAY SHOULD ONLY DISPLAY THE         
*                                  AGENCY ORBIT LINE                            
         B     DL400                                                            
*                                                                               
DL3550   DS    0H                                                               
         TM    TR.TLBYFLG4,X'40'   CANCELLATION?                                
         BZ    DL3570                                                           
         OI    CFLAG,CFKAGYQ       SET "FAKING AGY LINE" FLAG - DAILY           
         GOTOR GETNDX              DISPLAY THE REP LINE AGAIN                   
         L     R2,DMCB                                                          
         NI    CFLAG,X'FF'-CFKAGYQ                                              
*                                                                               
DL3570   L     R2,DMCB                                                          
         LH    RF,COUNT1                                                        
         AHI   RF,1                INCREASE COUNTER                             
         STH   RF,COUNT1                                                        
*                                                                               
         MVC   ELWORK4,TSARREC                                                  
*        NI    DISFLG3,FF-D3EOGRP RESET END OF GROUP FLAG                       
         MVC   TXNUM,ELTSRNUM                                                   
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         XC    TSARREC,TSARREC                                                  
*                                                                               
DL3630   DS    0H                                                               
         GOTO1 GOTSAR,TSANXT                                                    
         CLC   TSARREC+2(TLBYMLNK-TLKTYP),ELWORK2+2                             
         BNE   DL3650                                                           
         TM    TR.TLBYFLG3,X'80'                                                
         BO    DL3630              LOOP                                         
         B     DL3680              NOT END OF GROUP                             
*                                                                               
DL3650   DS    0H                                                               
         OI    DISFLG3,D3EOGRP     END OF GROUP                                 
DL3680   DS    0H                                                               
         MVC   TSARREC,ELWORK4                                                  
*                                                                               
         TM    DISFLG3,D3EOGRP                                                  
         BZ    DL70                                                             
*                                                                               
         XC    COMPTSAR,COMPTSAR   COMPARE TO NADA                              
         GOTO1 GOTSAR,TSARDH       RESTORE SEQUENCE                             
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   SAVEKEY,TSARREC+2                                                
         GOTO1 GOTSAR,TSANXT       READ NEXT                                    
         BE    DL3508                                                           
         DC    H'0'                                                             
*                                                                               
DL70     DS    0H                                                               
*&&TT                                                                           
         CLI   TR.TLBYRLNK,X'04'                                                
         BNE   *+6                                                              
         DC    X'0770'                                                          
*&&                                                                             
         NI    DISFLG3,FF-D3ORBAG  DISPLAYING CONTINUATION?                     
         XC    COUNT2,COUNT2       CLEAR COUNTER EACH LOOP                      
         MVC   TXNUM,ELTSRNUM                                                   
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSANXT                                                    
         BL    DL80                                                             
         CLI   TR.TLKTYP,X'0B'                                                  
         BE    DL300                                                            
*                                                                               
DL80     XC    LISTLAST,LISTLAST                                                
         B     DL300                                                            
*                                                                               
DL300    DS    0H                                                               
         CLC   ELWORK2+2(TLBYMLNK-TLKTYP),TSARREC+2                             
         BE    DL350                                                            
         NI    DISFLG3,FF-D31STREP-D3MINI-D3EOGRP                               
         XC    COUNT1,COUNT1                                                    
*                                                                               
DL350    DS    0H                                                               
         MVC   PRVREPSP,TOTREPSP   RESET FOR NEXT SEGMENT COMPARISON            
         MVC   PRVAGYSP,TOTAGYSP                                                
*                                                                               
         OC    LISTLAST,LISTLAST   NULL IF ALL DONE DISPLAYING                  
         BZ    DLX                                                              
*                                                                               
         LA    RF,DIFENDH                                                       
         CR    R2,RF                                                            
         BNH   DL10                                                             
*                                                                               
         MVC   LISTLAST,TB.TSRNUM  SAVE OFF LIST END                            
DL400    DS    0H                                                               
         NI    OVRDFLG,FF-OVCNCLQ  CLEAR FLAG                                   
         OI    MYFLAG1,X'01'       OUTPUT "BUY DISPLAYED" MESSAGE               
*                                                                               
DLX      DS    0H                                                               
         TM    DISFLG1,DBUYDISQ                                                 
         BO    DLX10                                                            
         GOTOR EMPTY                                                            
DLX10    DS    0H                                                               
         B     EXIT                                                             
         DROP  R8                                                               
         EJECT                                                                  
***********************************************************************         
* DISPLAY HEADER INFO FOR DIFFERENCE SUMMARY/DETAIL LISTING                     
***********************************************************************         
DIFFHEAD NTR1                                                                   
*                                                                               
         TM    SVDARFL2,SF2XML                                                  
         BZ    *+10                                                             
         MVC   DIFXML(7),=C'XML ORD'                                            
*                                                                               
         MVC   DIFHDLN,ECONNUM     FILL IN CONTRACT/ORDER #S                    
         GOTO1 HEXOUT,DMCB,CDARNUM,DIFAORD,4,=C'TOG'                            
*                                                                               
         MVC   DIFTYPE,=C'SUMMARY'                                              
*                                                                               
         LA    R6,DIFFDTE                                                       
         MVC   0(9,R6),=C'Agy date:'                                            
         GOTO1 DATCON,DMCB,(2,FLTDATES),(5,10(R6))                              
         MVI   18(R6),C'-'                                                      
         GOTO1 DATCON,DMCB,(2,FLTDATES+2),(5,19(R6))                            
DHX      DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* DISPLAY HEADER INFO FOR DIFFERENCE SUMMARY/DETAIL LISTING                     
***********************************************************************         
CHGHEAD  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         TM    FLAGS2,FG2EXPD                                                   
         BZ    CHGH0100            GET OUT                                      
         XC    DIFHLN2(HEADEXPQ),DIFHLN2                                        
         MVC   DIFHLN2(HEADEXPQ),HEADEXP                                        
         B     CHGHX                                                            
CHGH0100 DS    0H                                                               
         XC    DIFHLN2(MONTHQ),DIFHLN2                                          
         MVC   DIFHLN2(HEADSQZQ),HEADSQZ                                        
CHGHX    DS    0H                                                               
         B     EXIT                                                             
HEADEXP  DC    C'Rp# Day     Times       Len    Rate Pgm'                       
HEADEXPQ EQU   *-HEADEXP                                                        
HEADSQZ  DC    C'Rp# Day/Times,Len,Rate,Program'                                
HEADSQZQ EQU   *-HEADSQZ                                                        
MONTHQ   EQU   33                  WHERE MONTH START PRINTING (SQZ)             
*                                                                               
***********************************************************************         
* HANDLE CONTINUATION                                                           
***********************************************************************         
SETCONT  NTR1  BASE=*,LABEL=*                                                   
         TM    FLAGS2,FG2RGHT      PF 6 WAS PRESSED                             
         BO    SCONX               STILL THE SAME SCREEN                        
*                                                                               
         TM    FLAGS2,FG2BACK      SCROLLING BACK?                              
         BO    SCON0030            NO, NORMAL PROCESSING                        
         CLI   PFKEY,7                                                          
         BNE   SCON0050            NO, NORMAL PROCESSING                        
SCON0030 DS    0H                                                               
         NI    DISFLG1,X'FF'-DCONTEEQ                                           
         TM    DISFLG1,DCONBAKQ    CONTINUATION ON SCROLLING BACK?              
         BZ    SCONX                                                            
         OI    DISFLG1,DCONTEEQ                                                 
         B     SCONX                                                            
*                                                                               
SCON0050 DS    0H                                                               
         TM    DISFLG1,DCONTERQ                                                 
         BZ    SCON0080                                                         
         OI    DISFLG1,DCONTEEQ                                                 
         NI    DISFLG1,X'FF'-DCONTERQ                                           
         B     SCONX                                                            
SCON0080 DS    0H                                                               
         NI    DISFLG1,X'FF'-DCONTERQ-DCONTEEQ                                  
SCONX    DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* VALIDATE THIS SEGMENT FOR DISPLAY                                             
***********************************************************************         
VALSEG   NTR1  BASE=*,LABEL=*                                                   
         CLI   TR.TLBYFLG,TLMTHQ                                                
         BE    VALS0300            SKIP AGENCY LINK SEGMENT                     
         CLI   TR.TLBYFLG,TLLNKQ                                                
         BE    VALS0400                                                         
         CLI   TR.TLBYFLG,TLMTHQ2                                               
         BE    VALS0400                                                         
         CLI   TR.TLBYFLG,TLUMTHQ                                               
         BE    VALS0500                                                         
         DC    H'0'                                                             
*                                                                               
VALS0300 DS    0H                  EXIT WITH CODITION CODE                      
         TM    OFLAG1,OMATCHQ                                                   
         B     VALSX                                                            
VALS0400 DS    0H                                                               
         TM    OFLAG1,OPMATCHQ                                                  
         B     VALSX                                                            
VALS0500 DS    0H                  UNMATCH WITH NULL SPOTS                      
         TM    OFLAG1,OUMATCHQ                                                  
VALSX    DS    0H                                                               
         B     EXIT                                                             
*                                                                               
***********************************************************************         
* HANDLE COMMENTS FOR EMPTY DIFFERENCE SCREEN OR PRINTOUT                       
***********************************************************************         
EMPTY    NTR1  BASE=*,LABEL=*                                                   
         L     R8,ASPOOLD                                                       
         USING SPOOLD,R8                                                        
*                                                                               
         LA    R2,DSLINE                                                        
         LA    R3,LISTLEN                                                       
         TM    FLAGS,FGPRTQ                                                     
         BZ    EMPTY10                                                          
         LA    R2,P                                                             
         LA    R3,L'P                                                           
         XC    P,P                                                              
         XC    P2,P2                                                            
         XC    P3,P3                                                            
         XC    P4,P4                                                            
*                                                                               
EMPTY10  DS    0H                                                               
         MVC   0(COM1Q,R2),COM1                                                 
         MVC   COM1Q+1(L'STATUS+L'STATUS2,R2),STATUS                            
*                                                                               
         LA    R2,0(R3,R2)                                                      
         MVC   0(COM2Q,R2),COM2                                                 
         LA    R2,0(R3,R2)                                                      
         MVC   0(COM3Q,R2),COM3                                                 
         LA    R2,0(R3,R2)                                                      
         MVC   0(COM4Q,R2),COM4                                                 
         LA    R2,0(R3,R2)                                                      
*                                                                               
         TM    FLAGS,FGPRTQ                                                     
         BZ    EMPTY100                                                         
         BAS   RE,PRINT                                                         
         LA    R2,P                                                             
*                                                                               
EMPTY100 DS    0H                                                               
         TM    CMTFLAG,CMTSTAND+CMTORD+CMTREJ+CMTBUY                            
         BZ    *+10                                                             
         MVC   0(COM5Q,R2),COM5                                                 
*                                                                               
         TM    FLAGS,FGPRTQ                                                     
         BZ    EMPTYX                                                           
         BAS   RE,PRINT                                                         
*                                                                               
EMPTYX   DS    0H                                                               
         B     EXIT                                                             
COM1     DC    C'THE ORDER STATUS IS'                                           
COM1Q    EQU   *-COM1                                                           
COM2     DC    C'NO DIFFERENCES EXIST BETWEEN THE SPOTS ON THE AGY ORD'         
         DC    C'ER '                                                           
         DC    X'50'                                                            
         DC    C' REP CONTRACT'                                                 
COM2Q    EQU   *-COM2                                                           
COM3     DC    C'PLEASE CHECK THE BUYLIST SCREEN'                               
COM3Q    EQU   *-COM3                                                           
COM4     DC    C'CHECK THE AGENCY HEADER DATA TO SEE IF IT CHANGED'             
COM4Q    EQU   *-COM4                                                           
COM5     DC    C'BUYER INCLUDED COMMENTS (ORDER AND/OR BUYLINE) THAT '          
         DC    C'MAY REQUIRE ACTION'                                            
COM5Q    EQU   *-COM5                                                           
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* COMPARE PROGRAM NAME                                                          
***********************************************************************         
COMPPGM  NTR1  BASE=*,WORK=(R4,SMWORKQ),LABEL=*                                 
         USING SMWORKD,R4                                                       
         MVC   SMWORK1,TSARREC                                                  
         MVC   SMTXNUM,TXNUM                                                    
*                                                                               
         CLI   TR.TLBYTYPA,TLTYPAQ AGY SEG OF THE PAIR                          
         BE    CPGMYES             NEXT                                         
*                                                                               
         CLI   TR.TLBYLNK,0        NO LINK                                      
         BE    CPGMYES             NEXT                                         
*                                                                               
         TM    TR.TLBYFLG3,X'10'   MATCHED DAILY/C.O FORCE TO BE LINK?          
         BO    CPGMYES             DON'T COMPARE                                
*                                                                               
SEG2     USING TLSTD,SMWORK1                                                    
         MVI   BYTE,TLLNKQ                                                      
         CLI   TR.TLBYFLG,TLLNKQ   LINK/MATCH SEGMENTS NEED TO                  
         BE    CPGM35              RETRIEVE THE AGENCY LINE                     
*                                                                               
         MVI   BYTE,TLMTHQ                                                      
         CLI   TR.TLBYFLG,TLMTHQ                                                
         BNE   CPGMYES                                                          
*                                                                               
CPGM35   DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
*                                                                               
         MVI   TR.TLKTYP,X'0B'                                                  
         MVC   TR.TLBYFLG,BYTE                                                  
         MVI   TR.TLBYTYPA,TLTYPAQ                                              
         MVC   TR.TLBYLNK,SEG2.TLBYLNK                                          
         MVC   SAVEKEY(L'TSARKEY),TSARREC+2                                     
*                                                                               
         GOTO1 GOTSAR,TSARDH                                                    
         CLC   TSARREC+2(TLBYMLNK-TLKTYP),SAVEKEY                               
         BNE   CPGMYES             SAME GROUP                                   
*        DC    H'0'                                                             
*                                                                               
CPGM50   DS    0H                                                               
         CLC   TR.TLBYPROG,SEG2.TLBYPROG                                        
         BNE   CPGMNO                                                           
*                                                                               
CPGMYES  SR    RC,RC                                                            
CPGMNO   LTR   RC,RC                                                            
CPGMX    DS    0H                                                               
         MVC   TSARREC,SMWORK1                                                  
         MVC   TXNUM,SMTXNUM                                                    
         B     EXIT                                                             
*                                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
         DROP  R4                                                               
*                                                                               
***********************************************************************         
* CHECK TO SEE IF ZERO SPOTS, IF SO, SUPPRESS FROM DISPLAY                      
***********************************************************************         
         USING SMWORKD,R4                                                       
ZEROSPT  NTR1  BASE=*,WORK=(R4,SMWORKQ),LABEL=*                                 
         MVC   SMWORK1,TSARREC                                                  
         MVC   SMTXNUM,TXNUM                                                    
*                                                                               
         OC    TR.TLBYRSPT,TR.TLBYRSPT  ZERO REP SPOTS?                         
         BNZ   ZSPTNO                                                           
         OC    TR.TLBYASPT,TR.TLBYASPT  ZERO AGY SPOTS?                         
         BNZ   ZSPTNO              NO                                           
*                                                                               
         TM    TR.TLBYFLG4,X'44'   CANCELLATION                                 
         BNZ   ZSPTYES                                                          
*                                                                               
         CLI   TR.TLBYFLG,TLUMTHQ  UNMATCH SEGMENT?                             
         BE    ZSPTYES             YES, HIDE FROM DISPLAY                       
*                                                                               
         CLI   TR.TLBYFLG,TLLNKQ                                                
         BNE   ZSPTNO              NOT LINK - SKIP                              
*                                                                               
         CLI   TR.TLBYLNK,0        NO LINK                                      
         BE    ZSPTNO              NEXT                                         
*                                                                               
         TM    TR.TLBYFLG3,X'10'   MATCHED DAILY/C.O FORCE TO BE LINK?          
         BO    ZSPTNO              DON'T COMPARE                                
*                                                                               
SEG2     USING TLSTD,SMWORK1                                                    
*                                                                               
ZSPT35   DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
*                                                                               
         MVI   TR.TLKTYP,X'0B'                                                  
         MVI   TR.TLBYFLG,TLLNKQ                                                
         MVI   TR.TLBYTYPA,TLTYPAQ                                              
         MVC   TR.TLBYLNK,SEG2.TLBYLNK                                          
         MVC   SAVEKEY(L'TSARKEY),TSARREC+2                                     
*                                                                               
         GOTO1 GOTSAR,TSARDH                                                    
         CLC   TSARREC+2(TLBYMLNK-TLKTYP),SAVEKEY                               
         BE    ZSPT50              SAME GROUP                                   
*                                                                               
         CLI   SEG2.TLBYMLNK,0     DAILY BUYS IS OK                             
         BNE   ZSPTYES                                                          
         DC    H'0'                                                             
*                                                                               
ZSPT50   DS    0H                                                               
         OC    TR.TLBYASPT,TR.TLBYASPT  ZERO AGY SPOTS?                         
         BNZ   ZSPTNO              NO                                           
*                                                                               
ZSPTYES  SR    RC,RC                                                            
ZSPTNO   LTR   RC,RC                                                            
ZSPTX    DS    0H                                                               
         MVC   TSARREC,SMWORK1                                                  
         MVC   TXNUM,SMTXNUM                                                    
         B     EXIT                                                             
*                                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
         DROP  R4                                                               
*&&DO                                                                           
*********************************************************************           
* IS THIS THE LAST GROUP IN A DAILY BUY/COST OVERRIDE BUY GROUP                 
* P1:TSAR NUMBER OF THE CURRENT BUY SEGMENT                                     
*********************************************************************           
         USING SMWORKD,R4                                                       
LASTGRP  NTR1  BASE=*,WORK=(R4,SMWORKQ),LABEL=*                                 
         MVC   SMWORK1,TSARREC                                                  
         MVC   SMTXNUM,TXNUM                                                    
*                                                                               
         MVC   TXNUM,0(R1)                                                      
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSAGET                                                    
         BNE   LASTYES                                                          
*        DC    H'0'                                                             
         MVC   SMWORK2,TSARREC                                                  
         XC    TSARREC,TSARREC                                                  
*                                                                               
LAST10   DS    0H                                                               
         GOTO1 GOTSAR,TSANXT                                                    
         CLC   TSARREC+2(TLBYMLNK-TLKTYP),SMWORK2+2                             
         BNE   LASTYES             LAST LINE OF THE GROUP                       
         TM    TR.TLBYFLG3,X'80'                                                
         BO    LAST10              LOOP                                         
         B     LASTNO              NOT END OF GROUP                             
*                                                                               
LASTYES  SR    RC,RC                                                            
LASTNO   LTR   RC,RC                                                            
         MVC   TSARREC,SMWORK1                                                  
         MVC   TXNUM,SMTXNUM                                                    
         B     EXIT                                                             
*                                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
         DROP  R4                                                               
*&&                                                                             
***********************************************************************         
* DISPLAY SECTION HEADER FOR MATCH/UNMATCH/LINK                                 
***********************************************************************         
DISECTN  NTR1  BASE=*,LABEL=*                                                   
         L     R8,ASPOOLD                                                       
         USING SPOOLD,R8                                                        
         CLM   RF,8,=AL1(1)        DISPLAY MATCH SECTION?                       
         BE    DSCT0350                                                         
         MVC   BYTE,DISFLG2                                                     
*                                                                               
         L     R2,0(R1)                                                         
         MVC   WORK(L'TR.TLBYFLG),TR.TLBYFLG                                    
         MVC   WORK+L'TR.TLBYFLG(L'LFLAG),LFLAG                                 
         CLI   TR.TLBYFLG,TLLNKQ                                                
         BE    *+10                                                             
         MVC   WORK+L'TR.TLBYFLG(L'MFLAG),MFLAG                                 
*                                                                               
         LA    R3,MTABLE                                                        
DSCT0050 DS    0H                                                               
         CLI   0(R3),X'FE'         FE = TABLE TERMINATING CHAR                  
         BE    DSCT0100                                                         
         CLC   0(2,R3),WORK                                                     
         BE    DSCT0200                                                         
         LA    R3,3(R3)                                                         
         B     DSCT0050                                                         
DSCT0100 DS    0H                                                               
         DC    H'0'                                                             
DSCT0200 DS    0H                                                               
         MVC   WORK(23),=CL23'UNMATCHED LINES:       '                          
         CLI   2(R3),C'U'                                                       
         BNE   DSCT0300                                                         
         MVI   DISFLG2,DUMATCHQ                                                 
         B     DSCT0400                                                         
*                                                                               
DSCT0300 DS    0H                                                               
         MVC   WORK(23),=CL23'PROPOSED MATCHED LINES:'                          
         CLI   2(R3),C'P'                                                       
         BNE   DSCT0350                                                         
         MVI   DISFLG2,DPMATCHQ                                                 
         B     DSCT0400                                                         
*                                                                               
DSCT0350 DS    0H                  MATCH                                        
         CLI   2(R3),C'M'                                                       
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   WORK(23),=CL23'MATCHED LINES:'                                   
         MVI   DISFLG2,DMATCHQ                                                  
         OI    DISFLG1,D1MATCHQ                                                 
         TM    FLAGS,FGPRTQ                                                     
         BO    DSCT0400            IF NOT PRINTING                              
         CLC   SCRNUM,=H'1'        DON'T DUP-DISPLAY ON FIRST PAGE              
         BE    DSCT0500                                                         
*                                                                               
DSCT0400 DS    0H                                                               
         TM    FLAGS,FGPRTQ        ONE LINE BREAK FOR PRINT OUT                 
         BO    DSCT0455                                                         
*                                                                               
DSCT0420 DS    0H                                                               
         CLC   SCRNUM,=H'1'                                                     
         BE    DSCT0430                                                         
         LA    RF,DIFLISTH         IF THIS IS THE FIRST LINE ON THE             
         CR    RF,R2               SCREEN                                       
         BE    DSCT0450            DON'T SKIP A LINE                            
*                                                                               
DSCT0430 DS    0H                                                               
         LA    R2,LISTLEN(R2)                                                   
*                                                                               
DSCT0450 DS    0H                                                               
         LA    RF,DIFEND                                                        
         SHI   RF,LISTLEN                                                       
         CR    R2,RF                                                            
         BH    DSCTNO              EXIT                                         
*                                                                               
DSCT0455 DS    0H                                                               
         USING DIFFSUM,R2                                                       
*&&DO                                                                           
         MVI   DSCOLOR,NOCOLOR                                                  
         TM    STEREOFG,STFINUSE   NO COLOR FOR HEADING                         
         BO    *+8                                                              
         MVI   DSCOLOR,C' '                                                     
*&&                                                                             
         GOTOR DISCOLOR,NOCOLOR                                                 
*                                                                               
         MVC   DSLINE(23),WORK                                                  
         CLI   DISFLG2,DPMATCHQ                                                 
         BNE   *+10                                                             
         MVC   DSLINE+24(PMATCH1Q),PMATCH1                                      
         OI    DSLINEH+1,X'08'     HIGH INTENSITY                               
*                                                                               
         TM    FLAGS,FGPRTQ                                                     
         BZ    DSCT0460                                                         
         MVC   P(24+PMATCH1Q),DSLINE                                            
         BAS   RE,PRINT                                                         
         B     DSCTYES                                                          
*                                                                               
DSCT0460 DS    0H                                                               
         DROP  R2                                                               
         LA    R2,LISTLEN(R2)                                                   
*                                                                               
DSCT0500 DS    0H                                                               
DSCTYES  SR    R5,R5                                                            
         B     DSCTX                                                            
DSCTNO   LTR   R5,R5                                                            
         MVC   DISFLG2,BYTE                                                     
DSCTX    DS    0H                                                               
         ST    R2,DMCB                                                          
         B     EXIT                                                             
         DROP  R8                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
MTABLE   DS    0C                                                               
         DC    C'M',C'A',C'M'                                                   
         DC    C'M',C'P',C'M'                                                   
         DC    C'M',C'U',C'M'                                                   
         DC    C'Q',C'A',C'P'                                                   
         DC    C'Q',C'P',C'P'                                                   
         DC    C'Q',C'U',C'U'                                                   
         DC    C'T',C'A',C'M'                                                   
         DC    C'T',C'P',C'P'                                                   
         DC    C'T',C'U',C'U'                                                   
         DC    X'FF',C'A',C'U'                                                  
         DC    X'FF',C'P',C'U'                                                  
         DC    X'FF',C'U',C'U'                                                  
         DC    X'FE'                                                            
MTABLEQ  EQU   *-MTABLE                                                         
PMATCH1  DC    C'MUST INPUT "M" AND THE AGY LINE# TO APPROVE'                   
PMATCH1Q EQU   *-PMATCH1                                                        
***********************************************************************         
* BUILD SCROLL LINE TSAR RECORD                                                 
***********************************************************************         
*                                                                               
BLDSCREC NTR1  BASE=*,WORK=(R4,DLWORKQ),LABEL=*                                 
         USING DLWORKD,R4                                                       
         MVC   DLWORK,TSARREC                                                   
*                                                                               
         LH    RF,SCRNUM           INCREASE LINE COUNTER                        
         LA    RF,1(RF)                                                         
         STH   RF,SCRNUM                                                        
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,C'W'      SCROLL RECORD                                
         MVC   TR.TLSCKEY,SCRNUM                                                
         MVC   TR.TLSCPTR,TB.TSRNUM                                             
*                                                                               
         TM    DISFLG1,DCONTEEQ                                                 
         BZ    *+14                                                             
         OI    TR.TLSCFLG,X'80'                                                 
         MVC   TR.TLSCCTYP,TYP                                                  
*                                                                               
         TM    DISFLG3,D3ORBAG                                                  
         BZ    *+8                                                              
         OI    TR.TLSCFLG,X'40'                                                 
*                                                                               
         MVC   TR.TLSCBY#,BUY#                                                  
         MVC   TR.TLSCSUBL,SUBBUY#                                              
         MVC   TR.TLSCTYP,SVTYPE                                                
         MVC   TR.TLSCFLG2,DISFLG2                                              
*                                                                               
                                                                                
         MVC   TR.TLLEN,=Y(TLSCLQ)                                              
         GOTO1 GOTSAR,TSAADD                                                    
         TM    TB.TSERRS,TSEDUP                                                 
         BZ    BLDSCRCX                                                         
         MVC   DLWORK2,TSARREC                                                  
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   TSARREC,DLWORK2                                                  
         GOTO1 GOTSAR,TSAWRT                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
BLDSCRCX DS    0H                                                               
         MVC   TSARREC,DLWORK                                                   
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
         DROP  R4                                                               
***********************************************************************         
* GET  SCROLL LINE TSAR RECORD                                                  
***********************************************************************         
*                                                                               
GETSCREC NTR1  BASE=*,WORK=(R4,DLWORKQ),LABEL=*                                 
         USING DLWORKD,R4                                                       
         MVC   DLWORK,TSARREC                                                   
         L     R2,0(R1)                                                         
*&&DO                                                                           
         LH    RF,0(R2)                                                         
         CLI   RF,0                                                             
         BNE   *+12                                                             
         LHI   RF,1                                                             
         STH   RF,0(R2)                                                         
*&&                                                                             
         MVI   TR.TLKTYP,C'W'      SCROLL RECORD                                
         MVC   TR.TLSCKEY,0(R2)                                                 
         GOTO1 GOTSAR,TSARDH                                                    
         BNE   GSCRNO                                                           
*                                                                               
         MVC   DMCB(TLSCLQ2),TR.TLSCPTR                                         
GSCRYES  SR    RF,RF                                                            
GSCRNO   LTR   RF,RF                                                            
GSCRLX   DS    0H                                                               
         MVC   TSARREC,DLWORK                                                   
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
         DROP  R4                                                               
**********************************************************************          
* BUILD MATCH TABLE                                                             
* P1 = A(SEGMENT TSAR RECORD)                                                   
* THIS WILL BUILD MATCH RECORD FOR MATCH SEGMENT + LINK SEGMENT (IF             
* PROFILE FLAG IS SET TO ASSUME MATCH FOR LINK BUYS)                            
**********************************************************************          
BLDMTAB  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         SR    R3,R3                                                            
         SR    RF,RF                                                            
         L     R3,AEOTBLE          AEOTBLE IS UNSTABLE BETWEEN                  
         LA    RF,MTCHTAB          TRANSACTION                                  
         SR    R3,RF                                                            
         ST    R3,AEOTBLE          SO SAVE DISPLACEMENT INSTEAD                 
*                                                                               
         LA    R3,MTCHTAB                                                       
         A     R3,AEOTBLE                                                       
         USING MTCHTABD,R3                                                      
*                                                                               
         XC    TSARREC,TSARREC                                                  
         XC    TSARREC2,TSARREC2                                                
TR2      USING TLSTD,TSARREC2                                                   
         MVI   TR.TLKTYP,X'0B'                                                  
         GOTO1 GOTSAR,TSARDH                                                    
         BL    BLDM0600                                                         
*                                                                               
BLDM0030 DS    0H                                                               
         XC    BYTE,BYTE                                                        
         CLI   TR.TLBYFLG,TLMTHQ2  ANYTHING => TYPE "T" IS IGNORED              
         BH    BLDMX               EXIT                                         
*        TM    TR.TLBYFLG3,X'80'   TOTALLY MATCH?                               
*        BO    BLDM0050            YES,CHECK FOR DAILY BUY                      
         TM    TR.TLBYFLG3,X'80'   TOTALLY MATCH?                               
         BZ    BLDM0034            YES,CHECK FOR DAILY BUY                      
         TM    TR.TLBYFLG3,X'01'   DAILY BUY GROUP NOT TOTALLY MATCH?           
         BZ    BLDM0050            NO, PROCESS                                  
*                                                                               
BLDM0034 DS    0H                                                               
         CLI   TR.TLBYFLG,TLMTHQ   TYPE MATCH?                                  
         BE    BLDM0050            YES,PROCESS THIS RECORD                      
         CLI   TR.TLBYFLG,TLMTHQ3  TYPE TOTALLY MATCH?                          
         BE    BLDM0050            YES,PROCESS THIS RECORD                      
         CLI   TR.TLBYFLG,TLLNKQ   TYPE LINK?                                   
         BNE   BLDM0550            NO,NEXT RECORD                               
*                                                                               
         CLI   TR.TLBYTYPA,C'A'                                                 
         BE    BLDM0550            AGENCY PART OF THE LINK PAIR?                
         CLI   LFLAG,LASSUMEQ                                                   
         BNE   BLDM0550            ASSUME MATCH                                 
*                                                                               
BLDM0040 DS    0H                                                               
         OC    TR.TLBYLNK,TR.TLBYLNK                                            
         BNZ   BLDM0050            NO LINK NUMBER?                              
         OC    TR.TLBYALNK,TR.TLBYALNK                                          
         BNZ   *+6                 IS THIS AN ACTUALLY MATCH                    
         DC    H'0'                THAT GOT TURNED INTO A PROPOSED?             
         OC    TR.TLBYRLNK,TR.TLBYRLNK                                          
         BNZ   *+6                                                              
         DC    H'0'                                                             
*                                                                               
BLDM0050 DS    0H                                                               
         MVC   SVTSAR#,TB.TSRNUM   SAVE OFF SEGMENT TSAR #                      
         ST    R3,FULL             SAVE OFF CURRENT TABLE ENTRY                 
         MVC   TSARREC2,TSARREC                                                 
*                                                                               
         TM    TR2.TLBYFLG4,X'44'  CANCELLED DAILYS                             
         BZ    BLDM0051                                                         
         MVC   ABUY#,TR2.TLBYMLNK  YES, STICK IN DAILY GROUP NUMBER             
         B     BLDM0200                                                         
*                                                                               
BLDM0051 OC    TR.TLBYALNK,TR.TLBYALNK                                          
         BNZ   BLDM0056                                                         
         CLI   TR.TLBYFLG,TLLNKQ   IF LINK SEGMENT                              
         BNE   BLDM0056                                                         
*** TRAP ERROR                                                                  
         CLI   TR.TLBYLNK,0                                                     
         BNE   *+6                                                              
         DC    H'0'                                                             
*                                                                               
*** TRAP ERROR                                                                  
         MVI   TR.TLBYTYPA,TLTYPAQ                                              
*                                  READ THE AGENCY PART OF THE LINK             
         XC    TR.TLBYMLNK(L'TLKEY-(TLBYMLNK-TLKEY)),TR.TLBYMLNK                
         MVC   SAVEKEY,TSARREC                                                  
         GOTO1 GOTSAR,TSARDH                                                    
         CLC   SAVEKEY+2(TLBYMLNK-TLKEY),TSARREC+2                              
         BE    BLDM0054                                                         
         OC    TR2.TLBYMLNK,TR2.TLBYMLNK                                        
         BZ    BLDM0052            DAILY BUYS?                                  
         MVC   ABUY#,TR2.TLBYMLNK  YES, STICK IN DAILY GROUP NUMBER             
         B     BLDM0200                                                         
BLDM0052 DS    0H                                                               
         DC    H'0'                                                             
*                                                                               
BLDM0054 DS    0H                                                               
         TM    TR.TLBYAFLG,X'40'                                                
         BZ    BLDM0100                                                         
*                                                                               
         MVC   HALF,TR.TLBYALNK                                                 
         XC    TSARREC,TSARREC                                                  
         MVC   TR.TLBLINDX,HALF                                                 
         B     BLDM0058                                                         
*                                                                               
BLDM0056 DS    0H                                                               
         TM    TR.TLBYAFLG,X'40'   TLBYALNK IS A LINK POINTER?                  
         BZ    BLDM0100            NO                                           
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TR.TLBLINDX,TR2.TLBYALNK                                         
*                                                                               
BLDM0058 DS    0H                                                               
         MVI   TR.TLKTYP,C'A'                                                   
         GOTO1 GOTSAR,TSARDH       YES,READ BUYLINK RECORD                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R4,TR.TLBLBUY#                                                   
         USING TLBLBUY#,R4                                                      
BLDM0060 DS    0H                                                               
*** TRAP ERROR                                                                  
         OC    TR.TLBLBUY#,TR.TLBLBUY#                                          
         BNZ   *+6                                                              
         DC    H'0'                                                             
*** TRAP ERROR                                                                  
         MVC   ABUY#,TLBLBUY#                                                   
*                                                                               
         LA    R4,TLBLLENQ(R4)                                                  
         CLI   TLBLBUY#,0                                                       
         BE    BLDM0070                                                         
         LA    R3,MTCHTABL(R3)                                                  
         B     BLDM0060                                                         
BLDM0070 DS    0H                                                               
*        MVC   TSARREC2,TSARREC    RESTORE TSARREC                              
         B     BLDM0150                                                         
         DROP  R4                                                               
*                                                                               
BLDM0100 DS    0H                                                               
*** TRAP ERROR                                                                  
*        OC    TR.TLBYALNK,TR.TLBYALNK                                          
*        BNZ   *+6                                                              
*        DC    H'0'                                                             
*** TRAP ERROR                                                                  
         OC    TR.TLBYALNK,TR.TLBYALNK                                          
         BZ    CALLDDS             STOP!                                        
*                                                                               
         MVC   ABUY#,TR.TLBYALNK   NO, INSERT BUYLINE NUMBER                    
*                                                                               
BLDM0150 DS    0H                                                               
         MVC   MTCHTABL(L'GRPTERM2,R3),GRPTERM2 INSERT GROUP TERMINATOR         
*                                                                               
BLDM0200 DS    0H                                                               
         MVC   TSARREC,TSARREC2    RESTORE TSARREC                              
         L     R3,FULL                                                          
         TM    TR.TLBYRFLG,X'40'   TLBYRLNK IS A LINK POINTER?                  
         BZ    BLDM0280                                                         
*                                                                               
         MVC   TSARREC2,TSARREC                                                 
         XC    TSARREC,TSARREC                                                  
         MVC   TR.TLBLINDX,TR2.TLBYRLNK                                         
         MVI   TR.TLKTYP,C'R'                                                   
         GOTO1 GOTSAR,TSARDH       YES,READ BUYLINK RECORD                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R4,TR.TLBLBUY#                                                   
         USING TLBLBUY#,R4                                                      
BLDM0260 DS    0H                                                               
         CLC   ABUY#(L'TABTERM),TABTERM                                         
         BNE   *+8                                                              
         MVI   ABUY#,GRPTERM        TERMINATING ALL BLANKS                      
*** TRAP ERROR                                                                  
         OC    TR.TLBLBUY#,TR.TLBLBUY#                                          
         BNZ   *+6                                                              
         DC    H'0'                                                             
*** TRAP ERROR                                                                  
         MVC   RBUY#,TLBLBUY#                                                   
*                                                                               
         LA    R4,TLBLLENQ(R4)                                                  
         CLI   TLBLBUY#,0                                                       
         BE    BLDM0270                                                         
         LA    R3,MTCHTABL(R3)                                                  
         B     BLDM0260                                                         
BLDM0270 DS    0H                                                               
         B     BLDM0300                                                         
*                                                                               
BLDM0280 DS    0H                                                               
*** TRAP ERROR                                                                  
         OC    TR.TLBYRLNK,TR.TLBYRLNK                                          
         BNZ   *+6                                                              
         DC    H'0'                                                             
*** TRAP ERROR                                                                  
         MVC   RBUY#,TR.TLBYRLNK   NO, INSERT BUYLINE NUMBER                    
*                                                                               
BLDM0300 DS    0H                                                               
         LA    R3,MTCHTABL(R3)                                                  
         MVI   RBUY#,GRPTERM        INSERT GROUP TERMINATOR                     
         CLC   ABUY#(L'TABTERM),TABTERM                                         
         BNE   BLDM0320                                                         
         MVI   ABUY#,GRPTERM                                                    
         LA    R3,MTCHTABL(R3)     NEXT AVAILABLE GROUP                         
         B     BLDM0380                                                         
*                                                                               
BLDM0320 DS    0H                                                               
         LA    R3,MTCHTABL(R3)     NEXT AVAILABLE GROUP                         
BLDM0330 DS    0H                                                               
         CLC   ABUY#(L'TABTERM),TABTERM                                         
         BE    BLDM0350                                                         
         MVI   RBUY#,GRPTERM                                                    
         LA    R3,MTCHTABL(R3)                                                  
         B     BLDM0330                                                         
BLDM0350 DS    0H                                                               
         LA    R3,MTCHTABL(R3)                                                  
BLDM0380 DS    0H                                                               
*                                                                               
BLDM0500 DS    0H                                                               
         MVC   TXNUM,SVTSAR#                                                    
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSAGET                                                    
         TM    TB.TSERRS,TSERNF                                                 
         BZ    *+6                                                              
         DC    H'0'                                                             
         MVC   BYTE,TR.TLBYMLNK                                                 
BLDM0550 DS    0H                                                               
         GOTO1 GOTSAR,TSANXT                                                    
         BL    BLDM0600                                                         
         CLI   TR.TLKTYP,X'0B'                                                  
         BNE   BLDM0600            NO MORE BUY SEGMENT - EXIT!                  
         OC    TR.TLBYMLNK,TR.TLBYMLNK                                          
         BZ    BLDM0030            NON-DAILY - SKIP!                            
         CLC   BYTE,TR.TLBYMLNK                                                 
         BNE   BLDM0030            DIFFERENT DAILY GROUP - SKIP                 
         SHI   R3,MTCHTABL         NEXT BUY SAME GROUP, BACK TABLE UP           
         B     BLDM0030                                                         
BLDM0600 DS    0H                                                               
*                                                                               
BLDMX    DS    0H                                                               
         B     EXIT                                                             
         DROP  R3,R4                                                            
**********************************************************************          
* BUILD BUYLINE->SEGMENT REVERSE POINTER                                        
* ALSO COMPARES SPOTS WITHIN A SEGMENT                                          
* IF AGY DATES/SPOTS = REP DATES/SPOTS, THEN THIS SEGMENT WILL NOT              
* MAKE IT TO THE DISPLAY                                                        
* P1 - BYTE 1 = FLAG                                                            
*               X'80' = DON'T INITIALIZE OR CHANGE EARLIEST,LATEST              
**********************************************************************          
BLDRPTR  NTR1  BASE=*,WORK=(R3,BLWORKQ),LABEL=*                                 
         USING BLWORKD,R3                                                       
         NI    DISPFLGS,FF-DFUAGYL                                              
         MVC   BLBYTE2,0(R1)                                                    
*                                                                               
         XC    TSARREC,TSARREC                                                  
         XC    TSARREC2,TSARREC2                                                
         XC    BLWORK2,BLWORK2                                                  
         XC    BLWORK,BLWORK                                                    
*                                                                               
         TM    BLBYTE2,X'80'                                                    
         BO    BPTR0020                                                         
         MVC   EARLIEST,=XL3'FFFFFF'                                            
         XC    LATEST,LATEST                                                    
*                                                                               
BPTR0020 DS    0H                                                               
TR2      USING TLSTD,TSARREC2                                                   
TR3      USING TLSTD,BLWORK2                                                    
         MVI   TR.TLKTYP,X'0B'                                                  
         GOTO1 GOTSAR,TSARDH                                                    
         BL    BPTRX               EXIT                                         
*                                                                               
BPTR0030 CLI   TR.TLBYMLNK,0                                                    
         BE    BPTR0032                                                         
         CLI   TR.TLBYFLG,TLMTHQ3  SKIP TOTALLY MATCH DAILYS                    
         BE    BPTR0580                                                         
*                                                                               
BPTR0032 XC    BLBYTE,BLBYTE                                                    
         XC    BLHALF1,BLHALF1                                                  
         XC    BLHALF2,BLHALF2                                                  
         MVC   GERLIEST,=XL3'FFFFFF'                                            
         XC    GLATEST,GLATEST                                                  
*                                                                               
         LA    RE,BLIO                                                          
         XCEFL (RE),1000                                                        
*                                                                               
         MVC   SVTSAR#,TB.TSRNUM   SAVE OFF SEGMENT TSAR #                      
         MVC   TSARREC2,TSARREC                                                 
*                                                                               
         OC    TR2.TLBYALNK,TR2.TLBYALNK                                        
         BZ    BPTR0070            EXIT IF NULL                                 
*                                                                               
         TM    TR2.TLBYAFLG,X'40'  TLBYALNK IS A LINK POINTER?                  
         BZ    BPTR0061            NO                                           
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TR.TLBLINDX,TR2.TLBYALNK                                         
         MVI   TR.TLKTYP,C'A'                                                   
         GOTO1 GOTSAR,TSARDH       YES,READ BUYLINK RECORD                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   BLWORK2,TSARREC     BUILD REVERSE POINTER                        
         LA    R4,TR3.TLBLBUY#                                                  
         USING TLBLBUY#,R4                                                      
*                                                                               
BPTR0060 DS    0H                                                               
         SR    RF,RF                                                            
         ICM   RF,3,TLBL#SPT                                                    
         AH    RF,BLHALF1          CUMULATE AGENCY SPOT NUMBER                  
         STH   RF,BLHALF1                                                       
*                                                                               
BPTR0061 DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,X'0E'                                                  
         MVI   TR.TLBPTYP,C'A'                                                  
*                                                                               
         MVC   TR.TLBPBUY#,TR2.TLBYALNK                                         
         MVC   TR.TLBPMLNK,TR2.TLBYMLNK                                         
*                                                                               
         MVC   BLHALF(1),TR2.TLBYALNK                                           
         MVC   BLHALF+1(1),TR2.TLBYASUB                                         
         TM    TR2.TLBYAFLG,X'40'                                               
         BZ    BPTR0063                                                         
         MVC   TR.TLBPBUY#,TLBLBUY#                                             
         MVC   BLHALF,TLBLBUY#                                                  
         MVC   BLHALF+1(1),TLBLSUB#                                             
*                                                                               
BPTR0063 DS    0H                                                               
         GOTOR SUMSPOT,DMCB,(C'A',BLHALF),BLIO                                  
*                                                                               
         TM    BLBYTE2,X'40'       DON'T BUILD REVERSE POINTER?                 
         BO    BPTR0068                                                         
         TM    TR2.TLBYFLG4,X'10'  ADD-TO-SKED?                                 
         BO    BPTR0068            YES - SKIP!                                  
*                                                                               
         MVC   TR.TLBPSEG#,SVTSAR# SAVE SEGMENT NUMBER                          
*** TRAP ERROR                                                                  
         OC    TR.TLBPBUY#,TR.TLBPBUY#                                          
         BNZ   *+6                                                              
         DC    H'0'                                                             
         OC    TR.TLBPSEG#,TR.TLBPSEG#                                          
         BNZ   *+6                                                              
         DC    H'0'                                                             
*** TRAP ERROR                                                                  
         MVC   TR.TLLEN,=Y(TLBPLQ)                                              
         MVC   BLWORK,TSARREC                                                   
*                                                                               
         GOTO1 GOTSAR,TSARDH                                                    
         MVC   TSARREC,BLWORK                                                   
         BE    BPTR0065            TESTING CC OF THE GOTSAR CALL                
*                                                                               
         GOTO1 GOTSAR,TSAADD                                                    
         BE    BPTR0068                                                         
         DC    H'0'                                                             
*                                                                               
BPTR0065 DS    0H                                                               
*        MVC   TSARREC,BLWORK                                                   
         GOTO1 GOTSAR,TSAWRT                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
BPTR0068 DS    0H                                                               
         TM    TR2.TLBYAFLG,X'40'  ONLY ADD ONE TSAR RECORD                     
         BZ    BPTR0070            IF THIS IS NOT A BUY LINK                    
*                                                                               
         LA    R4,TLBLLENQ(R4)                                                  
         CLI   TLBLBUY#,0                                                       
         BNE   BPTR0060                                                         
BPTR0070 DS    0H                                                               
*                                                                               
BPTR0200 DS    0H                                                               
         OC    TR2.TLBYRLNK,TR2.TLBYRLNK                                        
         BZ    BPTR0270            EXIT IF NULL                                 
         TM    TR2.TLBYRFLG,X'40'  TLBYRLNK IS A LINK POINTER?                  
         BZ    BPTR0261                                                         
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TR.TLBLINDX,TR2.TLBYRLNK                                         
         MVI   TR.TLKTYP,C'R'                                                   
         GOTO1 GOTSAR,TSARDH       YES,READ BUYLINK RECORD                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   BLWORK2,TSARREC     BUILD REVERSE POINTER                        
         LA    R4,TR3.TLBLBUY#                                                  
         USING TLBLBUY#,R4                                                      
*                                                                               
BPTR0260 DS    0H                                                               
         SR    RF,RF                                                            
         ICM   RF,3,TLBL#SPT                                                    
         AH    RF,BLHALF2          CUMULATE REP SPOT NUMBER                     
         STH   RF,BLHALF2                                                       
*                                                                               
BPTR0261 DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,X'0E'                                                  
         MVI   TR.TLBPTYP,C'R'                                                  
*                                                                               
         MVC   TR.TLBPMLNK,TR2.TLBYMLNK                                         
         MVC   TR.TLBPBUY#,TR2.TLBYRLNK                                         
*                                                                               
         XC    BLHALF,BLHALF                                                    
         MVC   BLHALF(1),TR2.TLBYRLNK                                           
         TM    TR2.TLBYRFLG,X'40'                                               
         BZ    *+16                                                             
         MVC   BLHALF(1),TLBLBUY#                                               
         MVC   TR.TLBPBUY#,TLBLBUY#                                             
*                                                                               
         GOTOR SUMSPOT,DMCB,(C'R',BLHALF),BLIO+L'TSARREC                        
*                                                                               
         TM    BLBYTE2,X'40'       DON'T BUILD REVERSE POINTER?                 
         BO    BPTR0268                                                         
         MVC   TR.TLBPSEG#,SVTSAR# SAVE SEGMENT NUMBER                          
*                                                                               
*** TRAP ERROR                                                                  
         CLI   TR.TLBPBUY#,0                                                    
         BNE   *+6                                                              
         DC    H'0'                                                             
         OC    TR.TLBPSEG#,TR.TLBPSEG#                                          
         BNZ   *+6                                                              
         DC    H'0'                                                             
*** TRAP ERROR                                                                  
*                                                                               
         MVC   TR.TLLEN,=Y(TLBPLQ)                                              
         MVC   BLWORK,TSARREC                                                   
*                                                                               
         GOTO1 GOTSAR,TSARDH                                                    
         MVC   TSARREC,BLWORK                                                   
         BE    BPTR0265                                                         
*                                                                               
         GOTO1 GOTSAR,TSAADD                                                    
         BE    BPTR0268                                                         
         DC    H'0'                                                             
*                                                                               
BPTR0265 DS    0H                                                               
         GOTO1 GOTSAR,TSAWRT                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
BPTR0268 DS    0H                                                               
         TM    TR2.TLBYRFLG,X'40'  ONLY ADD ONE TSAR RECORD                     
         BZ    BPTR0270            IF THIS IS NOT A BUY LINK                    
*                                                                               
         LA    R4,TLBLLENQ(R4)                                                  
         CLI   TLBLBUY#,0                                                       
         BNE   BPTR0260                                                         
BPTR0270 DS    0H                                                               
*                                                                               
BPTR0500 DS    0H                                                               
         MVC   TXNUM,SVTSAR#                                                    
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSAGET                                                    
         TM    TB.TSERRS,TSERNF                                                 
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    RE,BLIO                                                          
         LR    RF,RE                                                            
         LA    RF,L'TSARREC(RF)                                                 
         CLC   0(TLGRLQ2,RE),0(RF)                                              
         LA    R0,TLGRWKQ                                                       
*                                                                               
BPTR0510 DS    0H                                                               
AGRID    USING TLGSTD,RE                                                        
RGRID    USING TLGSTD,RF                                                        
         OC    TR2.TLBYALNK,TR2.TLBYALNK                                        
         BZ    BPTR0530                                                         
         OC    TR2.TLBYRLNK,TR2.TLBYRLNK                                        
         BZ    BPTR0530                                                         
*                                                                               
         CLC   AGRID.TLGTOT,=X'0000'                                            
         BNE   BPTR0515                                                         
         CLC   RGRID.TLGTOT,=X'0000'                                            
         BE    BPTR0520            BOTH ARE ZEROS, COMPLETE MATCH               
*                                                                               
BPTR0515 DS    0H                                                               
         CLC   AGRID.TLGSTD,RGRID.TLGSTD                                        
         BNE   BPTR0530                                                         
         CLC   AGRID.TLGTOT,RGRID.TLGTOT                                        
         BNE   BPTR0530                                                         
*                                                                               
         LA    RE,AGRID.TLGRID                                                  
         LA    RF,RGRID.TLGRID                                                  
         DROP  AGRID,RGRID                                                      
*                                                                               
BPTR0518 DS    0H                                                               
         CLC   0(1,RE),0(RF)                                                    
         BNE   BPTR0530                                                         
         LA    RE,TLGRSIZE(RE)                                                  
         LA    RF,TLGRSIZE(RF)                                                  
         BCT   R0,BPTR0518                                                      
*                                                                               
BPTR0520 DS    0H                                                               
         OI    TR.TLBYFLG3,X'80'   SKIP THIS BUY SEGMENT ON DISPLAY             
*                                  SINCE BUYLINES MATCH UP IN EVERY             
*                                  ASPECTS                                      
         OI    BLBYTE,X'80'        SET UPDATE FLAG                              
*                                                                               
BPTR0530 DS    0H                                                               
*&&TT                                                                           
         CLI   TR2.TLBYALNK,5                                                   
         BNE   *+6                                                              
         DC    X'0770'                                                          
*&&                                                                             
                                                                                
         OC    BLHALF1(4),BLHALF1  UPDATE TOTAL SPOTS IN                        
         BZ    *+8                 BUY SEGMENT RECORD                           
         OI    BLBYTE,X'40'                                                     
*                                                                               
         OC    BLHALF1,BLHALF1                                                  
         BZ    *+10                                                             
         MVC   TR.TLBYASPT,BLHALF1                                              
*                                                                               
         OC    BLHALF2,BLHALF2                                                  
         BZ    *+10                                                             
         MVC   TR.TLBYRSPT,BLHALF2                                              
*                                                                               
BPTR0540 DS    0H                                                               
         TM    BLBYTE,X'80'+X'40'  UPDATE BUY SEGMENT?                          
         BZ    BPTR0550            NO                                           
*                                                                               
         GOTO1 GOTSAR,TSAPUT       ALSO DO NOT TAKE THIS SEGMENT'S              
         BZ    *+6                 START END DATE INTO CONSIDERATION            
         DC    H'0'                                                             
         TM    BLBYTE,X'80'                                                     
         BO    BPTR0570                                                         
*                                                                               
BPTR0550 DS    0H                                                               
         TM    BLBYTE2,X'80'                                                    
         BO    BPTR0570                                                         
*                                                                               
         CLC   EARLIEST,GERLIEST   SET EARLIEST DATE                            
         BNH   *+10                                                             
         MVC   EARLIEST,GERLIEST                                                
*                                                                               
         CLC   LATEST,GLATEST      SET LATEST DATE                              
         BNL   *+10                                                             
         MVC   LATEST,GLATEST                                                   
*                                                                               
BPTR0570 DS    0H                  CHECK TO SEE IF THERE IS UNMATCH             
         TM    TR.TLBYFLG3,X'80'   AGENCY LINES                                 
         BO    BPTR0580            TOTALLY MATCH, SKIP                          
         CLI   TR.TLBYFLG,TLMTHQ   MATCH SEGMENT, SKIP                          
         BE    BPTR0580                                                         
         OC    TR.TLBYALNK,TR.TLBYALNK                                          
         BNZ   BPTR0572            HAS AGENCY LINE - SET FLAG                   
         OC    TR.TLBYMLNK,TR.TLBYMLNK                                          
         BZ    BPTR0580            OR IF THIS IS DAILY -SET FLAG                
BPTR0572 DS    0H                  CHECK TO SEE IF THERE IS UNMATCH             
         OI    DISPFLGS,DFUAGYL    THERE IS AT LEAST ONE UNMATCHED              
*                                  AGENCY LINES                                 
BPTR0580 DS    0H                                                               
         GOTO1 GOTSAR,TSANXT                                                    
         BL    BPTRX                                                            
         CLI   TR.TLKTYP,X'0B'                                                  
         BE    BPTR0030                                                         
*                                                                               
BPTRX    DS    0H                                                               
         B     EXIT                                                             
         DROP  R4                                                               
         DROP  R3                                                               
**********************************************************************          
* ACCUMULATES THE SPOTS IN GRID TO IO FOR COMPARISON                            
* P1 = BUY TYPE + BUY NUMBER                                                    
* P2 = A(IO)                                                                    
**********************************************************************          
SUMSPOT  NTR1  BASE=*,WORK=(R4,DLWORKQ),LABEL=*                                 
         LM    R2,R3,0(R1)                                                      
         USING DLWORKD,R4                                                       
         MVC   DLBYTE,4(R1)                                                     
*                                                                               
IOGRID   USING TLGSTD,R3           IO AREA                                      
         MVC   DLWORK,TSARREC                                                   
         XC    TSARREC,TSARREC                                                  
*                                                                               
         MVI   TR.TLKTYP,X'04'     READ GRID RECORD                             
         MVC   TR.TLGTYP,0(R1)     TYPE                                         
         MVC   TR.TLGLN#(L'TLGLN#+L'TLGSUB#),0(R2)     NUMBER                   
*                                                                               
         MVC   SAVEKEY,TSARREC                                                  
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   GERLIEST,TR.TLGSTD  SET EARLIEST DATE                            
         BNH   *+10                                                             
         MVC   GERLIEST,TR.TLGSTD                                               
*                                                                               
         CLC   GLATEST,TR.TLGEND   SET LATEST DATE                              
         BNL   *+10                                                             
         MVC   GLATEST,TR.TLGEND                                                
*                                                                               
         LA    R6,IOGRID.TLGRID    R6->IO                                       
         LA    R8,TR.TLGRID        R8->TSAR                                     
*                                                                               
         OC    IOGRID.TLGSTD,IOGRID.TLGSTD                                      
         BZ    SSPT0300            FIRST TIME IN                                
         CLC   TR.TLGTOT,=X'0000'  ZERO SPOT, NO NEED TO SUM IT UP              
         BE    SSPTX                                                            
*                                                                               
*                                                                               
*&&DO                                                                           
TEST     USING TLSTD,DLWORK                                                     
         CLC   TEST.TLBPTYP(2),=X'D906'                                         
         BNE   *+6                                                              
         DC    X'0770'                                                          
*&&                                                                             
         CLC   IOGRID.TLGEND,TR.TLGEND                                          
         BNL   SSPT0030                                                         
         MVC   IOGRID.TLGEND,TR.TLGEND                                          
*                                                                               
SSPT0030 DS    0H                  IO STARTS EARLIER THAN TSAR                  
         CLC   IOGRID.TLGSTD,TR.TLGSTD   COMPARE START DATE                     
         BE    SSPT0080                                                         
*                                                                               
         CLC   IOGRID.TLGSTD,TR.TLGSTD                                          
         BL    SSPT0050                                                         
*                                                                               
         XC    IOGRID.TLGSTD(TLGRLQ2),TR.TLGSTD                                 
         XC    TR.TLGSTD(TLGRLQ2),IOGRID.TLGSTD                                 
         XC    IOGRID.TLGSTD(TLGRLQ2),TR.TLGSTD SWAP THE TWO AREA               
*                                                                               
         CLC   IOGRID.TLGEND,TR.TLGEND                                          
         BNL   SSPT0040                                                         
         MVC   IOGRID.TLGEND,TR.TLGEND                                          
*                                                                               
SSPT0040 DS    0H                  IO STARTS EARLIER THAN TSAR                  
*&&DO                                                                           
TEST     USING TLSTD,DLWORK                                                     
         CLC   TEST.TLBPTYP(2),=X'D931'                                         
         BNE   *+6                                                              
         DC    X'0770'                                                          
                                                                                
*&&                                                                             
SSPT0050 DS    0H                  IO STARTS EARLIER THAN TSAR                  
*        ZICM  RE,IOGRID.TLGTOT,2                                               
*        ZICM  RF,TR.TLGTOT,2                                                   
*        AR    RE,RF                                                            
*        STCM  RE,3,IOGRID.TLGTOT                                               
*                                                                               
         GOTOR MYPVAL,DMCB,IOGRID.TLGSTD,TR.TLGSTD                              
         LH    R1,DMCB                                                          
         MHI   R1,TLGRSIZE                                                      
         AR    R6,R1                                                            
*                                                                               
SSPT0080 DS    0H                  SAME START DATE                              
         ZICM  RE,IOGRID.TLGTOT,2                                               
         ZICM  RF,TR.TLGTOT,2                                                   
         AR    RE,RF                                                            
         STCM  RE,3,IOGRID.TLGTOT                                               
*                                                                               
SSPT0100 DS    0H                  SAME START DATE                              
         CLC   0(2,R6),=X'FFFF'    END OF GRID?                                 
         BE    SSPT0400                                                         
         CLC   0(2,R8),=X'FFFF'                                                 
         BE    SSPT0400                                                         
*                                                                               
SSPT0130 DS    0H                  SAME START DATE                              
*                                                                               
         SR    RE,RE               DEFAULT TO ZERO                              
         SR    RF,RF                                                            
         IC    RE,0(R6)                                                         
         IC    RF,0(R8)                                                         
*                                                                               
         AR    RE,RF               FOR ADDITION                                 
         STC   RE,0(R6)                                                         
*                                                                               
SSPT0150 DS    0H                                                               
         LA    R6,TLGRSIZE(R6)                                                  
         LA    R8,TLGRSIZE(R8)                                                  
         B     SSPT0100                                                         
*                                                                               
SSPT0300 DS    0H                                                               
         MVC   0(TLGRLQ2,R3),TR.TLGSTD                                          
*                                                                               
SSPT0400 DS    0H                                                               
         GOTOR SETDATE,DMCB,IOGRID.TLGSTD                                       
         TM    DLBYTE,X'80'        DON'T CHOP GRID                              
         BO    SSPT0500                                                         
*&&DO                                                                           
TEST     USING TLSTD,DLWORK                                                     
         CLC   TEST.TLBPTYP(2),=X'D906'                                         
         BNE   *+6                                                              
         DC    X'0770'                                                          
*&&                                                                             
         GOTOR CHOPGRID,DMCB,(R3)                                               
SSPT0500 DS    0H                                                               
*                                                                               
SSPTX    DS    0H                                                               
         MVC   TSARREC,DLWORK                                                   
         B     EXIT                                                             
         DROP  R4                                                               
         DROP  IOGRID                                                           
***********************************************************************         
* CHOP ZERO SPOT OFF GRID, ADJUST START DATE ACCORDINGLY                        
***********************************************************************         
CHOPGRID NTR1  BASE=*,LABEL=*                                                   
         L     R3,0(R1)                                                         
GD       USING TLGSTD,R3           IO AREA                                      
         CLC   GD.TLGTOT,=X'0000'  DON'T CHOP FOR ZERO SPOT LINES               
         BE    CHOPX                                                            
*                                                                               
         LA    R6,GD.TLGRIDX-TLGRSIZE  R6->END OF GRID                          
         LA    R4,GD.TLGRID            R4->START OF GRID                        
*                                                                               
CHOP0050 DS    0H                                                               
         CR    R6,R4                                                            
         BL    CHOP0500            BOUNDRY CHECK                                
         OC    0(TLGRSIZE,R6),0(R6)                                             
         BNZ   CHOP0100                                                         
         SHI   R6,TLGRSIZE         GO BACKWARD                                  
         B     CHOP0050            LOOP                                         
*                                                                               
CHOP0100 DS    0H                  R6->LAST UN-NULL GRID                        
         MVC   WORK(L'GD.TLGSTD),GD.TLGSTD                                      
         SR    R2,R2                                                            
CHOP0130 DS    0H                                                               
         CLI   0(R4),0             ZERO SPOTS?                                  
         BNE   CHOP0150                                                         
*        TM    1(R4),X'01'         NPW?                                         
*        BO    CHOP0150            DON'T CHOP                                   
         CLC   0(TLGRSIZE,R4),=X'FFFF'  END OF GRID?                            
         BE    CHOP0500            YES, GET OUT                                 
         AHI   R2,7                ACCUMULATE R2                                
         LA    R4,TLGRSIZE(R4)                                                  
         B     CHOP0130            LOOP                                         
*                                                                               
CHOP0150 DS    0H                                                               
         LTR   R2,R2               NULL=NOTHING TO ADJUST                       
         BZ    CHOP0500                                                         
         GOTO1 DATCON,DMCB,(3,WORK),(0,WORK+3)                                  
         GOTO1 ADDAY,DMCB,WORK+3,WORK+3,(R2)  ADJUST START DATE                 
         GOTO1 DATCON,DMCB,(0,WORK+3),(3,GD.TLGSTD)                             
*                                                                               
         SR    R6,R4               ADJUST SPOTS IN GRID                         
         AHI   R6,1                LENGTH TO MOVE                               
*                                                                               
         CHI   R6,0                TRAP ERROR                                   
         BNL   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         XC    WORK2(L'TSARREC),WORK2                                           
         EX    R6,*+8                                                           
         B     *+10                                                             
         MVC   WORK2(0),0(R4)                                                   
*                                                                               
         XC    GD.TLGRID(GD.TLGRIDX-GD.TLGRID),GD.TLGRID                        
         MVC   GD.TLGRID,WORK2                                                  
         MVC   GD.TLGRIDX,=X'FFFF'                                              
*                                                                               
CHOP0500 DS    0H                  CHOP TRAILING ZERO                           
         LA    R6,GD.TLGRIDX-TLGRSIZE  R6->END OF GRID                          
         LA    R4,GD.TLGRID            R4->START OF GRID                        
*                                                                               
CHOP0550 DS    0H                                                               
         CR    R6,R4                                                            
         BL    CHOP0800            BOUNDRY CHECK                                
         OC    0(TLGRSIZE,R6),0(R6)                                             
         BNZ   CHOP0600                                                         
         SHI   R6,TLGRSIZE         GO BACKWARD                                  
         B     CHOP0550            LOOP                                         
*                                                                               
CHOP0600 DS    0H                  R6->LAST UN-NULL GRID                        
         MVC   WORK(L'GD.TLGEND),GD.TLGEND                                      
         SR    R2,R2                                                            
CHOP0630 DS    0H                                                               
         CR    R6,R4                                                            
         BL    CHOP0800            BOUNDRY CHECK                                
         CLI   0(R6),0             ZERO SPOTS?                                  
         BNE   CHOP0650                                                         
         SHI   R2,7                DECREMENT R2 WEEKLY                          
         SHI   R6,TLGRSIZE                                                      
         B     CHOP0630            LOOP                                         
*                                                                               
CHOP0650 DS    0H                                                               
         LTR   R2,R2               NULL=NOTHING TO ADJUST                       
         BZ    CHOP0800                                                         
         GOTO1 DATCON,DMCB,(3,WORK),(0,WORK+3)                                  
         GOTO1 ADDAY,DMCB,WORK+3,WORK+3,(R2)  ADJUST START DATE                 
         GOTO1 DATCON,DMCB,(0,WORK+3),(3,GD.TLGEND)                             
CHOP0800 DS    0H                                                               
CHOPX    DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
         DROP  GD                                                               
***********************************************************************         
* GET GRID START DATE ON THE SCREEN                                             
***********************************************************************         
GETGSTD  NTR1  BASE=*,LABEL=*                                                   
         LA    R3,EXPWKQ           NUMBER OF WEEKS FOR EXP FORMAT               
         TM    FLAGS2,FG2EXPD                                                   
         BO    *+8                                                              
         LA    R3,SQZWKQ           NUMBER OF WEEKS FOR SQZ FORMAT               
*                                                                               
         MVC   FULL(L'GRSTDATE),GRSTDATE                                        
         GOTO1 DATCON,DMCB,(3,FULL),(0,ELEM)                                    
         MHI   R3,7                                                             
*                                                                               
         GOTO1 ADDAY,DMCB,ELEM,ELEM+6,(R3)                                      
         GOTO1 DATCON,DMCB,(0,ELEM+6),(3,FULL)                                  
*                                                                               
         CLC   LATEST,FULL         THE NEXT SCREEN LATER THAN LATEST?           
         BNL   GSTD0450            NO,EXIT                                      
*                                                                               
         CLC   EARLIEST,GRSTDATE   SAME AND ONLY PAGE?                          
         BE    GSTDNO              YES.SET CC AND EXIT,DON'T REDISPLAY          
*                                                                               
         MVC   GRSTDATE,EARLIEST   NO,START OVER FROM FIRST DATE                
         B     GSTD0500                                                         
*                                                                               
GSTD0450 DS    0H                                                               
         MVC   GRSTDATE,FULL       SET THE GRID START DATE                      
*                                                                               
GSTD0500 DS    0H                                                               
         OC    GRSTDATE,GRSTDATE   TRAP BAD DATE                                
         BNZ   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         GOTOR DISWKH,DMCB,GRSTDATE,DIFHLN2+MONTHQ,DIFHL3D                      
*                                                                               
         GOTOR DISMORE                                                          
*                                                                               
GSTDYES  SR    RC,RC                                                            
GSTDNO   LTR   RC,RC                                                            
GETGSTDX DS    0H                                                               
         B     EXIT                                                             
**********************************************************************          
*  DISPLAY THE 'MORE' FLAG IF THERE IS MORE DATES/SPOTS ON NEXT SCREEN          
**********************************************************************          
DISMORE  NTR1  BASE=*,LABEL=*                                                   
         LA    R3,EXPWKQ           NUMBER OF WEEKS FOR EXP FORMAT               
         TM    FLAGS2,FG2EXPD                                                   
         BO    *+8                                                              
         LA    R3,SQZWKQ           NUMBER OF WEEKS FOR SQZ FORMAT               
*                                                                               
         MVC   FULL(L'GRSTDATE),GRSTDATE                                        
         GOTO1 DATCON,DMCB,(3,FULL),(0,ELEM)                                    
         MHI   R3,7                                                             
         GOTO1 ADDAY,DMCB,ELEM,ELEM+6,(R3)                                      
         GOTO1 DATCON,DMCB,(0,ELEM+6),(3,FULL)                                  
*                                                                               
         CLC   LATEST,FULL         THE NEXT SCREEN LATER THAN LATEST?           
         BNL   MORE0500            NO, NO MORE>>                                
         MVC   DIFHLN1+25(6),=C'      '                                         
         B     MOREX                                                            
*                                                                               
MORE0500 DS    0H                                                               
         MVC   DIFHLN1+25(6),=C'MORE>>'                                         
*                                                                               
MOREX    DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* DISPLAY WEEKS HEADER ON THE SCREEN                                            
* P1 = A(START DATE)                                                            
***********************************************************************         
DISWKH   NTR1  BASE=*,LABEL=*                                                   
         LM    R2,R4,0(R1)                                                      
         TM    FLAGS,FGPRTQ                                                     
         BO    DISW0030                                                         
*                                                                               
         XC    0(L'DIFHLN2-MONTHQ,R3),0(R3)                                     
         XC    0(L'DIFHL3D,R4),0(R4)                                            
*                                                                               
         LA    R6,SQZWKQ           13                                           
         TM    FLAGS2,FG2EXPD                                                   
         BZ    DISW0050                                                         
*                                                                               
         LA    R6,EXPWKQ           EXPAND                                       
         LA    R3,((SQZWKQ-EXPWKQ)*DSGRIDQ)(R3)                                 
         LA    R4,((SQZWKQ-EXPWKQ)*DSGRIDQ)(R4)                                 
         B     DISW0050                                                         
DISW0030 DS    0H                                                               
         LA    R6,PRTWKQ                                                        
         TM    FLAGS2,FG2EXPD                                                   
         BZ    *+8                                                              
         LA    R6,EXPRTWKQ                                                      
*                                                                               
DISW0050 DS    0H                                                               
         MVC   FULL(L'GRSTDATE),0(R2)                                           
DISW0100 DS    0H                                                               
         CLC   FULL(L'LATEST),LATEST                                            
         BH    DISWKHX                                                          
         EDIT  (1,FULL+1),(2,(R3)),ALIGN=LEFT        MONTH                      
         EDIT  (1,FULL+2),(2,(R4)),ALIGN=LEFT,FLOAT=0 DAYS                      
         GOTO1 DATCON,DMCB,(3,FULL),(0,ELEM)                                    
         GOTO1 ADDAY,DMCB,ELEM,ELEM+6,7                                         
         GOTO1 DATCON,DMCB,(0,ELEM+6),(3,FULL)                                  
         LA    R3,DSGRIDQ(R3)                                                   
         LA    R4,DSGRIDQ(R4)                                                   
         BCT   R6,DISW0100                                                      
                                                                                
DISWKHX  DS    0H                                                               
         ST    R3,DMCB                                                          
         B     EXIT                                                             
***********************************************************************         
* MY OWN CALL TO PERVAL                                                         
***********************************************************************         
MYPVAL   NTR1  BASE=*,WORK=(R4,DLWORKQ),LABEL=*                                 
         LM    R2,R3,0(R1)                                                      
         USING DLWORKD,R4                                                       
         XC    WORK,WORK                                                        
         XC    DLWORK,DLWORK                                                    
*                                                                               
         MVC   DLWORK2(L'EARLIEST),0(R2)                                        
         OC    0(L'EARLIEST,R2),0(R2)                                           
         BNZ   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         GOTOR SETDATE,DMCB,DLWORK2                                             
         MVC   DLWORK2+L'EARLIEST(L'EARLIEST),0(R3)                             
         GOTOR SETDATE,DMCB,DLWORK2+L'EARLIEST                                  
*                                                                               
         GOTO1 DATCON,DMCB,(3,DLWORK2),(5,WORK)                                 
         GOTO1 DATCON,DMCB,(3,DLWORK2+L'EARLIEST),(5,WORK+9)                    
         MVI   WORK+8,C'-'                                                      
         GOTO1 PERVAL,DMCB,(17,WORK),DLWORK                                     
*                                                                               
         CLI   DMCB+4,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
WKD      USING PERVALD,DLWORK                                                   
         LA    R2,WKD.PVALNWKS                                                  
         SR    R3,R3                                                            
         ICM   R3,3,0(R2)          # WEEKS(DAY IF DAILY) ROUNDED UP             
         BCTR  R3,0                ADJUST FOR ROUNDING                          
         DROP  WKD                 R3 = NUMBER OF WEEKS                         
         STH   R3,DMCB                                                          
         DROP  R4                                                               
*                                                                               
MYPVALX  DS    0H                                                               
         B     EXIT                                                             
***********************************************************************         
* RETRIEVE INDEXED ITEMS: DAY/TIME, PROGRAM NAME AND BUY LINKS, IF ANY|         
* R2 ALREADY POINTS TO LIST LINE                                      |         
* LINE CAN BE ADVANCED IN THIS ROUTINE SO CALLER SHOULD UPDATE        |         
* R2 BY RETRIEVING FROM P1                                            |         
* INPUT : P1: BYTE 1 - X'80' SPECIAL DISPLAY FOR REP LINES            |         
*                            TO FAKE AN AGENCY LINE WITH ZERO SPOTS   |         
* OUTPUT: P1: A(NEXT LINE)                                            |         
*---------------------------------------------------------------------*         
* LAY OUT OF DLIO                                                     |         
*---------------------------------------------------------------------*         
* AGY SPOTS  |  TOTAL REP SPOTS |  SPOT DIFFERENCE  |  TOTAL AGY SPOTS|         
*---------------------------------------------------------------------*         
* 1ST 255 BYTE OF DLIO = AGENCY SPOTS FOR CALCULATION                 |         
* 2ND 255 BYTE OF DLIO = TOTAL REP SPOTS IN THIS SEGMENT              |         
* 3RD 255 BYTE OF DLIO = SPOT DIFFERENCES BETWEEN AGY AND REP LINES   |         
*                        WITHIN THIS SEGMENT                          |         
* 4TH 255 BYTE OF DLIO = TOTAL AGENCY SPOTS IN THIS                   |         
*                        SEGMENT                                      |         
***********************************************************************         
BUYSEG   USING TLSTD,GNXSVREC                                                   
         USING SPOOLD,R8                                                        
         USING DLWORKD,R4                                                       
         USING DIFFSUM,R2                                                       
*                                                                               
GETNDX   NTR1  BASE=*,WORK=(R4,DLWORKQ),LABEL=*                                 
         MVC   SVCOUNT2,COUNT2                                                  
         L     R8,ASPOOLD                                                       
         XC    DLBYTE,DLBYTE                                                    
*                                                                               
         XC    NXOFFSET,NXOFFSET                                                
*                                                                               
         MVC   GNXSVREC,TSARREC    SAVE OFF CURRENT TSAR RECORD                 
         MVC   DLTSRNUM,TXNUM       AND TSAR RECORD NUMBER                      
*                                                                               
GN100    DS    0H                                                               
         TM    MYFLAG1,X'40'       FOUND THE BUY IN CONTINATION?                
         BO    GN120               YES                                          
*                                                                               
         TM    DISFLG1,DCONTEEQ    CONTINUATION                                 
         BZ    GN120                                                            
         NI    DISFLG1,X'FF'-DCONTEEQ                                           
         CLI   TYP,C'A'                                                         
         BE    GN540                                                            
*                                                                               
GN120    DS    0H                                                               
         TM    BUYSEG.TLBYRFLG,X'40' REP BUY LINK?                              
         BO    GN450                                                            
***********************************************************************         
* DISPLAY FOR SINGLE REP BUY (NOT A REP LINK, NOT A AGY LINK)                   
***********************************************************************         
GN370    DS    0H                                                               
         CLI   BUYSEG.TLBYRLNK,0                                                
         BE    GN540                                                            
*                                                                               
         LH    RF,COUNT2           COUNT NUMBER OF REP BUYS                     
         AHI   RF,1                                                             
         STH   RF,COUNT2                                                        
*                                                                               
         LA    R1,BUYSEG.TLBYRFG2                                               
         GOTOR DISMKG                                                           
*                                                                               
         TM    CFLAG,CFKAGYQ       FAKING AGENCY SEGMENT?                       
         BZ    GN372               YES - PUT DAILY BUY IN AGY# FIELD            
         CLI   DISFLG2,DMATCHQ                                                  
         BE    GN374                                                            
         GOTOR DISBUY#,DMCB,BUYSEG.TLBYMLNK,(C'A',DSTYPA)                       
         B     GN374                                                            
*                                                                               
GN372    GOTOR DISBUY#,DMCB,BUYSEG.TLBYRLNK,(C'R',DSTYPR)                       
*                                                                               
GN374    XC    BYTE,BYTE                                                        
         TM    CFLAG,CFKAGYQ       FAKING AGENCY SEGMENT?                       
         BZ    GN376                                                            
         CLI   DISFLG2,DMATCHQ                                                  
         BNE   GN376                                                            
         OI    BYTE,X'80'          DON'T DISPLAY LINE INFO                      
*                                                                               
GN376    GOTOR DISLINE,DMCB,(R2),(BYTE,GNXSVREC),                      >        
               (C'R',BUYSEG.TLBYRLNK),DLIO                                      
         BNE   GNX3                                                             
*                                                                               
GN390    DS    0H                                                               
         L     R2,DMCB                                                          
         OI    DISFLG1,DREPQ                                                    
*                                                                               
         B     GN540                                                            
***********************************************************************         
* DISPLAY FOR MULTIPLE REP BUY USING BUY LINK RECORD                            
***********************************************************************         
GN450    DS    0H                                                               
         MVI   TYP,C'R'                                                         
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,C'R'                                                   
         MVC   TR.TLBLINDX,BUYSEG.TLBYRLNK                                      
         GOTO1 GOTSAR,TSARDH       RETRIEVE BUY LINK RECORD                     
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,TR.TLBLBUY#                                                   
K        USING TLBLBUY#,R3                                                      
GN480    DS    0H                                                               
         TM    MYFLAG1,X'40'       FOUND THE BUY ALREADY?                       
         BO    GN500                                                            
         TM    DISFLG1,DCONTEEQ                                                 
         BZ    GN500                                                            
         CLC   BUY#,0(R3)          LOOP UNTIL WE GET THE NEXT LINE              
         BNE   GN535               FROM THE PREVIOUS SCREEN                     
*                                                                               
         OI    MYFLAG1,X'40'                                                    
*                                                                               
GN500    DS    0H                                                               
*                                                                               
         CLI   DISFLG2,DMATCHQ                                                  
         BNE   GN510                                                            
         LH    RF,COUNT2           COUNT NUMBER OF REP BUYS                     
         AHI   RF,1                                                             
         STH   RF,COUNT2                                                        
GN510    DS    0H                                                               
*                                                                               
         LA    R1,TLBLFLG-TLBLBUY#(R3)                                          
         GOTOR DISMKG                                                           
*                                                                               
         TM    CFLAG,CFKAGYQ       FAKING AGENCY SEGMENT?                       
         BZ    GN514               YES - PUT DAILY BUY IN AGY# FIELD            
         CLI   DISFLG2,DMATCHQ                                                  
         BE    GN516                                                            
         GOTOR DISBUY#,DMCB,BUYSEG.TLBYMLNK,(C'A',DSTYPA)                       
         B     GN516                                                            
*                                                                               
GN514    GOTOR DISBUY#,DMCB,(R3),(C'R',DSTYPR)                                  
*                                                                               
GN516    XC    BYTE,BYTE                                                        
         CLI   DISFLG2,DMATCHQ                                                  
         BNE   GN520                                                            
         TM    CFLAG,CFKAGYQ       FAKING AGENCY SEGMENT?                       
         BO    GN518               YES - DON'T DISPLAY LINE INFO                
         TM    BUYSEG.TLBYFLG4,X'44'   IS THIS AN ORPHAN SEGMENT?               
         BO    GN517               YES, DISPLAY ALL                             
         TM    DISFLG1,D1STREPQ    FIRST BUY DISPLAYED ALREADY?                 
         BZ    GN520               NO                                           
         OC    BUYSEG.TLBYMLNK,BUYSEG.TLBYMLNK                                  
         BZ    GN520                                                            
*                                                                               
GN517    MVI   DSINPUT,C'M'                                                     
         GOTOR DISBUY#,DMCB,BUYSEG.TLBYMLNK,(C'A',DSTYPA)                       
         B     GN520                                                            
*                                                                               
GN518    OI    BYTE,X'80'          YES, THIS IS NOT THE FIRST BUY               
*                                  IN A MULTI                                   
*                                  SO ONLY DISPLAY GRID FOR THIS LINE           
GN520    DS    0H                                                               
         LA    R3,TLBLLENQ(R3)                                                  
         CLI   0(R3),0                                                          
         BE    GN530                                                            
         LA    R6,DSREPBY+L'DSREPBY                                             
         CLI   0(R6),C'*'          *(MAKEGOOD) = SKIP                           
         BE    GN525                                                            
         CLI   0(R6),X'40'                                                      
         BH    *+8                                                              
GN525    DS    0H                                                               
         BCT   R6,*-8                                                           
         TM    CFLAG,CFKAGYQ                                                    
         BO    *+8                                                              
         MVI   1(R6),C'+'                                                       
*                                                                               
*                                                                               
GN530    DS    0H                                                               
         SHI   R3,TLBLLENQ                                                      
*                                                                               
         TM    DISFLG1,D1STREPQ                                                 
         BZ    GN532                                                            
         OI    BYTE,X'40'          DO NOT UNPROTECT THIS LINE'S INPUT           
*                                  FIELD                                        
GN532    GOTOR DISLINE,DMCB,(R2),(BYTE,GNXSVREC),(C'R',(R3)),DLIO               
         BE    GN534                                                            
         MVC   BUY#,0(R3)                                                       
         B     GNX2                                                             
*                                                                               
GN534    DS    0H                                                               
         TM    CFLAG,CFKAGYQ                                                    
         BZ    GN535                                                            
         CLI   DISFLG2,DMATCHQ                                                  
         BE    GN535C                                                           
*                                                                               
GN535    L     R2,DMCB                                                          
GN535C   LA    R3,TLBLLENQ(R3)                                                  
         CLI   0(R3),0                                                          
         BE    GN535X                                                           
         OI    DISFLG1,D1STREPQ    DISPLAYED ONE BUY ALREADY                    
         B     GN500                                                            
*&&DO                                                                           
         LA    R3,TLBLLENQ(R3)                                                  
         CLI   0(R3),0                                                          
         BNE   GN480               LOOP TO DISPLAY ALL LINES IN SEG             
*&&                                                                             
         DROP  K                                                                
GN535X   DS    0H                                                               
         NI    DISFLG1,X'FF'-D1STREPQ                                           
         OI    DISFLG1,DREPQ                                                    
         TM    CFLAG,CFKAGYQ                                                    
         BZ    GN540                                                            
         L     R2,DMCB                                                          
         B     GN600                                                            
***********************************************************************         
*  AGY BUY PROCESS                                                              
***********************************************************************         
GN540    DS    0H                                                               
         TM    BUYSEG.TLBYFLG4,X'44'                                            
         BNZ   GN700                                                            
         OC    BUYSEG.TLBYALNK,BUYSEG.TLBYALNK                                  
         BZ    GN700                                                            
*                                                                               
         OI    MYFLAG1,X'80'       ONE AGENCY LINE IS DISPLAYED                 
*                                                                               
         TM    BUYSEG.TLBYAFLG,X'40' AGY BUY LINK?                              
         BZ    GN590                                                            
***********************************************************************         
* DISPLAY FOR MULTIPLE AGY BUY USING BUY LINK RECORD                            
***********************************************************************         
         MVI   TYP,C'A'                                                         
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,C'A'                                                   
         MVC   TR.TLBLINDX,BUYSEG.TLBYALNK                                      
         GOTO1 GOTSAR,TSARDH       RETRIEVE BUY LINK RECORD                     
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
GN550    DS    0H                                                               
         CLI   DISFLG2,DMATCHQ     DISPLAYING MATCH SEGMENT?                    
         BNE   GN570                                                            
*                                                                               
         TM    DISFLG1,DREPQ       IF REP LINE JUST DISPLAYED                   
         BZ    *+10                COMPARE WITH THE SAME SEG                    
         MVC   COMPTSAR,GNXSVREC                                                
*&&DO                                                                           
         OC    BUYSEG.TLBYMLNK,BUYSEG.TLBYMLNK                                  
         BNZ   GN570                                                            
*&&                                                                             
         LA    R1,TR.TLBLFLG                                                    
         GOTOR DISMKG                                                           
*                                                                               
         GOTOR DISLINE,DMCB,(R2),GNXSVREC,(C'A',TR.TLBLBUY#),DLIO               
         BE    GN560                                                            
         LA    R3,TR.TLBLBUY#                                                   
*        MVC   BUY#,TR.TLBLBUY#                                                 
         B     GNX2                                                             
*                                                                               
GN560    DS    0H                                                               
         L     R2,DMCB                                                          
         B     GN600                                                            
***********************************************************************         
* DISPLAY FOR NON-MATCH AGENCY MULTIPLE BUYS                                    
*          OR MATCH DAILY/C.O/C.E.D BUYS                                        
***********************************************************************         
GN570    DS    0H                  FOR NON-MATCH DISPLAY                        
         MVI   TYP,C'A'                                                         
         LA    R3,TR.TLBLBUY#                                                   
         USING TLBLBUY#,R3                                                      
*                                                                               
         CLI   0(R3),0                                                          
         BE    GN600                                                            
GN575    DS    0H                  LOOP                                         
         TM    MYFLAG1,X'40'       FOUND THE BUY ALREADY?                       
         BO    GN580                                                            
         TM    DISFLG1,DCONTEEQ                                                 
         BZ    GN580                                                            
         CLC   BUY#,0(R3)          LOOP UNTIL WE GET THE NEXT LINE              
         BNE   GN585               FROM THE PREVIOUS SCREEN                     
         CLC   SUBBUY#,TLBLSUB#-TLBLBUY#(R3)                                    
         BNE   GN585                                                            
         OI    MYFLAG1,X'40'                                                    
*                                                                               
GN580    DS    0H                                                               
         LA    R1,TLBLFLG-TLBLBUY#(R3)                                          
         GOTOR DISMKG                                                           
*                                                                               
         GOTOR DISBUY#,DMCB,(R3),(C'A',DSTYPA)                                  
*                                                                               
         GOTOR DISLINE,DMCB,(R2),GNXSVREC,(C'A',(R3)),DLIO                      
         BE    GN583                                                            
         MVC   BUY#,0(R3)                                                       
         B     GNX2                                                             
*                                                                               
GN583    DS    0H                                                               
         L     R2,DMCB                                                          
*                                                                               
         CLI   DISFLG2,DMATCHQ                                                  
         BNE   GN585                                                            
         OC    BUYSEG.TLBYMLNK,BUYSEG.TLBYMLNK                                  
         BZ    GN585                                                            
         LH    RF,COUNT2                                                        
         SHI   RF,1                                                             
         STH   RF,COUNT2                                                        
         CHI   RF,0                                                             
         BH    GN585                                                            
         OI    DLBYTE,X'80'        SO WE WON'T DO DISOVRD AGAIN                 
*                                                                               
GN584    DS    0H                                                               
         GOTOR DISOVRD,DMCB,(X'80',(R2))                                        
         BNE   GNX2                                                             
         L     R2,DMCB                                                          
         XC    COMPTSAR,COMPTSAR                                                
*                                                                               
GN585    DS    0H                                                               
         LA    R3,TLBLLENQ(R3)                                                  
         CLI   0(R3),0                                                          
         BE    GN600                                                            
*                                                                               
         MVI   DSINPUT,C'+'                                                     
         B     GN575                                                            
*                                                                               
***********************************************************************         
* DISPLAY FOR SINGLE AGY BUY                                                    
***********************************************************************         
GN590    DS    0H                                                               
         CLI   BUYSEG.TLBYALNK,0                                                
         BE    GN700                                                            
*                                                                               
         TM    DISFLG1,DREPQ       IF REP LINE JUST DISPLAYED                   
         BZ    GN595               COMPARE WITH THE SAME SEG                    
         MVC   COMPTSAR,GNXSVREC                                                
*                                                                               
GN595    DS    0H                                                               
         CLI   DISFLG2,DMATCHQ                                                  
         BE    GN595A                                                           
         GOTOR DISBUY#,DMCB,BUYSEG.TLBYALNK,(C'A',DSTYPA)                       
*                                                                               
GN595A   DS    0H                                                               
         LA    R1,BUYSEG.TLBYAFG2                                               
         GOTOR DISMKG                                                           
*                                                                               
         GOTOR DISLINE,DMCB,(R2),GNXSVREC,(C'A',BUYSEG.TLBYALNK),DLIO           
         BNE   GNX3                                                             
*                                                                               
GN597    DS    0H                                                               
         L     R2,DMCB                                                          
*                                                                               
GN600    DS    0H                                                               
         TM    DLBYTE,X'80'        SO WE WON'T DO DISOVRD AGAIN                 
         BO    GN700                                                            
         CLI   DISFLG2,DMATCHQ                                                  
         BNE   GN700                                                            
         TM    OVRDFLG,OVDALLQ                                                  
         BO    GN650                                                            
         TM    CFLAG,CFKAGYQ                                                    
         BO    GN620                                                            
         TM    OVRDFLG,OVDSPTQ                                                  
         BZ    GN650                                                            
*                                                                               
GN620    TM    OFLAG1,OSPTDIFQ                                                  
         BZ    GN650                                                            
*                                                                               
         BRAS  RE,ISEOSCR                                                       
         BH    GNX3                                                             
         GOTOR DISGRID,DMCB,(R2),(X'FE',DLIO+(2*L'TSARREC))                     
         L     R2,DMCB                                                          
*                                                                               
GN650    DS    0H                                                               
         ST    R2,DMCB             SET UP PARAMETERS MYSELF                     
*                                                                               
         TM    CFLAG,CFKAGYQ                                                    
         BO    GN700                                                            
*                                                                               
         TM    BUYSEG.TLBYFLG4,X'01'                                            
         BZ    *+8                                                              
         OI    DMCB,X'80'          DAILY                                        
*                                                                               
         GOTOR DISOVRD             DISPLAY OVERRIDE INFO                        
         BNE   GNX3                                                             
         L     R2,DMCB                                                          
         B     GN800                                                            
*                                                                               
GN700    DS    0H                  DISPLAY PROGRAM NAME FOR REPORT              
         TM    FLAGS,FGPRTQ        FOR ALL BUT MATCH SEGMENT                    
         BZ    GN800               MATCH SEGMENT IS DONE IN DISOVRD             
         CLI   DISFLG2,DMATCHQ                                                  
         BE    GN800                                                            
         OC    BUYSEG.TLBYPROG,BUYSEG.TLBYPROG                                  
         BZ    GN800                                                            
*                                                                               
         TM    CFLAG,CFKAGYQ                                                    
         BO    GN800                                                            
         MVC   DSLINE(5),=C'RPGM:'                                              
         OC    BUYSEG.TLBYRLNK,BUYSEG.TLBYRLNK                                  
         BNZ   *+10                                                             
         MVC   DSLINE(5),=C'RPGM:'                                              
*                                                                               
         GOTOR DISPGM,DMCB,DSLINE+8,BUYSEG.TLBYPROG                             
*                                                                               
         BRAS  RE,BUMPLINE                                                      
GN800    DS    0H                                                               
*                                                                               
********************************************************************            
* EXIT FOR PROCESSED OK                                                         
********************************************************************            
GNX      DS    0H                  EXIT FOR PROCESS OK                          
         NI    DISFLG1,X'FF'-DREPQ-DCONTEEQ                                     
         ST    R2,DMCB             PASS THE NEXT LINE TO CALLER                 
         MVC   TSARREC,GNXSVREC                                                 
         B     EXITOK                                                           
********************************************************************            
* EXIT FOR REACHING SCREEN END WHILE IN THE MIDDLE OF DISPLAYING                
* A LINE FROM A MULTI-LINE SEGMENT                                              
********************************************************************            
GNX2     DS    0H                                                               
         MVC   BUY#,0(R3)                                                       
         MVC   SUBBUY#,TLBLSUB#-TLBLBUY#(R3)                                    
         OI    DISFLG1,DCONTERQ    CONTINUATION REQUIRED NEXT SCR               
         CLI   TYP,C'R'            DISPLAYING REPLINES?                         
         BE    *+10                YES, DON'T RESTORE DAILY COUNTER             
         MVC   COUNT2,SVCOUNT2                                                  
********************************************************************            
* EXIT FOR REACHING SCREEN END WHILE IN THE MIDDLE OF DISPLAYING                
* A LINE FROM A SINGLE SEGMENT                                                  
********************************************************************            
GNX3     DS    0H                                                               
         NI    DISFLG1,FF-DREPQ-D1STREPQ                                        
         NI    CFLAG,FF-CFKAGYQ                                                 
         TWAXC (R2),DIFEND2H,PROT=Y CLEAN UP THE LAST LINE                      
         MVC   TXNUM,DLTSRNUM                                                   
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LTR   RB,RB                                                            
         B     EXIT                                                             
*                                                                               
         DROP  BUYSEG,R2                                                        
         DROP  R4                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* DISPLAY OVERRIDE INFORMATION                                                  
* P1 = ADDRESS OF DISPLAY LINE                                                  
***********************************************************************         
RBUYSEG  USING TLSTD,COMPTSAR                                                   
BUYSEG   USING TLSTD,GNXSVREC                                                   
*                                                                               
DISOVRD  NTR1  BASE=*,LABEL=*                                                   
         L     R8,ASPOOLD                                                       
         USING SPOOLD,R8                                                        
         L     R2,0(R1)                                                         
         USING DIFFSUM,R2                                                       
         MVC   BYTE,0(R1)                                                       
*                                                                               
         TM    FLAGS,FGPRTQ        PRINTING - SKIP                              
         BZ    DOVR0001                                                         
         XC    DSLINE(L'P),DSLINE                                               
         B     DOVR0002                                                         
*                                                                               
DOVR0001 DS    0H                                                               
         BRAS  RE,ISEOSCR          REACH END OF SCREEN?                         
         BH    DOVRNO                                                           
*&&TT                                                                           
         CLI   BUYSEG.TLBYRLNK,1                                                
         BNE   *+6                                                              
         DC    X'0770'                                                          
*&&                                                                             
DOVR0002 DS    0H                  DISPLAY COLOR                                
         GOTOR DISCOLOR,AGYCOLOR                                                
*                                                                               
         NI    DSLINEH+1,X'FF'-X'08'     TURN OFF HIGH INTENSITY                
*                                                                               
         MVC   DSLINE(NOCHANGQ),NOCHANGE                                        
         CLI   OVRDFLG,0                                                        
         BE    DOVR0038                                                         
*                                                                               
         MVC   DSLINE(ADDNEWQ),ADDNEW                                           
         TM    OVRDFLG,OVDALLQ                                                  
         BO    DOVR0038                                                         
*                                                                               
         MVC   DSLINE(CANCELQ),CANCEL                                           
         TM    OVRDFLG,OVCNCLQ                                                  
         BZ    DOVR0003                                                         
         CLI   BUYSEG.TLBYMLNK,0   DAILY FAKING AGENCY LINE?                    
         BE    DOVR0038                                                         
         MVC   DSLINE(CANCEL2Q),CANCEL2                                         
         B     DOVR0038                                                         
*                                                                               
DOVR0003 XC    DSLINE,DSLINE                                                    
*                                                                               
         TM    OVRDFLG,OVPGMQ                                                   
         BZ    DORV0035                                                         
*--------------------------------------------------------------------*          
* DISPLAY PROGRAM NAME IF REP PGM NOT THE SAME AS AGY PGM                       
*                                                                               
         XC    DSLINE,DSLINE                                                    
         NI    MISCFLG4,FF-MF4LPGM                                              
*                                                                               
         TM    FLAGS,FGPRTQ        PRINT - SKIP                                 
         BO    DOVR0004                                                         
*                                                                               
         GOTOR GETPGMLN,DMCB,RBUYSEG.TLBYPROG,BUYSEG.TLBYPROG                   
*                            CALCULATE PROGRAM NAME LENGTH                      
         BE    *+8                                                              
         OI    MISCFLG4,MF4LPGM                                                 
*                                                                               
DOVR0004 DS    0H                                                               
         GOTOR DISCOLOR,REPCOLOR                                                
*                                                                               
         MVC   DSLINE(L'REPPGM),REPPGM                                          
         LA    RF,DSLINE+12                                                     
         OC    RBUYSEG.TLBYPROG,RBUYSEG.TLBYPROG                                
         BZ    DOVR0010                                                         
*                                                                               
         GOTOR DISPGM,DMCB,DSLINE+7,RBUYSEG.TLBYPROG                            
         L     RF,DMCB       YES, DISPGM TELLS US WHERE IT ENDS                 
         LA    RF,2(RF)      2 SPACES                                           
*                                                                               
         TM    MISCFLG4,MF4LPGM                                                 
         BZ    DOVR0010                                                         
         BRAS  RE,BUMPLINE                                                      
*                                                                               
         GOTOR DISCOLOR,REPCOLOR                                                
*                                                                               
         ST    R2,DMCB                                                          
         LA    RF,DSLINE                                                        
*                                                                               
DOVR0010 DS    0H                                                               
         MVC   0(L'AGYPGM,RF),AGYPGM                                            
         OC    BUYSEG.TLBYPROG,BUYSEG.TLBYPROG                                  
         BNZ   DOVR0012                                                         
*                                                                               
         LA    RF,L'AGYPGM+6(RF)   NULL PROGRAM, LEAVE SPACE 6 SPACES           
         B     DOVR0015                                                         
*                                                                               
DOVR0012 DS    0H                                                               
         GOTOR DISPGM,DMCB,7(RF),BUYSEG.TLBYPROG                                
         L     RF,DMCB       DISPGM TELLS US WHERE IT ENDS                      
         LA    RF,3(RF)      2 SPACES                                           
*                                                                               
DOVR0015 DS    0H                                                               
         LA    RE,DSLINE+L'DSLINE-1                                             
         SR    RE,RF                                                            
         CHI   RE,L'PGMNOTE                                                     
         BH    DOVR0020      ENOUGH TO PUT THE PGM COMMENT                      
*                                                                               
         BRAS  RE,BUMPLINE   OTHERWISE, BUMP THE LINE                           
         BRAS  RE,ISEOSCR                                                       
         BH    DOVRNO                                                           
*                                                                               
         GOTOR DISCOLOR,REPCOLOR                                                
         LA    RF,DSLINE     POINT RF TO BEGINNING OF THE LINE                  
         ST    R2,DMCB       UPDATE R2                                          
*                                                                               
DOVR0020 DS    0H                                                               
         MVC   0(L'PGMNOTE,RF),PGMNOTE                                          
*                                                                               
DOVR0030 DS    0H                                                               
         BRAS  RE,BUMPLINE                                                      
         BRAS  RE,ISEOSCR                                                       
         BH    DOVRNO                                                           
         ST    R2,DMCB                                                          
*                                                                               
DORV0035 DS    0H                                                               
         TM    OVRDFLG,FF-OVPGMQ                                                
         BZ    DOVR0040            PROGRAM THE ONLY DIFFERENCE - SKIP           
*                                                                               
         GOTOR DISCOLOR,AGYCOLOR                                                
*                                                                               
         XC    DSLINE,DSLINE                                                    
         MVC   DSLINE(36),=CL36'REP LINE WILL CHANGE AS SHOWN ABOVE:'           
         LA    R6,DSLINE+37                                                     
*                                                                               
         TM    OVRDFLG,OVDAYQ                                                   
         BZ    *+14                                                             
         MVC   0(4,R6),=C'DAY,'                                                 
         LA    R6,4(R6)                                                         
*                                                                               
         TM    OVRDFLG,OVTIMEQ                                                  
         BZ    *+14                                                             
         MVC   0(5,R6),=C'TIME,'                                                
         LA    R6,5(R6)                                                         
*                                                                               
         TM    OVRDFLG,OVLENQ                                                   
         BZ    *+14                                                             
         MVC   0(4,R6),=C'LEN,'                                                 
         LA    R6,4(R6)                                                         
*                                                                               
         TM    OVRDFLG,OVRATEQ                                                  
         BZ    *+14                                                             
         MVC   0(5,R6),=C'RATE,'                                                
         LA    R6,5(R6)                                                         
*&&DO                                                                           
         TM    OVRDFLG,OVPGMQ                                                   
         BZ    *+14                                                             
         MVC   0(4,R6),=C'PGM,'                                                 
         LA    R6,4(R6)                                                         
*&&                                                                             
         TM    OVRDFLG,OVDSPTQ                                                  
         BZ    *+14                                                             
         MVC   0(12,R6),=C'DATES/SPOTS,'                                        
         LA    R6,12(R6)                                                        
*                                                                               
         BCTR  R6,0                                                             
         CLI   0(R6),C','                                                       
         BNE   *+8                                                              
         MVI   0(R6),C' '                                                       
*                                                                               
DOVR0038 DS    0H                                                               
         BRAS  RE,BUMPLINE                                                      
         ST    R2,DMCB                                                          
*                                                                               
DOVR0040 DS    0H                                                               
         TM    BUYSEG.TLBYAFLG,X'40' BUYLINK?                                   
         BZ    DOVR0160              NO                                         
*                                                                               
         BRAS  RE,ISEOSCR          REACH END OF SCREEN?                         
         BH    DOVRNO              YES, EXIT                                    
*                                                                               
         TM    BYTE,X'80'          DISPLAYING DAILY?                            
         BO    DOVR0160            SKIP THE LAST LINE                           
*                                                                               
DOVR0045 DS    0H                  IF BUY LINK                                  
*                                  NEED TO DISPLAY THE                          
*                                  LINES IN : A1+A5+A7 FORMAT                   
*                                                                               
* DISPLAY COLOR                                                                 
         GOTOR DISCOLOR,AGYCOLOR                                                
*                                                                               
         NI    DSLINEH+1,X'FF'-X'08' TURN OFF HIGH INTENSITY                    
         LA    R6,DSLINE                                                        
         MVC   0(OVRD1Q,R6),OVRD1                                               
         LA    R6,OVRD1Q+1(R6)                                                  
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TR.TLBLINDX,BUYSEG.TLBYALNK                                      
         MVI   TR.TLKTYP,C'A'                                                   
*                                                                               
         GOTO1 GOTSAR,TSARDH       READ BUYLINK RECORD                          
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,TR.TLBLBUY#                                                   
         USING TLBLBUY#,R3                                                      
*                                                                               
         CLI   0(R3),0                                                          
         BE    DOVR0100                                                         
*                                                                               
         BRAS  RE,ISEOSCR          END OF SCREEN - EXIT                         
         BH    DOVRNO                                                           
*                                                                               
DOVR0050 DS    0H                                                               
         GOTOR GETBUY#,DMCB,(1,(R3))   TRANSLATE BUY NUMBER                     
         BNE   DOVR0060                                                         
         LA    R4,DMCB+4                                                        
         EDIT  (2,(R4)),(4,(R6)),ALIGN=LEFT,FLOAT=A                             
         B     DOVR0070                                                         
*                                                                               
DOVR0060 EDIT  (1,0(R3)),(3,0(R6)),ALIGN=LEFT,FLOAT=A                           
*                                                                               
DOVR0070 LA    R3,TLBLLENQ(R3)                                                  
         CLI   0(R3),0                                                          
         BE    DOVR0100                                                         
*                                                                               
                                                                                
DOVR0080 LA    R6,DSLINE+L'DSLINE-1                                             
         LR    RF,R6                                                            
         LA    R1,DSLINE                                                        
         SHI   RF,5                                                             
*                                                                               
DOVR0086 CR    R6,R1                                                            
         BNH   DOVR0090                                                         
         CLI   0(R6),X'40'                                                      
         BH    *+8                                                              
         BCT   R6,DOVR0086                                                      
*                                                                               
DOVR0090 CR    R6,RF                                                            
         BNH   *+12                                                             
         BRAS  RE,BUMPLINE         NEW LINE IF HIT END OF LINE                  
         B     DOVR0080                                                         
*                                                                               
         MVI   1(R6),C'+'                                                       
*                                                                               
         LA    R6,2(R6)                                                         
         B     DOVR0050                                                         
*                                                                               
DOVR0100 DS    0H                                                               
         BRAS  RE,BUMPLINE                                                      
         ST    R2,DMCB                                                          
*                                                                               
DOVR0160 DS    0H                                                               
*                                                                               
DOVRYES  SR    R5,R5                                                            
         ST    R2,DMCB                                                          
DOVRNO   LTR   R5,R5                                                            
DOVRX    DS    0H                                                               
         B     EXIT                                                             
         DROP  BUYSEG                                                           
OVRD1    DC    C'BASED UPON AGENCY LINE DATA FROM  '                            
OVRD1Q   EQU   *-OVRD1                                                          
*                                                                               
NOCHANGE DC    C'NO CHANGE WILL BE MADE TO REP LINE'                            
NOCHANGQ EQU   *-NOCHANGE                                                       
*                                                                               
ADDNEW   DC    C'THIS WILL BECOME A NEW REP LINE   '                            
ADDNEWQ  EQU   *-ADDNEW                                                         
*                                                                               
CANCEL   DC    C'REP LINE(S) WILL BE CANCELLED     '                            
CANCELQ  EQU   *-CANCEL                                                         
*                                                                               
CANCEL2  DC    C'SPOTS CANCELLED ON DAILY BUY. REP LINE WILL BE ZEROE'          
         DC    C'D OUT'                                                         
CANCEL2Q  EQU  *-CANCEL2                                                        
*                                                                               
*'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''          
* DISPGM: DISPLAY PROGRAM NAME                                                  
* P1 = ADDRESS THIS ROUTINE WRITES THE PROGRAM NAME TO                          
* P2 = TXNUM (TSAR NUMBER) OF THE PROGRAM NAME TSAR RECORD                      
*.....................................................................          
DISPGM   NTR1  BASE=*,WORK=(R4,DOSMWKQ),LABEL=*                                 
         USING DOSMWKD,R4                                                       
         MVC   DOSSVTR#,TXNUM      SAVE THESE OFF                               
         MVC   RTSARREC,TSARREC                                                 
*                                                                               
         LM    R2,R3,0(R1)                                                      
         MVC   TXNUM,0(R3)                                                      
*                                                                               
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,TR.TLPGLEN                                                  
         BCTR  RF,0                                                             
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),TR.TLPGNAME                                              
*                                                                               
         AR    R2,RF               WHERE IT ENDS                                
         AHI   R2,1                1 FOR EX                                     
         ST    R2,DMCB                                                          
*                                                                               
DPGMYES  SR    RC,RC                                                            
DPGMNO   LTR   RC,RC                                                            
DPGMX    DS    0H                                                               
         MVC   TXNUM,DOSSVTR#                                                   
         MVC   TSARREC,RTSARREC                                                 
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*---------------------------------------------------------------------          
* GETPGMLN: CALCULATE TO SEE IF L(AGY PGM) + L(REP PGM) WILL FIT                
*           ON THE SCREEN DISPLAY LINE                                          
*           PRINTING SHOULDN'T HAVE THIS PROBLEM, SO THIS IS ONLY               
*           CALLED WHEN DISPLAYING ON SCREEN                                    
*---------------------------------------------------------------------          
GETPGMLN NTR1  BASE=*,WORK=(R4,SMWORKQ),LABEL=*                                 
         USING SMWORKD,R4                                                       
         MVC   SMTXNUM,TXNUM                                                    
         MVC   SMWORK1,TSARREC                                                  
*                                                                               
         SR    R6,R6                                                            
         LM    R2,R3,0(R1)                                                      
         OC    0(2,R2),0(R2)                                                    
         BNZ   *+12                                                             
         AHI   R6,5                NULL PROGRAM NAME = 6 CHARACTER LONG         
         B     GPGML200                                                         
*                                                                               
         MVC   TXNUM,0(R2)                                                      
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,TR.TLPGLEN                                                  
         AR    R6,RF               OVERHEAD                                     
*                                                                               
GPGML200 DS    0H                                                               
         OC    0(2,R3),0(R3)                                                    
         BNZ   *+12                                                             
         AHI   R6,5                NULL PROGRAM NAME = 6 CHARACTER LONG         
         B     GPGML300                                                         
*                                                                               
         MVC   TXNUM,0(R3)                                                      
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,TR.TLPGLEN                                                  
         AR    R6,RF                                                            
*                                                                               
GPGML300 DS    0H                                                               
         AHI   R6,L'AGYPGM+L'REPPGM                                             
         AHI   R6,4                SPACE                                        
*                                                                               
         CHI   R6,L'DSLINE                                                      
         BH    GPGMLNO                                                          
*                                                                               
GPGMLYES SR    RC,RC                                                            
GPGMLNO  LTR   RC,RC                                                            
GPGMLX   DS    0H                                                               
         MVC   TXNUM,SMTXNUM                                                    
         MVC   TSARREC,SMWORK1                                                  
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
         DROP  R4                                                               
MAXLPGM  EQU   25                                                               
AGYPGM   DC    C'APGM:'                                                         
REPPGM   DC    C'RPGM:'                                                         
PGMNOTE  DC    C'REP PGM NAME WILL NOT UPDATE'                                  
*                                                                               
*&&DO                                                                           
*---------------------------------------------------------------------          
* DISPLAY SPOT DIFFERENCE                                                       
*---------------------------------------------------------------------          
DISSPDIF NTR1  BASE=*,LABEL=*                                                   
         L     R8,ASPOOLD                                                       
         USING SPOOLD,R8                                                        
         L     R2,0(R1)                                                         
         USING DIFFSUM,R2                                                       
         MVC   BYTE,0(R1)                                                       
*                                                                               
         TM    FLAGS,FGPRTQ                                                     
         BZ    *+10                                                             
         XC    DSLINE(L'P),DSLINE                                               
BUYSEG   USING TLSTD,GNXSVREC                                                   
*&&DO                                                                           
         LA    RF,DIFEND           REACH END OF SCREEN?                         
         SHI   RF,LISTLEN                                                       
         CR    R2,RF                                                            
*&&                                                                             
         BRAS  RE,ISEOSCR          REACH END OF SCREEN?                         
         BH    DSPDNO                                                           
*                                                                               
DSPD0100 DS    0H                                                               
         BRAS  RE,BUMPLINE                                                      
*&&DO                                                                           
         TM    FLAGS,FGPRTQ                                                     
         BZ    DSPD0150                                                         
*                                                                               
         LA    R2,LISTLENP(R2)                                                  
         B     DSPD0160                                                         
*                                                                               
DSPD0150 DS    0H                                                               
         LA    R2,LISTLEN(R2)                                                   
*&&                                                                             
DSPD0160 DS    0H                                                               
DSPDYES  SR    R5,R5                                                            
         ST    R2,DMCB                                                          
DSPDNO   LTR   R5,R5                                                            
DSPDX    DS    0H                                                               
         B     EXIT                                                             
         DROP  BUYSEG                                                           
DSPD1    DC    C'CHANGE (+/-) OF DATES/SPOTS ='                                 
DSPD1Q   EQU   *-DSPD1                                                          
*&&                                                                             
*                                                                               
***********************************************************************         
* GETPROF1 GET MATCHING PROFILE FROM THE DARE PROF RECORD                       
* PROFILES 7 AND 8 ARE FOR BUYS THAT 'MATCH'. MATCH IS DEFINED BY               
*   HAVING THE SAME DAY/TIME/LEN/RATE (AND PROGRAM NAME FOR TV):                
* IF 7 = OFF AND 8 = OFF: ASSUMED MATCH                                         
* IF 7 = ON             : PROPOSED MATCH                                        
* IF 7 = OFF AND 8 = ON : NO MATCH                                              
*                                                                               
* IF REP AND AGENCY BUYS DO NOT MATCH, BUT WERE PREVIOUSLY LINKED AND           
* CURRENTLY DO NOT MATCH ANYTHING ELSE:                                         
* IF 9 = OFF AND 10 = OFF: PROPOSED MATCH                                       
* IF 9 = ON              : ASSUMED MATCH                                        
* IF 9 = OFF AND 10 = ON : NO MATCH                                             
***********************************************************************         
GETPROF1 NTR1  BASE=*,LABEL=*                                                   
         XC    MFLAG,MFLAG                                                      
         XC    LFLAG,LFLAG                                                      
         XC    CFLAG,CFLAG                                                      
*                                                                               
         LR    R4,RA                                                            
         AHI   R4,DARPROFS-CONHEADH                                             
         USING SVDSECT,R4                                                       
*                                                                               
         TM    SVDGPBIT+DARPPMTB,DARPPMTA                                       
         BO    GET0030                                                          
         TM    SVDGPBIT+DARNOMTB,DARNOMTA                                       
         BO    GET0050             ALL IN NOMATCH SECTION                       
         MVI   MFLAG,MASSUMEQ                                                   
         B     GET0100                                                          
GET0030  DS    0H                                                               
         MVI   MFLAG,MPROPSEQ                                                   
         B     GET0100                                                          
GET0050  DS    0H                                                               
         MVI   MFLAG,MNOMTCHQ                                                   
GET0100  DS    0H                                                               
*                                                                               
         TM    SVDGPBIT+DARLASMB,DARLASMA                                       
         BO    GET0130                                                          
         TM    SVDGPBIT+DARLNMTB,DARLNMTA                                       
         BO    GET0150             NO MATCH                                     
         MVI   LFLAG,LPROPSEQ                                                   
         B     GET0200                                                          
GET0130  DS    0H                                                               
         MVI   LFLAG,LASSUMEQ      ASSUME MATCH                                 
         B     GET0200                                                          
GET0150  DS    0H                                                               
         MVI   LFLAG,LNOMTCHQ                                                   
GET0200  DS    0H                                                               
         TM    SVDGPBIT+DARSPDFB,DARSPDFA                                       
         BZ    *+8                 SHOW SPOT DIFFERENCE                         
         OI    CFLAG,CSPDIFQ                                                    
*                                                                               
GETPROFX DS    0H                                                               
         B     EXIT                                                             
         DROP  R4                                                               
*----------------------------------------------------------------------         
* PROCSCR: PROCESS USER INPUT FROM THE SCREEN                                   
*----------------------------------------------------------------------         
PROCSCR  NTR1  BASE=*,LABEL=*                                                   
         LA    R2,DIFLISTH                                                      
         USING DIFFSUM,R2                                                       
*                                                                               
PROC0050 DS    0H                                                               
         TM    DSINPUTH+4,X'C0'    FIELD INPUT THIS TIME?                       
         BO    PROC0100            YES                                          
*                                                                               
         TM    DSTYPAH+4,X'C0'     FIELD INPUT BEFORE?                          
         BNO   PROC0500                                                         
*                                                                               
         CLI   DSINPUT,C'M'                                                     
         BNE   MISSINP                                                          
                                                                                
PROC0100 DS    0H                                                               
         GOTOR PROCLINE,DMCB,(R2)  PROCESS THIS LINE                            
*                                                                               
         NI    DSINPUTH+4,X'FF'-X'80'                                           
         NI    DSTYPAH+4,X'FF'-X'80'                                            
*                                                                               
PROC0500 DS    0H                                                               
         LA    R2,LISTLEN(R2)      NEXT LINE                                    
         LA    RF,DIFENDH          END OF SCREEN?                               
         CR    R2,RF                                                            
         BNH   PROC0050                                                         
*                                                                               
PROCSCRX DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*----------------------------------------------------------------------         
* PROTSCR: PROTECT THE SCREEN STARTS FROM DIFLIST                               
*----------------------------------------------------------------------         
PROTSCR  NTR1  BASE=*,LABEL=*                                                   
         LA    R2,DIFLISTH                                                      
         USING DIFFSUM,R2                                                       
*                                                                               
PROT0050 DS    0H                                                               
         OI    DSINPUTH+1,X'20'                                                 
         OI    DSTYPAH+1,X'20'                                                  
*                                                                               
         LA    R2,LISTLEN(R2)      NEXT LINE                                    
         LA    RF,DIFENDH                                                       
         CR    R2,RF               END OF SCREEN -DONE                          
         BNH   PROT0050                                                         
*                                                                               
PROTSCRX DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
         DROP  R2                                                               
*----------------------------------------------------------------------         
* PROCLINE: PROCESS LINE                                                        
* USER CAN EITHER ENTER C'M', OR C'U', OR NO INPUT                              
* P1 = THE LINE THAT THIS ROUTINE NEEDS TO PROCESS                              
*                                                                               
*----------------------------------------------------------------------         
PROCLINE NTR1  BASE=*,LABEL=*                                                   
         L     R4,0(R1)                                                         
         USING DIFFSUM,R4                                                       
         MVI   DAILY#,0                                                         
*                                                                               
         LA    R2,DSINPUTH         R2->INPUT FIELD                              
*                                                                               
         CLI   DSINPUT,INPUTM      INPUT 'M' - OK                               
         BE    PLIN0010                                                         
*                                                                               
         CLI   DSINPUT,INPUTU      INPUT 'U' - OK                               
         BE    PLIN0010                                                         
*                                                                               
         OC    DSINPUT,DSINPUT     NO INPUT - OK                                
         BZ    PLIN0010                                                         
*                                                                               
         B     MISSM               OTHERWISE, ERROR                             
*                                                                               
PLIN0010 DS    0H                                                               
         CLI   DSINPUT,INPUTM      INPUT 'M'                                    
         BNE   PLIN0020                                                         
*                                                                               
         OC    DSAGYBY,DSAGYBY     DID THEY ENTER A NUMBER TO MATCH?            
         BZ    MISSLIN             NO, ERROR                                    
*                                                                               
         B     PLIN0030            YES, OK                                      
*                                                                               
PLIN0020 DS    0H                  UNMATCH                                      
         OC    DSAGYBY,DSAGYBY     VALIDATE AGENCY LINE#                        
         BNZ   PLIN0030            MISS AGENCY LINE                             
*                                                                               
         GOTOR MYHEXIN,DMCB,DSTYPR,REP#                                         
         BNE   PLINX                                                            
*                                                                               
         GOTOR SRCHTABR,DMCB,REP#  USER CLEAR BOTH M AND AGENCY                 
         BNE   PLINX               FIELD TO UNMATCH, NEED TO                    
*                                  RECOVER THE AGENCY LINE # FROM TABL          
*                                                                               
         L     R3,DMCB             DMCB = A(TABLE ENTRY)                        
         MVC   AGY#,0(R3)                                                       
         B     PLIN0040                                                         
*                                                                               
PLIN0030 DS    0H                                                               
         GOTOR MYHEXIN,DMCB,DSTYPA,AGY#                                         
         BNE   PLINX               VALIDATE AGENCY NUMBER                       
*                                                                               
         CLI   DSTYPA,C'1'         FIRST CHARACTER > 1                          
         BNL   PLIN0035            OK                                           
*                                                                               
         CLI   DSTYPA,C'A'         IF NOT, IT MUST BE C'A'                      
         BNE   INVLFLD             OR ERROR                                     
*                                                                               
PLIN0035 DS    0H                                                               
         GOTOR MYHEXIN,DMCB,DSTYPR,REP#                                         
         BNE   PLINX                                                            
*                                                                               
PLIN0040 DS    0H                                                               
         GOTOR SRCHTAB,DMCB,AGY#,REP#   SEARCH TABLE                            
*                                                                               
PLIN0050 DS    0H                                                               
         L     R3,DMCB             A(NEXT AVAILABLE SLOT)                       
*                                                                               
         XC    TSARREC,TSARREC     CHECK TO SEE IF DAILY/C.O                    
         MVI   TR.TLKTYP,X'0E'                                                  
         MVI   TR.TLBPTYP,C'A'                                                  
         MVC   TR.TLBPBUY#,AGY#                                                 
         GOTO1 GOTSAR,TSARDH                                                    
         BNE   MATCHER             NO AGY SEGMENT? ERROR                        
*                                                                               
         MVC   DAILY#,TR.TLBPMLNK  SAVE OFF DAILY #                             
*                                                                               
         CLI   DSINPUT,INPUTM      MATCHING?                                    
         BNE   PLIN0500                                                         
*                                                                               
         CLI   SRCHFLG,SRCHAGY     AGY ALREADY MATCH TO OTHER LINES             
         BNE   PLIN0080            ERROR                                        
         CLI   DAILY#,0                                                         
         BE    MATCHER             NOT DAILY/C.O? ERROR!                        
*                                                                               
         LA    R3,MTCHTAB                                                       
PLIN0070 DS    0H                  ELSE, ADD THIS LINE TO TABLE                 
         CLC   0(L'TABTERM,R3),TABTERM                                          
         BE    PLIN0080                                                         
         LA    R3,MTCHTABL(R3)                                                  
         B     PLIN0070                                                         
*                                                                               
PLIN0080 DS    0H                  ELSE, ADD THIS LINE TO TABLE                 
         CLI   SRCHFLG,SRCHMTH     AGY LINE ALREADY MATCHED TO THIS             
         BE    PLINX               LINE, DO NOTHING                             
*                                                                               
         GOTOR VALDAILY            VALIDATE DAILY/C.OVERRIDE                    
         BNE   DAILYERR                                                         
*                                                                               
PLIN0100 DS    0H                  ELSE, ADD THIS LINE TO TABLE                 
         GOTOR SRCHTABR,DMCB,REP#  REP LINE MATCH TO SOMETHING ELSE             
         BNE   PLIN0150                                                         
         L     R3,DMCB             YES                                          
*                                                                               
PLIN0120 DS    0H                  DELETE THAT ENTRY FIRST                      
         GOTOR PROCTAB,DMCB,(X'02',AGY#),REP#,(R3),(R4)                         
         GOTOR SRCHTAB,DMCB,AGY#,REP#   SEARCH TABLE                            
         BE    PLIN0120                                                         
         BRAS  RE,ENDOFTAB                                                      
*                                                                               
PLIN0150 DS    0H                  THEN, ADD THIS LINE TO TABLE                 
         GOTOR PROCTAB,DMCB,(X'01',AGY#),REP#,(R3),(R4)                         
*                                  ADD ENTRY                                    
         B     PLINX                                                            
*                                                                               
PLIN0500 DS    0H                  UNDO MATCHING                                
         CLI   SRCHFLG,SRCHMTH     EXACT MATCH FOUND IN TABLE?                  
         BE    PLIN0520                                                         
         CLI   SRCHFLG,SRCHAGY     FOUND MATCHING AGENCY LINE?                  
         BNE   PLINX                                                            
         CLI   DAILY#,0            NOT DAILY?                                   
         BE    PLINX                                                            
*                                  ELSE,DELETE ENTRY                            
PLIN0520 DS    0H                  UNDO MATCHING                                
         GOTOR PROCTAB,DMCB,(X'02',AGY#),REP#,(R3),(R4)                         
         GOTOR SRCHTAB,DMCB,AGY#,REP#   SEARCH TABLE                            
         BE    PLIN0520                                                         
*                                                                               
         GOTOR CHKMTH              CHECK IF UNMATCHING A MATCH SEGMENT          
         BNE   *+8                 SO WE CAN OUTPUT AN ERROR MESSSAGE           
         OI    DISFLG1,D1UNMTHQ                                                 
*                                                                               
PLINX    DS    0H                                                               
         B     EXIT                                                             
         DROP  R4                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*  REP LINE: CHECK TO SEE IF THIS BUY LINE IS CREATED OUT OF DAILY/COST         
*            OVERRIDE AND IF IT IS STILL LINK TO AN DAILY/COST OVERRIDE         
*  AGY LINE: IF THIS IS A SINGLE COMPONENT AGENCY DAILY BUY, AND IT             
*            IS NOT BEING LINKED TO BY ANY REP LINE, TREAT THIS AS A            
*            NON-DAILY BUY                                                      
*  OUTPUT:                                                                      
*        CC EQU: IT IS A VALID DAILY BUY                                        
*        CC NEQ: IT IS NOT VALID DAILY BUY                                      
*                                                                               
*        DMCB+0: X'80'  DO NOT USE THIS BIT, RESERVED                           
*                X'40'  AGENCY BUY IS A SINGLE DAILY THAT'S NOT BEING           
*                       REFERENCED BY ANY REP BUYS                              
*                X'20'  REP LINE LINKS TO A AGENCY BUY THAT HAS BEEN            
*                       DELETED, SO TREAT AS A NON-DAILY                        
*                X'10'  THIS IS A DAILY BUY                                     
***********************************************************************         
BUYD     USING RBUYREC,R2                                                       
         USING ELWORKD,R4                                                       
ISDAILY  NTR1  BASE=*,WORK=(R4,ELWORKQ),LABEL=*                                 
         L     R2,0(R1)                                                         
*                                                                               
         MVC   ELSVIO,AIO                                                       
         MVC   ELSVKEY,KEY                                                      
         XC    ELBYTE,ELBYTE                                                    
*                                                                               
         TM    BUYD.RBUYFLG2,X'80' DAILY?                                       
         BZ    ISDLY020                                                         
         OI    ELBYTE,X'10'                                                     
         B     ISDLY050                                                         
*                                                                               
ISDLY020 LR    R6,R2                                                            
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   ISDLYNO                                                          
*                                                                               
         USING RBUYXXEL,R6                                                      
         TM    RBUYXXFG,X'40'      COST OVERRRIDE?                              
         BO    ISDLY050                                                         
*&&CD                                                                           
         TM    RBUYXXFG,X'10'      CONFLICT END DATE?                           
         BZ    ISDLYNO                                                          
*&&                                                                             
         DROP  R6                                                               
*                                                                               
ISDLY050 DS    0H                                                               
         CLC   =X'0B01',0(R2)                                                   
         BNE   ISDLY060                                                         
*                                                                               
         SR    R3,R3               CLEAR COUNTER                                
         XC    KEY,KEY                                                          
         MVC   KEY(RBUYKLIN-RBUYKEY),BUYD.RBUYKEY                               
         GOTO1 HIGH                                                             
*                                                                               
ISDLY052 CLC   KEYSAVE(26),KEY                                                  
         BNE   ISDLY054            NOT SAME GROUP                               
         AHI   R3,1                SAME, INCREASE COUNTER                       
         GOTO1 SEQ                 READ NEXT BUY                                
         B     ISDLY052                                                         
*                                                                               
ISDLY054 CHI   R3,1                SINGLE COMPONENT DAILYS?                     
         BH    ISDLYYES            NO, MORE THAN 1 - EXIT                       
*                                                                               
* YES, SEARCH THE TABLE OF "NO REP LINK AGENCY" TABLE                           
* IF THIS AGENCY LINE HAS NO REP LINE LINK TO IT                                
* TEAT THIS LINE AS A NON-DAILY                                                 
*                                                                               
         MVC   KEY,ELSVKEY         RELOAD THE KEY                               
K        USING RBUYKEY,KEY                                                      
*                                                                               
         ZIC   R1,K.RBUYKMLN                                                    
         STH   R1,HALF                                                          
         L     R3,TABCT                                                         
*                                                                               
         L     RF,ACOMFACS                                                      
         USING COMFACSD,RF                                                      
*                                                                               
         GOTO1 CBINSRCH,DMCB,(X'00',HALF),AGYBTAB,(R3),2,              X        
               (0,2),L'AGYBTAB/2                                                
         TM    DMCB,X'01'                                                       
         BO    ISDLYYES            NOT IN TABLE - SKIP                          
*                                                                               
         OI    ELBYTE,X'40'        SET OUTPUT FLAG                              
         B     ISDLYNO             IN TABLE, THIS AGY HAS NO REP LINK           
*                                  TREAT IT LIKE NON-DAILY                      
         DROP  RF                                                               
         DROP  K                                                                
*                                                                               
ISDLY060 LA    RE,ELIO3            ONLY DO THIS FOR REP LINE                    
         ST    RE,AIO                                                           
         XC    KEY,KEY                                                          
         MVC   KEY(RBUYKMLN-RBUYKEY),BUYD.RBUYKEY                               
*                                                                               
K        USING RBUYKEY,KEY                                                      
         MVI   KEY+1,X'01'                                                      
         MVC   K.RBUYKMLN,BUYD.RBUYAGBL                                         
         DROP  K                                                                
*                                                                               
         GOTO1 HIGH                                                             
         CLC   KEYSAVE(26),KEY                                                  
         BE    ISDLY062            AGY LINE IS CANCELLED                        
*                                                                               
         OI    ELBYTE,X'20'        SET AGY LINE CANCELLED FLAG                  
         B     ISDLYNO                                                          
*                                                                               
ISDLY062 GOTO1 GETREC                                                           
         L     R6,AIO                                                           
SDOW     USING RBUYREC,R6                                                       
*                                                                               
         TM    SDOW.RBUYFLG2,X'80'   DAILY?                                     
         BO    ISDLYYES                                                         
*                                                                               
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   ISDLYNO             NO 10 ELEMENT                                
*                                                                               
         DROP  SDOW                                                             
*                                                                               
         USING RBUYXXEL,R6                                                      
*&&CT                                                                           
         TM    RBUYXXFG,X'40'      COST OVERRRIDE?                              
         BZ    ISDLYNO                                                          
*&&                                                                             
*&&CD                                                                           
         TM    RBUYXXFG,X'40'      COST OVERRRIDE?                              
         BO    ISDLYYES                                                         
         TM    RBUYXXFG,X'10'      CONFLICT END DATE?                           
         BZ    ISDLYNO                                                          
*&&                                                                             
*                                                                               
ISDLYYES DS    0H                                                               
         NI    ELBYTE,FF-X'80'                                                  
         B     ISDLYX                                                           
ISDLYNO  DS    0H                                                               
         OI    ELBYTE,X'80'                                                     
ISDLYX   DS    0H                                                               
         MVC   AIO,ELSVIO                                                       
         MVC   KEY,ELSVKEY                                                      
         GOTO1 HIGH                                                             
         MVC   DMCB(1),ELBYTE      RETURN FLAG                                  
         TM    ELBYTE,X'80'                                                     
         B     EXIT                                                             
         DROP  R6                                                               
         DROP  BUYD                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*&&DO                                                                           
***********************************************************************         
*  CHECK TO SEE IF THIS REP BUY LINE IS CREATED OUT OF DAILY/COST OVER          
*  RIDE AND IF IT IS STILL LINK TO AN DAILY/COST OVERRIDE                       
***********************************************************************         
ISDAILY  NTR1  BASE=*,WORK=(R4,ELWORKQ),LABEL=*                                 
         L     R2,0(R1)                                                         
BUYD     USING RBUYREC,R2                                                       
*                                                                               
         USING ELWORKD,R4                                                       
         MVC   ELSVIO,AIO                                                       
         MVC   ELSVKEY,KEY                                                      
*                                                                               
         TM    BUYD.RBUYFLG2,X'80' DAILY?                                       
         BO    ISDLYYES                                                         
*                                                                               
         LR    R6,R2                                                            
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   ISDLY050                                                         
*                                                                               
         USING RBUYXXEL,R6                                                      
         TM    RBUYXXFG,X'40'      COST OVERRRIDE?                              
         BO    ISDLYYES                                                         
*&&CD                                                                           
         TM    RBUYXXFG,X'10'      CONFLICT END DATE?                           
         BO    ISDLYYES                                                         
*&&                                                                             
         DROP  R6                                                               
*                                                                               
ISDLY050 DS    0H                                                               
         CLC   =X'0B01',0(R2)                                                   
         BE    ISDLYNO                                                          
*                                                                               
         LA    RE,ELIO3            ONLY DO THIS FOR REP LINE                    
         ST    RE,AIO                                                           
         XC    KEY,KEY                                                          
         MVC   KEY(RBUYKMLN-RBUYKEY),BUYD.RBUYKEY                               
*                                                                               
K        USING RBUYKEY,KEY                                                      
         MVI   KEY+1,X'01'                                                      
         MVC   K.RBUYKMLN,BUYD.RBUYAGBL                                         
         DROP  K                                                                
*                                                                               
         GOTO1 HIGH                                                             
         CLC   KEYSAVE(26),KEY                                                  
         BNE   ISDLYNO             AGY LINE IS CANCELLED                        
*        DC    H'0'                                                             
*                                                                               
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO                                                           
SDOW     USING RBUYREC,R6                                                       
         TM    SDOW.RBUYFLG2,X'80'   DAILY?                                     
         BO    ISDLYYES                                                         
*                                                                               
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   ISDLYNO             NO 10 ELEMENT                                
*                                                                               
         DROP  SDOW                                                             
*                                                                               
         USING RBUYXXEL,R6                                                      
*&&CT                                                                           
         TM    RBUYXXFG,X'40'      COST OVERRRIDE?                              
         BZ    ISDLYNO                                                          
*&&                                                                             
*&&CD                                                                           
         TM    RBUYXXFG,X'40'      COST OVERRRIDE?                              
         BO    ISDLYYES                                                         
         TM    RBUYXXFG,X'10'      CONFLICT END DATE?                           
         BZ    ISDLYNO                                                          
*&&                                                                             
*                                                                               
ISDLYYES DS    0H                                                               
         MVC   AIO,ELSVIO                                                       
         MVC   KEY,ELSVKEY                                                      
         GOTO1 HIGH                                                             
         SR    RC,RC                                                            
         B     EXIT                                                             
ISDLYNO  DS    0H                                                               
         MVC   AIO,ELSVIO                                                       
         MVC   KEY,ELSVKEY                                                      
         GOTO1 HIGH                                                             
         LTR   RC,RC                                                            
         B     EXIT                                                             
         DROP  R6                                                               
         DROP  BUYD                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*&&                                                                             
***********************************************************************         
* CHECK TO SEE IF THE UNMATCHING IS DONE ON A MATCHING SECTION                  
* IF SO, SET CONDITION CODE                                                     
* THIS IS SO THAT WE CAN OUTPUT AN ERROR MESSAGE AND FORCE THE                  
* MORONS TO HIT PF 8 TO PREVIEW THE UNMATCHING                                  
***********************************************************************         
CHKMTH   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    TSARREC,TSARREC     CHECK TO SEE IF AGENCY LINE                  
         MVI   TR.TLKTYP,X'0E'     AND REP LINE BELONG TO THE SAME              
         MVI   TR.TLBPTYP,C'A'     SEGMENT                                      
         MVC   TR.TLBPBUY#,AGY#                                                 
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*        BNE   ERNOLINE            THIS LINE IS NOT ON AGENCY ORDER             
*                                                                               
         MVC   TSRNUMA,TR.TLBPSEG#                                              
*                                                                               
*** TRAP ERROR                                                                  
         OC    TSRNUMA,TSRNUMA                                                  
         BNZ   *+6                                                              
         DC    H'0'                                                             
*** TRAP ERROR                                                                  
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,TSRNUMA       REP SEGMENT                                  
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLI   TR.TLBYFLG,TLMTHQ                                                
CHKMTHX  DS    0H                                                               
         B     EXIT                                                             
*                                                                               
**********************************************************************          
* MYHEXIN LOOKS AT THE EBCDIC INPUT FIELD THAT GOT PASSED IN AND OUTPUT         
* THE BINARY OF IT                                                              
* P1 = A(USER INPUT FIELD)                                                      
* P2 = A(OUT PUT)                                                               
**********************************************************************          
MYHEXIN  NTR1  BASE=*,LABEL=*                                                   
         LM    R2,R3,0(R1)                                                      
*                                                                               
         LA    R6,L'DSAGYBY(R2)    R6 = END OF INPUT FIELD                      
*                                                                               
         CLI   0(R2),C'0'                                                       
         BE    INVLFLD             THE INPUT FIELD COULD                        
         BL    MYHX0050            POTENTIALLY BE 3 CHARACTERS                  
         B     MYHX0100                                                         
*                                  A31 OR 131 IF LINES GO OVER                  
MYHX0050 DS    0H                                                               
         LA    R2,1(R2)                                                         
*                                                                               
MYHX0100 DS    0H                                                               
         CLI   0(R6),C' '                                                       
         BH    *+8                                                              
         BCT   R6,*-8                                                           
*                                                                               
         CLI   0(R6),C'+'                                                       
         BNE   MYHX0150                                                         
         XC    0(1,R6),0(R6)                                                    
         B     MYHX0100                                                         
*                                                                               
MYHX0150 DS    0H                                                               
         LR    R4,R2                                                            
MYHX0180 DS    0H                                                               
         CR    R4,R6                                                            
         BH    MYHX0200                                                         
         CLI   0(R4),C'0'                                                       
         BL    MYHXNO                                                           
         CLI   0(R4),C'9'                                                       
         BH    MYHXNO                                                           
         LA    R4,1(R4)                                                         
         B     MYHX0180                                                         
MYHX0200 DS    0H                                                               
         SR    R6,R2                                                            
         BM    MYHXNO              IF > 0, WE ARE OK                            
         EX    R6,EXPACK                                                        
         CVB   R0,DUB                                                           
*                                                                               
         STCM  R0,3,FULL                                                        
         GOTOR GETBUY#,DMCB,(2,FULL)                                            
         BNE   MYHX0300                                                         
         IC    R0,DMCB+4                                                        
*                                                                               
MYHX0300 STC   R0,0(R3)                                                         
MYHXYES  SR    RC,RC                                                            
MYHXNO   LTR   RC,RC                                                            
MYHEXINX DS    0H                                                               
         B     EXIT                                                             
EXPACK   PACK  DUB,0(0,R2)                                                      
         EJECT                                                                  
***********************************************************************         
* SRCHTAB: SEARCH TABLE (SEQUENTICAL SEARCH, NO TRICK WHATSOEVER!)              
* P1:                                                                           
*      BYTE2-4  = A(AGY LINE#)                                                  
***********************************************************************         
SRCHTAB  NTR1  BASE=*,LABEL=*                                                   
         LM    R2,R3,0(R1)                                                      
         LA    R4,MTCHTAB                                                       
         USING MTCHTABD,R4                                                      
         XC    SRCHFLG,SRCHFLG                                                  
*                                                                               
SRCH0050 DS    0H                                                               
         CLC   ABUY#(L'TABTERM),TABTERM  END OF ENTRY?                          
         BE    SRCHNO                                                           
         CLC   ABUY#,0(R2)         FOUND?                                       
         BE    SRCHYES                                                          
         LA    R4,MTCHTABL(R4)                                                  
         B     SRCH0050                                                         
*** THIS NEEDS TO BE REFINED SO THAT AGY&REP LINES DO NOT HAVE TO BE            
*** ON THE SAME ENTRY TO BE AN EXACT MATCH, AS LONG AS THEY ARE IN              
*** THE SAME GROUP                                                              
SRCHYES  DS    0H                                                               
         MVI   SRCHFLG,SRCHAGY     AGY LINE MATCH                               
         CLC   RBUY#,0(R3)                                                      
         BNE   *+8                                                              
         MVI   SRCHFLG,SRCHMTH     EXACT MATCH                                  
*                                                                               
         LA    R6,MTCHTAB                                                       
*                                                                               
SRCH0080 DS    0H                                                               
         CR    R6,R4               IF THIS IS THE FIRST GROUP IN TABLE          
         BE    SRCH0120            THERE IS NO DELIMITER BEFORE IT              
         SHI   R4,MTCHTABL                                                      
         CLI   0(R4),GRPTERM                                                    
         BNE   SRCH0080                                                         
         LA    R4,MTCHTABL(R4)                                                  
SRCH0120 DS    0H                                                               
         ST    R4,DMCB                                                          
         B     EXITOK                                                           
*                                                                               
SRCHNO   ST    R4,DMCB                                                          
         MVI   SRCHFLG,SRCHNOM     NO MATCH                                     
         B     EXITH                                                            
         DROP  R4                                                               
*                                                                               
***********************************************************************         
* SRCHTAB: SEARCH TABLE (SEQUENTICAL SEARCH, NO TRICK WHATSOEVER!)              
* P1:                                                                           
*      BYTE2-4  = A(REP LINE#)                                                  
***********************************************************************         
SRCHTABR NTR1  BASE=*,LABEL=*                                                   
         L     R2,0(R1)                                                         
         LA    R4,MTCHTAB                                                       
         USING MTCHTABD,R4                                                      
*                                                                               
SRCR0050 DS    0H                                                               
         CLC   ABUY#(L'TABTERM),TABTERM END OF ENTRY?                           
         BE    SRCRNO                                                           
         CLC   RBUY#,0(R2)         FOUND?                                       
         BE    SRCRYES                                                          
         LA    R4,MTCHTABL(R4)                                                  
         B     SRCR0050                                                         
*                                                                               
SRCRYES  SR    R5,R5                                                            
         ST    R4,DMCB                                                          
SRCRNO   LTR   R5,R5                                                            
         B     EXIT                                                             
         DROP  R4                                                               
*                                                                               
***********************************************************************         
* PROCTAB: PROCESS TABLE                                                        
* P1:  BYTE1    = OPTION = X'01'(ADD ENTRY)                                     
*                          X'02'(DEL ENTRY)                                     
*      BYTE2-4  = A(AGY LINE)                                                   
*      BYTE5-8  = A(REP LINE)                                                   
*      BYTE9-12 = A(STARTING ADDRESS)                                           
*                                                                               
***********************************************************************         
PROCTAB  NTR1  BASE=*,LABEL=*                                                   
         LM    R2,R4,0(R1)                                                      
         MVC   BYTE,0(R2)          R2 = A(AGY LINE NUMBER)                      
         MVC   BYTE1,0(R3)         R3 = A(REP LINE NUMBER)                      
         LR    R6,R4               R4 = A(TABLE)                                
*                                                                               
         L     RE,12(R1)                                                        
         USING DIFFSUM,RE                                                       
         LA    R2,DSINPUTH                                                      
         DROP  RE                                                               
*                                                                               
TR2      USING TLSTD,TSARREC2                                                   
         USING MTCHTABD,R4                                                      
         CLI   0(R1),X'01'         ADD!                                         
         BE    PTAB0100                                                         
         CLI   0(R1),X'02'         DELETE!                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
PTAB0010 DS    0H                  DELETE THIS ENTRY                            
         CLC   ABUY#(L'TABTERM),TABTERM  LAST GROUP OF THE TABLE                
         BE    PTAB0050                                                         
         CLC   ABUY#(L'GRPTERM2),GRPTERM2 THE LAST ROW OF THIS GROUP            
         BE    PTAB0050                                                         
         LA    R4,MTCHTABL(R4)                                                  
         B     PTAB0010                                                         
*                                                                               
PTAB0050 DS    0H                  ELSE                                         
         LA    R4,MTCHTABL(R4)     WE WILL MOVE THE REMAINING UP                
         LA    RF,MTCHTAB                                                       
         AHI   RF,L'MTCHTAB                                                     
         SR    RF,R4               LENGTH TO MOVE                               
*                                                                               
         BCTR  RF,0                MOVE BOTTOM TO OVERWRITE                     
         EX    RF,*+8              THE ENTRY                                    
         B     *+10                                                             
         MVC   0(0,R6),0(R4)                                                    
*                                                                               
         AHI   RF,1                AND MARK END OF TABLE                        
         LR    R4,R6                                                            
         AR    R4,RF                                                            
         MVI   0(R4),X'00'                                                      
         B     PTAB0950            DONE                                         
*                                                                               
PTAB0100 DS    0H                  ADD THIS ENTRY                               
         LA    RF,MTCHTAB          BEGINNING OF TABLE?                          
         CR    RF,R4                                                            
         BE    PTAB0130            YES, DON'T NEED TO SKIP ONE ROW              
         LA    R4,MTCHTABL(R4)                                                  
         LR    R6,R4                                                            
*                                                                               
PTAB0130 DS    0H                                                               
         XC    TSARREC,TSARREC     CHECK TO SEE IF AGENCY LINE                  
         MVI   TR.TLKTYP,X'0E'     AND REP LINE BELONG TO THE SAME              
         MVI   TR.TLBPTYP,C'A'     SEGMENT                                      
         MVC   TR.TLBPBUY#,BYTE                                                 
         GOTO1 GOTSAR,TSARDH                                                    
*        BNE   PTAB0130                                                         
         BNE   ERNOLINE            THIS LINE IS NOT ON AGENCY ORDER             
*                                                                               
         MVC   TSRNUMA,TR.TLBPSEG#                                              
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,X'0E'                                                  
         MVI   TR.TLBPTYP,C'R'                                                  
         MVC   TR.TLBPBUY#,BYTE1                                                
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   TSRNUMR,TR.TLBPSEG#                                              
*                                                                               
         OC    TSRNUMR,TSRNUMR                                                  
         BNZ   *+6                                                              
         DC    H'0'                                                             
         OC    TSRNUMA,TSRNUMA                                                  
         BNZ   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   TSRNUMR,TSRNUMA     SAME SEGMENT ALREADY?                        
         BE    PTAB0500            MOVE ALL BUYS IN SEG TO TABLE                
*                                                                               
         LR    R4,R6                                                            
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,TSRNUMA       DIFFERENT SEGMENT                            
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   TSARREC2,TSARREC    SAVE OFF THIS SEGMENT                        
*                                                                               
         TM    TR2.TLBYAFLG,X'40'  BUY LINK?                                    
         BZ    PTAB0180                                                         
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,C'A'                                                   
         MVC   TR.TLBLINDX,TR2.TLBYALNK                                         
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,TR.TLBLBUY#                                                   
         USING TLBLBUY#,R3                                                      
PTAB0160 DS    0H                                                               
         MVC   ABUY#,TLBLBUY#                                                   
         LA    R3,TLBLLENQ(R3)                                                  
         CLI   TLBLBUY#,0                                                       
         BE    PTAB0170                                                         
         LA    R4,MTCHTABL(R4)                                                  
         B     PTAB0160                                                         
PTAB0170 DS    0H                  READ REP SEGMENT                             
         B     PTAB0190                                                         
PTAB0180 DS    0H                                                               
         CLI   TR2.TLBYALNK,0                                                   
         BNE   *+6                                                              
         DC    H'0'                                                             
         MVC   ABUY#,TR2.TLBYALNK                                               
PTAB0190 DS    0H                                                               
         MVI   MTCHTABL(R4),GRPTERM INSERT GROUP TERMINATOR                     
*                                                                               
PTAB0200 DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,TSRNUMR                                                    
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   TSARREC2,TSARREC                                                 
         LR    R4,R6                                                            
         TM    TR2.TLBYRFLG,X'40'  BUY LINK?                                    
         BZ    PTAB0280                                                         
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,C'R'                                                   
         MVC   TR.TLBLINDX,TR2.TLBYRLNK                                         
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,TR.TLBLBUY#                                                   
         USING TLBLBUY#,R3                                                      
PTAB0260 DS    0H                                                               
         CLC   ABUY#(L'TABTERM),TABTERM                                         
         BNE   *+8                                                              
         MVI   ABUY#,GRPTERM                                                    
*                                                                               
         MVC   RBUY#,TLBLBUY#                                                   
         LA    R3,TLBLLENQ(R3)                                                  
         CLI   TLBLBUY#,0                                                       
         BE    PTAB0270                                                         
         LA    R4,MTCHTABL(R4)                                                  
         B     PTAB0260                                                         
PTAB0270 DS    0H                  READ REP SEGMENT                             
         B     PTAB0290                                                         
PTAB0280 DS    0H                                                               
*** TRAP ERROR                                                                  
         CLI   TR2.TLBYRLNK,0                                                   
         BNE   *+6                                                              
         DC    H'0'                                                             
*** TRAP ERROR                                                                  
         MVC   RBUY#,TR2.TLBYRLNK                                               
PTAB0290 DS    0H                                                               
         LA    R4,MTCHTABL(R4)                                                  
         MVI   RBUY#,GRPTERM          INSERT GROUP TERMINATOR                   
         CLC   ABUY#(L'TABTERM),TABTERM                                         
         BNE   *+8                                                              
         MVI   ABUY#,GRPTERM                                                    
*                                                                               
PTAB0295 DS    0H                                                               
         LA    R4,MTCHTABL(R4)     STICK IN TERMINATING CHARACTER               
         CLC   ABUY#(L'TABTERM),TABTERM                                         
         BE    PTAB0950            FOR THIS GROUP                               
         MVI   RBUY#,GRPTERM                                                    
         B     PTAB0295                                                         
*                                                                               
PTAB0500 DS    0H                  MOVE ALL BUYS IN SEG TO TABLE                
*                                                                               
         MVC   TXNUM,TSRNUMA                                                    
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   TSARREC2,TSARREC                                                 
*                                                                               
PTAB0550 DS    0H                                                               
         TM    TR.TLBYAFLG,X'40'   TLBYALNK IS A LINK POINTER?                  
         BZ    PTAB0600            NO                                           
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TR.TLBLINDX,TR2.TLBYALNK                                         
         MVI   TR.TLKTYP,C'A'                                                   
         GOTO1 GOTSAR,TSARDH       YES,READ BUYLINK RECORD                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,TR.TLBLBUY#                                                   
         USING TLBLBUY#,R3                                                      
PTAB0560 DS    0H                                                               
         MVC   ABUY#,TLBLBUY#                                                   
         LA    R3,TLBLLENQ(R3)                                                  
         CLI   TLBLBUY#,0                                                       
         BE    PTAB0570                                                         
         LA    R4,MTCHTABL(R4)                                                  
         B     PTAB0560                                                         
PTAB0570 DS    0H                                                               
*        MVC   TSARREC2,TSARREC    RESTORE TSARREC                              
         B     PTAB0650                                                         
*                                                                               
PTAB0600 DS    0H                                                               
         MVC   ABUY#,TR2.TLBYALNK   NO, INSERT BUYLINE NUMBER                   
*                                                                               
PTAB0650 DS    0H                                                               
         MVI   MTCHTABL(R4),GRPTERM INSERT GROUP TERMINATOR                     
*                                                                               
PTAB0800 DS    0H                                                               
         LR    R4,R6                                                            
         TM    TR2.TLBYRFLG,X'40'  TLBYRLNK IS A LINK POINTER?                  
         BZ    PTAB0880                                                         
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TR.TLBLINDX,TR2.TLBYRLNK                                         
         MVI   TR.TLKTYP,C'R'                                                   
         GOTO1 GOTSAR,TSARDH       YES,READ BUYLINK RECORD                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,TR.TLBLBUY#                                                   
         USING TLBLBUY#,R3                                                      
PTAB0860 DS    0H                                                               
         CLC   ABUY#(L'TABTERM),TABTERM                                         
         BNE   *+8                                                              
         MVI   ABUY#,GRPTERM       TERMINATING ALL BLANKS                       
         MVC   RBUY#,TLBLBUY#                                                   
         LA    R3,TLBLLENQ(R3)                                                  
         CLI   TLBLBUY#,0                                                       
         BE    PTAB0870                                                         
         LA    R4,MTCHTABL(R4)                                                  
         B     PTAB0860                                                         
PTAB0870 DS    0H                                                               
         B     PTAB0900                                                         
*                                                                               
PTAB0880 DS    0H                                                               
         MVC   RBUY#,TR2.TLBYRLNK  NO, INSERT BUYLINE NUMBER                    
*                                                                               
PTAB0900 DS    0H                                                               
         MVI   MTCHTABL+1(R4),GRPTERM INSERT GROUP TERMINATOR                   
         CLI   MTCHTABL(R4),X'00'                                               
         BNE   *+8                                                              
         MVI   MTCHTABL(R4),GRPTERM                                             
         LA    R4,MTCHTABL(R4)     NEXT AVAILABLE GROUP                         
PTAB0930 DS    0H                                                               
         CLC   ABUY#(L'TABTERM),TABTERM                                         
         BE    PTAB0950                                                         
         MVI   RBUY#,GRPTERM                                                    
         LA    R4,MTCHTABL(R4)                                                  
         B     PTAB0930                                                         
PTAB0950 DS    0H                                                               
*                                                                               
PTABX    DS    0H                                                               
         B     EXIT                                                             
         DROP  R4                                                               
         DROP  R3                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* PROCSEG: PROCESS SEGMENTS BASE ON THE MATCH TABLE                             
* NOTE: CAN'T DELETE RECORD IN THIS ROUTINE, CAN'T ADD RECORDS                  
*       IN THIS ROUTINE. THEREFORE ALL WE CAN DO IS UPDATE KEYS ON              
*       PUT, AND ADD RECORDS TO THE END                                         
***********************************************************************         
PROCSEG  NTR1  BASE=*,WORK=(R2,DLWORKQ),LABEL=*                                 
TR2      USING TLSTD,TSARREC2                                                   
TR3      USING TLSTD,ELEM                                                       
         USING DLWORKD,R2                                                       
*                                                                               
         LA    R4,MTCHTAB                                                       
         A     R4,AEOTBLE                                                       
         USING MTCHTABD,R4                                                      
*                                                                               
         GOTOR UMTHSEG             UNMATCH EVERY SEGMENT                        
*                                                                               
PSEG0030 DS    0H                                                               
         CLC   ABUY#(L'TABTERM),TABTERM END OF TABLE?                           
         BE    PSEGX               NOTHING TO PROCESS                           
         CLI   ABUY#,GRPTERM       END OF GROUP?                                
         BE    PSEGX               NOTHING TO PROCESS                           
         OI    TB.TSINDS,TSIKEYUP                                               
*                                                                               
         XC    TSARREC,TSARREC     CHECK TO SEE IF AGENCY LINE                  
         MVI   TR.TLKTYP,X'0E'     AND REP LINE BELONG TO THE SAME              
         MVI   TR.TLBPTYP,C'A'     SEGMENT                                      
         MVC   TR.TLBPBUY#,ABUY#                                                
         GOTO1 GOTSAR,TSARDH                                                    
         BNE   PSEGNEXT                                                         
*        DC    H'0'                                                             
*        BNE   ERNOLINE            THIS LINE IS NOT ON AGENCY ORDER             
*                                                                               
         OC    TR.TLBPMLNK,TR.TLBPMLNK                                          
         BNZ   PSEG0032                                                         
*                                                                               
PSEG0032 MVC   TSRNUMA,TR.TLBPSEG#                                              
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,X'0E'                                                  
         MVI   TR.TLBPTYP,C'R'                                                  
         MVC   TR.TLBPBUY#,RBUY#                                                
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   TSRNUMR,TR.TLBPSEG#                                              
*** TRAP ERROR                                                                  
         OC    TSRNUMR,TSRNUMR                                                  
         BNZ   *+6                                                              
         DC    H'0'                                                             
         OC    TSRNUMA,TSRNUMA                                                  
         BNZ   *+6                                                              
         DC    H'0'                                                             
*** TRAP ERROR                                                                  
         CLC   TSRNUMR,TSRNUMA     SAME SEGMENT?                                
         BE    PSEG0500            YES                                          
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TXNUM,TSRNUMR       REP SEGMENT                                  
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
*&&TT                                                                           
         CLI   ABUY#,64                                                         
         BNE   *+6                                                              
         DC    X'0770'                                                          
*&&                                                                             
         OC    TR.TLBYMLNK,TR.TLBYMLNK                                          
         BZ    PSEG0040            NOT A DAILY/C.O                              
         TM    TR.TLBYFLG3,X'01'   DAILY GROUP NOT TOTALLY MATCH                
         BO    PSEG0040            PROCESS                                      
         TM    TR.TLBYFLG3,X'80'   TOTALLY MATCH? AND DAILY/C.O?                
         BO    PSEGNEXT            YES, SKIP                                    
*                                                                               
PSEG0040 DS    0H                                                               
         OC    TR.TLBYALNK,TR.TLBYALNK OTHER AGY LINE IN THIS SEGMENT           
         BNZ   PSEG0044                                                         
         OC    TR.TLBYMLNK,TR.TLBYMLNK                                          
         BZ    PSEG0080            DAILY BUY                                    
PSEG0044 DS    0H                                                               
*                                                                               
**********************************************************************          
*                                                                    *          
         NI    MYFLAG1,FF-X'04'                                                 
         OC    TR.TLBYMLNK,TR.TLBYMLNK                                          
         BZ    PSEG0050            NOT A DAILY/C.O                              
         CLC   ABUY#,TR.TLBYMLNK   THIS SHOULD ONLY HAPPEND FOR      *          
         BNE   PSEG0050            DAILY/C.O                         *          
*                                  WHERE A LINK SEGMENT IS TIE TO               
*                                  ANOTHER LINK SEGMENT WITH THE SAME           
*                                  LINE NUMBER                                  
         OI    MYFLAG1,X'04'                                                    
         B     PSEG0500                                                         
*                                                                               
**********************************************************************          
*                                                                               
*                                                                               
* DELETE THIS REP LINE FROM THIS SEGMENT,LEAVE THIS SEGMENT THE                 
* WAY IT IS, BUILD A NEW MATCHED SEGMENT BASE ON THIS ONE                       
* AND DELETE ALL AGENCY REFERENCE                                               
*                                                                               
PSEG0050 DS    0H                                                               
         MVC   DLWORK,TSARREC                                                   
         GOTOR KILLME,DMCB,(C'R',RBUY#)                                         
*                                                                               
         MVC   TSARREC,DLWORK                                                   
         MVI   TR.TLKTYP,X'0C'     ADD AS 0C RECORD SO WE WON'T MESS            
         MVI   TR.TLBYFLG,TLMTHQ   UP THE ORDER OF THE RECORD                   
         MVC   TR.TLBYLNK,ABUY#                                                 
         XC    TR.TLBYAFLG,TR.TLBYAFLG                                          
         XC    TR.TLBYALNK,TR.TLBYALNK                                          
         GOTO1 GOTSAR,TSAADD                                                    
         BE    PSEG0100                                                         
         DC    H'0'                                                             
*                                                                               
PSEG0080 DS    0H                                                               
         MVI   TR.TLBYFLG,TLMTHQ   MARK AS MATCH                                
         MVC   TR.TLBYLNK,ABUY#    ESTABLISH LINK                               
         GOTO1 GOTSAR,TSAPUT                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
PSEG0100 DS    0H                                                               
         MVC   TXNUM,TSRNUMA       AGENCY SEGMENT                               
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         OC    TR.TLBYRLNK,TR.TLBYRLNK OTHER REP LINE IN THIS SEGMENT           
         BZ    PSEG0180                                                         
*                                                                               
* DELETE THIS REP LINE FROM THIS SEGMENT,LEAVE THIS SEGMENT THE                 
* WAY IT IS, BUILD A NEW MATCHED SEGMENT BASE ONE THIS ONE                      
* AND DELETE ALL AGENCY REFERENCE                                               
*                                                                               
         MVC   DLWORK,TSARREC                                                   
         GOTOR KILLME,DMCB,(C'A',ABUY#)                                         
*                                                                               
         MVC   TSARREC,DLWORK                                                   
         MVI   TR.TLKTYP,X'0C'     ADD AS 0C RECORD SO WE WON'T MESS            
         MVI   TR.TLBYFLG,TLMTHQ   UP THE ORDER OF THE RECORD                   
         MVI   TR.TLBYTYPA,TLTYPAQ                                              
         MVC   TR.TLBYLNK,ABUY#                                                 
         XC    TR.TLBYRFLG,TR.TLBYRFLG                                          
         XC    TR.TLBYRLNK,TR.TLBYRLNK                                          
         GOTO1 GOTSAR,TSAADD                                                    
         BE    PSEGNEXT                                                         
         DC    H'0'                                                             
*                                                                               
PSEG0180 DS    0H                                                               
         MVI   TR.TLBYFLG,TLMTHQ   MARK AS MATCH                                
         MVI   TR.TLBYTYPA,TLTYPAQ                                              
         MVC   TR.TLBYLNK,ABUY#    ESTABLISH LINK                               
         GOTO1 GOTSAR,TSAPUT       UPDATE RECORD                                
         BE    *+6                                                              
         DC    H'0'                                                             
         B     PSEGNEXT                                                         
*                                                                               
PSEG0500 DS    0H                  MOVE ALL BUYS IN SEG TO TABLE                
*                                                                               
         MVC   TXNUM,TSRNUMR                                                    
PSEG0520 DS    0H                                                               
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         OC    TR.TLBYMLNK,TR.TLBYMLNK                                          
         BZ    PSEG0540            NOT A DAILY/C.O                              
         TM    TR.TLBYFLG3,X'02'   CANCELLED DAILY?                             
         BO    PSEG0540            YES, SKIP                                    
         TM    TR.TLBYFLG3,X'80'   TOTALLY MATCH?                               
         BO    PSEGNEXT            YES, SKIP                                    
*                                                                               
PSEG0540 DS    0H                                                               
         MVI   TR.TLBYFLG,TLMTHQ   MARK SEGMENT AS MATCH                        
         MVC   TSARREC2,TSARREC                                                 
         GOTO1 GOTSAR,TSAPUT       DELETE OLD SEGMENT                           
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         TM    MYFLAG1,X'04'                                                    
         BZ    PSEGNEXT                                                         
         MVC   TXNUM,TSRNUMA                                                    
         NI    MYFLAG1,FF-X'04'                                                 
         B     PSEG0520                                                         
*                                                                               
PSEGNEXT DS    0H                                                               
         LA    R4,MTCHTABL(R4)     NEXT ENTRY                                   
         CLC   ABUY#(L'TABTERM),TABTERM                                         
         BE    PSEGX               END OF TABLE, EXIT                           
         CLC   ABUY#(L'GRPTERM2),GRPTERM2  END OF GROUP?                        
         BNE   PSEGNEXT                                                         
*                                                                               
PSEG0900 DS    0H                  YES, POINT TO NEXT ENTRY                     
         LA    R4,MTCHTABL(R4)                                                  
         B     PSEG0030                                                         
*                                                                               
PSEGX    DS    0H                                                               
         NI    TB.TSINDS,X'FF'-TSIKEYUP                                         
         B     EXIT                                                             
         DROP  R4                                                               
         DROP  R2                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* LOOP THROUGH ALL BUY SEGMENT AND MARK THEM AS UNMATCHED                       
***********************************************************************         
UMTHSEG  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    TSARREC,TSARREC                                                  
         XC    TSARREC2,TSARREC2                                                
         MVI   TR.TLKTYP,X'0B'                                                  
         GOTO1 GOTSAR,TSARDH                                                    
         BL    UMTHRX                                                           
*                                                                               
UMTH0030 DS    0H                                                               
         CLI   TR.TLBYFLG,TLMTHQ                                                
         BE    UMTH0040            MATCH SEGMENT                                
         CLI   TR.TLBYFLG2,TLLNKQ                                               
         BE    UMTH0040                                                         
         CLI   TR.TLBYFLG2,TLMTHQ2                                              
         BE    UMTH0040                                                         
         CLI   TR.TLBYFLG,TLUMTHQ                                               
         BNE   UMTH0100            RESTORE LINK FOR UNMATCH SEGMENT             
         CLI   TR.TLBYFLG2,TLLNKQ                                               
         BNE   UMTH0100                                                         
UMTH0040 DS    0H                                                               
         TM    TR.TLBYFLG4,X'14'   SKIP THIS SEGMENT                            
         BNZ   UMTH0100            IF ADD-TO-SKED                               
         TM    TR.TLBYFLG3,X'80'   SKIP THIS SEGMENT                            
         BZ    UMTH0043                                                         
         OC    TR.TLBYMLNK,TR.TLBYMLNK                                          
         BZ    UMTH0100            IF NOT DAILY/C.O                             
*                                                                               
UMTH0043 DS    0H                                                               
         CLI   TR.TLBYFLG2,TLLNKQ                                               
         BE    UMTH0045                                                         
         CLI   TR.TLBYFLG2,TLMTHQ2      FOR MATCH TYPE 2                        
         BNE   UMTH0050                                                         
*&&DO                                                                           
         OC    TR.TLBYALNK,TR.TLBYALNK  ONLY RESTORE LINK                       
         BZ    UMTH0050                                                         
         OC    TR.TLBYRLNK,TR.TLBYRLNK  IF BOTH SPOT, REP SIDE AS BUYS          
         BZ    UMTH0050                                                         
*&&                                                                             
UMTH0045 DS    0H                                                               
         MVC   TR.TLBYFLG,TR.TLBYFLG2   RESTORE THE LINK                        
         MVC   TR.TLBYLNK,TR.TLBYLNKT                                           
         MVC   TR.TLBYTYPA,TR.TLBYTYP2                                          
         MVC   TR.TLBYSUBL,TR.TLBYSUB1                                          
         B     UMTH0080                                                         
*                                                                               
UMTH0050 DS    0H                                                               
         MVI   TR.TLBYFLG,TLUMTHQ  MARK AS UNMATCH                              
         XC    TR.TLBYLNK,TR.TLBYLNK                                            
         XC    TR.TLBYTYPA,TR.TLBYTYPA                                          
*                                                                               
UMTH0080 DS    0H                                                               
         OI    TB.TSINDS,TSIKEYUP                                               
         GOTO1 GOTSAR,TSAPUT                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
UMTH0100 DS    0H                                                               
         GOTO1 GOTSAR,TSANXT                                                    
         BL    UMTH0200                                                         
         CLI   TR.TLKTYP,X'0B'                                                  
         BE    UMTH0030                                                         
*                                                                               
UMTH0200 DS    0H                                                               
UMTHRX   DS    0H                                                               
         NI    TB.TSINDS,X'FF'-TSIKEYUP                                         
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* KILLME KILLS A BUYLINE FROM A SEGMENT                                         
* C'R' = KILL REP LINE                                                          
* C'A' = KILL AGY LINE                                                          
***********************************************************************         
KILLME   NTR1  BASE=*,WORK=(R6,DLWORKQ),LABEL=*                                 
*                                                                               
         USING DLWORKD,R6                                                       
         MVC   DLWORK,TSARREC                                                   
TR2      USING TLSTD,DLWORK                                                     
         MVC   BYTE,0(R1)                                                       
         L     R2,0(R1)                                                         
         MVC   DLBYTE,0(R2)                                                     
*                                                                               
         LA    R2,TR2.TLBYAFLG                                                  
         LA    R3,TR2.TLBYALNK                                                  
         CLI   BYTE,C'A'                                                        
         BE    KILL0100                                                         
         LA    R2,TR2.TLBYRFLG                                                  
         LA    R3,TR2.TLBYRLNK                                                  
*                                                                               
KILL0100 DS    0H                                                               
         TM    0(R2),X'40'         WE WILL KILL THE WHOLE REFERENCE             
         BO    KILL0200            NOW, IF THIS IS OK, WE WILL DELETE           
*                                  THE CODE TO KILL LINE WITHIN A               
*                                  BUY LINK RECORD                              
         XC    0(L'TR.TLBYRLNK,R3),0(R3)                                        
         XC    0(L'TR.TLBYRFLG,R2),0(R2)                                        
         CLI   TR2.TLBYFLG,TLMTHQ2 MATCH TYPE 2?                                
         BNE   *+8                                                              
         MVI   TR2.TLBYFLG,TLUMTHQ MARK AS UNMATCH                              
         MVC   TSARREC,DLWORK                                                   
         GOTO1 GOTSAR,TSAPUT                                                    
         BE    KILLMEX                                                          
         DC    H'0'                                                             
*                                                                               
KILL0200 DS    0H                                                               
         MVC   DLWORK,TSARREC                                                   
         XC    TSARREC,TSARREC                                                  
         MVC   TR.TLKTYP,BYTE                                                   
         MVC   TR.TLBLINDX,0(R3)                                                
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R4,TR.TLBLBUY#                                                   
         USING TLBLBUY#,R4                                                      
KILL0210 DS    0H                                                               
         CLI   0(R4),0                                                          
         BE    KILL0250            EXIT                                         
         CLC   DLBYTE,TLBLBUY#                                                  
         BE    KILL0230                                                         
         LA    R4,TLBLLENQ(R4)                                                  
         B     KILL0210                                                         
*                                                                               
KILL0230 DS    0H                                                               
         LA    RF,TSARREC                                                       
         SR    RE,RE                                                            
         ICM   RE,3,TR.TLLEN                                                    
         AR    RF,RE               RF->END OF REC                               
         LA    RE,TR.TLBLBUY#                                                   
         SR    RF,RE                                                            
         SHI   RF,TLBLLENQ                                                      
         LTR   RF,RF                                                            
         BNZ   KILL0235                                                         
*                                                                               
         XC    WORK,WORK           ONLY ONE BUY IN BUYLINK                      
         LA    RE,WORK                                                          
         B     KILL0240            DELETE BUYLINK REFERENCE IN BUYSEG           
*                                                                               
*&&TT                                                                           
         CLI   0(RE),27                                                         
         BNE   *+6                                                              
         DC    X'0770'                                                          
*&&                                                                             
*                                                                               
KILL0235 DS    0H                                                               
         LA    R2,TLBLLENQ(R4)                                                  
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),0(R2)                                                    
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,TR.TLLEN                                                    
         SHI   RF,TLBLLENQ                                                      
         STCM  RF,3,TR.TLLEN       UPDATE RECORD                                
*        B     KILL0245                                                         
*                                                                               
         LA    RF,TSARREC          TEST TO SEE IF ONLY ONE BUY LEFT             
         SR    RE,RE                                                            
         ICM   RE,3,TR.TLLEN                                                    
         AR    RF,RE               RF->END OF REC                               
         LA    RE,TR.TLBLBUY#                                                   
         SR    RF,RE                                                            
         SHI   RF,TLBLLENQ                                                      
         LTR   RF,RF                                                            
         BNZ   KILL0245                                                         
*                                                                               
         LA    RE,TR.TLBLBUY#      MOVE THIS BUY TO BUYSEG                      
*&&TT                                                                           
         CLI   0(RE),28                                                         
         BNE   *+6                                                              
         DC    X'0770'                                                          
*&&                                                                             
         B     KILL0240                                                         
*                                                                               
KILL0240 DS    0H                                                               
         LA    R2,TR2.TLBYRFLG                                                  
         LA    R3,TR2.TLBYRLNK                                                  
         CLI   BYTE,C'A'                                                        
         BNE   KILL0243                                                         
         LA    R2,TR2.TLBYAFLG                                                  
         LA    R3,TR2.TLBYALNK                                                  
*                                                                               
KILL0243 DS    0H                                                               
         MVC   0(TLBYRLNQ,R3),0(RE)                                             
         NI    0(R2),X'FF'-X'40'                                                
         XC    TSARREC,TSARREC                                                  
         MVC   TSARREC,DLWORK      DELETE LINK NUMBER                           
*                                                                               
KILL0245 DS    0H                                                               
         GOTO1 GOTSAR,TSAWRT                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   TSARREC,DLWORK                                                   
         B     KILLMEX                                                          
*                                                                               
KILL0250 DS    0H                                                               
         DC    H'0'                                                             
*                                                                               
KILLMEX  DS    0H                                                               
         B     EXIT                                                             
         DROP  R6                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* LOOP THROUGH ALL BUY SEGMENT AND SORT THEM AGAIN                              
***********************************************************************         
RESORTR  NTR1  BASE=*,WORK=(R4,DLWORKQ),LABEL=*                                 
         USING DLWORKD,R4                                                       
         XC    TSARREC,TSARREC                                                  
         XC    TSARREC2,TSARREC2                                                
         MVI   TR.TLKTYP,X'0B'                                                  
         GOTO1 GOTSAR,TSARDH                                                    
         BL    RSRT0200                                                         
*                                                                               
RSRT0030 DS    0H                                                               
         MVC   HALF,TB.TSRNUM                                                   
         MVC   DLWORK,TSARREC                                                   
         GOTO1 GOTSAR,TSADEL                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         OC    TR.TLBYMLNK,TR.TLBYMLNK                                          
         BZ    RSRT0050                                                         
         CLI   TR.TLBYTYP2,TLTYPAQ                                              
         BNE   RSRT0050                                                         
         MVC   TR.TLBYSUBL,TR.TLBYSUB1                                          
RSRT0050 DS    0H                                                               
         GOTO1 GOTSAR,TSAADD                                                    
         TM    TB.TSERRS,TSEDUP                                                 
         BZ    RSRT0100                                                         
         GOTOR MERGES              MERGES = MERGE SEG                           
*                                                                               
RSRT0100 DS    0H                                                               
         MVC   TXNUM,HALF                                                       
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   TSARREC,DLWORK                                                   
         BNE   RSRT0030                                                         
*                                                                               
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSANXT                                                    
         BL    RSRT0200                                                         
         CLI   TR.TLKTYP,X'0B'                                                  
         BE    RSRT0030                                                         
***********************************************************************         
* CONVERT 0C TSAR RECORD TO 0B TSAR RECORD                                      
***********************************************************************         
RSRT0200 DS    0H                  CONVERT 0C TO 0B                             
*                                                                               
         XC    TSARREC,TSARREC                                                  
         XC    TSARREC2,TSARREC2                                                
         XC    TB.TSRNUM,TB.TSRNUM                                              
         MVI   TR.TLKTYP,X'0C'                                                  
         GOTO1 GOTSAR,TSARDH                                                    
         BL    RSRT0400                                                         
*                                                                               
RSRT0230 DS    0H                                                               
         CLI   TR.TLKTYP,X'0C'                                                  
         BNE   RSRT0400                                                         
         MVC   DLWORK,TSARREC                                                   
         MVC   DLTSRNUM,TB.TSRNUM                                               
         GOTO1 GOTSAR,TSADEL                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVI   TR.TLKTYP,X'0B'                                                  
         GOTO1 GOTSAR,TSAADD                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
RSRT0300 DS    0H                                                               
         XC    TXNUM,TXNUM                                                      
         MVC   TSARREC,DLWORK                                                   
         GOTO1 GOTSAR,TSARDH                                                    
         CLI   TR.TLKTYP,X'0C'                                                  
         BE    RSRT0230                                                         
*                                                                               
RSRT0400 DS    0H                                                               
RSRTRX   DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
         DROP  R4                                                               
***********************************************************************         
* LOOP THROUGH ALL DAILY BUY SEGMENTS AND CHECK TO SEE IF THIS                  
* DAILY BUYS GROUP ARE TOTALLY MATCH, IF NOT, SET A FLAG                        
***********************************************************************         
         USING DLWORKD,R4                                                       
TR2      USING TLSTD,TSARREC2                                                   
TR3      USING TLSTD,DLWORK                                                     
*                                                                               
DAILYMTH NTR1  BASE=*,WORK=(R4,DLWORKQ),LABEL=*                                 
         XC    TSARREC,TSARREC                                                  
         XC    TSARREC2,TSARREC2                                                
*                                                                               
         MVI   TR.TLKTYP,X'0B'     BUY SEGMENT                                  
         GOTO1 GOTSAR,TSARDH                                                    
         BL    DFLGX                                                            
*                                                                               
DFLG0030 DS    0H                                                               
         MVC   TSARREC2,TSARREC    SAVE OFF SEGMENT                             
         MVI   DLBYTE2,0           CLEAR FLAG                                   
*        OC    TR.TLBYMLNK,TR.TLBYMLNK                                          
*        BZ    DFLGNEXT            ONLY PROCESS MULTIPLE BUY GROUPS             
         TM    TR.TLBYFLG4,X'01'   DAILY?                                       
         BZ    DFLGNEXT                                                         
         CLI   TR.TLBYFLG,TLUMTHQ                                               
         BE    DFLG0036                                                         
         CLI   TR.TLBYFLG,TLLNKQ                                                
         BNE   DFLGNEXT                                                         
         MVC   DLBYTE,TR.TLBYMLNK  SAVE OFF DAILY BUY GROUP #                   
*                                                                               
DFLG0036 DS    0H                                                               
         MVC   DLWORK,TSARREC                                                   
         MVC   DLTSRNUM,TXNUM                                                   
*                                                                               
         TM    TR.TLBYFLG3,X'80'                                                
         BO    DFLG0038                                                         
         OI    DLBYTE2,DLYNOMTH                                                 
*                                                                               
DFLG0038 DS    0H                                                               
         OC    TR.TLBYALNK,TR.TLBYALNK                                          
         BZ    DFLG0040                                                         
         OC    TR.TLBYRLNK,TR.TLBYRLNK                                          
         BZ    DFLG0040            DOES THIS SEGMENT HAS AGY+REP LINES          
         TM    TR.TLBYAFLG,X'40'   LINK?                                        
         BO    DFLG0047                                                         
         OC    TR.TLBYASPT,TR.TLBYASPT    ZERO SPOT?                            
         BNZ   DFLG0047                                                         
         B     DFLG0048                                                         
*                                  IF SO, SKIP                                  
DFLG0040 DS    0H                  IF NOT, SEEK AGENCY SEGMENT                  
         OC    TR.TLBYRLNK,TR.TLBYRLNK                                          
         BNZ   DFLG0041            THIS MUST BE AN ADD-TO-SKED                  
         OI    TR.TLBYFLG4,X'12'   MARK AS ADD-TO-SKED                          
         GOTO1 GOTSAR,TSAWRT                                                    
         BE    DFLGNEXT                                                         
         DC    H'0'                                                             
*                                                                               
DFLG0041 XC    TSARREC,TSARREC                                                  
         MVC   TR.TLKTYP(TLBYSUBL-TLKTYP),DLWORK+2                              
         MVI   TR.TLBYTYPA,TLTYPAQ                                              
         MVC   SAVEKEY(L'TSARKEY),TSARREC+2                                     
*                                                                               
         GOTO1 GOTSAR,TSARDH                                                    
DFLG0042 CLC   TSARREC+2(TLBYSUBL-TLKTYP),SAVEKEY                               
         BNE   DFLG0045            NO MATCHING AGENCY LINE                      
*                                                                               
         TM    TR.TLBYFLG3,X'04'   PROCESSED ALREADY?                           
         BO    DFLGNXT1                                                         
         CLC   TR.TLBYTIME(10),TR3.TLBYTIME  DOMINO?                            
         BNE   DFLG0043                                                         
         CLC   TR.TLBYDAY,TR3.TLBYDAY  SAME DAY?                                
         BNE   DFLGNXT1                                                         
*                                                                               
DFLG0043 OI    DLBYTE2,DLYLINK     THERE ARE LINK LINES                         
         OI    TR.TLBYFLG3,X'04'   PROCESSED                                    
*                                                                               
         GOTO1 GOTSAR,TSAWRT       UPDATE TSAR                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         TM    TR.TLBYAFLG,X'40'   LINK?                                        
         BO    DFLG0047                                                         
         OC    TR.TLBYASPT,TR.TLBYASPT    ZERO SPOT?                            
         BNZ   DFLG0047                                                         
*                                                                               
         B     DFLG0048            MARK AS ORPHAN                               
*                                                                               
DFLGNXT1 GOTO1 GOTSAR,TSANXT                                                    
         B     DFLG0042                                                         
*                                                                               
DFLG0045 OI    DLBYTE2,DLYOPHAN    SET ORPHAN FLAG                              
         MVC   TSARREC,DLWORK                                                   
         XC    TXNUM,TXNUM                                                      
*                                                                               
         OI    TR.TLBYFLG4,X'40'   THIS IS AN ORPHAN REP SEGMENT                
         GOTO1 GOTSAR,TSAWRT                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   DLWORK,TSARREC                                                   
         B     DFLG0048                                                         
*                                                                               
DFLG0047 DS    0H                                                               
         OI    DLBYTE2,DLYNOCAN    TURNNED OFF CANCELLATION                     
                                                                                
DFLG0048 MVC   TSARREC,DLWORK      RESET TO WHERE WE WERE                       
         MVC   TXNUM,DLTSRNUM                                                   
*                                                                               
         GOTO1 GOTSAR,TSANXT       READ NEXT SEGMENT                            
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   TR.TLKTYP(TLINDXLQ),TSARREC2+2                                   
         BE    DFLG0036            SAME DAILY GROUP                             
*************                                                                   
* END OF THIS DAILY BUY GROUP, CHECK FOR ADD-TO-SKED                            
*************                                                                   
         XC    TSARREC,TSARREC                                                  
         MVC   TSARREC+2(TLINDXLQ),TSARREC2+2    READ AGENCY SEGMENTS           
         XC    TXNUM,TXNUM         IN THIS GROUP AND SET FLAG                   
         MVI   TR.TLBYTYPA,TLTYPAQ                                              
         MVC   DLWORK3,TSARREC                                                  
         GOTO1 GOTSAR,TSARDH                                                    
*                                                                               
DFLG0050 CLC   TSARREC+2(TLINDXLQ),DLWORK3+2                                    
         BNE   DFLG0070                                                         
         TM    TR.TLBYFLG3,X'04'                                                
         BO    DFLG0060            NEXT SEGMENT                                 
*                                                                               
* THIS IS AN ADD-TO-SKED                                                        
*                                                                               
DFLG0054 OI    DLBYTE2,DLYADDSK    ADD-TO-SKED                                  
*                                                                               
         MVC   DLHALF,TXNUM                                                     
         MVC   DLWORK2,TSARREC     DELETE CURRENT SEGMENT                       
         GOTO1 GOTSAR,TSADEL                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   TSARREC,DLWORK2                                                  
         OI    TR.TLBYFLG4,X'10'   ADD-TO-SKED                                  
         MVI   TR.TLBYFLG,TLUMTHQ  SET TO UNMATCH                               
*                                                                               
         GOTO1 GOTSAR,TSAADD                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         TM    TB.TSERRS,TSEDUP                                                 
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         XC    TXNUM,TXNUM                                                      
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   TXNUM,DLHALF        RECORD POSITION DIDN'T CHANGE                
         BE    DFLG0060                                                         
*                                                                               
         MVC   TXNUM,DLHALF        IF TSAR NUMBER CHANGE                        
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSAGET       GET WILL GET THE NEXT TSAR                   
         BE    *+6                                                              
         DC    H'0'                                                             
         B     DFLG0050                                                         
*                                                                               
DFLG0060 GOTO1 GOTSAR,TSANXT       NEXT TSAR RECORD                             
         BE    DFLG0050                                                         
*                                                                               
* END OF THIS DAILY BUY GROUP, SET ALL FLAG IN THIS GROUP                       
*                                                                               
DFLG0070 TM    DLBYTE2,DLYNOMTH+DLYOPHAN+DLYADDSK                               
         BNZ   *+8                                                              
         OI    DLBYTE2,DLYMATCH    TOTALLY MATCH                                
*                                                                               
         TM    DLBYTE2,DLYMATCH                                                 
         BO    DFLGNEXT            ALL MATCH - NEXT GROUP                       
*                                                                               
DFLG0080 DS    0H                                                               
         MVC   TSARREC,TSARREC2    READ ALL DAILY BUY COMPONENT                 
         XC    TXNUM,TXNUM         IN THIS GROUP AND SET FLAG                   
*                                                                               
         GOTO1 GOTSAR,TSARDH                                                    
*                                                                               
DFLG0090 DS    0H                                                               
         CLC   TSARREC+2(TLINDXLQ),TSARREC2+2                                   
         BNE   DFLGNEXT            NOT THE SAME GROUP - NEXT                    
*                                                                               
         TM    DLBYTE2,DLYNOMTH                                                 
         BZ    *+8                                                              
         OI    TR.TLBYFLG3,X'01'   NOT TOTALLY MATCH DAILY GROUP                
*                                                                               
         TM    DLBYTE2,DLYOPHAN                                                 
         BZ    *+8                                                              
         OI    TR.TLBYFLG3,X'02'   THERE IS AN ORPHAN SEGMENT                   
*                                                                               
         TM    DLBYTE2,DLYLINK                                                  
         BZ    *+8                                                              
         OI    TR.TLBYFLG4,X'20'   THERE IS AN LINK SEGMENT                     
*                                                                               
         TM    DLBYTE2,DLYADDSK    THERE IS AN ADD-TO-SKED                      
         BZ    *+8                                                              
         OI    TR.TLBYFLG4,X'02'                                                
*                                                                               
         TM    DLBYTE2,DLYNOCAN    NOT CANCELLATION?                            
         BO    DFLG0092                                                         
*                                                                               
         OI    TR.TLBYFLG3,X'02'   MARK THERE IS AN ORPHAN                      
         OI    TR.TLBYFLG4,X'44'   CANCELLATION, MARK ALL AS ORPHAN             
         B     DFLG0094                                                         
*                                                                               
DFLG0092 TM    DLBYTE2,DLYLINK                                                  
         BO    DFLG0096                                                         
         TM    DLBYTE2,DLYADDSK                                                 
         BZ    DFLG0094            MOVE TO M SECTION BASE ON PROF               
         TM    DLBYTE2,DLYNOMTH    ADD-TO-SKED WITH NOT TOTALLY MATCH           
         BO    DFLG0094                                                         
*                                                                               
DFLG0093 TM    DLBYTE2,DLYLINK                                                  
         BO    DFLG0096                                                         
         TM    DLBYTE2,DLYOPHAN    NO LINK SEGMENT AND THERE IS ORPHAN          
         BZ    DFLG0096            SEGMENT, TREAT THESE SEGMENT                 
*                                  BASE ON PROFILE SETTING                      
DFLG0094 CLI   MFLAG,MASSUMEQ                                                   
         BNE   DFLG0096                                                         
         MVC   DLWORK2,TSARREC                                                  
         MVC   DLHALF,TXNUM                                                     
         GOTO1 GOTSAR,TSADEL                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   TSARREC,DLWORK2                                                  
         MVI   TR.TLBYFLG,TLMTHQ                                                
         MVC   TR.TLBYMLNK,TR.TLBYMLKT                                          
         OI    TR.TLBYFLG4,X'08'                                                
         GOTO1 GOTSAR,TSAADD                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         XC    TXNUM,TXNUM                                                      
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         CLC   TXNUM,DLHALF                                                     
         BE    DFLG0098                                                         
         MVC   TXNUM,DLHALF                                                     
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         B     DFLG0080                                                         
*                                                                               
DFLG0096 GOTO1 GOTSAR,TSAPUT       PUT TSAR RECORD BACK                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
DFLG0098 GOTO1 GOTSAR,TSANXT       NEXT TSAR RECORD                             
         BE    DFLG0090                                                         
*                                                                               
*                                                                               
DFLGNEXT DS    0H                                                               
         MVC   TSARREC,TSARREC2    RESET TO BEGINNIG OF DAILY GROUP             
         MVC   TR.TLBYSUBL(2),=X'FFFF'   READ NEXT GROUP                        
         MVC   TSARREC2,TSARREC                                                 
         GOTO1 GOTSAR,TSARDH                                                    
         BL    DFLGX               EXIT                                         
*                                                                               
         CLI   TR.TLKTYP,X'0B'                                                  
         BNE   DFLGX               EXIT                                         
         CLI   TR.TLBYTYPA,TLTYPAQ                                              
         BE    DFLGX               EXIT                                         
*                                                                               
         B     DFLG0030                                                         
*                                                                               
DFLGX    DS    0H                                                               
         GOTOR CLEARFLG                                                         
         B     EXIT                                                             
*                                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
         DROP  R4                                                               
         DROP  TR2                                                              
*                                                                               
* EQUATE FOR DAILY BUY ATTRIBUTE FLAG                                           
*                                                                               
DLYMATCH EQU   X'80'                                                            
DLYOPHAN EQU   X'40'               THERE IS AN ORPHAN                           
DLYNOMTH EQU   X'20'               NOT TOTALLY MATCH                            
DLYLINK  EQU   X'10'               THERE IS A LINK SEGMENT IN THIS GRP          
DLYADDSK EQU   X'08'               THERE IS AN ADD-TO-SKED                      
DLYNOCAN EQU   X'04'               THIS IS NOT A CANCELLATION                   
***********************************************************************         
* FIRST REMOVE THE MATCH NUMBER, SORT TSAR RECORDS BY DAY/TIME/LEN/RATE         
* THEN PUT IN THE MATCH NUMBER AGAIN                                            
***********************************************************************         
PUTMNUM  NTR1  BASE=*,WORK=(R4,DLWORKQ),LABEL=*                                 
         USING DLWORKD,R4                                                       
         XC    TSARREC,TSARREC                                                  
         XC    TSARREC2,TSARREC2                                                
         MVI   TR.TLKTYP,X'0B'                                                  
         GOTO1 GOTSAR,TSARDH                                                    
         BL    PUTM0200                                                         
*                                                                               
PUTM0030 DS    0H                                                               
         CLI   TR.TLKTYP,X'0B'                                                  
         BNE   PUTM0200                                                         
         CLI   TR.TLBYFLG,TLMTHQ3                                               
         BE    PUTM0200            SKIP TOTALLY MATCH RECORDS                   
         CLI   TR.TLBYTYPA,TLTYPAQ                                              
         BE    PUTM0200            DONE                                         
         CLI   TR.TLBYFLG,TLUMTHQ                                               
         BE    PUTM0200                                                         
*                                                                               
PUTM0050 DS    0H                                                               
         CLI   TR.TLBYLNK,0                                                     
         BE    PUTM0150            SKIP                                         
*                                                                               
         MVC   HALF,TB.TSRNUM                                                   
         MVC   DLWORK,TSARREC                                                   
         GOTO1 GOTSAR,TSADEL                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   TSARREC,DLWORK                                                   
         MVC   TR.TLBYMNUM,TR.TLBYLNK                                           
         XC    TR.TLBYLNK,TR.TLBYLNK                                            
*                                                                               
         GOTO1 GOTSAR,TSAADD                                                    
         CLI   TB.TSERRS,0                                                      
         BE    PUTM0100                                                         
         TM    TB.TSERRS,TSEDUP                                                 
         BO    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   TR.TLBYUID,TR.TLBYLNK                                            
         GOTO1 GOTSAR,TSAADD                                                    
         CLI   TB.TSERRS,0                                                      
         BE    PUTM0100                                                         
         DC    H'0'                                                             
*                                                                               
PUTM0100 DS    0H                                                               
         MVC   TXNUM,HALF                                                       
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   TSARREC,DLWORK                                                   
         BNE   PUTM0030                                                         
*                                                                               
PUTM0150 DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSANXT                                                    
         BNL   PUTM0030                                                         
***********************************************************************         
*                                                                               
***********************************************************************         
PUTM0200 DS    0H                  CONVERT 0C TO 0B                             
*                                                                               
         XC    TSARREC,TSARREC                                                  
         XC    TB.TSRNUM,TB.TSRNUM                                              
         MVI   TR.TLKTYP,X'0B'                                                  
         GOTO1 GOTSAR,TSARDH                                                    
         BL    PUTM0400                                                         
*                                                                               
PUTM0230 DS    0H                                                               
         CLI   TR.TLKTYP,X'0B'                                                  
         BNE   PUTM0400                                                         
         CLI   TR.TLBYFLG,TLUMTHQ                                               
         BE    PUTM0400                                                         
         CLI   TR.TLBYTYPA,TLTYPAQ                                              
         BE    PUTM0400            DONE                                         
*                                                                               
PUTM0250 DS    0H                                                               
         CLI   TR.TLBYMNUM,0                                                    
         BE    PUTM0300            SKIP                                         
*                                                                               
         MVC   TR.TLBYLNK,TR.TLBYMNUM                                           
         XC    TR.TLBYMNUM,TR.TLBYMNUM                                          
         OI    TB.TSINDS,TSIKEYUP                                               
*&&DO                                                                           
         CLC   TR.TLBYTIME,=X'0018'                                             
         BNE   *+6                                                              
         DC    H'0'                                                             
*&&                                                                             
         GOTO1 GOTSAR,TSAPUT                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
PUTM0300 DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSANXT                                                    
         BNL   PUTM0230                                                         
*                                                                               
PUTM0400 DS    0H                                                               
         NI    TB.TSINDS,FF-TSIKEYUP                                            
PUTMRX   DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
         DROP  R4                                                               
***********************************************************************         
* MERGE SEGMENT                                                                 
* THS GETS CALL WHEN TWO SEGMENTS ARE THE SAME BUT THE BUYS WITHIN              
* THEM ARE DIFFERENT, HAPPENS WHEN SEGMENTS GOT BROKEN INTO HALF                
* WHEN USER UNMATCH BUYS IN THE SAME SEGMENT, THEN MATCH ONE OF THEM            
* TO OTHER SEGMENT, THEN UNMATCH AGAIN                                          
***********************************************************************         
MERGES   NTR1  BASE=*,WORK=(R4,DLWORKQ),LABEL=*                                 
*                                                                               
         USING DLWORKD,R4                                                       
         MVC   DLWORK,TSARREC                                                   
TR2      USING TLSTD,DLWORK                                                     
*                                                                               
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         OC    TR2.TLBYALNK,TR2.TLBYALNK                                        
         BZ    MERG0400                                                         
*                                  NEED TO MERGE BUYS INTO AGY PORTION          
MERG0100 DS    0H                                                               
         OC    TR.TLBYALNK,TR.TLBYALNK                                          
         BO    MERG0200                                                         
*                                                                               
         MVC   TR.TLBYAFLG,TR2.TLBYAFLG                                         
         MVC   TR.TLBYALNK,TR2.TLBYALNK                                         
         GOTO1 GOTSAR,TSAWRT                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         B     MERG0300                                                         
*                                                                               
MERG0200 DS    0H                  NEED TO BUILD BUY LINK                       
*                                                                               
         TM    TR.TLBYAFLG,X'40'   BUY LINK?                                    
         BO    *+6                                                              
         DC    H'0'                SHOULDN'T HAPPEN                             
*                                                                               
         MVC   DLWORK3,TSARREC                                                  
TR3      USING TLSTD,DLWORK3                                                    
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,C'A'                                                   
         MVC   TR.TLBLINDX,TR3.TLBYALNK                                         
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,TR.TLBLBUY#                                                   
         USING TLBLBUY#,R3                                                      
         CLI   0(R3),X'00'                                                      
         BE    *+12                                                             
         LA    R3,TLBLLENQ(R3)                                                  
         B     *-12                                                             
*                                                                               
         MVC   TR.TLBLBUY#,TR2.TLBYALNK                                         
         SR    R3,R3                                                            
         ICM   R3,3,TR.TLLEN                                                    
         AHI   R3,TLBLLENQ                                                      
         STCM  R3,3,TR.TLLEN                                                    
         GOTO1 GOTSAR,TSAWRT                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
MERG0300 DS    0H                  END OF THIS PROCESSING                       
         B     MERG0800                                                         
*                                                                               
MERG0400 DS    0H                                                               
         OC    TR.TLBYRLNK,TR.TLBYRLNK                                          
         BO    MERG0600                                                         
*                                                                               
         MVC   TR.TLBYRFLG,TR2.TLBYRFLG                                         
         MVC   TR.TLBYRLNK,TR2.TLBYRLNK                                         
         GOTO1 GOTSAR,TSAWRT                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         B     MERG0800                                                         
*                                                                               
MERG0600 DS    0H                  NEED TO BUILD BUY LINK                       
*                                                                               
         TM    TR.TLBYRFLG,X'40'   BUY LINK?                                    
         BO    *+6                                                              
         DC    H'0'                SHOULDN'T HAPPEN                             
*                                                                               
         MVC   DLWORK3,TSARREC                                                  
TR3      USING TLSTD,DLWORK3                                                    
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,C'R'                                                   
         MVC   TR.TLBLINDX,TR3.TLBYRLNK                                         
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R3,TR.TLBLBUY#                                                   
         USING TLBLBUY#,R3                                                      
         CLI   0(R3),X'00'                                                      
         BE    *+12                                                             
         LA    R3,TLBLLENQ(R3)                                                  
         B     *-12                                                             
*                                                                               
         MVC   TR.TLBLBUY#,TR2.TLBYRLNK                                         
         SR    R3,R3                                                            
         ICM   R3,3,TR.TLLEN                                                    
         AHI   R3,TLBLLENQ                                                      
         STCM  R3,3,TR.TLLEN                                                    
         GOTO1 GOTSAR,TSAWRT                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
MERG0800 DS    0H                                                               
*                                                                               
MERGX    DS    0H                                                               
*                                                                               
         B     EXIT                                                             
         DROP  R3,R4                                                            
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* DISPLAY A LINE FROM A TSAR SEGMENT                                  *         
* DISLINE   PARAMETER 1          A(DISPLAY AREA)                      *         
*                                                                     *         
*           PARAMETER 2  BYTE 1  X'80' = ONLY DISPLAY GRID INFO       *         
*                                X'40' = DO NOT UNPROTECT THIS LINE   *         
*                        BYTE 2-4                                     *         
*                                A(BUY SEGMENT)                       *         
*                                                                     *         
*           PARAMETER 3  BYTE 1  C'R'  = REP BUY                      *         
*                                C'A'  = AGY BUY                      *         
*                        BYTE 2-4                                     *         
*                                A(BUY NUMBER)                        *         
*                                                                     *         
*           PARAMETER 4          A(BUFFER) TO STORE RESULTS FROM      *         
*                                  SPOT DIFFERENCE CALCULATION PASSING*         
*                                  BACK FROM COMPLINE                 *         
*                                SEE TOMBSTONE IN GETNDX FOR LAYOUT   *         
*                                OF THIS AREA                         *         
*---------------------------------------------------------------------*         
* LAY OUT OF AREA POINT TO BY PARAMETER 4                                       
*---------------------------------------------------------------------*         
* AGY SPOTS  |  TOTAL REP SPOTS |  SPOT DIFFERENCE  |  TOTAL AGY SPOTS|         
*---------------------------------------------------------------------*         
* 1ST 255 BYTE OF DLIO = AGENCY SPOTS FOR CALCULATION                 |         
* 2ND 255 BYTE OF DLIO = TOTAL REP SPOTS IN THIS SEGMENT              |         
* 3RD 255 BYTE OF DLIO = SPOT DIFFERENCES BETWEEN AGY AND REP LINES   |         
*                        WITHIN THIS SEGMENT                          |         
* 4TH 255 BYTE OF DLIO = TOTAL AGENCY SPOTS IN THIS                   |         
*                        SEGMENT                                      |         
***********************************************************************         
DISLINE  NTR1  BASE=*,WORK=(R6,ELWORKQ),LABEL=*                                 
         LM    R2,R4,0(R1)                                                      
*        MVC   ELBYTE,4(R1)                                                     
         MVC   MYBUYTYP,8(R1)                                                   
         MVC   MYBUY#(1),0(R4)                                                  
         MVC   MYBUY#+1(1),2(R4)   SUB LINE NUMBER                              
         USING DIFFSUM,R2                                                       
         USING ELWORKD,R6                                                       
         L     RF,12(R1)                                                        
         ST    RF,ELSVIO                                                        
         DROP  R6                                                               
*******                                                                         
* COLOR                                                                         
*******                                                                         
         MVI   DSCOLOR,C' '                                                     
         TM    STEREOFG,STFINUSE                                                
         BZ    DISL010                                                          
*                                                                               
         MVI   DSCOLOR,REPCOLOR                                                 
         TM    CFLAG,CFKAGYQ                                                    
         BO    DISL008                                                          
         CLI   MYBUYTYP,C'R'                                                    
         BE    DISL010                                                          
DISL008  MVI   DSCOLOR,AGYCOLOR                                                 
*                                                                               
DISL010  DS    0H                                                               
*                                                                               
BUYSEG   USING TLSTD,R3                                                         
         MVC   ORBCTR,=H'1'        ORBIT COUNTER                                
*                                                                               
         TM    FLAGS,FGPRTQ        IF WE ARE PRINTING                           
         BZ    DISL015                                                          
         L     RF,GNXSVIOX                                                      
         CR    R2,RF                                                            
         BL    DISL050                                                          
         GOTOR TRANLINE,DMCB,GNXSVIO  PRINT BUFFER OVERFLOW                     
         L     R2,GNXSVIO          PUSH THE STUFF OUT AND RELOAD R2             
         B     DISL050                                                          
*                                                                               
DISL015  DS    0H                                                               
         LA    RF,DIFEND                                                        
         CLI   BUYSEG.TLBYFLG,TLLNKQ                                            
         BNE   DISL018             IF LINK AGENCY SEGMENT, ALLOW IT TO          
         CLI   BUYSEG.TLBYTYPA,TLTYPAQ                                          
         BNE   DISL018             DISPLAY TO THE LAST LINE                     
         TM    BUYSEG.TLBYAFLG,X'40'   BUY LINK?                                
         BO    DISL018             YES,DON'T ALLOW IT TO DISPLAY TO THE         
*                                  LAST LINE                                    
         OC    BUYSEG.TLBYMLNK,BUYSEG.TLBYMLNK                                  
         BZ    DISL019             DAILY/C.O/C.E.D? NO!                         
*                                                                               
DISL018  DS    0H                                                               
         SHI   RF,LISTLEN                                                       
DISL019  DS    0H                                                               
         CR    R2,RF                                                            
         BH    DISLNO              EXIT                                         
*                                                                               
         NI    DSLINEH+1,X'FF'-X'08'     TURN OFF HIGH INTENSITY                
         TM    4(R1),X'40'              DO NOT UNPROTECT THIS FIELD             
         BO    DISL050                                                          
*                                                                               
         TM    DISFLG3,D31STREP                                                 
         BO    DISL050                                                          
         TM    DISFLG3,D3MINI                                                   
         BO    DISL050                                                          
*                                                                               
         CLI   MYBUYTYP,C'R'             REP LINE?                              
         BNE   DISL050                                                          
*                                                                               
         CLI   DISFLG2,DMATCHQ           DISPLAYING MATCH LINES?                
         BNE   DISL030                   NO, UNPROTECT INPUT FIELD              
         CLI   MFLAG,MASSUMEQ            YES, ASSUME MATCH?                     
         BNE   DISL020                   NO, UNPROTECT INPUT FIELD              
*                                                                               
         TM    BUYSEG.TLBYFLG4,X'40'     CANCELLED DAILYS?                      
         BO    DISL050                   DONOT UNPROTECT                        
         OC    BUYSEG.TLBYLNK,BUYSEG.TLBYLNK                                    
         BZ    DISL050                   LINK BY USER? NO, DONOT UNPROT         
*                                                                               
         TM    BUYSEG.TLBYFLG4,X'08'     SYSTEM FORCE MATCH DAILY               
         BO    DISL050                                                          
*                                                                               
DISL020  DS    0H                                                               
         NI    DSINPUTH+1,X'FF'-X'20'    YES, UNRPOTECT INPUT FIELD             
         B     DISL060                   SKIP UNMATCH AGENCY LINE CHECK         
*                                                                               
DISL030  DS    0H                                                               
         NI    DSINPUTH+1,X'FF'-X'20'    TURN OFF PROTECTED                     
         NI    DSTYPAH+1,X'FF'-X'20'                                            
*                                                                               
DISL050  DS    0H                                                               
         TM    DISPFLGS,DFUAGYL         IS THERE UNMATCH AGY LINE?              
         BO    DISL060                  YES, DO NO UNPROTECT ALL FIELD          
         OI    DSINPUTH+1,X'20'                                                 
         OI    DSTYPAH+1,X'20'                                                  
*                                                                               
DISL060  DS    0H                                                               
         USING ELWORKD,R6                                                       
         ST    R6,MYSVIO           BUFFER                                       
         MVC   ELWORK,TSARREC      BACK TSARREC UP                              
*                                                                               
         TM    4(R1),X'80'                                                      
         BO    DISL1300                                                         
         DROP  R6                                                               
*                                                                               
         MVC   TXNUM,BUYSEG.TLBYDAY RETRIEVE DAY(S)                             
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   GNXSVDRC,TSARREC    SAVE OFF DAYS RECORD                         
*                                                                               
TRDAYS   USING TLSTD,GNXSVDRC                                                   
**********                                                                      
* TIME(S)                                                                       
**********                                                                      
         MVC   TXNUM,BUYSEG.TLBYTIME RETRIEVE TIME(S)                           
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R6,TRDAYS.TLDYSTEN                                               
         LA    R4,TR.TLTMSTRT                                                   
         LR    R0,R2               BACK UP THE DISPLAY LINE                     
*                                                                               
DISL100  DS    0H                  IF SINGLE DAY, WE NEED                       
         TM    0(R6),X'F0'         TO PUT THE START DAY                         
         BNO   DISL150             BACK IN THE FIRST NIBBLE                     
         ZIC   R1,0(R6)                                                         
         SLL   R1,4                                                             
         STC   R1,HALF                                                          
         MVN   HALF(1),0(R6)                                                    
         MVC   0(1,R6),HALF                                                     
*                                                                               
DISL150  DS    0H                                                               
         GOTOR OUTDAY1,DMCB,1(R6),DSDAY                                         
         MVC   STENDAY,0(R6)                                                    
         GOTO1 UNTIME,DMCB,0(R4),DSTIME                                         
*                                                                               
DISL180  DS    0H                                                               
         AHI   R6,L'TRDAYS.TLDYSTEN+L'TRDAYS.TLDYDAYS                           
         AHI   R4,L'TR.TLTMSTRT+L'TR.TLTMENDT                                   
         CLI   0(R6),0                                                          
         BE    DISL200                                                          
*                                                                               
         LA    RF,LISTLEN                                                       
         TM    FLAGS,FGPRTQ                                                     
         BZ    *+8                                                              
         LA    RF,LISTLENP         PRINT OUT NEEDS MORE LENGTH                  
*                                                                               
         LA    R2,0(RF,R2)         FOR ORBIT                                    
*                                                                               
         TM    FLAGS,FGPRTQ                                                     
         BO    DISL180A                                                         
*&&DO                                                                           
         LA    RF,DIFEND                                                        
         SHI   RF,LISTLEN                                                       
         CR    R2,RF                                                            
*&&                                                                             
         BRAS  RE,ISEOSCR                                                       
         BH    DISLNO                                                           
*                                                                               
DISL180A DS    0H                                                               
         NI    DSLINEH+1,X'FF'-X'08'     TURN OFF HIGH INTENSITY                
*                                                                               
         LH    RF,ORBCTR                                                        
         AHI   RF,1                                                             
         STH   RF,ORBCTR                                                        
*                                                                               
         B     DISL100                                                          
*                                                                               
DISL200  DS    0H                                                               
         LR    R2,R0               RESTORE R2                                   
*                                                                               
***>>    OC    BUYSEG.TLBYPROG,BUYSEG.TLBYPROG                                  
***>>    BZ    DISL300                                                          
***>>                                                                           
         CLI   MYBUYTYP,C'R'       DISPLAY ***** FOR REP PGM NAME               
         BNE   DISL220                                                          
         TM    OVRDFLG,OVPGMQ      IF IT DIFFERS FROM AGY PGM NAME              
         BZ    DISL220                                                          
*                                                                               
         MVC   DSPGM(5),=C'*****'                                               
         TM    FLAGS2,FG2EXPD          SQUEEZ FORMAT MAY DISPLAY                
         BO    DISL300                 MORE THAN 5 CHARACTERS OF PGM            
         MVC   DSPGM(MAXPGM),=C'**********'                                     
         B     DISL300                                                          
*                                                                               
DISL220  DS    0H                                                               
         CLI   DISFLG2,DMATCHQ         MATCH AGY LINE                           
         BNE   DISL225                                                          
         CLI   MYBUYTYP,C'A'                                                    
         BE    DISL300                 DO NOT DISPLAY PROGRAM NAME              
*                                                                               
DISL225  DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,X'05'         BASE ON LINE#                            
         MVC   TR.TLPTYP,MYBUYTYP                                               
         MVC   TR.TLPLN#,MYBUY#                                                 
         GOTO1 GOTSAR,TSARDH                                                    
         BNE   DISL300                                                          
*                                                                               
         LH    RF,TR.TLLEN                                                      
         SHI   RF,TLPGM-TLREC          OVERHEAD                                 
*                                                                               
DISL230  DS    0H                                                               
         TM    FLAGS2,FG2EXPD          SQUEEZ FORMAT MAY DISPLAY                
         BZ    DISL250                 MORE THAN 5 CHARACTERS OF PGM            
                                                                                
         LA    RE,L'DSPGM-1                                                     
         CHI   RF,L'DSPGM                                                       
         BNH   DISL250                                                          
                                                                                
         LR    RF,RE                                                            
         MVI   DSPGM+L'DSPGM-1,C'+'    INSERT + SIGN IF OVER DISPLAYED          
                                                                                
DISL250  DS    0H                                                               
         CHI   RF,MAXPGM                                                        
         BNH   *+8                                                              
         LHI   RF,MAXPGM           REDUCE TO MAX ALLOWABLE PGM NAME             
*                                                                               
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   DSPGM(0),TR.TLPGM                                                
*                                                                               
DISL300  DS    0H                                                               
*                                      LENGTH                                   
         EDIT  BUYSEG.TLBYLEN,DSLEN                                             
*                                      RATE                                     
         ICM   RF,15,BUYSEG.TLBYRATE   DO NOT DISPLAY DECIMAL PTS               
         SR    RE,RE                                                            
         LHI   R4,100                                                           
         DR    RE,R4                                                            
         LR    R4,RF                                                            
         EDIT  (R4),DSRATE,FLOAT=$,ZERO=NOBLANK                                 
*                                                                               
         MVI   OVRDFLG,0           CLEAR OVERRID FLAG                           
                                                                                
         TM    BUYSEG.TLBYFLG4,X'44'                                            
         BNZ   DISL400                                                          
*                                                                               
         CLI   MYBUYTYP,C'A'       ONLY COMPARE FOR AGY LINES                   
         BNE   DISL1000                                                         
                                                                                
         USING ELWORKD,R6                                                       
DISL400  L     R6,MYSVIO           BUFFER                                       
         L     RE,ELSVIO                                                        
         GOTOR COMPLINE,DMCB,(R2),(R3),(RE)                                     
         DROP  R6                                                               
*                                                                               
         CLI   DISFLG2,DMATCHQ         MATCH AGY LINE                           
         BNE   DISL1000                                                         
         CLI   MYBUYTYP,C'A'                                                    
         BNE   DISL1000                DO NOT DISPLAY PROGRAM NAME              
         TM    OVRDFLG,FF-OVPGMQ                                                
         BZ    DISLX                                                            
*                                                                               
DISL1000 DS    0H                                                               
*&&DO                                                                           
         CLC   BUYSEG.TLBYDAY(10),=X'00010003001E000061A8'                      
         BNE   *+6                                                              
         DC    H'0'                                                             
*&&                                                                             
*                                                                               
         LR    R0,R2               THIS IS FOR ORBIT DISPLAY                    
         LH    RF,ORBCTR                                                        
                                                                                
DISL1050 DS    0H                                                               
         GOTOR FMATLINE,DMCB,(R2)                                               
         LA    RE,LISTLEN                                                       
         TM    FLAGS,FGPRTQ                                                     
         BZ    *+8                                                              
         LA    RE,LISTLENP                                                      
         LA    R2,0(RE,R2)                                                      
         BCT   RF,DISL1050                                                      
                                                                                
         LR    R2,R0                                                            
                                                                                
         TM    BUYSEG.TLBYFLG4,X'40'  CANCELLED DAILY?                          
         BO    DISL1070                                                         
         TM    DISFLG3,D31STREP    DISPLAYING DAILY?                            
         BO    DISL1080            DO NOT DUPLICATE THE MATCH NUMBER            
*                                                                               
DISL1070 TM    CFLAG,CFKAGYQ       FAKING AGENCY LINE WITH 0 SPOTS?             
         BO    DISL1080            DO NOT OUTPUT MATCH NUMBER                   
         GOTOR DISMATCH,DMCB,(R2),(MYBUYTYP,MYBUY#)                             
*                                                                               
DISL1080 DS    0H                                                               
         CLI   MYBUYTYP,C'A'                                                    
         BNE   DISL1300                                                         
         CLI   DISFLG2,DMATCHQ     DISPLAYING MATCH?                            
         BNE   DISL1300                                                         
*                                                                               
         LR    RE,R2               NEEDED IF WE DO BRANCH TO DISL1800           
         TM    OVRDFLG,OVDALLQ                                                  
         BO    DISL1200                                                         
         TM    OVRDFLG,OVDSPTQ                                                  
         BZ    DISL1800                                                         
*                                                                               
DISL1200 DS    0H                  A DIFFERENT WAY TO CALL GRID ROUTINE         
         USING ELWORKD,R6                                                       
         L     R6,MYSVIO           BUFFER                                       
         L     RE,ELSVIO                                                        
         DROP  R6                                                               
*                                                                               
         TM    BUYSEG.TLBYFLG4,X'01'                                            
         BZ    DISL1240                                                         
*                                                                               
         ST    RE,FULL                                                          
         LR    RF,RE                                                            
         GOTOR FAKEDZRO,DMCB,L'TSARREC(RF),2*L'TSARREC(RF),            >        
               3*L'TSARREC(RF)                                                  
         L     RE,FULL                                                          
*                                                                               
DISL1240 LA    RE,3*L'TSARREC(RE)                                               
         ST    RE,DMCB+4                                                        
         MVI   DMCB+4,X'FF'                                                     
         B     DISL1400                                                         
*                                                                               
DISL1300 DS    0H                  NORMAL WAY OF CALLING GRID ROUTINE           
         LA    RE,MYBUY#                                                        
         ST    RE,DMCB+4                                                        
         MVC   DMCB+4(1),MYBUYTYP                                               
*                                                                               
DISL1400 DS    0H                                                               
         GOTOR DISGRID,DMCB,(R2)                                                
*                                                                               
         LR    RE,R2               RE->FIRST LINE                               
         L     R2,DMCB             LINE AFTER GRID IS PRINTED                   
*                                                                               
DISL1800 DS    0H                                                               
         LA    R8,LISTLEN                                                       
         TM    FLAGS,FGPRTQ                                                     
         BZ    *+8                                                              
         LA    R8,LISTLENP                                                      
*                                                                               
         LH    RF,ORBCTR           YES, COMPARE R2 AND RE                       
DISL2000 DS    0H                                                               
         LA    RE,0(R8,RE)         RE=WHERE WE SHOULD BE NEXT                   
         BCT   RF,DISL2000                                                      
*                                                                               
         CR    RE,R2                                                            
         BNH   *+6                                                              
         LR    R2,RE                                                            
*                                                                               
**********************************************************************          
* EXIT FOR DISPLAY                                                              
**********************************************************************          
DISLX    DS    0H                                                               
         ST    R2,DMCB                                                          
         L     R6,MYSVIO                                                        
         USING ELWORKD,R6                                                       
         MVC   TSARREC,ELWORK      RESTORE TSARREC                              
         DROP  R6                                                               
*                                                                               
DISLYES  SR    RC,RC                                                            
DISLNO   LTR   RC,RC                                                            
         B     EXIT                                                             
         DROP  TRDAYS,BUYSEG                                                    
***********************************************************************         
*                                                                               
* P1: A(REP SPOTS)                                                              
* P2: A(SPOT DIFFERENCES BETWEEN AGENCY AND REP SPOTS)                          
* P3: A(AGENCY SPOTS)                                                           
***********************************************************************         
         USING DLWORKD,R6                                                       
R        USING TLGSTD,DLWORK                                                    
D        USING TLGSTD,DLWORK2                                                   
A        USING TLGSTD,R4                                                        
*                                                                               
FAKEDZRO NTR1  BASE=*,WORK=(R6,DLWORKQ),LABEL=*                                 
         LM    R2,R4,0(R1)                                                      
*                                                                               
         MVC   DLWORK(TLGRLQ2),0(R2)                                            
         MVC   DLWORK2(TLGRLQ2),0(R3)                                           
         GOTOR SYNCGRID,DMCB,DLWORK,DLWORK2                                     
*                                                                               
         MVC   A.TLGSTD(6),D.TLGSTD                                             
*                                                                               
         LA    R2,R.TLGRID                                                      
         LA    R3,D.TLGRID                                                      
         LA    R4,A.TLGRID                                                      
         LA    R6,TLGRWKQ                                                       
                                                                                
         DROP  R,D,A                                                            
*                                                                               
         SR    RE,RE                                                            
         SR    RF,RF                                                            
*                                                                               
FDZRO10  IC    RE,0(R2)                                                         
         IC    RF,0(R3)                                                         
         AR    RE,RF                                                            
         STC   RE,0(R4)                                                         
         LTR   RF,RF                                                            
         BZ    *+8                                                              
         OI    1(R4),X'01'         NPW OVERRIDE                                 
*                                                                               
         LA    R2,TLGRSIZE(R2)                                                  
         LA    R3,TLGRSIZE(R3)                                                  
         LA    R4,TLGRSIZE(R4)                                                  
*                                                                               
         BCT   R6,FDZRO10                                                       
         MVC   0(2,R4),=X'FFFF'    TLGRIDX                                      
*                                                                               
FDZROX   B     EXIT                                                             
*                                                                               
***********************************************************************         
* SYNCHRONIZE TWO GRIDS WITH DIFFERENT START DATE                               
* P1 =         BUY GRID 1                                                       
* P2 =         BUY GRID 2                                                       
* CALLER BEAWARE: GRID 1 AND GRID 2 COULD BE CHANGED IN THIS ROUTINE            
***********************************************************************         
G1       USING TLGSTD,R2           GRID 1                                       
G2       USING TLGSTD,R3           GRID 2                                       
*                                                                               
SYNCGRID NTR1  BASE=*,LABEL=*                                                   
         LM    R2,R3,0(R1)                                                      
         MVI   BYTE2,0                                                          
*                                                                               
         CLC   G1.TLGSTD,G2.TLGSTD                                              
         BE    SYNCGX              SAME, NO NEED TO ADJUST                      
         BNH   SYNCG200                                                         
*                                                                               
         XC    0(L'TSARREC,R2),0(R3)  SWAP THE TWO AREA                         
         XC    0(L'TSARREC,R3),0(R2)                                            
         XC    0(L'TSARREC,R2),0(R3)                                            
         OI    BYTE2,X'80'         SWAPPED                                      
*                                                                               
SYNCG200 GOTOR MYPVAL,DMCB,G1.TLGSTD,G2.TLGSTD                                  
         LH    R1,DMCB             NUMBER OF WEEK DIFFERENCE                    
         MHI   R1,TLGRSIZE                                                      
         LA    RE,G2.TLGRID        GRID START                                   
         AR    RE,R1               WEEK ADJUSTED                                
*                                                                               
         MVC   WORK2(L'TSARREC),G2.TLGRID                                       
         MVC   0(TLGRIDX-TLGRID,RE),WORK2                                       
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                CLEAR OUT STARTING AREA                      
         XC    G2.TLGRID(0),G2.TLGRID                                           
         MVC   G2.TLGSTD,G1.TLGSTD MOVE IN NEW START DATE                       
         MVC   G2.TLGRIDX,=X'FFFF'                                              
*                                                                               
         TM    BYTE2,X'80'         SWAP?                                        
         BZ    SYNCGX              NO                                           
*                                                                               
         XC    0(L'TSARREC,R2),0(R3)  SWAP BACK                                 
         XC    0(L'TSARREC,R3),0(R2)                                            
         XC    0(L'TSARREC,R2),0(R3)                                            
         NI    BYTE2,X'FF'-X'80'                                                
*                                                                               
SYNCGX   B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* DISPLAY BUY NUMBER                                                            
* P1: A(BUY NUMBER)                                                             
* P2: BYTE 1   - BUY TYPE (A/R)                                                 
*     BYTE 2-4 - A(EXACT FIELD TO DISPLAY THE NUMBER)                           
***********************************************************************         
DISBUY#  NTR1  BASE=*,LABEL=*                                                   
         LM    R2,R3,0(R1)                                                      
*                                                                               
         IC    R4,4(R1)                                                         
         CLI   4(R1),C'A'                                                       
         BNE   DISBUY50                                                         
*                                                                               
         GOTOR GETBUY#,DMCB,(1,(R2))   TRANSLATE BUY NUMBER                     
         BNE   DISBUY50                                                         
         LA    R2,DMCB+4                                                        
         EDIT  (2,(R2)),(3,(R3)),ALIGN=RIGHT,ZERO=NOBLANK                       
         B     DISBUY60                                                         
*                                                                               
DISBUY50 EDIT  (1,(R2)),(3,(R3)),ALIGN=RIGHT,ZERO=NOBLANK                       
DISBUY60 CLI   0(R3),X'40'                                                      
         BH    *+8                                                              
         STC   R4,0(R3)                                                         
*                                                                               
         CLI   1(R3),X'40'                                                      
         BH    *+14                                                             
         MVC   1(1,R3),2(R3)       MOVE SIGNIFICANT NUMBER TO THE LEFT          
         MVI   2(R3),0             CLEAN UP                                     
*                                                                               
DBUY#X   DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* DISPLAY BUY NUMBER                                                            
* PARAM: P1:   BYTE 1:   SEARCHING OPTION                                       
*                        1. SEARCH BY INTERNAL NUMBER                           
*                        2. SEARCH BY EXTERNAL NUMBER                           
*              BYTE2-4:  BUY NUMBER                                             
* OUTPUT: P1:  BYTE 1-2  RETURN BUY NUMBER                                      
***********************************************************************         
GETBUY#  NTR1  BASE=*,LABEL=*                                                   
         TM    SVDARFL2,SF2XML                                                  
         BZ    GBUY#NO                                                          
*                                                                               
         L     R3,0(R1)                                                         
         L     R2,ABUYTAB                                                       
         LA    R4,L'BUYTAB(R2)                                                  
         USING BUYTABD,R2                                                       
*                                                                               
         XC    HALF,HALF                                                        
*                                                                               
         MVC   HALF(1),0(R3)                                                    
         CLI   0(R1),1                                                          
         BE    *+10                                                             
         MVC   HALF(2),0(R3)                                                    
*                                                                               
GBUY0000 CR    R2,R4                                                            
         BNL   GBUY#NO                                                          
         CLI   0(R1),1                                                          
         BNE   GBUY0200                                                         
         CLC   INTBUY#,HALF                                                     
         BNE   GBUYNEXT                                                         
         B     GBUY0400                                                         
*                                                                               
GBUY0200 CLC   EXTBUY#,HALF                                                     
         BE    GBUY0400                                                         
*                                                                               
GBUYNEXT DS    0H                                                               
         LA    R2,BUYTABL(R2)                                                   
         B     GBUY0000                                                         
*                                                                               
GBUY0400 DS    0H                                                               
         MVC   DMCB+4(1),INTBUY#                                                
         CLI   0(R1),2                                                          
         BE    *+10                                                             
         MVC   DMCB+4(2),EXTBUY#                                                
*                                                                               
GBUY#YES SR    RC,RC                                                            
GBUY#NO  LTR   RC,RC                                                            
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* DISPLAY GRID                                                                  
* GET GRID TSAR RECORD BY BUY #                                                 
* ---------------------------------------------------------------------         
* P1: BYTE 2-4 - A(DISPLAY LINE)                                                
*                                                                               
* P2: BYTE 5   - BUY TYPE (A/R), OR IF X'FF',X'FE', SPECIAL OPTIONS             
*                X'FF' = USING A GRID BUFFER INSTEAD OF A TSAR RECORD           
*                X'FE' = SHOW SPOT DIFFERENCES FOR OVERRIDE                     
*                                                                               
*     BYTE 6-8 - A(BUY NUMBER)                                                  
*                IF BYTE1 = X'FE', BYTE 2-4 WILL HOLD A(GRID) TO BE             
*                DISPLAYED. THIS IS A CALCULATED RESULT OF ROUTINE              
*                COMPLINE                                                       
*                                                                               
* P3: BYTE 9     X'80' = USE BYTE 10-11 FOR ADDITIONAL SPOT INFORMATION         
*          10-11 ADDITIONAL BUFFER FOR DAILY BUY CANCELLATION                   
*                LEADING/TRAILING ZERO DISPLAY, ONLY USE WHEN                   
*                BYTE 9 = X'80'                                                 
*                                                                               
***********************************************************************         
DISGRID  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LM    R2,R3,0(R1)                                                      
         USING DIFFSUM,R2                                                       
*                                                                               
         XC    BYTE2,BYTE2                                                      
         XC    TSARREC,TSARREC                                                  
*                                                                               
         CLI   4(R1),X'FF'                                                      
         BE    DISG0100                                                         
*                                                                               
         CLI   4(R1),X'FE'                                                      
         BNE   DISG0150                                                         
*                                                                               
         NI    DSLINEH+1,X'FF'-X'08'     TURN OFF HIGH INTENSITY                
         MVC   DSLINE(CHANGEQ),CHANGE                                           
*                                                                               
DISG0100 DS    0H                                                               
         MVC   BYTE2,4(R1)          SAVE OFF CALLING OPTION                     
         MVC   TR.TLGSTD(TLGRLQ2),0(R3)                                         
         B     DISG0200                                                         
*                                                                               
DISG0150 DS    0H                                                               
         MVI   TR.TLKTYP,X'04'     KEY TO GRID RECORD                           
*                                                                               
         MVC   TR.TLGTYP,4(R1)                                                  
         CLI   TR.TLGTYP,C'A'                                                   
         BNL   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   TR.TLGLN#,0(R3)     BUY NUMBER                                   
         CLI   TR.TLGTYP,C'R'                                                   
         BE    *+10                                                             
         MVC   TR.TLGLN#(L'TLGLN#+L'TLGSUB#),0(R3)     BUY NUMBER               
*                                                                               
         MVC   WORK(32),TR.TLKEY   RESTORE KEY                                  
         GOTO1 GOTSAR,TSARDH                                                    
*                                  READ HIGH: SEE IF KEY EXISTS                 
         TM    TB.TSERRS,TSERNF    RECORD NOT FOUND SET?                        
         BNO   *+6                 NO  - RECORD WAS FOUND                       
         DC    H'0'                                                             
*                                                                               
DISG0200 DS    0H                                                               
         LA    R4,TR.TLGRID        R4->A(TSAR GRID)                             
         LA    R6,DSGRID           R6->A(GRID ON SCREEN)                        
         TM    FLAGS2,FG2EXPD                                                   
         BO    *+8                                                              
         LA    R6,DSTYPR+SQZBUYQ+1 IF SQZ FORMAT, WE START EARLIER              
*                                                                               
         SR    R3,R3               R3=# OF WK DIFFERENCES                       
*                                                                               
         MVC   TEMPDATE,GRSTDATE                                                
*                                                                               
DISG0250 CLC   TR.TLGSTD,TEMPDATE                                               
         BE    DISG0800            IF BUY DATE = GRID START DATE                
*                                  DO NOTHING                                   
         CLC   TR.TLGSTD,TEMPDATE  IF BUY DATE > GRID START DATE                
         BH    DISG0500                                                         
*                                                                               
DISG0300 DS    0H                  BUY START DATE < GRID START DATE             
         GOTOR MYPVAL,DMCB,TR.TLGSTD,TEMPDATE                                   
*                                                                               
         LH    R3,DMCB                                                          
         MHI   R3,TLGRSIZE         GRID UNIT SIZE                               
         AR    R4,R3                                                            
         SR    R3,R3                                                            
         B     DISG0800                                                         
*                                                                               
DISG0500 DS    0H                  BUY START DATE > GRID START DATE             
         GOTOR MYPVAL,DMCB,TEMPDATE,TR.TLGSTD                                   
*                                                                               
         LH    R3,DMCB                                                          
         MHI   R3,DSGRIDQ          GRID UNIT SIZE ON DISPLAY                    
         AR    R6,R3                                                            
         LH    R3,DMCB                                                          
*                                                                               
DISG0800 DS    0H                                                               
         LA    RE,PRTWKQ           PRTWKQ=30 WK/LINE                            
         TM    FLAGS2,FG2EXPD                                                   
         BZ    *+8                                                              
         LA    RE,EXPRTWKQ         EXPRTWKQ=28 WK/LINE                          
*                                                                               
         TM    FLAGS,FGPRTQ                                                     
         BO    DISG0900                                                         
*                                                                               
         LA    RE,EXPWKQ           EXPWKQ=10 WK/LINE                            
         TM    FLAGS2,FG2EXPD                                                   
         BO    *+8                                                              
         LA    RE,SQZWKQ           SQZWKQ=13 WK/LINE                            
*                                                                               
DISG0900 DS    0H                  LOOP THROUGH BUY GRID AND DISPLAY            
         SR    RE,R3                                                            
         BNP   DISG1100                                                         
*                                                                               
         LA    R3,TR.TLGRID+L'TLGRID-TLGRSIZE                                   
DISG0920 DS    0H                  LOOP THROUGH BUY GRID AND DISPLAY            
         CLI   0(R3),0             0 SPOT?                                      
         BNE   DISG1000                                                         
*                                                                               
         TM    1(R3),X'01'         NPW OVERRIDE?                                
         BO    DISG1000            YES                                          
*                                                                               
         SHI   R3,TLGRSIZE                                                      
         B     DISG0920            NO, CONTINUE                                 
*                                                                               
DISG1000 DS    0H                  LOOP THROUGH BUY GRID AND DISPLAY            
         CLC   0(2,R4),=X'FFFF'                                                 
         BE    DISGX                                                            
         CR    R4,R3               REACH THE LAST GRID                          
         BH    DISGX                                                            
*                                                                               
         CLI   BYTE2,X'FE'                                                      
         BE    DISG1009                                                         
         TM    CFLAG,CFKAGYQ       FAKING AGENCY LINE?                          
         BZ    DISG1009                                                         
*                                                                               
         MVI   2(R6),C'0'          ZERO SPOT                                    
         B     DISG1050            NEXT                                         
*                                                                               
* COPY FROM EDIT MACRO AND MODIFY                                               
*                                                                               
DISG1009 XC    BYTE,BYTE                                                        
DISG1010 DS    0H                  LOOP THROUGH BUY GRID AND DISPLAY            
         SR    R0,R0                                                            
         IC    R0,0(R4)                                                         
         CVD   R0,DUB                                                           
         MVC   WORK(17),=X'4040404040402020202020202020202020'                  
         MVI   WORK+15,X'21'                                                    
         LA    R1,WORK+16                                                       
         EDMK  WORK(17),DUB+2                                                   
         BCTR  R1,R0                                                            
*                                                                               
         CP    DUB,=P'0'           ZERO?                                        
         BE    DISG1030                                                         
*                                                                               
         CLI   BYTE2,X'FE'                                                      
         BNE   DISG1030                                                         
         CLI   0(R4),X'7F'         POSITIVE?                                    
         BNH   DISG1020                                                         
*                                                                               
         SR    RF,RF               NEGATIVE                                     
         IC    RF,0(R4)                                                         
         LNR   RF,RF                                                            
         STC   RF,0(R4)                                                         
         OI    BYTE,X'80'         SET NEGATIVE FLAG                             
         B     DISG1010                                                         
*                                                                               
DISG1020 DS    0H                                                               
         MVI   0(R1),C'+'                                                       
         TM    BYTE,X'80'          NEGATIVE?                                    
         BZ    DISG1030                                                         
         MVI   0(R1),C'-'          YES                                          
*                                                                               
DISG1030 DS    0H                                                               
         MVC   0(3,R6),WORK+17-(3)                                              
*                                                                               
*        EDIT  (1,0(R4)),(3,0(R6)),ZERO=NOBLANK,FLOAT=-                         
*                                                                               
DISG1050 DS    0H                  LOOP THROUGH BUY GRID AND DISPLAY            
         LA    R4,TLGRSIZE(R4)                                                  
         LA    R6,DSGRIDQ(R6)                                                   
         BCT   RE,DISG1000                                                      
*                                                                               
DISG1100 DS    0H                                                               
         TM    FLAGS,FGPRTQ                                                     
         BZ    DISGX                                                            
********************************************************************            
* THIS SECTION HANDLES LINES THAT HAVE SPOTS EXPAND MORE THAN 30 WKS            
* WHEN PRINTING, WE GET TO A NEW LINE AND PRINT OUT WEEK HEADERS                
* AND SPOT CORRESPONDING TO THE HEADERS, WHILE ON DISPLAY, WE LET               
* THE USER DO SCROLLING TO SEE ALL THE SPOTS                                    
********************************************************************            
         LA    RF,TR.TLGRID+L'TLGRID-1                                          
         SR    RF,R4                                                            
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         OC    0(0,R4),0(R4)                                                    
         BZ    DISGX                                                            
         OI    DISFLG3,D3LGRID                                                  
*                                                                               
*        CLI   TR.TLGLN#,69                                                     
*        BNE   *+6                                                              
*        DC    H'0'                                                             
*                                                                               
         SR    R0,R0                                                            
         LA    R0,5                5 LINES FOR LARGE GRID DISPLAY               
         LR    RE,R2                                                            
         L     RF,GNXSVIOX                                                      
*                                                                               
DISG1110 DS    0H                                                               
         CR    RE,RF                                                            
         BNL   DISG1120                                                         
         LA    RE,LISTLENP(RE)                                                  
         BCT   R0,DISG1110                                                      
         B     DISG1130                                                         
*                                                                               
DISG1120 DS    0H                                                               
         GOTOR TRANLINE,DMCB,GNXSVIO  PRINT BUFFER OVERFLOW                     
         L     R2,GNXSVIO          PUSH THE STUFF OUT AND RELOAD R2             
         B     DISG1140                                                         
*                                                                               
DISG1130 DS    0H                                                               
*                                  LOOP THROUGH BUY GRID AND DISPLAY            
         LA    R2,LISTLENP*2(R2)   DROP DOWN 2 LINES                            
*                                                                               
DISG1140 DS    0H                                                               
         LA    R3,PRTWKQ*7         PRINT NEXT WEEK HEADER                       
         TM    FLAGS2,FG2EXPD                                                   
         BZ    *+8                                                              
         LA    R3,EXPRTWKQ*7                                                    
*                                                                               
         MVC   ELEM+50(L'GRSTDATE),GRSTDATE                                     
         GOTO1 DATCON,DMCB,(3,ELEM+50),(0,ELEM)                                 
         GOTO1 ADDAY,DMCB,ELEM,ELEM+6,(R3)                                      
         GOTO1 DATCON,DMCB,(0,ELEM+6),(3,ELEM+50)                               
*                                                                               
         LA    RA,70(R2)                                                        
         TM    FLAGS2,FG2EXPD                                                   
         BZ    DISG1150                                                         
         LA    RA,79(R2)                                                        
DISG1150 DS    0H                                                               
         GOTOR DISWKH,DMCB,ELEM+50,(RA),LISTLENP(RA)                            
         L     RF,DMCB                                                          
         SR    RF,RA                                                            
         SHI   RF,DSGRIDQ                                                       
         LA    RA,LISTLENP*2(RA)                                                
         MVI   0(RA),C'-'                                                       
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   1(0,RA),0(RA)                                                    
         LA    R2,LISTLENP*3(R2)                                                
         LA    R6,DSTYPR+SQZBUYQ+1 R6->A(GRID ON SCREEN)                        
         TM    FLAGS2,FG2EXPD                                                   
         BZ    *+8                                                              
         LA    R6,DSTYPR+EXPBUYQ+1                                              
         MVC   TEMPDATE,ELEM+50                                                 
         LA    R4,TR.TLGRID                                                     
         SR    R3,R3                                                            
         B     DISG0250                                                         
*                                                                               
DISGX    DS    0H                                                               
         LA    R3,LISTLEN                                                       
         TM    FLAGS,FGPRTQ                                                     
         BZ    DISGX100                                                         
         LA    R3,LISTLENP                                                      
         TM    DISFLG3,D3LGRID                                                  
         BZ    DISGX100                                                         
         LA    R2,0(R3,R2)         LARGE GRID DROP DOWN ONE MORE LINE           
         MVI   0(R2),X'40'         SO THIS WILL PRINT AS ONE LINE               
                                                                                
*        LA    R3,LISTLENP*2       LARGE GRID DROP DOWN ONE MORE LINE           
*                                                                               
DISGX100 DS    0H                                                               
         NI    DISFLG3,FF-D3LGRID                                               
         LA    R2,0(R3,R2)                                                      
         ST    R2,DMCB                                                          
         B     EXIT                                                             
         DROP  R2                                                               
CHANGE   DC    C'CHANGE (+/-) OF DATES/SPOTS ='                                 
CHANGEQ  EQU   *-CHANGE                                                         
*                                                                               
***********************************************************************         
* DISPLAY MATCH LINES                                                           
* P1: A(DISPLAY LINE)                                                           
* P2: BYTE 1   - BUY TYPE (A/R)                                                 
*     BYTE 2-4 - A(BUY NUMBER)                                                  
***********************************************************************         
DISMATCH NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         LM    R2,R3,0(R1)                                                      
         USING DIFFSUM,R2                                                       
*                                                                               
         CLI   4(R1),C'R'                                                       
         BNE   DMTHX               ONLY DO THIS FOR REP LINES                   
*                                                                               
         GOTOR SRCHTABR,DMCB,(R3)                                               
         BNE   DMTHX                                                            
*                                                                               
         L     R4,DMCB                                                          
         USING MTCHTABD,R4                                                      
*                                                                               
         CLI   ABUY#,GRPTERM                                                    
         BE    DMTHX                                                            
*                                                                               
         LA    R6,MTCHTAB                                                       
         CR    R4,R6                                                            
         BE    DMTH0050                                                         
*                                                                               
         SHI   R4,MTCHTABL         IF THIS LINE IS PART OF A GROUP              
         CLI   ABUY#,GRPTERM       AND IT IS NOT THE FIRST LINE                 
         BL    DMTHX               DON'T DISPLAY IT                             
         LA    R4,MTCHTABL(R4)                                                  
*                                                                               
DMTH0050 DS    0H                                                               
         MVI   DSINPUT,C'M'                                                     
*                                                                               
         GOTOR DISBUY#,DMCB,ABUY#,(C'A',DSTYPA)                                 
*                                                                               
DMTHX    DS    0H                                                               
         B     EXIT                                                             
         DROP  R2                                                               
***********************************************************************         
* COMPARE LINE, SET FLAG, INSERT CONTROL CHARACTER                              
***********************************************************************         
COMPLINE NTR1  BASE=*,LABEL=*                                                   
         LM    R2,R4,0(R1)                                                      
BUYSEG   USING TLSTD,R3                                                         
BUYSEGR  USING TLSTD,COMPTSAR                                                   
         USING DIFFSUM,R2                                                       
*                                                                               
         CLI   DISFLG2,DMATCHQ     ARE WE DISPLAYING MATCH?                     
         BNE   CLINXX              NO, NO COMPARISON                            
*                                                                               
         XCEFL (R4),1000           R4=ELIO3=GRID COMPARISON AREA                
*                                                                               
         MVC   WORK2(L'TSARREC),TSARREC                                         
*                                                                               
         TM    BUYSEG.TLBYFLG4,X'44' GO RIGHT TO GRID COMPARISON                
         BZ    CLIN30                                                           
         MVC   COMPTSAR,0(R3)                                                   
         B     CLIN0200                                                         
*                                                                               
CLIN30   OC    COMPTSAR,COMPTSAR                                                
         BNZ   *+8                                                              
         OI    OVRDFLG,OVDALLQ                                                  
*                                                                               
         CLC   BUYSEG.TLBYDAY,BUYSEGR.TLBYDAY                                   
         BNE   CLIN35                                                           
*                                                                               
         LR    R0,R2                                                            
         LA    RE,LISTLENP                                                      
*                                                                               
         TM    FLAGS,FGPRTQ                                                     
         BO    *+8                                                              
         LA    RE,LISTLEN                                                       
*                                                                               
         LH    RF,ORBCTR                                                        
         MVC   DSDAY,=XL7'42424242424242' INSERT A CONTROL CHARACTER            
*                                  SO SQUASHER WILL CREATE COMMA                
         LA    R2,0(RE,R2)                                                      
         BCT   RF,*-10                                                          
         LR    R2,R0                                                            
*                                                                               
         B     CLIN37                                                           
*                                                                               
CLIN35   DS    0H                                                               
         OI    OVRDFLG,OVDAYQ                                                   
CLIN37   DS    0H                                                               
*                                                                               
         CLC   BUYSEG.TLBYTIME,BUYSEGR.TLBYTIME                                 
         BNE   CLIN40                                                           
*                                                                               
         LR    R0,R2               THIS IS FOR ORBIT DISPLAY                    
         LH    RF,ORBCTR                                                        
         LA    RE,LISTLENP                                                      
         TM    FLAGS,FGPRTQ                                                     
         BO    *+8                                                              
         LA    RE,LISTLEN                                                       
*                                                                               
         XC    DSTIME,DSTIME                                                    
         MVI   DSTIME,X'42'                                                     
         LA    R2,0(RE,R2)                                                      
         BCT   RF,*-14                                                          
         LR    R2,R0                                                            
*                                                                               
         B     CLIN42                                                           
*                                                                               
CLIN40   DS    0H                                                               
         OI    OVRDFLG,OVTIMEQ                                                  
CLIN42   DS    0H                                                               
*                                                                               
         CLC   BUYSEG.TLBYLEN,BUYSEGR.TLBYLEN                                   
         BNE   CLIN45                                                           
         XC    DSLEN,DSLEN                                                      
         MVI   DSLEN,X'42'                                                      
         B     CLIN47                                                           
*                                                                               
CLIN45   DS    0H                                                               
         OI    OVRDFLG,OVLENQ                                                   
CLIN47   DS    0H                                                               
*                                                                               
         CLC   BUYSEG.TLBYRATE,BUYSEGR.TLBYRATE                                 
         BNE   CLIN50                                                           
         XC    DSRATE,DSRATE                                                    
         MVI   DSRATE,X'42'                                                     
         B     CLIN52                                                           
*                                                                               
CLIN50   DS    0H                                                               
         OI    OVRDFLG,OVRATEQ                                                  
CLIN52   DS    0H                  PROGRAM NAME DOESN'T MATTER                  
*                                                                               
         CLC   BUYSEG.TLBYPROG,BUYSEGR.TLBYPROG                                 
         BNE   CLIN55              ALWAYS MATCH FOR DARE                        
         XC    DSPGM(MAXPGM),DSPGM                                              
         MVI   DSPGM,X'42'                                                      
         B     CLIN57                                                           
*                                                                               
CLIN55   DS    0H                                                               
         OI    OVRDFLG,OVPGMQ                                                   
*                                                                               
CLIN57   DS    0H                                                               
*                                                                               
         OC    BUYSEG.TLBYALNK,BUYSEG.TLBYALNK                                  
         BZ    CLIN0070            EXIT IF NULL                                 
         TM    BUYSEG.TLBYAFLG,X'40'  TLBYALNK IS A LINK POINTER?               
         BZ    CLIN0060            NO                                           
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TR.TLBLINDX,BUYSEG.TLBYALNK                                      
         MVI   TR.TLKTYP,C'A'                                                   
         GOTO1 GOTSAR,TSARDH       YES,READ BUYLINK RECORD                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   ELEM,TSARREC                                                     
TR3      USING TLSTD,ELEM                                                       
*                                                                               
         LA    R6,TR3.TLBLBUY#                                                  
         USING TLBLBUY#,R6                                                      
*                                                                               
CLIN0060 DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   HALF(1),BUYSEG.TLBYALNK                                          
         MVC   HALF+1(1),BUYSEG.TLBYASUB                                        
         TM    BUYSEG.TLBYAFLG,X'40'                                            
         BZ    *+16                                                             
         MVC   HALF,TLBLBUY#                                                    
         MVC   HALF+1(1),TLBLSUB#                                               
*                                                                               
         GOTOR SUMSPOT,DMCB,(C'A',HALF),(R4)                                    
         GOTOR SUMSPOT,DMCB,(C'A',HALF),(X'80',3*L'TSARREC(R4))                 
*                                                                               
CLIN0068 DS    0H                                                               
         TM    BUYSEG.TLBYAFLG,X'40'  ONLY ADD ONE TSAR RECORD                  
         BZ    CLIN0070               IF THIS IS NOT A BUY LINK                 
*                                                                               
         LA    R6,TLBLLENQ(R6)                                                  
         CLI   TLBLBUY#,0                                                       
         BNE   CLIN0060                                                         
CLIN0070 DS    0H                                                               
*                                                                               
CLIN0200 DS    0H                                                               
         OC    BUYSEGR.TLBYRLNK,BUYSEGR.TLBYRLNK                                
         BZ    CLIN0270                EXIT IF NULL                             
         TM    BUYSEGR.TLBYRFLG,X'40'  TLBYRLNK IS A LINK POINTER?              
         BZ    CLIN0260                                                         
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVC   TR.TLBLINDX,BUYSEGR.TLBYRLNK                                     
         MVI   TR.TLKTYP,C'R'                                                   
         GOTO1 GOTSAR,TSARDH       YES,READ BUYLINK RECORD                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   ELEM,TSARREC                                                     
*                                                                               
         LA    R6,TR3.TLBLBUY#                                                  
         USING TLBLBUY#,R6                                                      
*                                                                               
CLIN0260 DS    0H                                                               
         XC    TSARREC,TSARREC                                                  
         XC    HALF,HALF                                                        
         MVC   HALF(1),BUYSEGR.TLBYRLNK                                         
         TM    BUYSEGR.TLBYRFLG,X'40'                                           
         BZ    *+10                                                             
         MVC   HALF(1),TLBLBUY#                                                 
*                                                                               
         LR    RF,R4                                                            
         LA    RF,L'TSARREC(RF)                                                 
         GOTOR SUMSPOT,DMCB,(C'R',HALF),(RF)                                    
*                                                                               
         TM    BUYSEGR.TLBYRFLG,X'40'  ONLY ADD ONE TSAR RECORD                 
         BZ    CLIN0270            IF THIS IS NOT A BUY LINK                    
*                                                                               
         LA    R6,TLBLLENQ(R6)                                                  
         CLI   TLBLBUY#,0                                                       
         BNE   CLIN0260                                                         
CLIN0270 DS    0H                                                               
*                                                                               
CLIN0290 DS    0H                                                               
         TM    OVRDFLG,OVDALLQ                                                  
         BO    CLINX                                                            
*                                                                               
         LR    RE,R4               CALCULATE DIFFERENCE                         
*                                                                               
         TM    BUYSEG.TLBYFLG4,X'44'                                            
         BZ    CLIN0300            FAKE UP AGENCY GRID FOR CANCEL               
         XC    0(L'TSARREC,RE),0(RE)                                            
         MVC   0(TLGTOT-TLGSTD,RE),0(RF)                                        
*                                                                               
CLIN0300 LA    RF,L'TSARREC(RE)                                                 
*                                                                               
         LA    R6,L'TSARREC(RF)    IO FOR DIFFERENCE                            
*                                                                               
         XC    0(L'TSARREC,R6),0(R6)                                            
*                                                                               
         GOTOR GRIDDIFF,DMCB,(RE),(RF),(R6)                                     
         BNE   CLINX               NO DIFFERENCE,EXIT                           
         OI    OVRDFLG,OVDSPTQ                                                  
*                                                                               
CLINX    DS    0H                                                               
         MVC   TSARREC,WORK2                                                    
CLINXX   DS    0H                                                               
         B     EXIT                                                             
         DROP  R2                                                               
         DROP  R4                                                               
         DROP  R8                                                               
         DROP  TR3                                                              
         DROP  BUYSEG                                                           
         DROP  BUYSEGR                                                          
***********************************************************************         
* COMPUTE GRID DIFFERENCE (COMPGRID IS USED :( )                                
* FIRST SYNCHRONIZE THE START DATE, THEN DO COMPARISON                          
* INPUT                                                                         
* P1 = AGENCY  BUY GRID TSAR RECORD                                             
* P2 = REP     BUY GRID TSAR RECORD                                             
* P3 = A(OUTPUT)                                                                
* OUTPUT                                                                        
* CC EQUAL: GRID IS DIFFERENT                                                   
* CC NOT EQUAL: GRID IS THE SAME                                                
***********************************************************************         
GRIDDIFF NTR1  BASE=*,WORK=(R6,DLWORKQ),LABEL=*                                 
         LM    R2,R4,0(R1)                                                      
         USING DLWORKD,R6                                                       
*                                                                               
         XC    DLBYTE,DLBYTE                                                    
         MVC   DLWORK,0(R2)                                                     
         MVC   DLWORK2,0(R3)                                                    
*                                                                               
AGRID    USING TLGSTD,DLWORK       GRID 1(AGENCY GRID)                          
RGRID    USING TLGSTD,DLWORK2      GRID 2(REP GRID)                             
DGRID    USING TLGSTD,R4                                                        
*                                                                               
         CLC   AGRID.TLGSTD,RGRID.TLGSTD                                        
         BE    GDIF0500            IF SAME, NO NEED TO ADJUST                   
         BNH   GDIF0200                                                         
*                                                                               
         XC    DLWORK,DLWORK2      SWAP THE TWO AREA                            
         XC    DLWORK2,DLWORK                                                   
         XC    DLWORK,DLWORK2                                                   
         OI    DLBYTE,X'80'        MARK SWAP FLAG                               
*                                                                               
GDIF0200 DS    0H                                                               
         GOTOR MYPVAL,DMCB,AGRID.TLGSTD,RGRID.TLGSTD                            
         LH    R1,DMCB             NUMBER OF WEEK DIFFERENCE                    
         MHI   R1,TLGRSIZE                                                      
         LA    RE,RGRID.TLGRID     GRID START                                   
         AR    RE,R1               WEEK ADJUSTED                                
*                                                                               
         MVC   DLWORK3,RGRID.TLGRID                                             
         MVC   0(TLGRIDX-TLGRID,RE),DLWORK3                                     
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                CLEAR OUT STARTING AREA                      
         XC    RGRID.TLGRID(0),RGRID.TLGRID                                     
         MVC   RGRID.TLGSTD,AGRID.TLGSTD MOVE IN NEW START DATE                 
         MVC   RGRID.TLGRIDX,=X'FFFF'                                           
*                                                                               
         TM    DLBYTE,X'80'        SWAP?                                        
         BZ    GDIF0500            NO                                           
*                                                                               
         XC    DLWORK,DLWORK2      YE, SWAP BACK                                
         XC    DLWORK2,DLWORK                                                   
         XC    DLWORK,DLWORK2                                                   
         NI    DLBYTE,X'FF'-X'80'  MARK SWAP FLAG                               
*                                                                               
GDIF0500 DS    0H                                                               
         MVC   DGRID.TLGSTD,AGRID.TLGSTD                                        
         MVC   DGRID.TLGRIDX,=X'FFFF'                                           
         MVC   DGRID.TLGEND,AGRID.TLGEND                                        
         CLC   RGRID.TLGEND,AGRID.TLGEND                                        
         BNH   *+10                                                             
         MVC   DGRID.TLGEND,RGRID.TLGEND                                        
*                                                                               
         LA    RE,AGRID.TLGRID                                                  
         LA    RF,RGRID.TLGRID                                                  
         LA    R4,DGRID.TLGRID                                                  
         LA    R2,TLGRWKQ                                                       
*                                                                               
GDIF0520 DS    0H                                                               
         CLC   0(1,RE),0(RF)       AGY SPOT = REP SPOT?                         
         BNE   GDIF0530            NO, CALCULATE DIFFERENCE                     
*                                                                               
         CLI   0(RE),0                                                          
         BE    GDIF0550            THEY ARE BOTH ZERO - SKIP                    
*                                                                               
         OI    1(R4),X'01'         NOT ZERO - MARK NPW SO ZERO WILL BE          
         B     GDIF0550            DISPLAYED                                    
*                                                                               
GDIF0530 DS    0H                                                               
         OI    DLBYTE,X'40'                                                     
         SR    R0,R0               AGY SPOT                                     
         SR    R1,R1               REP SPOT                                     
         IC    R0,0(RE)                                                         
         IC    R1,0(RF)                                                         
         SR    R0,R1                                                            
         STC   R0,0(R4)            STORE DIFFERENCE IN SPOT                     
*                                                                               
GDIF0550 DS    0H                                                               
         LA    R4,TLGRSIZE(R4)                                                  
         LA    RE,TLGRSIZE(RE)                                                  
         LA    RF,TLGRSIZE(RF)                                                  
         BCT   R2,GDIF0520                                                      
*                                                                               
         TM    DLBYTE,X'40'                                                     
         BZ    GDIFNO                                                           
*                                                                               
GDIFYES  SR    RC,RC               GRID DIFFERS                                 
GDIFNO   LTR   RC,RC                                                            
GDIFX    DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
         DROP  R6                                                               
         DROP  DGRID                                                            
*---------------------------------------------------------------------*         
* CONVERT DAY TO MTWTFSS FORMAT                                       *         
*        R2    PARAMETER 1       A(ONE-BYTE DAYS OF WEEK)X'40' - MON  *         
*        R3    PARAMETER 2       A(ONE-BYTE DAYS OF WEEK)X'40' - MON  *         
*---------------------------------------------------------------------*         
OUTDAY1  NTR1  BASE=*,LABEL=*                                                   
         LA    R4,ODAYSQ           LOOP COUNTER                                 
         LM    R2,R3,0(R1)                                                      
         LR    R6,R2                                                            
         ZIC   R2,0(R6)                                                         
         MVC   0(ODAYSQ,R3),ODAYS                                               
OLOOP    DS    0H                                                               
         SLL   R2,1                                                             
         XC    BYTE,BYTE                                                        
         STC   R2,BYTE                                                          
         TM    BYTE,X'80'                                                       
         BO    *+8                                                              
         MVI   0(R3),C'.'                                                       
         LA    R3,1(R3)                                                         
         BCT   R4,OLOOP                                                         
ODEXT    XMOD1 1                                                                
ODAYS    DS    0C                                                               
         DC    CL1'M'                                                           
         DC    CL1'T'                                                           
         DC    CL1'W'                                                           
         DC    CL1'T'                                                           
         DC    CL1'F'                                                           
         DC    CL1'S'                                                           
         DC    CL1'S'                                                           
ODAYSQ   EQU   *-ODAYS                                                          
         SPACE 3                                                                
*                                                                               
***********************************************************************         
* RE-FORMAT A DISPLAY LINE FOR SQUEEZE FORMAT                         *         
*              PARAMETER 1       A(DISPLAY LINE)                      *         
***********************************************************************         
FMATLINE NTR1  BASE=*,LABEL=*                                                   
         TM    FLAGS2,FG2EXPD      EXPAND FORMAT?                               
         BO    FMATLX              YES, EXIT                                    
         L     R2,0(R1)                                                         
         USING DIFFSUM,R2                                                       
         LR    R4,R2                                                            
*                                                                               
*******                                                                         
* COLOR                                                                         
*******                                                                         
         MVI   DSCOLOR,C' '                                                     
         TM    STEREOFG,STFINUSE                                                
         BZ    FMATL20                                                          
*                                                                               
         MVI   DSCOLOR,REPCOLOR                                                 
         CLI   MYBUYTYP,C'R'                                                    
         BE    *+8                                                              
         MVI   DSCOLOR,AGYCOLOR                                                 
*                                                                               
FMATL20  DS    0H                                                               
         GOTO1 SQUASHER,DMCB,DSBUY,(C',',DSBUYQ)                                
*                                                                               
         OC    DSPGM,DSPGM         APPEND PROGRAM NAME                          
         BZ    FMATL50             IF SPACES, EXIT                              
         CLC   DSPGM,=C'     '                                                  
         BE    FMATL50                                                          
*                                                                               
         LA    R3,DSPGM-1                                                       
         CLI   0(R3),X'40'                                                      
         BH    *+8                                                              
         BCT   R3,*-8                                                           
*                                                                               
         MVI   1(R3),C','                                                       
         MVC   2(MAXPGM,R3),DSPGM                                               
         XC    DSPGM(MAXPGM),DSPGM                                              
*                                                                               
FMATL50  DS    0H                                                               
*                                                                               
         LA    R3,DSPGM-1                                                       
FMATL60  DS    0H                                                               
         CLI   0(R3),X'40'                                                      
         BH    *+8                                                              
         BCT   R3,*-8                                                           
         CLI   0(R3),C','          CLEAN UP COMMA AND CONTROL CHARACTER         
         BE    FMATL80                                                          
         CLI   0(R3),X'42'                                                      
         BNE   FMATL100                                                         
FMATL80  DS    0H                                                               
         MVI   0(R3),C' '                                                       
         BCT   R3,FMATL60                                                       
*                                                                               
FMATL100 DS    0H                                                               
         LA    R3,DSPGM-1                                                       
         CLI   0(R3),X'40'                                                      
         BH    *+8                                                              
         BCT   R3,*-8              R3->LAST PRINTABLE CHARACTER ON LINE         
*                                                                               
         LA    R6,DSTYPR+SQZBUYQ   MAX ALLOWABLE OUTPUT FOR SQUEEZE             
         CR    R3,R6                                                            
         BNH   FMATLX              OK!                                          
*                                                                               
         XC    1(DSBUYLQ-SQZBUYQ,R6),1(R6)                                      
         CLI   0(R6),C'*'                                                       
         BE    *+8                                                              
         MVI   0(R6),C'+'          TRUNCATE AND PUT A + AT THE END              
*                                                                               
FMATLX   DS    0H                                                               
         B     EXIT                                                             
         DROP  R2                                                               
***********************************************************************         
* GET TOTALS REP AND AGY SPOTS FOR THIS BUY SEGMENT                             
***********************************************************************         
GETTSPTS NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   GTSSVREC,TSARREC    SAVE OFF CURRENT TSAR RECORD                 
         MVC   GTSSVTR#,TXNUM       AND TSAR RECORD NUMBER                      
*                                                                               
BUYSEG   USING TLSTD,GTSSVREC                                                   
*                                                                               
         MVC   TOTREPSP,BUYSEG.TLBYRLNK+1                                       
         MVC   TOTAGYSP,BUYSEG.TLBYALNK+1                                       
         MVC   REPSPWK,BUYSEG.TLBYRLNK+1                                        
         MVC   AGYSPWK,BUYSEG.TLBYALNK+1                                        
*                                                                               
         TM    BUYSEG.TLBYRFLG,X'40' REP BUY LINK?                              
         BZ    GETSP10                                                          
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,C'R'                                                   
         MVC   TR.TLBLINDX,BUYSEG.TLBYRLNK                                      
         GOTO1 GOTSAR,TSARDH       RETRIEVE BUY LINK RECORD                     
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   TOTREPSP,TR.TLBLTSPT                                             
         MVC   REPSPWK,TR.TLBL#SPT                                              
*                                                                               
GETSP10  DS    0H                                                               
         TM    BUYSEG.TLBYAFLG,X'40' AGY BUY LINK?                              
         BZ    GETSPX                                                           
*                                                                               
* NOW SURE HOW THIS IS POSSIBLE TO HAVE BUY LINK FLAGGED BUT NO                 
* ACTUALLY LINK INFO, EXIT FOR NOW                                              
*                                                                               
         OC    BUYSEG.TLBYALNK,BUYSEG.TLBYALNK                                  
         BZ    GETSPX                                                           
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,C'A'                                                   
         MVC   TR.TLBLINDX,BUYSEG.TLBYALNK                                      
         GOTO1 GOTSAR,TSARDH       RETRIEVE BUY LINK RECORD                     
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   TOTAGYSP,TR.TLBLTSPT                                             
         MVC   AGYSPWK,TR.TLBL#SPT                                              
*                                                                               
GETSPX   DS    0H                                                               
         MVC   TXNUM,GTSSVTR#      RESTORE SEQUENCE                             
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         B     EXIT                                                             
         DROP  BUYSEG                                                           
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* DUMP CONTENTS OF TSAR BUFFER TO REPORT                                        
***********************************************************************         
DUMPTSAR NTR1  BASE=*,WORK=(R4,DLWORKQ),LABEL=*                                 
*                                                                               
         USING DLWORKD,R4                                                       
         MVC   DLWORK,TSARREC                                                   
         L     R8,ASPOOLD                                                       
         USING SPOOLD,R8                                                        
*                                                                               
         OI    GENSTAT3,NOCLRSPK                                                
         MVC   REMUSER,=C'HQI'     DARE AGENCY ORDER                            
*                                                                               
         LA    RF,SPOOLKEY                                                      
         USING PQPLD,RF                                                         
         XC    SPOOLKEY,SPOOLKEY                                                
         MVC   PLDESC,=C'TSAR BUFFER'                                           
         MVI   PLCLASS,C' '                                                     
         OI    SPOOLIND,SPUINIT    PERMITS SETTING OF CLASS                     
         MVC   PLSUBID,=C'HQI'     DARE AGENCY ORDER                            
         DROP  RF                                                               
*                                                                               
         LA    RE,SPLKEYAD                                                      
         ST    RE,SPOOLQLK         SET EXTENDED KEY ADDRESS                     
         USING PQPLD,RE                                                         
         XC    0(133,RE),0(RE)                                                  
         MVI   QLEXTRA,X'FF'                                                    
         MVC   QLRETNL,=H'6'                                                    
         MVC   QLRETND,=H'2'                                                    
         MVC   QLRETNL,=H'36'                                                   
         MVI   QLSYS,C'R'          FORM/COPIES COLUMN                           
         MVC   QLPRG,=C'CO'                                                     
         DROP  RE                                                               
                                                                                
         GOTO1 OPENPQ                                                           
*                                                                               
         MVC   P(19),=C'*** TSAR BUFFER ***'                                    
         BAS   RE,PRINT                                                         
*                                                                               
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSARDH                                                    
*                                                                               
DT10     DS    0H                                                               
         MVC   P(132),TSARREC                                                   
         BAS   RE,PRINT                                                         
         GOTO1 HEXOUT,DMCB,TB.TSRNUM,P,2                                        
         GOTO1 HEXOUT,DMCB,TR.TLLEN,P+6,2                                       
         GOTO1 HEXOUT,DMCB,TR.TLKEY,P+12,50                                     
         BAS   RE,PRINT                                                         
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSANXT                                                    
         BE    DT10                                                             
*                                                                               
         GOTO1 HEXOUT,DMCB,KEY,P,27                                             
         BAS   RE,PRINT                                                         
*                                                                               
         LA    R6,MTCHTAB          PRINT MATCH TABLE                            
         LA    R2,L'MTCHTAB(R6)                                                 
DT15     DS    0H                                                               
         CR    R2,R6                                                            
         BNH   DT15X                                                            
         GOTO1 HEXOUT,DMCB,(R6),P,80                                            
         BAS   RE,PRINT                                                         
         LA    R6,40(R6)                                                        
         B     DT15                                                             
DT15X    DS    0H                                                               
*                                                                               
         L     R6,ABUYTAB          PRINT BUY TABLE                              
         LA    R2,L'BUYTAB(R6)                                                  
DT16     DS    0H                                                               
         CR    R2,R6                                                            
         BNH   DT16X                                                            
         GOTO1 HEXOUT,DMCB,(R6),P,80                                            
         BAS   RE,PRINT                                                         
         LA    R6,40(R6)                                                        
         B     DT16                                                             
DT16X    DS    0H                                                               
*                                                                               
         LA    R6,AGYBTAB          PRINT AGENCY BUY TABLE                       
         LA    R2,L'AGYBTAB(R6)                                                 
DT17     DS    0H                                                               
         CR    R2,R6                                                            
         BNH   DT17X                                                            
         GOTO1 HEXOUT,DMCB,(R6),P,40                                            
         BAS   RE,PRINT                                                         
         LA    R6,40(R6)                                                        
         B     DT17                                                             
DT17X    DS    0H                                                               
         EDIT  TABCT,(8,P),ZERO=NOBLANK                                         
         BAS   RE,PRINT                                                         
         B     DTX                                                              
*                                                                               
DT20     DS    0H                                                               
         EDIT  SCRNUM,(3,P),ZERO=NOBLANK                                        
         EDIT  AEOTBLE,(8,P+4),ZERO=NOBLANK                                     
         BAS   RE,PRINT                                                         
DT20X    DS    0H                                                               
DTX      DS    0H                                                               
         MVC   TSARREC,DLWORK                                                   
         GOTO1 GOTSAR,TSARDH                                                    
         MVI   SPMODE,X'FF'                                                     
         BAS   RE,PRINT            CLOSE PRINT QUEUE                            
                                                                                
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* CALCULATE GRAND TOTAL DOLLARS AND SPOTS. TAKE INTO ACCOUNT POSSIBLE           
* TAKEOVER ORDER                                                                
***********************************************************************         
DISTOTAL NTR1  BASE=*,LABEL=*                                                   
*&&DO                                                                           
         XC    GTOTAL$,GTOTAL$                                                  
         XC    GSPT#,GSPT#                                                      
         OI    FLAGS,FGTOTALQ      SKIP BUY DETAIL BREAK OUT PROCESSING         
*                                                                               
         MVC   AIO,AIO1                                                         
         XC    KEY,KEY                                                          
         MVC   KEY(RDARKRT-RDARKEY),SELECTKY                                    
*                                                                               
         MVI   KEY+RDARKRT-RDARKEY,X'40' BUY RECORD                             
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
DIST10   DS    0H                                                               
         CLC   KEY(RDARKSEQ-RDARKEY),KEYSAVE                                    
         BNE   DIST70                                                           
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         CLI   KEY+RDARKSRT-RDARKEY,X'00' BUY HEADER                            
         BE    DIST20                                                           
         CLI   KEY+RDARKSRT-RDARKEY,X'10' BUY ORBITS                            
         BE    DIST30                                                           
         CLI   KEY+RDARKSRT-RDARKEY,X'30' BUY DETAIL                            
         BE    DIST40                                                           
         B     DIST60                                                           
*                                                                               
* PROCESS HEADER RECORD                                                         
*                                                                               
DIST20   DS    0H                                                               
         L     R6,AIO                                                           
         USING RDARBYEL,R6                                                      
         MVI   ELCODE,X'01'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         TM    RDARBYDL,X'80'+X'40' HARD/SOFT DELETED??                         
         BNZ   DIST60              SKIP                                         
         MVC   BUYCOST,RDARBYCO                                                 
         MVI   STARTDAY,0          CLEAR START/END DAYS OF WEEK                 
         MVI   ENDDAY,0                                                         
         GOTOR STARTEND,DMCB,RDARBYRO,WORK                                      
         B     DIST60                                                           
         DROP  R6                                                               
*                                                                               
DIST30   DS    0H                                                               
         L     R6,AIO                                                           
         USING RDAROBEL,R6                                                      
         MVI   ELCODE,X'01'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         TM    RDAROBDL,X'80'+X'40' HARD/SOFT DELETED??                         
         BNZ   DIST60              SKIP                                         
         DROP  R6                                                               
*                                                                               
         GOTOR BUYORBIT,DMCB,AIO                                                
         B     DIST60              READ NEXT                                    
*                                                                               
DIST40   DS    0H                                                               
         L     R6,AIO                                                           
         USING RDARBDEL,R6                                                      
         MVI   ELCODE,X'01'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         TM    RDARBDDL,X'80'+X'40' HARD/SOFT DELETED??                         
         BNZ   DIST60              SKIP                                         
         DROP  R6                                                               
*                                                                               
         GOTOR BUYDETL,DMCB,AIO                                                 
         BNE   DIST60              READ NEXT                                    
*                                                                               
         L     R6,AIO                                                           
         USING RDARBUEL,R6                                                      
         MVI   ELCODE,X'02'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
DIST50   DS    0H                                                               
         ZIC   R1,RDARBUWK                                                      
         XC    HALF,HALF                                                        
         MVC   HALF+1(1),RDARBUSW                                               
         MH    R1,HALF                                                          
         ZICM  R0,GSPT#,4                                                       
         AR    R0,R1                                                            
         STCM  R0,15,GSPT#                                                      
         MVC   FULL,RDARBU$$                                                    
         M     R0,FULL                                                          
         ZICM  R0,GTOTAL$,4                                                     
         AR    R0,R1                                                            
         STCM  R0,15,GTOTAL$                                                    
*                                                                               
         BRAS  RE,NEXTEL                                                        
         BE    DIST50                                                           
         DROP  R6                                                               
*                                                                               
DIST60   DS    0H                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
         B     DIST10                                                           
*&&                                                                             
DIST70   DS    0H                  DISPLAY GRAND TOTAL DOLLAR/SPOT              
         EDIT  GTOTAL$,DIFATOT,2,COMMAS=YES,FLOAT=$,ZERO=NOBLANK                
         EDIT  GSPT#,DIFASPT,ZERO=NOBLANK                                       
*                                                                               
* DISPLAY CONTRACT TOTALS AS WELL                                               
*                                                                               
         EDIT  RPORDTOT,DIFCTOT,2,COMMAS=YES,FLOAT=$,ZERO=NOBLANK               
         EDIT  RPSPTTOT,DIFCSPT,ZERO=NOBLANK                                    
*                                                                               
* DISPLAY (AGENCY - CONTRACT) TOTALS                                            
*                                                                               
         ICM   R3,15,GTOTAL$                                                    
         ICM   R4,15,RPORDTOT                                                   
         SR    R3,R4                                                            
         EDIT  (R3),DIFDTOT,2,COMMAS=YES,FLOAT=$,ZERO=NOBLANK                   
*                                                                               
         CLC   GTOTAL$,RPORDTOT                                                 
         BE    DIST100             SHOW SIGN                                    
         LA    RE,DIFDTOT                                                       
         LA    RF,L'DIFDTOT                                                     
DIST80   CLI   0(RE),C'$'                                                       
         BE    DIST90                                                           
         AHI   RE,1                                                             
         BCT   RF,DIST80                                                        
         B     DIST100                                                          
*                                                                               
DIST90   DS    0H                                                               
         SHI   RE,1                                                             
         MVI   0(RE),C'-'                                                       
         CLC   GTOTAL$,RPORDTOT                                                 
         BL    DIST100             SHOW SIGN                                    
         MVI   0(RE),C'+'                                                       
*                                                                               
DIST100  DS    0H                                                               
         ICM   R3,15,GSPT#                                                      
         ZICM  R4,RPSPTTOT,2                                                    
         SR    R3,R4                                                            
         BNP   DIST110                                                          
         EDIT  (R3),DIFDSPT,ZERO=NOBLANK,FLOAT=+                                
         B     DIST120                                                          
*                                                                               
DIST110  DS    0H                                                               
         EDIT  (R3),DIFDSPT,ZERO=NOBLANK,FLOAT=-                                
*                                                                               
DIST120  DS    0H                                                               
*                                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* SWAP TO CONTRACT                                                              
***********************************************************************         
SWAP2CON NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   KEY(L'SELECTKY),SELECTKY                                         
         GOTO1 HIGH                                                             
         GOTO1 GETREC                                                           
*                                                                               
         XC    BLOCK(256),BLOCK                                                 
         LA    R1,BLOCK                                                         
         USING GLVXFRSY,R1                                                      
         MVC   GLVXFRSY,=C'REP'    FROM THE REP SYSTEM                          
         MVC   GLVXFRPR,=C'DAR'    DARE PROGRAM                                 
         MVC   GLVXTOSY,=C'REP'    TO THE REP SYSTEM                            
         MVC   GLVXTOPR,=C'CON'    CONTRACT PROGRAM                             
***>>>   OI    GLVXFLG1,GLV1GOTO+GLV1SEPS   CALL BASE ON TRANSFER               
         OI    GLVXFLG1,GLV1SEPS   CALL BASE ON TRANSFER                        
         DROP  R1                                                               
*                                  SET UP THE TRANSFER CONTROL BLOCK            
         L     R4,ACOMFACS                                                      
         USING COMFACSD,R4                                                      
*                                                                               
         GOTO1 CGLOBBER,DMCB,=C'PUTD',BLOCK,14,GLVXCTL                          
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
         MVC   FULL,RDARREP#                                                    
         OC    RDARREP#,RDARREP#                                                
         BNZ   *+10                                                             
         MVC   FULL,CCONKNUM                                                    
         DROP  R6                                                               
*                                                                               
         LA    R2,DIFHDLNH         ANY CONTRACT NUMBER?                         
         GOTO1 CGLOBBER,DMCB,=C'PUTD',FULL,L'FULL,GLRCONNO                      
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTO1 CGLOBBER,DMCB,=C'PUTD',=CL1'D',1,GLRPFKEY                        
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         DROP  R4                                                               
*                                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* GET DISPLAY OPTION: MATCH/UNMATCH/PROPOSED/BOTH                               
***********************************************************************         
GETDOPT  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   MYSCRNUM,X'EB'                                                   
         BNE   GETDX                                                            
         TM    DIFMOPTH+4,X'C0'    IF OPTION IS CHANGED.                        
         BNO   *+10                                                             
         XC    LISTLAST,LISTLAST   REDISPLAY FROM START                         
*                                                                               
         OI    OFLAG1,OUMATCHQ+OMATCHQ+OPMATCHQ+OSPTDIFQ+OASSUMEQ               
*                                                                               
         LA    R2,DIFMOPTH                                                      
*        TM    5(R2),X'04'         VALID ALPHABETIC?                            
*        BNO   INVLOPT                                                          
         LA    R3,DIFMOPT+L'DIFMOPT-1                                           
         LA    R4,DIFMOPT                                                       
*                                                                               
GETD0010 DS    0H                                                               
         CR    R4,R3                                                            
         BH    GETD0040                                                         
         CLI   0(R3),C'M'                                                       
         BE    GETD0030                                                         
         CLI   0(R3),C'P'                                                       
         BE    GETD0030                                                         
         CLI   0(R3),C'U'                                                       
         BE    GETD0030                                                         
         CLI   0(R3),C'C'                                                       
         BE    GETD0030                                                         
         CLI   0(R3),C'X'                                                       
         BE    GETD0030                                                         
         CLI   0(R3),0                                                          
         BE    GETD0030                                                         
         CLI   0(R3),C' '                                                       
         BNE   INVLOPT                                                          
*                                                                               
GETD0030 DS    0H                                                               
         BCT   R3,GETD0010                                                      
GETD0040 DS    0H                                                               
*                                                                               
         LA    R3,DIFMOPT+L'DIFMOPT-1                                           
GETD0050 DS    0H                  THERE ISN'T MATCH OPTION                     
         CR    R4,R3                                                            
         BH    GETD0060                                                         
         CLI   0(R3),C'M'                                                       
         BE    GETD0090                                                         
         BCT   R3,GETD0050                                                      
GETD0060 DS    0H                                                               
         NI    OFLAG1,X'FF'-OMATCHQ                                             
GETD0090 DS    0H                                                               
*                                                                               
         LA    R3,DIFMOPT+L'DIFMOPT-1                                           
GETD0110 DS    0H                                                               
         CR    R4,R3                                                            
         BH    GETD0130                                                         
         CLI   0(R3),C'P'                                                       
         BE    GETD0150                                                         
         BCT   R3,GETD0110                                                      
GETD0130 DS    0H                  THERE ISN'T P MATCH OPTION                   
         NI    OFLAG1,X'FF'-OPMATCHQ                                            
GETD0150 DS    0H                                                               
*                                                                               
         LA    R3,DIFMOPT+L'DIFMOPT-1                                           
GETD0210 DS    0H                  THERE ISN'T MATCH OPTION                     
         CR    R4,R3                                                            
         BH    GETD0230                                                         
         CLI   0(R3),C'U'                                                       
         BE    GETD0250                                                         
         BCT   R3,GETD0210                                                      
GETD0230 DS    0H                  THERE ISN'T MATCH OPTION                     
         NI    OFLAG1,X'FF'-OUMATCHQ                                            
GETD0250 DS    0H                                                               
*                                                                               
         LA    R3,DIFMOPT+L'DIFMOPT-1                                           
GETD0310 DS    0H                  THERE ISN'T MATCH OPTION                     
         CR    R4,R3                                                            
         BH    GETD0330                                                         
         CLI   0(R3),C'C'                                                       
         BE    GETD0350                                                         
         BCT   R3,GETD0310                                                      
GETD0330 DS    0H                  THERE ISN'T MATCH OPTION                     
         NI    OFLAG1,X'FF'-OSPTDIFQ                                            
GETD0350 DS    0H                                                               
*                                                                               
         LA    R3,DIFMOPT+L'DIFMOPT-1                                           
GETD0370 DS    0H                  THERE ISN'T MATCH OPTION                     
         CR    R4,R3                                                            
         BH    GETD0390                                                         
         CLI   0(R3),C'X'                                                       
         BE    GETD0400                                                         
         BCT   R3,GETD0370                                                      
GETD0390 DS    0H                  THERE ISN'T MATCH OPTION                     
         NI    OFLAG1,X'FF'-OASSUMEQ                                            
GETD0400 DS    0H                                                               
*                                                                               
         TM    OFLAG1,OUMATCHQ+OMATCHQ+OPMATCHQ+OSPTDIFQ+OASSUMEQ               
         BNZ   GETD0450            RESTORE DEFAULT IF NONE IS ENTER             
         OI    OFLAG1,OUMATCHQ+OMATCHQ+OPMATCHQ                                 
         MVC   DIFMOPT(3),=C'MPU'                                               
         TM    CFLAG,CSPDIFQ       SHOW SPOT DIFFERENCE +/-?                    
         BZ    *+8                                                              
         MVI   DIFMOPT+3,C'C'      YES                                          
*                                                                               
GETD0450 DS    0H                                                               
*                                                                               
GETDX    DS    0H                                                               
*                                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
       ++INCLUDE REDARDIF                                                       
T80F24   CSECT                                                                  
***********************************************************************         
* INCASE OF ADDING DAILY BUYS, THERE MIGHT BE MULTIPLE BUYS WITH                
* THE SAME RBUYKMLN(AGENCY) BUY NUMBER. WE NEED TO CHECK EACH OF THESE          
* BUYS TO FIND THE ONE THAT MATCH THE CURRENT BUY SEGMENT TO BE ADDED           
***********************************************************************         
CHKDAILY NTR1  BASE=*,LABEL=*                                                   
*                                                                               
BUYSEG   USING TLSTD,APSVREC                                                    
*                                                                               
         L     R6,AIO2                                                          
         MVI   ELCODE,X'03'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING RBUYDTEL,R6                                                      
*                                                                               
         GOTO1 DATCON,DMCB,(2,BUYSEG.TLBYWKOF),(3,WORK)                         
         CLC   RBUYDTST,WORK       MUST BE DAILY!!                              
         BNE   CHKDYNO                                                          
         CLC   RBUYDTED,WORK                                                    
         BNE   CHKDYNO                                                          
*                                                                               
CHKDYYES SR    RC,RC                                                            
CHKDYNO  LTR   RC,RC                                                            
         XIT1                                                                   
         DROP  BUYSEG,R6                                                        
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
***********************************************************************         
*  CHECK TO SEE IF THIS REP BUY LINE IS CREATED OUT OF DAILY/COST OVER          
*  RIDE AND IF IT IS STILL LINK TO AN DAILY/COST OVERRIDE                       
***********************************************************************         
VALDAILY NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    BYTE,BYTE                                                        
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,X'0E'                                                  
         MVI   TR.TLBPTYP,C'R'                                                  
         MVC   TR.TLBPBUY#,REP#                                                 
         GOTO1 GOTSAR,TSARDH                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   BYTE,TR.TLBPMLNK                                                 
*                                                                               
         XC    TSARREC,TSARREC     CHECK TO SEE IF AGENCY LINE                  
         MVI   TR.TLKTYP,X'0E'     AND REP LINE BELONG TO THE SAME              
         MVI   TR.TLBPTYP,C'A'     SEGMENT                                      
         MVC   TR.TLBPBUY#,AGY#                                                 
         GOTO1 GOTSAR,TSARDH                                                    
         BNE   ERNOLINE                                                         
*                                                                               
         CLC   BYTE,TR.TLBPMLNK                                                 
         BNE   VDLYNO                                                           
*                                                                               
*                                                                               
VDLYES   SR    RC,RC                                                            
VDLYNO   LTR   RC,RC                                                            
         XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* ADD/REMOVE SPOTS FROM GRID                                                    
* RETURNS # OF SPOTS BEFORE CHANGE                                              
***********************************************************************         
ADJSPTS  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   MYWRK(1),0(R1)                                                   
         LA    R2,BUYGRID          RESET TO START OF GRID                       
         XC    ELEM,ELEM                                                        
         XC    WORK2,WORK2                                                      
         GOTO1 DATCON,DMCB,(3,GSTRDATE),(5,ELEM)                                
         GOTO1 DATCON,DMCB,(3,BSTRDATE),(5,ELEM+9)                              
         MVI   ELEM+8,C'-'                                                      
         GOTO1 PERVAL,DMCB,(17,ELEM),WORK2                                      
         CLI   DMCB+4,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
WKD      USING PERVALD,WORK2                                                    
         ZICM  R1,WKD.PVALNWKS,2   # WEEKS ROUNDED UP                           
         BCTR  R1,0                ADJUST FOR ROUNDING                          
         DROP  WKD                                                              
*                                                                               
         SLL   R1,1                MULTIPLY BY 2                                
         AR    R2,R1               BUMP TO STARTING CELL FOR THIS DATE          
*                                                                               
         MVC   DMCB(1),0(R2)       RETURN # SPOT BEFORE CHANGE                  
*                                                                               
         CLI   MYWRK,C'-'          ADDING TO GRID?                              
         BE    ASPT10                                                           
         ZIC   RF,BMSS#SPT                                                      
         ZIC   RE,0(R2)                                                         
         AR    RE,RF                                                            
         STC   RE,0(R2)                                                         
         B     ASPTSYES                                                         
*                                                                               
ASPT10   DS    0H                  REMOVING FROM GRID                           
         CLC   BMSS#SPT,0(R2)      SPTS MUST BE AVAILABLE TO BE REMOVED         
         BH    ASPTSNO                                                          
         ZIC   RF,BMSS#SPT                                                      
         ZIC   RE,0(R2)                                                         
         SR    RE,RF                                                            
         STC   RE,0(R2)                                                         
         OI    1(R2),X'01'         SET NPW OVERRIDE INCASE NO MORE SPOT         
*                                                                               
ASPTSYES SR    RC,RC                                                            
ASPTSNO  LTR   RC,RC                                                            
         XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* BUILD SPOT CHANGED COMMENT                                                    
***********************************************************************         
SPCHGCMT NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         ZIC   R3,DMCB                                                          
         OC    CMTSTRDT,CMTSTRDT                                                
         BNZ   SPCMT05                                                          
         MVC   CMTSTRDT,BSTRDATE                                                
         MVC   CMTENDDT,CMTSTRDT                                                
         MVI   CMTNUMWK,1                                                       
         STC   R3,CMTNUMSP                                                      
         B     SPCMTX                                                           
*                                                                               
SPCMT05  DS    0H                                                               
         ZIC   RE,CMTNUMSP                                                      
         CR    R3,RE                                                            
         BNE   SPCMT08                                                          
*                                                                               
         GOTO1 DATCON,DMCB,(3,CMTENDDT),(0,WORK)                                
         LA    RF,7                                                             
         GOTO1 ADDAY,DMCB,WORK,WORK+6,(RF)                                      
         GOTO1 DATCON,DMCB,(3,BSTRDATE),(0,WORK)                                
         CLC   WORK(6),WORK+6                                                   
         BNE   SPCMT08                                                          
         MVC   CMTENDDT,BSTRDATE                                                
         ZIC   RE,CMTNUMWK                                                      
         AHI   RE,1                                                             
         STC   RE,CMTNUMWK                                                      
         B     SPCMTX                                                           
*                                                                               
SPCMT08  DS    0H                                                               
         LA    R2,MYELEM                                                        
         LA    R1,120              MAX 2 ORD COMMENTS                           
*                                                                               
SPCMT10  DS    0H                                                               
         CLI   0(R2),0                                                          
         BE    SPCMT20                                                          
         AHI   R2,1                                                             
         BCT   R1,SPCMT10                                                       
         B     SPCMTX                                                           
*                                                                               
SPCMT20  DS    0H                                                               
         GOTO1 DATCON,DMCB,(3,CMTSTRDT),(4,(R2))                                
         AHI   R2,5                                                             
         CLI   CMTNUMWK,1                                                       
         BNH   SPCMT30                                                          
         MVI   0(R2),C'-'                                                       
         AHI   R2,1                                                             
         EDIT  CMTNUMWK,(3,0(R2)),ALIGN=LEFT                                    
         AR    R2,R0                                                            
         MVC   0(3,R2),=C'WKS'                                                  
         AHI   R2,3                                                             
*                                                                               
SPCMT30  DS    0H                                                               
         MVC   0(11,R2),=C' #SPTS WAS '                                         
         AHI   R2,11                                                            
*                                                                               
         EDIT  CMTNUMSP,(3,0(R2)),ALIGN=LEFT,ZERO=NOBLANK                       
         AR    R2,R0                                                            
         MVI   0(R2),C','                                                       
         AHI   R2,1                                                             
*                                                                               
         MVC   CMTSTRDT,BSTRDATE                                                
         MVC   CMTENDDT,CMTSTRDT                                                
         MVI   CMTNUMWK,1                                                       
         STC   R3,CMTNUMSP                                                      
*                                                                               
SPCMTX   DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* ADD SPOT CHANGED COMMENT                                                      
***********************************************************************         
ADORDCMT NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         OC    CMTSTRDT,CMTSTRDT                                                
         BZ    ORDCMTX                                                          
*                                                                               
         XC    MYELEM,MYELEM                                                    
*                                                                               
         L     R6,AIO2             CHAIN AND SAVE OFF CURRENT COMMENTS          
         MVI   ELCODE,X'84'                                                     
         BRAS  RE,GETEL                                                         
         BNE   ADOC20                                                           
         ZIC   RF,1(R6)                                                         
         SHI   RF,4                OVERHEAD + EXECUTED MOVE                     
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   MYELEM(0),3(R6)                                                  
         LA    R4,MYELEM                                                        
         LA    R4,1(R4,RF)                                                      
*                                                                               
         BRAS  RE,NEXTEL                                                        
         BNE   ADOC05                                                           
         ZIC   RF,1(R6)                                                         
         SHI   RF,4                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),0(R6)                                                    
         LA    R4,1(R4,RF)                                                      
*                                                                               
ADOC05   DS    0H                                                               
         MVI   0(R4),C','                                                       
         AHI   R4,1                                                             
*                                                                               
* REPLACE EXISTING BUY ORDER COMMENT                                            
ADOC10   DS    0H                                                               
         GOTO1 HELLO,DMCB,(C'D',=C'REPFILE'),(X'84',AIO2),0,0                   
*                                                                               
ADOC20   DS    0H                                                               
         LA    R2,MYELEM                                                        
         LA    R1,120              MAX 2 ORD COMMENTS                           
*                                                                               
ADOC30   DS    0H                                                               
         CLI   0(R2),0                                                          
         BE    ADOC40                                                           
         AHI   R2,1                                                             
         BCT   R1,ADOC30                                                        
         B     ORDCMTX                                                          
*                                                                               
ADOC40   DS    0H                                                               
         GOTO1 DATCON,DMCB,(3,CMTSTRDT),(4,(R2))                                
         AHI   R2,5                                                             
         CLI   CMTNUMWK,1                                                       
         BNH   ADOC50                                                           
         MVI   0(R2),C'-'                                                       
         AHI   R2,1                                                             
         EDIT  CMTNUMWK,(3,0(R2)),ALIGN=LEFT                                    
         AR    R2,R0                                                            
         MVC   0(3,R2),=C'WKS'                                                  
         AHI   R2,3                                                             
*                                                                               
ADOC50   DS    0H                                                               
         MVC   0(11,R2),=C' #SPTS WAS '                                         
         AHI   R2,11                                                            
*                                                                               
         EDIT  CMTNUMSP,(3,0(R2)),ALIGN=LEFT,ZERO=NOBLANK                       
*                                  BUILD AND ADD CHANGE BUY ORD CMTS            
         XC    ELTBUILD,ELTBUILD                                                
         MVC   ELTBUILD+3(60),MYELEM                                            
ADOC60   LA    R1,60                                                            
         LA    R2,ELTBUILD+63                                                   
ADOC70   CLI   0(R2),0                                                          
         BE    ADOC80                                                           
         CLI   0(R2),C' '                                                       
         BNE   ADOC90                                                           
ADOC80   BCTR  R2,0                                                             
         BCT   R1,ADOC70                                                        
         B     ORDCMTX                                                          
*                                                                               
ADOC90   DS    0H                                                               
         CLI   0(R2),C','          LINE SHOULDN'T END IN A COMMA                
         BNE   *+6                                                              
         BCTR  R1,0                                                             
         LA    R1,4(R1)                                                         
         STC   R1,ELTBUILD+1                                                    
         MVI   ELTBUILD,X'84'                                                   
         MVI   ELTBUILD+2,X'80'    FLAG AS REP ORDER COMMENT                    
*                                  USE HELLO FOR FIRST LINE                     
         L     R6,AIO2                                                          
         MVI   ELCODE,X'84'                                                     
         BRAS  RE,GETEL                                                         
         BE    ADOC100                                                          
*                                                                               
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),AIO2,ELTBUILD,0                    
*                                                                               
         OC    MYELEM+60(60),SPACES                                             
         CLC   MYELEM+60(60),SPACES                                             
         BE    ORDCMTX                                                          
         L     R6,AIO2                                                          
         MVI   ELCODE,X'84'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         XC    ELTBUILD,ELTBUILD                                                
         MVC   ELTBUILD+3(60),MYELEM+60                                         
         B     ADOC60              GO ADD SECOND ELEMENT                        
*                                                                               
ADOC100  DS    0H                  SECOND LINE MUST USE RECUP FOR               
         ZIC   R1,1(R6)            PROPER ORDERING                              
         AR    R6,R1                                                            
         GOTO1 VRECUP,DMCB,(2,AIO2),ELTBUILD,(R6),0                             
*                                                                               
ORDCMTX  DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*   BUCKUPDT: EITHER DELETE OR ADD BUCKET DOLLARS TO CONTRACT RECORD,           
*        BASED ON BUCKFLAG VALUE.                                               
***********************************************************************         
BUCKUPDT NTR1  BASE=*,WORK=(R2,500),LABEL=*                                     
         L     R4,AIO3             SET A(CONTRACT RECORD)                       
         USING RCONREC,R4                                                       
*                                                                               
         CLI   DAILYFLG,C'Y'       DAILY PACING?                                
         BNE   BUUP0010            NO                                           
         OI    BUCKFLGS,X'08'      YES - SET DAILY PACING CALL                  
*                                                                               
BUUP0010 EQU   *                                                                
*                                  SET ADDRESSES FOR REGENBUC                   
         MVC   DMCB,AIO            A(BUYREC)                                    
         MVC   DMCB(1),BUCKFLAG                                                 
         L     R0,VRECUP                                                        
         GOTOX (RFBUCKUP,REPFACS),DMCB,,(BUCKFLGS,RCONREC),            +        
               ACOMFACS,GETBROAD,(R0),(R2)                                      
         BNE   BUUP0100                                                         
         GOTOR TRUDATE             UPDATE TRUE ACTIVITY DATE                    
*                                                                               
         B     ABUCEXIT                                                         
*                                                                               
BUUP0100 EQU   *                                                                
         LA    R2,CONACTH                                                       
         L     R3,0(R1)                                                         
         GOTO1 GETTXT,DMCB+12,(R3),0,(C'E',DMCB),0,0,0                          
         DC    H'0',C'$ABEND'                                                   
*                                                                               
ABUCEXIT DS    0H                                                               
         B     EXIT                                                             
         DROP  R4                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* IO2 HAS NEW BUY TO ADD                                                        
***********************************************************************         
ADDBUY   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R6,AIO2                                                          
AGYBUY   USING RBUYREC,R6                                                       
*** TEST                                                                        
         TM    AGYBUY.RBUYCNTL,X'80'                                            
         BZ    *+6                                                              
         DC    H'0'                SHOULDN'T BE SET                             
*** TEST                                                                        
         XC    KEY,KEY                                                          
         MVI   BUYNUM,0                                                         
         MVC   KEY(RBUYKPLN-RBUYKEY),AGYBUY.RBUYKEY                             
         OI    DMINBTS,X'08'       RETURN DELETED KEYS                          
         GOTO1 HIGH                                                             
ADDB10   CLC   KEY(RBUYKPLN-RBUYKEY),KEYSAVE                                    
         BNE   ADDB20                                                           
         CLI   KEY+26,255          PLANREC?                                     
         BE    ADDB15                                                           
         CLC   BUYNUM,KEY+26                                                    
         BNL   *+10                                                             
         MVC   BUYNUM,KEY+26       HIGHEST LINE NUMBER SO FAR                   
ADDB15   OI    DMINBTS,X'08'       RETURN DELETED KEYS                          
         GOTO1 SEQ                                                              
         B     ADDB10                                                           
*                                                                               
ADDB20   DS    0H                  ASSIGN A NEW BUYLINE #                       
         CLI   BUYNUM,X'FF'                                                     
         BE    MAXBUYER                                                         
         ZIC   RF,BUYNUM                                                        
         LA    RF,1(RF)                                                         
         STC   RF,AGYBUY.RBUYKMLN                                               
         STC   RF,AGYBUY.RBUYKLIN                                               
         DROP  AGYBUY                                                           
*                                                                               
         L     R6,AIO3                                                          
         USING RCONSEND,R6                                                      
         MVI   ELCODE,X'20'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         TM    RCONSENF,X'20'      ON MEANS VERSION NOT ADVANCED                
         BZ    ADDB30                                                           
*                                                                               
         TM    MISCFLAG,MFCONOK                                                 
         BO    ADDB30                                                           
*                                                                               
* ADVANCE REP VERSION AND UPDATE VERSION DATES                                  
*                                                                               
         MVC   WORK(4),HELLO                                                    
         MVC   WORK+4(4),DATCON                                                 
*        GOTO1 VREGENVR,DMCB,(C'R',AIO3),WORK                                   
         GOTOX (RFGENVER,REPFACS),DMCB,(C'R',AIO3),WORK                         
         BNZ   INVLFLD                                                          
         L     R6,AIO3                                                          
         USING RCONSEND,R6                                                      
         MVI   ELCODE,X'20'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
ADDB30   DS    0H                                                               
         L     R4,AIO2                                                          
         USING RBUYREC,R4                                                       
         MVC   RBUYVER,RCONSRV     STORE REP VERSION NO. IN BUY                 
         MVI   RBUYCHGI,C'A'                                                    
         MVI   RBUYCHGI+1,0                                                     
         MVC   RBUYKMOD,CONMOD#                                                 
         TM    MISCFLG2,MF2TRADE   TRADE ORDER?                                 
         BZ    *+8                                                              
         OI    RBUYFLG2,X'02'      FLAG TRADE                                   
         DROP  R4,R6                                                            
*                                                                               
         MVC   AIO,AIO2                                                         
         L     R6,AIO                                                           
         AHI   R6,RBUYELEM-RBUYREC                                              
*                                                                               
* REMOVE ELEMENTS NOT PERTAINING TO THIS NEW BUY                                
* (EXAMPLE, X'56', X'66' ,ETC)                                                  
*                                                                               
ADDB40   DS    0H                                                               
         LA    R3,ELMLIST                                                       
         LA    R2,ELMLISTQ                                                      
*                                                                               
ADDB50   DS    0H                                                               
         CLC   0(1,R6),0(R3)                                                    
         BE    ADDB70                                                           
         AHI   R3,1                                                             
         CLI   0(R3),0                                                          
         BE    ADDB60                                                           
         BCT   R2,ADDB50                                                        
*                                                                               
ADDB60   DS    0H                                                               
         LR    R3,R6                                                            
         MVC   ELCODE,0(R6)                                                     
         GOTO1 REMELEM                                                          
         LR    R6,R3               RESTORE POINTER TO RECORD                    
         B     ADDB73                                                           
*                                                                               
ADDB70   DS    0H                                                               
         ZIC   RF,1(R6)                                                         
         AR    R6,RF                                                            
ADDB73   DS    0H                                                               
         CLI   0(R6),0                                                          
         BNE   ADDB40                                                           
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   ADDB74                                                           
         L     RF,AIO3                                                          
         USING RCONREC,RF                                                       
K        USING RBUYXXEL,R6                                                      
         MVC   K.RBUYXXMD,RCONMOD                                               
         MVC   K.RBUYXXVR,VERDFLT                                               
         DROP  RF                                                               
         DROP  K                                                                
         B     ADDB75                                                           
*                                                                               
ADDB74   DS    0H                                                               
         L     R6,AIO3                                                          
         USING RCONREC,R6                                                       
         XC    ELEM,ELEM                                                        
WKD      USING RBUYXXEL,ELEM                                                    
         MVI   WKD.RBUYXXCD,RBUYXXCQ                                            
         MVI   WKD.RBUYXXLN,RBUYXXLQ                                            
         MVC   WKD.RBUYXXMD,RCONMOD    CONTRACT MOD# AT BUY CREATION            
         MVC   WKD.RBUYXXVR,VERDFLT    CONTRACT VER# AT BUY CREATION            
         DROP  R6,WKD                                                           
*                                                                               
         GOTO1 ADDELEM                                                          
*                                                                               
ADDB75   DS    0H                                                               
         L     R6,AIO2                                                          
         MVI   ELCODE,X'08'        REP TO SPOT TRANSFER ELEMENT EXIST?          
         BRAS  RE,GETEL                                                         
         BNE   ADDB80                                                           
         USING RBUYSPEL,R6                                                      
         MVI   RBUYSPL#,0          RESET SPOT BUY NUMBER                        
         XC    RBUYSPDT,RBUYSPDT   AND CLEAR OUT TRANSFERRED DATE/TIME          
         XC    RBUYSPTM,RBUYSPTM                                                
         DROP  R6                                                               
*                                                                               
* REGENVER MARKS CONTRACT GOING TO MANUAL PROCESSING. WE NEED TO RESET          
* IT BACK TO AUTOMATIC                                                          
*                                                                               
ADDB80   DS    0H                                                               
         L     R6,AIO3                                                          
         MVI   ELCODE,X'1D'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING RCONDREL,R6                                                      
         NI    RCONDRF2,X'FF'-X'04'                                             
         DROP  R6                                                               
*                                                                               
         XC    ELTBUILD,ELTBUILD                                                
ELM      USING RBUYOCEL,ELTBUILD                                                
         MVI   ELM.RBUYOCCD,X'84'                                               
         MVI   ELM.RBUYOCLN,23                                                  
         MVI   ELM.RBUYOCID,X'80'                                               
         MVC   ELM.RBUYOCNT(20),=C'ADDITION TO SCHEDULE'                        
         DROP  ELM                                                              
         GOTO1 HELLO,DMCB,(C'D',=C'REPFILE'),(X'84',AIO2),0,0                   
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),AIO2,ELTBUILD,0                    
*                                                                               
         MVC   AIO,AIO2                                                         
         GOTO1 ADDREC                                                           
         MVI   BUCKFLAG,X'00'      SET TO ADD NEW FIGURES                       
*                                  ADD NEW BUCKETS                              
         GOTOR BUCKUPDT                                                         
*                                                                               
ADDBX    DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
*                                                                               
* LIST OF ELEMENTS TO RETAIN FOR NEW BUY                                        
*                                                                               
ELMLIST  DC    X'01',X'02',X'03',X'04',X'08',X'0D',X'10',X'21',X'84'            
         DC    X'D0'                                                            
         DC    X'00'                                                            
ELMLISTQ EQU   *-ELMLIST                                                        
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*  TRUDATE:  FOR CONTRACTS WHERE THE BUYLINES HAVE RESULTED IN BUCKET           
*     CHANGES, FIND (ADD IF NOT PRESENT) THE X'08' ELEMENT, AND                 
*     UPDATE THE TRUE ACTIVITY DATE FOR SAR REPORTING                           
***********************************************************************         
TRUDATE  NTR1  BASE=*,LABEL=*                                                   
         L     R4,AIO3                                                          
         USING RCONREC,R4                                                       
*                                                                               
         LA    R2,RCONELEM         A(1ST ELEMENT)                               
TDAT0010 EQU   *                                                                
         ZIC   RF,1(R2)            BUMP TO NEXT ELEMENT                         
         AR    R2,RF                                                            
         CLI   0(R2),0             END OF RECORD?                               
         BE    TDAT0030            YES - NO X'08' FOUND - ADD IT                
         CLI   0(R2),X'08'         X'08'?                                       
         BNE   TDAT0010            NO  - GO BACK FOR NEXT                       
TDAT0020 EQU   *                   YES - ADD TODAYS DATE                        
         USING RCONACEL,R2                                                      
         GOTO1 DATCON,DMCB,(5,RCONACTA),(3,RCONACTA)                            
*                                  TODAY'S DATE INTO TRUE ACT DATE              
         DROP  R2                                                               
*                                                                               
         B     TDAT0040            FINISHED                                     
TDAT0030 EQU   *                                                                
         XC    ELEM,ELEM                                                        
         MVC   ELEM(2),=X'080C'                                                 
         GOTO1 DATCON,DMCB,(5,RCONDATE),(3,ELEM+5)                              
*                                  TODAY'S DATE INTO TRUE ACT DATE              
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),RCONREC,ELEM,=C'ADD=CODE'          
TDAT0040 EQU   *                                                                
         MVI   TRUFLAG,C'Y'        SET 'NEED EC KEY' FLAG                       
         B     EXIT                                                             
         DROP  R4                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*   GEN8DEKY:  DELETE OLD 8D/8E KEY AND ADD NEW ONES                            
*                                                                               
* CONFLTDT = OLD/ORIGINAL CONTRACT FLIGHT DATES                                 
* FLTDATES = NEW/DARE ORDER FLIGHT DATES                                        
***********************************************************************         
GEN8DEKY NTR1  BASE=*,WORK=(R2,G8WORKQ),LABEL=*                                 
         USING G8WORKD,R2                                                       
*                                                                               
         MVC   G8SVAIO,AIO                                                      
*                                                                               
         L     R6,AIO              SAVE OFF STATION AND CON# BEFORE             
         USING RCONREC,R6          AIO GETS USED BY DATAMGR                     
*                                                                               
         GOTO1 DATCON,DMCB,(3,RCONDATE),(2,NEWFLTDT)                            
         GOTO1 DATCON,(R1),(3,RCONDATE+3),(2,NEWFLTDT+2)                        
         CLC   CONFLTDT,NEWFLTDT   NO CHANGES, SHOULDN'T BE IN HERE             
         BE    GENKEYX                                                          
*                                                                               
         MVC   WORK(5),RCONKSTA                                                 
         MVC   WORK+5(4),RCONKCON                                               
         DROP  R6                                                               
*                                                                               
         LA    RE,G8IO                                                          
         ST    RE,AIO                                                           
*                                                                               
* DELETE OLD SET OF 8D/8E RIS KEYS FIRST                                        
*                                                                               
         XC    KEY,KEY                                                          
KYD      USING RCONKEY,KEY                                                      
         MVI   KYD.RCON8TYP,X'8D'  INSERT KEY ID                                
*                                                                               
GENKEY10 DS    0H                                                               
         XC    BLOCK,BLOCK                                                      
         LA    R4,BLOCK                                                         
*                                                                               
         MVC   KYD.RCON8REP,AGENCY                                              
         MVC   KYD.RCON8FST(4),CONFLTDT                                         
         MVC   KYD.RCON8CON,WORK+5                                              
         LA    R3,1                                                             
         STC   R3,KYD.RCON8RID                                                  
         NI    DMINBTS,X'FF'-X'08' TURN OFF 'RETURN DELETES'                    
         GOTO1 HIGH                READ HIGH AND GET X'01' KEY                  
*                                  READ ACTIVE KEYS ONLY!                       
GENKEY20 DS    0H                                                               
         MVC   0(32,R4),KEY        SAVE OFF KEY                                 
*                                                                               
         CLC   KEY(16),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                DIE FOR NOW                                  
*                                                                               
         ZIC   R1,KYD.RCON8RID     SEQUENCE MUST MATCH                          
         CR    R3,R1                                                            
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         OI    KEY+27,X'80'                                                     
         GOTO1 WRITE                                                            
*                                                                               
         GOTO1 SEQ                                                              
         AHI   R3,1                                                             
         LA    R4,32(R4)                                                        
         CHI   R3,4                                                             
         BL    GENKEY20                                                         
*                                                                               
* ADD NEW SET OF 8D/8E RIS KEYS WITH NEW FLIGHT DATES                           
*                                                                               
GENKEY30 DS    0H                                                               
*                                                                               
         LA    R3,1                                                             
         LA    R4,BLOCK                                                         
*                                                                               
GENKEY40 DS    0H                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(32),0(R4)                                                    
*                                  ADD NEW KEYS WITH NEW FLIGHT DATES           
         MVC   KYD.RCON8FST(4),NEWFLTDT                                         
         STC   R3,KYD.RCON8RID                                                  
         OI    DMINBTS,X'08'       RETURN DELETED KEY                           
         GOTO1 HIGH                                                             
         CLC   KEY(27),KEYSAVE     CHECK IF NEW KEY EXISTS                      
         BNE   GENKEY50                                                         
         MVI   KEY+27,0            YES, RESTORE IT                              
         GOTO1 WRITE                                                            
         B     GENKEY60                                                         
*                                                                               
GENKEY50 DS    0H                                                               
         MVC   KEY,KEYSAVE                                                      
         MVI   KEY+27,0                                                         
         GOTO1 ADD                                                              
*                                                                               
GENKEY60 DS    0H                                                               
         AHI   R3,1                                                             
         LA    R4,32(R4)                                                        
         CHI   R3,4                                                             
         BL    GENKEY40                                                         
*                                                                               
         CLI   KEYSAVE,X'8E'       HAVE DONE PROCESSING 8D AND 8E KEYS?         
         BE    GENKEYX             YES, EXIT                                    
         XC    KEY,KEY             NO, SET TO PROCESS 8E KEYS                   
         MVI   KYD.RCON8TYP,X'8E'  INSERT KEY ID                                
         MVC   KYD.RCON8EST,WORK                                                
         B     GENKEY10                                                         
*                                                                               
GENKEYX  EQU   *                                                                
         MVC   AIO,G8SVAIO                                                      
         B     EXIT                                                             
         DROP  KYD                                                              
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* PRE APPROVAL PROCESSING:                                                      
* - SAVE OFF HEADER INFORMATION                                                 
***********************************************************************         
PREAPRV  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   KEY(L'SELECTKY),SELECTKY                                         
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(27),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                SHOULD NEVER HAPPEN!                         
*                                                                               
         MVC   AIO,AIO1                                                         
*                                                                               
         GOTO1 GETREC                                                           
         GOTOR VALPRDD                                                          
                                                                                
         L     R4,AIO                                                           
         USING RDARREC,R4                                                       
*                                                                               
         NI    MISCFLG2,X'FF'-MF2TRADE                                          
         CLI   RDARCORT,C'T'                                                    
         BNE   *+8                                                              
         OI    MISCFLG2,MF2TRADE                                                
*                                                                               
         MVI   KATZEDI,C'N'        SET KATZ EDI ORDER TO 'NO'                   
         CLC   =C'$EDI$',RDARAGAD  SCAN FOR KATZ EDI SPECIAL                    
         BNE   *+8                                                              
         MVI   KATZEDI,C'Y'                                                     
*                                                                               
         MVI   RESENT,C'N'         SET RESENT FLAG TO 'NO'                      
         TM    RDARMISC,X'80'      ORDER RESENT?                                
         BNO   PREA10              NO                                           
         MVI   RESENT,C'Y'         YES - NEED VERSION BUMP                      
PREA10   DS    0H                                                               
         TM    RDARMISC,X'20'      IS ORDER 'NOTDARE'?                          
         BNO   PREA20              NO                                           
         LA    R2,CONACTH          SET CURSOR TO 'ACTION' FIELD                 
         MVC   RERROR,=AL2(451)    SET ERROR MESSAGE                            
         GOTO1 MYERROR             EXIT WITH ERROR                              
PREA20   DS    0H                                                               
         LA    R2,DIFHDLNH         ANY CONTRACT NUMBER?                         
         CLI   5(R2),0                                                          
         BNE   PREA60              YES - CONTINUE                               
         OC    RDARREP#,RDARREP#   IS ORDER LINKED?                             
         BNZ   PREA30              YES                                          
         MVC   RERROR,=AL2(435)    NO  - UNLINKED: ILLEGAL APPROVAL             
         B     PREAERR                                                          
PREA30   DS    0H                                                               
         GOTO1 HEXOUT,DMCB,RDARREP#,WORK,4,=C'TOG'                              
*                                  GET REP CONTRACT NUMBER                      
         LA    R3,WORK                                                          
         LA    RF,8                LOOP CONTROL                                 
PREA40   DS    0H                                                               
         CLI   0(R3),C'0'          LEADING ZERO?                                
         BNE   PREA50              NO  - MOVE IT                                
         LA    R3,1(R3)            YES - BUMP TO NEXT POSITION                  
         BCT   RF,PREA40           GO BACK FOR NEXT                             
         DC    H'0'                SHOULDN'T HAPPEN                             
PREA50   DS    0H                                                               
         BCTR  RF,0                DECREMENT FOR EX                             
         EX    RF,*+8              MOVE BY LENGTH TO SCREEN                     
         B     *+10                                                             
         MVC   8(0,R2),0(R3)                                                    
PREA60   DS    0H                                                               
         TM    CCONFLAG,CCONFSWP   CANNOT APPROVE IF CONTRACT IS IN             
         BZ    PREA70              STATION'S WORK-IN-PROGRESS                   
         MVC   RERROR,=AL2(656)    SET ERROR TYPE = STATION IN WIP              
         B     PREAERR                                                          
*                                                                               
PREA70   DS    0H                                                               
         TM    RDARMISC,X'20'      ORDER NOTDARED FROM AGENCY SIDE?             
         BZ    PREA80                                                           
         MVI   RMSGTYPE,C'E'                                                    
         LA    R2,CONSERVH         SET A(SERVICE REQUEST)                       
         MVC   RERROR,=AL2(450)    SET ERROR TYPE = ONLY ACTION REJECT          
*                                     IS ALLOWED FOR NOTDARE ORDER              
         B     PREAERR                                                          
                                                                                
PREA80   DS    0H                                                               
*                                                                               
         CLI   RDARBSTS,0          AGY ORDER PRIOR STATUS?                      
         BE    PREA100             NO  - DO APPROVE OR REJECT                   
         CLI   RDARBSTS,C'A'       PRIOR STATUS = APPROVED?                     
         BE    PREAERR                                                          
PREA90   DS    0H                                                               
         MVI   RMSGTYPE,C'E'                                                    
         LA    R2,CONSERVH         SET A(SERVICE REQUEST)                       
         MVC   RERROR,=AL2(425)    SET ERROR TYPE = REJECTED:                   
*                                     THIS ACTION IGNORED                       
         B     PREAERR                                                          
*                                                                               
PREA100  DS    0H                                                               
*                                                                               
*   SAVE EASI CODES BEFORE ANYTHING ELSE.  AGENCY HEADER RECORD                 
*     CONTAINS X'01' AND X'02' ELEMENT, SO ALL LABELS APPLY AT                  
*     THIS TIME.                                                                
*                                                                               
         MVC   EASIADV(4),RDARCLI  INSERT CLIENT/ADV CODE                       
*                                     CHOPPED TO 4 CHARS                        
         MVC   EASIPROD,RDARPRD1   INSERT PRODUCT CODE                          
         MVC   EASIPRD2,RDARPRD2   INSERT PRODUCT CODE 2                        
*                                                                               
         MVC   SAVEPROD,RDARPRN1   SAVE PRODUCT NAME(S)                         
         CLC   =C'$EDI$',RDARAGAD  KATZ EDI ONLY HAS ONE PRODUCT                
         BE    PREA120                                                          
         CLC   RDARPRN2,SPACES                                                  
         BE    PREA120                                                          
         MVI   SAVEPROD+10,C'/'                                                 
         MVC   SAVEPROD+11(9),RDARPRN2                                          
                                                                                
PREA120  DS    0H                                                               
         EDIT  RDAREST#,(4,EASIEST#),FILL=0,ZERO=NOBLANK                        
*                                  INSERT ESTIMATE NUMBER, 3 CHARS              
         MVC   FLTDATES,RDARESST   SAVE FLIGHT START/END                        
         MVC   SAVEBUYR,RDARBUYR   SAVE BUYER NAME                              
*                                                                               
*                                                                               
*   INSERT INFORMATION FROM KEY SECTION INTO RETURN MESSAGE                     
*      SAVE AREA                                                                
*                                                                               
         GOTO1 HEXOUT,DMCB,RDARKORD,RETORD#,4,=C'TOG'                           
*                                  INSERT ORDER #                               
         MVC   RETSTAT,RDARKSTA    INSERT STATION                               
         CLI   RETSTAT+4,C'L'      IS IT A TV STATION?                          
         BE    PREA130             YES - LEAVE AS IS                            
         MVI   RETSTAT+5,C'V'      INSERT LAST CHAR OF MEDIA                    
         CLI   RETSTAT+4,C'T'      IS IT A TV STATION?                          
         BE    PREA130             YES - LEAVE AS IS                            
         MVI   RETSTAT+5,C'M'      NO  - INSERT RADIO MEDIA                     
*                                                                               
PREA130  DS    0H                                                               
         MVI   METHOD,ADDBUYQ                                                   
         CLI   STAMETH,0                                                        
         BE    PREA150                                                          
         CLI   STAMETH,3                                                        
         BNE   PREAX                                                            
         MVI   METHOD,CHGBUYQ                                                   
         B     PREAX                                                            
*                                                                               
PREA150  DS    0H                                                               
         LR    R4,RA               USE R2 TO COVER THE ENTRY                    
         AH    R4,=AL2(DARPROFS-CONHEADH)                                       
         USING SVDSECT,R4                                                       
*                                                                               
         TM    SVPGPBIT+CNTDRV3B,CNTDRV3A                                       
         BZ    PREAX                                                            
         MVI   METHOD,CHGBUYQ                                                   
*                                                                               
PREAX    DS    0H                                                               
***** FORCE ADD TO SCHED FOR ALL TEMPORARILY                                    
***** FORCE ADD TO SCHED FOR ALL TEMPORARILY                                    
***** FORCE ADD TO SCHED FOR ALL TEMPORARILY                                    
         MVI   METHOD,ADDBUYQ                                                   
***** FORCE ADD TO SCHED FOR ALL TEMPORARILY                                    
***** FORCE ADD TO SCHED FOR ALL TEMPORARILY                                    
***** FORCE ADD TO SCHED FOR ALL TEMPORARILY                                    
         B     EXIT                                                             
*                                                                               
PREAERR  DS    0H                                                               
         LA    R2,CONRECH          SET CURSOR HERE                              
         GOTO1 MYERROR                                                          
         DROP  R4                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                               
* VALIDATE PRODUCT DATE AGAINST ESTIMATE DATE                                   
*                                                                               
***********************************************************************         
VALPRDD  NTR1  BASE=*,WORK=(R4,500),LABEL=*                                     
*                                                                               
         L     R6,AIO              R6-> DARE RECORD                             
         USING RDARREC,R6                                                       
         MVI   ELCODE,X'0F'                                                     
         BRAS  RE,GETEL                                                         
         BNE   VALPRDDX                                                         
         USING RDARFLEM,R6                                                      
         TM    RDARFLG1,X'01'      UNWIRE?                                      
         BZ    VALPRDDX                                                         
*                                                                               
         L     R3,AIO                                                           
         USING RDARREC,R3                                                       
*                                                                               
         USING IMWORKD,R4          R4->WORK AREA                                
         MVC   IMSVKEY,KEY                                                      
         MVC   IMSVIO,AIO                                                       
*                                  CHECK FLIGHT DATE CONFLICT                   
         LA    RE,IMIO                                                          
         ST    RE,AIO                                                           
         XC    KEY,KEY                                                          
K        USING RPRDKEY,KEY                                                      
         MVI   K.RPRDKTYP,X'09'                                                 
         MVC   K.RPRDKADV,SVCONADV                                              
         MVC   K.RPRDKPRD,SVCONPRD                                              
         MVC   K.RPRDKREP,SVCONREP                                              
         DROP  K                                                                
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEYSAVE(27),KEY                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVI   RDUPDATE,C'Y'                                                    
         GOTO1 GETREC                                                           
         L     R6,AIO                                                           
         MVI   ELCODE,X'04'                                                     
         BRAS  RE,GETEL                                                         
         BNE   VALP0100                                                         
*                                                                               
         USING RPRDAGFL,R6                                                      
         GOTO1 DATCON,DMCB,(2,RDARESST),(3,ELEM)                                
         GOTO1 DATCON,DMCB,(2,RDARESEN),(3,ELEM+3)                              
*                                                                               
         CLC   ELEM(3),RPRDAGDF                                                 
         BL    VALP0050                                                         
         CLC   ELEM+3(3),RPRDAGDT                                               
         BH    VALP0050                                                         
         B     VALP0100                                                         
*                                                                               
VALP0050 DS    0H                                                               
         OC    RPRDAGDF(L'RPRDAGDF+L'RPRDAGDT),RPRDAGDF                         
         BNZ   ERPRDDAT            EMPTY?                                       
         TM    MISCFLG4,MF4TKO     TAKE OVER CONTRACT?                          
         BZ    ERPRDDAT            NO                                           
         MVC   RPRDAGDF,ELEM       COPY START-END DATE FROM ORDER               
         MVC   RPRDAGDT,ELEM+3                                                  
         GOTO1 PUTREC                                                           
                                                                                
VALP0100 DS    0H                                                               
         MVC   AIO,IMSVIO          NEED TO RESTORE GETREC SEQUENCE              
         MVC   KEY,IMSVKEY                                                      
         GOTO1 HIGH                                                             
         GOTO1 GETREC                                                           
*                                                                               
VALPRDDX DS    0H                                                               
         XIT1                                                                   
         DROP  R6                                                               
         DROP  R3                                                               
         DROP  R4                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                               
* PROPAGATE AGENCY DEMO CHANGES                                                 
* USING THE REP BUY'S LINK TO ITS AGENCY COUNTERPART. WE'LL COMPARE THE         
* TWO TO SEE IF WE NEED TO UPDATE ANY DEMO CATEGORY/VALUE CHANGES               
*                                                                               
***********************************************************************         
DEMOPROC NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    KEY,KEY                                                          
         LA    R6,KEY                                                           
         USING RBUYREC,R6                                                       
         XC    KEY,KEY                                                          
         MVI   RBUYKTYP,X'0B'                                                   
         MVC   RBUYKREP,TWAAGY     INSERT REP CODE                              
         MVC   RBUYKCON,COMPCON    INSERT CONTRACT #, 9/COMP/REV                
         DROP  R6                                                               
*                                                                               
         MVI   RDUPDATE,C'Y'                                                    
         GOTO1 HIGH                                                             
*                                                                               
DEMOP10  DS    0H                                                               
         CLC   KEY(RBUYKPLN-RBUYKEY),KEYSAVE                                    
         BNE   DEMOPX                                                           
*                                                                               
         MVC   AIO,AIO2                                                         
         MVI   RDUPDATE,C'Y'       READ FOR UPDATE                              
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO                                                           
         USING RBUYREC,R6                                                       
         CLI   RBUYAGBL,0          MUST HAVE LINK TO GET CORRECT DEMO           
         BE    DEMOP90                                                          
*                                                                               
         MVC   SVBUYKEY,KEY        SAVE FOR RESTARTS                            
*                                                                               
* FIND MATCHING AGENCY SHADOW BUY                                               
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
SHADOWD  USING RBUYREC,R4                                                       
         XC    KEY,KEY                                                          
         MVC   SHADOWD.RBUYKTYP(2),=X'0B01'                                     
         MVC   SHADOWD.RBUYKREP,TWAAGY    INSERT REP CODE                       
         MVC   SHADOWD.RBUYKCON,COMPCON   INSERT CONTRACT #, 9/COMP/REV         
         MVC   SHADOWD.RBUYKPLN,=X'FFFFFF' INSERT PLAN CODE                     
         MVC   SHADOWD.RBUYKMLN,RBUYAGBL                                        
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(RBUYKLIN-RBUYKEY),KEYSAVE                                    
         BNE   DEMOP80             COULDN'T FIND LINK, SKIP                     
         DROP  R6,SHADOWD                                                       
*                                                                               
DEMOP30  DS    0H                                                               
         MVC   AIO,AIO1                                                         
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO1             AGENCY SHADOW BUY                            
         MVI   ELCODE,X'0D'                                                     
         BRAS  RE,GETEL                                                         
         BNE   DEMOP80                                                          
         LR    R4,R6                                                            
SHADOWD  USING RBUYDMEL,R4                                                      
*                                                                               
         XC    ELEM,ELEM                                                        
         ZIC   R1,SHADOWD.RBUYDMLN                                              
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   ELEM(0),SHADOWD.RBUYDMEL                                         
         DROP  SHADOWD                                                          
*                                                                               
         LA    R4,ELEM                                                          
SHADOWD  USING RBUYDMEL,ELEM                                                    
*                                                                               
         L     R6,AIO2             REP BUY                                      
         MVI   ELCODE,X'0D'                                                     
         BRAS  RE,GETEL                                                         
         BNE   DEMOP70                                                          
         USING RBUYDMEL,R6                                                      
*                                                                               
         CLC   SHADOWD.RBUYDMLN,RBUYDMLN                                        
         BNE   DEMOP60                                                          
*                                                                               
         SR    R2,R2                                                            
         ZIC   R3,RBUYDMLN                                                      
         SHI   R3,2                                                             
         LA    RE,L'RBUYDMCV                                                    
         DR    R2,RE               R3 HAS NUMBER OF DEMOS TO CHECK              
*                                                                               
DEMOP40  DS    0H                                                               
         CLC   SHADOWD.RBUYDMCT,RBUYDMCT                                        
         BNE   DEMOP60             SAME CATEGORY?                               
         CLC   SHADOWD.RBUYDMDM,RBUYDMDM                                        
         BE    DEMOP50             SAME VALUE?                                  
         MVC   SHADOWD.RBUYDM2M,RBUYDMDM                                        
*                                                                               
DEMOP50  DS    0H                                                               
         AHI   R4,L'RBUYDMCV                                                    
         AHI   R6,L'RBUYDMCV                                                    
         BCT   R3,DEMOP40                                                       
*                                                                               
DEMOP60  DS    0H                  REMOVE EXISTING AGENCY DEMO VALUES           
         GOTO1 HELLO,DMCB,(C'D',=C'REPFILE'),(X'0D',AIO2),0,0                   
*                                                                               
DEMOP70  DS    0H                                                               
         L     RE,AIO2             REREAD FOR PUTREC                            
         MVC   KEY(L'RBUYKEY),0(RE)                                             
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(L'RBUYKEY),KEYSAVE                                           
         BE    *+6                                                              
         DC    H'0'                                                             
         MVI   RDUPDATE,C'Y'                                                    
         MVC   AIO,AIOAREA         WRITE OUT BUY RECORD                         
         GOTO1 GETREC                                                           
         MVC   AIO,AIO2                                                         
         GOTO1 ADDELEM                                                          
         GOTO1 PUTREC                                                           
*                                                                               
DEMOP80  DS    0H                                                               
         MVC   KEY(27),SVBUYKEY    RESTART                                      
         GOTO1 HIGH                                                             
*                                                                               
DEMOP90  DS    0H                                                               
         MVI   RDUPDATE,C'Y'                                                    
         GOTO1 SEQ                                                              
         B     DEMOP10                                                          
*                                                                               
DEMOPX   DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                               
* SPECIAL TRAP FOR AUTO-APPROVAL TOTALS NOT MATCHING                            
*                                                                               
***********************************************************************         
TRAP     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XR    R1,R1                                                            
         L     R6,AIO3                                                          
         MVI   ELCODE,X'03'                                                     
         TM    MISCFLG2,MF2TRADE   TRADE ORDER?                                 
         BZ    *+8                                                              
         MVI   ELCODE,X'63'                                                     
*                                                                               
         BRAS  RE,GETEL                                                         
         B     *+8                                                              
TRAP10   BRAS  RE,NEXTEL                                                        
         BNE   TRAP20                                                           
*                                                                               
         ZICM  R0,6(R6),4                                                       
         AR    R1,R0                                                            
         B     TRAP10                                                           
*                                                                               
TRAP20   DS    0H                                                               
         ZICM  R0,GTOTAL$,4                                                     
         CR    R0,R1                                                            
         BNE   TRAP30                                                           
*                                                                               
         B     TRAPX                                                            
         CLI   TWAOFFC,C'*'        DDS TERMINAL?                                
         BNE   TRAPX                                                            
*                                                                               
         XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(APPRVOKQ),APPRVOK                                        
         OI    CONHEADH+6,X'80'    XMIT                                         
         OI    CONACTH+6,X'40'     FORCE CURSOR HERE                            
         L     RF,ATIOB                                                         
         USING TIOBD,RF                                                         
         OI    TIOBINDS,TIOBALRM   SOUND A BEEP                                 
         DROP  RF                                                               
         DC    H'0',C'$ABEND'                                                   
*                                                                               
*                                                                               
* NOTIFY USER TO CONTRACT DDS                                                   
*                                                                               
TRAP30   DS    0H                                                               
*        GOTOR DUMPTSAR                                                         
         XC    CONHEAD,CONHEAD                                                  
         MVC   CONHEAD(ERRMTCHQ),ERRMTCH                                        
         OI    CONHEADH+6,X'80'    XMIT                                         
         OI    CONACTH+6,X'40'     FORCE CURSOR HERE                            
         L     RF,ATIOB                                                         
         USING TIOBD,RF                                                         
         OI    TIOBINDS,TIOBALRM   SOUND A BEEP                                 
         DROP  RF                                                               
         DC    H'0',C'$ABEND'                                                   
*                                                                               
TRAPX    DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
ERRMTCH  DC    C'Error: Contract and order total mismatch. Call DDS.'           
ERRMTCHQ EQU   *-ERRMTCH                                                        
APPRVOK  DC    C'Approval went to completion. All spots matched.'               
APPRVOKQ EQU   *-APPRVOK                                                        
         EJECT                                                                  
***********************************************************************         
* SPECIAL OPEN ACTION TO BYPASS DIFFERENCES LOGIC                               
* JUST SEND OPEN TO AGENCY                                                      
* THIS IS TRIGGER ONLY BY THE CONTRACT SEND ACTION SO WE WILL ALSO              
* BE FLAGGING THE DARE ORDER -S                                                 
***********************************************************************         
SENDOPEN NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLC   =C'#OPEN',CONACT    SPECIAL OPEN ACTION TO BYPASS                
         BE    *+6                 DIFFERENCES LOGIC                            
         DC    H'0'                JUST SEND OPEN TO AGENCY                     
*                                                                               
         MVI   ACTCODE,C'A'                                                     
         LA    R2,AORHDLNH                                                      
         GOTO1 VALICON,DMCB,(R2)   GET CONTRACT INFO AND STORE IT               
         GOTOR GETCON              RETRIEVE CONTRACT RECORD                     
         BZ    *+6                 EXIT:  NO CONTRACT NUMBER                    
         DC    H'0'                                                             
*                                                                               
         XC    WORK,WORK                                                        
         MVC   WORK(4),ACOMFACS                                                 
         MVC   WORK+4(2),TWAAGY                                                 
*                                                                               
         GOTOX (RFGETDAR,REPFACS),DMCB,AIO3,KEY,0,WORK                          
*                                                                               
         MVC   SELECTKY,KEY                                                     
*                                                                               
         GOTOR POSTAPRJ                                                         
*                                                                               
         NI    FLAGS2,X'FF'-FG2STAY                                             
         OI    FLAGS2,FG2RTRN                                                   
*                                                                               
         GOTOR SWAP2CON                                                         
*                                                                               
         NI    FLAGS2,X'FF'-FG2RTRN                                             
*                                                                               
SOPNX    DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* POST APPROVAL/REJECTION PROCESSING:                                           
* - UPDATE DARE AGENCY RECORD                                                   
* - WRITE OUT DARE TRANSACTION MESSAGES TO PRINT QUEUE                          
* - UPDATE PASSIVE KEYS                                                         
***********************************************************************         
POSTAPRJ NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   KEY(L'SELECTKY),SELECTKY                                         
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(27),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                SHOULD NEVER HAPPEN!                         
*                                                                               
         MVC   AIO,AIO1                                                         
*                                                                               
         GOTO1 GETREC                                                           
                                                                                
         L     R4,AIO                                                           
         USING RDARREC,R4                                                       
*                                                                               
         L     R6,AIO                                                           
         USING RDARELEM,R6                                                      
*                                                                               
         MVI   ELCODE,X'01'                                                     
         BRAS  RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                MUST BE THERE                                
*                                                                               
*   SAVE HEADER INFORMATION FOR RETURN MESSAGE                                  
*                                                                               
         MVC   RETFROM(20),RDARSNDR                                             
*                                                                               
         CLC   =C'H7',RDARSNDR                                                  
         BNE   *+10                                                             
         MVC   RETFROM(2),=C'MS'                                                
*                                                                               
*   INSERT INFORMATION FROM KEY SECTION INTO RETURN MESSAGE                     
*      SAVE AREA                                                                
*                                                                               
         GOTO1 HEXOUT,DMCB,RDARKORD,RETORD#,4,=C'TOG'                           
*                                  INSERT ORDER #                               
         MVC   RETSTAT,RDARKSTA    INSERT STATION                               
         CLI   RETSTAT+4,C'L'      IS IT A TV STATION?                          
         BE    PAR400              YES - LEAVE AS IS                            
         MVI   RETSTAT+5,C'V'      INSERT LAST CHAR OF MEDIA                    
         CLI   RETSTAT+4,C'T'      IS IT A TV STATION?                          
         BE    PAR400              YES - LEAVE AS IS                            
         MVI   RETSTAT+5,C'M'      NO  - INSERT RADIO MEDIA                     
*                                                                               
*                                  INSERT SENDER/RECEIVER                       
PAR400   DS    0H                                                               
         GOTO1 HEXOUT,DMCB,RDARREP#,RETCON#,4,=C'TOG'                           
*                                  INSERT CONTRACT # (REP)                      
*                                                                               
         MVC   RETSENDR,RDARRTS    INSERT 'RETURN TO SENDER' INFO               
*                                                                               
*   SET REPORT ID/CLASS FOR SPOOLING                                            
*                                                                               
         CLI   KATZEDI,C'Y'        SKIP SENDING APPROVAL NOTICE BACK TO         
         BE    PAR690              THE AGENCY FOR KATZ EDI ORDERS               
*        TM    SVDARFL2,SF2XML     XML ORDER?                                   
*        BO    PAR690              DO NOT SPOOL DARE TRANSACTION                
*                                                                               
         MVC   REMUSER,=C'DAR'                                                  
         LA    RF,SPOOLKEY                                                      
         USING PQPLD,RF                                                         
*                                                                               
         XC    SPOOLKEY,SPOOLKEY                                                
*                                                                               
         MVC   PLDESC,=CL11'DARE REJECT'                                        
         CLC   =C'AMEND',CONACT                                                 
         BNE   *+10                                                             
         MVC   PLDESC,=CL11'DARE AMEND'                                         
         MVC   EDICTACT,=C'REJ'    SET EDICT 'ACTION'                           
         CLI   ACTCODE,C'R'        APPROVAL/REJECTION?                          
         BE    PAR510              NO                                           
         MVC   PLDESC,=CL11'DARE APPRVL'                                        
         MVC   EDICTACT,=C'APP'    SET EDICT 'ACTION'                           
*                                                                               
PAR510   EQU   *                                                                
         OI    GENSTAT3,NOCLRSPK                                                
         MVI   PLCLASS,C'G'        CLASS G                                      
         OI    SPOOLIND,SPUINIT    PERMITS SETTING OF CLASS                     
*                                                                               
         DROP  R4,R6,RF                                                         
*                                                                               
         LA    RE,SPLKEYAD         SET EXTENDED KEY ADDRESS                     
*                                                                               
*                                                                               
         ST    RE,SPOOLQLK         SAVE EXTENDED KEY ADDRESS                    
         USING PQPLD,RE                                                         
         XC    0(133,RE),0(RE)                                                  
         MVC   QLRETNL,=H'6'                                                    
         MVC   QLRETND,=H'2'                                                    
         DROP  RE                                                               
*                                                                               
PAR690   DS    0H                                                               
         CLI   KATZEDI,C'Y'        SKIP MESSAGE FOR KATZ EDI ORDERS             
         BE    PAR0880                                                          
*        TM    SVDARFL2,SF2XML     XML ORDER?                                   
*        BO    PAR0880             DO NOT SPOOL DARE TRANSACTION                
*                                                                               
*                                  SEND MESSAGE: ORDER APPROVED                 
         GOTO1 OPENPQ                                                           
         GOTOR EDICT                                                            
*                                  PUT OUT EDICT HEADER                         
         GOTOR APPRREJC                                                         
*                                                                               
         CLI   ACTCODE,C'R'                                                     
         BNE   PAR0880                                                          
*&&RD                                                                           
         L     R6,AIO1                                                          
         USING RDARREC,R6                                                       
         CLI   RDARKSTA+4,C'A'     FOR RADIO EDI, SEND SALESPERSON              
         BE    PAR0700             AND TRAILER RECORDS                          
         CLI   RDARKSTA+4,C'F'                                                  
         BE    PAR0700                                                          
         B     PAR0880             FINISHED - EXIT                              
         DROP  R6                                                               
*&&                                                                             
*                                                                               
PAR0700  DS    0H                                                               
         GOTOR REJCMSGS                                                         
*                                  RETRIEVE HEADER OF AGY ORD                   
PAR0880  DS    0H                                                               
         MVC   KEY(L'SELECTKY),SELECTKY                                         
         GOTO1 HIGH                                                             
         GOTO1 GETREC                                                           
                                                                                
         L     R4,AIO                                                           
         USING RDARREC,R4                                                       
*                                                                               
         MVC   RDARBSTS,ACTCODE    SET STATUS TO ACTCODE                        
         CLI   ACTCODE,C'A'        ORDER APPROVED?                              
         BNE   PAR0900             NO  -                                        
         OI    RDARMISC,X'40'      YES - SET 'APPROVED AT LEAST ONCE'           
*                                                                               
PAR0900  EQU    *                                                               
         CLI   ACTCODE,C'R'        ORDER REJECTED?                              
         BNE   PAR0910             NO  -                                        
*                                                                               
         GOTOR ADDREJS,DMCB,(R4)                                                
PAR0910  EQU   *                                                                
         CLC   =C'AMEND',CONACT                                                 
         BNE   PAR0913                                                          
         MVI   RDARBSTS,C'M'       SET STATUS TO AMEND                          
         DROP  R4                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'0F'                                                     
         BRAS  RE,GETEL                                                         
         BNE   PAR0915             NO FLAG ELEMENT, SKIP                        
         USING RDARFLEM,R6         TURN OFF STACF FLAG                          
         NI    RDARFLG1,X'FF'-X'10'                                             
         DROP  R6                                                               
*                                                                               
PAR0913  EQU   *                                                                
         CLI   ACTCODE,C'A'        ORDER APPROVED?                              
         BNE   PAR0915             NO  -                                        
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'0F'                                                     
         BRAS  RE,GETEL                                                         
         BNE   PAR0915             NO FLAG ELEMENT, SKIP                        
         USING RDARFLEM,R6         TURN OFF -S FLAG                             
         NI    RDARFLG1,X'FF'-X'40'                                             
*                                                                               
         CLC   =C'#OPEN',CONACT    SPECIAL OPEN ACTION TO BYPASS                
         BNE   PAR0915             DIFFERENCES LOGIC TRIGGERED BY               
         OI    RDARFLG1,X'40'      A CONTRACT SEND ACTION                       
         DROP  R6                                                               
*                                  REWRITE RECORD WITH NEW STATUS               
PAR0915  EQU   *                                                                
         GOTOR WRITEREC                                                         
*                                                                               
         GOTOR DOAUDIT,DMCB,(R4)                                                
*                                                                               
         CLI   KATZEDI,C'Y'        SKIP MESSAGE FOR KATZ EDI ORDERS             
         BE    PAR0960                                                          
*                                  SEND MESSAGE: ORDER APPROVED                 
*                       1.3.5.7.9.1.3.5.7.9.1.3.5.                              
*        MVC   P(26),=C'*** END OF DDS MESSAGE ***'                             
*                                  SEND SPECIAL PRINT LINE                      
*        GOTO1 SPOOL,DMCB,(R8)                                                  
*        MVI   LINE,1              FORCE TO SINGLE PAGE                         
*                                                                               
PAR0920 DS     0H                                                               
         MVI   SPMODE,X'FF'        CLOSE THE PRINT QUEUE                        
         GOTO1 SPOOL,DMCB,(R8)                                                  
         MVI   LINE,1              FORCE TO SINGLE PAGE                         
*                                                                               
*                                  INSTEAD OF REJECT MESSAGE                    
*                                                                               
* SPECIAL FOR KATZ EDI ORDERS. IF ACTION IS APPROVE, ADD A PASSIVE KEY          
* X'E1' WITH CONTRACT # AND DATE/TIME STAMP INFO TO BE PICKED UP LATER          
* AT NIGHT BY A REPORT THAT WILL WRITE THESE ORDERS OUT TO TAPE                 
*                                                                               
PAR0960 DS     0H                                                               
         CLI   ACTCODE,C'A'        FOR ACTION APPROVE                           
         BNE   PARX                                                             
         CLI   KATZEDI,C'Y'        AND KATZ EDI ORDERS                          
         BNE   PAR0970                                                          
         GOTOR GENEDIKY                                                         
*                                                                               
PAR0970 DS     0H                                                               
         MVI   RMSGTYPE,C'I'                                                    
         LA    R2,CONSERVH         SET A(SERVICE REQUEST)                       
         MVC   RERROR,=AL2(113)    SET ERROR TYPE = APPROVED                    
         TM    SVDARFL2,SF2XML     XML ORDER?                                   
         BZ    *+10                                                             
         MVC   RERROR,=AL2(940)    SPECIAL MESSAGE FOR XML                      
*                                                                               
         CLI   ACTCODE,C'A'        APPROVED?                                    
         BE    PAR1000             YES                                          
         MVC   RERROR,=AL2(114)    SET ERROR TYPE = REJECTED                    
*                                                                               
PAR1000 EQU    *                                                                
         CLC   =C'#OPEN',CONACT    SPECIAL OPEN ACTION                          
         BE    PARX                JUST EXIT AND RETURN TO CONTRACT             
         LA    R2,CONRECH                                                       
         GOTO1 MYERROR                                                          
*                                                                               
PARX     DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* CREATES EDICT HEADER CARDS FOR EDICT PROCESSING                               
***********************************************************************         
         DS    0F                                                               
EDICT    NTR1  BASE=*,LABEL=*                                                   
         MVI   FORCEHED,C'N'       PREVENT HEADLINES                            
         MVI   LINE,0                                                           
         MVC   P+4(5),=C'*HDR*'                                                 
                                                                                
         MVC   P+9(14),=C'EDICT=*DDSDARR'                                       
                                                                                
*                                                                               
         MVI   P+34,C'W'           WIDE REPORT - 132 CHARS                      
*                                  SEND SPECIAL PRINT LINE                      
         GOTO1 SPOOL,DMCB,(R8)                                                  
*                                                                               
* PRINT A ++DDS CARD                                                            
*                                                                               
         LA    R3,P                                                             
         USING EDICTD,R3                                                        
         MVC   EDIDDSID,=C'++DDS'                                               
         MVI   EDISYST,C'D'        UPPER CASE 'D'                               
         MVC   EDIPROG,EDICTACT    INSERT EDICT 'ACTION'                        
         MVC   EDIIDEN,=C'TRN'     TRANSACTION DATA                             
                                                                                
*                                                                               
* INFORMATION CHUNK FOR ETI REPORTING                                           
*                                                                               
         MVC   KEY(L'SELECTKY),SELECTKY                                         
         GOTO1 HIGH                                                             
         MVC   AIO,AIO1                                                         
         GOTO1 GETREC                                                           
                                                                                
         L     R6,AIO              DARE RECORD                                  
         USING RDARREC,R6                                                       
         MVC   EDIRDRRP,RDARKREP   REP CODE                                     
         MVC   EDIRDRAG,RDARKAGY   AGENCY CODE                                  
         MVC   EDIRDRST,RDARKSTA   STATION CODE                                 
         MVC   EDIRDRMD,RDARMEDI   MEDIA CODE                                   
                                                                                
         EDIT  RDAREST#,(3,EDIRDRES),ALIGN=LEFT                                 
                                                                                
* AGENCY ORDER #                                                                
         ZAP   WORK2(5),=P'0'                                                   
         MVO   WORK2(5),RDARKORD                                                
         EDIT  (P5,WORK2),(8,EDIRDRAN),ALIGN=LEFT                               
                                                                                
* CONTRACT #                                                                    
         OC    RDARREP#,RDARREP#                                                
         BZ    EDICT10                                                          
         ZAP   WORK2(5),=P'0'                                                   
         MVO   WORK2(5),RDARREP#                                                
         EDIT  (P5,WORK2),(8,EDIRDRCN),ALIGN=LEFT                               
                                                                                
         L     R4,AIO3             RESET A(CONTRACT RECORD)                     
         USING RCONREC,R4                                                       
         MVC   EDIRDRSP,RCONSAL    SALESMAN CODE                                
         DROP  R4                                                               
                                                                                
EDICT10  DS    0H                                                               
         MVC   EDIRDRBY,RDARBUYC   BUYER CODE                                   
                                                                                
         MVI   ELCODE,X'02'        DESCRIPTIVE ELEMENT #2                       
         BRAS  RE,GETEL                                                         
         BNE   EDICT50                                                          
         USING RDARCLEM,R6                                                      
         MVC   EDIRDRCL,RDARCLI    CLIENT CODE                                  
         MVC   EDIRDRP1,RDARPRD1   PRODUCT CODE 1                               
         MVC   EDIRDRP2,RDARPRD2   PRODUCT CODE 2                               
         DROP  R3,R6                                                            
*                                  SEND SPECIAL PRINT LINE                      
EDICT50  DS    0H                                                               
         GOTO1 SPOOL,DMCB,(R8)                                                  
                                                                                
         MVI   LINE,1              FORCE TO SINGLE PAGE                         
                                                                                
EDICTX   DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
********************************************************************            
* GENERATE WORKSHEET                                                            
* PRIO SERVE AS A BUFFER TO CONSTRUCT THE PRINTLINE IN "SCREEN FORMAT"          
* THEN IT IS TRANSLATED TO THE REAL PQ PRINT LINE                               
* !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!               
* !!!NOTE: DO NOT USE PRIO, IT IS THE BUFFER OF THE PRINT LINE!!!               
* !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!               
********************************************************************            
PRDAO    NMOD1 PRWORKQ,*PRDAO*,CLEAR=YES                                        
         LR    R4,RC                                                            
         USING PRWORKD,R4                                                       
         L     RC,0(R1)                                                         
*                                                                               
         L     R8,ASPOOLD                                                       
         USING SPOOLD,R8                                                        
         USING PRWORKD,R4                                                       
         USING DIFFSUM,R2                                                       
*                                                                               
         MVC   PRBYTE(CLEARQ),DISFLG1   SAVE OFF THIS CHUNK                     
*                                                                               
         XC    DISFLG1(CLEARQ),DISFLG1  CLEAR THIS CHUNK                        
         MVC   PRSVSDTE,GRSTDATE                                                
         MVC   GRSTDATE,EARLIEST   RESET GRID START DATE                        
*                                                                               
         MVC   KEY(L'SELECTKY),SELECTKY                                         
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         MVC   AIO,AIO1                                                         
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
         MVC   REVNUM,RDARRNUM                                                  
         MVC   REVDATE,RDARDATE                                                 
         MVC   REVTIME,RDARTIME                                                 
         DROP  R6                                                               
*                                                                               
         TM    PRTSTAT,PRTCLOSE    CLOSE THE PRINTQ?                            
         BNO   *+12                NO                                           
         BAS   RE,PQCLOSE                                                       
         B     PRX                 CLEAN UP AFTER PRINTING                      
*                                                                               
         TM    PRTSTAT,PRTNEWPG    PQ OPEN?                                     
         BO    PR05                                                             
***TESTING                                                                      
*        MVC   *-4(2),=X'4710'                                                  
***TESTING                                                                      
         BAS   RE,PQOPEN           NO                                           
         B     *+8                                                              
PR05     DS    0H                                                               
         MVI   FORCEHED,C'Y'       YES - FORCEHEAD ON NEXT REPORT               
*                                                                               
         L     R1,=A(HEDSPECS)                                                  
         A     R1,RELO                                                          
         ST    R1,SPECS                                                         
*        LA    R1,HOOK                                                          
*        ST    R1,HEADHOOK                                                      
         LA    R1,*                                                             
         A     R1,=A(HOOK-(*-4))                                                
         ST    R1,HEADHOOK                                                      
*                                                                               
         MVI   METHOD,ADDBUYQ                                                   
         CLI   STAMETH,0                                                        
         BE    PR08A                                                            
         CLI   STAMETH,3                                                        
         BNE   PR08B                                                            
         MVI   METHOD,CHGBUYQ                                                   
         B     PR08B                                                            
*                                                                               
PR08A    DS    0H                                                               
         LR    R3,RA               USE R3 TO COVER THE ENTRY                    
         AHI   R3,DARPROFS-CONHEADH                                             
         USING SVDSECT,R3                                                       
*                                                                               
         TM    SVPGPBIT+CNTDRV3B,CNTDRV3A                                       
         BZ    PR08B                                                            
         MVI   METHOD,CHGBUYQ                                                   
*                                                                               
PR08B    DS    0H                                                               
         MVC   PRSVSDTE,GRSTDATE                                                
         MVC   GRSTDATE,EARLIEST                                                
         NI    PRTSTAT,X'FF'-PRTPAGE1                                           
         GOTOR PRPAGE1             PRINT PAGE HEADINGS                          
         OI    PRTSTAT,PRTPAGE1                                                 
*                                                                               
         XC    TSARREC,TSARREC                                                  
         MVI   TR.TLKTYP,X'0B'                                                  
         GOTO1 GOTSAR,TSARDH                                                    
         BL    PRX                                                              
*                                                                               
PR08     DS    0H                                                               
         NI    PRFLAG1,FF-PBUYDISQ                                              
*                                                                               
PR09     DS    0H                  LOOP POINT                                   
         XCEFL PRIO,L'PRIO                                                      
         LA    RF,PRIO                                                          
         AHI   RF,L'PRIO                                                        
         MVI   0(RF),FF                                                         
         ST    RF,GNXSVIOX                                                      
*                                                                               
         LA    R2,PRIO                                                          
         ST    R2,GNXSVIO                                                       
*                                                                               
PR10     DS    0H                                                               
         CLI   TR.TLKTYP,X'0B'                                                  
         BNE   PRX                                                              
         NI    PRFLAG1,FF-X'40'                                                 
*                                                                               
         MVC   PRTSRNUM,TB.TSRNUM                                               
         MVC   PRTXNUM,TB.TSRNUM   SAVE OFF CURRENT REC #                       
         MVC   PRWORK3,TSARREC                                                  
*                                                                               
         TM    TR.TLBYFLG3,X'80'                                                
*        BO    PR70                SKIP BUYS THAT MATCHES TOTALLY               
         BZ    PR10030                                                          
         OC    TR.TLBYMLNK,TR.TLBYMLNK                                          
         BZ    PR70                                                             
         B     PR30                                                             
*                                                                               
PR10030  DS    0H                                                               
         GOTOR ZEROSPT                                                          
         BE    PR70                YES, SKIP                                    
*                                                                               
PR10050  DS    0H                                                               
         CLI   TR.TLBYTYPA,TLTYPAQ                                              
         BNE   PR10100             SKIP AGENCY LINK SEGMENT                     
         TM    TR.TLBYFLG4,X'10'   ADD-TO-SKED?                                 
         BZ    PR70                NO - SKIP                                    
*                                                                               
PR10100  OI    PRFLAG1,PBUYDISQ    AT LEAST ONE SEGMENT MAKE IT TO              
*                                  DISPLAY, THOUGH IT COULD BE                  
         GOTOR VALSEG                                                           
         BZ    PR70                OVERRIDEN BECAUSE OF MPU OPTION              
*                                                                               
         CLC   SVTYPE,TR.TLBYFLG WE NEED TO BREAK ON                            
         BE    PR30                DIFFERENT SECTIONS                           
*                                                                               
         CLI   SVTYPE,TLLNKQ                                                    
         BNE   *+12                                                             
         CLI   TR.TLBYFLG,TLMTHQ2                                               
         BE    PR15                                                             
*                                                                               
         GOTOR DISECTN,DMCB,(R2)   DISPLAY SECTION HEADER                       
         XC    PRIO(256),PRIO                                                   
*                                                                               
PR15     DS    0H                                                               
         MVC   SVTYPE,TR.TLBYFLG SAVE OFF TYPE                                  
*                                                                               
*PR20     DS    0H                                                              
*                                                                               
         USING DIFFSUM,R2                                                       
*                                                                               
PR30     DS    0H                                                               
         MVC   PRWORK2,TSARREC                                                  
         TM    TR.TLBYFLG3,X'80'                                                
         BO    PR33                                                             
*                                                                               
PR30C    DS    0H                                                               
         NI    OVRDFLG,FF-OVPGMQ                                                
         GOTOR COMPPGM                                                          
         BE    *+8                                                              
         OI    OVRDFLG,OVPGMQ                                                   
*                                                                               
         GOTOR GETNDX              RETREIVE INDEXED ITEMS                       
         L     R0,DMCB                                                          
*                                                                               
         TM    TR.TLBYFLG4,X'44'   ORPHAN SEGMENT?                              
         BNZ   PR31                YES,DUMMY UP AGENCY BUY WITH 0 SPTS          
*                                                                               
         OC    TR.TLBYMLNK,TR.TLBYMLNK                                          
         BZ    *+8                                                              
         OI    DISFLG3,D3MINI                                                   
*                                                                               
         CLI   TR.TLBYFLG,TLMTHQ   MATCH?                                       
         BNE   PR32                NO                                           
         CLI   TR.TLBYLNK,0        NO LINK, SYSTEM MATCH=DONE                   
         BE    PR43                NEXT                                         
*                                                                               
         OC    TR.TLBYALNK,TR.TLBYALNK                                          
         BZ    PR31                                                             
         OC    TR.TLBYRLNK,TR.TLBYRLNK                                          
         BNZ   PR43                MATCH = DONE                                 
*                                                                               
PR31     DS    0H                                                               
         LR    R2,R0               USER MATCH, PUSH R2 FORWARD                  
         OI    PRFLAG1,X'80'                                                    
         B     PR33                READ THE NEXT HALF                           
*                                                                               
PR32     DS    0H                                                               
         GOTOR TRANLINE,DMCB,PRIO   TRANSLATE BUFFER TO PRINT LINE              
*                                                                               
PR33     DS    0H                                                               
         MVC   PRWORK,TSARREC      SAVE OFF CURRENT BUY SEGMENT                 
*                                                                               
         TM    TR.TLBYFLG4,X'44'   CANCELLATION                                 
         BNZ   PR3500                                                           
         CLI   TR.TLBYTYPA,TLTYPAQ AGY SEG OF THE PAIR                          
         BE    PR70                NEXT                                         
         CLI   TR.TLBYLNK,0                                                     
         BE    PR45                NEXT                                         
         TM    TR.TLBYFLG3,X'10'   MATCHED DAILY/C.O?                           
         BZ    PR3390                                                           
*                                                                               
         MVC   PRWORK2,TSARREC                                                  
         MVC   TXNUM,PRTSRNUM                                                   
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         XC    TSARREC,TSARREC                                                  
*                                                                               
PR3330   DS    0H                                                               
         GOTO1 GOTSAR,TSANXT                                                    
         CLC   TSARREC+2(TLBYMLNK-TLKTYP),PRWORK3+2                             
         BNE   PR3380                                                           
         TM    TR.TLBYFLG3,X'80'                                                
         BO    PR3330              LOOP                                         
         MVC   TSARREC,PRWORK2                                                  
*                                                                               
         TM    PRFLAG1,X'80'                                                    
         BZ    PR3390                                                           
         GOTOR TRANLINE,DMCB,PRIO                                               
         B     PR70                                                             
*                                                                               
PR3380   DS    0H                                                               
         MVC   TSARREC,PRWORK2                                                  
PR3390   DS    0H                                                               
         MVI   BYTE,TLLNKQ                                                      
         CLI   TR.TLBYFLG,TLLNKQ   LINK/MATCH SEGMENTS NEED TO                  
         BE    PR35                RETRIEVE THE AGENCY LINE                     
         MVI   BYTE,TLMTHQ                                                      
         CLI   TR.TLBYFLG,TLMTHQ                                                
         BNE   PR70                                                             
*                                                                               
         MVC   COMPTSAR,TSARREC                                                 
         TM    TR.TLBYFLG3,X'10'   MATCHED DAILY/C.O?                           
         BZ    *+10                                                             
         XC    COMPTSAR,COMPTSAR                                                
*                                                                               
PR35     DS    0H                                                               
         TM    TR.TLBYFLG4,X'40'   ORPHAN SEGMENT                               
         BO    PR3500                                                           
*                                                                               
         MVC   TSARREC2,TSARREC                                                 
         MVC   PRWORK,TSARREC      SAVE OFF CURRENT BUY SEGMENT                 
         XC    TSARREC,TSARREC                                                  
TR2      USING TLSTD,TSARREC2                                                   
*                                                                               
         MVI   TR.TLKTYP,X'0B'                                                  
         MVC   TR.TLBYFLG,BYTE                                                  
         MVI   TR.TLBYTYPA,TLTYPAQ                                              
         MVC   TR.TLBYLNK,TR2.TLBYLNK                                           
         MVC   SAVEKEY(L'TSARKEY),TSARREC+2                                     
*                                                                               
         GOTO1 GOTSAR,TSARDH                                                    
         CLC   TSARREC+2(TLBYMLNK-TLKTYP),SAVEKEY                               
         BE    PR3504                                                           
         CLI   TR2.TLBYMLNK,0                                                   
         BE    PR3503                                                           
*                                                                               
         TM    DISFLG3,D3EOGRP     END OF GROUP?                                
         BO    PR3502              YES                                          
*                                                                               
*    FAKE AGY COMPONENT WITH ZERO SPOTS                                         
*                                                                               
         MVC   TSARREC,TSARREC2                                                 
         TM    TR.TLBYFLG4,X'40'   CANCELLED REP BUYS?                          
         BZ    PR70                                                             
*                                                                               
PR3500   OI    CFLAG,CFKAGYQ       SET "FAKING AGY LINE" FLAG - DAILY           
         GOTOR GETNDX              DISPLAY THE REP LINE AGAIN                   
         L     R2,DMCB                                                          
*                                                                               
         NI    CFLAG,X'FF'-CFKAGYQ                                              
*                                                                               
         CLI   DISFLG2,DMATCHQ                                                  
         BNE   PR43                                                             
*                                                                               
         TM    TR.TLBYFLG4,X'44'   CANCELLED REP BUYS?                          
         BNZ   PR3501                                                           
         OC    TR2.TLBYALNK,TR2.TLBYALNK                                        
         BNZ   PR70                AGY LINE DISPLAYED ALREADY - SKIP            
*                                                                               
PR3501   OI    OVRDFLG,OVCNCLQ     NO, THIS IS A REP LINE WITHOUT               
         GOTOR DISOVRD,DMCB,(X'80',(R2))  AGY LINE TO MATCH UP TO               
         L     R2,DMCB             UPDATE NEXT SCREEN LINE                      
         B     PR43                SO IT SHOULD BE CANCELLED.                   
*                                                                               
PR3502   DS    0H                                                               
         NI    DISFLG3,FF-D3MINI                                                
         B     PR70                                                             
*                                                                               
PR3503   DS    0H                                                               
         DC    H'0'                                                             
*                                                                               
PR3504   DS    0H                                                               
         CLI   TR2.TLBYMLNK,0      DAILY/C.O?                                   
         BE    PR40                NO,NO NEED TO LOOP                           
         LH    R3,COUNT1                                                        
         CHI   R3,0                                                             
         BE    PR40                                                             
*                                                                               
PR3506   DS    0H                                                               
         GOTO1 GOTSAR,TSANXT       LOOP UNTIL WE GOT THE RIGHT ONE              
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         BCT   R3,PR3506                                                        
*                                                                               
PR3508   DS    0H                                                               
         CLC   TSARREC+2(TLBYMLNK-TLKTYP),SAVEKEY                               
         BE    PR40                                                             
         NI    DISFLG3,FF-D3MINI                                                
         TM    DISFLG3,D3EOGRP                                                  
         BO    PR43                                                             
         CLI   DISFLG2,DMATCHQ                                                  
         BNE   PR43                                                             
*                                                                               
         OI    OVRDFLG,OVCNCLQ     NO, REP LINE WILL BE CANCELLED               
         GOTOR DISOVRD,DMCB,(X'80',(R2))                                        
         NI    OVRDFLG,FF-OVCNCLQ  CLEAR FLAG                                   
         L     R2,DMCB             UPDATE NEXT SCREEN LINE                      
*                                                                               
         B     PR43                                                             
*                                                                               
PR3510   DS    0H                                                               
*                                                                               
PR40     DS    0H                                                               
         MVC   PRWORK2,TSARREC                                                  
         OI    PRFLAG1,PBUYDISQ    AT LEAST ONE SEGMENT MAKE IT TO              
         GOTOR GETNDX                                                           
*                                                                               
         L     R2,DMCB                                                          
*                                                                               
         LH    RF,COUNT1                                                        
         AHI   RF,1                INCREASE COUNTER                             
         STH   RF,COUNT1                                                        
*                                                                               
         MVC   TXNUM,PRTSRNUM                                                   
         GOTO1 GOTSAR,TSAGET                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
         XC    TSARREC,TSARREC                                                  
*                                                                               
PR4030   DS    0H                                                               
         GOTO1 GOTSAR,TSANXT                                                    
         CLC   TSARREC+2(TLBYMLNK-TLKTYP),PRWORK3+2                             
         BNE   PR4050                                                           
         TM    TR.TLBYFLG3,X'80'                                                
         BO    PR4030              LOOP                                         
         B     PR4080                                                           
*                                                                               
PR4050   DS    0H                                                               
         OI    DISFLG3,D3EOGRP     END OF GROUP                                 
*                                                                               
PR4080   DS    0H                                                               
         MVC   TSARREC,PRWORK2                                                  
*                                                                               
         TM    DISFLG3,D3EOGRP                                                  
         BZ    PR43                                                             
*                                                                               
         XC    COMPTSAR,COMPTSAR   COMPARE TO NADA                              
         GOTO1 GOTSAR,TSARDH       RESTORE SEQUENCE                             
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   SAVEKEY,TSARREC+2                                                
         GOTO1 GOTSAR,TSANXT       READ NEXT                                    
         BE    PR3508                                                           
         DC    H'0'                                                             
*                                                                               
PR43     DS    0H                                                               
         GOTOR TRANLINE,DMCB,PRIO   TRANSLATE BUFFER TO PRINT LINE              
*                                                                               
PR45     DS    0H                                                               
         TM    MYFLAG1,X'80'        ONE AGENCY LINE IS DISPLAYED                
         BZ    PR60                                                             
*                                                                               
         NI    MYFLAG1,X'FF'-X'80'                                              
         GOTOR AGYCMT,DMCB,(RC),PRIO,PRWORK2   READ AGENCY COMMENT              
         GOTOR TRANLINE,DMCB,PRIO   TRANSLATE BUFFER TO PRINT LINE              
         DC    X'0770'                                                          
*                                                                               
PR60     DS    0H                                                               
         MVI   SPACING,1                                                        
         BAS   RE,PRINT                                                         
*                                                                               
PR70     DS    0H                                                               
         MVC   TXNUM,PRTSRNUM                                                   
         XC    TSARREC,TSARREC                                                  
         GOTO1 GOTSAR,TSANXT                                                    
         BL    PR80                                                             
         CLI   TR.TLKTYP,X'0B'                                                  
         BE    PR300                                                            
*                                                                               
PR80     XC    PRTXNUM,PRTXNUM                                                  
         B     PR300                                                            
*                                                                               
PR300    DS    0H                                                               
         CLC   PRWORK3+2(TLBYMLNK-TLKTYP),TSARREC+2                             
         BE    *+14                                                             
         NI    DISFLG3,FF-D31STREP-D3MINI-D3EOGRP                               
         XC    COUNT1,COUNT1   CLEAR ON NEXT GROUP                              
*                                                                               
         OC    PRTXNUM,PRTXNUM     NULL IF ALL DONE PRINTING                    
         BZ    PRX                                                              
         B     PR09                                                             
         EJECT                                                                  
*                                                                               
PRX      DS    0H                                                               
         TM    PRFLAG1,PBUYDISQ                                                 
         BO    PRX10                                                            
         GOTOR EMPTY                                                            
PRX10    DS    0H                                                               
         GOTOR PRTCOMMT            PRINT COMMENT                                
         MVC   DISFLG1(KEEPQ),PRBYTE   RESTORE THIS CHUNK                       
         MVC   GRSTDATE,PRSVSDTE                                                
         B     EXIT                                                             
         EJECT                                                                  
         DROP  R4                                                               
         DROP  R2                                                               
***********************************************************************         
* REPORT CONTRACT SPECS                                                         
***********************************************************************         
HEDSPECS DS    0H                                                               
         SPROG 0                                                                
         PSPEC H1,1,AGYNAME                                                     
         PSPEC H1,120,PAGE                                                      
         PSPEC H2,91,REQUESTOR                                                  
         SPACE 1                                                                
         DC    X'00'                                                            
         EJECT                                                                  
***********************************************************************         
* CLOSE PRINTQ                                                                  
***********************************************************************         
PQCLOSE  NTR1                                                                   
         MVI   SPMODE,X'FF'                                                     
         GOTO1 SPOOL,DMCB,(R8)                                                  
         B     EXIT                                                             
***********************************************************************         
* OPEN PRINTQ AND SET HEADSPECS/HOOK                                            
***********************************************************************         
PQOPEN   NTR1                                                                   
         OI    GENSTAT3,NOCLRSPK                                                
         MVC   REMUSER,=C'DAO'     DARE AGENCY ORDER                            
*                                                                               
         OC    REQINIT,REQINIT     CHECK IF OVERRIDE REPORT NAME                
         BZ    *+10                                                             
         MVC   REMUSER,REQINIT                                                  
*&&DB                                                                           
         MVC   REMUSER,=C'DBR'     DEBUG REPORT                                 
*&&                                                                             
         LA    RF,SPOOLKEY                                                      
         USING PQPLD,RF                                                         
         XC    SPOOLKEY,SPOOLKEY                                                
         MVC   PLDESC,=C'WORKSHEET  '                                           
         MVI   PLCLASS,C' '                                                     
         OI    SPOOLIND,SPUINIT    PERMITS SETTING OF CLASS                     
         MVC   PLSUBID,=C'DAO'     DARE AGENCY ORDER                            
*                                                                               
         OC    REQINIT,REQINIT     CHECK IF OVERRIDE REPORT NAME                
         BZ    *+10                                                             
         MVC   REMUSER,REQINIT                                                  
*&&DB                                                                           
         MVC   PLSUBID,=C'DBR'     DEBUG REPORT                                 
*&&                                                                             
         DROP  RF                                                               
*                                                                               
         LA    RE,SPLKEYAD                                                      
         ST    RE,SPOOLQLK         SET EXTENDED KEY ADDRESS                     
         USING PQPLD,RE                                                         
         XC    0(133,RE),0(RE)                                                  
         MVI   QLEXTRA,X'FF'                                                    
         MVC   QLRETNL,=H'6'                                                    
         MVC   QLRETND,=H'2'                                                    
         MVC   QLRETNL,=H'36'                                                   
         MVI   QLSYS,C'R'          FORM/COPIES COLUMN                           
         MVC   QLPRG,=C'CO'                                                     
         DROP  RE                                                               
*                                                                               
         GOTO1 OPENPQ                                                           
*                                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* PRINT COMMENTS                                                                
***********************************************************************         
PRTCOMMT NTR1                                                                   
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
         TM    CMTFLAG,CMTSTAND+CMTORD+CMTREJ                                   
         BNZ   PCOM100                                                          
         CLI   RDARCORT,C'T'                                                    
         BNE   PCOMTX                                                           
*                                                                               
PCOM100  DS    0H                                                               
         BAS   RE,PRINT                                                         
         MVI   P,C'-'                                                           
         MVC   P+1(L'P-1),P                                                     
         MVC   P(22),=C'*** START OF COMMENTS '                                 
         BAS   RE,PRINT                                                         
*                                                                               
         CLI   RDARCORT,C'T'                                                    
         BNE   PCOM150                                                          
         MVC   P(21),=C'This is a TRADE ORDER'                                  
         BAS   RE,PRINT                                                         
         TM    CMTFLAG,CMTSTAND+CMTORD+CMTREJ                                   
         BZ    PCOMTX                                                           
         DROP  R6                                                               
*                                                                               
PCOM150  DS    0H                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(RDARKRT-RDARKEY),SELECTKY                                    
         LA    R6,KEY                                                           
         USING RDARKEY,R6                                                       
         MVI   RDARKRT,X'20'       TYPE STANDARD COMMENT                        
         DROP  R6                                                               
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(L'RDARKEY),KEYSAVE                                           
         BNE   PCOM190             IF STANDARD COMMENT                          
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         BAS   RE,PRTSTCMT                                                      
                                                                                
* PRINT ORDER COMMENTS, IF ANY                                                  
PCOM190  DS    0H                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(RDARKRT-RDARKEY),SELECTKY                                    
         LA    R6,KEY                                                           
         USING RDARKEY,R6                                                       
         MVI   RDARKRT,X'30'       TYPE ORDER COMMENT                           
         DROP  R6                                                               
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(L'RDARKEY),KEYSAVE                                           
         BNE   PCOM200             IF ORDER COMMENT                             
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         BAS   RE,PRTORCMT                                                      
                                                                                
PCOM200  DS    0H                  PRINT REJECTION CMTS IF REQUESTED            
         XC    KEY,KEY                                                          
         MVC   KEY(RDARKRT-RDARKEY),SELECTKY                                    
         LA    R6,KEY                                                           
         USING RDARKEY,R6                                                       
         MVI   RDARKRT,X'10'       REJECT CMT IS IN THE HEADER                  
         DROP  R6                                                               
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(L'RDARKEY),KEYSAVE                                           
         BNE   PCOM210                                                          
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   PCOM210             IF REJECT COMMENT                            
         BAS   RE,PRTREJCT                                                      
                                                                                
PCOM210  DS    0H                                                               
         BAS   RE,PRINT                                                         
*                                                                               
PCOMTX   DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* PRINT STANDARD COMMENTS                                                       
***********************************************************************         
PRTSTCMT NTR1                                                                   
         BAS   RE,PRINT                                                         
         MVC   P(24),=C'AGENCY STANDARD COMMENT:'                               
         BAS   RE,PRINT                                                         
                                                                                
PRTST10  DS    0H                                                               
         L     R6,AIO                                                           
         USING RDARSCEL,R6                                                      
         MVI   ELCODE,2                                                         
         BRAS  RE,GETEL                                                         
         BNE   PRTSTX                                                           
                                                                                
PRTST20  DS    0H                                                               
         ZIC   R1,RDARSCLN                                                      
         CLI   RDARSCLN,3                                                       
         BL    *+8                                                              
         SH    R1,=H'3'                                                         
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   P+7(0),RDARSCCM                                                  
         BAS   RE,PRINT                                                         
         BRAS  RE,NEXTEL                                                        
         BE    PRTST20                                                          
         DROP  R6                                                               
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
                                                                                
         CLC   KEY(RDARKSEQ-RDARKEY),KEYSAVE                                    
         BNE   PRTSTX                                                           
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         B     PRTST10                                                          
                                                                                
PRTSTX   DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* PRINT ORDER COMMENTS                                                          
***********************************************************************         
PRTORCMT NTR1                                                                   
         BAS   RE,PRINT                                                         
         MVC   P(21),=C'AGENCY ORDER COMMENT:'                                  
         BAS   RE,PRINT                                                         
                                                                                
PRTOR10  DS    0H                                                               
         L     R6,AIO                                                           
         USING RDAROREL,R6                                                      
         MVI   ELCODE,2                                                         
         BRAS  RE,GETEL                                                         
         BNE   PRTORX                                                           
                                                                                
PRTOR20  DS    0H                                                               
         ZIC   R1,RDARORLN                                                      
         CLI   RDARORLN,3                                                       
         BL    *+8                                                              
         SH    R1,=H'3'                                                         
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   P+7(0),RDARORCM                                                  
         BAS   RE,PRINT                                                         
         BRAS  RE,NEXTEL                                                        
         BE    PRTOR20                                                          
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 SEQ                                                              
                                                                                
         CLC   KEY(RDARKSEQ-RDARKEY),KEYSAVE                                    
         BNE   PRTORX                                                           
                                                                                
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         B     PRTOR10                                                          
                                                                                
PRTORX   DS    0H                                                               
         B     EXIT                                                             
         DROP  R6                                                               
         EJECT                                                                  
***********************************************************************         
* PRINT REJECTION COMMENTS                                                      
***********************************************************************         
PRTREJCT NTR1                                                                   
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   PRTREJX                                                          
         USING RDARRCEM,R6                                                      
                                                                                
         BAS   RE,PRINT                                                         
         MVC   P(22),=C'REP REJECTION COMMENT:'                                 
         BAS   RE,PRINT                                                         
                                                                                
PRTREJ10 DS    0H                                                               
         CLI   RDARRCEN,2                                                       
         BNH   PRTREJ20                                                         
         ZIC   R1,RDARRCEN                                                      
         SH    R1,=H'3'                                                         
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   P+7(0),RDARRCCM                                                  
                                                                                
PRTREJ20 DS    0H                                                               
         BAS   RE,PRINT                                                         
         BRAS  RE,NEXTEL                                                        
         BE    PRTREJ10                                                         
                                                                                
PRTREJX  DS    0H                                                               
         B     EXIT                                                             
         DROP  R6                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*   APPRREJC:  APPROVAL/REJECTION HEADER OUTPUT                                 
***********************************************************************         
         DS    0F                                                               
APPRREJC NTR1  BASE=*,LABEL=*                                                   
         LA    R4,P                SET PRINT OUTPUT                             
         USING ORDAPREJ,R4                                                      
*                                                                               
         CLI   ACTCODE,C'A'        APPROVAL?                                    
         BNE   APRJ0020            NO  -  REJECT                                
         MVC   ARTRANID,=C'ORDAPP'                                              
         B     APRJ0040                                                         
APRJ0020 EQU   *                                                                
         MVC   ARTRANID,=C'ORDREJ'                                              
APRJ0040 EQU   *                                                                
*                                  INSERT IDENTIFIER                            
         MVC   ARORDNUM,RETORD#    INSERT ORDER NUMBER                          
         MVC   ARFROM,RETTO        INSERT FROM CODE                             
         MVC   ARTO,RETFROM        INSERT TO CODE                               
*                                     NOTE:  CODES ARE REVERSED                 
         GOTO1 DATCON,DMCB,(5,WORK),(X'20',ARDATE)                              
*                                  INSERT TODAY'S DATE                          
         THMS  DDSTIME=YES                                                      
         ST    R0,DUB              ACTUAL TIME ADJUSTMENT                       
         ST    R1,DUB+4            DDS TIME                                     
         AP    DUB(4),DUB+4(4)                                                  
         ICM   R1,15,DUB                                                        
         SRL   R1,12               SHIFT OFF SECONDS AND SIGN                   
         STCM  R1,3,WORK                                                        
         GOTO1 HEXOUT,DMCB,WORK,ARTIME,2,0                                      
*                                                                               
         MVC   ARSTAT(6),RETSTAT   INSERT STATION                               
*&&DO                                                                           
         CLI   ARSTAT+4,C'A'       GET UID FROM STATION RECORD FOR              
         BE    APRJ0043            RADIO EDI                                    
         CLI   ARSTAT+4,C'F'       GET UID FROM STATION RECORD FOR              
         BNE   APRJ0045            RADIO EDI                                    
*                                                                               
APRJ0043 EQU   *                                                                
         GOTOR GETUID,DMCB,ARSTAT                                               
*&&                                                                             
*                                                                               
APRJ0045 EQU   *                                                                
         MVC   ARCON#,RETCON#      INSERT CONTRACT #                            
*                                                                               
*        CLC   =C'AMEND',CONACT                                                 
*        BNE   APRJ0050                                                         
*        MVC   ARCON#,SPACES                                                    
*        MVC   ARCON#(5),=C'AMEND' AMEND NOTICE?                                
*                                                                               
APRJ0050 EQU   *                                                                
         MVC   ARRETSND,RETSENDR   INSERT 'RET TO SENDER' INFO                  
****>>>> MVC   ARDDS,=C'DDS'       INSERT LINE DELIMITER                        
*                                                                               
         GOTO1 SPOOL,DMCB,(R8)     SEND THE MESSAGE                             
         MVI   LINE,1              FORCE TO SINGLE PAGE                         
*                                                                               
         CLI   ACTCODE,C'A'        APPROVAL?                                    
         BE    APRJ0320            APPROVED:  DON'T UPDATE CONTRACT             
*                                     STATUS FLAG HERE...                       
*                                                                               
*                                  SET 'ORDER REJECTED' FLAG                    
*                                     IN CONTRACT RECORD AND REWRITE            
*&&DO                                                                           
         MVC   AIO,AIO3            SET A(IO AREA)                               
         L     R2,AIO3                                                          
         USING RCONREC,R2                                                       
*                                                                               
         OC    RCONREC(L'RCONKEY),RCONREC                                       
         BZ    APRJ0320            ORDER IS UNLINKED                            
*                                                                               
         MVC   KEY(27),RCONREC     GET KEY FROM CONTRACT RECORD                 
         MVC   KEYSAVE,KEY         DON'T RETURN DELETED RECORDS                 
         GOTO1 HIGH                                                             
         CLC   KEYSAVE(27),KEY     REDUNDANT CHECK: KEY FOUND?                  
         BNE   APRJ0320                       NO  - EXIT                        
         GOTO1 GETREC              READ CONTRACT                                
*                                                                               
         LA    R6,RCONREC                                                       
         MVI   ELCODE,X'1D'        RETRIEVE                                     
         BRAS  RE,GETEL                                                         
         BE    APRJ0160            FOUND: UPDATE IT                             
         XC    ELTBUILD,ELTBUILD   NOT FOUND: BUILD IT                          
         MVI   ELTBUILD,X'1D'      INSERT ELEMENT CODE                          
         LA    RF,RCONDL2Q                                                      
         STC   RF,ELTBUILD+1       INSERT ELEMENT LENGTH                        
         OI    ELTBUILD+2,X'20'    SET 'REJECTED' FLAG                          
*                                                                               
         CLI   DIFHDLNH+5,0        ANY CONTRACT NUMBER ON SCREEN?               
         BE    *+8                                                              
         OI    ELTBUILD+2,X'80'    YES, SET 'LINKED' FLAG                       
*                                                                               
         GOTO1 HEXIN,DMCB,RETORD#,ELTBUILD+3,8                                  
*                                  INSERT HEX VALUE OF AGY ORD #                
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),RCONREC,ELTBUILD,         X        
               =C'ADD=CODE'                                                     
         B     APRJ0200                                                         
APRJ0160 EQU   *                                                                
         MVI   2(R6),X'A0'         SET 'REJECTED+LINKED' FLAGS, CLEAR           
*                                     ANY PREVIOUS VALUE                        
APRJ0200 EQU   *                                                                
         GOTO1 PUTREC              WRITE UPDATED RECORD TO FILE                 
         DROP  R2,R4                                                            
*                                                                               
*&&                                                                             
APRJ0320 EQU   *                                                                
         B     EXIT                                                             
*                                                                               
         DROP  R4                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*&&RD                                                                           
*                                                                               
*   GETSALNM :  RETRIEVE SALESPERSON NAME FOR UNLINKED REJECTIONS               
*               ON EXIT, WORK HAS EXPANDED NAME                                 
*                                                                               
         DS    0F                                                               
GETSALNM NTR1  BASE=*,WORK=(R4,500),LABEL=*                                     
         L     R2,AIO              SAVE CURRENT AIO                             
         ST    R4,AIO                                                           
*                                                                               
         L     R6,AIO1             CHECK IF WE NEED TO SEND                     
         MVI   ELCODE,X'0A'        SALESPERSON/POINTPERSON                      
         BRAS  RE,GETEL            FOR BOTH OPEN/REJECT                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING RDARPPEL,R6                                                      
*                                                                               
         XC    KEY,KEY             GET SALESPERSON NAME                         
         XC    WORK,WORK                                                        
         LA    R3,KEY                                                           
         USING RSALREC,R3                                                       
         MVI   RSALKTYP,X'06'                                                   
         MVC   RSALKREP,AGENCY                                                  
         MVC   RSALKSAL,RDARPPSP                                                
         DROP  R6                                                               
*                                                                               
         L     R6,AIO1             CHECK IF UNWIRED                             
         MVI   ELCODE,X'0F'        YES, NEED TO GET POINTPERSON                 
         BRAS  RE,GETEL            FOR BOTH OPEN/REJECT                         
         BNE   GSAL10                                                           
         USING RDARFLEM,R6                                                      
         TM    RDARFLG1,X'01'      UNWIRED?                                     
         BZ    GSAL10                                                           
         DROP  R6                                                               
*                                                                               
         MVI   RSALKTYP,X'31'                                                   
*                                                                               
GSAL10   DS    0H                                                               
*                                                                               
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(27),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
         L     R3,AIO                                                           
         MVC   WORK(L'RSALNAME),RSALNAME                                        
         DROP  R3                                                               
         ST    R2,AIO              RESTORE AIO                                  
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*&&                                                                             
*                                                                               
*                                                                               
*   REJCMSGS:  REJECTION MESSAGES                                               
*                                                                               
         DS    0F                                                               
REJCMSGS NTR1  BASE=*,LABEL=*                                                   
         LA    RF,REJMESS          SET A(REJECTION MESSAGES)                    
         ST    RF,AREJMESS                                                      
*                                                                               
         SR    R4,R4               LINE COUNTER                                 
*&&RD                                                                           
         L     R6,AIO1             CHECK IF WE NEED TO SEND                     
         MVI   ELCODE,X'0A'        SALESPERSON/POINTPERSON                      
         BRAS  RE,GETEL            FOR BOTH OPEN/REJECT                         
         BNE   REMS0003                                                         
         USING RDARPPEL,R6                                                      
         CLC   RDARPPSP,SPACES                                                  
         BE    REMS0003                                                         
*                                                                               
         GOTOR GETSALNM                                                         
*                                                                               
         XC    P,P                 CLEAR PRINT LINE                             
         LA    R2,P                                                             
         USING ORDSAL,R2                                                        
         MVC   OSTRANID,=C'ORDSAL'                                              
         MVC   OSORDNUM,RETORD#                                                 
         MVC   OSSPPCDE,RDARPPSP                                                
         MVC   OSSPPNME,WORK                                                    
         DROP  R2,R6                                                            
*                                                                               
         LA    R4,1(R4)            COUNT LINE                                   
         GOTO1 SPOOL,DMCB,(R8)                                                  
         MVI   LINE,1              FORCE TO SINGLE PAGE                         
*                                                                               
REMS0003 DS    0H                                                               
         CLI   ACTCODE,C'A'        IF APPROVE/OPEN                              
         BNE   REMS0005            PRINT TRAILER AND EXIT                       
*        LTR   R4,R4               ANY SALESPERSON/POINTPERSON CODE             
*        BZ    EXIT                PRINTED?                                     
         XC    P,P                                                              
         LA    R6,P                                                             
         USING ORDCOM,R6           YES, NEED TO GENERATE TRAILER                
         USING ORDTRLR,R6                                                       
         MVC   OTTRANID,=C'ORDTLR'                                              
         MVC   OTORDNUM,RETORD#                                                 
         LA    R4,2(R4)            ADD 1 EACH FOR HDR, TRLR                     
         EDIT  (R4),(6,OTCOUNT),FILL=0,ZERO=NOBLANK                             
         GOTO1 SPOOL,DMCB,(R8)                                                  
         MVI   LINE,1              FORCE TO SINGLE PAGE                         
         B     EXIT                                                             
         DROP  R6                                                               
*                                                                               
REMS0005 DS    0H                                                               
         CLC   =C'AMEND',CONACT    SEND AMEND NOTICE?                           
         BNE   REMS0010                                                         
*                                                                               
         XC    P,P                 CLEAR PRINT LINE                             
         LA    R6,P                                                             
         USING ORDCOM,R6                                                        
         MVC   OCTRANID,=C'ORDCOM'                                              
         MVC   OCORDNUM,RETORD#                                                 
         MVI   OCCONTIN,C'*'                                                    
         MVC   OCCOMMNT(13),=C'*** AMEND ***'                                   
         LA    R4,1(R4)            COUNT LINE                                   
         GOTO1 SPOOL,DMCB,(R8)                                                  
         MVI   LINE,1              FORCE TO SINGLE PAGE                         
*&&                                                                             
*                                                                               
*                                                                               
*   LINES ON SCREEN ARE COUNTED, TO DETERMINE WHERE '*' CONTINUATION            
*     MARKS ARE TO BE PLACED.  BLANK LINES WITHIN THE BODY OF THE               
*     REJECTION COMMENTS ARE SKIPPED.  THESE ARE THEN SKIPPED OVER              
*     WHEN THE SCREEN IS FORMATTED INTO THE OUTPUT MESSAGES.                    
*                                                                               
REMS0010 EQU   *                                                                
         LA    R2,AORREASH         MESSAGE HEADER                               
         LA    R3,AORENDH          LAST                                         
         SR    R6,R6                                                            
REMS0020 EQU   *                                                                
         CLI   5(R2),0             ANYTHING ON LINE?                            
         BE    REMS0040            NO  - DON'T COUNT LINE                       
         LA    R6,1(R6)            YES - COUNT LINE                             
REMS0040 EQU   *                                                                
         LA    R2,AORREA2H-AORREASH(R2)                                         
*                                  BUMP TO NEXT LINE                            
         CR    R2,R3               END OF SCREEN REACHED?                       
         BNH   REMS0020            NO  - GO BACK FOR NEXT                       
*                                                                               
         LR    R3,R6               SET UP LOOP                                  
         LTR   R3,R3               ANY REJECT LINES?                            
         BZ    REMS0100            NO                                           
*                                                                               
         XC    P,P                 CLEAR PRINT LINE                             
         LA    R6,P                                                             
         USING ORDCOM,R6                                                        
*                                                                               
         LA    R2,AORREASH                                                      
REMS0080 EQU   *                                                                
         BAS   RE,MSGCHECK         OUTPUT PREVIOUS LINE?                        
         MVC   OCTRANID,=C'ORDCOM'                                              
         MVC   OCORDNUM,RETORD#                                                 
REMS0090 EQU   *                                                                
         ZIC   RF,5(R2)            GET LENGTH OF LINE                           
         LTR   RF,RF               ANYTHING ON LINE?                            
         BNZ   REMS0095            YES                                          
         ST    RF,DMCB+8           INSERT LENGTH (ZERO) INTO P3                 
         GOTO1 REJMSGS,DMCB,(RC),0                                              
*                                  NO  - BLANK LINE IN MESS AREA                
         LA    R4,1(R4)            COUNT BLANK LINE IN                          
*                                     TOTAL LINES                               
         LA    R2,AORREA2H-AORREASH(R2)                                         
*                                  BUMP TO NEXT LINE                            
         B     REMS0080            GO BACK FOR NEXT                             
*                                     WITHOUT CHANGING COUNTER                  
REMS0095 EQU   *                                                                
         BCTR  RF,0                DECREMENT FOR MOVE                           
         EX    RF,REMS0950         MOVE BY LENGTH                               
****>>>  MVC   OCDDS,=C'DDS'       INSERT LINE DELIMITER                        
         ST    RF,DMCB+8           INSERT LENGTH INTO P3                        
         GOTO1 REJMSGS,DMCB,(RC),(R2)                                           
         LA    R4,1(R4)                                                         
*                                                                               
         LA    R2,AORREA2H-AORREASH(R2)                                         
*                                  BUMP TO NEXT LINE                            
         BCT   R3,REMS0080         GO BACK FOR NEXT                             
*                                                                               
* SUPPRESS STATION ORDER COMMENTS PER PETRY AND ELLEN WEINSTEIN                 
*                                                                               
REMS0100 EQU   *                                                                
         B     REMS1000                                                         
REMS0950 MVC   OCCOMMNT(0),8(R2)   MOVE BY LENGTH                               
*                                                                               
REMS1000 EQU   *                                                                
*                                                                               
*   DETERMINE IF LAST BUYLINE COMMENT ENTRY IS STILL WAITING TO                 
*      SPOOL.                                                                   
*                                                                               
         CLC   P,SPACES            ANYTHING ON PRINT LINE?                      
         BE    REMS1100                                                         
         OC    P,P                 ANYTHING ON PRINT LINE?                      
         BZ    REMS1100            NO  - NO OUTPUT                              
         GOTO1 SPOOL,DMCB,(R8)     SPOOL THE LINE                               
         MVI   LINE,1              FORCE TO SINGLE PAGE                         
         OC    OCBUYLIN,OCBUYLIN   BUYLINE NUMBER IN LINE?                      
         BZ    REMS1100            NO                                           
         CLC   OCBUYLIN,SPACES     BUYLINE NUMBER IN LINE?                      
         BE    REMS1100                                                         
*                                                                               
*   ONLY BUMP THE LINECOUNT FOR COMMENTS FROM BUYLINE RECORDS.                  
*      THE SCREEN MESSAGE LINES ARE ALREADY COUNTED.                            
*                                                                               
*        LA    R4,1(R4)            BUMP THE LINECOUNT                           
*                                                                               
*        DROP  R2,R3,R5                                                         
*                                                                               
REMS1100 EQU   *                                                                
         USING ORDTRLR,R6                                                       
         MVC   OTTRANID,=C'ORDTLR'                                              
         MVC   OTORDNUM,RETORD#                                                 
         LA    R4,2(R4)            ADD 1 EACH FOR HDR, TRLR                     
         EDIT  (R4),(6,OTCOUNT),FILL=0,ZERO=NOBLANK                             
         GOTO1 SPOOL,DMCB,(R8)                                                  
         MVI   LINE,1              FORCE TO SINGLE PAGE                         
*                                                                               
         CLI   ACTNUM,ACTAMD       ACTION AMEND?                                
         BE    REMS1300            YES, DON'T MARK CONTRACT REJECTED            
*                                                                               
*   INSERT REJECT DATE/TIME STAMP                                               
*                                                                               
         OC    AORHDLN,AORHDLN     ANY CONTRACT NUMBER ON SCREEN?               
         BZ    REMS1300            NO  - DON'T GET CONTRACT NUMBER              
         L     RF,AIOAREA          PREPARE TO REWRITE CONTRACT RECORD           
         ST    RF,AIO              SET IO AREA TO READ OLD RECORD               
         L     R2,AIO3                                                          
         USING RCONREC,R2                                                       
*                                                                               
         MVC   KEY(27),RCONREC     GET KEY FROM NEW RECORD                      
         MVC   KEYSAVE,KEY                                                      
         OI    DMINBTS,X'08'       RETURN DELETED KEY ALSO                      
         GOTO1 HIGH                                                             
         CLC   KEYSAVE(27),KEY     REDUNDANT CHECK: KEY FOUND?                  
         BNE   REMS1300            YES                                          
         NI    KEY+27,X'FF'-X'80'  RESTORE KEY                                  
         OI    DMINBTS,X'08'       RETURN DELETED RECORDS ALSO                  
         GOTO1 GETREC              READ INTO AIOAREA                            
         MVC   AIO,AIO3            RESET TO UPDATED CON RECORD                  
*                                                                               
*                                  UPDATE CONTRACT STATUS ELEMENT               
*                                                                               
*                                                                               
         LA    R2,RCONELEM         FIND X'1D' ELEMENT                           
REMS1120 EQU   *                                                                
         CLI   0(R2),0             END OF RECORD?                               
         BE    REMS1140            YES - NOT FOUND - BUILD IT                   
         CLI   0(R2),X'1D'         DARE ELEMENT?                                
         BE    REMS1200            FOUND: UPDATE IT                             
         ZIC   RF,1(R2)            NO  - BUMP TO NEXT ELEMENT                   
         AR    R2,RF                                                            
         B     REMS1120            GO BACK FOR NEXT                             
REMS1140 EQU   *                                                                
         XC    ELTBUILD,ELTBUILD   NOT FOUND: BUILD IT                          
         MVI   ELTBUILD,X'1D'      INSERT ELEMENT CODE                          
         LA    RF,RCONDL2Q                                                      
         STC   RF,ELTBUILD+1       INSERT ELEMENT LENGTH                        
         OI    ELTBUILD+2,X'20'    SET 'REJECTED' FLAG                          
*                                                                               
         CLI   AORHDLNH+5,0        ANY CONTRACT NUMBER ON SCREEN?               
         BE    *+8                                                              
         OI    ELTBUILD+2,X'80'    YES, SET 'LINKED' FLAG                       
*                                                                               
         TM    MISCFLAG,X'80'      DAILY ORDER?                                 
         BZ    *+8                                                              
         OI    ELTBUILD+2,X'08'    SET DAILY FLAG                               
                                                                                
         GOTO1 HEXIN,DMCB,RETORD#,ELTBUILD+3,8                                  
*                                  INSERT HEX VALUE OF AGY ORD #                
         MVC   ELTBUILD+RCONDRDR-RCONDREL(4),ACTDATE                            
*                                  YES - MOVE DATE+TIME TO REJECTED             
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),RCONREC,ELTBUILD,         X        
               =C'ADD=CODE'                                                     
         B     REMS1250                                                         
REMS1200 EQU   *                                                                
                                                                                
         MVI   2(R2),X'A0'         SET 'REJECTED+LINKED' FLAGS, CLEAR           
*                                     ANY PREVIOUS VALUE                        
         TM    MISCFLAG,X'80'      DAILY ORDER?                                 
         BZ    *+8                                                              
         OI    2(R2),X'08'         SET DAILY FLAG                               
                                                                                
         MVC   RCONDRDR-RCONDREL(4,R2),ACTDATE                                  
*                                  YES - MOVE DATE+TIME TO REJECTED             
REMS1250 EQU   *                                                                
         GOTO1 PUTREC              WRITE UPDATED RECORD TO FILE                 
         GOTO1 WRITE               REWRITE CLEARED KEY FOR RECORD               
REMS1300 EQU   *                                                                
         B     EXIT                                                             
*                                                                               
         DROP  R2,R6                                                            
         EJECT                                                                  
*                                                                               
*   MSGCHECK:  DETERMINE IF A LINE HAS TO BE SPOOLED.  THIS IS TO               
*      ENABLE THE '*' TO BE INSERTED FOR ANOTHER LINE FOLLOWING                 
*      INDICATOR.  THIS ROUTINE WILL ONLY BE CALLED WHEN A NEW LINE             
*      IS TO BE CONSTRUCTED.  IF OLD LINE IS WAITING TO SPOOL, IT               
*      MUST BE FLAGGED.                                                         
*   NOTE:  CONDITION CODE ON EXIT DETERMINES WHETHER LINE COUNT IS              
*      TO BE INCREMENTED.                                                       
*                                                                               
MSGCHECK NTR1                                                                   
         CLC   P,SPACES            ANYTHING ON PRINT LINE?                      
         BE    MCHE0100            NO  - NO OUTPUT                              
         OC    P,P                 ANYTHING ON PRINT LINE?                      
         BZ    MCHE0100            NO  - NO OUTPUT                              
         USING ORDCOM,R6                                                        
         MVI   OCCONTIN,C'*'       YES - INSERT INDICATOR                       
         GOTO1 SPOOL,DMCB,(R8)     SPOOL THE LINE                               
         MVI   LINE,1              FORCE TO SINGLE PAGE                         
MCHE0100 EQU   *                                                                
         B     EXIT                                                             
         DROP  R6                                                               
*                                                                               
         EJECT                                                                  
*                                                                               
*   REJMSGS:  INSERTS MESSAGE INTO HOLD AREA, FOR LATER INCLUSION               
*        IN THE AGENCY ORDER HEADER, SO THAT MESSAGES CAN BE RE-                
*        CALLED DURING WORKSHEET PRINTING.                                      
*                                                                               
REJMSGS  NTR1                                                                   
         L     RC,0(R1)            RESET A(WORKSPACE)                           
         L     R2,4(R1)            RESET A(ERROR MESSAGE LINE)                  
         L     RF,8(R1)            RESET L(ERROR MESSAGE LINE)                  
         L     R3,AREJMESS         SET A(NEXT MESSAGE SLOT)                     
         LTR   RF,RF               ANY LENGTH IN LINE?                          
         BNZ   RMSG0040            YES - PROCESS                                
         MVC   0(2,R3),=X'1002'    NO  - PUT IN EMPTY ELEMENT                   
         LA    R3,2(R3)                                                         
         B     RMSG0200            EXIT                                         
RMSG0040 EQU   *                                                                
         LR    RE,RF               SET NEW ELEMENT LENGTH                       
         LA    RE,3(RE)            ADD FOR ELTID+CTRL+EX DEC                    
         MVI   0(R3),X'10'         INSERT ELEMENT CODE                          
         STC   RE,1(R3)            INSERT ELEMENT LENGTH                        
         EX    RF,RMSG0080         MOVE BY LENGTH                               
         AR    R3,RE               ADD LENGTH TO SLOT ADDR                      
         B     RMSG0200                                                         
*                                                                               
RMSG0080 MVC   2(0,R3),8(R2)       INSERT MESSAGE BY LENGTH                     
RMSG0200 EQU   *                                                                
         ST    R3,AREJMESS         REPLACE A(NEXT MESSAGE SLOT)                 
         XC    0(4,R3),0(R3)       CLEAR NEXT SLOT                              
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*   ADDREJS :  REJECTION MESSAGES                                               
*                                                                               
         DS    0F                                                               
ADDREJS  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R4,0(R1)            RESET A(IO AREA)                             
         USING RDARREC,R4                                                       
*                                                                               
         LA    R3,REJMESS          SET A(REJECT MSG AREA)                       
*                                                                               
ARJS0020 EQU   *                                                                
         CLI   0(R3),0             ANY ENTRY?                                   
         BE    ARJS0080            NO  - FINISHED                               
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),(R4),(R3),=C'ADD=CODE'             
*                                  YES - ADD ELEMENT TO AGY HDR REC             
         ZIC   RF,1(R3)            BUMP TO NEXT ENTRY IN TABLE                  
         AR    R3,RF                                                            
         B     ARJS0020            GO BACK FOR NEXT                             
ARJS0080 EQU   *                                                                
         XC    ELTBUILD,ELTBUILD   INSERT DATE/TIME ELEMENT                     
         MVC   ELTBUILD(2),=X'2006'                                             
         MVC   ELTBUILD+2(4),ACTDATE                                            
*                                  MOVE DATE+TIME TO APPROVED                   
         GOTO1 HELLO,DMCB,(C'P',=C'REPFILE'),(R4),ELTBUILD,            X        
               =C'ADD=CODE'                                                     
         B     EXIT                                                             
*                                                                               
         DROP  R4                                                               
*                                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* REPORT HEADHOOK ROUTINE                                                       
***********************************************************************         
HOOK     NTR1  BASE=*,LABEL=*                                                   
         MVC   KEY(L'SELECTKY),SELECTKY                                         
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         MVI   RDUPDATE,C'N'                                                    
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
*                                                                               
         MVC   H1+45(32),=C'****** DIFFERENCES REPORT ******'                   
*                                                                               
         TM    MISCFLG4,MF4DIFF                                                 
         BO    HOOK002                                                          
*                                                                               
         CLI   PRTSTAT,0                                                        
         BNE   HOOK001                                                          
*                                                                               
         OI    MISCFLG4,MF4DIFF                                                 
         B     HOOK002                                                          
*                                                                               
HOOK001  DS    0H                                                               
         MVC   H1+45(33),=C'****** AGENCY ORDER REPORT ******'                  
*                                                                               
         CLI   RDARRNUM,0                                                       
         BE    HOOK002                                                          
*                                                                               
         MVC   H1+44(35),=C'****** AGENCY REVISION REPORT ******'               
*                                                                               
HOOK002  DS    0H                                                               
         GOTO1 DATCON,DMCB,(5,0),(8,H1+90)                                      
*                                                  GET TODAY'S DATE             
         THMS  DDSTIME=YES                         GET CURRENT TIME             
         ST    R1,DUB                                                           
         ZAP   PRTTIME,DUB(4)                                                   
         ST    R0,DUB              ADDJUST FOR DDS TIME                         
         AP    PRTTIME,DUB(4)                                                   
*                                                                               
         MVC   H1+99(2),=C'AT'                                                  
         UNPK  DUB,PRTTIME                                                      
         MVC   H1+102(2),DUB+2     TIME                                         
         MVI   H1+104,C'.'                                                      
         MVC   H1+105(2),DUB+4                                                  
*                                                                               
         MVC   H2(13),=C'ORDER STATUS:'                                         
         MVC   H2+15(L'STATUS+L'STATUS2),STATUS                                 
*&&DO                                                                           
         OC    RDARRNUM,RDARRNUM                                                
         BZ    HOOK03                                                           
         MVC   H2+15(6),=C'REVNEW'                                              
         TM    RDARMISC,X'80'                                                   
         BZ    HOOK03                                                           
         MVC   H2+15(6),=C'REVRES'                                              
*&&                                                                             
HOOK03   DS    0H                                                               
*                                                                               
         CLI   RDARRNUM,0                                                       
         BNE   HOOK03A                                                          
         MVC   H2+51(14),=C'ORIGINAL ORDER'                                     
         TM    SVDARFL2,SF2XML                                                  
         BZ    *+10                                                             
         MVC   H2+51(20),=C'XML ORIGINAL ORDER'                                 
         LA    R4,H2+67                                                         
         B     HOOK03B                                                          
HOOK03A  DS    0H                                                               
         MVC   H2+51(17),=C'AGENCY REVISION #'                                  
         TM    SVDARFL2,SF2XML                                                  
         BZ    *+10                                                             
         MVC   H2+47(21),=C'XML AGENCY REVISION #'                              
         EDIT  (1,REVNUM),(3,H2+69),ALIGN=LEFT,ZERO=NOBLANK,FILL=0              
         LA    R4,H2+73                                                         
*                                                                               
HOOK03B  DS    0H                                                               
         CLI   RDARCORT,C'T'                                                    
         BNE   *+10                                                             
         MVC   0(13,R4),=C'- TRADE ORDER'                                       
*                                                                               
*********                                                                       
* LINE 3                                                                        
*********                                                                       
         MVC   H3+49(9),=C'RECEIVED:'                                           
         GOTO1 DATCON,DMCB,(2,RDARDATE),(5,H3+59)                               
         EDIT  RDARTIME,(4,WORK)                                                
         MVC   H3+69(2),WORK     FORMAT TO HH:MM                                
         MVI   H3+71,C':'                                                       
         MVC   H3+72(2),WORK+2                                                  
         CLC   WORK(2),=C'24'                                                   
         BNH   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   H3+90(4),RDARKSTA   PRINT STATION/MKT NAME                       
         MVC   H3+94(3),=C'- M'                                                 
         MVC   H3+95(1),RDARKSTA+4                                              
         CLI   RDARKSTA+4,C'T'                                                  
         BNE   *+8                                                              
         MVI   H3+96,C'V'                                                       
         MVI   H3+97,C'/'                                                       
         MVC   H3+98(L'EMKTNAME),EMKTNAME                                       
*                                                                               
         BRAS  RE,PRTSUB           GET SUBREP NAME INTO WORK                    
         MVC   H4+90(L'RDARKREP),RDARKREP                                       
         MVI   H4+92,C'/'                                                       
         MVC   H4+93(L'RREPNAME),WORK                                           
*                                                                               
HOOK05   EQU   *                                                                
*                                                                               
         MVC   H5(9),=C'---AGY---'                                              
         MVC   H5+11(7),=C'ORDER#:'                                             
         ZAP   WORK+20(5),=P'0'                                                 
         MVO   WORK+20(5),RDARKORD                                              
         EDIT  (P5,WORK+20),(8,H5+21),ALIGN=LEFT,ZERO=NOBLANK,FILL=0            
*                                                                               
         MVC   H5+64(9),=C'---REP---'                                           
         MVC   H5+74(10),=C'CONTRACT#:'                                         
*                                                                               
         OC    RDARREP#,RDARREP#                                                
         BZ    HOOK15                                                           
         ZAP   WORK+20(5),=P'0'                                                 
         MVO   WORK+20(5),CCONKNUM                                              
         EDIT  (P5,WORK+20),(8,H5+85),ALIGN=LEFT                                
*                                                                               
HOOK15   DS    0H                                                               
         TM    PRTSTAT,PRTPAGE1                                                 
         BNO   HOOKX                                                            
*                                                                               
         LA    RF,SUMTITLQ                                                      
         MVC   H7(SUMTITLQ),SUMTITLE                                            
         TM    FLAGS2,FG2EXPD                                                   
         BZ    *+14                                                             
         LA    RF,SUMTIT2Q                                                      
         MVC   H7(SUMTIT2Q),SUMTIT2E                                            
*                                                                               
         LA    R3,H7                                                            
         LA    R4,H8                                                            
         LA    R3,4(RF,R3)                                                      
         LA    R4,4(RF,R4)                                                      
*                                                                               
         GOTOR DISWKH,DMCB,GRSTDATE,(R3),(R4)                                   
         MVI   H9,C'-'                                                          
         MVC   H9+1(L'P3-2),H9                                                  
*                                                                               
HOOKX    DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
         DROP  R6                                                               
         EJECT                                                                  
*                                                                               
*   DOAUDIT :  ADD AUDIT TRAIL                                                  
*                                                                               
         DS    0F                                                               
DOAUDIT  NTR1  BASE=*,WORK=(R6,500),LABEL=*                                     
         L     R4,0(R1)            RESET A(IO AREA)                             
*                                                                               
         L     R2,AIO              SAVE CURRENT AIO                             
         ST    R6,AIO                                                           
*                                                                               
         USING RDARREC,R4                                                       
*                                                                               
         MVC   REVNUM,RDARRNUM                                                  
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(RDARKRT-RDARKEY),RDARKEY                                     
         MVI   KEY+RDARKRT-RDARKEY,X'70'                                        
         GOTO1 HIGH                                                             
         CLC   KEY(L'RDARKEY),KEYSAVE                                           
         BNE   DOAUDX                                                           
         GOTO1 GETREC                                                           
*                                                                               
         MVC   WORK(4),HELLO       RECORD DARE HISTORY                          
         MVC   WORK+4(4),DATCON                                                 
         XC    DMCB+4(4),DMCB+4                                                 
         MVI   DMCB+4,X'FF'        VALID ACTION                                 
         MVI   DMCB+5,DHAPPROQ     ACTION APPROVE                               
*                                                                               
         CLI   ACTCODE,C'A'        APPROVAL?                                    
         BE    *+8                                                              
         MVI   DMCB+5,DHREJECQ     ACTION REJECT                                
*                                                                               
         CLC   =C'AMEND',CONACT                                                 
         BNE   *+8                                                              
         MVI   DMCB+5,DHAMENDQ     ACTION AMEND                                 
*                                                                               
         MVC   DMCB+6(1),REVNUM    REVISION NUMBER                              
         GOTO1 VREGENDH,DMCB,AIO,,WORK                                          
*                                                                               
         GOTO1 PUTREC                                                           
*                                                                               
DOAUDX   DS    0H                                                               
         ST    R2,AIO                                                           
         XIT1                                                                   
         DROP  R4                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*   WRITE OUT DARE RECORD                                                       
*   UPDATE ALL APPROPRIATE PASSIVE KEYS IF RADIO EDI ORDER                      
*   AIO/AIO1 HAS DARE RECORD TO PUT TO FILE                                     
*                                                                               
WRITEREC NTR1  BASE=*,WORK=(R3,500),LABEL=*                                     
         XCEFL (R3),1600           CLEAR KEY BUILD AREA                         
         L     R6,AIO                                                           
         MVC   KEY(27),0(R6)                                                    
*                                                                               
         L     R2,AIO                                                           
         MVC   AIO,AIOAREA         SET ALTERNATE IO AREA                        
         MVC   KEYSAVE,KEY                                                      
         GOTO1 HIGH                READ THE KEY                                 
         CLC   KEYSAVE(27),KEY     KEY MUST BE ON FILE?                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   HDRDA,KEY+28                                                     
*                                                                               
         GOTO1 GETREC              READ RECD INTO AIOAREA                       
         ST    R2,AIO              RESTORE AIO                                  
*                                                                               
*   PULL OLD KEYS PRE-P/P-S/P CHANGE:                                           
*          R3:  KEY BUILD AREA                                                  
*     AIOAREA:  CURRENT LOCATION OF OLD AGENCY ORDER RECORD                     
*        AIO2:  IO AREA                                                         
*                                                                               
         GOTO1 (RFGENDTR,REPFACS),DMCB,(X'41',ACOMFACS),(R3),AIOAREA,  X        
               AIO2                                                             
*                                                                               
         GOTO1 PUTREC              WRITE OUT CHANGED DARE RECORD                
*                                                                               
*   PULL NEW KEYS PRE-P/P-S/P CHANGE:                                           
*          R3:  KEY BUILD AREA                                                  
*         AIO:  CURRENT LOCATION OF NEW AGENCY ORDER RECORD                     
*        AIO2:  IO AREA                                                         
*                                                                               
         LA    R6,800(R3)          ADD 800 TO KEY BUILD AREA                    
         GOTO1 (RFGENDTR,REPFACS),DMCB,(X'41',ACOMFACS),(R6),AIO,AIO2           
*                                                                               
*   PROCESS OLD VS NEW PASSIVE POINTERS                                         
*                                                                               
         LA    R6,800(R3)          R6->NEW PASSIVE POINTERS                     
         GOTO1 (RFGENDTR,REPFACS),DMCB,(X'02',ACOMFACS),(R3),(R6),HDRDA         
*                                                                               
WRX      DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
* SPECIAL FOR KATZ EDI ORDERS. IF ACTION IS APPROVE, ADD A PASSIVE KEY          
* X'E1' WITH CONTRACT # AND DATE/TIME STAMP INFO TO BE PICKED UP LATER          
* AT NIGHT BY A REPORT THAT WILL WRITE THESE ORDERS OUT TO TAPE                 
*                                                                               
GENEDIKY NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    KEY,KEY                                                          
         LA    R6,KEY                                                           
         USING REDIKEY,R6                                                       
         MVI   REDIKTYP,REDIKTYQ                                                
         MVC   REDIKREP,AGENCY                                                  
         MVI   REDIKACT,C'A'       ACTION IF APPROVE                            
         MVC   REDIKCON,CCONKNUM   CONTRACT NUMBER IN PWOS                      
*                                  DATE IN YYMMDD                               
         GOTO1 DATCON,DMCB,(5,WORK),(3,REDIKDTE)                                
*                                  FETCH TODAY'S DATE                           
         THMS  DDSTIME=YES                                                      
         ST    R0,DUB              ACTUAL TIME ADJUSTMENT                       
         ST    R1,DUB+4            DDS TIME                                     
         AP    DUB(4),DUB+4(4)                                                  
         ICM   R1,15,DUB                                                        
         SRL   R1,4                SHIFT OFF SIGN                               
         STCM  R1,7,REDIKTIM       TIME IN HHMMSS                               
         DROP  R6                                                               
*                                                                               
         L     RE,AIOAREA                                                       
         LA    RF,LIOS                                                          
         XCEF                                                                   
         L     R6,AIOAREA                                                       
         MVC   0(27,R6),KEY                                                     
*                                                                               
         MVC   KEY+28(4),RECADDR   CONTRACT RECORD ADDRESS                      
*                                                                               
         GOTO1 ADD                 ADD THE KEY                                  
         TM    DMCB+8,X'FD'                                                     
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,AIOAREA                                                       
         USING REDBKEY,R6                                                       
*                                                                               
         MVI   REDBKTYP,REDBKTYQ   ADD X'0E' RECORD AS A BACKUP                 
         MVI   REDBLEN+1,34+REDBELLQ                                            
         MVI   REDBCODE,1          TO THE X'E1' KEYS                            
         MVI   REDBELLN,REDBELLQ                                                
         DROP  R6                                                               
*                                                                               
         MVC   MYSVAIO,AIO                                                      
         MVC   AIO,AIOAREA         SET ALTERNATE READ AREA                      
         GOTO1 ADDREC                                                           
*                                                                               
         MVC   AIO,MYSVAIO         RESTORE AIO BEFORE EXIT                      
*                                                                               
GENEDIX  DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*******************************************************************             
* TRANSLATE THE LINE FROM SCREEN FORMAT TO REPORT FORMAT                        
*******************************************************************             
TRANLINE NTR1  BASE=*,LABEL=*                                                   
*        LM    R2,R3,0(R1)                                                      
         L     R2,GNXSVIO                                                       
         LR    R5,R2                                                            
         USING DIFFSUM,R2                                                       
         LA    R3,P                                                             
         USING DIFFSUMP,R3                                                      
*                                                                               
*&&TT                                                                           
         CLC   DSREPBY(2),=X'FFFF'                                              
         BNE   *+6                                                              
         DC    X'0770'                                                          
*&&                                                                             
         SR    R6,R6                                                            
         LA    R6,MAXPLINE                                                      
         LR    R1,R2                                                            
         AHI   R1,L'PRIO-LISTLENP                                               
*        LA    R1,L'PRIO-LISTLENP(R2)                                           
*                                                                               
TLIN0050 DS    0H                 LINES NEED TO BE PRINTED                      
         OC    0(LISTLENP,R1),0(R1)                                             
         BNZ   TLIN0060                                                         
         CLI   0(R1),FF                                                         
         BE    TLIN0060                                                         
*                                                                               
         SHI   R1,LISTLENP                                                      
         BCT   R6,TLIN0050                                                      
*                                                                               
TLIN0060 DS    0H                                                               
         ZIC   RF,MAXLINES         LINES REMAINING ON REPORT                    
         ZIC   RE,LINE                                                          
         SR    RF,RE                                                            
*                                                                               
         CR    R6,RF                                                            
         BL    TLIN0080                                                         
         CHI   R6,30                                                            
         BH    TLIN0080            WHO GIVES A SHIT                             
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
TLIN0080 DS    0H                                                               
         SR    R4,R4                                                            
*                                                                               
TLIN0100 DS    0H                                                               
         CR    R4,R6                                                            
         BNL   TLINX                                                            
*        CLI   0(R2),FF                                                         
*        BE    TLIN0150                                                         
         AHI   R4,1                LINE COUNTER                                 
         MVI   SPACING,0                                                        
         MVC   DSINPUTP,DSINPUT                                                 
         MVC   DSTYPAP,DSTYPA                                                   
         MVC   DSAGYBYP,DSAGYBY                                                 
         MVC   DSLINEP,DSLINE                                                   
         BAS   RE,PRINT                                                         
         LA    R2,LISTLENP(R2)                                                  
         B     TLIN0100                                                         
*                                                                               
TLIN0150 DS    0H                                                               
         MVC   0(OVERLOAQ,R3),OVERLOAD                                          
         BAS   RE,PRINT                                                         
TLINX    DS    0H                                                               
*        MHI   R6,LISTLENP                                                      
         XCEFL (R5),L'PRIO                                                      
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
OVERLOAD DC    C'BUY LINE(S) IS TOO BIG, SOME INFORMATIONIS SKIPPED'            
OVERLOAQ EQU   *-OVERLOAD                                                       
*********************************************************************           
* PRINT SUBREP CODE/NAME                                                        
*********************************************************************           
PRTSUB   NTR1  BASE=*,LABEL=*                                                   
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
*                                                                               
         XC    KEY,KEY                                                          
K        USING RREPREC,KEY                                                      
         MVI   KEY,X'01'                                                        
         MVC   K.RREPKREP,RDARKREP                                              
         DROP  K                                                                
*                                                                               
         GOTO1 HIGH                                                             
         CLC   KEYSAVE(27),KEY                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   AIO,AIO2                                                         
         GOTO1 GETREC                                                           
         L     R6,AIO                                                           
         USING RREPREC,R6                                                       
         MVI   ELCODE,X'01'                                                     
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
         USING RREPCODE,R6                                                      
         MVC   WORK(L'RREPNAME),RREPNAME                                        
         DROP  R6                                                               
         MVC   AIO,AIO1                                                         
EXIT3    XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
* PRINT PAGE1 "HEADINGS"                                                        
*   CONTRACT DETAILS ARE SET                                                    
*   DARE RECORD IS IN AIO                                                       
***********************************************************************         
PRPAGE1  NTR1  BASE=*,LABEL=*                                                   
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
*        NI    SPOOLIND,FF-SPNGAPS                                              
*----------------*                                                              
* REP AGENCY                                                                    
*----------------*                                                              
         LA    R2,H6                                                            
         USING PRHEAD,R2                                                        
*                                                                               
         MVC   PRALBL(7),=C'AGENCY:'                                            
         MVC   PRACODE(L'RDARKAGY),RDARKAGY                                     
         OC    RDARKAOF,RDARKAOF                                                
         BZ    PPGE08                                                           
*                                                                               
         LA    RE,PRACODE+L'PRACODE-1                                           
         CLI   0(RE),X'40'                                                      
         BH    *+8                                                              
         BCT   RE,*-8                                                           
*                                                                               
         MVI   1(RE),C'-'                                                       
         MVC   2(L'RDARKAOF,RE),RDARKAOF    AGENCY OFFICE                       
*                                                                               
PPGE08   DS    0H                                                               
         MVC   PRANAME,RDARAGNM    AGENCY AGENCY NAME                           
*                                                                               
         MVC   PRRLBL(7),=C'AGENCY:'                                            
         MVC   PRRCODE(L'CCONKAGY),CCONKAGY                                     
*                                                                               
         CLC   CCONKAOF,SPACES     OFFICE?                                      
         BE    PPGE20              NO                                           
         LA    RE,PRRCODE+L'PRRCODE-1                                           
         CLI   0(RE),X'40'                                                      
         BH    *+8                                                              
         BCT   RE,*-8                                                           
*                                                                               
         MVI   1(RE),C'-'                                                       
         MVC   2(L'CCONKAOF,RE),CCONKAOF    AGENCY OFFICE                       
*                                                                               
         MVC   PRRNAME,EAGYNAM1                                                 
*                                                                               
*****                                                                           
** ADVERTISER INFO                                                              
*****                                                                           
PPGE20   DS    0H                                                               
         LA    R2,L'H7(R2)                                                      
         MVC   PRALBL(11),=C'ADVERTISER:'                                       
         MVC   PRACODE(L'RDARCLI),RDARCLI                                       
         MVC   PRANAME(L'RDARCLNM),RDARCLNM                                     
         MVC   PRRLBL(11),=C'ADVERTISER:'                                       
         MVC   PRRCODE(L'CCONKADV),CCONKADV                                     
         MVC   PRRNAME,EADVNAME                                                 
*                                                                               
         LA    R2,L'H7(R2)                                                      
***                                                                             
* PRODUCT                                                                       
***                                                                             
         L     R6,AIO                                                           
         USING RDARCLEM,R6                                                      
         MVI   ELCODE,X'02'                                                     
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                MUST BE THERE                                
*                                                                               
         MVC   PRALBL(8),=C'PRODUCT:'                                           
         MVC   PRACODE(L'RDARPRD1),RDARPRD1                                     
         MVC   PRANAME,RDARPRN1                                                 
         MVC   PRRLBL(8),=C'PRODUCT:'                                           
         MVC   PRRCODE(L'CCONPRD),CCONPRD                                       
         MVC   PRRNAME,EPRDNAME                                                 
                                                                                
* SECOND PRODUCT                                                                
         LA    R2,L'H7(R2)                                                      
*                                                                               
         MVC   PRALBL(12),=C'2ND PRODUCT:'                                      
         MVC   PRACODE(L'RDARPRD2),RDARPRD2                                     
         MVC   PRANAME,RDARPRN2                                                 
*        MVC   PRRLBL,=C'PRODUCT'                                               
*        MVC   PRRCODE,CCONPRD                                                  
*        MVC   PRRNAME,EPRDNAME                                                 
*                                                                               
         DROP  R6                                                               
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
*                                                                               
         LA    R2,L'H7(R2)                                                      
* ESTIMATE #                                                                    
         MVC   PRALBL(11),=C'ESTIMATE #:'                                       
         EDIT  RDAREST#,(4,PRACODE),ALIGN=RIGHT,FILL=0                          
         MVC   PRRLBL(11),=C'ESTIMATE #:'                                       
*                                                                               
         MVC   PRRCODE(L'CCONIEST),CCONIEST                                     
         CLC   CCONIEST,SPACES                                                  
         BH    *+10                                                             
         MVC   PRRCODE(L'CCONXEST),CCONXEST                                     
*                                                                               
         LA    R2,L'H7(R2)                                                      
* FLIGHT DATE                                                                   
         MVC   PRALBL(12),=C'FLIGHT DATE:'                                      
         GOTO1 DATCON,DMCB,(2,RDARESST),(5,PRACODE)                             
         MVI   PRACODE+8,C'-'                                                   
         GOTO1 DATCON,DMCB,(2,RDARESEN),(5,PRACODE+9)                           
         MVC   PRRLBL(12),=C'FLIGHT DATE:'                                      
         MVC   PRRCODE(L'ECONDATE),ECONDATE                                     
* LEN                                                                           
         MVC   PRRNAME+L'PRRNAME+1(4),=C'LEN:'                                  
         LA    R6,WORK             PUT OUT LENGTHS AND CLASS                    
         MVC   WORK,SPACES                                                      
         LA    R4,CSARLEN                                                       
         LA    R3,6                                                             
                                                                                
PPGE21   OC    0(2,R4),0(R4)                                                    
         BZ    PPGE23              NO LENGTH IN THIS FIELD                      
         CH    R3,=H'6'                                                         
         BE    *+12                FIRST TIME                                   
         MVI   0(R6),C','                                                       
         LA    R6,1(R6)                                                         
                                                                                
         ZIC   RE,1(R4)            LENGTH                                       
         MH    RE,=H'10'           LEFT ONE POSITION                            
         ZIC   RF,0(R4)            CLASS                                        
         AR    RE,RF                                                            
         EDIT  (RE),(5,0(R6)),1,ALIGN=LEFT                                      
         SH    R0,=H'2'                                                         
         AR    R6,R0               LENGTH OF OUTPUT                             
         CLC   0(2,R6),=C'.0'                                                   
         BE    *+8                                                              
         LA    R6,2(R6)                                                         
         MVC   0(2,R6),SPACES                                                   
                                                                                
PPGE23   LA    R4,2(R4)                                                         
         BCT   R3,PPGE21                                                        
         MVC   PRRNAME+L'PRRNAME+6(3),WORK                                      
*                                                                               
         L     R6,AIO                                                           
         USING RDARREC,R6                                                       
*                                                                               
         LA    R2,L'H7(R2)                                                      
         MVC   PRALBL(8),=C'STATION:'                                           
         MVC   PRACODE(4),RDARKSTA AGENCY STATION                               
         CLI   RDARKSTA+4,C' '                                                  
         BE    PPGE25                                                           
         MVC   PRACODE+4(3),=C'- M'                                             
         MVC   PRACODE+5(1),RDARKSTA+4                                          
         CLI   RDARKSTA+4,C'T'                                                  
         BNE   *+8                                                              
         MVI   PRACODE+6,C'V'                                                   
         CLI   RDARKSTA+3,C' '                                                  
         BNE   PPGE25                                                           
         MVC   PRACODE+3(3),PRACODE+4                                           
         MVI   PRACODE+6,C' '                                                   
                                                                                
PPGE25   DS    0H                  UNLINK ORDERS NEED TO READ STATION           
         MVC   PRANAME,EMKTNAME                                                 
*                                                                               
         MVC   PRRLBL(8),=C'STATION:'                                           
         MVC   PRRCODE(4),CCONKSTA                                              
         MVC   PRRCODE+4(3),=C'-TV'                                             
         CLI   CCONKSTA+4,C' '                                                  
         BE    PPGE35                                                           
         CLI   CCONKSTA+4,C'L'                                                  
         BNE   PPGE30                                                           
         MVC   PRRCODE+4(3),=C'-L '                                             
         B     PPGE35                                                           
PPGE30   DS    0H                                                               
         MVC   PRRCODE+4(3),=C'- M'                                             
         MVC   PRRCODE+5(1),CCONKSTA+4                                          
                                                                                
PPGE35   DS    0H                                                               
         CLI   CCONKSTA+3,C' '                                                  
         BNE   PPGE40                                                           
         MVC   PRRCODE+3(3),PRRCODE+4                                           
         MVI   PRRCODE+6,C' '                                                   
PPGE40   DS    0H                                                               
         MVC   PRRNAME,EMKTNAME                                                 
*                                                                               
         LA    R2,L'H7(R2)                                                      
         MVC   PRALBL(6),=C'BUYER:'                                             
         MVC   PRACODE(L'RDARBUYR),RDARBUYR                                     
         MVC   PRRLBL(20),=C'REP OFF/SALESPERSON:'                              
         MVC   PRRCODE(L'CCONKOFF),CCONKOFF                                     
         MVC   PRRCODE+5(L'CCONSAL),CCONSAL                                     
         MVC   PRRNAME,ESALNAME                                                 
*                                                                               
         LA    R2,L'H7(R2)                                                      
         MVC   PRACODE(26),=C'(   )    -     (EX       )'                       
         MVC   PRACODE+1(3),RDARBTEL                                            
         MVC   PRACODE+6(3),RDARBTEL+3                                          
         MVC   PRACODE+10(4),RDARBTEL+6                                         
         MVC   PRACODE+19(6),RDARBXTN EXTENSION                                 
         MVC   PRRLBL(8),=C'DAYPART:'                                           
* DAYPART                                                                       
         LA    R1,WORK             DAYPARTS                                     
         XC    WORK,WORK                                                        
         XC    BYTE,BYTE           0=1 CHAR DPT CODE                            
         LA    R4,CSARDPT                                                       
         LA    R3,6                                                             
                                                                                
PPGE120  LA    R6,DPTABLE                                                       
         OC    0(1,R4),0(R4)                                                    
         BZ    PPGE150             NO DPT                                       
*                                                                               
         CLI   1(R4),X'C1'                                                      
         BL    PPGE130             NO CHAR IN CPP PART OF FIELD                 
         CLI   1(R4),X'E9'                                                      
         BH    PPGE130             NO CHAR IN CPP PART OF FIELD                 
*                                  3 CHAR DPT CODE                              
         MVI   BYTE,1                                                           
         B     PPGE140                                                          
*                                                                               
PPGE130  CLC   3(1,R6),0(R4)                                                    
         BE    PPGE140             ONE CHAR CODE IN RSARDPT                     
         CLI   0(R6),X'FF'                                                      
         BE    PPGE160                                                          
         LA    R6,L'DPTABLE(R6)                                                 
         B     PPGE130                                                          
*                                                                               
PPGE140  CH    R3,=H'6'                                                         
         BE    *+12                                                             
         MVI   0(R1),C','                                                       
         LA    R1,1(R1)                                                         
                                                                                
         CLI   BYTE,0                                                           
         BNE   *+14                DPT IS THREE CHAR CODE                       
         MVC   0(3,R1),0(R6)       DPT 1 CHAR MOVE FROM TABLE                   
         B     *+10                                                             
         MVC   0(3,R1),0(R4)       MOVE DPT 3 CHAR FROM RSARDPT                 
         LA    R1,3(R1)                                                         
                                                                                
PPGE150  LA    R4,3(R4)            NEXT DPT FIELD                               
         BCT   R3,PPGE120                                                       
*                                                                               
PPGE160  DS    0H                                                               
         MVC   PRRCODE,WORK                                                     
         L     R6,AIO                                                           
*&&DO                                                                           
         LA    R2,P                                                             
         MVC   PRALBL(6),=C'DEMOS:'                                             
         MVC   PRACODE,=C'RA2554'  STUB                                         
         MVC   PRRLBL(6),=C'DEMOS:'                                             
         MVC   PRRCODE,=C'RHOMES'                                               
*                                                                               
         BAS   RE,PRINT                                                         
*&&                                                                             
         BAS   RE,PRINT                                                         
*                                                                               
*-----------------------------*                                                 
* REP AND AGENCY ORDER TOTALS                                                   
*-----------------------------*                                                 
         LA    R2,P                                                             
         CLI   RDARCORT,C'T'                                                    
         BE    PRTOT05                                                          
         MVC   PRALBL(24),=C'TOTAL SPOTS AND DOLLARS:'                          
         EDIT  GSPT#,(4,PRALBL+25),ZERO=NOBLANK                                 
*        EDIT  AGSPTTOT,(4,PRALBL+25),ZERO=NOBLANK                              
         EDIT  GTOTAL$,(16,PRANAME),2,ZERO=NOBLANK,COMMAS=YES,FLOAT=$, X        
               ALIGN=LEFT                                                       
         B     PRTOT08                                                          
*                                                                               
PRTOT05  DS    0H                                                               
         MVC   PRALBL(30),=C'TRADE TOTAL SPOTS AND DOLLARS:'                    
         EDIT  GSPT#,(4,PRALBL+31),ZERO=NOBLANK                                 
         EDIT  GTOTAL$,(16,PRANAME+7),2,ZERO=NOBLANK,COMMAS=YES,       X        
               FLOAT=$,ALIGN=LEFT                                               
         LA    RE,PRRLBL-6                                                      
         MVC   0(5,RE),=C'TRADE'                                                
*                                                                               
PRTOT08  DS    0H                                                               
         MVC   PRRLBL(24),=C'TOTAL SPOTS AND DOLLARS:'                          
         EDIT  RPSPTTOT,(4,PRRLBL+25),ZERO=NOBLANK                              
         EDIT  RPORDTOT,(16,PRRNAME),2,ZERO=NOBLANK,COMMAS=YES,FLOAT=$,X        
               ALIGN=LEFT                                                       
*                                                                               
         MVC   P2+78(12),=C'DIFFERENCE:'                                        
         ZICM  RE,GSPT#,4                                                       
*        ZICM  RE,AGSPTTOT,2                                                    
         ZICM  RF,RPSPTTOT,2                                                    
         SR    RE,RF                                                            
         BP    PRTOT10                                                          
         EDIT  (RE),(5,P2+89),FLOAT=-,ZERO=NOBLANK                              
         B     PRTOT20                                                          
*                                                                               
PRTOT10  DS    0H                                                               
         EDIT  (RE),(5,P2+89),FLOAT=+                                           
*                                                                               
PRTOT20  DS    0H                                                               
         MVI   P2+95,C'+'                                                       
         ZICM  RE,GTOTAL$,4                                                     
*        ZICM  RE,AGORDTOT,4                                                    
         ZICM  RF,RPORDTOT,4                                                    
         SR    RE,RF                                                            
         BP    PRTOT30                                                          
         MVI   P2+95,C'-'                                                       
         LTR   RE,RE                                                            
         BNZ   PRTOT30                                                          
         MVI   P2+95,C' '                                                       
*                                                                               
PRTOT30  DS    0H                                                               
         EDIT  (RE),(16,P2+96),2,ALIGN=LEFT,ZERO=NOBLANK,COMMAS=YES,   X        
               FLOAT=$                                                          
*                                                                               
PPGE200  DS    0H                                                               
         BAS   RE,PRINT                                                         
         BAS   RE,PRINT                                                         
*                                                                               
         TM    CMTFLAG,CMTSTAND+CMTORD+CMTREJ                                   
         BNZ   PPGE250                                                          
         TM    MISCFLG2,MF2TRADE                                                
         BO    PPGE250                                                          
         TM    SVDARFL2,SF2XML                                                  
         BO    PPGE250                                                          
         B     PPGE500                                                          
*                                                                               
PPGE250  DS    0H                                                               
         LA    R2,P                                                             
         MVC   0(CMTFLW2Q,R2),CMTFLW2                                           
         LA    R2,P+CMTFLW2Q+1                                                  
*                                                                               
         TM    SVDARFL2,SF2XML                                                  
         BO    PPGE300                                                          
         LA    R4,0                                                             
         B     PPGE350                                                          
*                                                                               
PPGE300  DS    0H                                                               
         MVC   0(CMTFLWQ,R2),CMTFLW                                             
         LA    R2,CMTFLWQ+1(R2)                                                 
         LA    R4,3                                                             
*                                                                               
PPGE350  DS    0H                                                               
         TM    CMTFLAG,CMTSTAND+CMTORD+CMTREJ                                   
         BNZ   PPGE400                                                          
         TM    MISCFLG2,MF2TRADE                                                
         BZ    PPGE450                                                          
*                                                                               
PPGE400  DS    0H                                                               
         LA    R2,0(R4,R2)                                                      
         MVC   0(CMTFLW3Q,R2),CMTFLW3                                           
         LA    R2,CMTFLW3Q+1(R2)                                                
PPGE450  DS    0H                                                               
         MVC   0(CMTFLW2Q,R2),CMTFLW2                                           
PPGE480  DS    0H                                                               
         BAS   RE,PRINT                                                         
*                                                                               
PPGE500  DS    0H                                                               
         GOTOR PRWKHD              PRINT WEEK HEADING                           
         GOTOR PRFILTER            PRINT FILTER, IF NOT DEFAULT                 
*                                                                               
         B     EXIT                                                             
         EJECT                                                                  
DPTABLE  DS    0CL4                                                             
         DC    CL4'MNGM'            MORNING                                     
         DC    CL4'DAYD'            DAYTIME                                     
         DC    CL4'ELYE'            EARLY FRINGE                                
         DC    CL4'ENWR'            EARLY NEWS                                  
         DC    CL4'ACCA'            PRIME ACCESS                                
         DC    CL4'LNWT'            LATE NEWS                                   
         DC    CL4'LTEL'            LATE FRINGE                                 
         DC    CL4'WKDW'            WEEKEND                                     
         DC    CL4'KIDK'            KIDS                                        
         DC    CL4'FRGF'            FRINGE                                      
         DC    CL4'NWSN'            NEWS                                        
         DC    CL4'PRIP'            PRIME                                       
         DC    CL4'MOVV'            MOVIES                                      
         DC    CL4'SPES'            SPECIALS                                    
         DC    CL4'SPOJ'            SPORTS                                      
         DC    CL4'SPSO'            SOAPS                                       
         DC    CL4'COMU'            COMPETITIVE                                 
         DC    CL4'LOCX'            LOCAL                                       
         DC    X'FF'                                                            
*                                                                               
CMTFLW   EQU   *                                                                
         DC    C'THIS IS A XML ORDER'                                           
CMTFLWQ  EQU   *-CMTFLW                                                         
*                                                                               
CMTFLW2  EQU   *                                                                
         DC    C'***'                                                           
CMTFLW2Q EQU   *-CMTFLW2                                                        
*                                                                               
CMTFLW3  EQU   *                                                                
         DC    C'COMMENTS FOLLOW ORDER'                                         
CMTFLW3Q EQU   *-CMTFLW3                                                        
*********************************************************************           
* PRINT WEEK HEADING FOR REPORT                                                 
*********************************************************************           
PRWKHD   NTR1                                                                   
                                                                                
         MVC   P1(SUMTITLQ),SUMTITLE                                            
         LA    RF,SUMTITLQ                                                      
         TM    FLAGS2,FG2EXPD                                                   
         BZ    *+14                                                             
         LA    RF,SUMTIT2Q                                                      
         MVC   P1(SUMTIT2Q),SUMTIT2E                                            
*                                                                               
         LA    R3,P1                                                            
         LA    R4,P2                                                            
         LA    R3,3(RF,R3)                                                      
         LA    R4,3(RF,R4)                                                      
         GOTOR DISWKH,DMCB,GRSTDATE,(R3),(R4)                                   
         MVI   P3,C'-'                                                          
         MVC   P3+1(L'P3-2),P3                                                  
*                                                                               
         BAS   RE,PRINT                                                         
         BAS   RE,PRINT                                                         
PRWKHX   DS    0H                                                               
         B     EXIT                                                             
*********************************************************************           
* PRINT VIEWING FILTER, IF NOT DEFAULT(MPU)                                     
*********************************************************************           
PRFILTER NTR1                                                                   
         TM    OFLAG1,OMATCHQ+OUMATCHQ+OPMATCHQ                                 
         BO    PFTRX                                                            
         MVC   P(FLTER1Q),FLTER1                                                
         LA    R2,P+FLTER1Q                                                     
         TM    OFLAG1,OMATCHQ                                                   
         BZ    *+14                                                             
         MVC   0(MATCH1Q,R2),MATCH1                                             
         LA    R2,MATCH1Q+1(R2)                                                 
*                                                                               
         TM    OFLAG1,OPMATCHQ                                                  
         BZ    *+14                                                             
         MVC   0(PMATCH2Q,R2),PMATCH2                                           
         LA    R2,PMATCH2Q+1(R2)                                                
*                                                                               
         TM    OFLAG1,OUMATCHQ                                                  
         BZ    *+14                                                             
         MVC   0(9,R2),=C'UNMATCHED'                                            
         LA    R2,10(R2)                                                        
*                                                                               
         CLI   0(R2),X'81'                                                      
         BH    *+8                                                              
         BCT   R2,*-8                                                           
*                                                                               
         MVC   2(FLTER2Q,R2),FLTER2                                             
         BAS   RE,PRINT                                                         
         BAS   RE,PRINT                                                         
PFTRX    DS    0H                                                               
         B     EXIT                                                             
MATCH1   DC    C'MATCHED '                                                      
         DC    X'50'                                                            
MATCH1Q  EQU   *-MATCH1                                                         
PMATCH2  DC    C'PROPOSED MATCH '                                               
         DC    X'50'                                                            
PMATCH2Q EQU   *-PMATCH2                                                        
FLTER1   DC    C'REPORT FILTERED ON '                                           
FLTER1Q  EQU   *-FLTER1                                                         
FLTER2   DC    C'BUYS ONLY'                                                     
FLTER2Q  EQU   *-FLTER2                                                         
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
T80F24   CSECT                                                                  
*******************************************************************             
* FOR REPORTING, AGENCY CHANGE COMMENT, COMMENT,DEMO IS DISPLAYED               
* AFTER THE AGENCY LINE IS DISPLAYED                                            
*******************************************************************             
AGYCMT   NMOD1 AGYCMTQ,*AGYCMT*,CLEAR=YES                                       
         LR    R4,RC                                                            
         USING AGYCMTD,R4                                                       
         L     RC,0(R1)                                                         
*                                                                               
         L     R2,4(R1)                                                         
         L     R8,8(R1)                                                         
BUYSEG   USING TLSTD,R8                                                         
         TM    BUYSEG.TLBYAFLG,X'40'                                            
         BZ    ACMT0020                                                         
*                                                                               
         XC    TSARREC,TSARREC     RETRIEVE BUYLINK                             
         MVI   TR.TLKTYP,C'A'                                                   
         MVC   TR.TLBLINDX,BUYSEG.TLBYALNK                                      
         GOTO1 GOTSAR,TSARDH       RETRIEVE BUY LINK RECORD                     
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
ACMT0020 DS    0H                                                               
*                                                                               
         XC    AGWORK,AGWORK                                                    
         XC    AGWORK2,AGWORK2                                                  
         XC    AGBYTE,AGBYTE                                                    
         XC    KEY,KEY                                                          
K        USING RDARREC,KEY                                                      
         MVC   KEY(RDARKRT-RDARKEY),SELECTKY                                    
         MVI   K.RDARKRT,X'40'       BUY                                        
         MVI   K.RDARKSRT,X'20'      COMMENT                                    
*                                                                               
         MVC   AGSVKEY,KEY                                                      
         LA    R3,BUYSEG.TLBYALNK                                               
         TM    BUYSEG.TLBYAFLG,X'40'                                            
         BZ    ACMT0050                                                         
         LA    R3,TR.TLBLBUY#                                                   
         USING TLBLBUY#,R3                                                      
*                                                                               
ACMT0050 DS    0H                                                               
         CLI   0(R3),0                                                          
         BE    ACMT0500                                                         
         TM    BUYSEG.TLBYAFLG,X'40'                                            
         BZ    ACMT0060                                                         
         CLC   AGBYTE,0(R3)                                                     
         BE    ACMT0300                                                         
*                                                                               
ACMT0060 DS    0H                                                               
         MVC   AGBYTE,0(R3)                                                     
         MVC   KEY,AGSVKEY                                                      
         MVC   K.RDARKSEQ,0(R3)                                                 
         DROP  K                                                                
         MVC   AIO,AIO2                                                         
         GOTO1 HIGH                                                             
         CLC   KEYSAVE(27),KEY                                                  
         BNE   ACMT0300                                                         
*                                                                               
         GOTO1 GETREC                                                           
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BAS   RE,GETEL                                                         
         BE    ACMT0080                                                         
         L     R6,AIO                                                           
         MVI   ELCODE,X'02'                                                     
         BAS   RE,GETEL                                                         
         BNE   ACMT0300            NEXT BUYLINE                                 
*                                                                               
ACMT0080 DS    0H                                                               
         USING DIFFSUM,R2                                                       
         MVC   DSLINE(22),=C'ADDITIONAL AGENCY LINE'                            
*                                                                               
         GOTOR GETBUY#,DMCB,(1,(R3))   TRANSLATE BUY NUMBER                     
         BNE   ACMT0090                                                         
         LA    RF,DMCB+4                                                        
         EDIT  (2,(RF)),(4,DSLINE+23),ALIGN=LEFT                                
         B     ACMT0092                                                         
*                                                                               
ACMT0090 EDIT  (1,0(R3)),(3,DSLINE+23),ALIGN=LEFT                               
ACMT0092 LA    RF,DSLINE+L'DSLINE-1                                             
         CLI   0(RF),X'40'                                                      
         BH    *+8                                                              
         BCT   RF,*-8                                                           
*                                                                               
         MVC   2(13,RF),=C'BUYLIST INFO:'                                       
*                                                                               
         L     R6,AIO                                                           
         MVI   ELCODE,X'10'                                                     
         BAS   RE,GETEL                                                         
         BNE   ACMT0200                                                         
*                                                                               
         MVC   AGWORK3(4),ACOMFACS    SET UP ROUTINE ADDRESS BLOCK              
         MVC   AGWORK3+4(4),VOUTDAY                                             
         MVC   AGWORK3+8(4),UNTIME                                              
         MVC   AGWORK3+12(4),DEMOCON                                            
         XC    BYTE,BYTE                                                        
         OI    BYTE,X'02'                                                       
         GOTO1 VREGENDB,DMCB,(BYTE,KEY),(4,AGWORK),AIO,AGWORK3                  
*                                                                               
         LA    R1,AGWORK                                                        
*                                                                               
ACMT0150 DS    0H                                                               
         OC    0(81,R1),0(R1)      MOVE OUTPUT FROM DAB TO PRINT                
         BZ    ACMT0200                                                         
         MVC   DSCMMT,9(R1)                                                     
*                                                                               
*        BAS   RE,PRINT                                                         
         LA    R2,LISTLENP(R2)     NEXT LINE                                    
         CLI   0(R2),FF            END OF BUFFER?                               
         BE    AGYCMTX                                                          
*                                                                               
         LA    R1,81(R1)                                                        
         B     ACMT0150                                                         
*                                                                               
ACMT0200 DS    0H                                                               
         L     R6,AIO                                                           
         USING RDARCTEL,R6                                                      
         MVI   ELCODE,X'02'        COMMENTS                                     
         BAS   RE,GETEL                                                         
         BNE   ACMT0300                                                         
ACMT0230 DS    0H                                                               
         CLI   RDARCTLN,2           SKIP IF NO COMMENT                          
         BNH   ACMT0290                                                         
         CLI   RDARCTLN,72          SHORTEN TO MAX 70 IF TOO LONG               
         BL    *+12                                                             
         LA    R1,69                                                            
         B     ACMT0250                                                         
         ZIC   R1,RDARCTLN                                                      
         SH    R1,=H'3'             SUBTRACT OVERHEAD LENGTH                    
ACMT0250 DS    0H                                                               
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   DSCMMT(0),RDARCTCM                                               
*                                                                               
         LA    R2,LISTLENP(R2)                                                  
         CLI   0(R2),FF            END OF BUFFER?                               
         BE    AGYCMTX                                                          
*                                                                               
ACMT0290 DS    0H                                                               
         BAS   RE,NEXTEL                                                        
         BE    ACMT0230                                                         
*                                                                               
ACMT0300 DS    0H                  NEXT BUY LINE                                
         TM    BUYSEG.TLBYAFLG,X'40'                                            
         BZ    ACMT0500                                                         
         LA    R3,TLBLLENQ(R3)                                                  
         B     ACMT0050                                                         
*                                                                               
ACMT0500 DS    0H                                                               
*                                                                               
AGYCMTX  DS    0H                                                               
         ST    R2,DMCB                                                          
         MVC   AIO,AIO1                                                         
         B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
         DROP  R4,R6,R8                                                         
*        PRINT OFF                                                              
       ++INCLUDE DDSPOOLD          (GENERAL PRINT AREAS)                        
       ++INCLUDE DDSPLWORKD        (GENERAL CONTROLLER AREAS)                   
       ++INCLUDE DDCOMFACS                                                      
       ++INCLUDE DDCOREQUS                                                      
       ++INCLUDE DDGLOBEQUS                                                     
       ++INCLUDE DDGLVXCTLD                                                     
       ++INCLUDE DDTSARD                                                        
       ++INCLUDE REPFACSQ                                                       
       ++INCLUDE RECNTPROF                                                      
       ++INCLUDE REDARPROF                                                      
       ++INCLUDE DDPERVALD                                                      
       ++INCLUDE FAGETTXTD                                                      
       ++INCLUDE FATIOB                                                         
       ++INCLUDE REDARFFD                                                       
       ++INCLUDE DDGENTWA                                                       
         ORG   CONTAGH                                                          
       ++INCLUDE REDARF8D                                                       
         EJECT                                                                  
         ORG   CONTAGH                                                          
       ++INCLUDE REDAREBD                                                       
         EJECT                                                                  
       ++INCLUDE REDARTW3                                                       
         EJECT                                                                  
       ++INCLUDE REDARWORKD                                                     
         EJECT                                                                  
       ++INCLUDE REDARDSECT                                                     
         EJECT                                                                  
RSTARECD DSECT                                                                  
       ++INCLUDE REGENSTA                                                       
         EJECT                                                                  
RSALRECD DSECT                                                                  
       ++INCLUDE REGENSAL                                                       
         EJECT                                                                  
RREPRECD DSECT                                                                  
       ++INCLUDE REGENREPA                                                      
         EJECT                                                                  
REDIRECD DSECT                                                                  
       ++INCLUDE REGENEDI                                                       
         EJECT                                                                  
RECFCD   DSECT                                                                  
       ++INCLUDE REGENCFC                                                       
         EJECT                                                                  
       ++INCLUDE DMPRTQL                                                        
         EJECT                                                                  
*        PRINT OFF                                                              
       ++INCLUDE CTGENFILE                                                      
         EJECT                                                                  
EDICTD   DSECT                                                                  
       ++INCLUDE EDIDDSHD                                                       
         EJECT                                                                  
       ++INCLUDE EDILINKD                                                       
         EJECT                                                                  
         PRINT ON                                                               
*                                                                               
* SYSSPARE SAVED VARIABLES                                                      
*                                                                               
SYSD     DSECT                                                                  
         ORG   SYSSPARE                                                         
VTSAR    DS    A                                                                
ATSARBUF DS    A                   ADDRESS OF TSAR BUFFER TO USE                
*                                                                               
FLAGS    DS    X                                                                
FGINITQ  EQU    X'80'                                                           
* X'80' = BUY PREPROCESSING AND TSAR INITIALIZATION PERFORMED                   
FGBSEGQ  EQU   X'40'                                                            
* X'40' = BUILD BUY SEGMENT                                                     
FGPRTQ   EQU   X'20'                                                            
* X'20' = DIFFERENCE DETAIL LIST IN PROCESS (DEFAULT = SUMMARY)                 
FGTBSVDQ EQU   X'10'                                                            
* X'10' = TSAR BUFFER HAS BEEN SAVED                                            
FGTOTALQ EQU   X'08'                                                            
* X'08' = TOTAL CALCULATION, SKIP BUY DETAIL PROCESSING                         
FGADDSPQ EQU   X'04'                                                            
* X'04' = ADD SPOTS TO REP BUYS, ELSE REMOVE SPOTS IF OFF                       
FGNEWBYQ EQU   X'02'                                                            
* X'02' = ADDING NEW REP BUY LINE                                               
FGPVIEWQ EQU   X'01'                                                            
* X'01' = PREVIEW VIEW REQUESTED                                                
*                                                                               
FLAGS2   DS    X                                                                
FG2DEMO  EQU   X'80'                                                            
* X'80' = AGENCY DEMO CATEGORIES CHANGED                                        
FG2STAY  EQU   X'40'                                                            
* X'40' = CALL CONTRACT AND STAY IN SAME SESSION                                
FG2SEND  EQU   X'20'                                                            
* X'20' = CALL CONTRACT AND SEND THE CONTRACT TO STATION                        
FG2RTRN  EQU   X'10'                                                            
* X'10' = THIS IS A RETURN CALL BACK TO CONTRACT                                
FG2FORC  EQU   X'08'                                                            
* X'08' = FORCE GLOBBER RETURN TO DAR/SELECT IN PREVIOUS SESSION                
FG2EXPD  EQU   X'04'                                                            
* X'04' = SET THE DISPLAY FORMAT TO EXPAND                                      
FG2RGHT  EQU   X'02'                                                            
* X'02' = TRAVERSING GRID IN RIGHT DIRECTION -->>                               
FG2BACK  EQU   X'01'                                                            
* X'01' = SCROLL BACK                                                           
METHOD   DS    X                   ADD SPOTS TO NEW LINE OR CHG CURRENT         
ADDBUYQ  EQU   X'80'                                                            
CHGBUYQ  EQU   X'40'                                                            
*                                                                               
DISPFLGS DS    X                   DISPLAY FLAGS                                
DFCOMPQ  EQU   X'80'               TOO MANY REP LINES, COMPRESSED MODE          
DFUAGYL  EQU   X'40'                THERE IS UNMATCH LINES                      
*                                                                               
* KEEP TRACK OF TSAR RECORD NUMBERS FOR BUY SEGMENTS IN                         
* DIFFERENCES LIST DISPLAY                                                      
*                                                                               
LISTSTRT DS    H                   TSAR NUMBER OF RECORD AT LIST START          
LISTLAST DS    H                   TSAR NUMBER OF RECORD AT LIST END            
*                                                                               
NXOFFSET DS    F                   OFFSET TO NEXT DISPLAY LINE                  
*                                  SET WHEN IN EXPLODED MODE                    
*                                                                               
RPORDTOT DS    XL4                 REP CONTRACT ORDER TOTAL                     
AGORDTOT DS    XL4                 AGENCY ORDER TOTAL                           
RPSPTTOT DS    XL2                 REP CONTRACT SPOT TOTAL                      
AGSPTTOT DS    XL2                 AGENCY SPOT TOTAL                            
*                                                                               
PRVREPSP DS    X                   TOTAL SPTS FROM REP BUYS FOR THIS WK         
PRVAGYSP DS    X                   TOTAL SPTS FROM AGY BUYS FOR THIS WK         
TOTREPSP DS    X                   TOTAL SPTS FROM REP BUYS FOR THIS WK         
TOTAGYSP DS    X                   TOTAL SPTS FROM AGY BUYS FOR THIS WK         
REPSPWK  DS    X                   SPTS FROM REP BUY FOR THIS WK                
AGYSPWK  DS    X                   SPTS FROM AGY BUY FOR THIS WK                
NUMWKS   DS    H                   # OF WKS OF CONTINUOUS BUY SEGMENTS          
SEGRATE  DS    F                   RATE OF CURRENT SEGMENTS                     
STENDAY  DS    X                   LAST START END DAY INDICATOR                 
*                                                                               
SAVEROTE DS    A                   SAVE A(ROTATION FIELD)                       
COMPCON  DS    CL4                 CONTRACT # COMP/REVERSED                     
ELTBUILD DS    CL96                ELEMENT BUILD AREA                           
ELTBILD2 DS    CL64                SECOND BUILD AREA                            
SVDEMCAT DS    XL42                SAVED DEMO CATEGORIES                        
PROGNAME DS    CL34                SAVE BUY PROGRAM NAME                        
DETLFLAG DS    XL2                 TOTAL SPOT LENGTH                            
BUYUPDAT DS    CL1                 BUY WRITE FLAG                               
SKIPRECS DS    CL1                 GENERAL RECORD SKIP FLAG                     
TOTSPTUN DS    XL1                 TOTAL SPOT UNITS                             
ACTCODE  DS    CL1                 ACTION CODE:                                 
*                                     A  =  APPROVE                             
*                                     R  =  REJECT                              
PRTSTAT  DS    X                   STATUS FLAG FOR PRINTING                     
PRTONE   EQU   X'80'               ONLY ONE REPORT WILL BE PRINTED              
PRTNEWPG EQU   X'40'               EJECT PAGE FOR NEXT REPORT                   
PRTCLOSE EQU   X'20'               WE'RE ALL DONE, CLOSE PQ AND EXIT            
PRTDAILY EQU   X'10'               BUY IS DAILY                                 
PRTPAGE1 EQU   X'08'               PAGE 1 IS PRINTED                            
PRTCHEAD EQU   X'04'               COMMENT HEADER PRINTED                       
PRTKBUY  EQU   X'01'               CONTRACT BUYS FOUND, PRINT CONTRACT          
*                                   BUYS SIDE-BY-SIDE WITH AGENCY'S             
*                                                                               
MISCFLAG DS    XL1                 MESSAGE FLAGS                                
*                                     X'80'  =  DAILY ORDER                     
*                                     X'40'  =  ORBIT DROPPED                   
MFMANUAL EQU   X'20'                  X'20'  =  MANUAL CHANGES STARTED          
MFEXACT  EQU   X'10'                  X'10'  =  EXACT #SPOTS MATCH              
MFCREDIT EQU   X'08'                  X'08'  =  K BUY HAS CREDIT BUYS           
MFMGLOOP EQU   X'04'                  X'04'  =  MATCH MAKEGOOD ONLY             
MFCDATE  EQU   X'02'                  X'02'  =  CONFLICT END DATE ORDER         
MFCONOK  EQU   X'01'                  X'01'  =  CONTRACT UPDATED                
*                                                                               
MISCFLG2 DS    XL1                 MORE MESSAGE FLAGS                           
MF2PTCAN EQU   X'80'                  X'80'  =  PARTIAL CANCEL                  
MF20SBUY EQU   X'40'                  X'40'  =  AGENCY SENT 0 SPT BUY           
MF2NOXIT EQU   X'20'                  X'20'  =  DON'T ERROR EXIT IN             
*                                               MANUAL MATCHING                 
MF2TRADE EQU   X'10'                  X'10'  =  TRADE ORDER                     
MF2MATCH EQU   X'08'                  X'08'  =  BUYLINE HAS A MATCH             
MF2FOUND EQU   X'04'                  X'04'  =  ENTRY FOUND IN TABLE            
MF2BUYUP EQU   X'02'                  X'02'  =  BUY CHANGED, DO PUTREC          
MF2FORCE EQU   X'01'                  X'01'  =  FORCED MATCHING                 
*                                                                               
MISCFLG3 DS    XL1                 SOME MORE MESSAGE FLAGS                      
MF3EFFDT EQU   X'80'                  X'80'  =  EFFECTIVE DATES CHANGED         
MF3#SPTS EQU   X'40'                  X'40'  =  SPOTS PER WEEK CHANGED          
MF3SPTCH EQU   X'20'                  X'20'  =  SPOTS CHANGE DETECTED           
MF3PRBUY EQU   X'10'                  X'10'  =  PROCESS REST OF REP             
*                                               BUYS W/O REMOVING SPOTS         
MF3PGNAM EQU   X'08'                  X'08'  =  PROGRAM NAME CHANGED            
MF3BYCMT EQU   X'04'                  X'04'  =  BUY COMMENT PROCESSED           
*                                               FOR DATE/SPOT CHANGES           
MF3BASEG EQU   X'02'                  X'02'  =  BUY AGENCY SEGMENT              
*                                               ALREADY PROCESSED               
MF303ELM EQU   X'01'                  X'01'  =  X'03' ELEM ADDED TO BUY         
*                                                                               
MISCFLG4 DS    XL1                                                              
MF4TKO   EQU   X'80'               X'80'  =  TAKE OVER ORDER                    
MF4LPGM  EQU   X'40'               X'40'  =  LONG PROGRAM NAME                  
MF4MKG   EQU   X'20'               X'20'  =  THIS LINE IS AGY MAKEGOOD          
MF4DIFF  EQU   X'10'               X'10' = DIFFERENCE REPORT                    
MF4GLOB  EQU   X'08'               X'08' = CAME BACK FROM GLOBBER               
MF4NOAGY EQU   X'04'               X'04' = AGY LINE IS CANCELLED                
*                                                                               
SVDARFL2 DS    XL1                 = RDARFLG2                                   
SF2XML   EQU   X'80'               XML ORDER                                    
*                                                                               
SMATFLAG DS    X                   SPECIAL MATCH FLAGS FOR C/O, DAILYS          
SMATROKQ EQU   X'80'               REP LIST OF BUYS ALL DONE                    
SMATAOKQ EQU   X'40'               AGY LIST OF BUYS ALL DONE                    
SMATDALY EQU   X'20'               CAME FROM DAILY MATCHING                     
*                                                                               
AMSTRLNK DS    X                   AGENCY MASTER LINE LINK                      
AMSTRLN# DS    X                   AGENCY MASTER LINE LINK OFFSET               
*                                                                               
SVMSTRLK DS    X                   SAVED MASTER LINE LINK                       
SVREPNPW DS    X                   NPW OF REP BUY                               
SVAGYNPW DS    X                   NPW OF AGY BUY                               
*                                                                               
REPSPDIF DS    X                   (# REP SPT) - (# AGY SPT) FOR THE WK         
APPRBUY# DS    X                   LAST BUY DISPLAYED IN APPROVAL SCRN          
AGBUYMTR DS    X                   AGENCY MAKEGOOD BUY MASTER LINE              
ORBFLAG  DS    CL1                 ORBIT PRESENCE INDICATOR                     
*                                     Y  =  ORBIT PRESENT                       
BUCKFLGS DS    CL1                 INDICATOR FOR BUCKUP ROUTINE                 
ORDROTST DS    CL1                 ORDER ROTATION START DAY                     
EDICTACT DS    CL3                 EDICT 'ACTION'                               
RESENT   DS    CL1                 RESENT FLAG                                  
ACTDATE  DS    XL2                 DATE FOR STAMPING                            
ACTTIME  DS    XL2                 TIME FOR STAMPING                            
VERDFLT  DS    CL1                 VERSION NUMBER (REP)                         
CONMOD#  DS    CL1                 SAVE AREA FOR MOD NUMBER                     
BUYLINE# DS    X                   BUYLINE NUMBER BEING GENERATED               
NEWVER#  DS    CL1                 NEW RECORD VERSION NUMBER                    
NEEDSCRN DS    CL1                                                              
SAVEKEY  DS    CL27                KEY SAVE AREA FOR RESTARTS                   
         DS    CL9                 !!!DO NOT USE!!!                             
SVBUYKEY DS    CL27                KEY SAVE AREA FOR RESTARTS                   
SAVEPROD DS    CL20                PROD NAME(S) FROM AGENCY ORDER               
SAVEEASI DS    0CL16               SAVE AREA FOR EASI CODES                     
EASIADV  DS    CL4                 CLIENT CODE: 6 CHARS ON AGENCY HDR           
EASIPROD DS    CL4                                                              
EASIEST# DS    CL4                 EST#: 3 CHARS ON AGENCY HDR                  
EASIPRD2 DS    CL4                 PIGGY/PARTNER PRODUCT                        
FLTDATES DS    CL4                 AGENCY ORDER FLIGHT DATES                    
FLTSTART DS    XL3                                                              
FLTEND   DS    XL3                                                              
SAVEBUYR DS    CL24                BUYER NAME FROM AGENCY ORDER                 
STARTDAY DS    XL1                 START DAY FOR BUY                            
ENDDAY   DS    XL1                 END DAY FOR BUY                              
ORBSTDAY DS    XL1                 ORBIT START DAY                              
ROTATDAY DS    XL1                 ROTATION START DAY                           
BUCKFLAG DS    CL1                 ADD/SUBTRACT FLAG FOR BUCKETS                
TRUFLAG  DS    CL1                 GENERATE EC/SAR KEY IF 'Y'                   
FLTKEYFG DS    CL1                 GENERATE 8E AND 8D KEY IF 'Y'                
CONFLTDT DS    CL4                 ORIGINAL CONTRACT FLIGHT DATES               
NEWFLTDT DS    CL4                 NEW CONTRACT FLIGHT DATES                    
RECADDR  DS    CL4                 DISK ADDRESS OF CONTRACT RECORD              
TKOVDATE DS    XL3                 TAKEOVER DATE                                
SAVEBU$$ DS    CL4                 BUY BREAK SAVE AREA                          
SENDID   DS    CL2                                                              
INTTYPE  DS    CL1                 INPUT TYPE                                   
SPLKEYAD DS    133C                EXTENDED SPOOL AREA                          
PRTTIME  DS    XL4                 PRINT TIME                                   
REVNUM   DS    XL(L'RDARRNUM)                                                   
REVDATE  DS    XL(L'RDARDATE)                                                   
REVTIME  DS    XL(L'RDARTIME)                                                   
ORDRETRN EQU   *                   INFO FOR RETURN MESSAGES                     
RETORD#  DS    CL8                                                              
RETFROM  DS    CL10                                                             
RETTO    DS    CL10                                                             
RETSTAT  DS    CL6                                                              
RETCON#  DS    CL8                                                              
RETSENDR DS    CL16                                                             
*                                                                               
*   SPOTPAK TRANSFER ELEMENT                                                    
*                                                                               
IFELCODE DS    CL2                 CODE/LENGTH = X'0830'                        
IFSPAG   DS    CL2                 SPOT AGENCY POWER CODE                       
IFSPMD   DS    CL1                 SPOT MEDIA CODE                              
IFSPCL   DS    CL3                 SPOT CLIENT CODE                             
IFSPPRD  DS    CL3                 SPOT PRODUCT CODE                            
IFSPES   DS    CL1                 SPOT ESTIMATE NUMBER                         
IFSPPP   DS    CL3                 SPOT PRODUCT PIGGY                           
IFSPP1   DS    CL1                 SPOT PRODUCT 1 SPLIT                         
IFSPP2   DS    CL1                 SPOT PRODUCT 2 SPLIT                         
IFSPL#   DS    CL1                 SPOT BUYLINE NUMBER                          
IFSPST   DS    CL5                 STATION CALL LETTERS                         
IFSPADV  DS    CL4                 REP ADVERTISER CODE                          
IFSPRD   DS    CL3                 REP PRODUCT CODE                             
IFSPDT   DS    CL3                 SPOT TRANSFER DATE                           
IFSPTM   DS    CL4                 SPOT TRANSFER TIME                           
         DS    CL12                SPARE                                        
IFELLEN  EQU   *-IFELCODE          ELEMENT LENGTH                               
*                                                                               
         DS    0F                                                               
BUYCOST  DS    F                   COST OF SPOTS IN BUY                         
SPOTCTR  DS    F                   NUMBER SPOTS IN BUY                          
WEEKCTR  DS    F                   NUMBER WEEKS IN BUY                          
ORDTOT$$ DS    F                   ORDER TOTAL DOLLARS                          
ORDTOTSP DS    F                   ORDER TOTAL SPOTS                            
AREJMESS DS    A                   A(NEXT REJ MESS SPACE)                       
KATZEDI  DS    C                   Y/N KATZ EDI ORDER?                          
DAILYFLG DS    C                   DAILY PACING FLAG                            
TARGETBY DS    X                                                                
TKODATE  DS    XL3                 TAKEOVER DATE                                
MYSVAIO  DS    F                                                                
*                                                                               
BUYNUM   DS    X                                                                
ABUYLINK DS    X                   AGENCY BUY LINK NUMBER                       
ABUYXLNK DS    XL2                 AGENCY BUY LINK NUMBER (FOR XML)             
*                                                                               
RSTRDATE DS    XL3                 (YMD) REP BUY START DATE                     
BUYGRID2 DS    XL53                BUYGRID FOR THE REP BUYLINE                  
*                                                                               
ASTRDATE DS    XL3                 (YMD) AGENCY BUY START DATE                  
*                                                                               
CPDATE   DS    0XL6                                                             
EARLIEST DS    XL3                 EARLIEST DATE OF ALL BUYS                    
LATEST   DS    XL3                 LATEST DATE OF ALL BUYS                      
GRSTDATE DS    XL3                 GRID START DATE ON DISPLAY LINE              
*                                                                               
MFLAG    DS    X                   FLAG FOR MATCHING BUYS                       
MASSUMEQ EQU   C'A'                DISPLAY LINES IN ASSUME MATCH                
MPROPSEQ EQU   C'P'                DISPLAY LINES IN PROPOSE MATCH               
MNOMTCHQ EQU   C'U'                DISPLAY LINES IN NO MATCH SECTION            
*                                                                               
LFLAG    DS    X                   FLAG FOR LINKED+UNMATCH BUYS                 
LASSUMEQ EQU   C'A'                DISPLAY LINES IN ASSUME MATCH                
LPROPSEQ EQU   C'P'                DISPLAY LINES IN PROPOSE MATCH               
LNOMTCHQ EQU   C'U'                DISPLAY LINES IN NO MATCH SECTION            
*                                                                               
CFLAG    DS    X                                                                
CSPDIFQ  EQU   X'80'               SHOW SPOT DIFFERENCE +/-                     
CFKAGYQ  EQU   X'40'               FAKE AGENCY BUY WITH 0 SPOTS                 
*XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX         
* NOTE!!! DO NOT CHANGE FIELDS IN THIS BOX                            X         
* STORAGE IN HERE MIRRORS SPACE STARTS FROM PRSFLG1                   X         
*XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX         
         DS    0F                                                               
DISFLG1  DS    X                   FLAG FOR DISPLAY                   X         
D1MATCHQ EQU   X'80'               AT LEAST ONE MATCH LINE WAS DISPLAYX         
DCONBAKQ EQU   X'40'               CONTINUATION ON SCROLL BACK        X         
D1UNMTHQ EQU   X'20'               UNMATCHING A MATCHING SEGMENT      X         
DCONTEEQ EQU   X'10'               THIS SCREEN IS A CONTINUATION OF   X         
*                                  THE PREVIOUS SCREEN(SEGMENT WISE)  X         
DCONTERQ EQU   X'08'               THIS SCREEN IS GOING TO HAVE A     X         
*                                  CONTINUATION AT THE NEXT SCREEN    X         
D1STREPQ EQU   X'04'               FIRST REP LINE IS DISPLYAED        X         
*                                                                     X         
DREPQ    EQU   X'02'               REP INFO JUST DISPLAYED            X         
*                                                                     X         
DBUYDISQ EQU   X'01'               AT LEAST ONE BUY IS DISPLAYED      X         
*                                                                     X         
DISFLG2  DS    X                   FLAG FOR DISPLAY                   X         
DMATCHQ  EQU   C'M'                AT LEAST ONE MATCH LINE WAS DISPLAYX         
DPMATCHQ EQU   C'P'                PROPOSE SECTION HEADER DISPLAYED   X         
DUMATCHQ EQU   C'U'                UNMATCH SECTION HEADER DISPLAYED   X         
*                                                                     X         
DISFLG3  DS    X                   FLAG FOR DISPLAY                   X         
D3ORBAG  EQU   X'80'               DISPLAY THE AGY LINE ONLY--FOR ORBIT         
D3MINI   EQU   X'10'                                                  X         
D3EOGRP  EQU   X'08'               END OF GROUP                       X         
D31STREP EQU   X'04'               FIRST REP LINE IS DISPLAYED(DAILY) X         
D3LGRID  EQU   X'02'               LARGE GRID                         X         
SCRNUM   DS    H                   CURRENT SCREEN NUMBER              X         
COUNT1   DS    H                   COUNTER FOR DAILY BUYS             X         
COUNT2   DS    H                   COUNTER FOR MATCHING                         
SVTYPE   DS    XL1                 SAVED TSAR RECORD SEGMENT TYPE     X         
CLEARQ   EQU   *-DISFLG1                                              X         
KEEPQ    EQU   *-DISFLG1                                              X         
* BLOCK END                                                           X         
*                                                                     X         
*XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX         
SVCOUNT2 DS    H                   SAVE FOR CONTINUATION                        
TYP      DS    C                   TYPE OF THE FIRST LINE OF THE NEXT           
*                                  SCREEN WITHIN THE SEGMENT                    
BUY#     DS    X                   BUY# OF THE FIRST LINE OF THE NEXT           
SUBBUY#  DS    X                   SCREEN WITHIN THE SEGMENT                    
*                                                                               
STATUS   DS    XL6                 ORDER STATUS                                 
STATUS2  DS    XL2                                                              
*                                                                               
COUNTER  DS    H                   DEBUG COUNTER                                
TABCT    DS    F                   TABLE ENTRY COUNTER                          
*                                                                               
COMPTSAR DS    XL(L'TLREC)         SAVED PREVIOUS TSAR FOR COMPARISON           
CMTFLAG  DS    X                   COMMENT PRINT FLAG                           
CMTSTAND EQU   X'80'               THERE ARE STANDARD COMMENTS                  
CMTORD   EQU   X'40'               THERE ARE ORDER COMMENTS                     
CMTREJ   EQU   X'20'               THERE ARE REJECTION COMMENTS                 
CMTBUY   EQU   X'10'               THERE ARE BUYLINE COMMENTS                   
*                                                                               
*                                                                               
ABUYTAB  DS    A                   A(BUYTAB)                                    
EOBUYTAB DS    H                   DISTANCE FROM END TO START OF TABLE          
MTCHTABL EQU   2                   ENTRY LENGTH = 2 (BYTE 1=AGY BUY)            
*                                                   (BYTE 2=REP BUY)            
GRPTERM  EQU   X'00'               GROUP TERMINATOR = X'00'                     
AEOTBLE  DS    A                   A(END OF LAST TOTALLY MATCH ENTRY            
*                                    IN THE MATCH TABLE)                        
*                                                                               
MTCHTAB  DS    CL1020              MAXIMUM 255 MATCH BUYS                       
         DS    CL1                 DELIMITER=X'FF'                              
MTCHTABQ EQU   *-MTCHTAB                                                        
*                                                                               
                                                                                
BUYTABL  EQU   3                   2 BYTE EXTERNAL + 1 BYTE INTERNAL            
BUYTAB   DS    XL762               254 * ( 2(EXT) + 1(INT) ) = 762              
BUYTABX  EQU   *-BUYTAB                                                         
         DS    CL1                 END OF TABLE = X'FF'                         
BUYTABQ  EQU   *-BUYTAB                                                         
*                                                                               
MTCHTABD DSECT                     DSECT FOR MTCHTAB                            
ABUY#    DS    XL1                 AGENCY BUY NUMBER                            
RBUY#    DS    XL1                 REP    BUY NUMBER                            
*                                                                               
BUYTABD  DSECT                     DSECT FOR MTCHTAB                            
INTBUY# DS     XL1                 AGENCY INTERNAL BUY#                         
EXTBUY# DS     XL2                 AGENCY EXTERNAL BUY#                         
         EJECT                                                                  
*                                                                               
* APPLICATION STORAGE AREA                                                      
*                                                                               
MYAREAD  DSECT                                                                  
RECREV   EQU   6                                                                
ACTAMD   EQU   14                                                               
ACTREJ   EQU   16                                                               
ACTDIF   EQU   17                                                               
RELO     DS    A                                                                
MYSVIO   DS    A                                                                
MYBUYTYP DS    CL1                                                              
MYBUY#   DS    XL2                                                              
MYFLAG1  DS    XL1                 X'80'=AGENCY BUY DISPLAYED                   
*                                  X'40'=FOUND BUY                              
*                                  X'20'=1 BUY IN THIS SEGMENT HAS BEEN         
*                                        DISPLAYED                              
*                                  X'10'=AT LEAST 1 BUY IS DISPLAYED            
*                                  X'08'=REMOTE REQUEST FROM LIST SCRN          
*                                  X'04'=MATCH AGENCY LINE AS WELL              
*                                  X'02'=RESERVED                               
*                                  X'01'=OUTPUT "BUY DISPLAYED" MESSAGE         
MYFLAG2  DS    XL1                 X'80'=CONTRACT VERSION WAS BUMPED            
TEMPFLAG DS    XL1                 USE FOR TEMPORARY FLAG                       
OFLAG1   DS    X                   DISPLAY OPTION FLAG 1                        
OUMATCHQ EQU   X'80'               DISPLAY UNMATCH                              
OMATCHQ  EQU   X'40'               DISPLAY MATCH                                
OPMATCHQ EQU   X'20'               DISPLAY PROPOSE MATCH                        
OSPTDIFQ EQU   X'10'               DISPLAY SPOT DIFFERENCE +/-                  
OASSUMEQ EQU   X'08'               ASSUME MATCH ALL PROPOSE LINK SEGMT          
*                                                                               
OVRDFLG  DS    X                   OVERRIDE FLAG                                
* THIS FLAG SHOULDN'T BE USED FOR OTHER PURPOSE                                 
OVDAYQ   EQU   X'80'               DAY IS OVERRIDED                             
OVTIMEQ  EQU   X'40'               TIME IS OVERRIDED                            
OVLENQ   EQU   X'20'               LENGTH IS OVERRIDED                          
OVRATEQ  EQU   X'10'               RATE IS OVERRIDED                            
OVPGMQ   EQU   X'08'               PROGRAM IS OVERRIDED                         
OVDSPTQ  EQU   X'04'               DATE/SPORTS IS OVERRIDED                     
OVDALLQ  EQU   X'02'               ONLY TURNED ON WHEN COMPARING TO             
*                                  NOTHING                                      
OVCNCLQ  EQU   X'01'               REP LINE WILL BE CANCELLED                   
*                                                                               
*                                                                               
TBLINDEX DS    XL2                 BUY LINK INDEX                               
SVTSAR#  DS    XL2                 SAVED TSAR RECORD NUMBER                     
TLACTN   DS    XL1                 REQUESTED ACTION                             
TLST     DS    XL(L'TLREC+2)       TSAR2 RECORD BUFFER                          
         ORG   TLST                                                             
TXNUM    DS    XL2                                                              
TXREC    DS    0X                                                               
TXLEN    DS    XL2                                                              
TXKEY    DS    0X                                                               
         ORG                                                                    
TBLOCK   DS    XL(TSARDL)          TSAR BUFFER                                  
*                                                                               
GSTRDATE DS    XL3                 (YMD) MISSED BUY START DATE FOR GRID         
GENDDATE DS    XL3                 (YMD) MISSED BUY START DATE FOR GRID         
BUYGRID  DS    XL(53*2)            FIRST BYTE = #SPT, 2ND BYTE =                
*                                  X'01' NPW                                    
*                                  X'02' NOT PART OF AGENCY BUY WEEK            
BSTRDATE DS    XL3                 START DATE USED IN GRID CALCULATIONS         
BMSS#SPT DS    X                                                                
MYWRK    DS    XL27                                                             
MSSTDT   DS    CL8                 BUY GRID START DATE                          
         DS    CL1                 SEPARATOR                                    
MSSTDT2  DS    CL8                 USER INPUT START DATE                        
         DS    CL1                 SEPARATOR                                    
MSSTDT3  DS    CL8                 USER INPUT END DATE                          
MSBUYEL  DS    XL11                BUY ELEMENT BUILD AREA                       
MSSTRDAY DS    X                                                                
MSENDDAY DS    X                                                                
*                                                                               
TSARREC  DS    XL(L'TLREC)                                                      
TSARREC2 DS    XL(L'TLREC)                                                      
TSARKEY  DS    XL(L'TLKEY)                                                      
*                                                                               
GTSSVREC DS    XL(L'TLREC)         SAVED TSARREC AREA                           
GTSSVTR# DS    XL2                 SAVED TSAR RECORD NUMBER                     
PRTXNUM  DS    XL2                 SAVED TSAR RECORD NUMBER FOR PRINT           
*                                                                               
*                                                                               
GNXSVIO  DS    A                                                                
GNXSVIOX DS    A                                                                
GNXSVREC DS    XL(L'TLREC)         SAVED TSARREC AREA                           
GNXSVDRC DS    XL(L'TLREC)         SAVED DAYS TSARREC AREA                      
GNXSVTR# DS    XL2                 SAVED TSAR RECORD NUMBER                     
*                                                                               
DLSVREC  DS    XL(L'TLREC)         SAVED TSARREC AREA FOR LIST DISPLAY          
         ORG   DLSVREC             RECYCLE                                      
APSVREC  DS    XL(L'TLREC)          SAVED TSARREC AREA FOR APPROVAL             
DLSVBLRC DS    XL(L'TLREC)         SAVED PREVIOUS BUY LINK AREA                 
DLSVTR#  DS    XL2                 SAVED TSAR RECORD NUMBER                     
PRSVTR#  DS    XL2                 SAVED TSAR# FOR PRINT ROUTINE                
PVSVTR#  DS    XL2                 SAVED 'PREVIOUS' TSAR RECORD NUMBER          
CRSVTR#  DS    XL2                 SAVED 'CURRENT' TSAR RECORD NUMBER           
UPSVTR#  DS    XL2                 SAVED TSAR# FOR UPDTBUYS ROUTINE             
CGSVTR#  DS    XL2                 SAVED TSAR# FOR COMPGRID ROUTINE             
DMSVTR#  DS    XL2                 SAVED TSAR# FOR DOMATCH ROUTINE              
DUSVTR#  DS    XL2                 SAVED TSAR# FOR DOUNMATCH ROUTINE            
*                                                                               
HDRDA    DS    XL4                 DISK ADDRESS OF DARE HEADER RECORD           
SVCONADV DS    CL4                                                              
SVCONPRD DS    CL3                                                              
SVCONREP DS    CL2                                                              
*                                                                               
WORK2    DS    300C                WORK SPACE FOR BUCKET BUILD                  
*                                     AND GENERAL COMPARISONS                   
AGY#     DS    X                                                                
REP#     DS    X                                                                
DAILY#   DS    X                                                                
SVAGLNK  DS    X                   SAVED PREVIOUS AGENCY LINK                   
TSRNUMA  DS    XL2                 SEGMENT TSRNUM OF THE AGENCY LINE            
*                                                                               
TSRNUMR  DS    XL2                 SEGMENT TSRNUM OF THE REP LINE               
*                                                                               
GCPDATE  DS    0XL6                GRID COMPARISON DATE                         
GERLIEST DS    XL3                 EARLIEST DATE OF ALL BUYS                    
GLATEST  DS    XL3                 EARLIEST DATE OF ALL BUYS                    
*                                                                               
SAVER2   DS    A                                                                
ORBCTR   DS    H                   ORBIT COUNTER                                
MYCOUNT  DS    H                   MY COUNTER FOR DEBUG                         
*                                                                               
BYTE1    DS    X                   ANOTHER BYTE                                 
BYTE2    DS    X                                                                
SRCHFLG  DS    X                   SEARCH FLAG                                  
SRCHMTH  EQU   C'M'                C'M' = FIND EXACT MATCH                      
SRCHAGY  EQU   C'A'                C'A' = FIND MATCHING AGY ONLY                
SRCHNOM  EQU   C'N'                C'N' = NO MATCH                              
*                                                                               
* FOR ALL BUY GRIDS                FIRST BYTE = #SPT, 2ND BYTE =                
*                                  X'01' NPW                                    
*                                  X'02' NOT PART OF AGENCY BUY WEEK            
*                                                                               
ABUYGRID DS    XL(53*2)            BUYGRID FOR THE AGY BUYLINE                  
RBUYGRID DS    XL(53*2)            BUYGRID FOR THE REP BUYLINE                  
REPGRID  DS    XL(53*2)            BUYGRID FOR A REP BUYLINE                    
SVGRID   DS    XL(53*2)            TEMPORARY GRID                               
TEMPDATE DS    XL3                 TEMPORARY DATE                               
*                                                                               
*                                                                               
MYELEM   DS    CL256               REUSE REJMESS AREA                           
CMTSTRDT DS    XL3                                                              
CMTENDDT DS    XL3                                                              
CMTNUMWK DS    X                                                                
CMTNUMSP DS    X                                                                
         ORG   MYELEM                                                           
AGYBTAB  DS    XL(2*255)           REUSE REJMESS AREA                           
*                                  AGENCY BUY LINE TABLE                        
         ORG   MYELEM                                                           
REJMESS  DS    600C                REJECTION MESSAGE BUILD AREA                 
*                                                                               
ASBUYDA  DS    XL(4*255)           AGENCY SHADOW BUY D/A LIST                   
RBUYDA   DS    XL(4*255)           REPPAK BUY D/A LIST                          
*                                                                               
WORKLQ   EQU   *-MYAREAD                                                        
FF       EQU   X'FF'                                                            
*                                                                               
* ONLINE LIST LINE                                                              
*                                                                               
GEND     DSECT                                                                  
         ORG   LISTAR                                                           
LSTRHDLN DS    CL8                                                              
         DS    CL1                                                              
LSTRAORN DS    CL8                                                              
         DS    CL1                                                              
LSTRSTA  DS    CL6                                                              
         DS    CL1                                                              
LSTRAGY  DS    CL5                                                              
         EJECT                                                                  
ORDAPREJ DSECT                                                                  
ARTRANID DS    CL6                                                              
ARORDNUM DS    CL8                                                              
ARFROM   DS    CL10                                                             
ARTO     DS    CL10                                                             
ARDATE   DS    CL6                                                              
ARTIME   DS    CL4                                                              
ARSTAT   DS    CL6                                                              
ARCON#   DS    CL8                                                              
ARRETSND DS    CL16                                                             
ARDDS    DS    CL3                                                              
         SPACE 4                                                                
ORDCOM   DSECT                                                                  
OCTRANID DS    CL6                                                              
OCORDNUM DS    CL8                                                              
OCCONTIN DS    CL1                                                              
OCBUYLIN DS    CL4                                                              
OCCOMMNT DS    CL70                                                             
OCDDS    DS    CL3                                                              
         SPACE 4                                                                
ORDSAL   DSECT                                                                  
OSTRANID DS    CL6                                                              
OSORDNUM DS    CL8                                                              
OSSPPCDE DS    CL3                                                              
OSSPPNME DS    CL20                                                             
         SPACE 4                                                                
ORDTRLR  DSECT                                                                  
OTTRANID DS    CL6                                                              
OTORDNUM DS    CL8                                                              
OTCOUNT  DS    CL6                                                              
*                                                                               
* IF ANY OF THE BELOW FIELDS CHANGE, MAKE SURE TO CHANGE THE PARAMETERS         
* IN THE XSORT CALLS ABOVE                                                      
*                                                                               
SORTD    DSECT                                                                  
SRTAGYBY DS    X                   AGENCY BUY THAT K BUY IS MAPPED TO           
*                                  X'FF' MEANS K BUY ADDED MANUALLY             
SRTTKBUY DS    X                   TARGET K BUY (FOR MAKEGOOD/CREDIT)           
SRTCONBY DS    X                   K BUY                                        
SRTBUYDA DS    XL4                 CONTRACT BUY DISK ADDRESS                    
SRTFLAGS DS    X                   MISC. FLAGS                                  
SFMATCHD EQU   X'80'               K BUY WAS MATCHED                            
SFMATING EQU   X'40'               K BUY IS IN PROCESS OF MATCHING              
SFMKGOOD EQU   X'20'               K BUY IS A MAKEGOOD                          
SFCREDIT EQU   X'10'               K BUY IS A CREDIT                            
SFTMKGD  EQU   X'08'               K BUY IS TARGET MAKEGOOD                     
SFTCRDT  EQU   X'04'               K BUY IS TARGET CREDIT                       
SFADDED  EQU   X'02'               K BUY WAS ADDED AT THIS APPROVAL             
SFTKMKGD EQU   X'01'               K BUY IS A TAKEOVER MAKEGOOD                 
SRTFLG2  DS    X                                                                
SF2METH1 EQU   X'80'               AUTO METHOD 1                                
SF2METH2 EQU   X'40'               AUTO METHOD 2                                
SF2METH3 EQU   X'20'               AUTO METHOD 3                                
SF20SPTS EQU   X'10'               CONTRACT BUY HAS ZERO TOTAL SPOTS            
SF20CSTS EQU   X'08'               CONTRACT BUY HAS ZERO TOTAL DOLLARS          
SF2MGOF  EQU   X'04'               CONTRACT BUY HAS PENDING MKGD OFFERS         
SF2CAN   EQU   X'02'               CANCELLED BY 0 SPOT OVERRIDE                 
SORTDLQ  EQU   *-SORTD                                                          
*                                                                               
SLINKD   DSECT SHOW LINK ON SCREEN                                              
SLAGYBUY DS    CL3                                                              
         DS    C                                                                
SLKBUY   DS    CL3                                                              
         DS    C                                                                
SLTKBUY  DS    CL3                                                              
         DS    C                                                                
SLFLAGS  DS    CL23                                                             
*----------------------------------------------------------------------         
TLSTD    DSECT                     TSAR RECORD DSECT                            
TLREC    DS    0XL255              *** TSAR RECORD ***                          
TLLEN    DS    XL2                 RECORD LENGTH                                
*&&LN                                                                           
TLKEY    DS    0XL22               *** TSAR KEY ***                             
*&&                                                                             
*&&LP                                                                           
TLKEY    DS    0XL36               *** TSAR KEY ***                             
*&&                                                                             
TLKTYP   DS    XL1                 TSAR RECORD TYPE                             
*                                    - X'01' DAYS                               
*                                    - X'02' TIMES                              
*                                    - X'03' PROGRAM NAME                       
*                                    - X'04' GRID                               
*                                    - X'05' PROGRAM NAME BASE ON LIN#          
*                                    - X'0B' BUY SEGMENT                        
*                                    - X'0C' ANOTHER BUY SEGMENT REC            
*                                    - X'0E' REVERSE POINTER REC                
*                                    - C'A'  AGENCY BUY LINKS                   
*                                    - C'R'  REP BUY LINKS                      
*                                    - C'V'  REVERSE SORT POINTER               
*                                    - C'W'  SCROLL RECORD                      
*                                    - C'X'  DUMMY BUY SEGMENT                  
*                                    - C'Z'  AGENCY LINK RECORD                 
*                                                                               
TLDATA   DS    0X                                                               
         EJECT                                                                  
*---------------------------------------*                                       
* KEY FOR 'DAYS' RECORD - X'01' DAYS                                            
*---------------------------------------*                                       
         ORG   TLDATA                                                           
TLDYSTEN DS    XL1                 START-END DAY INDICATOR                      
TLDYDAYS DS    XL1                 DAY(S)                                       
*                                                                               
*---------------------------------------*                                       
* KEY FOR 'TIMES' RECORD - X'02' TIMES                                          
*---------------------------------------*                                       
         ORG   TLDATA                                                           
TLTMSTRT DS    XL2                 START TIME                                   
TLTMENDT DS    XL2                 END TIME                                     
*----------------------------------------------------*                          
* KEY FOR 'PROGRAM NAME' RECORD - X'03' PROGRAM NAME                            
*----------------------------------------------------*                          
         ORG   TLDATA                                                           
TLPGLEN  DS    XL2                                                              
TLPGNAME DS    0C                  PROGRAM NAME                                 
*---------------------------------------*                                       
* KEY FOR 'PROGRAM NAME' RECORD BASE ON BUYLINE#                                
*---------------------------------------*                                       
         ORG   TLDATA                                                           
TLPTYP   DS    X                   FLAG, C'A' = AGY                             
*                                        C'R' = REP                             
TLPLN#   DS    XL1                 BUY LINE#                                    
         DS    XL(L'TLKEY-L'TLPTYP-L'TLPLN#)                                    
TLPGM    DS    0C                  PROGRAM NAME                                 
*---------------------------------------*                                       
* KEY FOR 'BUY SEGMENT' RECORD  = X'0B', C'X'                                   
*---------------------------------------*                                       
         ORG   TLDATA                                                           
TLBYFLG  DS    XL1                                                              
TLMTHQ   EQU   C'M'                C'M' - MATCHED                               
TLLNKQ   EQU   C'Q'                C'Q' - UNMATCH BUT LINKED                    
TLMTHQ2  EQU   C'T'                C'T' - MATCHED(ANOTHER SORT SEQ)             
TLMTHQ3  EQU   C'V'                C'V' - MATCHED(TOTALLY)                      
TLUMTHQ  EQU   X'FF'               X'FF' - UNMATCH AND NOT-LINKED               
TLBYTYPA DS    XL1                 NULL UNLESS IT IS AN AGY SEG                 
TLTYPAQ  EQU   C'A'                NULL UNLESS IT IS AN AGY SEG                 
*                                  THAT LINKS TO A REP SEGMENT                  
TLBYLNK  DS    XL1                 AGY LINK NUMBER                              
TLBYMLNK DS    XL1                 MASTER LINK - THIS IS USED                   
*                                  FOR MULTIPLE DAILY/COST OVERRIDE             
*                                  BUYS TO CHAIN TOGETHER.                      
TLINDXLQ EQU   *-TLKTYP                                                         
TLBYSUBL DS    XL1                 SUB LINE (FOR SORTING)                       
*                                                                               
*                                                                               
TLBYDAY  DS    XL2                 DAY INDEX                                    
TLBYTIME DS    XL2                 TIME INDEX                                   
TLBYLEN  DS    XL2                 LENGTH IN SECONDS                            
TLBYRATE DS    XL4                 RATE                                         
*                                                                               
TLBYPROG DS    XL2                 PROGRAM NAME INDEX                           
TLBYMKG  DS    CL1                 Y=MAKEGOOD, N=NOT MAKEGOOD                   
TLBYMIDT DS    XL1                 MAKEGOOD TYPE (A=AGY, R=REP)                 
TLBYMID  DS    XL1                 MAKEGOOD NUMBER                              
TLBYUID  DS    XL1                 FIELD TO MAKE THIS SEGMENT UNIQUE            
*                                                                               
TLBYKLQ  EQU   *-TLKTYP                                                         
*&&LP                                                                           
         DS    XL(L'TLKEY-TLBYKLQ)  KEY SPARE                                   
*&&                                                                             
                                                                                
*                                                                               
TLBYFLG2 DS    XL1                 C'M' - MATCHED                               
*                                  C'Q' - UNMATCH BUT LINKED                    
*                                  X'00' - UNMATCH AND NOT-LINKED               
TLBYLNKT DS    XL1                 AGY LINK NUMBER                              
TLBYMNUM DS    XL1                 MATCH NUMBER                                 
TLBYMLKT DS    XL1                 SAVED MASTER LINK                            
TLBYSUB1 DS    XL1                 SUB LINE (SAME AS TLBYSUBL)                  
TLBYSID1 DS    XL1                 SUB ID (SAME AS TLBYSID)                     
TLBYTYP2 DS    CL1                 TYPE = C'A' FOR AGENY LINK                   
*                                                                               
TLBYFLG3 DS    XL1                                                              
*                                  X'80' - SKIP THIS SEGMT ON DISPLAY           
*                                  X'40' - REP LINES ARE DISPLAYED              
*                                  X'20' - AGY LINES ARE DISPLAYED              
*                                  X'10' - MATCH DAILY/C.O TREATED AS           
*                                          LINK                                 
*                                  X'08' - SEGMENT ALREADY PROCESSED            
*                                          (ONLY SET BY OPEN ROUTINE)           
*                                  X'04' - SEGMENT ALREADY PROCESSED            
*                                          (ONLY SET BY PROCLNK2)               
*                                  X'02' - DAILY BUY GROUP HAS ORPHAN           
*                                          SEGMENT                              
*                                  X'01' - DAILY BUY GROUP NOT TOTALLY          
*                                          MATCHED                              
TLBYFLG4 DS    XL1                                                              
*                                  X'80' - AGENCY CANCELLED DAILY BUY           
*                                  X'40' - THIS IS A ORPHAN REP SEGMENT         
*                                  X'20' - THERE IS A LINK LINE                 
*                                  X'10' - THIS IS AN ADD-TO-SKED               
*                                  X'01' - THIS IS A DAILY BUY                  
*                                  X'02' - THERE IS AN ADD-TO-SKED              
*                                  X'04' - THIS IS A CANCELLATION               
*                                  X'08' - SYSTEM FORCE MATCH DAILY             
TLBYWKOF DS    XL2                 WEEK-OF                                      
*                                  NOTE: WEEK-OF NOW SERVE THE PURPOSE          
*                                  OF TELLING US WHAT THE EARLIEST              
*                                  START DATE OF THE SEGMENT IS                 
TLBYRFLG DS    X                   REP FLAGS                                    
*                                  X'80' = LENGTH IS IN MINUTES                 
*                                  X'40' = TLBYRLNK IS A LINK POINTER           
*                                          ELSE IT IS THE ACTUAL LINE#          
*                                  X'01' = SPECIAL FOR DISPLAY:                 
*                                          FLAG THIS RECORD IF THIS IS          
*                                          THE FIRST RECORD ON THE TOP          
*                                          OF THE SCREEN. THIS WILL             
*                                          ALLOW US TO SCROLL BACK TO           
*                                          THE CORRECT RECORD                   
TLBYAFLG DS    X                   AGENCY FLAGS                                 
*                                  X'80' = LENGTH IS IN MINUTES                 
*                                  X'40' = TLBYALNK IS A LINK POINTER           
*                                          ELSE IT IS THE ACTUAL LINE#          
*                                                                               
TLBYRLNK DS    XL2                 REP BUY LINK POINTER IF TLBYRFLG             
*                                  HAS X'40' ON. OTHERWISE THIS IS              
*                                  THE ACTUAL BUY LINE NUMBER                   
*                                  AND NUMBER OF SPOTS FOR THIS SEGMEMT         
*                                                                               
         DS    XL1                 THIS HAS PRACTICALLY NO USE AND              
*                                  MUST BE NULL                                 
*                                  I KEEP IT FOR SIMPLER PROCESSING             
*                                                                               
TLBYRSPT DS    XL2                 REP TOTAL SPOT                               
TLBYRFG2 DS    XL1                 FLAG FOR THIS REP LINE                       
*                                  X'80' = THIS LINE IS A MAKEGOOD              
TLBYRLNQ EQU   *-TLBYRLNK                                                       
TLBYALNK DS    XL2                 AGENCY BUY LINK POINTER IF TLBYAFLG          
*                                  HAS X'40' ON. OTHERWISE THIS IS              
*                                  THE ACTUAL BUY LINE NUMBER                   
*                                  AND NUMBER OF SPOTS FOR THIS SEGMEMT         
TLBYASUB DS    XL1                                                              
TLBYASPT DS    XL2                 AGY TOTAL SPOT                               
TLBYAFG2 DS    XL1                 FLAG FOR THIS AGY LINE                       
*                                  X'80' = THIS LINE IS A MAKEGOOD              
TLBYALNQ EQU   *-TLBYALNK                                                       
TLBYALLQ EQU   *-TLBYRFLG                                                       
TLBYLQ   EQU   *-TLSTD                                                          
*---------------------------------------*                                       
* KEY FOR AGENCY/REP 'BUY LINK' RECORD                                          
*---------------------------------------*                                       
         ORG   TLDATA                                                           
TLBLINDX DS    XL2                 LINK INDEX POINTED FROM BUY SEGMENT          
*                                  FOR THIS WEEK                                
         DS    XL(L'TLKEY-L'TLKTYP-L'TLBLINDX)  KEY SPARE                       
*                                                                               
TLBLTSPT DS    X                   TOTAL NUMBER OF REP OR AGENY SPOTS           
TLBLBUY# DS    X                   AGENCY OR REP BUY NUMBERS                    
         DS    X                   DO NOT USE                                   
TLBLSUB# DS    X                   SUB LINE IF MUTLI-LINK BUYS                  
TLBL#SPT DS    XL2                 AND CORRESPONDING NUMBER OF SPOTS            
TLBLFLG  DS    X                   MISCFLG FOR THIS PARTICULAR BUY              
*                                  X'80'=MAKEGOOD BUY                           
*                                  X'40'=PROCESSED ALREADY(OPEN LOGIC)          
TLBLLENQ EQU   *-TLBLBUY#          UNIT SIZE FOR ONE BUY                        
TLBLLEN2 EQU   *-TLSTD             FIX PORTION                                  
TLBLLIST DS    0X                                                               
*---------------------------------------*                                       
* KEY FOR AGENCY/REP -> BUY SEG REVERSE POINTER RECORD                          
*---------------------------------------*                                       
         ORG   TLDATA                                                           
TLBPTYP  DS    CL1                 C'A' = AGENCY                                
*                                  C'R' = REP                                   
TLBPBUY# DS    X                   BUY NUMBER                                   
         DS    XL(L'TLKEY-L'TLKTYP-L'TLBPTYP-L'TLBPBUY#)                        
TLBPSEG# DS    XL2                 SEGMENT NUMBER                               
TLBPMLNK DS    XL1                 NOT NULL = DAILY/C.O                         
TLBPLQ   EQU   *-TLSTD                                                          
*                                                                               
*---------------------------------------*                                       
* KEY FOR 'SCROLL TABLE' RECORD                                                 
*---------------------------------------*                                       
         ORG   TLDATA                                                           
TLSCKEY  DS    H                   SCREEN NUMBER                                
         DS    XL(L'TLKEY-L'TLKTYP-L'TLSCKEY)  KEY SPARE                        
TLSCPTR  DS    H                   POINTER TO THE FIRST RECORD ON THIS          
*                                  SCREEN                                       
TLSCFLG  DS    X                   X'80' = THIS SCREEN IS A CONTINUAT           
*                                  ION OF THE PREVIOUS SCREEN                   
*                                  AND TLSCBY# WILL HAVE THE NUMBER OF          
*                                  THE BUY THAT IT STARTS AT                    
*                                  X'40' = AGY PART OF THE ORBIT BUY            
*                                                                               
TLSCBY#  DS    X                   BUY#                                         
TLSCSUBL DS    X                   SUB BUY#                                     
TLSCTYP  DS    X                   SVTYPE FOR THIS SCREEN                       
TLSCFLG2 DS    X                   DISFLG2 FOR THIS SCREEN                      
TLSCCTYP DS    X                   CONTINUATION TYPE                            
TLSCLQ   EQU   *-TLSTD                                                          
TLSCLQ2  EQU   *-TLSCPTR                                                        
*                                                                               
*---------------------------------------*                                       
* KEY FOR BUY GRID RECORD - X'04' GRID                                          
*---------------------------------------*                                       
         ORG   TLDATA                                                           
TLGTYP   DS    X                   FLAG, C'A' = AGY                             
*                                        C'R' = REP                             
TLGLN#   DS    XL1                 BUY LINE#                                    
TLGSUB#  DS    XL1                 SUB LINE# (C.O/DAILY)                        
         DS    XL(L'TLKEY-L'TLKTYP-L'TLGLN#-L'TLGTYP-L'TLGSUB#)                 
TLGPGM   DS    CL10                PROGRAM NAME                                 
TLGFLG   DS    X                   MISC FLAG                                    
TLGSTD   DS    XL3                 START DATE                                   
TLGEND   DS    XL3                 END DATE                                     
TLGTOT   DS    XL2                 TOTAL SPOT NUMBER                            
TLGRID   DS    XL(TLGRWKQ*2)       GRID                                         
TLGRIDX  DS    XL2                                                              
TLGRLQ   EQU   *-TLSTD             GRID RECORD LENGTH                           
TLGRLQ2  EQU   *-TLGSTD            L'(START DATE + GRID)                        
TLGRSIZE EQU   2                   GRID UNIT SIZE                               
TLGRWKQ  EQU   53                                                               
*                                                                               
*---------------------------------------*                                       
* KEY FOR 'AGY LINK SEGMENT' RECORD                                             
* THESE ARE THE UNMATCHED BUT LINKED AGENCY LINK RECORD                         
*---------------------------------------*                                       
         ORG   TLDATA                                                           
TLXTYPQ  EQU   C'Z'                TSAR RECORD TYPE EQUATE                      
TLXYBY#  DS    XL1                 BUY NUMBER                                   
         DS    XL(L'TLKEY-L'TLKTYP-L'TLXYBY#)  KEY SPARE                        
TLXYDAY  DS    XL2                 DAY INDEX                                    
TLXYTIME DS    XL2                 TIME INDEX                                   
TLXYLEN  DS    XL2                 LENGTH IN SECONDS                            
TLXYRATE DS    XL4                 RATE                                         
TLXYPROG DS    XL2                 PROGRAM NAME INDEX                           
TLXYMKG  DS    CL1                 Y=MAKEGOOD, N=NOT MAKEGOOD                   
TLXKEYQ  EQU   *-TLXYDAY           POTION OF KEY                                
TLXYLQ   EQU   *-TLSTD                                                          
*                                                                               
LISTLEN  EQU   DIFLIS2-DIFLIST     LIST LENGTH                                  
LISTLENP EQU   LISTLEN+(PRTWKQ-SQZWKQ)*DSGRIDQ+10                               
*                                                                               
* DSECT FOR DISPLAY LINE                                                        
*                                                                               
DIFFSUM  DSECT                     DIFFERENCE SQUEEZ LINE DSECT                 
DSCOLORH DS    CL8                 HEADER                                       
DSCOLOR  DS    CL1                 COLOR FOR AGENCY LINES                       
*                                                                               
DSINPUTH DS    CL8                 HEADER                                       
DSINPUT  DS    CL1                                                              
INPUTM   EQU   C'M'                                                             
INPUTU   EQU   C' '                SPACE                                        
*                                                                               
DSTYPAH  DS    CL8                 HEADER                                       
DSTYPA   DS    CL1                 AGENCY INDICATOR                             
DSAGYBY  DS    CL2                 LINE NUMBER                                  
*                                                                               
DSLINEH  DS    CL8                 HEADER                                       
DSLINE   DS    0CL71               HEADER                                       
DSTYPR   DS    CL1       1         REP INDICATOR                                
DSREPBY  DS    CL2       3         REP BUY NUMBERS                              
DSMKG    DS    CL1       4         * FOR MKGOOD                                 
DSBUY    DS    0C                  BUY INFO                                     
DSDYTM   DS    CL19                DAY/TIME                                     
         ORG   DSDYTM                                                           
DSDAY    DS    CL7                 DAY                                          
         DS    CL1                                                              
DSTIME   DS    CL11      23        TIME                                         
         DS    CL1       24                                                     
DSLEN    DS    CL3       27        LENGTH                                       
         DS    CL1       28                                                     
DSRATE   DS    CL7       35        RATE                                         
         DS    CL1       36                                                     
*                                                                               
DSBUYQ   EQU   *-DSBUY             LENGTH FOR SQUASHER  43                      
*                                                                               
DSPGM    DS    CL5       41        PROGRAM NAME                                 
*        DS    CL1       43                                                     
DSGRID   DS    CL27      72                                                     
DSLINEX  DS    0C                  END MARKER                                   
DSBUYLQ  EQU   *-DSTYPR            71,FOR THE LAST PORTION OF LIST              
DSLISTQ  EQU   *-DIFFSUM           TOTAL LENGTH FOR THE LIST LINE               
         ORG   DSLINE+43                                                        
DSCMMT   DS    CL76                COMMENT                                      
*                                                                               
MAXPGM   EQU   10                  MAX LENGTH FOR PROGRAM NAME                  
SQZBUYQ  EQU   31                  MAX LENGTH FOR SQZ BUY LENGTH                
EXPBUYQ  EQU   40                  MAX LENGTH FOR EXP BUY LENGTH                
DSGRIDQ  EQU   3                   GRID UNIT SIZE (INCLUDING SPACE)             
SQZWKQ   EQU   13                  NUMBER OF WEEKS FOR SQZ                      
EXPWKQ   EQU   10                  NUMBER OF WEEKS FOR EXP                      
PRTWKQ   EQU   30                  NUMBER OF WEEKS FOR PRINTING                 
EXPRTWKQ EQU   28                  NUMBER OF WEEKS FOR EXPAND PRINTING          
PRTWK2Q  EQU   22                  NUMBER OF WEEKS FOR 2ND LINE PRINT           
         ORG   DSDYTM                                                           
PDSDYTM  DS    CL24                DAY/TIME                                     
         DS    CL1                                                              
PDSLEN   DS    CL3                 LENGTH                                       
         DS    CL1                                                              
PDSRATE  DS    CL12                RATE                                         
         DS    CL1                                                              
PDSDATES DS    CL10                DATES                                        
         DS    CL1                                                              
PDS#SPT  DS    CL4                 +/- NUMBER OF SPOTS                          
         DS    CL1                                                              
PDSPGM   DS    CL20                PROGRAM NAME                                 
         DS    CL1                                                              
PDSRBUY# DS    CL20                REP BUY NUMBERS                              
         DS    CL1                                                              
PDST#SPT DS    CL5                 TOTAL SPOT DIFFERENCE                        
         DS    CL1                                                              
PDST$    DS    CL16                TOTAL DOLLAR DIFFERENCE                      
*                                                                               
REPCOLOR EQU   C'X'                = DEFAULT COLOR =BLACK                       
AGYCOLOR EQU   C'R'                = RED                                        
NOCOLOR  EQU   C'X'                = BLACK ALSO                                 
*                                                                               
DIFFSUMP DSECT                     DIFFERENCE SQUEEZ LINE FOR PRINT OUT         
DSINPUTP DS    CL1                 USER INPUT (M)                               
         DS    CL1                                                              
*                                                                               
DSTYPAP  DS    CL1                 AGENCY INDICATOR                             
DSAGYBYP DS    CL2                 LINE NUMBER                                  
         DS    CL1                                                              
*                        71                                                     
DSLINEP  DS    0CL129              HEADER                                       
         DS    CL30                                                             
DSGRIDP  DS    CL78                                                             
*                                                                               
DSLINEXP DS    0C                  END MARKER                                   
DSBUYLQP EQU   *-DSLINEP           71,FOR THE LAST PORTION OF LIST              
*                                                                               
*                                                                               
G8WORKD  DSECT                                                                  
G8SVAIO  DS    A                                                                
G8IO     DS    XL1000                                                           
G8WORKQ  EQU   *-G8WORKD                                                        
*                                                                               
IMWORKD  DSECT                                                                  
IMSVIO   DS    A                                                                
IMSVKEY  DS    XL27                                                             
IMIO     DS    XL2000                                                           
IMWORKQ  EQU   *-IMWORKD                                                        
*                                                                               
DLWORKD  DSECT                                                                  
DLIO     DS    XL(4*L'TSARREC)                                                  
         ORG   DLIO                                                             
DLWORK   DS    XL255                                                            
DLWORK2  DS    XL255                                                            
DLWORK3  DS    XL255                                                            
DLWORK4  DS    XL255                                                            
DLSVIO   DS    XL4                                                              
DLSVKEY  DS    XL32                                                             
DLBYTE   DS    XL1                                                              
DLBYTE2  DS    XL1                                                              
DLTSRNUM DS    H                                                                
DLHALF   DS    H                                                                
DLHALF1  DS    H                                                                
DLHALF2  DS    H                                                                
DLWORKQ  EQU   *-DLWORKD                                                        
*                                                                               
SMWORKD  DSECT                                                                  
SMWORK1  DS    XL(L'TSARREC)                                                    
SMWORK2  DS    XL(L'TSARREC)                                                    
SMTXNUM  DS    XL2                                                              
SMWORKQ  EQU   *-SMWORKD                                                        
*                                                                               
BLWORKD  DSECT                                                                  
BLIO     DS    XL(4*L'TSARREC)                                                  
BLWORK   DS    XL255                                                            
BLWORK2  DS    XL255                                                            
BLWORK3  DS    XL255                                                            
BLWORK4  DS    XL255                                                            
BLSVIO   DS    XL4                                                              
BLSVKEY  DS    XL32                                                             
BLBYTE   DS    XL1                                                              
BLBYTE2  DS    XL1                                                              
BLTSRNUM DS    H                                                                
BLHALF   DS    H                                                                
BLHALF1  DS    H                                                                
BLHALF2  DS    H                                                                
BLWORKQ  EQU   *-BLWORKD                                                        
*                                                                               
BBCWORKD DSECT                                                                  
BBCAIO   DS    A                                                                
BBCRIO   DS    A                                                                
BBCFLAG  DS    X                                                                
BBCAGRID DS    XL(53*2)                                                         
BBCRGRID DS    XL(53*2)                                                         
BBCCTR   DS    X                                                                
BBCWKLSC DS    X                   WEEK OF LAST SPOT CHANGED                    
BBCMODCD DS    XL100                                                            
BBCELEM  DS    XL500                                                            
BBCWORKQ EQU   *-BBCWORKD                                                       
*                                                                               
*                                                                               
DOSMWKD  DSECT                                                                  
DOSSVTR# DS    XL2                 SAVED TSAR# FOR DOMATCH ROUTINE              
*                                                                               
RTSARREC DS    XL(L'TLREC)                                                      
ATSARREC DS    XL(L'TLREC)                                                      
DOSMWKQ  EQU   *-DOSMWKD                                                        
*                                                                               
DOCADDD  DSECT                                                                  
DOCASVKY DS    XL(L'TLKEY)                                                      
*                                                                               
DOCADDQ  EQU   *-DOCADDD                                                        
*                                                                               
PRWORKD  DSECT                                                                  
PRWORK   DS    XL(L'TSARREC)                                                    
PRWORK2  DS    XL(L'TSARREC)                                                    
PRWORK3  DS    XL(L'TSARREC)                                                    
*XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX                           
* NOTE!!! DO NOT INSERT FIELDS IN THIS BOX          X                           
* STORAGE IN HERE MIRRORS SPACE STARTS FROM DISFLG1 X                           
*XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX                           
         DS    0F                                                               
PRBYTE   DS    X                                    X                           
PRBYTE2  DS    X                                    X                           
PRBYTE3  DS    X                                    X                           
PRSCRNUM DS    H                                    X                           
PRCOUNT1 DS    H                                    X                           
PRCOUNT2 DS    H                                    X                           
PRSVTYPE DS    X                                    X                           
*XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX                           
*                                                                               
PRSVSDTE DS    XL3                                  X                           
*                                                                               
PRFLAG1  DS    X                                                                
PBUYDISQ EQU   X'80'                                                            
*              X'40'               LINE TRANSLATION IS SKIPPED                  
PRTSRNUM DS    H                                                                
PRIO     DS    XL(MAXPLINE*LISTLENP)                                            
PRIOX    DS    X                                                                
MAXPLINE EQU   70                                                               
PRWORKQ  EQU   *-PRWORKD                                                        
*                                                                               
ELWORKD  DSECT                                                                  
ELWORK   DS    XL255                                                            
ELWORK2  DS    XL255                                                            
ELWORK3  DS    XL255                                                            
ELWORK4  DS    XL255                                                            
ELIO3    DS    XL2000                                                           
ELSVIO   DS    XL4                                                              
ELSVKEY  DS    XL32                                                             
ELBYTE   DS    XL1                                                              
ELBYTE2  DS    XL1                                                              
ELTSRNUM DS    H                                                                
ELTSRNM2 DS    H                                                                
ELWORKQ  EQU   *-ELWORKD                                                        
*                                                                               
AGYCMTD  DSECT                                                                  
AGWORK   DS    XL255                                                            
AGWORK2  DS    XL255                                                            
AGWORK3  DS    XL255                                                            
AGWORK4  DS    XL255                                                            
AGSVIO   DS    XL4                                                              
AGSVKEY  DS    XL32                                                             
AGBYTE   DS    XL1                                                              
AGBYTE2  DS    XL1                                                              
AGTSRNUM DS    H                                                                
AGTSRNM2 DS    H                                                                
AGIO3    DS    XL4000                                                           
AGYCMTQ EQU    *-AGYCMTD                                                        
*                                                                               
PRHEAD   DSECT                                                                  
PRALBL   DS    CL20                                                             
         DS    CL1                                                              
PRACODE  DS    CL9                                                              
         DS    CL1                                                              
PRANAME  DS    CL20                                                             
         DS    CL14                                                             
*                                                                               
PRRLBL   DS    CL20                                                             
         DS    CL1                                                              
PRRCODE  DS    CL9                                                              
         DS    CL1                                                              
PRRNAME  DS    CL20                                                             
PRHEADQ  EQU   *-PRHEAD                                                         
*                                                                               
COMMTD   DSECT                                                                  
         DS    CL10                                                             
CMLBL    DS    CL40                                                             
         DS    CL2                                                              
CMCMT    DS    CL76                                                             
T80F24   CSECT                                                                  
         ORG   T80F24+(((*-T80F24)/2048)+1)*2048                                
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'001REDAR24   04/16/10'                                      
         END                                                                    
