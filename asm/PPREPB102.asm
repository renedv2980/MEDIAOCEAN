*          DATA SET PPREPB102  AT LEVEL 184 AS OF 01/20/21                      
*PHASE PPB102A                                                                  
*INCLUDE COVAIL                                                                 
*INCLUDE FINDOUTP                                                               
*INCLUDE CENTER                                                                 
*INCLUDE CHOPPER                                                                
*INCLUDE PPBVAL                                                                 
*INCLUDE GETUSER                                                                
*INCLUDE PPFMTINO                                                               
*INCLUDE PPGETBFR                                                               
*INCLUDE DDUCOM             (ADDED 10/00)                                       
*INCLUDE XSORTL                                                                 
*INCLUDE PPGETCG                                                                
*INCLUDE PPGETPO#                                                               
         TITLE 'PRREPB102 - NEW PRINT BILLING'                                  
***********************************************************************         
* USER    JIRA       DATE                  CHANGE LOG                 *         
* ---- ----------  -------- ----------------------------------------- *         
* YKVA SPEC-46255  21.1     CHANGE THE WORDING FOR TECH FEE           *         
* YKVA SPEC-46758  21.1     PRINT VENDOR CODE/NAME ON MIDAS BILLS     *         
* YKVA SPEC-47099  21.1     REMOVE HARD CODE FOR WB FORAGY OO         *         
* YKVA SPEC-42250  20.3     SHOW TOTAL CREDIT AMOUNT IN PARENTHESIS   *         
* YKVA SPEC-31829  20.3     PREVENT A PRODUCT FROM BILLING, BILL=NO   *         
* YKVA SPEC-42549  20.1     ADD CLT WNO TO WB LIST FOR AGY OO         *         
* YKVA SPEC-43353  20.1     ADD CLT WHO TO WB LIST FOR AGY OO         *         
* YKVA SPEC-34078  20.1 UCOMM RECORDS AND THE DEFINED FIELDS          *         
* KWAN SPEC-35841  19.3 WRITE OUT "COPY" RECORD IN RECOVERY           *         
* YKVA SPEC-34572  19.3     EST OR PRD UDEF ON CLT LEVEL BILL (EPUDEF)*         
* YKVA SPEC-38399  HOTFIX   EXPAND BESIZE IN PPBILLEDID 300K TO 1200K *         
* SMUR SPEC-36386  19.2 BUG READ B4 PROF BEFORE BILADDR REC           *         
* YKVA SPEC-30565  19.2     PRINT RATE AMOUNT FOR COMMISSION BUYS     *         
* SMUR SPEC-36649  INCREASE CLIENT TABLE FROM 8,000 TO 15,000         *         
* YKVA SPEC-29021  1/19 INT ADD CLT WBN AND WH9 TO WB LIST FOR AGY OO *         
* SMUR SPEC-22215  11/06/18 NEW MEDIA (D)IGITAL AUDIO (18.3)          *         
* SMUR SPEC-16949  02/16/18 B8 PROF4 SUPPRESS ** NEXT TO TOTALS 18.2  *         
* SMUR SPEC-16649  02/05/18 READ NEW BILLADR REC B8 PROFILE 3 (18.2)  *         
* AKAT SPEC-20020  01/26/18 INCREASE LINTABN FROM 200 TO 250GY OO   *           
* YKVA SPEC-19585  1/18INTR ADD CLT WB8 & WP8 TO WB LIST FOR AGY OO   *         
* YKVA SPEC-19113  1/18INTR MISSING PRD CODE AND VENDOR DESCRIPT BUG  *         
* SMUR SPEC-18902  1/18INTR CLEAR PRINT LINE FOR EXTENDED NAME        *         
* SMUR SPEC-7723   02/28/17 PRINT EXPANDED CLIENT NAME IF IT EXISTS   *         
* YKVA SPEC-9400   02/24/17 FIX PO BILLING ON CLEARED DOLLARS         *         
* AKAT SPEC-5428   09/22/16 FIX CANADIAN TAX REPORTING BUG FOR ALL PRD*         
* AKAT ITMF-9564   09/07/16 SET A(P4) FOR GETUSER AT BH53V2X3         *         
* AKAT DSSUP-6785  01/25/16 ADD CLT WB6 & WP6 TO WB LIST FOR AGY OO   *         
*                                                                     *         
* BPLA    JUN/15  CHANGES TO SUPPORT EXTENDED EST. UCOMMS                       
*                 FOR AGENCY H7 (AT&T)                                          
*         JUL/15  CHANGES FOR NEW MEDIA CODES                                   
*                                                                               
* BPLA    MAR/15  CHANGES TO REQUIRE EST UDEF'S FOR BILLING                     
*                 CONTROLLED BY CLTUDEF INFO                                    
*                 USE THE AGENCY HEADER MEDIA NAME IN REGISTER                  
*                 INVTBN EXPANDED FROM 3000 TO 4000                             
*                                                                               
* BPLA    DEC/14  STANDARD CUSTOM COLUMNS FEATURE FOR 24/7                      
*                 PROFILE OPTIONS                                               
*                 ALSO SUPPRESSION OF ZERO COST2 INSERTIONS                     
*                 PROFILE OPTION (B2PROF+6 VALUE C) FREEOPT                     
*                                                                               
* BPLA    NOV/14  FEATURE TO DISPLAY ESTIMATE DATES                             
*                 BELOW ESTIMATE NAMES (PROFB2B+5 AND +6)                       
*                 ALSO NEW WARNER BROS. CLIENTS FOR AGENCY OO                   
*                                                                               
* BPLA    SEP/14  CHANGE TO START REPORTING GST BASIS ON BILLHEADERS            
*                 EVEN WHEN THE CLIENT IS EXEMPT                                
*                 WHEN REVERSING BILL PRIOR TO THE FEATURE RELEASE              
*                 THE OLD VAT TABLE WILL BE USED                                
*                                                                               
*  BPLA   MAR/14  CHANGES FOR MEDIA L                                           
*                                                                               
*  BPLA   JAN/14  MORE OMD WARNER BROS. CLIENT CODES                            
*                                                                               
*  BPLA   OCT/13  CODE TO SUPPORT THE REPORTING OF SOME STANDARD                
*                 CUSTOM COLUMNS - B4-7C PROFILE CONTROLLED                     
*                                                                               
*  BPLA   SEP/13  WORKFILE RETENTION TO 2 YEARS (17520 HOURS)                   
*                 ZERO INVOICE ISSUE WITH MULTIPLE MTHS                         
*                                                                               
*  BPLA   JUL/13  AND MEDIA S SEARCH CHANGE                                     
*                                                                               
*  BPLA   MAY/13  CHANGES FOR PO# BILLING                                       
*                 MOVED FROM PPREPB102Q MAY30/13                                
*                                                                               
*  BPLA   FEB/13  CANADIAN BC-HST CHANGE - BACK TO JUST GST                     
*                 PE-HST  NEW AND 14.0 %  APRIL 1/2013                          
*                                                                               
*  BPLA   DEC/12  NEW OMD CLIENTS FOR WARNER BROS.                              
*                 QST % CHANGE 9.50 TO 9.975 +                                  
*                 BASED ON GST                                                  
*                                                                               
*  BPLA   OCT/12  CHANGE FOR NEW WARNER BROS. CLIENT                            
*                 CHANGE TO WARNER BROS. LOGIC TO PREVENT                       
*                 DUMPS WHEN REQUEST IS FOR ONE VENDOR                          
*                                                                               
*  BPLA   FEB/12  CHANGES FOR GRP M MIDAS                                       
*                 MIGRATED FROM PPREPB102M LEVEL 83 11/14/11                    
*                 BUG FIX - CHECK FOR COST2 COMM. ADJ                           
*                 FOR ADJ SEPARATE INVOICE.                                     
*         MAR/12  ALSO SET OUWBSW FOR OMDTOA WARNER BROS. CLTS                  
*                 WHI AND WTI - SHOWS PRD USER1 IN HEADLINES                    
*                                                                               
*  BPLA   DEC/11  QST RATE CHANGE TO 9.5% FROM 8.5% AS OF JAN01/12              
*                 ALSO WARNER BROS. CODE FOR OMD (OO)                           
*                                                                               
*  BPLA   JUN/11  ADJUST COPY AND CAPTION OVERRIDE CHECK                        
*                                                                               
*  BPLA   MAY/11  FOR $ TYPE COST2 DON'T SET FINANCIAL BIT                      
*                 ON IN THE BILL HEADERS                                        
*                                                                               
*  BPLA   JAN/11  NEW VALUE FOR PRIOR W = 24 PRIOR                              
*                 MTHS TOGETHER                                                 
*                                                                               
*  BPLA   DEC/10  CHANGES FOR NEW QST TAX RATES                                 
*                 7.5% TO 8.5% 1/1/11                                           
*                                                                               
*  BPLA   SEP/10  CHANGES FOR A NEW B8 PROFILE                                  
*                 INV. AND DUE DATE WITH THE CENTURY                            
*                 $ BEFORE AMOUNT DUES                                          
*                 ALSO FIX AOR GST PROBLEM                                      
*                                                                               
*  BPLA   JUN/10  CHANGES FOR CANADIAN HST JUL/10 TAX CHANGES                   
*                 DUE TO STAGED RELEASE, AGENCY CHECKS ARE                      
*                 USED FOR ACCESS TO THE NEW HST CHANGES                        
*                                                                               
*  BPLA   MAY/10  NEW WARNER BROS. CLIENTS AND NEW DIVISION CHECK               
*                                                                               
*  BPLA   APR/10  DISPLAY PRD USER FIELDS UNDER PRD NAME                        
*                 IF PRDS TOGETHER AND FIELDS SET TO 'F'                        
*                 (FRONT OF BILL)                                               
*                 FOR YN OUTDOOR USE NEW EDI MISCELLANEOUS                      
*                 INSERTION INFO FIELD FOR MARKET (THEY                         
*                 PUT INTO 2ND BUY COMMENT (FOR CHEVRON)                        
*                                                                               
*  BPLA   FEB/10  BILLING REPS FOR REGIONS                                      
*                 WARNER BROS. NEW DIV (202) CHK FOR CLTS WB9                   
*                 AND WP9 - TREAT AS THEATRICAL                                 
*                                                                               
*  BPLA   JAN/10  AOR PROFILE ERROR IF PROGPRO2+13 (B4-B7)                      
*                 IS NOT N AND AORLOPT+1 IS C - PEPTAB ISSUES                   
*                                                                               
*  BPLA   NOV/09  IMPROVE THE WAY INSERTION SPACE DESCRIPTIONS ARE              
*                 CARRIED IN EDI WORKER FILES                                   
*                 CHANGES TO FOREIGN EXCHANGE DISPLAY FOR FRENCH                
*                 NEW FOX-LIKE OPTION FOR ZENITH                                
*                 NO-OPTED FOR NOW - SEE **NOHAR IN FIRST COLUMN                
*                 FOR SJR CLIENT HAR STILL SETS PUSRSW ON                       
*                                                                               
*  BPLA   NOV/09  EMPTY LINES IN STANDARD COMMENTS CAUSED                       
*                 A PROBLEM FOR ARCHIVE SINCE THEIR ELEMENTS                    
*                 WERE LENGTH OF 3 WITH A BINARY ZERO AS DATA                   
*                 I SUSPECT THAT ARCHIVE DIDN'T LIKE THE BINARY ZERO            
*                 IN THE MIDDLE OF AN INVOICE.                                  
*                                                                               
*  BPLA   SEP/09  IGNORE DELETED BFORM RECORDS WHEN                             
*                 CHECKING FOR ANY FOR THE CLIENT                               
*                                                                               
*  BPLA   MAR/09  FIX FOR BFORM C BILLING FORMULAS                              
*                                                                               
*  BPLA   FEB/09  BE SURE PROPER ESTIMATE IS IN ADEST                           
*                 IN PRBUY - IT'S NOT WHEN THE REQUEST                          
*                 IS FOR A RANGE OF ESTIMATES                                   
*                 THIS CAUSED PLANNED COST BILLING                              
*                 TO NOT FUNCTION PROPERLY                                      
*                                                                               
*  BPLA   JAN/09  NOVARTIS EST. USER FIELD OPTION FOR YNRO (YN)                 
*                 CLIENT CODE = NVM AND NIM                                     
*                 NEW 2009 CLIENT CODE FOR WARNER BROTHERS                      
*                 PLUS WARNER BROS FOR AGENCY FR                                
*                                                                               
*  BPLA   NOV/08  OPTION (QOPTB) TO OVERRIDE B2 PROFILE'S ADJSEP                
*                                                                               
*  BPLA   SEP/08  STORE USER ID FOR OVERNIGHT REQS AS WELL AS SOON              
*                                                                               
*  BPLA   JUL/08  SUPPRESS SECOND AOR BILL FOR AC=0+ADDITIONAL                  
*                 CHARGES ON A SEPARATE INVOICE                                 
*                                                                               
*  BPLA   JUL/08  ALLOW AOR LISTING OPTION FOR WB BILLING                       
*                 (IT USE JOBS ON SEPARATE INVOICES CONTROL FOR                 
*                 WB FLIGHTS)                                                   
*                                                                               
*  BPLA   MAY/08  SPECIAL MOS OPTION FOR MULLEN                                 
*                 B1A OPTION (C) TO PUT AC=0 AND ADDITIONAL                     
*                 CHARGES ON THE SAME SEPARATE INVOICE.                         
*                                                                               
*  BPLA   APR/08  ADD JW TO LIST OF AGENCIES TO GET WPP COMMENT                 
*                                                                               
*  BPLA   MAR/08  METEST ID REALLY W+ - NOT M+ AS TOLD EARLIER                  
*                                                                               
*  BPLA   FEB/08  CLEAR REG+DST FROM HEAD 8+9 IF NOT SET FOR                    
*                 ON SEPARATE INVOICES                                          
*                                                                               
*  BPLA   JAN/08  MODIFY END OF PERLIST CHECK FOR SFM BILL                      
*                 FORMULA SEARCHING                                             
*                 CHANGE TEST FOR THEATRICAL DIVISION TO 100                    
*                 AND NOT 001                                                   
*                                                                               
*  BPLA   DEC/07  CHANGES FOR WB FLIGHTS (MEDIACOM)                             
*                 AORINV WPP FIX                                                
*                                                                               
*  BPLA   DEC/07  GST/HST TAX CHANGE                                            
*                                                                               
*  BPLA   OCT/07  FIX BUG FOR REVERSING OF ADDITIONAL CHARGE                    
*                 INVOICES - FORMULA SHOULD NOT BE APPLIED                      
*                                                                               
*  BPLA   JUL/07  NO-OP FOX FEATURES - THEY DON'T WANT TO USE                   
*                 AS IT ENTAILS REQUESTING EACH PRODCUT GROUP                   
*                 SEPARATELY                                                    
*                                                                               
*  BPLA   JUN/07  B2A PROFILE OPTION TO SHOW NET ON AOR PRD/EST/MTH             
*                 FORMAT. CODE TO SUPPORT REQUESTS FOR ONE ADID                 
*                                                                               
*  BPLA - MAY/07  ***DISPLAY PRD AND EST USER IN HEADLINES NOT CODED***         
*                 ALSO FOX STYLE USER DATA DISPLAY -                            
*                 PRD AND EST USER DATA WITH PRD NAME                           
*                 WHEN PRDS ARE TOGETHER AND ESTIMATES                          
*                 ARE ON SEPARATE INVOICES.                                     
*                                                                               
*  BPLA - APR/07  WALMART USER FIELD FEATURE + WPP COMMENT                      
*                 + BUG FIX FOR PATO                                            
*                 MOSOPT - DISPLAY 'MONTH OF SERVICE'                           
*                 INSTEAD OF 'MONTH OF' ABOVE COLUMN HEADERS                    
*                                                                               
*  BPLA - MAR/07  RESET CURTAB+3 TO 2 AT START OF INVREG                        
*                 SOMETIMES A DUMP WILL CLOBBER IT                              
*                                                                               
*  BPLA - NOV/06-JAN/07  CHANGES FOR PLANNED COST BILLING                       
*                                                                               
*  BPLA   10/06   CHANGE "AMOUNT DUE" AND "CREDIT AMOUNT"                       
*                 BEFORE GST AND PST TO "AMOUNT BEFORE TAX"                     
*                                                                               
*  BPLA   09/06   ADD NEW P&G CLIENT CODE PGG                                   
*                 IMPROVED 'INVALID BILLING PROFILE' MESSAGES                   
*                 SEND ERROR IF DIVISIONS TOGETHER AND PRODUCTS                 
*                 SEPARATE - DOESN'T WORK                                       
*                 FIX PROBLEM WHEN TRACING PROFILES                             
*                 -PRNTPROF CLOBBERD WORK                                       
*                                                                               
*  BPLA   08/06   IF REVERSING STILL SET S-RATE ON SEPARATE                     
*                 INVOICE (CR/DB) SWITCH SO THAT FORMULA                        
*                 WILL BE APPLIED (OR NOT) CORRECTLY                            
*                 WAS THAT CHECK NEEDED FOR ADDITIONAL CHARGES                  
*                 ON SEPARATE INV.?                                             
*                                                                               
*  BPLA   07/06   HANDLE REVERSALS IN MULTIPLE REG/DST ASSIGNMENT               
*                 SITUATIONS                                                    
*                                                                               
*  BPLA   07/06   SAVE REFERENCE # FOR EDI                                      
*                                                                               
*  BPLA   06/06   CHANGES FOR 24 MONTHS AND GST CHANGE                          
*                 GST CHANGES TO 6% AS OF JUL01/2006                            
*                 HSTS CHANGE TO 14% AS WELL                                    
*                 ++INCLUDES NEW PGSTTAB - NEEDED FOR SALES TAX CALC            
*                 IT HAS MORE ENTRIES FOR THE NEW %                             
*                                                                               
*  BPLA   03/06                                                                 
*                 CHANGES FOR REPORTING AD ID                                   
*                 NEW VALUE FOR NOZEOPT T=SUPPRESS PUB TOTALS                   
*                 B4-B7 PROFILE (PROGPRO2) +15                                  
*                 WHEN REVERSING SET CR/DB CONTROL TO "N"                       
*                                                                               
*  BPLA   02/06   XML CHANGES - ZEROS IN EMPTY AMOUNT DUE FIELDS                
*                                                                               
*  BPLA   01/06   SOME CLIENTS FOR OSZNY NEED EST UDEF FEATURE                  
*                 MSSW                                                          
*                                                                               
*  BPLA   11/05   REWORK THE WAY GST BASIS IS STORED                            
*                                                                               
*  BPLA   10/05   ALWAYS PASS BOTH GROSS AND NET TO EDI                         
*                                                                               
*  BPLA   08/05   ALWAYS SKIP REVERSE AND REVERSAL ELEMENTS                     
*                 WHEN CHECKING FOR BILLING OF "FREE" INSERTIONS                
*                                                                               
*  BPLA   07/05   CHANGES TO SUPPORT DIV BILLING REPS                           
*                                                                               
*  BPLA   06/05   SAVE OFFICE AT CLTF3X SINCE PROFILE                           
*                 ERRORS MAY BE FOUND LATER IN CFIRST                           
*                -AFTER A NEW STARTING INVOICE NUMBER HAS BEEN FOUND            
*                                                                               
*  BPLA   04-05/05 CHGS FOR UPDATIVE SOON BILLING                               
*                                                                               
*  BPLA   03/05   CHANGES FOR MCCANN, ETC..                                     
*                 SRATE INS. DENOTED WITH AN *                                  
*                 BILLING REP FOR ESTIMATES                                     
*                 AMOUNT DUE IN PREVIOUS INV. LISTING                           
*                 SRATE AND ADDITIONAL CHARGES                                  
*                 ON SEPARATE INVOICES FEATURES                                 
*                                                                               
*  BPLA   1-2/05 FIX DEBBIE WOOD'S MISSING AMOUNT DUES                          
*         INCORPORATE CODE FOR MCCANN'S AMOUNT DUE OF                           
*         PRIOR INVOICES AND * BEFORE S-RATE INSERTIONS.                        
*         REMOVE *'ED OUT UPASS CODE.                                           
*         ADD CODE FOR ESTIMATE BILLING REPS                                    
*         FIX MISSING INS. DATE IF ONLY ADDITIONAL CHARGE                       
*         IS BILLABLE. FIX SOME MISSING EDI TOTALS PROBLEM.                     
*                                                                               
*                                                                               
*  BPLA   ANOTHER CHANGE TO NDUES CHECKING                                      
*                                                                               
*  BPLA   NDUES FIX - ADJUST WHERE IT'S BUMPED                                  
*  8-10/04 EDI INSERTION DETAILS                                                
*         CVATSW FIX                                                            
*         BILLING FORMULA RECORDS WILL SOON SUPPORT PRINTING                    
*         AN ADJUSTMENT BASED ON AC TO PRINT AS SOMETHING                       
*         ELSE - THIS IS LIKE THE CHAB FEATURE RELEASED IN 1992                 
*         RETAIL BILLING FIX TO ALLOW FOR MORE OUTLETS -                        
*         UP TO 252 - UPASS CHANGES                                             
*         REGISTER ON SEPARATE PQ ENTRY FOR LIVE DIRECT                         
*         REQUESTS (NO REPORTS=2 STATEMENT NEEDED IN JCL)                       
*                 PREVIOUS INVOICES (MCCANN)                                    
*                 PROGPROF2+11  A AND C                                         
*                 NOTE:C GETS LSTOPT SET TO A                                   
*                 SHOWREV SET TO Y                                              
*                                                                               
*  BPLA   IGNORE PREVIOUS MANUAL AOR BILLS                                      
*         REGION/DISTRICT UCOMM BUG FIX                                         
*                                                                               
*  BPLA   08-09/03 NEW VALUES FOR PROGPRO2+11 (LSTOPT)                          
*                  THAT WILL INCLUDE REVERSED AND REVERSAL                      
*                  BILLING ELEMENTS                                             
*                  OPTION TO DO REGISTER FOR DRAFT BILLING (QOPTA)              
*                  MINDSHARE-EST USER COMMENTS-FOR ESTS TOGETHER (MSSW)         
*                  MORE P&G MODIFICATIONS                                       
*                                                                               
*  BPLA   05/03    PRINT EST USER FIELD WITH PRODUCT                            
*                  FOR P&G BILLING - HARDCODED TESTS                            
*                                                                               
*  BPLA   04/03    ISSUE NAME AND NTR1 FOR FMED                                 
*                                                                               
*  BPLA   01/03    FIX DISPLAY OF REVERSAL INVOICE NUMBER                       
*                  USE 'SHORT' FORMAT (NO MEDIA)                                
*                                                                               
*  BPLA   09/02    NEW PRIOR MONTHS OPTIONS FROM REQUEST CARD 2                 
*                                                                               
*  BPLA   04/02    READ B9A PROFILE AND SET ALTERNATE ACC SYS                   
*                                                                               
*  BPLA   04/02    REMOVE CODE THAT SUPPRESSED INSERTION DATE                   
*                  FOR DOREMUS TRADE INSERTIONS                                 
*                                                                               
*  BPLA   02/01    FIX BUG IN GNOFFSET                                          
*                                                                               
*  BPLA   12/00    V(PUBFRST) CHANGED TO V(FSTPUB)                              
*                                                                               
*  BPLA   10/00    FOR FINANCIAL BUYS BEFORE START MOS                          
*                  SKIP FINANCIAL ELEM CHECK                                    
*                                                                               
*  BPLA   08/00    COPY OF PPREPB12A AT LEVEL 50 7/20/00                        
*                  COPY MADE 8/16/00                                            
*                  CHANGES TO CATALP AND PPREPB1WKN                             
*                  (WHICH INCLUDES PNNEWFILE IN PLACE OF                        
*                  PPNEWFILE)                                                   
*                  PNNEWFILE INCLUDES PNBILREC IN PLACE                         
*                  OF PBILLREC                                                  
*                                                                               
*  BPLA   07/00    FIX BUG IN COST2 CHECK                                       
*                                                                               
*  BPLA   02/00    FIX BUG WHEN CHECKING FOR MULTIPLE                           
*                  REG/DST SCHEME - USE DRD OVERRIDE CLIENT                     
*                  (IR REQUESTED)                                               
*                                                                               
*  BPLA   10/07/00 NEW PROFILE OPTION TO PREVENT DELETED,                       
*                  BUT NOT CREDIT CLEARED,ITEMS FROM BEING                      
*                  BILLED WHEN THE PAID ITEMS ONLY OPTION                       
*                  IS IN FORCE.                                                 
*                  NEW VALUE ON B4-B7 PROFILE+10                                
*                  D= TREAT DELETED BUYS AS ABOVE                               
*                                                                               
*  BPLA   10/8/99  CHANGES FOR USER FIELDS IN HEADLINES                         
*                                                                               
*  BPLA   9/21/99  CHANGE TO DISPLAY 'INTERACTIVE'                              
*                  FOR MEDIA "I" WHEN THE AGENCY WAS USING                      
*                  AN ABREVIATION                                               
*                                                                               
*  BPLA   9/10/99  FIX BUG IN CFIRST WHEN CHECKING IF                           
*                  SFM BILL FORMULA RECORDS EXIST                               
*                  (USED AREC INSTEAD OF ADCLT)                                 
*                                                                               
*  BPLA   5/99  COPY OF PPB12A LEVEL=29 5/5/99                                  
*               CHANGES FOR COST2 - SEE *COST2* FLAGS                           
*                                                                               
*               NEW VALUES FOR FINANSW                                          
*               X'01'  BIT ON = FINANCIAL BILLING (OLD OR RJ PALMER)            
*               X'02'  BIT ON = RJ PALMER STYLE (X'01' ALSO ON)                 
*               X'80'  BIT ON = CARAT SYLE COST2 BILLING                        
*                      (X'01' AND X'02' BITS WILL BE OFF)                       
*                                                                               
*               - NOTE THAT THE CLI'S FOR THE FINANSW HAVE BEEN                 
*                 TO TM'S - THIS MUST ALSO BE DONE IN THE OTHER                 
*                 BILLING SOURCE BOOKS                                          
*                                                                               
*  BPLA   5/99  CHANGE TO SAVE FORMULAS EVEN IF USING                           
*               BILLING FORMULA RECORDS - I STILL NEED COMMENTS                 
*                                                                               
*  BPLA   2/99  IN CFIRST IF BFROPT IS SET TO "Y"                               
*               BE SURE SOME SFM BILLING PROFILE EXISTS                         
*               ** BILLING DIES IF NONE ARE FOUND **                            
*                                                                               
*  BPLA   1/99  CHANGE IN GETNUM - IF SEQUENCING ACROSS MEDIA                   
*               START WITH MEDIA "I" (NOT M)                                    
*                                                                               
*  BPLA  11/98  FIX MINOR BUG IN BILHEAD - AOR LIST OPTION                      
*               TOGETHER WITH SEPARATE COMM INVOICE                             
*               CAUSED "P" OF "PRODUCT" TO DISAPPEAR                            
*                                                                               
*  BPLA  10/98  B1X PROFILE INVOICE NUMBER RESEQUENCING                         
*               FIX TO HANDLE Y2K PROFILE DATES                                 
*               CHANGES FOR Y2K START MOS ON B2 PROFILES (NEWSTART)             
*               ALSO START MOS ON B1 PROFILE (AGMSTADT)                         
*                                                                               
*  BPLA  10/98  PRTUSER ADDED TO ACONS (AT END)                                 
*                                                                               
*  BPLA  10/98  RENAMED FROM PB12AE                                             
*                                                                               
*  BPLA  9/98   CHANGES FOR MEDIA I - INTERACTIVE                               
*                                                                               
*  BPLA  8/98   ADD BILLING FORMULA RECORD CODE                                 
*                                                                               
*  BPLA  8/98   CHANGES FOR SHIP DATE (FORD)                                    
*               PROFB2B+10 IS NUMBER OF DAYS PRIOR TO DUE DATE                  
*               FOR SHIP DATE (0= NO SHIP DATE)                                 
*                                                                               
*  BPLA  8/98   WHEN REVERSING - ONLY SHOW                                      
*               BILL BEING REVERSED IN LIST OF PRIOR INVOICES                   
*                                                                               
*  BPLA  4/98   FIX IN GETNUM FOR Y2K                                           
*                                                                               
*  BPLA 3/98    LONG CLIENT NAME OPTION ADDED                                   
*                                                                               
*  BPLA 1/98    COPY OF PPB12A AT LEVEL 31 MADE 1/12/98                         
*               CHANGES FOR EDI BILLING LOOK FOR **EDI**                        
*               NOTE - EDI REDONE (FIRST TRY IN OCT/97)                         
*                                                                               
*  BPLA 9/97    TEMPORARY CODE IN BLDTAB TO ALLOW                               
*               AOR BILLING WITH MULTI-MEDIA REQUEST.                           
*               ALSO CHANGE IN RESTART - DO AORINV                              
*               AT MODE LBUYXRQ ALSO                                            
*               AT PRESENT ONLY SJR AND DOREMUS CAN                             
*               BILL MULTI-MEDIA AOR                                            
*                                                                               
*  BPLA 5/97    COST SUPPRESSION OPTION B4A-B7A PROFILE+11                      
*               SETS WIOPT - Y = SUPPRESS ALL COSTS + TOTALS                    
*               EXCEPT FOR INVOICE TOTALS (AND INSERTION                        
*               RATES WHEN DOING A FINANCIAL REBATE BILL)                       
*                                                                               
*  BPLA 2/97    ADD ROUTINE TO READ BILL FROM DATA IN BILL ELEMENT              
*               - NEEDED FOR SPECIAL DRD SCHEME PREVIOUS INVOICES               
*                                                                               
*  BPLA 2/97    IN CLTFIRST SET ON SPECIAL MDRDAS SWITCH                        
*               FOR SPECIAL MULTIPLE DRD FEATURE                                
*               IF ON-SET EXDATE TO TODAY SO TODAY'S PRIOR BILLING              
*               IS IGNORED.                                                     
*               MUST USE RDSPLIT AFTER GETINS CALLS                             
*                                                                               
*  BPLA 2/97      SPECIAL CODE TO ALLOW REG ON SEPARATE INV                     
*             EVEN FOR MULTIPLE ASSIGNMENTS (SJR AND DRD CLT=SDK)               
*                                                                               
*  BPLA 12/96     MOVE NOZEOPT VS PROFB1A CHECK TO SETD30                       
*                 FROM SETD15                                                   
*                                                                               
*  BPLA 10/96     NEW VERSION TO SUPPORT 3 NEW FEATURES                         
*                 1) STANDARD COMMENTS ON AOR BILLS - NO CHANGES                
*                    IN THIS PROGRAM                                            
*                 2) ERRORS ONLY FOR DRAFT RETAIL BILLING (QOPT9)               
*                 3) SUPPRESS ZONE/EDITION FOR PUB TOTALS (NOZEOPT)             
*                                                                               
*                                                                               
*  BPLA 9/96      PPB12AO SOURCE MADE LIVE                                      
*                 NOW INCLUDES PPREPB1WRK                                       
*                 NEEDS PPB1ACC                                                 
*                                                                               
*  BPLA 7/96      FIX RETAIL SUMMARY BILL HEADLINE                              
*                                                                               
*  BPLA 5/96      MOLSON FEATURE FOR BACKER - BS NOT TH                         
*                                                                               
*  BPLA 5/96      WHEN PAYOPT IS "Y" PROCESS INSERTIONS WITH                    
*                 NO DATED PAYELEMS IF BGROSS(12) IS NOT ZERO                   
*                 - NEED TO PRODUCE CREDITS                                     
*                                                                               
*  BPLA 4/96      SPECIAL FEATURE FOR ZENITH - MOLSON (RETAIL)                  
*                                                                               
*  BPLA 1/96      IN PRBUY - IF PROCESSING MANUAL BILL                          
*                 SKIP EXCULDING BILLING CHECK                                  
*                 IN RESTART - SKIP GOTO ARMBILL (MANUAL BILL READ)             
*                 IF MODE IS PGR1LAST                                           
*                 IN BKPRD - IF PROCESSING MANUAL BILL USE PRODUCT              
*                 FROM "BUY" INSTEAD OF KPRD                                    
*                                                                               
*  BPLA 9/95      CHANGES FOR SEQUENCING INVOICES BY OFFICE AND                 
*                 OFFICE LIST                                                   
*                                                                               
*  BPLA 7/95      WHEN REVERSING FINANCIAL BILL SET IDSP(4,RF) TO               
*                 F'1' EVEN IF I ONLY FIND OPEN BILLING                         
*                 WHEN I WASN'T PEPTAB WAS EMPTY AND BILLABLE                   
*                 AMOUNTS WERE WRONG.                                           
*                                                                               
*  BPLA 3/95      ALSO CLEAR VBTAB WHEN I GO TO SETDATE IN CFIRST               
*                              WHEN I DIDN'T SOMETIMES VAT BASIS                
*                              WAS WRONG FOR OFFICE AND BILLING GROUP           
*                              REQUESTS                                         
*                                                                               
*  BPLA 9/94      NEW PROFILE OPTION ON B4-B7 PROFILE                           
*                 AAA ADDRESS OPTION - Y MEANS USE AAA ADDRESS                  
*                 UNLESS A "REAL" ADDRESS HAS BEEN SET-UP FOR                   
*                 THE PRODUCT (EVEN IF PRODUCTS ARE ON SEPARATE                 
*                 INVOICES)                                                     
*                                                                               
*  BPLA 8/94      AT BH5F - CHECK FOR SPACES IN AJADDRS - NOT 0                 
*                                                                               
*  BPLA 7/27/94   IN BILHEAD - AT BH5F CHANGE                                   
*                        CLC   AJOBBRK,AINVBRK                                  
*                     TO CLI   JOBCTL,C'S'                                      
*                                                                               
*  BPLA 6/27/94   FIX PEPTAB KEY LENGTH IN PEPPARS                              
*  BPLA 6/23/94   IN CFIRST CHECK FOR AGY/MED/CLT BREAK                         
*                 INSTEAD OF AGY/MED WHEN GOING TO AAGMPROC                     
*                 ALSO RESTORE READ OF B1X PROFILE                              
*                 IN AGMPROC                                                    
*                 ALSO GOTO GETNUM EIF SAME MEDIA (IN CFIRST)                   
*                                                                               
*  BPLA 6/15/94   AND FINANCIAL BYTE TO MEDIA IN BRKTAB                         
*                 AS AN ATTEMPT TO HANDLE MIX OF FINANCIAL                      
*                 AND NON-FINANCIAL ON SAME BILL                                
*                                                                               
*  BPLA 5/13/94   IN GETNUM USE PPFMTINO TO FORMAT INVOICE NUMBERS              
*                 ALSO MOVE READING OF PB1X PROFILE TO SETDATE                  
*                                                                               
*                                                                               
*  BPLA 4/6/94    IN BLDTAB IF REQUEST IS FOR A SINGLE EST                      
*                 DON'T SET EST TO SEPARATE IF AGMFORMS IS 'L'                  
*                 OR 'B' (LONG LOGOS) AND REG/DST IS EPERATE                    
*                 THIS WOULD CAUSE DUMPS IN BILHEAD (TOO MANY                   
*                 HEADLINES)                                                    
*                                                                               
*  BPLA 2-3/94    CHANGES FOR PST                                               
*                                                                               
*  BPLA 1/94      IN GETNUM SET ON FCRDCLOS TO 'Y' TO READ CLOSED-OUT           
*                 BILLS - NEEDED SINCE UNBILLING NOW MAY CLOSE-OUT              
*                 BILLS INSTEAD OF DELETING THEM                                
*                                                                               
*  BPLA 10/93     CHANGES FOR RETPROF+13  DISTRIBUTOR DETAILS                   
*                                                                               
*  BPLA 10/5/93   NEW CDSEP OPTION - R - SPECIAL CD HANDLING                    
*                 WITH 'APPLY' MESSAGES                                         
*                                                                               
*  BPLA  8/20/93  AT BUYBK3A7 SEE IF DELETED WITH NO PAY ELEMS                  
*                 IF SO THEN SKIP THAT BUY                                      
*   BPLA 6/23/93  CHECK FOR 0 IN PROFB2B+1 BEFORE ALTERING                      
*                 QESTEND                                                       
*   BPLA 6/10/93  FIX BUG AFFECTING PAYOPTS E-F-G                               
*                                                                               
*   BPLA 5/25/93  PROCESS MANUAL BILLS WHEN DOING CLEARED ITEMS                 
*                 ONLY                                                          
*   BPLA 5/10/93  GETUSER ADDED TO ACONS                                        
*                                                                               
*   BPLA 3/1/93   DISALLOW SPECIAL CD HANDLING FOR UFC CLIENTS                  
*                                                                               
*   BPLA 1/27/93  FIXED BUG  - GOT "NO BILLING GERNERATED"                      
*                 WHEN USER TRIED TO REVERSE A FINANCIAL BILL                   
*                 THAT HAD NO OPEN BILLING                                      
*                                                                               
*   BPLA 10/26/92 IF QOPT8 = C SET OFF ADJSEP (CDSEP MUST BE LEFT ON            
*                 BUT NOT CD SEP BILL IS PRODUCED)                              
*                 IF QOPT8 = N SET OFF ADJSEP                                   
*                                                                               
*   BPLA 9/28/92  USE NTAXCALC TO GET TAX WHEN BILLING PAID ITEMS               
*                                                                               
*   BPLA 9/21/92  "FREE" DATE CHECK CHANGED FROM AUG01/92 TO SEP01/92           
*                                                                               
*   BPLA 8/4/92   IN BILHEAD CHECK RETPROF+13 TO SEE IF SUPPRESSING             
*                 DETAILS ON DISTRIBUTOR BILLS                                  
*   BPLA 7/31/92  IN BILHEAD CHECK FOR BLANK ESTIMATE NAME LINE 2               
*                                                                               
*   BPLA 7/29/92  DON'T BILL "FREE" INSERTIONS WHOSE INSERTION DATE             
*                 IS BEFORE AUG01/92                                            
*                 ALSO NEW MEANING FOR 7TH BYTE OF B2 PROFILE (+6)              
*                 WAS BEING MOVED TO ORIGTYPE (NO DETAIL MARKING)               
*                                                                               
*                 NEW VALUE - "Y"  MEANS BILL "FREE" INSERTIONS                 
*                 WHOSE INSERTION DATE IS ON OR AFTER AUG01/92                  
*                                                                               
*   BPLA 7/21/92  WHEN CHECKING PROFB2B AT REQFRST DON'T ALTER REQUEST          
*                 IF PROFB2B = "N"                                              
*                                                                               
*   BPLA 7/9/92   CHANGES TO USE PBBILST (IN PBILELEM) TO INDICATE              
*                 UPFRONT COMMISSION AND NET BILLING - INSTEAD OF               
*                 X'46' ELEMENTS FOR COMMISSION BILLING                         
*                 NOTE - THIS MODULE NEEDS NEW VERSION OF GETINS                
*                 THAT CAN HANDLE REQUESTS FOR UFC COMM AND                     
*                 UFC NET BILLING                                               
*                                                                               
*   BPLA 6/16/92  NO NEW COMMISSION BILLING FOR FINANCIAL CLIENTS               
*                                                                               
*   BPLA 6/8/92   WHEN BILLING CLEARED ITEMS ONLY CHK FOR ANY PAY               
*                 ELEM WITH A DATE ("FREE" INSERTIONS CHANGES                   
*                 CAUSED ALL UNPAID ITEMS TO GET BILLED WHEN                    
*                 REQUESTING CLEARED ITEMS ONLY)                                
*   BPLA 6/1/92   SETTING FILTER VALUES FOR COMM BILLING MUST BE                
*                 IN REQFRST, REMOVED FROM CFIRST                               
*                                                                               
*   BPLA 5/28/92  IF QDIST IS BLANK ONLY CHECK REGION AT BUYBK5I                
*                 PREVIOUS BILLS WERE MISSING WHEN QREG WAS REQUESTED           
*                 AND QDIST WAS BLANK IF THE SCHEME WAS REG/DST                 
*                                                                               
*   BPLA 5/26/92  B2B PROFILE EST FILTERS FOR COMM. BILLING                     
*                                                                               
*   BPLA 4/29/92  COMMISSION BILLING CHANGES                                    
*                                                                               
*   BPLA 4/20/92  CHANGES FOR BILLING "FREE" INSERTIONS                         
*                                                                               
*   BPLA 4/20/92  COPY OF PPB12AL (LEVEL 40)                                    
*                                                                               
*   BPLA 4/1/92   PCT. BILLING CONTROL                                          
*                 AT BUYBK3C CLEAR PREVIOUS BILLING IF MANPCT IS NOT            
*                 0 AND PCTCTL IS "N"                                           
*                                                                               
*   BPLA 3/25/92  EFFECTIVE DATE CHECK FOR PERCTL = "T"                         
*                 IN BUYBK3G                                                    
*   BPLA 7/18/91  FIX CLOBBERING OF "DOCUMENT" BY *AOR* AND                     
*                 "MEDIA BILLING" (EXPANDED FOR FRENCH)                         
*   BPLA 5/7/91   DISALLOW ADJ SEP OR CD SEP WITH AOR CLIENT LIST               
*                                                                               
*   BPLA 5/7/91   COPY OF PPB12AN (LEVEL 25)                                    
*                                                                               
*   BPLA 5/2/91   FIX 'BILLING' DISPLAY FOR STRIP OFF                           
*                                                                               
*   BPLA 4/25/91  NEW ROUTINE TO EXTRACT NET FROM NET+TAX                       
*                 TO ACCOUNT FOR GST                                            
*                                                                               
*   BPLA 3/26/91  CODE FOR DRAFT RBATE BILLING - RD                             
*                                                                               
*   BPLA 3/25/91  MORE FRENCH CHANGES                                           
*                                                                               
*   BPLA 3/11/91  CHANGES FOR GRANT'S AOR FEATURES                              
*                                                                               
*   BPLA 11/30/90 CHANGES FOR CANADIAN GST                                      
*                                                                               
*   BPLA 11/12/90 SKIP MANUAL BILL READ IN RESTART IF MODE=CLILAST -            
*                 WAS REREADING MANUAL BILLS OF LAST PRODUCT (READ              
*                 AT PRDLAST                                                    
*                                                                               
*   BPLA 9/26/90  REVERSAL INVOICE NUMBER NOW CHARACTERS (QMANUAL+7(4))         
*                 WAS BINARY (QMANUAL+7(2))                                     
*                                                                               
*        QOPT3 C=CD PUBS ONLY                                                   
*              N=NON-CD PUBS ONLY                                               
*                                                                               
*        QOPT1 C=CD ITEMS ONLY                                                  
*              N=NON-CD ITEMS ONLY                                              
*                                                                               
*        QOPT8 - ONLY FOR COMMISSION BILLING (B2B PROFILE SET TO 'Y')           
*              C= COMMISSION ONLY BILL                                          
*              N= NET BILL                                                      
*              R= REGULAR BILL                                                  
*         NOTE THAT QOPT8 IS IN QAREA2 (COL 62)                                 
*                                                                               
*        QOPTA - MIGHT BE SET FOR DRAFT BILLING                                 
*              R= DO REGISTER                                                   
*                                                                               
*        QPUB+1  MIGHT HAVE RD=XXX FOR DIV/REG/DST OVERRIDE CLIENT XXX          
*        QPUB+1(7) = IF JXXXXXX  AD CODE FILTER                                 
*                                                                               
*        QINVDATE AND QDUEDAYS IN QPAY (COL 53) USED TO BE IN                   
*        QPUB+1 AND QPUB+7                                                      
*                                                                               
*        QMANUAL NOW IN REC CARD 2 (COL 27)                                     
*                                                                               
*        QADID(12)  QAREA2 (COL 09)                                             
*                   IF QADID BEGINS WITH C'.' WB FLIGHT (10) FOLLOWS            
PPB102   CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 0,PPB102                                                         
         SPACE 2                                                                
         B     PROC                                                             
PATCH    DC    16X'00'                                                          
*              BYTE 1  - X'40'=TRACE VBTAB                                      
*                        X'04'=TRACE OUTPUT FILE FOR EDI ???                    
*                        X'08'=TRACE TSAROFF BUFFER                             
*                        X'10'=PRINT USER PROFILES                              
TRCE     DC    C'N'                                                             
         SPACE 2                                                                
PROC     DS    0H                                                               
         L     RA,0(R1)                                                         
         USING PPWORKD,RA                                                       
         MVI   RC2DSECT,C'Y'       2ND DSECT                                    
         L     R9,PPWORK2C                                                      
         USING PPWORK2D,R9                                                      
         LA    RC,SPACEND                                                       
         USING BILWRKD,RC                                                       
*                                  SAVE BASE REGS FOR HEADHOOK                  
         L     RF,=A(SAVREGS)                                                   
         STM   R9,RA,0(RF)                                                      
*                                                                               
         BRAS  RE,INISSB           INITIALIZE SSB VALUES                        
*                                                                               
         CLI   MODE,PROCBUY                                                     
         BE    PROCESS                                                          
         BH    *+8                                                              
         MVI   DONESW,C'N'         RESET AT RESTART                             
         CLI   MODE,RUNFRST                                                     
         BE    RUNF                                                             
         CLI   MODE,REQFRST                                                     
         BE    REQF                                                             
         CLI   MODE,CLIFRST                                                     
         BE    CLTF                                                             
         CLI   MODE,PGR1FRST        DIVISIONS                                   
         BE    PGR1F                                                            
         CLI   MODE,PRDFRST                                                     
         BE    PRDF                                                             
         CLI   MODE,ESTFRST                                                     
         BE    ESTF                                                             
         CLI   MODE,MGR1FRST        REGIONS                                     
         BE    MGR1F                                                            
         CLI   MODE,MGR2FRST         DISTRICTS                                  
         BE    MGR2F                                                            
         CLI   MODE,PGR1LAST                                                    
         BE    PGR1L                                                            
         CLI   MODE,PGR2LAST                                                    
         BE    PGR2L                                                            
         CLI   MODE,PGR3LAST                                                    
         BE    PGR3L                                                            
         CLI   MODE,PRDLAST                                                     
         BE    PRDL                                                             
         CLI   MODE,MGR1LAST                                                    
         BE    MGR1L                                                            
         CLI   MODE,MGR2LAST                                                    
         BE    MGR2L                                                            
         CLI   MODE,MGR3LAST                                                    
         BE    MGR3L                                                            
         CLI   MODE,MKTLAST                                                     
         BE    MKTL                                                             
         CLI   MODE,CLILAST                                                     
         BE    CLTL                                                             
         CLI   MODE,FBUYPUB                                                     
         BE    PUBF                                                             
         CLI   MODE,RUNLAST                                                     
         BE    RUNL                                                             
         CLI   MODE,REQLAST                                                     
         BE    REQL                                                             
         CLI   MODE,LBUYXRQ    LAST FOR MULTI-MEDIA REQ                         
         BNE   EXIT                                                             
         XC    QSAVE,QSAVE                                                      
         MVI   DONESW,C'N'                                                      
         MVI   FMULTMED,C' '      CLEAR FIRST MEDIA                             
         B     RESTART                                                          
*                                                                               
         SPACE 2                                                                
EXIT     DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
*        RUNFRST                                                                
         SPACE 2                                                                
RUNF     DS    0H                                                               
         MVI   DMINBTS,X'08'       SET TO PASS DELETES                          
         MVI   DMOUTBTS,X'FD'                                                   
*                                                                               
         MVC   SQEND,=CL6' '                                                    
         MVI   FMULTMED,C' '   CLEAR FIRST MEDIA FOR MULT-MEDIA REQ             
*                                                                               
         XC    ABILLEDI,ABILLEDI                                                
         MVC   ADWKREC,=A(WKREC)                                                
         MVC   ABUFFC,=A(BUFFALOC)                                              
         MVC   ALINTAB,=A(LINTAB)                                               
         MVC   APATCH,=A(PATCH)                                                 
         MVC   AAELIST,=A(AELIST)                                               
         MVC   ASCCTAB,=A(SCCTAB)  STANDARD CUSTOM COL. TABLE                   
*                                                                               
*                                  GET MEMORY FOR FOTAB                         
         GOTO1 =V(COVAIL),DMCB,C'GET',850000,850000                             
         OC    4(4,R1),4(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,4(R1)                                                         
         MVC   0(8,RF),=C'*FOTAB**'                                             
         LA    RF,8(RF)                                                         
         ST    RF,AFOTABS                                                       
*                                                                               
         MVI   FFS,X'FF'                                                        
         MVC   FFS+1(L'FFS-1),FFS                                               
         MVI   DASHES,C'-'                                                      
         MVC   DASHES+1(L'DASHES-1),DASHES                                      
         MVC   TOTSIZH,=Y(TOTSIZE)                                              
         MVC   XXPUB,=X'9999999999E9'   SPECIAL PUB-99999999,99,Z               
*                                                                               
         L     RE,=A(LEVTOTS)                                                   
         L     RF,=A(TOTSIZE*MAXLEVS)                                           
         XCEF                                                                   
*                                                                               
         L     RF,ALINTAB                                                       
         LA    0,LINTABN                                                        
         MVC   0(132,RF),SPACES                                                 
         LA    RF,132(RF)                                                       
         BCT   R0,*-10                                                          
         MVC   ANXTLIN,ALINTAB                                                  
         MVI   PRSW,C'N'                                                        
*                                                                               
*                                  SET BINSRCH PARS FOR PEPTAB                  
         SR    R0,R0                                                            
         L     R1,=A(PEPTAB)                                                    
         SR    R2,R2                                                            
         LA    R3,PEPTABRL                                                      
         LA    R4,PEPTKEYL         PRINT KEY LENGTH (12)                        
*                           MED,FIN,PRD(3), EST(2), PER(2), SPARE(3)            
         LA    R5,PEPTBN                                                        
         STM   R0,R5,PEPPARS                                                    
*                                                                               
         SR    R0,R0                                                            
*                             SET BINSRCH PARS FOR INVTAB                       
         L     R1,=A(INVTAB)                                                    
         LA    R3,INVTABRL                                                      
         LA    R4,INVTABKL                                                      
         LA    R5,INVTBN                                                        
         STM   R0,R5,INVPARS                                                    
*                                                                               
         SR    R0,R0               SET CLIENT LIST BINSRCH PARS                 
         L     R1,=A(CLTTAB)                                                    
         SR    R2,R2                                                            
         LA    R3,4                                                             
         LA    R4,4                                                             
         LHI   R5,CLTBMAX                                                       
         STM   R0,R5,CLTPARS                                                    
*                                                                               
*                             SET BINSRCH PARS FOR UPETAB                       
         L     R1,=A(UPETAB)                                                    
         LA    R3,UPETABRL                                                      
         LA    R4,UPETABKL                                                      
         LA    R5,UPETABN                                                       
         STM   R0,R5,UPEPARS                                                    
*                                                                               
         GOTO1 DYNALLOC,DMCB,(C'A',=C'OUT     ')                                
         CLI   DMCB+4,0                                                         
         BE    RUNFX                                                            
         MVI   OUTDDFLG,C'Y'       "OUT" DD STATEMENT IS PRESENT                
         OPEN  (OUT,OUTPUT)        OPEN BILL HEADER BUFFER FILE                 
*                                                                               
RUNFX    DS    0H                                                               
*                                                                               
         L     R2,VMASTC                                                        
         USING MASTD,R2                                                         
         CLI   MCRECOVR,C'W'                                                    
         BNE   *+8                                                              
         MVI   UPDTSOON,C'Y'       UPDATIVE SOON FLAG                           
*                                                                               
         DROP  R2                                                               
         B     EXIT                                                             
         SPACE 3                                                                
         EJECT                                                                  
REQF     DS    0H                                                               
*                              DO CONTROLLERS WORK-SET PPWORK2D FIELDS          
         L     R6,PPFILEC                                                       
         LA    R7,1(R6)                                                         
         LA    R7,4095(R7)                                                      
         USING PPFILED,R6,R7                                                    
*                                                                               
         LA    RF,PAGYREC                                                       
         ST    RF,ADAGY                                                         
         LA    RF,PCLTREC                                                       
         ST    RF,ADCLT                                                         
         LA    RF,PPRDREC                                                       
         ST    RF,ADPRD                                                         
         LA    RF,PESTREC                                                       
         ST    RF,ADEST                                                         
         LA    RF,PBUYREC                                                       
         ST    RF,ADBUY                                                         
         LA    RF,PBILLREC                                                      
         ST    RF,ADBILL                                                        
         LA    RF,PUBREC                                                        
         ST    RF,ADPUB                                                         
         DROP  R6,R7                                                            
*                                                                               
         MVI   CURSW,C'N'          SET OFF CURRENT MONTH SWITCH                 
*                                                                               
         L     R6,=A(DICSECT)                                                   
         USING DICSECT,R6                                                       
*                                                                               
         XC    DMCB,DMCB                                                        
         LA    R1,DMCB                                                          
         USING DICTATED,R1                                                      
         MVI   DDACTN,DDACTNL      TRANSLATE LIST                               
         MVI   DDRETN,DDCASEU                                                   
         MVI   DDSYS,4                                                          
         MVC   DDLANG,RCLANG                                                    
         LA    RF,DCLIST                                                        
         STCM  RF,7,DDIADR                                                      
         LA    RF,DSLIST                                                        
         STCM  RF,7,DDOADR                                                      
         GOTO1 DICTATE                                                          
         DROP  R1,R6                                                            
*                                                                               
         CLI   INV#ERR,C'Y'        DID A PRIOR REQUEST HAVE                     
         BNE   *+12                A GETNUM ERROR?                              
         MVI   ERR,INVNERR                                                      
         BRAS  RE,ERRPROC                                                       
*                                                                               
         MVI   MOLSON,C'N'         SET OFF MOLSON OPTION                        
*                                                                               
         MVI   WPPOPT,C'N'         SET OFF WPP OPTION                           
         CLC   QAGENCY,=C'M2'     WPP AGENCY?                                   
         BE    REQF1                                                            
         CLC   QAGENCY,=C'YN'     WPP AGENCY?                                   
         BE    REQF1                                                            
         CLC   QAGENCY,=C'YP'     WPP AGENCY?                                   
         BE    REQF1                                                            
         CLC   QAGENCY,=C'H7'     WPP AGENCY?                                   
         BE    REQF1                                                            
         CLC   QAGENCY,=C'FR'     WPP AGENCY?                                   
         BE    REQF1                                                            
         CLC   QAGENCY,=C'JW'     WPP AGENCY?                                   
         BE    REQF1                                                            
         B     REQF1X                                                           
*                                                                               
REQF1    MVI   WPPOPT,C'Y'                                                      
REQF1X   DS    0H                                                               
*                                                                               
         MVI   CURTAB+3,2          SET DEFAULT TO 2 DECIMALS                    
*                                                                               
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   MGR1BK(6),=C'REGION'                                             
*--->    MVC   MGR2BK(8),=C'DISTRICT'                                           
*--->    MVC   PGR1BK(8),=C'DIVISION'                                           
         MVC   MGR1BK(L'PP@REGN),PP@REGN                                        
         MVC   MGR2BK(L'PP@DIST),PP@DIST                                        
         MVC   PGR1BK(L'PP@DIV),PP@DIV                                          
         DROP  RE                                                               
*                                                                               
         MVI   MGR1LEN,3                                                        
         MVI   MGR2LEN,3                                                        
         MVI   PGR1LEN,3                                                        
         XC    SAVMGRU,SAVMGRU                                                  
         CLI   QREGION,C'0'        FOR  REQS FOR ONE REG/DST                    
         BL    *+10                MUST SET SAVMGRU HERE                        
         MVC   SAVMGRU(3),QREGION  BECAUSE I DON'T GET MODE SETTINGS            
         CLI   QDIST,C'0'                                                       
         BL    *+10                                                             
         MVC   SAVMGRU+3(3),QDIST                                               
*                                                                               
         L     RF,ADAGY                                                         
         MVC   AGYADR,PAGYADDR-PAGYREC(RF)                                      
         MVC   AGYNM,PAGYNAME-PAGYREC(RF)                                       
*                                                                               
         MVC   MED,QMEDIA                                                       
         MVC   MEDNM,PAGYMED-PAGYREC(RF)                                        
         OC    MEDNM,SPACES                                                     
*                                                                               
         CLI   QMEDIA,C'S'                                                      
         BNE   REQF1X2                                                          
         CLC   MEDNM(6),=C'SEARCH'    SEE IF MEDIA S IS SEARCH                  
         BNE   REQF1X2                                                          
         MVI   SRCHSW,C'Y'         SET SEARCH SWITCH                            
*                                                                               
REQF1X2  B     REQF3                                                            
*                                                                               
REQF3    DS    0H                                                               
         GOTO1 DATCON,DMCB,(4,RCDATE),(0,TODAY)                                 
         GOTO1 DATCON,DMCB,TODAY,(3,TODAYB)                                     
*                                                                               
         CLI   RCMULTIQ,C'Y'       SEE IF DOING MULTI-MEDIA REQ                 
         BNE   REQF5                                                            
*                                                                               
         CLI   FMULTMED,C' '       SEE IF I HAVE ALREADY                        
         BH    REQF7               ENCOUNTERED A MEDIA                          
*                            IF SO, DON'T RESET PAGE,SETDSW,BTABSW              
         MVC   FMULTMED,QMEDIA     FIRST MEDIA FOR MULT-MEDIA REQUEST           
         B     REQF5                                                            
*                                                                               
*******  CLI   QMEDIA,C'M'         SEE IF FIRST MEDIA                           
*******  BE    REQF5                                                            
*******  B     REQF7              DON'T RESET PAGE,SETDSW,BTABSW                
*                                                                               
REQF5    MVC   PAGE,=H'1'                                                       
         MVI   SETDSW,C'N'                                                      
         MVI   BTABSW,C'N'                                                      
         MVI   CLTRDSW,C'N'                                                     
         CLI   QCLIENT,C'*'       SEE IF OFFICE GROUP REQUEST                   
         BE    REQF6                                                            
         CLI   QCLIENT,C'&&'      SEE IF OFFICE GROUP REQUEST                   
         BNE   REQF7                                                            
REQF6    XC    QSAVE,QSAVE        MUST CLEAR LAST REQUEST                       
         MVC   SQEND(6),QEND      SAVE ORIGINAL QEND                            
*                                 RESET IN QEND AT CLIFRST                      
*                                 TO ASSURE PROPER B1 PROFILE                   
*                                 AND INVOICE NUMBER SEQUENCING                 
*                                                                               
REQF7    MVI   FCRDBUY,C'Y'       ACTIVATE READING OF BUYS                      
         MVI   FCRDACTV,C'N'                                                    
         MVI   PUBSW,0                                                          
         XC    ESTNAM2,ESTNAM2                                                  
         CLC   QPRODUCT,SPACES                                                  
         BNE   *+8                                                              
         MVI   FCRDACTV,C'Y'                                                    
         MVI   ACTSW,C'N'                                                       
         XC    DBTOTS(24),DBTOTS   CLEAR REQ CHECKING TOTALS                    
         MVC   SORTTRCE,TRCE                                                    
         MVI   RETDRAFT,C'N'                                                    
         CLC   QPROG,=C'BD'                                                     
         BNE   *+8                                                              
         MVI   RETDRAFT,C'Y'                                                    
*                                                                               
         CLI   QOPTA,C'R'          INVOICE REGISTER REQUESTED?                  
         BNE   *+8                 (MIGHT BE SET FOR DRAFTS)                    
         MVI   DOINVREG,C'Y'                                                    
         CLC   QPROG,=C'B1'        LIVE BILLING?                                
         BNE   *+8                                                              
         MVI   DOINVREG,C'Y'       ALWAYS DO REGISTER                           
         CLC   QPROG,=C'R1'        LIVE REBATE BILLING?                         
         BNE   *+8                                                              
         MVI   DOINVREG,C'Y'       ALWAYS DO REGISTER                           
*                                                                               
         MVC   TYPE,QOPT2          BILLING TYPE IS QOPT2                        
         CLI   TYPE,C' '                                                        
         BNE   *+8                                                              
         MVI   TYPE,C'4'                                                        
         CLI   RETDRAFT,C'Y'                                                    
         BNE   *+8                                                              
         MVI   TYPE,C'D'                                                        
*                                                                               
         MVC   SAVTRACE,RCTRACE                                                 
*                                                                               
         L     RE,=A(PDLIST)       CLEAR PRDLIST FOR RETAIL                     
         LH    RF,=H'1500'                                                      
         XCEF                                                                   
*                                  STANDARDIZE QEST (BLANK = ALL)               
*                                  IF USING FILTERS MUST LEAVE                  
*                                  QEST BLANK                                   
*                                                                               
*                                                                               
         CLC   QEST(6),SPACES                                                   
         BNE   *+10                                                             
         MVC   QEST,=C'ALL'                                                     
*                                                                               
         XC    MANGRS(16),MANGRS    IN CASE NEXT REQ IS A MANUAL                
*                                   BILL WITH NO ACTIVITY                       
*                                SO I'LL GO TO ACFIRST IN CLTLAST               
**********                                                                      
*        ENTER/ALTER ESTIMATE FILTER FOR COMMISSION BILLING CLTS                
*        ONLY FOR SINGLE CLIENT REQUESTS                                        
*        WARNING BILLING WILL BE SCREWED UP IF B2B PROFILE IS                   
*        DIFFERENT BY MEDIA AND THE REQUEST IS FOR MEDIA *                      
*        OR IF CLT HEADER DOES NOT EXIST                                        
**********                                                                      
*                                  READ B2B PROFILE                             
         CLC   QCLIENT,=C'ALL'                                                  
         BE    REQF20                                                           
         CLI   QCLIENT,C'*'                                                     
         BE    REQF20                                                           
         CLI   QCLIENT,C'&&'       BILLING GROUP                                
         BE    REQF20                                                           
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(2),QAGENCY                                                   
         MVC   KEY+2(1),QMEDIA                                                  
         MVI   KEY+3,X'02'                                                      
         MVC   KEY+4(3),QCLIENT                                                 
REQF9    L     RF,ADCLT                                                         
         CLC   0(7,RF),KEY         SEE IF CLIENT ALREADY THERE                  
         BE    REQF15                                                           
         GOTO1 HIGH                                                             
         CLC   KEY(7),KEYSAVE                                                   
         BE    REQF10                                                           
         B     EXIT              CLIENT NOT FOUND - EXIT                        
*                                COULD HAPPEN FOR MULTI-MEDIA REQUEST           
*                                                                               
REQF10   GOTO1 GETCLI                                                           
*                                                                               
REQF15   DS    0H                 SEE IF REQUESTED FOR ONE ADID                 
*                                 IF SO, READ THE JOB REC AND SET               
*                                 THE CODE IN THE REQUEST CARD                  
*                                 JXXXXXX IN QPUB+1                             
         CLI   QADID,C'.'         REQUEST FOR ONE WB FLIGHT?                    
         BE    REQF17                                                           
*                                                                               
         CLC   QADID,SPACES                                                     
         BNH   REQF17                                                           
         CLC   QPUB,SPACES                                                      
         BE    *+6                                                              
         DC    H'0'                NOTHING CAN BE THERE                         
*                                  RD=... MIGHT BE HERE                         
         XC    KEY,KEY                                                          
         MVC   KEY(2),QAGENCY                                                   
         MVC   KEY+2(1),QMEDIA                                                  
         MVI   KEY+3,X'C1'                                                      
         MVC   KEY+4(3),QCLIENT                                                 
         MVC   KEY+7(3),QPRODUCT                                                
         MVC   KEY+10(12),QADID                                                 
         GOTO1 HIGH                                                             
         CLC   KEY(22),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'              MUST FIND (REQUEST PROGRAM SHOULD              
*                                VALIDATE EXISTENCE                             
         GOTO1 GETJOB                                                           
*                                                                               
         L     R7,PPFILEC          NEEDED TO ADDRESS PJOBREC                    
         USING PPFILED,R7                                                       
         MVI   QPUB+1,C'J'         SET JOB FILTER                               
         MVC   QPUB+2(6),PJOBKJOB                                               
         DROP  R7                                                               
*                                                                               
*                                                                               
REQF17   XC    WORK,WORK                                                        
         MVC   WORK(4),=C'PB2B'                                                 
         NI    WORK,X'BF'          LOWER CASE                                   
         MVC   WORK+4(3),QAGENCY                                                
         L     RF,ADCLT                                                         
         MVC   WORK+7(3),PCLTKCLT-PCLTREC(RF)                                   
         LA    RF,PCLTOFF-PCLTREC(RF)                                           
         CLI   0(RF),C' '                                                       
         BNH   *+14                                                             
         MVI   WORK+10,C'*'        SET OFFICE CODE                              
         MVC   WORK+11(1),0(RF)                                                 
         CLI   WORK+6,C'*'         SEE IF MEDIA "*" REQUEST                     
         BNE   REQF18                                                           
         L     RF,ADCLT                                                         
         MVC   WORK+6(1),2(RF)     USE MEDIA FORM CLIENT HEADER                 
*                                                                               
REQF18   GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB2B,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,PROFB2B,WORK+16                               
*                                                                               
         CLI   QMEDIA,C'I'          PLANNED COST ONLY FOR MEDIA I               
         BE    REQF18A                                                          
         CLI   QMEDIA,C'L'          OR MEDIA L                                  
         BE    REQF18A                                                          
         CLI   QMEDIA,C'B'          OR MEDIA B                                  
         BE    REQF18A                                                          
         CLI   QMEDIA,C'V'          OR MEDIA V                                  
         BE    REQF18A                                                          
         CLI   QMEDIA,C'W'          OR MEDIA W                                  
         BE    REQF18A                                                          
         CLI   QMEDIA,C'D'          OR DIGITAL AUDIO                            
         BE    REQF18A                                                          
*                                                                               
         CLI   QMEDIA,C'S'         CHECK FOR MEDIA S                            
         BNE   REQF18NS                                                         
         CLI   PROFB2B+15,C'S'     PLANNED COST ALLOWED FOR MEDIA S             
         BNE   REQF18NS                                                         
         LA    RF,WORK+16                                                       
         USING PROFINFD,RF                                                      
         CLI   PROFIMED,C'S'       BE SURE I FOUND A MEDIA S PROFILE            
         BNE   REQF18NS            IF NOT, DON'T HONOR PC BILLING               
         MVI   PROFB2B+12,C'Y'                                                  
         B     REQF18A                                                          
         DROP  RF                                                               
*                                                                               
REQF18NS MVI   PROFB2B+12,C'N'     DEFAULT TO N                                 
         MVC   PROFB2B+13(2),=X'FFFF'                                           
         B     REQF18BX                                                         
*                                                                               
REQF18A  DS    0H                                                               
         CLI   PROFB2B+12,0                                                     
         BNE   *+8                                                              
         MVI   PROFB2B+12,C'N'     DEFAULT TO N                                 
         OC    PROFB2B+13(2),=X'0000'   EFFECTIVE DATE GIVEN?                   
         BNE   REQF18B                                                          
         MVC   PROFB2B+13(2),=X'FFFF'                                           
         B     REQF18BX                                                         
*                                                                               
REQF18B  MVC   W(2),PROFB2B+13                                                  
         CLI   PROFB2B+14,0       NO MONTH GIVEN?                               
         BNE   *+8                                                              
         MVI   W+1,X'01'          SET TO JANUARY                                
         MVI   W+2,X'01'                                                        
         GOTO1 DATCON,DMCB,(3,W),(0,W+6)                                        
         GOTO1 DATCON,DMCB,(0,W+6),(3,W)                                        
         MVC   PROFB2B+13(2),W                                                  
*                                                                               
REQF18BX DS    0H                                                               
*                                                                               
*        CODE ABOVE SHOULD CONVERT BINARY DATE TO EBCDIC                        
*        THEN BACK TO BINARY - THIS IS NEEDED FOR Y2K PROFILE VALUES            
*                                                                               
         OC    PROFB2B(12),PROFB2B   WAS WHOLE PROFILE - NOW CHECK 12           
         BZ    REQF20                                                           
*                                                                               
         CLI   PROFB2B,C'N'                                                     
         BE    REQF20                                                           
*                                                                               
         CLI   PROFB2B+1,0    SEE IF REGULAR EST FILTER POSITION                
         BE    REQF20         DESIGNATED                                        
*                                                                               
REQF18E  CLC   QEST,=C'ALL'                                                     
         BNE   REQF20                                                           
*                                                                               
         CLI   QESTEND,C' '         CHK FOR FILTER ALREADY THERE                
         BH    *+10                                                             
         MVC   QESTEND(3),=C'***'                                               
*                                                                               
         ZIC   RF,PROFB2B+1                                                     
         LA    RF,QESTEND-1(RF)                                                 
         MVC   0(1,RF),PROFB2B+2        SET FILTER VALUE IN REQUEST             
         CLI   QOPT8,C'R'                                                       
         BE    *+8                                                              
         NI    0(RF),X'BF'              SET TO ALL BUT                          
*                                                                               
*                                                                               
REQF20   DS    0H                                                               
         GOTO1 =A(VBADD),DMCB,(C'C',0)     CLEAR VBTAB                          
         B     EXIT                                                             
         SPACE 3                                                                
*        CLTFRST                                                                
CLTF     DS    0H                                                               
*                                                                               
         MVI   CURSW,C'N'          SET OFF CURRENT MONTH SWITCH                 
*                                                                               
*        CLC   QAGENCY,=C'OO'       OMD                                         
*        BNE   CLTF100                                                          
*        BRAS  RE,WBOFFCK                                                       
*        BNE   CLTF100                                                          
*                                                                               
CLTF100  BRAS  RE,CFIRST                                                        
*                          CLTSW MAY BE SET TO 'N'                              
*                          FOR TYPERRS AND PROFERRS                             
*                          IF QCLIENT = ALL,*,&                                 
         CLI   PO#OPT,C'Y' SEE IF BILLING BY PO#                                
         BNE   *+8                                                              
         MVI   JOBCTL,C'S' SET JOBS (PO#S) TO SEPARATE                          
         B     EXIT                                                             
         SPACE 2                                                                
*        ESTFRST                                                                
ESTF     DS    0H                                                               
*                                                                               
         BRAS  RE,EFIRST   NOW IN ITS OWN NMOD                                  
*                                                                               
         CLI   MODE,CLILAST            NEEDED SINCE I MAY GET HERE FOR          
         BE    CLTL                    A SINGLE EST RETAIL REQUEST              
*                                      WHEN DOING A MANUAL BILL                 
*                                                                               
         B     EXIT                                                             
         SPACE 2                                                                
PGR1F    DS    0H                                                               
         L     RF,PPFILEC                                                       
         USING PPFILED,RF                                                       
         MVC   SAVPGRU(3),PDIVKDIV                                              
*                                                                               
         MVI   MOLSON,C'N'      SET OFF MOLSON OPTION                           
*                                                                               
         CLI   SVWBSW,C'Y'       CHECK ORIGINAL WBSW                            
         BNE   PGR1F2            SKIP IF NOT Y                                  
*                                                                               
         MVI   WBSW,C'Y'                                                        
         MVI   UCOMMSW,C'Y'     SET ON UCOMM BILL CONTROL                       
         MVI   JOBCTL,C'S'                                                      
*                                                                               
         CLC   QAGENCY,=C'OO'     OMD WARNER BROS. - ALL DIVISIONS              
         BE    PGR1F2            ARE THEATRICAL                                 
*                                                                               
         CLC   PDIVKDIV,=C'100'  DIVISION 100 FOR THEATRICAL PRDS (M+)          
         BE    PGR1F2            AND MAYBE FOR NON-TEST AGY                     
         CLC   PDIVKDIV,=C'202'  DIVISION 202 FOR THOME VIDEO                   
         BE    PGR1F2            TREAT AS THEATRICAL                            
         CLC   PDIVKDIV,=C'300'  DIVISION 300 FOR THEATRICAL PRDS (M+)          
         BE    PGR1F2            TREAT AS THEATRICAL                            
         CLC   PDIVKDIV,=C'404'  DIVISION 300 FOR THEATRICAL PRDS (M+)          
         BE    PGR1F2            TREAT AS THEATRICAL                            
*                                                                               
PGR1F1X  CLI   QADID,C'.'       FILTERING ON A FLIGHT ID?                       
         BE    PGR1F2           MUST LEAVE SWITCHES ON                          
*                               TO PREVENT BILLING OF UNWANTED DATA             
         MVI   WBSW,C'N'        SET OFF WBSW                                    
         MVI   UCOMMSW,C'N'     SET OFF UCOMM BILL CONTROL                      
         MVI   JOBCTL,C'N'                                                      
         B     PGR1FX           (OVERRIDES CLIENT)                              
*                                                                               
PGR1F2   DS    0H               SET OFF UCOMM BILL CONTROL                      
*                               IF NOT THEATRICAL? OR LEAVE ALONE?              
*GR1F5   DS    0H                                                               
*        CLC   QAGENCY,=C'BS'   SEE IF BACKER                                   
*        BNE   PGR1FX                                                           
*******  CLC   QAGENCY,=C'TH'   SEE IF ZENITH                                   
*******  BNE   PGR1FX                                                           
*        CLI   RETPROF,0         SEE IF RETAIL                                  
*        BE    PGR1FX                                                           
*        CLC   PDIVKDIV,=C'002' SEE IF DIVISION 2                               
*        BNE   PGR1FX                                                           
*        CLC   PDIVNAME(6),=C'MOLSON'   SHOULD CLINCH IT                        
*        BNE   PGR1FX                                                           
*        MVI   MOLSON,C'Y'      SET ON MOLSON OPTION                            
*                                                                               
PGR1FX   B     EXIT                                                             
         SPACE 2                                                                
         DROP  RF                                                               
*                                                                               
*        PRDFRST                                                                
PRDF     DS    0H                                                               
*                                                                               
         NI    FLAG1,X'FF'-NOBILPRD  INIT                                       
         L     RF,ADPRD                                                         
         TM    PPRDSTAT-PPRDREC(RF),X'40'     BILL=NO?                          
         BZ    *+16                                                             
         MVI   MODE,PRDLAST        DON'T BILL THIS PRODUCT                      
         OI    FLAG1,NOBILPRD                                                   
         B     PRDF6                                                            
*                                                                               
         CLI   SVWBSW,C'Y'         CHECK ORIGINAL WBSW                          
         BNE   PRDF0X                                                           
         MVI   UCOMMSW,C'Y'        RESET UCOMM BILL CONTROL                     
         MVI   WBSW,C'Y'                                                        
         MVI   JOBCTL,C'S'                                                      
*                                                                               
         CLI   QADID,C'.'          FLIGHT FILTER ENTERED?                       
         BE    PRDF0X              IF SO LEAVE SWICHES ON                       
*                                  SO FILTERING WILL WORK                       
*                          AND PREVENT BILLING OF NON-THEATRICAL                
*                                                                               
         L     RF,ADPRD                                                         
*****    CLC   =C'001',PPRDDIV-PPRDREC(RF) ASSIGNED TO DIV 001?                 
*****    BE    PRDF0X              THEATRICAL - EXIT WITH RESET VALUES          
         CLC   =C'100',PPRDDIV-PPRDREC(RF) ASSIGNED TO DIV 100?                 
         BE    PRDF0X              THEATRICAL - EXIT WITH RESET VALUES          
*                                                                               
         CLC   QAGENCY,=C'OO'  FOR OMD MUST BE DIV 100,200,300,400,500          
         BNE   PRDF00          600, 700,800,900                                 
         CLC   =C'200',PPRDDIV-PPRDREC(RF) ASSIGNED TO DIV 200?                 
         BE    PRDF0X              THEATRICAL - EXIT WITH RESET VALUES          
         CLC   =C'300',PPRDDIV-PPRDREC(RF) ASSIGNED TO DIV 300?                 
         BE    PRDF0X              THEATRICAL - EXIT WITH RESET VALUES          
         CLC   =C'400',PPRDDIV-PPRDREC(RF) ASSIGNED TO DIV 400?                 
         BE    PRDF0X              THEATRICAL - EXIT WITH RESET VALUES          
         CLC   =C'500',PPRDDIV-PPRDREC(RF) ASSIGNED TO DIV 500?                 
         BE    PRDF0X              THEATRICAL - EXIT WITH RESET VALUES          
         CLC   =C'600',PPRDDIV-PPRDREC(RF) ASSIGNED TO DIV 600?                 
         BE    PRDF0X              THEATRICAL - EXIT WITH RESET VALUES          
         CLC   =C'700',PPRDDIV-PPRDREC(RF) ASSIGNED TO DIV 700?                 
         BE    PRDF0X              THEATRICAL - EXIT WITH RESET VALUES          
         CLC   =C'800',PPRDDIV-PPRDREC(RF) ASSIGNED TO DIV 800?                 
         BE    PRDF0X              THEATRICAL - EXIT WITH RESET VALUES          
         CLC   =C'900',PPRDDIV-PPRDREC(RF) ASSIGNED TO DIV 900?                 
         BE    PRDF0X              THEATRICAL - EXIT WITH RESET VALUES          
         B     PRDF0AX                                                          
*                                                                               
PRDF00   CLC   =C'WB9',PPRDKCLT-PPRDREC(RF) FOR THESE CLIENTS CHECK             
         BE    PRDF0A                       FOR DIV 202 OR 404                  
         CLC   =C'WP9',PPRDKCLT-PPRDREC(RF)                                     
         BNE   PRDF0A5                                                          
*                                                                               
PRDF0A   CLC   =C'202',PPRDDIV-PPRDREC(RF) HM VIDEO-TREAT AS THEATRICAL         
         BE    PRDF0X                                                           
         CLC   =C'404',PPRDDIV-PPRDREC(RF) VIDEO ON DEMAND AS THEATRICA         
         BE    PRDF0X                                                           
         B     PRDF0AX                                                          
*                                                                               
PRDF0A5  CLC   =C'WA9',PPRDKCLT-PPRDREC(RF) FOR THESE CLIENTS CHECK             
         BE    PRDF0A6                      FOR DIV 404                         
         CLC   =C'WC9',PPRDKCLT-PPRDREC(RF)                                     
         BNE   PRDF0AX                                                          
*                                                                               
PRDF0A6  CLC   =C'404',PPRDDIV-PPRDREC(RF) VIDEO ON DEMAND AS THEATRICA         
         BE    PRDF0X                                                           
         B     PRDF0AX                                                          
*                                                                               
PRDF0AX  DS    0H                                                               
         MVI   UCOMMSW,C'N'                                                     
         MVI   WBSW,C'N'                                                        
         MVI   JOBCTL,C'N'                                                      
*                                  SET BILL FORMULA EFF DATE                    
PRDF0X   DS    0H                                                               
         XC    EFFDTE,EFFDTE                                                    
         XC    PRDFORM,PRDFORM                                                  
***      XC    PRDFORM2,PRDFORM2                                                
***      XC    PRDFORM3,PRDFORM3                                                
         XC    ESTFORM,ESTFORM                                                  
***      XC    ESTFORM2,ESTFORM2                                                
***      XC    ESTFORM3,ESTFORM3                                                
         L     RF,ADPRD                                                         
         MVC   KPRD,PPRDKPRD-PPRDREC(RF)   USED IN PRBUY                        
*                                                                               
******   CLI   BFROPT,C'N'     SEE IF USING BILLING FORMULA RECORDS             
******   BNE   PRDF1                                                            
*                                                                               
         MVC   PRDFORM,PPRDBILP-PPRDREC(RF)                                     
***      MVC   PRDFORM2,PPRDBILP+37-PPRDREC(RF)                                 
***      MVC   PRDFORM3,PPRDBILP+44-PPRDREC(RF)                                 
*                                                                               
PRDF1    DS    0H                                                               
         CLI   PREVSW,C'P'         IF PREVIOUS ONLY                             
         BE    PRDF4                                                            
         OC   MANGRS(12),MANGRS    OR MANUAL BILL                               
         BZ    PRDF6                                                            
**NEW 6/20/88                                                                   
         CLI   ESTQ,C'1'           FOR SINGLE EST REQ                           
         BNE   PRDF3                                                            
         OC    RETPROF,RETPROF     AND RETAIL                                   
         BZ    PRDF3                                                            
         B     PRDF6             DON'T SET FCRDBUY TO 'N' YET                   
*                                NEEDED SO I'LL READ ESTIMATE                   
*                                AND CAN SET NON-RETAIL IF                      
*                                NON-RETAIL ESTIMATE.                           
*                                ESTF WILL THEN SET MODE TO CLILAST             
**NEW 6/20/88                                                                   
PRDF3    MVI   MODE,CLILAST        TO SKIP BUY READING                          
         B     CLTL                                                             
PRDF4    DS    0H                                                               
         MVI   FCRDBUY,C'N'       SET NO TO READ BUYS                           
PRDF6    DS    0H                                                               
         B     EXIT                                                             
         SPACE 2                                                                
**NEW 6/20/88                                                                   
         SPACE 2                                                                
*        MGR1FRST                                                               
MGR1F    DS    0H                                                               
         L     RF,PPFILEC                                                       
         USING PPFILED,RF                                                       
         MVC   SAVMGRU(3),PREGKREG                                              
         B     EXIT                                                             
         SPACE 3                                                                
MGR2F    DS    0H                                                               
         CLI   QDIST,C' '              SEE IF DISTRICT REQ                      
         BE    EXIT                    NO JUST EXIT                             
         L     RF,PPFILEC                                                       
         USING PPFILED,RF                                                       
         CLC   PREGKCLT(9),PDSTKCLT     DISTRICT MUST BE FOR                    
         BNE   MGERR                    RIGHT CLT/DIV/REG                       
         MVC   SAVMGRU+3(3),PDSTKDST                                            
         B     EXIT                                                             
*                                                                               
MGERR    CLI   PROGPRO2+3,C'N'         SEE IF REG/DST SUPPRESSED                
         BNE   MGERR5                                                           
         CLC   QDIST,=C'ALL'                                                    
         BNE   MGERR5                                                           
         MVC   SAVMGRU+3(3),=C'999'    SET DUMMY DISTRICT                       
         B     EXIT                                                             
*                                                                               
MGERR5   MVI   ERR,MGRERR              REGION/DISTRICT ERROR                    
*                                      CAUSED WHEN PUB ASSGINED                 
*                                      TO A REGION BUT NOT A DST                
*                                      USED TO CAUSE DUMPS AT FMGR2             
         BRAS  RE,ERRPROC                                                       
         B     EXIT                                                             
         DROP  RF                                                               
*                                                                               
         EJECT                                                                  
*        PGR1LAST                                                               
PGR1L    DS    0H                                                               
         L     R3,APGR1BRK                                                      
         B     PGRXL                                                            
         SPACE 2                                                                
*        PGR2LAST                                                               
PGR2L    DS    0H                                                               
         L     R3,APGR2BRK                                                      
         B     PGRXL                                                            
         SPACE 2                                                                
*        PGR3LAST                                                               
PGR3L    DS    0H                                                               
         L     R3,APGR3BRK                                                      
         B     PGRXL                                                            
         SPACE 2                                                                
PGRXL    DS    0H                                                               
         LTR   R3,R3                                                            
         BZ    EXIT                LEVEL NOT USED                               
         C     R3,AINVBRK                                                       
         BH    EXIT                LEVEL 'BELOW' INV BREAK                      
         B     RESTART                                                          
         SPACE 2                                                                
*        PRDLAST                                                                
PRDL     DS    0H                                                               
         CLC   APRDBRK,AINVBRK                                                  
         BH    PRDL2                LEVEL 'BELOW' INV BREAK                     
         L     RF,ADPRD                                                         
         MVC   KPRD,PPRDKPRD-PPRDKEY(RF)                                        
         B     RESTART                                                          
PRDL2    DS    0H                                                               
         CLI   PREVSW,C'N'         SEE IF DOING PREVIOUS BILLS                  
         BE    EXIT                                                             
         L     RF,ADPRD                                                         
         MVC   KPRD,PPRDKPRD-PPRDKEY(RF)                                        
         BRAS  RE,RMBILL           MUST READ MANUAL BILLS                       
         B     EXIT                                                             
         SPACE 2                                                                
*        MGR1LAST                                                               
MGR1L    DS    0H                                                               
         L     R3,AMGR1BRK                                                      
         B     MGRXL                                                            
         SPACE 2                                                                
*        MGR2LAST                                                               
MGR2L    DS    0H                                                               
         L     R3,AMGR2BRK                                                      
         B     MGRXL                                                            
         SPACE 2                                                                
*        MGR3LAST                                                               
MGR3L    DS    0H                                                               
         L     R3,AMGR3BRK                                                      
         B     MGRXL                                                            
         SPACE 2                                                                
MGRXL    DS    0H                                                               
         LTR   R3,R3                                                            
         BZ    EXIT                LEVEL NOT USED                               
         CLI   SUMOPT,C'Y'         IF DOING RETAIL CORP SUMMARY                 
         BE    EXIT                DONT DO 1 MGR AT A TIME                      
         CLI   MGRBKTS,C'Y'        OR IF MGR BUCKETS                            
         BE    EXIT                                                             
         C     R3,AINVBRK                                                       
         BH    EXIT                LEVEL 'BELOW' INV BREAK                      
         CLC   APRDBRK,AINVBRK                                                  
         BH    EXIT                PRD 'BELOW' INV BREAK                        
         L     RF,ADPRD                                                         
         MVC   KPRD,PPRDKPRD-PPRDREC(RF)                                        
         B     RESTART                                                          
         SPACE 2                                                                
*        MKTLAST                                                                
         SPACE 2                                                                
MKTL     DS    0H                  **INACTIVE**                                 
         B     EXIT                                                             
         SPACE 2                                                                
*        CLTLAST                                                                
         SPACE 2                                                                
CLTL     DS    0H                                                               
         OC   MANGRS(12),MANGRS      MANUAL BILL (WITH ACTIVITY)                
         BNZ   RESTART                                                          
         CLI   QMANUAL,C'G'          TEST FOR MANUAL BILL                       
         BE    CLTL5                 WITH NO ACTIVITY                           
         CLI   QMANUAL,C'F'          OR MANUAL FEE                              
         BNE   RESTART                                                          
CLTL5    BRAS  RE,CFIRST             MUST GO THROUGH CLI FIRST                  
         MVC   KPRD,QPRODUCT         MUST SET PRD FOR PRBUY                     
         MVI   DONESW,C'N'                                                      
         B     RESTART                                                          
         EJECT                                                                  
         SPACE 2                                                                
RESTART  DS    0H                                                               
RSTR     DS    0H                                                               
         CLI   DONESW,C'D'                                                      
         BE    RSTR2                                                            
         MVI   DONESW,C'D'                                                      
         OC    MANGRS(12),MANGRS    TEST MANUAL BILLING                         
         BZ    RSTR1D              NO                                           
*                                  YES - SET UP DUMMY BUY AND POST IT           
         TM    FLAG1,NOBILPRD      UNLESS NOT BILLING THIS PROD                 
         BO    RSTR1D                                                           
*                                                                               
         L     RF,ADBUY                                                         
         USING PBUYREC,RF                                                       
         XC    0(250,RF),0(RF)       MUST CLEAR IT                              
         MVC   PBUYKMED,QMEDIA                                                  
         MVC   PBUYKAGY,QAGENCY                                                 
         MVC   PBUYKCLT,QCLIENT                                                 
         MVC   PBUYKPRD,QPRODUCT                                                
         MVC   KPRD,QPRODUCT                                                    
         PACK  DUB,QEST                                                         
         CVB   R0,DUB                                                           
         STH   R0,HALF                                                          
         MVC   PBUYKEST,HALF                                                    
         MVC   PBUYKPUB(6),XXPUB                                                
         MVC   PBDBDATE,PERLIST+5       MOVE START DATE                         
*                                                                               
         DROP  RF                                                               
*                                                                               
         BRAS  RE,PRBUY            PROCESS MANUAL AS DUMMY BUYS                 
*                                                                               
RSTR1D   DS    0H                                                               
         OC    BRKTAB,BRKTAB       TEST HAVE SET KEY TABLE                      
         BZ    RSTR1H              NO- NO PROCESSING                            
         OC   MANGRS(12),MANGRS    SEE IF MANUAL BILL                           
         BNZ   RSTR1F              YES - SKIP READ OF OLD MANUAL BILLS          
         CLI   MODE,PGR3LAST                                                    
         BNL   RSTR1F                                                           
         CLI   PREVSW,C'N'                                                      
         BE    RSTR1F                                                           
*                                                                               
         CLI   MODE,CLILAST        SEE IF CLIENT LAST                           
         BE    RSTR1F              SKIP MANUAL BILL READ                        
         CLI   MODE,PGR1LAST       OR LAST FOR DIVISION                         
         BE    RSTR1F              SKIP MANUAL BILL READ                        
         BRAS  RE,RMBILL           READ OLD MANUAL BILLS                        
RSTR1F   L     RF,ABUFFC                                                        
         L     RF,BUFFSOFA-BUFFALOD(RF)                                         
         LTR   RF,RF                                                            
         BZ    RSTR1H              NO DATA                                      
         CLI   RCMULTIQ,C'Y'       SEE IF DOING MULTI-MEDIA REQ                 
         BNE   RSTR1G                                                           
         CLI   MODE,LBUYXRQ         SEE IF LAST FOR MULTIU-MEDIA REQ            
         BNE   RSTR2                                                            
*                                                                               
RSTR1G   BRAS  RE,RDBUFF                                                        
*                                                                               
RSTR1H   DS    0H                                                               
         GOTO1 BUFFALO,DMCB,=C'RESET',ABUFFC                                    
*                                                                               
*                                                                               
RSTR2    DS    0H                                                               
         CLI   MODE,LBUYXRQ       SEE IF LAST FOR MULTI-MEDIA REQ               
         BE    RSTR2C             ALSO DO AORINV                                
         CLI   MODE,CLILAST                                                     
         BNE   EXIT                                                             
**NEW 3/11/91                                                                   
RSTR2C   DS    0H                                                               
         CLI   AORLOPT,C'C'                                                     
         BNE   RSTR3                                                            
         MVI   AORLCTL,C'P'                                                     
****     BRAS  RE,AORINV                                                        
         GOTO1 =A(AORINV)                                                       
         XC    PEPTABN,PEPTABN     CAN FINALLY CLEAR PEPTAB                     
*                                  IT'S NORMALLY CLEARED IN ENDINV              
*                                                                               
RSTR3    DS    0H                                                               
         CLI   MODE,CLILAST                                                     
         BNE   EXIT                                                             
*                                                                               
**NEW 3/11/91                                                                   
         OC   MANGRS(12),MANGRS    SEE IF MANUAL BILL                           
         BZ    RSTR4                                                            
         TM    FLAG1,NOBILPRD      UNLESS NOT BILLING THIS PROD                 
         BO    RSTR4                                                            
         MVC   DBTOTS,MANGRS                                                    
         MVI   MODE,LBUYREQ        SO PPG WILL GO TO NEXT REQ                   
*                                  TEST DISCREPANT TOTALS                       
RSTR4    CLI   RETDRAFT,C'Y'                                                    
         BE    EXIT                                                             
***E***                                                                         
         CLC   QPROG,=C'E1'      ESTIMATE - NO OBTOTS + DBTOTS CHK              
         BE    EXIT                                                             
***E***                                                                         
         OC    MANGRS(12),MANGRS    MANUAL BILL?                                
         BZ    RSTR5                                                            
         CLI   WBSW,C'Y'          WB FLIGHT ACTIVE?                             
         BNE   RSTR5                                                            
         CLI   QADID,C'.'         AND FLIGHT ENTERED                            
         BE    RSTR5X             DON'T CHECK SINCE IF IT'S THE                 
*                                 WRONG ONE FOR THE ESTIMATE                    
*                                 SKIPPING THIS CHECK WILL                      
*                                 ALLOW THE PROGRAM TO PROCEDE                  
*                                 AND 'NO BILLING GENERATED' MESSAGE            
*                                 WILL APPEAR.                                  
RSTR5    CLC   OBTOTS,DBTOTS                                                    
         BE    *+6                                                              
         DC    H'0'                                                             
RSTR5X   CLI   ACTSW,C'Y'                                                       
         BE    EXIT                                                             
*                                                                               
RSTR6    DS    0H                                                               
**NEW 7/13/88                                                                   
         CLI   QCLIENT,C'&&'       CHK GROUP REQUEST                            
         BE    EXIT                YES - JUST EXIT                              
         CLI   QCLIENT,C'*'        CHK OFFICE REQUEST                           
         BE    EXIT                YES - JUST EXIT                              
         CLC   QCLIENT,=C'ALL'      CHK ALL CLT REQUEST                         
         BE    EXIT                YES - JUST EXIT                              
**NEW 7/13/88                                                                   
         CLI   RCMULTIQ,C'Y'       SEE IF MULTI-MEDIA REQ                       
         BNE   RSTR8                                                            
         CLI   MODE,LBUYXRQ        ONLY FOR LAST MEDIA                          
         BNE   EXIT                                                             
RSTR8    MVI   ERR,NOBILERR        NO BILLING GENERATED                         
         BRAS  RE,ERRPROC                                                       
         SPACE 3                                                                
*                                                                               
*        REQUEST LAST                                                           
REQL     MVC   QSAVE,QPROG                                                      
*                                                                               
         CLI   QMANUAL,C'G'      MANUAL BILL?                                   
         BE    REQL10                                                           
         CLI   QMANUAL,C'F'      MANUAL FEE?                                    
         BE    REQL10                                                           
*                                                                               
*        MANUAL BILLING UNLOCKS IN CFIRST (MODE=CLIFRST)                        
*                                                                               
*                                                                               
*        NOTE: UNLOCKING HERE WON'T WORK IF WE ALLOW                            
*              SOON WITH MEDIA "*"  (DOREMUS DOES FOR FINANCIAL CLTS)           
*                                                                               
         CLI   UPDTSOON,C'Y'     UPDATIVE SOON?                                 
         BNE   REQL10                                                           
         BRAS  RE,UNLOCK         UNLOCK UPDATIVE SOON REQ                       
*                                                                               
REQL10   CLI   CLTRDSW,C'Y'         SEE IF REQUEST READ A CLIENT                
         BE    EXIT                                                             
         CLI   RCMULTIQ,C'Y'        SEE IF MULTI-MEDIA REQUEST                  
         BE    EXIT                 YES - MUST LEAVE QSAVE ALONE                
*                                   IT WILL BE CLEARED AT LBUYXRQ               
         XC    QSAVE,QSAVE                                                      
*                                   CLEAR QSAVE IF NO CLIENT READ               
*                                   FOR THIS REQUEST SO NEXT REQ                
*                                   WILL GO TO AMGPROC AT CFIRST                
         B     EXIT                                                             
*                                                                               
*        RUN LAST                                                               
RUNL     DS    0H                                                               
***E***                                                                         
RUNL10   CLC   QPROG,=C'E1'                                                     
         BE    EXIT                                                             
***E***                                                                         
         BRAS  RE,INVREG                                                        
**EDI**                                                                         
         CLI   OUTMODE,C'D'       SEE IF DIRECT DATASET MODE                    
         BNE   EXIT                                                             
         GOTO1 =A(BILLEDI),DMCB,('EDMCLS',0) CLOSE EDI                          
**EDI**                                                                         
         B     EXIT                                                             
         EJECT                                                                  
*        PROCESS BUY                                                            
PROCESS  DS    0H                                                               
         CLI   QOPT1,C' '                                                       
         BE    PROC20                                                           
         L     RF,ADBUY                                                         
         USING PBUYREC,RF                                                       
         CLI   QOPT1,C'C'          SEE IF DOING CD ITEMS ONLY                   
         BNE   PROC5                                                            
         CP    PBDCD,=P'0'                                                      
         BE    EXIT                NO CD SO IGNORE ITEM                         
         B     PROC20                                                           
*                                                                               
PROC5    CP    PBDCD,=P'0'         MUST BE DOING NON-CD ITEMS                   
         BE    PROC20                                                           
         B     EXIT                CD ITEM SO IGNORE IT                         
*                                                                               
PROC20   BRAS  RE,PRBUY                                                         
         B     EXIT                                                             
         DROP  RF                                                               
         EJECT                                                                  
PUBF     DS    0H                                                               
CHKSRT   DS    0H                                                               
         CLI   RETPROF,0        NO MULTIPLE ASSIGN ALLOWED FOR RETAIL           
         BNE   CKS8                                                             
         CLC   QREGION,SPACES                                                   
         BE    CKS13                                                            
*                                                                               
         CLI   MRDASS,C'Y'      SEE IF SPECIAL DRD SCHEME                       
         BE    CKS13            ALLOW MULTIPLE ASSIGNMENTS                      
*                               WITH REGION/DST SEPARATE                        
*                                                                               
CKS5     CLI   MGR1CTL,C'S'     NO MULTIPLE ASSIGNS FOR                         
         BE    CKS8             SEPARATE INV BY REG                             
         CLI   MGR2CTL,C'S'     NO MULTIPLE ASSIGNS FOR                         
         BE    CKS8             SEPARATE INV BY DISTRICT                        
*                                                                               
*        REVERSAL OF MULTIPLE REG/DST BILL REVERSALS NOW SUPPORTED              
*                                                                               
****     CLI   QMANUAL,C'R'     SEE IF REVERSAL                                 
****     BE    CKS8             CAN'T REVERSE IF MULTIPLE REG/DST               
*                               MUST UNBILL                                     
*                               WILL GET MULTIPLE REVERSAL BILLINGS             
         CLC   QREGION,=C'ALL'                                                  
         BE    CKS13                                                            
*                  IF BY SINGLE REG OR DIST, NO MULTIPLE ASSIGN                 
CKS8     L     R2,ALTLREC                                                       
         LTR   R2,R2                                                            
         BZ    CKS13               NO LTLREC                                    
         LA    R2,33(R2)                                                        
         MVI   ELCODE,X'71'                                                     
         MVI   BYTE,0                                                           
         CLI   0(R2),X'71'                                                      
         BE    CKS12B                                                           
*                                                                               
CKS12    DS    0H                                                               
         BAS   RE,PNEXTEL                                                       
         BNE   CKS13                                                            
*                                                                               
CKS12B   DS    0H                                                               
         USING PUBDSTEL,R2                                                      
*                                                                               
         CLC   QPUB+1(3),=C'RD='     SEE IF DRD OVERRIDE CLT ENTERED            
         BNE   CKS12C                                                           
         CLC   PUBDCLT,QPUB+4       MUST MATCH DRD CLIENT                       
         BNE   CKS12                                                            
         B     CKS12CX                                                          
*                                                                               
CKS12C   DS    0H                                                               
         L     RF,ADCLT                                                         
         CLC   PUBDCLT,PCLTKCLT-PCLTREC(RF)                                     
         BNE   CKS12                                                            
*                                                                               
CKS12CX  DS    0H                                                               
         L     RF,PPFILEC                                                       
         USING PPFILED,RF                                                       
         CLC   PUBDDIV,PDIVKDIV                                                 
         BE    CKS12D                                                           
         CLC   PUBDDIV,PPRDDIV         TRY PRD DIVISION                         
         BNE   CKS12                                                            
CKS12D   CLI   BYTE,0                                                           
         BE    CKS12F                                                           
*                                                                               
         MVC   P1(80),QPROG                                                     
         MVC   P2(80),QAREA2                                                    
         GOTO1 REPORT                                                           
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   P2(90),=CL90'MULTIPLE REG/DST ASSGNS NOT ALLOWED FOR REG         
*--->          S OR DSTS ON SEPARATE INVS - OR RETAIL'                          
         MVC   P1(L'PP@MLT01),PP@MLT01                                          
         MVC   P2(L'PP@MLT02),PP@MLT02                                          
         MVC   P3(23),=C'IF REVERSAL-MUST UNBILL'                               
         DROP  RE                                                               
         GOTO1 REPORT                                                           
         MVI   MODE,LBUYREQ                                                     
         B     EXIT                                                             
         SPACE 3                                                                
PNEXTEL  DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    PNEXTEL2                                                         
         CLC   0(1,R2),ELCODE                                                   
         BER   RE                                                               
         B     PNEXTEL                                                          
PNEXTEL2 DS    0H                                                               
         LTR   RE,RE                                                            
         BR    RE                                                               
*                                                                               
CKS12F   DS    0H                                                               
         MVI   BYTE,1                                                           
         B     CKS12                                                            
*                                                                               
CKS13    DS    0H                                                               
         MVI   PUBSW,0                                                          
         CLI   QOPT3,C' '                                                       
         BE    SETFLT              DOING ALL PUBS                               
         L     RF,PPFILEC                                                       
         LA    R7,1(RF)                                                         
         LA    R7,4095(R7)                                                      
         USING PPFILED+4096,R7                                                  
         LA    R3,PUBREC+33                                                     
         USING PUBGENEL,R3                                                      
         CLI   0(R3),X'10'                                                      
         BE    *+6                                                              
         DC    H'0'                NO NAME ELEMENT                              
         SR    R0,R0                                                            
         IC    R0,1(R3)                                                         
         AR    R3,R0                                                            
         CLI   0(R3),X'20'                                                      
         BE    HAVEL       HAVE PROD ELEMENT                                    
         CLI   QOPT3,C'C'                                                       
         BE    GETNEXT                                                          
         B     SETFLT                                                           
*                                                                               
HAVEL    DS    0H                                                               
         OC    PUBCDDAT,PUBCDDAT   CHK FOR EFF DATE                             
         BNZ   HAVEL5              IF PRESENT THIS IS OR WAS A CD PUB           
         CP    PUBCD,=P'0'                                                      
         BE    NCHDIS              NO CASH DISCOUNT                             
HAVEL5   CLI   QOPT3,C'C'                                                       
         BE    SETFLT                                                           
         B     GETNEXT                                                          
*                                                                               
NCHDIS   CLI   QOPT3,C'C'                                                       
         BE    GETNEXT                                                          
         B     SETFLT                                                           
*                                                                               
GETNEXT  MVI   PUBSW,1             DON'T PROCESS THIS PUB                       
         B     PUBFEXT                                                          
*                                                                               
         DROP  R7                                                               
         DROP  R3                                                               
SETFLT   DS    0H                                                               
PUBFEXT  B     EXIT                                                             
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
INISSB   NMOD1 0,INISSB                                                         
         LA    RF,SSBCPYTB         POINT TO AGENCY ALPHA TABLE                  
*                                                                               
INISSB3  CLI   0(RF),X'FF'         END OF TABLE?                                
         JE    INISSBX                                                          
         CLC   QAGENCY,0(RF)       NEED TO ENABLE COPY RECORD?                  
         JE    INISSB9                                                          
         LA    RF,2(RF)            NEXT ENTRY IN TABLE                          
         J     INISSB3                                                          
*                                                                               
INISSB9  L     RF,SSB                                                           
         USING SSBD,RF                                                          
         OI    SSOSTAT2,SSOSROLC                                                
         DROP  RF                                                               
INISSBX  XIT1                                                                   
*                                                                               
SSBCPYTB DS    0H                                                               
         DC    CL2'SJ'                                                          
         DC    CL2'HD'                                                          
         DC    CL2'*B'                                                          
         DC    CL2'H7'                                                          
         DC    CL2'FR'                                                          
         DC    CL2'JE'                                                          
         DC    CL2'JM'                                                          
         DC    CL2'JP'                                                          
         DC    X'FF'                                                            
*                                                                               
         LTORG                                                                  
*&&DO                                                                           
WBOFFCK  NMOD1 0,WBOFFCK                                                        
         XC    WK,WK                                                            
         XC    WORK,WORK                                                        
OFF      USING OFFICED,WORK                                                     
         MVI   OFF.OFCSYS,C'P'                 NEED SYSTEM                      
         MVC   OFF.OFCAGY,QAGENCY              AGENCY                           
         L     R2,ADCLT                                                         
         MVC   OFF.OFCOFC,PCLTOFF-PCLTREC(R2)  ANY OFFICE                       
         MVC   OFF.OFCCLT,PCLTKCLT-PCLTREC(R2) AND THE CLIENT                   
         DROP  OFF                                                              
*                                                                               
         XC    DMCB(4),DMCB                                                     
         MVC   DMCB+4(3),=X'D9000A'                                             
         MVI   DMCB+7,QOFFICER                                                  
         L     RF,VCOMFACS                                                      
         L     RF,(CCALLOV-COMFACSD)(RF)                                        
         GOTO1 (RF),DMCB                                                        
         CLI   4(R1),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         L     RF,DMCB                                                          
         GOTO1 (RF),DMCB,(C'2',WORK),(X'01',VCOMFACS),(C'S',WK)                 
*                                                                               
         CLC   =C'WB',WK                                                        
         BE    WBOFFCX                                                          
         CLC   =C'RH',WK                                                        
         BE    WBOFFCX                                                          
         CLC   =C'XW',WK                                                        
*        BNE   WBOFFCX                                                          
WBOFFCX  XIT1                                                                   
*                                                                               
         LTORG                                                                  
*&&                                                                             
UNLOCK   NMOD1 0,UNLOCK                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   UPDTSOON,C'Y'       UPDATIVE SOON?                               
         BNE   UNLOCKX                                                          
*                                                                               
         XC    LKUPKEY,LKUPKEY     YES -- UNLOCK UPDATIVE SOONS                 
L        USING LKKEYD,LKUPKEY                                                   
         L     R1,UTL                                                           
         MVC   L.LOCKSE,4(R1)                                                   
         MVC   L.LOCKAGY,QAGENCY                                                
         MVC   L.LOCKRTY,=C'BC'       CLIENT LOCK (USED BY P12 ALSO)            
*****    MVI   L.LOCKKEY,C'*'                                                   
*****    CLI   RCMULTIQ,C'Y'          SEE IF MULTI-MEDIA REQ                    
*****    BE    *+10                                                             
         MVC   L.LOCKKEY(1),QMEDIA                                              
         MVC   L.LOCKKEY+1(3),QCLIENT                                           
         DROP  L                                                                
*                                                                               
         XC    DMCB(4),DMCB                                                     
         MVC   DMCB+4(3),=X'D9000A'                                             
         MVI   DMCB+7,QLOCKET                                                   
         L     RF,VCOMFACS                                                      
         L     RF,(CCALLOV-COMFACSD)(RF)                                        
         GOTO1 (RF),DMCB                                                        
         CLI   4(R1),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         L     RF,DMCB                                                          
*                                                                               
UNLOCK10 GOTO1 (RF),DMCB,('LKUNLKQ',LKUPKEY),VCOMFACS                           
         CLI   4(R1),2             TEST TABLE BUSY                              
         BE    UNLOCK10                                                         
*                                                                               
UNLOCKX  DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
*                                                                               
LKUPKEY  DS    CL15                UPDATIVE SOON KEY                            
*                                                                               
         EJECT                                                                  
         TITLE 'PROCESS BUY - OR MANUAL BILLS AS DUMMY BUYS'                    
PRBUY    NMOD1 0,PRBUY,R8                                                       
************************  NOTE USE OF R8 AS SECOND BASE REGISTER                
*                                                                               
         LA    RC,SPACEND                                                       
*                                                                               
         TM    FLAG1,NOBILPRD      SEE IF BILLING THIS PROD                     
         BO    PRBUYXX             NO - THEN SKIP THIS INSERTION                
         CLI   CLTSW,C'N'          SEE IF PROCESSING THIS CLIENT                
         BE    PRBUYXX             NO - THEN SKIP THIS INSERTION                
         CLI   PUBSW,0             SEE IF PROCESSING THIS PUB                   
         BNE   PRBUYXX             NO - THEN SKIP THIS INSERTION                
*                                                                               
*                                                                               
PRBUY05  LA    R2,PERLIST                                                       
         L     RF,ADBUY                                                         
         CLC   PBDBDATE-PBUYREC(3,RF),2(R2)   SEE IF BEFORE FIRST               
         BL    PRBUYXX                        MTH START - YES SKIP              
*                                                                               
PRBUY10  CLC   PBDBDATE-PBUYREC(3,RF),5(R2)                                     
         BNH   PRBUY15                                                          
         LA    R2,8(R2)                                                         
         CLI   0(R2),X'FF'          SEE IF AT END OF PERLIST                    
         BE    PRBUYXX             PAST END OF LIST SO SKIP                     
         B     PRBUY10                                                          
*                                                                               
PRBUY15  DS    0H                                                               
*                                                                               
PRBUY20  DS    0H                                                               
         L     RF,ADBUY                                                         
         XC    KTYP,KTYP           KTYP=0 MEANS NO ADDIT CHGS                   
         XC    KPO#,KPO#           KPO#=0 MEANS NO PO#S                         
         XC    SVCURPO#,SVCURPO#   CLEAR SAVED BUY'S CURRENT PO#                
*                                                                               
         CLI   3(RF),X'88'         SEE IF PROCESSING MANUAL BILL                
         BE    PRBUY30             SKIP EXCLUDING BILLING CHECK                 
*                                                                               
         CLI   PO#OPT,C'Y'         SEE IF BILLING BY PO#                        
         BNE   PRBUY20A                                                         
*                                                                               
         OC    MANGRS(12),MANGRS       ARE WE DOING MANUAL ?                    
         BZ    PBUY201            YES, DON'T DO GETINS                          
         CLI   PO#OPT,C'Y'      BILLING BY PO#                                  
         BNE   PBUY201                                                          
         CLC   QPO#SEQ,SPACES                                                   
         BNE   *+6                                                              
         DC    H'0'             SHOULD NOT HAPPEN                               
         MVC   KPO#,QPO#SEQ                                                     
         MVC   SVCURPO#,QPO#SEQ                                                 
         XC    PO#TAB,PO#TAB       TABLE OF PO# FROM BILLING ELEMENTS           
         MVC   PO#TAB(2),SVCURPO#  ADD CURRENT AS FIRST (AND ONLY) PO#          
         MVI   PO#TAB+2,X'FF'  END OF TABLE                                     
         B     PRBUY30                                                          
*                                                                               
PBUY201  LA    R2,33(RF)                                                        
         MVI   ELCODE,X'A9'        FIND CURRENT PO#                             
PBUY2010 BRAS  RE,NEXTEL                                                        
         BNE   PRBUYXX             SKIP INSERTIONS WITHOUT A PO#                
         USING PBYPOELD,R2                                                      
         TM    PBYPOSTA,BYPOZZZQ   ZZZ?                                         
         BZ    PBUY201A                                                         
         CLC   PBYPOPRD,KPRD       FIND MATCING PRODUCT                         
         BNE   PBUY2010            KEEP LOOKING                                 
*                                                                               
PBUY201A MVC   SVCURPO#,PBYPOSQ#                                                
         CLC   QPO#SEQ,SPACES      ONE PO# REQ?                                 
         BE    PBUY201B            NO                                           
         CLC   PBYPOSQ#,QPO#SEQ     YES - SKIP IF NOT THE ONE I WANT            
         BNE   PRBUYXX                                                          
*                                                                               
PBUY201B XC    PO#TAB,PO#TAB       TABLE OF PO# FROM BILLING ELEMENTS           
         MVC   PO#TAB(2),SVCURPO#  ADD CURRENT AS FIRST PO#                     
         MVI   PO#TAB+2,X'FF'  END OF TABLE                                     
*                                                                               
         LA    R2,33(RF)                                                        
         MVI   ELCODE,X'26'    MAKE TABLE OF ADDIT CHG CODES                    
PRBY201  BRAS  RE,NEXTEL       FROM BILLING ELEMENTS                            
         BNE   PRBUY20A                                                         
         USING PBILELEM,R2                                                      
         CLI   1(R2),X'1B'     CHECK LENGTH - MUST BE AT LEAST 27               
         BL    PRBY201A         ELSE CHECK IF REVERSED/REVERSAL                 
         CLC   PBPRD,KPRD       MUST MATCH MY PRODUCT                           
         BNE   PRBY201          KEEP LOOKING                                    
         OC    PBLDATE,PBLDATE  MUST HAVE A DATE                                
         BZ    PRBY201                                                          
         OC    PBPOSEQ,PBPOSEQ  MUST ALSO HAVE A PO SEQ#                        
         BNZ   PRBY201B         REALLY SHOULD NOT HAPPEN                        
         B     PRBY201                                                          
*                                                                               
PRBY201A OC    PBLDATE,PBLDATE  MUST HAVE A DATE                                
         BZ    PRBY201                                                          
         CLC   PBPRD,KPRD       MUST MATCH MY PRODUCT                           
         BNE   PRBY201          KEEP LOOKING                                    
         TM    PBBILST,X'C0'    SEE IF REVERED/REVERSAL                         
         BNZ   PRBY201          IF SO, JUST SKIP                                
*                                                                               
*         SEND ERROR MESSAGE AND STOP - NON-PO# BILLING                         
*         FOUND WHEN PROCESSING BY PO#                                          
*                                                                               
         MVC   P1(80),QPROG                                                     
         MVC   P2(80),QAREA2                                                    
         GOTO1 REPORT                                                           
******** L     RE,=A(DICSECT)                                                   
******** USING DICSECT,RE                                                       
         MVC   P1(42),=CL42'INSERTION WITH NON-PO# BILLING ENCOUNTERED'         
********       S OR DSTS ON SEPARATE INVS - OR RETAIL'                          
******** MVC   P1(L'PP@MLT01),PP@MLT01                                          
******** MVC   P2(L'PP@MLT02),PP@MLT02                                          
         MVC   P2(21),=C'REQUEST NOT PROCESSED'                                 
******** DROP  RE                                                               
         GOTO1 REPORT                                                           
         BRAS  RE,UNLOCK                                                        
         MVI   MODE,LBUYREQ                                                     
         GOTO1 AENDREQ                                                          
*******  B     PRBUYXX                                                          
         SPACE 3                                                                
*                                                                               
PRBY201B LA    R1,PO#TAB                                                        
PRBY202  CLI   0(R1),X'FF'     EOT ?                                            
         BE    PRBY203        YES, GO PUT IN PO#SEQ                             
         CLC   0(L'PBPOSEQ,R1),PBPOSEQ                                          
         BE    PRBY201         ALREADY IN TABLE                                 
         LA    R1,L'PBPOSEQ(R1)    NEXT PO# SEQ                                 
         B     PRBY202                                                          
PRBY203  MVC   0(L'PBPOSEQ,R1),PBPOSEQ    PUT PO#SEQ                            
         CLI   L'PBPOSEQ(R1),X'FF' IF ALREADY X'FF'                             
         BNE   *+6            MAX PO# REACHED                                   
         DC    H'0'                                                             
         MVI   L'PBPOSEQ(R1),X'FF'                                              
         B     PRBY201                                                          
         DROP  R2                                                               
*                                                                               
*                                                                               
PRBUY20A XC    ADCHGTAB,ADCHGTAB                                                
         MVI   FXFND,C'N'                                                       
         MVI   ADCHGTAB,X'FF'  MARK EOT                                         
         LA    R2,33(RF)                                                        
         MVI   ELCODE,X'44'    MAKE TABLE OF ADDIT CHG CODES                    
PRBUY201 BRAS  RE,NEXTEL                                                        
         BNE   PRBUY204                                                         
         USING PACELEMD,R2                                                      
*                                                                               
         CLC   PACCODE,=C'FX'   FX CHARGE                                       
         BNE   *+12                                                             
         MVI   FXFND,C'Y'                                                       
         B     PRBUY201        DON'T ADD TO TABLE                               
*                                                                               
         LA    R1,ADCHGTAB                                                      
PRBUY202 CLI   0(R1),X'FF'     EOT ?                                            
         BE    PRBUY203        YES, GO PUT IN CHARGE CODE                       
         CLC   0(L'PACCODE,R1),PACCODE                                          
         BE    PRBUY201                                                         
         LA    R1,L'PACCODE(R1)    NEXT CHARGE CODE                             
         B     PRBUY202                                                         
PRBUY203 MVC   0(L'PACCODE,R1),PACCODE    PUT CHARGE CODE                       
         MVI   L'PACCODE(R1),X'FF'                                              
         B     PRBUY201                                                         
         DROP  R2                                                               
*                                                                               
PRBUY204 CLI   FXFND,C'Y'      FX ELEMENT FOUND?                                
         BNE   FXBUY22P                                                         
         LA    R1,ADCHGTAB                                                      
FXBUY20  CLI   0(R1),X'FF'      END OF TABLE?                                   
         BE    FXBUY22                                                          
         LA    R1,L'PACCODE(R1)                                                 
         B     FXBUY20                                                          
*                                                                               
FXBUY22  MVC   0(2,R1),=C'FX'   SO FX WILL BE LAST CHARGE                       
         MVI   2(R1),X'FF'      RESET END OF TABLE                              
*                                                                               
FXBUY22P DS    0H                                                               
         CLI   PO#OPT,C'Y'      BILLING BY PO#?                                 
         BNE   PRBUY205                                                         
         MVI   MIXEDPO#,C'N'                                                    
         OC    SVCURPO#,SVCURPO#    DO I HAVE A CURRENT ONE?                    
         BZ    PRBUY205                                                         
         LA    R2,33(RF)                                                        
         MVI   ELCODE,X'26'                                                     
FXBUY22R BRAS  RE,NEXTEL                                                        
         BNE   PRBUY205                                                         
         USING PBILELEM,R2                                                      
         CLI   1(R2),X'1B'         CHECK ELEM LENGTH                            
         BL    FXBUY22R            MUST BE AT LEAST 27 TO HAVE A PO#            
         OC    PBLDATE,PBLDATE     CHECK FOR DATE                               
         BZ    FXBUY22R                                                         
         CLC   PBPOSEQ,SVCURPO#    SEE IF MATCHES CURRENT PO#                   
         BE    FXBUY22R                                                         
         MVI   MIXEDPO#,C'Y'                                                    
         B     PRBUY205            STOP LOOKING                                 
         DROP  R2                                                               
PRBUY205 OC    EXDATE,EXDATE       SEE IF EXCLUDING BILLING                     
         BZ    PRBUY20X                                                         
*                                                                               
         LA    R2,33(RF)                                                        
         MVI   ELCODE,X'26'                                                     
PRBUY20B BRAS  RE,NEXTEL                                                        
         BNE   PRBUY20C                                                         
         CLC   5(3,R2),EXDATE                                                   
         BNE   PRBUY20B                                                         
         MVI   0(R2),X'F6'    ALTER ELEM CODE SO GETINS WILL IGNORE             
         B     PRBUY20B                                                         
*                                                                               
PRBUY20C LA    R2,33(RF)                                                        
         MVI   ELCODE,X'28'     FINANCIAL BILLING                               
PRBUY20D BRAS  RE,NEXTEL                                                        
         BNE   PRBUY20E                                                         
         CLC   5(3,R2),EXDATE                                                   
         BNE   PRBUY20D                                                         
         MVI   0(R2),X'F8'    ALTER ELEM CODE SO GETINS WILL IGNORE             
         B     PRBUY20D                                                         
*                                                                               
PRBUY20E LA    R2,33(RF)                                                        
         MVI   ELCODE,X'29'     REBATE BILLING                                  
PRBUY20F BRAS  RE,NEXTEL                                                        
         BNE   PRBUY20H                                                         
         CLC   5(3,R2),EXDATE                                                   
         BNE   PRBUY20F                                                         
         MVI   0(R2),X'F9'    ALTER ELEM CODE SO GETINS WILL IGNORE             
         B     PRBUY20F                                                         
*                                                                               
*                                                                               
*                                                                               
*                                                                               
PRBUY20H B     PRBUY20X                                                         
*                                                                               
PRBUY20X L     R2,ADBUY                                                         
         L     RF,ADCLT                                                         
*                                                                               
*        FIRST BE SURE PROPER ESTIMATE IS IN ADEST                              
*        IF NOT, THEN I MUST READ IT HERE                                       
*        THIS COULD HAPPEN WITH ESTIMATE RANGE REQUESTS                         
*                                                                               
         L     R7,ADEST                                                         
         USING PESTREC,R7                                                       
         MVC   BKSAVKEY,KEY         BUYREC'S KEY                                
         XC    KEY,KEY                                                          
         MVC   KEY(07),0(RF)        PART OF CLIENT KEY                          
         MVC   KEY+7(3),KPRD        USE THE PRODUCT I'M PROCESSING              
         MVI   KEY+3,X'07'                                                      
         MVC   KEY+10(2),PBUYKEST-PBUYREC(R2)                                   
         CLC   KEY(12),PESTKEY                                                  
         BE    PRBUY20Y                                                         
         GOTO1 HIGH                                                             
         CLC   KEY(25),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                ESTIMATE MUST BE ONE FILE                    
         GOTO1 GETEST                                                           
PRBUY20Y MVC   KEY(64),BKSAVKEY   RESTORE KEY AND KEYSAVE                       
         GOTO1 HIGH                                                             
         DROP  R7                                                               
*                                                                               
*                                                                               
         OC    MANGRS(12),MANGRS       ARE WE DOING MANUAL ?                    
         BNZ   PRBUY30             YES, DON'T DO GETINS                         
*                         GO POSSIBLY ADD PLANNED COST INDICATORS               
         MVI   BYTE,C'P'                                                        
         BRAS  RE,SETSKIP     GO SET EST IN UPETAB                              
*                                                                               
**THE CODE BELOW UP TO PRBUY30S WILL GET $$ EXCLUDING SPECIAL CHARGES           
* GETINS CALL HAS C'X' IN 4TH PARAMETER (YKVA)                                  
*                                                                               
         XC    KPO#,KPO#          CLEAR FOR NORMAL PROCESSING                   
         XC    KTYP,KTYP                                                        
         CLI   PO#OPT,C'Y'                                                      
         BNE   PRBUY20Z                                                         
         LA    R4,PO#TAB                                                        
PRBUY20P CLI   0(R4),X'FF'                                                      
         BE    PRBUY35         EOT OF PO#S - NOW DO CHARGES                     
         ST    R4,WKPO#        SAVE THE ADDRESS IN THE TABLE                    
         MVC   KPO#,0(R4)      NOTE - KPO# FOLLOWS KTYP                         
*                                                                               
PRBUY20Z CLI   SCBNCSW,C'C'       UFC COMM BILLING                              
         BE    PRBUY23                                                          
         CLI   SCBNCSW,C'N'       UFC NET BILLING                               
         BE    PRBUY23D                                                         
*                                                                               
         BRAS  RE,PLANCHK       GO CHECK PLANNED COST INFO                      
         CLI   DUB,C'X'            SKIP THIS INSERION?                          
         BE    PRBUYXX                                                          
*                                                                               
         CLI   DUB,C'P'           BILL PLANNED COST?                            
         BNE   PRBUY21                                                          
         GOTO1 GETINS,DMCB,(R2),(C'P',GROSS),KPRD,(C'P',0),0,KPO#               
         B     PRBUY30                                                          
*                                                                               
PRBUY21  GOTO1 GETINS,DMCB,(R2),GROSS,KPRD,(C'P',0),0,KPO#                      
         B     PRBUY30                                                          
*                                                                               
PRBUY23  GOTO1 GETINS,DMCB,(R2),(C'C',GROSS),KPRD,(C'P',0),0,KPO#               
         B     PRBUY30                                                          
*                                                                               
PRBUY23D GOTO1 GETINS,DMCB,(R2),(C'N',GROSS),KPRD,(C'P',0),0,KPO#               
         B     PRBUY30                                                          
*&&DO                                                                           
PRBUY25  DS    0H                                                               
         CLI   SCBNCSW,C'C'       UFC COMM BILLING                              
         BNE   PRBUY25D                                                         
         L     R2,ADBUY                                                         
         GOTO1 GETINS,DMCB,(R2),(C'C',GROSS),KPRD,(C'P',0),0,KPO#               
         B     PRBUY30                                                          
*                                                                               
PRBUY25D CLI   SCBNCSW,C'N'       UFC NET BILLING                               
         BNE   PRBUY30                                                          
         L     R2,ADBUY                                                         
         GOTO1 GETINS,DMCB,(R2),(C'N',GROSS),KPRD,(C'P',0),0,KPO#               
*&&                                                                             
PRBUY30  DS    0H                                                               
         OC    KPO#,KPO#      ZERO FOR "NORMAL" BILLING                         
         BZ    PRBUY30C                                                         
         CLC   KPO#,SVCURPO#  SEE IF IT MATCHES CURRENT PO#                     
         BE    *+10                                                             
         XC    GROSS(16),GROSS CLEAR ORDERED $                                  
*                                                                               
******** CLI   MRDASS,C'Y'    SEE IF SPECIAL DRD SCHEME                         
******** BNE   PRBUY30S                                                         
* SINCE ALWAYS CALLING GETINS MYSELF NOW NEED ALWAYS GO TO RDSPLIT              
PRBUY30C OC    SAVMGRU,SAVMGRU     ANYTHING IN THIS FIELD ?                     
         BZ    PRBUY30S            IF YES, ALWAYS GO TO RDSPLIT                 
         GOTO1 =A(RDSPLIT),DMCB,SAVMGRU  GET SHARE FOR THIS REG/DST             
*                                                                               
PRBUY30S DS    0H                                                               
         OC    MANGRS(12),MANGRS    SEE IF DOING A MANUAL BILL                  
         BZ    PRBUY31                                                          
*                               REQ SHOULD REQUIRE A PO#                        
PRBUY31  BAS   RE,BUYBK                                                         
         OC    MANGRS(12),MANGRS  CREATING A MANUAL BILL?                       
         BNZ   PRBUYXX          THEN DONE                                       
*                                                                               
         CLI   PO#OPT,C'Y'                                                      
         BNE   PRBUY35                                                          
         L     R4,WKPO#                                                         
         LA    R4,2(R4)                                                         
         B     PRBUY20P         PROCESS NEXT PO# MAIN $                         
*                                                                               
PRBUY35  DS    0H                                                               
         XC    KPO#,KPO#                                                        
         CLI   PO#OPT,C'Y'      SEE IF BILLING BY PO#                           
         BNE   PRBUY35D                                                         
         LA    R4,PO#TAB                                                        
PRBUY36  CLI   0(R4),X'FF'                                                      
         BE    PRBUYXX         EOT OF PO#S - TOTALLY DONE                       
         ST    R4,WKPO#        SAVE THE ADDRESS IN THE TABLE                    
         MVC   KPO#,0(R4)      NOTE - KPO# FOLLOWS KTYP                         
*                                                                               
*                             WHEN ASKED TO PROCESS PO#S                        
*                             FOR ONE CHARGE - GETINS                           
*                             PARAMETER 4 C'B' GETINS EXPECTS                   
*                             THE PO# TO FOLLOW THE CHARGE TYPE                 
*                                                                               
*                             CLEARING KPO# MAY ALLOW ME TO USE                 
*                             A 'B' IN PARAMETER FOR EVERYONE                   
*                                                                               
PRBUY35D LA    R5,ADCHGTAB                                                      
PRBUY40  CLI   0(R5),X'FF'     EOT ?                                            
         BE    PRBUYX          YES, DONE WITH CHARGES                           
         MVC   KTYP,0(R5)          SAVE CHARGE FOR LATER                        
*                                                                               
** CALL GETINS FOR EACH ADDIT CHARGE                                            
*                                                                               
*                                                                               
         CLI   MIDASSW,C'Y'       CHECK FOR MIDAS TRADE                         
         BNE   PRBUY41                                                          
         CLC   KTYP,=C'TC'        SEE IF DOING TRADE CREDIT                     
         BNE   PRBUY41            SKIP CODE BELOW FOR THIS CHARGE               
         XC    GROSS(48),GROSS    CLEAR GROSS AND BGROSS                        
         XC    BGROSS(16),BGROSS                                                
*                                 I ONLY WANT COST2 FOR THOSE                   
         B     PRBUY50S           GOES TO BUYBK                                 
*                                                                               
PRBUY41  L     R2,ADBUY                                                         
         CLI   SCBNCSW,C'C'       UFC COMM BILLING                              
         BE    PRBUY43                                                          
         CLI   SCBNCSW,C'N'       UFC NET BILLING                               
         BE    PRBUY43D                                                         
         GOTO1 GETINS,DMCB,(R2),GROSS,KPRD,(C'B',0),,KTYP                       
         B     PRBUY50                                                          
PRBUY43  GOTO1 GETINS,DMCB,(R2),(C'C',GROSS),KPRD,(C'B',0),,KTYP                
         B     PRBUY50                                                          
PRBUY43D GOTO1 GETINS,DMCB,(R2),(C'N',GROSS),KPRD,(C'B',0),,KTYP                
*                                                                               
PRBUY50  DS    0H             SEE IF SPECIAL DRD SCHEME                         
*                                                                               
*        MUST CLEAR THE ORDERED $ WHEN BILLING BY PO# AND                       
*        KPO# DOES NOT MATCH THE CURRENT PO#                                    
         CLI   PO#OPT,C'Y'                                                      
         BNE   PRBUY50C                                                         
         CLC   KPO#,SVCURPO#                                                    
         BE    *+10                                                             
         XC    GROSS(12),GROSS                                                  
*                                                                               
******** CLI   MRDASS,C'Y'                                                      
******** BNE   PRBUY50S                                                         
* SINCE ALWAYS CALLING GETINS MYSELF NOW NEED ALWAYS GO TO RDSPLIT              
PRBUY50C OC    SAVMGRU,SAVMGRU     ANYTHING IN THIS FIELD ?                     
         BZ    PRBUY50S            IF YES, ALWAYS GO TO RDSPLIT                 
         GOTO1 =A(RDSPLIT),DMCB,SAVMGRU  GET SHARE FOR THIS REG/DST             
*                                                                               
PRBUY50S BAS   RE,BUYBK                                                         
*                                                                               
PRBUY50X LA    R5,L'PACCODE(R5)    NEXT CHARGE CODE                             
         B     PRBUY40                                                          
*                                                                               
*                                                                               
*        B     PRBUYX                                                           
*                                                                               
         SPACE 3                                                                
NEXTEL   DS    0H                                                               
         ZIC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         JE    NEXTEL2                                                          
         CLC   0(1,R2),ELCODE                                                   
         BER   RE                                                               
         J     NEXTEL                                                           
NEXTEL2  DS    0H                                                               
         LTR   RE,RE                                                            
         BR    RE                                                               
         EJECT                                                                  
*        BUILD BUYREC SORT KEYS AND PASS TO SORT                                
         SPACE 2                                                                
BUYBK    NTR1                                                                   
         SPACE 2                                                                
BUYBK1   DS    0H                                                               
BUYBK2   DS    0H                                                               
         XC    SORTREC,SORTREC                                                  
         L     RF,ASORTDTA                                                      
         OC    0(16,RF),MANGRS      IF MANUAL USE MAN GROSS AND NET CD          
         BNZ   BUYBK5                                                           
*                                  SEE IF DOING REVERSAL                        
         CLI   MANRVDTP,0                                                       
         BE    BUYBK3              NO                                           
         XC    FULL,FULL           USED BY TAXCALC                              
         L     R3,ADBUY                                                         
BUYBK2B  LA    R2,33(R3)                                                        
         MVI   ELCODE,X'26'        FIND BILLING ELEMS                           
***R***                                                                         
BUYBK2B5 CLC   QPROG,=C'R1'        SEE IF FINANCIAL REBATE REVERSAL             
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
         CLC   QPROG,=C'RD'  SEE IF FINANCIAL REBATE REVERSAL - DRAFT           
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
***R***                                                                         
BUYBK2C  BRAS  RE,NEXTEL                                                        
         BE    BUYBK2C2                                                         
         CLC   QPROG,=C'R1'          FINANCIAL REBATE BILLING                   
         BE    BUYBK2F               SKIP THIS BUY                              
         CLC   QPROG,=C'RD'     FINANCIAL REBATE BILLING  - DRAFT               
         BE    BUYBK2F               SKIP THIS BUY                              
*COST2*                                                                         
         CLI   CAROPT,C'Y'         COST2 REVERSAL                               
         BE    BUYBK2C8            MUST STILL CHECK FOR OPEN (COST2)            
*COST2*                                                                         
         TM    FINANSW,X'01'         SEE IF FINANCIAL REVERSAL                  
         BNO   BUYBK2F               NO- SKIP THIS BUY                          
         B     BUYBK2C8  MUST STILL CHECK FOR OPEN                              
*                        BILLING ELEMS EVEN IF I DIDN'T FIND CONTRACT           
         USING PBILELEM,R2                                                      
BUYBK2C2 DS    0H                                                               
         OC    KTYP,KTYP           PROCESSING A ADDIT CHARGE?                   
         BZ    BUYK2C3                                                          
         CLI   1(R2),25            IS IT SPEC CHARGE ELEM? (LEN=25)             
         BL    BUYBK2C             NO, DON'T PROCESS                            
         CLC   PBACCODE,KTYP       YES, ONLY PROCESS FOR THAT ADDIT CHG         
         BNE   BUYBK2C                                                          
         B     BUYK2C4                                                          
*                                                                               
BUYK2C3  CLI   1(R2),25            MUST BE AT LEAST 25 TO HAVE A TYPE           
         BL    BUYK2C4                                                          
         OC    PBACCODE,PBACCODE   MUST NOT HAVE A TYPE                         
         BNZ   BUYBK2C             IF DOES, THEN SKIP                           
*                                                                               
BUYK2C4  OC    KPO#,KPO#           LOOKING FOR A PO#?                           
         BZ    BUYK2CX                                                          
         CLI   1(R2),27            LENGTH MUST BE AT LEAST 27                   
         BL    BUYBK2C                                                          
         CLC   PBPOSEQ,KPO#                                                     
         BNE   BUYBK2C                                                          
*                                                                               
BUYK2CX  OC    PBLDATE,PBLDATE     SEE IF BILLED                                
         BZ    BUYBK2C                                                          
***R***                                                                         
         CLC   PBPRD,KPRD                                                       
         BNE   BUYBK2C                                                          
***R***                                                                         
         CLI   SCBNCSW,C'C'        SEE IF UPFRONT COMM BILLING                  
         BNE   BUYBK2C3                                                         
         TM    PBBILST,X'01'       MUST BE UFC COM BILLING                      
         BZ    BUYBK2C             SKIP                                         
         B     BUYBK2C5                                                         
*                                                                               
BUYBK2C3 DS    0H                                                               
         CLI   SCBNCSW,C'N'        SEE IF UPFRONT COMM BILLING -NET             
         BNE   BUYBK2C5                                                         
         TM    PBBILST,X'02'       MUST BE UFC NET BILLING                      
         BZ    BUYBK2C             SKIP                                         
*                                                                               
BUYBK2C5 DS    0H                                                               
         CLC   PBLDATE,MANRVDTP                                                 
         BNE   BUYBK2C                                                          
         CLC   PBINVNO,MANRVNO     MATCH INVOICE NUMBERS                        
         BNE   BUYBK2C                                                          
**TEST REMOVED 9/7/88                                                           
**NO-OP  TM    PBBILST,X'80'       SEE IF ALREADY REVERSED                      
**NO-OP  BNZ   BUYBK2C             YES  - JUST SKIP                             
*                                                                               
*              LEAVE ORDERED AS ZERO                                            
         MVC   IDSP(4,RF),=F'1'    INSERTS                                      
*                                                                               
         MVC   X+64(12),PBGROSS     SAVE ELEMENT'S $                            
*                                                                               
         OC    SAVMGRU(6),SAVMGRU   REG/DST SPLIT?                              
         BZ    BUYBK2C6                                                         
         ST    RF,FULL2                                                         
         MVC   X(48),GROSS        SAVE REAL GROSS(48) AND BGROSS(16)            
         XC    GROSS(48),GROSS    IN X                                          
         MVC   X+48(16),BGROSS                                                  
         MVC   BGROSS(12),PBGROSS     USE VALUES FROM BILLING ELEMENT           
         XC    BGROSS+12(4),BGROSS+12                                           
         GOTO1 =A(RDSPLIT),DMCB,SAVMGRU  GET SHARE FOR THIS REG/DST             
         MVC   PBGROSS(12),BGROSS     SET TO SHARE FOR THIS REG/DST             
         MVC   GROSS(48),X           RESTORE GROSS                              
         MVC   BGROSS(16),X+48       AND BGROSS                                 
         L     RF,FULL2                                                         
*                                                                               
BUYBK2C6 DS    0H                                                               
         MVC   BGDSP(4,RF),PBGROSS PREV BILLING                                 
         L     R0,BGDSP(RF)                                                     
         DS    0H                                                               
         ICM   RE,15,PBAGYCOM                                                   
         SR    R0,RE                                                            
         ST    R0,BNDSP(RF)         NET                                         
         MVC   BCDSP(4,RF),PBCSHDSC                                             
         MVC   BADSP(4,RF),PBAGYCOM                                             
*                                                                               
         MVC   PBGROSS(12),X+64       RESTORE ELEMENT'S $                       
*                                                                               
         L     RE,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RE),C'C'  SEE IF 'C' RATE BUY                   
         BNE   *+12                                                             
         LA    R4,BADSP(RF)                                                     
         BAS   RE,FIXAC                                                         
***TAX                                                                          
         L     RE,ADBUY                                                         
         OC    PBDTAX-PBUYREC(3,RE),PBDTAX-PBUYREC(RE)                          
         BZ    BUYBK2C7                                                         
         CLI   ELCODE,X'29'                                                     
         BE    BUYBK3D            NO TAX FOR REBATE BILLING                     
         LA    R4,BNDSP(RF)        SET R4 TO NET                                
         BRAS  RE,NTAXCALC                                                      
         MVC   BTDSP(4,RF),FULL                                                 
***TAX                                                                          
*                                                                               
*COST2*                                                                         
BUYBK2C7 CLI   CAROPT,C'Y'       SEE IF COST2 ACTIVE                            
         BE    BUYBK2C9                                                         
         TM    FINANSW,X'01'       SEE IF FINANCIAL CLIENT                      
*                  (STATEMENT ABOVE USED TO BE TAGGED BUYBK2C7)                 
         BNO   BUYBK3D             SKIP CHK FOR ZERO AMTS                       
***R***                                                                         
BUYBK2C9 DS    0H                                                               
*COST2*                                                                         
         CLC   QPROG,=C'R1'        SEE IF FINANCIAL REBATE REVERSAL             
         BE    BUYBK3D                                                          
         CLC   QPROG,=C'RD'  SEE IF FINANCIAL REBATE REVERSAL DRAFT             
         BE    BUYBK3D                                                          
***R***                                                                         
*                                  MUST LOOK FOR OPEN BILLING ELEMS             
BUYBK2C8 L     R3,ADBUY                                                         
BUYBK2D  LA    R2,33(R3)                                                        
         MVI   ELCODE,X'28'        FIND BILLING ELEMS                           
BUYBK2E  BRAS  RE,NEXTEL                                                        
         BNE   BUYBK2E5                                                         
         USING PBILELEM,R2                                                      
         OC    KTYP,KTYP           PROCESSING A ADDIT CHARGE?                   
         BZ    BUYK2E3                                                          
         CLI   1(R2),25            IS IT SPEC CHARGE ELEM? (LEN=25)             
         BL    BUYBK2E             NO, DON'T PROCESS                            
         CLC   PBACCODE,KTYP       YES, ONLY PROCESS FOR THAT ADDIT CHG         
         BNE   BUYBK2E                                                          
         B     BUYK2E4                                                          
*                                                                               
BUYK2E3  CLI   1(R2),25            MUST BE AT LEAST 25 TO HAVE A TYPE           
         BL    BUYK2E4                                                          
         OC    PBACCODE,PBACCODE   MUST NOT HAVE A TYPE                         
         BNZ   BUYBK2E             IF DOES, THEN SKIP                           
*                                                                               
BUYK2E4  OC    KPO#,KPO#           LOOKING FOR A PO#?                           
         BZ    BUYK2EX                                                          
         CLI   1(R2),27            LENGTH MUST BE AT LEAST 27                   
         BL    BUYBK2E                                                          
         CLC   PBPOSEQ,KPO#                                                     
         BNE   BUYBK2E                                                          
*                                                                               
BUYK2EX  OC    PBLDATE,PBLDATE     SEE IF BILLED                                
         BZ    BUYBK2E                                                          
***R***                                                                         
         CLC   PBPRD,KPRD                                                       
         BNE   BUYBK2E                                                          
***R***                                                                         
         CLC   PBLDATE,MANRVDTP                                                 
         BNE   BUYBK2E                                                          
         CLC   PBINVNO,MANRVNO     MATCH INVOICE NUMBERS                        
         BNE   BUYBK2E                                                          
**TEST NO-OPED 9/7/88                                                           
**NO-OP  TM    PBBILST,X'80'       SEE IF ALREADY REVERSED                      
**NO-OP  BNZ   BUYBK2E             YES  - JUST SKIP                             
*                                                                               
*              LEAVE ORDERED AS ZERO                                            
         MVC   OBGDSP(4,RF),PBGROSS PREV BILLING                                
         L     R0,OBGDSP(RF)                                                    
         DS    0H                                                               
         ICM   RE,15,PBAGYCOM                                                   
         SR    R0,RE                                                            
         ST    R0,OBNDSP(RF)        NET                                         
         MVC   OBCDSP(4,RF),PBCSHDSC                                            
         MVC   OBADSP(4,RF),PBAGYCOM                                            
*                                                                               
         CLI   MIDASSW,C'Y'        SEE IF GRP M MIDAS TRADE                     
         BNE   BUYBK2E3                                                         
         CLC   KTYP,=C'TC'         AND DOING TRADE CREDIT                       
         BNE   BUYBK2E3                                                         
         MVC   OBTRDC(4,RF),OBNDSP(RF)   PUT NET IN TRADE CREDIT                
******   XC    OBGDSP(20,RF),OBGDSP(RF)  CLEAR OTHER OPEN FIELDS                
*                                                                               
BUYBK2E3 L     RE,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RE),C'C'  SEE IF 'C' RATE BUY                   
         BNE   *+12                                                             
         LA    R4,OBADSP(RF)                                                    
         BAS   RE,FIXAC                                                         
***TAX                                                                          
         MVC   OBTDSP(4,RF),FULL   SET OPEN BILLED TAX - SAME AS                
***TAX                             CONTRACT                                     
         MVC   IDSP(4,RF),=F'1'    INSERTS                                      
*                                  NEEDED SO $ GET POSTED TO PEPTAB             
*                                                                               
         B     BUYBK3D             SKIP ZERO AMT CHK                            
*                                                                               
BUYBK2E5 DS    0H      I GET HERE IF NO OPEN BILLING FOUND                      
*                      WHEN REVERSING FINANCIAL BILL                            
         OC    IDSP(4,RF),IDSP(RF)    ENSURES THAT I FOUND CONTRACT             
         BNZ   BUYBK3D          SKIP ZERO AMT CHECK                             
*                                                                               
BUYBK2F  B     BUYBK9              SKIP THIS BUY                                
*                                                                               
**NEW 6/20/88                                                                   
BUYBK3   TM    FINANSW,X'01'      SEE IF DOING FINANCIAL CLIENT                 
         BNO   BUYBK3A                                                          
*                                                                               
         TM    FINANSW,X'02'      SEE IF $ TYPE COST2                           
         BO    BUYBK3A            SKIP AD CODE CHECK                            
*                                                                               
         CLC   QAGENCY,=C'SJ'     SPECIAL FOR SJR FINANCIAL CLIENTS             
         BE    BUYBK3A0                                                         
         CLC   QAGENCY,=C'DM'     SPECIAL FOR DOREMUS FINANCIAL CLIENTS         
         BNE   BUYBK3A                                                          
BUYBK3A0 L     RE,ADBUY                                                         
         OC    PBDJOB-PBUYREC(6,RE),PBDJOB-PBUYREC(RE)                          
         BZ    BUYBK9             SKIP BUYS WITH NO AD CODE                     
*                                                                               
BUYBK3A  CLI   QPUB+1,C'J'        AD CODE FILTER                                
         BNE   BUYBK3A2                                                         
         L     RE,ADBUY                                                         
         CLC   PBDJOB-PBUYREC(6,RE),QPUB+2                                      
         BNE   BUYBK9                WRONG AD CODE                              
*                                                                               
BUYBK3A2 MVC   0(4,RF),GROSS                                                    
         L     R0,0(RF)                                                         
         S     R0,AGYCOM                                                        
         ST    R0,NDSP(RF)         NET                                          
         MVC   CDSP(4,RF),CSHDSC                                                
         MVC   ADSP(4,RF),AGYCOM                                                
         L     RE,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RE),C'C'  SEE IF 'C' RATE BUY                   
         BNE   *+12                                                             
         LA    R4,ADSP(RF)                                                      
         BAS   RE,FIXAC                                                         
***TAX   DS    0H                                                               
         MVC   IDSP(4,RF),=F'1'        LEAVE AS INSERTIONS IF NO TAX            
         L     RE,ADBUY                                                         
         OC    PBDTAX-PBUYREC(3,RE),PBDTAX-PBUYREC(RE)                          
         BZ    BUYBK3A4                                                         
         MVC   TDSP(4,RF),TAX          TAX                                      
*                                                                               
BUYBK3A4 DS    0H                                                               
         MVC   BGDSP(4,RF),BGROSS  PREV BILLING                                 
         L     R0,BGDSP(RF)                                                     
         S     R0,BAGYCOM                                                       
         ST    R0,BNDSP(RF)         NET                                         
         MVC   BCDSP(4,RF),BCSHDSC                                              
         MVC   BADSP(4,RF),BAGYCOM                                              
         L     RE,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RE),C'C'  SEE IF 'C' RATE BUY                   
         BNE   *+12                                                             
         LA    R4,BADSP(RF)                                                     
         BAS   RE,FIXAC                                                         
***TAX                                                                          
         XC    FULL,FULL                                                        
*                                  IF NOT BREAKINGOUT TAX                       
*                                  OR PBDTAX IS 0                               
*                                                                               
         L     RE,ADBUY                                                         
         OC    PBDTAX-PBUYREC(3,RE),PBDTAX-PBUYREC(RE)                          
         BZ    BUYBK3A5                                                         
         LA    R4,BNDSP(RF)                                                     
         BRAS  RE,NTAXCALC     MUST CALCULATE TAX OF PREVIOUS BILLING           
*                              R4 INCLUDES TAX                                  
BUYBK3A5 MVC   BTDSP(4,RF),FULL                                                 
         DS    0H                                                               
***TAX                        NOTE - PAYOPT MAY CAUSE TAX PROBLEM               
         CLI   PAYOPT,C'N'                                                      
         BE    BUYBK3B                                                          
*                                                                               
*                                  MUST NOW CHECK FOR PAY ELEM                  
*                                  WITH DATE SINCE "FREE" INSERTION             
*                                  LOGIC WILL CAUSE ANY UNPAID                  
*                                  INSERTION TO GET BILLED                      
*                                                                               
         L     R3,ADBUY                                                         
         CLI   3(R3),X'88'         SEE IF MANUAL BILL                           
         BE    BUYBK3B             PROCESS AS CLEARED                           
*                                                                               
         LA    R2,33(R3)                                                        
         MVI   ELCODE,X'25'        FIND PAYELEM WITH DATE                       
BUYBK3A6 BRAS  RE,NEXTEL                                                        
         BNE   BUYBK3A7              SKIP THIS BUY                              
         USING PPAYELEM,R2                                                      
         OC    KTYP,KTYP           ARE WE DOING ADDIT CHARGE ?                  
         BNZ   *+16                                                             
         CLI   1(R2),24            YES, MAKE SURE LEN=23                        
         BNE   BUYBK3A6                                                         
         B     *+22                NO, DON'T DO ANYTHING SPECIAL                
         CLI   1(R2),26            IS IT SPEC CHARGE ELEM?                      
         BNE   BUYBK3A6            NO, DON'T PROCESS                            
         CLC   PPACCODE,KTYP       YES, ONLY PROCESS FOR THAT ADDIT CHG         
         BNE   BUYBK3A6                                                         
         OC    2(3,R2),2(R2)         CHK FOR PAY DATE                           
         BZ    BUYBK3A6              FALL THROUGH IF DATE FOUND                 
         DROP  R2                                                               
*                                                                               
         CLI   PAYOPT,C'D'      SPECIAL TREATMENT OF                            
         BNE   BYBK3A6B         DELETED BUYS                                    
*                               THEY MUST BE FULLY CREDITED                     
         L     R3,ADBUY                                                         
         TM    27(R3),X'80'       SEE IF DELETED                                
         BZ    BUYBK3A8        NO - THEN CONTINUE                               
*                                                                               
         XC    X(12),X                                                          
         CLC   X(12),PGROSS   SEE IF FULLY PAID                                 
         BE    BUYBK3A8                                                         
         B     BUYBK9          IF NOT THE SKIP                                  
*                                                                               
BYBK3A6B DS    0H                                                               
         CLI   PAYOPT,C'E'    FOR PAYOPTS E-F-G                                 
         BL    BUYBK3A8                                                         
         CLI   PAYOPT,C'G'    FOR PAYOPTS E-F-G                                 
         BH    BUYBK3A8                                                         
         MVC   X(12),GROSS                                                      
         L     R3,ADBUY                                                         
         TM    27(R3),X'80'       SEE IF DELETED                                
         BZ    *+10                                                             
         XC    X(12),X                                                          
         CLC   X(12),PGROSS   SEE IF FULLY PAID                                 
         BE    BUYBK3A8                                                         
*                             NO ADD TO UNPAID EST TABLE                        
         MVI   BYTE,C'U'                                                        
         BRAS  RE,SETSKIP     GO SET EST'S UNPAID INDICATOR                     
         B     BUYBK3A8                                                         
*                                                                               
BUYBK3A7 DS    0H             GET HERE IF NO DATED PAY ELEMENTS                 
         CLI   PAYOPT,C'E'    CHK PAYOPTS E-F-G                                 
******** BL    BUYBK9         SKIP THIS BUY                                     
         BL    BYBK3A7D       GO CHECK FOR BILLING                              
         CLI   PAYOPT,C'G'                                                      
******** BH    BUYBK9         SKIP THIS BUY                                     
         BH    BYBK3A7D       GO CHECK FOR BILLING                              
*                                                                               
         L     R3,ADBUY                                                         
         TM    27(R3),X'80'   SEE IF DELETED                                    
         BZ    BYBK3A7B                                                         
         OC    BGROSS(12),BGROSS   YES, IF NOT BILLED                           
         BZ    BUYBK9              THEN SKIP THIS BUY                           
         B     BUYBK3A8            ELSE PROCESS AND DON'T SET IN                
*                                  UNPAID TABLE                                 
BYBK3A7B DS    0H                                                               
         MVI   BYTE,C'U'                                                        
         BRAS  RE,SETSKIP     GO SET EST'S UNPAID INDICATOR                     
         B     BUYBK3A8                                                         
*                                                                               
BYBK3A7D DS    0H         NO PAY ELEMS - WITH PAYOPT "Y"                        
         OC    BGROSS(12),BGROSS     SEE IF BILLED OR FREE                      
         BZ    BUYBK9        SKIP IF FREE OR NOT BILLED                         
*                            MUST SILL PROCESS TO GET CREDIT                    
*                                                                               
BUYBK3A8 DS    0H                                                               
         MVC   0(4,RF),PGROSS                                                   
         L     R0,0(RF)                                                         
         S     R0,PAGYCOM                                                       
         ST    R0,NDSP(RF)         NET                                          
         MVC   CDSP(4,RF),PCSHDSC                                               
         MVC   ADSP(4,RF),PAGYCOM                                               
         L     RE,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RE),C'C'  SEE IF 'C' RATE BUY                   
         BNE   *+12                                                             
         LA    R4,ADSP(RF)                                                      
         BAS   RE,FIXAC                                                         
***TAX                                                                          
         L     RE,ADBUY                                                         
         OC    PBDTAX-PBUYREC(3,RE),PBDTAX-PBUYREC(RE)                          
         BZ    BUYBK3A9                                                         
         LA    R4,NDSP(RF)                                                      
         BRAS  RE,NTAXCALC    MUST CALCULATE TAX ON NET PAID                    
         MVC   TDSP(4,RF),FULL     SAVE AS ORDERED TAX                          
***TAX                                                                          
***PO#                                                                          
BUYBK3A9 CLI   PO#OPT,C'Y'      BILLING BY PO#                                  
         BNE   BUYBK3B                                                          
         CLC   KPO#,SVCURPO#  SEE IF IT MATCHES CURRENT PO#                     
         BE    *+10                                                             
         XC    0(20,RF),0(RF)      YES- CLEAR ALL ORDERED $                     
***PO#                                                                          
BUYBK3B  DS    0H                                                               
         L     R3,ADBUY                                                         
         TM    27(R3),X'80'        TEST DELETED                                 
         BZ    BUYBK3B2                                                         
***TAX    WAS 0(12,RF)                                                          
*** 8/28/90   FIXED TO CLEAR TAX IF DELETED  (WAS 16)                           
         XC    0(20,RF),0(RF)      YES- CLEAR ALL ORDERED $                     
*                                                                               
BUYBK3B2 DS    0H                                                               
         MVI   ELCODE,X'91'        FACTOR ELEMENT                               
         CLI   CAROPT,C'Y'         SEE IF DOING COST 2 CLT                      
         BE    BYBK3B2B                                                         
*                                                                               
         MVI   ELCODE,X'30'        MUST FIND OPEN RATE ELEM                     
         TM    FINANSW,X'01'       SEE IF FINANCIAL CLIENT                      
         BNO   BUYBK3C                                                          
*                                                                               
         LA    R2,PERLIST                                                       
         L     R1,ADBUY                                                         
         CLC   PBDBDATE-PBUYREC(3,R1),2(R2)   SEE IF BEFORE FIRST               
         BL    BUYBK9                         MTH START - YES SKIP              
*                                 DON'T DIE WITH MISSING OPEN                   
*                                 RATE ELEMENT IF BEFORE                        
*                                 MOS START DATE                                
*                                 THESE BUYS WOULD EVENTUALLY                   
*                                 HAVE BEEN SKIPPED ANYWAY                      
*                                                                               
BYBK3B2B L     R2,ADBUY                                                         
         LA    R2,33(R2)                                                        
         BRAS  RE,NEXTEL                                                        
         BE    *+6                                                              
         DC    H'0'                SOMETING VERY WRONG                          
*                                                                               
         ST    RF,FULL2                                                         
BUYBK3B3 L     R2,ADBUY                                                         
*                                 GOTO GETINS TO GET OPEN VALUES                
*                                 (OR COST 2 VALUES)                            
*                                                                               
         CLI   KTYP,0              DOING ADDITIONAL CHARGE?                     
         BNE   BYBK3B3B                                                         
*                                                                               
         BRAS  RE,PLANCHK       GO CHECK PLANNED COST INFO                      
         CLI   DUB,C'X'            SKIP THIS INSERION?                          
         BE    PRBUYXX          (REDUNDANT CHECK)                               
*                                                                               
         CLI   DUB,C'P'           BILL PLANNED COST?                            
         BNE   BYBK3B3A           USE SPECIAL GETINS PARAMETER                  
         GOTO1 GETINS,DMCB,(R2),(C'B',GROSS),KPRD,(C'X',0)                      
         B     BYBK3B3D                                                         
*                                                                               
BYBK3B3A GOTO1 GETINS,DMCB,(R2),(C'O',GROSS),KPRD,(C'X',0)                      
         B     BYBK3B3D                                                         
*                                                                               
BYBK3B3B DS    0H                                                               
         GOTO1 GETINS,DMCB,(R2),(C'O',GROSS),KPRD,(C'A',0),,KTYP                
         TM    FINANSW,X'01'   SEE IF FINANCIAL OR $ TYPE COST2                 
         BZ    BYBK3B3D        IF SO,THIS CALL RETURNS PROPER                   
*                              BGROSS ETC. BUT GROSS ETC. INCLUDES              
*                              ALL OPEN $                                       
         MVC   SBGROSS(16),BGROSS  SAVE PREV. BILLED FOR THIS CHARGE            
*                  MUST CALL GETINS AGAIN FOR ORDERED FOR THIS CHARGE           
BYBK3B3E GOTO1 GETINS,DMCB,(R2),GROSS,KPRD,(C'A',0),,KTYP                       
         MVC   BGROSS(16),SBGROSS   RESTORE PREV. BILLED FOR CHG                
*                                                                               
*        TAX SHOULD NOW BE IN TAX                                               
*        IT IS ALSO INCLUDED IN GROSS,PYABLE, AND BLABLE                        
***********                                                                     
****     MUST USE REG/DST SPLIT ROUTINE                                         
****     FOR REG/DST REQUESTS                                                   
***********                                                                     
BYBK3B3D L     RF,FULL2                                                         
         MVC   OGDSP(4,RF),GROSS                                                
         L     R0,OGDSP(RF)                                                     
         S     R0,AGYCOM                                                        
         ST    R0,ONDSP(RF)                                                     
*                                                                               
*****    OC    GROSS,GROSS              IS THERE ANY OPEN GROSS?                
*****    BNZ   BYBK3B3F                                                         
*****    LTR   R0,R0                                                            
*****    BNZ   BYBK3B3F                 OR OPEN NET?                            
*****    B     *+10                     IF NOT, DON'T SET OPEN CD               
*                                                                               
BYBK3B3F MVC   OCDSP(4,RF),CDSP(RF)     USE CONTRACT CD                         
         MVC   OADSP(4,RF),AGYCOM                                               
         L     RE,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RE),C'C'  SEE IF 'C' RATE BUY                   
         BNE   *+12                                                             
         LA    R4,OADSP(RF)                                                     
         BAS   RE,FIXAC                                                         
***TAX                                                                          
         MVC   OTDSP(4,RF),TAX        NOTE TAX BASED ON CONTRACT NET            
***TAX                                                                          
         MVC   OBGDSP(4,RF),BGROSS                                              
         L     R0,OBGDSP(RF)                                                    
         S     R0,BAGYCOM                                                       
         ST    R0,OBNDSP(RF)                                                    
*                                                                               
*****    OC    BGROSS,BGROSS     IS THERE ANY OPEN PREV BILLED GROSS            
*****    BNZ   BYBK3B3G                                                         
*****    LTR   R0,R0                                                            
*****    BNZ   BYBK3B3G        OR OPEN PREV. BILLED NET?                        
*****    B     *+10            IF NOT, DON'T SET PREV. BILLED CD                
*                                                                               
BYBK3B3G MVC   OBCDSP(4,RF),BCSHDSC                                             
         MVC   OBADSP(4,RF),BAGYCOM                                             
         L     RE,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RE),C'C'  SEE IF 'C' RATE BUY                   
         BNE   *+12                                                             
         LA    R4,OBADSP(RF)                                                    
         BAS   RE,FIXAC                                                         
***TAX                                                                          
         MVC   OBTDSP(4,RF),FULL     MUST USE CONTRACT TAX                      
*                          STILL IN FULL - CALCULATED                           
*                          AT BUYBK3A4 OR BUYBK3B IF PAYOPT=C'Y'                
*                          OR PAYOPT = 'S' (SUPPRESS MESSAGE)                   
***TAX                     NOTE - PAYOPT MAY CAUSE TAX PROBLEM                  
*                                                                               
         CLI   PAYOPT,C'N'                                                      
         BE    BUYBK3B4                                                         
         MVC   OGDSP(4,RF),PGROSS                                               
         L     R0,OGDSP(RF)                                                     
         S     R0,PAGYCOM                                                       
         ST    R0,ONDSP(RF)                                                     
         MVC   OCDSP(4,RF),PCSHDSC                                              
         MVC   OADSP(4,RF),PAGYCOM                                              
         L     RE,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RE),C'C'  SEE IF 'C' RATE BUY                   
         BNE   *+12                                                             
         LA    R4,OADSP(RF)                                                     
         BAS   RE,FIXAC                                                         
         B     BUYBK3B4                                                         
*                                                                               
BUYBK3B4 DS    0H                                                               
         L     R3,ADBUY                                                         
         TM    27(R3),X'80'        SEE IF DELETED                               
         BZ    *+10                                                             
         XC    OGDSP(24,RF),OGDSP(RF) CLEAR OPEN ORDERED ALSO                   
*                                                                               
***R***                                                                         
BUYBK3B5 CLC   QPROG,=C'R1'        SEE IF DOING OPEN/CONTRACT REBATE            
         BE    BUYBK3B6                                                         
         CLC   QPROG,=C'RD'  SEE IF DOING OPEN/CONTRACT REBATE DRAFT            
         BNE   BUYBK3B9                                                         
BUYBK3B6 L     R0,BGDSP(RF)      OPEN BILLING - GROSS                           
         S     R0,OBGDSP(RF)     CONTRACT BILLING                               
         ST    R0,0(RF)          SET AS 'ORDERED'                               
         L     R0,BNDSP(RF)      OPEN BILLING - AGYCOM                          
         S     R0,OBNDSP(RF)     CONTRACT BILLING                               
         ST    R0,NDSP(RF)       SET AS 'ORDERED'                               
         L     R0,BCDSP(RF)      OPEN BILLING  -CD                              
         S     R0,OBCDSP(RF)     CONTRACT BILLING                               
         ST    R0,CDSP(RF)      SET AS 'ORDERED'                                
         L     R0,BADSP(RF)      OPEN BILLING  -AC                              
         S     R0,OBADSP(RF)     CONTRACT BILLING                               
         ST    R0,ADSP(RF)      SET AS 'ORDERED' AC                             
***TAX                                                                          
         XC    TDSP(4,RF),TDSP(RF)      CLEAR TAX FOR REBATE BILLING            
***TAX                                                                          
         XC    IDSP(ROW2L-IDSP,RF),IDSP(RF) CLEAR ALL OTHER ACCUMS              
         L     R2,ADBUY                                                         
         LA    R2,33(R2)                                                        
         MVI   ELCODE,X'29'        FIND PREVIOUS REBATE BILLING                 
BUYBK3B7 BRAS  RE,NEXTEL                                                        
         BNE   BUYBK3B9                                                         
         USING PBILELEM,R2                                                      
         OC    KTYP,KTYP           ARE WE DOING ADDIT CHARGE ?                  
         BNZ   *+16                                                             
         CLI   1(R2),23            YES, MAKE SURE LEN=23                        
         BNE   BUYBK3B7                                                         
         B     *+22                NO, DON'T DO ANYTHING SPECIAL                
         CLI   1(R2),25            IS IT SPEC CHARGE ELEM?                      
         BNE   BUYBK3B7            NO, DON'T PROCESS                            
         CLC   PBACCODE,KTYP       YES, ONLY PROCESS FOR THAT ADDIT CHG         
         BNE   BUYBK3B7                                                         
         OC    5(3,R2),5(R2)       CHK FOR DATE                                 
         BZ    BUYBK3B7                                                         
         CLC   PBPRD,KPRD         MUST BE RIGHT PRD                             
         BNE   BUYBK3B7                                                         
         L     R0,BGDSP(RF)                                                     
         DS    0H                                                               
         ICM   R1,15,PBGROSS                                                    
         AR    R0,R1                                                            
         ST    R0,BGDSP(RF)                                                     
         ICM   R1,15,PBGROSS       NET=GROSS-AC                                 
         ICM   R0,15,PBAGYCOM                                                   
         SR    R1,R0                                                            
         L     R0,BNDSP(RF)                                                     
         AR    R0,R1                                                            
         ST    R0,BNDSP(RF)                                                     
         L     R0,BCDSP(RF)                                                     
         ICM   RE,15,PBCSHDSC                                                   
         AR    R0,RE                                                            
         ST    R0,BCDSP(RF)                                                     
         L     RE,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RE),C'C'  SEE IF 'C' RATE BUY                   
         BNE   BUYBK3B8                                                         
         MVC   FULL,PBAGYCOM                                                    
         LA    R4,FULL                                                          
         BAS   RE,FIXAC                                                         
         L     R0,BADSP(RF)                                                     
         A     R0,FULL                                                          
         ST    R0,BADSP(RF)                                                     
         B     BUYBK3B7                                                         
*                                                                               
BUYBK3B8 L     R0,BADSP(RF)                                                     
         ICM   RE,15,PBAGYCOM                                                   
         AR    R0,RE                                                            
         ST    R0,BADSP(RF)                                                     
         B     BUYBK3B7                                                         
***TAX    NOTE - NO TAX FOR REBATE BILLING                                      
*                                                                               
         DROP  R2                                                               
***R***                                                                         
BUYBK3B9 DS    0H                                                               
         CLI   MIDASSW,C'Y'      GRP M MIDAS TRADE                              
         BNE   BUYBK3C                                                          
         CLC   KTYP,=C'TC'       AND DOING A TRADE CREDIT                       
         BNE   BUYBK3C                                                          
         L     R0,ONDSP(RF)      ALWAYS SAME AS NET?                            
         ST    R0,OTRDC(RF)                                                     
         L     R0,OBNDSP(RF)                                                    
         ST    R0,OBTRDC(RF)                                                    
*                                WAS OPEN INS COUNTER                           
*                                NEVER USED                                     
***E***                                                                         
BUYBK3C  CLC   QPROG,=C'E1'        SEE IF ESTIMATE REPORT                       
         BNE   BYBK3C2                                                          
         XC    BGDSP(20,RF),BGDSP(RF)     CLEAR BILLED                          
         XC    OBGDSP(20,RF),OBGDSP(RF)   CLEAR OPEN BILLED                     
         B     BUYBK3D             PASS ALL BUYS                                
*                                                                               
BYBK3C2  DS    0H                                                               
***E***                                                                         
***TAX      WAS (12,RF) ETC.                                                    
         OC    0(16,RF),0(RF)      NO DATA  - ORDERED                           
         BNZ   BUYBK3D                                                          
         OC    BGDSP(20,RF),BGDSP(RF) NO DATA - BILLED                          
         BNZ   BUYBK3D                                                          
         OC    OGDSP(20,RF),OGDSP(RF) NO DATA - ORDERED OPEN                    
         BNZ   BUYBK3D                                                          
         OC    OTRDC(4,RF),OTRDC(RF)    ORDERED TRADE CREDIT                    
         BNZ   BUYBK3D                                                          
         OC    OBGDSP(20,RF),OBGDSP(RF) NO DATA - BILLED OPEN                   
         BNZ   BUYBK3D                                                          
         OC    OBTRDC(4,RF),OBTRDC(RF)  PREV BILLED TRD CREDIT                  
         BNZ   BUYBK3D                                                          
*                                                                               
         CLI   FREEOPT,C'C'      ZERO COST2 FEATURE                             
         BE    BYBK3C3                                                          
*                                                                               
         CLI   FREEOPT,C'Y'      SEE IF BILING FREE INSERTIONS                  
         BNE   BUYBK3C3                                                         
BYBK3C3  L     RF,ADBUY                                                         
         CLC   PBUYKDAT-PBUYREC(3,RF),=X'5C0901'  NOT BEFORE 9/1/92             
         BL    BUYBK3C3                                                         
*                                                                               
         DS    0H                I MUST NOW PROCESS "FREE" BUYS                 
*                                UNLESS THEY HAVE A BILLING ELEMENT             
*                                WITH A BILL DATE                               
         L     RF,ADBUY                                                         
         LA    R2,33(RF)                                                        
         MVI   ELCODE,X'26'                                                     
*                                                                               
BUYBK3C0 CLC   QPROG,=C'R1'        SEE IF DOING REBATE BILLING                  
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
         CLC   QPROG,=C'RD'   SEE IF DOING REBATE BILLING DRAFT                 
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
*                                                                               
BUYBK3C1 BRAS  RE,NEXTEL                                                        
         BNE   BUYBK3C2        IF NO PREV BILLING - GO SEE IF DELETED           
         USING PBILELEM,R2                                                      
         OC    KTYP,KTYP           PROCESSING A ADDIT CHARGE?                   
         BZ    BUYK3C3A                                                         
         CLI   1(R2),25            IS IT SPEC CHARGE ELEM? (LEN=25)             
         BL    BUYBK3C1            NO, DON'T PROCESS                            
         CLC   PBACCODE,KTYP       YES, ONLY PROCESS FOR THAT ADDIT CHG         
         BNE   BUYBK3C1                                                         
         B     BUYK3C4A                                                         
*                                                                               
BUYK3C3A CLI   1(R2),25            MUST BE AT LEAST 25 TO HAVE A TYPE           
         BL    BUYK3C4A                                                         
         OC    PBACCODE,PBACCODE   MUST NOT HAVE A TYPE                         
         BNZ   BUYBK3C1            IF DOES, THEN SKIP                           
*                                                                               
BUYK3C4A OC    KPO#,KPO#           LOOKING FOR A PO#?                           
         BZ    BUYK3CXA                                                         
         CLI   1(R2),27            LENGTH MUST BE AT LEAST 27                   
         BL    BUYBK3C1                                                         
         CLC   PBPOSEQ,KPO#                                                     
         BNE   BUYBK3C1                                                         
*                                                                               
BUYK3CXA OC    PBLDATE,PBLDATE     SEE IF BILLED                                
         BZ    BUYBK3C1              NO - SKIP                                  
         CLC   PBPRD,KPRD            MUST BE RIGHT PRODUCT                      
         BNE   BUYBK3C1                                                         
*                                                                               
*****    CLI   SHOWREV,C'Y'          INCLUDING?                                 
*****    BE    *+12                                                             
*                                                                               
         TM    PBBILST,X'C0'         SKIP REVERSED - REVERSALS                  
         BNZ   BUYBK3C1                                                         
         CLI   SCBNCSW,C'C'        SEE IF UFC COMM BILLING                      
         BNE   *+16                                                             
         TM    PBBILST,X'01'                                                    
         BZ    BUYBK3C1              NOT RIGHT TYPE - SKIP                      
         B     BUYBK3C3                                                         
*                                                                               
         CLI   SCBNCSW,C'N'          UFC NET BILLING                            
         BNE   BUYBK3C3                                                         
         TM    PBBILST,X'02'         SEE IF UFC NET BILLING                     
         BZ    BUYBK3C1              NOT RIGHT TYPE - SKIP                      
         DROP  R2                    PROCESS                                    
         B     BUYBK3C3                                                         
*                                                                               
BUYBK3C2 DS    0H                                                               
*                                 "FREE" BUY THAT WAS NEVER BILLED              
*                                 SEE IF DELETED                                
         L     RF,ADBUY                                                         
         TM    27(RF),X'80'                                                     
         BNZ   BUYBK9             YES - THEN I CAN SKIP                         
         B     BUYBK3D            PROCESS                                       
*                                                                               
*                                                                               
BUYBK3C3 DS    0H                                                               
         CLI   ZUOPT,C'O'         SEE IF OMITTING PREV. BILLED INS              
         BE    BUYBK9             YES THEN I CAN SKIP THIS BUY                  
         CLI   LSTOPT,C'Y'        SEE IF LISTING PREV BILLS                     
         BE    BUYBK3C4                                                         
         CLI   LSTOPT,C'A'                                                      
         BE    BUYBK3C4                                                         
         CLI   LSTOPT,C'R'                                                      
         BE    BUYBK3C4                                                         
         CLI   LSTOPT,C'B'                                                      
         BE    BUYBK3C4                                                         
         CLI   LSTOPT,C'I'                                                      
         BE    BUYBK3C4                                                         
         B     BUYBK9            NO  - I CAN SKIP THIS BUY                      
*                                                                               
BUYBK3C4 DS    0H                PROCESS BUY TO GET CORRECT                     
*                                PREVIOUS BILLED AMTS                           
         L     RF,ADBUY                                                         
         LA    R2,33(RF)                                                        
         MVI   ELCODE,X'26'                                                     
*                                                                               
BUYBK3C5 CLC   QPROG,=C'R1'        SEE IF DOING REBATE BILLING                  
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
         CLC   QPROG,=C'RD'   SEE IF DOING REBATE BILLING DRAFT                 
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
*                                                                               
BUYBK3C6 BRAS  RE,NEXTEL                                                        
         BNE   BUYBK9               IF NO PREV BILLING - CAN SKIP               
         USING PBILELEM,R2                                                      
         OC    KTYP,KTYP           PROCESSING A ADDIT CHARGE?                   
         BZ    BUYK3C3                                                          
         CLI   1(R2),25            IS IT SPEC CHARGE ELEM? (LEN=25)             
         BL    BUYBK3C6            NO, DON'T PROCESS                            
         CLC   PBACCODE,KTYP       YES, ONLY PROCESS FOR THAT ADDIT CHG         
         BNE   BUYBK3C6                                                         
         B     BUYK3C4                                                          
*                                                                               
BUYK3C3  CLI   1(R2),25            MUST BE AT LEAST 25 TO HAVE A TYPE           
         BL    BUYK3C4                                                          
         OC    PBACCODE,PBACCODE   MUST NOT HAVE A TYPE                         
         BNZ   BUYBK3C6            IF DOES, THEN SKIP                           
*                                                                               
BUYK3C4  OC    KPO#,KPO#           LOOKING FOR A PO#?                           
         BZ    BUYK3CX                                                          
         CLI   1(R2),27            LENGTH MUST BE AT LEAST 27                   
         BL    BUYBK3C6                                                         
         CLC   PBPOSEQ,KPO#                                                     
         BNE   BUYBK3C6                                                         
*                                                                               
BUYK3CX  OC    PBLDATE,PBLDATE     SEE IF BILLED                                
         BZ    BUYBK3C6              NO - SKIP                                  
         CLC   PBPRD,KPRD            MUST BE RIGHT PRODUCT                      
         BNE   BUYBK3C6                                                         
*                                                                               
         CLI   SHOWREV,C'Y'          INCLUDING?                                 
         BE    *+12                                                             
*                                                                               
         TM    PBBILST,X'C0'         SKIP REVERSED - REVERSALS                  
         BNZ   BUYBK3C6                                                         
         CLI   SCBNCSW,C'C'          UFC COMM BILLING                           
         BNE   BUYBK3C7                                                         
         TM    PBBILST,X'01'         CHECK RIGHT TYPE                           
         BZ    BUYBK3C6                                                         
         B     BUYBK3D                                                          
*                                                                               
BUYBK3C7 DS    0H                                                               
         CLI   SCBNCSW,C'N'          UFC NET BILLING                            
         BNE   BUYBK3D                                                          
         TM    PBBILST,X'02'         CHECK RIGHT TYPE                           
         BZ    BUYBK3C6                                                         
         DROP  R2                    PROCESS                                    
*                                                                               
BUYBK3D  DS    0H                                                               
*                                                                               
         OC    MANPCT,MANPCT         SEE IF PCT BILL                            
         BZ    BUYBK3D5                                                         
         CLI   PCTCTL,C'N'           AND NO PREVIOUS BILLING                    
         BNE   BUYBK3D5                                                         
         L     RF,ASORTDTA                                                      
         XC    BGDSP(20,RF),BGDSP(RF)         CLEAR BILLED $                    
         XC    OBGDSP(20,RF),OBGDSP(RF)       CLEAR OPEN BILLED $               
*                                                                               
BUYBK3D5 LA    R2,PERLIST                                                       
         L     RF,ADBUY                                                         
         CLC   PBDBDATE-PBUYREC(3,RF),2(R2)   SEE IF BEFORE FIRST               
         BL    BUYBK9                         MTH START - YES SKIP              
*                                                                               
BUYBK3E  CLC   PBDBDATE-PBUYREC(3,RF),5(R2)                                     
         BNH   BUYBK3G                                                          
         LA    R2,8(R2)                                                         
         CLI   0(R2),X'FF'          SEE IF AT END OF PERLIST                    
         BE    BUYBK9              PAST END OF LIST SO SKIP                     
         B     BUYBK3E                                                          
*                                                                               
BUYBK3G  DS    0H                                                               
         MVC   THISPER,0(R2)       SAVE THIS YM                                 
*                                                                               
         CLI   PERCTL,C'T'                                                      
         BNE   BUYBK5                                                           
*                                  IF MULTI-MONTH                               
         LA    RF,ESTFORM                                                       
         CLI   ESTFORM+BILNBSW-BILPROF,C'Y'    SEE IF NOT FOR BILLING           
         BE    BUYBK3H                                                          
         OC    ESTFORM(7),ESTFORM     SEE IF I HAVE A FORMULA/DATE              
         BNZ   BUYBK3M             YES THEN USE IT                              
*                                                                               
BUYBK3H  LA    RF,PRDFORM          TRY FOR PRODUCT                              
         CLI   PRDFORM+BILNBSW-BILPROF,C'Y'    SEE IF NOT FOR BILLING           
         BE    BUYBK3K                                                          
         OC    PRDFORM,PRDFORM     SEE IF I HAVE A FORMULA/DATE                 
         BNZ   BUYBK3M             YES THEN USE IT                              
*                                                                               
BUYBK3K  LA    RF,AAEFORM          TRY FOR AAA ESTIMATE                         
         CLI   AAEFORM+BILNBSW-BILPROF,C'Y'    SEE IF NOT FOR BILLING           
         BE    BUYBK3L                                                          
         OC    AAEFORM(7),AAEFORM     SEE IF I HAVE A PRD FORMULA/DATE          
         BNZ   BUYBK3M              YES THEN USE IT                             
BUYBK3L  LA    RF,AAAFORM           TRY FOR PRD AAA FORMULA                     
         CLI   AAAFORM+BILNBSW-BILPROF,C'Y'    SEE IF NOT FOR BILLING           
         BE    BUYBK4                                                           
*                                                                               
BUYBK3M  CLC   CURPER,5(RF)        CURRENT MO NOT LOWER THAN                    
         BL    BUYBK4              FORMULA EFF DATE                             
         CLC   THISPER,5(RF)                                                    
         BL    BUYBK9              BYPASS ALL MONTHS BEFORE EFF DATE            
BUYBK4   DS    0H                                                               
**GST                                                                           
         CLI   CVATCOD,0           CHECK FOR CANADINA GST                       
         BE    BUYBK5                                                           
         CLC   CURPER,CVATSTRT     AND CURRENT MTH NOT LOWER THAN               
         BL    BUYBK5              GST START DATE                               
         CLC   THISPER,CVATSTRT    BYPASS EARLIER MONTHS                        
         BL    BUYBK9                                                           
**GST                                                                           
*                                                                               
BUYBK5   DS    0H                                                               
         MVI   ZLSW,C'N'                                                        
***E***                                                                         
         CLC   QPROG,=C'E1'        FOR ESTIMATES DON'T SET ZLSW                 
         BE    BUYBK5B                                                          
***E***                                                                         
         CLI   MANRVDTP,0          SEE IF DOING REVERSAL                        
         BNE   BUYBK5B             YES - DON'T SET ZLSW                         
*                                  UNLESS OLD MANUAL BILL                       
         CLI   ZUOPT,C'S'          SEE IF PRINTING PREV BILLED UNITS            
         BE    BUYBK5B                                                          
*                                  MUST BE LUMPING PREV BILLED UNITS            
         L     RF,ASORTDTA                                                      
         CLC   0(16,RF),BGDSP(RF)  CHK G,N,CD,AC                                
         BNE   BUYBK5B                                                          
         CLC   OGDSP(16,RF),OBGDSP(RF) ALSO CHK OPEN BILLING                    
         BNE   BUYBK5B                                                          
         CLC   OTRDC(4,RF),OBTRDC(RF) ALSO CHK TRADE CREDITS                    
         BNE   BUYBK5B                                                          
***TAX     NOTE - CHECKS ABOVE TO NOT COMPARE TAX ORDERED VS. BILLED            
***TAX     BECAUSE ROUNDING ERRORS ARE POSSIBLE                                 
***TAX     SHOULD BE OK SINCE THE BUY PROGRAM WILL NOT ALLOW TAX PCT.           
***TAX     TO CHANGE AFTER BILLING                                              
*                                                                               
         CLI   FREEOPT,C'C'      ZERO COST2 FEATURE                             
         BE    BUYBK5A                                                          
*                                                                               
         CLI   FREEOPT,C'Y'      SEE IF BILLING FREE INSERTIONS                 
         BNE   BUYBK5A8                                                         
BUYBK5A  L     RE,ADBUY                                                         
         CLC   PBUYKDAT-PBUYREC(3,RE),=X'5C0901'   NOT BEFORE 9/1/92            
         BL    BUYBK5A8                                                         
*                                                                               
         OC    0(16,RF),0(RF)                                                   
         BNZ   BUYBK5A8                                                         
         OC    OGDSP(16,RF),OGDSP(RF)                                           
         BNZ   BUYBK5A8                                                         
*                                                                               
         OC    OTRDC(4,RF),OTRDC(RF)    TRADE CREDITS                           
         BNZ   BUYBK5A8                                                         
*                                FREE BUY-SEE IF IT HAS BEEN BILLED             
         L     RF,ADBUY                                                         
         LA    R2,33(RF)                                                        
         MVI   ELCODE,X'26'                                                     
*                                                                               
BUYBK5A1 CLC   QPROG,=C'R1'        SEE IF DOING REBATE BILLING                  
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
         CLC   QPROG,=C'RD'   SEE IF DOING REBATE BILLING DRAFT                 
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
*                                                                               
BUYBK5A2 BRAS  RE,NEXTEL                                                        
         BNE   BUYBK5B              IF NO PREV BILLING - PROCESS                
         USING PBILELEM,R2                                                      
         OC    KTYP,KTYP           PROCESSING A ADDIT CHARGE?                   
         BZ    BUYK5A3                                                          
         CLI   1(R2),25            IS IT SPEC CHARGE ELEM? (LEN=25)             
         BL    BUYBK5A2            NO, DON'T PROCESS                            
         CLC   PBACCODE,KTYP       YES, ONLY PROCESS FOR THAT ADDIT CHG         
         BNE   BUYBK5A2                                                         
         B     BUYK5A4                                                          
*                                                                               
BUYK5A3  CLI   1(R2),25            MUST BE AT LEAST 25 TO HAVE A TYPE           
         BL    BUYK5A4                                                          
         OC    PBACCODE,PBACCODE   MUST NOT HAVE A TYPE                         
         BNZ   BUYBK5A2            IF DOES, THEN SKIP                           
*                                                                               
BUYK5A4  OC    KPO#,KPO#           LOOKING FOR A PO#?                           
         BZ    BUYK5AX                                                          
         CLI   1(R2),27            LENGTH MUST BE AT LEAST 27                   
         BL    BUYBK5A2                                                         
         CLC   PBPOSEQ,KPO#                                                     
         BNE   BUYBK5A2                                                         
*                                                                               
BUYK5AX  OC    PBLDATE,PBLDATE     SEE IF BILLED                                
         BZ    BUYBK5A2              NO - SKIP                                  
         CLC   PBPRD,KPRD            MUST BE RIGHT PRODUCT                      
         BNE   BUYBK5A2                                                         
*                                                                               
*****    CLI   SHOWREV,C'Y'          INCLUDING?                                 
*****    BE    *+12                                                             
*                                                                               
         TM    PBBILST,X'C0'         SKIP REVERSED - REVERSALS                  
         BNZ   BUYBK5A2                                                         
         CLI   SCBNCSW,C'C'          UFC COMM BILLING                           
         BNE   BUYBK5A4                                                         
         TM    PBBILST,X'01'                                                    
         BZ    BUYBK5A2                                                         
         B     BUYBK5A8                                                         
*                                                                               
BUYBK5A4 CLI   SCBNCSW,C'N'          UFN NET BILLING                            
         BNE   BUYBK5A8                                                         
         TM    PBBILST,X'02'                                                    
         BZ    BUYBK5A2                                                         
*                                                                               
         DROP  R2                    PROCESS                                    
*                                                                               
*                                                                               
BUYBK5A8 CLI   ZUOPT,C'O'          SEE IF OMITING PREV BILLED INS               
         BE    BUYBK9              YES                                          
         MVI   ZLSW,C'Y'           SET TOTALLY BILLED                           
         B     BUYBK5C                                                          
*                                                                               
BUYBK5B  L     RF,ADBUY                                                         
         CLI   3(RF),X'88'         SEE IF DOING OLD MANUAL BILL                 
*                                  DUMMIED UP AS BUYREC                         
         BNE   BUYBK5C                                                          
         MVI   ZLSW,C'Y'           SET TO FULLY BILLED                          
*                                                                               
BUYBK5C  LA    R3,BRKTAB                                                        
         USING BRKTABD,R3                                                       
BUYBK5E  DS    0H                                                               
         CLI   LSTOPT,C'Y'         SEE IF LISTING PREV BILLS                    
         BE    BUYBK5E5                                                         
         CLI   LSTOPT,C'R'         SEE IF LISTING PREV BILLS                    
         BE    BUYBK5E5            (+ RESTATE AMTDUE)                           
         CLI   LSTOPT,C'A'         SEE IF LISTING PREV BILLS                    
         BE    BUYBK5E5            (SHOW AMOUNT DUE)                            
         CLI   LSTOPT,C'B'         SEE IF LISTING INVS FOR INSERTS              
         BE    BUYBK5E5            AND PREV BILLS (+ RESTATE AMTDUE)            
         CLI   LSTOPT,C'I'         OR LISTING INV FOR INSERTS                   
         BNE   BUYBK7              AND PREV BILLS                               
*                                                                               
BUYBK5E5 OC    SAVMGRU(6),SAVMGRU      SEE IF DOING REG/DSTS                    
         BZ    BUYBK6                                                           
*                                                                               
         CLI   MRDASS,C'Y'          SEE IF SPECIAL DRD SCHEME                   
         BE    BUYBK5J              SKIP PRIMARY REG/DST CHECK                  
*                                                                               
BUYBK5E7 DS    0H                                                               
         L     R2,ALTLREC                                                       
         LTR   R2,R2                                                            
         BZ    BUYBK6                                                           
         LA    R2,33(R2)                                                        
         MVI   ELCODE,X'71'                                                     
         CLI   0(R2),X'71'                                                      
         BE    BUYBK5H                                                          
*                                                                               
BUYBK5F  DS    0H                                                               
         BAS   RE,BNEXTEL                                                       
         BNE   BUYBK5J                                                          
*                                                                               
BUYBK5H  DS    0H                                                               
         CLC   QPUB+1(3),=C'RD='   SEE IF OVERRIDE CLT GIVEN                    
         BE    BUYBK5H3                                                         
*                                                                               
         USING PUBDSTEL,R2                                                      
         L     RF,ADCLT                                                         
         CLC   PUBDCLT,PCLTKCLT-PCLTREC(RF)                                     
         BNE   BUYBK5F                                                          
         B     BUYBK5H4                                                         
*                                                                               
BUYBK5H3 CLC   PUBDCLT,QPUB+4    DRD OVERRIDE CLT                               
         BNE   BUYBK5F                                                          
*                                                                               
BUYBK5H4 L     RF,PPFILEC                                                       
         USING PPFILED,RF                                                       
         CLC   PUBDDIV,PDIVKDIV                                                 
         BE    BUYBK5I                                                          
         CLC   PUBDDIV,PPRDDIV       TRY PRODUCT DIVISION                       
         BNE   BUYBK5F                                                          
BUYBK5I  CLC   PUBDREG(3),SAVMGRU    CHK FOR PRIMARY REG                        
         BNE   BUYBK7              NO - THEN SKIP SAVE OF                       
*                                  PREV INVOICE DATA TO                         
*                                  PREVENT SAME ELEM BEING ADDED TWICE          
*                                                                               
         CLI   QDIST,C' '          IF NOT BY DISTRICT                           
         BE    BUYBK5J                                                          
         CLC   PUBDREG(6),SAVMGRU    CHK FOR PRIMARY REG/DST                    
         BNE   BUYBK7              NO - THEN SKIP SAVE OF                       
*                                  PREV INVOICE DATA TO                         
*                                  PREVENT SAME ELEM BEING ADDED TWICE          
*                                                                               
         B     BUYBK5J                                                          
         DROP  RF                                                               
*                                                                               
         SPACE 3                                                                
BNEXTEL  DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    BNEXTEL2                                                         
         CLC   0(1,R2),ELCODE                                                   
         BER   RE                                                               
         B     BNEXTEL                                                          
BNEXTEL2 DS    0H                                                               
         LTR   RE,RE                                                            
         BR    RE                                                               
*                                                                               
FIXAC    NTR1                                                                   
*                                  R4 HAS ADDR OF 'BAD' AC                      
*                                  WILL BE SAME AS GROSS                        
*                                  FOR 'C' RATE BUYS                            
         L     RF,ADBUY                                                         
         ZAP   DUB,PBDACP-PBUYREC(3,RF)                                         
         BNZ   FIXAC5                                                           
         XC    0(4,R4),0(R4)       CLEAR AC                                     
         B     FIXACX                                                           
*                                                                               
FIXAC5   CVB   R0,DUB                                                           
         L     R1,0(R4)                                                         
         L     RF,=F'100000'                                                    
         SR    RF,R0                                                            
         MR    RE,R1                                                            
         SLDL  RE,1                                                             
         D     RE,=F'100000'                                                    
         LTR   RF,RF                                                            
         BM    *+8                                                              
         AH    RF,=H'1'                                                         
         SRA   RF,1                                                             
*                                                                               
         LR    R0,R1                                                            
         SR    R0,RF                                                            
         ST    R0,0(R4)            STORE 'FIXED' AGY COM                        
FIXACX   XIT1                                                                   
         EJECT                                                                  
         SPACE 3                                                                
*                                                                               
BUYBK5J  DS    0H                  NO REG/DST ELEM FOUND                        
*                                  SAVE INVOICE FOR LISTING                     
BUYBK6   L     RF,ADBUY                                                         
BUYBK6B  LA    R2,33(RF)                                                        
         MVI   ELCODE,X'26'        FIND BILLING ELEMS                           
         CLI   CAROPT,C'Y'         CARAT SYTLE COST2?                           
         BE    BUYBK6B5                                                         
*                                                                               
         TM    FINANSW,X'01'       SEE IF DOING FINANCIAL CLIENT                
         BNO   BUYBK6C                                                          
BUYBK6B5 MVI   ELCODE,X'28'        LOOK FOR OPEN BILLING ELEMS                  
***R***                                                                         
         CLC   QPROG,=C'R1'        SEE IF FINANCIAL REBATE                      
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
         CLC   QPROG,=C'RD'        SEE IF FINANCIAL REBATE DRAFT                
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
***R***                                                                         
BUYBK6C  BRAS  RE,NEXTEL                                                        
         BNE   BUYBK7                                                           
         USING PBILELEM,R2                                                      
         OC    KTYP,KTYP           PROCESSING A ADDIT CHARGE?                   
         BZ    BUYK6C3                                                          
         CLI   1(R2),25            IS IT SPEC CHARGE ELEM? (LEN=25)             
         BL    BUYBK6C             NO, DON'T PROCESS                            
         CLC   PBACCODE,KTYP       YES, ONLY PROCESS FOR THAT ADDIT CHG         
         BNE   BUYBK6C                                                          
         B     BUYK6C4                                                          
*                                                                               
BUYK6C3  CLI   1(R2),25            MUST BE AT LEAST 25 TO HAVE A TYPE           
         BL    BUYK6C4                                                          
         OC    PBACCODE,PBACCODE   MUST NOT HAVE A TYPE                         
         BNZ   BUYBK6C             IF DOES, THEN SKIP                           
*                                                                               
BUYK6C4  OC    KPO#,KPO#           LOOKING FOR A PO#?                           
         BZ    BUYK6CX                                                          
         CLI   1(R2),27            LENGTH MUST BE AT LEAST 27                   
         BL    BUYBK6C                                                          
         CLC   PBPOSEQ,KPO#                                                     
         BNE   BUYBK6C                                                          
*                                                                               
BUYK6CX  OC    PBLDATE,PBLDATE     SEE IF BILLED                                
         BZ    BUYBK6C                                                          
         CLC   PBPRD,KPRD          MUST BE RIGHT PRODUCT                        
         BNE   BUYBK6C             SKIP                                         
*                                                                               
         CLI   MANRVDTP,0         SEE IF REVERSING                              
         BE    BUYBK6C2                                                         
*                                  THEN ONLY LIST IF MATCHES DATE               
*                                  AND NUMBER                                   
         CLC   PBLDATE,MANRVDTP                                                 
         BNE   BUYBK6C                                                          
         CLC   PBINVNO,MANRVNO     MATCH INVOICE NUMBERS                        
         BNE   BUYBK6C                                                          
         B     BUYBK6C8            IF MATCHES - SKIP OTHER CHECKS               
*                                                                               
BUYBK6C2 DS    0H                                                               
*                                                                               
         CLI   SHOWREV,C'Y'        INCLUDING?                                   
         BE    *+12                                                             
*                                                                               
         TM    PBBILST,X'C0'       SKIP REVERSED AND REVERSALS                  
         BNZ   BUYBK6C                                                          
         CLI   SCBNCSW,C'C'        UFC COMM BILLING                             
         BNE   BUYBK6C3                                                         
         TM    PBBILST,X'01'                                                    
         BZ    BUYBK6C                                                          
         B     BUYBK6C8                                                         
*                                                                               
BUYBK6C3 DS    0H                                                               
         CLI   SCBNCSW,C'N'        UFC NET BILLING                              
         BNE   BUYBK6C8                                                         
         TM    PBBILST,X'02'                                                    
         BZ    BUYBK6C                                                          
*                                                                               
BUYBK6C8 DS    0H                                                               
*                                                                               
         SR    R0,R0                CLEAR R0  (STORED IN BUYBK6CA)              
         CLI   LSTOPT,C'A'          DOING ACTUAL $ ON PREV. INV. LIST           
         BE    BUYBK6C9             MUST READ BILL                              
         CLI   MRDASS,C'Y'          SEE IF DOING SPECIAL DRD SCHEME             
         BNE   BUYBK6CC             IF SO, MUST ALSO READ BILL                  
*                                                                               
BUYBK6C9 GOTOR RDBILL,DMCB,ADBUY,(R2)                                           
*                                   ADBILL SHOULD NOW HAVE BILL                 
         L     RF,ADBUY           MUST RESET RF TO ADBUY                        
         L     R1,ADBILL                                                        
*                                                                               
         CLI   MRDASS,C'Y'          SEE IF DOING SPECIAL DRD SCHEME             
         BNE   BUYBK6CA             IF SO REG/DST MUST MATCH                    
*                                                                               
         CLC   SAVMGRU(6),PNBMGR1-PBILLREC(R1)  MATCH REG/DST                   
         BNE   BUYBK6C              NO - THEN SKIP THIS ELEM                    
*                                                                               
BUYBK6CA DS    0H             SAME BILL'S AMOUNT DUE                            
         CLI   0(R1),0        WAS BILL FOUND?                                   
         BE    BUYBK6C        IF NOT JUST SKIP -SO I WON'T DIE HERE             
*                                                                               
         ZAP   DUB,PBILLRCV-PBILLREC(L'PBILLRCV,R1)                             
         CVB   R0,DUB                                                           
*                                                                               
BUYBK6CC DS    0H                                                               
         XC    X,X                                                              
         LA    R7,X                                                             
         USING INVLD,R7                                                         
*                                                                               
         ST    R0,INVLDUE            AMOUNT DUE FROM BILL                       
*                                                                               
         MVC   INVLINV(2),PBLDATE    YEAR AND MONTH                             
*                                                                               
         MVC   INVLINV+2(2),PBINVNO     INVOICE NUMBER                          
*                                                                               
*                                                                               
BUYBK6F  DS    0H                                                               
         OC    AMEDBRK,AMEDBRK                                                  
         BZ    BUYBK61                                                          
         CLC   AMEDBRK,AINVBRK                                                  
         BH    *+10                                                             
         MVC   INVLMED,QMEDIA                                                   
*                                                                               
BUYBK61  OC    APGR1BRK,APGR1BRK                                                
         BZ    BUYBK6F2                                                         
         CLC   APGR1BRK,AINVBRK                                                 
         BH    *+10                                                             
         MVC   INVLPGR,SAVPGRU     PGROUP - DIVISION                            
BUYBK6F2 CLC   APRDBRK,AINVBRK                                                  
         BH    *+10                                                             
         MVC   INVLPRD,PBPRD       PRD                                          
*                                                                               
         CLC   AESTBRK,AINVBRK                                                  
         BH    *+10                                                             
         MVC   INVLEST,PBUYKEST-PBUYKEY(RF)      EST                            
*                                                                               
         OC    AJOBBRK,AJOBBRK                                                  
         BZ    *+20                                                             
         CLC   AJOBBRK,AINVBRK                                                  
         BH    BUYBK6F4                                                         
         MVC   INVLJOB,PBDJOB-PBUYKEY(RF)      JOB                              
**NEW 4/25/90                                                                   
         OC    INVLJOB,INVLJOB                 SEE IF THERE IS A JOB            
         BNZ   BUYBK6F4                                                         
         MVC   INVLJOB,=X'FFFFFFFFFFFF'                                         
*                                    SO I WILL FIND IF JOB= *NONE*              
*                                    AJOB = 6X'FF'                              
**NEW 4/25/90                                                                   
BUYBK6F4 OC    APUBBRK,APUBBRK                                                  
         BZ    BBK6F4B                                                          
         CLC   APUBBRK,AINVBRK                                                  
         BH    BBK6F4B                                                          
         MVC   INVLPUB(4),PBUYKPUB-PBUYKEY(RF)   BASE NUMBER                    
         CLI   NOZEOPT,C'Y'    SEE IF SUPPRESSING ZONE/EDITION                  
         BE    BBK6F4B                                                          
         MVC   INVLPUB,PBUYKPUB-PBUYKEY(RF)      PUB                            
BBK6F4B  OC    AMGR1BRK,AMGR1BRK                                                
         BZ    *+20                                                             
         CLC   AMGR1BRK,AINVBRK                                                 
         BH    *+10                                                             
         MVC   INVLMGR,SAVMGRU     MARKET GROUP - REG/DST                       
         OC    AMKTBRK,AMKTBRK                                                  
         BZ    BUYBK6G                                                          
         CLC   AMKTBRK,AINVBRK                                                  
         BH    BUYBK6G                                                          
         L     RF,ADPUB                                                         
         XC    WORK(20),WORK                                                    
         MVC   WORK(2),PUBSTACD-PUBREC(RF)                                      
         CLI   PUBSTACD-PUBREC(RF),C' '     USE STACD                           
         BNH   *+12                                                             
         CLI   PUBSTACD-PUBREC(RF),C'0'     UNLESS NUMERIC                      
         BL    *+10                                                             
         MVC   WORK(2),PUBSTATE-PUBREC(RF)                                      
         MVI   WORK+2,C','                                                      
         MVC   WORK+4(16),PUBZNAME-PUBREC(RF)  CAN ONLY USE 16 CHARS            
         CLI   QMEDIA,C'O'         FOR OUTDOOR MKT IS STATE, ZONE               
         BE    BUYBK6F5                                                         
         XC    WORK(20),WORK                                                    
         CLI   QMEDIA,C'N'                                                      
         BNE   BUYBK6F5            NO MKTS FOR MAGS,TRADE,SUPPLEMENTS           
         MVC   WORK(2),PUBSTATE-PUBREC(RF)                                      
         MVI   WORK+2,C','                                                      
         MVC   WORK+4(16),PUBCITY-PUBREC(RF)                                    
BUYBK6F5 LA    R5,WORK                                                          
BUYBK6F8 MVC   INVLMKT,0(R5)       MARKET                                       
         L     RF,ADBUY            MUST RESET RF                                
*                                                                               
BUYBK6G  CLC   APERBRK,AINVBRK                                                  
         BH    BUYBK6I                                                          
*                           FIND PERIOD THAT CONTAINS BILLABLE DATE             
         LA    RE,PERLIST                                                       
BUYBK6H  DS    0H                                                               
         CLC   PBDBDATE-PBUYKEY(3,RF),5(RE)                                     
         BNH   BUYBK6H2                                                         
         LA    RE,8(RE)                                                         
         B     BUYBK6H                                                          
*                                                                               
BUYBK6H2 DS    0H                                                               
         MVC   INVLPER,0(RE)                                                    
*                                                                               
BUYBK6I  DS    0H                                                               
         CLC   APERGBRK,AINVBRK                                                 
         BH    BUYBK6J                                                          
*                           FIND PERIOD THAT CONTAINS BILLABLE DATE             
         LA    RE,PERLIST                                                       
BUYBK6I2 CLC   PBDBDATE-PBUYKEY(3,RF),5(RE)                                     
         BNH   BUYBK6I4                                                         
         LA    RE,8(RE)                                                         
         B     BUYBK6I2                                                         
*                                                                               
BUYBK6I4 DS    0H                                                               
         MVI   INVLPERG,C'1'       SET PERIOD GROUP                             
         CLC   0(2,RE),CURPER                                                   
         BNE   BUYBK6J                                                          
         CLI   PRIOR,C'W'   1 +24 PRIOR                                         
         BE    BUYBK6I5                                                         
         CLI   PRIOR,C'M'                                                       
         BNE   BUYBK6J                                                          
BUYBK6I5 MVI   INVLPERG,C'5'                                                    
*                                                                               
BUYBK6J  DS    0H                                                               
         OC    ACRDBBRK,ACRDBBRK                                                
         BZ    BUYBK6M                                                          
         CLC   ACRDBBRK,AINVBRK                                                 
         BH    BUYBK6M                                                          
         CLI   PROGPRO2+13,C'Y'    CREDIT/DEBITS SEPARATE?                      
         BNE   BUYBK6J5                                                         
         MVI   INVLCRDB,C'D'       DEBIT                                        
         L     RF,ASORTDTA                                                      
         L     R0,0(RF)                                                         
         L     R1,BGDSP(RF)                                                     
         CR    R0,R1                                                            
         BNL   BUYBK6M                                                          
         MVI   INVLCRDB,C'C'       CREDIT                                       
         B     BUYBK6M                                                          
*                                                                               
BUYBK6J5 CLI   PROGPRO2+13,C'R'    S-RATE INSERTIONS ON SEPARATE?               
         BNE   BUYBK6J8                                                         
         MVI   INVLCRDB,C'D'       USE DEBIT CODE                               
         L     RF,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RF),C'S'                                        
         BE    BUYBK6M                                                          
         MVI   INVLCRDB,C'C'       USE CREDIT CODE                              
         B     BUYBK6M                                                          
*                                                                               
BUYBK6J8 CLI   PROGPRO2+13,C'C'    ALL ADDITIONAL CHARGES SEPARATE?             
         BNE   BUYBK6K                                                          
         MVI   INVLCRDB,C'C'       USE CREDIT CODE                              
         OC    KTYP,KTYP           AM I DOING AN ADDTIONAL CHG?                 
         BZ    BUYBK6M             NO                                           
*                                                                               
         CLC   KTYP,=C'FX'         FOREIGN EXCHANGE CHARGE?                     
         BE    BUYBK6M             DON'T PUT ON SEPARATE INVOICE                
*                                                                               
         MVI   INVLCRDB,C'D'       USE DEBIT CODE                               
         B     BUYBK6M                                                          
*                                                                               
BUYBK6K  DS    0H                                                               
         CLI   PROGPRO2+13,C'B'     BOTH AC=0 INSERTIONS AND CHARGES            
         BNE   BUYBK6M              ON A SEPARATE INVOICE                       
         MVI   INVLCRDB,C'C'       USE CREDIT CODE                              
         OC    KTYP,KTYP           AM I DOING AN ADDTIONAL CHG?                 
         BZ    BUYBK6K4            NO                                           
*                                                                               
         CLC   KTYP,=C'FX'         FOREIGN EXCHANGE CHARGE?                     
         BE    BUYBK6K4            DON'T PUT ON SEPARATE INVOICE                
*                                                                               
         MVI   INVLCRDB,C'D'       USE DEBIT CODE                               
         B     BUYBK6M                                                          
*                                                                               
BUYBK6K4 MVI   INVLCRDB,C'D'       USE DEBIT CODE                               
         L     RF,ADBUY                                                         
         CLC   PBDACP-PBUYREC(3,RF),=PL3'0'       AC=0?                         
         BE    BUYBK6M                                                          
         MVI   INVLCRDB,C'C'       USE CREDIT CODE                              
         B     BUYBK6M                                                          
*                                                                               
BUYBK6M  MVC   INVLGRS(4),PBGROSS                                               
         MVC   FULL,PBGROSS                                                     
         L     RF,FULL                                                          
         MVC   FULL,PBAGYCOM                                                    
         S     RF,FULL                                                          
         ST    RF,INVLNET                                                       
         MVC   INVLCD,PBCSHDSC     CD                                           
         MVC   INVLAC,PBAGYCOM                                                  
         L     RE,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RE),C'C' SEE IF 'C' RATE BUY                    
         BNE   BUYBK6O                                                          
         LA    R4,INVLAC                                                        
         BAS   RE,FIXAC                                                         
*                                                                               
BUYBK6O  GOTO1 BINSRCH,INVPARS,(1,X)                                            
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
         L     RF,ADBUY            MUST RESET RF                                
*                                                                               
         CLI   0(R1),1             ALREADY THERE                                
         BE    BUYBK6C             NO - NEXT ELEM                               
*                                                                               
         L     R1,0(R1)            ADD INTO EXISTING ELEM                       
         MVC   DMCB(16),INVLGRS-INVLD(R1)                                       
         ST    R3,FULL              SAVE BRKTAB R3                              
         LM    R3,R6,DMCB                                                       
         MVC   DMCB(16),INVLGRS                                                 
         A     R3,DMCB                                                          
         A     R4,DMCB+4                                                        
         A     R5,DMCB+8                                                        
         A     R6,DMCB+12                                                       
         STM   R3,R6,DMCB                                                       
         L     R3,FULL                RESTORE BRKTAB R3                         
         MVC   INVLGRS-INVLD(16,R1),DMCB                                        
         MVC   INVLDUE-INVLD(4,R1),INVLDUE    DON'T ADD JUST SAVE IT            
         B     BUYBK6C                                                          
*                                                                               
         DROP  R7                                                               
*                                                                               
BUYBK7   LH    R0,SPTSEQ                                                        
         AH    R0,=H'1'                                                         
         STH   R0,SPTSEQ                                                        
BUYBK7B  L     RF,BRKCODE                                                       
         LTR   RF,RF                                                            
         BZ    BUYBK8                                                           
         BAS   RE,BUYBRKS-4(RF)                                                 
         LA    R3,BRKL(R3)                                                      
         B     BUYBK7B                                                          
*                                                                               
BUYBK8   DS    0H                                                               
         OC    KPO#,KPO#           PROCESSING BY PO#                            
         BZ    BUYBK8A                                                          
         L     R2,ASORTCOM                                                      
         MVC   4(2,R2),KPO#        STORE PO# SEQ HERE                           
*                                                                               
BUYBK8A  CLI   ZLSW,C'Y'           SEE IF TOTALLY BILLED                        
         BE    BUYBK8B                                                          
         L     R2,ASORTCOM                                                      
         OC   MANGRS(12),MANGRS                                                 
         BNZ   *+10                                                             
         MVC   0(4,R2),KEY+27      DISK ADDRESS                                 
         B     BUYBK8E                                                          
*                                                                               
BUYBK8B  L     R2,ASORTDTA                                                      
         OC    BGDSP(20,R2),BGDSP(R2) SEE IF BILLED                             
         BZ    BUYBK9                                                           
**NEW 5/3/88                                                                    
         L     RF,ADBUY                                                         
*                              SEE IF OLD MANUAL BILL                           
         CLI   3(RF),X'88'                                                      
         BE    BUYBK8E         YES - DON'T SET AS BILLED INSERTION              
*                              SO ORDERED(20) WON'T' EQUAL BILLED               
*                              SINCE IDSP(R2) STILL SET TO F'1'                 
*                              IN BUYBK3A                                       
*                                                                               
         MVC   BIDSP(4,R2),=F'1' SET 1 BILLED INS                               
BUYBK8E  B     BUYBK8X                                                          
*                                                                               
BUYBK8X  DS    0H                                                               
*                                                                               
         CLI   ESTQ,C'1'           SINGLE ESTIMATE REQUEST?                     
         BNE   BUYBK8X5                                                         
*                                                                               
         CLC   THISPER,CURPER    CURRENT MTH ACTIVITY                           
         BNE   *+8                                                              
         MVI   CURSW,C'Y'                                                       
*                                                                               
BUYBK8X5 BRAS  RE,TOSORT                                                        
*                                                                               
BUYBK9   DS    0H                                                               
         OC    KTYP,KTYP        SEE IF PROCESSING AN ADDITIONAL CHG             
         BZ    PRBUYXX          IF NOT THEN JUST RETURN                         
*                                                                               
PRBUYX   CLI   PO#OPT,C'Y'      BILLING BY PO#                                  
         BNE   PRBUYXX                                                          
         L     R4,WKPO#   TABLE ADDRESS OF THE PO# I JUST PROCESSED             
         LA    R4,2(R4)   BUMP TO NEXT PO# TO DO ITS CHARGES                    
         B     PRBUY36    GO DO NEXT                                            
*                                                                               
PRBUYXX  XIT1                                                                   
         SPACE 2                                                                
BUYBRKS  DS    0F                                                               
         B     BKMED                                                            
         B     BKPGR1                                                           
         B     BKPGR2                                                           
         B     BKPGR3                                                           
         B     BKPRD                                                            
         B     BKEST                                                            
         B     BKMGR                                                            
         B     BKMGR                                                            
         B     BKMGR                                                            
         B     BKMKT                                                            
         B     BKJOB                                                            
         B     BKPUB                                                            
         B     BKDESC                                                           
         B     BKPER                                                            
         B     BKPERG                                                           
         B     BKCTYP                                                           
         B     BKCRDB                                                           
*                                                                               
         SPACE 2                                                                
BKMED    DS    0H                                                               
         L     RF,ADBUY                                                         
         MVC   HALF(1),PBUYKMED-PBUYREC(RF)                                     
         MVC   HALF+1(1),FINANSW                                                
         LA    R2,HALF                                                          
         B     BKALL                                                            
         SPACE 2                                                                
BKPGR1   DS    0H                                                               
         LA    R2,SAVPGRU                                                       
         B     BKALL                                                            
         SPACE 2                                                                
BKPGR2   DS    0H                                                               
         LA    R2,SAVPGRU                                                       
         ZIC   RF,PGR1LEN                                                       
         AR    R2,RF               POINT OT PGR2                                
         B     BKALL                                                            
         SPACE 2                                                                
BKPGR3   DS    0H                                                               
         LA    R2,SAVPGRU                                                       
         ZIC   RF,PGR2LEN                                                       
         AR    R2,RF               POINT OT PGR3                                
         B     BKALL                                                            
         SPACE 2                                                                
BKPRD    DS    0H                  PRD                                          
         LA    R2,KPRD                                                          
         L     RF,ADBUY                                                         
         CLI   3(RF),X'88'         SEE IF PROCESSING MANUAL BILL                
         BNE   BKALL                                                            
         LA    R2,PBUYKPRD-PBUYREC(RF)                                          
         B     BKALL                                                            
         SPACE 2                                                                
BKEST    DS    0H                  EST                                          
         L     RF,ADBUY                                                         
         LA    R2,PBUYKEST-PBUYREC(RF)                                          
         B     BKALL                                                            
         SPACE 2                                                                
BKPER    DS    0H                  PERIOD                                       
*                                  FIND PERIOD THAT CONTAINS BLBL DATE          
         LA    R2,PERLIST                                                       
BKPER2   DS    0H                                                               
         L     RF,ADBUY                                                         
         CLC   PBDBDATE-PBUYREC(3,RF),5(R2)                                     
         BNH   BKPER3                                                           
         LA    R2,8(R2)                                                         
         B     BKPER2                                                           
*                                                                               
BKPER3   DS    0H                                                               
         LA    R0,PERLIST                                                       
         SR    R2,R0                                                            
         SRL   R2,3                                                             
         STC   R2,BYTE              CODE FOR PERIOD                             
         LA    R2,BYTE                                                          
         B     BKALL                                                            
         SPACE 2                                                                
BKPERG   DS    0H                                                               
         LA    R5,PERLIST                                                       
BKPERG2  DS    0H                                                               
         L     RF,ADBUY                                                         
         CLC   PBDBDATE-PBUYREC(3,RF),5(R5)                                     
         BNH   BKPERG5                                                          
         LA    R5,8(R5)                                                         
         B     BKPERG2                                                          
*                                                                               
BKPERG5  DS    0H                                                               
         LA    R2,=C'1'            OLD MONTHS                                   
         CLC   0(2,R5),CURPER                                                   
         BNE   BKALL                                                            
         CLI   PRIOR,C'W'        1 +24 PRIOR                                    
         BE    BKPERG6                                                          
         CLI   PRIOR,C'M'                                                       
         BNE   BKALL                                                            
BKPERG6  LA    R2,=C'5'                                                         
         B     BKALL                                                            
*                                                                               
         SPACE 2                                                                
BKCRDB   DS    0H                                                               
         CLI   PROGPRO2+13,C'Y'     CREDIT/DEBIT BREAKOUT?                      
         BNE   BKCRDB5                                                          
         LA    R2,=C'D'             DEBIT                                       
         L     RF,ASORTDTA                                                      
         L     R0,0(RF)                                                         
         L     R1,ROWHL(RF)                                                     
         CR    R0,R1                                                            
         BNL   BKALL                                                            
         LA    R2,=C'C'                                                         
         B     BKALL                MUST BE CREDIT                              
*                                                                               
BKCRDB5  CLI   PROGPRO2+13,C'R'     S-RATE INS. SEPARATE?                       
         BNE   BKCRDB8                                                          
         LA    R2,=C'D'             USE DEBIT CODE                              
         L     RF,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RF),C'S'   S-RATE?                              
         BE    BKALL                                                            
         LA    R2,=C'C'             USE CREDIT CODE                             
         B     BKALL                                                            
*                                                                               
BKCRDB8  CLI   PROGPRO2+13,C'C'     ADDITIONAL CHGS SEPARATE?                   
         BNE   BKCRDB10                                                         
         LA    R2,=C'C'             USE CREDIT CODE                             
         OC    KTYP,KTYP            DOING ADDITIONAL CHG?                       
         BZ    BKALL                NORMAL COME FIRST                           
*                                                                               
         CLC   KTYP,=C'FX'          FOREIGN EXCHANGE CHARGE?                    
         BE    BKALL                DON'T PUT ON SEPARATE INVOICE               
*                                                                               
         LA    R2,=C'D'                                                         
         B     BKALL                USE DEBIT CODE                              
*                                                                               
BKCRDB10 CLI   PROGPRO2+13,C'B'    DOING BOTH?                                  
         BNE   BKCRDBX                                                          
         LA    R2,=C'C'             USE CREDIT CODE                             
         OC    KTYP,KTYP            DOING ADDITIONAL CHG?                       
         BZ    BKCRDB11             NORMAL COME FIRST                           
*                                                                               
         CLC   KTYP,=C'FX'          FOREIGN EXCHANGE CHARGE?                    
         BE    BKCRDB11             DON'T PUT ON SEPARATE INVOICE               
*                                                                               
         LA    R2,=C'D'                                                         
         B     BKALL                USE DEBIT CODE                              
*                                                                               
BKCRDB11 DS    0H                                                               
         LA    R2,=C'D'             USE DEBIT CODE                              
         L     RF,ADBUY                                                         
         CLC   PBDACP-PBUYREC(3,RF),=PL3'0' AC=0?                               
         BE    BKALL                                                            
         LA    R2,=C'C'             USE CREDIT CODE                             
         B     BKALL                                                            
*                                                                               
BKCRDBX  DC    H'0'                SHOULDN'T HAPPEN                             
         SPACE 2                                                                
BKMGR    DS    0H                                                               
         LA    R2,SAVMGRU                                                       
         CLI   BRKCODE+3,MGR1EQ                                                 
         BE    BKALL                                                            
         LR    R0,R2                                                            
         ZIC   RF,MGR1LEN                                                       
         AR    R2,RF               POINT TO MGR2                                
         CLI   BRKCODE+3,MGR2EQ                                                 
         BE    BKALL                                                            
         LR    R2,R0                                                            
         ZIC   RF,MGR2LEN                                                       
         AR    R2,RF               POINT OT MGR3                                
         B     BKALL                                                            
*                                                                               
         SPACE 2                                                                
BKMKT    DS    0H                  MKT                                          
         L     RF,ADPUB                                                         
         XC    WORK(20),WORK                                                    
         MVC   WORK(2),PUBSTACD-PUBREC(RF)                                      
         CLI   PUBSTACD-PUBREC(RF),C' '     USE STACD                           
         BNH   *+12                                                             
         CLI   PUBSTACD-PUBREC(RF),C'0'     UNLESS NUMERIC                      
         BL    *+10                                                             
         MVC   WORK(2),PUBSTATE-PUBREC(RF)                                      
         MVI   WORK+2,C','                                                      
         MVC   WORK+4(16),PUBZNAME-PUBREC(RF)  CAN ONLY USE 16 CHARS            
         CLI   QMEDIA,C'O'         FOR OUTDOOR MKT IS STATE, ZONE               
         BE    BKMKT5                                                           
         XC    WORK(20),WORK                                                    
         CLI   QMEDIA,C'N'                                                      
         BNE   BKMKT5              NO MKTS FOR MAGS,TRADE,SUPPLEMENTS           
         MVC   WORK(2),PUBSTATE-PUBREC(RF)                                      
         MVI   WORK+2,C','                                                      
         MVC   WORK+4(16),PUBCITY-PUBREC(RF)                                    
BKMKT5   LA    R2,WORK                                                          
         B     BKALL                                                            
         SPACE 2                                                                
*                                                                               
         SPACE 2                                                                
BKPUB    DS    0H                  PUB                                          
         L     RF,ADBUY                                                         
         LA    R2,PBUYKPUB-PBUYREC(RF)                                          
         CLC   XXPUB,0(R2)                                                      
         BE    BKALL               OLD OR NEW MANUAL BILLS                      
         LA    R2,WORK                                                          
         XC    WORK(10),WORK                                                    
         MVC   WORK(4),PBUYKPUB-PBUYREC(RF)   MOVE BASE PUB                     
         CLI   NOZEOPT,C'Y'        SEE IF SUPRESSING ZONE/EDITION               
         BE    *+10                                                             
         MVC   WORK(6),PBUYKPUB-PBUYREC(RF)   MOVE FULL PUB NUMBER              
*                                                                               
         CLI   ZUOPT,C'P'          SEE IF COMBINING PREV BILLS                  
*                                  ACROSS PUBS                                  
         BNE   BKALL                                                            
         CLI   ZLSW,C'Y'           SEE IF FULLY BILLED                          
         BNE   BKALL                                                            
         LA    R2,=X'FFFFFFFFFFFF'                                              
         B     BKALL                                                            
*                                                                               
BKJOB    DS    0H                  JOB (WITH PRD)                               
**WB**                                                                          
         CLI   WBSW,C'Y'           WB FLIGHT FEATURE?                           
         BE    BKFLT                                                            
**WB**                                                                          
         CLI   PO#OPT,C'Y'         BILLING BY PO# (SEPARATE)                    
         BE    BKPO#                                                            
*                                                                               
         ST    RE,FULL2            SAVE LINK REGISTER                           
         XC    WORK,WORK                                                        
         LA    R2,WORK                                                          
         L     RF,ADBUY                                                         
         CLC   PBDJOB-PBUYREC(6,RF),SPACES  DO I HAVE A JOB?                    
         BNH   BKJOB5                                                           
*                                                                               
         MVC   WORK(3),PBUYKPRD-PBUYREC(RF)                                     
         MVC   WORK+JOBDSP(6),PBDJOB-PBUYREC(RF)                                
         MVC   WORK+3+ADIDLQ(6),PBDJOB-PBUYREC(RF)                              
*                                                                               
*        MUST READ JOB TO GET AD ID                                             
*                                                                               
*                                                                               
         L     R7,PPFILEC          NEEDED TO ADDRESS PJOBREC                    
         USING PPFILED,R7                                                       
*                                                                               
         XC    WORK(25),WORK                                                    
         MVC   WORK(10),PBUYKEY-PBUYREC(RF)                                     
         MVI   WORK+3,X'15'                                                     
         MVC   WORK+10(6),PBDJOB-PBUYREC(RF)                                    
         CLC   PJOBREC(25),WORK                                                 
         BE    BKJOB3                                                           
         MVC   BKSAVKEY,KEY                                                     
         MVC   KEY(25),WORK                                                     
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         GOTO1 GETJOB                                                           
*                                                                               
         MVC   KEY,BKSAVKEY                                                     
         GOTO1 HIGH                                                             
*                                                                               
BKJOB3   DS    0H                                                               
*                                                                               
         L     RE,FULL2         RESTORE RE                                      
         L     RF,ADBUY                                                         
         MVC   WORK(3),PBUYKPRD-PBUYREC(RF)                                     
         MVC   WORK+JOBDSP(6),PBDJOB-PBUYREC(RF)                                
         MVC   WORK+ADIDDSP2(ADIDLQ),PJOBADID  STORE AFTER AD CODE              
*                                                                               
         CLI   PBDJOB-PBUYREC(RF),X'FF'      AD ID ONLY                         
         BE    BKJOB3A                       THEY WILL HAVE AD ID               
*                                            BEFORE AND AFTER AD CODE           
         B     BKALL                                                            
*                                                                               
BKJOB3A  DS    0H                                                               
         MVC   WORK+ADIDDSP(ADIDLQ),PJOBADID   STORE BEFORE AD CODE             
         B     BKALL                           FOR SORTING                      
*                                                                               
         DROP  R7                                                               
*                                                                               
BKJOB5   MVC   WORK(3),=3X'FF'   FOR BUYS WITH NO JOB - SET PRD TO FF'S         
         L     RE,FULL2         RESTORE RE                                      
         B     BKALL                                                            
**WB**                                                                          
BKFLT    DS    0H                                                               
         XC    WORK,WORK                                                        
         MVC   WORK(3),=3X'FF'                                                  
         MVC   WORK+JOBDSP(10),ESTWBFLT                                         
*                    FROM EST UCOMM-CONTROL WILL BE REQUIRED                    
         L     RF,ADBUY                                                         
         CLI   3(RF),X'88'      MANUAL BILL?                                    
         BNE   BKFLT5                                                           
         MVC   WORK+JOBDSP(10),SVMANFLT    USE MANUAL BILL'S FLIGHT ID          
*                                                                               
BKFLT5   LA    R2,WORK                                                          
         B     BKALL                                                            
**WB**                                                                          
BKPO#    DS    0H                                                               
         XC    WORK,WORK                                                        
         MVI   WORK,X'FF'                                                       
         MVC   WORK+1(2),=C'PO'                                                 
******   MVC   WORK+3(02),KPO#                                                  
*                                                                               
         L     RF,ADBUY                                                         
         CLI   3(RF),X'88'      MANUAL BILL?                                    
         BNE   BKPO#2                                                           
         MVI   WORK,X'FF'                                                       
         MVC   WORK+1(2),=C'PO'                                                 
*******  MVC   WORK+3(2),SVMANPO#    USE MANUAL BILL'S PO#                      
         MVC   KPO#,SVMANPO#                                                    
*                                                                               
BKPO#2   DS    0H                USE PPGETPO# TO GET PO#                        
         ST    RE,FULL2                                                         
         MVC   BKSAVKEY,KEY                                                     
         MVC   WORK+40(1),PBUYKMED-PBUYREC(RF)                                  
         MVC   WORK+41(2),PBUYKAGY-PBUYREC(RF)                                  
         MVC   WORK+43(3),PBUYKCLT-PBUYREC(RF)                                  
****     MVC   WORK+46(3),PBUYKPRD-PBUYREC(RF)                                  
         MVC   WORK+46(3),KPRD       CAN'T USE PBUYKPRD                         
         MVC   WORK+49(2),PBUYKEST-PBUYREC(RF)                                  
         MVC   WORK+51(2),KPO#        PO SEQ #                                  
         GOTO1 =V(PPGETPO#),DMCB,(C'C',WORK+40),(PO#TYPE,WORK+4),VCOMFAX        
               CS                                                               
*                                                                               
         MVC   KEY,BKSAVKEY                                                     
         GOTO1 HIGH                                                             
*                                                                               
         L     RE,FULL2                                                         
*                                                                               
BKPO#5   LA    R2,WORK                                                          
         B     BKALL                                                            
*                                                                               
BKDESC   DS    0H                                                               
         XC    WORK,WORK                                                        
         CLI   ZLSW,C'Y'           TEST ALREADY BILLED                          
         BE    BKDESC2                                                          
         OC   MANGRS(12),MANGRS                                                 
         BNZ   BKDESC3                                                          
         L     RF,ADBUY                                                         
         MVC   WORK(3),PBUYKDAT-PBUYREC(RF)                                     
         MVC   WORK+3(2),SPTSEQ                                                 
         B     BKDESC9                                                          
*                                                                               
BKDESC2  MVI   WORK,X'FA'          PREVBILLED INS                               
         L     RF,ADBUY                                                         
         CLI   PBUYKRCD-PBUYREC(RF),X'88'   SEE IF PREV MANUAL BILL             
         BNE   BKDESC9                                                          
         MVI   WORK,X'FC'          PREV MANUAL BILL (FROM RMBILL)               
*                                                                               
*              THE FOLLOWING IS NEEDED TO INSURE UNIQUE DECSRIPTIONS            
*              THE FIELDS WERE SET IN RMBILL IN THE DUMMY BUY                   
*                                                                               
         MVC   WORK+1(2),PBDRLIND+2-PBUYREC(RF)  PBILKMN - YEAR/MTH             
         MVC   WORK+3(2),PBDRLIND-PBUYREC(RF)  PBILKBNO - INVOICE NO.           
         L     R2,ASORTCOM         SET DISK ADDR                                
         MVC   0(4,R2),KEY+27                                                   
         B     BKDESC9                                                          
*                                                                               
BKDESC3  MVI   WORK,X'FB'          CURRENT MANUAL                               
*                                                                               
BKDESC9  LA    R2,WORK                                                          
         B     BKALL                                                            
         SPACE 2                                                                
BKCTYP   DS    0H                  TYPE OF CHARGE                               
         LA    R2,KTYP                                                          
         B     BKALL                                                            
         SPACE 2                                                                
BKALL    DS    0H                                                               
         LA    R5,SORTKEY                                                       
         A     R5,BRKDISP                                                       
         L     RF,BRKLENM1                                                      
         EX    RF,*+6                                                           
         BR    RE                                                               
         MVC   0(0,R5),0(R2)                                                    
         EJECT                                                                  
*                                                                               
         LTORG                                                                  
         SPACE 1                                                                
KTYP     DS    CL2                 TEMP STORAGE FOR ADDIT CHARGE                
         DC    X'00'               DO NOT REMOVE!!!                             
*                                                                               
*                      NEEDED FOR GETINS CALLS FOR PO# BILLING                  
*                                                                               
KPO#     DS    XL2                 TEMP STORAGE FOR PO# (SEQ#)                  
FXFND    DS    CL1                                                              
ADCHGTAB DS    CL26              (WAS 24)                                       
ADCHGTX  DC    X'FF'              FOR A FINAL X'FF'                             
*  NOTE  MAX IS 13 ADDITIONAL CHARGES                                           
PO#TAB   DS    XL26                                                             
PO#TABX  DC    X'FF'              FOR A FINAL X'FF'                             
*  NOTE  MAX IS 13 PO#                                                          
*                                                                               
SBGROSS  DS    4F                                                               
WKPO#    DS    F       TABLE ADDRESS OF THE PO# THAT I JUST DID                 
BKSAVKEY DS    CL64                                                             
*                                                                               
         DROP  R8                                                               
         EJECT                                                                  
*        USED TO CHECK PLANNED COST                                             
*                                                                               
PLANCHK  NMOD1 0,PLANCK                                                         
*                                                                               
         LA    RC,SPACEND                                                       
*                                                                               
         MVI   DUB,0                                                            
*                                                                               
*     FIRST CHECK B4-7A PROFILE TO SEE IF PLANNED COST APPLIES                  
*                                                                               
         CLI   PROGPRO3+12,C'N'                                                 
         BE    PLANCKX                                                          
         OC    PROGPRO3+13(2),PROGPRO3+13   EFFECTIVE YM GIVEN?                 
         BZ    PLANCK2           NO - SKIP DATE CHECK HERE                      
         CLI   PROGPRO3+14,0     MONTH GIVEN?                                   
         BE    PLANCK2           YES - IMPLIES NO EFFECTIVE DATE GIVEN          
         L     RE,ADBUY                                                         
         CLC   PBUYKDAT-PBUYKEY(2,RE),PROGPRO3+13  BEFORE EFFECTIVE YM?         
         BL    PLANCKX                                                          
*                                                                               
PLANCK2  XC    X(20),X                                                          
         LA    R5,X                                                             
         USING UPED,R5                                                          
*                                                                               
         MVC   UPEPRD,KPRD   CAN'T USE PBUYKPRD  - MIGHT BE ZZZ                 
*                                                                               
         L     RE,ADBUY                                                         
         MVC   UPEEST,PBUYKEST-PBUYKEY(RE)                                      
*                                                                               
         GOTO1 BINSRCH,UPEPARS,X                                                
         CLI   0(R1),1           SEE IF IN TABLE                                
         BE    PLANCKX                                                          
*                                                                               
         L     R5,0(R1)          ADDRESS OF FOUND RECORD                        
         TM    UPESTAT,X'02'     PLANNED COST  ACTIVE?                          
         BZ    PLANCKX                                                          
*                                                                               
         L     RE,ADBUY                                                         
         CLC   PBUYKDAT-PBUYKEY(2,RE),UPEPEDT  CHK VS. EFFECTIVE MONTH          
         BL    PLANCKX                                                          
         CLI   PROGPRO3+12,C'A'  CHECKING FOR ACTUALIZED $                      
         BNE   PLANCK10                                                         
*                                                                               
PLANCK5  OC    UPEPADT,UPEPADT   IF NO ACTUALIZATION DATE, SKIP                 
         BZ    PLANCK40          THIS INSERTION                                 
*                                                                               
         CLC   PBUYKDAT-PBUYKEY(2,RE),UPEPADT  CHK VS. ACTUALIZTN MONTH         
         BH    PLANCK40          SKIP IF MTH NO ACUALIZED                       
         B     PLANCKX           PROCESS REGULAR $                              
*                                                                               
PLANCK10 CLI   PROGPRO3+12,C'P'  PLANNED $  ASKED FOR                           
         BNE   PLANCK20                                                         
         OC    UPEPADT,UPEPADT   IS THERE AN ACTUALIZATION DATE?                
         BZ    PLANCK12          NO - SET TO PROCESS PLANNED $                  
*                                MUST BE BEFORE AN ACTUALIZAION DATE            
         CLC   PBUYKDAT-PBUYKEY(2,RE),UPEPADT  CHK VS. ACTUALIZTN MONTH         
         BNH   PLANCK40          SKIP IF IN OR BEFORE ACTUALIZAION MTH          
PLANCK12 MVI   DUB,C'P'          ELSE SET TO USE PLANNED $                      
         B     PLANCKX                                                          
*                                                                               
PLANCK20 CLI   PROGPRO3+12,C'B'     DOING BOTH PLANNED AND ACTUALIZED           
         BE    *+6                                                              
         DC    H'0'              DUMP FOR NOW - INVALID PROFILE                 
*                                                                               
         OC    UPEPADT,UPEPADT   ACTUALIZATION DATE PRESENT?                    
         BZ    PLANCK12          NO, THEN SET TO PROCESS PLANNED                
         CLC   PBUYKDAT-PBUYKEY(2,RE),UPEPADT                                   
         BNH   PLANCKX           PROCESS REGULAR $ IF IN OR BEFORE              
         B     PLANCK12          IF AFTER PROCESS PLANNED                       
*                                                                               
PLANCK40 MVI   DUB,C'X'          SKIP THIS INSERTION                            
*                                                                               
PLANCKX  XIT1                                                                   
         DROP  R5                                                               
         LTORG                                                                  
         EJECT                                                                  
*        SETSKIP  - SET TO SKIP PRD/EST IF UNPAID INS. FOUND                    
*                   USED WITH PAYOPTS E,F,G    (BYTE=U)                         
*                   ALSO SET PLANNED COST INFO (BYTE=P)                         
*                                                                               
SETSKIP  NMOD1 0,SETSKP                                                         
*                                                                               
         LA    RC,SPACEND                                                       
*                                                                               
         XC    X(20),X                                                          
         LA    R5,X                                                             
         USING UPED,R5                                                          
*                                                                               
         MVC   UPEPRD,KPRD   CAN'T USE PBUYKPRD  - MIGHT BE ZZZ                 
*                                                                               
         L     RE,ADBUY                                                         
         MVC   UPEEST,PBUYKEST-PBUYKEY(RE)                                      
*                                                                               
         GOTO1 BINSRCH,UPEPARS,(1,X)   ADD TO TABLE                             
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'      TOO MANY UNPAID ESTS - EXPAND UPETAB                   
         L     R5,0(R1)  ADDRESS OF ADDED OR FOUND RECORD                       
*                                                                               
         CLI   BYTE,C'U'                SEE IF I'M SETTING UNPAID IND.          
         BNE   SETSKP                                                           
         OI    UPESTAT,X'01'            SET UNPAID INDICATOR                    
         B     SETSKX                                                           
*                                                                               
SETSKP   DS    0H          SEE IF I NEED TO SET PLANNED COST DATA               
         CLI   BYTE,C'P'                                                        
         BNE   SETSKX                                                           
         MVI   W,0                                                              
*                                                                               
*        FIRST CHECK ESTIMATE'S PLANNED COST ELEMENT                            
*                                                                               
         L     R2,ADEST                                                         
         LA    R2,33(R2)    TO FIRST ELEMENT                                    
         MVI   ELCODE,X'45'                                                     
         BRAS  RE,NEXTEL                                                        
         BNE   SETSKP2                                                          
         OC    2(2,R2),2(R2)     EFFECTIVE DATE PRESENT?                        
         BZ    SETSKP2           SKIP IF NOT                                    
         OI    W,X'01'           SET ESTIMATE ELEMENT FOUND                     
         MVC   UPEPEDT,2(R2)     SAVE EFFECIVE DATE (INSERTION)                 
         OI    UPESTAT,X'02'     SET PLANNED COST INDICATOR                     
*                                                                               
*        NEXT CHECK ESIMATE'S ACTUALIZAION ELEMENT                              
*                                                                               
SETSKP2  L     R2,ADEST                                                         
         LA    R2,33(R2)    TO FIRST ELEMENT                                    
         MVI   ELCODE,X'46'                                                     
         BRAS  RE,NEXTEL                                                        
         BNE   SETSKP2A                                                         
         MVC   UPEPADT,2(R2)     SAVE ACTUALIZATION DATE (INSERTION)            
         OI    UPESTAT,X'02'     SET PLANNED COST INDICATOR                     
SETSKP2A CLI   W,X'01'           EST X'45' ELEMENT FOUND?                       
         BE    SETSKX                                                           
         B     SETSKP5           OTHERWISE CHK PRODUCT                          
*                                                                               
*        PATCHABLE FOR TESING                                                   
*                                                                               
         MVI   UPEPADT,X'00'     ACTULIZATION DATE - YR                         
         MVI   UPEPADT+1,X'00'   ACTULIZATION DATE - MTH                        
         B     SETSKX                                                           
*                                                                               
*        NEXT CHECK PRODUCT'S PLANNED COST ELEMENT                              
*                                                                               
SETSKP5  L     R2,ADPRD                                                         
         LA    R2,33(R2)    TO FIRST ELEMENT                                    
         MVI   ELCODE,X'45'                                                     
         BRAS  RE,NEXTEL                                                        
         BNE   SETSKP10                                                         
         OC    2(2,R2),2(R2)     EFFECTIVE DATE PRESENT?                        
         BZ    SETSKP10          SKIP IF NOT                                    
         MVC   UPEPEDT,2(R2)     SAVE EFFECIVE DATE (INSERTION)                 
         OI    UPESTAT,X'02'     SET PLANNED COST INDICATOR                     
         B     SETSKX                                                           
*                                                                               
*        NEXT CHECK CLIENT'S B2B PROFILE                                        
*                                                                               
SETSKP10 MVC   UPEPEDT,=X'FFFF'    DEFAULT TO NOT ACTIVE                        
         CLI   PROFB2B+12,C'Y'     PLANNED COST CLIENT?                         
         BNE   SETSKX                                                           
         MVC   UPEPEDT,PROFB2B+13 SAVE EFFECTIVE DATE (INSERTION)               
         OI    UPESTAT,X'02'     SET PLANNED COST INDICATOR                     
*                                                                               
SETSKX   DS    0H                                                               
         XIT1                                                                   
         DROP  R5                                                               
         LTORG                                                                  
         EJECT                                                                  
NTAXCALC NMOD1 0,NTAXC USED TO EXTRACT NET FROM NET + TAX                       
         LA    RC,SPACEND                                                       
*                      RETURNS NET IN FULL                                      
         MVC   DUB(4),0(R4)           SET TO NET (+TAX)                         
         L     RF,ADBUY                                                         
         OC    PBDTAX-PBUYREC(3,RF),PBDTAX-PBUYREC(RF)                          
         BZ    NTAXCX                 IF NO TAX - DONE                          
*                                                                               
NTAXC2   TM    PBDCNDA-PBUYREC(RF),X'80'   SEE IF CANADIAN                      
         BZ    NTAXC40                NO USE OLD ROUTINE                        
*                                                                               
         MVC   BYTE(1),PBDGST-PBUYREC(RF)                                       
         LA    RE,PGSTTAB                                                       
         CLI   BYTE,0                                                           
         BNE   *+8                                                              
         MVI   BYTE,C'S'           DEFAULT TO STANDARD                          
*                                                                               
NTAXC4   CLC   0(1,RE),BYTE                                                     
         BE    NTAXC5                                                           
NTAXC4N  LA    RE,8(RE)                                                         
         CLI   0(RE),X'FF'                                                      
         BNE   NTAXC4                                                           
         B     NTAXC40         INVALID TAX CODE - TREAT LIKE NO GST             
*                                                                               
NTAXC5   CLC   PBUYKDAT-PBUYREC(3,RF),4(RE)                                     
         BH    NTAXC5E                                                          
         CLC   PBDPDATE-PBUYREC(3,RF),4(RE)                                     
         BH    NTAXC5E                                                          
         B     NTAXC4N            TRY FOR ANOTHER ENTRY                         
*                                                                               
NTAXC5E  DS    0H                                                               
         OC    2(2,RE),2(RE)      CHK FOR GST PCT                               
         BZ    NTAXC40                                                          
         TM    1(RE),X'01'        SEE IF SALES TAX BASED ON NET                 
         BO    NTAXC40                                                          
*                                                                               
*        GET HERE WHEN PROPER ENTRY IS FOUND                                    
*                                                                               
NTAXC7   DS    0H                                                               
*        DUB = NET + SALES TAX % (NET + GST % OF NET)                           
*     SO DUB = NET + SALES TAX % (1+GST% X NET)                                 
*     SO DUB = NET + (SALES TAX % X (1+GST%)) NET                               
*     SO DUB = (1 + (SALES TAX % X (1+GST %))) X NET                            
*  THEREFORE NET = DUB DIVIDED BY (1+(SALES TAX % X (1+GST %)))                 
*                                                                               
         XC    FULL,FULL                                                        
         MVC   FULL+2(2),2(RE)   GST %                                          
         L     RE,FULL                                                          
         A     RE,=F'100000'     1 + GST % (3 DECIMALS)                         
         XC    FULL2,FULL2                                                      
         MVC   FULL2+1(3),PBDTAX-PBUYREC(RF)                                    
         L     RF,FULL2                                                         
         MR    RE,RE                                                            
         D     RE,=F'1000000' SINCE PBDTAX IS 4 DECIMALS                        
*                             RF = SALES TAX % X (1+GST%)                       
         A     RF,=F'100000'  RF = 1 + (SALES % X (1+GST%))                     
         ST    RF,FULL                                                          
         L     RF,DUB                                                           
         M     RE,=F'100000'                                                    
         SLDL  RE,1                                                             
         D     RE,FULL                                                          
         LTR   RF,RF                                                            
         BM    *+8                                                              
         AH    RF,=H'1'                                                         
         SRA   RF,1                                                             
         ST    RF,DUB            SHOULD NOW BE NET                              
         B     TAXC3                                                            
*                                                                               
*                                                                               
NTAXC40  DS    0H                                                               
         XC    FULL2,FULL2                                                      
         MVC   FULL2+1(3),PBDTAX-PBUYREC(RF)                                    
*                                                                               
         L     RE,FULL2           N+TAX= N + TAX PCT(N)                         
         A     RE,=F'1000000'     N = N+TAX/100.0000 + TAX PCT                  
         ST    RE,FULL2                                                         
*                                                                               
         L     RF,DUB                                                           
         M     RE,=F'1000000'                                                   
         SLDL  RE,1                                                             
         D     RE,FULL2            SINCE PBDTAX HAS 4 DECIMALS                  
         LTR   RF,RF                                                            
         BM    *+8                                                              
         AH    RF,=H'1'                                                         
         SRA   RF,1                                                             
         ST    RF,DUB                                                           
NTAXCX   DS    0H                                                               
         B     TAXC3             REST SAME AS TAXCALC                           
*                                                                               
TAXCALC  NTR1                     R4 POINTS TO NET                              
         MVC   DUB(4),0(R4)                                                     
TAXC3    XC    FULL,FULL                                                        
         L     RF,ADBUY                                                         
         OC    PBDTAX-PBUYREC(3,RF),PBDTAX-PBUYREC(RF)                          
         BZ    TAXCX                                                            
**GST                                                                           
         TM    PBDCNDA-PBUYREC(RF),X'80'     SEE IF CANADIAN BUY                
         BZ    TAXC8                                                            
         MVC   BYTE(1),PBDGST-PBUYREC(RF)                                       
         LA    RE,PGSTTAB                                                       
         CLI   BYTE,0                                                           
         BNE   *+8                                                              
         MVI   BYTE,C'S'           DEFAULT TO STANDARD                          
*                                                                               
TAXC4    CLC   0(1,RE),BYTE                                                     
         BE    TAXC5                                                            
TAXC4N   LA    RE,8(RE)                                                         
         CLI   0(RE),X'FF'                                                      
         BNE   TAXC4                                                            
         B     TAXC7              INVALID TAX CODE                              
*                                                                               
TAXC5    CLC   PBUYKDAT-PBUYREC(3,RF),4(RE)                                     
         BH    TAXC5E                                                           
         CLC   PBDPDATE-PBUYREC(3,RF),4(RE)                                     
         BH    TAXC5E                                                           
         B     TAXC4N           TRY FOR ANOTHER ENTRY                           
*                                                                               
TAXC5E   OC    2(2,RE),2(RE)      CHK FOR GST PCT                               
         BZ    TAXC7                                                            
*                                                                               
         TM    1(RE),X'01'        SEE IF TAX BASED ON NET                       
         BO    TAXC7              TREAT AS NO GST                               
*                                                                               
*        GET HERE WHEN PROPER ENTRY IS FOUND                                    
*                                                                               
         XC    FULL,FULL                                                        
         MVC   FULL+2(2),2(RE)                                                  
         L     RE,FULL                                                          
         L     RF,DUB                                                           
         MR    RE,RE                                                            
         SLDL  RE,1                                                             
         D     RE,=F'100000'          GST HAS 3 DECIMALS                        
         LTR   RF,RF                                                            
         BM    *+8                                                              
         AH    RF,=H'1'                                                         
         SRA   RF,1                                                             
         A     RF,DUB                 ADD GST TO DUB (NET)                      
         ST    RF,DUB                                                           
*                                                                               
TAXC7    XC    FULL,FULL                                                        
TAXC8    DS    0H                                                               
         L     RF,ADBUY                                                         
         MVC   FULL+1(3),PBDTAX-PBUYREC(RF)                                     
*                                                                               
         L     RE,FULL                                                          
         L     RF,DUB                                                           
         MR    RE,RE                                                            
         SLDL  RE,1                                                             
         D     RE,=F'1000000'      SINCE PBDTAX HAS 4 DECIMALS                  
         LTR   RF,RF                                                            
         BM    *+8                                                              
         AH    RF,=H'1'                                                         
         SRA   RF,1                                                             
         ST    RF,FULL            SALES TAX                                     
*                                                                               
TAXCX    XIT1                                                                   
***TAX                                                                          
*                                                                               
**GST                                                                           
*****  ++INCLUDE PGSTTAB                                                        
*                                                                               
*                                                                               
*   ENTRIES ARE GST CODE (1),BASIS,PCT (3 DECIMALS),START DATE,SPARE            
*        BASIS X'00' = SALES TAX BASED ON NET + GST                             
*              X'01' = SALES TAX BASED ON NET                                   
*                                                                               
PGSTTAB  DS    0H                                                               
         DC    C'S',X'00',H'5000',X'6C0101',X'00'      JAN/08                   
         DC    C'S',X'00',H'6000',X'6A0701',X'00'      JUL/06                   
         DC    C'S',X'00',H'7000',X'5B0101',X'00'      JAN/91                   
         DC    C'S',X'00',H'0000',X'000000',X'00'      JUL/1867                 
         DC    C'X',X'00',H'0000',X'6C0101',X'00'      JAN/08                   
         DC    C'X',X'00',H'0000',X'6A0101',X'00'      JUL/06                   
         DC    C'X',X'00',H'0000',X'5B0101',X'00'      JAN/91                   
         DC    C'X',X'00',H'0000',X'000000',X'00'      JUL/1867                 
         DC    C'Z',X'00',H'0000',X'6C0101',X'00'      JAN/08                   
         DC    C'Z',X'00',H'0000',X'6A0701',X'00'      JUL/06                   
         DC    C'Z',X'00',H'0000',X'5B0101',X'00'      JAN/91                   
         DC    C'Z',X'00',H'0000',X'000000',X'00'      JUL/1867                 
         DC    C'T',X'01',H'5000',X'6C0101',X'00'      JAN/08                   
         DC    C'T',X'01',H'6000',X'6A0701',X'00'      JUL/06                   
         DC    C'T',X'01',H'7000',X'5B0101',X'00'      JAN/91                   
         DC    C'T',X'01',H'0000',X'000000',X'00'      JUL/1867                 
         DC    X'FF'             END OF TABLE                                   
*                                                                               
*   ENTRIES ARE PROVINCE CODE (2)                                               
*        PST CODE (1),PCT (3 DECIMALS),START DATE,BASIS                         
*        BASIS X'00' = PST TAX BASED ON NET + GST                               
*              X'01' = PST TAX BASED ON NET                                     
*                                                                               
PPSTTAB  DS    0H                                                               
         DC    CL2'BC',C'H',AL2(12000),X'6E0701',X'01'  JUL/10                  
PPSTTABL EQU   (*-PPSTTAB)                                                      
         DC    CL2'ON',C'H',AL2(13000),X'6E0701',X'01'  JUL/10                  
         DC    CL2'NB',C'H',AL2(13000),X'6C0101',X'01'  JAN/08                  
         DC    CL2'NB',C'H',AL2(14000),X'6A0701',X'01'  JUL/06                  
         DC    CL2'NB',C'H',AL2(15000),X'610401',X'01'  APR/97                  
         DC    CL2'NF',C'H',AL2(13000),X'6C0101',X'01'  JAN/08                  
         DC    CL2'NF',C'H',AL2(14000),X'6A0701',X'01'  JUL/06                  
         DC    CL2'NF',C'H',AL2(15000),X'610401',X'01'  APR/97                  
         DC    CL2'NS',C'H',AL2(15000),X'6E0701',X'01'  JUL/10                  
         DC    CL2'NS',C'H',AL2(13000),X'6C0101',X'01'  JAN/08                  
         DC    CL2'NS',C'H',AL2(14000),X'6A0701',X'01'  JUL/06                  
         DC    CL2'NS',C'H',AL2(15000),X'610401',X'01'  APR/97                  
         DC    CL2'PQ',C'S',AL2(9975),X'710101',X'01'  JAN01/13                 
         DC    CL2'PQ',C'S',AL2(9500),X'700101',X'00'  JAN01/12                 
         DC    CL2'PQ',C'S',AL2(8500),X'6F0101',X'00'  JAN01/11                 
         DC    CL2'PQ',C'S',AL2(7500),X'620101',X'00'  JAN01/98                 
         DC    CL2'PQ',C'S',AL2(6500),X'5E0601',X'00'  JUN1/94                  
         DC    CL2'PQ',C'S',AL2(4000),X'5E0501',X'00'  MAY1/94                  
         DC    CL2'ZZ',C'Q',AL2(0000),X'5E0501',X'00' BILL BUT DON'T            
         DC    CL2'ZZ',C'S',AL2(0000),X'5E0501',X'00' PAY DEFAULT               
         DC    CL2'ZZ',C'X',AL2(0000),X'5E0501',X'00' RATES                     
         DC    CL2'ZZ',C'Z',AL2(0000),X'5E0501',X'00'                           
PPSTTABN EQU   (*-PPSTTAB)/PPSTTABL                                             
         SPACE 2                                                                
PROVTAB  DC    CL2'BC'             BRITISH COLUMBIA                             
         DC    CL2'AL'             ALBERTA                                      
         DC    CL2'SA'             SASKATCHEWAN                                 
         DC    CL2'MA'             MANITOBA                                     
         DC    CL2'ON'             ONTARIO                                      
         DC    CL2'PQ'             QUEBEC                                       
         DC    CL2'NB'             NEW BRUNSWICK                                
         DC    CL2'NS'             NOVA SCOTIA                                  
         DC    CL2'PE'             PRINCE EDWARD ISLAND                         
         DC    CL2'NF'             NEWFOUNDLAND                                 
         LTORG                                                                  
         EJECT                                                                  
         TITLE 'PPREPB102 -  FIRST FOR CLIENT'                                  
         SPACE 2                                                                
CFIRST   NMOD1 0,CFIRST                                                         
         LA    RC,SPACEND                                                       
*                                                                               
*        NOTE R7 AS SECOND BASE REGISTER FOR THIS ROUTINE                       
*                                                                               
         LA    R7,CFIRST+4095                                                   
         LA    R7,1(R7)                                                         
         USING CFIRST+4096,R7                                                   
         SPACE 2                                                                
         CLI   QMANUAL,C'G'      MANUAL BILL?                                   
         BE    CLT0                                                             
         CLI   QMANUAL,C'F'      MANUAL FEE?                                    
         BE    CLT0                                                             
         B     CLT1                                                             
*                                                                               
CLT0     CLI   UPDTSOON,C'Y'     UPDATIVE SOON?                                 
         BNE   CLT1                                                             
         BRAS  RE,UNLOCK         UNLOCK UPDATIVE SOON REQ                       
*                                                                               
*   UNLOCK HERE AS REQLAST MODE IS NOT ALWAYS PASSED FOR MANUAL BILLING         
*                                                                               
CLT1     DS    0H                                                               
         MVI   CLTRDSW,C'Y'          SET CLT READ FOR THIS REQUEST              
*                                    CHECKED AT REQLAST                         
         MVI   CLTSW,C'Y'            SET TO PROCESS THIS CLIENT                 
*                                    CLTSW IS SET TO 'N' IN AERRPROC            
*                                    IF ERR=PROFERR OR TYPERR                   
         XC    UPETABN,UPETABN       RESET UPETAB                               
*                                    FOR EACH CLIENT                            
*                               MUST REST MEDNM AT EACH CLIENT                  
*                               SINCE IT MIGHT HAVE BEEN ALTERED                
         L     RF,ADAGY                                                         
         MVC   MED,QMEDIA                                                       
         MVC   MEDNM,PAGYMED-PAGYREC(RF)                                        
         L     RF,ADCLT                                                         
         LA    R2,33(RF)                                                        
         MVI   ELCODE,X'41'                                                     
         BAS   RE,CNEXTEL                                                       
         BNE   *+10                                                             
         MVC   MEDNM,2(R2)                                                      
*                                                                               
         L     RF,ADCLT                                                         
         LA    R2,33(RF)                                                        
         MVI   PO#OPT,C'N'             SET DEFAULT TO NOT BILL BY PO#           
         MVI   PO#TYPE,0                                                        
         XC    PO#EFFD,PO#EFFD          CLEAR EFFECTIVE MOS                     
         MVC   PO#ANNO,SPACES                                                   
         MVC   PO#ANNO(3),=C'PO#'       DEFAULT ANNOTATION?                     
         MVI   ELCODE,X'52'        CHECK FOR PO# BILLING ELEMENT                
         BAS   RE,CNEXTEL                                                       
         BNE   CLT1C                                                            
****************                                                                
****     CODE BELOW NEED ACCESS TO THE PCLTPOEL                                 
****     NOT YET IN MY VERSION OF PCLTREC                                       
****     ONLY IN KEVIN'S                                                        
****                                                                            
****     USING PCLTPOEL,R2                                                      
****     MVI   PO#OPT,C'N'                                                      
****     TM    PCLTPOF1,P_POBILQ                                                
****     BZ    *+8                                                              
****     MVI   PO#OPT,C'Y'          BILLING BY PO#                              
****     MVC   PO#TYPE,PCLTPOLV     SAVE TYPE                                   
****     MVC   PO#EFFD,PCLTPOED     JUST SAVE Y/M - MOS                         
****     TM    PCLTPOF1,P_POLOVQ    SEE IF OVERRIDING PO# ANNO                  
****     BZ    *+16                                                             
****     MVC   PO#ANNO,PCLTPONM                                                 
****     OC    PO#ANNO,SPACES                                                   
         MVI   PO#OPT,C'N'                                                      
         TM    2(R2),X'80'                                                      
         BZ    *+8                                                              
         MVI   PO#OPT,C'Y'          BILLING BY PO#                              
         MVC   PO#TYPE,3(R2)        SAVE TYPE                                   
         MVC   PO#EFFD,4(R2)        JUST SAVE Y/M - MOS                         
         TM    2(R2),X'40'          SEE IF OVERRIDING PO# ANNO                  
         BZ    *+16                                                             
         MVC   PO#ANNO,8(R2)                                                    
         OC    PO#ANNO,SPACES                                                   
*                                                                               
CLT1C    CLI   RCLANG,4            SEE IF FRENCH                                
         BNE   CLT3                CHANGE NEWPAPERS TO JOURNAUX                 
         CLI   QMEDIA,C'N'                                                      
         BNE   CLT2                                                             
         MVC   MEDNM,=CL10'JOURNAUX'                                            
         B     CLT3                                                             
*                                                                               
CLT2     CLI   QMEDIA,C'O'       CHANGE OUTDOOR TO EXTERIOR                     
         BNE   CLT2D                                                            
         MVC   MEDNM,=CL10'EXTERIEUR'                                           
         B     CLT3                                                             
*                                                                               
CLT2D    CLI   QMEDIA,C'D'       CHANGE DIGITAL AUDIO TO LAUDIO                 
         BNE   CLT2L                                                            
         MVC   MEDNM,=CL10'AUDIO NUM.'                                          
         B     CLT3                                                             
*                                                                               
CLT2L    CLI   QMEDIA,C'L'       CHANGE SOCIAL TO SOCIAUX                       
         BNE   CLT2V                                                            
         MVC   MEDNM,=CL10'SOCIAUX'                                             
         B     CLT3                                                             
*                                                                               
CLT2V    CLI   QMEDIA,C'V'       CHANGE NAT. VIDEO TO VIDEO NAT.                
         BNE   CLT2W                                                            
         MVC   MEDNM,=CL10'VIDEO NAT.'                                          
         B     CLT3                                                             
*                                                                               
CLT2W    CLI   QMEDIA,C'W'       CHANGE LOC. VIDEO TO VIDEO LOC.                
         BNE   CLT3                                                             
         MVC   MEDNM,=CL10'VIDEO LOC.'                                          
         B     CLT3                                                             
*                                                                               
*        CHECK FOR SOME ABREVIATIONS                                            
*        SO I CAN DISPLAY THE FULL MEDIA NAME                                   
*                                                                               
CLT3     DS    0H                                                               
         MVC   MYMEDNM,SPACES     NOTE MYMEDNM IS 11 CHARACTERS                 
         MVC   MYMEDNM(10),MEDNM                                                
         CLC   MEDNM(10),=C'INTERACTIV'                                         
         BE    CLT3B                                                            
         CLC   MEDNM(9),=C'INTERACTV' COVERS INTERACTV AND INTERACTVE           
         BE    CLT3B                                                            
         CLC   MEDNM(6),=C'INTRAC'                                              
         BE    CLT3B                                                            
         B     CLT3C                                                            
*                                                                               
CLT3B    MVC   MYMEDNM,=C'INTERACTIVE'    11 CHARACTERS                         
*                                                                               
CLT3C    DS    0H                                                               
*                                                                               
         BRAS  RE,GPOB8              GET B8 PROFILE                             
********                             CHK FOR FINANCIAL CLIENT HERE              
********                             AND SET FINANSW TO X'01' IF YES            
         L     RF,ADCLT                                                         
         MVC   CLIENT,PCLTKCLT-PCLTREC(RF)                                      
         MVI   FINANSW,0                                                        
         CLI   PCLTFIN-PCLTREC(RF),C'Y'                                         
         BNE   *+8                                                              
         MVI   FINANSW,X'01'                                                    
*                                                                               
         MVI   MIDASSW,C'N'         ONLY SET FOR THESE AGENCIES                 
         CLC   QAGENCY,=C'H7'       OTHERS FOUND WITH THIS BIT ON               
         BE    CLT3C2                                                           
         CLC   QAGENCY,=C'SJ'                                                   
         BE    CLT3C2                                                           
         CLC   QAGENCY,=C'*B'                                                   
         BE    CLT3C2                                                           
         B     CLT3CX                                                           
*                                                                               
CLT3C2   TM    PCLTSTAT-PCLTREC(RF),X'40'                                       
         BZ    *+12                                                             
         MVI   MIDASSW,C'Y'    SET ON MIDAS SWITCH                              
         MVI   FINANSW,X'03'   $ TYPE COST2                                     
*                                                                               
*COST2*                                                                         
CLT3CX   MVI   CAROPTC,C'N'   CARAT OPT (CLIENT LEVEL)                          
         TM    PCLTSTAT-PCLTREC(RF),X'08'   COST2 FACTOR CLT?                   
         BNO   *+12                                                             
         MVI   CAROPTC,C'Y'                                                     
         MVI   FINANSW,X'80'   SPECIAL VALUE FOR CARAT STYLE                    
*                              COST2 CLIENTS                                    
         TM    PCLTSTAT-PCLTREC(RF),X'04'    COST2 $ CLIENT                     
         BNO   *+8            (RJ PALMER STYLE)                                 
         MVI   FINANSW,X'03'  TREAT JUST LIKE FINANCIAL                         
*COST2*                                                                         
***R***                                                                         
         CLC   QPROG,=C'R1'   FINANCIAL REBATE ONLY FOR FINANCIAL CLTS          
         BE    CLTF0                                                            
         CLC   QPROG,=C'RD'  FINANCIAL REBATE DRAFT                             
         BNE   CLTF0A                                                           
CLTF0    TM    FINANSW,X'01'   ONLY FOR FINANCIAL CLIENTS                       
         BO    CLTF0A                                                           
         MVC   ERRPROF,SPACES        NO PROFILE INVOLVED                        
         MVI   ERR,PROFERR                                                      
         BRAS  RE,ERRPROC                                                       
         B     CLXFX                                                            
***R***                                                                         
*                                                                               
CLTF0A   DS    0H                                                               
         MVI   WMSW,C'N'             SET OFF WALMART SWITCH                     
         MVI   PGSW,C'N'             SET OFF P&G SWITCH                         
         MVI   FOXSW,C'N'            SET OFF FOX SWITCH                         
         MVI   H7ATTSW,C'N'          SET OFF H7 ATT SWITCH                      
         MVI   PUSRSW,C'N'           SET OFF PRD USER CONTROL                   
         MVI   UCOMMSW,C'N'          SET OFF UCOMM REQUIRED                     
         MVI   UDEFESW,X'00'         SET OFF EST UDEFS REQUIRED                 
         MVI   ATTSW,C'N'            SET OFF AT&T SW                            
*                                                                               
*                                                                               
CLTF0AX  L     RF,ADCLT                                                         
         TM    PCLTSTAT-PCLTREC(RF),X'80'  EST UCOMM REQUIRED?                  
         BNO   *+8                                                              
         MVI   UCOMMSW,C'Y'                                                     
         MVI   MSSW,C'N'       DEFAULT - IN FEST - NO EST USER FLDS             
         MVI   OUWBSW,C'N'     SET OFF OU WARNER BROS. PRD USER SW              
*                                                                               
         CLC   QAGENCY,=C'OU'    SEE IF OMDTOA                                  
         BNE   CLTF0AX2                                                         
         CLC   CLIENT,=C'WH1'        WARNER BROS. CLT                           
         BE    CLTF0AX1                                                         
         CLC   CLIENT,=C'WT1'        WARNER BROS. CLT                           
         BE    CLTF0AX1                                                         
         B     CLTF0AX2                                                         
*                                                                               
CLTF0AX1 MVI   OUWBSW,C'Y'           SET ON SPECIAL WB PRD USER SWITCH          
*                                                                               
*        TEMPORARILY SET TO N TO NO-OPT THIS FEATURE                            
*        WILL BE Y IN THE FUTURE                                                
*                                                                               
**WB**                                                                          
CLTF0AX2 MVI   WBSW,C'N'             SET OFF WB FLIGHT FEATURE                  
         MVI   SVWBSW,C'N'                                                      
**WB**                                                                          
*                                                                               
*        CLC   QAGENCY,=C'TC'        TRAINING CENTER?                           
*        BNE   CLTF0C                                                           
*        CLC   CLIENT,=C'PGT'       P&G TESTING                                 
*        BE    CLTF0P                                                           
*        B     CLTF0X                                                           
*                                                                               
CLTF0C   CLC   QAGENCY,=C'SJ'        SJR FOR TESTING                            
         BE    CLTF0CT                                                          
         CLC   QAGENCY,=C'W+'        METEST TESTING (WAS M+)                    
*        BE    CLTF0CT                                                          
*        CLC   QAGENCY,=C'*B'        DDSB FOR TESTING                           
         BNE   CLTF0H                                                           
*        FOR WALMART FEATURE                                                    
*        TO WORK PROPERLY PRODUCTS SHOULD BE TOGETHER                           
*        AND ESTIMATES SEPARATE                                                 
*        PRODUCT USER ONE SHOULD BE SET TO AGENCY#                              
*        'SHOW ON BILLS' SHOULD BE H                                            
*        AND ENTERED FOR ALL PRODUCTS (003129 FOR MEDIAVEST)                    
*        ESTIMATE USER 1 SHOULD BE SET TO ACCOUNT #                             
*        'SHOW ON BILLS' SHOULD BE F                                            
*        AND ENTERED FOR EACH ESTIMATE                                          
*                                                                               
CLTF0CT  CLC   CLIENT,=C'WMT'        WALMART TESTING                            
         BE    CLTF0PW                                                          
*NOFOX*  CLC   CLIENT,=C'FOX'        FOR FOX TESTING  (NO-OPED)                 
*NOFOX*  BE    CLTF0PFX                                                         
*NOHAR*  CLC   CLIENT,=C'HAR'        FOR HARRAH'S TESTING                       
*NOHAR*  BE    CLTF0PHR                                                         
**WB**                                                                          
         CLC   CLIENT,=C'WBF'        WB FLIGHT TESTING                          
         BE    CLTF0WB                                                          
         CLC   CLIENT,=C'WB8'        REALLY JUST FOR W+                         
         BE    CLTF0WB                                                          
         CLC   CLIENT,=C'WH8'        REALLY JUST FOR W+                         
         BE    CLTF0WB                                                          
         CLC   CLIENT,=C'WP8'        REALLY JUST FOR W+                         
         BE    CLTF0WB                                                          
**WB**                                                                          
         B     CLTF0X                                                           
*                                                                               
CLTF0H   CLC   QAGENCY,=C'H9'        STARCOM?                                   
         BNE   CLTF0L                                                           
*        CLC   CLIENT,=C'PG '                                                   
*        BE    CLTF0P                                                           
*        CLC   CLIENT,=C'PG1'                                                   
*        BE    CLTF0P                                                           
         CLC   CLIENT,=C'PGB'                                                   
         BE    CLTF0P                                                           
*        CLC   CLIENT,=C'PGN'                                                   
*        BE    CLTF0P                                                           
*        CLC   CLIENT,=C'PGO'         ADDED 7/10/03                             
*        BE    CLTF0P                                                           
         CLC   CLIENT,=C'HPG'         TAPESTRY - ADDED 10/10/05                 
         BE    CLTF0P                                                           
*        CLC   CLIENT,=C'PGG'         GILLETTE - ADDED 09/19/06                 
*        BE    CLTF0P                                                           
         CLC   CLIENT,=C'WMT'         WALMART - SET WMSW                        
         BE    CLTF0PW                                                          
         B     CLTF0X                                                           
*                                                                               
CLTF0L   CLC   QAGENCY,=C'FG'        LETO - CANADIAN TESTING                    
         BNE   CLTF0O                                                           
         CLC   CLIENT,=C'P&&G'                                                  
         BE    CLTF0P                                                           
         B     CLTF0X                                                           
*                                                                               
CLTF0O   CLC   QAGENCY,=C'O0'        STARCOM TORONTO?                           
         BNE   CLTF0O5                                                          
         CLC   CLIENT,=C'PGM'                                                   
         BE    CLTF0P                                                           
         B     CLTF0X                                                           
*                                                                               
CLTF0O5  DS    0H                                                               
*                      NOTE - MORE CHECKS FOR AGENCY H7 AT CLTF0X               
         CLC   QAGENCY,=C'H7'    MINDSHARE                                      
         BNE   CLTFO07                                                          
         CLC   QCLIENT(2),=C'ATA' CERTAIN AT&T CLIENTS                          
         BE    CLTF0ATT                                                         
         CLC   QCLIENT(2),=C'ATE' CERTAIN AT&T CLIENTS                          
         BE    CLTF0ATT                                                         
         CLC   QCLIENT(2),=C'ATF' CERTAIN AT&T CLIENTS                          
         BE    CLTF0ATT                                                         
         CLC   QCLIENT(2),=C'ATM' CERTAIN AT&T CLIENTS                          
         BE    CLTF0ATT                                                         
         B     CLTF0X                                                           
*                                                                               
CLTFO07  CLC   QAGENCY,=C'TH'    ZENITH                                         
         BNE   CLTF0X                                                           
**NOFOX  CLC   QCLIENT,=C'TCF'  20TH CENTURY FOX                                
**NOFOX  BE    CLTF0PFX         SET FOX PROCESSING                              
         B     CLTF0X                                                           
*                                                                               
*                                                                               
CLTF0ATT MVI   H7ATTSW,C'Y'      SET ON H7ATTSW TO USE BIGTOTS                  
         MVI   ATTSW,C'Y'                                                       
         B     CLTF0XX                                                          
*                                                                               
CLTF0P   MVI   PGSW,C'Y'             SET FOR P&G PROCESSING                     
         B     CLTF0X                                                           
CLTF0PW  MVI   WMSW,C'Y'             SET FOR WALMART PROCESSING                 
         B     CLTF0X                                                           
CLTF0PFX MVI   FOXSW,C'Y'        Y - SET FOR FOX PROCESSING                     
         B     CLTF0X                                                           
CLTF0PHR MVI   PUSRSW,C'Y'       Y - SET PRD USER CONTROL (TESTING)             
         B     CLTF0X                SET FOR SJR CLIENT HAR                     
*                                    WILL ALSO BE SET IF PRD USER               
*                                    CONTROLS ARE SET TO APPEAR                 
*                                    ON FRONT OF BILL                           
**WB**                                                                          
CLTF0WB  MVI   WBSW,C'Y'            SET FOR WB FLIGHT PROCESSING                
         MVI   SVWBSW,C'Y'          SAVE ORIGINAL VALUE                         
         B     CLTF0XX                                                          
**WB**                                                                          
*                                                                               
CLTF0X   DS    0H                                                               
*                              FOR ESTIMATES TOGETHER                           
         CLC   QAGENCY,=C'H7'       MINDSHARE?                                  
         BNE   CLTF0X3                                                          
         CLC   CLIENT,=C'NXN'     ONLY FOR NEXTEL CLIENT CODES                  
         BE    CLTF0X4                                                          
         CLC   CLIENT,=C'NXS'     ONLY FOR NEXTEL CLIENT CODES                  
         BE    CLTF0X4                                                          
         CLC   CLIENT,=C'NXW'     ONLY FOR NEXTEL CLIENT CODES                  
         BE    CLTF0X4                                                          
         CLC   CLIENT,=C'KK '     ALSO CLIENT KK                                
         BE    CLTF0X4                                                          
*                                                                               
         CLI   QMEDIA,C'O'        ALSO CLIENT NV FOR MEDIA O,M,N                
         BE    CLTF0X2                                                          
         CLI   QMEDIA,C'N'        ALSO CLIENT NV FOR MEDIA O,M,N                
         BE    CLTF0X2                                                          
         CLI   QMEDIA,C'M'        ALSO CLIENT NV FOR MEDIA O,M,N                
         BE    CLTF0X2                                                          
         CLI   QMEDIA,C'I'        NVE FOR INTERACTIVE                           
         BNE   CLTF0X8            GO CHECK FURTHER H7 CLTS                      
         CLC   CLIENT,=C'NVE'                                                   
         BE    CLTF0X4                                                          
         B     CLTF0X8                                                          
*                                                                               
CLTF0X2  CLC   CLIENT,=C'NV '                                                   
         BE    CLTF0X4                                                          
         B     CLTF0X8                                                          
*                                                                               
CLTF0X3  CLC   QAGENCY,=C'YN'    YNRO - CHECK FOR CLIENT NVM AND NIM            
         BNE   CLTF0X5                                                          
         CLC   CLIENT,=C'NVM'    NOVARTIS CLIENT                                
         BE    CLTF0X4                                                          
         CLC   CLIENT,=C'NIM'    NOVARTIS CLIENT                                
         BE    CLTF0X4                                                          
         B     CLTF0XX                                                          
*                                                                               
CLTF0X4  MVI   MSSW,C'Y'         SHOW ESTIMATE USER FIELDS IN FEST              
         B     CLTF0XX           EVEN IF ESTIMATES TOGETHER                     
*                                                                               
CLTF0X5  DS    0H                                                               
         CLC   QAGENCY,=C'PC'     OPTIMEDIA?                                    
         BNE   CLTF0X6                                                          
         CLI   QMEDIA,C'M'    MAGAZINES                                         
         BE    CLTF0X5M                                                         
         CLI   QMEDIA,C'N'    NEWSPAPERS                                        
         BE    CLTF0X5M                                                         
         CLI   QMEDIA,C'O'    OUTDOOR                                           
         BE    CLTF0X5M                                                         
         CLI   QMEDIA,C'I'    INTERACTIVE?                                      
         BNE   CLTF0XX                                                          
         CLC   CLIENT,=C'SPN'  ONLY THESE CLIENTS                               
         BE    CLTF0X4                                                          
         CLC   CLIENT,=C'SPZ'                                                   
         BE    CLTF0X4                                                          
         B     CLTF0XX                                                          
*                                                                               
CLTF0X5M DS    0H              OSZNY CLIENTS FOR MEDIA M,N,O                    
         CLC   CLIENT,=C'SPA'                                                   
         BE    CLTF0X4                                                          
         CLC   CLIENT,=C'SPC'                                                   
         BE    CLTF0X4                                                          
         CLC   CLIENT,=C'SPM'                                                   
         BE    CLTF0X4                                                          
         CLC   CLIENT,=C'SPN'                                                   
         BE    CLTF0X4                                                          
         CLC   CLIENT,=C'SPO'                                                   
         BE    CLTF0X4                                                          
         CLC   CLIENT,=C'SPS'                                                   
         BE    CLTF0X4                                                          
         CLC   CLIENT,=C'SPV'                                                   
         BE    CLTF0X4                                                          
         CLC   CLIENT,=C'SPW'                                                   
         BE    CLTF0X4                                                          
         CLC   CLIENT,=C'SPZ'                                                   
         BE    CLTF0X4                                                          
         B     CLTF0XX                                                          
*                                                                               
CLTF0X6  DS    0H                                                               
         CLC   QAGENCY,=C'M2'       MEDIACOM?                                   
         BNE   CLTF0X8                                                          
         CLC   QCLIENT,=C'WB8'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WP8'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WR8'      WARNER BROS. TERRY HINES THEATRICAL         
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WL8'      WARNER BROS. TERRY HINES THEATRICAL         
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WO8'      WARNER BROS. TERRY HINES THEATRICAL         
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WT8'      WARNER BROS. TERRY HINES THEATRICAL         
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WU8'      WARNER BROS. TERRY HINES THEATRICAL         
         BE    CLTF0WB                                                          
*  2009 CODES                                                                   
         CLC   QCLIENT,=C'WA9'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WB9'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WC9'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WP9'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WR9'      WARNER BROS. TERRY HINES THEATRICAL         
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WL9'      WARNER BROS. TERRY HINES THEATRICAL         
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WO9'      WARNER BROS. TERRY HINES THEATRICAL         
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WT9'      WARNER BROS. TERRY HINES THEATRICAL         
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WU9'      WARNER BROS. TERRY HINES THEATRICAL         
         BE    CLTF0WB                                                          
         B     CLTF0XX                                                          
*                                                                               
CLTF0X8  DS    0H                                                               
         CLC   QAGENCY,=C'H7'       MINDSHARE                                   
         BNE   CLTF0X9                                                          
         CLC   QCLIENT,=C'WB9'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WP9'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         B     CLTF0XX                                                          
CLTF0X9  DS    0H                                                               
         CLC   QAGENCY,=C'OO'       OMD                                         
         BNE   CLTF0XX                                                          
         XC    WK,WK                                                            
         XC    WORK,WORK                                                        
OFF      USING OFFICED,WORK                                                     
         MVI   OFF.OFCSYS,C'P'                 NEED SYSTEM                      
         MVC   OFF.OFCAGY,QAGENCY              AGENCY                           
         L     R2,ADCLT                                                         
         MVC   OFF.OFCOFC,PCLTOFF-PCLTREC(R2)  ANY OFFICE                       
         MVC   OFF.OFCCLT,PCLTKCLT-PCLTREC(R2) AND THE CLIENT                   
         DROP  OFF                                                              
*                                                                               
         XC    DMCB(4),DMCB                                                     
         MVC   DMCB+4(3),=X'D9000A'                                             
         MVI   DMCB+7,QOFFICER                                                  
         L     RF,VCOMFACS                                                      
         L     RF,(CCALLOV-COMFACSD)(RF)                                        
         GOTO1 (RF),DMCB                                                        
         CLI   4(R1),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         L     RF,DMCB                                                          
         GOTO1 (RF),DMCB,(C'2',WORK),(X'01',VCOMFACS),(C'S',WK)                 
*                                                                               
         CLC   =C'WB',WK                                                        
         BE    CLTF0WB                                                          
         CLC   =C'RH',WK                                                        
         BE    CLTF0WB                                                          
         CLC   =C'XW',WK                                                        
         BE    CLTF0WB                                                          
*&&DO                                                                           
         CLC   QCLIENT,=C'WBD'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WB2'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WB3'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WB4'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WBV'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WR2'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WR3'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WR4'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WR5'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WC2'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WB6'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WB8'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WBJ'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WBN'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WH9'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WNO'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WHO'      WARNER BROS.                                
         BE    CLTF0WB                                                          
*                                                                               
         CLI   QMEDIA,C'I'          ONLY FOR INTERACTIVE                        
         BNE   *+14                                                             
         CLC   QCLIENT,=C'WR6'      WARNER BROS.                                
         BE    CLTF0WB                                                          
*                                                                               
         CLI   QMEDIA,C'O'          ONLY FOR OUTDOOR                            
         BNE   CLTF0XX                                                          
         CLC   QCLIENT,=C'WP2'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WP3'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WP4'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WP5'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WP6'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WP7'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         CLC   QCLIENT,=C'WP8'      WARNER BROS.                                
         BE    CLTF0WB                                                          
         B     CLTF0XX                                                          
*&&                                                                             
**TF0X9  DS    0H                                                               
***      CLC   QAGENCY,=C'UB'       CARLA - CARAT SANTA MONICA                  
***      BNE   CLTF0XX                                                          
***      CLC   QCLIENT,=C'DIZ'      DISNEY                                      
***      BE    CLTF0X4              SET ON MSSW                                 
***      B     CLTF0XX                                                          
*                                                                               
CLTF0XX  DS    0H                                                               
*                                                                               
CLTF1    CLI   RCMULTIQ,C'Y'        SEE IF DOING MULTI-MEDIA REQ                
         BNE   CLTF2                                                            
*                                                                               
         CLC   FMULTMED,QMEDIA   SEE IF FIRST MEDIA                             
         BE    CLTF2                                                            
*****    CLI   QMEDIA,C'M'                                                      
*****    BE    CLTF2            ONLY CLEAR BRKTAB FOR FIRST MEDIA               
         CLI   SETDSW,C'Y'                                                      
         BE    CLTF4                                                            
*                               ON MULTI-MEDIA REQS                             
*                               AND DONT GO TO AAGMPROC                         
*                               IF DATE ALREADY SET IN CLTF                     
CLTF2    XC    BRKTAB,BRKTAB                                                    
         MVC   PAGE,=H'1'       RESET PAGE FOR NON-MULTIMEDIA REQS              
         CLI   QCLIENT,C'*'      SEE IF OFFICE REQUEST                          
         BE    CLTF2A                                                           
         CLI   QCLIENT,C'&&'     SEE IF BILLING GROUP REQUEST                   
         BNE   *+10                                                             
CLTF2A   MVC   QEND,SQEND         MUST RESET QEND SAVED AT REQFRST              
*                                 SO SETDATE WILL NOT THINK IT'S                
*                                 ONLY DOING ONE MONTH                          
*                                                                               
         CLC   QAGENCY(6),QSAVE+2       AGY/MED/CLT BREAK                       
         BE    CLTF2C                                                           
         BRAS  RE,AGMPROC            GET AGM BILLING PROFILE                    
*                                                                               
CLTF2C   CLI   RCMULTIQ,C'Y'                                                    
         BNE   CLTF2T                                                           
         CLI   AGMSEQ,C'A'                                                      
         BE    CLTF2T                                                           
         DC    H'0'        MULTI-MEDIA REQ MUST SEQ ACROSS MEDIA                
*                                                                               
CLTF2T   DS    0H                  GET STARTING INVNO                           
         CLC   SVAGMINV,AGMSTANO   TEST CHANGE OF INVNO CTLS                    
         BE    *+14                                                             
         MVC   SVAGMINV,AGMSTANO                                                
         B     CLTF3D                                                           
*                                                                               
         CLC   SVAGMOCT,AGMOCTL    SEE IF AGMOCTL HAS CHANGED                   
         BNE   CLTF3D              YES                                          
*                                                                               
         CLI   AGMOCTL,0           IF DOING BY OFFICE                           
         BE    CLTF2V                                                           
         L     RF,ADCLT                                                         
         CLC   SVOFF,PCLTOFF-PCLTREC(RF) AND OFFICE HAS CHANGED                 
         BNE   CLTF3D                    GET NEW STARTING INVNO                 
*                                                                               
****                                CODE MOVED FROM AFTER CLTF5                 
CLTF2V   DS    0H                                                               
CLTF3    DS    0H                                                               
         CLC   QSAVE(2),QPROG         FIRST TIME                                
         BNE   CLTF3D              YES                                          
**                                                                              
         CLI   RCMULTIQ,C'Y'       SEE IF DOING MULTIMEDIA REQ                  
         BNE   CLTF3A                                                           
         CLI   SETDSW,C'N'         SEE IF FIRST MEDIA ENCOUNTERED               
         BE    CLTF3D              YES                                          
**                NOTE AGMSEQ MUST BE "A" FOR MULTI MEDIA REQS                  
**                                                                              
CLTF3A   CLI   AGMSEQ,C'C'         TEST SEQ BY CLIENT                           
         BE    CLTF3D                                                           
         CLI   AGMSEQ,C'D'         TEST SEQ BY CLIENT ACROSS MEDIA              
         BE    CLTF3D                                                           
         CLC   QMEDIA,QSAVE+4                                                   
         BE    CLTF3C              MUST STILL GO TO GETNUM                      
         CLI   AGMSEQ,C'M'                                                      
         BE    CLTF3D                                                           
*                                  REDO INV NO TO GET RIGHT MEDIA               
CLTF3C   MVC   W(2),TODAYB         SET MONTH FOR GETNUM                         
         GOTOR GETNUM,DMCB,(1,INVNO),PINVNO                                     
         B     CLTF3F                                                           
CLTF3D   DS    0H                  GET FIRST INVOICE NO.                        
         XC    INVNO,INVNO                                                      
         GOTOR GETNUM,DMCB,INVNO,PINVNO                                         
*                                                                               
CLTF3F   DS    0H                                                               
         OC    INVNO,INVNO         IF NO INVOICE NUMBER                         
         BNZ   CLTF3X             (DUE TO ERROR)                                
         GOTOR GETNUM,DMCB,INVNO,PINVNO    GET ONE NOW                          
*                                                                               
CLTF3X   L     RF,ADCLT       SAVE OFFICE AND AMGOCTL                           
*                             DO HERE AFTER GETNUM CALLS                        
         MVC   SVOFF,PCLTOFF-PCLTREC(RF)                                        
         MVC   SVAGMOCT,AGMOCTL                                                 
*                                                                               
CLTF4    DS    0H                                                               
         LA    RF,SVAADDRS              RESTORE SAVE CORP ADDR                  
         L     RE,=A(AADDRS)                                                    
         MVC   0(L'SVAADDRS/2,RE),0(RF)                                         
         MVC   L'SVAADDRS/2(L'SVAADDRS/2,RE),L'SVAADDRS/2(RF)                   
*                                                                               
         CLC   QAGENCY(6),QSAVE+2       CLIENT BREAK                            
         BE    CLTF8                                                            
***                                                                             
***  NOTE - FOR MULTI-MEDIA REQS AAA FORMULAS + ADDRS ARE GOTTEN                
***         ONLY FOR FIRST MEDIA - MAGAZINES                                    
***         SINCE CLIENT IS THE SAME                                            
*                                  READ AAA PRDHDR                              
*                                  FOR ADDRESS AND FORMULA                      
         L     R0,=A(AADDRS)                                                    
         LHI   R1,ADDRLEN                                                       
         SR    RE,RE                                                            
         LA    RF,X'40'                 FILL WITH SPACES                        
         SLL   RF,24                                                            
         MVCL  (R0),(RE)                                                        
*                                                                               
         XC    AAAFORM,AAAFORM                                                  
***      XC    AAAFORM2,AAAFORM2                                                
***      XC    AAAFORM3,AAAFORM3                                                
         L     RF,AAELIST                                                       
         MVC   0(6,RF),FFS                                                      
         MVC   KEY1,KEY                                                         
*                                                                               
         BRAS  RE,GETPROFS                                                      
*                                                                               
         NI    FLAG1,X'FF'-AADDRSW INIT AAA BILL ADDRESS REC FOUND              
         MVC   THREE,=C'AAA'                                                    
         CLI   BILLADR,C'Y'        B8 PR3 READ BILL ADDRESS REC?                
         BNE   *+8                                                              
         BRAS  RE,RBILADDR         READ BILL ADDRESS REC                        
*                                                                               
CLTF401A L     RF,ADCLT                                                         
         MVC   KEY(25),0(RF)                                                    
         MVI   KEY+3,X'06'                                                      
         MVC   KEY+7(3),=C'AAA'                                                 
         GOTO1 HIGH                                                             
         CLC   KEY(25),KEYSAVE                                                  
         BNE   CLTF5                                                            
         MVC   AREC,ADWKREC        READ INTO WORK REC                           
         GOTO1 GETPRT                                                           
         L     RF,AREC                                                          
         LA    RF,PPRDBILL-PPRDREC(RF)                                          
         CLC   =C'NONE',0(RF)                                                   
         BE    CLTF4A                                                           
         CLC   =C'XX',0(RF)                                                     
         BE    CLTF4A                                                           
         CLC   =C'X ',0(RF)                                                     
         BE    CLTF4A                                                           
         CLI   0(RF),C'A'                                                       
         BL    CLTF4A                                                           
*                                                                               
         L     RE,=A(AADDRS)       CORP ADDRESS                                 
         TM    FLAG1,AADDRSW       AAA BILL ADDRESS REC FOUND?                  
         BO    CLTF402A                                                         
         MVC   000(20,RE),00(RF)                                                
         MVC   060(30,RE),20(RF)                                                
         MVC   120(30,RE),50(RF)                                                
         MVC   180(24,RE),80(RF)                                                
**NEW 3/7/89                                                                    
*                        CHECK FOR SECOND BILL RECEIPT NAME LINE                
*                                                                               
CLTF402A L     R1,AREC              DID USE RE  NOW USE R1                      
         LA    R1,PPRDBIL2-PPRDREC(R1)  AND LEAVE RE SET TOAAADDRS              
*                                       RF IS STILL SET TO PPRDBILL             
         CLI   0(R1),C'A'                                                       
         BL    CLTF4A                                                           
         CLC   =C'NONE',0(R1)                                                   
         BE    CLTF4A                                                           
         CLC   =C'XX',0(R1)                                                     
         BE    CLTF4A                                                           
         CLC   =C'X ',0(R1)                                                     
         BE    CLTF4A                                                           
         TM    FLAG1,AADDRSW       AAA BILL ADDRESS REC FOUND?                  
         BO    CLTF4A                                                           
         MVC   060(60,RE),SPACES      CLEAR                                     
         MVC   060(20,RE),0(R1)                                                 
         MVC   120(30,RE),20(RF)                                                
         MVC   180(30,RE),50(RF)                                                
         MVC   240(24,RE),80(RF)                                                
**NEW 3/7/89                                                                    
*                                                                               
CLTF4A   DS    0H                                                               
*                                                                               
******   CLI   BFROPT,C'N'      SEE IF USING BILLING FORMULA RECORDS            
******   BNE   CLTF5            YES - THE DON'T BUILD AAA EST LIST              
*                               OR SET AAAFORM                                  
*                                                                               
         L     RF,AREC                                                          
         MVC   AAAFORM,PPRDBILP-PPRDREC(RF)    DATE, BASE + COMMISSION          
***      MVC   AAAFORM2,PPRDBILP+37-PPRDREC(RF)   2ND FORMULA + DATE            
***      MVC   AAAFORM3,PPRDBILP+44-PPRDREC(RF)   3ND FORMULA + DATE            
*                                                                               
*                                  BUILD LIST OF ANY AAA EST FORMULAS           
         L     R6,AAELIST          START                                        
         L     RF,AREC                                                          
         MVC   KEY,0(RF)                                                        
         MVI   KEY+3,7                                                          
CLTF4B   DS    0H                                                               
         GOTO1 SEQ                                                              
         CLC   KEY(10),KEYSAVE                                                  
         BNE   CLTF5               DONE                                         
*                                                                               
         GOTO1 GETREC                                                           
         L     RF,AREC                                                          
         MVC   0(2,R6),10(RF)      EST NO.                                      
         MVC   2(37,R6),PESTBILP-PESTREC(RF)    FORMULA                         
         OC    2(37,R6),2(R6)                                                   
         BZ    CLTF4D                                                           
         OC    2(5,R6),2(R6)                                                    
         BNZ   CLTF4D                                                           
         MVC   2(2,R6),=X'0505'              SET DEFAULT                        
*                                     IF CHAB WITH NO FORMULA                   
*                                                                               
CLTF4D   MVC   39(14,R6),PESTREVN+3-PESTREC(RF)    FORMULAS 2 + 3               
*                                                                               
**             2ND AND 3RD FORMULAS                                             
*                                                                               
         LA    R6,53(R6)                                                        
         MVC   0(6,R6),FFS         SET EOL                                      
         L     RE,AAELIST                                                       
         AH    RE,=H'5300'         MAX 100 ESTS                                 
         CR    R6,RE                                                            
         BL    CLTF4B                                                           
         DC    H'0'                TABLE FULL                                   
*                                                                               
CLTF5    DS    0H                                                               
         LA    RF,SVAADDRS         SAVE CORP ADDR                               
         L     RE,=A(AADDRS)                                                    
         MVC   0(L'SVAADDRS/2,RF),0(RE)                                         
         MVC   L'SVAADDRS/2(L'SVAADDRS/2,RF),L'SVAADDRS/2(RE)                   
*                                                                               
         CLI   BFROPT,C'Y'         SEE IF SFM BILLING FORMULAS                  
         BNE   CLTF5F                                                           
*                                                                               
         NI    DMINBTS,X'F7'      NO DELETES                                    
*                                                                               
         XC    KEY,KEY                                                          
         L     RF,ADCLT                                                         
         MVC   KEY(7),0(RF)       AGY/MED/CODE/CLT                              
         MVI   KEY+3,X'4C'        SFM BILL FORMULA REC                          
         GOTO1 HIGH                                                             
*                                                                               
         OI    DMINBTS,X'08'      RESET TO PASS DELETES                         
*                                                                               
         CLC   KEY(7),KEYSAVE                                                   
         BE    CLTF5F                                                           
*                                                                               
         MVC   ERRPROF,=C'B1X12'                                                
         MVI   ERR,PROFERR       IF NO SFM FORMULA RECS                         
         BRAS  RE,ERRPROC        SEND INVALID BILLING PROFILE                   
         B     CLXFX                                                            
*                                                                               
CLTF5F   DS    0H                                                               
         MVC   KEY,KEY1                                                         
         GOTO1 HIGH                RESTORE SEQ                                  
*                                                                               
CLTF6    DS    0H                                                               
*                                                                               
CLTF8    DS    0H                                                               
CLTF10   DS    0H                                                               
*                                       CHECK FOR MANUAL AMOUNTS                
         XC    MANUALS,MANUALS                                                  
         XC    EXDATE,EXDATE                                                    
         MVI   MRDASS,C'N'        SET OFF SPECIAL REG/DST SWITCH                
***                                                                             
*******  CLC   QAGENCY,=C'SJ'       SPECIAL FOR SJR                             
*******  BNE   CF10A                                                            
*******  CLC   QPUB+1(6),=C'RD=SDK'    SEE IF SPECIAL DRD SCHEME                
*******  BNE   CF10A                                                            
*******  MVI   MRDASS,C'Y'   ALLOWS REGIONS SEPARATE FOR MULTIPLE               
*******  MVC   EXDATE,TODAYB       NEED TO EXCLUDE TODAY'S BILLING              
*******  B     CLTF10A                                                          
*                                  TO BILL PROPERLY                             
CF10A    DS    0H                                                               
*******  CLC   QAGENCY,=C'WI'       SPECIAL FOR WESTERN                         
*******  BNE   CLTF10A                                                          
*******  CLC   QPUB+1(6),=C'RD=BXX'    SEE IF SPECIAL DRD SCHEME                
*******  BNE   CLTF10A                                                          
*******  MVI   MRDASS,C'Y'   ALLOWS REGIONS SEPARATE FOR MULTIPLE               
*******  MVC   EXDATE,TODAYB       NEED TO EXCLUDE TODAY'S BILLING              
*                                  TO BILL PROPERLY                             
*                                                                               
* CODE ABOVE WAS TO HANDLE BELL SOUTH BILLING NEED                              
*                                                                               
CLTF10A  DS    0H                                                               
         MVC   RD1OPT,QOPT9             RETAIL DRAFT BILLING CONTROL            
*                                                                               
         MVI   NONRET,C'N'                                                      
         MVI   PREVSW,0                                                         
         CLI   RETDRAFT,C'Y'                                                    
         BNE   *+8                                                              
         MVI   PREVSW,C'N'              NO PREV FOR RETAIL DRAFT                
         CLC   =C'ONLY PREV',QMANUAL    ONLY PREV BILLS                         
         BNE   CLTF10B                                                          
         MVI   PREVSW,C'P'                                                      
         B     CLTF50                                                           
CLTF10B  DS    0H                                                               
         CLC   =C'PREV',QMANUAL                                                 
         BNE   CLTF10C                                                          
         MVI   PREVSW,C'Y'                                                      
         B     CLTF50                                                           
CLTF10C  DS    0H                                                               
         CLC   =C'NO PREV',QMANUAL NO PREVIOUS BILLS                            
         BNE   CLTF10D                                                          
         MVI   PREVSW,C'N'                                                      
         B     CLTF50                                                           
CLTF10D  DS    0H                                                               
         CLI   QMANUAL,C'X'       TO EXCULDE BILLING ON THIS DATE               
         BNE   CLTF10E                                                          
         GOTO1 DATCON,DMCB,QMANUAL+1,(3,EXDATE)                                 
         B     CLTF50                                                           
*                                                                               
CLTF10E  CLC   =C'NO PRIOR',QMANUAL                                             
         BE    CLTF50                                                           
*                                                                               
*                                       NON-RETAIL                              
         CLC   =C'NON-RETAI',QMANUAL    SUPPRESS RETAIL                         
         BNE   CLTF10M                                                          
         MVI   NONRET,C'Y'                                                      
         B     CLTF50                                                           
*                                                                               
CLTF10M  DS    0H                                                               
         CLC   QMANUAL,SPACES                                                   
         BE    CLTF50                                                           
         CLI   QMANUAL,C'P'         PCT                                         
         BE    CLTF20                                                           
         CLI   QMANUAL,C'R'        REVERSAL                                     
         BE    CLTF30                                                           
         CLI   QMANUAL,C'G'                                                     
         BE    CLTF10R                  ERROR                                   
         CLI   QMANUAL,C'F'        FEE                                          
         BNE   CLTF39                   ERROR                                   
CLTF10R  MVC   MANGRS,QMANUAL+1                                                 
         MVC   MANNET,QMANUAL+1                                                 
         XC    MANAC,MANAC          CLEAR MANAC                                 
         CLC   QPROG,=C'R1'   NO MANUAL AMOUNTS FOR R1- REBATE BILL             
         BE    CLTF39                                                           
         CLC   QPROG,=C'RD' NO MANUAL AMOUNTS FOR R1-REBATE BILL DRAFT          
         BE    CLTF39                                                           
*                                                                               
         CLC   QMANCD,SPACES                                                    
         BE    *+10                                                             
         MVC   MANCD,QMANCD        MANUAL CD                                    
*                                                                               
         CLI   QMANUAL,C'F'        SEE IF FEE                                   
         BE    CLTF14              LEAVE MANGRS=MANNET                          
*                                  LEAVE MANAC AS ZERO                          
*                                                                               
         L     R1,MANGRS                                                        
*&&DO                                                                           
*  THIS CODE FOR 16.67% IS NOT NEEDED ANYMORE AS OF 4/12/01                     
*  THE PROGRAM WILL ALWAYS GO TO CLTF11                                         
         CLI   QMEDIA,C'O'         SEE IF OUTDOOR                               
         BNE   CLTF11                                                           
**NEW 6/22/88                                                                   
         L     RF,ADAGY                                                         
         CLI   PAGYNAT-PAGYREC(RF),C'C'   SEE IF CANADIAN AGY                   
         BE    CLTF11                     ALWAYS 15.00 PCT                      
**NEW 6/22/88                                                                   
         L     RF,=F'10000'         NET IS 16.67% FOR OUTDOOR                   
         L     RE,=F'8333'                                                      
         B     CLTF12                                                           
*&&                                                                             
*                                                                               
CLTF11   LA    RF,100              NET IS 85/100                                
         LA    RE,85                                                            
CLTF12   DS    0H                                                               
         MR    R0,RE                                                            
         DR    R0,RF                                                            
         ST    R1,MANNET                                                        
         L     RE,MANGRS                                                        
         SR    RE,R1                                                            
         ST    RE,MANAC          AC = GROSS- NET                                
*                                                                               
CLTF14   DS    0H                                                               
         B     CLTF50                                                           
         SPACE 2                                                                
*                                  PCT                                          
CLTF20   DS    0H                                                               
         MVI   NONRET,C'Y'         NO RETAIL IF PCT BILL                        
         MVC   MANPCT,QMANUAL+1    2 DECIMALS                                   
         OC    MANPCT,MANPCT                                                    
         BZ    CLTF39                                                           
         B     CLTF50                                                           
         SPACE 2                                                                
*                                  REVERSAL INVOICE NUMBER                      
CLTF30   DS    0H                                                               
         LA    R2,QMANUAL+1                                                     
         GOTO1 DATCON,DMCB,(R2),(3,MANRVDTP)                                    
*                                                                               
**NEW 9/26/90   QMANUAL+7(4) WAS BINARY FIELD - REVERSAL INV NUMBER             
**              MVC   MANRVNO,QMANUAL                                           
         PACK  DUB,QMANUAL+7(4)                                                 
         CVB   R0,DUB                                                           
         STH   R0,MANRVNO                                                       
         OC    MANRVNO,MANRVNO                                                  
         BZ    CLTF39                                                           
         CLC   QMANCD,=C'NON-'      SEE IF NON-RETAIL REVERSAL                  
         BNE   CLTF30C                                                          
         MVI   NONRET,C'Y'          SET TO NON-RETAIL                           
*                                                                               
*        NO-OPED                                                                
******   CLC   QREGION(6),SPACES                                                
******   CLI   QMGR,C' '           IF MGR'S DONT SUPPRESS BUY READ              
******   BNE   *+8                                                              
******   MVI   FCRDBUY,C'N'       SUPPRESS READING OF BUYS                      
CLTF30C  MVI   PREVSW,C'Y'                                                      
*                                                                               
         B     CLTF50                                                           
         SPACE 2                                                                
CLTF39   DS    0H                                                               
         MVI   ERR,MANERR                                                       
         BRAS  RE,ERRPROC                                                       
         B     CLXFX                                                            
*                                                                               
CLTF50   DS    0H                                                               
         CLI   RCMULTIQ,C'Y'     SEE IF DOING MULTI-MEDIA REQ                   
         BNE   CLTF51                                                           
*                                                                               
         CLI   SETDSW,C'Y'       SEE IF DATES SET                               
         BE    CLTF52                                                           
*                                                                               
CLTF51   BRAS  RE,SETDATE                                                       
*                                                                               
** CODE FOR EPUDEF                                                              
         CLI   EPUDEF,C'N'                                                      
         BE    CLTF511            OPTION NOT ON                                 
         CLI   EPUDEF,0           JUST IN CASE                                  
         BE    CLTF511            OPTION NOT ON                                 
         XC    BYTE2,BYTE2                                                      
         CLI   PROGPRO2+1,C'T'    PRODUCTS TOGETHER?                            
         BNE   *+8                                                              
         OI    BYTE2,PUDEFON                                                    
*                                                                               
         CLI   PROGPRO2+2,C'T'    ESTIMATES TOGETHER?                           
         BNE   *+8                                                              
         OI    BYTE2,EUDEFON                                                    
*                                                                               
         CLI   EPUDEF,C'Y'        BOTH PRODS AND EST                            
         BNE   CLTF51E                                                          
         TM    BYTE2,PUDEFON+EUDEFON   TEST BOTH FLAGS ON                       
         BO    CLTF511                 YES, KEEP EPUDEF AS 'Y'                  
         BZ    CLTF51NO                NO, SET TO 'N'                           
         MVI   EPUDEF,C'P'                                                      
         TM    BYTE2,PUDEFON                                                    
         BO    CLTF511                                                          
         MVI   EPUDEF,C'E'                                                      
         B     CLTF511                                                          
*                                                                               
CLTF51E  CLI   EPUDEF,C'E'        EST ?                                         
         BNE   CLTF51P                                                          
         TM    BYTE2,EUDEFON                                                    
         BO    CLTF511          YES, KEEP ON                                    
         B     CLTF51NO                NO, SET TO 'N'                           
*                                                                               
CLTF51P  CLI   EPUDEF,C'P'        PROD?                                         
         BE    *+6                                                              
         DC    H'0'            SHOULD NOT HAPPEN                                
*                                                                               
         TM    BYTE2,PUDEFON                                                    
         BO    CLTF511          YES, KEEP ON                                    
*                                                                               
CLTF51NO MVI   EPUDEF,C'N'     TURN OFF THE FLAG                                
*                                                                               
*                                                                               
*        SET PUSRSW (PRD USER CONTROL) TO Y IF EITHER (OR BOTH)                 
*        PRD USER 1 OR PRD USER 2 ARE SET TO APPEAR ON THE FRONT                
*        AND THE OTHER IS NOT TO APPEAR ON BILLING OR UNDEFINED.                
*                                                                               
CLTF511  CLI   PROGPRO2+1,C'T'   ARE PRODUCTS TOGETHER? (BY PROFILE)            
         BNE   CLTF515           IF NOT DON'T SET PUSRSW                        
*                                                                               
         L     RF,ADCLT                                                         
         LA    R2,33(RF)                                                        
         MVI   ELCODE,X'20'          SEARCH FOR UDEF ELEMENT                    
         BAS   RE,CNEXTEL                                                       
         BNE   CLTF515                                                          
         USING PCLTUDEF,R2                                                      
         CLI   PCLTP1F1,0            NOT DEFINED                                
         BE    CLTF512              GO CHECK USER 2                             
         TM    PCLTP1F1,X'10'        TO APPEAR OF BILLING?                      
         BNO   CLTF512              IF NOT CHECK SECOND PRD USER                
         TM    PCLTP1F1,X'12'        SEE IF SET FOR FRONT OF BILL               
         BNO   CLTF515              IF NOT - DON'T SET PUSRSW                   
         MVI   PUSRSW,C'Y'                                                      
*                                                                               
CLTF512  CLI   PCLTP2F1,0            NOT DEFINED                                
         BE    CLTF515                                                          
         TM    PCLTP2F1,X'10'        SEE IF SET TO APPEAR ON BILLING            
         BNO   CLTF515                                                          
         MVI   PUSRSW,C'N'           MUST SET OFF IN CASE USER 2                
*                                    IS NOT ALSO SET FOR FRONT OF BILL          
         TM    PCLTP2F1,X'12'        SEE IF SET FOR FRONT OF BILL               
         BNO   CLTF515              IF NOT - DON'T SET PUSRSW                   
         MVI   PUSRSW,C'Y'           SET IT ON (MAYBE AGAIN)                    
         TM    PCLTP1F1,X'12'        BE SURE PRD USER ONE WAS ALSO              
         BNM   CLTF515              CHECK NOT MIXED                             
         MVI   PUSRSW,C'N'           IF MIXED MEANS USER ONE SET FOR            
*                                    BILLING BUT NOT ON FRONT                   
*                                    IF SO MUST SET OFF THE SWITCH              
         DROP  R2                                                               
CLTF515  L     RF,ADCLT                                                         
         MVI   UDEFESW,0     SET OFF EST UDEF BILLING CONTROL                   
         LA    R2,33(RF)                                                        
         MVI   ELCODE,X'20'          SEARCH FOR UDEF ELEMENT                    
         BAS   RE,CNEXTEL                                                       
         BNE   CLTF51A                                                          
         USING PCLTUDEF,R2                                                      
         CLI   PCLTE1F1,0            NOT DEFINED                                
         BE    CLTF516              GO CHECK USER 2                             
         TM    PCLTE1F1,X'01'       REQUIRED FOR BILLING?                       
         BNO   CLTF516              IF NOT CHECK SECOND PRD USER                
         OI    UDEFESW,X'01'        EST UDEF 1 REQUIRED                         
*                                                                               
CLTF516  CLI   PCLTE2F1,0            NOT DEFINED                                
         BE    CLTF517                                                          
         TM    PCLTE2F1,X'01'        REQUIRED FOR BILLING?                      
         BNO   CLTF517                                                          
         OI    UDEFESW,X'02'     2ND EST UDEF REQUIRED FOR BILLING              
*                                                                               
CLTF517  DS    0H                                                               
         DROP  R2                                                               
*                                                                               
CLTF51A  GOTO1 =A(VBADD),DMCB,(C'C',0)     CLEAR VBTAB                          
*                              WHEN I DIDN'T SOMETIMES VAT BASIS                
*                              WAS WRONG FOR OFFICE AND BILLING GROUP           
*                              REQUESTS                                         
*                                                                               
         CLI   CLTSW,C'N'      MEANS SKIP THIS CLIENT                           
         BE    CLXFX                                                            
         MVI   SETDSW,C'Y'  SO THEY WON'T BE RESET ON MULTI-MED REQ             
**GST                                                                           
*                            NOTE- CODES FOR PSTS ARE SET IN SETCPVC            
*                                  IF CVATCOD IS SET TO NULL HERE               
*                                  IT STAYS NULL AND ALL VATS ARE OFF           
         MVC   CVATSTRT,=X'5B01'          JAN/91                                
******** MVC   CVATRATE,=F'7000'          7.000 PCT                             
         MVI   CVATCOD,0                                                        
         L     RF,ADAGY                                                         
         CLI   PAGYNAT-PAGYREC(RF),C'C'    SEE IF CANADIAN                      
         BNE   CLTF51F                                                          
         CLC   CURPER,CVATSTRT     SEE IF CURRENT PER BEFORE START              
         BL    CLTF51F                                                          
         MVI   CVATCOD,C'S'        SET DEFAULT                                  
         L     RF,ADCLT                                                         
         CLI   PCLTGST-PCLTREC(RF),C' '                                         
         BNH   CLTF51F                                                          
         MVC   CVATCOD,PCLTGST-PCLTREC(RF)                                      
*                                                                               
CLTF51F  DS    0H                                                               
*******  CLI   CVATCOD,C'S'                                                     
*******  BE    *+10                                                             
*******  XC    CVATRATE,CVATRATE    OTHER CODES = ZERO PCT                      
*                                                                               
*                                                                               
***E***                                                                         
         CLC   QPROG,=C'E1'   FIX OPTIONS AND PROFILES FOR ESTIMATES            
         BNE   CLTF52                                                           
         MVI   PEOVOPT,C'N'                                                     
         MVI   CDSEP,C'N'                                                       
         MVI   ADJSEP,C'N'                                                      
         MVI   TESTFLAG,C'T'                                                    
         MVI   PRIOR,C'T'                                                       
         MVI   LSTOPT,C'N'                                                      
         MVI   ZBOPT,C'N'                                                       
         MVI   ZUOPT,C'S'                                                       
         MVI   ZLOPT,C'0'                                                       
         MVI   ORIGTYPE,0                                                       
         MVI   PROGPRO3+5,C'0'             NO STRIP-OFF                         
         MVI   PROGPRO4+5,C'0'             NO STRIP-OFF                         
         MVC   PROGPRO3+6(3),=C'YNN'       SET TO ORDERED ONLY                  
         MVC   PROGPRO4+6(3),=C'YNN'       SET TO ORDERED ONLY                  
***E***                                                                         
*                                                                               
*                                                                               
CLTF52   DS    0H                                                               
         CLI   SCBOPT,C'Y'       SEE IF SEP COMMISSION OPTION                   
         BNE   CLTF70                                                           
         CLC   =C'ALL',QCLIENT                                                  
         BE    CLTF53                                                           
         CLI   QCLIENT,C'*'         OFFICE                                      
         BE    CLTF53                                                           
         CLI   QCLIENT,C'&&'        OR GROUP                                    
         BNE   CLTF54                                                           
*                                                                               
CLTF53   MVI   MODE,CLILAST         SKIP THIS CLIENT                            
         B     CLXFX                                                            
*                                                                               
CLTF54   CLI   PROFB2B+1,0          CHK FOR EST FILTER PROFILE                  
         BNH   CLTF60                                                           
         CLI   PROFB2B+2,C'*'       CAN'T BE AN *                               
         BE    CLTF62                                                           
         B     CLTF56                                                           
******                                                                          
******   FILTERS NOW ADDED/ALTERED AT REQFRST                                   
******   CLC   =C'ALL',QEST                                                     
*****    BNE   CLTF56                                                           
***                                                                             
***      CLI   QESTEND,C' '         CHK FOR FILTER ALREADY THERE                
***      BH    *+10                                                             
***      MVC   QESTEND(3),=C'***'                                               
***                                                                             
***      ZIC   RF,PROFB2B+1                                                     
***      LA    RF,QESTEND-1(RF)                                                 
***      MVC   0(1,RF),PROFB2B+2        SET FILTER VALUE IN REQUEST             
***      CLI   SCBNCSW,C'R'                                                     
***      BE    *+8                                                              
***      NI    0(RF),X'BF'              SET TO ALL BUT                          
***      B     CLTF70                                                           
***                                                                             
CLTF56   DS    0H                                                               
         CLI   QESTEND,C'0'                                                     
         BL    CLTF70                                                           
         MVI   ERR,ESTERR             CAN'T HANDLE RANGE OF ESTS                
         BRAS  RE,ERRPROC                                                       
         B     CLXFX                                                            
*                                                                               
CLTF60   DS    0H             HERE IF NO FILTER POSITION                        
         CLI   SCBNCSW,C'R'                                                     
         BNE   CLTF70                                                           
CLTF62   MVI   ERR,SCBERR                                                       
         BRAS  RE,ERRPROC     IF REGULAR MUST HAVE FILTER POSITION              
         B     CLXFX                                                            
*                             OR FILTER VALUE WAS *                             
*                                                                               
CLTF70   DS    0H                                                               
*                             SET PRD AND EST Q'S                               
CLXF4    DS    0H                                                               
         MVI   ESTQ,C'S'           SERIES                                       
         CLI   QESTEND,C' '                                                     
         BH    CLXF6                                                            
         MVI   ESTQ,C'A'           ALL                                          
         CLC   =C'ALL',QEST                                                     
         BE    CLXF6                                                            
*                                                                               
         OC    MANGRS(12),MANGRS   IF MANUAL, KEEP AT ONE, NOT ALL              
         BNZ   CLXF4O                                                           
*                                                                               
         CLI   EPUDEF,C'Y'      SHOW PRD & EST UDEFS                            
         BE    CLXF6                                                            
         CLI   EPUDEF,C'E'      SHOW EST UDEFS                                  
         BE    CLXF6                                                            
*                                                                               
CLXF4O   MVI   ESTQ,C'1'           ONE EST                                      
*                                                                               
CLXF6    DS    0H                                                               
         MVI   PRDQ,C'A'           ALL                                          
         CLC   QPRODUCT,=C'ALL'                                                 
         BE    CLXF7                                                            
         CLC   QPRODUCT,=C'ZZZ'                                                 
         BE    CLXF7                                                            
         CLI   PGSW,C'Y'        P&G PROCESSING?                                 
         BE    CLXF7            LEAVE PRDQ AT "A"                               
*                                                                               
         CLI   WMSW,C'Y'        OR WALMART PROCESSING                           
         BE    CLXF7            LEAVE PRDQ AT "A"                               
*                                                                               
         CLI   FOXSW,C'Y'       OR FOX PROCESSING                               
         BE    CLXF7            LEAVE PRDQ AT "A"                               
*                                                                               
         CLI   PUSRSW,C'Y'      OR PRD USER CONTROL                             
         BE    CLXF7            LEAVE PRDQ AT "A"                               
*                                                                               
         CLI   EPUDEF,C'Y'      SHOW PRD & EST UDEFS                            
         BE    CLXF7                                                            
         CLI   EPUDEF,C'P'      SHOW PRD UDEFS                                  
         BE    CLXF7                                                            
*                                                                               
CLXF6K   DS    0H                                                               
         MVI   PRDQ,C'1'           ONE PRD                                      
*                                                                               
CLXF7    DS    0H                                                               
         MVI   PGRQ,C'N'           NO PGRS                                      
         CLI   QDIV,C' '                                                        
         BE    CLXF8                                                            
         MVI   PGRQ,C'A'           MORE THAN 1 PGR                              
         CLC   QDIV,=C'ALL'                                                     
         BE    CLXF8                                                            
         MVI   PGRQ,C'1'           1 PGR                                        
*                                                                               
CLXF8    DS    0H                                                               
         MVI   MGRQ,C'N'           NO MGRS                                      
         CLC   QREGION(6),SPACES                                                
         BE    CLXF9                                                            
         MVI   MGRQ,C'A'           MORE THAN 1 MGR                              
         CLC   =C'ALL',QREGION                                                  
         BE    CLXF9                                                            
         CLC   =C'ALL',QDIST                                                    
         BE    CLXF9                                                            
         MVI   MGRQ,C'1'           1 MGR                                        
*                                                                               
CLXF9    DS    0H                                                               
         MVI   MKTQ,C'A'           ALL MKTS                                     
         MVI   JOBQ,C'A'                                                        
         CLI   QPUB+1,C'J'         SEE IF REQ FOR ONE JOB                       
         BNE   *+8                                                              
         MVI   JOBQ,C'1'                                                        
*                                                                               
CLXF10   DS    0H                                                               
         OC   MANGRS(12),MANGRS                                                 
         BZ    CLXF12                                                           
         CLI   PRDQ,C'1'                                                        
         BNE   CLTF39                                                           
         CLI   ESTQ,C'1'                                                        
         BNE   CLTF39                                                           
         CLI   MGRQ,C'N'           NO REG/DST FOR MANUAL BILLS                  
         BNE   CLTF39                                                           
*                                                                               
         CLI   WBSW,C'Y'           ALLOW DIV FOR WB FLIGHT MANUAL BILLS         
         BE    CLXF12                                                           
*                                                                               
         CLI   PGRQ,C'N'           NO DIV FOR MANUAL BILLS                      
         BNE   CLTF39                                                           
CLXF12   DS    0H                                                               
         CLI   RCMULTIQ,C'Y'       SEE IF PART OF MULTI-MEDIA REQ               
         BNE   CLXF12C                                                          
         CLI   BTABSW,C'Y'         ONLY GO TO BLDTAB ONCE                       
         BE    CLXF13              FOR FIRST ACTIVE MEDIA                       
*                                                                               
CLXF12C  BRAS  RE,BLDTAB           BUILD KEY TAB                                
         CLI   CLTSW,C'N'          MEANS SKIP THIS CLIENT                       
         BE    CLXFX                                                            
         MVI   BTABSW,C'Y'                                                      
CLXF13   DS    0H                                                               
CLXFX    DS    0H                                                               
         L     RF,ADCLT       SAVE OFFICE AND AMGOCTL                           
         MVC   SVOFF,PCLTOFF-PCLTREC(RF)                                        
         MVC   SVAGMOCT,AGMOCTL                                                 
*                                                                               
**EDI**                                                                         
         CLI   TESTFLAG,C'T'         SEE IF DRAFT BILLING                       
         BNE   CLXFXC                                                           
         CLC   QUESTOR(4),=C'*EDI'    NO EDI UNLESS *EDI IN QUESTOR             
         BNE   CLXFXD                                                           
*                                                                               
CLXFXC   CLI   PROFB1A+5,C'Y'         EDI CLIENT?                               
         BE    CLXFXE                                                           
         CLI   PROFB1A+5,C'F'         EDI CLIENT WITH FIXED FORMAT?             
         BE    CLXFXE                                                           
*                                                                               
CLXFXD   DS    0H                                                               
         LA    RF,=X'07FE'           DUMMY ROUTINE                              
         B     CLXFXF                                                           
*                                                                               
CLXFXE   DS    0H                                                               
         L     RF,=A(BILLEDI)                                                   
*                                                                               
CLXFXF   ST    RF,ABILLEDI                                                      
         MVI   OUTMODE,C'W'       SET FOR WORKER FILE                           
*                         PATCH TO 'D' FOR DIRECT DATASET MODE                  
CLXFXX   DS    0H                                                               
**EDI**                                                                         
         XIT1                                                                   
         SPACE 2                                                                
CNEXTEL  DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    CNEXTEL2                                                         
         CLC   0(1,R2),ELCODE                                                   
         BER   RE                                                               
         B     CNEXTEL                                                          
CNEXTEL2 DS    0H                                                               
         LTR   RE,RE                                                            
         BR    RE                                                               
*                                                                               
         LTORG                                                                  
*                                                                               
SVAADDRS DS    CL(ADDRLEN)                                                      
         DROP  R7                                                               
         EJECT                                                                  
*                                                                               
*        ESTFRST                                                                
EFIRST   NMOD1 0,EFIRST                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
*COST2*                                                                         
*              SET CARAT COST2 OPTION                                           
*              NOTE - WILL GET SET AGIAN IN PPREPB12C AT FEST                   
*                                                                               
         MVI   CAROPT,C'N'                                                      
         CLI   CAROPTC,C'Y'      SEE IF COST 2 CLIENT                           
         BNE   ESTF01J           SKIP                                           
         L     RF,ADEST                                                         
         CLC   PESTCF-PESTREC(5,RF),=PL5'0' SEE IF EST OVERRIDE                 
         BE    ESTF01J      OF ZERO - MEANS NON-COST2 ESTIMATE                  
*                                                                               
         MVI   CAROPT,C'Y'    SET ON SWITCH                                     
         OC    PESTCF-PESTREC(5,RF),PESTCF-PESTREC(RF)                          
         BZ    ESTF01J      BE SURE PACKED FIELD                                
         CP    PESTCF-PESTREC(5,RF),=P'0'   ONE MORE CHECK                      
         BNL   *+6                                                              
         DC    H'0'         SOMETHING VERY WRONG                                
*                                                                               
ESTF01J  DS    0H                                                               
*COST2*                                                                         
         L     RF,ADEST                                                         
         MVC   ESTFORM,PESTBILP-PESTREC(RF)                                     
***      MVC   ESTFORM2,PESTREVN+3-PESTREC(RF)                                  
***      MVC   ESTFORM3,PESTREVN+10-PESTREC(RF)                                 
         XC    AAEFORM,AAEFORM                                                  
***      XC    AAEFORM2,AAEFORM2                                                
***      XC    AAEFORM3,AAEFORM3                                                
         L     RE,AAELIST                                                       
*                                                                               
ESTF10   CLC   0(6,RE),FFS                                                      
         BE    ESTF20                                                           
         CLC   10(2,RF),0(RE)                                                   
         BE    ESTF15                                                           
         LA    RE,53(RE)                                                        
         B     ESTF10                                                           
*                                                                               
ESTF15   DS    0H                                                               
         MVC   AAEFORM,2(RE)                                                    
***      MVC   AAEFORM2,39(RE)                                                  
***      MVC   AAEFORM3,46(RE)                                                  
*                                                                               
ESTF20   DS    0H                                                               
*                                                                               
*        OI    FLAG1,NOBILPRD   SEE IF BILLING THIS PROD                        
*        BO    ESTFX                                                            
*                                                                               
*        CHECK HERE FOR A UCOMM FOR THIS ESTIMATE                               
*                                                                               
         CLI   UCOMMSW,C'Y'      UCOMM REQUIRED?                                
         BNE   ESTF22                                                           
*                                                                               
         L     RF,=A(CHKUCOM)                                                   
         BASR  RE,RF                                                            
*                                                                               
         OC    MANGRS(12),MANGRS   MANUAL BILLING?                              
         BZ    ESTF20B                                                          
         OC    SVMANFLT,SVMANFLT  ONE FLT REQUESTED?                            
         BZ    ESTF20B                                                          
         CLC   SVMANFLT,ESTWBFLT  CHECK VS. ESTIMATE'S                          
         BE    ESTF20B                                                          
         MVI   BYTE,C'C'       SET TO MISSING IF WRONG                          
*                                                                               
ESTF20B  CLI   BYTE,C'C'                                                        
         BNE   ESTF22                                                           
         BAS   RE,CSETSKIP     GO SET EST'S MISSING UCOMM INDICATOR             
*                                                                               
ESTF22   DS    0H                                                               
*                                                                               
*        CHECK HERE FOR UDEF'S FOR THIS ESTIMATE                                
*                                                                               
         CLI   UDEFESW,0         ANY EST UDEFS REQUIRED?                        
         BE    ESTF23            NO                                             
*                                                                               
         L     RF,=A(CHKUDEF)                                                   
         BASR  RE,RF                                                            
*                                                                               
         CLI   BYTE,C'C'                                                        
         BNE   ESTF23                                                           
         BAS   RE,CSETSKIP     GO SET EST'S MISSING UDEF INDICATOR              
*                              (SAME AS MISSING UCOMM)                          
*                                                                               
*                                                                               
ESTF23   CLI   ESTQ,C'1'           IF ONE EST REQ                               
         BNE   ESTFX                                                            
         L     RF,ADEST                                                         
*                                                                               
*                                                                               
         CLC   PESTRSCH-PESTREC(2,RF),SPACES     NO RETAIL SCHEME               
         BH    ESTF25                                                           
         MVI   NONRET,C'Y'         THEN SET OFF RETAIL                          
         XC    RETPROF,RETPROF                                                  
         MVI   SUMOPT,C'N'                                                      
         B     ESTF25                                                           
*                                                                               
ESTF25   DS    0H                                                               
         CLI   SCBOPT,C'Y'             SEP COMM BILLING OPT                     
         BNE   ESTF30                                                           
         CLI   PROFB2B+1,0             CHK FOR FILTER POSITION                  
         BE    ESTF30                                                           
         ZIC   R2,PROFB2B+1                                                     
         LA    R2,PESTGRPS-1-PESTREC(R2,RF)                                     
*                                                                               
         CLI   SCBNCSW,C'R'            REGULAR ESTIMATE REQUEST                 
         BNE   ESTF26                                                           
         CLC   0(1,R2),PROFB2B+2                                                
         BE    ESTF30                                                           
         B     ESTFERR                 MISMATCH - REJECT                        
*                                                                               
ESTF26   DS    0H                                                               
         CLC   0(1,R2),PROFB2B+2       REJECT IF EQUAL                          
         BNE   ESTF30                                                           
*                                                                               
ESTFERR  MVI   ERR,ESTERR                                                       
         BRAS  RE,ERRPROC                                                       
         B     ESTFX                                                            
*                                                                               
ESTF30   OC    MANGRS(12),MANGRS       SEE IF DOING A MANUAL BILL               
         BZ    ESTFX                                                            
         MVI   MODE,CLILAST            NEEDED SINCE I MAY GET HERE              
*                                       A SINGLE EST RETAIL REQUEST             
ESTFX    XIT1                                                                   
*                                                                               
*                                                                               
*        CSETSKIP   SETS MISSING UCOMM (BYTE=C)                                 
*                                                                               
         SPACE 2                                                                
CSETSKIP NTR1                                                                   
         XC    X(20),X                                                          
         LA    R5,X                                                             
         USING UPED,R5                                                          
*                                                                               
         L     R7,ADEST                                                         
         USING PESTREC,R7                                                       
         MVC   UPEPRD,PESTKPRD    DON'T USE PBUYKPRD  - MIGHT BE ZZZ            
         MVC   UPEEST,PESTKEST                                                  
         DROP  R7                                                               
*                                                                               
         GOTO1 BINSRCH,UPEPARS,(1,X)   ADD TO TABLE                             
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'      TOO MANY UNPAID ESTS - EXPAND UPETAB                   
         L     R5,0(R1)  ADDRESS OF ADDED OR FOUND RECORD                       
*                                                                               
CSETSKP  CLI   BYTE,C'C'             SEE IF I'M SETTING MISSING UCOM            
         BNE   CSETSKX                                                          
         OI    UPESTAT,X'04'         SET MISSING UCOMM INDICATOR                
         B     CSETSKX                                                          
*                                                                               
CSETSKX  DS    0H                                                               
         XIT1                                                                   
         DROP  R5                                                               
*                                                                               
         LTORG                                                                  
*                                                                               
* GET B8 PROFILE                                                                
*                                                                               
GPOB8    NMOD1 0,GPOB8*                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         MVI   DATEOPT,C'N'    SET TO DEFAULTS                                  
         MVI   DOLSOPT,C'N'                                                     
         MVI   BILLADR,C'N'                                                     
*        MVI   NOSTAR,C'N'     INIT NO ** NEXT TO TOTALS                        
*        MVI   SHOWRATE,C'N'                                                    
         NI    FLAG1,X'FF'-SHOWRATE  INIT                                       
         NI    FLAG1,X'FF'-NOSTAR    INIT NO ** NEXT TO TOTALS                  
         NI    FLAG1,X'FF'-PARENTH   INIT                                       
         NI    FLAG1,X'FF'-SHOWMVEN  INIT                                       
         MVI   EPUDEF,C'N'                                                      
         XC    WORK,WORK                                                        
         MVC   WORK(4),=C'POB8'                                                 
         MVC   WORK+4(3),QAGENCY                                                
         L     RF,ADCLT                                                         
         MVC   WORK+7(3),PCLTKCLT-PCLTREC(RF)                                   
         LA    RF,PCLTOFF-PCLTREC(RF)                                           
         CLI   0(RF),C' '                                                       
         BNH   *+14                                                             
         MVI   WORK+10,C'*'        SET OFFICE CODE                              
         MVC   WORK+11(1),0(RF)                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROGPROF,DATAMGR,,WORK+16              
         GOTOR PRNTPROF,DMCB,WORK,PROGPROF,WORK+16                              
         OC    PROGPROF,PROGPROF   WAS IT FOUND?                                
         BZ    GPOB8X                                                           
         MVC   DATEOPT,PROGPROF                                                 
         MVC   DOLSOPT,PROGPROF+1                                               
         MVC   BILLADR,PROGPROF+2  READ BILLADR REC FOR EXTENDED ADDR           
*        MVC   NOSTAR,PROGPROF+3   SUPPRESS ** ON TOTALS                        
         CLI   PROGPROF+3,C'Y'                                                  
         BNE   *+8                                                              
         OI    FLAG1,NOSTAR         SUPPRESS ** ON TOTALS                       
*        MVC   SHOWRATE,PROGPROF+5 SHOW RATE FOR UB                             
         CLI   PROGPROF+5,C'Y'                                                  
         BNE   *+8                                                              
         OI    FLAG1,SHOWRATE       SHOW RATE FOR UB                            
*                                                                               
         MVC   EPUDEF,PROGPROF+6   UDEFS ON CONSOLIDATED BILL                   
         CLI   PROGPROF+7,C'Y'     USE PARENTHESIS FOR CREDIT AMOUNT            
         BNE   *+8                                                              
         OI    FLAG1,PARENTH                                                    
*                                                                               
         CLI   PROGPROF+8,C'Y'     SHOW MIDAS VENDOR                            
         BNE   *+8                                                              
         OI    FLAG1,SHOWMVEN                                                   
*                                                                               
GPOB8X   XIT1                                                                   
*                                                                               
*                                                                               
         TITLE 'BLDTAB - BUILD SORT/BREAK CONTROL TABLE'                        
BLDTAB   NMOD1 0,BLDTAB                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
*                                  READ B5 PROFILE                              
*                                       MOVE PROFILE INTO BRKEQV                
BT1      DS    0H                                                               
         MVI   NOINSSW,0                                                        
         XC    SPTSEQ,SPTSEQ                                                    
         XC    X,X                                                              
         MVC   X(7),PROGPRO2      HOLD PROF IN X                                
*                                                                               
         MVC   X+10(7),PROGPRO2   SAVE ORIG VALUES                              
*                                                                               
         CLI   RCMULTIQ,C'Y'      MULTIMEDIA REQ                                
         BE    BT01A              YES - CAN'T ALTER BLDTAB                      
         CLI   QMEDIA,C'M'                                                      
         BNE   *+8                                                              
         MVI   X+4,C'N'            NO MARKETS FOR MAGS                          
         CLI   QMEDIA,C'T'                                                      
         BNE   *+8                                                              
         MVI   X+4,C'N'            NO MARKETS FOR TRADE MAGS                    
         CLI   QMEDIA,C'S'                                                      
         BNE   *+8                                                              
         MVI   X+4,C'N'            NO MARKETS FOR SUPPLEMENTS                   
         CLI   QMEDIA,C'I'                                                      
         BNE   *+8                                                              
         MVI   X+4,C'N'            NO MARKETS FOR INTERACTIVE                   
         CLI   QMEDIA,C'L'                                                      
         BNE   *+8                                                              
         MVI   X+4,C'N'            NO MARKETS FOR SOCIAL                        
         CLI   QMEDIA,C'B'                                                      
         BNE   *+8                                                              
         MVI   X+4,C'N'            NO MARKETS FOR MOBILE                        
         CLI   QMEDIA,C'V'                                                      
         BNE   *+8                                                              
         MVI   X+4,C'N'            NO MARKETS FOR NAT. VIDEO                    
         CLI   QMEDIA,C'W'                                                      
         BNE   *+8                                                              
         MVI   X+4,C'N'            NO MARKETS FOR LOC. VIDEO                    
         CLI   QMEDIA,C'D'                                                      
         BNE   *+8                                                              
         MVI   X+4,C'N'            NO MARKETS FOR DIGITAL AUDIO                 
*                                                                               
BT01A    MVI   PRDMKT,C'P'         PRD HIGHER THAN MKT                          
         CLI   X+4,C'R'            UNLESS MKT OPT = R                           
         BNE   BT01C                                                            
         MVI   X+4,C'T'            THEN RESET TO T                              
         CLI   X+1,C'T'            PRD MUST ALSO BE T                           
         BNE   BT01C                                                            
         MVI   PRDMKT,C'M'         AND SET MKT HIGHER THAN PRD                  
BT01C    DS    0H                                                               
*                                                                               
*              IF REQ FOR SINGLE SET PROF TO SEPARATE                           
         CLI   PGRQ,C'1'                                                        
         BNE   *+8                                                              
         MVI   X+0,C'S'                                                         
         CLI   PRDQ,C'1'                                                        
         BNE   *+8                                                              
         MVI   X+1,C'S'                                                         
         CLI   ESTQ,C'1'                                                        
         BNE   *+8                                                              
         MVI   X+2,C'S'                                                         
         CLI   MGRQ,C'1'                                                        
         BNE   *+8                                                              
         MVI   X+3,C'S'                                                         
         CLI   MKTQ,C'1'                                                        
         BNE   *+8                                                              
         MVI   X+4,C'S'                                                         
         CLI   JOBQ,C'1'         REQ FOR ONE JOB  - SET TO SEPARATE             
         BNE   *+8                                                              
         MVI   X+5,C'S'                                                         
*                                                                               
         CLI   X+6,C'X'            MEANS NO PUBS BUT SHOW INSERTIONS            
         BNE   BT01C3                                                           
         MVI   X+6,C'N'                                                         
         B     BT01C5                                                           
*                                                                               
BT01C3   CLI   X+6,C'I'            MEANS PUBS TOGEHTER WITH NO                  
         BNE   BT01C5                                                           
         MVI   X+6,C'T'                                                         
         MVI   NOINSSW,C'Y'                                                     
BT01C5   MVI   X+7,C'T'            DESC                                         
         MVI   SPOTSW,C'N'         REALLY INSERTION DETAILS                     
         OC   MANGRS(12),MANGRS                                                 
         BNZ   *+8                                                              
         MVI   SPOTSW,C'Y'                                                      
         MVI   BRKPUB+2,1             SET PUB REQ                               
         MVI   BRKDESC+2,0            SET DESC NOT REQ                          
         OC   MANGRS(12),MANGRS    IF MANUAL                                    
         BZ    BT01D                                                            
         XC    MGR1BK,MGR1BK     CLEAR MGROUP NAMES                             
         XC    MGR2BK,MGR2BK                                                    
         MVC   X+3(6),=6C'N'       SUPPRESS MGR,MKT,JOB,PUB                     
         CLI   PO#OPT,C'Y'       SEE IF BILLING BY PO#                          
         BNE   BT01C7                                                           
         CLC   QPO#SEQ,SPACES    ONE PO# REUESTED?                              
         BE    BT01C7                                                           
         MVI   X+5,C'S'          RESET TO JOBS (PO#) SEPARATE                   
*                                                                               
BT01C7   MVI   BRKPUB+2,0             SET PUB NOT REQ                           
         MVI   BRKDESC+2,1            SET DESC REQ                              
*                                                                               
BT01D    DS    0H                                                               
*                                                                               
         CLI   X,C'T'           DIVISIONS TOGETHER?                             
         BNE   BT01DC                                                           
         CLI   X+1,C'S'         WITH PRODUCTS SEPARATE                          
         BNE   BT01DC                                                           
*                                                                               
         MVC   ERRPROF,=C'B4 01' DOESN'T WORK                                   
         MVC   ERRPROF+1(1),TYPE                                                
         MVI   ERR,PROFERR                                                      
         BRAS  RE,ERRPROC                                                       
         B     BLDTABX                                                          
*                                                                               
BT01DC   DS    0H                                                               
*                                                                               
         CLI   AGMFORMS,C'L'    CHK FOR LONG LOGO                               
         BE    BT01D2                                                           
         CLI   AGMFORMS,C'B'    CHK FOR LONG LOGO                               
         BE    BT01D2                                                           
         B     BT01D8                                                           
*                                                                               
*                                                                               
*        TRY AND CATCH PROBLEMS WITH HEADLINES IF USING LONG LOGO               
*                                                                               
BT01D2   CLC   X(4),=C'SSSS'    SEE IF DIV/PRD/EST/(REG/DST)                    
         BNE   BT01D8           ARE ALL SEPARATE                                
         CLI   QDIST,C' '       SEE IF DISTRICT REQUESTED                       
         BE    BT01D8           NO - THEN I SHOULD HAVE ROOM IN THE             
*                               HEADLINES                                       
         CLI   X+13,C'T'        CHK ORIG REG/DST VALUE                          
         BNE   BT01D3                                                           
         MVI   X+3,C'T'         RESET REG/DST TO TOGETHER                       
         B     BT01D8                                                           
*                                                                               
BT01D3   CLI   X+12,C'T'        CHK ORIG EST VALUE OF TOGETHER                  
         BNE   BT01D8                                                           
         MVI   X+2,C'T'        SET EST TO TOGETHER                              
*                                                                               
BT01D8   XC    WORK,WORK                                                        
         MVC   WORK(BRKEQVL),BRKEQV                                             
         LA    R2,WORK                                                          
         MVC   03(1,R2),X+0     PGR1                                            
         MVC   06(1,R2),X+0     PGR2                                            
         MVC   09(1,R2),X+0     PGR3                                            
         MVC   12(1,R2),X+1     PRD                                             
         MVC   15(1,R2),X+2     EST                                             
         MVC   18(1,R2),X+3     MGR1                                            
         MVC   21(1,R2),X+3     MGR2                                            
         MVC   24(1,R2),X+3     MGR3                                            
         MVC   27(1,R2),X+4     MKT                                             
         MVC   30(1,R2),X+5     JOB                                             
         MVC   33(1,R2),X+6     PUB                                             
         MVC   36(1,R2),X+7     DESC                                            
*                                                                               
         CLI   QDIV,C' '                                                        
         BNE   BT01F                                                            
         MVI   3(R2),C'N'          SET ALL  PGROUPS TO N                        
         MVI   6(R2),C'N'                                                       
         MVI   9(R2),C'N'                                                       
*                                                                               
BT01F    CLI   QREGION,C' '                                                     
         BNE   BT01H                                                            
         MVI   18(R2),C'N'         NO REGIONS                                   
*                                                                               
BT01H    CLI   QDIST,C' '                                                       
         BNE   BT01J                                                            
         MVI   21(R2),C'N'         NO DISTRICTS                                 
         MVI   24(R2),C'N'                                                      
*                                                                               
BT01J    DS    0H                                                               
         CLI   QPUB,C' '           SEE IF DOING ONE PUB                         
         BE    BT01J5              NO                                           
         CLC   QPUB+8(3),=C'ZZZ'   SEE IF DOING ONE PUB/ALL EDITIONS            
         BE    BT01J5              YES - LEAVE PUB CONTROL ALONE                
         MVI   33(R2),C'S'         SET PUB TO SEPARATE                          
*                                                                               
BT01J5   MVI   39(R2),C'S'         PRIOR SEPARATE                               
*                                                                               
         CLI   PRIOR,C'U'          25 ON SEPARATE?                              
         BE    BT1A                                                             
*                                                                               
         CLI   PRIOR,C'1'          IF 1 - 3                                     
         BNL   BT1A                                                             
         MVI   39(R2),C'T'         PRIOR TOGETHER                               
*                                                                               
         CLI   PRIOR,C'V'          25 TOGETHER                                  
         BE    BT1A                                                             
*                                                                               
         CLI   PRIOR,X'CC'         IF A-I OR X'CA' AND X'CB'                    
         BNH   BT1A         X'CA' IS 10 PRIOR MONTHS                            
*                           X'CB' IS 11 PRIOR MONTHS                            
*                           X'CC' IS 12 PRIOR MONTHS                            
*                                                                               
         MVC   39(1,R2),PRIOR           PERIOD                                  
*                                                                               
BT1A     DS    0H                                                               
         CLI   PRIOR,C'N'          IF NO PRIOR                                  
         BNE   *+8                                                              
         MVI   39(R2),C'S'         TREAT AS SEPARATE                            
         MVI   42(R2),C'N'         NO PERIOD GROUP                              
*                                                                               
         CLI   PRIOR,C'W'          1+ 24 PRIOR                                  
         BE    BT1A5                                                            
         CLI   PRIOR,C'M'          UNLESS DOING CUR MO SEPARATE                 
         BNE   *+12                                                             
BT1A5    MVI   39(R2),C'T'                                                      
         MVI   42(R2),C'S'                                                      
         CLI   SUMOPT,C'Y'         IF DOING RETAIL SUMMARY                      
         BNE   *+8                                                              
         MVI   42(R2),C'R'         USE PER GRP AS DUMMY 'SEPARATE'              
*                                  (USE 'R' TO CAUSE TO SORT FIRST)             
*                                                                               
*                                  IF NO 'SEPARATE' SET PERIOD GROUP            
*                                  TO SEP AND USE AS DUMMY INV BRK              
         LR    RF,R2                                                            
         LA    R0,14                                                            
BT1B     DS    0H                                                               
         CLI   0(RF),C'S'                                                       
         BE    BT1D                                                             
         LA    RF,3(RF)                                                         
         BCT   R0,BT1B                                                          
         MVI   42(R2),C'S'         PERIOD GROUP TO S                            
BT1D     DS    0H                                                               
         MVI   0(R2),C'N'         SET MEDIA BRK TO NO                           
         CLI   RCMULTIQ,C'Y'       UNLESS DOING A MULTI-MEDIA REQ               
         BNE   BT1G                                                             
         MVI   0(R2),C'T'         SET MEDIAS TOGETHER                           
         CLI   33(R2),C'S'        SEE IF PUB SEPARATE                           
         BNE   BT1G                                                             
         B     BPRFERR            SEND INVALID BILLING PROFILE                  
*                                                                               
BT1G     MVI   45(R2),C'T'         SET ALL CHARGES TOGETHER (FOR NOW)           
*                                                                               
         MVI   48(R2),C'N'         SET CRBD BREAK TO NO                         
         CLI   PROGPRO2+13,C'Y'                                                 
         BNE   BT1G5                                                            
         MVI   48(R2),C'S'                                                      
         B     BT2                                                              
*                                                                               
BT1G5    DS    0H                                                               
*                                                                               
         CLI   PROGPRO2+13,C'R'    S-RATE INSERTIONS ON SEPARATE                
         BNE   *+8                                                              
         MVI   48(R2),C'S'                                                      
*                                                                               
         CLI   PROGPRO2+13,C'C'    ADDITIONAL CHARGES ON SEPARATE               
         BNE   *+8                                                              
         MVI   48(R2),C'S'                                                      
*                                                                               
         CLI   PROGPRO2+13,C'B'    AC=0 OR ADDITIONAL CHARGE ON SEP.            
         BNE   BT1G7                                                            
         MVI   48(R2),C'S'                                                      
         OC    MANRVNO,MANRVNO     SEE IF DOING A REVERSAL                      
         BZ    BT1G7                                                            
         CLC   MANRVDTP,=X'6C0701' SEE IF AFTER JUL01/08                        
         BNL   BT1G7               LEAVE AS 'S'                                 
         MVI   48(R2),C'N'         OTHERWISE RESET TO N                         
*                                  SO OLD BILLS WILL REVERSE PROPERLY           
*                                                                               
BT1G7    DS    0H                  2 INSTRUCTIONS BELOW ARE SUSPECT             
         OC    MANRVNO,MANRVNO     SEE IF DOING A REVERSAL                      
         BNZ   BT2                 IF YES - LEAVE AS "N"                        
*                                                                               
BT2      DS    0H                                                               
**NEW 4/25/90                                                                   
         CLI   PAYOPT,C'E'         SEE IF BILLING CLEARED ESTS ONLY             
         BE    BT2A                                                             
         CLI   PAYOPT,C'G'         SEE IF BILLING CLEAEDS EST ONLY              
         BNE   BT2AK                                                            
*                                  IF BILLING CLEARED ESTS ONLY                 
*                                  REG/DST, MKT, JOB, PUB                       
*                                  CAN'T BE ON SEPARATE INVOICES                
*                              **  OPTION WILL NOT WORK **                      
BT2A     CLI   18(R2),C'S'         REGIONS                                      
         BE    BPRFERR5                                                         
         CLI   21(R2),C'S'         DISTRICTS                                    
         BE    BPRFERR5                                                         
         CLI   24(R2),C'S'                                                      
         BE    BPRFERR5                                                         
         CLI   27(R2),C'S'         MARKETS                                      
         BE    BPRFERR5                                                         
         CLI   30(R2),C'S'         JOBS                                         
         BE    BPRFERR5                                                         
         CLI   33(R2),C'S'         PUBS                                         
         BE    BPRFERR5                                                         
         CLI   QPUB,C' '                                                        
         BE    BT2AK                                                            
         CLC   QPUB+8(3),=C'ZZZ'   OR ALL ZONES/EDITIONS                        
         BE    BPRFERR5                                                         
         B     BT2AK                                                            
*                                  SET PAGE BREAK                               
BPRFERR5 MVI   ERR,PROFERR5        SEND ERROR MESSAGE                           
         BRAS  RE,ERRPROC                                                       
         B     BLDTABX                                                          
*                                                                               
BT2AK    DS    0H                                                               
         ZIC   RF,PROGPRO2+8                                                    
         LTR   RF,RF                                                            
         BZ    BT3                                                              
         LA    RF,1(RF)            ADJUST FOR MEDIA                             
***                                                                             
         LA    RF,2(RF)            ADJUST FOR PGR AND MGR LUMPING               
         CLI   PROGPRO2+8,4                                                     
         BL    *+8                                                              
         LA    RF,2(RF)                                                         
         MH    RF,=H'3'                                                         
         LA    RF,WORK-3(RF)                                                    
         LA    RE,WORK                                                          
BT2B     DS    0H                                                               
         CLI   0(RE),C'T'                                                       
         BNE   *+8                                                              
         OI    2(RE),X'80'         PAGE BREAK                                   
         LA    RE,3(RE)                                                         
         CR    RE,RF                                                            
         BNH   BT2B                                                             
*                                                                               
BT3      DS    0H                                                               
*                                  SET RECAP LEVEL                              
         ZIC   RF,PROGPRO2+7                                                    
         LTR   RF,RF                                                            
         BZ    BT3B                                                             
         LA    RF,1(RF)            ADJUST FOR MEDIA                             
         LA    RF,2(RF)            ADJUST FOR PGR AND MGR LUMPING               
         CLI   PROGPRO2+7,5        SO 4 WILL LOOK AT REGION                     
         BL    *+8                                                              
         LA    RF,2(RF)                                                         
         MH    RF,=H'3'                                                         
         LA    RF,WORK-3(RF)                                                    
*                                                                               
         CLI   0(RF),C'N'          RECAP LEVEL CAN'T BE NOT DISPLAYED           
         BE    BPRFERR             IF IT'S NOT MAIN BILL LOOKS FUNNY            
*                                                                               
         CLI   0(RF),C'X'          RECAP LEVEL CAN'T BE NOT DISPLAYED           
         BE    BPRFERR             IF IT'S NOT MAIN BILL LOOKS FUNNY            
*                                  VENDOR X - TREAT AS N                        
*                                                                               
         LA    RE,WORK                                                          
BT3A     DS    0H                                                               
         OI    2(RE),X'40'         RECAP LEVEL                                  
         LA    RE,3(RE)                                                         
         CR    RE,RF                                                            
         BNH   BT3A                                                             
BT3B     DS    0H                                                               
         MVC   BFORMAT(5),PROGPRO3        BILL $ CATAGORIES                     
         MVC   BFORMAT+5(1),PROGPRO3+9    AGY COM                               
         CLI   BFORMAT+5,0                                                      
         BNE   *+8                                                              
         MVI   BFORMAT+5,C'N'   OLD PROFLIES WILL HAVE X'00'                    
         MVC   BSTRIP,PROGPRO3+5                                                
         MVC   BORDSW,PROGPRO3+6                                                
         MVC   BPBILSW,PROGPRO3+7                                               
         MVC   BBILLSW,PROGPRO3+8                                               
*                                                                               
         MVC   PCTCTL,PROGPRO3+10         PCT BILLING CONTROL                   
         CLI   PCTCTL,C' '                                                      
         BH    *+8                                                              
         MVI   PCTCTL,C'P'                SET DEFAULT                           
         MVC   DFORMAT(5),PROGPRO4        BILL $ CATAGORIES                     
         MVC   DFORMAT+5(1),PROGPRO4+9    AGY COM                               
         CLI   DFORMAT+5,0                                                      
         BNE   *+8                                                              
         MVI   DFORMAT+5,C'N'    FOR OLD PROFLIES WHICH MAY HAVE X'00'          
*                                  FOR DETAIL BACK-UP                           
         MVC   DSTRIP,PROGPRO4+5                                                
         MVC   DORDSW,PROGPRO4+6                                                
         MVC   DPBILSW,PROGPRO4+7                                               
         MVC   DBILLSW,PROGPRO4+8                                               
         CLI   QMANUAL,C'G'                                                     
         BE    BT3B2                                                            
         CLI   QMANUAL,C'F'        FEE                                          
         BNE   BT3B4                                                            
BT3B2    MVC   BORDSW(3),=C'NNY'   FOR MANUALS SET TO BILLABLE ONLY             
         B     BT3B4X                                                           
BT3B4    CLC   =C'NO PREV',QMANUAL                                              
         BNE   BT3B4C                                                           
         MVI   BPBILSW,C'N'        SET FOR NO PREV                              
         B     BT3B4X                                                           
*                                                                               
BT3B4C   CLC   =C'ONLY PREV',QMANUAL                                            
         BNE   BT3B4E                                                           
         MVC   BORDSW(3),=C'NYN'   SET FOR ONLY PREVIOUS                        
         B     BT3B4X                                                           
*                                                                               
BT3B4E   CLC   =C'PREV',QMANUAL                                                 
         BNE   BT3B4X                                                           
         MVI   BPBILSW,C'Y'        SET ON PREV BILLING                          
BT3B4X   LA    RF,BFORMAT          EDIT BILLING PROFILE                         
         LA    RE,6                                                             
         SR    R1,R1               USED TO COUNT $ CATS                         
BT3B5    CLI   0(RF),C'Y'                                                       
         BNE   *+8                                                              
         LA    R1,1(R1)                                                         
         LA    RF,1(RF)                                                         
         BCT   RE,BT3B5                                                         
         LTR   R1,R1                                                            
         BNZ   BT3B10                                                           
*                                                                               
BPRFERR  DS    0H                                                               
         MVC   ERRPROF,=C'B4   '   CAN'T DESIGNATE ONE FIELD                    
         MVC   ERRPROF+1(1),TYPE                                                
BPRFERRX MVI   ERR,PROFERR         INVALID BILLING PROFILE                      
         BRAS  RE,ERRPROC                                                       
         B     BLDTABX                                                          
*                                                                               
BPRFERR7 DS    0H                                                               
         MVC   ERRPROF,=C'B4  8'   PROGPRO2+7                                   
         MVC   ERRPROF+1(1),TYPE                                                
         B     BPRFERRX                                                         
*                                                                               
BPRFERRA DS    0H                                                               
         MVC   ERRPROF,=C'B4A  '   CAN'T DESIGNATE ONE FIELD                    
         MVC   ERRPROF+1(1),TYPE                                                
         B     BPRFERRX                                                         
*                                                                               
BT3B10   STC   R1,BDOLNUM                                                       
         LA    RF,BORDSW           EDIT BILLING PROFILE                         
         LA    RE,3                                                             
         SR    R1,R1               USED TO COUNT $ TYPES                        
         MVI   BTYPNUM,0                                                        
BT3B15   CLI   0(RF),C'N'                                                       
         BE    BT3B18                                                           
         LA    R1,1(R1)            COUNT 'Y'S AND 'D'S                          
         CLI   0(RF),C'Y'                                                       
         BNE   *+8                                                              
         OI    BTYPNUM,X'01'       SET 'Y' FOUND                                
         CLI   0(RF),C'D'                                                       
         BNE   *+8                                                              
         OI    BTYPNUM,X'80'                                                    
BT3B18   LA    RF,1(RF)                                                         
         BCT   RE,BT3B15                                                        
         LTR   R1,R1                                                            
         BZ    BPRFERRA                                                         
         TM    BTYPNUM,X'01'                                                    
         BNO   BPRFERRA             MUST HAVE AT LEAST ONE NOT D OR N           
         TM    BTYPNUM,X'80'        SEE IF A 'D' ENTERED                        
         BZ    BT3B20                                                           
         CLI   PROGPRO2+7,0         THEN CAN'T HAVE DETAIL BACK-UP              
         BNE   BPRFERR7                                                         
BT3B20   STC   R1,BTYPNUM                                                       
*                                                                               
*        EDIT DETAIL BACKUP BILLING PROFILE                                     
BT3B25   LA    RF,DFORMAT                                                       
         LA    RE,6                                                             
         SR    R1,R1               USED TO COUNT $ CATS                         
BT3B27   CLI   0(RF),C'Y'                                                       
         BNE   *+8                                                              
         LA    R1,1(R1)                                                         
         LA    RF,1(RF)                                                         
         BCT   RE,BT3B27                                                        
         LTR   R1,R1                                                            
         BNZ   BT3B30                                                           
*                                                                               
DPRFERR  DS    0H                  DETAIL BACK-UP PROFILE                       
         MVC   ERRPROF,=C'B4B  '   CAN'T DESIGNATE ONE FIELD                    
         MVC   ERRPROF+1(1),TYPE                                                
         MVI   ERR,PROFERR         INVALID BILLING PROFILE                      
         BRAS  RE,ERRPROC                                                       
         B     BLDTABX                                                          
*                                                                               
BT3B30   STC   R1,DDOLNUM                                                       
         LA    RF,DORDSW           EDIT BILLING PROFILE                         
         LA    RE,3                                                             
         SR    R1,R1               USED TO COUNT $ TYPES                        
         MVI   DTYPNUM,0                                                        
BT3B35   CLI   0(RF),C'N'                                                       
         BE    BT3B38                                                           
         LA    R1,1(R1)                                                         
         CLI   0(RF),C'Y'          MUST FIND AT LEAST ONE 'Y'                   
         BNE   BT3B38                                                           
         OI    DTYPNUM,X'01'                                                    
BT3B38   LA    RF,1(RF)                                                         
         BCT   RE,BT3B35                                                        
         LTR   R1,R1                                                            
         BZ    DPRFERR                                                          
         CLI   DTYPNUM,X'01'       MUST FIND AT LEAST ONE 'Y'                   
         BNE   DPRFERR             CAN'T BE ALL 'D' AND 'N' S                   
         STC   R1,DTYPNUM                                                       
*                                                                               
         MVC   LSTOPT,PROGPRO2+11                                               
*                                                                               
         LA    RF,LSTOTAB          SEE IF KEEPING REVERSED & REVERSALS          
         MVI   SHOWREV,C'N'                                                     
BT3B40   CLC   LSTOPT,0(RF)                                                     
         BNE   *+18                                                             
         MVC   LSTOPT,1(RF)        SET ADJUSTED LSTOPT VALUE                    
         MVI   SHOWREV,C'Y'                                                     
         B     BT3B42                                                           
*                                                                               
         LA    RF,L'LSTOTAB(RF)    NXT ENTRY                                    
         CLI   0(RF),X'FF'                                                      
         BNE   BT3B40                                                           
*                                                                               
BT3B42   DS    0H                                                               
***           CHECK USED TO BE FOR PROGPRO2+6,C'S'  - BNE                       
***           CHANGED TO SUPPRESS PREVIOUS INV LIST FOR REQ FOR                 
***           ONE PUBLICATION  OCT27/87                                         
         CLI   QPUB,C'0'           IF ONE PUB                                   
         BL    BT3I              ONLY SHOW PREV INV AT DETAIL LEVEL             
*                                NO LIST OF PREV INV AT END                     
         CLI   LSTOPT,C'D'        LEAVE 'D' ALONE                               
         BE    BT3I                                                             
         JIF   LSTOPT,EQ,C'I',OR,LSTOPT,EQ,C'B',BT3E,JUMP=N                     
*                                  CHANGE OTHERS TO 'N'                         
         MVI   LSTOPT,C'N'         NO PREVIOUS INV LIST                         
         B     BT3I                                                             
*                                                                               
BT3E     MVI   LSTOPT,C'D'         CHANGE 'I' OR 'B' TO 'D'                     
*                                                                               
BT3I     CLI   PRDMKT,C'M'         TEST MKT TO BE HIGHER THAN PRD               
         BNE   BT3J                                                             
*                                  SWAP MKT AND PRD CLTS                        
         MVC   X(15),WORK+00                                                    
         MVC   WORK+00(12),WORK+15                                              
         MVC   WORK+12(15),X                                                    
*                                                                               
BT3J     DS    0H                                                               
*                                  S=SEPARATE                                   
*                                  T=TOGETHER                                   
*                                  N=NO                                         
         LA    R0,BRKEQVL/3                                                     
BT4      DS    0H                                                               
         CLI   0(R2),C'N'                                                       
         BNE   *+8                                                              
         MVI   0(R2),X'FF'         SET N'S LAST                                 
         LA    R2,3(R2)                                                         
         BCT   R0,BT4                                                           
*                                  SORT ON PROFILE BYTE (POSITION)              
         LA    R0,BRKEQVL/3                                                     
         GOTO1 XSORT,DMCB,WORK,(R0),3,1,0                                       
*                                  BUILD BRKTAB                                 
         LA    R2,WORK                                                          
         LA    R3,BRKTAB                                                        
         USING BRKTABD,R3                                                       
         XC    BRKTAB,BRKTAB                                                    
         SR    R7,R7                                                            
         XC    ABRKS(ABRKSL),ABRKS CLEAR CONTROL ADDRESSES                      
         XC    ATOTS,ATOTS                                                      
         XC    ATOTSV,ATOTSV                                                    
         XC    ALEVS,ALEVS                                                      
         XC    LEVCTLS,LEVCTLS                                                  
BT6      DS    0H                                                               
         ZIC   RF,1(R2)            CODE                                         
         LTR   RF,RF                                                            
         BZ    BT8                                                              
         BAS   RE,BTTAB-4(RF)                                                   
         LA    R2,3(R2)                                                         
         B     BT6                                                              
BT8      DS    0H                                                               
*                                                                               
         L     R6,ABUFFC                                                        
         USING BUFFALOD,R6                                                      
*                                                                               
         ST    R7,SORTKLEN         ACCUMED KEY LEN                              
         A     R7,BUFFLCOM                                                      
         A     R7,BUFFLDTA                                                      
         ST    R7,SORTRLEN                                                      
         LA    R7,SORTREC                                                       
         A     R7,SORTKLEN                                                      
         ST    R7,ASORTCOM                                                      
         A     R7,BUFFLCOM                                                      
         ST    R7,ASORTDTA                                                      
*                                                                               
*                                  RECALCULATE MAX LINES                        
         L     RF,BUFFCRMX                                                      
         M     RE,BUFFLALL                                                      
         D     RE,SORTRLEN                                                      
         ST    RF,BUFFCRMX                                                      
*                                                                               
         MVC   BUFFLIST(1),SORTKLEN+3     SET LENGTH OF KEY                     
         MVC   BUFFLKEY,SORTKLEN                                                
         MVC   BUFFLALL,SORTRLEN        SET LENGTH OF REC                       
         MVI   BUFFDOPT,C'Y'                                                    
*                                                                               
         GOTO1 BUFFALO,DMCB,=C'SET',ABUFFC                                      
*                                                                               
         DROP  R6                                                               
*                                                                               
*                                  SET A(TOTALS)                                
         L     R3,ALOWBRK          START AT END OF BRKTAB AND BACK UP           
         LA    R0,BRKTAB                                                        
         L     R4,=A(LEVTOTS)                                                   
         L     R5,=A(VBTAB)                                                     
BT10     DS    0H                                                               
         L     RF,BRKCODE                                                       
         LA    RF,ATOTS(RF)                                                     
         ST    R4,0(RF)                                                         
         L     RF,BRKCODE                                                       
         LA    RF,ATOTSV(RF)                                                    
         ST    R5,0(RF)                                                         
         AH    R4,TOTSIZH                                                       
         AH    R5,=Y(VTOTSIZE)                                                  
         SH    R3,=Y(BRKL)                                                      
         CR    R3,R0                                                            
         BNL   BT10                                                             
*                                                                               
         CLC   AINVBRK,APMSELO                                                  
         BNH   *+10                                                             
         MVC   APMSELO,AINVBRK                                                  
         OC    MANGRS(12),MANGRS    IF MANUAL                                   
         BZ    *+10                                                             
         XC    ARECAP,ARECAP       TEN NO RECAPS                                
         CLC   APAGBRK,AINVBRK                                                  
         BNL   *+10                                                             
         MVC   APAGBRK,AINVBRK                                                  
         OC    ARECAP,ARECAP                                                    
         BZ    BT10B                                                            
         CLC   ARECAP,AINVBRK      IF RECAP OPT IS NOT LOGICAL                  
         BNL   *+10                                                             
         MVC   ARECAP,AINVBRK      SET TO INVOICE BRK                           
BT10B    DS    0H                                                               
         MVC   SVPAGBRK,APAGBRK    SAVE PAGE LEVEL                              
         MVC   SVLOWTOG,ALOWTOG    AND LOWEST TOGETHER                          
*                                  CHANGE CTL FROM T TO P                       
*                                  FOR TOGETHERS ON SEP PAGE                    
         LA    R3,BRKTAB                                                        
         XC    AHITOG,AHITOG                                                    
BT11     DS    0H                                                               
         OC    BRKCODE,BRKCODE                                                  
         BZ    BT11D                                                            
         CLI   BRKCTL1,C'T'                                                     
         BNE   BT11B                                                            
         C     R3,APAGBRK                                                       
         BH    BT11A                                                            
         MVI   BRKCTL1,C'P'                                                     
         LA    RF,LEVCTLS                                                       
         A     RF,BRKCODE                                                       
         MVI   0(RF),C'P'                                                       
         B     BT11B                                                            
*                                                                               
BT11A    DS    0H                                                               
         OC    AHITOG,AHITOG       SAVE HIGHEST TOGETHER BRK                    
         BNZ   *+8                                                              
         ST    R3,AHITOG                                                        
*                                                                               
*                                                                               
BT11B    DS    0H                                                               
         LA    R3,BRKL(R3)                                                      
         B     BT11                                                             
BT11D    DS    0H                                                               
         CLI   AORSW,C'Y'          SEE IF DOING AOR                             
         BNE   BT11F                                                            
*                                                                               
         CLC   QAGENCY,=C'SJ'      IF SJR ALLOW MULTI-MEDIA                     
         BE    BT11D5              AOR                                          
*                                                                               
         CLC   QAGENCY,=C'DM'      IF DOREMUS ALLOW MULTI-MEDIA                 
         BE    BT11D5              AOR                                          
*                                                                               
         CLI   RCMULTIQ,C'Y'       NO MULTI-MEDIA REQ FOR AOR                   
         BE    BT11E                                                            
BT11D5   DS    0H                                                               
         CLI   AORLOPT,C'Y'     SEE IF LISTING PRD/EST ON AOR                   
         BE    BT11F            YES - ALLOW PRDS TOGETHER                       
         CLI   AORLOPT,C'C'     SEE IF LISTING PRD/EST ON AOR AT END            
         BE    BT11F            YES - ALLOW PRDS TOGETHER                       
         CLI   PRDCTL,C'S'         NO - THEN PRODUCT MUST BE SEPARATE           
         BE    BT11F                                                            
BT11E    MVI   ERR,AORERR                                                       
         BRAS  RE,ERRPROC                                                       
         B     BLDTABX                                                          
*                                                                               
BT11F    DS    0H                                                               
*                                                                               
*                                                                               
BLDTABX  DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
BTTAB    DS    0F                                                               
         B     BTMED                                                            
         B     BTPGR1                                                           
         B     BTPGR2                                                           
         B     BTPGR3                                                           
         B     BTPRD                                                            
         B     BTEST                                                            
         B     BTMGR1                                                           
         B     BTMGR2                                                           
         B     BTMGR3                                                           
         B     BTMKT                                                            
         B     BTJOB                                                            
         B     BTPUB                                                            
         B     BTDESC                                                           
         B     BTPER                                                            
         B     BTPERG                                                           
         B     BTCTYP                                                           
         B     BTCRDB                                                           
*                                                                               
         SPACE 2                                                                
BTPGR1   DS    0H                                                               
         ZIC   R4,PGR1LEN          DIVISIONS                                    
         B     BTALL                                                            
         SPACE 2                                                                
BTPGR2   DS    0H                  FUTURE USE                                   
         ZIC   R4,PGR2LEN                                                       
         B     BTALL                                                            
         SPACE 2                                                                
BTPGR3   DS    0H                  FUTURE USE                                   
         ZIC   R4,PGR3LEN                                                       
         B     BTALL                                                            
         SPACE 2                                                                
BTPRD    DS    0H                                                               
         LA    R4,3                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTMGR1   DS    0H                  REGIONS                                      
         ZIC   R4,MGR1LEN                                                       
         B     BTALL                                                            
         SPACE 2                                                                
BTMGR2   DS    0H                  DISTRICTS                                    
         ZIC   R4,MGR2LEN                                                       
         B     BTALL                                                            
         SPACE 2                                                                
BTMGR3   DS    0H                  FUTURE USE                                   
         ZIC   R4,MGR3LEN                                                       
         B     BTALL                                                            
         SPACE 2                                                                
BTMKT    DS    0H                                                               
         LA    R4,20                                                            
         B     BTALL                                                            
         SPACE 2                                                                
BTEST    DS    0H                                                               
         LA    R4,2                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTJOB    DS    0H                                                               
         LA    R4,33       PRD(3),ADID(12),JOB(6),ADID2(12)                     
*                          ADID PRESENT HERE ONLY FOR AD ID ONLY                
*                          JOB WILL BEGIN WITH X'FF'                            
*                          ADID2 MAY BE PRESENT FOR "NORMAL' ADCODES            
**WB**                                                                          
*                          FOR WB FLIGHT PRD WILL BE SET TO X'FFFFFF'           
*                          FOLLOWED BY THE FLIGHT CODE                          
**WB**                                                                          
         B     BTALL                                                            
         SPACE 2                                                                
BTDESC   DS    0H                                                               
         LA    R4,6                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTPER    DS    0H                                                               
         LA    R4,1                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTPERG   DS    0H                                                               
         LA    R4,1                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTMED    DS    0H                                                               
         LA    R4,2                MEDIA AND FINANSW                            
         B     BTALL                                                            
         SPACE 2                                                                
BTCRDB   DS    0H                                                               
         LA    R4,1                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTPUB    DS    0H                                                               
         LA    R4,6                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTCTYP   DS    0H                                                               
         LA    R4,2                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTALL    DS    0H                                                               
         LTR   R4,R4               BYPASS = LEN = 0                             
         BNE   BTALL1                                                           
         MVI   0(R2),C'N'                                                       
         BR    RE                                                               
BTALL1   DS    0H                                                               
         CLI   0(R2),X'FF'         TEST BYPASSED                                
         BNE   BTALL2                                                           
         MVI   0(R2),C'N'          RESET FF TO N                                
         TM    2(R2),X'0F'         TEST OK TO BYPASS                            
         BZR   RE                  YES                                          
BTALL2   DS    0H                                                               
         CLI   0(R2),C'R'          CHAGE R TO S                                 
         BNE   *+8                 (PER GRP FOR RETAIL SUMMARY)                 
         MVI   0(R2),C'S'                                                       
         TM    2(R2),X'01'                                                      
         BZ    BTALL4                                                           
         ST    R3,APMSELO         SAVE 'LOWEST' (HIGH IN CORE)                  
*                                  OF PRD,MKT,STA,EST                           
BTALL4   DS    0H                                                               
         TM    2(R2),X'02'                                                      
         BZ    BTALL6                                                           
         ST    R3,APEPLO           SAVE 'LOWEST' OF PRD-EST-PER                 
         OC    APEPHI,APEPHI                                                    
         BNZ   *+8                                                              
         ST    R3,APEPHI           SAVE 'HIGHEST'                               
BTALL6   DS    0H                                                               
         ZIC   RF,1(R2)                                                         
         ST    RF,BRKCODE          CODE                                         
         ST    R7,BRKDISP          DISP = CUMED LENGTH                          
         AR    R7,R4                                                            
         BCTR  R4,R0                                                            
         ST    R4,BRKLENM1         LENGTH OF FIELD - 1                          
*                                                                               
         MVC   BRKCTL1,0(R2)       CONTROL BYTE                                 
*                                                                               
         ST    R3,ALOWBRK          SAVE ADDR OF LOWEST BRK                      
         LA    RF,ABRKS-4                                                       
         A     RF,BRKCODE                                                       
         ST    R3,0(RF)            SET ADDR OF THIS LEV BRK                     
*                                                                               
         CLI   BRKCTL1,C'T'                                                     
         BNE   BTALL7                                                           
         C     R3,APERBRK                                                       
         BE    BTALL7                                                           
         ST    R3,ALOWTOG     LOWEST 'TOGETHER' (EXC PER )                      
BTALL7   DS    0H                                                               
         LA    RF,ALEVS                                                         
         A     RF,BRKCODE                                                       
         LA    R0,SORTREC                                                       
         A     R0,BRKDISP                                                       
         ST    R0,0(RF)            SET ADDR OF FIELD                            
         LA    RF,LEVCTLS                                                       
         A     RF,BRKCODE                                                       
         MVC   0(4,RF),BRKCTL1                                                  
         CLI   0(R2),C'S'                                                       
         BNE   *+8                                                              
         ST    R3,AINVBRK          A(LEVEL FOR NEW INVOICE)                     
         CLI   0(R2),C'N'                                                       
         BE    BTALL8                                                           
         TM    2(R2),X'80'                                                      
         BZ    *+8                                                              
         ST    R3,APAGBRK          A(PAGE BREAK LEVEL)                          
         TM    2(R2),X'40'                                                      
         BZ    *+8                                                              
         ST    R3,ARECAP           A(RECAP LEVEL)                               
BTALL8   DS    0H                                                               
         LA    R3,BRKL(R3)                                                      
         BR    RE                                                               
         SPACE 3                                                                
*                                  TABLE OF BRK CODES AND LENGTHS               
*                                  BYTE 1 - TO BE FILLED IN FROM PROF           
*                                  BYTE 2 - CODE                                
*                                  BYTE 3 - CONTROL GROUP                       
*                                  X'01' = PRD,EST,MKT,STA                      
*                                  X'02' = PRD,EST,PER                          
*                                  X'04' = NECESSARY FOR OTHER REASON           
*                                         (COST TYPE FOR NETWORK)               
BRKEQV   DS    0C                                                               
         DC    X'000400'           MEDIA                                        
         DC    X'000800'           PGR1                                         
         DC    X'000C00'           PGR2                                         
         DC    X'001000'           PGR3                                         
         DC    X'001403'           PRD                                          
         DC    X'001803'           EST                                          
         DC    X'001C00'           MGR1                                         
         DC    X'002000'           MGR2                                         
         DC    X'002400'           MGR3                                         
         DC    X'002800'           MKT                                          
BRKJOB   DC    X'002C00'           JOB                                          
BRKPUB   DC    X'003001'           PUB                                          
BRKDESC  DC    X'003400'           DESC                                         
         DC    X'003802'           PERIOD                                       
         DC    X'003C00'           PERIOD GROUP                                 
         DC    X'004000'           COST TYPE                                    
         DC    X'004400'           CREDIT/DEBIT BREAK                           
BRKEQVL  EQU   *-BRKEQV                                                         
         SPACE 3                                                                
*                                                                               
*        IF FIRST CHARACTER MATCHES LSTOPT, IT WILL                             
*        BE RESET TO THE SECOND AND SHOWREV GETS SET TO "Y"                     
*                                                                               
LSTOTAB  DS    0XL2                                                             
         DC    C'CA'                                                            
         DC    C'WY'                                                            
         DC    C'SR'                                                            
         DC    C'TB'                                                            
         DC    C'UI'                                                            
         DC    C'VD'                                                            
         DC    X'FF'                                                            
LSTOTBL  EQU   *-LSTOTAB                                                        
         LTORG                                                                  
         TITLE 'SETDATE - MASSAGE QSTART + QEND'                                
*                                                                               
SETDATE  NMOD1 0,SETDATE                                                        
         LA    RC,SPACEND                                                       
         LA    R8,SETDATE+4095                                                  
         LA    R8,1(R8)                                                         
         USING SETDATE+4096,R8                                                  
*                                                                               
*        SET FX RATE DISPLAY OPTION FROM FX PROFILE                             
*                                                                               
         MVI   FXROPT,C'N'    SET TO DEFAULT                                    
*                                                                               
         XC    WORK,WORK                                                        
         MVC   WORK(4),=C'POFX'                                                 
         MVC   WORK+4(3),QAGENCY                                                
         L     RF,ADCLT                                                         
         MVC   WORK+7(3),PCLTKCLT-PCLTREC(RF)                                   
         LA    RF,PCLTOFF-PCLTREC(RF)                                           
         CLI   0(RF),C' '                                                       
         BNH   *+14                                                             
         MVI   WORK+10,C'*'        SET OFFICE CODE                              
         MVC   WORK+11(1),0(RF)                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROGPROF,DATAMGR,,WORK+16              
         GOTOR PRNTPROF,DMCB,WORK,PROGPROF,WORK+16                              
         OC    PROGPROF,PROGPROF   WAS IT FOUND?                                
         BZ    *+10                                                             
         MVC   FXROPT,PROGPROF+1                                                
*                                  READ B2 PROFILE                              
         XC    WORK,WORK                                                        
         MVC   WORK(4),=C'POB2'                                                 
***E***                                                                         
         CLC   QPROG,=C'E1'        FOR ESTIMATE READ E PROFILES                 
         BNE   *+10                                                             
         MVC   WORK+2(2),=C'E2'                                                 
***E***                                                                         
         MVC   WORK+4(3),QAGENCY                                                
         L     RF,ADCLT                                                         
         MVC   WORK+7(3),PCLTKCLT-PCLTREC(RF)                                   
         LA    RF,PCLTOFF-PCLTREC(RF)                                           
         CLI   0(RF),C' '                                                       
         BNH   *+14                                                             
         MVI   WORK+10,C'*'        SET OFFICE CODE                              
         MVC   WORK+11(1),0(RF)                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROGPROF,DATAMGR,,WORK+16              
         GOTOR PRNTPROF,DMCB,WORK,PROGPROF,WORK+16                              
*                                                                               
         OC    PROGPROF,PROGPROF                                                
         BNZ   SETD0                                                            
         MVI   ERR,TYPERR          NO B2 PROFILE                                
**WB**                                                                          
         B     SDERROR                                                          
**WB**                                                                          
*                                  READ TYPE PROF INTO PROGPRO2                 
SETD0    MVC   WORK+3(1),TYPE                                                   
         MVC   WORK+4(3),QAGENCY   RE-SET AGENCY                                
         XC    WORK+16(L'WORK-16),WORK+16                                       
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROGPRO2,DATAMGR,,WORK+16              
         GOTOR PRNTPROF,DMCB,WORK,PROGPRO2,WORK+16                              
*        GOTO1 (RF),(R1),,PROGPRO2                                              
         OC    PROGPRO2,PROGPRO2                                                
         BNZ   SETD01                                                           
         MVI   ERR,TYPERR          NO PROFILE                                   
**WB**                                                                          
         B     SDERROR                                                          
**WB**                                                                          
SETD01   DS    0H                                                               
*                                                                               
         CLC   QAGENCY,=C'SJ'           SJR                                     
         BE    SETD01B                                                          
         CLC   QAGENCY,=C'*B'           DDSB                                    
         BNE   SETD01C                                                          
SETD01B  CLC   QCLIENT,=C'AMC'         CHECK FOR PO TESTING CLIENT              
         BE    *+14                                                             
         CLC   QCLIENT,=C'POT'         CHECK FOR PO TESTING CLIENT              
         BNE   SETD01C                                                          
         MVI   PO#OPT,C'Y'                                                      
         MVI   PO#TYPE,C'E'             PO# BY ESTIMATE                         
         MVC   PO#EFFD,=X'6A02'         FEB/2006 - FOR TESTING                  
*                                       C= BY CLIENT, P= BY PRODUCT             
         MVC   PO#ANNO(10),=C'PUR. ORD.#'                                       
         MVI   PROGPRO2+5,C'S'     USE JOB CONTROL FOR FLIGHTS                  
*** TESTING MANUAL PO# BILL                                                     
*******  OC    MANGRS(12),MANGRS                                                
*******  BZ    *+10                                                             
*******  MVC   QPO#SEQ,=X'0001'   PATCH TO SEQ # 0001                           
*** TESTING MANUAL PO# BILL                                                     
*                                                                               
SETD01C  DS    0H                                                               
**WB**                                                                          
         CLI   WBSW,C'Y'           WB FLIGHT FEATURE?                           
         BNE   *+8                                                              
         MVI   PROGPRO2+5,C'S'     USE JOB CONTROL FOR FLIGHTS                  
*                                                                               
*        COULD SEND ERROR IF PROGPRO2 IS ALREADY S                              
*                                                                               
**WB**                                                                          
         CLI   MIDASSW,C'Y'        FOR MIDAS FORCE PUB TO NO                    
         BNE   *+16                                                             
         TM    FLAG1,SHOWMVEN      UNLESS PROFILE IS OVERRIDING                 
         BO    *+8                                                              
         MVI   PROGPRO2+6,C'N'                                                  
*                                                                               
         MVC   WORK(4),=C'PB A'    MUST READ B4-7A PROFILE                      
***E***                                                                         
         CLC   QPROG,=C'E1'        FOR ESTIMATE READ E4-7 A PROFILE             
         BNE   *+8                                                              
         MVI   WORK+1,C'E'                                                      
***E***                                                                         
         MVC   WORK+2(1),TYPE                                                   
         MVC   WORK+4(3),QAGENCY   RE-SET AGENCY                                
         NI    WORK,X'BF'          MAKE SYSTEM LOWER CASE                       
         XC    WORK+16(L'WORK-16),WORK+16                                       
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROGPRO3,DATAMGR,,WORK+16              
         GOTOR PRNTPROF,DMCB,WORK,PROGPRO3,WORK+16                              
*        GOTO1 (RF),(R1),,PROGPRO3                                              
         OC    PROGPRO3,PROGPRO3                                                
         BNZ   SETD01D                                                          
         MVI   ERR,TYPERR          NO PROFILE                                   
**WB**                                                                          
         B     SDERROR                                                          
**WB**                                                                          
*                                                                               
SETD01D  DS    0H                                                               
         XC    PROFB2B,PROFB2B     GET B2B PROFILE                              
         MVC   WORK(4),=C'PB2B'                                                 
         NI    WORK,X'BF'          MAKE SYSTEM LOWER CASE                       
         XC    WORK+16(L'WORK-16),WORK+16                                       
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB2B,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,PROFB2B,WORK+16                               
*        GOTO1 (RF),(R1),,PROFB2B                                               
*                                                                               
         CLI   QMEDIA,C'I'         PLANNED COST ONLY FOR MEDIA I                
         BE    SETD01D5                                                         
         CLI   QMEDIA,C'L'         OR FOR MEDIA L                               
         BE    SETD01D5                                                         
         CLI   QMEDIA,C'B'         OR FOR MEDIA B                               
         BE    SETD01D5                                                         
         CLI   QMEDIA,C'V'         OR FOR MEDIA V                               
         BE    SETD01D5                                                         
         CLI   QMEDIA,C'W'         OR FOR MEDIA W                               
         BE    SETD01D5                                                         
         CLI   QMEDIA,C'D'         OR FOR MEDIA D                               
         BE    SETD01D5                                                         
*                                                                               
         CLI   QMEDIA,C'S'         CHECK FOR MEDIA S                            
         BNE   SETD01DS                                                         
         CLI   PROFB2B+15,C'S'     PLANNED COST ALLOWED FOR MEDIA S             
         BNE   SETD01DS                                                         
         LA    RF,WORK+16                                                       
         USING PROFINFD,RF                                                      
         CLI   PROFIMED,C'S'       BE SURE I FOUND A MEDIA S PROFILE            
         BE    SETD01D5            IF NOT, DON'T HONOR PC BILLING               
         DROP  RF                                                               
*                                                                               
SETD01DS MVI   PROGPRO3+12,C'N'    DEFAULT TO N                                 
         MVC   PROGPRO3+13(2),=X'FFFF'                                          
         B     SETD01EX                                                         
*                                                                               
SETD01D5 DS    0H                                                               
         CLI   PROGPRO3+12,0                                                    
         BNE   *+8                                                              
         MVI   PROGPRO3+12,C'N'    DEFAULT TO N                                 
         OC    PROGPRO3+13(2),=X'0000'  EFFECTIVE DATE GIVEN?                   
         BNE   SETD01E                                                          
         B     SETD01EX                                                         
*                                                                               
SETD01E  MVC   W(2),PROGPRO3+13                                                 
         CLI   PROGPRO3+14,0      NO MONTH GIVEN?                               
         BNE   *+8                                                              
         MVI   W+1,X'01'          SET TO JANUARY                                
         MVI   W+2,X'01'                                                        
         GOTO1 DATCON,DMCB,(3,W),(0,W+6)                                        
         GOTO1 DATCON,DMCB,(0,W+6),(3,W)                                        
         MVC   PROGPRO3+13(2),W                                                 
*                                                                               
*        CODE ABOVE SHOULD CONVERT BINARY DATE TO EBCDIC                        
*        THEN BACK TO BINARY - THIS IS NEEDED FOR Y2K PROFILE VALUES            
*                                                                               
*                                                                               
SETD01EX MVC   WORK(4),=C'PB B'    MUST READ B4-7B PROFILE                      
*                                  HAS FORMAT FOR DETAIL BACK-UP                
*                                  THIS PROFILE IS OPTIONAL                     
***E***                                                                         
         CLC   QPROG,=C'E1'     FOR ESTIMATE USE E4-7 B PROFILE                 
         BNE   *+8                                                              
         MVI   WORK+1,C'E'                                                      
***E***                                                                         
         MVC   WORK+2(1),TYPE                                                   
         MVC   WORK+4(3),QAGENCY   RE-SET AGENCY                                
         NI    WORK,X'BF'          MAKE SYSTEM LOWER CASE                       
         XC    WORK+16(L'WORK-16),WORK+16                                       
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROGPRO4,DATAMGR,,WORK+16              
         GOTOR PRNTPROF,DMCB,WORK,PROGPRO4,WORK+16                              
*        GOTO1 (RF),(R1),,PROGPRO4                                              
         OC    PROGPRO4,PROGPRO4                                                
         BNZ   *+10                                                             
         MVC   PROGPRO4,PROGPRO3   USE B4-7A PROFILE IF B                       
*                                  IS NOT FOUND                                 
*                                                                               
******** DUMMY B4-7C PROFILE FOR TESTING                                        
******** MVC   PROFSCC(4),=C'B122' FOR TESTING                                  
******** B     SETDCA                                                           
******** DUMMY B4-7C PROFILE FOR TESTING                                        
         MVC   WORK(4),=C'PB C'    MUST READ B4-7C PROFILE                      
         MVC   WORK+2(1),TYPE                                                   
         MVC   WORK+4(3),QAGENCY   RE-SET AGENCY                                
         NI    WORK,X'BF'          MAKE SYSTEM LOWER CASE                       
         XC    WORK+16(L'WORK-16),WORK+16                                       
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFSCC,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,PROFSCC,WORK+16                               
*                                                                               
SETDCA   L     RE,ASCCTAB                                                       
         OC    PROFSCC,PROFSCC     DO I HAVE A SCC PROFILE?                     
         BZ    SETDCD                                                           
         CLI   PROFSCC,C'N'        SEE IF NOT SHOWING CATEGORY                  
         BE    SETDCB                                                           
         CLI   PROFSCC+1,C'1'      IF YES, IS IT THE FIRST?                     
         BNE   SETDCB                                                           
         MVC   0(2,RE),=X'2029'    INTERNAL CODE FOR CATEGORY 8233              
         MVC   2(1,RE),PROFSCC     SET HEADER CONTROL                           
         MVI   3(RE),C'N'          DATA ON NEXT LINE                            
         LA    RE,6(RE)            BUMP TO NEXT ENTRY                           
*                                                                               
SETDCB   CLI   PROFSCC+2,C'N'      SEE IF NOT SHOWING MARKET                    
         BE    SETDCD                                                           
         MVC   0(2,RE),=X'201D'    INTERNAL CODE FOR MARKET 8221                
         MVC   2(1,RE),PROFSCC+2   SET HEADER CONTROL                           
         MVI   3(RE),C'N'          DATA ON NEXT LINE                            
         LA    RE,6(RE)                                                         
         CLI   PROFSCC,C'N'        SEE IF CATEGORY REQUIRED                     
         BE    SETDCD                                                           
         CLI   PROFSCC+1,C'1'      WAS IT FIRST?                                
         BE    SETDCD                                                           
         MVC   0(2,RE),=X'2029'    CATEGORY MUST BE SECOND                      
         MVC   2(1,RE),PROFSCC     SET HEADER CONTROL                           
         MVI   3(RE),C'N'          DATA ON NEXT LINE                            
         LA    RE,6(RE)                                                         
*                                                                               
*                                                                               
SETDCD   DS    0H                  IF BOTH N OR NO PROFSCC                      
*                                                                               
*        THESE 3 FIELDS WILL BE PROFILE CONTROLLED (PROFSCC)                    
*                                                                               
         CLI   PROFSCC+4,C'Y'      SHOW?                                        
         BNE   *+22                                                             
         MVC   0(2,RE),=X'202C'    LINE ITEM NAME (PACKAGE?)                    
         MVI   2(RE),C'D'          NO HEADINGS - ONLY DATA                      
         MVI   3(RE),C'S'          DATA ON SAME LINE                            
         LA    RE,6(RE)                                                         
         CLI   PROFSCC+5,C'Y'      SHOW UNITS?                                  
         BNE   *+22                                                             
         MVC   0(2,RE),=X'2031'    UNITS                                        
         MVI   2(RE),C'2'          SECOND HEADING ONLY                          
         MVI   3(RE),C'S'         DATA ON SAME LINE                             
         LA    RE,6(RE)                                                         
         CLI   PROFSCC+6,C'Y'      SHOW RATE?                                   
         BNE   *+22                                                             
         MVC   0(2,RE),=X'2035'    RATE                                         
         MVI   2(RE),C'2'          SECOND HEADING ONLY                          
         MVI   3(RE),C'S'          DATA ON SAME LINE                            
         LA    RE,6(RE)                                                         
SETDCDX  MVI   0(RE),X'FF'         TABLE WILL HAVE ONLY X'FF'                   
*                                  OTHERWISE END OF TABLE                       
*                                                                               
*                                  IS NOT FOUND                                 
SETD01X  MVI   SUMOPT,C'N'                                                      
         MVC   CDSEP,PROGPROF+2                                                 
         MVC   ADJSEP,PROGPROF+3                                                
         MVC   OSDOPT,PROGPROF+4    ON-SALE DATE OPTION                         
         MVC   DOCOPT,PROGPROF+13   DOCUMENT/INV OPTION                         
*                                                                               
         MVC   WIOPT,PROGPRO3+11   SUPPRESS COST (WESTERN) OPTION               
         CLI   WIOPT,C' '          FROM B4-7A PROFILE                           
         BH    *+8                                                              
         MVI   WIOPT,C'N'          SET DEFAULT                                  
*                                                                               
         MVI   AORSW,C'Y'                                                       
         CLI   PROGPROF+3,C'A'      SAME PROFILE BYTE AS ADJSEP                 
         BE    *+8                                                              
         MVI   AORSW,C'N'                                                       
         CLI   ADJSEP,C'A'                                                      
         BNE   *+8                                                              
         MVI   ADJSEP,C'N'                                                      
*                                                                               
         CLI   QOPTB,C' '        SEE IF OVERRIDING ADJSEP                       
         BNH   *+10                                                             
         MVC   ADJSEP,QOPTB                                                     
*                                                                               
         CLI   QOPT8,C'C'         SEE IF UFC COMMISSION BILLING                 
         BNE   *+8                                                              
         MVI   ADJSEP,C'N'                                                      
*                                                                               
         CLI   QOPT8,C'N'         SEE IF UFC NET BILLING                        
         BNE   *+8                                                              
         MVI   ADJSEP,C'N'         ONLY SET ADJSEP TO "N"                       
*                                  CDSEP CAN BE LEFT ALONE                      
*                                  READ FOR B1A PROFILE                         
         XC    PROFB1A,PROFB1A                                                  
         MVC   WORK(4),=C'PB1A'                                                 
         NI    WORK,X'BF'          MAKE SYSTEM LOWER CASE                       
         XC    WORK+16(L'WORK-16),WORK+16                                       
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB1A,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,PROFB1A,WORK+16                               
*                                                                               
         MVC   MOSOPT,PROFB1A+3  MONTH OF SERVICE (NOT MONTH OF)                
         CLI   MOSOPT,0                                                         
         BNE   *+8                                                              
         MVI   MOSOPT,C'N'     SET 0 TO N                                       
*                                                                               
         CLC   QAGENCY,=C'M$'       SEE IF MULLEN                               
         BNE   SETD01X5                                                         
         CLI   MOSOPT,C'N'          IS IS SET TO N?                             
         BNE   SETD01X5             NO - THEN LEAVE ALONE                       
         MVI   MOSOPT,C'X'          X = SUPPRESS IN HEADLINES                   
*                                                                               
SETD01X5 CLC   QPROG,=C'D1'                                                     
         BE    SETD02                                                           
         CLC   QPROG,=C'RD'                                                     
         BE    SETD02                                                           
         B     SETD02E                                                          
*                                                                               
SETD02   MVI   PROFB1A+2,C'N'      NO SEPARATE REGISTER FOR DRAFT               
         B     SETD02K                                                          
SETD02E  DS    0H                                                               
         L     RF,VMASTC                                                        
         USING MASTD,RF                                                         
         L     R1,MCVREMOT                                                      
         USING REMOTED,R1                                                       
         OC    REMOTKEY,REMOTKEY    PRINTING DIRECT?                            
         BNZ   SETD02K                                                          
         B     SETD02             OTHERWISE NO SEPARATE REGISTER                
*                                                                               
         DROP  RF                                                               
         DROP  R1                                                               
*                                                                               
SETD02K  DS    0H                                                               
*                                                                               
***                                                                             
*        READING OF PB1X PROFILE MOVED HERE FROM AGMPROC                        
***                                                                             
         XC    PROGPROX,PROGPROX   FIRST GET EXTENSION PROFILE                  
         MVC   WORK(4),=C'PB1X'                                                 
         NI    WORK,X'BF'          MAKE SYSTEM LOWER CASE                       
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROGPROX,DATAMGR,,WORK+16              
         GOTOR PRNTPROF,DMCB,WORK,PROGPROX,WORK+16                              
*                                                                               
SETD03   DS    0H                                                               
         XC    PROFAOR,PROFAOR     GET AOR PROFILE                              
         MVI   AORLOPT,C'N'        SET TO NO                                    
         MVC   WORK(4),=C'PB2A'                                                 
         NI    WORK,X'BF'          MAKE SYSTEM LOWER CASE                       
         XC    WORK+16(L'WORK-16),WORK+16                                       
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFAOR,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,PROFAOR,WORK+16                               
*        GOTO1 (RF),(R1),,PROFAOR                                               
         OC    PROFAOR,PROFAOR           SEE IF I HAVE AOR PROFILE              
         BZ    SETD05                                                           
         MVC   AORSW,PROFAOR+0                                                  
         MVC   AORLOPT,PROFAOR+1        AOR DETAIL OPTION                       
*                                                                               
         CLI   AORLOPT,C' '                                                     
         BH    *+8                                                              
         MVI   AORLOPT,C'N'             DEFAULT TO N                            
         MVC   AORTXOPT,PROFAOR+3       AOR TAX OPTION                          
         CLI   AORTXOPT,C' '                                                    
         BH    *+8                                                              
         MVI   AORTXOPT,C'Y'                                                    
         MVC   AORNOPT,PROFAOR+6        SHOW NET WHEN LISTING                   
         CLI   AORNOPT,C' '                                                     
         BH    *+8                                                              
         MVI   AORNOPT,C'N'             DEFAULT TO N                            
*                                                                               
SETD05   DS    0H                                                               
         XC    PROFB2B,PROFB2B     GET B2B PROFILE                              
         MVC   WORK(4),=C'PB2B'                                                 
         NI    WORK,X'BF'          MAKE SYSTEM LOWER CASE                       
         XC    WORK+16(L'WORK-16),WORK+16                                       
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB2B,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,PROFB2B,WORK+16                               
*******  GOTO1 (RF),(R1),,PROFB2B                                               
*                                                                               
         CLI   QMEDIA,C'I'        PLANNED COST ONLY FOR MEDIA I                 
         BE    SETD5A                                                           
         CLI   QMEDIA,C'L'        OR FOR MEDIA L                                
         BE    SETD5A                                                           
         CLI   QMEDIA,C'B'        OR FOR MEDIA B                                
         BE    SETD5A                                                           
         CLI   QMEDIA,C'V'        OR FOR MEDIA V                                
         BE    SETD5A                                                           
         CLI   QMEDIA,C'W'        OR FOR MEDIA W                                
         BE    SETD5A                                                           
         CLI   QMEDIA,C'D'        OR FOR MEDIA D                                
         BE    SETD5A                                                           
*                                                                               
         CLI   QMEDIA,C'S'         CHECK FOR MEDIA S                            
         BNE   SETD05NS                                                         
         CLI   PROFB2B+15,C'S'     PLANNED COST ALLOWED FOR MEDIA S             
         BNE   SETD05NS                                                         
         LA    RF,WORK+16                                                       
         USING PROFINFD,RF                                                      
         CLI   PROFIMED,C'S'       BE SURE I FOUND A MEDIA S PROFILE            
         BNE   SETD05NS            IF NOT, DON'T HONOR PC BILLING               
         MVI   PROFB2B+12,C'Y'     SET FOR PLANNED COST BILLING                 
         B     SETD5A                                                           
         DROP  RF                                                               
*                                                                               
SETD05NS MVI   PROFB2B+12,C'N'     DEFAULT TO N                                 
         MVC   PROFB2B+13(2),=X'FFFF'                                           
         B     SETD5AX                                                          
*                                                                               
SETD5A   DS    0H                                                               
         CLI   PROFB2B+12,0                                                     
         BNE   *+8                                                              
         MVI   PROFB2B+12,C'N'     DEFAULT TO N                                 
         OC    PROFB2B+13(2),=X'0000'   EFFECTIVE DATE GIVEN?                   
         BNE   SETD5A0                                                          
         MVC   PROFB2B+13(2),=X'FFFF'                                           
         B     SETD5AX                                                          
*                                                                               
SETD5A0  MVC   W(2),PROFB2B+13                                                  
         CLI   PROFB2B+14,0       NO MONTH GIVEN?                               
         BNE   *+8                                                              
         MVI   W+1,X'01'          SET TO JANUARY                                
         MVI   W+2,X'01'                                                        
         GOTO1 DATCON,DMCB,(3,W),(0,W+6)                                        
         GOTO1 DATCON,DMCB,(0,W+6),(3,W)                                        
         MVC   PROFB2B+13(2),W                                                  
*                                                                               
SETD5AX  DS    0H                                                               
*                                                                               
*        CODE ABOVE SHOULD CONVERT BINARY DATE TO EBCDIC                        
*        THEN BACK TO BINARY - THIS IS NEEDED FOR Y2K PROFILE VALUES            
*                                                                               
         MVC   SCBOPT,PROFB2B+0                                                 
         MVI   SCBNCSW,0                                                        
         CLI   SCBOPT,C'Y'                                                      
         BNE   SETD10                                                           
*                                                                               
         CLI   CDSEP,C'R'       DISALLOW SPECIAL CD HANDLING (+APPLY)           
         BE    SETD05A                                                          
         CLI   CDSEP,C'C'          DISALLOW SPECIAL CD HANDLING                 
         BNE   SETD05B                                                          
SETD05A  DS    0H                B2B PROFILE INVALID                            
         MVC   ERRPROF,=C'B2B01'   FIRST FIELD                                  
         MVI   ERR,PROFERR         INVALID PROFILE                              
**WB**                                                                          
         B     SDERROR                                                          
**WB**                                                                          
*COST2*                                                                         
SETD05B  DS    0H                                                               
         CLI   CAROPTC,C'Y'        NO UPFRONT COMM BILLING                      
         BE    SETD05B2            FOR CARAT COST 2                             
*COST2 *                                                                        
         TM    FINANSW,X'01'                                                    
         BNO   SETD05C                                                          
SETD05B2 DS    0H                B2B PROFILE INVALID                            
         MVC   ERRPROF,=C'B2B01'   FIRST FIELD                                  
         MVI   ERR,PROFERR         NO UPFRONT COMMISSION BILLING                
**WB**                                                                          
         B     SDERROR                                                          
**WB**                                                                          
*                                                                               
SETD05C  DS    0H                                                               
         CLI   PROFB2B+12,C'Y'       DISALLOW UFC WITH PLANNED COST             
         BE    SETD05B2              (GETINS ISSUE)                             
*                                                                               
         MVC   SCBNCSW,QOPT8                                                    
         CLI   SCBNCSW,C'C'          MUST HAVE TYPE C, N, OR R                  
         BE    SETD15                                                           
         CLI   SCBNCSW,C'N'                                                     
         BE    SETD15                                                           
         CLI   SCBNCSW,C'R'                                                     
         BE    SETD15                                                           
SETD05E  MVI   ERR,SCBERR                                                       
**WB**                                                                          
         B     SDERROR                                                          
**WB**                                                                          
*                                                                               
SETD10   CLI   QOPT8,C' '      IF NOT COMMISSION OPTION IS INVALID              
         BNE   SETD05E                                                          
*                                                                               
SETD15   DS    0H                                                               
         TM    FINANSW,X'01'    FINANCIAL OR RJ PALMER TYPE COST2               
         BNO   SETD15C                                                          
         CLI   PROFB2B+12,C'Y'    DISALLOW PLANNED COST                         
         BNE   SETD15C                                                          
*                                                                               
         MVC   ERRPROF,=C'B2B12'   PLANNED COST FIELD  #12                      
         MVI   ERR,PROFERR         NO PLANNED COST                              
**WB**                                                                          
         B     SDERROR                                                          
**WB**                                                                          
*                                                                               
SETD15C  XC    RETPROF,RETPROF                                                  
         MVI   ACCSYSOV,0      CLEAR ACC SYSTEM OVERRIDE                        
         CLI   NONRET,C'Y'                                                      
         BE    SETD25B                                                          
***E***                                                                         
***E***  DO READ RETAIL PROFILE FOR E1 NOW                                      
***E***                                                                         
***E***  CLC   QPROG,=C'E1'   FOR RETAIL FOR ESTIMATES                          
***E***  BE    SETD25B                                                          
***E***                                                                         
*                                                                               
         MVC   WORK(4),=C'P0B9'        READ FOR RETAIL PROFILE                  
         XC    WORK+16(L'WORK-16),WORK+16                                       
         GOTO1 GETPROF,DMCB,(X'A0',WORK),RETPROF,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,RETPROF,WORK+16                               
*        GOTO1 (RF),(R1),,RETPROF                                               
*                                                                               
         CLI   RETPROF,0                                                        
         BE    SETD25B                                                          
*                                                                               
         MVC   WORK(4),=C'PB9A'        READ FOR B9A RETIAL PROF                 
         NI    WORK,X'BF'          MAKE SYSTEM LOWER CASE                       
         XC    WORK+16(L'WORK-16),WORK+16                                       
         GOTO1 GETPROF,DMCB,(X'A0',WORK),X,DATAMGR,,WORK+16                     
         GOTOR PRNTPROF,DMCB,WORK,X,WORK+16                                     
         MVC   ACCSYSOV,X+8     SAVE ACC SYS OVERRIDE                           
*                                                                               
***E***                                                                         
         CLC   QPROG,=C'E1'        ESTIMATE REPORT                              
         BNE   *+8                                                              
         MVI   RETPROF+6,C'N'      NO SUMMARY BILL                              
***E***                                                                         
         TM    FINANSW,X'01'       NO RETAIL FOR FINANCIAL CLIENTS              
         BNO   *+6                                                              
         DC    H'0'                MUST DIE                                     
*                                                                               
         MVI   PROGPRO2+7,0        NO DETAIL-BACKUP FOR RETAIL                  
*                                                                               
         MVI   CDSEP,C'N'          NO CD SEPARATE FOR RETAIL                    
         MVI   ADJSEP,C'N'         NO ADJ SEPARATE FOR RETAIL                   
         MVI   AORSW,C'N'          NO AOR FOR RETAIL                            
*                                                                               
         MVC   SUMOPT,RETPROF+6    CORP SUMMARY                                 
         CLI   RETDRAFT,C'Y'                                                    
         BNE   *+12                                                             
         MVI   SUMOPT,C'N'                                                      
         MVI   RETPROF+11,C'Y'     ACTIVATE PCT PRINTING                        
*                                                                               
*                                  SET UP GDAREA FOR FINDOUT                    
         L     R4,=A(GDAREA)                                                    
         USING GDSECT,R4                                                        
         XC    GDCOMP(255),GDCOMP                                               
         XC    GDCOMP+255(GDSECTL-255),GDCOMP+255                               
         MVC   GDCOMP(3),RETPROF                                                
         MVC   GDMED,QMEDIA        SET MEDIA CODE                               
         MVC   GDMGRLEN,RETPROF+3     REGION LENGTH                             
         MVC   SVREGLEN,RETPROF+3                                               
         MVC   SVDSTLEN,RETPROF+4                                               
         ZIC   R0,GDMGRLEN                                                      
         ZIC   R1,RETPROF+4      ADD DISTRICT LENGTH                            
         AR    R0,R1                                                            
         STC   R0,GDMGRLEN                                                      
         CLI   RETPROF+14,C'*'     TEST PSEUDO MGR (ACCT PREFIX)                
         BNH   *+8                                                              
         MVI   GDMGRLEN,1                                                       
         MVI   GDMKTLEN,0                                                       
         MVC   GDOUTLEN,RETPROF+5                                               
*                                                                               
         MVC   GDDMGR,DATAMGR                                                   
         MVC   GDAUTL,UTL                                                       
         MVC   GDACCSYS,ACCTSE                                                  
*                                                                               
         CLI   ACCSYSOV,0        SEE IF ACC SYSTEM OVERRIDE PRESENT             
         BE    *+10                                                             
         MVC   GDACCSYS,ACCSYSOV    USE IT                                      
*                                                                               
         MVC   GDATABS,AFOTABS                                                  
         MVI   GDOUTNO,0                                                        
         DROP  R4                                                               
*                                                                               
         CLI   ACCTSE,0        MUST HAVE VALID ACCOUNT SE                       
         BNE   SETD25B                                                          
         MVI   ERR,IDERR                                                        
**WB**                                                                          
         B     SDERROR                                                          
**WB**                                                                          
*                                                                               
SETD25B  DS    0H                                                               
*                                                                               
         L     R4,=A(VATACCS)      VAT ACCOUNT TABLE                            
         SR    R5,R5                                                            
         MVC   WORK(4),=C'P0VA'                                                 
*                                                                               
STD26    DS    0H                                                               
         GOTO1 GETPROF,DMCB,(X'A0',WORK),X,DATAMGR,,WORK+16                     
**       SKIP DISPLAY OF THESE PROFILES                                         
**       TO SAVE BYTES - TEMP FIX FOR ADDRESSIBLITY ERROR                       
**                                                                              
**NO-OP  GOTOR PRNTPROF,DMCB,WORK,X,WORK+16                                     
**                                                                              
         BAS   RE,FIXVACC          *'S TO SPACES                                
         MVC   0(16,R4),X                                                       
         LA    R5,1(R5)                                                         
         CH    R5,=Y(NPROVS)                                                    
         BH    STD26B                                                           
         LA    R4,16(R4)                                                        
         MVI   WORK+3,C'A'        MUST USE "A" FOR PROVINCE 10                  
         CH    R5,=H'10'                                                        
         BE    STD26A                                                           
*                                                                               
         LA    RF,X'F0'(R5)                                                     
         STC   RF,WORK+3           PROVINCE NUMBER                              
STD26A   DS    0H                                                               
         MVC   WORK(3),=C'PVA'                                                  
         NI    WORK,X'BF'          SYSTEM LOWER CASE                            
         B     STD26                                                            
*                                                                               
STD26B   DS    0H                                                               
*                                                                               
         B     STD26C              SKIP AROUND UNLESS NEEDED                    
*                                                                               
         L     RF,APATCH           CHECK FOR SPECIAL PATCHES                    
         OC    1(15,RF),0(RF)  SEE IF OVERRIDING B4-7 PROFILE                   
         BZ    *+10     1 BEYOND SINCE MAY JUST BE 1 BYTE PATCH                 
         MVC   PROGPRO2,0(RF)   OVERRIDE B4-7 PROFILE                           
*******  OC    16(16,RF),16(RF)                                                 
*******  BZ    *+10                                                             
*******  MVC   PROGPRO4(14),16(RF)     DONT CLOBBER DATE                        
STD26C   DS    0H                                                               
*                                                                               
*                                                                               
*                                                                               
*                                  INVOICE DATE                                 
         LA    R4,TODAY            USE TODAY                                    
** CODE NO-OPED 7/19/90                                                         
** SINCE QINVDATE AND QDUEDAYS MOVED TO QPAY (COL 53)                           
** AND CAN CO-EXIST WITH PUB,JOB, OR RD=                                        
**       CLI   QPUB,C' '           SEE IF PUB SPECIFIED                         
**       BNE   SETD25E                                                          
**       CLI   QPUB+1,C'J'      AD CODE FILTER                                  
**       BE    SETD25E                                                          
**       CLC   QPUB+1(3),=C'RD='      DIV/REG/DST OVERRIDE                      
**       BE    SETD25E                                                          
*                                                                               
         CLI   QINVDATE,C' '                                                    
         BNH   *+8                                                              
         LA    R4,QINVDATE         UNLESS REQ OVERRIDE                          
*                                                                               
SETD25E  MVC   EINVDTE,0(R4)                                                    
*                                                                               
         CLI   DATEOPT,C'Y'     SEE IF SHOWING CENTURY                          
         BNE   SETD25G                                                          
         GOTO1 DATCON,DMCB,(R4),(20,WORK)                                       
         GOTO1 DATCON,(R1),(R4),(5,PINVDTE)                                     
         MVC   PINVDTE+6(4),WORK   MMMDD/YYYY                                   
         B     SETD25H                                                          
*                                                                               
SETD25G  GOTO1 DATCON,DMCB,(R4),(5,PINVDTE)                                     
SETD25H  GOTO1 (RF),(R1),,(3,BINVDTE)                                           
         GOTO1 (RF),(R1),,(2,BINVDTEP)                                          
*                                  DUE DATE CALC                                
** CODE NO-OPED 7/19/90                                                         
** SINCE QINVDATE AND QDUEDAYS MOVED TO QPAY (COL 53)                           
** AND CAN CO-EXIST WITH PUB,JOB, OR RD=                                        
**       CLI   QPUB,C' '           SEE IF PUB SPECIFIED                         
**       BNE   SETD26                                                           
**       CLI   QPUB+1,C'J'      AD CODE FILTER                                  
**       BE    SETD26                                                           
*                                                                               
         CLI   QDUEDAYS,C' '                                                    
         BNH   SETD26                                                           
         PACK  DUB,QDUEDAYS(2)                                                  
         CVB   R0,DUB                                                           
         STC   R0,BYTE                                                          
         B     SETD28                                                           
*                                                                               
SETD26   DS    0H                                                               
         MVC   BYTE,PROGPROF                                                    
SETD28   DS    0H                                                               
         MVC   PDUEDTE(16),SPACES   CLEAR DUE DATES                             
         MVC   PSHPDTE,SPACES   CLEAR SHIP                                      
         XC    BDUEDTE(5),BDUEDTE                                               
         CLI   BYTE,0                                                           
         BE    SETD30                                                           
         ZIC   R0,BYTE                                                          
         GOTO1 ADDAY,DMCB,EINVDTE,EDUEDTE,(R0)                                  
*                                                                               
         CLI   DATEOPT,C'Y'     SEE IF SHOWING CENTURY                          
         BNE   SETD28C                                                          
         GOTO1 DATCON,DMCB,EDUEDTE,(20,WORK)                                    
         GOTO1 DATCON,(R1),EDUEDTE,(5,PDUEDTE)                                  
         MVC   PDUEDTE+6(4),WORK   MMMDD/YYYY                                   
         B     SETD28D                                                          
*                                                                               
SETD28C  GOTO1 DATCON,DMCB,EDUEDTE,(5,PDUEDTE)                                  
SETD28D  GOTO1 (RF),(R1),,(3,BDUEDTE)                                           
         GOTO1 (RF),(R1),,(2,BDUEDTEP)                                          
*                                                                               
         CLI   PROFB2B+10,0         SEE IF SHIP DATE IS NEEDED                  
         BE    SETD30                                                           
         ZIC   R0,PROFB2B+10                                                    
         LCR   R0,R0                                                            
         GOTO1 ADDAY,DMCB,EDUEDTE,WORK,(R0)                                     
         GOTO1 DATCON,DMCB,WORK,(5,PSHPDTE)                                     
*                                                                               
SETD30   DS    0H                                                               
         MVC   PEOVOPT,PROGPROF+11   'Y' = USE PRD/EST COLS OVERRIDE            
*                                                                               
         MVC   JOBOPT,PROGPROF+1     FOR SHOW AD FILE INFO  N,1,2,A,B           
         CLI   PROGPROF+8,C'4'                                                  
         BL    SETD30A                                                          
         CLC   TYPE,PROGPROF+8     TEST VALID BILLING TYPE                      
         BNH   SETD30A                                                          
         MVI   ERR,TYPERR                                                       
**WB**                                                                          
         B     SDERROR                                                          
**WB**                                                                          
SETD30A  DS    0H                                                               
*                                                                               
         CLI   PROGPRO2+3,C'S'      REG/DST                                     
         BE    SETD30A2                                                         
         CLI   PROGPRO2+4,C'S'      MKTS                                        
         BE    SETD30A2                                                         
*                                                                               
         CLI   WBSW,C'Y'            WB FLIGHT FEATURE ON?                       
         BE    *+12                 IF YES - BYPASS THIS CHECK                  
*                                   IT'S USED FOR WB FLIGHTS                    
*                       **CONCERN** COULD CAUSE PROBLEMS IF THEY                
*                                   BILL ESTS TOGETHER?                         
*                                                                               
         CLI   PROGPRO2+5,C'S'      JOBS                                        
         BE    SETD30A2                                                         
*                                                                               
         CLI   PROGPRO2+6,C'S'      PUBS                                        
         BE    SETD30A2                                                         
*                                                                               
**WB**                                                                          
**NO-OP  CLI   WBSW,C'Y'            WB FLIGHT FEATURE?                          
**NO-OP  BE    SETD30A2             (LIKE JOBS SEPARATE)                        
**WB**                                                                          
*                                                                               
         CLI   PROGPRO2+13,C'N'     CAN'T USE NON-N WITH AORLOPT=C              
         BNE   SETD30A2             (I CAN'T CLEAR THE PEPTAB FOR C             
*                                   BUT MUST FOR PROGPRO2+13 NON-N)             
*                                   OBTOTS VS. DBTOTS MIGHT NOT MATCH           
*                                                                               
         CLI   ADJSEP,C'Y'          ADJ SEP                                     
         BE    SETD30A2                                                         
         CLI   CDSEP,C'Y'           OR CD SEP                                   
         BNE   SETD30A3                                                         
*                                                                               
SETD30A2 CLI   AORLOPT,C'C'          INCOMPATIBLE WITH AOR                      
         BNE   SETD30A3              CLIENT LIST MODE                           
         MVI   ERR,AORPERR                                                      
**WB**                                                                          
         B     SDERROR                                                          
**WB**                                                                          
*                                                                               
SETD30A3 DS    0H                                                               
         MVC   TESTFLAG,PROGPROF+7                                              
*******                                                                         
         CLC   QPROG,=C'D1'      DRAFT BILLING                                  
         BNE   *+8                                                              
         MVI   TESTFLAG,C'T'        SET TEST MODE                               
         CLC   QPROG,=C'RD'      DRAFT BILLING (REBATE)                         
         BNE   *+8                                                              
         MVI   TESTFLAG,C'T'        SET TEST MODE                               
*******                                                                         
         CLI   RETDRAFT,C'Y'                                                    
         BNE   *+8                                                              
         MVI   TESTFLAG,C'T'                                                    
******                                                                          
         B     SETD30A4            BYPASS SEP VS. BACK-UP CHECK                 
*******                                                                         
**       CLI   ADJSEP,C'Y'         CANNOT HAVE SEP ADJ                          
**       BE    SETD30A2                                                         
**       CLI   CDSEP,C'Y'         CANNOT HAVE SEP CD                            
**       BNE   SETD30A4                                                         
**TD30A2 CLI   PROGPRO2+7,0        AND DETAIL BACKUP                            
**       BE    SETD30A4                                                         
**       MVI   ERR,ADJERR                                                       
**       BRAS  RE,ERRPROC                                                       
**                                                                              
SETD30A4 DS    0H                                                               
         MVI   BOXNO,0               WAS PROGPROF+4                             
         MVC   PAYOPT,PROGPRO2+10    BILL CLEARED ITEMS ONLY                    
         CLI   PAYOPT,0                                                         
         BNE   *+8                                                              
         MVI   PAYOPT,C'N'           TO INSURE DEFAULT TO 'N'                   
*                                                                               
         CLI   PROGPRO3+12,C'P'      PLANNED COST OPT IS INVALID                
         BE    SD30A4E               WITH PAYOPT NOT N                          
         CLI   PROGPRO3+12,C'A'      PLANNED COST OPT IS INVALID                
         BE    SD30A4E               WITH PAYOPT NOT N                          
         CLI   PROGPRO3+12,C'B'      PLANNED COST OPT IS INVALID                
         BE    SD30A4E               WITH PAYOPT NOT N                          
         B     SD30A4G                                                          
*                                                                               
SD30A4E  CLI   PAYOPT,C'N'                                                      
         BE    SD30A4G                                                          
         MVC   ERRPROF,=C'B4 11'      B4-B7 FIELD 11                            
         MVC   ERRPROF+1(1),TYPE                                                
         MVI   ERR,PROFERR                                                      
**WB**                                                                          
         B     SDERROR                                                          
**WB**                                                                          
*                                                                               
*        PAYOPT VALUES                                                          
* N  =  ALL ITEMS                                                               
* Y  =  CLEARED ITEMS ONLY                                                      
* S  =        "             + NO MESSAGE                                        
* C  =        "             + NO MESSAGE + CHG ORDERED TO CLEARED               
* E  =  CLEARED ESTS ONLY  (NO UNPAID INSERTIONS)                               
* F  =        "             + NO MESSAGE                                        
* G  =        "             + NO MESSAGE + CHG ORDERED TO CLEARED               
*                                                                               
* D  =   CLEARED ITEMS ONLY + DELETED ITEMS MUST BE                             
*                             FULLY CLEARED                                     
*                                                                               
****************** SPECIAL FOR MW(TO)  TO SUPPRESS MESSAGE                      
****************** SPECIAL FOR PA(TO)  TO SUPPRESS MESSAGE                      
SD30A4G  CLC   QAGENCY,=C'MW'                                                   
         BE    *+14                                                             
         CLC   QAGENCY,=C'PA'                                                   
         BNE   SETD30A5                                                         
         CLI   PAYOPT,C'Y'                                                      
         BNE   SETD30A5                                                         
         MVI   PAYOPT,C'S'           RESET TO SUPPRESS MESSAGE                  
****************** END OF SPECIAL FOR MW(TO)                                    
*                                                                               
SETD30A5 TM    FINANSW,X'01'         NO PAYED OPT FOR FINANCIAL CLIENTS         
         BNO   SETD30A6                                                         
         CLI   PAYOPT,C'N'                                                      
         BE    SETD30A6                                                         
*                                                                               
         MVC   ERRPROF,=C'B4 11'      B4-B7 FIELD 11                            
         MVC   ERRPROF+1(1),TYPE                                                
         MVI   ERR,PROFERR                                                      
**WB**                                                                          
         B     SDERROR                                                          
**WB**                                                                          
*                                                                               
SETD30A6 MVC   TAXOPT,PROGPROF+12                                               
         CLI   MIDASSW,C'Y'       FOR MIDAS SET TAXOPT TO N                     
         BE    *+12                                                             
         CLI   TAXOPT,0                                                         
         BNE   *+8                                                              
         MVI   TAXOPT,C'N'      CAN BE 'Y' OR 'S' (SUPPRESS DISPLAY)            
         MVI   NOPMBRK,C'N'                                                     
*                                                                               
         MVC   NOZEOPT,PROGPRO2+15     SUPPRESSING ZONE/EDITION?                
         CLI   NOZEOPT,0                IF NOT SPECIFIED                        
         BNE   *+8                                                              
         MVI   NOZEOPT,C'N'             SET TO "N"                              
*                                                                               
*                                                                               
         L     RE,ADAGY                                                         
         CLI   PAGYNAT-PAGYREC(RE),C'C'   SEE IF CANADIAN AGY                   
         BNE   SETD30A7                                                         
*                                                                               
         CLI   NOZEOPT,C'Y'     SEE IF SUPPRESSING ZONE/EDITION                 
         BNE   SETD30A7                                                         
         CLI   PROFB1A+0,C'Y'   THEN MUST BEING PST FOR ALL PUBS                
         BE    SETD30A7         SINCE I WON'T BE ABLE TO READ PUB               
         MVI   ERR,PROFERR6                                                     
**WB**                                                                          
         B     SDERROR                                                          
**WB**                                                                          
*                                                                               
SETD30A7 DS    0H                                                               
*                                  TOGETHER                                     
         CLI   QPRIORMD,C'T'       PRIOR MONTHS SPECIFIED IN REQUEST?           
         BNE   SETD3A8            NO, CHECK PROFILE                             
         PACK  DUB,QPRIORMO        GET NUMBER OF PRIOR MONTHS...                
         CVB   R0,DUB                                                           
         STC   R0,PRIOR                                                         
         OI    PRIOR,X'C0'         PRIOR = X'C1'..X'CC'                         
         B     SETD30B                                                          
*                                                                               
SETD3A8  DS    0H                  SEPARATE                                     
         CLI   QPRIORMD,C'S'       PRIOR MONTHS SPECIFIED IN REQUEST?           
         BNE   SETD3A9            NO, CHECK PROFILE                             
         PACK  DUB,QPRIORMO        GET NUMBER OF PRIOR MONTHS...                
         CVB   R0,DUB                                                           
         STC   R0,PRIOR                                                         
         OI    PRIOR,X'F0'         PRIOR = X'F1'..X'FC'                         
         B     SETD30B                                                          
*                                                                               
SETD3A9  DS    0H                                                               
         MVC   PRIOR,PROGPRO2+9                                                 
         CLI   PRIOR,C'Z'                                                       
         BNE   SETD30A8                                                         
         MVI   PRIOR,C'T'                                                       
         MVI   NOPMBRK,C'Y' PRIOR MONTHS TOGETHER WITH NO BREAKOUT              
*                                                                               
SETD30A8 CLC   =C'NO PRIOR',QMANUAL                                             
         BNE   *+8                                                              
         MVI   PRIOR,C'N'                                                       
         MVI   NMOS,1              NO PRIOR MONTHS                              
         CLI   PRIOR,C'N'                                                       
         BE    SETD31                                                           
*                                                                               
         MVI   NMOS,MAXMOS                                                      
*                                                                               
         CLI   PRIOR,C'U'      25 PRIOR MONTHS SEP                              
         BE    SETD31                                                           
         CLI   PRIOR,C'V'      25 PRIOR MONTHS TOGETHER                         
         BE    SETD31                                                           
         CLI   PRIOR,C'W'      CURRENT ON ONE INV + 24 PRIOR                    
         BE    SETD31          TOGETHER ON ANOTHER                              
*                                                                               
         MVI   NMOS,X'0D'      DEFAULT TO 13                                    
*                                                                               
         CLI   PRIOR,X'CC'     A-I = 1-9 PRIOR MOS TOGETHER                     
*                              X'CA' = 10 , X'CB' = 11, X'CC' = 12              
         BNH   SETD30B                                                          
         CLI   PRIOR,C'1'          AND 1-12 = 1-12 PRIORS SEPARATE              
         BL    SETD31                                                           
SETD30B  DS    0H                                                               
         ZIC   RF,PRIOR                                                         
         LA    RF,1(RF)                                                         
         STC   RF,NMOS                                                          
         NI    NMOS,X'0F'                                                       
SETD31   DS    0H                                                               
*                                                                               
         CLI   BFRMOS,C'Y'      IF MOS ALLOWED ON NEW BILL FORMULA RECS         
         BNE   SETD31A9                                                         
         CLI   PRIOR,C'S'       THEN MUST HAVE SEP BILLS PER MOS                
         BE    SETD31A9                                                         
         CLI   PRIOR,C'U'       25 SEPARATE                                     
         BE    SETD31A9                                                         
         CLI   PRIOR,C'N'                                                       
         BE    SETD31A9                                                         
         CLI   PRIOR,C'1'  CURRENT MONTH PRIORS ON SEPARATE INVS.               
         BNL   SETD31A9                                                         
*                          OTHER PRIOR MONTHS OPTIONS MAY                       
*                          HAVE MORE THAN ONE MOS ON ONE INV.                   
         MVI   ERR,MOSERR                                                       
**WB**                                                                          
         B     SDERROR                                                          
**WB**                                                                          
*                                                                               
SETD31A9 DS    0H                                                               
                                                                                
         MVC   ZBOPT,PROGPROF+5    ZERO BILL OPTION                             
         MVC   ZUOPT,PROGPROF+9    PREVIOUSLY BILLED INS OPT                    
         MVC   ZLOPT,PROGPROF+10      ZERO LINE OPTION                          
         CLI   RETDRAFT,C'Y'                                                    
         BNE   *+8                                                              
         MVI   ZLOPT,C'0'                                                       
         MVI   ORIGTYPE,0                                                       
*******  MVC   ORIGTYPE,PROGPROF+6     TYPE NOT TO MARK DETAILS                 
         MVC   FREEOPT,PROGPROF+6      Y = BILL "FREE" BUYS                     
*                                      WHOSE INS. DATE IS ON OR AFTER           
*                                      AUG01/92                                 
*                                      C = SUPPRESS ZERO COST2 INS.             
*                                          OR ZERO BILLABLE COST2               
         OC    MANGRS(12),MANGRS                                                
         BZ    *+12                                                             
         MVI   NMOS,1                                                           
         MVI   PRIOR,C'N'          NO PRIOR IF MANUAL                           
SETD32   DS    0H                                                               
*                                  SET MGR BUCKETS OPT                          
         MVI   MGRBKTS,C'N'                                                     
         B     SETD34                                                           
***                                                                             
*        WAS MKTGROUP SCHEME CHK FOR SPOT                                       
***                                                                             
*                                                                               
SETD34   DS    0H                                                               
SETD34D  DS    0H                                                               
         OC    MANUALS,MANUALS     IF ANY MANUAL ENTRY                          
         BNZ   SETD35              IGNORE PROF PERCENTZGE                       
         ZIC   RF,PROGPRO2+12      TAKE FROM B4-7 PROFILE                       
         MH    RF,=H'100'                                                       
         ST    RF,MANPCT                                                        
SETD35   DS    0H                                                               
         MVI   PCTNET,C'Y'         PCT ON BOTH GROSS + NET                      
         CLC   MANPCT,=F'14900'    BUT, IF OVER 149 PCT                         
         BNH   SETD36                                                           
         L     RF,MANPCT                                                        
         S     RF,=F'10000'        SUBTRACT 100 PCT AND TAKE                    
         ST    RF,MANPCT                                                        
         MVI   PCTNET,C'N'         PCT OF GROSS ONLY                            
SETD36   DS    0H                                                               
         MVC   NEWSTART,PROGPROF+14     STARTING YM FOR NEW BILLING             
         OC    NEWSTART(2),NEWSTART   MUST CHECK 2 BYTES NOW                    
*                                     SINCE Y2K YEARS MIGHT BE 0                
         BNZ   *+10                                                             
*******  CLI   NEWSTART,0                                                       
*******  BNE   *+10                                                             
         MVC   NEWSTART,AGMSTADT                                                
         OC    NEWSTART(2),NEWSTART   MUST CHECK 2 BYTES NOW                    
*                                     SINCE Y2K YEARS MIGHT BE 0                
         BNZ   SETD36C                                                          
******** CLI   NEWSTART,0                                                       
******** BNE   *+10                                                             
         MVC   NEWSTART,FFS        NOT USING                                    
         B     SETD36X                                                          
*                                                                               
SETD36C  DS    0H                                                               
         MVC   WORK(2),NEWSTART                                                 
         MVI   WORK+2,X'01'                                                     
         GOTO1 DATCON,DMCB,(3,WORK),(0,WORK+6)                                  
         GOTO1 DATCON,DMCB,(0,WORK+6),(3,WORK)                                  
         MVC   NEWSTART(2),WORK                                                 
*                                                                               
*        CODE ABOVE SHOULD CONVERT BINARY DATE TO EBCDIC                        
*        THEN BACK TO BINARY - THIS IS NEEDED FOR Y2K PROFILE VALUES            
*                                                                               
SETD36X  DS    0H                                                               
         SPACE 2                                                                
         XC    PERLIST(PERLSTLQ),PERLIST                                        
         MVI   PARTIAL,C'N'                                                     
         CLI   QEND,C' '       TEST START-END GIVEN                             
         BE    SETD3                                                            
*                                  YES- SET DATES DIRECTLY                      
         GOTO1 DATCON,DMCB,QSTART,(3,BQSTART)                                   
         GOTO1 (RF),(R1),QEND,(3,BQEND)                                         
         LA    RF,PERLIST                                                       
         MVC   0(2,RF),BQSTART     YM                                           
         MVC   2(6,RF),BQSTART     YMD,YMD                                      
         MVI   8(RF),X'FF'                                                      
         CLC   BQSTART(2),BQEND    DATES CANNOT SPAN MONTH                      
         BE    SETD2B                                                           
SETDERR  MVI   ERR,DATERR2         INVALID PERIOD                               
**WB**                                                                          
         B     SDERROR                                                          
**WB**                                                                          
*                                                                               
SETD2B   DS    0H                                                               
         MVC   WORK(2),BQSTART                                                  
         BAS   RE,DTEXP                                                         
         CLC   WORK(6),BQSTART     UNLESS DATES = MONTH DATES                   
         BE    *+8                                                              
         MVI   PARTIAL,C'Y'        SET PARTIAL MONTH REQ                        
         MVC   CURPER(8),PERLIST                                                
         B     SETD4                                                            
*                                                                               
SETD3    DS    0H                  MONTH REQUEST                                
         MVC   WORK(4),QSTART                                                   
         MVC   WORK+4(2),=C'01'                                                 
         GOTO1 DATCON,DMCB,WORK,(3,WORK)                                        
*                                                                               
         ZIC   R6,NMOS                                                          
         SLL   R6,3                X 8                                          
         LA    R6,PERLIST-8(R6)    POINT TO LAST ENTRY                          
         LR    R5,R6               SAVE ADDR OF LAST ENTRY                      
         MVI   8(R6),X'FF'         SET END                                      
*                                                                               
SETD3B   DS    0H                                                               
         BAS   RE,DTEXP                                                         
         MVC   0(2,R6),WORK        YM                                           
         MVC   2(6,R6),WORK        YMD,YMD                                      
*                                                                               
         CLI   WORK+1,1            IF JANUARY                                   
         BNE   SETD3F                                                           
         MVI   WORK+1,12           SET TO DEC                                   
         ZIC   RF,WORK             OF PREV YEAR                                 
         BCTR  RF,R0                                                            
         STC   RF,WORK                                                          
         B     SETD3H                                                           
*                                                                               
SETD3F   DS    0H                                                               
         ZIC   RF,WORK+1           ELSE DECREMENT MONTH                         
         BCTR  RF,R0                                                            
         STC   RF,WORK+1                                                        
*                                                                               
SETD3H   DS    0H                                                               
         SH    R6,=H'8'            UP ONE POSITION                              
         LA    R0,PERLIST                                                       
         CR    R6,R0                                                            
         BNL   SETD3B                                                           
*                                                                               
*                                  SET DERIVED START-END DATES IN REQ           
         MVC   CURPER(8),0(R5)                                                  
         MVC   BQSTART(6),2(R5)                                                 
         GOTO1 DATCON,DMCB,(3,BQSTART),QSTART                                   
         GOTO1 (RF),(R1),(3,BQEND),QEND                                         
*                                                                               
SETD4    DS    0H                                                               
SETD45   CLC   PERLIST(2),NEWSTART                                              
         BNL   SETD23              BEFORE START OF NEW BILLING                  
         XC    PLWK,PLWK           NOTE THAT THIS CLEARS PART OF X              
*                                  FOR 25 MONTHS I NEEDED MORE AREA             
*                                  SO I USED PLWK                               
         MVC   PLWK(PERLSTLQ),PERLIST                                           
         XC    PERLIST(PERLSTLQ),PERLIST                                        
         MVC   PERLIST(PERLSTLQ-8),PLWK+8                                       
         B     SETD45                                                           
SETD23   DS    0H                                                               
         CLI   PERLIST,X'FF'                                                    
         BE    SETDERR             MUST HAVE SOME DATE LEFT                     
         XC    PLWK,PLWK                                                        
*                                                                               
*        CHECK PERLIST VS. START MOS OF BILLING BY PO#                          
*        IF FIRST MOS IS EARLIER THAT PO# START MONTH                           
*        DO NOTHING.  IF ON OR AFTER PO# BILLINF START MOS                      
*        CLEAR THE ONES BEFORE THE PO# START MOS AND SET AN X'FF'               
*                                                                               
*                                                                               
         CLI   PO#OPT,C'Y'    BILLIG BY PO#?  (FROM CLIENT)                     
         BNE   SETD55                                                           
         OC    PO#EFFD,PO#EFFD   DO I HAVE AN EFFECTIVE MOS?                    
         BZ    SETD55                                                           
*                                FIND HIGHEST MONTH                             
         LA    R2,PERLIST+8      NEXT MOS                                       
SETD23A  CLI   0(R2),X'FF'       END OF LIST                                    
         BE    SETD23B                                                          
         LA    R2,8(R2)          NEXT MONTH                                     
         B     SETD23A                                                          
*                                                                               
SETD23B  SH    R2,=H'8'          BACK-UP TO LAST MOS                            
         CLC   0(2,R2),PO#EFFD     CHECK HIGHEST MOS VS. EFFD MOS               
         BL    SETD53              GO SET OFF PO#OPT AND PROCESS                
*                                                                               
*        ADJUST PERLIST AND REMOVE MOS BEFORE EFFECTIVE DATE                    
*                                                                               
*                                                                               
SETD23C  CLC   PERLIST(2),PO#EFFD  MONTH BELOW EFFECTIVE DATE                   
         BNL   SETD23X             BEFORE START OF PO# BILLING                  
         XC    PLWK,PLWK           NOTE THAT THIS CLEARS PART OF X              
*                                  FOR 25 MONTHS I NEEDED MORE AREA             
*                                  SO I USED PLWK                               
         MVC   PLWK(PERLSTLQ),PERLIST                                           
         XC    PERLIST(PERLSTLQ),PERLIST                                        
         MVC   PERLIST(PERLSTLQ-8),PLWK+8                                       
         B     SETD23C                                                          
SETD23X  DS    0H                                                               
         CLI   PERLIST,X'FF'                                                    
         BE    SETDERR             MUST HAVE SOME DATE LEFT                     
         XC    PLWK,PLWK                                                        
         B     SETD55                                                           
*                                SO ANY PRIOR MONTHS                            
*                                BEFORE THE PO# BILLING                         
*                                EFFECTIVE MONTH WILL BE SKIPPED                
SETD53   MVI   PO#OPT,C'N'       SET OFF BILLING BY PO#                         
*                                IF FIRST MONTH IS BEFORE                       
*                                PO#EFFD                                        
*                                                                               
SETD55   DS    0H                                                               
         CLI   PO#OPT,C'Y'       SEE IF STILL Y                                 
         BNE   *+8                                                              
         MVI   PROGPRO2+5,C'S'   USE JOB CONTROL FOR PO#                        
         B     SETDATEX                                                         
*                                                                               
SDERROR  BRAS  RE,ERRPROC                                                       
*                                                                               
SETDATEX DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
DTEXP    DS    0H                EXPAND YYMM IN WORK TO YYMMDD-YYMMDD           
         MVI   WORK+2,1                                                         
         MVC   WORK+3(3),WORK                                                   
         MVC   WORK+6(12),MTHDAYS  TABLE OF HIGH DAYS                           
         TM    WORK,X'01'          TEST LEAP                                    
         BNZ   *+8                                                              
         MVI   WORK+6+1,29         SET FEB TO 29                                
*                                                                               
         ZIC   RF,WORK+1                                                        
         LA    RF,WORK+6-1(RF)     POINT TO MONTH                               
         MVC   WORK+5(1),0(RF)                                                  
         BR    RE                                                               
*                                                                               
MTHDAYS  DC    AL1(31,28,31,30,31,30,31,31,30,31,30,31)                         
*                                                                               
         SPACE 2                                                                
*              FIXVACC - FIX VAT ACCOUNT CODES                                  
*                                                                               
FIXVACC  DS    0H                                                               
         LA    RF,X                CHANGE * TO SPACE                            
         LA    R0,16                                                            
         CLI   0(RF),C'*'                                                       
         BNE   *+8                                                              
         MVI   0(RF),C' '                                                       
         LA    RF,1(RF)                                                         
         BCT   R0,*-16                                                          
         BR    RE                                                               
*                                                                               
         SPACE 3                                                                
         LTORG                                                                  
*                                                                               
PLWK     DS    (MAXMOS)XL8                                                      
         DS    XL9                                                              
*                                                                               
         DROP  R8                                                               
*                                                                               
         TITLE 'TOSORT - PASS RECORDS TO SORT/BUFFALO'                          
*                                                                               
TOSORT   NMOD1 0,TOSORT                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         CLI   SORTTRCE,C'Y'                                                    
         BNE   TS4                                                              
*                                                                               
         MVC   P1+1(7),=C'SORT IN'                                              
         MVI   P1,X'10'             FORCE PRINT                                 
         GOTO1 HEXOUT,DMCB,SORTREC,P1+10,SORTRLEN,=C'N'                         
         MVI   SKIPSPEC,C'Y'                                                    
         GOTO1 =A(PRNT)                                                         
TS4      DS    0H                                                               
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFFC,SORTREC                              
*                                                                               
TSX      DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'GETNUM - GET AND FORMAT INVOICE NUMBER'                         
GETNUM   NMOD1 0,GETNUM                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         MVI   RCTRACE,C'N'        SUPPRESS TRACE                               
         MVI   FCRDCLOS,C'Y'        SO I WILL READ CLOSED-OUT BILLS             
*                              NEEDED SINCE UNBILLING NOW CLOSES-OUT            
*                              BILLS INSTEAD OF DELETING THEM                   
*                                                                               
         ST    R1,SAVR1                                                         
         LM    R2,R3,0(R1)                                                      
         CLI   0(R1),0                                                          
         BNE   GN31                                                             
         MVC   W(2),TODAYB         YM                                           
         OC    0(2,R2),0(R2)                                                    
         BNZ   GN22                DONT SEARCH FILE                             
         XC    HALF,HALF                                                        
**NEW 2/23/90                                                                   
*                                                                               
         BAS   RE,GNOFFSET         BUILD TABLE FOR OFFICE CHECKING              
*                                                                               
         CLC   QPROG,=C'D1'        SEE IF DRAFT BILLING                         
         BE    GN20                DON'T SEARCH JUST START WITH 1               
         CLC   QPROG,=C'RD'        SEE IF DRAFT BILLING (REBATE)                
         BE    GN20                DON'T SEARCH JUST START WITH 1               
*                                                                               
**NEW 2/23/90                                                                   
         MVC   KEY1,KEY            PRESERVE KEY                                 
         XC    KEY,KEY                                                          
         MVC   KEY(3),QAGENCY                                                   
         CLI   AGMSEQ,C'A'         BY AGY                                       
         BE    GN2                                                              
         CLI   AGMSEQ,C'D'         BY CLT ACROSS MEDIA                          
         BNE   GN2B                                                             
GN2      MVI   KEY+2,C'B'          LOWEST MEDIA (NOW "B") WAS I                 
GN2B     CLI   AGMSEQ,C'C'                                                      
         BE    GN2D                                                             
         CLI   AGMSEQ,C'D'         BY CLT ACROSS MEDIA                          
         BNE   *+10                                                             
GN2D     MVC   KEY+4(3),CLIENT                                                  
GN2E     DS    0H                                                               
         MVI   KEY+3,X'08'                                                      
GN3      GOTO1 HIGH                                                             
         B     GN4B                                                             
GN4      DS    0H                                                               
         GOTO1 SEQ                                                              
GN4B     DS    0H                                                               
         CLC   KEY(3),KEYSAVE           AGENCY/MEDIA                            
         BNE   GN6                                                              
GN4C     CLI   KEY+3,X'08'         SEE IF BILLREC                               
         BE    GN4D                                                             
         BH    GN6                 YES GO SEE IF I HAVE TO                      
*                                  CHK NEXT MEDIA                               
         MVI   KEY+3,X'08'                                                      
         CLI   AGMSEQ,C'C'                                                      
         BE    GN4C5                                                            
         CLI   AGMSEQ,C'D'                                                      
         BNE   *+10                                                             
GN4C5    MVC   KEY+4(3),CLIENT                                                  
         B     GN3                                                              
*                                                                               
GN4D     CLI   AGMSEQ,C'C'                                                      
         BE    GN4E                                                             
         CLI   AGMSEQ,C'D'                                                      
         BNE   GN4F                                                             
GN4E     CLC   KEY+4(3),KEYSAVE+4       CLIENT                                  
         BNE   GN6D                                                             
GN4F     DS    0H                                                               
         CLI   AGMOCTL,0           DOING OFFICES?                               
         BE    GN4H                NO, OK                                       
*                                                                               
         MVC   MEDCLT(1),KEY+2      MEDIA                                       
         MVC   MEDCLT+1(3),KEY+4                                                
*                                                                               
         GOTO1 BINSRCH,CLTPARS,(0,MEDCLT)                                       
         CLI   0(R1),1             IF IN LIST, OK                               
         BNE   GN4H                                                             
         MVC   KEY+7(3),=X'FFFFFF' ELSE SKIP TO NEXT CLIENT                     
         B     GN2E                                                             
*                                                                               
GN4H     DS    0H                                                               
         CLC   KEY(2),=C'KN'       FOR K&N NO INV NUMBER RESEQ                  
         BE    GN5F                                                             
         OC    INRSQYM,INRSQYM                                                  
         BZ    GN5                                                              
         CLC   KEY+14(2),INRSQYM                                                
         BL    GN4                                                              
         BH    GN5F                                                             
         CLC   INRSQDA,=C'01'                                                   
         BE    GN5F                                                             
*                                      MUST READ BILL TO CHECK DAY              
         GOTO1 GETBILL                                                          
         L     RF,ADBILL                                                        
         CLC   PBILLDAT+4-PBILLREC(2,RF),INRSQDA                                
         BL    GN4                                                              
         B     GN5F                                                             
*                                                                               
GN5      DS    0H                                                               
         CLC   KEY+14(2),W              YM                                      
         BNE   GN4                                                              
         B     GN5F                                                             
*                                                                               
*                                                                               
GN5F     DS    0H                                                               
         CLC   HALF,KEY+16              INVOICE NO.                             
         BNL   GN4                                                              
         MVC   HALF,KEY+16                                                      
         B     GN4                                                              
*                                                                               
GN6      DS    0H                  END OF AGY/MEDIA                             
         CLI   AGMSEQ,C'A'                                                      
         BE    GN7                                                              
GN6D     CLI   AGMSEQ,C'D'         OR BY CLT ACROSS MEDIA                       
         BNE   GN20                                                             
*                                  IF BY AGY TRY NEXT MEDIA                     
GN7      CLC   KEY(2),KEYSAVE                                                   
         BH    GN20                END OF AGY                                   
         XC    KEY+4(21),KEY+4                                                  
         ZIC   R1,KEYSAVE+2                                                     
         LA    R1,1(R1)                                                         
         STC   R1,KEY+2            NEXT MEDIA                                   
         MVI   KEY+3,X'08'                                                      
         CLI   AGMSEQ,C'C'                                                      
         BE    GN8                                                              
         CLI   AGMSEQ,C'D'         OR BY CLT ACROSS MEDIA                       
         BNE   *+10                                                             
GN8      MVC   KEY+4(3),CLIENT                                                  
         GOTO1 HIGH                                                             
         CLC   KEY(2),KEYSAVE      CHK RIGHT AGY                                
         BH    GN20                                                             
         B     GN4C                                                             
*                                  HAVE HIGHEST NO.                             
GN20     DS    0H                                                               
         LH    RF,HALF                                                          
         LA    RF,1(RF)                                                         
         STH   RF,0(R2)                                                         
         CLC   0(2,R2),AGMSTANO                                                 
         BNL   *+10                                                             
         MVC   0(2,R2),AGMSTANO                                                 
         B     GN23                                                             
*                                  BUMP TO NEXT NO.                             
GN22     DS    0H                                                               
         LH    RF,0(R2)                                                         
         LA    RF,1(RF)                                                         
         STH   RF,0(R2)                                                         
*                                                                               
GN23     DS    0H                                                               
         LA    R4,AGMSKP1S                                                      
GN25     DS    0H                                                               
         OC    0(4,R4),0(R4)                                                    
         BZ    GN30                                                             
         CLC   0(2,R2),0(R4)                                                    
         BL    GN30                                                             
         CLC   0(2,R2),2(R4)                                                    
         BNL   GN26                                                             
         MVC   0(2,R2),2(R4)                                                    
         LH    RF,0(R2)                                                         
         LA    RF,1(RF)                                                         
         STH   RF,0(R2)                                                         
GN26     DS    0H                                                               
*                                                                               
GN30     DS    0H                                                               
         CH    RF,=H'9999'                                                      
         BL    *+10                                                             
         MVI   INV#ERR,C'Y'        REMEMBER THAT WE DIED HERE                   
         DC    H'0'                NO BILL OVER 10,000                          
*                                  (USED TO RESET TO 1)                         
*                                                                               
*                                  FORMAT INVOICE NUMBER                        
GN31     DS    0H                                                               
         MVC   GNWORK(2),W       BINARY YR/MN                                   
         MVI   GNWORK+2,1        SET DAY TO 1                                   
         GOTO1 DATCON,DMCB,(3,GNWORK),GNDATE                                    
*                                                                               
         GOTO1 =V(PPFMTINO),DMCB,GNDATE,(2,(R2)),(QMEDIA,PROFB1),      X        
               PROGPROX                                                         
         L     RF,DMCB                 A(FULL INVOICE NUMBER)                   
         MVC   0(10,R3),0(RF)                                                   
         L     RF,DMCB+8                                                        
         MVC   SVINVMO,0(RF)           SAVE MONTH                               
         L     RF,DMCB+12                                                       
         MVC   SVINVMED,0(RF)          SAVE MEDIA CHARACTERS                    
*                                                                               
GNX      DS    0H                                                               
         MVC   RCTRACE,SAVTRACE                                                 
         MVI   FCRDCLOS,C'N'         RESET TO NO CLOSED-OUT RECORDS             
         XIT1                                                                   
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        GNOFFSET - SET FOR OFFICE CHECKING                                     
*                                                                               
***********************************************************************         
         SPACE 2                                                                
GNOFFSET NTR1                                                                   
         XC    CLTPARS+8(4),CLTPARS+8    CLEAR CLIENT TABLE                     
         CLI   AGMOCTL,0           ANY OFFICE CHECKING                          
         BE    GNOSX               NO, DONE                                     
         XC    WKGN,WKGN           CLEAR LIST OF OFFICES                        
         LA    R4,MED                                                           
         CLI   AGMSEQ,C'A'     SEE IF SEQUENCING BY AGENCY                      
         BNE   GNOS2                                                            
         LA    R4,MEDTAB                                                        
*                                                                               
GNOS2    DS    0H                                                               
         LHI   R3,16                                                            
         CLI   AGMOCTL,C'*'        TEST OFFICE SEQUENCING                       
         BNE   GNOS4                                                            
         L     R2,ADCLT                                                         
         MVC   WKGN(1),PCLTOFF-PCLTREC(R2) SET THIS OFFICE IN LIST              
         B     GNOS6                                                            
*                                                                               
GNOS4    XC    WKGN,WKGN                                                        
         XC    WORK,WORK                                                        
OFF      USING OFFICED,WORK                                                     
         MVI   OFF.OFCSYS,C'P'                 NEED SYSTEM                      
         MVC   OFF.OFCAGY,QAGENCY              AGENCY                           
         L     R2,ADCLT                                                         
         MVC   OFF.OFCOFC,PCLTOFF-PCLTREC(R2)  ANY OFFICE                       
         MVC   OFF.OFCCLT,PCLTKCLT-PCLTREC(R2) AND THE CLIENT                   
         MVI   OFF.OFCLMT,C'$'                 OFFICE LIST                      
         MVC   OFF.OFCLMT+1(1),AGMOCTL         OFFICE LIST CODE                 
         DROP  OFF                                                              
*                                                                               
         XC    DMCB(4),DMCB                                                     
         MVC   DMCB+4(3),=X'D9000A'                                             
         MVI   DMCB+7,QOFFICER                                                  
         L     RF,VCOMFACS                                                      
         L     RF,(CCALLOV-COMFACSD)(RF)                                        
         GOTO1 (RF),DMCB                                                        
         CLI   4(R1),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         L     RF,DMCB                                                          
         GOTO1 (RF),DMCB,(C'2',WORK),(X'D0',VCOMFACS),WKGN                      
         LHI   R3,128             # OF POSSIBLE OFFICES IN THE LIST             
         LHI   R1,128             # OF POSSIBLE OFFICES IN THE LIST             
*                                                                               
         L     RF,ADCLT           MUST BE SURE CLIENT'S OFFICE                  
         CLI   PCLTOFF-PCLTREC(RF),C' '                                         
         BNH   GNOS5ERR           MUST HAVE AN OFFICE                           
         LA    R2,WKGN                                                          
*                                                                               
GNOS5C   CLC   0(1,R2),PCLTOFF-PCLTREC(RF)                                      
         BE    GNOS6              FOUND                                         
         LA    R2,1(R2)                                                         
         BCT   R1,GNOS5C                                                        
*                                 IF DOING A OFFICE LIST                        
*                                 MY CLIENT'S OFFICE MUST BE IN IT              
GNOS5ERR DS    0H                                                               
         MVC   ERRPROF,=C'B1 10'                                                
         MVI   ERR,PROFERR                                                      
         BRAS  RE,ERRPROC                                                       
         B     GNOSX                                                            
*                                                                               
GNOS6    DS    0H                  READ OFF/CLT PASSIVES FOR EACH OFF           
         LA    R2,WKGN             LIST OF OFFICES                              
*                                                                               
GNOS8    DS    0H                                                               
         CLI   0(R2),0             NOT AN OFFICE                                
         BE    GNOS12                                                           
         CLI   0(R2),C'0'          NOT AN OFFICE                                
         BE    GNOS12                                                           
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(2),QAGENCY      OFF/CLT PASSIVES                             
         MVC   KEY+2(1),0(R4)                                                   
         MVI   KEY+3,X'A2'                                                      
         MVC   KEY+4(1),0(R2)      OFFICE CODE                                  
         GOTO1 HIGH                                                             
         B     GNOS10B                                                          
*                                                                               
GNOS10   DS    0H                                                               
         GOTO1 SEQ                                                              
GNOS10B  DS    0H                                                               
         CLC   KEY(5),KEYSAVE     THROUGH OFFICE                                
         BNE   GNOS12                                                           
         MVC   MEDCLT(1),KEY+2      MEDIA                                       
         MVC   MEDCLT+1(3),KEY+5    CLIENT                                      
*                                                                               
         GOTO1 BINSRCH,CLTPARS,(1,MEDCLT)                                       
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                CLIENT TABLE FULL                            
         B     GNOS10              NEXT POINTER                                 
*                                                                               
GNOS12   DS    0H                                                               
         LA    R2,1(R2)            NEXT OFFICE                                  
         BCT   R3,GNOS8                                                         
         CLI   AGMSEQ,C'A'        SEE IF ACROSS AGENCY                          
         BNE   GNOSX                                                            
         LA    R4,1(R4)           POINT TO NEXT MEDIA                           
         CLI   0(R4),X'FF'        SEE IF AT END                                 
         BE    GNOSX                                                            
         B     GNOS2                  GO DO NEXT MEDIA                          
*                                                                               
GNOSX    DS    0H                                                               
         XIT1                                                                   
         LTORG                                                                  
*                                                                               
GNWORK   DS    CL10                  GETNUM WORK AREA                           
GNDATE   DS    CL6                                                              
MEDCLT   DS    CL4                   USED AS KEY TO CLIENT BINSEARCH            
WKGN     DS    XL128                                                            
***      OLD MEDIA TABLE                                                        
***TAB   DC    C'MNOST',X'FF'        MEDIA TABLE                                
***                                                                             
MEDTAB   DC    C'BILMNOSTVW',X'FF'       MEDIA TABLE                            
*                                                                               
*                                                                               
         TITLE 'AGMPROC - HANDLE AGENCY/MEDIA PROFILE'                          
AGMPROC  NMOD1 0,AGMPROC                                                        
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
*                                                                               
*        READ PB1X PROFILE                                                      
*                                                                               
         XC    PROGPROX,PROGPROX   FIRST GET EXTENSION PROFILE                  
         XC    WORK,WORK                                                        
         MVC   WORK(4),=C'PB1X'                                                 
         NI    WORK,X'BF'          MAKE SYSTEM LOWER CASE                       
         MVC   WORK+4(3),QAGENCY   AGY/MED                                      
         L     RF,ADCLT                                                         
         MVC   WORK+7(3),PCLTKCLT-PCLTREC(RF)                                   
         LA    RF,PCLTOFF-PCLTREC(RF)                                           
         CLI   0(RF),C' '                                                       
         BNH   *+14                                                             
         MVI   WORK+10,C'*'        SET OFFICE CODE                              
         MVC   WORK+11(1),0(RF)                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROGPROX,DATAMGR,,WORK+16              
         GOTOR PRNTPROF,DMCB,WORK,PROGPROX,WORK+16                              
*                                                                               
         CLI   PROGPROX+10,0           TEST OVERRIDE OF MAXLINES                
         BNH   *+10                                                             
         MVC   MAXLINES,PROGPROX+10                                             
*                                                                               
         MVC   BFROPT,PROGPROX+11  OPTION TO READ SFM BF RECS                   
         CLI   BFROPT,C' '                                                      
         BH    *+8                                                              
         MVI   BFROPT,C'N'                                                      
*                                                                               
         MVC   BFRMOS,PROGPROX+12  MOS OPTION FOR SFM BF RECS                   
         CLI   BFRMOS,C' '                                                      
         BH    *+8                                                              
         MVI   BFRMOS,C'N'                                                      
*                                                                               
         MVC   AGMINBY,PROGPROX+4     SET INVOICE NUMBER BASE YEAR              
         XC    INRSQYM(4),INRSQYM     CLEAR INVOICE NO. RESEQ DATE              
         OC    PROGPROX(3),PROGPROX   SEE IF DATE GIVEN                         
         BZ    AGMP1                                                            
*                                                                               
         GOTO1 DATCON,DMCB,(3,PROGPROX),(0,DUB) CONVERT TO EBCDIC               
         MVC   INRSQDA,DUB+4         EBCDIC DAY                                 
         GOTO1 DATCON,DMCB,(0,DUB),(3,WORK)  CONVERT BACK TO BINARY             
*                                                                               
*        CODE ABOVE NEEDED FOR Y2K -(CONVERTS YEAR 0 TO 100, ETC)               
*                                                                               
         MVC   INRSQYM(2),WORK    CORRECTED BINARY Y/M                          
*                                                                               
*****    MVC   INRSQYM(2),PROGPROX   YEAR AND MONTH (LEAVE AS BINARY)           
*****    ZIC   R0,PROGPROX+2             DAY                                    
*****    CVD   R0,DUB                                                           
*****    OI    DUB+7,X'0F'                                                      
*****    UNPK  INRSQDA,DUB             MAKE EBCDIC                              
*                                                                               
AGMP1    DS    0H                                                               
*                                  READ B1 PROFILE                              
*                                                                               
         DS    0H                                                               
         XC    WORK,WORK                                                        
         MVC   WORK(4),=C'POB1'                                                 
         MVC   WORK+4(3),QAGENCY                                                
***      CODE TO READ OFFICE LEVEL B1 PROFILE                                   
***      FOR THOSE AGYS WHO WANT DIFFERENT PAPER/ADDRESS BY OFFICE              
***      NOTE - ONLY GET HERE FROM CLTFRST IF AGY/MED CHANGES                   
*** START OF NEW CODE 9/29/87                                                   
         L     RF,ADCLT                                                         
         MVC   WORK+7(3),PCLTKCLT-PCLTREC(RF)                                   
         LA    RF,PCLTOFF-PCLTREC(RF)                                           
         CLI   0(RF),C' '                                                       
         BNH   AGMP2                                                            
         MVI   WORK+10,C'*'        SET OFFICE CODE                              
         MVC   WORK+11(1),0(RF)                                                 
         B     AGMP3                                                            
*                                                                               
AGMP2    XC    WORK+7(5),WORK+7     NO OFFICE-SO CLEAR CLT                      
*** END OF NEW CODE 9/29/87                                                     
AGMP3    GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB1,DATAMGR,,WORK+16                
         GOTOR PRNTPROF,DMCB,WORK,PROFB1,WORK+16                                
         MVC   W(16),PROFB1                                                     
*                                                                               
         MVC   AGMSTADT,W          START MOS FOR NEW BILLING                    
*                                                                               
*                                  MEDIA EXP                                    
*                                  *=BLANK, **=USE MEDIA CODE                   
         CLI   W+2,C'*'                                                         
         BNE   *+8                                                              
         MVI   W+2,C' '                                                         
         CLI   W+3,C'*'                                                         
         BNE   *+8                                                              
         MVI   W+3,C' '                                                         
         CLC   W+2(2),SPACES                                                    
         BNE   *+10                                                             
         MVC   W+2(1),MED                                                       
*                                                                               
         MVC   AGMEXP,W+2          MEDIA EXP                                    
         MVC   AGMFMT,W+4          FORMAT                                       
         MVC   AGMSEQ,W+5          SEQ CONTROL                                  
         MVC   AGMCLOPT,W+12       OPT FOR 1 CLT/PAGE ON REGISTER               
         MVC   AGMFORMS,W+13       PAPER TYPE (D=DDS)                           
         MVC   AGMCLNO,W+14        CLT INTERFACE NO. OPT                        
*                                                                               
         MVC   AGMOCTL,W+9                                                      
         CLI   AGMOCTL,C'0'                                                     
         BNE   *+8                                                              
         MVI   AGMOCTL,0                                                        
*                                                                               
*******                                                                         
*******  MVC   AGMMTH,W+9       MONTH SEQUENCE CONTROL - INOPERATIVE            
*******                                                                         
         MVC   AGMTITL,W+10                                                     
*                                                                               
         MVC   AGMSCOM,W+15    COMMENT SKIP CHARACTER                           
         CLI   AGMSCOM,0                                                        
         BNE   *+8                                                              
         MVI   AGMSCOM,C'N'     SET 0 TO N                                      
*                                  START NO. AND SKIPS                          
         LA    R2,W+6                                                           
         LA    R3,AGMSTANO                                                      
         LA    R0,3                                                             
AGMP4    DS    0H                                                               
         ZIC   RF,0(R2)                                                         
         MH    RF,=H'100'                                                       
         STH   RF,0(R3)                                                         
         LA    R2,1(R2)                                                         
         LA    R3,2(R3)                                                         
         BCT   R0,AGMP4                                                         
*                                                                               
         OC    AGMSTANO,AGMSTANO                                                
         BNZ   *+8                                                              
         MVI   AGMSTANO+1,1        START AT 1 NOT ZERO                          
         LH    RF,AGMSKP1E         ADJUST END OF RANGES                         
         LTR   RF,RF                                                            
         BZ    AGMP4B                                                           
         LA    RF,99(RF)                                                        
         STH   RF,AGMSKP1E                                                      
AGMP4B   DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'PRNT - PRINT CONTROL MODULE'                                    
*                                                                               
PRNT     NMOD1 0,PRNT                                                           
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         MVC   SAVMODE,MODE                                                     
         MVI   MODE,0              LET REPORT DO ALL LEVELS OF HEADS            
         CLI   RCSUBPRG,100        SPECIAL TO GET CATEGORY HEADS                
         BNE   PRNT4               AND NOT RPINT ANYTHING                       
*                                                                               
         CLI   PROFB2B+9,C'L'     LONG CLIENT NAME OPTION                       
         BNE   *+8                                                              
         MVI   RCSUBPRG,101        ALTER SPROG                                  
*                                                                               
PRNT02   DS    0H                                                               
         CLI   RD1OPT,C'E'         SKIP IF RETAIL DRAFT ERROR MODE              
         BE    PRNT4                                                            
*                                                                               
         MVC   MIDHOOK,=A(BILHEAD)                                              
         XC    HEADHOOK,HEADHOOK                                                
         MVI   FORCEHED,C'N'                                                    
         MVI   LINE,0                                                           
         MVI   FORCEMID,C'Y'                                                    
*                                  CLEAR ALL P'S                                
         LA    R1,P1                                                            
         LA    R0,14                                                            
         MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,*-10                                                          
*                                                                               
         GOTO1 REPORT                                                           
         MVI   RCSUBPRG,0                                                       
         XC    MIDHOOK,MIDHOOK                                                  
         B     PRNTX                                                            
         SPACE 2                                                                
PRNT4    DS    0H                                                               
         MVI   RCSUBPRG,20                                                      
         L     RF,ADAGY                                                         
         CLI   PAGYPROF+14-PAGYREC(RF),C'0'                                     
         BNE   *+8                                                              
         MVI   RCSUBPRG,22              NET LESS CD COLUMN                      
         CLI   AORSW,X'03'              SEE IF DOING AOR REGISTER               
         BNE   PRNT4A                                                           
         ZIC   RF,RCSUBPRG                                                      
         LA    RF,1(RF)                                                         
         STC   RF,RCSUBPRG                                                      
PRNT4A   DS    0H                                                               
*                                                                               
         CLI   SAVMODE,RUNLAST                                                  
         BE    PRNT4B                                                           
         MVI   RCSUBPRG,10                                                      
         CLI   RETDRAFT,C'Y'                                                    
         BNE   *+8                                                              
         MVI   RCSUBPRG,30                                                      
*                                                                               
PRNT4B   MVC   HEADHOOK,=A(BILHEAD)                                             
         CLI   PRSW,C'C'           CLEAR LINES                                  
         BE    PRNT24                                                           
         CLI   SORTTRCE,C'Y'                                                    
         BE    PRNT5                                                            
         CLI   PRSW,C'N'                                                        
         BNE   PRNT8                                                            
PRNT5    DS    0H                                                               
*                                                                               
         CLI   RD1OPT,C'E'       SEE IF RETAIL DRAFT MODE                       
         BNE   PRNT6                                                            
         CLI   UPASS,X'FE'       MUST BE TEST PASS TO PRINT - WAS C'T'          
         BNE   PRNTX                                                            
         MVI   SPACING,0         NO SPACING                                     
         MVI   FORCEHED,C'N'     OR NEW PAGES                                   
PRNT6    DS    0H                                                               
         GOTO1 REPORT                                                           
         B     PRNTX                                                            
*                                                                               
PRNT8    DS    0H                                                               
*                                                                               
         CLI   RD1OPT,C'E'         SEE IF RETAIL DRAFT MODE                     
         BE    PRNT25                                                           
*                                                                               
         CLI   PRSW,C'F'                                                        
         BE    PRNT20                                                           
*                                  HOLD PRINT LINES                             
         CLI   PRSW,C'M'           TEST 'MERGE UP'                              
         BNE   PRNT8W                                                           
*                                                                               
         CLC   P2,SPACES           MUST BE SINGLE LINE                          
         BNE   PRNT8W                                                           
         CLC   P1(21),SPACES        BLANK IN DESC                               
         BNE   PRNT8W                                                           
         CLC   P1,SPACES            NON-SPACES                                  
         BE    PRNT8W                                                           
*                                                                               
         SR    R4,R4                                                            
         L     R2,ANXTLIN                                                       
PRNT8F   DS    0H                                                               
         SH    R2,=H'132'                                                       
         C     R2,ALINTAB          BEFORE START                                 
         BL    PRNT8M                                                           
         CLC   21(111,R2),SPACES   LOLUMNS CLEAR                                
         BNE   PRNT8M                                                           
         CLC   0(21,R2),SPACES     DESC NOT CLEAR                               
         BE    PRNT8M                                                           
*                                                                               
         LR    R4,R2               SAVE A(LINE)                                 
         B     PRNT8F                                                           
PRNT8M   DS    0H                                                               
         LTR   R4,R4               NO LINE IS OK FOR MERGE                      
         BZ    PRNT8W                                                           
*                                                                               
         MVC   21(111,R4),P1+21     MERGE LINES                                 
         MVC   P1,SPACES                                                        
         CLI   SPACING,1                                                        
         BNH   PRNTX                                                            
         L     R2,ANXTLIN          MULT SPACING AFTER MERGE                     
         B     PRNT10                                                           
         B     PRNTX                                                            
*                                                                               
PRNT8W   DS    0H                                                               
         LA    R0,14                                                            
         L     R2,ANXTLIN                                                       
         LA    R4,P1                                                            
PRNT9    DS    0H                                                               
         CLC   0(132,R4),SPACES                                                 
         BE    PRNT10                                                           
         MVC   0(132,R2),0(R4)                                                  
         MVC   0(132,R4),SPACES    CLEAR LINE                                   
         LA    R2,132(R2)                                                       
         LA    R4,132(R4)                                                       
         BCT   R0,PRNT9                                                         
PRNT10   DS    0H                  ADJUST FOR SPACING                           
         CLI   SPACING,2                                                        
         BL    PRNT11                                                           
         ZIC   R0,SPACING                                                       
         BCTR  R0,R0                                                            
         MVI   0(R2),0                                                          
         LA    R2,132(R2)                                                       
         BCT   R0,*-8                                                           
PRNT11   DS    0H                                                               
         ST    R2,ANXTLIN                                                       
         MVI   SPACING,1                                                        
         B     PRNTX                                                            
*                                                                               
*                                  FLUSH PRINT LINES                            
*                                                                               
PRNT20   DS    0H                                                               
         MVI   PRSW,C'N'                                                        
         CLC   ANXTLIN,ALINTAB                                                  
         BE    PRNTX                                                            
*                                  FIRST COUNT LINES                            
         L     R5,ANXTLIN                                                       
         S     R5,ALINTAB                                                       
         SR    R4,R4                                                            
         D     R4,=F'132'                                                       
         CH    R5,=H'25'           NOT MUCH POINT IS REQUIRING                  
         BNH   *+8                 MORE THAN 25 LINES                           
         LA    R5,25                                                            
         STC   R5,ALLOWLIN         NUMBER OF LINES                              
*                                                                               
         L     R2,ALINTAB                                                       
PRNT22   DS    0H                                                               
         MVC   P1,0(R2)                                                         
         GOTO1 REPORT                                                           
         LA    R2,132(R2)                                                       
         C     R2,ANXTLIN                                                       
         BL    PRNT22                                                           
*                                                                               
PRNT24   DS    0H                                                               
         MVC   ANXTLIN,ALINTAB                                                  
         L     RF,ALINTAB                                                       
         LA    R0,LINTABN                                                       
         MVC   0(132,RF),SPACES                                                 
         LA    RF,132(RF)                                                       
         BCT   R0,*-10                                                          
         B     PRNTX                                                            
*                                                                               
PRNT25   DS    0H                                                               
         LA    RF,P1                                                            
         LA    R0,14                                                            
*                                                                               
         MVC   0(132,RF),SPACES                                                 
         LA    RF,132(RF)                                                       
         BCT   R0,*-10                                                          
*                                                                               
PRNTX    DS    0H                                                               
         MVC   MODE,SAVMODE                                                     
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'BILHEAD - HEADLINE ROUTINES  (HEADHOOK)'                        
         SPACE 2                                                                
BILHEAD  NMOD1 0,BILHEAD                                                        
         LM    R9,RA,SAVREGS                                                    
         LA    RC,SPACEND                                                       
         B     BH1                                                              
*                                                                               
SAVREGS  DS    3F                                                               
*                                                                               
BH1      DS    0H                                                               
         SPACE 2                                                                
*                                                                               
         CLI   RCSUBPRG,101        SPECIAL TO SAVE HEADS                        
         BE    BH01                WITH LONG CLIENT NAME OPTION                 
         CLI   RCSUBPRG,100        SPECIAL TO SAVE HEADS                        
         BNE   BH1B                                                             
*                                                                               
BH01     DS    0H                                                               
         BRAS  RE,BH50                                                          
         B     BHX                                                              
**NEW 10/27/89                                                                  
BH1B     CLI   RCSUBPRG,20         INVOICE REGISTER                             
         BE    BH80                                                             
         CLI   RCSUBPRG,21         INVOICE REGISTER                             
         BE    BH80                                                             
         CLI   RCSUBPRG,22         INVOICE REGISTER                             
         BE    BH80                                                             
         CLI   RCSUBPRG,23         INVOICE REGISTER                             
         BE    BH80                                                             
*                                  NORMAL HEADLINE ROUTINE                      
         CLI   AGMFORMS,C'D'       DDS+ PAPER                                   
         BE    BH1F                                                             
         CLI   AGMFORMS,C'A'       AGY ADDR ON AGY PAPER (HEAD1)                
         BNE   BH1D                                                             
*                                                                               
         MVC   HEAD1+27(33),AGYADR                                              
         B     BH1G                                                             
*                                                                               
**NEW 4/18/90                                                                   
BH1D     CLI   AGMFORMS,C'B'       AGY ADDR ON AGY PAPER  (HEAD3)               
         BNE   BH2                                                              
*                                                                               
         MVC   HEAD3+27(33),AGYADR                                              
         OC    HEAD3,SPACES                                                     
         GOTO1 =V(CENTER),DMCB,HEAD3+27,33                                      
         B     BH2                                                              
**NEW 4/18/90                                                                   
*                                                                               
BH1F     DS    0H                                                               
         MVC   HEAD1+27(33),AGYNM                                               
         MVC   HEAD2+27(33),AGYADR                                              
         OC    HEAD2,SPACES                                                     
         GOTO1 =V(CENTER),DMCB,HEAD2+27,33                                      
BH1G     DS    0H                                                               
         OC    HEAD1,SPACES                                                     
         GOTO1 =V(CENTER),DMCB,HEAD1+27,33                                      
*                                                                               
BH2      DS    0H                                                               
         CLI   SKIPSPEC,C'Y'                                                    
         BE    BHX                                                              
*                                                                               
         LA    R4,HEAD5            START WITH HEAD5                             
         CLI   AGMFORMS,C'L'     LONG LOGO' FORMS                               
         BE    BH2C                                                             
         CLI   AGMFORMS,C'B'    'LONG LOGO' FORMS (ADDRESS IN HEAD3)            
         BE    BH2C                                                             
         LA    R4,HEAD4          ELSE USE HEAD4                                 
*                                                                               
BH2C     DS    0H                                                               
***E***                                                                         
         CLC   QPROG,=C'E1'        FOR ESTIMATE - CALL RUN ON                   
         BNE   BH3                                                              
         MVC   0(6,R4),=C'RUN ON'                                               
         MVC   8(10,R4),PINVDTE    INVOICE DATE                                 
         L     R3,=A(DICSECT)      MUST SET R3                                  
         B     BH4B                NO INVOICE NUMBER                            
***E***                                                                         
*                                                                               
BH3      DS    0H                                                               
         L     R3,=A(DICSECT)                                                   
         USING DICSECT,R3                                                       
*                                                                               
         CLI   DOCOPT,C'Y'  SEE IF REALLY BILLING THRU PROD                     
         BNE   BH3D                                                             
*--->    MVC   0(13,R4),=C'DOCUMENT DATE'                                       
         MVC   0(L'PP@DOCDT,R4),PP@DOCDT                                        
         MVC   14(10,R4),PINVDTE    INVOICE DATE                                
         B     BH3F                                                             
*                                                                               
BH3D     DS    0H                                                               
*--->    MVC   0(12,R4),=C'INVOICE DATE'                                        
         MVC   0(L'PP@INVDT,R4),PP@INVDT                                        
         MVC   14(10,R4),PINVDTE    INVOICE DATE                                
BH3F     CLI   PDUEDTE,C' '                                                     
         BE    BH4                                                              
*--->    MVC   132(8,R4),=C'DUE DATE'                                           
         MVC   132(L'PP@DUEDT,R4),PP@DUEDT                                      
         MVC   132+14(10,R4),PDUEDTE    DUE DATE                                
*                                                                               
         CLI   PSHPDTE,C' '         SEE IF I HAVE A SHIP DATE                   
         BE    BH4                                                              
         MVC   264(9,R4),=C'SHIP DATE'                                          
         MVC   264+14(8,R4),PSHPDTE                                             
*                                                                               
BH4      DS    0H                                                               
*                                                                               
***E***                                                                         
         CLC   QPROG,=C'E1'        NO INV. NO. FOR ESTIMATE                     
         BE    BH4B                                                             
***E***                                                                         
         CLI   CORPZ,C'Y'          TEST CORP RETAIL NOT AN INVOICE              
         BNE   BH4A                                                             
*--->    MVC   62(11,R4),=C'CONTROL NO.'                                        
         MVC   62(L'PP@CTRLN,R4),PP@CTRLN                                       
         B     BH4B                                                             
BH4A     DS    0H                                                               
*--->    MVC   66(7,R4),=C'INVOICE'                                             
         MVC   66(L'PP@INVOC,R4),PP@INVOC                                       
         CLI   DOCOPT,C'Y'  SEE IF REALLY BILLING THRU PROD                     
         BNE   BH4B                                                             
*--->    MVC   61(12,R4),=C'DOCUMENT NO.'                                       
         MVC   61(L'PP@DOCNO,R4),PP@DOCNO                                       
*                                                                               
BH4B     DS    0H                                                               
*--->    MVC   132+75(4,R4),=C'PAGE'                                            
         MVC   132+75(L'PP@PAGE,R4),PP@PAGE                                     
         LA    R6,132+80(R4)                                                    
         EDIT  (B2,PAGE),(3,0(R6))                                              
***                                                                             
         CLI   RCMULTIQ,C'Y'          SEE IF DOING MULTI-MEDIA REQ              
         BNE   BH4B2                  YES - DON'T SHOW MEDIA IN HEADS           
*--->    MVC   38(13,R4),=C'MEDIA BILLING'                                      
         MVC   38(L'PP@MEDBL,R4),PP@MEDBL                                       
         LA    RF,38(R4)              MUST SET RF FOR BH4B4                     
***E***                                                                         
         CLC   QPROG,=C'E1'           SEE IF ESTIMATE                           
         BNE   BH4B1                                                            
         MVC   38(14,R4),=C'MEDIA ESTIMATE'                                     
         MVC   52(6,R4),SPACES  SOMETHING MAY HAVE BEEN LEFT THERE              
         B     BH4B4                                                            
***E***                                                                         
***R***                                                                         
BH4B1    CLC   QPROG,=C'R1'         REBATE BILLING                              
         BE    BH4B1C                                                           
         CLC   QPROG,=C'RD'         REBATE BILLING - DRAFT                      
         BNE   BH4B4                                                            
*--->    MVC   30(29,R4),=C'MEDIA CONTRACT REBATE BILLING'                      
BH4B1C   MVC   30(L'PP@MED02,R4),PP@MED02                                       
         LA    RF,35(R4)           MUST SET R4 FOR BH4B4                        
         B     BH4B4                                                            
***R***                                                                         
*                                                                               
BH4B2    DS    0H                                                               
         CLI   RCLANG,4            SPECIAL CODE FOR FRENCH                      
         BNE   BH4B2E                                                           
         MVC   30(L'PP@MEDBL,R4),PP@MEDBL                                       
         LA    RF,L'PP@MEDBL+30(R4)                                             
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         CLC   MYMEDNM(7),=C'SOCIAUX'                                           
         BNE   BH4B2T                                                           
         MVI   1(RF),C'S'      CHANGES MEDIA TO MEDIAS                          
         LA    RF,1(RF)        BUMP RF                                          
         B     BH4B2A                                                           
*                                                                               
BH4B2T   CLC   MYMEDNM(10),=C'DIG. AUDIO'                                       
         BNE   BH4B2V                                                           
         MVC   MYMEDNM(10),=C'AUDIO NUM.'                                       
         B     BH4B2A                                                           
*                                                                               
BH4B2V   CLC   MYMEDNM(10),=C'NAT. VIDEO'                                       
         BNE   BH4B2W                                                           
         MVC   MYMEDNM(10),=C'VIDEO NAT.'                                       
         B     BH4B2A                                                           
*                                                                               
BH4B2W   CLC   MYMEDNM(10),=C'LOC. VIDEO'                                       
         BNE   BH4B2A                                                           
         MVC   MYMEDNM(10),=C'VIDEO LOC.'                                       
         B     BH4B2A                                                           
*                                                                               
******** MVC   2(10,RF),MEDNM                                                   
BH4B2A   MVC   2(11,RF),MYMEDNM                                                 
         B     BH4B3                                                            
*                                                                               
**4B2E   MVC   30(10,R4),MEDNM                                                  
BH4B2E   MVC   30(11,R4),MYMEDNM                                                
*******  LA    RF,40(R4)                                                        
         LA    RF,41(R4)                                                        
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
*--->    MVC   2(13,RF),=C'MEDIA BILLING'                                       
         MVC   2(L'PP@MEDBL,RF),PP@MEDBL                                        
***E***                                                                         
         CLC   QPROG,=C'E1'           SEE IF ESTIMATE                           
         BNE   BH4B3                                                            
         MVC   2(14,RF),=C'MEDIA ESTIMATE'                                      
         MVC   16(6,RF),SPACES  SOMETHING MAY HAVE BEEN LEFT THERE              
         B     BH4B4                                                            
***E***                                                                         
***R***                                                                         
BH4B3    CLC   QPROG,=C'R1'           REBATE                                    
         BE    BH4B3C                                                           
         CLC   QPROG,=C'RD'           REBATE  - DRAFT                           
         BNE   BH4B4                                                            
**4B3C   MVC   28(10,R4),MEDNM                                                  
BH4B3C   MVC   28(11,R4),MYMEDNM                                                
         MVI   39(R4),C' '                                                      
         LA    RF,39(R4)                                                        
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
*--->    MVC   2(23,RF),=C'CONTRACT REBATE BILLING'                             
         MVC   2(L'PP@CRB,RF),PP@CRB                                            
***R***                                                                         
BH4B4    CLI   PASSNO,2                                                         
         BNE   BH5                                                              
         CLI   DUESW,C'A'          SEE IF DOING ADJSEP NOW                      
         BE    BH5                                                              
         CLI   DUESW,C'R'          OR AOR                                       
         BE    BH5                                                              
         CLI   DUESW,C'C'          OR CD SEP INV                                
         BE    BH5                                                              
         LA    R0,32-14(R4)                                                     
         SR    RF,R0               RF = LENGTH OF TITLE                         
         LA    RE,132+32(R4)                                                    
         SH    RF,=H'20'                                                        
         BNP   BH4D                                                             
         SRL   RF,1                                                             
         AR    RE,RF                                                            
BH4D     DS    0H                                                               
*--->    MVC   0(20,RE),=C'** DETAIL BACK-UP **'                                
         MVC   0(L'PP@DTLBK,RE),PP@DTLBK                                        
         CLI   AGMTITL,C'I'                                                     
         BNE   *+10                                                             
*--->    MVC   0(21,RE),=C'** INVOICE BACK-UP **'                               
         MVC   0(L'PP@INVBK,RE),PP@INVBK                                        
***E***                                                                         
         CLC   QPROG,=C'E1'       NO INV NO. FOR ESTIMATE                       
         BNE   BH5                                                              
         MVC   0(22,RE),=C'** ESTIMATE BACK-UP **'                              
         B     BH5D                                                             
***E***                                                                         
*                                                                               
BH5      DS    0H                                                               
**NEW 3/11/91                                                                   
         CLI   DUESW,C'R'           SEE IF DOING AOR BILL                       
         BNE   BH5A                                                             
         CLI   DOCOPT,C'Y'           SEE IF DOCUMENT                            
         BE    BH5A                  DON'T CLOBBER WITH *AOR*                   
         MVI   61(R4),C'*'                                                      
         MVC   62(3,R4),PP@AOR       MUST BE 3 CHARS                            
         MVI   65(R4),C'*'                                                      
BH5A     DS    0H                                                               
**NEW 3/11/91                                                                   
***E***                                                                         
         CLC   QPROG,=C'E1'         NO INV. NUMBER FOR ESTIMATES                
         BE    BH5E                                                             
***E***                                                                         
         MVC   74(10,R4),PINVNO                                                 
BH5D     CLI   TESTFLAG,C'T'                                                    
         BNE   BH5E                                                             
***E***                                                                         
         CLC   QPROG,=C'E1'            NO MESSAGE ON ESTIMATES                  
         BE    BH5E                                                             
***E***                                                                         
*--->    MVC   132+58(16,R4),=C'**TEST BILLING**'                               
         MVC   132+58(L'PP@TSTBL,R4),PP@TSTBL                                   
         CLC   QPROG,=C'D1'                                                     
         BNE   *+10                                                             
*--->    MVC   132+57(17,R4),=C'**DRAFT BILLING**'                              
         MVC   132+57(L'PP@DRFBL,R4),PP@DRFBL                                   
         CLC   QPROG,=C'RD'       REBATE DRAFT                                  
         BNE   *+10                                                             
*--->    MVC   132+57(17,R4),=C'**DRAFT BILLING**'                              
         MVC   132+57(L'PP@DRFBL,R4),PP@DRFBL                                   
*                                                                               
*                                  BILLING ADDR                                 
BH5E     L     RF,=A(AADDRS)       USE AAA ADDR                                 
         CLC   APRDBRK,AINVBRK     IF MULTI-PROD BILL                           
         BH    BH5E5                                                            
         L     RF,=A(BADDRS)       SET TO BRAND ADDRESS                         
*                                                                               
         CLI   PROGPRO2+14,C'Y'    CHECK FOR AAA ADDRESS OPTION                 
         BNE   BH5E5                                                            
         L     RF,=A(AADDRS)       USE AAA ADDRESS                              
         L     RE,=A(BADDRS)       UNLESS I HAVE A BRAND ADDRESS                
         CLC   0(10,RE),SPACES                                                  
         BE    BH5E5                                                            
         L     RF,=A(BADDRS)       USE IT                                       
*                                                                               
BH5E5    CLI   DUESW,C'R'          OR AOR BILL                                  
         BNE   BH5F                                                             
         L     RF,=A(AORADDR)      NOTE : USE AOR ADDRESS                       
         B     BH5FX                                                            
*                                                                               
BH5F     DS    0H                                                               
         CLI   PGR1CTL,C'S'             DIVISIONS SEPARATE?                     
         BNE   BH5F5                                                            
         L     RE,=A(DADDRS)            SEE IF I HAVE A DIV-REP ADDR            
         CLC   0(20,RE),SPACES                                                  
         BE    BH5F2                                                            
         L     RF,=A(DADDRS)            USE IT UNLESS EST OR JOB                
*                                                                               
BH5F2    CLI   MGR1CTL,C'S'             REGIONS SEPARATE?                       
         BNE   BH5F5                                                            
         L     RE,=A(RADDRS)            SEE IF I HAVE A REG-REP ADDR            
         CLC   0(20,RE),SPACES                                                  
         BE    BH5F5                                                            
         L     RF,=A(RADDRS)            USE IT UNLESS EST OR JOB                
*                                                                               
BH5F5    DS    0H                                                               
         CLI   PRDCTL,C'S'              SEE IF PRDS ON SEPARATE INVS            
         BNE   BH5F10                                                           
         CLI   ESTCTL,C'S'              SEE IF ESTS ON SEPARATE INVS            
         BNE   BH5F10                                                           
         L     RE,=A(EADDRS)            SEE IF I HAVE A EST-REP ADDR            
         CLC   0(20,RE),SPACES                                                  
         BE    BH5F10                                                           
         L     RF,=A(EADDRS)            USE IT                                  
*                                       UNLESS I FIND ONE FOR THE JOB           
*                                                                               
**WB**                                                                          
BH5F10   DS    0H                                                               
         CLI   WBSW,C'Y'       WB FLIGHT FEATURE                                
         BE    BH5FX           JOBCTL IS NOT REALLY JOB BUT FLIGHT              
**WB**                                                                          
         CLI   JOBCTL,C'S'              SEE IF JOB ON SEPARATE INVS             
         BNE   BH5FX                                                            
         L     RE,=A(JADDRS)            SEE IF I HAVE A JOB-REP ADDR            
         CLC   0(20,RE),SPACES                                                  
         BE    BH5FX                                                            
         L     RF,=A(JADDRS)            USE IT                                  
*                                                                               
*                            NOTE -     IF MULTI-PRD BILL                       
*                                       AOR ADDRESS WILL BE FROM LAST           
*                                       PRODUCT                                 
**NEW 10/17/89                          UNLESS DOING AOR DETAILS                
*                                                                               
BH5FX    DS    0H                                                               
         MVC   HEAD7+46(60),00(RF)                                              
         MVC   HEAD8+46(60),60(RF)                                              
         MVC   HEAD9+46(60),120(RF)                                             
         MVC   HEAD10+46(60),180(RF)                                            
         MVC   HEAD11+46(70),240(RF)     PRINT ONLY USES 4 LINES                
*          DATA SET PPB12AI    AT LEVEL 029 AS OF 08/26/97                      
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMADD',0)     EDI CALL                          
**EDI**                                                                         
*                                                                               
         LA    R4,HEAD11+46                                                     
         CLC   0(36,R4),SPACES                                                  
         BE    *+8                                                              
         LA    R4,HEAD12+46                                                     
         CLI   QOPT3,C'C'                                                       
         BNE   BH5G                                                             
*--->    MVC   0(32,R4),=C'** CASH DISCOUNT VENDORS ONLY **'                    
         MVC   0(L'PP@CDVO,R4),PP@CDVO                                          
         B     BH5I                                                             
BH5G     CLI   QOPT3,C'N'                                                       
         BNE   BH5I                                                             
*--->    MVC   0(36,R4),=C'** NON-CASH DISCOUNT VENDORS ONLY **'                
         MVC   0(L'PP@NCDVO,R4),PP@NCDVO                                        
*                                                                               
BH5I     CLI   QOPT1,C'C'                                                       
         BNE   BH5K                                                             
         MVC   0(60,R4),SPACES                                                  
*--->    MVC   0(30,R4),=C'** CASH DISCOUNT ITEMS ONLY **'                      
         MVC   0(L'PP@CDIO,R4),PP@CDIO                                          
         CLI   QOPT3,C'C'                                                       
         BNE   BH5I5                                                            
*--->    MVC   0(31,R4),=C'** CD VENDORS AND ITEMS ONLY **'                     
         MVC   0(L'PP@CDVIO,R4),PP@CDVIO                                        
         B     BH5X                                                             
BH5I5    CLI   QOPT3,C'N'                                                       
         BNE   BH5X                                                             
*--->    MVC   0(33,R4),=C'** NON-CD VENDORS CD ITEMS ONLY**'                   
         MVC   0(L'PP@NCDVC,R4),PP@NCDVC                                        
         B     BH5X                                                             
*                                                                               
BH5K     CLI   QOPT1,C'N'                                                       
         BNE   BH5X                                                             
         MVC   0(60,R4),SPACES                                                  
*--->    MVC   0(34,R4),=C'** NON-CASH DISCOUNT ITEMS ONLY **'                  
         MVC   0(L'PP@NCDIO,R4),PP@NCDIO                                        
         CLI   QOPT3,C'C'                                                       
         BNE   BH5K5                                                            
*--->    MVC   0(39,R4),=C'** CD VENDORS WITH NON-CD ITEMS ONLY **'             
         MVC   0(L'PP@CDVNC,R4),PP@CDVNC                                        
         B     BH5X                                                             
BH5K5    CLI   QOPT3,C'N'                                                       
         BNE   BH5X                                                             
*--->    MVC   0(38,R4),=C'** NON-CD VENDORS NON-CD ITEMS ONLY **'              
         MVC   0(L'PP@NCDVN,R4),PP@NCDVN                                        
         B     BH5X                                                             
BH5X     DS    0H                                                               
*                                       PUT CATEGORY HEADS SAVED                
*                                       INTO REAL HEADLINES                     
         LA    R4,HEAD8                                                         
         LA    R0,6                                                             
         CLI   AGMFORMS,C'L'  'LONG LOGO' FORMS                                 
         BE    BH5X5                                                            
         CLI   AGMFORMS,C'B'  'LONG LOGO' FORMS WITH ADDRESS HEAD3              
         BE    BH5X5                                                            
         LA    R4,HEAD7                                                         
         LA    R0,7                                                             
*                                                                               
BH5X5    L     R5,=A(MYHEADS)                                                   
**NEW 10/17/89                                                                  
         CLI   DUESW,C'R'           AOR BILL                                    
         BNE   BH6                                                              
         CLI   AORLOPT,C'N'         SEE IF DOING DETAILS                        
         BE    BH6                                                              
**NEW 3/11/91     ABOVE INSTRUCTIONS WERE C'Y' AND BNE                          
         LA    R0,1                                                             
         MVC   SAVMYH,45(R5)         SAVE FIRST BYTE OF SECOND MYHEAD           
         MVI   45(R5),C' '           THEN ONLY SHOW CLIENT                      
**NEW 10/17/89                                                                  
BH6      DS    0H                                                               
         L     RF,ADCLT                                                         
         LA    R2,33(RF)                                                        
         MVI   ELCODE,X'55'        EXTENDED CLIENT NAME                         
         BRAS  RE,FNEXTEL                                                       
         BNE   BH6C                                                             
         USING PCLTXEL,R2                                                       
         CLC   =C'CLIENT ',0(R5)   CLIENT LABEL?                                
         BNE   BH6C                                                             
         MVC   0(132,R4),SPACES                                                 
         MVC   0(13,R4),0(R5)      CLIENT LABEL AND CLT CODE                    
         MVC   15(L'PCLTXNME,R4),PCLTXNME  EXTNEDED CLIENT NAME                 
         DROP  R2                                                               
         B     *+10                                                             
BH6C     MVC   0(45,R4),0(R5)      CLIENT NAME                                  
*                                                                               
         LA    R4,132(R4)                                                       
         LA    R5,45(R5)                                                        
         BCT   R0,BH6C                                                          
         CLI   0(R5),C' '                                                       
         BNH   *+6                                                              
         DC    H'0'                TOO MANY HEADLINES                           
*                                                                               
         CLI   DUESW,C'R'           AOR BILL                                    
         BNE   BH6X                                                             
         CLI   AORLOPT,C'N'         SEE IF DOING DETAILS                        
         BE    BH6X                                                             
         L     R5,=A(MYHEADS)                                                   
         MVC   45(1,R5),SAVMYH  RESTORE FIRST BYTE OF SECOND MYHEAD             
*                                                                               
BH6X     DS    0H                                                               
         CLI   HEAD13,C' '                                                      
         BNE   *+8                                                              
         MVI   HEAD13,0            ENSURE 13 HEADS                              
*                                                                               
         SPACE 3                                                                
         LA    R2,MID1             USE MID LINES FOR COL HEADS                  
         USING ALINED,R2                                                        
         MVI   MID1+131,0              NO COL HEADS ON ADJ BILL                 
         MVI   MID2+131,0                                                       
         CLI   DUESW,C'A'          ADJ INV                                      
         BE    BH40                                                             
         CLI   DUESW,C'R'          OR AOR                                       
         BE    BH39X                                                            
         CLI   DUESW,C'C'          OR CD INV                                    
         BE    BH40                                                             
         CLI   UPASS,X'FF'         WAS C'S'                                     
         BNE   BH7                                                              
*                                  RETAIL SUMMARY FORMAT                        
*                                                                               
         MVC   INVWD1+5(L'PP@CNTRL),PP@CNTRL                                    
         MVC   ALCOL3,INVWD1                                                    
         MVC   INVWD2+6(L'PP@NUM),PP@NUM                                        
         MVC   ALCOL3+132,INVWD2                                                
         MVC   BAMTWD,PP@BLAMT                                                  
         MVC   ALCOL4+132,BAMTWD                                                
*                                                                               
         B     BH20                                                             
*                                                                               
BH7      DS    0H                                                               
         CLI   FMTSW,C'D'          INSERTION DETAILS                            
         BNE   BH8                                                              
         OC    ARECAP,ARECAP       SEE IF DOING RECAP                           
         BNZ   BH7B                                                             
         CLI   NOINSSW,C'Y'       SEE IF SUPPRESSING INS DETAIL                 
         BE    BH8                ON MAIN BILL                                  
*                                  ***************************                  
*                                  FMTSW  D - INSERTION DETAILS                 
BH7B     MVI   MID1+0,0                                                         
         CLI   RCMULTIQ,C'Y'       SEE IF MULTI-MEDIA REQ                       
         BE    BH7D                                                             
*--->    MVC   MID1+0(6),=C'INSERT'                                             
         MVC   MID1+0(L'PP@INSRT),PP@INSRT                                      
         CLI   QMEDIA,C'O'                                                      
         BNE   *+10                                                             
*--->    MVC   MID1+0(7),=C'POSTING'                                            
         MVC   MID1+0(L'PP@POST),PP@POST                                        
BH7D     DS    0H                                                               
*--->    MVC   MID2+0(4),=C'DATE'                                               
         MVC   MID2+0(L'PP@DATE),PP@DATE                                        
*--->    MVC   MID2+12(5),=C'SPACE'                                             
         MVC   MID2+12(L'PP@SPACE),PP@SPACE                                     
*                                                                               
BH7F     DS    0H                                                               
         CLI   RCLANG,4            SEE IF FRENCH                                
         BNE   BH8                 NO                                           
         CLI   QMEDIA,C'O'         SEE IF OUTDOOR                               
         BE    BH8                 YES                                          
         CLI   RCMULTIQ,C'Y'       SEE IF MULTI-MEDIA REQ                       
         BE    BH8                 YES                                          
*                                                                               
*        SPECIAL CODE TO ALTER "INSERT DATE"                                    
*        TO "DATE D'INSERTN"                                                    
*                                                                               
         MVC   MID1+0(L'PP@INSRT),SPACES                                        
         MVC   MID1+0(L'PP@DATE),PP@DATE                                        
         MVC   MID2+0(9),=C'D''INSERTN'                                         
*                                                                               
BH8      DS    0H                                                               
*                                  MONTH OF SERVICE                             
BH20     DS    0H                                                               
         CLI   PERCTL,C'T'                                                      
         BNE   BH22                                                             
         CLI   NOPMBRK,C'Y'        NO PERIOD BREAKOUT                           
         BE    BH22                                                             
*                                                                               
         CLI   FMTSW,C'D'          NO BILL PER HEADLINE FOR                     
         BE    BH22                BUY  DETAIL FORMAT                           
***E***                                                                         
         CLC   QPROG,=C'E1'        SEE IF ESTIMATE                              
         BNE   BH21                                                             
***E***                                                                         
*--->    MVC   MID1+11(6),=C'PERIOD'                                            
         MVC   MID1+11(L'PP@PERD),PP@PERD                                       
         B     BH22                                                             
*                                                                               
BH21     LA    R4,MID1+11                                                       
*--->    MVC   0(7,R4),=C'BILLING'                                              
         MVC   0(L'PP@BLNG,R4),PP@BLNG                                          
*--->    MVC   132(6,R4),=C'PERIOD'                                             
         MVC   132(L'PP@PERD,R4),PP@PERD                                        
*                                  PUB                                          
BH22     DS    0H                                                               
****                                                                            
         B     BH24                BYPASS THIS CODE FOR NOW                     
******                                                                          
         CLI   PUBCTL,C'T'                                                      
         BNE   BH24                                                             
         CLC   APUBBRK,ALOWTOG                                                  
         BH    BH24                                                             
         CLI   PERCTL,C'T'                                                      
         BE    BH22B                                                            
*                                  SINGLE MOS                                   
         LA    R4,MID2+8                                                        
         B     BH22D                                                            
*                                  MULTI MOS                                    
BH22B    DS    0H                                                               
         LA    R4,MID2+8                                                        
         CLI   FMTSW,C'D'          INSERTION DETAILS                            
         BE    BH22D                                                            
         LA    R4,MID2+0                                                        
*                                                                               
BH22D    DS    0H                                                               
*--->    MVC   0(3,R4),=C'PUB'                                                  
         MVC   0(L'PP@PUB,R4),PP@PUB                                            
*                                  MARKET                                       
BH24     DS    0H                                                               
         CLI   PRDMKT,C'M'         SKIP IF MKT HIGHER THAN PRD                  
         BE    BH26                                                             
         CLC   AMKTBRK,APAGBRK     ONLY IF TOGETHER ON PAGE                     
         BNH   BH26                                                             
         CLC   AMKTBRK,ALOWTOG                                                  
         BH    BH26                                                             
         CLC   MID2(6),SPACES                                                   
         BE    BH24B                                                            
*--->    MVC   MID1(7),=C'MARKET/'                                              
         MVC   MID1(L'PP6MARKT),PP6MARKT                                        
         MVI   MID1+L'PP6MARKT,C'/'                                             
         B     BH26                                                             
BH24B    DS    0H                                                               
*--->    MVC   MID2(6),=C'MARKET'                                               
         MVC   MID2(L'PP6MARKT),PP6MARKT                                        
*                                  ESTIMATE                                     
BH26     DS    0H                                                               
         CLC   ALOWTOG,AHITOG      TEST ONLY ONE TOGETHER                       
         BNE   BH30                                                             
*                                  YES - PRINT DESC HERE                        
         OC    ALOWTOG,ALOWTOG     IF ZERO THEN ONLY TOGETHER IS PER            
         BZ    BH30 SKIP                                                        
*                                                                               
         L     R0,ALOWTOG                                                       
*--->    LA    R6,=C'ESTIMATE    '                                              
         MVC   WORK(12),SPACES                                                  
         MVC   WORK(L'PP@EST),PP@EST                                            
         LA    R6,WORK                                                          
         C     R0,AESTBRK                                                       
         BE    BH28                                                             
*--->    LA    R6,=C'PRODUCT     '                                              
         MVC   WORK(12),SPACES                                                  
         MVC   WORK(L'PP@PRO),PP@PRO                                            
         LA    R6,WORK                                                          
         C     R0,APRDBRK                                                       
         BE    BH27                SPECIAL ROUTINE FOR PRODUCT                  
         LA    R6,MGR1BK                                                        
         C     R0,AMGR1BRK                                                      
         BE    BH28                                                             
         LA    R6,MGR2BK                                                        
         C     R0,AMGR2BRK                                                      
         BE    BH28                                                             
         LA    R6,MGR3BK                                                        
         C     R0,AMGR3BRK                                                      
         BE    BH28                                                             
         LA    R6,PGR1BK                                                        
         C     R0,APGR1BRK                                                      
         BE    BH28                                                             
         LA    R6,PGR2BK                                                        
         C     R0,APGR2BRK                                                      
         BE    BH28                                                             
         LA    R6,PGR3BK                                                        
         C     R0,APGR3BRK                                                      
         BE    BH28                                                             
         B     BH30                                                             
*                                                                               
BH27     CLI   PUSRSW,C'Y'          PRD USER CONTROL                            
         BE    BH30                 WHEN PRDS TOGETHER                          
*                                                                               
BH28     DS    0H                                                               
         CLC   MID2(14),SPACES                                                  
         BNE   BH28A                                                            
         MVC   MID2(12),0(R6)                                                   
         B     BH29C                                                            
BH28A    DS    0H                                                               
         CLC   10(2,R6),SPACES                                                  
         BNE   BH28B                                                            
         MVC   MID2(10),0(R6)                                                   
         B     BH29C                                                            
BH28B    DS    0H                                                               
         GOTO1 =V(CHOPPER),DMCB,(12,0(R6)),(10,MID1),(C'P',2)                   
BH29C    DS    0H                                                               
*                                                                               
BH30     DS    0H                                                               
         CLI   UPASS,X'FF'         SEE IF DOING RETAIL SUMMARY PASS             
         BE    BH40                YES - SKIP  - WAS C'S'                       
*                                                                               
         CLI   RETPROF+13,C'N'     SEE IF SKIPPING DETAILS ON DISTRIB           
         BE    BH30C               BILL - NO-SHOW CATS                          
         CLI   RETPROF+13,0        SEE IF SKIPPING DETAILS ON DISTRIB           
         BE    BH30C               BILL - NO-SHOW CATS                          
         CLI   UPASS,1             SEE IF CORP                                  
         BE    BH30C                                                            
         CLI   RETPROF+13,C'I'     SEE IF NO INS $                              
         BE    BH40                IF SO - THEN SKIP CATS                       
         CLI   RETPROF+13,C'B'     SEE IF NO INS $                              
         BE    BH40                IF SO - THEN SKIP CATS                       
*                                                                               
         CLI   PGR1CTL,C'T'        SEE IF DIV/PRD/EST                           
         BE    BH30C               IS TOGETHER - IF SO MUST SHOW CATS           
         CLI   PRDCTL,C'T'                                                      
         BE    BH30C                                                            
         CLI   ESTCTL,C'T'                                                      
         BE    BH30C                                                            
         CLI   MKTCTL,0          FIRST CHK FOR X'00'                            
         BE    BH30A                                                            
         CLI   MKTCTL,C'N'       IF MKT/JOB/PUB IS SHOWN                        
         BNE   BH30C             MUST SHOW CATS                                 
**WB**                                                                          
BH30A    DS    0H                                                               
         CLI   WBSW,C'Y'       WB FLIGHT FEATURE                                
         BE    BH30B           JOBCTL IS NOT REALLY JOB BUT FLIGHT              
**WB**                                                                          
         CLI   JOBCTL,0          FIRST CHECK FOR X'00'                          
         BE    BH30B                                                            
         CLI   JOBCTL,C'N'                                                      
         BNE   BH30C                                                            
BH30B    CLI   PUBCTL,C'N'                                                      
         BNE   BH30C                                                            
         B     BH40                DISTRIBUTOR BILL - SKIP                      
*                                                                               
         DROP  R3                                                               
*                                                                               
BH30C    L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
         MVC   BHTYPNAM,PP@ORD                                                  
         MVC   BHTYPRVB,PP@PRV04                                                
         MVC   BHTYBLBL,PP@BILLA                                                
*                                                                               
         MVC   BHCATNAM(L'PPRGROSS),PPRGROSS                                    
*COST2*                                                                         
         CLI   MIDASSW,C'Y'                                                     
         BE    *+12                                                             
         CLI   CAROPT,C'Y'        CARAT OPTION ACTIVE                           
         BNE   *+10                                                             
         MVC   BHCATNAM(16),=CL16'  COST TO CLIENT'                             
*                                CHANGE 'GROSS' TO 'COST TO CLIENT'             
*COST2*                                                                         
         MVC   BHCATNET(L'PPRNET),PPRNET                                        
         MVC   BHCATCD(L'PP@CDISC),PP@CDISC                                     
         MVC   BHCATGLC(L'PPRGRSLC),PPRGRSLC                                    
         MVC   BHCATNLC(L'PPRNETCD),PPRNETCD                                    
         MVC   BHCATAC(L'PPAAGYCM),PPAAGYCM                                     
         DROP  RE                                                               
*              SEE IF DOING ONE DOL CAT                                         
         MVC   HFORMAT,FORMAT    SAVE FORMAT                                    
         MVC   HTYPES,ORDSW     SAVE TYPES                                      
         CLI   DOLNUM,1                                                         
         BNE   BH33                                                             
         CLI   TYPNUM,1                                                         
         BNE   BH33                                                             
         LA    R4,MID1+(ALCOL4-ALINE-2)  ONE COL - PUT IN LAST                  
         BAS   RE,BHGETCAT                                                      
         MVC   0(16,R4),WORK                                                    
         BAS   RE,BHGETTYP                                                      
         MVC   132(16,R4),WORK                                                  
         B     BH39                GO DO STRIP-OFF                              
*                                                                               
BH33     CLI   DOLNUM,1            SEE IF ONE CAT AND MULTIPLE TYPES            
         BNE   BH34                                                             
*                                  IF SHOWING INVOICE DETAILS AT INS            
*                                  LEVEL MUST USE GRID FORMAT EVEN              
*                                  FOR ONE CATEGORY                             
*                                                                               
         JIF   FMTSW,EQ,C'D',AND,LSTOPT,EQ,C'I',BH34,JUMP=N                     
         JIF   FMTSW,EQ,C'D',AND,LSTOPT,EQ,C'B',BH34,JUMP=N                     
         JIF   FMTSW,EQ,C'D',AND,LSTOPT,EQ,C'D',BH34,JUMP=N                     
         ZIC   R2,TYPNUM                                                        
         LA    R4,MID1+(ALCOL2-ALINE-2)                                         
         CLI   TYPNUM,3                                                         
         BE    *+8                                                              
         LA    R4,MID1+(ALCOL3-ALINE-2)                                         
         BAS   RE,BHGETCAT                                                      
         MVC   0(16,R4),WORK                                                    
BH33B    BAS   RE,BHGETTYP                                                      
         MVC   132(16,R4),WORK                                                  
         LA    R4,16(R4)                                                        
         BCT   R2,BH33B                                                         
         B     BH39                                                             
*                                                                               
BH34     CLI   TYPNUM,1            ONE TYPE AND MULTIPLE CATS                   
         BNE   BH36                                                             
         CLI   DOLNUM,5                                                         
         BNL   BH36                                                             
         LA    R4,MID1+(ALCOL1-ALINE-2)                                         
         CLI   DOLNUM,4                                                         
         BE    BH34A                                                            
         LA    R4,MID1+(ALCOL2-ALINE-2)                                         
         CLI   DOLNUM,3                                                         
         BE    BH34A                                                            
         LA    R4,MID1+(ALCOL3-ALINE-2)                                         
BH34A    ZIC   R6,DOLNUM                                                        
BH34B    BAS   RE,BHGETCAT                                                      
         MVC   0(16,R4),WORK                                                    
         MVC   HTYPES,ORDSW        MUST RESTORE TYPES                           
         BAS   RE,BHGETTYP         IF ONE TYPE - PUT UNDER CAT                  
         MVC   132(16,R4),WORK                                                  
BH34E    LA    R4,16(R4)                                                        
         BCT   R6,BH34B                                                         
         B     BH39                                                             
*                                                                               
*        MULTIPLE CATS AND TYPES MUST USE GRID                                  
*                                                                               
BH36     CLI   DOLNUM,3            SEE IF MORE THAN 3 CATS                      
         BH    BH38                                                             
         LA    R4,MID2+(ALCOL3-ALINE-2)  3 OR LESS CATS - ACROSS                
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         LA    R4,MID2+(ALCOL2-ALINE-2)                                         
         ZIC   R6,DOLNUM           TYPES DOWN                                   
BH36B    BAS   RE,BHGETCAT                                                      
         MVC   0(16,R4),WORK                                                    
         LA    R4,16(R4)                                                        
         BCT   R6,BH36B                                                         
         B     BH39                                                             
BH38     DS    0H                  4 OR MORE CATS - DOWN                        
         LA    R4,MID2+(ALCOL3-ALINE-2) TYPES ACROSS                            
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         LA    R4,MID2+(ALCOL2-ALINE-2)                                         
         ZIC   R6,TYPNUM                                                        
BH38B    BAS   RE,BHGETTYP                                                      
         MVC   0(16,R4),WORK                                                    
         LA    R4,16(R4)                                                        
         BCT   R6,BH38B                                                         
         B     BH39                                                             
*                                                                               
BH39     DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
         LA    R4,BHCATNAM                                                      
         LA    R5,5                                                             
         LA    R6,CATTAB                                                        
BH39A    CLC   STRIP,0(R6)                                                      
         BE    BH39B                                                            
         LA    R6,1(R6)                                                         
         LA    R4,16(R4)                                                        
         BCT   R5,BH39A                                                         
         B     BH40                IF NOT IN TABLE SKIP STRIP                   
*                                                                               
BH39B    DS    0H                                                               
         CLI   RCLANG,4            SEE IF FRENCH                                
         BE    BH39D                                                            
         MVC   MID1+85(16),0(R4)                                                
*--->    MVC   MID2+94(7),=C'BILLING'                                           
         MVC   MID2+94(L'PP@BLNG),PP@BLNG                                       
         B     BH40                                                             
*                                                                               
BH39D    DS    0H                    FRENCH - PUT BILLING ON TOP                
*                                  90 SINCE FRENCH WORD IS 11 CHAR              
         MVC   MID1+90(L'PP@BLNG),PP@BLNG                                       
         MVC   MID2+85(16),0(R4)                                                
         B     BH40                                                             
*                                                                               
         DROP  RE                                                               
*                                                                               
BHGETCAT NTR1                                                                   
         MVC   WORK(16),SPACES                                                  
         LA    R4,HFORMAT                                                       
         LA    R5,6                FOR BCT                                      
         LA    R6,BHCATNAM                                                      
BHGETC5  CLI   0(R4),C'Y'                                                       
         BE    BHGETC10                                                         
         LA    R4,1(R4)                                                         
         LA    R6,16(R6)                                                        
         BCT   R5,BHGETC5                                                       
         LA    R6,SPACES                                                        
         B     BHGETCX                                                          
*                                                                               
BHGETC10 MVC   WORK(16),0(R6)                                                   
         MVI   0(R4),C'N'          SET OFF IN HFORMAT                           
BHGETCX  XIT1                                                                   
*                                                                               
*                                                                               
BHGETTYP NTR1                                                                   
         MVC   WORK(16),SPACES                                                  
         LA    R4,HTYPES                                                        
         LA    R5,3                FOR BCT                                      
*                                                                               
         LA    R6,BHTYPNAM                                                      
BHGETT5  CLI   0(R4),C'Y'                                                       
         BE    BHGETT10                                                         
         CLI   0(R4),C'D'          MEANS SHOW AT DETAIL LEVEL ONLY              
         BE    BHGETT10            SKIP $ BUT STILL SHOW ANNOTATION             
         LA    R4,1(R4)                                                         
         LA    R6,16(R6)                                                        
         BCT   R5,BHGETT5                                                       
         LA    R6,SPACES                                                        
         B     BHGETTX                                                          
*                                                                               
BHGETT10 MVC   WORK(16),0(R6)                                                   
**NEW 10/17/89                                                                  
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
         CLI   PAYOPT,C'G'         SEE IF CHANGING ORDERED TO CLEARED           
         BE    BHGETT20                                                         
         CLI   PAYOPT,C'C'         SEE IF CHANGING ORDERED TO CLEARED           
         BNE   BHGETT30                                                         
*--->    CLC   WORK+9(7),=C'ORDERED'                                            
BHGETT20 CLC   WORK(16),PP@ORD                                                  
         BNE   BHGETT30                                                         
*--->    MVC   WORK+9(7),=C'CLEARED'                                            
         MVC   WORK+7(L'PP@CLEAR),PP@CLEAR                                      
BHGETT30 MVI   0(R4),C'N'          SET OFF IN HFORMAT                           
**NEW 10/17/89                                                                  
BHGETTX  XIT1                                                                   
*                                                                               
         DROP  RE                                                               
*                                                                               
CATTAB   DC    C'GNC12'     1=G-CD,2=N-CD                                       
*                                                                               
**NEW 10/17/89                                                                  
*                                                                               
BH39X    DS    0H                  AOR BILLS                                    
         CLI   AORLOPT,C'N'        IF DOING AOR PRD/EST/MOS LIST                
         BE    BH40                NEED SPECIAL HEADS                           
*                                                                               
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
         LA    R2,MID1             USE MID LINES FOR COL HEADS                  
         USING ALINED,R2                                                        
*--->    MVC   ALCOL1(16),=C'      MONTH OF  '                                  
         MVC   ALCOL1+7(L'PP@MTHOF),PP@MTHOF                                    
         LA    R2,132(R2)                                                       
*--->    MVC   ALDESC(7),=C'PRODUCT'                                            
*--->    MVC   ALCOL1(16),=C' EST   SERVICE  '                                  
*--->    MVC   ALCOL2+2(12),=C'GROSS AMOUNT'                                    
*--->    MVC   ALCOL3(14),=C'  AOR%   BASIS'                                    
*--->    MVC   ALCOL4+2(12),=C'     AOR FEE'                                    
*--->    MVC   ALSTRIP+2(12),=C'BASIS AMOUNT'                                   
         MVC   ALDESC(L'PP@PRO),PP@PRO                                          
         MVC   ALCOL1(L'PP@ESTSV),PP@ESTSV                                      
         MVC   ALCOL2(L'PP@GRSAM),PP@GRSAM                                      
*                                                                               
         CLI   AORNOPT,C'Y'                 SHOWING NET INSTEAD?                
         BNE   BH39X5                                                           
         MVC   ALCOL2(L'PP@GRSAM),SPACES    CLEAR GROSS                         
         MVC   ALCOL2+3(L'PP@NAMT),PP@NAMT  (+3 SINCE PP@NAMT NOT               
*                                           RIGHT ALIGNED)                      
BH39X5   MVC   ALCOL3(L'PP@AORBS),PP@AORBS                                      
         MVC   ALCOL4(L'PP@AORFE),PP@AORFE                                      
         MVC   ALSTRIP(L'PP@BASAM),PP@BASAM                                     
         B     BHX                 FOR AOR LIST, SKIP BILLING PERIOD            
         DROP  R2                                                               
         DROP  RE                                                               
**NEW 10/17/89                                                                  
*                                                                               
BH40     DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
         CLI   PERCTL,C'S'                                                      
         BNE   BHX                                                              
*                                                                               
BH42     CLI   PARTIAL,C'Y'                                                     
         BE    BH46                                                             
         L     RF,APER                                                          
         ZIC   R5,0(RF)                                                         
         SLL   R5,3                                                             
         LA    R5,PERLIST(R5)                                                   
*                                                                               
         CLI   MOSOPT,C'X'      SPECIAL MOS SUPPRESSION FOR MULLEN              
         BE    BHX                                                              
*                                                                               
         LA    R4,HEAD13                                                        
         CLI   MOSOPT,C'Y'      MONTH OF SERVICE INSTEAD OF MONTH OF            
         BNE   BH45M                                                            
         MVC   47(L'PP@MTHSV,R4),PP@MTHSV                                       
         B     BH45MX                                                           
*                                                                               
*--->    MVC   54(8,R4),=C'MONTH OF'                                            
BH45M    MVC   54(L'PP@MTHOF,R4),PP@MTHOF                                       
BH45MX   GOTO1 DATCON,DMCB,(3,0(R5)),(6,64(R4))   MMM/YY                        
         B     BHX                                                              
BH46     DS    0H                                                               
         CLI   HEAD12+46,C' '      COULD HAVE CD/NONCD MESSAGE                  
         BH    BH47                IF SO USE ONE LINE                           
         LA    R4,HEAD12                                                        
         LA    R6,132+46(R4)                                                    
         CLI   HEAD11+46,C' '      TEST LAST ADDRESS LINE USED                  
         BNH   *+12                                                             
BH47     LA    R4,HEAD13           YES - PRINT DATES ON ONE LINE                
         LA    R6,18(R4)                                                        
*--->    MVC   46(16,R4),=C'BILLING PERIOD -'                                   
         MVC   46(L'PP@BILPD,R4),PP@BILPD                                       
***E***                                                                         
         CLC   QPROG,=C'E1'         SEE IF ESTIMATE                             
         BNE   *+10                                                             
         MVC   46(7,R4),SPACES         BLANK -OUT 'BILLING'                     
***E***                                                                         
         GOTO1 DATCON,DMCB,QSTART,(5,0(R6))                                     
         GOTO1 (RF),(R1),QEND,(5,14(R6))                                        
         L     RE,=A(DICSECT)           MUST RESET RE                           
*--->    MVC   9(4,R6),=C'THRU'                                                 
         MVC   9(L'PP@THRU,R6),PP@THRU                                          
         B     BHX                                                              
         DROP  RE                                                               
         EJECT                                                                  
         SPACE 2                                                                
BH80     DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*                                                                               
         CLC   RCSVAGY,=C'DM'      DOREMUS - NO MEDIA IN REGISTER               
         BE    BH80T                                                            
         CLC   RCSVAGY,=C'SJ'      OR SJR                                       
         BE    BH80T                                                            
*--->    MVC   HEAD9(5),=C'MEDIA'                                               
         MVC   HEAD9(L'PP@MED),PP@MED                                           
         MVC   HEAD9+9(1),MED                                                   
         MVC   HEAD9+13(10),MEDNM                                               
*                                                                               
BH80T    CLI   TESTFLAG,C'T'                                                    
         BNE   *+10                                                             
*                                                                               
         MVC   HEAD9+39(L'PP@TSTBL),PP@TSTBL    **** TEST BILLING ****          
*                                                                               
         CLI   MIDASSW,C'Y'                                                     
         BNE   BHX                                                              
*****    MVC   MID1+94(5),=C'MIDAS'                                             
*****    MVC   MID2+90(27),=C'COMMISSION     TRADE CREDIT'                      
         MVC   MID1+90(10),SPACES            CLEARS 'CASH'                      
         MVC   MID2+90(15),=C'CD/TRADE CREDIT'                                  
*                                                                               
BHX      DS    0H                                                               
         XIT1                                                                   
         DROP  RE                                                               
         SPACE 3                                                                
FNEXTEL  DS    0H                                                               
         ZIC   RF,1(R2)                                                         
         AR    R2,RF                                                            
         CLI   0(R2),0                                                          
         JE    FNEXTEL2                                                         
         CLC   0(1,R2),ELCODE                                                   
         BER   RE                                                               
         J     FNEXTEL                                                          
FNEXTEL2 DS    0H                                                               
         LTR   RE,RE                                                            
         BR    RE                                                               
         EJECT                                                                  
*                                                                               
INVWD1   DC    C'       CONTROL  '                                              
INVWD2   DC    C'        NUMBER  '                                              
BAMTWD   DC    C'   BILL AMOUNT  '                                              
*                                                                               
*                                                                               
SAVMYH   DC    C' '   USED TO SAVE FIRST BYTE OF SECOND MYHEAD                  
*                     NEEDED WITH AORLOPT AND SEPARATE COMM INV.                
         SPACE 3                                                                
         LTORG                                                                  
BHTYPNAM DC    CL16'         ORDERED'                                           
BHTYPRVB DC    CL16'    PREV. BILLED'                                           
BHTYBLBL DC    CL16'        BILLABLE'                                           
*                                                                               
BHCATNAM DC    CL16'           GROSS'                                           
BHCATNET DC    CL16'             NET'                                           
BHCATCD  DC    CL16'      CASH DISC.'                                           
BHCATGLC DC    CL16'   GROSS LESS CD'                                           
BHCATNLC DC    CL16'     NET LESS CD'                                           
BHCATAC  DC    CL16'    AGENCY COMM.'                                           
         EJECT                                                                  
BH50     NMOD1 0,BH50                                                           
         LA    RC,SPACEND                                                       
*                             HERE FROM DUMMY NON-PRINTING HEADLINE             
*                             SETTING REPORT CALL                               
*                             SAVE NEEDED LINES                                 
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*                                                                               
         CLC   AESTBRK,APAGBRK     TEST EST TO BE IN B.MY HEADLINES             
         BH    BH51B                NO                                          
BH51     DS    0H                  STATE ESTIMATE                               
         MVC   HEAD6,SPACES                                                     
         MVC   HEAD7,SPACES                                                     
*--->    MVC   HEAD6(8),=C'ESTIMATE'                                            
         MVC   HEAD6(L'PP@EST),PP@EST                                           
         MVC   HEAD6+9(3),EST                                                   
         MVC   HEAD6+13(20),ESTNM                                               
         MVC   HEAD7+13(20),ESTNAM2                                             
***E***                                                                         
         CLC   QPROG,=C'E1'             FOR E1 SHOW REVISION NUMBER             
         BNE   BH52                                                             
***E***                                                                         
         OC    ESTREV,ESTREV            CHK FOR REVISION NUMBER                 
         BZ    BH52                                                             
         CLC   HEAD7+13(4),SPACES        USE HEAD7 IF I CAN                     
         BH    BH51A                                                            
*--->    MVC   HEAD7+13(3),=C'REV'                                              
         MVC   HEAD7+13(L'PP@REVIS),PP@REVIS                                    
         MVC   HEAD7+17(3),ESTREV                                               
         B     BH52                                                             
*                                                                               
BH51A    DS    0H                                                               
*--->    MVC   HEAD7+35(3),=C'REV'                                              
         MVC   HEAD7+35(L'PP@REVIS),PP@REVIS                                    
         MVC   HEAD7+39(3),ESTREV                                               
         DROP  RE                                                               
         B     BH52                                                             
*                                                                               
BH51B    DS    0H                                                               
         CLC   HEAD6+11(8),=C'FILTERED'   IF USING FILTERS                      
         BE    BH52                       LEAVE HEAD6 AND HEAD7 ALONE           
         MVC   HEAD6,SPACES        CLEAR ESTIMATE                               
         MVC   HEAD7,SPACES        CLEAR ESTIMATE                               
BH52     DS    0H                                                               
*                                  ADD CLT INTERFACE NO AFTER CLT NME           
         CLI   RCSUBPRG,101        IF LONG CLIENT NAME                          
         BE    BH52D               NO ROOM FOR INTERFACE NUMBER                 
*                                                                               
         CLI   AGMCLNO,C'Y'                                                     
         BE    BH52B                                                            
         CLI   AGMCLNO,C'C'        Y OR C MEANS YES                             
         BNE   BH52D                                                            
*                                                                               
BH52B    L     R7,ADCLT                                                         
         CLI   PCLTNUM-PCLTREC(R7),X'FF'                                        
         BNE   BH52C                        PWOS                                
         UNPK  WORK(5),PCLTNUM+1-PCLTREC(3,R7)                                  
         LA    R7,HEAD1+45                                                      
         CLI   0(R7),C' '                                                       
         BH    *+8                                                              
         BCT   R7,*-8                                                           
         MVI   3(R7),C'('                                                       
         MVC   4(4,R7),WORK                                                     
         MVI   8(R7),C')'                                                       
         B     BH52D                                                            
*                                                                               
BH52C    MVC   BYTE,PCLTNUM-PCLTREC(R7)                                         
         NI    BYTE,X'F0'                                                       
         CLI   BYTE,X'80'                                                       
         BNE   BH52C8                                                           
         XC    FULL,FULL                                                        
         MVC   FULL+1(3),PCLTNUM-PCLTREC(R7)                                    
         NI    FULL+1,X'7F'              SET-OFF X'80'                          
         L     R0,FULL                                                          
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  WORK(5),DUB                                                      
         LA    R7,HEAD1+45                                                      
         CLI   0(R7),C' '                                                       
         BH    *+8                                                              
         BCT   R7,*-8                                                           
         MVI   3(R7),C'('                                                       
         CLC   QAGENCY,=C'KA'        SPECIAL FOR KA                             
         BNE   BH52C4                                                           
         MVC   4(4,R7),WORK+1       NOTE - DROPS HIGH DIGIT                     
         MVI   8(R7),C')'                                                       
         B     BH52D                                                            
*                                                                               
BH52C4   MVC   4(5,R7),WORK                                                     
         MVI   9(R7),C')'                                                       
         B     BH52D                                                            
*                                                                               
BH52C8   MVC   WORK(3),PCLTNUM-PCLTREC(R7)                                      
         OC    WORK(3),SPACES                                                   
         CLC   WORK(3),SPACES                                                   
         BE    BH52D                                                            
*                                                                               
         LA    R7,HEAD1+45                                                      
         CLI   0(R7),C' '                                                       
         BH    *+8                                                              
         BCT   R7,*-8                                                           
         MVI   3(R7),C'('                                                       
         MVC   4(3,R7),WORK                                                     
         MVI   7(R7),C')'                                                       
*                                                                               
BH52D    DS    0H                                                               
*                                  ADD ACCT NO AFTER PRD NAME                   
         CLI   AGMCLNO,C'C'        C OR X MEANS NO                              
         BE    BH53                                                             
         CLI   AGMCLNO,C'X'                                                     
         BE    BH53                                                             
*                                                                               
         L     R7,ADPRD                                                         
         MVC   FULL,PPRDACCT-PPRDREC(R7)                                        
         CLI   FULL,C' '                                                        
         BNH   BH53                                                             
         CLC   FULL,=4C'0'                                                      
         BE    BH53                                                             
         LA    R7,HEAD5+45                                                      
         CLI   0(R7),C' '                                                       
         BH    *+8                                                              
         BCT   R7,*-8                                                           
         MVI   3(R7),C'('                                                       
         MVC   4(4,R7),FULL                                                     
         MVI   8(R7),C')'                                                       
         CLI   FULL,X'FF'          TEST NUMERIC ACCOUNT CODE                    
         BNE   BH53                                                             
         MVI   FULL,0                                                           
         CLC   QAGENCY,=C'JW'      SPECIAL FORMAT FOR JWT                       
         BNE   BH52F                                                            
         L     R0,FULL                                                          
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  4(5,R7),DUB                                                      
         MVI   9(R7),C')'                                                       
         B     BH53                                                             
*                                                                               
BH52F    CLC   QAGENCY,=C'KA'      SPECIAL FORMAT FOR KETCHEM                   
         BNE   BH52K                                                            
         L     R0,FULL                                                          
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  4(4,R7),DUB         **NOTE - DROPS HIGH DIGIT OF 5               
         MVI   8(R7),C')'                                                       
         B     BH53                                                             
*                                                                               
BH52K    EDIT  (B4,FULL),(5,4(R7)),ALIGN=LEFT                                   
         AR    R7,R0               ADD EDITED LENGTH                            
         MVI   4(R7),C')'                                                       
*                                                                               
BH53     DS    0H                                                               
         MVI   BYTE,0                                                           
         OC    AMGR1BRK,AMGR1BRK        TEST MGR'S IN HEADLINE                  
         BZ    BH53B                    NO                                      
         CLC   AMGR1BRK,APAGBRK                                                 
         BH    BH53B                    NO                                      
         OI    BYTE,X'40'               YES                                     
BH53B    DS    0H                                                               
         OC    APGR1BRK,APGR1BRK        TEST PGR'S IN HEADLINE                  
         BZ    BH53D                    NO                                      
         CLC   APGR1BRK,APAGBRK                                                 
         BH    BH53D                    NO                                      
         OI    BYTE,X'80'               YES                                     
*                                                                               
BH53D    DS    0H                                                               
         CLI   BYTE,0              NO MGRS AND NO PGRS                          
         BNE   BH53E                                                            
         CLC   AMKTBRK,APAGBRK     AND NO MKT                                   
         BH    BH53V2              NO NEED FOR ALIGNING                         
*                                                                               
BH53E    DS    0H                                                               
*                                                                               
*                                  FIRST ALIGN ALL FIELDS LIKE PGRS             
*                                  AND MGRS- DESC(12),CODE(5)                   
         MVC   X(45),HEAD6         SAVE EST MEADLINE                            
         MVC   X+45(45),HEAD7       SAVE EST LINE 2                             
*                                                                               
         CLI   MGR1CTL,C'S'        REGION SEPARATE?                             
         BE    *+10                                                             
         MVC   HEAD8(45),SPACES    CLEAR FROM HEAD8                             
         CLI   MGR2CTL,C'S'        DISTRICT SEPARATE?                           
         BE    *+10                                                             
         MVC   HEAD9(45),SPACES    CLEAR FROM HEAD9                             
*                                                                               
         CLI   RCSUBPRG,101        LONG CLIENT NAME OPTION?                     
         BE    BH53E5              YES - SKIP CLIENT ALTER                      
*                                                                               
         LA    R6,HEAD1            CLT                                          
         BAS   RE,BHMVR                                                         
*                                                                               
BH53E5   DS    0H                                                               
         LA    R6,HEAD2            DIVISION                                     
         BAS   RE,BHMVR                                                         
         LA    R6,HEAD5            PRD                                          
         BAS   RE,BHMVR                                                         
         LA    R6,HEAD6            EST   EST USES HEAD 6 AND 7                  
         BAS   RE,BHMVR                                                         
         LA    R6,HEAD7            EST   EST USES HEAD 6 AND 7                  
         BAS   RE,BHMVR                                                         
         LA    R6,HEAD8            REGION                                       
         BAS   RE,BHMVR                                                         
         LA    R6,HEAD9            DISTRICT                                     
         BAS   RE,BHMVR                                                         
BH53T    DS    0H                                                               
*                                  RESTORE ESTIMATE LINE                        
*                                  IF NOT STANDARD                              
         CLC   X(3),=C'ALL'                                                     
         BE    BH53V                                                            
         CLC   X+9(5),=C'GROUP'                                                 
         BNE   BH53V2                                                           
BH53V    DS    0H                                                               
         MVC   HEAD6(45),X                                                      
         MVC   HEAD7(45),X+45                                                   
*                                                                               
BH53V2   DS    0H                                                               
*                                                                               
         CLI   OUWBSW,C'Y'       CHK OMDTOA'S WARNER BROS. FEATURE              
         BE    BH53V2A           IT ALSO PRINTS FIRST PRD USER HERE             
*                                                                               
         CLI   WMSW,C'Y'         CHECK FOR WALMART PROCESSING                   
         BNE   BH53V2X                                                          
BH53V2A  LA    R4,HEAD7            FIND FIRST FREE HEAD AFTER EST               
         CLC   HEAD7(10),SPACES    EITHER HEAD 7, 8, 0R 9 MUST BE FREE          
         BE    BH53V2B                                                          
         LA    R4,HEAD8                                                         
         CLC   HEAD8(10),SPACES                                                 
         BE    BH53V2B                                                          
         LA    R4,HEAD9                                                         
         CLC   HEAD9(10),SPACES                                                 
         BE    BH53V2B                                                          
         B     BH53V2X              IF NOT SKIP                                 
*                                                                               
BH53V2B  DS    0H       PRINT 1ST PRODUCT USER                                  
*                                                                               
*        NOTE  - ONLY WORKS IF SAME DATA IS SET IN EVERY PRODUCT                
*                                                                               
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'P',ADPRD),(C':',0(R4)),X        
               0                                                                
*                                                                               
         TM    DMCB+4,X'10'      SEE TO PRINT ON BILLING                        
         BNO   BH53V2E                                                          
         TM    DMCB+4,X'04'      SEE IF TO PRINT IN HEADLINES                   
         BNO   BH53V2E                                                          
         B     BH53V2X                                                          
*                                                                               
BH53V2E  MVC   0(54,R4),SPACES   CLEAR IF NOT TO APPEAR ON BILLING              
*                                OR NOT IN HEADLINES                            
BH53V2X  DS    0H                                                               
         CLI   PROFB2B+6,C'F'    ESTIMATE DATES IN FRONT                        
         BE    BH53V2XU                                                         
*                                                                               
         CLI   PROFB2B+5,C'N'    SHOW ESTIMATE DATES                            
         BE    BH53V2XU                                                         
         CLI   PROFB2B+5,0       SHOW ESTIMATE DATES                            
         BE    BH53V2XU                                                         
         CLI   ESTCTL,C'S'     MUST BE SEPARATE                                 
         BNE   BH53VA                                                           
         L     R2,ADEST                                                         
         USING PESTREC,R2                                                       
*                                                                               
         CLC   HEAD8(10),SPACES  HEAD 8 MUST BE FREE                            
         BNE   BH53VA                                                           
         MVC   HEAD8(12),=C'FLIGHT DATES'                                       
         CLI   PROFB2B+5,C'F'                                                   
         BE    BH53V2X2                                                         
         MVC   HEAD8(14),=C'CAMPAIGN DATES'                                     
         CLI   PROFB2B+5,C'C'                                                   
         BE    BH53V2X2                                                         
         MVC   HEAD8(14),=C'ESTIMATE DATES'                                     
         CLI   PROFB2B+5,C'E'                                                   
         BE    BH53V2X2     OR ANY OTHER VALUES                                 
*                                                                               
BH53V2X2 GOTO1 DATCON,DMCB,(0,PESTST),(5,HEAD8+15)                              
         MVI   HEAD8+23,C'-'                                                    
         GOTO1 DATCON,DMCB,(0,PESTEND),(5,HEAD8+24)                             
         B     BH53VA                                                           
*                                                                               
         DROP  R2                                                               
*        NOTE - CAN'T SHOW ESTIMATE USER FIELDS WITH EST DATES                  
*                                                                               
*                                                                               
*        NOW ATTEMPT TO PRINT ESTIMATE USER FIELDS                              
*        IN HEADLINES                                                           
*                                                                               
BH53V2XU MVI   EUSERSW,0                                                        
         CLI   ESTCTL,C'S'     MUST BE SEPARATE                                 
         BNE   BH53VA                                                           
*                               BOTH HEAD 8 AND 9 MUST BE FREE                  
         CLC   HEAD8(10),SPACES                                                 
         BNE   BH53VA                                                           
         CLC   HEAD9(10),SPACES                                                 
         BNE   BH53VA                                                           
***                                                                             
***      NOTE  USING HEAD8 AND 9 MAY STILL CLOBBER ADDRESS?                     
***                                                                             
*                                                                               
         L     R2,ADEST                                                         
         LA    R2,33(R2)    TO FIRST ELEMENT                                    
         MVI   ELCODE,X'08'   LOOK FOR USER DATA                                
         BRAS  RE,NEXTEL                                                        
         BNE   BH53VA       CAN SKIP GETUER CALLS                               
         USING PESTUDEF,R2                                                      
         MVC   X(32),PEUSER1      SAVE REAL PEUSER1                             
         MVC   X+32(16),PEUSER2   AND PEUSER2                                   
*                                                                               
*        STRIP-OFF #R# AND #F# PREFIXES HERE                                    
*                                                                               
         CLC   PEUSER1(3),=C'#R#'     ONLY ON NON-ADJ INV?                      
         BE    BHPRTE5                                                          
         CLC   PEUSER1(3),=C'#F#'     ONLY ON NON-ADJ INV?                      
         BNE   BHPRTE6                                                          
BHPRTE5  MVC   WORK(32),PEUSER1                                                 
         MVC   PEUSER1(29),WORK+3                                               
         MVC   PEUSER1+29(3),SPACES                                             
*                                                                               
BHPRTE6  DS    0H                                                               
         CLC   PEUSER2(3),=C'#R#'     ONLY ON NON-ADJ INV?                      
         BE    BHPRTE7                                                          
         CLC   PEUSER2(3),=C'#F#'     ONLY ON NON-ADJ INV?                      
         BNE   BHPRTE8                                                          
BHPRTE7  MVC   WORK(16),PEUSER2                                                 
         MVC   PEUSER2(13),WORK+3                                               
         MVC   PEUSER2+13(3),SPACES                                             
*                                                                               
BHPRTE8  DS    0H                                                               
*                                                                               
         CLI   ADJSEP,C'Y'      SEE IF PUTTING ADJ ON SEPARATE INV              
         BNE   BH53V2X4                                                         
*                                                                               
         CLC   X(3),=C'#R#'     ONLY ON NON-ADJ INV?                            
         BNE   BH53V2X3                                                         
         LA    R4,HEAD8           MUST SET R4 HERE                              
         CLI   DUESW,C'A'         IS THE AN ADJ SEP INV?                        
         BE    BH53V5             SKIP THE FIRST EST USER                       
         B     BH53V2X4                                                         
*                                                                               
BH53V2X3 CLC   X(3),=C'#F#'     ONLY ON ADJ SEP BILL?                           
         BNE   BH53V2X4                                                         
         LA    R4,HEAD8           MUST SET R4 HERE                              
         CLI   DUESW,C'A'         IS THE AN ADJ SEP INV?                        
         BNE   BH53V5             SKIP THE FIRST EST USER                       
         B     BH53V2X4                                                         
*                                                                               
BH53V2X4 DS    0H                                                               
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'E',ADEST),(C':',HEAD8),+        
               0                                                                
*                                                                               
         LA    R4,HEAD8                                                         
         TM    DMCB+4,X'10'      SEE TO PRINT ON BILLING                        
         BNO   BH53V3                                                           
         TM    DMCB+4,X'04'      SEE IF TO PRINT IN HEADLINES                   
         BNO   BH53V3                                                           
         MVI   EUSERSW,1        EST USER 1 TO PRINT                             
         LA    R4,HEAD9                                                         
         B     BH53V5                                                           
*                                                                               
BH53V3   DS    0H                                                               
         MVC   HEAD8(54),SPACES    CLEAR IF NOT TO PRINT                        
BH53V5   DS    0H                                                               
         CLI   0(R2),X'08'         SEE IF EST USER DATA PRESENT                 
         BNE   BH53V5X                                                          
*                                                                               
         CLI   ADJSEP,C'Y'                                                      
         BNE   BH53V5X                                                          
*                                                                               
         CLC   X+32(3),=C'#R#'     ONLY ON NON-ADJ INV?                         
         BNE   BH53V5A                                                          
         CLI   DUESW,C'A'         IS THE AN ADJ SEP INV?                        
         BE    BH53V9             SKIP THE FIRST EST USER                       
         B     BH53V5X                                                          
*                                                                               
BH53V5A  CLC   X+32(3),=C'#F#'     ONLY ON ADJ SEP BILL?                        
         BNE   BH53V5X                                                          
         CLI   DUESW,C'A'         IS THE AN ADJ SEP INV?                        
         BNE   BH53V9             SKIP THE FIRST EST USER                       
         B     BH53V5X                                                          
*                                                                               
BH53V5X  DS    0H                                                               
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'E',ADEST),0,           +        
               (C':',0(R4))                                                     
*                                                                               
         TM    DMCB+6,X'10'      SEE TO PRINT ON BILLING                        
         BNO   BH53V7                                                           
         TM    DMCB+6,X'04'      SEE IF TO PRINT IN HEADLINES                   
         BNO   BH53V7                                                           
         ZIC   R1,EUSERSW        BUMP COUNT OF ESTIMATE USERS                   
         LA    R1,1(R1)                                                         
         STC   R1,EUSERSW                                                       
         B     BH53V9                                                           
*                                                                               
BH53V7   MVC   0(54,R4),SPACES     CLEAR IF NOT TO PRINT                        
*                                                                               
BH53V9   DS    0H                                                               
*                                                                               
         MVC   PEUSER1,X         RESTORE REAL USER 1                            
         MVC   PEUSER2,X+32      RESTORE REAL USER 2                            
*                                                                               
         DROP  R2                                                               
*                                                                               
BH53VA   DS    0H             GET HERE IF NO EST USERS FOUND                    
         B     BH53Z                                                            
         SPACE 2                                                                
BHMVR    DS    0H                  ALIGN AS DESC(12),CODE(5)                    
         MVC   WORK,0(R6)                                                       
         MVC   9(40,R6),SPACES                                                  
         MVC   10(3,R6),WORK+9                                                  
         MVC   15(30,R6),WORK+13                                                
         BR    RE                                                               
         SPACE 2                                                                
BH53Z    DS    0H                                                               
*                                                                               
*                                  CLEAR MYHEADS                                
         L     R4,=A(MYHEADS)                                                   
         LA    R0,10             450 / 10                                       
         MVC   0(45,R4),SPACES                                                  
         LA    R4,45(R4)                                                        
         BCT   R0,*-10                                                          
*                                                                               
         L     R4,=A(MYHEADS)                                                   
         MVC   0(45,R4),HEAD1       CLIENT                                      
         LA    R4,45(R4)                                                        
         LA    R3,BRKTAB                                                        
         USING BRKTABD,R3                                                       
*                                                                               
BH54     DS    0H                                                               
         OC    BRKCODE,BRKCODE                                                  
         BZ    BH50X                                                            
         CLI   WBSW,C'Y'           CHECK FOR WARNER BROS. CLIENT                
         BNE   BH54AA                                                           
         CLI   BRKCODE+3,PUBEQ     BYPASS BREAKS 'BELOW' PUB                    
         BNL   BH55                                                             
         B     BH54AB                                                           
*                                                                               
BH54AA   CLI   BRKCODE+3,PUBEQ     BYPASS BREAKS 'BELOW' PUB                    
         BH    BH55                                                             
*                                                                               
BH54AB   CLI   UPASS,X'FF'         TEST RETAIL SUMMARY PASS - WAS C'S'          
         BE    BH54A                                                            
*                                                                               
         C     R3,APAGBRK          FOR REG BULL PAGBRK IS LIMIT                 
         BH    BH56                                                             
         B     BH54B                                                            
*                                  FOR SUMMARY PASS - USE LEVCTLS               
BH54A    DS    0H                                                               
         LA    RF,LEVCTLS                                                       
         A     RF,BRKCODE                                                       
         CLI   0(RF),C'S'          SEPARATE                                     
         BE    BH54B                                                            
         CLI   0(RF),C'P'          OR PAGE BREAK                                
         BNE   BH56                                                             
BH54B    DS    0H                                                               
         L     RF,BRKCODE                                                       
         CLI   BRKCODE+3,ESTEQ                                                  
         BNH   BH54C                                                            
         LA    RF,4(RF)            SINCE EST USES 2 LINES                       
BH54C    MH    RF,=H'33'           132/4 = INDEX INTO HEADS                     
****                                                                            
****  WAS LA   RF,HEAD1(RF)            OK WHEN FIRST BRKCODE WAS 04             
****                                                                            
         LA    RF,HEAD1-L'HEAD1(RF)  SINCE FIRST BRKCODE IS NOW 08              
*                                    NOT 04                                     
         MVC   0(45,R4),0(RF)                                                   
         LA    R4,45(R4)           NEXT LINE                                    
         CLI   BRKCODE+3,ESTEQ       SEE IF DOING EST                           
         BNE   BH55                                                             
         LA    RF,L'HEAD1(RF)      ALSO DO 2ND EST LINE                         
*                                                                               
         CLC   0(45,RF),SPACES     SEE IF USED                                  
         BNH   BH54E               NO THEN SKIP                                 
*                                                                               
         MVC   0(45,R4),0(RF)                                                   
         LA    R4,45(R4)           NEXT LINE                                    
*                                                                               
BH54E    DS    0H                                                               
         CLI   PROFB2B+5,C'N'      SHOW ESTIMATE DATES?                         
         BE    BH54E5                                                           
         CLI   PROFB2B+5,0         SHOW ESTIMATE DATES?                         
         BE    BH54E5                                                           
         LA    RF,L'HEAD1(RF)      DO ESTIMATE DATES                            
         MVC   0(45,R4),0(RF)                                                   
         LA    R4,45(R4)           NEXT LINE                                    
         B     BH55                CAN'T DO EST USERS?                          
*                                                                               
BH54E5   CLI   EUSERSW,0           ESTIMATE USERS TO PRINT?                     
         BE    BH55                                                             
         LA    RF,L'HEAD1(RF)      DO FIRST ESTIMATE USER                       
         MVC   0(45,R4),0(RF)                                                   
         LA    R4,45(R4)           NEXT LINE                                    
         CLI   EUSERSW,1           ONLY ONE?                                    
         BE    BH55                                                             
         LA    RF,L'HEAD1(RF)      DO 2ND ESTIMATE USER                         
         MVC   0(45,R4),0(RF)                                                   
         LA    R4,45(R4)           NEXT LINE                                    
*                                                                               
BH55     DS    0H                                                               
         LA    R3,BRKL(R3)         NEXT LEVEL                                   
         B     BH54                                                             
BH56     DS    0H                                                               
         C     R3,AESTBRK                                                       
         BNE   BH55                                                             
*                                  EVEN IF EST NOT ON BILL                      
*                                  PUT IT IN HEADS                              
         MVC   0(45,R4),HEAD6                                                   
         B     BH55                                                             
*                                                                               
BH50X    DS    0H                                                               
*                    R4 SHOULD BE POINTING TO NEXT LINE IN MYHEADS              
*                                                                               
         CLI   PO#OPT,C'Y'                                                      
         BNE   BH50X5                                                           
         MVC   0(L'PO#ANNO,R4),PO#ANNO                                          
         L     RF,AJOB                                                          
         CLC   0(3,RF),=X'FFD7D6'     X'FF'C'PO'                                
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    R4,L'PO#ANNO(R4)                                                 
BH50X2   CLI   0(R4),C' '                                                       
         BH    BH50X3                                                           
         SH    R4,=H'1'                                                         
         B     BH50X2                                                           
*                                                                               
BH50X3   MVC   2(25,R4),4(RF)     PO# DATA                                      
         B     BH50XX                                                           
*                                                                               
BH50X5   CLI   WBSW,C'Y'     LASTLY CHECK WARNER BROTHERS OPTION                
         BNE   BH50XX                                                           
         OC    ESTWBFLT,ESTWBFLT   DO I HAVE ONE?                               
         BZ    BH50XX                                                           
         MVC   0(09,R4),=C'WB FLIGHT'                                           
         MVC   15(10,R4),ESTWBFLT                                               
*                                                                               
BH50XX   DS    0H                                                               
         XIT1                                                                   
         LTORG                                                                  
*                                                                               
EUSERSW  DC    X'00'                                                            
         EJECT                                                                  
*                             INVOICE REGISTER HEADLINES                        
         TITLE 'ERRPROC - HANDLE RRRORS'                                        
         SPACE 2                                                                
ERRPROC  NMOD1 0,ERRPROC                                                        
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         LA    RE,ERRLIST                                                       
         L     RF,=F'780'                                                       
         XCEF                                                                   
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
         MVC   INVL3,PP@INVL3      INVALID PRODUCT GROUP                        
         MVC   INVL4,PP@INVL4      INVALID REGION/DISTRICT SCHEME               
         MVC   NEWB,PP@NEWB  NEW BILLING NOT EFFECTIVE FOR THIS DATE            
         MVC   NOBG,PP@NOBG        NO BILLING GENERATED                         
         MVC   MERR1,PP@MERR1      MANUAL AMOUNT ERROR                          
         MVC   INVL5,PP@INVL5      INVALID BILLING PERIOD                       
         MVC   INVL6,PP@INVL6      INVALID BILLING TYPE                         
         MVC   PROF,PP@PROF        PROFILE INCOMPATIBILITY - RETAIL             
         MVC   DTL1,PP@DTL1   DETAIL BACK-UP INCOMP. WITH SEP ADJ.              
         MVC   INVL7,PP@INVL7      INVALID BILLING PROFILE                      
         MVC   MERR2,PP@MERR2      MANUAL REVERSAL ERROR                        
         MVC   AORBL,PP@AORBL  AOR BILL - PRDS NOT SEPARATE,OR MEDIA            
         MVC   REG,PP@REG                                                       
         DROP  RE                                                               
*                                                                               
         MVC   P1(80),QPROG                                                     
         MVC   P2(80),QAREA2                                                    
         MVI   SKIPSPEC,C'Y'                                                    
         MVI   FORCEHED,C'Y'                                                    
         MVI   PRSW,C'N'                                                        
         GOTO1 =A(PRNT)                                                         
         ZIC   RF,ERR                                                           
         MH    RF,=H'60'                                                        
         LA    RF,ERRLIST-60(RF)                                                
         MVC   P1(2),=C'**'                                                     
         MVC   P1+3(60),0(RF)                                                   
*                                                                               
         CLI   ERR,PROFERR         INVALID BILLING PROFILE ERROR?               
         BNE   *+22                (+33 TO GET PAST TEXT)                       
         MVC   P1+33(3),ERRPROF    DISPLAY PROFILE #                            
         MVC   P1+37(2),ERRPROF+3  DISPLAY PROFILE FIELD #                      
         MVC   ERRPROF,SPACES      CLEAR AFTER PRINTING                         
*                                                                               
         MVI   SKIPSPEC,C'Y'                                                    
         MVI   PRSW,C'N'                                                        
         GOTO1 =A(PRNT)                                                         
         CLC   QCLIENT,=C'ALL'                                                  
         BE    ERRP5                                                            
         CLI   QCLIENT,C'*'        OFFICE                                       
         BE    ERRP5                                                            
         CLI   QCLIENT,C'&&'       CLIENT GROUP                                 
         BE    ERRP5                                                            
         B     ERRPX                                                            
ERRP5    CLI   ERR,PROFERR         SEE IF PROFILE ERROR                         
         BE    ERRP7                                                            
         CLI   ERR,PROFERR5        SEE IF PROFILE ERROR                         
         BE    ERRP7                                                            
         CLI   ERR,PROFERR6        SEE IF PROFILE ERROR                         
         BE    ERRP7                                                            
         CLI   ERR,TYPERR          OR TYPE ERROR                                
         BE    ERRP7                                                            
         B     ERRPX                                                            
*                                                                               
ERRP7    DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   P1(34),=C'** NO BILLING GENERATED FOR CLIENT'                    
         MVC   P1(L'PP@NOBIL),PP@NOBIL                                          
         DROP  RE                                                               
         L     RF,ADCLT                                                         
         MVC   P1+35(3),PCLTKCLT-PCLTREC(RF)                                    
         GOTO1 =A(PRNT)                                                         
         MVI   CLTSW,C'N'          SKIP TO NEXT CLIENT                          
         XIT1                                                                   
**                                                                              
ERRPX    DS    0H                                                               
         BRAS  RE,UNLOCK     MUST UNLOCK HERE ALSO FOR UPDATIVE SOONS           
*                            UPDATIVE SOONS LIMITED TO ONE CLIENT               
         GOTO1 AENDREQ             NEXT REQUEST                                 
         SPACE 3                                                                
ERRLIST  DS    0C                                                               
INVL3    DC    CL60'INVALID PRODUCT GROUP'            1                         
INVL4    DC    CL60'INVALID REGION/DISTRICT SCHEME'              2              
*              USUALLY BECAUSE PUB NOT ASSGINED TO A DISTRICT                   
*              FOR 'ALL' DISTRICT REQUEST                                       
NEWB     DC    CL60'NEW BILLING NOT EFFECTIVE FOR THIS DATE'     3              
NOBG     DC    CL60'NO BILLING GENERATED'                        4              
MERR1    DC    CL60'MANUAL AMOUNT ERROR'                         5              
INVL5    DC    CL60'INVALID BILLING PERIOD'                      6              
INVL6    DC    CL60'INVALID BILLING TYPE'                        7              
PROF     DC    CL60'PROFILE INCOMPATIBILITY - RETAIL'            8              
DTL1     DC    CL60'DETAIL BACK-UP  INCOMP. WITH SEP ADJ.'       9              
INVL7    DC    CL60'INVALID BILLING PROFILE'                    10              
MERR2    DC    CL60'MANUAL REVERSAL ERROR'                      11              
*  ATTEMPT TO MANUALLY REVERSE A BILL WHICH 'REBILLED' AN OLD MANUAL            
AORBL    DC    CL60'AOR BILL - PRDS NOT SEPARATE,OR MEDIA *'    12              
REG      DC    CL60'REG/DST,MKT,JOB,PUB CAN''T BE SEPARATE WITH CLEAREDX        
                ESTS'                                           13              
         DC    CL60'PROFILE INCOMPATIBILITY - AOR'              14              
         DC    CL60'COMMISSION/NET/REG OPTION INVALID'          15              
         DC    CL60'INVALID ESTIMATE OPTION'                    16              
         DC    CL60'INVALID REQUESTING ID'                      17              
         DC    CL60'PROFILE ERROR - NO ZONE/EDT WITH PUB PST'   18              
         DC    CL60'MONTH OF SERVICE PROFILE ERROR'             19              
         DC    CL60'A PRIOR INVOICE NUMBER EXCEEDED 9999'       20              
*                                                                               
*                                                                               
         SPACE 3                                                                
PGRERR   EQU   1                                                                
MGRERR   EQU   2                                                                
DATERR   EQU   3                                                                
NOBILERR EQU   4                                                                
MANERR   EQU   5                                                                
DATERR2  EQU   6                                                                
TYPERR   EQU   7                                                                
RETPERR  EQU   8                                                                
ADJERR   EQU   9                                                                
PROFERR  EQU   10                                                               
AORERR   EQU   12                                                               
PROFERR5 EQU   13                                                               
AORPERR  EQU   14                                                               
SCBERR   EQU   15                                                               
ESTERR   EQU   16                                                               
IDERR    EQU   17                                                               
PROFERR6 EQU   18                                                               
MOSERR   EQU   19       IF USING B1X BILLING FORMULA MOS OPTION                 
*                       MOS MUST BE ON SEPARATE INVOICES                        
INVNERR  EQU   20                                                               
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
         TITLE 'PRNTPROF - TRACE USER PROFILE'                                  
PRNTPROF NMOD1 0,PRNTPROF                                                       
         LA    RC,SPACEND                                                       
*                                                                               
* P1: KEY PASSED TO GETPROF                                                     
* P2: RETURNED PROFILE VALUES FROM GETPROF                                      
* P3: ADDITIONAL RETURNED INFO FROM GETPROF                                     
*                                                                               
         MVC   SAVEPRFK,WORK       SAVE PROFILE KEY                             
*                                                                               
         L     RF,APATCH                                                        
         TM    0(RF),X'10'         PRINT USER PROFILES?                         
         BZ    PRNTPRFX            NO                                           
*                                                                               
         LM    R2,R4,0(R1)                                                      
*                                                                               
         USING PROFKD,R2                                                        
         USING PROFINFD,R4                                                      
*                                                                               
         OC    PROFIDAT,PROFIDAT   ANY ACTIVITY DATE PRESENT?                   
         BZ    PRNTPRFX            NO -- NO PROFILE WAS RETURNED                
*                                                                               
         MVC   P1(PROFMSLQ),PROFMSG PREPARE TO PRINT PROFILE INFO               
         MVC   P1(3),PROFKPGM                                                   
         TM    PROFKSYS,X'40'      SYSTEM IS LOWER CASE?                        
         BZ    *+14                                                             
         MVC   P1(2),P1+1          YES - PROGRAM IS 3 CHARS. LONG               
         MVI   P1+2,C' '                                                        
         MVC   P1+38(5),SPACES                                                  
         MVC   P1+38(L'PROFIAGY),PROFIAGY                                       
         CLC   PROFIAGY,SPACES     NUMERIC USERID IN KEY?                       
         BNL   PRNTPRF5            NO                                           
         EDIT  PROFIAGY,(5,P1+38),ALIGN=LEFT                                    
PRNTPRF5 MVC   P1+51(3),SPACES                                                  
         MVC   P1+51(L'PROFIMED),PROFIMED                                       
         CLI   PROFIMED,0                                                       
         BNE   *+10                                                             
         MVC   P1+51(3),=C'ALL'                                                 
         MVC   P1+63(3),SPACES                                                  
         MVC   P1+63(L'PROFICLT),PROFICLT                                       
         OC    PROFICLT,PROFICLT                                                
         BNZ   *+10                                                             
         MVC   P1+63(3),=C'ALL'                                                 
         GOTO1 DATCON,DMCB,(3,PROFIDAT),(8,P1+21)                               
         GOTO1 REPORT                                                           
*                                                                               
         GOTO1 HEXOUT,DMCB,0(R3),P1+1,16,=C'N'                                  
         MVC   P1+40(16),0(R3)                                                  
         GOTO1 REPORT                                                           
         GOTO1 REPORT                                                           
*                                                                               
PRNTPRFX DS    0H                                                               
         MVC   WORK(16),SAVEPRFK     RESTORE WORK (PROFILE KEY)                 
         XIT1                                                                   
         DROP  R2,R4                                                            
         SPACE 2                                                                
PROFMSG  DC    C'XXX PROFILE, UPDATED MMMDD/YY, AGENCY=XXXXX, MEDIA=XXX+        
               , CLIENT=CCC'                                                    
PROFMSLQ EQU   *-PROFMSG                                                        
         SPACE 2                                                                
         LTORG                                                                  
SAVEPRFK DS    CL16           SAVED PROFILE KEY                                 
         EJECT                                                                  
*                             GET SHARE FOR REGION/DISTRICT                     
*                                  THIS ROUTINE FORCES THE SHARES FOR           
*                                  EACH REG/DIST TO ADD TO THE TOTAL.           
*                                  THE LOGIC PARALELLS THAT FOR POOL            
*                                  ALLOCATION IN GETINS.                        
RDSPLIT  DS    0D                                                               
         NMOD1 0,RDSPLIT                                                        
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         L     RF,0(R1)                                                         
         MVC   DOUBLE(6),0(RF)     REG/DIST                                     
         OC    DOUBLE(6),SPACES                                                 
****                                                                            
         MVC   RDDIFS(48),GROSS         GROSS AND PAID + TAX                    
         MVC   RDDIFS+48(16),BGROSS     BILLED DATA                             
         XC    RDBLSUMS,RDBLSUMS                                                
****                                                                            
         XC    RDSUMS,RDSUMS                                                    
         XC    FULL,FULL                                                        
******                                                                          
******   NO-OPED INSTRUCTIONS SINCE QPUB+1 SHOULD ALWAYS BE RD=                 
******                                                                          
******   L     RF,ADCLT                                                         
******   MVC   RDCLTDIV(3),PCLTKCLT-PCLTREC(RF)                                 
******   L     RF,ADPRD                                                         
******   MVC   RDCLTDIV+3(3),PPRDDIV-PPRDREC(RF)                                
******                                                                          
         L     RF,ADCLT                                                         
         MVC   RDCLTDIV(3),PCLTKCLT-PCLTREC(RF)                                 
         MVC   RDCLTDIV+3(3),SAVPGRU                                            
         CLC   QPUB+1(3),=C'RD='        REQUESTED REG/DST OVERRIDE              
         BNE   *+16                                                             
         MVC   RDCLTDIV(3),QPUB+4                                               
         MVC   RDCLTDIV+3(3),=C'000'                                            
*                                                                               
*                                  FIRST PASS                                   
         L     R2,ALTLREC                                                       
         LA    R2,33(R2)                                                        
         CLI   0(R2),X'71'                                                      
         BE    RDSP4                                                            
RDSP3    DS    0H                                                               
         BAS   RE,RDNXTEL                                                       
         BNE   RDSP8                                                            
RDSP4    DS    0H                                                               
         USING PUBDSTEL,R2                                                      
         CLC   PUBDCLT(6),RDCLTDIV                                              
         BNE   RDSP3                                                            
         XC    FULL,FULL                                                        
         MVC   FULL+2(2),PUBDSHR                                                
         LA    R4,GROSS                                                         
         LA    R3,RDDIFS                                                        
****                                                                            
         ZAP   COUNT,=P'1'                                                      
****                                                                            
RDSP5    DS    0H                                                               
         L     R1,0(R4)                                                         
         LTR   R1,R1                                                            
         BZ    RDSP6                                                            
         M     R0,FULL                                                          
         BAS   RE,RDDIV            ROUNDED DIVISION                             
         L     R0,0(R3)                                                         
         SR    R0,R1                                                            
         ST    R0,0(R3)                                                         
RDSP6    DS    0H                                                               
****                                                                            
         CP    COUNT,=P'16'                                                     
         BE    RDSP6E                                                           
         AP    COUNT,=P'1'                                                      
         B     RDSP6C                                                           
*                                                                               
RDSP6C   LA    R4,4(R4)                                                         
         LA    R3,4(R3)                                                         
RDSP6D   B     RDSP5               NEXT AMOUNT                                  
RDSP6E   B     RDSP3               NEXT SHARE                                   
****                                                                            
*                                                                               
*                                                                               
RDSP8    DS    0H                                                               
         OC    FULL,FULL                                                        
         BZ    RDSPLITX            NO SHARES                                    
*                                  END OF PASS 1                                
*                                  NOW RDDIFS HAS DIFFERENCES                   
*                                  BETWEEN ORIGINAL AMOUNTS AND                 
*                                  SUM OF ROUNDED SHARES                        
*                                                                               
*                                                                               
*                                  PASS 2                                       
         L     R2,ALTLREC                                                       
         LA    R2,33(R2)                                                        
         CLI   0(R2),X'71'                                                      
         BE    RDSP10                                                           
RDSP9    DS    0H                                                               
         BAS   RE,RDNXTEL                                                       
         BNE   RDSP30                                                           
RDSP10   DS    0H                                                               
         CLC   PUBDCLT(6),RDCLTDIV                                              
         BNE   RDSP9                                                            
*                                  IS THIS A SELECTED REG/DST                   
         MVI   DOUBLE+6,0               NO                                      
         CLC   DOUBLE(3),=C'ALL'                                                
         BE    RDSP11                                                           
         CLC   DOUBLE(3),SPACES                                                 
         BE    RDSP11                                                           
         CLC   DOUBLE(3),PUBDREG                                                
         BH    RDSP13                                                           
         BL    RDSP30                                                           
RDSP11   DS    0H                                                               
         CLC   DOUBLE+3(3),=C'ALL'                                              
         BE    RDSP12                                                           
         CLC   DOUBLE+3(3),SPACES                                               
         BE    RDSP12                                                           
         CLC   DOUBLE+3(3),PUBDDST                                              
         BH    RDSP13                                                           
         BL    RDSP30                                                           
RDSP12   DS    0H                                                               
         MVI   DOUBLE+6,1               YES                                     
RDSP13   DS    0H                                                               
         MVC   FULL+2(2),PUBDSHR                                                
         LA    R4,GROSS                                                         
         LA    R3,RDDIFS                                                        
****                                                                            
         ZAP   COUNT,=P'1'                                                      
****                                                                            
RDSP13A  DS    0H                                                               
         OC    0(4,R4),0(R4)                                                    
         BZ    RDSP20              NO AMOUNT                                    
         OC    0(4,R3),0(R3)                                                    
         BNZ   RDSP14                                                           
*                                  NO DIFF                                      
         CLI   DOUBLE+6,0          TEST IF A SELECTED REG/DST                   
         BE    RDSP20              NO                                           
         L     R1,0(R4)                                                         
         M     R0,FULL             YES COMPUTE SHARE                            
         BAS   RE,RDDIV                                                         
*                                  AND ADD TO RDSUMS                            
RDSP13B  DS    0H                                                               
****                                                                            
         A     R1,64(R3)                                                        
         ST    R1,64(R3)                                                        
****                                                                            
         B     RDSP20                                                           
RDSP13D  DS    0H                                                               
         CLI   DOUBLE+6,0          TEST IF A SELECTED REG/DST                   
         BE    RDSP20              NO                                           
         B     RDSP13B             YES                                          
*                                  DIFFERENCE NO-ZERO                           
RDSP14   DS    0H                                                               
         L     R1,0(R4)                                                         
         M     R0,FULL             SHARE                                        
         D     R0,=F'10000'        TRUNCATED DIVISION                           
         LTR   R0,R0               TEST REMAINDER                               
         BZ    RDSP13D             ZERO                                         
         BM    RDSP17              NEG                                          
*                                                                               
*                                  AMOUNT POS                                   
         TM    0(R3),X'80'         TEST DIFF                                    
         BNZ   RDSP15                                                           
*                                  AMOUNT POS, DIFF POS                         
         C     R0,=F'5000'         TEST IF ROUNDED DOWN                         
         BNL   RDSP13D             NO                                           
         L     RF,0(R3)            YES - SUBTRACT 1 FROM DIFF                   
         BCTR  RF,R0                                                            
         ST    RF,0(R3)                                                         
         A     R1,=F'1'            ADD 1 TO AMOUNT                              
         B     RDSP13D                                                          
*                                  AMOUNT POS, DIFF NEG                         
RDSP15   DS    0H                                                               
         C     R0,=F'5000'         TEST IF ROUNDED UP                           
         BL    RDSP13D             NO                                           
         L     RF,0(R3)            YES - ADD 1 TO DIFF                          
         A     RF,=F'1'                                                         
         ST    RF,0(R3)                                                         
         B     RDSP13D                                                          
*                                                                               
*                                  AMOUNT NEG                                   
RDSP17   DS    0H                                                               
         TM    0(R3),X'80'         TEST DIFF                                    
         BZ    RDSP18                                                           
*                                  AMOUNT NEG, DIFF NEG                         
         C     R0,=F'-5000'       TEST IF ROUNDED UP                            
         BL    RDSP13D             NO                                           
         L     RF,0(R3)            YES - ADD 1 TO DIFF                          
         A     RF,=F'1'                                                         
         ST    RF,0(R3)                                                         
         BCTR  R1,R0               SUBTRACT 1 FROM AMT                          
         B     RDSP13D                                                          
*                                  AMOUNT NEG, DIFF POS                         
RDSP18   DS    0H                                                               
         C     R0,=F'-5000'        TEST IF ROUNDED DOWN                         
         BNL   RDSP13D             NO                                           
         L     RF,0(R3)            YES - SUB 1 FROM DIFF                        
         BCTR  RF,R0                                                            
         ST    RF,0(R3)                                                         
         B     RDSP13D                                                          
*                                                                               
*                                                                               
RDSP20   DS    0H                                                               
****                                                                            
         CP    COUNT,=P'16'                                                     
         BE    RDSP25                                                           
         AP    COUNT,=P'1'                                                      
*                                                                               
RDSP23   LA    R4,4(R4)                                                         
         LA    R3,4(R3)                                                         
RDSP24   B     RDSP13A             NEXT AMOUNT                                  
RDSP25   B     RDSP9               NEXT SHARE                                   
****                                                                            
*                                                                               
RDSP30   DS    0H                                                               
         MVC   GROSS(48),RDSUMS      GROSS, PAID +TAX                           
         MVC   BGROSS(16),RDBLSUMS                                              
*                                                                               
*                                                                               
RDSPLITX DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
RDNXTEL  DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    RDNXTEL2                                                         
         CLI   0(R2),X'71'                                                      
         BER   RE                                                               
         B     RDNXTEL+2                                                        
RDNXTEL2 LTR   R2,R2                                                            
         BR    RE                                                               
         SPACE 3                                                                
RDDIV    DS    0H                                                               
         SLDA  R0,1                                                             
         D     R0,=F'10000'                                                     
         LTR   R1,R1                                                            
         BNP   *+8                                                              
         A     R1,=F'1'                                                         
         SRA   R1,1                                                             
         BR    RE                                                               
*                                                                               
         DS    0F                                                               
****                                                                            
RDDIFS   DS    CL64                                                             
RDSUMS   DS    CL48                                                             
RDBLSUMS DS    CL16                                                             
****                                                                            
RDCLTDIV DS    CL6                                                              
COUNT    DC    PL2'0'                                                           
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'RDBILL- READ BILL FROM DATA IN BILL ELEMENT'                    
*                                                                               
*        FIRST PARAMETER IS A(PBUYREC)                                          
*        SECOND PARAMETER IS A(PBILELEM)                                        
*                                                                               
*        IF BILL IS NOT ON FILE PBILLREC IS CLEARED                             
*                                                                               
RDBILL   NMOD1 0,RDBILL                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         MVI   RCTRACE,C'N'        SUPPRESS TRACE                               
         MVI   FCRDCLOS,C'Y'        SO I WILL READ CLOSED-OUT BILLS             
*                              NEEDED SINCE UNBILLING NOW CLOSES-OUT            
*                              BILLS INSTEAD OF DELETING THEM                   
*                                                                               
         LM    R2,R3,0(R1)      R2 ADDRESS OF BUY                               
*                               R3 ADDRESS OF BILL ELEMENT                      
*                                                                               
         MVC   RDBSKEY,KEY      SAVE CALLING KEY                                
         MVC   RDBSAREC,AREC    SAVE CALLING AREC                               
         XC    KEY,KEY                                                          
         MVC   KEY(10),0(R2)     AGY/MED/REC CODE/CLT/PRD                       
         CLI   KEY+3,X'88'    DUMMY BUY FOR PREVIOUS MANUAL?                    
         BNE   RDBILL3                                                          
         L     RF,ADCLT                                                         
         MVC   KEY(3),0(RF)      NEEDED FOR AGENCY AND MEDIA                    
*                                                                               
RDBILL3  MVC   KEY+10(2),PBUYKEST-PBUYREC(R2)                                   
         MVC   KEY+12(2),PBDBDATE-PBUYREC(R2)                                   
         MVC   KEY+14(2),PBLDATE-PBILELEM(R3)     BILL DATE                     
         MVC   KEY+16(2),PBINVNO-PBILELEM(R3)     INVOICE NUMBER                
         MVI   KEY+3,X'08'                                                      
         GOTO1 HIGH                                                             
         CLC   KEY(18),KEYSAVE                                                  
         BE    RDBILL5                                                          
*                                                                               
         L     RF,ADBILL        BILL NOT ON FILE - CLEAR PBILLREC               
         XC    0(150,RF),0(RF)                                                  
         B     RDBILL8                                                          
*                                                                               
RDBILL5  GOTO1 GETBILL                                                          
*                                                                               
RDBILL8  MVC   KEY,RDBSKEY   RESTORE SEQ READ                                   
         GOTO1 HIGH                                                             
         MVC   AREC,RDBSAREC                                                    
         MVI   FCRDCLOS,C'N'        RESET TO N                                  
         MVC   RCTRACE,SAVTRACE                                                 
         XMOD1 1                                                                
         LTORG                                                                  
*                                                                               
RDBSKEY  DS    CL32         SAVED KEY                                           
RDBSAREC DS    F                                                                
         SPACE 2                                                                
         DROP  R2,R3                                                            
         TITLE 'RMBILL - READ OLD MANUAL BILLS'                                 
* CHANGE LOG                                                                    
*                                                                               
*  BPLA   10/00    INCREASE VALUES IN CKMAX TO                                  
*                  REFLECT CHANGE TO PL6   $999,999,999.99                      
*                                                                               
*  BPLA   08/00    COPY OF PPREPB12B AT LEVEL 17 7/24/00                        
*                  COPY MADE 8/16/00                                            
*                  CHANGES TO CATALP AND PPREPB1WKN                             
*                  (WHICH INCLUDES PNNEWFILE IN PLACE OF                        
*                  PPNEWFILE)                                                   
*                  PNNEWFILE INCLUDES PNBILREC IN PLACE                         
*                  OF PBILLREC                                                  
*            ALSO  OTHER CHANGES  - LOOK FOR **BIG                              
*                                                                               
*  BPLA    7/00  WHEN PRINTING REGISTER - CHECK AGYXTBL                         
*                TO SEE IF I SHOULD DISPLAY COST2 OR OPEN                       
*                                                                               
*  BPLA    4/00  DIE IF AMOUNT EXCEEDS CAPACITY OF PL5                          
*                BILL REC FIELDS                                                
*                                                                               
*  BPLA    6/99  CHANGES FOR COST2                                              
*                                                                               
*  BPLA    6/99  COPY OF PPB12B AT LEVEL 6 MADE 6/15/99                         
*                                                                               
*  BPLA   10/98  RENAMED FROM PPB12BE                                           
*                                                                               
*  BPLA   1/98 PPB12B AT LEVEL 14 COPIED 1/12/98                                
*              CHANGES FOR EDI BILLING - SEE **EDI**                            
*                                                                               
*  BPLA  12/97 ADD DUMMY CSECT AT END (TO GET BOOK= MESSAGE)                    
*                                                                               
*  BPLA 12/97 DO NOT ATTEMPT TO READ FOR PRIOR MANUAL                           
*             BILLS IF REQUEST ID FOR ONE PUB                                   
*             SINCE THE CREDITS FOR THE PREVIOUS MANUAL                         
*             BILL WILL BE ON A SEPERATE INVOICE                                
*             THERE IS THE POTENTIAL WNBILL TO                                  
*             SKIP A PEPTAB ENTRY (SINCE PEPTSTAT IS X'40')                     
*             IF THE PEPTAB KEY IS THE SAME.                                    
*             THIS FINALLY HAPPENED ON 12/17/97 FOR MKTOA                       
*                                                                               
*                                                                               
*  BPLA 5/97  FIX CHECK FOR FINANCIAL BILLS IN REGISTER                         
*             SOME MAY HAVE SALES TAX IN WHICH CASE                             
*             THE ELEMENT LENGTH WILL BE 32 (X'20) NOT 30 (X'1E')               
*                                                                               
*  BPLA 9/96     PPB12BO SOURCE MADE LIVE - NOW INCLUDES PPREPB1WRK             
*                NEEDS PPB1ACC                                                  
*                                                                               
*  BPLA 4/96     CHANGES FOR ZENITH - MOLSON                                    
*                                                                               
*  BPLA 7/95     SAVE SVINVMO IN PBILLREC AT PBILIMO                            
*                THIS FIELD WAS PBILESTS (START EST FOR EST RANGE-ONLY          
*                USED BY "OLD" BILLING)                                         
*                                                                               
* BPLA 3/95       INCORPORATE INVREG CHANGES FROM PPB12BR                       
*                 (LEVEL 10 - 2/21/95)                                          
*                 FIXES PROBLEM OF AMOUNTS OVER 21 MILLION                      
*                 BY SWITCHING TO PL8 ACCUMULATORS                              
*                                                                               
* BPLA 7/14/94    FIX BUG IN WNBILL - AT WN64C                                  
*                 NEW PEPTAB KEY CHANGE                                         
*                                                                               
* BPLA 6/94       STORE FINANSW IN PEPTAB (PEPTFIN)                             
*                 AND CHECK IT WHEN WRITING THE BILLS                           
*                                                                               
* BPLA 5/94       CHECK FOR PBILOTH ELEM BEFORE CHECKING                        
*                 PBILLIND (FINANCIAL IND)                                      
*                                                                               
* BPLA 1/94       CHANGES FOR PST                                               
*                                                                               
* BPLA 10/5/93    CHANGES FOR NEW CDSEP OPTION -'R' - SPECIAL                   
*                 CD HANDLING WITH 'APPLY' MESSAGES                             
*                                                                               
* BPLA 1/11/93    CHANGE TO ALLOW CD SEP BILL WITH UFC COMMISSION               
*                 BILL                                                          
* BPLA 10/13/92   USE PPBVAL IN INVREG (INVOICE REGISTER)                       
*                                                                               
* BPLA 6/16/92  NET INDICATOR IN PBILCMSW  NO COMMISSION ONLY                   
*            INDICATOR FOR UPFRONT COMMISSION BILL, AOR BIT                     
*            ON NET BILL (IF AOR EVEN THOUGH NO AOR BILL IS PRODUCED)           
*            SPECIAL TREATMENT OF UFC BILLS IN REGISTER.                        
*                                                                               
* BPLA 4/29/92  CHANGES FOR COMMISSION BILLING                                  
*                                                                               
* BPLA 4/20/92  COPY OF PPB12BL                                                 
*                                                                               
* BPLA 4/15/92  CHANGE CHECK OF PCTCTL IN RMBILL FROM "N" TO "F"                
*               SO THAT I ONLY READ OLD MANUAL BILLS WITH A                     
*               MANPCT IF I'M NOT APPLING THE PERCENTAGE TO                     
*               PREVIOUS BILLING                                                
* BPLA 4/1/92   READ OLD MANUAL BILLS - EVEN IF MANPCT IS NOT ZERO              
*               BUT SKIP IF PCTCTL IS "N"                                       
* BPLA 1/15/92  CLEAR END OF RECORD IN INVREG                                   
*                                                                               
* BPLA 11/27/91 DON'T READ MANUAL BILLS IF DOING A PERCENTAGE                   
*               BILL - IT WON'T GET CERDITED PROPERLY AND CAUSES                
*               AN IMBALANCE.                                                   
* BPLA 10/1/91 SET AOR INDICATOR IN SEPERATE COMM. AND CD BILLS                 
*                                                                               
* BPLA 7/10/91 IN WBILL (WB6)  CHECK FOR AOR ACCOUNT INSTEAD OF                 
*              AOR AMOUNT WHEN SETTING ON X'10' IN PBILCMSW                     
* BPLA 6/20/91 IN WBILL (WB6C) CONDITIONALLY SET ON X'04'                       
*              IN PBILCMSW (SUBTRACT TAX FROM AOR BASIS)                        
* BPLA         BUG FIXED IN WNBILL (WN64C)  WAS ST  R0,X+20 SHOULD              
*              HAVE BEEN 20(R2)                                                 
* BPLA 6/14/91 STORE TAX IN PBILLTAX (IN PBILOTH ELEMENT)                       
*                                                                               
* BPLA 5/16/91 AOR KILL DATE AND VAT CODE                                       
*                                                                               
* BPLA 3/26/91 DRAFT REBATE BILLING (RD)                                        
*                                                                               
* BPLA 3/12/91 GRANT'S AOR FEATURES                                             
*                                                                               
* BPLA 2/1/91    IN INVREG ADD GST TO X+8 (BILL AMOUNT)                         
*                                                                               
         PRINT NOGEN                                                            
RMBILL   NMOD1 0,RMBILL                                                         
         USING PPWORKD,RA                                                       
         USING PPWORK2D,R9                                                      
         USING BILWRKD,RC                                                       
         LA    RC,SPACEND                                                       
***E***                                                                         
         CLC   QPROG,=C'E1'       NO READING FOR ESTIMATES                      
         BE    RMBX                                                             
*                                                                               
         CLI   QPUB,C' '          SEE IF FOR ONE PUB                            
         BH    RMBX               DON'T READ FOR PRIOR MANUAL BILLS             
*                                 IT CAN CAUSE PROBLEMS                         
***E***                                                                         
***R***                                                                         
         CLC   QPROG,=C'R1'       NO MANUAL BILLS FOR REBATES                   
         BE    RMBX                                                             
         CLC   QPROG,=C'RD'       NO MANUAL BILLS FOR REBATES DRAFT             
         BE    RMBX                                                             
***R***                                                                         
         OC   MANGRS(12),MANGRS   SEE IF MANUAL BILL                            
         BNZ   RMBX              YES - SKIP READ OF OLD MANUAL BILLS            
         CLI   QMANUAL,C'G'       DOUBLE CHECK FOR MANUAL BILL                  
         BE    RMBX                                                             
         CLI   QMANUAL,C'F'                                                     
         BE    RMBX                                                             
*                                                                               
         OC    MANPCT,MANPCT      SEE IF PERCENTAGE BILL                        
         BZ    RMB2                                                             
         CLI   PCTCTL,C'F' SEE IF NOT APPLING PCT TO PREVIOUS BILLING           
         BNE   RMBX       OTHERWISE SKIP READ OF OLD MANUAL BILLS               
*                                                                               
RMB2     CLI   FINANSW,0         SEE IF FINANCIAL CLIENT                        
         BNE   RMBX              YES - THEN CAN NOT HAVE MANUAL BILLS           
*                                                                               
*              PASS AS DUMMY BUYS TO APRBUY                                     
*                                                                               
         NI    DMINBTS,X'F7'       SET FOR NO DELETES                           
*                                                                               
         XC    KEY,KEY                                                          
         L     RF,ADPRD                                                         
         MVC   KEY(10),0(RF)                                                    
         MVI   KEY+3,X'02'                                                      
         L     RE,ADCLT                                                         
         CLC   KEY(7),0(RE)       SEE IF PRD FOR MY CLIENT                      
         BNE   RMBX               NO - SKIP READ OF MANUALS                     
*                                 SINCE I MAY GET HERE FROM                     
*                                 PRDLAST EVEN WITH NO BUYS READ                
         MVI   KEY+3,X'88'                                                      
         GOTO1 HIGH                                                             
         B     RMB5                                                             
RMB3     GOTO1 SEQ                                                              
RMB5     CLC   KEY(10),KEYSAVE                                                  
         BNE   RMBX                                                             
         CLI   QEST,C' '                                                        
         BE    RMB5F                                                            
         CLC   QEST,=C'ALL'                                                     
         BE    RMB5F                                                            
         CLC   KEY+10(2),BQEST                                                  
         BL    RMB3                                                             
         BE    RMB5W                                                            
         CLC   QESTEND,SPACES                                                   
         BE    RMB3                                                             
         CLC   KEY+10(2),BQESTEND        RANGE OF ESTS                          
         BH    RMBX                                                             
         B     RMB5W                                                            
*                                                                               
RMB5F    CLC   QESTEND,SPACES            SEE IF FILTER SPECIFIED                
         BE    RMB5W                     NO                                     
         L     R7,ADEST                                                         
         USING PESTREC,R7                                                       
         MVC   SVRMKEY,KEY                                                      
         XC    KEY+12(12),KEY+12                                                
         MVI   KEY+3,X'07'                                                      
         CLC   KEY(12),PESTKEY                                                  
         BE    RMB5H                                                            
         GOTO1 READ                                                             
         GOTO1 GETEST                                                           
RMB5H    MVC   KEY(64),SVRMKEY    RESTORE KEY AND KEYSAVE                       
         GOTO1 HIGH                                                             
*                                                                               
         LA    RE,QESTEND                                                       
         LA    RF,PESTGRPS                                                      
         LA    R0,3                                                             
*                                                                               
RMB5H5   DS    0H                                                               
         CLI   0(RE),C'*'                                                       
         BE    RMB5H8                                                           
         CLI   0(RE),C' '                                                       
         BE    RMB5H8                                                           
         TM    0(RE),X'40'        TEST NEGATIVE FILTER                          
         BZ    RMB5H7                                                           
         CLC   0(1,RE),0(RF)                                                    
         BNE   RMB3               SKIP THIS BILL                                
         B     RMB5H8                                                           
*                                                                               
RMB5H7   MVC   DUB(1),0(RE)        NEGATIVE FILTER                              
         OI    DUB,X'40'                                                        
         CLC   DUB(1),0(RF)                                                     
         BE    RMB3                SKIP THIS BILL                               
*                                                                               
RMB5H8   LA    RE,1(RE)                                                         
         LA    RF,1(RF)                                                         
         BCT   R0,RMB5H5           GO DO NEXT FILTER                            
*                                                                               
         DROP  R7                                                               
*                                                                               
RMB5W    GOTO1 GETBILL                                                          
         L     R7,ADBILL                                                        
         USING PBILLREC,R7                                                      
*                                                                               
*        PREVIOUS MANUAL AOR BILLS SHOULD BE IGNORED                            
*                                                                               
         TM    PBILCMSW,BSTTAORQ   MANUAL AOR?                                  
         BNZ   RMB3                SKIP                                         
*                                                                               
         CLI   SCBNCSW,C'C'        SEE IF COMMISSION BILLING                    
         BNE   RMB5W4                                                           
         TM    PBILCMSW,BSTSCOMQ                                                
         BNO   RMB3                ONLY READ MANUAL COMMISSION BILLS            
*                                                                               
RMB5W4   OC    MANRVNO,MANRVNO     SEE IF DOING MANUAL REVERSAL                 
         BNZ   RMB5X5              YES - MUST MATCH                             
RMB5X    CLC   PBILMCAN,=12C'0'    SEE IF THIS BILL WAS 'REBILLED'              
         BE    RMB6                NO - OK TO PROCESS                           
         B     RMB3                YES - SKIP                                   
*                                                                               
RMB5X5   LH    R0,MANRVNO                                                       
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  WORK(4),DUB                                                      
         CLC   PBILMCAN+2(4),WORK  CHK RIGHT INV NO                             
         BNE   RMB3                                                             
         GOTO1 DATCON,DMCB,(3,MANRVDTP),(0,WORK)                                
         CLC   PBILMCAN(2),WORK+2  MONTH                                        
         BNE   RMB3                                                             
         CLC   PBILMDAT,WORK       CHK RIGHT DATE                               
         BNE   RMB3                                                             
*              ATTEMPT TO REVERSE A 'REBILLED' OLD MANUAL BILL                  
*                                  NOT ABLE TO HANDLE                           
*                                  AS I WOULD NOT BE ABLE TO UNBILL             
*                                  AND A8 WOULD BE OUT OF BALANCE               
         GOTO1 BUFFALO,DMCB,=C'RESET',ABUFFC                                    
*                                                                               
         OI    DMINBTS,X'08'       RESET TO PASS DELETES                        
         MVI   ERR,11              SET ERRCODE                                  
         BRAS  RE,ERRPROC                                                       
*              CAN'T DO SINCE MANUAL MUST STILL BE MARKED "REVERSED"            
*              BY ORIGINAL BILL SO I CAN'T RESET PBILMCAN TO ZEROS              
*              OR TO THE REVERSALS DATE AND INVOICE NUMBER                      
*              FOR NOW THEY MUST STILL UNBILL                                   
*                                                                               
RMB6     DS    0H                                                               
         XC    SVMANFLT,SVMANFLT                                                
         XC    SVMANPO#,SVMANPO#   PO# SEQUENCE                                 
         CLI   WBSW,C'Y'           WB FLIGHT FEATURE?                           
         BNE   RMB7P                                                            
         MVC   SVMANFLT,PBILADID+1                                              
         CLI   QADID,C'.'          REQUEST FOR ONE WB FLIGHT?                   
         BNE   RMB7                                                             
         CLC   PBILADID+1(10),QADID+1   FLIGHTS MUST MATCH                      
         BNE   RMB3                ELSE SKIP                                    
         B     RMB7                                                             
*                                                                               
RMB7P    DS    0H                                                               
         CLI   PO#OPT,C'Y'         SEE IF BILLING BY PO#                        
         BNE   RMB7Q                                                            
         CLC   PBILLJOB(3),=X'FFD7D6' SEE IF A PO#                              
         BNE   RMB3                IF NOT SKIP                                  
         MVC   SVMANPO#,PBILLJOB+3                                              
         CLC   QPO#SEQ,SPACES     REQUEST FOR ONE PO#?                          
         BE    RMB7                                                             
         CLC   PBILLJOB+3(2),QPO#SEQ  SEQUENCE # MUST MATCH                     
         BNE   RMB3               ELSE SKIP                                     
         B     RMB7                                                             
*                                                                               
RMB7Q    CLC   PBILLJOB(3),=X'FFD7D6' SEE IF A PO#                              
         BE    RMB3                IF SO SKIP - THIS SHOULD NOT HAPPEN?         
*                                  NO - SET UP DUMMY BUY AND POST IT            
RMB7     L     RF,ADWKREC                                                       
         XC    0(250,RF),0(RF)                                                  
         USING PBUYREC,RF                                                       
         MVC   PBUYKAGY,PBILKAGY                                                
         MVC   PBUYKMED,PBILKMED                                                
         MVC   PBUYKCLT,PBILKCLT                                                
         MVI   PBUYKRCD,X'88'      SET SPECIAL RECORD CODE                      
         MVC   PBUYKPRD,PBILKPRD                                                
         MVC   PBUYKEST,PBILKEST                                                
         MVC   PBUYKPUB(6),XXPUB                                                
         MVC   PBDELEM(2),=X'2074'                                              
         MVC   PBDBDATE(2),PBILKMOS                                             
         MVI   PBDBDATE+2,X'01'                                                 
*                                                                               
*                                   SAVE INVOICE NUMBER AND MONTH               
*                                   IN PBDRLIND(4)- SO I CAN DISPLAY            
*                                   THEM IN LDESC (IN PPB12C)                   
*                                   IN PRBUY THESE FIELDS ARE PUT               
*                                   AFTER X'FC' IN ADESC                        
*                                                                               
         MVC   PBDRLIND(2),PBILKBNO   INVOICE NUMBER                            
         MVC   PBDRLIND+2(2),PBILKBMN     BILLING YEAR/MONTH                    
*                                                                               
*              USED WITH PBDBDATE IN PRBUY TO INSURE                            
*              UNIQUE DECSRIPTIONS                                              
*                                                                               
         ZAP   DUB,PBILLGRS                                                     
         CVB   R0,DUB                                                           
         ST    R0,BGROSS                                                        
         ZAP   DUB,PBILLBIL        GR-CD                                        
         CVB   R1,DUB                                                           
         SR    R0,R1                                                            
         ST    R0,BCSHDSC                                                       
         ZAP   DUB,PBILLNET                                                     
         CVB   R1,DUB        GR-AC-CD                                           
         AR    R1,R0          RE-ADD CD - R1 NOW GR-AC                          
         ZAP   DUB,PBILLGRS                                                     
         CVB   R0,DUB                                                           
         SR    R0,R1                                                            
         ST    R0,BAGYCOM                                                       
         XC    GROSS(12),GROSS     NO ORDERED                                   
         XC    PGROSS(12),PGROSS     NO ORDERED                                 
*                                                                               
*              SET UP DUMMY BILLELEM                                            
*                                                                               
         MVC   PBDELEM+116(2),=X'2617'                                          
         MVC   PBDELEM+116+2(3),PBILKPRD                                        
         GOTO1 DATCON,DMCB,PBILLDAT,(3,WORK)                                    
         L     RF,ADWKREC                                                       
         MVC   PBDELEM+116+5(3),WORK                                            
         MVC   PBDELEM+116+8(2),PBILKBNO                                        
         MVC   PBDELEM+116+11(12),BGROSS                                        
         CLI   PO#OPT,C'Y'          BILLING BY PO#?                             
         BNE   RMB8                                                             
         OC    SVMANPO#,SVMANPO#                                                
         BZ    RMB8                                                             
         MVI   PBDELEM+117,X'1B'    ADJUST BILL ELEMENT LENGTH                  
         MVC   PBDELEM+116+25(2),SVMANPO#  SET PO#SEQ IN BILL ELEM              
*                                                                               
RMB8     OC    MANRVNO,MANRVNO      SEE IF DOING MANUAL REVERSAL                
         BZ    RMB9                                                             
*                                   YES - MUST SET DATE AND INV NO              
*                                   SO PRBUY WILL PROCESS                       
*                                   ALSO COMPLEMENT BGROSS(12)                  
*                                                                               
*                                                                               
         MVC   PBDELEM+116+5(3),MANRVDTP                                        
         MVC   PBDELEM+116+8(2),MANRVNO                                         
         L     R0,BGROSS                                                        
         LCR   R0,R0                                                            
         ST    R0,BGROSS                                                        
         L     R0,BGROSS+4                                                      
         LCR   R0,R0                                                            
         ST    R0,BGROSS+4                                                      
         L     R0,BGROSS+8                                                      
         LCR   R0,R0                                                            
         ST    R0,BGROSS+8                                                      
         MVC   PBDELEM+116+11(12),BGROSS                                        
*                                                                               
*                                                                               
RMB9     MVC   SAVR1,ADBUY         SAVE REAL ADDR OF PBUYREC                    
         MVC   ADBUY,ADWKREC      FOOL PRBUY                                    
         MVI   PUBSW,0    SO PRBUY WILL ALWAYS PROCESS THESE                    
*                                  'DUMMY' INSERTIONS                           
         BRAS  RE,PRBUY            PROCESS MANUAL AS DUMMY BUYS                 
         MVC   ADBUY,SAVR1         RESTORE REAL ADDR OF PBUYREC                 
         B     RMB3                GO DO NEXT MANUAL BILL                       
*                                                                               
RMBX     OI    DMINBTS,X'08'     RESET TO PASS DELETES                          
         XIT1                                                                   
         SPACE 3                                                                
*                                                                               
SVRMKEY  DS    CL64                                                             
*                                                                               
         LTORG                                                                  
         TITLE 'WNBILL - WRITE NEW BILL RECORDS'                                
WNBILL   NMOD1 0,WNBILL                                                         
         USING PPWORKD,RA                                                       
         USING PPWORK2D,R9                                                      
         USING BILWRKD,RC                                                       
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         MVC   SAVR1,DMCB+3        SAVE CALLING CODE                            
*                                                                               
         CLI   PASSNO,1            ONLY FOR PASS 1                              
         BNE   WNEXT                                                            
         CLI   SORTTRCE,C'Y'                                                    
         BNE   WN1                                                              
*                                                                               
         MVC   P1+1(6),=C'WNBILL'                                               
         GOTO1 =A(PRNT)                                                         
WN1      DS    0H                                                               
         CLI   UPASS,X'FE'      SKIP FOR RETAIL TEST PASS  - WAS C'T'           
         BE    WNEXT                                                            
*                                                                               
         CLI   SAVR1,1             JUST POSTING TO PEP TAB                      
         BE    WN50                                                             
*                                  MARKING MANUAL BILLS                         
*                                                                               
         L     R4,ASORTDTA                                                      
         OC    0(ROWTL,R4),0(R4)         NO $  (WAS ROW2L)                      
         BNZ   WN8                                                              
         CLI   ZEROSW,C'Y'                                                      
         BNE   WNEXT                                                            
*                                                                               
WN8      DS    0H                                                               
*                                       ADD TO PRD-EST-PER TAB                  
WN50     DS    0H                                                               
         L     R4,BRKCODE-BRKTABD(R3)   R3 POINTS TO BRK LEVEL                  
         L     R4,ATOTS(R4)      POINT TO ACCUM                                 
         LA    R5,PERLIST          DATE LIST                                    
*                                                                               
WN58     DS    0H                                                               
         CLI   0(R5),0             SKIP NON-EXISTENT MONTHS                     
         BE    WN69                                                             
         CLI   0(R5),X'FF'                                                      
         BE    WN69                                                             
         OC    0(ROWTL,R4),0(R4)        NO $  (WAS ROWL)                        
         BNZ   WN58A                                                            
         CLI   ZEROSW,C'Y'                                                      
         BNE   WN69                                                             
*                                                                               
WN58A    DS    0H                                                               
         LR    R3,R4                                                            
WN58B    DS    0H                                                               
         LR    RF,R3                                                            
         CLC   0(ROWHL,RF),ROWHL(RF)   NO $                                     
         BNE   WN58D                                                            
         CLC   ROWTL(ROWHL,RF),ROWTL+ROWHL(RF)    CHK OPEN $                    
         BNE   WN58D                                                            
         CLI   ZEROSW,C'Y'                                                      
         BNE   WN68                                                             
*                                                                               
WN58D    DS    0H                                                               
         LA    R2,W                                                             
         LA    R0,5                BCT   NOW 5 TO INCLUDE TAX                   
WN59     DS    0H                                                               
         L     R1,0(RF)                 ORD                                     
         S     R1,ROWHL(RF)        LESS BILLED                                  
         ST    R1,0(R2)                                                         
         LA    R2,4(R2)                                                         
         LA    RF,4(RF)                                                         
         BCT   R0,WN59                                                          
*                                                                               
         LA    R2,W+20             FOR OPEN AMOUNTS                             
         LA    R0,6                BCT (WAS 4) TO GET TO TRADE CREDIT           
*                                  LAST FIELD IS NOW TRADE CREDITS              
         LR    RF,R3               RESET TO START OF ACCUM                      
         LA    RF,ROWTL(RF)                                                     
WN62     DS    0H                                                               
         L     R1,0(RF)               ORD                                       
         S     R1,ROWHL(RF)        LESS BILLED                                  
         ST    R1,0(R2)                                                         
         LA    R2,4(R2)                                                         
         LA    RF,4(RF)                                                         
         BCT   R0,WN62                                                          
*                                                                               
*                                                                               
         L     R0,=A(PEPTWRK)      CLEAR PEPTAB WORK AREA                       
         LA    R1,PEPTABRL                                                      
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         L     RE,=A(PEPTWRK)                                                   
         USING PEPTD,RE                                                         
         OC    AMED,AMED                                                        
         BZ    WN64                                                             
         L     RF,AMED                                                          
         MVC   PEPTMED,0(RF)                                                    
WN64     L     RF,APRD                                                          
         MVC   PEPTPRD,0(RF)       PRD                                          
         L     RF,AEST                                                          
         MVC   PEPTEST,0(RF)       EST                                          
**JOB                                                                           
         MVI   PEPTFIN,0                                                        
         CLI   FINANSW,0           SEE IF DOING FINANCIAL CLIENT                
         BE    WN64A               NO                                           
         MVC   PEPTFIN,FINANSW     SET FINANCIAL IND INTO PEPTAB                
         B     WN64A5                                                           
*                                                                               
WN64A    CLI   PO#OPT,C'Y'         BILLING BY PO#                               
         BNE   WN64C               NOT FINANCIAL AND NOT PO# BILLING            
         OC    AJOB,AJOB                                                        
         BNZ   *+6                                                              
         DC    H'0'                MUST HAVE JOB (PO#)                          
         L     RF,AJOB                                                          
         MVC   PEPTJOB(3),0(RF)       FORMAT IS X'FF', C'PO', SEQ#              
         L     RF,ASORTCOM                                                      
         MVC   PEPTJOB+3(2),4(RF)   PO SEQ # SAVED THERE                        
*                                  NOTHING IN PEPTADID                          
         B     WN64C                                                            
*                                                                               
WN64A5   OC    AJOB,AJOB           SEE IF DOINGS JOBS                           
         BZ    WN64C                                                            
         L     RF,AJOB                                                          
**WB**                                                                          
         CLI   WBSW,C'Y'          WB FILGHT FEATURE?                            
         BNE   WN64B                                                            
         MVC   PEPTAID(10),JOBDSP(RF) FLIGHT ID                                 
         B     WN64C                                                            
WN64B    DS    0H                                                               
**WB**                                                                          
         MVC   PEPTJOB,JOBDSP(RF)  AD CODE                                      
         MVC   PEPTAID,ADIDDSP2(RF) AD ID  (ALWAYS USE ONE AFTER AD)            
*                                                                               
*        ABOVE CODE IS SPECIAL FOR FINANCIAL CLIENTS                            
*        SHOULD WORK SINCE FOR DOREMUS ALWAYS BILLS BY                          
*        JOB AND USES ONE JOB FOR EACH ESTIMATE                                 
*        THIS CODE ADDED TO PUT JOB IN PEPTAB SO THEY                           
*        CAN REBATE JOBS TOGETHER                                               
*        SHOULD STILL WORK FOR THEIR REGULAR BILLING ALSO                       
*                                                                               
WN64C    MVC   PEPTMOS,0(R5)        Y/M                                         
*                                                                               
         L     RF,ACTYP             CHECK FOR TRADE CREDIT                      
         CLC   0(2,RF),=C'TC'       ADDITIONAL CHARGE                           
         BNE   WN64C5                                                           
         MVC   PEPTTRDC,W+40        DO NET OPEN BILLABLE (TRADE CREDIT)         
*                                   (COST2 NET)                                 
         MVC   PEPTOGRS(16),W+20    OPEN GROSS AND NET AND CD AND AC            
         B     WN64CX                                                           
*                                                                               
WN64C5   MVC   PEPTGRS(16),W        GROSS AND NET AND CD AND AC                 
         MVC   PEPTTAX(4),W+16      TAX NOW IN PEPTAB  (CONTRACT)               
         MVC   PEPTOGRS(16),W+20    OPEN GROSS AND NET AND CD AND AC            
                                                                                
         DROP  RE                                                               
*                                                                               
WN64CX   DS    0H                                                               
         L     RF,=A(PEPTWRK)                                                   
         GOTO1 BINSRCH,PEPPARS,(1,(RF))                                         
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
         CLI   0(R1),1                                                          
         BE    WN68                                                             
*                                  ADD TOTALS IN                                
         L     RF,=A(PEPTWRK)                                                   
         MVC   X(64),0(RF)                                                      
*                                                                               
         L     R2,0(R1)                                                         
         L     R0,12(R2)                                                        
         A     R0,X+12             GROSS                                        
         ST    R0,12(R2)                                                        
         L     R0,16(R2)                                                        
         A     R0,X+16             NET                                          
         ST    R0,16(R2)                                                        
         L     R0,20(R2)                                                        
         A     R0,X+20             CD                                           
         ST    R0,20(R2)                                                        
         L     R0,24(R2)           AC                                           
         A     R0,X+24                                                          
         ST    R0,24(R2)                                                        
*                                                                               
         L     R0,36(R2)                                                        
         A     R0,X+36             OPEN GROSS                                   
         ST    R0,36(R2)                                                        
         L     R0,40(R2)                                                        
         A     R0,X+40             OPEN NET                                     
         ST    R0,40(R2)                                                        
         L     R0,44(R2)                                                        
         A     R0,X+44             CD (REALLY CONTRACT)                         
         ST    R0,44(R2)                                                        
         L     R0,48(R2)                                                        
         A     R0,X+48             AC                                           
         ST    R0,48(R2)                                                        
*                                                                               
         L     R0,60(R2)                                                        
         A     R0,X+60             TAX                                          
         ST    R0,60(R2)                                                        
*                                                                               
WN68     DS    0H                                                               
*                                                                               
WN69     DS    0H                                                               
         LA    R4,ROWL(R4)         NEXT MONTH                                   
         LA    R5,8(R5)                                                         
         LA    R0,PERLIST+8*MAXMOS                                              
         CR    R5,R0                                                            
         BL    WN58                                                             
*                                                                               
WNEXT    DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'WBILL - WRITE BILL RECS'                                        
         SPACE 2                                                                
WBILL    NMOD1 0,WBILL                                                          
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         CLI   UPASS,X'FE'         SKIP FOR TEST PASS - WAS C'T'                
         BE    WBILLX                                                           
***E***                                                                         
         CLC   QPROG,=C'E1'          WRITE NO BILLS FOR ESTIMATES               
         BE    WBILLX                                                           
***E***                                                                         
         CLI   SORTTRCE,C'B'      BILL TRACE ONLY                               
         BE    WB0                                                              
         CLI   SORTTRCE,C'Y'                                                    
         BNE   WB1                                                              
WB0      DS    0H                                                               
         MVC   P1+1(14),=C'WRITE OLD BILL'                                      
         GOTO1 =A(PRNT)                                                         
WB1      DS    0H                                                               
         L     R7,ADBILL                                                        
         USING PBILLREC,R7                                                      
*                                                                               
         XC    PBILLREC(255),PBILLREC                                           
**BIG                                                                           
         XC    PBILLREC+255(70),PBILLREC+255                                    
**BIG                                                                           
         L     RF,ADCLT                                                         
         MVC   PBILLREC(7),0(RF)   AGY,MED,CLT                                  
         MVI   PBILLREC+3,X'08'                                                 
         MVC   PBILKBMN,TODAYB     YEAR MONTH                                   
         MVC   PBILKBNO,INVNO                                                   
******** MVC   PBILLLEN,=H'103'                                                 
******** MVC   PBILLEL(2),=X'0846'    ELEM CODE +LENGTH                         
**BIG                                                                           
         MVC   PBILLLEN,=H'133'                                                 
         MVC   PBILLEL(2),=X'0864'    ELEM CODE +LENGTH                         
**BIG                                                                           
*                                                                               
WB1C     MVC   PBILLDAT,TODAY                                                   
*                                                                               
         CLI   QOPT1,C' '          SEE IF CD ITEMS FILTER ACTIVE                
         BNH   *+10                                                             
         MVC   PBCDITYP,QOPT1      SET IN BILLREC                               
         CLI   QOPT3,C' '          SEE IF CD PUBS FILTER ACTIVE                 
         BNH   *+10                                                             
         MVC   PBCDPTYP,QOPT3      SET IN BILLREC                               
*                                                                               
         CLI   PAYOPT,C'N'      BILLING CLEARED ITEMS ONLY?                     
         BE    *+8                                                              
         OI    PBILSTAT,X'01'   OTHER PAYOPTS ARE CLEARED ITEMS ONLY            
*                                                                               
         CLI   PROGPRO3+12,C'P'    BILLED ON PLANNED?                           
         BNE   *+8                                                              
         OI    PBILSTAT,X'04'                                                   
*                                                                               
         CLI   PROGPRO3+12,C'A'    BILLED ON ACTUALIZED?                        
         BNE   *+8                                                              
         OI    PBILSTAT,X'08'                                                   
*                                                                               
         CLI   PROGPRO3+12,C'B'    BILLED ON BOTH PLANNED + ACTUALIZED          
         BNE   *+8                                                              
         OI    PBILSTAT,X'02'                                                   
*                                                                               
         CLI   UPDTSOON,C'Y'       UPDATIVE SOON REQUEST?                       
         BNE   *+8                 WAS *+14 WHEN STORED FOR SOON ONLY           
         OI    PBILSTAT,PSTSOONQ                                                
*                                                                               
         MVC   PBILLUID,RCORIGID                                                
*                                                                               
         MVI   PBILSEP,C'R'        SET FOR REGULAR                              
         MVI   PBILLTYP,C'B'                                                    
*                                                                               
         OC    MANGRS(12),MANGRS                                                
         BZ    *+8                                                              
         MVI   PBILLTYP,C'M'        NEW MANUAL BILL                             
*                                                                               
WB1D     MVC   PBILLTYP+1(1),TYPE                                               
***R***                                                                         
         CLC   QPROG,=C'R1'          FINANCIAL REBATE BILL                      
         BNE   *+8                                                              
         MVI   PBILLTYP,C'R'                                                    
         CLC   QPROG,=C'RD'          FINANCIAL REBATE BILL DRAFT                
         BNE   *+8                                                              
         MVI   PBILLTYP,C'R'                                                    
***R***                                                                         
WB1E     MVC   PBILLCAN(12),=12C'0'                                             
*                                                                               
*                                                                               
         MVC   PBILINVD,BINVDTE                                                 
*                                                                               
         MVC   PBILIMO,SVINVMO   INV MONTH - AS DISPLAYED                       
*                              SVINVMO GET SET BY PPFMTINO IN GETNUM            
         MVC   PBILIMED,SVINVMED         MEDIA CHARACTERS                       
         MVC   PBILISEQ,AGMFMT           MED/MTH SEQ (1 OR 2)                   
*                                                                               
         MVC   PBILDUED,BDUEDTE                                                 
*                                                                               
*                             CREATE BILLS FROM PRD-EST-PER TABLE               
         L     R4,PEPPARS+4        A(TABLE)                                     
**NEW 10/18/89                                                                  
         USING PEPTD,R4                                                         
**NEW 10/18/89                                                                  
         L     R6,PEPTABN          FOR BCT                                      
         LTR   R6,R6                                                            
         BNZ   WB4                                                              
         CLI   UPASS,X'FF'         OK IF CORP SUMMARY BILL - WAS C'S'           
         BE    WBILLX                                                           
         DC    H'0'                                                             
*                                                                               
WB4      DS    0H                                                               
*                                                                               
**NEW 3/12/91                                                                   
         CLI   DUESW,C'R'          SEE IF AOR OR ADJ SEP OR CD SEP              
         BE    WB4C                                                             
         CLI   DUESW,C'A'                                                       
***NEW 5/16/91                                                                  
         BE    WB4A                                                             
***NEW 5/16/91                    WAS BE  WB4C                                  
         CLI   DUESW,C'C'                                                       
         BE    WB4C                                                             
         TM    PEPTSTAT,X'40'                                                   
         BNZ   WB8B5              SKIP TO NEXT PEPTAB ENTRY                     
         OI    PEPTSTAT,X'40'                                                   
***NEW 5/16/91                                                                  
         B     WB4C                                                             
*                                                                               
WB4A     TM    PEPTSTAT,X'20'      TEST ALREADY DONE                            
         BNZ   WB8B5               YES, SKIP                                    
         OI    PEPTSTAT,X'20'                                                   
         B     WB4C                                                             
***NEW 5/16/91                                                                  
**NEW 3/12/91                                                                   
*                                                                               
*                                  PRODUCT CODE                                 
WB4C     MVI   PBILLREC+3,X'08'    MUST RESET FOR MANUALS                       
         CLI   PEPTMED,0           SEE IF MEDIA IN PEPTAB                       
         BE    *+10                                                             
         MVC   PBILKMED,PEPTMED                                                 
         MVC   PBILKPRD,PEPTPRD                                                 
*                                                                               
         MVC   PBILKEST,PEPTEST    EST                                          
         MVC   PBILKMOS,PEPTMOS    MOS                                          
         CLI   PEPTFIN,0           SEE IF FINANCIAL CLIENT                      
         BE    WB4C5                                                            
******   MVC   PBILLLEN,=H'133'                                                 
**BIG                                                                           
         MVC   PBILLLEN,=H'163'      133+30                                     
**BIG                                                                           
         MVC   PBILOTH(2),=X'091E'    NEW ELEM CODE +LENGTH                     
         MVC   PBILLIND,PEPTFIN       SET PEPTFIN INTO PBILLREC                 
         CLI   PEPTFIN,X'03'          SEE IF $ TYPE COST2                       
         BNE   *+8                                                              
         MVI   PBILLIND,X'02'         SETS OFF FINANCIAL IND                    
*                                                                               
         CLI   MIDASSW,C'Y'        SEE IF MIDAS TRADE                           
         BNE   *+14                                                             
         MVC   PBILTRCD,PEPTTRDC   BOTH BINARY                                  
         OI    PBILSTAT,X'20'      GRP M TRADE MIDAS                            
*                                     IN THE BILL HEADER                        
         ZAP   PBILLOPG,=P'0'                                                   
         ZAP   PBILLOPN,=P'0'                                                   
         ZAP   PBILLCNR,=P'0'                                                   
*                                                                               
WB4C5    MVI   PBILCMSW,0                                                       
         MVI   PBILCDSW,C'R'    SET FOR REGULAR CD HANDLING                     
         CLI   CDSEP,C'N'                                                       
         BE    WB5                                                              
         MVI   PBILCDSW,C'S'    SEPERATE CD INV                                 
         CLI   CDSEP,C'Y'                                                       
         BE    WB5                                                              
         MVI   PBILCDSW,C'C'     FOR 'C' - SPECIAL CD HANDLING                  
         CLI   CDSEP,C'C'                                                       
         BE    WB5                                                              
*                                                                               
         CLI   CDSEP,C'R'        ALSO SPECIAL CD HANDLING                       
         BE    WB5                                                              
*                                                                               
         MVI   PBILCDSW,C'N'     MUST BE NO CD                                  
*                                                                               
WB5      MVI   PBRETAIL,0                                                       
         MVC   PBILBASA(5),PEPTBILF  BILL FORMULA                               
         MVC   PBILLCAN(12),=12C'0'                                             
         OC   MANGRS(12),MANGRS                                                 
         BNZ   WB6                 IF MANUAL LEAVE AS ZEROS                     
         XC    PNBPGR1,PNBPGR1                                                  
         XC    PNBMGR1,PNBMGR1                                                  
         XC    PNBMGR2,PNBMGR2                                                  
*                                                                               
WB6      TM    PEPTSTAT,X'80'      TEST COMM ONLY BILL (NOT ADJ INV)            
         BZ    *+8                                                              
         OI    PBILCMSW,BSTCMONQ   COMMISSION ONLY                              
*                                                                               
         CLI   DUESW,C'R'          SEE IF THIS IS AOR BILL                      
         BE    WB6A3                                                            
*                                                                               
*        PBILCMSW WASN'T BEING SET FOR SEPERATE COMM. AND CD BILLS              
*                                                                               
*        NOW CHECK FOR SPECIAL SEPARATE INVOICING CONTROLLED BY                 
*        PROGPRO2+13 (NON-N VALUES)                                             
*                                                                               
         CLI   PROGPRO2+13,0       NOT PRESENT                                  
         BE    WB6A1                                                            
         CLI   PROGPRO2+13,C'N'    OR N                                         
         BE    WB6A1                                                            
         L     RE,ACRDB                                                         
         CLI   0(RE),C'D'          AM I DOING THE SEPARATE INVOICE?             
         BNE   WB6A1                                                            
         CLI   PROFAOR+7,C'Y'      AM I SUPPRESSING ITS AOR BILL?               
         BE    WB6A3                                                            
                                                                                
WB6A1    OC    PEPTAORA,PEPTAORA  CHECK FOR AOR AMOUNT                          
         BZ    WB6A3                                                            
         OI    PBILCMSW,BSTCAORQ   MEANS AOR BILL WILL FOLLOW                   
*                                                                               
WB6A3    DS    0H                                                               
         CLI   SCBNCSW,C'N'       NET BILL IN SEP COMM SITUATION                
         BNE   *+8                                                              
         OI    PBILCMSW,BSTSNETQ                                                
*                                                                               
         CLI   SCBNCSW,C'C'       SEE IF COMMISSION BILL                        
         BNE   WB6A5                                                            
         CLI   DUESW,C'R'         AND NOT AOR INV                               
         BE    WB6B                                                             
         CLI   DUESW,C'C'         AND NOT CD INV                                
         BE    WB6B                                                             
         OI    PBILCMSW,BSTSCOMQ     SEP COMM                                   
         ZAP   PBILLGRS,=P'0'                                                   
         ZAP   PBILLBIL,=P'0'                                                   
         ZAP   PBILLNET,=P'0'                                                   
         L     R0,PEPTDUE           DUE                                         
         S     R0,PEPTNET           LESS NET                                    
         CVD   R0,DUB                                                           
*                                                                               
         BAS   RE,CKMAX                                                         
*                                                                               
         ZAP   PBILLRCV,DUB                                                     
***                                                                             
***      NOTE- PUTTING GROSS AND NET IN SCB TYPE COMMISSION BILLS               
***            TO PROVIDE A CROSS CHECK WITH INSERTIONS.                        
***            SOME PROGRAMS THAT TOTAL BILLS WILL HAVE TO BE                   
***            CHANGED TO AVOID INFLATED AMOUNTS                                
***                                                                             
         L     R0,PEPTGRS          GROSS                                        
         CVD   R0,DUB                                                           
*                                                                               
         BAS   RE,CKMAX                                                         
*                                                                               
         ZAP   PBILLGRS,DUB                                                     
         L     R1,PEPTCD           CD                                           
         SR    R0,R1                                                            
         CVD   R0,DUB                                                           
*                                                                               
         BAS   RE,CKMAX                                                         
*                                                                               
         ZAP   PBILLBIL,DUB        GROSS-CD                                     
         L     R0,PEPTNET           NET                                         
         SR    R0,R1                                                            
         CVD   R0,DUB                                                           
*                                                                               
         BAS   RE,CKMAX                                                         
*                                                                               
         ZAP   PBILLNET,DUB        NET-CD                                       
         B     WB7                                                              
*                                                                               
WB6A5    DS    0H                                                               
WB6AX    CLI   DUESW,C'A'          FOR ADJ INV ZERO BILL AMT AND NET            
         BNE   WB6B                                                             
***NEW 5/16/91                                                                  
                                                                                
         CLI   PEPTFIN,0          CHK FINANCIAL/COST2                           
         BE    WB6AX3                                                           
         OC    PEPTOADJ,PEPTOADJ  ANY COST2 ADJUSTMENT                          
         BNZ   WB6AX5                                                           
*                                                                               
WB6AX3   OC    PEPTADJ,PEPTADJ    SKIP IF NO ADJUSTMENT AMOUNT                  
         BZ    WB8B5         (AT LEAST ONE ENTRY SHOULD BE NON-ZERO)            
***NEW 5/16/91                                                                  
WB6AX5   ZAP   PBILLGRS,=P'0'                                                   
         ZAP   PBILLBIL,=P'0'                                                   
         ZAP   PBILLNET,=P'0'                                                   
         L     R0,PEPTADJ          ADJ                                          
         CVD   R0,DUB                                                           
*                                                                               
         BAS   RE,CKMAX                                                         
*                                                                               
         ZAP   PBILLRCV,DUB                                                     
         MVI   PBILSEP,C'A'                                                     
*                                                                               
WB6A8    CLI   PEPTFIN,0           CHK FINANCIAL PEPTAB ENTRY                   
         BE    WB7                                                              
         ZAP   PBILLCNR,DUB        SET CONTRACT RCV                             
         L     R0,PEPTOADJ         OPEN ADJ                                     
         CVD   R0,DUB                                                           
*                                                                               
         TM    PBILSTAT,X'20'      SEE IF GRP M MIDAS TRADE                     
         BNO   *+8                                                              
         A     R0,PEPTTRDC         INCLUDE TRADE CREDITS                        
*                                                                               
         BAS   RE,CKMAX                                                         
*                                                                               
         ZAP   PBILLRCV,DUB                                                     
         B     WB7                                                              
*                                                                               
WB6B     DS    0H                                                               
         CLI   DUESW,C'C'          FOR CD INV ZERO BILL AMT AND NET             
         BNE   WB6C                                                             
         ZAP   PBILLGRS,=P'0'                                                   
         ZAP   PBILLBIL,=P'0'                                                   
         ZAP   PBILLNET,=P'0'                                                   
         L     R0,PEPTCD           CD TO PBILLRCV                               
         LCR   R0,R0               FOR CD INV MUST COMPLIMENT CD                
         CVD   R0,DUB                                                           
         ZAP   PBILLRCV,DUB                                                     
         MVI   PBILSEP,C'C'                                                     
         CLI   PEPTFIN,0           CHK FINANCIAL PEPTAB ENTRY                   
         BE    WB7                                                              
         ZAP   PBILLCNR,DUB        MUST ALSO SET CONTRACT RCV                   
****                                                                            
****                          ** NOTE OPEN CD IS SAME AS CONTRACT**             
****                                                                            
         B     WB7                                                              
*                                                                               
WB6C     DS    0H                                                               
         CLI   DUESW,C'R'          FOR AOR INVOICE                              
         BNE   WB6C5                                                            
***NEW 5/16/91                                                                  
         CLI   PEPTAORA,C' '       SKIP IF NO AOR ACCOUNT                       
         BNH   WB8B5                                                            
***NEW 5/16/91                                                                  
         ZAP   PBILLGRS,=P'0'                                                   
         ZAP   PBILLBIL,=P'0'                                                   
         L     RF,PEPTDUE          DUE                                          
         S     RF,PEPTNET           MINUS NET                                   
         CVD   RF,DUB                                                           
*                                                                               
         BAS   RE,CKMAX                                                         
*                                                                               
         ZAP   PBILLACM,DUB        SAME AS PBILLNET                             
         L     R0,PEPTAOR          AOR AMOUNT                                   
         CVD   R0,DUB                                                           
*                                                                               
         BAS   RE,CKMAX                                                         
*                                                                               
         ZAP   PBILLRCV,DUB        PUT IN RECEIVABLE                            
         OI    PBILCMSW,BSTTAORQ   SET AOR BILL BIT                             
*                                                                               
         TM    PEPTAORB,X'80'       SEE IF AOR BASIS IS AC                      
         BO    WB6C1X                                                           
         CLI   AORTXOPT,C'Y'                                                    
         BE    WB6C1                                                            
WB6C1    OI    PBILCMSW,X'04'      SUBTRACT TAX FROM AOR BASIS                  
*                                                                               
WB6C1X   DS    0H                                                               
**NEW 3/12/91                                                                   
         CLI   AORLOPT,C'N'                                                     
         BE    WB7                                                              
         MVC   PBILKBNO,PEPTAORI     SET INVOIVE NUMBER FROM PEPTAB             
**NEW 3/12/91                                                                   
*                                                                               
WB6C2    B     WB7                                                              
*                                                                               
*                             NOTE : WHAT ABOUT FINANCIAL CLIENTS               
*                                                                               
WB6C5    CLI   UPASS,0             IS IT RETAIL                                 
         BH    WB6D                YES                                          
*                                  NO                                           
*               8(R4)=GROSS                                                     
*              12(R4)=NET                                                       
*              16(R4)=CD                                                        
*              20(R4)=AC                                                        
*              24(R4)=ADJ                                                       
*              28(R4)=DUE                                                       
*              32(R4)=GROSS        OPEN                                         
*              36(R4)=NET          OPEN                                         
*              40(R4)=CD           ALWAYS CONTRACT                              
*              44(R4)=AC                                                        
*              48(R4)=ADJ          OPEN                                         
*              52(R4)=DUE          OPEN                                         
*              56(R4)=TAX                                                       
*              60(R4)=AOR AMOUNT                                                
*              64(R4)=AOR BASE AMOUNT                                           
*              68(R4)=RET SHR ACTUAL                                            
*              72(R4)=RET SHR GROSS                                             
*              76(R4)=RET SHR NET                                               
*              80(R4)=RET SHR CD                                                
*              84(R4)=RET SHR AC                                                
*              88(R4)=RET SHR AC                                                
*              92(R4)=RET SHR VAT                                               
*                                                                               
*              96(R4)=VAT MAIN BILL                                             
*             100(R4)=VAT ADJ SEP BILL                                          
*             104(R4)=VAT CD SEP BILL                                           
*             108(R4)=VAT AOR BILL                                              
*                                                                               
*             112(R4)=PRD ACCT                                                  
*             116(R4)=STATUS    X'80'=COMM ONLY                                 
*              2 SPARE                                                          
*             119(R4)=BILLING FORMULA (5)                                       
*             124(R4)=JOB CODE(6) (FOR FINANCIAL)                               
*              3 SPARE                                                          
*              133(R4)=AOR RCVBL/PAYABLE ACCNT (14)                             
*              147(R4)=AOR PCT (4)                                              
*              151(R4)=AOR BASIS (1)                                            
*              152(R4)=AOR RECORD DISK ADDR (4)                                 
*              156(R4)=AOR INVOICE NUMBER (2)                                   
*              158(R4)=VAT CODE                                                 
*              159(R4)=VAT SW                                                   
*                                                                               
*        ALSO SEE PEPTD DSECT IN PPREPB1WKR                                     
*                                                                               
         L     R0,PEPTGRS          GROSS                                        
         CVD   R0,DUB                                                           
*                                                                               
         BAS   RE,CKMAX                                                         
*                                                                               
         ZAP   PBILLGRS,DUB                                                     
         L     R1,PEPTCD           CD                                           
         SR    R0,R1                                                            
         CVD   R0,DUB                                                           
         ZAP   PBILLBIL,DUB        GROSS-CD                                     
         L     R0,PEPTNET           NET                                         
         SR    R0,R1                                                            
         CVD   R0,DUB                                                           
*                                                                               
         BAS   RE,CKMAX                                                         
*                                                                               
         ZAP   PBILLNET,DUB        NET-CD                                       
         L     R0,PEPTDUE          ACTUAL                                       
         CLI   ADJSEP,C'Y'         IF THIS IS NORMAL BILL                       
         BNE   *+8                 BUT ADJ IS SEP                               
         S     R0,PEPTADJ          THEN SUBTRACT ADJ FROM THIS BILL             
         CVD   R0,DUB                                                           
*                                                                               
         BAS   RE,CKMAX                                                         
*                                                                               
         ZAP   PBILLRCV,DUB                                                     
         CLI   PEPTFIN,0         SEE IF DOING FINANCIAL PEPTAB ENTRY            
         BE    WB7                                                              
*                                                                               
         ZAP   PBILLCNR,PBILLRCV   SET CONTRACT RCV IN NEW ELEM                 
         L     R0,PEPTOGRS          OPEN GROSS                                  
         CVD   R0,DUB                                                           
         ZAP   PBILLOPG,DUB                                                     
         L     R0,PEPTONET          OPEN NET                                    
         CVD   R0,DUB                                                           
         ZAP   PBILLOPN,DUB                                                     
         L     R0,PEPTODUE         ACTUAL  - OPEN                               
         CLI   ADJSEP,C'Y'         IF THIS IS NORMAL BILL                       
         BNE   *+8                 BUT ADJ IS SEP                               
         S     R0,PEPTOADJ    THEN SUBTRACT OPEN ADJ FROM THIS BILL             
*                                                                               
         TM    PBILSTAT,X'20'      SEE IF GRP M MIDAS TRADE                     
         BNO   *+8                                                              
         A     R0,PEPTTRDC         INCLUDE TRADE CREDITS                        
*                                                                               
         CVD   R0,DUB                                                           
*                                                                               
         BAS   RE,CKMAX                                                         
*                                                                               
         ZAP   PBILLRCV,DUB         NOW OPEN RCV                                
         B     WB7                                                              
*                                  RETAIL                                       
WB6D     DS    0H                                                               
**NEW 10/31/89                     IF RETAIL SET PBRACCT TO SPACES              
         MVC   PBRACCT(12),SPACES                                               
**NEW 10/31/89                                                                  
         MVC   PBRETAIL,UPASS      1 = CORP 'OUTLET',2+ = DISTRIB               
         CLI   CORPZ,C'Y'          IF CORP NOT AN INVOICE                       
         BNE   *+8                                                              
         OI    PBRETAIL,X'80'      CORPORATE CONTROL                            
*                                                                               
         CLI   UPASS,2                                                          
         BL    *+8                                                              
         MVI   PBRETAIL,2          ALL DISTRIBS = 2                             
         CLI   UPASS,X'FF'         SUMMARY PASS  - WAS C'S'                     
         BNE   *+8                                                              
         MVI   PBRETAIL,X'41'      SUMMARY                                      
*                                                                               
         L     R0,PEPTRETG         GROSS  - RETAIL                              
         CVD   R0,DUB                                                           
*                                                                               
         BAS   RE,CKMAX                                                         
*                                                                               
         ZAP   PBILLGRS,DUB                                                     
         L     R1,PEPTRETC         CD   - RETAIL                                
         SR    R0,R1                                                            
         CVD   R0,DUB                                                           
         ZAP   PBILLBIL,DUB        GROSS-CD                                     
         L     R0,PEPTRETN         NET                                          
         SR    R0,R1               NET-CD                                       
         CVD   R0,DUB                                                           
*                                                                               
         BAS   RE,CKMAX                                                         
*                                                                               
         ZAP   PBILLNET,DUB        NET - CD                                     
         L     R0,PEPTRETA         ACTUAL - RETAIL                              
         CVD   R0,DUB                                                           
*                                                                               
         BAS   RE,CKMAX                                                         
*                                                                               
         ZAP   PBILLRCV,DUB                                                     
*                                                                               
*                                                                               
         L     R5,=A(GDAREA)                                                    
         USING GDSECT,R5                                                        
         CLI   UPASS,X'FF'         FOR SUMMARY - WAS C'S'                       
         BNE   *+10                                                             
         MVC   GDMGR(8),SPACES     NO MGR OR MKT                                
*******  MVC   DUB(5),PBILLGRS     SAVE PBILLGRS                                
**BIG                                                                           
         MVC   DUB(6),PBILLGRS     SAVE PBILLGRS                                
**BIG                                                                           
         MVC   PBRACCT(6),GDMGR                                                 
         ZIC   RF,GDMGRLEN                                                      
         LA    RF,PBRACCT(RF)                                                   
         CLI   GDMKTLEN,0          OK - SINCE GDMKTLEN ALWAYS 0                 
         BE    *+14                FOR PRINT                                    
         MVC   0(4,RF),GDMKT                                                    
         LA    RF,4(RF)                                                         
         L     RE,GDOUTAD                                                       
**NEW 11/15/89     TO PREVENT BAD RETAIL BILLS TO BE ADDED                      
*               TO THE FILE (WITHOUT OR WITH A BAD OUTLET CODE)                 
         CLI   0(RE),C'A'                                                       
         BNL   *+6                                                              
         DC    H'0'       OUTLET CODE MUST BEGIN WITH A CHARACTER               
*                         FUNNY DATA WAS THERE ONCE FOR FCSA 10/89              
*                         NEVER FOUND OUT WHY                                   
*                                                                               
**NEW 11/15/89                                                                  
         MVC   0(L'GDOCODE,RF),0(RE)                                            
         DROP  R5                                                               
*                                                                               
WB6H2    DS    0H                                                               
         CLI   MOLSON,C'Y'         IF MOLSON SPECIAL                            
         BNE   WB6H4                                                            
         CLC   0(6,RF),=C'000001'  GIVE CORPORATE A DIFFERENT                   
         BNE   WB6H4                                                            
         MVI   5(RF),C'5'          OUTLET CODE (FOR RCVBLS)                     
*                                                                               
WB6H4    DS    0H                                                               
         MVC   PBILLGRS,DUB        RESTORE PBILLGRS                             
*                                  IT MAY HAVE BEEN CLOBBERED BY ABOVE          
         B     WB7D                                                             
*                                                                               
WB7      DS    0H                  NON-REATIL - SET MGR                         
********                                                                        
         OC   MANGRS(12),MANGRS    IF MANUAL LEAVE AS ZEROS                     
         BNZ   WB7D                                                             
         OC    AMGR1BRK,AMGR1BRK   SEE IF DOING MKTGRPS                         
         BZ    WB7D                                                             
         CLC   AMGR1BRK,AINVBRK    TEST MGR SEP                                 
         BH    WB7D                                                             
         MVC   PNBPGR1,PGR1        DIVISION                                     
         MVC   PNBMGR1,MGR1        REGION                                       
         MVC   PNBMGR2,MGR2        DISTRICT                                     
*                                                                               
WB7D     DS    0H                                                               
*                                                                               
         CLI   WBSW,C'Y'           WB FILGHT FEATURE?                           
         BNE   WB7D0                                                            
         OC    MANGRS(12),MANGRS       MANUAL BILLING?                          
         BZ    WB7D0                                                            
         MVI   PBILADID,C'.'       TO INDICATE FLIGHT ID FOLLOWS                
         MVC   PBILADID+1(10),ESTWBFLT   FLIGHT ID                              
         B     WB7D5                                                            
*                                                                               
*        IF DOING SEPERATE INVOICE PER AD CODE                                  
*        ADD PBILOTH ELEM                                                       
*                                                                               
WB7D0    OC    AJOBBRK,AJOBBRK     SEE IF DOING AD CODES                        
         BZ    WB7D6                                                            
**WB**                                                                          
         CLI   WBSW,C'Y'           WB FILGHT FEATURE?                           
         BNE   WB7D1                                                            
         OC    PEPTAID,PEPTAID         SEE IF IN PEPTAB                         
         BZ    WB7D3                                                            
         MVI   PBILADID,C'.'       TO INDICATE FLIGHT ID FOLLOWS                
         MVC   PBILADID+1(10),PEPTAID    FLIGHT ID                              
         B     WB7D5                                                            
WB7D1    DS    0H                                                               
**WB**                                                                          
         OC    PEPTJOB,PEPTJOB     SEE IF JOB IN PEPTAB                         
         BZ    WB7D3               WILL BE FOR DOREMUS FINANCIAL CLTS           
         MVC   PBILLJOB,PEPTJOB                                                 
         MVC   PBILADID,PEPTAID    STORE AD ID                                  
         B     WB7D5                                                            
*                                                                               
WB7D3    CLC   AJOBBRK,AINVBRK     TEST SEPERATE JOB PER INVOICE                
         BH    WB7D6                                                            
         L     RF,AJOB                                                          
**WB**                                                                          
         CLI   WBSW,C'Y'           WB FILGHT FEATURE?                           
         BNE   WB7D3J                                                           
         MVI   PBILADID,C'.'                                                    
         MVC   PBILADID+1(10),JOBDSP(RF) FILGHT ID                              
         B     WB7D5                                                            
*                                                                               
WB7D3J   DS    0H                                                               
**WB**                                                                          
         MVC   PBILLJOB,JOBDSP(RF)                                              
         MVC   PBILADID,ADIDDSP2(RF)   ALWAYS USE ONE AFTER AD                  
*                                                                               
WB7D5    CLI   PEPTFIN,0           CHECK FINANCIAL                              
         BNE   WB7D6                                                            
         ZAP   PBILLOPG,=P'0'                                                   
         ZAP   PBILLOPN,=P'0'                                                   
         ZAP   PBILLCNR,=P'0'                                                   
         MVC   PBILOTH(2),=X'091E'                                              
*****    MVC   PBILLLEN,=H'133'    RESET RECORD LENGTH                          
**BIG                                                                           
         MVC   PBILLLEN,=H'163'      133+30                                     
**BIG                                                                           
*                                                                               
WB7D6    OC    PEPTTAX,PEPTTAX     CKECK FOR SALES TAX                          
         BZ    WB7D8                                                            
         CLI   PBILOTH,X'09'       SEE IF 09 ELEMNET ALREADY THERE              
         BE    WB7D6H                                                           
         ZAP   PBILLOPG,=P'0'                                                   
         ZAP   PBILLOPN,=P'0'                                                   
         ZAP   PBILLCNR,=P'0'                                                   
         MVC   PBILOTH(2),=X'0920'  "BIG" PBILOTH ELEMENT                       
******** MVC   PBILLLEN,=H'135'    RESET RECORD LENGTH                          
**BIG                                                                           
         MVC   PBILLLEN,=H'165'    RESET RECORD LENGTH 133+32                   
**BIG                                                                           
         MVC   PBILLTAX,PEPTTAX                                                 
         CLI   PBRETAIL,0           SEE IF RETAIL                               
         BE    WB7D8                                                            
         MVC   PBILLTAX,PEPTRETT    USE RETAIL SHRARE OF TAX                    
         B     WB7D8                                                            
*                                                                               
WB7D6H   MVC   PBILOTH(2),=X'0920'   "BIG" PBILOTH ELEMENT                      
*******  MVC   PBILLLEN,=H'135'                                                 
**BIG                                                                           
         MVC   PBILLLEN,=H'165'     133+32                                      
**BIG                                                                           
         MVC   PBILLTAX,PEPTTAX                                                 
         CLI   PBRETAIL,0           SEE IF RETAIL                               
         BE    WB7D8                                                            
         MVC   PBILLTAX,PEPTRETT    USE RETAIL SHRARE OF TAX                    
         B     WB7D8                                                            
*                                                                               
*                                                                               
*                                  ADD INTO REQ TOTALS                          
WB7D8    CLI   PBRETAIL,X'41'      SKIP CORP SUMMARY                            
         BE    WB7F                                                             
         CLI   DUESW,C'A'          ADJ INV SKIP OBTOTS                          
         BE    WB7F                                                             
         CLI   DUESW,C'C'          CD INV                                       
         BE    WB7F                                                             
         CLI   DUESW,C'R'          OR AOR INV                                   
         BE    WB7F                                                             
*                                                                               
*              NOTE - R4 STILL SET TO PEPTAB ENTRY                              
*                                                                               
         L     R0,OBTOTS                                                        
         A     R0,PEPTGRS          GROSS                                        
         ST    R0,OBTOTS                                                        
         L     R0,OBTOTS+4                                                      
         A     R0,PEPTNET           NET                                         
         ST    R0,OBTOTS+4                                                      
         L     R0,OBTOTS+8                                                      
         A     R0,PEPTCD            CD                                          
         ST    R0,OBTOTS+8                                                      
*                                                                               
WB7F     DS    0H                                                               
**GST                                                                           
         CLI   PEPTVSW,0           SEE IF BILL IS VATABLE                       
         BE    WB7F6                                                            
         XC    ELEM(15),ELEM        ADD VAT ELEMENT                             
         MVC   ELEM(2),=X'0A0E'                                                 
         LA    RF,ELEM                                                          
         USING PBILVEL,RF                                                       
*                                                                               
         MVC   PBILLVCD,PEPTVCD                                                 
         MVC   PBILLVAT,PEPTVATC   VAT FOR COMMISSION BILL                      
         MVC   PBILLVBS,PEPTADJ    VAT BASIS FOR ADJ BILL                       
         CLI   DUESW,C'A'                                                       
         BE    WB7F4                                                            
         L     R0,PEPTVATD          CD VAT                                      
         LCR   R0,R0                MUST COMPLIMENT                             
         STCM  R0,15,PBILLVAT                                                   
         L     R0,PEPTCD            CD VAT BASIS                                
         LCR   R0,R0                MUST COMPLIMENT                             
         ST    R0,PBILLVBS                                                      
*                                                                               
         CLI   DUESW,C'C'                                                       
         BE    WB7F4                                                            
         MVC   PBILLVAT,PEPTVATA    VAT FOR AOR BILL                            
         MVC   PBILLVBS,PEPTAOR                                                 
         CLI   DUESW,C'R'                                                       
         BE    WB7F4                                                            
         MVC   PBILLVAT,PEPTVAT      SET FOR MAIN BILL VAT                      
*                                    SET VAT BASIS                              
*                                                                               
         L     R0,PEPTVTB            GST BASIS FOR MAIN BILL                    
         B     WB7F2                                                            
*                                                                               
*        NO LONGER TRY TO CALCULATE HERE                                        
*        AS GST BASIS MAY NOT BE BASED ON THE AMOUNT DUE                        
*                                                                               
**       L     R0,PEPTDUE            AMOUNT DUE                                 
**       S     R0,PEPTTAX            MINUS TAX                                  
**       CLI   ADJSEP,C'Y'           SEE IF ADJ ON SEPERATE                     
**       BNE   *+8                                                              
**       S     R0,PEPTADJ                                                       
**                                                                              
**       CLI   CDSEP,C'R'         SPECIAL CD HANDLING USING 'APPLY'             
**       BE    WB7F1                                                            
**                                                                              
**       CLI   CDSEP,C'C'            CHECK FOR SPECIAL CD HANDLING              
**       BNE   WB7F2                                                            
**7F1    TM    PBILBASA,X'04'        SEE IF CD IN FORMULA                       
**       BNO   WB7F2                                                            
**       A     R0,PEPTCD             RESTORE CD                                 
**                                                                              
WB7F2    ST    R0,PBILLVBS                                                      
***********                                                                     
***********               WHAT IF RETAIL AND COMM SEP OR CD SEP???              
***********                                                                     
         CLI   PBRETAIL,0          SEE IF RETAIL BILL                           
         BE    WB7F4                                                            
         MVC   PBILLVAT,PEPTRETV    USE RETAIL VAT                              
         L     R0,PEPTRETA          ACTUAL                                      
         S     R0,PEPTRETT          MINUS TAX                                   
         ST    R0,PBILLVBS                                                      
         DROP  RF                                                               
****                                                                            
WB7F4    DS    0H                                                               
         LA    R2,PBILLEL                                                       
         MVI   ELCODE,X'FF'                                                     
         BRAS  RE,NEXTEL       ADD TO END OF RECORD                             
         GOTO1 RECUP,DMCB,(1,PBILLREC),ELEM,(R2)                                
*                                                                               
         BAS   RE,SETPVAT          NOW DO PROV VATS                             
*                                                                               
WB7F6    DS    0H                                                               
**GST                                                                           
         CLC   QPROG,=C'R1'        FINANCIAL REBATE                             
         BE    WB7F9                                                            
         CLC   QPROG,=C'RD'        FINANCIAL REBATE BILL - DRAFT                
         BNE   WB7X                ALTER BILLAMTS                               
WB7F9    ZAP   PBILLOPG,=P'0'                                                   
         ZAP   PBILLOPN,=P'0'                                                   
         ZAP   PBILLGRS,=P'0'                                                   
         ZAP   PBILLBIL,=P'0'                                                   
         ZAP   PBILLNET,=P'0'                                                   
         ZAP   PBILLRCV,PBILLCNR     SET PBILLRCV TO PBILLCNR                   
***R***                                                                         
WB7X     CLI   RCWRITE,C'Y'                                                     
         BNE   WB7X5                                                            
         CLI   TESTFLAG,C'T'       ALL DRAFT BILLING                            
         BE    WB7X5   MAY STILL NEED TO DO EDI (WAS BE   WB8)                  
         MVC   KEY,PBILLREC                                                     
***NEW 5/16/91                      DIE IF BILL ALREADY ON FILE                 
         GOTO1 HIGH                                                             
         CLC   KEY(20),KEYSAVE                                                  
         BNE   *+6                                                              
         DC    H'0'                                                             
         MVC   KEY,PBILLREC                                                     
***NEW 5/16/91                                                                  
         MVC   AREC,ADBILL                                                      
         GOTO1 ADDPRT                                                           
         OC    SAVEDA,SAVEDA                                                    
         BNZ   *+10                                                             
         MVC   SAVEDA,KEY          SAVE DA OF FIRST BILL ADDED                  
**EDI**                                                                         
WB7X5    DS    0H                                                               
         GOTO1 ABILLEDI,DMCB,('EDMHDR',0) EDI CALL                              
*                                                                               
         CLI   OUTDDFLG,C'Y'       IS "OUT" DD STATEMENT PRESENT?               
         BNE   WB7X8               NO                                           
         L     RE,ACONIO           PREPARE TO PUT HEADER TO SEQ FILE            
         SR    RF,RF               USE CONTRACT RECORD AREA                     
         ICM   RF,3,PBILLLEN       L'RECORD                                     
         LR    R0,RF                                                            
         AHI   R0,4                L'RECORD +4(FOR RDW)                         
         STH   R0,0(RE)            PUT L'RECORD IN FIRST 2 BYTES OF RDW         
         XC    2(2,RE),2(RE)       CLEAR 2ND HALFWORD OF RDW                    
         LR    R1,RF               L'RECORD                                     
         LR    R0,R7               R0 = A(RECORD)                               
         LA    RE,4(RE)            COPY HEADER RECORD INTO I/O AREA+4           
         MVCL  RE,R0               VARIABLE LENGTH RECORD IS NOW BUILT          
         L     R3,ACONIO           A(RECORD)                                    
**SEPREG                                                                        
*                                  USE FIRST SPARE BYTE OF KEY                  
         MVC   22(1,R3),PROFB1A+2  Y= REGISTER ON SEPARATE OUTPUT               
*                                  18+4 FOR LENGTH = 22                         
*                                  WILL BE CHECKED USING PBILLREC+18            
*                                                                               
         CLI   PROFB1A+2,C'Y'                                                   
         BE    WB7X6                                                            
         MVI   NORMREG,C'Y'    BILL FOR NORMAL REGISTER ENCOUNTERED             
         B     WB7X7                                                            
WB7X6    MVI   SEPREG,C'Y'     BILL FOR SEPARATE REGISTER ENCOUNTERED           
*                                                                               
WB7X7    DS    0H                                                               
**SEPREG                                                                        
         L     R2,=A(OUT)                                                       
         PUT   (R2),(R3)           WRITE TO SYSDA FILE                          
         MVI   HAVEBILL,C'Y'       WE CAN PRINT AN INVOICE REGISTER             
*                                                                               
WB7X8    DS    0H                                                               
         CLI   RCWRITE,C'Y'                                                     
         BNE   WB8                                                              
**EDI**                                                                         
         OC    MANGRS(12),MANGRS    SEE IF MANUAL BILL                          
         BZ    WB8                                                              
*                                                                               
         MVC   FULL,KEY            SAVE DA                                      
         MVC   KEY,PBILLREC        ADD SECOND POINTER                           
         MVC   KEY+27(4),FULL      PUT DA IN KEY                                
         MVI   KEY+3,X'88'                                                      
         GOTO1 DATAMGR,DMCB,(DMINBTS,DMADD),PRTDIR,KEY,KEY                      
         MVC   BYTE,DMCB+8                                                      
         NC    BYTE,DMOUTBTS                                                    
         BZ    *+6                                                              
         DC    H'0'                DATAMGR ERROR                                
*                                                                               
WB8      DS    0H                                                               
         CLI   SORTTRCE,C'B'       TRACE OF BILLS ONLY                          
         BE    WB8A                                                             
         CLI   SORTTRCE,C'Y'                                                    
         BNE   WB8B                                                             
*                                  DUMP OF RECORD                               
WB8A     DS    0H                                                               
         GOTO1 HEXOUT,DMCB,PBILLREC,P1+10,50,=C'N'                              
         GOTO1 (RF),(R1),PBILLREC+50,P2+10,50                                   
         GOTO1 (RF),(R1),PBILLREC+100,P3+10,50                                  
         GOTO1 (RF),(R1),PBILLREC+150,P4+10,50                                  
         GOTO1 (RF),(R1),PBILLREC+200,P5+10,50                                  
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
WB8B     DS    0H                                                               
         LA    R2,PBILLEL                                                       
         MVI   ELCODE,X'0A'        DELETE 0A ELEM                               
         BRAS  RE,NEXTEL                                                        
         BNE   WB8B3                                                            
         GOTO1 RECUP,DMCB,(1,PBILLREC),(R2),0                                   
*                                                                               
WB8B3    LA    R2,PBILLEL                                                       
         MVI   ELCODE,X'09'        DELETE 09 ELEM                               
         BRAS  RE,NEXTEL                                                        
         BNE   WB8B3V                                                           
         GOTO1 RECUP,DMCB,(1,PBILLREC),(R2),0                                   
*                                                                               
WB8B3V   DS    0H                      DELETE PST ELEMS                         
         LA    R2,PBILLEL                                                       
         MVI   ELCODE,X'84'                                                     
         BRAS  RE,NEXTEL                                                        
         BNE   WB8B4                                                            
         GOTO1 RECUP,DMCB,(1,PBILLREC),(R2),0                                   
         B     WB8B3V                   MORE                                    
*                                                                               
WB8B4    XC    PBILOTH(50),PBILOTH      CLEAR PBILLREC                          
*                                                                               
WB8B5    A     R4,PEPPARS+12       NEXT PEPTAB ENTRY                            
*******  MVC   PBILLLEN,=H'103'      RESET TO "NORMAL" BILL LENGTH              
**BIG                                                                           
         MVC   PBILLLEN,=H'133'   RESET TO "NORMAL" BILL LEN 100+33             
**BIG                                                                           
         XC    PBILOTH(50),PBILOTH      CLEAR PBILOTH AND 0A ELEM               
         BCT   R6,WB4                                                           
*                                                                               
WBILLX  DS    0H                                                                
         XIT1                                                                   
         SPACE 3                                                                
CKMAX    CP    DUB,=P'99999999999'    OVER MAX                                  
         BNH   *+6                                                              
         DC    H'0'             MUST DIE                                        
         CP    DUB,=P'-99999999999'   UNDER MINIMUM                             
         BNL   *+6                                                              
         DC    H'0'            MUST DIE                                         
         BR    RE              RETURN                                           
*                                                                               
         EJECT                                                                  
**********************************************************************          
*                                                                               
*        SETPVAT - SET PROVINCIAL VAT AMOUNTS                                   
*                                                                               
*         NOTE- +1'S AND +4'S ARE TO BYPASS NATIONAL VAT                        
**********************************************************************          
         PRINT GEN                                                              
         SPACE 1                                                                
SETPVAT  NTR1                                                                   
*                                                                               
         LA    R2,PEPTVCDS+1       VAT CODES                                    
         LA    R3,PEPTVSWS+1       VAT SWITCHES                                 
*                                                                               
SPV4     DS    0H                                                               
         CLI   DUESW,C'R'          AOR BILLS                                    
         BNE   SPV5                                                             
         LA    R2,PEPTAOVS+1       USE AOR VAT CODES                            
         LA    R3,PEPTAOVS+1       ALSO USE AS SWITCHES                         
         LA    R5,PEPTVTAS+4       VAT AMOUNTS                                  
         L     R6,PEPTAOR          AOR AMOUNT IS VAT BASIS                      
         A     R6,PEPTVTAS         ADD GST FOR PROV VAT BASES                   
         ST    R6,FULL                                                          
         LA    R6,FULL                                                          
         B     SPV10                                                            
*                                                                               
SPV5     DS    0H                                                               
         CLI   DUESW,C'A'          COMM ADJ BILLS                               
         BNE   SPV5CD                                                           
         LA    R5,PEPTVTCS+4       VAT AMOUNTS                                  
         LA    R6,PEPTCVTB+4       VAT BASES                                    
         B     SPV10                                                            
*                                                                               
SPV5CD   DS    0H                                                               
         CLI   DUESW,C'C'          CD SEP BILLS                                 
         BNE   SPV6                                                             
         LA    R5,PEPTVTDS+4       VAT AMOUNTS                                  
         LA    R6,PEPTDVTB+4       VAT BASES                                    
         B     SPV10                                                            
*                                                                               
SPV6     DS    0H                                                               
         CLI   UPASS,0             RETAIL                                       
         BE    SPV7                                                             
         LA    R5,PEPTRTVS+4       VAT AMOUNTS                                  
         LA    R6,PEPTRVTB+4       VAT BASES                                    
         B     SPV10                                                            
*                                                                               
SPV7     DS    0H                  'NORMAL' BILL                                
         LA    R5,PEPTVTS+4        VAT AMOUNTS                                  
         LA    R6,PEPTVTB+4        VAT BASES                                    
*                                                                               
SPV10    DS    0H                                                               
         LA    R0,NPROVS                                                        
         SR    RF,RF                                                            
         B     SPV14                                                            
*                                                                               
SPV12    DS    0H                                                               
         LA    R2,1(R2)                                                         
         LA    R3,1(R3)                                                         
         LA    R5,4(R5)                                                         
         CLI   DUESW,C'R'          FOR AOR BASIS IS CONTSTANT                   
         BE    *+8                                                              
         LA    R6,4(R6)            NEXT BASIS AMOUNT                            
*                                                                               
SPV14    CLI   0(R3),C' '          TEST VAT SWITCH                              
         BNH   SPV50                                                            
*                                                                               
         LA    RE,ELEM             START OF PROV VAT 'ELEMENTS'                 
         XC    ELEM,ELEM                                                        
         USING PBLPSTEL,RE                                                      
         MVC   ELEM(2),=X'840F'    SET ELEM CODE AND LENGTH                     
*                                                                               
         MVC   PBLPVCOD,0(R2)   VAT CODE                                        
         CLI   0(R2),X'FF'                    IF MIXED                          
         BNE   *+8                                                              
         MVI   PBLPVCOD,C'?'                                                    
         MVC   PBLPVBAS,0(R6)   VAT BASIS                                       
         MVC   PBLPVAMT,0(R5)   VAT AMOUNT                                      
*                                                                               
         CLI   DUESW,C'C'        SEE IF CD BILL                                 
         BNE   SPV20                                                            
*                                                                               
         ICM   R1,15,PBLPVBAS      IF SO MUST COMPLIMENT BASE                   
         LCR   R1,R1                                                            
         STCM  R1,15,PBLPVBAS                                                   
         ICM   R1,15,PBLPVAMT      AND VAT                                      
         LCR   R1,R1                                                            
         STCM  R1,15,PBLPVAMT                                                   
*                                                                               
SPV20    LH    R1,=H'11'                PROVINCE = 11 - BCT COUNTER             
         SR    R1,R0                                                            
         STC   R1,PBLPVPRV                                                      
         DROP  RE                                                               
*                                                                               
         ST    RF,MYRF                                                          
         ST    R2,MYR2                                                          
         ST    R0,MYR0                                                          
         LA    R2,PBILLEL                                                       
         MVI   ELCODE,X'FF'                                                     
         BRAS  RE,NEXTEL                                                        
         GOTO1 RECUP,DMCB,(1,PBILLREC),ELEM,(R2)                                
         L     RF,MYRF                                                          
         L     R2,MYR2                                                          
         L     R0,MYR0                                                          
         XC    ELEM,ELEM                                                        
         LA    RF,1(RF)            COUNT OF ELEMS                               
*                                                                               
SPV50    DS    0H                                                               
         BCT   R0,SPV12                                                         
*                                                                               
SPVX     DS    0H                                                               
         XIT1                                                                   
         PRINT NOGEN                                                            
         DROP  R4                                                               
*                                                                               
MYRF     DS    F                 USED TO SAVE REGISTER F                        
MYR2     DS    F                                                                
MYR0     DS    F                                                                
         LTORG                                                                  
         TITLE 'INVREG - INVOICE REGISTER MODULE'                               
INVREG   NMOD1 0,INVREG                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
*                                                                               
INV0     DS    0H                                                               
*                                                                               
         MVI   CURTAB+3,2          RESET TO 2 DECIMALS                          
*                       -IT SOMETIMES GETS CLOBBERED WHEN BILLING DUMPS         
         CLI   DOINVREG,C'Y'     PRODUCE REGISTER?                              
         BNE   INVRX                                                            
         CLI   HAVEBILL,C'Y'    ANY BILLS?                                      
         BNE   INVRX                                                            
*                                                                               
         MVI   AORSW,0      WILL BE SET TO X'01' IF AOR BILL FOUND              
*                                                                               
         B     INVR0                                                            
         B     INVR                                                             
PATCHDA  DC    F'0'            USE TO RERUN REGISTER                            
INVR     MVC   SAVEDA,PATCHDA                                                   
*                                                                               
INVR0    DS    0H                                                               
*                                                                               
*        CHECK TABLE OF FINANCIAL AGENCIES                                      
*        IF AGENCY IS NOT IN THIS TABLE                                         
*        "OPEN" BILLING WILL DISPLAY AS "COST2"                                 
*                                                                               
*                                                                               
         MVI   ROPENSW,C'N'                                                     
         LA    R1,FAGYTAB                                                       
INVR0A   CLI   0(R1),X'FF'            END OF FINANCIAL AGENCIES                 
         BE    INVR0F                                                           
         CLC   RCSVAGY(2),0(R1)                                                 
         BNE   INVR0C                                                           
         MVI   ROPENSW,C'Y'                                                     
         B     INVR0F                                                           
*                                                                               
INVR0C   LA    R1,2(R1)                                                         
         B     INVR0A                                                           
*                                                                               
INVR0F   DS    0H                                                               
         MVI   SREGPASS,1        FIRST PASS - NORMAL REGISTER                   
*                                (ATTACHED TO BILLING)                          
*                                NOTE - RCWHATPR WILL BE SET                    
*                                FROM SREGPASS                                  
*                                                                               
INVR04   DS    0H                                                               
         CLOSE OUT                                                              
         OPEN  (OUT,INPUT)                                                      
*                                                                               
**       MVC   SAVR1,SAVEDA      SAVE FIRST DISK ADDR                           
**                          AND SET TO X'02' WHEN DOING AOR REGISTER            
**VR1    DS    0H                                                               
**       OC    SAVEDA,SAVEDA                                                    
**       BZ    INVRX               NO BILLS ADDED                               
*                                                                               
         CLI   SREGPASS,2    SECOND PASS?                                       
         BE    INVR04S                                                          
         CLI   NORMREG,C'Y'  BILL FOR NORMAL REGISTER ENCOUNTERED               
         BNE   INVR04S                                                          
         MVC   QUESTOR,=C'INVOICE REG.' PRINT SMTH TO INDICATE INV REG          
         GOTO1 VREQREP,DMCB         FORCE GENERATION OF REQUEST HEADER          
INVR04S  L     R8,=A(DICSECT)                                                   
         USING DICSECT,R8                                                       
*                                                                               
         LA    R2,P1                                                            
         USING ILINED,R2                                                        
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         MVI   RCSUBPRG,20                                                      
         TM    AORSW,X'02'         SEE IF DOING AOR REGISTER                    
         BNO   INVR1C                                                           
         ZIC   R3,RCSUBPRG                                                      
         LA    R3,1(R3)                                                         
         STC   R3,RCSUBPRG                                                      
*                                                                               
INVR1C   DS    0H                  CLEAR ALL TOTALS                             
         LA    R3,BILLTOTS                                                      
         BAS   RE,CLRTOTS                                                       
         LA    R3,IRITOTS                                                       
         BAS   RE,CLRTOTS                                                       
         LA    R3,IRCTOTS                                                       
         BAS   RE,CLRTOTS                                                       
         LA    R3,IRMTOTS                                                       
         BAS   RE,CLRTOTS                                                       
*                                                                               
         ZIC   R0,SAVEDA+2                                                      
         BCTR  R0,R0                                                            
         STC   R0,SAVEDA+2                                                      
         XC    KEY1,KEY1                                                        
         MVC   AREC,ADWKREC                                                     
         XC    DBTOTS,DBTOTS                                                    
INVR2    DS    0H                                                               
**       L     R7,AREC                                                          
**       USING PBILLREC,R7                                                      
         L     R6,ACONIO                                                        
         LA    R7,4(R6)      PAST LENGTH                                        
         USING PBILLREC,R7                                                      
         L     R1,=A(OUT)                                                       
         GET   (R1),(R6)       READ INTO ACONIO                                 
         B     INVR2B                                                           
**                                                                              
**       XC    PBILOTH(60),PBILOTH                                              
**       GOTO1 DATAMGR,DMCB,DMRSEQ,PRTFILE,SAVEDA,AREC                          
**                                                                              
**       TM    DMCB+8,X'7F'                                                     
**       BZ    *+6                                                              
**       DC    H'0'                                                             
**       TM    DMCB+8,X'80'                                                     
**       BZ    INVR2B                                                           
**VR2A   MVI   PBILLREC,X'FF'                                                   
**       MVC   PBILLREC+1(24),PBILLREC                                          
**       B     INVR3                                                            
*                                                                               
INVR2B   DS    0H                                                               
**SEPREG                                                                        
         CLI   SREGPASS,1       FIRST PASS?                                     
         BNE   INVR2B4                                                          
         CLI   PBILLREC+18,C'Y'     IF SO, SKIP THESE BILLS                     
         BE    INVR2                                                            
         B     INVR2BX                                                          
*                                                                               
INVR2B4  CLI   SREGPASS,2       SECOND PASS - SEPARATE REGISTER                 
         BE    *+6                                                              
         DC    H'0'             SOMETHING WRONG                                 
         CLI   PBILLREC+18,C'Y'                                                 
         BNE   INVR2            SKIP THOSE ON FIRST REGISTER                    
*                                                                               
**SEPREG                                                                        
INVR2BX  CLC   PBILLREC(2),RCSVAGY                                              
         BNE   INVR2                                                            
         CLI   PBILLREC+3,X'08'                                                 
         BNE   INVR2               NOT A BILL                                   
*                                                                               
         MVC   HALF,PBILLLEN                                                    
         LA    RE,PBILLREC                                                      
         AH    RE,HALF                                                          
         MVC   0(2,RE),=X'0000'      ZERO END OF RECORD                         
*                                                                               
         CLI   PBILLTYP,C'0'       SEE IF "NEW" BILL                            
         BH    INVR2               OLD - SKIP                                   
*                                                                               
*                                  FIRST TEST FOR INVOICE BRK                   
INVR3    DS    0H                                                               
         CLI   PBILLREC,X'FF'      LAST BILL                                    
         BE    INVR3AX                                                          
*                                                                               
         TM    AORSW,X'02'         SEE IF DOING AOR REGISTER                    
         BNO   INVR3A                                                           
         TM    PBILCMSW,BSTTAORQ   SEE IF AOR BILL                              
         BNO   INVR2               NO SKIP                                      
         B     INVR3AX                                                          
*                                                                               
INVR3A   TM    PBILCMSW,BSTTAORQ                                                
         BNO   INVR3AX                                                          
         OI    AORSW,X'01'         SET AOR BILLS FOUND                          
         B     INVR2               SKIP AOR THIS TIME                           
*                                                                               
INVR3AX  CLC   RCSVAGY,=C'DM'      FOR DOREMUS IGNORE MEDIA BREAKS              
         BE    INVR3B                                                           
         CLC   RCSVAGY,=C'SJ'      OR SJR                                       
         BNE   INVR3D                                                           
INVR3B   CLC   PBILLREC+4(3),KEY1+4  CHK FOR CLT BREAK                          
         BNE   INVR4                                                            
         B     INVR3F                                                           
*                                                                               
INVR3D   CLC   PBILLREC(7),KEY1    CLT                                          
         BNE   INVR4                                                            
INVR3F   CLC   PBILLREC+16(2),KEY1+16    CHK FOR INVOICE BREAK                  
         BE    INVR16                                                           
INVR4    DS    0H                                                               
         OC    KEY1,KEY1                                                        
         BZ    INVR12                                                           
*                                                                               
         CLC   DBTOTS(4),=F'1'     IF ONLY 1 INV FOR THIS NUMBER                
         BNH   INVR6               DONT PRINT A TOTAL                           
*                                                                               
         MVC   BILLTOTS(80),IRITOTS     PRINT INVOICE TOTALS                    
*                                                                               
         BAS   RE,IRFMTL                                                        
         MVC   ILINV,W                                                          
*--->    MVC   ILPRD(5),=C'TOTAL'                                               
         MVC   ILPRD(L'PP@TOTAL),PP@TOTAL                                       
         MVI   SPACING,2                                                        
**SEPREG                                                                        
         MVC   RCWHATPR,SREGPASS                                                
**SEPREG                                                                        
         GOTO1 =A(PRNT)                                                         
INVR6    DS    0H                                                               
         LA    R3,IRITOTS          CLEAR                                        
         BAS   RE,CLRTOTS                                                       
         XC    DBTOTS,DBTOTS                                                    
*                                                                               
         CLC   RCSVAGY,=C'DM'      DOREMUS - IGNORE MEDIA BREAKS                
         BE    INVR6A                                                           
         CLC   RCSVAGY,=C'SJ'      OR SJR                                       
         BNE   INVR6C                                                           
INVR6A   CLC   PBILLKEY+4(3),KEY1+4      TEST CLT BREAK                         
         BE    INVR16                                                           
         B     INVR6E                                                           
*                                                                               
INVR6C   CLC   PBILLKEY(7),KEY1    TEST CLIENT BRK                              
         BE    INVR16                                                           
INVR6E   OC    KEY1,KEY1                                                        
         BZ    INVR12                                                           
*                                  FINSIH UP LAST CLIENT                        
         MVC   BILLTOTS(80),IRCTOTS  MOVE CLT TOTS TO BILLTOTS                  
*                                FOR PRINTING                                   
         MVC   TOTSTAR,=C'* '                                                   
         BAS   RE,IRFMTL                                                        
*--->    MVC   P1(7),=C'*CLIENT'                                                
         MVC   P1(L'PP7CLI),PP7CLI                                              
         MVC   P1+8(3),KEY1+4                                                   
*--->    MVC   P1+12(7),=C'TOTALS*'                                             
         MVC   P1+12(L'PP7TOTAL),PP7TOTAL                                       
         MVI   SPACING,2                                                        
**SEPREG                                                                        
         MVC   RCWHATPR,SREGPASS                                                
**SEPREG                                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
         LA    R3,IRCTOTS          ROLL CLIENT TOTALS TO MEDIA TOTALS           
         LA    R4,IRMTOTS                                                       
         BAS   RE,ROLTOTS                                                       
*                                                                               
         LA    R3,IRCTOTS          THEN CLEAR CLIENT TOTALS                     
         BAS   RE,CLRTOTS                                                       
*                                                                               
         CLC   RCSVAGY,=C'DM'      DOREMUS - IGNORE MEDIA BREAKS                
         BE    INVR7                                                            
         CLC   RCSVAGY,=C'SJ'      OR SJR                                       
         BNE   INVR8                                                            
INVR7    CLI   PBILLREC,X'FF'      SEE IF END OF FILE                           
         BNE   INVR14                                                           
*                                                                               
         MVC   BILLTOTS(80),IRMTOTS  MOVE MEDIA TOTALS FOR PRINTING             
*                                                                               
         MVC   TOTSTAR,=C'**'                                                   
         BAS   RE,IRFMTL                                                        
*--->    MVC   P1(16),=C'**GRAND TOTALS**'                                      
         MVC   P1(L'PP@GRTOT),PP@GRTOT                                          
**SEPREG                                                                        
         MVC   RCWHATPR,SREGPASS                                                
**SEPREG                                                                        
         GOTO1 =A(PRNT)                                                         
         B     INVR30              GO SEE IF I MUST DO AOR REGISTER             
*                                                                               
INVR8    CLC   PBILLREC(3),KEY1    TEST MEDIA BRK                               
         BE    INVR14                                                           
*                                                                               
         MVC   BILLTOTS(80),IRMTOTS  MOVE MEDIA TOTALS FOR PRINTING             
*                                                                               
         MVC   TOTSTAR,=C'**'                                                   
         BAS   RE,IRFMTL                                                        
*--->    MVC   P1(16),=C'**MEDIA TOTALS**'                                      
         MVC   P1(L'PP@MDTOT),PP@MDTOT                                          
**SEPREG                                                                        
         MVC   RCWHATPR,SREGPASS                                                
**SEPREG                                                                        
         GOTO1 =A(PRNT)                                                         
         CLI   PBILLREC,X'FF'                                                   
         BE    INVR30               SEE IF I MUST DO AOR REGISTER               
*                                                                               
         LA    R3,IRMTOTS           CLEAR MEDIA TOTALS                          
         BAS   RE,CLRTOTS                                                       
*                             NEW MEDIA                                         
INVR12   DS    0H                                                               
         CLI   PBILLREC,X'FF'                                                   
         BE    INVR30               SEE IF I MUST DO AOR REGISTER               
         CLC   RCSVAGY,=C'DM'        NO MEDIA FOR DOREMUS                       
         BE    INVR12F                                                          
         CLC   RCSVAGY,=C'SJ'        OR SJR                                     
         BE    INVR12F                                                          
*                                                                               
*    NOTE  FOR MEDSOC (L - SOCIAL) NO CHANGES                                   
         MVC   MEDNEWS+1(L'PP@NEWS),PP@NEWS                                     
         MVC   MEDMAG+1(L'PP@MAG),PP@MAG                                        
         MVC   MEDTRD+1(L'PP@TRD),PP@TRD                                        
         MVC   MEDSPL+1(L'PP@SPL),PP@SPL                                        
         MVC   MEDOUT+1(L'PP@OUT),PP@OUT                                        
         CLI   RCLANG,4        SEE IF LAST REQ WAS FRENCH                       
         BNE   INVR12A                                                          
         MVC   MEDNATV+1(10),=C'VIDEO NAT.'                                     
         MVC   MEDLOCV+1(10),=C'VIDEO LOC.'                                     
         MVC   MEDLOCV+1(10),=C'AUDIO NUM.'                                     
*                                                                               
INVR12A  CLI   SRCHSW,C'Y'     IS MEDIA S SEARCH?                               
         BNE   *+10                                                             
         MVC   MEDSPL+1(10),=CL10'SEARCH'                                       
*                                                                               
         LA    R3,MEDLIST                                                       
INVR12C  CLI   0(R3),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLC   0(1,R3),PBILKMED                                                 
         BE    INVR12E                                                          
         LA    R3,11(R3)                                                        
         B     INVR12C                                                          
*                                                                               
INVR12E  DS    0H                                                               
         CLI   RCLANG,4        LAST REQ FRENCH?                                 
         BE    INVR12E8        USE NAME FROM TABLE                              
*                                                                               
         L     R6,ADAGY        IF NOT,USE MEDIA NAME FROM HEADER                
         USING PAGYREC,R6                                                       
         CLC   PAGYKMED,PBILKMED    SEE IF MATCHES MY AGY HEADER                
         BNE   INVR12E5             IF NOT, GO READ IT                          
*                                                                               
INVR12E2 MVC   MED,PAGYKMED                                                     
         MVC   MEDNM,PAGYMED        USE NAME FROM AGENCY HEADER                 
         B     INVR12F                                                          
*                                                                               
INVR12E5 DS    0H                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(03),PBILLKEY      PART OF BILL KEY                           
         MVI   KEY+3,X'01'                                                      
         GOTO1 HIGH                                                             
         CLC   KEY(25),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         GOTO1 GETAGY                                                           
         B     INVR12E2                                                         
*                                                                               
         DROP  R6                                                               
*                                                                               
INVR12E8 MVC   MED,0(R3)       GET FROM TABLE  - FRENCH REQUEST                 
         MVC   MEDNM,1(R3)                                                      
*                                                                               
INVR12F  MVI   FORCEHED,C'Y'                                                    
*                                                                               
*                             NEW CLIENT                                        
INVR14   DS    0H                                                               
         CLI   AGMCLOPT,C'N'                                                    
         BE    *+8                                                              
         MVI   FORCEHED,C'Y'                                                    
*--->    MVC   P1(6),=C'CLIENT'                                                 
         MVC   P1(L'PP@CLI),PP@CLI                                              
         MVC   P1+7(3),PBILKCLT                                                 
         MVC   P2(9),DASHES                                                     
         CLI   P1+9,C' '                                                        
         BE    *+8                                                              
         MVI   P2+9,C'-'                                                        
         MVI   ALLOWLIN,6                                                       
**SEPREG                                                                        
         MVC   RCWHATPR,SREGPASS                                                
**SEPREG                                                                        
**DUMP**                                                                        
**       CLI   PBILKMED,C'I'                                                    
**       BNE   INVR15                                                           
**       CLC   PBILKCLT(2),=C'GP'                                               
**       BNE   INVR15                                                           
**       DC    H'0'                DUMP BEFORE                                  
**                                                                              
**VR15   DS    0H                                                               
**DUMP**                                                                        
         GOTO1 =A(PRNT)                                                         
**DUMP**                                                                        
**       CLI   PBILKMED,C'T'                                                    
**       BNE   INVR15D                                                          
**       CLC   PBILKCLT(2),=C'GP'                                               
**       BNE   INVR15D                                                          
**       DC    H'0'                DUMP AFTER                                   
**                                                                              
**VR15D  DS    0H                                                               
**DUMP**                                                                        
         XC    BINVDTE,BINVDTE                                                  
         XC    BDUEDTE,BDUEDTE                                                  
*                                                                               
INVR16   DS    0H                                                               
         CLC   PBILINVD,BINVDTE                                                 
         BE    INVR17                                                           
         GOTO1 DATCON,DMCB,(3,PBILINVD),(5,P1+23)                               
*--->    MVC   P1+9(14),=C'INVOICE DATE ='                                      
         MVC   P1+9(L'PP@INVDT),PP@INVDT                                        
         MVI   ALLOWLIN,3                                                       
**SEPREG                                                                        
         MVC   RCWHATPR,SREGPASS                                                
**SEPREG                                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
INVR17   DS    0H                                                               
         CLC   PBILDUED,BDUEDTE                                                 
         BE    INVR18                                                           
         GOTO1 DATCON,DMCB,(3,PBILDUED),(5,P1+23)                               
*--->    MVC   P1+13(10),=C'DUE DATE ='                                         
         MVC   P1+9(L'PP@DUEDT),PP@DUEDT                                        
         MVI   ALLOWLIN,3                                                       
**SEPREG                                                                        
         MVC   RCWHATPR,SREGPASS                                                
**SEPREG                                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
*                                                                               
INVR18   DS    0H                                                               
*                                                                               
         MVC   HALF,PBILKBNO                                                    
         LH    R0,HALF                                                          
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  ILINV(4),DUB+5(3)                                                
         MVI   ILINV+4,C' '                                                     
         CLI   PBRETAIL,X'41'      SUMMARY BILL                                 
         BNE   INVR18C                                                          
         MVI   ILINV+4,C'S'                                                     
         B     INVR19                                                           
*                                                                               
INVR18C  CLI   PBRETAIL,X'81'      CORP CONTROL                                 
         BNE   INVR18D                                                          
         MVI   ILINV+4,C'C'                                                     
         B     INVR19                                                           
*                                                                               
INVR18D  CLC   RCSVAGY,=C'DM'           SPECIAL FOR DOREMUS                     
         BE    INVR18F                                                          
         CLC   RCSVAGY,=C'SJ'           OR SJR                                  
         BNE   INVR19                                                           
INVR18F  MVC   ILINV+4(1),PBILKMED                                              
*                                                                               
INVR19   MVC   W(4),ILINV                                                       
*                                                                               
         MVC   ILPRD,PBILKPRD           PRODUCT                                 
*                                                                               
         MVC   HALF,PBILKEST                                                    
         LH    RF,HALF                                                          
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  ILEST,DUB                                                        
*                                                                               
*                                                                               
INVR20   DS    0H                                                               
         GOTO1 DATCON,DMCB,(3,PBILKMOS),(6,WORK)                                
         MVC   ILPER(3),WORK                                                    
         MVC   ILPER+3(2),WORK+4   YR                                           
*                                                                               
INVR22   DS    0H                                                               
*                                                                               
         MVC   ILTYPE(2),=C'AJ'                                                 
         CLI   PBILSEP,C'A'       ADJ SEP                                       
         BE    INVR22B                                                          
*--->    MVC   ILTYPE(2),=C'CD'                                                 
*                                                                               
         MVC   ILTYPE(2),PP@CD                                                  
*                                                                               
         CLI   PBILSEP,C'C'       CD SEP                                        
         BE    INVR22B                                                          
*--->    MVC   ILTYPE-1(3),=C'AOR'                                              
         MVC   ILTYPE-1(3),PP@AOR                                               
         TM    PBILCMSW,BSTTAORQ  AOR BILL                                      
         BO    INVR22B                                                          
         MVI   ILTYPE-1,C' '                                                    
         MVC   ILTYPE(2),PBILLTYP                                               
*                                                                               
         TM    PBILCMSW,BSTSCOMQ        SEP COMM BILL                           
         BZ    *+8                                                              
         MVI   ILTYPE,C'C'                                                      
*                                                                               
         TM    PBILCMSW,BSTSNETQ        SEP COMM BILL - NET                     
         BZ    *+8                                                              
         MVI   ILTYPE,C'N'                                                      
*                                                                               
INVR22B  CLI   PBRETAIL,0                                                       
         BE    INVR22W                                                          
*                                                                               
         MVC   ILPER+132(6),PBRACCT    RETAIL ACCT NO.                          
         MVC   ILPER+264(6),PBRACCT+6                                           
         B     INVR23                                                           
*                                                                               
INVR22W  DS    0H                                                               
         CLI   PBILADID,C'.'       WB FLIGHT PRESENT?                           
         BNE   INVR23                                                           
         MVC   ILINV+133(2),=C'F='                                              
         MVC   ILINV+135(10),PBILADID+1    FLIGHT CODE                          
*                                                                               
INVR23   DS    0H                                                               
         XC    X(40),X                 WAS 28                                   
*                                  NEW X+28 - OPEN NET                          
*                                  NEW X+32 - MIDAS TRADE CREDITS               
*                                  NEW X+36 - MIDAS COMMISSION                  
*                                                                               
         GOTO1 =V(PPBVAL),DMCB,(C'B',PBILLREC),PPBVALD                          
*                                                                               
*        MOVE "EFFECTIVE" VALUES INTO PBILLREC                                  
*        NOTE - USE PPBVEBC FOR CD                                              
*        NOTE PPBVGST HAS GST                                                   
*             AND PPBVPST HAS PST                                               
*                                                                               
         MVC   PBILLGRS,PPBVEBG                                                 
         MVC   PBILLBIL,PPBVEBB                                                 
         MVC   PBILLNET,PPBVEBN                                                 
*                                                                               
         ZAP   DUB,PBILLBIL        GROSS-CD                                     
         CVB   R0,DUB                                                           
         ST    R0,X           GROSS  - BAMT                                     
         ZAP   DUB,PBILLNET        NET-CD                                       
         CVB   R0,DUB                                                           
         ST    R0,X+4         NET - BNET                                        
         ZAP   DUB,PBILLRCV                                                     
         CVB   R0,DUB                                                           
         ST    R0,X+8         NET - BACTUAL                                     
         ZAP   DUB,PPBVEBC         EFFECTIVE CD                                 
         CVB   R0,DUB                                                           
         ST    R0,X+16             CD                                           
*                                                                               
         CLC   PBILOTH(2),=X'091E'    FIRST CHECK FOR OTHER ELEM                
         BE    INVR23A   (IT WILL ALWAYS BE IN THE SAME PLACE)                  
*                                                                               
         CLC   PBILOTH(2),=X'0920'  OR OTHER ELEM (+TAX)                        
         BNE   INVR23B   (IT WILL ALWAYS BE IN THE SAME PLACE)                  
*                                                                               
INVR23A  TM    PBILLIND,X'83'      SEE IF FINANCIAL (ANY TYPE)                  
         BZ    INVR23B                                                          
         ZAP   DUB,PBILLCNR                                                     
         CVB   R0,DUB                                                           
         ST    R0,X+8              SET TO CONTRACT RECEIVABLE                   
*                                                                               
INVR23A5 ZAP   DUB,PBILLRCV                                                     
         CVB   R0,DUB                                                           
****     TM    PBILLIND,X'02'      SEE IF MIDAS BILL                            
****     BZ    *+8                                                              
****     A     R0,PBILTRCD         ADD TRADE CREDITS                            
         ST    R0,X+20             OPEN (COST2) AMT. DUE                        
         ZAP   DUB,PBILLOPG                                                     
         CVB   R0,DUB                                                           
****     TM    PBILLIND,X'02'      SEE IF MIDAS BILL                            
****     BZ    *+8                                                              
****     A     R0,PBILTRCD         ADD TRADE CREDITS                            
         ST    R0,X+24             OPEN (COST2) GROSS                           
         ZAP   DUB,PBILLOPN                                                     
         CVB   R0,DUB                                                           
         ST    R0,X+28             OPEN (COST2) NET                             
         TM    PBILLIND,X'02'      SEE IF MIDAS BILL                            
         BZ    INVR23B                                                          
         MVC   X+32(4),PBILTRCD    TRADE CREDITS                                
*                                                                               
INVR23B  L     R0,X+4              NET-CD                                       
         A     R0,X+16                                                          
         ST    R0,X+4              NOW NET                                      
*****                                                                           
         L     R0,X                GROSS-CD                                     
         A     R0,X+16                                                          
         ST    R0,X                NOW GROSS                                    
*****                                                                           
         L     R0,X+8              PBILLRCV                                     
         LTR   R0,R0                                                            
         BNP   INVR23C                                                          
         CLI   PBILCDSW,C'C'        CHK FOR SPECIAL CD HANDLING                 
         BNE   INVR23C              NO                                          
         TM    PBILBASA,X'04'       CD IN BASE                                  
         BZ    INVR23C                                                          
         ZAP   DUB,PPBVEBC          "EFFECTIVE" CD                              
         BNP   INVR23C              CD MUST ALSO BE POSTIVE                     
         L     R0,X+8                                                           
         A     R0,X+16              ADD CD BACK TO RECVBL                       
         ST    R0,X+8                                                           
*                                                                               
         CLC   PBILOTH(2),=X'091E'    FIRST CHECK FOR OTHER ELEM                
         BE    INVR23B5  (IT WILL ALWAYS BE IN THE SAME PLACE)                  
*                                                                               
         CLC   PBILOTH(2),=X'0920'   OR OTHER ELEM WITH TAX                     
         BNE   INVR23C   (IT WILL ALWAYS BE IN THE SAME PLACE)                  
*                                                                               
INVR23B5 TM    PBILLIND,X'83'       SEE IF FINANCIAL BILL (ANY TYPE)            
         BZ    INVR23C                                                          
         L     R0,X+20                                                          
         A     R0,X+16              ADD CD BACK TO OPEN RECVBL                  
         ST    R0,X+20                                                          
*                                                                               
INVR23C  DS    0H                                                               
         TM    PBILSTAT,X'20'   SEE IF GRP M MIDAS TRADE                        
         BZ    INVR23C2                                                         
         L     R0,X+28          MIDAS COMM = COST 2 NET - "REAL" NET            
         L     R1,X+4           'REAL' NET                                      
         S     R1,X+16          LESS CASH DISC                                  
         SR    R0,R1            COST2 NET LEES 'REAL' NET-CD                    
         ST    R0,X+36          MIDAS COMMISSION                                
*                                                                               
INVR23C2 ZAP   DUB,PBILLRCV                                                     
*                                                                               
         CLC   PBILOTH(2),=X'091E'    FIRST CHECK FOR OTHER ELEM                
         BE    INVR23C5  (IT WILL ALWAYS BE IN THE SAME PLACE)                  
*                                                                               
         CLC   PBILOTH(2),=X'0920'   OR OTHER ELEM WITH TAX                     
         BNE   INVR23D   (IT WILL ALWAYS BE IN THE SAME PLACE)                  
*                                                                               
*                                                                               
INVR23C5 TM    PBILLIND,X'83'       SEE IF FINANCIAL BILL (ANY TYPE)            
         BZ    INVR23D                                                          
         ZAP   DUB,PBILLCNR         YES - USE CONTRACT RECIEVABLE               
*                                                                               
         TM    PBILLIND,X'82'       SEE IF COST2 EITHER TYPE                    
         BZ    *+10                                                             
         ZAP   DUB,PBILLRCV        USE REAL RCVBL                               
*                                                                               
INVR23D  TM    PBILBASA,X'04'                                                   
         BNZ   INVR23D5                                                         
         SP    DUB,PPBVEBC          SUBTRACT CD OUT NOW                         
*                                                                               
INVR23D5 CLI   PBILSEP,C'C'         SEE IF SEPERATE CD INV                      
         BNE   *+10                                                             
         SR    R0,R0                                                            
         B     *+10                                                             
         SP    DUB,PBILLNET                                                     
         CVB   R0,DUB                                                           
         ST    R0,X+12              EFFECTIVE AGY COMM                          
*                                                                               
*   NOTE - FOR COST2 TYPE FINANCIAL  AGY COMM = OPEN RCVBL                      
*          MINUS CONTRACT NET                                                   
*                                                                               
         TM    PBILSTAT,X'20'       SEE IF MIDAS                                
         BZ    INVR23D8                                                         
         L     R0,X+20              ACTUAL (COST2)                              
         S     R0,X+28              MINUS COST2 NET                             
         ST    R0,X+12              = AGENCY COMMISSION                         
*                                                                               
*   NOTE - FOR MIDAS AGY COMM = OPEN RCVBL                                      
*          MINUS OPEN NET                                                       
*                                                                               
INVR23D8 TM    PBILCMSW,BSTCMONQ    TEST COMMISSION ONLY BILL                   
         BZ    INVR23E                                                          
         MVC   X+12(4),X+8          SET EFF AC = BILL ACTUAL                    
         XC    X+4(4),X+4           CLEAR NET                                   
         B     INVR23E                                                          
**NO-OP                                                                         
**       L     R0,X                 SET AC=GROSS SO NET =0                      
**       L     RF,ADAGY                                                         
**       CLI   PAGYPROF+14-PAGYREC(RF),C'0'                                     
**       BNE   *+8                                                              
**       S     R0,X+16              INCLUDE CD                                  
**       ST    R0,X+4                                                           
*                                                                               
INVR23E  DS    0H                                                               
         TM    PBILCMSW,BSTTAORQ    TEST AOR BILL                               
         BNO   INVR23X                                                          
         MVC   X+12(4),X+8          SET EFF AC = BILL ACTUAL                    
         XC    X+4(4),X+4           CLEAR NET                                   
         B     INVR23X                                                          
***NO-OP***                                                                     
****     TM    PBILCMSW,X'C2'       TEST COMM ONLY BILL                         
***                                ALSO ADJ SEP OR CD SEP                       
***                                                                             
****     BZ    *+10                                                             
****     XC    X+4(4),X+4          IF SO SET NET=0 (COMM = ACTUAL)              
****     L     R0,X+8              ACT                                          
****     S     R0,X+4              -NET                                         
****     A     R0,X+16             PLUS CD                                      
****     ST    R0,X+12             = COMM                                       
****     L     R0,X                GROSS-CD                                     
****     A     R0,X+16                                                          
****     ST    R0,X                NOW GROSS                                    
*                                                                               
INVR23X  DS    0H                                                               
*                                                                               
*        BELIEVE IT OR NOT                                                      
*        X = GROSS                          BILLTOTS+0                          
*        X+4 = NET                          BILLTOTS+8                          
*        X+8 = ACTUAL                       BILLTOTS+16                         
*        X+12 = COMMISSION                  BILLTOTS+24                         
*        X+16 = CD                          BILLTOTS+32                         
*        X+20 = OPEN ACTUAL (RECVBL)        BILLTOTS+40                         
*        X+24 = OPEN GROSS                  BILLTOTS+48                         
*        X+28 = OPEN NET                    BILLTOTS+56                         
*        X+32 = MIDAS TRADE CREDITS         BILLTOTS+64                         
*        X+36 = MIDAS COMMISSION            BILLTOTS+72                         
*                                                                               
INVR24   DS    0H                                                               
***R***                                                                         
*        FINALLY ADD GST AND PST TO X+8 (ACTUAL)                                
         L     R0,X+8                                                           
         A     R0,PPBVGST                                                       
         A     R0,PPBVPST                                                       
         ST    R0,X+8                                                           
*                                                                               
INVR24A  DS    0H                                                               
         CLI   PBILLTYP,C'R'       SEE IF DOING FINANCIAL REBATE BILL           
         BNE   INVR24B                                                          
         XC    X+12(4),X+12        NO COMMISSION ON REBATE REGISTER             
         XC    X+20(4),X+20        NO OPEN ACTUAL FOR REBATE REGISTER           
***R***                                                                         
*                                                                               
INVR24B  DS    0H                  MOVE VALUES FROM X (40)                      
*                                  TO BILLTOTS FOR PRINTING                     
         LA    R3,BILLTOTS         FIRST CLEAR BILLTOTS                         
         BAS   RE,CLRTOTS                                                       
*                                                                               
         LA    R3,X                                                             
         LA    R4,BILLTOTS                                                      
         LA    R1,10               FOR BCT                                      
*                                                                               
INVR24C  L     R0,0(R3)                                                         
         CVD   R0,DUB                                                           
         ZAP   0(8,R4),DUB                                                      
         LA    R3,4(R3)                                                         
         LA    R4,8(R4)                                                         
         BCT   R1,INVR24C                                                       
*                                                                               
INVR24D  BAS   RE,IRFMTL                                                        
         CLI   PBRETAIL,X'81'      TEST CORP CONTROL                            
         BNE   INVR24X                                                          
         LA    R4,ILCOL2-1         YES-* BEFORE ACT                             
         CLI   1(R4),C' '                                                       
         BNE   *+12                                                             
         LA    R4,1(R4)                                                         
         B     *-12                                                             
         MVI   0(R4),C'*'                                                       
INVR24X  DS    0H                                                               
*                                                                               
         LA    R3,BILLTOTS        ROLL TO INVOICE TOTALS                        
         LA    R4,IRITOTS                                                       
         BAS   RE,ROLTOTS                                                       
*                                                                               
         L     R4,DBTOTS           ADD TO BILL COUNTER                          
         LA    R4,1(R4)                                                         
         ST    R4,DBTOTS                                                        
*                                                                               
         CLI   PBRETAIL,X'81'      DONT ADD FOR CORP CONTROL                    
         BE    INVR26                                                           
*                                                                               
         LA    R3,BILLTOTS        ROLL TO CLIENT TOTALS                         
         LA    R4,IRCTOTS                                                       
         BAS   RE,ROLTOTS                                                       
*                                                                               
         LM    R3,R6,IRCTOTS       ROLL TO CLIENT TOTALS                        
*                                                                               
INVR26   DS    0H                                                               
         MVI   ALLOWLIN,3                                                       
         MVC   KEY1,PBILLKEY                                                    
         MVC   BINVDTE,PBILINVD                                                 
         MVC   BDUEDTE,PBILDUED                                                 
**SEPREG                                                                        
         MVC   RCWHATPR,SREGPASS                                                
**SEPREG                                                                        
         GOTO1 =A(PRNT)                                                         
         B     INVR2                                                            
*                                                                               
INVR29   DS    0H            END OF OUT - DATASET                               
         MVI   PBILLREC,X'FF'                                                   
         MVC   PBILLREC+1(24),PBILLREC                                          
         B     INVR3AX                                                          
*                                                                               
INVR30   TM    AORSW,X'02'         SEE IF I JUST DID AOR REGISTER               
         BO    INVR30S             YES - THEN DONE                              
         TM    AORSW,X'01'         SEE IF AOR BILLS FOUND                       
         BNO   INVR30S             NO - THEN NO AOR REGISTER                    
         OI    AORSW,X'02'         NO DO AOR REGISTER                           
         B     INVR04                                                           
**SEPREG                                                                        
*                                                                               
INVR30S  CLI   SREGPASS,2          DID I JUST DO SECOND PASS?                   
         BE    INVRX               FINALLY DONE                                 
         CLI   SEPREG,C'Y'         BILL FOR SEPARATE REGISTER EXISTS            
         BNE   INVRX               NO - THEN ALSO DONE                          
*                                                                               
*        SET 2 REPORT OPTION HERE                                               
*        REPORTS=2 LINE SHOULD NOT BE IN THE JCL                                
*        OTHERWISE EMPTY SEPARATE REGISTER ENTRIES MAY                          
*        BE CREATED WHEN DESTINATION= LINES ARE IN THE JCL                      
*                                                                               
         L     R1,VMASTC                                                        
         USING MASTD,R1                                                         
         MVI   MCREPTS,2                                                        
         DROP  R1                                                               
*                                                                               
         MVI   AORSW,0                                                          
         MVI   SREGPASS,2          NOW DO SECOND PASS                           
         XC    KEY1,KEY1                                                        
         B     INVR04                                                           
**SEPREG                                                                        
**       MVC   SAVEDA,SAVR1        MUST RESTORE FIRST DISK ADDR                 
**       B     INVR1                                                            
*                                  FORMAT AMOUNTS                               
         SPACE 3                                                                
IRFMTL   NTR1                                                                   
         SPACE 2                                                                
         LA    R3,BILLTOTS+16      ACTUAL                                       
         CLI   MIDASSW,C'Y'                                                     
         BNE   *+8                                                              
         LA    R3,BILLTOTS+40      FOR MIDAS DISPLAY COST2 HERE                 
*                                                                               
         LA    R5,ILCOL1                                                        
         BAS   RE,IRFEDT                                                        
         ZAP   MYDUB,BILLTOTS+8(8)     NET                                      
         L     RF,ADAGY                                                         
         CLI   PAGYPROF+14-PAGYREC(RF),C'0'                                     
         BNE   *+10                                                             
         SP    MYDUB,BILLTOTS+32(8)  SUBTRACT CD                                
         LA    R3,MYDUB                                                         
         LA    R5,ILCOL2                                                        
         BAS   RE,IRFEDT                                                        
*                                                                               
         LA    R3,BILLTOTS+24      COMMISSION                                   
         LA    R5,ILCOL3                                                        
         BAS   RE,IRFEDT                                                        
         LA    R3,BILLTOTS+0       GROSS                                        
         LA    R5,ILCOL4                                                        
         BAS   RE,IRFEDT                                                        
         LA    R3,BILLTOTS+32      CD                                           
         LA    R5,ILSTRIP                                                       
         BAS   RE,IRFEDT                                                        
*                                                                               
         CLI   MIDASSW,C'Y'      SEE IF A MIDAS CLT PROCESSED                   
         BE    IRFMTL2                                                          
*                                                                               
         CP    BILLTOTS+40(8),=P'0'   CHK FOR OPEN ACTUAL (RECVBL)              
         BE    IRFMTL5                                                          
IRFMTL2  LA    R3,BILLTOTS+40                                                   
*--->    MVC   ILCOL1+127(5),=C'OPEN='                                          
         MVC   ILCOL1+127(L'PP@OPEN),PP@OPEN                                    
**CARAT                                                                         
         CLI   ROPENSW,C'Y'                                                     
         BE    *+10                                                             
*******  CLC   RCSVAGY,=C'UB'                                                   
*******  BNE   *+10                                                             
         MVC   ILCOL1+127(5),=C'COST2'                                          
*                                                                               
         CLI   MIDASSW,C'Y'      SEE IF A MIDAS CLT PROCESSED                   
         BNE   *+10                                                             
         MVC   ILCOL1+127(5),=C'MIDAS'                                          
*                                                                               
         LA    R5,ILCOL1+132      PUT IN SECOND LINE                            
         BAS   RE,IRFEDT                                                        
*                                                                               
*                                                                               
IRFMTL5  CLI   MIDASSW,C'Y'      SEE IF A MIDAS CLT PROCESSED                   
         BE    IRFMTL7                                                          
*                                                                               
         CP    BILLTOTS+48(8),=P'0'  CHK FOR OPEN GROSS                         
         BE    INVRX                                                            
IRFMTL7  LA    R3,BILLTOTS+48                                                   
         CLI   MIDASSW,C'Y'      SEE IF A MIDAS CLT PROCESSED                   
         BE    IRFMTL7X                                                         
*--->    MVC   ILCOL4+127(5),=C'OPEN='                                          
         MVC   ILCOL4+127(L'PP@OPEN),PP@OPEN                                    
**CARAT                                                                         
         CLI   ROPENSW,C'Y'                                                     
         BE    *+10                                                             
******** CLC   RCSVAGY,=C'UB'                                                   
******** BNE   *+10                                                             
         MVC   ILCOL4+127(5),=C'COST2'                                          
*                                                                               
IRFMTL7X LA    R5,ILCOL4+132      PUT IN SECOND LINE                            
         BAS   RE,IRFEDT                                                        
*                                                                               
         CLI   MIDASSW,C'Y'      SEE IF MIDAS CLT PROCESSED                     
         BNE   INVRX                                                            
         LA    R3,BILLTOTS+56     COST2 NET                                     
         LA    R5,ILCOL2+132                                                    
         BAS   RE,IRFEDT                                                        
         LA    R3,BILLTOTS+72     MIDAS COMM.                                   
         LA    R5,ILCOL3+132      (UNDER AGY COM)                               
         BAS   RE,IRFEDT                                                        
         LA    R3,BILLTOTS+64     TRADE CREDITS                                 
         LA    R5,ILSTRIP+132                                                   
         BAS   RE,IRFEDT                                                        
         B     INVRX                                                            
         SPACE 2                                                                
IRFEDT   DS    0H                                                               
         ST    RE,DUB                                                           
*--->    EDIT  (R0),(16,0(R5)),2,COMMAS=YES,CR=YES                              
         CURED (P8,0(R3)),(16,0(R5)),CURTAB,COMMAS=YES,CR=YES                   
         TM    FLAG1,NOSTAR                                                     
*        CLI   NOSTAR,C'Y'         SUPPRESS ** ON TOTALS?                       
         BO    *+18                                                             
         CLI   14(R5),C' '                                                      
         BNE   *+10                                                             
         MVC   14(2,R5),TOTSTAR                                                 
         MVC   TOTSTAR,SPACES                                                   
         L     RE,DUB                                                           
         BR    RE                                                               
         SPACE 2                                                                
INVRX    DS    0H                                                               
         DROP  R8                                                               
         XIT1                                                                   
         SPACE 3                                                                
ROLTOTS  DS    0H                                                               
         LA    R0,10          FOR BCT                                           
ROLTOTS2 DS    0H                                                               
         AP    0(8,R4),0(8,R3)                                                  
         LA    R4,8(R4)                                                         
         LA    R3,8(R3)                                                         
         BCT   R0,ROLTOTS2                                                      
         BR    RE                                                               
         SPACE 3                                                                
CLRTOTS  DS    0H                                                               
         LA    R0,10                                                            
         ZAP   0(8,R3),=PL8'0'                                                  
         LA    R3,8(R3)                                                         
         BCT   R0,*-10                                                          
         BR    RE                                                               
*                                                                               
*                                                                               
*        NOTE- MEDIA NAMES NOW GOTTEN FROM AGY HEADER                           
*        ENTRY FOR EACH MEDIA STILL REQUIRED THOUGH                             
*                                                                               
         SPACE 3                                                                
MEDLIST  DS    0C                                                               
MEDMOB   DC    C'BMOBILE    '                                                   
MEDNATV  DC    C'VNAT. VIDEO'                                                   
MEDLOCV  DC    C'WLOC. VIDEO'                                                   
MEDSOCL  DC    C'LSOCIAL    '                                                   
MEDNEWS  DC    C'NNEWSPAPERS'                                                   
MEDMAG   DC    C'MMAGAZINES '                                                   
MEDTRD   DC    C'TTRADE     '                                                   
MEDINTR  DC    C'IINTERACTV '                                                   
MEDSPL   DC    C'SSUPLEMENTS'                                                   
MEDOUT   DC    C'OOUTDOOR   '                                                   
MEDAUDIO DC    C'DDIG. AUDIO'                                                   
         DC    X'FFFF'                                                          
         SPACE 3                                                                
MYDUB    DS    PL8                                                              
         DS    0D              FOR ALIGNMENT                                    
BILLTOTS DS    10PL8                                                            
IRITOTS  DS    10PL8                                                            
IRCTOTS  DS    10PL8                                                            
IRMTOTS  DS    10PL8                                                            
*                                                                               
         SPACE 2                                                                
       ++INCLUDE PPBVALD                                                        
*                                                                               
         LTORG                                                                  
*                                                                               
ROPENSW  DC    C'N'                                                             
*                                                                               
*        LIST OF FINANCIAL AGENCIES - IF NOT IN THIS TABLE                      
*        "OPEN" REGISTER AMOUNCS WILL DISPLAY AS "COST2"                        
*                                                                               
FAGYTAB  DC    C'DMMKMXWIWJWTXD'                                                
         DC    X'FF'          END OF TABLE                                      
         SPACE 2                                                                
         DROP  R2,R7                                                            
         TITLE 'RDBUFF - READ BUFFER'                                           
*                                                                               
*  CHANGE LOG                                                                   
*                                                                               
*  BPLA   12/00    PUBFRST CSECT RENAMED TO FSTPUB                              
*                  TO AVOID DUPLICATE TAGS                                      
*                  CHANGE ALSO MADE IN PPREPB12A                                
*                  IN V(PUBFRST) - NOW V(FSTPUB)                                
*                                                                               
*  BPLA   08/00    COPY OF PPREPB12C AT LEVEL 40 7/20/00                        
*                  COPY MADE 8/16/00                                            
*                  CHANGES TO CATALP AND PPREPB1WKN                             
*                  (WHICH INCLUDES PNNEWFILE IN PLACE OF                        
*                  PPNEWFILE)                                                   
*                  PNNEWFILE INCLUDES PNBILREC IN PLACE                         
*                  OF PBILLREC                                                  
*                                                                               
*   BPLA   07/00  FIX BUG IN COST2 CHECKING                                     
*                                                                               
*   BPLA   07/00  CHANGES FOR NEW PPNEWFILE - SEE **PPNEW                       
*                                                                               
*   BPLA   05/00  USE AORWRK  INSTEAD OF PCONREC                                
*                                                                               
*   BPLA   01/00  CHECK FOR NEW VALUE FOR PAYOPT (D)                            
*                                                                               
*   BPLA   12/99  ALLOW THE DISPLAY OF ON-SALE DATES FOR                        
*                 NEWSPAPERS (THEY MAY NOW EXIST) IN LDESC                      
*                                                                               
*   BPLA   9/99   CHANGE SO VARIOUS ABREVIATIONS FOR INTERACTIVE                
*                 WILL ALL PRINT AS "INTERACTIVE" (IN FMED)                     
*                 FMED MOVED TO IT'S OWN CSECT                                  
*                                                                               
*   BPLA   6/99   CHANGES FOR COST2 FEATURE                                     
*                                                                               
*   BPLA   6/99   COPY OF PPB12C LEVEL 21 MADE 6/15/99                          
*                                                                               
*   BPLA   5/99   SAVE FORMULA EVEN IF USING BILLING FORMULA                    
*                 RECORDS - I STILL NEED COMMENTS                               
*                                                                               
*   BPLA   1/99   NEW OPTION ON B2B PROFILE (+11)                               
*                 TO DISPLAY NEWSPAPER UNIT RATES AT NET                        
*                 (LIKE OPTION ON P52, PEC, P53)                                
*                                                                               
*   BPLA   10/98  CODE TO CHECK FOR PRINTABLE USER FIELDS                       
*                 AT FRONT OF INVOICE                                           
*                                                                               
*   BPLA   10/98  RENAMED FROM PPB12CE                                          
*                                                                               
*   BPLA   8/98   CHANGES FOR SFM BILLING FORMULA RECS                          
*                                                                               
*   BPLA   3/98   ADD MEDIA COUNT FOR MULTI-MEDIA REQ                           
*                 AND SUPPRESS AD CODE TOTALS IF ONLY ONE MEDIA                 
*                                                                               
*   BPLA   1/98   CHANGES FOR EDI BILLING                                       
*                                                                               
*   BPLA  12/97   ADD DUMMY CSECT AT END                                        
*                                                                               
*   BPLA  9/97    IN GETAOR USE AMED FOR MEDIA                                  
*                IN MULT-MEDIA REQUESTS                                         
*                 IF PRD AND/OR ESTIMATE ARE                                    
*                 ON SEPERATE BILLS FOR MULTI-MEDIA                             
*                 REQUEST I MUST GO TO AGETAOR IN FMED                          
*                                                                               
*   BPLA 5/97     FOR WESTERN OPTION DISPLAY COLOR                              
*                 PREMIUM WITHOUT COST                                          
*                                                                               
*   BPLA   5/97   FIX DISPLAY OF PRODUCT ACCOUNT (IN X)                         
*                                                                               
*   BPLA   5/97   WESTERN OPTIONS TO SUPPRESS COSTS                             
*                                                                               
*   BPLA   5/97   FOR MULTI-MEDIA REQUESTS I MUST                               
*                 READ FOR AAA FORMULAS AT FMED                                 
*                 - CODE COPIED FROM PPB12AO IN CFIRST                          
*                                                                               
*   BPLA  10/96   NEW VERSION TO SUPPORT                                        
*                 1) STANDARD COMMENTS ON AOR BILLS                             
*                 2) SUPPRESSING ZONE/EDITION (NOZEOPT)                         
*                 3) RETAIL DRAFT BILLING - ERRORS ONLY                         
*                    RD1OPT = "E"                                               
*                                                                               
*   BPLA  9/96    PPB12CO SOURCE MADE LIVE - NOW INCLUDES PPREPB1WRK            
*                 NEEDS PPB1ACC                                                 
*                                                                               
*   BPLA 7/96     IF UPASS = "S" (CORP SUMMARY) (NOW X'FF')                     
*                 SKIP DIV IN FPGR1 AND LPGR1                                   
*                 IF QPUB+1 = RD=                                               
*                                                                               
*   BPLA 4/96     SPECIAL CHANGE FOR ZENITH - MOLSON                            
*                                                                               
*   BPLA 3/95     IF MARKETS ARE ON SEPERATE INVS                               
*                 PRINT MARKET AT RB16I INSTEAD OF FMKT                         
*                                                                               
*   BPLA 6/94     AT LPERG RESET PERCTL TO 'T' IF PRIOR IS 'M'                  
*                 SINCE IT AMY HAVE BEEN ALTERED TO 'S' AT FPERG                
*                                                                               
*   BPLA 6/94     SPECIAL CODE AROUND SOME GOTO GETNUMS                         
*                                                                               
*   BPLA 6/94     CHANGES IN FPRD AND FEST                                      
*                 FPRD MOVED TO ITS OWN CSECT                                   
*                 IN FPRD IF EST IS HIGHER THAN PRD                             
*                 READ EST FOR BILL FORMULA                                     
*                 ALSO FPRD NAD FEST NOW ALWAYS SET BILL FORMULAS               
*                 THEY USED NOT TO IF THEY WERE NOT BEING SHOWN                 
*                                                                               
*   BPLA 1/94     CHANGES FOR PST                                               
*                                                                               
*  BPLA 10/18/93  AT PUBFRST CLEAR PUB LINES                                    
*                                                                               
*  BPLA 10/14/93  CHANGE IN LPUB TO HANDLE DETAIL BACK-UP AT                    
*                 PUB LEVEL (PROGPRO2+7=7)                                      
*                                                                               
*  BPLA 10/20/92  CADDRS MOVED FROM BILWRK TO RDBUFF (AFTER LTORG)              
*                 SINCE I RAN OUT OF ROOM IN SPACEND (BILWRK)                   
*  BPLA 9/21/92  "FREE" DATE CHECK CHANGED FROM AUG01/92 TO SEP01/92            
*                                                                               
*  BPLA 7/9/92   CHANGES TO CHECK PBBILST (IN PBILELEM) FOR UFC BILLING         
*                INSTEAD OF X'46' ELEMENTS                                      
*                                                                               
*  BPLA 6/16/92  REMOVE CHK FOR SCBNCSW = C'N' IN GETAOR                        
*                                                                               
*  BPLA 4/30/92  ROUND PERCENTAGE BILLING + COMMISSION BILLING CHANGES          
*                                                                               
*  BPLA 4/20/92  CHANGES FOR "FREE" INSERTIONS                                  
*                                                                               
*  BPLA 4/20/92  COPY OF PPB12CL                                                
*                                                                               
*  BPLA 4/1/92   IN RB6B4 DON'T APPLY MANPCT TO PREVIOUS IF PCTCTL = F          
*                ALSO DON'T APPLY TO PREVIOUS MANUAL BILLING                    
*                                                                               
*  BPLA 1/24/92  GOTO FOR AGETAOR MOVED FROM BEGINNING OF FPRD TO FPRD3         
*  BPLA 1/21/92  CHANGES TO HANDLE MIX TO AOR PCTS                              
*  BPLA 7/29/91  NEW VALUES FOR PEOVOPT                                         
*               S= USE PRD/EST CHAB DATA AND SUBTRACT CD FROM STRIP-OFF         
*               D= SAME AS 'S' BUT DON'T SUBTRACT CD FROM STRIP-OFF             
*      NOTE -   Y STILL USES AGENCY HEADER PROFILE                              
*                                                                               
*  BPLA 5/16/91  GRANT'S AOR CHANGES FOR AOR KILLDATE AND VAT CODE              
*                ALSO SAVE PRINTING BILL FORMULA OVERRIDES                      
*                IN TOTAL ROW  (BFPBASB AND BFPCOMP)                            
*                                                                               
*                                                                               
*  BPLA 3/26/91  DRAFT REBATE BILLING - RD                                      
*                                                                               
*  BPLA 3/12/91  GRANT'S AOR CHANGES AORLOPT,AORTXOPT                           
*                                                                               
         PRINT NOGEN                                                            
*                                  READ BUFFER                                  
         SPACE 2                                                                
RDBUFF   NMOD1 0,RDBUFF,R8                                                      
************************  NOTE USE OF R8 AS SECOND BASE REGISTER                
*                                                                               
         USING PPWORKD,RA                                                       
         L     R9,PPWORK2C                                                      
         USING PPWORK2D,R9                                                      
         LA    RC,SPACEND                                                       
         USING BILWRKD,RC                                                       
         SPACE 2                                                                
         MVI   UPASS,0                                                          
         MVC   SVMKTCTL,MKTCTL                                                  
*                                  SET LENGTH OF INV BRK                        
         L     R3,AINVBRK                                                       
         USING BRKTABD,R3                                                       
         L     RF,BRKDISP                                                       
         A     RF,BRKLENM1                                                      
         ST    RF,INVBKLEN                                                      
*                                                                               
RB0      DS    0H                                                               
         CLI   SORTTRCE,C'Y'                                                    
         BNE   *+8                                                              
         MVI   RCTRACE,C'Y'                                                     
         XC    SORTREC,SORTREC                                                  
         XC    THISREC,THISREC                                                  
         XC    OLDREC,OLDREC                                                    
         XC    PASSREC,PASSREC                                                  
*                                                                               
         LA    R1,12                                                            
         LA    RE,BIGTOTS           PACKED ACCUMS                               
         LA    RF,BIGTOTST                                                      
RB0P2    ZAP   0(6,RE),=P'0'                                                    
         ZAP   0(6,RF),=P'0'                                                    
         LA    RE,6(RE)                                                         
         LA    RF,6(RF)                                                         
         BCT   R1,RB0P2                                                         
**NEW 3/12/91                                                                   
RB0P5    CLI   AORLOPT,C'C'                                                     
         BE    *+10                                                             
**NEW 3/12/91                                                                   
         XC    PEPTABN,PEPTABN     CLEAR PRD-EST-PER TAB                        
         XC    PRDFORM,PRDFORM                                                  
         XC    ESTFORM,ESTFORM                                                  
         XC    AAEFORM,AAEFORM                                                  
         XC    CVATPSWS,CVATPSWS    CLEAR PRD VAT MIX SWITCHES                  
         MVC   LASTPRD,=X'FFFFFF'                                               
*                                                                               
         CLC   AMKTBRK,AINVBRK                                                  
         BNH   RB1                                                              
         OC    AMGR1BRK,AMGR1BRK                                                
         BZ    RB1B                                                             
         CLC   AMGR1BRK,AINVBRK                                                 
         BH    RB1B                                                             
RB1      DS    0H                  IF MKT OR MGR ON SEP BILL                    
         MVI   ORIGTYPE,C'0'       OVERRIDE OPTION NOT TO DETAIL MARK           
RB1B     DS    0H                                                               
         MVI   BILSW,C'N'                                                       
         MVI   NDUES,0                                                          
*                                                                               
         BAS   RE,SETPASS0         ALWAYS START WITH PASS 0                     
*                                                                               
RB2      DS    0H                                                               
         GOTO1 BUFFALO,DMCB,=C'HIGH',ABUFFC,THISREC,0                           
         B     RB4B                                                             
RB4      DS    0H                                                               
         GOTO1 BUFFALO,DMCB,=C'SEQ',ABUFFC,THISREC,0                            
RB4B     DS    0H                                                               
         LA    R3,BRKTAB                                                        
         USING BRKTABD,R3                                                       
         TM    DMCB+8,X'80'        EOF                                          
         BZ    RB6                                                              
         MVI   THISREC,X'FF'                                                    
         MVC   THISREC+1(L'THISREC-1),THISREC                                   
         OC    SORTREC,SORTREC                                                  
         BZ    RB20                DONE IF NO DATA                              
         B     RB8                                                              
*                                                                               
RB6      DS    0H                                                               
         CLI   UCOMMSW,C'Y'       EST UCOMM REQUIRED?                           
         BNE   RB6UDEF                                                          
         MVI   BYTE,C'C'                                                        
         BAS   RE,CHKSKIP          CHK EST IN UPETAB                            
         CLI   DUB,1                                                            
         BE    RB4                 MEANS SKIP THIS RECORD                       
*                                                                               
RB6UDEF  DS    0H                                                               
         CLI   UDEFESW,0          EST UDEFS REQUIRED?                           
         BE    RB6PAY                                                           
         MVI   BYTE,C'C'                                                        
         BAS   RE,CHKSKIP          CHK EST IN UPETAB                            
         CLI   DUB,1                                                            
         BE    RB4                 MEANS SKIP THIS RECORD                       
*                                 SEE IF SKIPPING UNPAID ESTS                   
*                                 PAYOPTS E,F,G                                 
RB6PAY   DS    0H                                                               
         CLI   PAYOPT,C'E'                                                      
         BL    RB6A                                                             
         CLI   PAYOPT,C'G'                                                      
         BH    RB6A                                                             
         MVI   BYTE,C'U'                                                        
         BAS   RE,CHKSKIP          CHK EST IN UPETAB                            
         CLI   DUB,1                                                            
         BE    RB4                 MEANS SKIP THIS RECORD                       
*                                                                               
RB6A     L     RF,ASORTDTA         POINT TO DATA                                
         LA    R0,SORTREC                                                       
         SR    RF,R0                                                            
         LA    RF,THISREC(RF)      POINT TO DATA IN THISREC                     
*                                                                               
         CLI   UPASS,X'FF'         FOR SUMMARY PASS  - WAS C'S'                 
         BNE   RB6B                                                             
         MVC   SORTREC,THISREC                                                  
         L     R6,ASORTCOM         SKIP ANYTHING WITHOUT INV. NO                
         CLC   0(2,R6),TODAYB      TODAY'S DATE (Y/M)                           
         BNE   RB5                                                              
         L     R6,APUB                                                          
         OC    0(6,R6),0(R6)                                                    
         BNZ   RB5                 PUB MUST ALSO BE BLANK                       
         L     R6,APRD             ALSO FILTER ON PRODUCT                       
         CLC   SAVPRD,0(R6)                                                     
         BE    RB6B                                                             
*                                                                               
RB5      DS    0H                                                               
         B     RB4                                                              
*                                                                               
RB6B     DS    0H                                                               
         OC    0(ROW2L,RF),0(RF)   SKIP NULL ITEMS                              
         BZ    RB4                                                              
         CLI   PASSNO,2            SEE IF BACK-UP PASS                          
         BNE   RB6B2                                                            
         OC    ARECAP,ARECAP       JUST IN CASE                                 
         BZ    RB6B2                                                            
*                                                                               
         CLI   FINANSW,X'03'       CHECK FOR COST 2 OPTIONS                     
         BE    RB6B0                                                            
         TM    FINANSW,X'80'                                                    
         BO    RB6B0                                                            
         B     RB6B1                                                            
*                                                                               
RB6B0    CLI   FREEOPT,C'C'   SKIP ZERO COST2 INSERTIONS                        
         BNE   RB6B1          ON DETAIL BACK-UP                                 
         CLC   OGDSP(16,RF),OBGDSP(RF) CHK FOR OPEN BILLABLE                    
         BNE   RB6B2                                                            
         B     RB4                                                              
*                                                                               
RB6B1    CLI   ZUOPT,C'B'          SEE IF SHOWING                               
         BNE   RB6B2               ONLY BILLABLE ITEMS ON BACK-UP               
         CLC   0(16,RF),BGDSP(RF)                                               
         BNE   RB6B2                                                            
         CLC   OGDSP(16,RF),OBGDSP(RF) CHK FOR OPEN BILLABLE                    
         BNE   RB6B2                                                            
         CLC   OTRDC(4,RF),OBTRDC(RF) CHK FOR TRD CREDIT BILLABLE               
         BE    RB4                 TOTALLY BILLED SO SKIP                       
***TAX   NOTE - CHECK ABOVE DOES NOT CATCH ONLY BILLABLE TAX                    
***TAX          THIS SHOULD NOT OCCUR SINCE THE TAX PCT.                        
***TAX          WILL NOT BE PERMITTED TO CHANGE ON BILLED INSERTIONS            
***TAX        ALSO THERE MAY BE DISCREPANCIES IN TAX DUE TO ROUNDING            
*                                                                               
*                                                                               
RB6B2    DS    0H                                                               
         OC    MANPCT,MANPCT       TEST PCT= REQUEST                            
         BZ    RB6C                NO                                           
*                                  YES - TAKE PCT OF GROSS + NET                
         MVI   X,0                                                              
RB6B4    CLI   X,2                                                              
         BE    RB6C                                                             
         L     R5,GDSP(RF)         GROSS                                        
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,GDSP(RF)                                                      
****     CLI   PCTNET,C'N'                                                      
****     BE    *+20                                                             
         L     R5,NDSP(RF)         NET                                          
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,NDSP(RF)                                                      
         L     R5,CDSP(RF)         CD                                           
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,CDSP(RF)                                                      
         L     R5,ADSP(RF)         AC                                           
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,ADSP(RF)                                                      
***TAX                                                                          
         L     R5,TDSP(RF)          TAX                                         
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,TDSP(RF)                                                      
***TAX                                                                          
*                                                                               
         CLI   PCTCTL,C'F'            SEE IF NOT APPLYING PCT TO PREV           
         BE    RB6B8                                                            
*                                                                               
         L     R5,APUB          DON'T APPLY PCT TO PREVIOUS MANUAL              
         CLC   0(6,R5),XXPUB          BILLING                                   
         BE    RB6B8                                                            
*                                                                               
         L     R5,ROWHL(RF)           BILLED GRS                                
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,ROWHL(RF)                                                     
*****    CLI   PCTNET,C'N'            SKIP NET                                  
*****    BE    *+20                                                             
         L     R5,ROWHL+NDSP(RF)        BILLED NET                              
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,ROWHL+NDSP(RF)                                                
         L     R5,ROWHL+CDSP(RF)        BILLED CD                               
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,ROWHL+CDSP(RF)                                                
         L     R5,ROWHL+ADSP(RF)        BILLED AC                               
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,ROWHL+ADSP(RF)                                                
***TAX                                                                          
         L     R5,ROWHL+TDSP(RF)         BILLED TAX                             
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,ROWHL+TDSP(RF)                                                
*                                                                               
RB6B8    ZIC   R1,X                                                             
         LA    R1,1(R1)                                                         
         STC   R1,X                                                             
         LA    RF,ROWTL(RF)            NOW DO OPEN ACCUMS                       
         B     RB6B4                                                            
*                                                                               
PCMDIV   L     R2,=F'10000'                                                     
         DRNDR (R4),(R2)                                                        
         BR    RE                                                               
*                                                                               
*                                                                               
RB6C     DS    0H                                                               
         MVC   SORTREC,THISREC                                                  
RB7      DS    0H                                                               
         OC    OLDKEY,OLDKEY       IF FIRST TIME                                
         BZ    RB15                BYPASS BREAK TEST                            
         OC    BRKCODE,BRKCODE                                                  
         BNZ   *+6                                                              
         DC    H'0'                DUPE KEY                                     
         L     R6,BRKDISP                                                       
         LA    R7,OLDKEY(R6)                                                    
         LA    RE,THISKEY(R6)                                                   
         L     RF,BRKLENM1                                                      
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R7),0(RE)                                                    
         BNE   RB8                                                              
         LA    R3,BRKL(R3)                                                      
         B     RB7                                                              
*                                                                               
RB8      DS    0H                                                               
*                                  'LAST' BREAKS                                
         ST    R3,ATHISBRK         SAVE THIS BRK                                
         CLI   PASSNO,0            IF PASS 0                                    
         BNE   RB8B                                                             
         C     R3,AINVBRK          AND INV BRK                                  
         BH    RB18                                                             
*                                                                               
*                                  END OF INVOICE ON PASS 0                     
*                                  (MEANS THIS IS A 'ZERO' BILL)                
*                                                                               
*                                  SHOULD I PRODUCE IT                          
*                                                                               
         CLC   TYPE,ZBOPT          NOT IF NOT RIGHT TUPE                        
         BNE   RB8A4                                                            
*                                                                               
         CLI   PRIOR,C'T'          NOT IF MULTI MONTH BILLS                     
         BE    RB8A4                                                            
         CLI   PRIOR,C'V'          25 TOGETHER                                  
         BNL   RB8A4                                                            
         CLI   PRIOR,C'1'                                                       
         BNL   RB8A4                                                            
*                                                                               
         CLI   ESTQ,C'1'       SINGLE ESTIMATE REQ?                             
         BNE   RB8A0                                                            
*                                                                               
         CLI   CURSW,C'Y'      CHECK FOR ANY CURRENT MONTH PROCESSING           
         BNE   RB8A4                                                            
         B     RB8A1                                                            
*                                                                               
RB8A0    L     RF,ASORTDTA         CHECK IF OLDREC HAS ANYTHING                 
         LA    RE,SORTREC                                                       
         SR    RF,RE               DO 'OC' ONLY FOR KEY & COMMENT               
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         OC    OLDREC(0),OLDREC                                                 
         L     RE,APER                                                          
         BZ    *+8                                                              
         LA    RE,OLDREC-SORTREC(RE)      USE 'OLDREC' PERIOD                   
         ZIC   RF,0(RE)                                                         
         MH    RF,=H'8'                                                         
         LA    RF,PERLIST(RF)                                                   
         CLC   CURPER,0(RF)                                                     
         BNE   RB8A4                                                            
****                                                                            
****     OLD CODE                                                               
*                                  ONLY FOR REQUESTED MONTH                     
**NO-OP  L     RE,APER                                                          
***      LA    RE,OLDREC-SORTREC(RE)      USE 'OLDREC' PERIOD                   
***      ZIC   RF,0(RE)                                                         
***      MH    RF,=H'8'                                                         
***      LA    RF,PERLIST(RF)                                                   
***      CLC   CURPER,0(RF)                                                     
***      BNE   RB8A4                                                            
*                                                                               
*                                  PRODUCE ZERO BILL                            
RB8A1    BAS   RE,SETPASS1                                                      
         BAS   RE,SETRET                                                        
         MVI   ZEROSW,C'Y'         SET PRODUCING ZERO BILL NOW                  
         B     RB14D                                                            
*                                                                               
RB8A4    DS    0H                  DO NOT PRODUCE BILL                          
         MVC   PASSREC,THISREC     SET RESTART POINT                            
         B     RB18                                                             
RB8B     DS    0H                                                               
         L     R3,ALOWBRK                                                       
         MVC   SORTREC,OLDREC                                                   
         CLI   UPASS,X'FE'       SKIP 'LASTS' FOR TEST PASS (WAS C'T')          
         BE    RB10B                                                            
         CLI   RETSKIP,C'Y'        OR IF NO SHARE FOR OUTLET/SCHEME             
         BE    RB10B                                                            
*                                  AT LOWEST LEVEL PUT INTO TOTALS              
         L     R1,APER                                                          
         ZIC   RF,0(R1)                                                         
         MH    RF,=Y(ROWL)         RF = DISP INTO ACCUM                         
         L     RE,BRKCODE                                                       
         A     RF,ATOTS(RE)      POINT TO THIS ACCUM                            
         L     R7,ASORTDTA                                                      
*                                                                               
RB8C     DS    0H                                                               
         MVC   0(ROW2L,RF),0(R7)  FOR FINANCIAL MOVE CONTRACT+OPEN              
*                                                                               
         L     R7,ATOTS(RE)                                                     
         AH    R7,=Y(MAXMOS*ROWL)       POINT TO TOTAL ROW                      
*                                                                               
*        SPECIAL TOTALS FOR H7 + CLT ATE                                        
*                                                                               
         CLI   H7ATTSW,C'Y'                                                     
         BNE   RB8X                                                             
*                                                                               
         ST    RF,FULL             SAVE THIS REGISTER                           
         LA    RE,BIGTOTS          PACKED ACCUMS FOR PILCALC                    
         LA    R0,12               GRS/NET/CD/AC/TAX/INS                        
RB8H7    DS    0H                  ORDERED AND BILLED                           
         L     R1,0(RF)                                                         
         CVD   R1,DUB                                                           
         AP    0(6,RE),DUB                                                      
         LA    RE,6(RE)                                                         
         LA    RF,4(RF)                                                         
         BCT   R0,RB8H7                                                         
         L     RF,FULL             RESTORE RF                                   
*                                                                               
RB8X     LA    R0,24                                                            
RB9      DS    0H                                                               
         L     R1,0(R7)                                                         
         A     R1,0(RF)                                                         
         ST    R1,0(R7)                                                         
         LA    R7,4(R7)                                                         
         LA    RF,4(RF)                                                         
         BCT   R0,RB9                                                           
*                                                                               
RB9A     CLI   PASSNO,1            FOR PASS 1                                   
         BNE   RB9B                                                             
         CLI   CVATCOD,0           AND IF DOING VAT                             
         BE    RB9B                                                             
         GOTO1 =A(VBADD),DMCB,SORTREC,BRKTABD  ADD TO GST/PST BASES             
*                                                                               
RB9B     DS    0H                                                               
*                                                                               
*                                  AND PUT INV NO. INTO INV LIST                
         L     R5,APER                                                          
         ZIC   RF,0(R5)                                                         
         MH    RF,=H'8'                                                         
         LA    RF,INVLIST(RF)                                                   
         L     R5,ASORTCOM         A(INV NO)                                    
         OC    0(4,R5),0(R5)       NO INV NO.                                   
         BZ    RB9D                                                             
         CLC   0(2,R5),TODAYB      INV NO. WILL MATCH TODAY                     
         BNE   RB9D                                                             
         L     R1,APUB                                                          
         OC    0(6,R1),0(R1)       WILL ALSO HAVE PUB BLANK                     
         BNZ   RB9D                                                             
         MVC   0(4,RF),0(R5)                                                    
*                                                                               
RB9D     B     *+8                                                              
RB10     DS    0H                                                               
         SH    R3,=Y(BRKL)         BACK UP THRU LIST                            
RB10B    DS    0H                                                               
         C     R3,ATHISBRK                                                      
         BL    RB14J                NO MORE                                     
*                                                                               
RB11     DS    0H                                                               
         MVC   SORTREC,OLDREC                                                   
         CLI   UPASS,X'FE'       SKIP 'LASTS' FOR TEST PASS - WAS C'T'          
         BE    RB11B                                                            
         CLI   RETSKIP,C'Y'        OR IF NO SHARE FOR OUTLET/SCHEME             
         BE    RB11B                                                            
         C     R3,APMSELO          AT LOWEST OF PRD,MKT,PUB,EST                 
         BNE   RB11B                                                            
         CLC   ORIGTYPE,TYPE       OPTION NOT TO DETAIL MARK FILE               
         BE    RB11B                                                            
         BRAS  RE,WNBILL                                                        
*                                                                               
RB11B    DS    0H                                                               
         C     R3,APRDBRK                                                       
         BH    *+10                                                             
         MVC   RETSKIP,PRDSKIP                                                  
*                                                                               
         C     R3,AINVBRK                                                       
         BL    RB11D               BYPASS LAST'S IF 'ABOVE' INV BRK             
         BH    *+10                                                             
*                                                                               
         MVC   RETSKIP,INVSKIP     ON INVBRK USE INVSKIP                        
         MVI   BYTE,C'L'                                                        
         BAS   RE,RBTRCE                                                        
*                                                                               
         CLI   UPASS,X'FE'      SKIP 'LASTS' FOR TEST PASS  - WAS C'T'          
         BE    RB11D                                                            
*                                                                               
         CLI   BRKCTL1,C'S'        NO SEPARATES                                 
         BNE   RB11C                                                            
         CLI   UPASS,X'FF'         ON SUMMARY PASS - C'S'                       
         BE    RB11D                                                            
RB11C    DS    0H                                                               
         CLI   RETSKIP,C'Y'        OR IF NO SHARE FOR OUTLET/SCHEME             
         BE    RB11D                                                            
         MVI   INVSKIP,C'N'        SET NOT TO SKIP INV                          
         MVI   PRDSKIP,C'N'        OR PRODUCT                                   
*                                  IF ANY EST NOT SKIPPED                       
         MVI   PRSW,C'H'           SET TO HOLD LINES                            
         L     RF,BRKCODE                                                       
         BAS   RE,LASTTAB-4(RF)                                                 
RB11D    DS    0H                                                               
RB13     DS    0H                                                               
         C     R3,AINVBRK                                                       
         BNE   RB13D                                                            
         CLI   INVSKIP,C'Y'                                                     
         BE    RB14B                                                            
         CLI   UPASS,X'FE'     SKIP 'LASTS' FOR TEST PASS - WAS C'T'            
         BE    RB14B                                                            
         BRAS  RE,ENDINV                                                        
*                                                                               
         MVI   FININVSW,0      CLEAR FINANCIAL INVOICE SWITCH                   
*                                                                               
         L     RF,BRKCODE                                                       
         L     RE,ATOTS(RF)                                                     
         LH    RF,TOTSIZH                                                       
*                             CLEAR INV ACCUM                                   
         XCEF                                                                   
*                                                                               
         OC    ARECAP,ARECAP      SEE IF DOING DETAIL BACK-UP                   
         BZ    RB13C        N0 - THEN CLEAR INV LEVEL VATS                      
         CLI   PASSNO,1                                                         
         BE    RB14B        DON'T CLEAR INV LEVEL VATS YET                      
*                                                                               
RB13C    GOTO1 =A(VBROLL),DMCB,BRKTABD   TRY VBROLL TO CLEAR                    
*                                        INVOICE LEVEL VAT TABLES               
         B     RB14B                                                            
*                                                                               
RB13D    DS    0H                                                               
         BAS   RE,ROLLUP                                                        
         GOTO1 =A(VBROLL),DMCB,BRKTABD   AND GST/PST TABLES                     
*                                                                               
         B     RB10                                                             
*                                                                               
RB14     DS    0H                                                               
RB14B    DS    0H                                                               
         CLI   RETPROF,0           TEST RETAIL                                  
         BE    RB14B2              NO                                           
         CLI   RETERR,0            TEST RETAIL ERROR                            
         BNE   RB14H               YES - NEXT INV - BACK TO PASS 0              
         CLI   UPASS,X'FF'         WAS C'S'                                     
         BE    RB14H               DONE AFTER SUMMARY PASS                      
         CLI   UPASS,1             AND QFTER CORP PASS (PASS 1)                 
         BE    RB14H                                                            
         CLI   UPASS,X'FE'         IS IT TEST PASS - WAS C'T'                   
         BNE   *+8                 NO                                           
         MVI   UPASS,1             START AT 2 (DO PASS 1 (CORP) LAST)           
*                                                                               
         ZIC   RF,UPASS            BUMP UNDERPASS                               
         LA    RF,1(RF)                                                         
         STC   RF,UPASS                                                         
         CLI   UPASS,X'FE'         MAXIMUM OUTLETS REACHED                      
         BL    *+6                 WOULD BE CONFUSED WITH TEST PASS             
         DC    H'0'                MUST DIE                                     
*                                                                               
RB14B0X  DS    0H                                                               
         MVI   RETSKIP,C'N'                                                     
         MVI   CORPZ,C'N'          NOT A CORP INV                               
         CLI   RETPROF,0                                                        
         BE    *+12                                                             
         MVI   INVSKIP,C'Y'                                                     
         MVI   PRDSKIP,C'Y'                                                     
*                                                                               
RB14B1   DS    0H                                                               
         L     R4,=A(GDAREA)                                                    
         USING GDSECT,R4                                                        
         MVC   GDOUTNO,UPASS                                                    
         MVC   GDSCHM,SPACES                                                    
         GOTO1 =V(FINDOUTP),DMCB,(R4)                                           
         OC    GDOUTAD,GDOUTAD            TEST END OF OUTLES                    
         BNZ   RB14B1A                                                          
*                                                                               
         CLI   UPASS,1                                                          
         BE    RB14H                                                            
         CLI   RETDRAFT,C'Y'                                                    
         BE    RB14H               NO CORP PASS FOR DRAFT                       
*                                                                               
         MVI   UPASS,1             DO CORP PASS                                 
         CLI   SUMOPT,C'Y'         IF WILL DO SUMMARY                           
         BNE   *+8                                                              
         MVI   CORPZ,C'Y'          CORP BILL NOT AN INVOICE                     
         B     RB14B1                                                           
*                                                                               
RB14B1A  DS    0H                                                               
*                                  SET ADDRESS                                  
         L     R4,GDOUTAD                                                       
         BAS   RE,SETADDR                                                       
         CLI   UPASS,1                                                          
         B     RB14D                                                            
         L     RF,=A(CADDRS)       SAVE CORP ADDR                               
         L     RE,=A(BADDRS)                                                    
         MVC   0(ADDRLEN/2,RF),0(RE)                                            
         MVC   ADDRLEN/2(ADDRLEN/2,RF),ADDRLEN/2(RE)                            
         B     RB14D                                                            
         DROP  R4                                                               
*                                                                               
RB14B2   DS    0H                                                               
         ZIC   RF,PASSNO           BUMP PASS NO                                 
         LA    RF,1(RF)                                                         
         STC   RF,PASSNO                                                        
*                                                                               
         CLI   PASSNO,2                                                         
         BH    RB14H                                                            
         OC    ARECAP,ARECAP                                                    
         BZ    RB14B                                                            
         MVC   FORMAT,DFORMAT                                                   
         MVC   STRIP,DSTRIP                                                     
         MVC   ORDSW(3),DORDSW                                                  
         MVC   DOLNUM,DDOLNUM                                                   
         MVC   TYPNUM,DTYPNUM                                                   
         MVC   APAGBRK,SVPAGBRK    RESTORE BRK CONTROLS                         
         MVC   ALOWTOG,SVLOWTOG                                                 
         MVC   SPOTCTL,SPOTSW      SPOT DETAIL ON BACKUP                        
         MVI   FMTSW,0                                                          
         CLI   SPOTCTL,C'Y'                                                     
         BNE   *+8                                                              
         MVI   FMTSW,C'D'                                                       
         BAS   RE,SETCOLS                                                       
RB14D    DS    0H                                                               
         XC    OLDREC,OLDREC                                                    
         MVC   THISREC,PASSKEY                                                  
         B     RB2                                                              
*                                                                               
RB14H    DS    0H                                                               
         MVC   PASSREC,THISREC                                                  
         BAS   RE,SETPASS0         BACK TO PASS 0                               
         MVI   BILSW,C'N'                                                       
*                                                                               
RB14J    DS    0H                                                               
         L     R3,ATHISBRK         RESTORE R3                                   
RB15     DS    0H                                                               
         CLC   FFS,THISKEY         AT EOF DONT DO 'FIRSTS'                      
         BNE   RB16                                                             
         CLC   FFS,THISKEY+6       TO INSURE THIS IS EOF REC                    
         BE    RB20                                                             
*                                  'FIRSTS'                                     
RB16     DS    0H                                                               
         MVC   SORTREC,THISREC                                                  
         L     RF,BRKCODE                                                       
         LTR   RF,RF                                                            
         BZ    RB19                                                             
         MVI   BYTE,C'F'                                                        
         BAS   RE,RBTRCE                                                        
         CLI   PASSNO,1                                                         
         BE    RB16A                                                            
         BL    RB18                                                             
*****    C     R3,AINVBRK   NO-OPED 3/3/89                                      
*****    BL    RB17         SINCE I NEED TO GO TO FEST ON RECAP PASS            
*                                                                               
RB16A    DS    0H                                                               
         CLI   UPASS,X'FE'         FOR TEST PASS  - WAS C'T'                    
         BNE   RB16B                                                            
         C     R3,AESTBRK          DO ONLY EST FIRST                            
         BNE   RB17                                                             
         B     RB16C                                                            
RB16B    DS    0H                                                               
         CLI   RETSKIP,C'Y'        IF SKIP                                      
         BNE   RB16C                                                            
         C     R3,AESTBRK          BYPASS BRKS 'BELOW' EST                      
         BH    RB17                                                             
RB16C    DS    0H                                                               
         MVI   PRSW,C'H'           SET TO HOLD LINES                            
         L     RF,BRKCODE                                                       
         BAS   RE,FRSTTAB-4(RF)                                                 
*                                                                               
RB16D    DS    0H                                                               
         CLI   RETSKIP,C'Y'        TEST SKIP BECAUSE OF ZERO PCT                
         BE    RB17                                                             
*                                                                               
RB16E    DS    0H                                                               
         C     R3,APAGBRK                                                       
         BNE   RB16F                                                            
**NEW 5/5/89                                                                    
         CLI   PASSNO,2            SEE IF DETAIL PASS                           
         BNE   RB16E3                                                           
*  ANOTHER TRY                                                                  
         JIF   PROGPRO2+8,GT,0,AND,PROGPRO2+8,LT,4,RB16E3,JUMP=N                
*              WHEN PAGE BREAK IS GREATER THAN 0 AND LESS THAN 4                
*              RESET HEADLINES                                                  
*                                                                               
         JIF   PROGPRO2+2,EQ,C'T',AND,PROGPRO2+8,EQ,X'03',RB16E3,JUMP=N         
*                              ESTIMATES TOGETHER AND EST PAGE BREAK            
*                              OR PRODUCT PAGE BREAK                            
*                              THEN MUST RESET HEADLINES                        
*                            - THERE WAS A PROBLEM IF                           
*                              ESTIMATE WAS NOT ON MAIN BILL                    
         B     RB16E5                                                           
*                                  THEN I CAN SKIP SPECIAL HEADLINES            
*                                  PROBLEM WAS THEY CLEARED P1-P5               
*                                  AND REMOVED MKT/JOB/PUB                      
**NEW 5/5/89                                                                    
RB16E3   MVI   RCSUBPRG,100        SET SPECIAL HEADLINES                        
         GOTO1 =A(PRNT)                                                         
RB16E5   MVI   FORCEHED,C'Y'                                                    
RB16F    DS    0H                                                               
         C     R3,AINVBRK                                                       
         BNE   RB17                                                             
*                             SPECIAL COMMENTS FOR SPECIAL BILLS                
         B     RB16FX         MESSAGE NOW IN HEADLINES                          
*                                                                               
RB16FX   L     R6,=A(DICSECT)                                                   
         USING DICSECT,R6                                                       
         CLI   PAYOPT,C'E'    SKIP UPAID ESTS (WITH MESSAGE)                    
         BE    RB16FX5                                                          
*                                                                               
         CLI   PAYOPT,C'D'     SPECIAL DELETED PAID BUY OPTION                  
         BE    RB16FX5         STILL DO MESSAGE                                 
*                                                                               
         CLI   PAYOPT,C'Y'                                                      
         BNE   RB16G                                                            
RB16FX5  DS    0H                                                               
*--->    MVC   P1(57),=C'** ORDERED AMOUNTS ARE BASED ON PUB INVOICE CL         
*--->          EARANCES **'                                                     
         MVC   P1(L'PP@ORD01),PP@ORD01                                          
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
RB16G    DS    0H                                                               
         OC    MANPCT,MANPCT                                                    
         BZ    RB16H                                                            
*--->    MVC   P1(14),=C'** AMOUNTS ARE'                                        
         MVC   P1(L'PP@AMT01),PP@AMT01                                          
         LA    R4,P1+15                                                         
*--->    EDIT (B4,MANPCT),(6,0(R4)),2,ALIGN=LEFT                                
         CURED (B4,MANPCT),(6,0(R4)),CURTAB,ALIGN=LEFT                          
         MVI   CURTAB+3,2                                                       
         AR    R4,R0                                                            
*--->    MVC   1(21,R4),=C'PERCENT OF ORDERED **'                               
         MVC   1(L'PP@PCORD,R4),PP@PCORD                                        
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
RB16H    DS    0H                                                               
         OC    MANRVNO,MANRVNO                                                  
         BZ    RB16I                                                            
*--->    MVC   P1(36),=C'** REVERSAL OF INVOICE NN-NNNN DATED'                  
         MVC   P1(L'PP@REV01),PP@REV01                                          
         MVC   W(2),MANRVDTP                                                    
*                                                                               
         MVC   SVSVIMO,SVINVMO            SAVE INV MTH                          
*                                                                               
         GOTOR GETNUM,DMCB,(1,MANRVNO),WORK                                     
*                                                                               
         MVC   SVINVMO,SVSVIMO            RESTORE INV MTH                       
*                                                                               
         DROP  R6                                                               
         L     RF,DMCB+4                USE "SHORT" FORMAT (NO MEDIA)           
         MVC   P1+23(7),0(RF)                                                   
*                                        DON'T MOVE MEDIA EXPANSION             
**OLD**  MVC   P1+23(7),WORK+2                                                  
**OLD**  CLI   WORK+9,C' '               SEE IF INVOICE 10 LONG                 
**OLD**  BE    *+10                                                             
**OLD**  MVC   P1+23(7),WORK+3                                                  
*                                                                               
         GOTO1 DATCON,DMCB,(3,MANRVDTP),(5,WORK)                                
         MVC   P1+37(8),WORK                                                    
         MVC   P1+37+9(2),=C'**'                                                
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
RB16I    DS    0H                                                               
*                                                                               
         MVI   PUMODE,C'F'   USER FIELDS AT FRONT OF BILL                       
         BRAS  RE,PRTUSER                                                       
*                                                                               
         LA    RF,P1                                                            
         CLI   MKTCTL,C'S'           MARKETS ON SEPERATE INV                    
         BNE   RB16I3                                                           
         OC    AMKT,AMKT                                                        
         BZ    RB16I3                                                           
         L     RE,AMKT                                                          
         MVC   P1+0(20),0(RE)                                                   
         MVC   P2+0(20),DASHES                                                  
         LA    R4,P1+20                                                         
         LA    R5,P2+20                                                         
RB16I2   CLI   0(R4),C' '                                                       
         BH    RB16I2X                                                          
         MVI   0(R5),C' '                                                       
         BCTR  R4,0                                                             
         BCTR  R5,0                                                             
         B     RB16I2                                                           
*                                                                               
RB16I2X  DS    0H                                                               
         JIF   JOBCTL,NE,C'S',AND,PUBCTL,NE,C'S',RB16K,JUMP=N                   
         MVI   P3,0                 SKIP A LINE                                 
         LA    RF,P4                                                            
*                                                                               
RB16I3   DS    0H                                                               
         CLI   JOBCTL,C'S'           JOB ON SEPERATE INV                        
         BNE   RB16J                                                            
**WB**                                                                          
         CLI   WBSW,C'Y'      WB FLIGHT FEATURE?                                
         BNE   RB16I3J                                                          
         B     RB16I5         NOW IN HEADLINES                                  
****                                                                            
****     MVC   000(25,RF),JOBL1   IT WILL CONTAIN FLIGHT INFO                   
****     B     RB16I5                                                           
*                                                                               
RB16I3J  DS    0H                                                               
**WB**                                                                          
         MVC   000(25,RF),JOBL1                                                 
         MVC   132(25,RF),JOBL2                                                 
         MVC   264(30,RF),JOBL3                                                 
         MVC   396(30,RF),JOBL4                                                 
         MVC   528(30,RF),JOBL5                                                 
         MVC   660(30,RF),JOBL6                                                 
         LA    RF,264(RF)                                                       
         CLC   JOBL3,SPACES                                                     
         BE    RB16I5                                                           
         LA    RF,132(RF)         BUMP ANOTHER LINE                             
         CLC   JOBL4,SPACES                                                     
         BE    RB16I5                                                           
         LA    RF,132(RF)          BUMP ANOTHER LINE                            
         CLC   JOBL5,SPACES                                                     
         BE    RB16I5                                                           
         LA    RF,132(RF)          BUMP ANOTHER LINE                            
         B     RB16I5                                                           
*                                                                               
****  OLD CODE ****                                                             
****     MVC   P1+0(25),JOBL1       MUST RESTORE P1 - P5                        
****     MVC   P2+0(25),JOBL2                                                   
****     MVC   P3+0(30),JOBL3                                                   
****     MVC   P4+0(30),JOBL4                                                   
****     MVC   P5+0(30),JOBL5                                                   
****     LA    RF,P3                                                            
****     CLC   P3(25),SPACES                                                    
****     BE    RB16I5                                                           
****     LA    RF,P4                                                            
****     CLC   P4(25),SPACES                                                    
****     BE    RB16I5                                                           
****     LA    RF,P5                                                            
*                                                                               
RB16I5   DS    0H                                                               
         CLI   PUBCTL,C'S'                                                      
         BNE   RB16K                                                            
         MVI   0(RF),0                                                          
         LA    RF,132(RF)           SKIP A LINE                                 
*                                                                               
RB16J    CLI   PUBCTL,C'S'           PUB ON SEPERATE INV                        
         BNE   RB16K                                                            
         MVC   0(60,RF),PPUBL1                                                  
         MVC   132(20,RF),PPUBL2                                                
*                                                                               
RB16K    DS    0H                                                               
*                                                                               
RB17     DS    0H                                                               
         LA    R3,BRKL(R3)                                                      
         B     RB16                                                             
*                                                                               
RB18     DS    0H                                                               
*                                  PASS 0                                       
***E***                                                                         
         CLC   QPROG,=C'E1'        FOR ESTIMATES DON'T CHK BILLABLE             
         BE    RB18C                                                            
***E***                                                                         
         L     R6,ASORTDTA                                                      
         CLC   0(16,R6),BGDSP(R6)   TEST ANY BILLABLE                           
         BNE   RB18C                                                            
         CLC   OGDSP(16,R6),OBGDSP(R6)  TEST OPEN BILLABLE                      
         BNE   RB18C                                                            
         CLC   OTRDC(4,R6),OBTRDC(R6)  TEST TRD CREDIT BILLABLE                 
         BNE   RB18C                                                            
         OC    0(16,R6),0(R6)        CHECK FOR ANY ORDERED                      
         BNZ   RB19              IF FOUND SKIP - ITEM HAS BEEN BILLED           
         OC    OGDSP(16,R6),OGDSP(R6) CHECK FOR ANY OPEN ORDERED                
         BNZ   RB19              IF FOUND SKIP - ITEM HAS BEEN BILLED           
         OC    OTRDC(4,R6),OTRDC(R6) CHECK FOR ANY TRD CREDIT ORD               
         BNZ   RB19              IF FOUND SKIP - ITEM HAS BEEN BILLED           
*                                                                               
*        SEE IF COMBINED PREVIOUSLY BILLED DATA                                 
         L     R1,ADESC                                                         
         LTR   R1,R1                                                            
         BZ    RB18C       JUST IN CASE ADESC NOT PRESENT                       
         CLI   0(R1),X'FA'     LUMPED PREVIOUSLY BILLED DATA                    
         BE    RB19            MUST SKIP IF NO ORDERED                          
         CLI   0(R1),X'FC'     PREVIOUS MANUAL BILLS                            
         BE    RB19            MUST SKIP IF NO ORDERED                          
*                             (YES - I ACTUALLY SAW A ZERO                      
*                              MANUAL BILL)                                     
*                              OTHERWISE WBILL MAY DUMP                         
*                                                                               
*    SINCE I'M NOW BILLING "FREE" BUYS I MUST CONSIDER THEM BILLABLE            
*                                                                               
***TAX   NOTE THAT THE CHECKS ABOVE WILL NOT DETECT A BILLABLE TAX              
***TAX        THIS SHOULD NOT OCCUR SINCE THE TAX PCT. WILL NOT BE              
***TAX        ALLOWED TO CHANGE FOR BILLED INSERTIONS                           
***TAX        ALSO THERE MAY BE DISCREPANCIES IN TAX DUE TO ROUNDING            
*                                                                               
RB18C    MVI   BILSW,C'Y'          SET ACTIVITY                                 
         MVI   ZEROSW,C'N'         RESET ZERO-BILLING SSWOTCH                   
         BAS   RE,SETPASS1         AND DO PASS 1                                
         BAS   RE,SETRET                                                        
         B     RB14D                                                            
RB19     DS    0H                                                               
         CLC   FFS,THISKEY                                                      
         BNE   RB19C                                                            
         CLC   FFS,THISKEY+6                                                    
         BE    RB20                                                             
RB19C    MVC   OLDREC,THISREC                                                   
         B     RB4                                                              
*                                                                               
RB20     DS    0H                                                               
*                                                                               
         CLI   SUMOPT,C'Y'         TEST DOING CORP SUMMARY (RETAIL)             
         BNE   RB30                NO                                           
         CLI   UPASS,X'FF'         TEST ALREADY DONE - WAS C'S'                 
         BE    RB26                YES                                          
         MVI   UPASS,X'FF'         WAS C'S'                                     
         MVI   CORPZ,C'N'          CORP INV CONTROL                             
*                                                                               
         L     RF,=A(BADDRS)                                                    
         L     RE,=A(CADDRS)                                                    
         MVC   0(ADDRLEN/2,RF),0(RE)                                            
         MVC   ADDRLEN/2(ADDRLEN/2,RF),ADDRLEN/2(RE)                            
         L     RF,=A(AADDRS)                                                    
         MVC   0(ADDRLEN/2,RF),0(RE)   RESTORE ADDRESSES                        
         MVC   ADDRLEN/2(ADDRLEN/2,RF),ADDRLEN/2(RE)                            
*                                                                               
*                                  CLEAR VARIOUS BREAK CLTS                     
         LA    RF,BRKTAB                                                        
         ST    RF,APAGBRK                                                       
         ST    RF,SVPAGBRK                                                      
         MVC   AINVBRK,APERGBRK                                                 
         XC    ALOWTOG,ALOWTOG                                                  
         XC    AHITOG,AHITOG                                                    
*                                  RESET BREAK CONTROLS                         
         LA    R3,BRKTAB                                                        
*                                                                               
RB21     DS    0H                                                               
         OC    BRKCODE,BRKCODE                                                  
         BZ    RB25B                                                            
         C     R3,APERGBRK         DUMMY 'SEPARATE'                             
         BE    RB25                                                             
         C     R3,APRDBRK          FORCE PRD SEPARATE                           
         BNE   *+12                                                             
         MVI   BRKCTL1,C'S'                                                     
         B     RB24B                                                            
         C     R3,AESTBRK          FORCE EST TOGETHER                           
         BNE   *+8                                                              
         MVI   BRKCTL1,C'S'                                                     
         C     R3,APERBRK          FORCE PERIOD TOGETHER                        
         BNE   *+8                                                              
         MVI   BRKCTL1,C'S'                                                     
         CLI   BRKCTL1,C'S'        SEPARATE                                     
         BNE   RB22                                                             
         MVI   BRKCTL1,C'T'        TO TOGETHER                                  
*                                                                               
         C     R3,APERBRK                                                       
         BE    RB21B                                                            
*                                                                               
         ST    R3,ALOWTOG                                                       
         ST    R3,SVLOWTOG                                                      
*                                                                               
RB21B    DS    0H                                                               
         OC    AHITOG,AHITOG                                                    
         BNZ   *+8                                                              
         ST    R3,AHITOG                                                        
         B     RB24                                                             
*                                                                               
RB22     DS    0H                                                               
         CLI   BRKCTL1,C'T'        TOGETHER                                     
         BE    RB23                                                             
         CLI   BRKCTL1,C'P'                                                     
         BNE   RB24                                                             
RB23     DS    0H                                                               
         MVI   BRKCTL1,C'N'        TO NO                                        
*                                                                               
RB24     DS    0H                                                               
RB24B    DS    0H                                                               
         LA    RF,LEVCTLS                                                       
         A     RF,BRKCODE                                                       
         MVC   0(1,RF),BRKCTL1                                                  
*                                                                               
RB25     DS    0H                                                               
         LA    R3,BRKL(R3)                                                      
         B     RB21                                                             
*                                                                               
RB25B    DS    0H                                                               
         XC    SAVPRD,SAVPRD       START WITH FIRST PRODUCT                     
RB26     DS    0H                                                               
RB26B    DS    0H                                                               
         L     RF,=A(PDLIST)                                                    
RB26C    DS    0H                                                               
         CLI   0(RF),X'FF'         TEST IF I ALREADY DID THIS PRD               
         BE    RB26C5              YES                                          
         CLI   0(RF),0             LAST PRD                                     
         BE    RB28                                                             
         B     RB26D                                                            
*                                                                               
RB26C5   LA    RF,3(RF)            NO - NEXT PRD                                
         B     RB26C                                                            
*                                                                               
*                                                                               
RB26D    DS    0H                                                               
         MVC   SAVPRD,0(RF)                                                     
         L     RE,APRD             SET PRD HERE                                 
         MVC   0(3,RE),0(RF)                                                    
         MVI   0(RF),X'FF'         SO I WON'T REDO THIS PRD                     
         L     R3,APRDBRK                                                       
         BAS   RE,FPRD                                                          
         B     RB0                                                              
*                                                                               
RB28     DS    0H                                                               
         BRAS  RE,BLDTAB           REBUILD BREAK TABLES                         
         MVI   UPASS,0                                                          
*                                                                               
RB30     DS    0H                                                               
RDBUFFX  DS    0H                                                               
         MVI   PRSW,C'F'           PRINT ANY LEFTOVER LINES                     
         GOTO1 =A(PRNT)                                                         
         MVC   RCTRACE,SAVTRACE                                                 
         XC    INVLIST,INVLIST                                                  
         XC    INVTABN,INVTABN                                                  
         L     RF,AINVTAB          CLEAR INVTAB                                 
         XC    0(256,RF),0(RF)                                                  
         MVI   INVSKIP,C'N'                                                     
         MVI   PRDSKIP,C'N'                                                     
RBEXT    DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
SETPASS0 DS    0H                                                               
         MVI   PASSNO,0                                                         
         B     *+8                                                              
SETPASS1 DS    0H                                                               
         MVI   PASSNO,1            SET FOR PASS 1                               
         MVI   RETSKIP,C'N'        RESET SKIP SWITCHES                          
         CLI   RETPROF,0                                                        
         BE    *+12                                                             
         MVI   INVSKIP,C'Y'                                                     
         MVI   PRDSKIP,C'Y'                                                     
         MVC   FORMAT,BFORMAT      CATS                                         
         MVC   STRIP,BSTRIP                                                     
         MVC   ORDSW(3),BORDSW     TYPES                                        
         MVC   DOLNUM,BDOLNUM      NUMBER OF DOL  CATS                          
         MVC   TYPNUM,BTYPNUM      NUMBER OF DOL TYPES                          
         MVC   APAGBRK,SVPAGBRK    RESTORE                                      
         MVC   ALOWTOG,SVLOWTOG                                                 
         MVC   SPOTCTL,SPOTSW                                                   
         OC    ARECAP,ARECAP      DOING DETAIL BACK-UP?                         
         BZ    SP1B                                                             
         MVC   APAGBRK,AINVBRK     FOR RECAP NO PAGE BRKS                       
         MVC   ALOWTOG,ARECAP                                                   
         MVI   SPOTCTL,C'N'        IF RECAP THEN NO SPOT DETAILS                
         B     SP1C                                                             
*                                  ON MAIN BILL                                 
SP1B     DS    0H                                                               
*                                                                               
         CLI   PROGPRO2+6,C'X'     NO PUBS BUT SHOW INS.                        
         BE    SP1C                                                             
*                                                                               
         CLI   PUBCTL,C'N'         SEE IF NOT SHOWING PUB                       
         BNE   SP1C                                                             
*                                                                               
         MVI   SPOTCTL,C'N'        THEN DON'T SHOW INSERTION DETAILS            
*                                                                               
SP1C     MVI   FMTSW,0                                                          
         CLI   SPOTCTL,C'Y'                                                     
         BNE   SP1D                                                             
         MVI   FMTSW,C'D'          FOR SPOT DETAILS - FORMAT = 0                
SP1D     DS    0H                                                               
*                                                                               
*                                  SET COLS USABLE FOR DESCRIPTIONS             
SETCOLS  DS    0H                                                               
         MVI   TWOCOL,C'Y'         2 COLS AVALIBLE                              
         MVC   WORK(1),DOLNUM                                                   
         MVC   WORK+1(1),TYPNUM                                                 
         LA    RF,COLTAB                                                        
SETCOL3  CLI   0(RF),X'FF'         END OF TABLE                                 
         BER   RE                                                               
         CLC   0(2,RF),WORK                                                     
         BE    SETCOL5                                                          
         LA    RF,2(RF)                                                         
         B     SETCOL3                                                          
*                                                                               
SETCOL5  MVI   TWOCOL,C'N'         2 COLS NOT AVAILABLE                         
         BR    RE                                                               
*                                                                               
*                                  BELOW COMBOS USE 4 COLUMNS                   
COLTAB   DC    X'0302'             DOLNUM,TYPNUM                                
         DC    X'0303'                                                          
         DC    X'0401'                                                          
         DC    X'0403'                                                          
         DC    X'0503'                                                          
         DC    X'0603'                                                          
         DC    X'FFFF'                                                          
         SPACE 3                                                                
RBTRCE   DS    0H                                                               
         CLI   SORTTRCE,C'Y'                                                    
         BNER  RE                                                               
*                                                                               
         MVC   P1+1(1),PASSNO                                                   
         OI    P1+1,C'0'                                                        
         CLI   UPASS,0                                                          
         BE    RBT2                                                             
         MVC   P1+2(1),UPASS                                                    
         CLI   UPASS,X'FF'              WAS C'S'                                
         BNL   RBT2                                                             
         OI    P1+2,C'0'                                                        
RBT2     DS    0H                                                               
         MVC   P1+4(1),BYTE                                                     
         LA    RF,BRKLIST-4                                                     
         A     RF,BRKCODE                                                       
         MVC   P1+5(4),0(RF)                                                    
         LR    R0,RE                                                            
         GOTO1 HEXOUT,DMCB,SORTREC,P1+10,SORTRLEN,=C'N'                         
         GOTO1 =A(PRNT)                                                         
         LR    RE,R0                                                            
         BR    RE                                                               
         SPACE 3                                                                
SETRET   DS    0H                                                               
         CLI   RETPROF,0                                                        
         BER   RE                                                               
         CLI   UPASS,X'FF'             WAS C'S'                                 
         BER   RE                                                               
         LR    R0,RE                                                            
         GOTO1 =A(SETR)                                                         
         LR    RE,R0                                                            
         BR    RE                                                               
         SPACE 3                                                                
*                                                                               
*        THIS ROUTINE USED FOR PAYOPTS E,F,G (BYTE WILL BE U)                   
*        (SKIP ESTS WITH UNPAID INSERTIONS)                                     
*                                                                               
*        COULD ALSO BE USED TO CHECKED PLANNED COST (BYTE P?)                   
*                                                                               
CHKSKIP  DS    0H             SEE IF EST IS IN UPETAB                           
         NTR1                 IF FOUND SET DUB TO 1                             
*                             MEANS SKIP THIS RECORD IN BUFF READS              
         MVI   DUB,0                                                            
         XC    X(20),X                                                          
         LA    R5,X                                                             
         USING UPED,R5                                                          
         L     RE,APRD                                                          
         LA    R0,SORTREC                                                       
         SR    RE,R0           POINT TO PRD IN THISREC                          
         LA    RE,THISREC(RE)                                                   
         MVC   UPEPRD,0(RE)                                                     
         L     RE,AEST                                                          
         LA    R0,SORTREC                                                       
         SR    RE,R0           POINT TO EST IN THISREC                          
         LA    RE,THISREC(RE)                                                   
         MVC   UPEEST,0(RE)                                                     
         GOTO1 BINSRCH,UPEPARS,X                                                
         CLI   0(R1),1           SEE IF IN TABLE                                
         BE    CHKSKX                                                           
*                                                                               
         L     R5,0(R1)          ADDRESS OF FOUND RECORD                        
         CLI   BYTE,C'U'         CHECKING UNPAID STATUS?                        
         BNE   CHKSKC                                                           
         TM    UPESTAT,X'01'     SEE IF UNPAID                                  
         BZ    CHKSKX                                                           
         MVI   DUB,1             YES THEN SKIP                                  
         B     CHKSKX                                                           
*                                                                               
CHKSKC   CLI   BYTE,C'C'         CHECKING MISSING UCOMM/UDEF?                   
         BNE   CHKSKX                                                           
         TM    UPESTAT,X'04'     SEE IF UCOMM/UDEF MISSING                      
         BZ    CHKSKX                                                           
         MVI   DUB,1             YES THEN SKIP                                  
         B     CHKSKX                                                           
*                                                                               
CHKSKX   XIT1                                                                   
         DROP  R5                                                               
         SPACE 2                                                                
SETADDR  DS    0H                                                               
         USING GDOUTD,R4                                                        
*                                                                               
         ST    RE,FULL2            SAVE RE                                      
*                                                                               
         L     R0,=A(AADDRS)                                                    
         LHI   R1,ADDRLEN                                                       
         SR    RE,RE                                                            
         LA    RF,X'40'                 FILL WITH SPACES                        
         SLL   RF,24                                                            
         MVCL  (R0),(RE)                                                        
*                                                                               
         L     RF,=A(AADDRS)                                                    
*                                                                               
*NOP     MVC   144+36-L'GDOCODE(L'GDOCODE,RF),GDOCODE  OUTLET CODE              
         CLI   BILLADR,C'Y'        EXTENDED ADDRESS?                            
         BNE   *+14                                                             
         MVC   240+70-L'GDOCODE(L'GDOCODE,RF),GDOCODE  OUTLET CODE              
         B     *+10                                                             
         MVC   240+36-L'GDOCODE(L'GDOCODE,RF),GDOCODE  OUTLET CODE              
                                                                                
         LA    R1,GDONAME                                                       
         CLI   MOLSON,C'Y'            FOR MOLSON                                
         BNE   SETAD4                                                           
         CLC   GDOCODE(6),=C'000001'  CORPORATE                                 
         BNE   SETAD4                                                           
         LA    R1,MOLSADDR         USE SPECIAL ADDRESS                          
*NOP     MVC   144+36-L'GDOCODE(6,RF),=C'000005'  AND DIFFERENT OUTLET          
         CLI   BILLADR,C'Y'        EXTENDED ADDRESS?                            
         BNE   *+14                                                             
         MVC   240+70-L'GDOCODE(6,RF),=C'000005'  AND DIFFERENT OUTLET          
         B     *+10                                                             
         MVC   240+36-L'GDOCODE(6,RF),=C'000005'  AND DIFFERENT OUTLET          
*                                                 (FOR RECIEVABLES)             
SETAD4   DS    0H                                                               
         MVC   000(36,RF),GDONAME-GDONAME(R1)                                   
         MVC   060(26,RF),GDOAL1-GDONAME(R1)                                    
         MVC   120(26,RF),GDOAL2-GDONAME(R1)                                    
         MVC   180(26,RF),GDOAL3-GDONAME(R1)                                    
         MVC   240(26,RF),GDOAL4-GDONAME(R1)                                    
*                                                                               
*        OLD CODE                                                               
*                                                                               
****     MVC   000(36,RF),GDONAME                                               
****     MVC   036(26,RF),GDOAL1                                                
****     MVC   072(26,RF),GDOAL2                                                
****     MVC   108(26,RF),GDOAL3                                                
****     MVC   144(26,RF),GDOAL4                                                
****     MVC   144+36-L'GDOCODE(L'GDOCODE,RF),GDOCODE                           
*                                                                               
         L     R1,=A(BADDRS)       SET IN BADDRS ALSO                           
         MVC   0(ADDRLEN/2,R1),0(RF)                                            
         MVC   ADDRLEN/2(ADDRLEN/2,R1),ADDRLEN/2(RF)                            
                                                                                
         L     RE,FULL2            RESTORE RE                                   
         BR    RE                                                               
         DROP  R4                                                               
         EJECT                                                                  
*        'FIRSTS'                                                               
         SPACE 2                                                                
FRSTTAB  DS    0F                                                               
         B     FMED                                                             
         B     FPGR1                                                            
         B     FPGR2                                                            
         B     FPGR3                                                            
         B     FPRD                                                             
         B     FEST                                                             
         B     FMGR1                                                            
         B     FMGR2                                                            
         B     FMGR3                                                            
         B     FMKT                                                             
         B     FJOB                                                             
         B     FPUB                                                             
         B     FDESC                                                            
         B     FPER                                                             
         B     FPERG                                                            
         B     FCTYP                                                            
         B     FCRDB                                                            
         SPACE 3                                                                
*        'LASTS'                                                                
         SPACE 2                                                                
LASTTAB  DS    0F                                                               
         B     LMED                                                             
         B     LPGR1                                                            
         B     LPGR2                                                            
         B     LPGR3                                                            
         B     LPRD                                                             
         B     LEST                                                             
         B     LMGR1                                                            
         B     LMGR2                                                            
         B     LMGR3                                                            
         B     LMKT                                                             
         B     LJOB                                                             
         B     LPUB                                                             
         B     LDESC                                                            
         B     LPER                                                             
         B     LPERG                                                            
         B     LCTYP                                                            
         B     LCRDB                                                            
         EJECT                                                                  
*        FIRST FOR MEDIA                                                        
FMED     NTR1                                                                   
*                                                                               
         GOTO1 =A(FSTMED)             FMED NOW IN IT'S OWN CSECT                
         B     RBEXT                                                            
*                                                                               
         EJECT                                                                  
*        FIRST FOR PRODUCT GROUP (REALLY DIVISION)                              
         SPACE 2                                                                
FPGR1    DS    0H                                                               
*                                                                               
***      L     RF,=A(DADDRS)       CLEAR DIV - REP ADDRESS                      
***      MVC   0(132,RF),SPACES                                                 
***      MVC   132(OADDRLEN-132,RF),SPACES                                      
*                                                                               
         ST    RE,FULL2            SAVE RE                                      
         L     R0,=A(DADDRS)       CLEAR DIV - REP ADDRESS                      
         LHI   R1,ADDRLEN                                                       
         SR    RE,RE                                                            
         LA    RF,X'40'                 FILL WITH SPACES                        
         SLL   RF,24                                                            
         MVCL  (R0),(RE)                                                        
         L     RE,FULL2            RESTORE RE                                   
*                                                                               
         LA    R5,PGR1             PGR1 DATA                                    
         L     R6,APGR1                                                         
         B     FPGRA                                                            
         SPACE 2                                                                
FPGR2    DS    0H                                                               
         LA    R5,PGR2             PGR2 DATA                                    
         L     R6,APGR2            FUTURE USE                                   
         B     FPGRA                                                            
         SPACE 3                                                                
FPGR3    DS    0H                                                               
         LA    R5,PGR3             PGR3 DATA                                    
         L     R6,APGR3            FUTURE USE                                   
         SPACE 3                                                                
FPGRA    NTR1                                                                   
         SPACE 2                                                                
*                                                                               
         CLI   UPASS,X'FF'      SEE IF CORP SUMMARY PASS - WAS C'S'             
         BNE   FPGRA1                                                           
         CLC   QPUB+1(3),=C'RD='   AND DRD OVERCIDE CLT                         
         BE    FPGRAX              THE SKIP DIV                                 
*                                                                               
FPGRA1   OC    ALOWTOG,ALOWTOG                                                  
         BZ    *+12                                                             
         C     R3,ALOWTOG          TEST IF TO APPEAR                            
         BH    FPGRAX              NO                                           
*                                                                               
         MVC   0(3,R5),0(R6)       MOVE CODE                                    
*              READ DIVISION FOR NAME                                           
*              THEN SAVE IT IN PGRNAME                                          
         L     RF,PPFILEC                                                       
         USING PPFILED,RF                                                       
         XC    KEY,KEY                                                          
         MVC   KEY(10),PCLTREC     AGY/MED/CODE/CLT/DIV                         
         OC    AMED,AMED           FOR MULTI-MEDIA REQ GET MEDIA                
         BZ    FPGRA3              FROM AMED                                    
         L     R1,AMED                                                          
         MVC   KEY+2(1),0(R1)                                                   
FPGRA3   MVI   KEY+3,X'03'         DIVISION                                     
         MVC   KEY+7(3),0(R6)                                                   
FPGRA5   GOTO1 HIGH                                                             
         CLC   KEY(10),KEYSAVE                                                  
         BE    FPGRA8                                                           
*                                                                               
         L     RF,PPFILEC                                                       
         MVC   PDIVREP,SPACES     MUST CLEAR IF DIVISION NOT ON FILE            
*                                                                               
         CLC   KEYSAVE+7(3),=C'999'                                             
         BE    FPGRA8                                                           
         DC    H'0'                DIVISION NOT FOUND                           
*                                                                               
FPGRA8   GOTO1 GETDIV                                                           
         L     RF,PPFILEC                                                       
         MVC   PGR1NM(20),PDIVNAME                                              
*                                                                               
         CLI   PDIVREP,C' '       BILLING REP PRESENT?                          
         BNH   FPGRA8X                                                          
*                                                                               
*                                 READ REP AND SET ADDRESS                      
*                                 INTO DADDRS                                   
         MVC   DSAVKEY,KEY                                                      
         XC    KEY,KEY                                                          
         XC    WORK(25),WORK                                                    
         L     RF,ADCLT                                                         
         MVC   WORK(3),0(RF)       AGY/MED                                      
         OC    AMED,AMED           FOR MULTI-MEDIA REQ GET MEDIA                
         BZ    FPGRA8E             FROM AMED                                    
         L     RF,AMED                                                          
         MVC   WORK+2(1),0(RF)                                                  
*                                                                               
FPGRA8E  MVC   KEY(3),WORK        AGY,MED                                       
         MVI   KEY+3,X'11'                                                      
         L     RF,PPFILEC                                                       
         MVC   KEY+4(4),PDIVREP                                                 
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'               MUST FIND REP                                 
*                                                                               
         DROP  RF                                                               
*                                                                               
         L     R4,PPFILEC         TO ACCESS REP RECORD                          
         USING PPFILED,R4                                                       
         LA    R0,PREPREC                                                       
*                                                                               
         ST    R0,AREC                                                          
         GOTO1 GETPRT                                                           
*                                                                               
         MVC   KEY,DSAVKEY                                                      
         GOTO1 HIGH                                                             
*                                                                               
         L     RF,=A(DADDRS)                                                    
         MVC   0(30,RF),PREPNAME                                                
         MVC   60(30,RF),PREPLIN1                                               
         MVC   120(30,RF),PREPLIN2                                              
         LA    RE,156(RF)                                                       
         OC    PREPATTN,PREPATTN     SEE IF I HAVE AN ATTENTION                 
         BZ    FPGRA8F                                                          
         MVC   180(5,RF),=C'ATTN:'                                              
         MVC   186(20,RF),PREPATTN                                              
         LA    RE,186(RF)                                                       
*                                                                               
         DROP  R4                                                               
*                                                                               
FPGRA8F  DS    0H                                                               
*                                                                               
FPGRA8X  DS    0H           CHECK IF EST 'HIGHER' THAN PAGE BRK                 
         B     FPGRA15                                                          
*                                                                               
FPGRA10  B     FPGRAX                                                           
FPGRA15  DS    0H                                                               
         C     R3,APAGBRK          TEST PGR 'HIGHER' THAN PAGE BRK              
         BNH   FPGRA18             YES                                          
*                                  PGR 'TOGETHER'                               
         CLC   P1,SPACES                                                        
         BE    FPGRA17                                                          
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
FPGRA17  DS    0H                                                               
         OC    18(24,R5),SPACES                                                 
         CLC   ALOWTOG,AHITOG                                                   
         BNE   FPGRA17B                                                         
*                                  IS ONLY TOGETHER                             
         MVC   P1(5),0(R5)                                                      
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P1+6(24),18(R5)                                                  
         B     FPGRA10                                                          
         GOTO1 =V(CHOPPER),DMCB,(24,18(R5)),(14,P1+6),(C'P',2)                  
         B     FPGRA10                                                          
FPGRA17B  DS    0H                                                              
         MVC   P1(12),6(R5)        DESC                                         
         LA    RF,P1+12                                                         
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   2(5,RF),0(R5)       NUMBER                                       
*                                                                               
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P2(24),18(R5)                                                    
         B     FPGR17D                                                          
         GOTO1 =V(CHOPPER),DMCB,(24,18(R5)),(20,P2),(C'P',2)                    
FPGR17D  DS    0H                                                               
         C     R3,ALOWTOG                                                       
         BE    *+8                                                              
         BAS   RE,ULINE                                                         
         B     FPGRA20                                                          
*                                  PGR IN HEADS                                 
FPGRA18  DS    0H                                                               
FPGRA20  DS    0H                                                               
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMPGR',0)     EDI CALL                          
**EDI**                                                                         
*                                                                               
FPGRAX   DS    0H                                                               
         B     RBEXT                                                            
         EJECT                                                                  
*        FIRST FOR MARKET GROUP                                                 
         SPACE 2                                                                
FMGR1    DS    0H                                                               
*                                                                               
****     L     RF,=A(RADDRS)       CLEAR REG - REP ADDRESS                      
****     MVC   0(132,RF),SPACES                                                 
****     MVC   132(OADDRLEN-132,RF),SPACES                                      
*                                                                               
         ST    RE,FULL2            SAVE RE                                      
*                                                                               
         L     R0,=A(RADDRS)       CLEAR REG - REP ADDRESS                      
         LHI   R1,ADDRLEN                                                       
         SR    RE,RE                                                            
         LA    RF,X'40'                 FILL WITH SPACES                        
         SLL   RF,24                                                            
         MVCL  (R0),(RE)                                                        
*                                                                               
         L     RE,FULL2            RESTORE RE                                   
*                                                                               
         LA    R5,MGR1             REGION                                       
         L     R6,AMGR1                                                         
         B     FMGRA                                                            
         SPACE 2                                                                
FMGR2    DS    0H                                                               
         LA    R5,MGR2             DISTRICT                                     
         L     R6,AMGR2                                                         
         B     FMGRA                                                            
         SPACE 2                                                                
FMGR3    DS    0H                  FUTURE USE                                   
         LA    R5,MGR3                                                          
         L     R6,AMGR3                                                         
         SPACE 2                                                                
FMGRA    LR    R0,RE                                                            
         GOTO1 =A(FMGRALL)                                                      
         LR    RE,R0                                                            
         BR    RE                                                               
*                                                                               
         EJECT                                                                  
*        FIRST FOR MARKET                                                       
         SPACE 2                                                                
FMKT     NTR1                                                                   
         SPACE 2                                                                
         CLC   AMKTBRK,AINVBRK     IF MKT SEPARATE                              
         BH    FMKT3                                                            
         CLC   AESTBRK,AINVBRK     AND EST SEPARATE                             
         BH    FMKT3                                                            
         BRAS  RE,TSTRET           DO RETAIL TEST                               
         BNZ   FMKTX               SKIP                                         
*                                                                               
FMKT3    DS    0H                                                               
         CLI   MKTCTL,0                                                         
         BE    FMKTX               NO MARKETS                                   
         CLI   MKTCTL,C'N'                                                      
         BE    FMKTX                                                            
         OC    ALOWTOG,ALOWTOG                                                  
         BZ    *+12                                                             
         C     R3,ALOWTOG          TEST IF TO APPEAR                            
         BH    FMKTX               NO                                           
         L     RF,AMKT                                                          
         OC    0(2,RF),0(RF)       IF NO MARKET-SKIP ALL MKT CODE               
         BNZ   *+12                                                             
         MVI   MKTCTL,C'N'         (MKTCTL RESET AT ENDINV)                     
         B     FMKTX                                                            
**WB**   CLC   XXMKT,0(RF)         SKIP PREV BILL MKT                           
**WB**   BNE   FMKT8                                                            
**WB**   MVI   SPACING,2                                                        
**WB**   CLC   BORDSW(3),=C'YNN'      IF FORMAT (ORDERED ONLY)                  
**WB**   BE    FMKTX                                                            
*                                                                               
*              READ MARKET AND PRINT IT                                         
*                                  MKT IN HEADS                                 
FMKT8    DS    0H                                                               
         CLC   P1,SPACES                                                        
         BE    FMKT8C                                                           
         MVI   SPACING,2                                                        
         LR    R0,RF               SAVE RF                                      
         GOTO1 =A(PRNT)                                                         
         LR    RF,R0               RESTORE RF                                   
*                                                                               
FMKT8C   DS    0H                                                               
         CLI   MKTCTL,C'S'     SEE IF MARKETS ARE ON SEPERATE INVS              
         BE    FMKT10          DON'T PUT INTO P1 AND P2                         
*                              MARKET WILL PRINT AT RB16I                       
*                                                                               
         MVC   P1+0(20),0(RF)                                                   
         MVC   P2+0(20),DASHES                                                  
         LA    R4,P1+20                                                         
         LA    R5,P2+20                                                         
FMKT9    CLI   0(R4),C' '                                                       
         BH    FMKT10                                                           
         MVI   0(R5),C' '                                                       
         BCTR  R4,0                                                             
         BCTR  R5,0                                                             
         B     FMKT9                                                            
FMKT10   DS    0H                                                               
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMMKT',0)    EDI CALL                           
**EDI**                                                                         
FMKTX    DS    0H                                                               
         B     RBEXT                                                            
         SPACE 2                                                                
FPERG    DS    0H                                                               
         CLI   UPASS,X'FF' IGNORE PERCTL RESET FOR SUMMARY PASS                 
         BER   RE          WAS C'S'                                             
         CLI   PRIOR,C'W'          1 +24 PRIOR ON SEPARATE INV                  
         BE    FPERG5                                                           
         CLI   PRIOR,C'M'                                                       
         BNER  RE                                                               
FPERG5   MVI   PERCTL,C'T'         RESET PERCTL                                 
         L     RF,APERG                                                         
         CLI   0(RF),C'5'          TEST A SEPARATE CURRENT MONTH                
         BNER  RE                  NO                                           
         MVI   PERCTL,C'S'         YES - TREAT AS SEP                           
         BR    RE                                                               
         SPACE 3                                                                
FCTYP    DS    0H                                                               
         BR    RE                                                               
         SPACE 3                                                                
FCRDB    DS    0H                                                               
         BR    RE                                                               
         SPACE 2                                                                
FPUB     LR    R0,RE                                                            
         BRAS  RE,FSTPUB                                                        
         LR    RE,R0                                                            
         XC    ITEMCNT,ITEMCNT       USED TO COUNT ITEMS                        
         BR    RE                                                               
         SPACE 2                                                                
FEST     LR    R0,RE                                                            
         GOTO1 =A(FSTEST)         FEST NOW IN ITS OWN CSECT                     
         LR    RE,R0                                                            
         BR    RE                                                               
*                                                                               
         SPACE 2                                                                
FPRD     LR    R0,RE                                                            
         GOTO1 =A(FSTPRD)         FPRD NOW IN ITS OWN CSECT                     
         LR    RE,R0                                                            
         BR    RE                                                               
*                                                                               
FJOB     DS    0H                                                               
         LR    R0,RE               SAVE RETURN REG                              
         BRAS  RE,JOBFRST                                                       
         LR    RE,R0                                                            
         XC    MEDCNT,MEDCNT          USED TO COUNT MEDIA                       
*                                     FOR MULTI-MEDIA REQUEST                   
         BR    RE                                                               
         SPACE 2                                                                
*                                                                               
FDESC    DS    0H                                                               
         L     R1,ITEMCNT            COUNT DETAILS                              
         LA    R1,1(R1)              CLEARED AT FPUB                            
         ST    R1,ITEMCNT            CHECKED IN LPUB - LPUB8                    
*                                                                               
         BR    RE                                                               
         SPACE 2                                                                
FPER     DS    0H                                                               
         BR    RE                                                               
         SPACE 2                                                                
         EJECT                                                                  
LMED     NTR1                                                                   
         SPACE 2                                                                
*                                                                               
         BRAS  RE,BILCALC                                                       
         CLI   MEDCTL,C'N'                                                      
         BE    LMED10                                                           
         C     R3,ALOWTOG          IS THIS LOWEST TOGETHER                      
         BE    LMED8               YES                                          
         BH    LMEDX               BYPASS IF 'LOWER' (ON RECAPS)                
*                                  EST IS NOT LOWEST                            
         CLC   P1,SPACES                                                        
         BE    LMED5                                                            
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)            SINCE I MAY NOT HAVE PRINTED                 
*                                  EST NAME YET                                 
LMED5    DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   P1+2(12),=C'MEDIA TOTALS'                                        
         MVC   P1+2(L'PP@MDTOT),PP@MDTOT                                        
         DROP  RE                                                               
         CLI   PRDMKT,C'M'                                                      
         BE    LMED8                                                            
*--->    MVI   P1+1,C'*'          NOT NEEDED SINCE PP@MDTOT HAS *'S             
*--->    MVI   P1+14,C'*'                                                       
         MVC   TOTSTAR,=C'* '                                                   
         SPACE 2                                                                
LMED8    DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   TOTNAME,=CL12'MEDIA'                                             
         MVC   TOTNAME,SPACES                                                   
         MVC   TOTNAME(L'PP@MED),PP@MED                                         
         DROP  RE                                                               
         BRAS  RE,TOTOUT                                                        
         MVC   TOTSTAR,SPACES                                                   
*                                                                               
         BRAS  RE,PRTADJ           PRINT ADJUSTMENTS                            
         B     LMEDX                                                            
LMED10   DS    0H                                                               
LMEDX    DS    0H                                                               
         B     RBEXT                                                            
         EJECT                                                                  
*        LAST FOR PRODUCT GROUP                                                 
         SPACE 2                                                                
LPGR1    DS    0H                                                               
         LA    R5,PGR1             PGR1 DATA                                    
         B     LPGRA                                                            
         SPACE 2                                                                
LPGR2    DS    0H                                                               
         LA    R5,PGR2             PGR2 DATA                                    
         B     LPGRA                                                            
         SPACE 2                                                                
LPGR3    DS    0H                                                               
         LA    R5,PGR3             PGR3 DATA                                    
         B     LPGRA                                                            
         SPACE 2                                                                
LPGRA    NTR1                                                                   
         SPACE 2                                                                
*                                                                               
         CLI   UPASS,X'FF'     SEE IF CORP SUMMARY PASS - WAS C'S'              
         BNE   LPGRA5              SKIP DIV                                     
         CLC   QPUB+1(3),=C'RD='   AND USING DRD OVERRIDE CLT                   
         BE    LPGRX               SKIP DIV                                     
*                                                                               
LPGRA5   DS    0H                                                               
         C     R3,ALOWTOG          IS THIS LOWEST TOG                           
         BE    LPGRA8              YES                                          
         BH    LPGRX               BYPASS IF 'LOWER' (ON RECAPS)                
*                                  PGR NOT LOWEST                               
         MVC   P1(2),=C'**'                                                     
         MVC   P1+2(12),6(R5)      DESC                                         
         LA    RF,P1+14                                                         
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
*                                                                               
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   2(8,RF),=C'TOTALS**'                                             
         MVC   2(L'PP8TOTAL,RF),PP8TOTAL                                        
         DROP  RE                                                               
         MVC   TOTSTAR,=C'* '                                                   
         SPACE 2                                                                
LPGRA8   DS    0H                                                               
         MVC   TOTNAME,6(R5)       SAVE DESCRIPTION                             
         BRAS  RE,TOTOUT                                                        
         MVC   TOTSTAR,SPACES                                                   
         BRAS  RE,PRTADJ                                                        
LPGRX    DS    0H                                                               
         B     RBEXT                                                            
         EJECT                                                                  
*        LAST FOR PRODUCT                                                       
         SPACE 2                                                                
LPRD     NTR1                                                                   
         SPACE 2                                                                
*                                                                               
LPRD2    BRAS  RE,BILCALC                                                       
         CLI   PRDCTL,C'N'                                                      
         BE    LPRD10                                                           
*                                                                               
         L     R5,=A(DICSECT)                                                   
         USING DICSECT,R5                                                       
*                                                                               
         CLI   PUSRSW,C'Y'         PRD USER CONTROL                             
         BNE   LPRD2NH                                                          
         C     R3,ALOWTOG          IS THIS LOWEST TOGETHER                      
         BH    LPRDX               BYPASS IF 'LOWER' (ON RECAPS)                
         B     LPRD2X                                                           
*                                  PRD NOT LOWEST                               
LPRD2NH  C     R3,ALOWTOG          IS THIS LOWEST TOGETHER                      
         BE    LPRD8               YES                                          
         BH    LPRDX               BYPASS IF 'LOWER' (ON RECAPS)                
*                                  PRD NOT LOWEST                               
LPRD2X   CLC   P1,SPACES                                                        
         BE    LPRD5                                                            
*                                                                               
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)            SINCE I MAY NOT HAVE PRINTED                 
*                                  PRD NAME YET                                 
LPRD5    DS    0H                                                               
*--->    MVC   P1+2(14),=C'PRODUCT TOTALS'                                      
         MVC   P1+2(L'PP@PRDTL),PP@PRDTL                                        
         CLI   PRDMKT,C'M'                                                      
         BE    LPRD8                                                            
         MVI   P1+1,C'*'                                                        
         MVI   P1+16,C'*'                                                       
         MVC   TOTSTAR,=C'* '                                                   
         SPACE 2                                                                
LPRD8    DS    0H                                                               
*--->    MVC   TOTNAME,=CL12'PRODUCT'                                           
         MVC   TOTNAME,SPACES                                                   
         MVC   TOTNAME(L'PP7PRO),PP7PRO                                         
         DROP  R5                                                               
         BRAS  RE,TOTOUT                                                        
         MVC   TOTSTAR,SPACES                                                   
*                                  TEST NEED TO SAVE CORP DATA NOW              
         CLI   SUMLEV,C'P'                                                      
         BE    LPRD9                                                            
         CLI   SUMLEV,0                                                         
         BH    LPRD9B                                                           
         MVI   SUMLEV,C'P'         CORP DATE SAVED AT PRD LEVEL                 
LPRD9    DS    0H                                                               
         BRAS  RE,SAVCORP                                                       
*                                                                               
LPRD9B   DS    0H                                                               
         BRAS  RE,PRTADJ                                                        
*                                                                               
         B     LPRDX                                                            
LPRD10   DS    0H                                                               
LPRDX    DS    0H                                                               
         MVC   FORMAT,SVFORMAT      RESTORE FORMAT,STRIP + DOLNUM               
         MVC   STRIP,SVSTRIP                                                    
         MVC   DOLNUM,SVDOLN                                                    
         MVC   TWOCOL,SV2COL                                                    
         B     RBEXT                                                            
         EJECT                                                                  
*        LAST FOR ESTIMATE                                                      
         SPACE 2                                                                
LEST     NTR1                                                                   
         SPACE 2                                                                
*                                                                               
         BRAS  RE,BILCALC                                                       
         CLI   ESTCTL,C'N'                                                      
         BE    LEST10                                                           
*                                                                               
         L     R5,=A(DICSECT)                                                   
         USING DICSECT,R5                                                       
         C     R3,ALOWTOG          IS THIS LOWEST TOGETHER                      
         BE    LEST8               YES                                          
         BH    LESTX               BYPASS IF 'LOWER' (ON RECAPS)                
*                                  EST IS NOT LOWEST                            
         CLC   P1,SPACES                                                        
         BE    LEST5                                                            
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)            SINCE I MAY NOT HAVE PRINTED                 
*                                  EST NAME YET                                 
LEST5    DS    0H                                                               
*--->    MVC   P1+2(15),=C'ESTIMATE TOTALS'                                     
         MVC   P1+2(L'PP@ESTOT),PP@ESTOT                                        
         CLI   PRDMKT,C'M'                                                      
         BE    LEST8                                                            
         MVI   P1+1,C'*'                                                        
         MVI   P1+17,C'*'                                                       
         MVC   TOTSTAR,=C'* '                                                   
         SPACE 2                                                                
LEST8    DS    0H                                                               
*--->    MVC   TOTNAME,=CL12'ESTIMATE'                                          
         MVC   TOTNAME,SPACES                                                   
         MVC   TOTNAME(L'PP@EST),PP@EST                                         
         BRAS  RE,TOTOUT                                                        
         MVC   TOTSTAR,SPACES                                                   
         DROP  R5                                                               
*                                                                               
         BRAS  RE,SAVCORP                                                       
         MVI   SUMLEV,C'E'         CORP DATA SAVED AT EST LEVEL                 
         BRAS  RE,PRTADJ           PRINT ADJUSTMENTS                            
         B     LESTX                                                            
LEST10   DS    0H                                                               
LESTX    DS    0H                                                               
         MVC   FORMAT,SVPFORMT       RESTORE FORMAT,STRIP AND DOLNUM            
         MVC   STRIP,SVPSTRIP                                                   
         MVC   DOLNUM,SVPDOLN                                                   
         MVC   TWOCOL,SVP2COL                                                   
         B     RBEXT                                                            
         EJECT                                                                  
*        LAST FOR MARKET GROUP                                                  
         SPACE 2                                                                
LMGR1    DS    0H                                                               
         LA    R5,MGR1             MGR1 DATA                                    
         L     R6,AMGR1                                                         
         B     LMGRA                                                            
         SPACE 2                                                                
LMGR2    DS    0H                                                               
         LA    R5,MGR2             MGR2 DATA                                    
         L     R6,AMGR2                                                         
         B     LMGRA                                                            
         SPACE 2                                                                
LMGR3    DS    0H                                                               
         LA    R5,MGR3             MGR3 DATA                                    
         L     R6,AMGR3                                                         
         B     LMGRA                                                            
         SPACE 2                                                                
LMGRA    NTR1                                                                   
         SPACE 2                                                                
         C     R3,ALOWTOG          IS THIS LOWEST TOGETHER                      
         BE    LMGRA8              YES                                          
         BH    LMGRX               BYPASS IF 'LOWER' (ON RECAPS)                
*                                  MGR NOT LOWEST                               
         MVC   P1,SPACES                                                        
         MVC   P2,SPACES                                                        
         MVC   P3,SPACES                                                        
         MVC   P1(2),=C'**'                                                     
         C     R3,AINVBRK          IF END OF INV                                
         BE    *+10                SKIP DESC IN TOTAL                           
         MVC   P1+3(12),6(R5)                                                   
         LA    R4,P1+14                                                         
LMGRA6   CLI   0(R4),C' '                                                       
         BH    LMGRA7                                                           
         BCT   R4,LMGRA6                                                        
LMGRA7   MVC   2(3,R4),0(R6)       MOVE CODE                                    
         LA    RF,P1+18                                                         
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
*                                                                               
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   2(9,RF),=C'TOTALS **'                                            
         MVC   2(L'PP9TOTAL,RF),PP9TOTAL                                        
         DROP  RE                                                               
         MVC   TOTSTAR,=C'* '                                                   
         C     R3,AINVBRK                                                       
         BE    LMGR17D                                                          
         MVI   P3,0                                                             
         CLI   TWOCOL,C'Y'            DISPLAY NAME HERE ALSO                    
         BNE   *+14                                                             
         MVC   P2(24),18(R5)                                                    
         B     LMGR17D                                                          
         GOTO1 =V(CHOPPER),DMCB,(24,18(R5)),(20,P2),(C'P',2)                    
LMGR17D  DS    0H                                                               
*                                                                               
LMGRA8   DS    0H                                                               
         MVC   TOTNAME,6(R5)       SAVE DESCRIPTION                             
         BRAS  RE,TOTOUT                                                        
         MVC   TOTSTAR,SPACES                                                   
*                                                                               
LMGRX    DS    0H                                                               
         B     RBEXT                                                            
         EJECT                                                                  
*        LAST FOR MARKET                                                        
         SPACE 2                                                                
LMKT     NTR1                                                                   
         SPACE 2                                                                
         CLI   MKTCTL,C'N'                                                      
         BE    LMKT10              NO MKT ON BILL                               
         CLI   MKTCTL,0                                                         
         BE    LMKT10              NO MKT ON BILL                               
*                                                                               
         L     R5,=A(DICSECT)                                                   
         USING DICSECT,R5                                                       
         CLI   UPASS,X'FF'         FOR RETAIL SUMMARY - WAS C'S'                
         BNE   LMKT2                                                            
         BRAS  RE,BILCALC          DO CALCS NOW                                 
LMKT2    DS    0H                                                               
         C     R3,ALOWTOG          IS THIS LOWEST BREAK                         
         BE    LMKT6               YES                                          
         BH    LMKTX               BYPASS IF 'LOWER' (ON RECAPS)                
*                                  MKT NOT LOWEST                               
         L     RE,AMKT                                                          
**WB**   CLC   XXMKT,0(RE)                                                      
**WB**   BE    LMKT10              BYPASS PRINTING FOR DUMMY MARKET             
         CLC   P1,SPACES                                                        
         BE    LMKT3                                                            
         GOTO1 =A(PRNT)            MIGHT STILL NEED TO PRINT MKT                
*                                                                               
LMKT3    CLI   PERCTL,C'T'                                                      
         BNE   LMKT4                                                            
         LA    RF,P1+2                                                          
*--->    MVC   0(13,RF),=C'MARKET TOTALS'                                       
         MVC   0(L'PPAMKTST,RF),PPAMKTST                                        
         B     LMKT6                                                            
LMKT4    DS    0H                                                               
*--->    MVC   P1+07(15),=C'MARKET  *TOTAL*'                                    
         MVC   P1+07(L'PPBMKTST),PPBMKTST                                       
         B     LMKT6                                                            
LMKT4B   DS    0H                                                               
*--->    MVC   P1+01(12),=C'MKT  *TOTAL*'                                       
         MVC   P1+01(L'PPCMKTST),PPCMKTST                                       
*                                                                               
LMKT6    DS    0H                                                               
         MVC   TOTSTAR,=C'* '                                                   
*--->    MVC   TOTNAME,=CL12'MARKET'                                            
         MVC   TOTNAME,SPACES                                                   
         MVC   TOTNAME(L'PP@MARKT),PP@MARKT                                     
         BRAS  RE,TOTOUT                                                        
         MVC   TOTSTAR,SPACES                                                   
         DROP  R5                                                               
LMKT10   DS    0H                                                               
LMKTX    DS    0H                                                               
         B     RBEXT                                                            
         EJECT                                                                  
*        LAST FOR PUB                                                           
         SPACE 2                                                                
LPUB     NTR1                                                                   
         SPACE 2                                                                
         CLI   PUBCTL,C'N'        NO PUB ON BILL                                
         BE    LPUB10                                                           
         L     R4,APUB                                                          
         CLC   0(6,R4),XXPUB       SPECIAL CODE FOR MANAUL BILLS                
         BE    LPUB10                                                           
         CLC   0(6,R4),=X'FFFFFFFFFFFF'   SPECIAL CODE FOR PREV                 
         BE    LPUB10              BILLED INS FOR ALL PUBS                      
*                                  DON'T PRINT VENDOR TOTALS                    
*                                                                               
         L     R7,=A(DICSECT)                                                   
         USING DICSECT,R7                                                       
         C     R3,ALOWTOG                                                       
         BH    LPUBX               BYPASS IF 'LOWER' (ON RECAPS)                
         BL    LPUB8                                                            
         LA    R5,P1+0                                                          
LPUB6    DS    0H                                                               
         LR    RF,R5                                                            
         SH    RF,=H'2'                                                         
         CLC   0(20,RF),SPACES      SEE IF CAN PRINT ON SAME LINE               
         BNE   LPUB6B              NO                                           
         CLC   P2,SPACES                                                        
         BE    LPUB7                                                            
LPUB6B   DS    0H                                                               
         GOTO1 =A(PRNT)                                                         
LPUB7    DS    0H                                                               
         L     R4,APUB                                                          
         CLC   XXPUB,0(R4)                                                      
         BNE   LPUB7A                                                           
         CLC   BORDSW(3),=C'YNN'   FOR 'ORDERED ONLY' FORMATS                   
         BE    LPUBX               SKIP PREV BILL MKT                           
         CLI   PRDMKT,C'M'         IF MKT HIGHER THAN PRD                       
         BNE   LPUB7B                                                           
         MVI   0(R5),C'.'             FORCE PRINTING                            
         B     LPUB7B                                                           
LPUB7A   DS    0H                                                               
         CLI   PUBCTL,C'S'            SEE IF PUB ON SEPERATE INVOIVE            
         BE    LPUB7B                 SKIP - PUB WILL PRINT AT RB16J            
*                                                                               
         CLI   PROGPRO2+7,7           CHECK IF DETAIL BACK-UP AT PUB            
         BE    LPUB7B                 SKIP PUB WILL AREADY HAVE PRINTED         
*                                                                               
         MVC   0(60,R5),PPUBL1                                                  
         CLI   PPUBL2,C' '                                                      
         BNH   *+10                                                             
         MVC   132(20,R5),PPUBL2                                                
*                                      SEE IF I MUST PRINT PUB NOW              
         CLC   40(10,R5),SPACES                                                 
         BNE   LPUB7A5                                                          
         CLI   TWOCOL,C'Y'                                                      
         BE    LPUB7B                                                           
         CLC   20(10,R5),SPACES                                                 
         BE    LPUB7B                                                           
*                                                                               
LPUB7A5  GOTO1 =A(PRNT)                                                         
*                                                                               
LPUB7B   DS    0H                                                               
         MVC   TOTSTAR,=C'* '                                                   
*--->    MVC   TOTNAME,=CL12'VENDOR'                                            
         MVC   TOTNAME,SPACES                                                   
         MVC   TOTNAME(L'PP@VEND),PP@VEND                                       
         BRAS  RE,TOTOUT                                                        
         MVC   TOTSTAR,SPACES                                                   
         B     LPUBX                                                            
*                                  PUB NOT LOWEST TOG (SPOT DETS)               
LPUB8    DS    0H                                                               
         GOTO1 =A(PRNT)            SINCE PUB TAKES A LINE                       
         OC    ARECAP,ARECAP       SEE IF DOING RECAP PASS                      
         BNZ   LPUB8A                                                           
         CLI   NOINSSW,C'Y'        FIRST CHK IF NOT SHOWING                     
         BE    LPUB8B              INSERT DETAILS ON MAIN BILL                  
*                          IF YES - ALWAYS PRINT VENDOR TOTALS                  
*                                                                               
         CLI   PROFB1A+5,C'Y'      EDI CLIENT?                                  
         BE    LPUB8B              YES, BYPASS ITEM COUNT CHECK                 
         CLI   PROFB1A+5,C'F'                                                   
         BE    LPUB8B                                                           
*                                                                               
LPUB8A   CLC   ITEMCNT,=F'1'      NO TOTALS IF ONLY ONE INSERTION               
         BH    LPUB8A5                                                          
         BL    LPUBX              NO ITEMS FOR PUB                              
*                                                                               
LPUB8A2  DS    0H                                                               
         CLC   QAGENCY,=C'M2'     MEDIACOM?                                     
         BNE   LPUBX                                                            
*                                                                               
         L     R2,ACTYP                                                         
         OC    0(2,R2),0(R2)      DID I JUST DO AN ADDITIONAL CHARGE?           
         BNZ   LPUBX              IF SO DO NOTHING                              
*                                                                               
         MVI   P1,0               BE SURE IT PRINTS                             
         GOTO1 =A(PRNT)           SKIP ANOTHER LINE BETWEEN PUBS                
         B     LPUBX              WHEN ONLY ONE INSERTION                       
*                                 OR WHEN PUB TOTALS ARE SUPPRESSED             
*                                                                               
LPUB8A5  CLI   NOZEOPT,C'T'       SEE IF SUPRESSING PUB TOTALS                  
         BE    LPUB8A2                                                          
*                                                                               
LPUB8B   DS    0H                                                               
*--->    MVC   P1+4(14),=CL14'VENDOR  TOTALS'                                   
         MVC   P1+4(L'PP@VNTOT),PP@VNTOT                                        
***E***                                                                         
         CLI   NOPMBRK,C'Y'                                                     
         BE    LPUB8C                                                           
***E***                                                                         
         CLI   PERCTL,C'T'                                                      
         BE    LPUB8D                                                           
LPUB8C   MVC   P1+4(L'PP@VSTOT),PP@VSTOT                                        
LPUB8D   DS    0H                                                               
*                                                                               
         B     LPUB7B                                                           
*                                                                               
LPUB10   DS    0H                                                               
LPUBX    DS    0H                                                               
         DROP  R7                                                               
         B     RBEXT                                                            
*                                                                               
*        LAST FOR DESCRIPTION - MOVED TO ITS OWN CSECT                          
LDESC    LR    R0,RE               SAVE RETURN REG                              
         BRAS  RE,LASTDSC                                                       
         LR    RE,R0                                                            
         BR    RE                                                               
         SPACE 2                                                                
*                                                                               
LJOB     NTR1                                                                   
         CLI   JOBCTL,C'N'         SEE IF NO SHOWING JOB                        
         BE    LJOBX               AS A CONTROL                                 
         CLI   JOBCTL,0                                                         
         BE    LJOBX                                                            
*                                                                               
LJOB1    DS    0H                                                               
         OC    AMED,AMED          SEE IF MULTI-MEDIA REQUEST                    
         BZ    LJOB1D                                                           
         CLI   JOBCTL,C'S'        SEE IF JOB ON SEPERATE INV                    
         BNE   LJOB1D                                                           
         CLC   MEDCNT,=F'1'       SEE IF ONLY ONE MEDIA                         
         BNE   LJOB1D             SKIP JOB TOTALS                               
         C     R3,AINVBRK         MUST ALSO BE INVOICE BREAK                    
         BNE   LJOB1D                                                           
         B     LJOBX                                                            
*                                                                               
LJOB1D   DS    0H                                                               
         L     R7,=A(DICSECT)                                                   
         USING DICSECT,R7                                                       
         C     R3,ALOWTOG                                                       
         BH    LJOBX               BYPASS IF 'LOWER' (ON RECAPS)                
         BL    LJOB8                                                            
*                                                                               
LJOB2    DS    0H                                                               
*--->    MVC   TOTNAME,=CL12'AD CODE'                                           
         MVC   TOTNAME,SPACES                                                   
         MVC   TOTNAME(L'PPAADCOD),PPAADCOD                                     
*                                                                               
         CLI   PO#OPT,C'Y'          BILLING BY PO#                              
         BNE   LJOB4                                                            
         MVC   TOTNAME,SPACES                                                   
         MVC   TOTNAME(L'PO#ANNO),PO#ANNO                                       
         B     LJOB6                                                            
**WB**                                                                          
LJOB4    CLI   WBSW,C'Y'            WB FLIGHT FEATURE?                          
         BNE   *+16                                                             
         MVC   TOTNAME,SPACES                                                   
         MVC   TOTNAME,=CL12'FLIGHT'                                            
**WB**                                                                          
LJOB6    MVC   TOTSTAR,=C'* '                                                   
         BRAS  RE,TOTOUT                                                        
         MVC   TOTSTAR,SPACES                                                   
         B     LJOBX                                                            
LJOB8    DS    0H                                                               
         GOTO1 =A(PRNT)            SINCE JOB TAKES A LINE                       
LJOB8B   DS    0H                                                               
*--->    MVC   P1+3(15),=CL15'AD CODE  TOTALS'                                  
         MVC   P1+3(L'PPAADCOD),PPAADCOD                                        
         LA    RE,P1+3                                                          
         LA    RE,L'PPAADCOD(RE)                                                
         LA    RE,1(RE)                                                         
*                                                                               
         CLI   PO#OPT,C'Y'          BILLING BY PO#                              
         BNE   LJOB8B5                                                          
         MVC   P1+3(15),SPACES                                                  
         MVC   P1+3(L'PO#ANNO),PO#ANNO                                          
         LA    RE,P1+3+L'PO#ANNO                                                
LJOB8B2  CLI   0(RE),C' '            SCAN BACKWARD                              
         BH    LJOB8B3                                                          
         BCT   RE,LJOB8B2                                                       
LJOB8B3  LA    RE,2(RE)                                                         
         DROP  R7                                                               
*                        SPECIAL CODE NEEDED TO ADDRESS PP6TOTAL                
LJOB8B5  L     R7,=A(DICSECT)                                                   
         AH    R7,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,R7                                                        
         MVC   0(L'PP6TOTAL,RE),PP6TOTAL                                        
*                                                                               
         DROP  R7                                                               
*                                                                               
         L     R7,=A(DICSECT)       RESET R7 FOR OTHER DDICT WORDS              
         USING DICSECT,R7                                                       
***E***                                                                         
         CLI   NOPMBRK,C'Y'                                                     
         BE    LJOB8C                                                           
***E***                                                                         
         CLI   PERCTL,C'T'                                                      
         BE    LJOB8D                                                           
*--->    MVI   P1+11,C'*'           LABEL WAS LJOB8C                            
*--->    MVI   P1+17,C'*'                                                       
LJOB8C   MVC   0(L'PP8TOTS,RE),PP8TOTS       *TOTALS*                           
*                                                                               
LJOB8D   DS    0H                                                               
*                                                                               
         B     LJOB2                                                            
*                                                                               
*                                                                               
LJOBX    MVI   JOBACTSW,C'N'                                                    
         B     RBEXT                                                            
*        LAST FOR PERIOD                                                        
LPER     DS    0H                                                               
*                                                                               
LPERG    DS    0H                                                               
         C     R3,AINVBRK          IF INVOICE BREAK                             
         BNE   LPERGX                                                           
         CLI   PASSNO,2            AND PASS 2                                   
         BNE   LPERGX                                                           
         L     R7,=A(DICSECT)                                                   
         USING DICSECT,R7                                                       
*                                  PRINT TOTALS                                 
*--->    MVC   P1(12),=C'** TOTALS **'                                          
         MVC   P1(L'PP@TOTS),PP@TOTS                                            
         LR    R0,RE                                                            
         MVC   TOTSTAR,=C'**'                                                   
         BRAS  RE,TOTOUT                                                        
         MVC   TOTSTAR,SPACES                                                   
         LR    RE,R0                                                            
*                                                                               
         CLI   PRIOR,C'W'          SEE IF PRIOR ON SEPERATE INV                 
         BE    LPERG5              1 +24                                        
         CLI   PRIOR,C'M'          SEE IF PRIOR ON SEPERATE INV                 
         BNE   LPERGX                                                           
LPERG5   MVI   PERCTL,C'T'         RESET PERCTL TO  TOGETHER                    
*                                  NEEDED SINCE PERCTL IS CHECKED               
*                                  IN BUYBK                                     
LPERGX   BR    RE                                                               
         DROP  R7                                                               
         SPACE 2                                                                
LCTYP    DS    0H                                                               
LCRDB    DS    0H                                                               
         C     R3,AINVBRK          IF INVOICE BREAK                             
         BNER  RE                                                               
         CLI   PASSNO,2            AND PASS 2                                   
         BNER  RE                                                               
*                                  PRINT TOTALS                                 
         L     R7,=A(DICSECT)                                                   
         USING DICSECT,R7                                                       
*--->    MVC   P1(12),=C'** TOTALS **'                                          
         MVC   P1(L'PP@TOTS),PP@TOTS                                            
         LR    R0,RE                                                            
         MVC   TOTSTAR,=C'**'                                                   
         DROP  R7                                                               
         BRAS  RE,TOTOUT                                                        
         MVC   TOTSTAR,SPACES                                                   
         LR    RE,R0                                                            
         BR    RE                                                               
         EJECT                                                                  
*                             ROLLUP - ADD TO NEXT ACCUM                        
ROLLUP   NTR1                                                                   
         SPACE 2                                                                
*                                                                               
         L     RF,BRKCODE                                                       
         L     R4,ATOTS(RF)                                                     
         LA    R5,MAXMOS+1                                                      
RU2      DS    0H                                                               
         OC    0(ROWTL,R4),0(R4)    **NOTE- LEN WAS ROWL                        
         BZ    RU6                                                              
         LA    R0,ROWL/4                                                        
         LR    RE,R4                                                            
         LH    R2,TOTSIZH          USED AS INDEX REG                            
RU4      DS    0H                                                               
         L     RF,0(R2,R4)                                                      
         A     RF,0(R4)                                                         
         ST    RF,0(R2,R4)                                                      
         LA    R4,4(R4)                                                         
         BCT   R0,RU4                                                           
         XC    000(256,RE),000(RE)                                              
         XC    256(256,RE),256(RE)                                              
         XC    512(ROWL-512,RE),512(RE)                                         
         B     *+8                                                              
RU6      DS    0H                                                               
         LA    R4,ROWL(R4)                                                      
         BCT   R5,RU2                                                           
*                                                                               
         L     RF,BRKCODE                                                       
         L     R4,ATOTS(RF)      POINT TO ACCUM                                 
         AH    R4,=Y(TOTSIZE-BFORML)    POINT TO FORMULA INFO                   
         LR    R5,R4                                                            
         AH    R5,TOTSIZH          R5 POINTS TO NEXT ACCUMS FORMULA             
         USING BFORMD,R4                                                        
*                                  ROLL UP BILL FORMULA                         
         OC    0(BFORML,R5),0(R5)  ANY ALREADY THERE?                           
         BNZ   *+14                                                             
         MVC   0(BFORML,R5),BFBASA NO, JUST MOVE THIS ONE UP                    
         B     RU16                                                             
*                                                                               
         CLC   BFBASA,BFBASA-BFORMD(R5) IS BASE THE SAME?                       
         BE    *+8                                                              
         MVI   BFBASA-BFORMD(R5),X'FF'   NO, SET HAVE UNEQUAL BASES             
*                                                                               
         CLC   BFCOMP,BFCOMP-BFORMD(R5)  IS COMMISSION THE SAME?                
         BE    *+10                                                             
         MVC   BFCOMP-BFORMD(4,R5),FFS   NO, SET UNEQUAL COMMISSIONS            
*                                                                               
         CLC   BFRETSHR,BFRETSHR-BFORMD(R5)  RETAIL SHARE =?                    
         BE    *+10                                                             
         MVC   BFRETSHR-BFORMD(3,R5),FFS   UNEQUAL RETAIL SHRS                  
*                                                                               
         OC    BFTAXMIX-BFORMD(1,R5),BFTAXMIX   MIXED TX STATUS                 
*                                                                               
         CLC   BFAORPCT,BFAORPCT-BFORMD(R5)                                     
         BE    *+10                                                             
         MVC   BFAORPCT-BFORMD(3,R5),FFS     UNEQUAL AOR PCTS                   
*                                                                               
         LA    RE,BFVATCOD         DO VAT CODES INDIVIDUALLY                    
         LA    RF,BFVATCOD-BFORMD(R5)                                           
         LA    R0,NPROVS+1                                                      
         B     RU8A             ?? FOR GST SKIP ALREADY THERE CHECK             
RU8      DS    0H                                                               
         CLI   0(RF),C' '          IF NOTHING ALREADY THERE                     
         BH    *+14                                                             
         MVC   0(1,RF),0(RE)       USE CURRENT VALUE                            
         B     RU8A2                                                            
RU8A     DS    0H                                                               
         CLC   0(1,RE),0(RF)                                                    
         BE    *+8                                                              
         MVI   0(RF),X'FF'         UNEQUAL                                      
RU8A2    DS    0H                                                               
         LA    RE,1(RE)                                                         
         LA    RF,1(RF)                                                         
         BCT   R0,RU8                                                           
*                                                                               
         LA    RE,BFVATSW          DO VAT SWS INDIVIDUALLY                      
         LA    RF,BFVATSW-BFORMD(R5)                                            
         LA    R0,NPROVS+1                                                      
RU8B     DS    0H                                                               
         CLC   0(1,RE),0(RF)                                                    
         BE    *+8                                                              
         MVI   0(RF),X'FF'         UNEQUAL                                      
         LA    RE,1(RE)                                                         
         LA    RF,1(RF)                                                         
         BCT   R0,RU8B                                                          
*                                                                               
RU16     DS    0H                                                               
         XC    BFBASA(BFORML),BFBASA    CLEAR OLD ONE                           
*                                                                               
RUX      DS    0H                                                               
         B     RBEXT                                                            
         EJECT                                                                  
*        ULINE IN FIRST BLANK LINE                                              
ULINE    NTR1                                                                   
*                                  FIND FIRST BLANK LINE                        
         LA    R3,P1                                                            
         SR    RE,RE                                                            
UL2      DS    0H                                                               
         OC    0(40,R3),SPACES                                                  
         CLC   0(40,R3),SPACES                                                  
         BE    UL4                                                              
         LA    R3,132(R3)                                                       
         LA    RE,1(RE)                                                         
         B     UL2                                                              
*                                                                               
UL4      DS    0H                                                               
         LTR   RE,RE                                                            
         BNP   ULX                                                              
*                                                                               
         LA    RF,P1+40                                                         
UL5      DS    0H                                                               
         LR    R1,RF                                                            
         LR    R0,RE                                                            
UL6      DS    0H                                                               
         CLI   0(R1),C' '                                                       
         BH    UL8                 FIRST NON-BLACK CHAR                         
         LA    R1,132(R1)                                                       
         BCT   R0,UL6                                                           
*                                                                               
         BCT   RF,UL5                                                           
*                                                                               
UL8      DS    0H                                                               
         LA    R0,P1                                                            
         SR    RF,R0                                                            
         BM    ULX                                                              
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),DASHES                                                   
*                                                                               
ULX      DS    0H                                                               
         B     RBEXT                                                            
         SPACE 3                                                                
ITEMCNT  DS    F                                                                
         LTORG                                                                  
*                                                                               
DSAVKEY  DS    CL32                                                             
*                                                                               
         SPACE 3                                                                
BRKLIST  DS    0C                                                               
         DC    C'MED '                                                          
         DC    C'PGR1'                                                          
         DC    C'PGR2'                                                          
         DC    C'PGR3'                                                          
         DC    C'PRD '                                                          
         DC    C'EST '                                                          
         DC    C'MGR1'                                                          
         DC    C'MGR2'                                                          
         DC    C'MGR3'                                                          
         DC    C'MKT '                                                          
         DC    C'JOB '                                                          
         DC    C'PUB '                                                          
         DC    C'DESC'                                                          
         DC    C'PER '                                                          
         DC    C'PERG'                                                          
         DC    C'CRDB'                                                          
*                                                                               
         DROP  R8                                                               
*                                                                               
*                                                                               
MOLSADDR DS    0C                                                               
         DC    CL36'MOLSON BREWERIES USA, INC.'                                 
         DC    CL26'11911 FREEDOM DRIVE'                                        
         DC    CL26'RESTON, VA.  22090-5609'                                    
         DC    CL26' '                                                          
         DC    CL26' '                                                          
*                                                                               
PASSREC  DS    CL187                                                            
PASSKEY  EQU   PASSREC                                                          
*                                                                               
         EJECT                                                                  
FSTMED   NMOD1 0,FSTMED                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         L     RF,AMED                                                          
         MVC   FINANSW,1(RF)        SET FINANCIAL SWITCH FROM BUFFER            
*                                                                               
         OC    FININVSW,FINANSW     OR ON FINANCIAL INVOICE SWITCH              
*                                   SO FININVSW WILL BE SET TO                  
*                                   FINANCIAL IF ANY OF THE MEDIAS              
*                                   ARE FINANCIAL                               
*                                   THIS IS USED FOR AOR,ADJ, AND CD            
*                                   INVOICES                                    
*                                   THIS SWITCH WILL BE RESET TO X'00'          
*                                   AFTER GOTO AENDINV                          
*                                                                               
         CLI   MEDCTL,C'N'                                                      
         BE    FMEDX                                                            
         CLI   JOBCTL,C'S'          SEE IF JOB SEPERATE                         
         BNE   FMED2                                                            
         OC    AMED,AMED                                                        
         BZ    FMED2               SEE IF MULTIMEDIA REQUEST                    
         L     RF,MEDCNT                                                        
         AH    RF,=H'1'                                                         
         ST    RF,MEDCNT                                                        
*                                                                               
FMED2    DS    0H                                                               
         CLC   P1,SPACES                                                        
         BE    FMED5                                                            
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
FMED5    XC    KEY,KEY                                                          
         MVC   KEY(2),QAGENCY                                                   
         L     RF,AMED                                                          
         MVC   KEY+2(1),0(RF)                                                   
         MVI   KEY+3,X'01'                                                      
         GOTO1 HIGH                                                             
         CLC   KEY(4),KEYSAVE                                                   
         BE    *+6                                                              
         DC    H'0'             FATAL ERROR                                     
*                                                                               
         GOTO1 GETAGY                                                           
         L     RF,PPFILEC                                                       
         USING PPFILED,RF                                                       
         MVC   P1(10),PAGYMED                                                   
         OC    P1(10),SPACES                                                    
*                                                                               
         CLC   P1(10),=C'INTERACTIV'                                            
         BE    FMED5B                                                           
         CLC   P1(9),=C'INTERACTV'  COVERS INTERACTV AND INTERACTVE             
         BE    FMED5B                                                           
         CLC   P1(6),=C'INTRAC'   INTRACTIVE AND OTHERS                         
         BE    FMED5B                                                           
         B     FMED5C                                                           
*                                                                               
FMED5B   MVC   P1(11),=C'INTERACTIVE'   11 CHARACTERS                           
*                                                                               
FMED5C   DS    0H                                                               
         BAS   RE,FMDULINE                                                      
*                                                                               
*                                  READ AAA PRDHDR                              
*                                  FOR ADDRESS AND FORMULA                      
*                                                                               
         L     R0,=A(AADDRS)                                                    
         LHI   R1,ADDRLEN                                                       
         SR    RE,RE                                                            
         LA    RF,X'40'                 FILL WITH SPACES                        
         SLL   RF,24                                                            
         MVCL  (R0),(RE)                                                        
*                                                                               
         XC    AAAFORM,AAAFORM                                                  
***      XC    AAAFORM2,AAAFORM2                                                
***      XC    AAAFORM3,AAAFORM3                                                
         L     RF,AAELIST                                                       
         MVC   0(6,RF),FFS                                                      
*                                                                               
         MVC   KEY1,KEY                                                         
*                                                                               
         NI    FLAG1,X'FF'-AADDRSW INIT AAA BILL ADDRESS REC FOUND              
         MVC   THREE,=C'AAA'       PRESET TO PROD AAA                           
         CLI   BILLADR,C'Y'        B8 PR3 READ BILL ADDRESS REC?                
         BNE   *+8                                                              
         BRAS  RE,RBILADDR         READ BILL ADDRESS REC                        
*                                                                               
         L     RF,ADCLT                                                         
         MVC   KEY(25),0(RF)                                                    
         L     RF,AMED                                                          
         MVC   KEY+2(1),0(RF)                                                   
         MVI   KEY+3,X'06'                                                      
         MVC   KEY+7(3),=C'AAA'                                                 
         GOTO1 HIGH                                                             
         CLC   KEY(25),KEYSAVE                                                  
         BNE   FMEDF5                                                           
         MVC   AREC,ADWKREC        READ INTO WORK REC                           
         GOTO1 GETPRT                                                           
         L     RF,AREC                                                          
         LA    RF,PPRDBILL-PPRDREC(RF)                                          
         CLC   =C'NONE',0(RF)                                                   
         BE    FMEDF4A                                                          
         CLC   =C'XX',0(RF)                                                     
         BE    FMEDF4A                                                          
         CLC   =C'X ',0(RF)                                                     
         BE    FMEDF4A                                                          
         CLI   0(RF),C'A'                                                       
         BL    FMEDF4A                                                          
         L     RE,=A(AADDRS)       CORP ADDRESS                                 
         TM    FLAG1,AADDRSW       AAA BILL ADDRESS REC FOUND?                  
         BO    FMED5D                                                           
         MVC   000(20,RE),00(RF)                                                
         MVC   060(30,RE),20(RF)                                                
         MVC   120(30,RE),50(RF)                                                
         MVC   180(24,RE),80(RF)                                                
**NEW 3/7/89                                                                    
*                        CHECK FOR SECOND BILL RECEIPT NAME LINE                
*                                                                               
FMED5D   L     R1,AREC              DID USE RE  NOW USE R1                      
         LA    R1,PPRDBIL2-PPRDREC(R1)  AND LEAVE RE SET TOAAADDRS              
*                                       RF IS STILL SET TO PPRDBILL             
         CLI   0(R1),C'A'                                                       
         BL    FMEDF4A                                                          
         CLC   =C'NONE',0(R1)                                                   
         BE    FMEDF4A                                                          
         CLC   =C'XX',0(R1)                                                     
         BE    FMEDF4A                                                          
         CLC   =C'X ',0(R1)                                                     
         BE    FMEDF4A                                                          
         TM    FLAG1,AADDRSW       AAA BILL ADDRESS REC FOUND?                  
         BO    FMEDF4A                                                          
         MVC   060(60,RE),SPACES      CLEAR                                     
         MVC   060(20,RE),0(R1)                                                 
         MVC   120(30,RE),20(RF)                                                
         MVC   180(30,RE),50(RF)                                                
         MVC   240(24,RE),80(RF)                                                
**NEW 3/7/89                                                                    
*                                                                               
FMEDF4A  DS    0H                                                               
         L     RF,AREC                                                          
         MVC   AAAFORM,PPRDBILP-PPRDREC(RF)    DATE, BASE + COMMISSION          
***      MVC   AAAFORM2,PPRDBILP+37-PPRDREC(RF)   2ND FORMULA + DATE            
***      MVC   AAAFORM3,PPRDBILP+44-PPRDREC(RF)   3ND FORMULA + DATE            
*                                                                               
*                                  BUILD LIST OF ANY AAA EST FORMULAS           
         L     R6,AAELIST          START                                        
         L     RF,AREC                                                          
         MVC   KEY,0(RF)                                                        
         L     RF,AMED                                                          
         MVC   KEY+2(1),0(RF)                                                   
         MVI   KEY+3,7                                                          
FMEDF4B  DS    0H                                                               
         GOTO1 SEQ                                                              
         CLC   KEY(10),KEYSAVE                                                  
         BNE   FMEDF5              DONE                                         
*                                                                               
         GOTO1 GETREC                                                           
         L     RF,AREC                                                          
         MVC   0(2,R6),10(RF)      EST NO.                                      
         MVC   2(37,R6),PESTBILP-PESTREC(RF)    FORMULA                         
         OC    2(37,R6),2(R6)                                                   
         BZ    FMEDF4D                                                          
         OC    2(5,R6),2(R6)                                                    
         BNZ   FMEDF4D                                                          
         MVC   2(2,R6),=X'0505'              SET DEFAULT                        
*                                     IF CHAB WITH NO FORMULA                   
*                                                                               
FMEDF4D  MVC   39(14,R6),PESTREVN+3-PESTREC(RF)    FORMULAS 2 + 3               
*                                                                               
**             2ND AND 3RD FORMULAS                                             
*                                                                               
         LA    R6,53(R6)                                                        
         MVC   0(6,R6),FFS         SET EOL                                      
         L     RE,AAELIST                                                       
         AH    RE,=H'5300'         MAX 100 ESTS                                 
         CR    R6,RE                                                            
         BL    FMEDF4B                                                          
         DC    H'0'                TABLE FULL                                   
*                                                                               
FMEDF5   DS    0H                                                               
         CLI   AORSW,C'Y'          IF DOING AOR                                 
         BNE   FMEDX                                                            
*                                  IF PRD AND EST ARE SEPERATE                  
*                                  I MUST GO TO GETAOR HERE                     
         CLI   PRDCTL,C'S'                                                      
         BNE   FMEDX                                                            
         CLI   ESTCTL,C'S'                                                      
         BNE   FMEDX                                                            
         BRAS  RE,GETAOR                                                        
*                                                                               
FMEDX    DS    0H                                                               
         XMOD1                                                                  
         EJECT                                                                  
*        ULINE IN FIRST BLANK LINE                                              
FMDULINE NTR1                                                                   
*                                  FIND FIRST BLANK LINE                        
         LA    R3,P1                                                            
         SR    RE,RE                                                            
FMDUL2   DS    0H                                                               
         OC    0(40,R3),SPACES                                                  
         CLC   0(40,R3),SPACES                                                  
         BE    FMDUL4                                                           
         LA    R3,132(R3)                                                       
         LA    RE,1(RE)                                                         
         B     FMDUL2                                                           
*                                                                               
FMDUL4   DS    0H                                                               
         LTR   RE,RE                                                            
         BNP   FMDULX                                                           
*                                                                               
         LA    RF,P1+40                                                         
FMDUL5   DS    0H                                                               
         LR    R1,RF                                                            
         LR    R0,RE                                                            
FMDUL6   DS    0H                                                               
         CLI   0(R1),C' '                                                       
         BH    FMDUL8              FIRST NON-BLACK CHAR                         
         LA    R1,132(R1)                                                       
         BCT   R0,FMDUL6                                                        
*                                                                               
         BCT   RF,FMDUL5                                                        
*                                                                               
FMDUL8   DS    0H                                                               
         LA    R0,P1                                                            
         SR    RF,R0                                                            
         BM    FMDULX                                                           
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),DASHES                                                   
*                                                                               
FMDULX   DS    0H                                                               
         XIT1                                                                   
         DROP  RF                                                               
         LTORG                                                                  
*                                                                               
         EJECT                                                                  
*                                                                               
FSTPRD   NMOD1 0,FSTPRD                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         SPACE 2                                                                
         MVC   SVFORMAT,FORMAT                                                  
         MVC   SVSTRIP,STRIP                                                    
         MVC   SVDOLN,DOLNUM                                                    
         MVC   SV2COL,TWOCOL                                                    
*                                                                               
FPRD2    DS    0H                     MUST ALWAYS READ PRD                      
         L     R4,APRD                                                          
         L     RF,ADCLT                                                         
         MVC   KEY(25),0(RF)                                                    
         OC    AMED,AMED           FOR MULTI-MEDIA REQ GET MEDIA                
         BZ    FPRD2B              FROM AMED                                    
         L     RF,AMED                                                          
         MVC   KEY+2(1),0(RF)                                                   
*                                                                               
FPRD2B   MVC   KEY+7(3),0(R4)      3 CHAR PRD CODE                              
         MVI   KEY+3,X'06'                                                      
         L     RF,ADPRD                                                         
         CLC   KEY(10),0(RF)       TEST ALREADY HAVE PRDREC                     
         BE    FPRD2X                                                           
         GOTO1 HIGH                                                             
         CLC   KEY(10),KEYSAVE                                                  
         BE    FPRD2C                                                           
         DC    H'0'               PRODUCT MUST BE ON FILE                       
*                                                                               
FPRD2C   L     RF,ADPRD                                                         
         ST    RF,AREC                                                          
         GOTO1 GETPRT                                                           
*                                                                               
FPRD2X   DS    0H                                                               
         L     RF,ADPRD                                                         
         CLI   SVWBSW,C'Y'     ORIGINAL WB SWITCH SET?                          
         BNE   FPRD3                                                            
         MVI   WBSW,C'Y'       RESET SWITCH                                     
*****    CLC   =C'001',PPRDDIV-PPRDREC(RF)                                      
*****    BE    FPRD3                                                            
         CLC   =C'100',PPRDDIV-PPRDREC(RF)                                      
         BE    FPRD3                                                            
*                                                                               
         CLC   QAGENCY,=C'OO'  FOR OMD MUST BE DIV 100,200,300,400,500          
         BNE   FPRD2X1         600, 700,800,900                                 
         CLC   =C'200',PPRDDIV-PPRDREC(RF) ASSIGNED TO DIV 200?                 
         BE    FPRD3               THEATRICAL - EXIT WITH RESET VALUES          
         CLC   =C'300',PPRDDIV-PPRDREC(RF) ASSIGNED TO DIV 300?                 
         BE    FPRD3               THEATRICAL - EXIT WITH RESET VALUES          
         CLC   =C'400',PPRDDIV-PPRDREC(RF) ASSIGNED TO DIV 400?                 
         BE    FPRD3               THEATRICAL - EXIT WITH RESET VALUES          
         CLC   =C'500',PPRDDIV-PPRDREC(RF) ASSIGNED TO DIV 500?                 
         BE    FPRD3               THEATRICAL - EXIT WITH RESET VALUES          
         CLC   =C'600',PPRDDIV-PPRDREC(RF) ASSIGNED TO DIV 600?                 
         BE    FPRD3               THEATRICAL - EXIT WITH RESET VALUES          
         CLC   =C'700',PPRDDIV-PPRDREC(RF) ASSIGNED TO DIV 700?                 
         BE    FPRD3               THEATRICAL - EXIT WITH RESET VALUES          
         CLC   =C'800',PPRDDIV-PPRDREC(RF) ASSIGNED TO DIV 800?                 
         BE    FPRD3               THEATRICAL - EXIT WITH RESET VALUES          
         CLC   =C'900',PPRDDIV-PPRDREC(RF) ASSIGNED TO DIV 900?                 
         BE    FPRD3               THEATRICAL - EXIT WITH RESET VALUES          
         B     FPRD2X4                                                          
*                                                                               
FPRD2X1  CLC   =C'WB9',PPRDKCLT-PPRDREC(RF)  FOR THESE CLIENTS CHECK            
         BE    FPRD2X2                       FOR DIV 202                        
         CLC   =C'WP9',PPRDKCLT-PPRDREC(RF)                                     
         BNE   FPRD2X3                                                          
*                                                                               
FPRD2X2  CLC   =C'202',PPRDDIV-PPRDREC(RF)  HM VIDEO-TREAT THEATRICAL           
         BE    FPRD3                                                            
         CLC   =C'404',PPRDDIV-PPRDREC(RF)  OR VIDEO ON DEMAND                  
         BE    FPRD3                                                            
         B     FPRD2X4                                                          
*                                                                               
FPRD2X3  CLC   =C'WA9',PPRDKCLT-PPRDREC(RF)  FOR THESE CLIENTS CHECK            
         BE    FPRD2X3A                      FOR DIV 404                        
         CLC   =C'WC9',PPRDKCLT-PPRDREC(RF)                                     
         BNE   FPRD2X4                                                          
*                                                                               
FPRD2X3A CLC   =C'404',PPRDDIV-PPRDREC(RF)  OR VIDEO ON DEMAND                  
         BE    FPRD3                                                            
*                                                                               
FPRD2X4  DS    0H                                                               
         MVI   WBSW,C'N'       SET OFF FOR NON-THEATRICAL PRDS                  
*                                                                               
FPRD3    DS    0H                            ALWAYS SET FORMULA                 
*                                                                               
         L     RF,ADPRD                                                         
*                                                                               
******   CLI   BFROPT,C'N'         IF NOT DOING NEW BFR'S                       
******   BNE   FPRD3X                                                           
*                                                                               
         MVC   PRDFORM,PPRDBILP-PPRDREC(RF)    HOLD PROFILE                     
         OC    PRDFORM,PRDFORM                                                  
         BZ    FPRD3A                                                           
         OC    PRDFORM(5),PRDFORM                                               
         BNZ   FPRD3A                                                           
         MVC   PRDFORM(2),=X'0505'        SET DEFAULT IF CHAB THERE             
*                                         WITH NO FORMULA                       
FPRD3A   DS    0H                                                               
         CLC   AESTBRK,APRDBRK        SEE IF EST 'HIGHER' THAM PRD              
         BNL   *+8                                                              
         BAS   RE,SETEST         IF SO TRY FOR ESTIMATE FORMULA                 
*                                                                               
*                                                                               
*        MOVED FROM BEGINNING OF FPRD TO HERE                                   
**NEW 11/6/89                                                                   
FPRD3X   DS    0H                                                               
         BRAS  RE,GETAOR           MUST TRY TO GET AOR INFO                     
*                                  HERE IN CASE REQUEST IS FOR                  
*                                  ONE EST AND ALL PRDS                         
*                                                                               
         CLI   PRDCTL,C'N'         NOT PRINTING PRD                             
         BE    FPRDX                                                            
         CLI   RETPROF,0                                                        
         BE    *+8                                                              
         MVI   PRDSKIP,C'Y'                                                     
         CLI   UPASS,X'FF'           WAS C'S'                                   
         BE    FPRD4                                                            
         OC    ALOWTOG,ALOWTOG                                                  
         BZ    *+12                                                             
         C     R3,ALOWTOG          TEST IF TO APPEAR                            
         BH    FPRDX               NO                                           
*                                                                               
FPRD4    DS    0H                                                               
         L     RF,ADPRD                                                         
*                                         FORMULA NOW SET AT FPRD3              
FPRD4A   MVC   PRD,PPRDKPRD-PPRDREC(RF)                                         
         MVC   PRDNM(20),PPRDNAME-PPRDREC(RF)                                   
*                                                                               
         CLI   RETPROF,0           SKIP PRD ADDR IF RETAIL                      
         BNE   FPRD6                                                            
*                                                                               
         NI    FLAG1,X'FF'-BADDRSW INIT BRAND BILL ADDRESS REC FOUND            
         MVC   THREE,PRD                                                        
         CLI   BILLADR,C'Y'        B8 PR3 READ BILL ADDRESS REC?                
         BNE   FPRD4C                                                           
         CLI   PROGPRO2+14,C'Y'    CHECK FOR AAA ADDRESS OPTION                 
         BE    *+8                                                              
         NI    FLAG1,X'FF'-AADDRSW    CAN'T USE AAA ADDRESS                     
         BRAS  RE,RBILADDR         READ BILL ADDRESS REC                        
         TM    FLAG1,BADDRSW+AADDRSW ANY BILLADR RECORD FOUND?                  
         BNZ   FPRD6                                                            
*                                                                               
FPRD4C   L     R0,=A(BADDRS)                                                    
         LHI   R1,ADDRLEN                                                       
         SR    RE,RE                                                            
         LA    RF,X'40'                 FILL WITH SPACES                        
         SLL   RF,24                                                            
         MVCL  (R0),(RE)                                                        
*                                                                               
         L     RE,=A(BADDRS)                                                    
         L     RF,ADPRD                                                         
         LA    RF,PPRDBILL-PPRDREC(RF)                                          
*                                                                               
         CLC   =C'NONE',0(RF)                                                   
         BE    FPRD6                                                            
         CLC   =C'XX',0(RF)                                                     
         BE    FPRD6                                                            
         MVC   WORK(5),0(RF)                                                    
         OC    WORK(5),SPACES     SINCE THERE MAY BE BINARY ZEROS               
         CLC   WORK(5),=C'X    '                                                
         BE    FPRD6                                                            
         CLI   0(RF),C'A'                                                       
         BL    FPRD6                                                            
*                                                                               
         MVC   000(20,RE),00(RF)    BILL RECIEPT NAME                           
         MVC   060(30,RE),20(RF)    PPRDLIN1                                    
         MVC   120(30,RE),50(RF)    PPRDLIN2                                    
         MVC   180(24,RE),80(RF)    PPRDATTN                                    
*                                                                               
****     MVC   BADDR1(20),00(RF)    BILL RECIEPT NAME                           
****     MVC   BADDR2(30),20(RF)    PPRDLIN1                                    
****     MVC   BADDR3(30),50(RF)    PPRDLIN2                                    
****     MVC   BADDR4(24),80(RF)    PPRDATTN                                    
**NEW 3/7/89                                                                    
*                                                                               
*                            CHECK FOR 2ND BILL RECEIPT NAME LINE               
*                                                                               
         L     R1,ADPRD                                                         
         LA    R1,PPRDBIL2-PPRDREC(R1)                                          
         CLC   =C'NONE',0(R1)                                                   
         BE    FPRD6                                                            
         CLC   =C'XX',0(R1)                                                     
         BE    FPRD6                                                            
*                                                                               
         MVC   WORK(5),0(R1)                                                    
         OC    WORK(5),SPACES     SINCE THERE MAY BE BINARY ZEROS               
         CLC   WORK(5),=C'X    '                                                
         BE    FPRD6                                                            
*                                                                               
         CLI   0(R1),C'A'                                                       
         BL    FPRD6                                                            
         MVC   060(60,RE),SPACES                                                
         MVC   060(20,RE),0(R1)                                                 
         MVC   120(30,RE),20(RF)                                                
         MVC   180(30,RE),50(RF)                                                
         MVC   240(24,RE),80(RF)                                                
*                                                                               
****     MVC   BADDR2(30),SPACES           FIRST CLEAR                          
****     MVC   BADDR2(20),0(RE)                                                 
****     MVC   BADDR3(30),20(RF)                                                
****     MVC   BADDR4(30),50(RF)                                                
****     MVC   BADDR5(24),80(RF)                                                
**NEW 3/7/89                                                                    
FPRD6    DS    0H                                                               
         C     R3,APAGBRK          IS PRD 'HIGHER' THAN PAGE BRK                
         BNH   FPRD8               YES                                          
         CLI   PRDCTL,C'S'                                                      
         BE    FPRD8                                                            
         CLC   P1,SPACES                                                        
         BE    FPRD7                                                            
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    CLC   P1(8),=C'PRODUCT-'  PREVENT PRINTING OF UNUSED                   
         CLC   P1(L'PP8PRO),PP8PRO                                              
         BNE   FPRD6B              PRODUCT (CAN HAPPEN IN RETAIL)               
*                                                                               
         DROP  RE                                                               
*                                                                               
         MVC   P1,SPACES                                                        
         MVC   P2,SPACES                                                        
         MVC   P3,SPACES                                                        
         MVC   P4,SPACES                                                        
         B     FPRD7                                                            
*                                                                               
FPRD6B   DS    0H                                                               
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)            CLEAR P                                      
FPRD7    DS    0H                                                               
         MVC   X(7),SPACES     CLEAR X (PRD ACCOUNT PUT THERE)                  
*                                                                               
         CLI   AGMCLNO,C'C'        NO ACCT NO IF C OR X                         
         BE    FPRD7D                                                           
         CLI   AGMCLNO,C'X'        NO ACCT NO IF C OR X                         
         BE    FPRD7D                                                           
*                                  PUT ACCT NO (IF ANY) IN X(7)                 
         L     RF,ADPRD                                                         
         MVC   FULL,PPRDACCT-PPRDREC(RF)                                        
         CLI   FULL,C' '                                                        
         BNH   FPRD7D                                                           
         MVI   X,C'('                                                           
         MVC   X+1(4),FULL                                                      
         MVI   X+5,C')'                                                         
         CLI   FULL,X'FF'                                                       
         BNE   FPRD7D                                                           
         MVI   FULL,0                                                           
         EDIT  (B4,FULL),(5,X+1),ALIGN=LEFT                                     
         LA    R1,X+1                                                           
         AR    R1,R0               ADD EDITED LENGTH                            
         MVI   0(R1),C')'                                                       
*                                                                               
FPRD7D   DS    0H                                                               
         OC    PRDNM,SPACES                                                     
*                                                                               
         CLI   PUSRSW,C'Y'         PRD USER CONTROL                             
         BE    FPRD7D2             SO I WILL DISPLAY THE PRD USERS              
*                                  EVEN IF PRD IS ONLY TOGETHER                 
         CLC   ALOWTOG,AHITOG      IS PRD ONLY 'TOGETHER'                       
         BE    FPRD5               YES                                          
*                                  PRD NOT ONLY                                 
FPRD7D2  L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   P1(8),=C'PRODUCT-'                                               
         MVC   P1(L'PP8PRO),PP8PRO                                              
         DROP  RE                                                               
         MVC   P1+9(3),PRD                                                      
         MVC   P1+14(7),X          ACCT NO.                                     
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P2(24),PRDNM                                                     
         B     FPRD7F                                                           
         GOTO1 =V(CHOPPER),DMCB,(24,PRDNM),(20,P2),(C'P',2)                     
FPRD7F   DS    0H                                                               
         C     R3,ALOWTOG                                                       
         BE    *+8                                                              
         BAS   RE,PULINE                                                        
*                                                                               
         CLI   WMSW,C'Y'      WALMART PROCESSING?                               
         BNE   FPRD7F4                                                          
*                                                                               
         MVC   W,SPACES                                                         
*                                                                               
*        ACCOUNT NUMBER - BRAND'S ESTIMATE USER1                                
*                                                                               
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'E',ADEST),(C':',W),0            
*******  TM    DMCB+6,X'10'     PRINT ON BILLING?                               
*******  BNO   FPRD7F9                                                          
         MVC   P3(40),SPACES    WILL REPLACE UNDERLINING                        
         MVC   P3(40),W                                                         
         B     FPRD7X                                                           
*                                                                               
FPRD7F4  DS    0H                                                               
         CLI   PGSW,C'Y'      P&G PROCESSING?                                   
         BNE   FPRD7F6                                                          
*                                                                               
         MVC   W,SPACES                                                         
*                                                                               
*        ACCOUNT NUMBER - BRAND'S ESTIMATE USER1                                
*        INTERNAL ORDER NUMBER - BRAND'S ESTIMATE USER2                         
*                                                                               
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'E',ADEST),(C':',W),    X        
               (C':',W+40)                                                      
*******  TM    DMCB+6,X'10'     PRINT ON BILLING?                               
*******  BNO   FPRD7F9                                                          
         MVC   P3(40),SPACES    WILL REPLACE UNDERLINING                        
         MVC   P3(40),W                                                         
         CLC   P3(40),SPACES                                                    
         BNH   FPRD7F5                                                          
         MVC   P4(40),W+40                                                      
         B     FPRD7X                                                           
*                                                                               
FPRD7F5  MVC   P3(40),W+40    ACCOUNT MISSING - JUST DO I/O NUM                 
         B     FPRD7X                                                           
*                                                                               
FPRD7F6  DS    0H            CHECK FOX SWITCH                                   
*                                                                               
         CLI   PUSRSW,C'Y'   PRD USER CONTROL                                   
         BE    FPRD7F6B                                                         
         CLI   EPUDEF,C'P'                                                      
         BNL   FPRD7F6B                                                         
         CLI   FOXSW,C'Y'                                                       
         BNE   FPRD7X                                                           
*                                                                               
FPRD7F6B DS    0H                                                               
*        CODE BELOW ASSUMES PRD AND EST USER DATA WITH ANNO                     
*        WON'T EXCEED 40 CHARACTERS EACH                                        
*                                                                               
         MVC   W,SPACES                                                         
*        DISPLAY FIRST PRODUCT USER AND FIRST ESTIMATE USER DATA                
*                                                                               
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'P',ADPRD),(C':',W),0            
         TM    DMCB+4,X'10'     PRINT ON BILLING?                               
         BNO   FPRD7F6E                                                         
         CLC   W(20),SPACES     SEE IF DATA EXISTS                              
         BE    FPRD7F6E                                                         
         MVC   P3(54),SPACES    WILL REPLACE UNDERLINING                        
         MVC   P3(54),W                                                         
*                                                                               
FPRD7F6E DS    0H                                                               
*                                                                               
         CLI   FOXSW,C'Y'      FOR PUSRSW AND EPUDEF=P/Y                        
         BNE   FPRD7F6H        SECOND PRODUCT UDEF                              
*                                                                               
*        FOXSW NOW DOES FIRST ESTIMATE USER - THEN EXITS                        
*                                                                               
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'E',ADEST),(C':',W),0            
         TM    DMCB+4,X'10'     PRINT ON BILLING?                               
         BNO   FPRD7X                                                           
         LA    R1,P3                                                            
         CLC   P3(50),SPACES   CAN I USE P3?                                    
         BE    FPRD7F6X                                                         
         CLC   P3(10),DASHES   MIGHT STILL BE UNDERLINING                       
         BE    FPRD7F6X                                                         
         LA    R1,P4                                                            
*                                                                               
FPRD7F6X MVC   0(50,R1),SPACES  WILL REPLACE UNDERLINING                        
         MVC   0(50,R1),W                                                       
         B     FPRD7X                                                           
*                                                                               
FPRD7F6H DS    0H         FOR PUSRSW CHECK FOR SECOND PRODUCT USER              
         MVC   W,SPACES                                                         
*        DISPLAY 2ND PRODUCT USER                                               
*                                                                               
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'P',ADPRD),0,(C':',W)            
         TM    DMCB+6,X'10'     PRINT ON BILLING?                               
         BNO   FPRD7F6J                                                         
         CLC   W(20),SPACES    SEE IF DATA EXISTS                               
         BE    FPRD7F6J                                                         
         LA    R1,P3                                                            
         CLC   P3(2),=C'--'    SEE IF UNDERLINING                               
         BE    FPRD7F6I                                                         
         CLC   P3(10),SPACES   OR NOT USED                                      
         BE    FPRD7F6I                                                         
         LA    R1,P4             IF USED ALREADY PUT IN P4                      
FPRD7F6I MVC   0(54,R1),SPACES    MAY  REPLACE UNDERLINING                      
         MVC   0(54,R1),W                                                       
*                                                                               
FPRD7F6J DS    0H                                                               
*                                                                               
FPRD7X   DS    0H                                                               
         B     FPRD10K       SKIP TO EDI CHECK                                  
*                                  PRD ONLY 'TOGETHER'                          
FPRD5    DS    0H                                                               
         MVC   P1(3),PRD                                                        
         MVC   W,SPACES                                                         
         MVC   W(24),PRDNM                                                      
         LA    RF,W+24             FLOAT ACCT NO AFTER                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   2(7,RF),X                                                        
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P1+4(33),W                                                       
         B     FPRD10                                                           
         GOTO1 =V(CHOPPER),DMCB,(33,W),(16,P1+4),(C'P',3)                       
         B     FPRD10                                                           
FPRD8    DS    0H                                                               
         CLI   PRDCTL,C'S'                                                      
         BNE   FPRD10                                                           
         CLI   PEOVOPT,C'S'     SEE IF USING COLUMNS OVERRIDE                   
         BE    FPRD8C           FROM B2 PROFILE+11                              
*                               AND SUBTRACT CD FROM STRIP-OFF                  
         CLI   PEOVOPT,C'D'     SEE IF USING COLUMNS OVERRIDE                   
         BE    FPRD8C           FROM B2 PROFILE+11                              
*                               AND DON'T SUBTRACT CD FROM STRIP-OFF            
         CLI   PEOVOPT,C'Y'        SEE IF USING COLUMNS OVERRIDE                
         BNE   FPRD10              FROM B2 PROFILE+11                           
FPRD8C   CLI   PRDFORM+9,C'A'      SEE IF OVERIDING COLUMNS TO PRINT            
         BL    FPRD9               LOOK AT AAAFORM                              
         LA    RF,PRDFORM+9                                                     
         ST    RF,FULL                                                          
         GOTO1 =A(FMTOVER)                                                      
         B     FPRD10                                                           
*                                                                               
FPRD9    OC    PRDFORM,PRDFORM     SEE IF PRD CHAB FOUND                        
         BNZ   FPRD10              YES - DON'T LOOK AT AAAFORM                  
         CLI   AAAFORM+9,C'A'      SEE IF OVERIDING COLUMNS TO PRINT            
         BL    FPRD10                                                           
         LA    RF,AAAFORM+9                                                     
         ST    RF,FULL                                                          
         GOTO1 =A(FMTOVER)                                                      
FPRD10   DS    0H                                                               
*                                                                               
         CLI   PGSW,C'Y'            P&G PROCESSING?                             
         BNE   FPRD10K                                                          
*                                                                               
         MVC   W,SPACES                                                         
*                                                                               
*        INTERNAL ORDER NUMBER - BRAND'S ESTIMATE USER2                         
*                                                                               
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'E',ADEST),(C':',W),    X        
               (C':',W+40)                                                      
*******  TM    DMCB+6,X'10'     PRINT ON BILLING?                               
*******  BNO   FPRD10K                                                          
         MVC   P2+1(40),W                                                       
         CLC   P2+1(40),SPACES                                                  
         BNH   FPRD10C                                                          
         MVC   P3+1(40),W+40                                                    
         B     FPRD10K                                                          
*                                                                               
FPRD10C  MVC   P2+1(40),W+40    ACCOUNT MISSING JUST DO I/O NUMBER              
*                                                                               
FPRD10K  GOTO1 ABILLEDI,DMCB,('EDMPRD',0)    EDI CALL                           
FPRDX    DS    0H                                                               
         XMOD1                                                                  
         EJECT                                                                  
*                                                                               
         SPACE 2                                                                
*        GET ESTHDR AND SET FORMULA                                             
*                                                                               
SETEST   NTR1                                                                   
         L     RF,ADCLT            BUILD EST KEY                                
         XC    KEY,KEY                                                          
         MVC   KEY(25),0(RF)                                                    
         OC    AMED,AMED           SEE IF MULTI-MEDIA REQUEST                   
         BZ    SEST1                                                            
         L     RF,AMED                                                          
         MVC   KEY+2(1),0(RF)                                                   
*                                                                               
SEST1    DS    0H                                                               
         L     RE,APRD                                                          
         MVC   KEY+7(3),0(RE)                                                   
         MVI   KEY+3,X'07'                                                      
         L     RF,AEST                                                          
         MVC   KEY+10(2),0(RF)                                                  
         L     R4,ADEST                                                         
         CLC   KEY(12),0(R4)       TEST ALREADY HAVE ESTHDR                     
         BE    SEST2                                                            
         GOTO1 HIGH                                                             
         CLC   KEY(12),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                ESTIMATE NOT FOUND                           
         GOTO1 GETEST                                                           
*                                                                               
SEST2    DS    0H                                                               
         L     RF,ADEST                                                         
         MVC   ESTFORM,PESTBILP-PESTREC(RF)    HOLD PROFILE                     
         OC    ESTFORM,ESTFORM                                                  
         BZ    SEST2C                                                           
         OC    ESTFORM(5),ESTFORM                                               
         BNZ   SEST2C                                                           
         MVC   ESTFORM(2),=X'0505'                SET DEFAULT                   
*                                                                               
SEST2C   DS    0H                                                               
***      MVC   ESTFORM2,PESTREVN+3-PESTREC(RF)    2ND FORMULA                   
***      MVC   ESTFORM3,PESTREVN+10-PESTREC(RF)    3RD FORMULA                  
*                                                                               
         XC    AAEFORM,AAEFORM                                                  
***      XC    AAEFORM2,AAEFORM2                                                
***      XC    AAEFORM3,AAEFORM3                                                
*                                                                               
         L     RE,AAELIST          SET AAA EST FORM IF ANY                      
SEST3    DS    0H                                                               
         CLC   0(6,RE),FFS         EOL                                          
         BE    SEST5                                                            
         CLC   10(2,RF),0(RE)      EST =                                        
         BE    SEST4                                                            
         LA    RE,53(RE)                                                        
         B     SEST3                                                            
SEST4    DS    0H                                                               
         MVC   AAEFORM,2(RE)                                                    
***      MVC   AAEFORM2,39(RE)       2ND FORMULA                                
***      MVC   AAEFORM3,46(RE)       3RD FORMULA                                
*                                                                               
SEST5    DS    0H                                                               
SESTX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
*        PULINE IN FIRST BLANK LINE                                             
PULINE   NTR1                                                                   
*                                  FIND FIRST BLANK LINE                        
         LA    R3,P1                                                            
         SR    RE,RE                                                            
PUL2     DS    0H                                                               
         OC    0(40,R3),SPACES                                                  
         CLC   0(40,R3),SPACES                                                  
         BE    PUL4                                                             
         LA    R3,132(R3)                                                       
         LA    RE,1(RE)                                                         
         B     PUL2                                                             
*                                                                               
PUL4     DS    0H                                                               
         LTR   RE,RE                                                            
         BNP   PULX                                                             
*                                                                               
         LA    RF,P1+40                                                         
PUL5     DS    0H                                                               
         LR    R1,RF                                                            
         LR    R0,RE                                                            
PUL6     DS    0H                                                               
         CLI   0(R1),C' '                                                       
         BH    PUL8                FIRST NON-BLACK CHAR                         
         LA    R1,132(R1)                                                       
         BCT   R0,PUL6                                                          
*                                                                               
         BCT   RF,PUL5                                                          
*                                                                               
PUL8     DS    0H                                                               
         LA    R0,P1                                                            
         SR    RF,R0                                                            
         BM    PULX                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),DASHES                                                   
*                                                                               
PULX     DS    0H                                                               
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
*        FIRST FOR ESTIMATE                                                     
         SPACE 2                                                                
*                                                                               
FSTEST   NMOD1 0,FSTEST                                                         
         LA    RC,SPACEND                                                       
*                                                                               
****     L     RF,=A(EADDRS)       CLEAR EST - REP ADDRESS                      
****     MVC   0(132,RF),SPACES                                                 
*****    MVC   132(OADDRLEN-132,RF),SPACES                                      
*                                                                               
         L     R0,=A(EADDRS)       CLEAR EST - REP ADDRESS                      
         LHI   R1,ADDRLEN                                                       
         SR    RE,RE                                                            
         LA    RF,X'40'                 FILL WITH SPACES                        
         SLL   RF,24                                                            
         MVCL  (R0),(RE)                                                        
*                                                                               
         BRAS  RE,GETAOR              GET ANY AOR INFO                          
*                                                                               
         MVC   SVPFORMT,FORMAT       FORMAT AND STRIP                           
         MVC   SVPSTRIP,STRIP                                                   
         MVC   SVPDOLN,DOLNUM                                                   
         MVC   SVP2COL,TWOCOL                                                   
*                                                                               
         BAS   RE,ESETEST          READ EST AND SET FORMULAS                    
*                                                                               
         BRAS  RE,TSTRET           DO RETAIL TEST                               
         BNZ   FESTX                                                            
*                                                                               
*                                                                               
         XC    ESTWBFLT,ESTWBFLT   CLEAR                                        
         CLI   WBSW,C'Y'           WB FILGHT FEATURE ACTIVE?                    
         BNE   FSTEST2                                                          
*                                                                               
         L     RF,=A(CHKUCOM)      MUST GET FILGHT HERE                         
         BASR  RE,RF               (NEEDED FOR EST=ALL REQS)                    
*                                                                               
FSTEST2  CLI   ESTCTL,C'N'         NOT PRINTING EST                             
         BE    FESTX                                                            
         OC    ALOWTOG,ALOWTOG                                                  
         BZ    *+12                                                             
         C     R3,ALOWTOG          TEST IF TO APPEAR                            
         BH    FESTX               NO                                           
*                                                                               
*                                                                               
**************** NOTE THAT EST IS READ EST SET AND FORMULAS SET                 
**************** IN ESETEST                                                     
****************                                                                
FEST3    DS    0H                                                               
         L     RF,ADEST                                                         
         MVC   ESTNM(20),PESTNAME-PESTREC(RF)                                   
         MVC   ESTNAM2,PESTNAM2-PESTREC(RF)                                     
         MVC   ESTREV,PESTREVN-PESTREC(RF)                                      
*                                                                               
FEST3A6  DS    0H                                                               
         CLI   PRDCTL,C'S'        IF IF PRD AND EST ARE SEPERATE                
         BNE   FEST3A7                                                          
         CLI   ESTCTL,C'S'        SEE IF EST SEPERATE                           
         BNE   FEST3A7                                                          
         CLC   P1,SPACES                                                        
         BE    FEST3A6A                                                         
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)            CLEAR P                                      
FEST3A6A DS    0H                                                               
*                                                                               
         CLI   PROFB2B+6,C'F'    ESTIMATE DATES IN FRONT                        
         BNE   FEST3A7                                                          
*                                                                               
         CLI   PROFB2B+5,C'N'    SHOW ESTIMATE DATES                            
         BE    FEST3A7                                                          
         CLI   PROFB2B+5,0       SHOW ESTIMATE DATES                            
         BE    FEST3A7                                                          
         CLI   ESTCTL,C'S'     MUST BE SEPARATE                                 
         BNE   FEST3A7                                                          
         L     R2,ADEST                                                         
         USING PESTREC,R2                                                       
*                                                                               
         CLC   P1(15),SPACES       ANYTHING THERE?                              
         BE    FEST3A6C                                                         
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)            CLEAR P                                      
*                                                                               
FEST3A6C MVC   P1(12),=C'FLIGHT DATES'                                          
         CLI   PROFB2B+5,C'F'                                                   
         BE    FEST3A6D                                                         
         MVC   P1(14),=C'CAMPAIGN DATES'                                        
         CLI   PROFB2B+5,C'C'                                                   
         BE    FEST3A6D                                                         
         MVC   P1(14),=C'ESTIMATE DATES'                                        
         CLI   PROFB2B+5,C'E'                                                   
         BE    FEST3A6D     OR ANY OTHER VALUES                                 
*                                                                               
FEST3A6D GOTO1 DATCON,DMCB,(0,PESTST),(5,P1+15)                                 
         MVI   P1+23,C'-'                                                       
         GOTO1 DATCON,DMCB,(0,PESTEND),(5,P1+24)                                
         GOTO1 =A(PRNT)                                                         
         B     FEST3A7                                                          
         DROP  R2                                                               
*                                                                               
FEST3A7  CLI   PEOVOPT,C'S'        SEE IF USING COLUMNS OVERRIDE                
         BE    FEST3A8             FROM B2 PROFILE+11 (STRIP-CD)                
*                                  AND SUBTRACT CD FROM STRIP-OFF               
         CLI   PEOVOPT,C'D'        SEE IF USING COLUMNS OVERRIDE                
         BE    FEST3A8             FROM B2 PROFILE+11 (STRIP-CD)                
*                            AND DON'T SUBTRACT CD FROM STRIP-OFF               
         CLI   PEOVOPT,C'Y'        SEE IF USING COLUMNS OVERRIDE                
         BNE   FEST3AD             FROM B2 PROFILE+11                           
FEST3A8  CLI   ESTFORM+9,C'A'      SEE IF OVERRIDING COLUMNS AT EST             
         BL    FEST3AD                                                          
         LA    RF,ESTFORM+9                                                     
         ST    RF,FULL                                                          
         GOTO1 =A(FMTOVER)                                                      
*                                                                               
FEST3AD  DS    0H                                                               
         L     RF,ADEST                                                         
         CLI   PESTBREP-PESTREC(RF),C' '   BILLING REP PRESENT?                 
         BNH   FEST3AX                                                          
*                                                                               
*                                 READ REP AND SET ADDRESS                      
*                                 INTO EADDRS                                   
         MVC   ESAVKEY,KEY                                                      
         XC    KEY,KEY                                                          
         XC    WORK(25),WORK                                                    
         L     RF,ADCLT                                                         
         MVC   WORK(3),0(RF)       AGY/MED                                      
         OC    AMED,AMED           FOR MULTI-MEDIA REQ GET MEDIA                
         BZ    FEST3AE             FROM AMED                                    
         L     RF,AMED                                                          
         MVC   WORK+2(1),0(RF)                                                  
*                                                                               
FEST3AE  MVC   KEY(3),WORK        AGY,MED                                       
         MVI   KEY+3,X'11'                                                      
         L     RF,ADEST          RESET TO ESTIMATE                              
         MVC   KEY+4(4),PESTBREP-PESTREC(RF)                                    
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'               MUST FIND REP                                 
*                                                                               
         L     R4,PPFILEC         TO ACCESS REP RECORD                          
         USING PPFILED,R4                                                       
         LA    R0,PREPREC                                                       
*                                                                               
         ST    R0,AREC                                                          
         GOTO1 GETPRT                                                           
*                                                                               
         MVC   KEY,ESAVKEY                                                      
         GOTO1 HIGH                                                             
*                                                                               
         L     RF,=A(EADDRS)                                                    
         MVC   0(30,RF),PREPNAME                                                
         MVC   60(30,RF),PREPLIN1                                               
         MVC   120(30,RF),PREPLIN2                                              
         LA    RE,156(RF)                                                       
         OC    PREPATTN,PREPATTN     SEE IF I HAVE AN ATTENTION                 
         BZ    FEST3AF                                                          
         MVC   180(5,RF),=C'ATTN:'                                              
         MVC   186(20,RF),PREPATTN                                              
         LA    RE,186(RF)                                                       
*                                                                               
         DROP  R4                                                               
*                                                                               
FEST3AF  DS    0H                                                               
*                                                                               
FEST3AX  C     R3,APAGBRK          IS EST 'HIGHER' THAN PAGE BRK                
         BNH   FEST8               YES                                          
         CLC   P1,SPACES                                                        
         BE    FEST3B                                                           
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)            CLEAR P                                      
FEST3B   DS    0H                                                               
         OC    ESTNM,SPACES                                                     
         OC    ESTNAM2,SPACES                                                   
         CLC   ALOWTOG,AHITOG      IS EST ONLY 'TOGETHER'                       
         BE    FEST5               YES                                          
*                                  EST NOT ONLY                                 
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   P1(8),=C'ESTIMATE'                                               
         MVC   P1(L'PP@EST),PP@EST                                              
         DROP  RE                                                               
         MVC   P1+9(3),EST                                                      
         MVC   P2(20),ESTNM                                                     
         CLC   ESTNAM2,SPACES                                                   
         BE    *+10                                                             
         MVC   P3(20),ESTNAM2                                                   
*                                                                               
         CLI   PROFB2B+5,C'N'                                                   
         BE    FEST3D                                                           
         CLI   PROFB2B+5,0                                                      
         BE    FEST3D                                                           
         L     R2,ADEST                                                         
         USING PESTREC,R2                                                       
*                                                                               
         MVC   P4(12),=C'FLIGHT DATES'                                          
         LA    R4,P4+13                                                         
         CLI   PROFB2B+5,C'F'                                                   
         BE    FEST3BX                                                          
         MVC   P4(14),=C'CAMPAIGN DATES'                                        
         LA    R4,P4+15                                                         
         CLI   PROFB2B+5,C'C'                                                   
         BE    FEST3BX                                                          
         MVC   P4(14),=C'ESTIMATE DATES'                                        
         LA    R4,P4+15                                                         
         CLI   PROFB2B+5,C'E'                                                   
         BE    FEST3BX                                                          
*                        ANY OTHER VALUE - USE ESTIMATE                         
FEST3BX  GOTO1 DATCON,DMCB,(0,PESTST),(5,0(R4))                                 
         MVI   8(R4),C'-'                                                       
         GOTO1 DATCON,DMCB,(0,PESTEND),(5,9(R4))                                
*                                                                               
         DROP  R2                                                               
*                                                                               
FEST3D   DS    0H                                                               
         CLI   MSSW,C'Y'   ESTIMATE USER FIELDS HERE?                           
         BE    FEST3D3                                                          
         CLI   EPUDEF,C'E'                                                      
         BE    FEST3D3                                                          
         CLI   EPUDEF,C'Y'                                                      
         BNE   FEST3DX                                                          
*                                                                               
FEST3D3  MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'E',ADEST),(C':',W),0            
         TM    DMCB+4,X'10'     PRINT ON BILLING?                               
         BNO   FEST3D5                                                          
         LA    R1,P5                                                            
         CLC   P4(10),SPACES   ANYTHING IN P4?                                  
         BNE   FEST3D5          THEN USE P5                                     
         LA    R1,P4                                                            
         CLC   P3(10),SPACES   ANYTHING IN P3?                                  
         BNE   FEST3D5         YES THEN USE P4                                  
         LA    R1,P3           OTHERWISE USE P3                                 
*                                                                               
FEST3D5  MVC   0(40,R1),W                                                       
         CLI   MSSW,C'Y'                                                        
         BE    FEST3DX                                                          
         MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'E',ADEST),0,(C':',W)            
         TM    DMCB+6,X'10'     PRINT ON BILLING?                               
         BNO   FEST3DX                                                          
         LA    R1,P5                                                            
         CLC   P4(10),SPACES   ANYTHING IN P4?                                  
         BNE   *+8              THEN USE P5                                     
         LA    R1,P4                                                            
*                                                                               
         MVC   0(40,R1),W                                                       
*                                                                               
FEST3DX  DS    0H                                                               
         C     R3,ALOWTOG                                                       
         BE    *+8                                                              
         BAS   RE,EULINE                                                        
         B     FEST10                                                           
*                                  EST IS ONLY TOG                              
FEST5    DS    0H                                                               
         MVC   P1(3),EST                                                        
         CLI   TWOCOL,C'Y'                                                      
         BNE   FEST7                                                            
         MVC   P1+4(20),ESTNM                                                   
         MVC   P2+4(20),ESTNAM2                                                 
         B     FEST7C                                                           
*                                                                               
FEST7    GOTO1 =V(CHOPPER),DMCB,(20,ESTNM),(16,P1+4),(C'P',2)                   
         LA    R4,P2+4                                                          
         CLC   P2+4(16),SPACES     SEE IF I CAN USE P2                          
         BE    *+8                                                              
         LA    R4,P3+4             NO - MUST USE P3                             
         GOTO1 =V(CHOPPER),DMCB,(20,ESTNAM2),(16,0(R4)),(C'P',2)                
*                                                                               
FEST7C   DS    0H                                                               
*                                                                               
         CLI   PROFB2B+5,C'N'                                                   
         BE    FEST7C5                                                          
         CLI   PROFB2B+5,0 '                                                    
         BE    FEST7C5                                                          
         L     R2,ADEST                                                         
         USING PESTREC,R2                                                       
*                                                                               
         LA    R4,P2                                                            
         CLC   P2(10),SPACES    CAN I USE P2?                                   
         BE    FEST7C2                                                          
         LA    R4,P3                                                            
         CLC   P3(10),SPACES    CAN I USE P3?                                   
         BE    FEST7C2                                                          
         LA    R4,P4            P4 SHOULD BE AVAILABLE                          
*                                                                               
FEST7C2  MVC   4(12,R4),=C'FLIGHT DATES'                                        
         LA    R5,17(R4)                                                        
         CLI   PROFB2B+5,C'F'                                                   
         BE    FEST7C2X                                                         
         MVC   4(14,R4),=C'CAMPAIGN DATES'                                      
         LA    R5,19(R4)                                                        
         CLI   PROFB2B+5,C'C'                                                   
         BE    FEST7C2X                                                         
         MVC   4(14,R4),=C'ESTIMATE DATES'                                      
         LA    R5,19(R4)                                                        
         CLI   PROFB2B+5,C'E'                                                   
         BE    FEST7C2X                                                         
*                       ANY OTHER VALUE - USE ESTIMATE                          
FEST7C2X CLI   TWOCOL,C'Y'                                                      
         BE    FEST7C3                                                          
         LA    R5,132(R4)  PUT DATES IN NEXT LINE                               
         SH    R5,=H'4'                                                         
*                                                                               
FEST7C3  GOTO1 DATCON,DMCB,(0,PESTST),(5,0(R5))                                 
         MVI   8(R5),C'-'                                                       
         GOTO1 DATCON,DMCB,(0,PESTEND),(5,9(R5))                                
*                                                                               
         DROP  R2                                                               
*                                                                               
FEST7C5  CLI   MSSW,C'Y'   ESTIMATE USER FIELDS HERE?                           
         BE    FEST7C7                                                          
         CLI   EPUDEF,C'E'                                                      
         BE    FEST7C7                                                          
         CLI   EPUDEF,C'Y'                                                      
         BNE   FEST7X                                                           
*                                                                               
FEST7C7  MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'E',ADEST),(C':',W),0            
         TM    DMCB+4,X'10'     PRINT ON BILLING?                               
         BNO   FEST7E                                                           
         LA    R1,P5                                                            
         CLC   P4(10),SPACES   ANYTHING IN P4?                                  
         BNE   FEST7E          YES - THE USE P5                                 
         LA    R1,P4                                                            
         CLC   P3(10),SPACES   ANYTHING IN P3?                                  
         BNE   FEST7E          YES THEN USE P4                                  
         LA    R1,P3                                                            
         CLC   P2(10),SPACES   ANYTHING IN P2?                                  
         BNE   FEST7E          YES THEN USE P3                                  
         LA    R1,P2           OTHERWISE USE P2                                 
*                                                                               
FEST7E   MVC   0(40,R1),W                                                       
         CLI   MSSW,C'Y'                                                        
         BE    FEST7X                                                           
         MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'E',ADEST),0,(C':',W)            
         TM    DMCB+6,X'10'     PRINT ON BILLING?                               
         BNO   FEST7X                                                           
         LA    R1,P5                                                            
         CLC   P4(10),SPACES   ANYTHING IN P4?                                  
         BNE   *+8              THEN USE P5                                     
         LA    R1,P4                                                            
*                                                                               
         MVC   0(40,R1),W                                                       
*                                                                               
FEST7X   DS    0H                                                               
         B     FEST10                                                           
*                                                                               
FEST8    DS    0H                                                               
FEST10   DS    0H                                                               
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMEST',0)    EDI CALL                           
**EDI**                                                                         
FESTX    DS    0H                                                               
         XMOD1                                                                  
*        GET ESTHDR AND SET FORMULA                                             
*                                                                               
ESETEST  NTR1                                                                   
         L     RF,ADCLT            BUILD EST KEY                                
         XC    KEY,KEY                                                          
         MVC   KEY(25),0(RF)                                                    
         OC    AMED,AMED           SEE IF MULTI-MEDIA REQUEST                   
         BZ    ESEST1                                                           
         L     RF,AMED                                                          
         MVC   KEY+2(1),0(RF)                                                   
*                                                                               
ESEST1   DS    0H                                                               
         L     RE,APRD                                                          
         MVC   KEY+7(3),0(RE)                                                   
         MVI   KEY+3,X'07'                                                      
         L     RF,AEST                                                          
         MVC   KEY+10(2),0(RF)                                                  
         L     R4,ADEST                                                         
         CLC   KEY(12),0(R4)       TEST ALREADY HAVE ESTHDR                     
         BE    ESEST2                                                           
         GOTO1 HIGH                                                             
         CLC   KEY(12),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                ESTIMATE NOT FOUND                           
         GOTO1 GETEST                                                           
*                                                                               
ESEST2   DS    0H                                                               
         L     RF,ADEST                                                         
         MVC   HALF,PESTKEST-PESTREC(RF)                                        
         LH    R0,HALF                                                          
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  EST,DUB                                                          
*                                                                               
         MVC   ESTFORM,PESTBILP-PESTREC(RF)    HOLD PROFILE                     
         OC    ESTFORM,ESTFORM                                                  
         BZ    ESEST2C                                                          
         OC    ESTFORM(5),ESTFORM                                               
         BNZ   ESEST2C                                                          
         MVC   ESTFORM(2),=X'0505'                SET DEFAULT                   
*                                                                               
ESEST2C  DS    0H                                                               
***      MVC   ESTFORM2,PESTREVN+3-PESTREC(RF)    2ND FORMULA                   
***      MVC   ESTFORM3,PESTREVN+10-PESTREC(RF)    3RD FORMULA                  
*                                                                               
         XC    AAEFORM,AAEFORM                                                  
***      XC    AAEFORM2,AAEFORM2                                                
***      XC    AAEFORM3,AAEFORM3                                                
*                                                                               
         L     RE,AAELIST          SET AAA EST FORM IF ANY                      
ESEST3   DS    0H                                                               
         CLC   0(6,RE),FFS         EOL                                          
         BE    ESEST5                                                           
         CLC   10(2,RF),0(RE)      EST =                                        
         BE    ESEST4                                                           
         LA    RE,53(RE)                                                        
         B     ESEST3                                                           
ESEST4   DS    0H                                                               
         MVC   AAEFORM,2(RE)                                                    
***      MVC   AAEFORM2,39(RE)       2ND FORMULA                                
***      MVC   AAEFORM3,46(RE)       3RD FORMULA                                
*                                                                               
ESEST5   DS    0H                                                               
*                 SET CAROPT OPTION                                             
*                 NOTE - ALSO SET AT ESTF IN PPREPB12A                          
*                                                                               
         MVI   CAROPT,C'N'                                                      
         CLI   CAROPTC,C'Y'      SEE IF COST 2 CLIENT                           
         BNE   ESEST7            SKIP                                           
         L     RF,ADEST                                                         
         CLC   PESTCF-PESTREC(5,RF),=PL5'0' SEE IF EST OVERRIDE                 
         BE    ESEST7       OF ZERO - MEANS NON-COST2 ESTIMATE                  
*                                                                               
         MVI   CAROPT,C'Y'    SET ON SWITCH                                     
         OC    PESTCF-PESTREC(5,RF),PESTCF-PESTREC(RF)                          
         BZ    ESEST7       NO OVERRIDE ENTERED                                 
*                           NO DO CP INSTRUCTION                                
         CP    PESTCF-PESTREC(5,RF),=P'0'   ONE MORE CHECK                      
         BNL   *+6                                                              
         DC    H'0'         SOMETHING VERY WRONG                                
*                                                                               
ESEST7   DS    0H                                                               
ESESTX   DS    0H                                                               
         XIT1                                                                   
*                                                                               
ESAVKEY  DS    CL32                                                             
*                                                                               
*        EULINE IN FIRST BLANK LINE                                             
EULINE   NTR1                                                                   
*                                  FIND FIRST BLANK LINE                        
         LA    R3,P1                                                            
         SR    RE,RE                                                            
EUL2     DS    0H                                                               
         OC    0(40,R3),SPACES                                                  
         CLC   0(40,R3),SPACES                                                  
         BE    EUL4                                                             
         LA    R3,132(R3)                                                       
         LA    RE,1(RE)                                                         
         B     EUL2                                                             
*                                                                               
EUL4     DS    0H                                                               
         LTR   RE,RE                                                            
         BNP   EULX                                                             
*                                                                               
         LA    RF,P1+40                                                         
EUL5     DS    0H                                                               
         LR    R1,RF                                                            
         LR    R0,RE                                                            
EUL6     DS    0H                                                               
         CLI   0(R1),C' '                                                       
         BH    EUL8                FIRST NON-BLACK CHAR                         
         LA    R1,132(R1)                                                       
         BCT   R0,EUL6                                                          
*                                                                               
         BCT   RF,EUL5                                                          
*                                                                               
EUL8     DS    0H                                                               
         LA    R0,P1                                                            
         SR    RF,R0                                                            
         BM    EULX                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),DASHES                                                   
*                                                                               
EULX     DS    0H                                                               
         XIT1                                                                   
         LTORG                                                                  
*                                                                               
*                                  WAS IN BILWRK MOVED HERE                     
         EJECT                                                                  
FMTOVER  NMOD1 0,FMTOVER                                                        
         LA    RC,SPACEND                                                       
         LA    R5,OVERTAB                                                       
         L     RF,FULL                                                          
*                                                                               
FMTOV5   CLI   0(R5),X'FF'     END OF TABEL                                     
         BE    FMTOVX                                                           
         CLC   0(1,R5),0(RF)                                                    
         BE    FMTOV10                                                          
         LA    R5,9(R5)                                                         
         B     FMTOV5                                                           
*                                                                               
FMTOV10  MVC   FORMAT,1(R5)                                                     
         MVC   STRIP,7(R5)                                                      
         MVC   DOLNUM,8(R5)                                                     
         CLI   PEOVOPT,C'D'        DON'T SUBTRACT CD                            
         BE    FMTOV20                                                          
*                                                                               
         CLI   PEOVOPT,C'S'        SUBTRACT CD FROM STRIP-OFF                   
         BE    FMTOV12                                                          
*                                  IF 'Y', STILL DO THE OLD WAY                 
         L     RE,ADAGY                                                         
         CLI   PAGYPROF+14-PAGYREC(RE),C'0'                                     
         BNE   FMTOV20          NOT 0 MEANS SUBTRACT FOR STRIP                  
FMTOV12  CLI   STRIP,C'G'                                                       
         BNE   FMTOV15                                                          
         MVI   STRIP,C'1'       SET TO G-CD                                     
         B     FMTOV20                                                          
*                                                                               
FMTOV15  CLI   STRIP,C'N'                                                       
         BNE   FMTOV20                                                          
         MVI   STRIP,C'2'       SET TO N-CD                                     
*                                                                               
FMTOV20  MVI   TWOCOL,C'Y'        RECALULATE TWOCOL                             
         CLI   DOLNUM,3                                                         
         BNE   FMTOVX                                                           
         CLI   TYPNUM,2                                                         
         BL    FMTOVX                                                           
         MVI   TWOCOL,C'N'                                                      
*                                                                               
FMTOVX   XMOD1                                                                  
         SPACE 3                                                                
*                                                                               
OVERTAB  DC    C'1',C'YNNNNN',C'N',X'01'                                        
         DC    C'2',C'NYNNNN',C'G',X'01'                                        
         DC    C'3',C'YYNNNN',X'00',X'02'                                       
         DC    C'4',C'YNYYNN',C'N',X'03'                                        
         DC    C'5',C'NYYNYN',C'G',X'03'                                        
         DC    C'6',C'YYYNNN',X'00',X'03'                                       
         DC    C'7',C'YYNYNN',C'N',X'03'                                        
         DC    C'8',C'YYNNYN',C'G',X'03'                                        
         DC    C'9',C'YNYNYN',C'N',X'03'                                        
         DC    C'A',C'YNNYYN',C'N',X'03'                                        
         DC    C'B',C'YNYYNN',C'G',X'03'                                        
         DC    C'C',C'NYYNYN',C'N',X'03'                                        
         DC    C'D',C'YNYNNN',C'N',X'02'                                        
         DC    C'E',C'NYYNNN',C'G',X'02'                                        
         DC    X'FFFF'                                                          
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
FMGRALL  NMOD1 0,FMGRALL                                                        
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         CLC   AESTBRK,AINVBRK     IF EST SEPARATE                              
         BH    FMGRA3                                                           
         BRAS  RE,TSTRET           DO RETAIL TEST                               
         BNZ   FMGRAX                                                           
*                                                                               
FMGRA3   DS    0H                                                               
         OC    ALOWTOG,ALOWTOG                                                  
         BZ    *+12                                                             
         C     R3,ALOWTOG          TEST IF TO APPEAR                            
         BH    FMGRAX              NO                                           
*                                                                               
         MVC   0(3,R5),0(R6)       MOVE CODE                                    
*              READ REGION/DISTRICT FOR NAME                                    
*              THEN SAVE IT IN MGRNAMES                                         
         L     RF,PPFILEC                                                       
         USING PPFILED,RF                                                       
         XC    KEY,KEY                                                          
         MVC   KEY(7),PCLTREC                                                   
         OC    AMED,AMED           FOR MULTI-MEDIA REQ GET MEDIA                
         BZ    FMGRA3B             FROM AMED                                    
         L     R1,AMED                                                          
         MVC   KEY+2(1),0(R1)                                                   
FMGRA3B  OC    APGR1,APGR1           SEE IF DOING DIVISIONS                     
         BZ    FMGRA3C                                                          
         L     R1,APGR1                                                         
         MVC   KEY+7(3),0(R1)        SET DIVISION IN KEY                        
         B     FMGRA4                                                           
*        NOTE CAN NOT RELY ON PROPER DIVISION IN PDIVREC                        
*        SINCE I GET HERE BEFORE FPGR1 IF REG/DST IS 'S'                        
*        AND DIVISION IS 'T'                                                    
******   CLC   PDIVREC(3),KEY          BE SURE PDIVREC IS RIGHT AGY/MED         
******   BNE   FMGRA3C                 NO - MUST USE DIVISION FROM PRD          
******   CLC   PDIVREC+4(3),KEY+4      BE SURE PDIVREC IS RIGHT CLIENT          
******   BNE   FMGRA3C                 NO - MUST USE DIV FROM PRD               
******   MVC   KEY(10),PDIVREC     AGY/MED/CODE/CLT/DIV                         
******   OC    KEY(10),KEY                                                      
******   BNZ   FMGRA4                                                           
*                                                                               
FMGRA3C  DS    0H                                                               
*                                                                               
*      MUST READ PRD HERE TO GET DIVISION                                       
*                                                                               
         L     R4,APRD                                                          
         L     RF,ADCLT                                                         
         MVC   KEY(25),0(RF)                                                    
         OC    AMED,AMED           FOR MULTI-MEDIA REQ GET MEDIA                
         BZ    FMGRA3E             FROM AMED                                    
         L     RF,AMED                                                          
         MVC   KEY+2(1),0(RF)                                                   
*                                                                               
FMGRA3E  MVC   KEY+7(3),0(R4)      3 CHAR PRD CODE                              
         MVI   KEY+3,X'06'                                                      
         L     RF,ADPRD                                                         
         CLC   KEY(10),0(RF)       TEST ALREADY HAVE PRDREC                     
         BE    FMGRA3H                                                          
         GOTO1 HIGH                                                             
         CLC   KEY(10),KEYSAVE                                                  
         BE    FMGRA3F                                                          
         DC    H'0'               PRODUCT MUST BE ON FILE                       
*                                                                               
FMGRA3F  L     RF,ADPRD                                                         
         ST    RF,AREC                                                          
         GOTO1 GETPRT                                                           
*                                                                               
FMGRA3H  DS    0H                                                               
FMGRA3M  L     R1,ADPRD                                                         
         MVC   KEY(7),0(R1)                   IF NOTHING IN DIVREC              
         MVC   KEY+7(3),PPRDDIV-PPRDREC(R1)   USE DIV FROM PRD                  
*                                                                               
FMGRA4   MVI   KEY+3,X'04'         REGION                                       
         CLC   QPUB+1(3),=C'RD='   CHK FOR CLIENT OVERRIDE                      
         BNE   *+16                                                             
         MVC   KEY+4(3),QPUB+4     USE OVERRIDE CLIENT                          
         MVC   KEY+7(3),=C'000'                                                 
         MVC   KEY+10(3),0(R6)                                                  
         C     R6,AMGR1            SEE IF DOING REGIONS                         
         BE    FMGRA5                                                           
*              MUST BE DISTRICTS                                                
*                                                                               
         L     RF,PPFILEC          MUST RESET RF                                
         MVC   KEY(13),PREGREC     USE REGION REC                               
         CLC   QPUB+1(3),=C'RD='   CHK FOR CLIENT OVERRIDE                      
         BNE   *+16                                                             
         MVC   KEY+4(3),QPUB+4     USE OVERRIDE CLIENT                          
         MVC   KEY+7(3),=C'000'                                                 
         MVI   KEY+3,X'05'                                                      
         MVC   KEY+13(3),0(R6)     DISTRICTS                                    
FMGRA5   GOTO1 HIGH                                                             
         C     R6,AMGR1                                                         
         BNE   FMGRA8                                                           
*                                                                               
         L     RF,PPFILEC                                                       
         MVC   PREGREP,SPACES      MUST CLEAR REGION BILLREP                    
*                                                                               
         CLC   KEY(13),KEYSAVE                                                  
         BE    FMGRA7                                                           
*                                                                               
         CLC   KEYSAVE+10(3),=C'999'                                            
         BE    FMGRA7                                                           
         DC    H'0'                REGION NOT FOUND                             
*                                                                               
FMGRA7   GOTO1 GETREG                                                           
         L     RF,PPFILEC                                                       
         MVC   MGR1NM(20),PREGNAME                                              
*                                                                               
         CLI   PREGREP,C' '       BILLING REP PRESENT?                          
         BNH   FMGRA7X                                                          
*                                                                               
*                                 READ REP AND SET ADDRESS                      
*                                 INTO DADDRS                                   
         MVC   RSAVKEY,KEY                                                      
         XC    KEY,KEY                                                          
         XC    WORK(25),WORK                                                    
         L     RF,ADCLT                                                         
         MVC   WORK(3),0(RF)       AGY/MED                                      
         OC    AMED,AMED           FOR MULTI-MEDIA REQ GET MEDIA                
         BZ    FMGRA7E             FROM AMED                                    
         L     RF,AMED                                                          
         MVC   WORK+2(1),0(RF)                                                  
*                                                                               
FMGRA7E  MVC   KEY(3),WORK        AGY,MED                                       
         MVI   KEY+3,X'11'                                                      
         L     RF,PPFILEC                                                       
         MVC   KEY+4(4),PREGREP                                                 
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'               MUST FIND REP                                 
*                                                                               
         DROP  RF                                                               
*                                                                               
         L     R4,PPFILEC         TO ACCESS REP RECORD                          
         USING PPFILED,R4                                                       
         LA    R0,PREPREC                                                       
*                                                                               
         ST    R0,AREC                                                          
         GOTO1 GETPRT                                                           
*                                                                               
         MVC   KEY,RSAVKEY                                                      
         GOTO1 HIGH                                                             
*                                                                               
         L     RF,=A(RADDRS)                                                    
         MVC   0(30,RF),PREPNAME                                                
         MVC   60(30,RF),PREPLIN1                                               
         MVC   120(30,RF),PREPLIN2                                              
         LA    RE,156(RF)                                                       
         OC    PREPATTN,PREPATTN     SEE IF I HAVE AN ATTENTION                 
         BZ    FMGRA7F                                                          
         MVC   180(5,RF),=C'ATTN:'                                              
         MVC   186(20,RF),PREPATTN                                              
         LA    RE,186(RF)                                                       
*                                                                               
         DROP  R4                                                               
*                                                                               
FMGRA7F  DS    0H                                                               
*                                                                               
FMGRA7X  DS    0H           CHECK IF EST 'HIGHER' THAN PAGE BRK                 
         B     FMGRA15                                                          
*                                                                               
FMGRA8   C     R6,AMGR2                                                         
         BNE   FMGRA10                                                          
         CLC   KEY(16),KEYSAVE                                                  
         BE    FMGRA9                                                           
         CLC   KEYSAVE+13(3),=C'999'                                            
         BE    FMGRA9                                                           
         DC    H'0'                DISTRICT NOT FOUND                           
*                                                                               
FMGRA9   GOTO1 GETDIST                                                          
         L     RF,PPFILEC                                                       
         USING PPFILED,RF                                                       
         MVC   MGR2NM(20),PDSTNAME                                              
         B     FMGRA15                                                          
*                                                                               
         DROP  RF                                                               
*                                                                               
FMGRA10  B     FMGRAX                                                           
*                                                                               
FMGRA15  DS    0H                                                               
         C     R3,APAGBRK          TEST MGR 'HIGHER' THAN PAGE BRK              
         BNH   FMGRA18             YES                                          
*                                  MGR 'TOGETHER'                               
         CLC   P1,SPACES                                                        
         BE    FMGRA17                                                          
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
FMGRA17  DS    0H                                                               
         OC    18(24,R5),SPACES                                                 
         CLC   ALOWTOG,AHITOG                                                   
         BNE   FMGRA17B                                                         
*                                  IS ONLY TOGETHER                             
         MVC   P1(5),0(R5)                                                      
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P1+6(24),18(R5)                                                  
         B     FMGRA10                                                          
         GOTO1 =V(CHOPPER),DMCB,(24,18(R5)),(14,P1+6),(C'P',2)                  
         B     FMGRA10                                                          
FMGRA17B  DS    0H                                                              
         MVC   P1(12),6(R5)        DESC                                         
         LA    RF,P1+12                                                         
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   2(5,RF),0(R5)       NUMBER                                       
*                                                                               
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P2(24),18(R5)                                                    
         B     FMGR17D                                                          
         GOTO1 =V(CHOPPER),DMCB,(24,18(R5)),(20,P2),(C'P',2)                    
FMGR17D  DS    0H                                                               
         C     R3,ALOWTOG                                                       
         BE    *+8                                                              
         BAS   RE,FMULINE                                                       
         B     FMGRA20                                                          
*                                  MGR IN HEADS                                 
FMGRA18  DS    0H                                                               
FMGRA20  DS    0H                                                               
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMMGR',0)    EDI CALL                           
**EDI**                                                                         
         B     FMGRAX                                                           
*                                                                               
FMGRAX   DS    0H                                                               
         XMOD1                                                                  
*        UNDERLINE FIRST BLANK LINE                                             
FMULINE  NTR1                                                                   
*                                  FIND FIRST BLANK LINE                        
         LA    R3,P1                                                            
         SR    RE,RE                                                            
FMUL2    DS    0H                                                               
         OC    0(40,R3),SPACES                                                  
         CLC   0(40,R3),SPACES                                                  
         BE    FMUL4                                                            
         LA    R3,132(R3)                                                       
         LA    RE,1(RE)                                                         
         B     FMUL2                                                            
*                                                                               
FMUL4    DS    0H                                                               
         LTR   RE,RE                                                            
         BNP   FMULX                                                            
*                                                                               
         LA    RF,P1+40                                                         
FMUL5    DS    0H                                                               
         LR    R1,RF                                                            
         LR    R0,RE                                                            
FMUL6    DS    0H                                                               
         CLI   0(R1),C' '                                                       
         BH    FMUL8               FIRST NON-BLACK CHAR                         
         LA    R1,132(R1)                                                       
         BCT   R0,FMUL6                                                         
*                                                                               
         BCT   RF,FMUL5                                                         
*                                                                               
FMUL8    DS    0H                                                               
         LA    R0,P1                                                            
         SR    RF,R0                                                            
         BM    FMULX                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),DASHES                                                   
*                                                                               
FMULX    DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
RSAVKEY  DS    CL32                                                             
         LTORG                                                                  
SETR     NMOD1 0,SETR                                                           
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         MVI   CORPZ,C'N'          CLEAR CORP INV IND                           
         L     R4,=A(GDAREA)                                                    
         USING GDSECT,R4                                                        
         MVC   GDCLUST,SPACES                                                   
         CLI   GDMGRLEN,0                                                       
         BE    SR4                                                              
         CLI   RETPROF+14,C'*'     TEST PSEUDO MGR (ACCT PREFIX)                
         BNH   SR3                                                              
         MVC   GDMGR(1),RETPROF+14                                              
         B     SR4                                                              
SR3      DS    0H                                                               
         CLI   SVREGLEN,0                                                       
         BE    SR3D               NO REGION                                     
         ZIC   RF,SVREGLEN                                                      
         ZIC   RE,MGR1LEN                                                       
         SR    RE,RF                                                            
         BNM   *+6                                                              
         SR    RE,RE                                                            
         A     RE,AMGR1            USE LAST 'GDMGRLEN' POSITIONS                
         BCTR  RF,R0                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   GDMGR(0),0(RE)                                                   
SR3D     CLI   SVDSTLEN,0                                                       
         BE    SR4                 NO DISTRICT                                  
         ZIC   RF,SVDSTLEN                                                      
         ZIC   RE,MGR2LEN                                                       
         SR    RE,RF                                                            
         BNM   *+6                                                              
         SR    RE,RE                                                            
         A     RE,AMGR2            USE LAST 'GDMGRLEN' POSITIONS                
         BCTR  RF,R0                                                            
         LA    R6,GDMGR                                                         
         ZIC   R0,SVREGLEN                                                      
         AR    R6,R0                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R6),0(RE)                                                    
*                                                                               
SR4      DS    0H                                                               
         CLI   GDMKTLEN,0                                                       
         BE    SR6                                                              
         L     RF,AMKT                                                          
         LH    R0,0(RF)                                                         
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  GDMKT,DUB                                                        
*                                                                               
SR6      DS    0H                                                               
         CLI   UPASS,X'FF'        WAS C'S'                                      
         BE    SR10                                                             
         MVI   GDOUTNO,0                                                        
         MVC   GDSCHM,SPACES                                                    
         GOTO1 =V(FINDOUTP),DMCB,GDSECT                                         
*                                                                               
         MVI   UPASS,X'FE'                                                      
         MVI   RETERR,0             WAS C'T'                                    
         OC    GDNOUTS,GDNOUTS                                                  
         BNZ   SR10                                                             
         MVI   RETERR,1                                                         
         MVI   PRSW,C'N'                                                        
*                                                                               
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   P1(05),=C'** NO'                                                 
         MVC   P1(L'PP@NO),PP@NO                                                
         MVC   P1+6(15),GDOUTDSC                                                
*--->    MVC   P1+22(3),=C'FOR'                                                 
         MVC   P1+22(L'PP@FOR),PP@FOR                                           
         MVC   P1+26(15),GDMGRDSC                                               
         CLI   GDMKTLEN,0                                                       
         BE    *+10                                                             
         MVC   P1+26(15),GDMKTDSC                                               
         MVC   P1+42(6),GDMGR                                                   
         MVC   P1+49(2),GDMKT     *** NOT USED FOR PRINT                        
*                                                                               
*--->    MVC   P1+55(9),=C'(EST NNN)'                                           
         MVC   P1+55(L'PP@ESTN),PP@ESTN                                         
         DROP  RE                                                               
*                                                                               
         L     RF,AEST                                                          
         MVC   HALF,0(RF)                                                       
         LH    R0,HALF                                                          
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  P1+60(3),DUB                                                     
*                                                                               
         MVI   SKIPSPEC,C'Y'                                                    
         GOTO1 =A(PRNT)                                                         
         MVC   PAGE,=H'1'                                                       
*                                                                               
SR10     DS    0H                                                               
         XMOD1                                                                  
*                                                                               
         LTORG                                                                  
         DROP  R4                                                               
         EJECT                                                                  
FSTPUB   NMOD1 0,FSTPUB                                                         
         LA    RC,SPACEND                                                       
**PPNEW  L     RF,PPFILEC                                                       
**PPNEW  LA    R8,4095(RF)                                                      
**PPNEW  LA    R8,1(R8)                                                         
**PPNEW  USING PPFILED+4096,R8     NEEDED FOR PJOBREC                           
*                                                                               
         L     R8,PPFILEC          **PPNEW                                      
         USING PPFILED,R8          **PPNEW                                      
*                                                                               
         SPACE 2                                                                
         CLI   PUBCTL,C'N'                                                      
         BE    FPUBX                                                            
         MVC   WRKPMED,QMEDIA                                                   
         OC    AMED,AMED           FOR MULTI-MEDIA REQ GET MEDIA                
         BZ    FPUB0               FROM AMED                                    
         L     RF,AMED                                                          
         MVC   WRKPMED,0(RF)                                                    
*                                                                               
FPUB0    DS    0H                                                               
         XC    SVDA,SVDA      CLEAR SAVED DISK ADDR                             
*                             NEEDED WHEN ADDITIONAL CHARGES                    
*                             ARE ON SEPARATE INVOICES                          
         MVC   PPUBL1,SPACES                                                    
         MVC   PPUBL2,SPACES                                                    
         L     R4,APUB                                                          
         CLC   0(6,R4),XXPUB       SPECIAL FOR MANUAL BILLS                     
         BE    FPUBX               SPECIAL CODE FOR PREV BILLED                 
         CLC   0(6,R4),=X'FFFFFFFFFFFF'                                         
         BE    FPUBX               SPECIAL CODE FOR PREV BILLED                 
*                                  INSERTIONS FOR ALL PUBS                      
*                                  DON'T PRINT ANYTHING                         
*                                                                               
**                                                                              
*        READ PUB HERE                                                          
*                                                                               
         CLI   NOZEOPT,C'Y'        SEE IF SUPPRESSING ZONE/EDITION              
         BE    FPUB1                                                            
*        MUST SEARCH FOR FIRST MATCH ON BASE NUMBER                             
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(1),WRKPMED                                                   
         MVC   KEY+1(6),0(R4)                                                   
         MVC   KEY+7(2),QAGENCY                                                 
         MVI   KEY+9,X'81'                                                      
         GOTO1 HIGHPUB                                                          
         CLC   KEY(25),KEYSAVE                                                  
         BE    FPUB2                                                            
         L     RF,ADAGY                                                         
         CLI   PAGYPROF+16-PAGYREC(RF),C'0'   SEE IF I SHOULD LOOK              
         BE    FPUB1S              FOR DEFALUT                                  
         MVC   KEYSAVE+7(2),=C'ZZ' TEST ALREADY FOUND DEFAULT                   
         CLC   KEYSAVE(25),KEY                                                  
         BE    FPUB2                LOOK FOR DEFAULT                            
         B     FPUB1S                                                           
*                                                                               
*         I GET HERE IF SUPPRESSING ZONE/EDITION                                
*         (NOZEOPT=Y)                                                           
*                                                                               
FPUB1    DS    0H         LOOK FOR FIRST THAT MATCHES BASE NUMBER               
         XC    KEY,KEY                                                          
         MVC   KEY(1),WRKPMED                                                   
         MVC   KEY+1(4),0(R4)       BASE PUB -                                  
         MVC   KEY+7(2),QAGENCY                                                 
         MVI   KEY+9,X'81'                                                      
         GOTO1 HIGHPUB                                                          
         B     FPUB1C                                                           
*                                                                               
FPUB1B   GOTO1 SEQPUB                                                           
*                                                                               
FPUB1C   CLC   KEY(25),KEYSAVE                                                  
         BE    FPUB2                                                            
         CLC   KEY(5),KEYSAVE      CHECK FOR RIGHT BASE                         
         BNE   FPUB1G                                                           
         CLC   KEY+7(2),QAGENCY    CHECK RIGHT AGENCY                           
         BE    FPUB2               READ IT                                      
         L     RF,ADAGY                                                         
         CLI   PAGYPROF+16-PAGYREC(RF),C'0'  SEE IF USING DEFAULT               
         BE    FPUB1B              NO - DO SEQ READ                             
         CLC   KEY+7(2),=C'ZZ'                                                  
         BE    FPUB2               FOUND DEFAULT - READ IT                      
         B     FPUB1B              NO - KEEP LOOKING                            
*                                                                               
FPUB1G   DC    H'0'   CAN'T FIND ANY PUB FOR THIS NUMBER                        
*                     FOR MY AGENCY OR ZZ (IF APPLICABLE)                       
*                                                                               
FPUB1S   MVC   KEY,KEYSAVE    TRY TO READ MY PUB OR DEFAULT                     
         GOTO1 READPUB        WILL GET DATAMGR ERROR IF NOT FOUND               
*                                                                               
FPUB2    GOTO1 GETNAME             READ PUBREC                                  
*                                                                               
         L     RF,ADPUB                                                         
         MVC   PPUBL1(20),PUBNAME-PUBREC(RF)                                    
*                                                                               
         CLI   WRKPMED,C'O'        SEE IF OUTDOOR                               
         BNE   FPUB2B                                                           
         CLI   MKTCTL,0            SEE IF SHOWING MARKET                        
         BE    FPUB2B              NO - THEN SHOW HERE                          
         CLI   MKTCTL,C'N'         SEE IF SHOWING MARKET                        
         BE    FPUB2B              NO - THEN SHOW HERE                          
         B     FPUB3               MKT WILL BE SEPERATE LINE                    
*                                                                               
FPUB2B   DS    0H                                                               
         CLI   NOZEOPT,C'Y'  NO ZONE/MKT IF SUPPRESSING ZONE/EDIT               
         BE    *+10                                                             
         MVC   PPUBL2(20),PUBZNAME-PUBREC(RF)                                   
*                                                                               
         CLI   WRKPMED,C'N'                                                     
         BNE   FPUB3                                                            
         CLI   MKTCTL,0           SEE IF SHOWING MARKET                         
         BE    FPUB2C                                                           
         CLI   MKTCTL,C'N'        SEE IF SHOWING MARKET                         
         BE    FPUB2C                                                           
         B     FPUB3                                                            
*                                                                               
FPUB2C   CLI   PUBCITY-PUBREC(RF),C' '                                          
         BE    FPUB3                                                            
         CLI   PUBSTATE-PUBREC(RF),C' '                                         
         BNH   FPUB3                                                            
         MVC   PPUBL1,SPACES                                                    
         MVC   PPUBL1(2),PUBSTATE-PUBREC(RF)                                    
         MVI   PPUBL1+2,C','                                                    
         MVC   PPUBL1+3(16),PUBCITY-PUBREC(RF)                                  
         LA    R5,PPUBL1+20                                                     
         CLI   0(R5),C' '                                                       
         BH    *+8                                                              
         BCT   R5,*-8                                                           
         LA    R5,3(R5)                                                         
         MVC   0(20,R5),PUBNAME-PUBREC(RF)                                      
*                                                                               
FPUB3    L     RF,ADAGY                                                         
         IC    R5,PAGYPROF+12-PAGYREC(RF)                                       
         LA    R6,PPUBL1+40                                                     
FPUB3A   CLI   0(R6),C' '                                                       
         BH    FPUB3B                                                           
         BCTR  R6,0                                                             
         B     FPUB3A                                                           
*                                                                               
FPUB3B   LA    R6,2(R6)                                                         
         GOTO1 PUBEDIT,DMCB,((R5),0(R4)),1(R6)                                  
         MVI   0(R6),C'('                                                       
         LA    R5,PPUBL1+58                                                     
FPUB3E   CLI   0(R5),C' '                                                       
         BH    FPUB3F                                                           
         BCTR  R5,0                                                             
         B     FPUB3E                                                           
*                                                                               
FPUB3F   MVI   1(R5),C')'                                                       
*                                                                               
*                                                                               
FPUB4M   DS    0H                                                               
         OC    PPUBL1,SPACES                                                    
         OC    PPUBL2,SPACES                                                    
         C     R3,ALOWTOG                                                       
         BH    FPUBX               SKIP IF LOWEST TOG OR NOT TO APPEAR          
**NEW 5/5/89                       WAS BNL                                      
***NO-OP                                                                        
*******  C     R3,APAGBRK          TEST PUB 'HIGHER' THAN PAGE BRK              
*******  BNH   FPUB8               YES                                          
*                                  PUB TOGETHER (WITH INS DETAILS)              
         CLC   P1,SPACES                                                        
         BE    FPUB5                                                            
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
FPUB5    DS    0H                                                               
         MVC   P1+0(60),PPUBL1                                                  
         MVC   P2+0(20),PPUBL2                                                  
**NEW 1/20/89                                                                   
         CLI   PUBCTL,C'S'          SEE IF PUB SEPERATE                         
         BNE   FPUB8                                                            
         MVC   P1+0(60),SPACES                                                  
         MVC   P2+0(20),SPACES      DON'T PUT PUB IN P1 AND P2                  
*                                    WILL BE DONE AT RB16J                      
*                                                                               
FPUB8    DS    0H                                                               
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMPUB',0)   EDI CALL                            
**EDI**                                                                         
*                                                                               
FPUBX    DS    0H                                                               
         XMOD1                                                                  
*                                                                               
WRKPMED  DC    C' '                                                             
*                                                                               
         LTORG                                                                  
         TITLE 'FIRST FOR JOB ROUTINE'                                          
JOBFRST  NMOD1 0,JOBFRST                                                        
         LA    RC,SPACEND                                                       
**PPNEW  L     RF,PPFILEC                                                       
**PPNEW  LA    R8,4095(RF)                                                      
**PPNEW  LA    R8,1(R8)                                                         
**PPNEW  USING PPFILED+4096,R8     NEEDED FOR PJOBREC                           
*                                                                               
         L     R8,PPFILEC          **PPNEW                                      
         USING PPFILED,R8          **PPNEW                                      
*                                                                               
         CLI   JOBCTL,C'N'         SEE IF NOT SHOWING JOB                       
         BE    FJOBX                                                            
         CLI   JOBCTL,0            SEE IF NOT SHOWING JOB                       
         BE    FJOBX                                                            
*                                                                               
         MVC   JOBL1,SPACES                                                     
         MVC   JOBL2,SPACES                                                     
         MVC   JOBL3,SPACES                                                     
         MVC   JOBL4,SPACES                                                     
         MVC   JOBL5,SPACES                                                     
         MVC   JOBL6,SPACES                                                     
*                                                                               
****     L     RF,=A(JADDRS)       CLEAR JOB - REP ADDRESS                      
****     MVC   0(132,RF),SPACES                                                 
****     MVC   132(OADDRLEN-132,RF),SPACES                                      
*                                                                               
         L     R0,=A(JADDRS)       CLEAR JOB - REP ADDRESS                      
         LHI   R1,ADDRLEN                                                       
         SR    RE,RE                                                            
         LA    RF,X'40'                 FILL WITH SPACES                        
         SLL   RF,24                                                            
         MVCL  (R0),(RE)                                                        
*                                                                               
*                                                                               
FJOB5    DS    0H                                                               
**WB**                                                                          
         CLI   WBSW,C'Y'            WB FLIGHT FEATURE?                          
         BNE   FJOB5J                                                           
         MVC   JOBL1+0(7),=C'FLIGHT='                                           
         L     RF,AJOB                                                          
         MVC   JOBL1+8(10),JOBDSP(RF)   FLIGHT ID HERE                          
         B     FJOB19                                                           
FJOB5J   DS    0H                                                               
         CLI   PO#OPT,C'Y'         BILLING BY PO#                               
         BE    FJOB19              SKIP JOB (USED BY PO#)                       
**WB**                                                                          
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   JOBL1+0(8),=C'AD CODE='                                          
         MVC   JOBL1+0(L'PP@ADCOD),PP@ADCOD                                     
         L     RF,AJOB                                                          
         MVC   JOBL1+8(6),JOBDSP(RF) PAST PRD                                   
         CLI   0(RF),X'FF'         FOR NO AD CODE                               
         BNE   FJOB6               PRD WILL BE X'FF'S                           
*--->    MVC   JOBL1+8(6),=C'*NONE*'                                            
         MVC   JOBL1+8(L'PP@NONE),PP@NONE                                       
         DROP  RE                                                               
         B     FJOB8                                                            
*                                                                               
FJOB6    DS    0H                                                               
         CLI   JOBDSP(RF),X'FF'    AD ID ALONE JOB?                             
         BNE   FJOB8                                                            
         MVC   JOBL1,SPACES                                                     
         MVC   JOBL1+0(5),=C'AD ID'                                             
         MVC   JOBL1+6(ADIDLQ),ADIDDSP(RF)                                      
         LA    R1,JOBL1+6+ADIDLQ                                                
         B     FJOB8A                                                           
*                                                                               
FJOB8    DS    0H                                                               
         LA    R1,JOBL1+8+ADIDLQ                                                
FJOB8A   CLI   0(R1),C' '                                                       
         BH    *+8                                                              
         BCT   R1,*-8                                                           
         LA    R0,JOBL1+8                                                       
         LA    R2,JOBL2+8                                                       
*                                                                               
         CLI   JOBDSP(RF),X'FF'        AD ID ALONE?                             
         BNE   *+12                                                             
         LA    R0,JOBL1+6                                                       
         LA    R2,JOBL2+6                                                       
         SR    R1,R0                                                            
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),DASHES                                                   
*                                                                               
         L     RF,AJOB                                                          
         CLI   0(RF),X'FF'                                                      
         BE    FJOB19              NO JOB                                       
         XC    WORK(25),WORK                                                    
         L     RF,ADCLT                                                         
         MVC   WORK(7),0(RF)       AGY/MED/CODE/CLT                             
         OC    AMED,AMED           FOR MULTI-MEDIA REQ GET MEDIA                
         BZ    FJOB8B              FROM AMED                                    
         L     RF,AMED                                                          
         MVC   WORK+2(1),0(RF)                                                  
*                                                                               
FJOB8B   MVI   WORK+3,X'15'                                                     
         L     RF,AJOB                                                          
         MVC   WORK+7(3),0(RF)      PRD                                         
         MVC   WORK+10(6),JOBDSP(RF)                                            
         CLC   PJOBREC(25),WORK                                                 
         BE    FJOB18CX                                                         
         MVC   JSAVKEY,KEY                                                      
         MVC   KEY(25),WORK                                                     
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         GOTO1 GETJOB                                                           
*                                                                               
         MVC   KEY,JSAVKEY                                                      
         GOTO1 HIGH                                                             
*                                                                               
FJOB18CX DS    0H                                                               
         L     RF,AJOB                                                          
         CLI   JOBDSP(RF),X'FF'       AD ID ONLY?                               
         BE    FJOB18CZ               DON'T SHOW IT HERE                        
         CLC   PJOBADID,SPACES        AD ID PRESENT?                            
         BNH   FJOB18CZ                                                         
         MVC   JOBL2+0(7),=C'AD ID= '      (7) TO CLEAR FIRST DASH              
         MVC   JOBL2+7(ADIDLQ),PJOBADID                                         
*                                                                               
FJOB18CZ DS    0H                                                               
         CLI   JOBOPT,C'N'            NO JOB INFO                               
         BE    FJOB18H                                                          
*                                                                               
         CLI   JOBOPT,C'A'            OR AD NUMBER ONLY                         
         BE    FJOB18H                                                          
         CLC   JOBL2+0(6),=C'AD ID='  IS AD ID IN LINE 2?                       
         BE    *+10                   IF SO LEAVE IT                            
*                                  MUST HAVE BEEN UNDERLINING                   
         MVC   JOBL2(20),SPACES    BLANK OUT UNDERLINING                        
         TM    JOBOPT,X'30'                                                     
         BZ    FJOB18D                                                          
*                                       COPY NO.                                
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   JOBL2+0(6),=C'COPY ='                                            
         LA    R1,JOBL2                                                         
         CLC   JOBL2,SPACES      CAN I USE JOBL2?                               
         BE    *+8                                                              
         LA    R1,JOBL3          NO USE JOBL3                                   
         MVC   0(L'PP@COPY,R1),PP@COPY                                          
         DROP  RE                                                               
         MVC   7(17,R1),PJOBCPY                                                 
         MVI   SPACING,2                                                        
         B     FJOB18F                                                          
*                                       AD. NO.                                 
FJOB18D  DS    0H                                                               
*                                                                               
FJOB18F  DS    0H                                                               
*                                                                               
         TM    JOBOPT,X'02'                                                     
         BZ    FJOB18H                                                          
         LA    R2,JOBL2               JOBL2 AND JOBL3 AVAILABLE?                
         LA    R1,JOBL3                                                         
         CLC   0(15,R2),SPACES                                                  
         BE    FJOB18G                                                          
         LA    R2,JOBL3                TRY JOBL3 AND JOBL4                      
         LA    R1,JOBL4                                                         
         CLC   0(15,R2),SPACES                                                  
         BE    FJOB18G                                                          
         LA    R2,JOBL4                MUST USE JOBL4 AND JOBL5                 
         LA    R1,JOBL5                                                         
*                                  CAPTION                                      
FJOB18G  MVC   0(25,R2),PJOBCAP1                                                
         MVC   0(25,R1),PJOBCAP2                                                
         MVI   SPACING,2                                                        
*                                                                               
FJOB18H  DS    0H                                                               
         OC    PJOBBLCC,PJOBBLCC        BILLING CONTACT                         
         BZ    FJOB18M                                                          
         LA    R2,JOBL3                                                         
         CLC   0(15,R2),SPACES                                                  
         BE    FJOB18I                                                          
         LA    R2,JOBL4                                                         
         CLC   0(15,R2),SPACES                                                  
         BE    FJOB18I                                                          
         LA    R2,JOBL5                                                         
         CLC   0(15,R2),SPACES                                                  
         BE    FJOB18I                                                          
         LA    R2,JOBL6                 MUST USE JOBL6                          
FJOB18I  MVC   0(30,R2),PJOBBLCC                                                
         MVI   SPACING,2                                                        
*                                                                               
FJOB18M  DS    0H                 CHECK FOR BILLING REP                         
         CLI   PJOBBREP,C' '                                                    
         BNH   FJOB19                                                           
*                                                                               
*                                 READ REP AND SET ADDRESS                      
*                                 INTO JADDRS                                   
         MVC   JSAVKEY,KEY                                                      
         XC    KEY,KEY                                                          
         MVC   KEY(3),WORK        AGY,MED                                       
         MVI   KEY+3,X'11'                                                      
         MVC   KEY+4(4),PJOBBREP                                                
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'               MUST FIND REP                                 
         LA    R0,PREPREC                                                       
         ST    R0,AREC                                                          
         GOTO1 GETPRT                                                           
*                                                                               
         MVC   KEY,JSAVKEY                                                      
         GOTO1 HIGH                                                             
*                                                                               
         L     RF,=A(JADDRS)                                                    
         MVC   0(30,RF),PREPNAME                                                
         MVC   60(30,RF),PREPLIN1                                               
         MVC   120(30,RF),PREPLIN2                                              
         LA    RE,156(RF)                                                       
         OC    PREPATTN,PREPATTN     SEE IF I HAVE AN ATTENTION                 
         BZ    FJOB18P                                                          
         MVC   180(5,RF),=C'ATTN:'                                              
         MVC   186(20,RF),PREPATTN                                              
         LA    RE,186(RF)                                                       
*                                                                               
FJOB18P  OC    PJOBBLCC,PJOBBLCC    SEE IF I HAVE A BILLING CONTACT             
         BZ    *+10                                                             
         MVC   0(30,RE),PJOBBLCC                                                
*                                                                               
         DROP  R8                                                               
*                                  PREVIOUS BILLING                             
FJOB19   DS    0H                                                               
         C     R3,ALOWTOG                                                       
         BH    FJOBX                                                            
**NEW 5/5/89                      WAS BNL                                       
         CLC   P1,SPACES                                                        
         BE    FJOB25                                                           
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
FJOB25   MVC   P1(25),JOBL1                                                     
         MVC   P2(25),JOBL2                                                     
         MVC   P3(30),JOBL3                                                     
         MVC   P4(30),JOBL4                                                     
         MVC   P5(30),JOBL5                                                     
         MVC   P6(30),JOBL6                                                     
         JIF   JOBCTL,NE,C'S',OR,PUBCTL,NE,C'S',FJOB25X,JUMP=N                  
*                                  IF PUB AND JOB CLTS ARE BOTH                 
*                                  'S' THEN DON'T PUT JOBLINES IN P1            
         MVC   P1(25),SPACES                                                    
         MVC   P2(25),SPACES                                                    
         MVC   P3(30),SPACES                                                    
         MVC   P4(30),SPACES                                                    
         MVC   P5(30),SPACES                                                    
         MVC   P6(30),SPACES                                                    
**EDI**                                                                         
FJOB25X  DS    0H                                                               
         GOTO1 ABILLEDI,DMCB,('EDMJOB',0)     EDI CALL                          
**EDI**                                                                         
*                                                                               
FJOBX    DS    0H                                                               
         XMOD1                                                                  
*                                                                               
JSAVKEY  DS    CL32                                                             
*                                                                               
         LTORG                                                                  
         TITLE 'SPECIAL ROUTINE FOR LAST FOR DESCRIPTION'                       
LASTDSC  NMOD1 0,LASTDSC                                                        
         LA    RC,SPACEND                                                       
         LA    R8,LASTDSC+4095                                                  
         LA    R8,1(R8)                                                         
         USING LASTDSC+4096,R8     R8 SECOND BASE REGISTER                      
         SPACE 2                                                                
         OC    ACTYP,ACTYP         CHECK IF HAVE A(SPECIAL CHAGE LEV)           
         BNZ   *+6                                         (*YKVA*)             
         DC    H'0'                NO, DIE FOR NOW (SHOULD NOT HAPPEN)          
         MVC   WRKMED,QMEDIA                                                    
         OC    AMED,AMED                                                        
         BZ    LDESC1                                                           
         L     RF,AMED                                                          
         MVC   WRKMED,0(RF)                                                     
*                                                                               
LDESC1   DS    0H                                                               
         MVI   PRTINSW,C'Y'        SET ON INS PRINT SWITCH                      
*                                                                               
         CLI   PASSNO,1            AND IF PASS 1                                
         BNE   LDESC4                                                           
*                                                                               
         L     RF,ADESC                                                         
         CLI   0(RF),X'FA'         TEST MANUAL RECORD                           
         BNH   LDESC2                                                           
         B     LDESC4                                                           
*                                                                               
LDESC2   DS    0H                                                               
*                                                                               
         CLI   UPASS,X'FF'         IF RETAIL SUMMARY PASS  - WAS C'S'           
         BE    LDESCX                                                           
*                                                                               
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)        POINT TO ACCUM FOR THIS LEVEL                
         ST    R7,SAVR1            SAVE ADDRESS OF ACCUM                        
*                                  RE-WRITE RECORDS                             
         CLI   UPASS,1       FOR RETAIL ONLY RE-RWRITE RECS FOR CORP            
         BH    LDESC2D       SKIP TO TOTALING IN WORK                           
*                                                                               
         SPACE 2                                                                
*                                                                               
         L     R6,ASORTCOM         DISK ADDR IN COMMENT                         
         OC    0(4,R6),0(R6)       NO DA MEANS LINE IS TOTALLY BILLED           
         BZ    LDESC2X             (MAY BE MULTIPLE UNITS)                      
         MVC   KEY+27(4),0(R6)                                                  
         MVC   AREC,ADWKREC                                                     
         GOTO1 GETPRT                                                           
         L     R7,ADWKREC                                                       
         USING PBUYREC,R7                                                       
         LA    R2,PBDELEM                                                       
         MVI   ELCODE,X'30'                                                     
         TM    FINANSW,X'01'      SEE IF DOING FINANCIAL BILL                   
         BNO   LDESC2A            OLD STYLE OR RJ PALMER                        
         BRAS  RE,NEXTEL                                                        
         BE    LDESC2AX                                                         
         DC    H'0'                NO FINANCIAL ELEM                            
*                                                                               
LDESC2A  BRAS  RE,NEXTEL                                                        
         BNE   LDESC2AX                                                         
         DC    H'0'            FINANCIAL ELEM ON NON-FINANCIAL BILL             
*                                                                               
LDESC2AX L     RF,APRD                                                          
         MVC   WPRD,0(RF)                                                       
*                                                                               
         CLI   MANRVDTP,0          IF A REVERSAL                                
         BE    LDESC2D                                                          
*                                  FIND ELEMS TO REVERSE                        
         LA    R2,PBDELEM                                                       
         MVI   ELCODE,X'26'        BILL ELEM                                    
***R***                                                                         
         CLC   QPROG,=C'R1'        FINANCIAL REBATE REVERSAL                    
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
         CLC   QPROG,=C'RD'        FINANCIAL REBATE REVERSAL - DRAFT            
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
***R***                                                                         
*                                                                               
LDESC2B  DS    0H                                                               
         BRAS  RE,NEXTEL                                                        
         BNE   LDESC2C                                                          
*                                                                               
         USING PBILELEM,R2                                                      
         CLC   PBPRD,WPRD           SAVE WPRD                                   
         BNE   LDESC2B                                                          
*                                                                               
         L     R1,ACTYP                                                         
         CLI   1(R2),23            IF ADDIT CHG ELEM, LEN = 25                  
         BNH   LDESC2B2                                                         
         CLC   PBACCODE,0(R1)      IS IT SPECIAL CHG WE NEED?                   
         BNE   LDESC2B             NO, GET NEXT ELEM                            
         B     LDESC2B3                                                         
*                                                                               
LDESC2B2 OC    0(L'PBACCODE,R1),0(R1) DO WE HAVE SPEC CHARGE?                   
         BNZ   LDESC2B               YES, GET NEXT ELEM                         
*                                                                               
LDESC2B3 L     R1,ASORTCOM                                                      
         CLI   PO#OPT,C'Y'        BILLING BY PO#?                               
         BNE   LDESC2B4                                                         
         CLI   1(R2),25           LENGTH MUST BE 25                             
         BL    LDESC2B            NO, GET NEXT ELEM                             
         CLC   PBPOSEQ,4(R1)      PO#S MUST MATCH (PAST X'FF' C'PO')            
         BNE   LDESC2B            NO, GET NEXT ELEM                             
*                                                                               
LDESC2B4 CLC   PBLDATE,MANRVDTP   TEST ELEM FOR REVSRL DATE                     
         BNE   LDESC2B             NO-SKIP                                      
         CLC   PBINVNO,MANRVNO     TEST RIGHT INV NUMBER                        
         BNE   LDESC2B                                                          
         CLI   SCBNCSW,C'C'        UFC COMM BILLING                             
         BNE   LDESC2B5                                                         
         TM    PBBILST,X'01'       SEE IF RIGHT TYPE                            
         BZ    LDESC2B                                                          
         B     LDESC2B7                                                         
*                                                                               
LDESC2B5 DS    0H                                                               
         CLI   SCBNCSW,C'N'        UFC NET BILLING                              
         BNE   LDESC2B7                                                         
         TM    PBBILST,X'02'       SEE IF RIGHT TYPE                            
         BZ    LDESC2B                                                          
*                                                                               
LDESC2B7 OI    PBBILST,X'80'       SET REVERSED                                 
         B     LDESC2B             NEXT ELEM                                    
*                                                                               
LDESC2C  DS    0H                                                               
         CLI   FINANSW,0           FOR FINANCIAL CLIENTS REVERSE                
         BE    LDESC2D             OPEN BILLING ELEMS                           
***R***                                                                         
         CLC   QPROG,=C'R1'        UNLESS REBATE REVERSAL                       
         BE    LDESC2D                                                          
         CLC   QPROG,=C'RD'        UNLESS REBATE REVERSAL - DRAFT               
         BE    LDESC2D                                                          
***R***                                                                         
         LA    R2,PBDELEM                                                       
         MVI   ELCODE,X'28'        BILL ELEM                                    
*                                                                               
LDESC2C5 DS    0H                                                               
         BRAS  RE,NEXTEL                                                        
         BNE   LDESC2D                                                          
*                                                                               
         USING PBILELEM,R2                                                      
         CLC   PBPRD,WPRD           SAVE WPRD                                   
         BNE   LDESC2C5                                                         
*                                                                               
         L     R1,ACTYP                                                         
         CLI   1(R2),23            IF ADDIT CHG ELEM, LEN = 25                  
         BNH   *+18                                                             
         CLC   PBACCODE,0(R1)      IS IT SPECIAL CHG WE NEED?                   
         BNE   LDESC2C5            NO, GET NEXT ELEM                            
         B     *+14                                                             
         OC    0(L'PBACCODE,R1),0(R1) DO WE HAVE SPEC CHARGE?                   
         BNZ   LDESC2C5               YES, GET NEXT ELEM                        
*                                                                               
         CLC   PBLDATE,MANRVDTP   TEST ELEM FOR REVSRL DATE                     
         BNE   LDESC2C5            NO-SKIP                                      
         CLC   PBINVNO,MANRVNO     TEST RIGHT INV NUMBER                        
         BNE   LDESC2C5                                                         
*                                                                               
         OI    PBBILST,X'80'       SET REVERSED                                 
         B     LDESC2C5            NEXT ELEM                                    
*                                  FIND WHERE TO PUT BILLING ELEMS              
LDESC2D  DS    0H                                                               
         MVI   BILLPASS,0       SET FOR FIRST BILL ELEM PASS                    
LDESC2D5 CLI   UPASS,1          SEE IF DOING RETAIL - ONLY                      
         BH    LDESC2G          ONLY REWRITE RECS FOR CORP PASS                 
*                                                                               
         MVI   BYTE,0                                                           
         L     R7,ADWKREC                                                       
         LA    R2,PBDELEM                                                       
         MVI   ELCODE,X'26'                                                     
***R***                                                                         
         CLC   QPROG,=C'R1'      FINANCIAL REBATE BILL                          
         BNE   *+8                                                              
         MVI   ELCODE,X'29'      SPECIAL BILL ELEM CODE                         
         CLC   QPROG,=C'RD'      FINANCIAL REBATE BILL DRAFT                    
         BNE   *+8                                                              
         MVI   ELCODE,X'29'      SPECIAL BILL ELEM CODE                         
***R***                                                                         
LDESC2D7 DS    0H                                                               
         CLI   BILLPASS,0        SEE IF DOING FIRST BILL ELEM PASS              
         BE    *+8                                                              
         MVI   ELCODE,X'28'                                                     
LDESC2E  BRAS  RE,NEXTEL                                                        
         BE    LDESC2F                                                          
         B     LDESC2G                                                          
*                                                                               
LDESC2F  DS    0H                                                               
         CLI   1(R2),X'17'         IGNORE BAD ELEMS                             
         BNE   LDESC2E             FROM JWT CONVERSION                          
*                                                                               
         USING PBILELEM,R2                                                      
         L     R1,ACTYP                                                         
         CLI   1(R2),23            IF ADDIT CHG ELEM, LEN = 25                  
         BNH   LDESC2F2                                                         
         CLC   PBACCODE,0(R1)      IS IT SPECIAL CHG WE NEED?                   
         BNE   LDESC2E             NO, GET NEXT ELEM                            
         B     LDESC2F3                                                         
*                                                                               
LDESC2F2 OC    0(L'PBACCODE,R1),0(R1) DO WE HAVE SPEC CHARGE?                   
         BNZ   LDESC2E                YES, GET NEXT ELEM                        
*                                                                               
LDESC2F3 L     R1,ASORTCOM                                                      
         CLI   PO#OPT,C'Y'        BILLING BY PO#?                               
         BNE   LDESC2F4                                                         
         CLI   1(R2),25           LENGTH MUST BE 25                             
         BL    LDESC2E            NO, GET NEXT ELEM                             
         CLC   PBPOSEQ,4(R1)      PO#S MUST MATCH (PAST X'FF' C'PO')            
         BNE   LDESC2E            NO, GET NEXT ELEM                             
*                                                                               
LDESC2F4 OC    5(3,R2),5(R2)       CHK FOR DATE                                 
         BZ    LDESC2F5                                                         
         CLC   QREGION(6),SPACES                                                
         BE    LDESC2E                                                          
*                                 FOR REG/DST BILLING                           
*                                 SUM ELEMS FOR MULTIPLE                        
*                                 REG/DST ASSIGNS                               
         CLC   5(3,R2),TODAYB                                                   
         BNE   LDESC2E                                                          
         CLC   2(3,R2),WPRD                                                     
         BNE   LDESC2E                                                          
         CLC   8(2,R2),INVNO                                                    
         BNE   LDESC2E                                                          
         MVI   BYTE,2             MEANS TO ADD TO EXISTING ELEM                 
         B     LDESC2G                                                          
LDESC2F5 MVI   BYTE,1                                                           
*                                                                               
LDESC2G  L     R5,SAVR1            START OF TOTALS                              
         AH    R5,=Y(MAXMOS*ROWL)                                               
*****    LA    R5,MAXMOS*ROWL(R5)  POINT TO TOTAL ROW                           
*                                                                               
         XC    WORK,WORK                                                        
*                                                                               
         CLI   BILLPASS,0                                                       
         BE    *+8                                                              
         LA    R5,ROWTL(R5)          OPEN GROSS,NET,CD                          
         L     R0,0(R5)                                                         
         S     R0,ROWHL(R5)                                                     
         ST    R0,WORK                                                          
         L     R0,4(R5)                                                         
         S     R0,ROWHL+4(R5)                                                   
         ST    R0,WORK+4                                                        
         L     R0,8(R5)                                                         
         S     R0,ROWHL+8(R5)                                                   
         ST    R0,WORK+8                                                        
*                                                                               
         OC    WORK(12),WORK        TEST ANYTHING BILLABLE                      
         BNZ   LDESC2G4            YES- PROCESS, ELSE SKIP                      
*                                                                               
***TAX   NOTE - CHECK ABOVE DOES NOT CATCH ONLY BILLABLE TAX                    
***TAX          THIS SHOULD NOT OCCUR SINCE THE TAX PCT.                        
***TAX          WILL NOT BE PERMITTED TO CHANGE ON BILLED INSERTIONS            
***TAX          ALSO THERE MAY BE DESCRIPANCIES DUE TO ROUNDING                 
*                                                                               
*                                                                               
         MVI   PRTINSW,C'Y'        SET ON INS PRINT SWITCH                      
*                                                                               
                                                                                
         CLI   BILLPASS,0                                                       
         BE    LDESC2GB                                                         
         CLI   FINANSW,X'03'        COST 2 - RATE                               
         BE    LDESC2GA                                                         
         TM    FINANSW,X'80'        COST 2 - FACTOR                             
         BO    LDESC2GA                                                         
         B     LDESC2GB                                                         
*                                                                               
LDESC2GA CLI   FREEOPT,C'C'         OMITTING ZERO COST2 INS.                    
         BNE   LDESC2GB                                                         
         OC    0(12,R5),0(R5)       ANY COST2 ORDERED?                          
         BNZ   LDESC2GB                                                         
*                                                                               
         MVI   PRTINSW,C'N'         PROCESS BUT DON'T PRINT                     
         B     LDESC2GC                                                         
*                                                                               
LDESC2GB CLI   FREEOPT,C'Y'         SEE IF BILLING FREE INSERTIONS              
         BNE   LDESC2IX                                                         
LDESC2GC L     RE,ADWKREC                                                       
         CLC   PBUYKDAT-PBUYREC(3,RE),=X'5C0901' MUST BE AFTER 9/1/92           
         BL    LDESC2IX                                                         
*                                                                               
*                           CHECK IF I HAVE BILLING ELEM WITH DATE              
*                           IF FOUND I CAN SKIP                                 
         ST    R2,SAVER2                                                        
*                                                                               
         L     R7,ADWKREC                                                       
         LA    R2,PBDELEM                                                       
         MVI   ELCODE,X'26'                                                     
***R***                                                                         
         CLC   QPROG,=C'R1'      FINANCIAL REBATE BILL                          
         BNE   *+8                                                              
         MVI   ELCODE,X'29'      SPECIAL BILL ELEM CODE                         
         CLC   QPROG,=C'RD'      FINANCIAL REBATE BILL DRAFT                    
         BNE   *+8                                                              
         MVI   ELCODE,X'29'      SPECIAL BILL ELEM CODE                         
***R***                                                                         
         CLI   BILLPASS,0        SEE IF DOING FIRST BILL ELEM PASS              
         BE    *+8                                                              
         MVI   ELCODE,X'28'                                                     
LDESC2G0 BRAS  RE,NEXTEL                                                        
         BE    LDESC2G1                                                         
         B     LDESC2G2                                                         
*                                                                               
LDESC2G1 DS    0H                                                               
*                                                                               
         USING PBILELEM,R2                                                      
         L     R1,ACTYP                                                         
         CLI   1(R2),23            IF ADDIT CHG ELEM, LEN = 25                  
         BNH   *+18                                                             
         CLC   PBACCODE,0(R1)      IS IT SPECIAL CHG WE NEED?                   
         BNE   LDESC2G0            NO, GET NEXT ELEM                            
         B     *+14                                                             
         OC    0(L'PBACCODE,R1),0(R1) DO WE HAVE SPEC CHARGE?                   
         BNZ   LDESC2G0               YES, GET NEXT ELEM                        
*                                                                               
         CLC   2(3,R2),WPRD        SEE IF RIGHT PRODUCT                         
         BNE   LDESC2G0            NO - SKIP                                    
         OC    5(3,R2),5(R2)       CHECK FOR DATE                               
         BZ    LDESC2G2                                                         
         CLC   5(3,R2),EXDATE      SEE IF MATCHES IGNORE DATE                   
         BE    LDESC2G0            SKIP THIS ELEM                               
*                                                                               
*****    CLI   SHOWREV,C'Y'        INCLUDING?                                   
*****    BE    *+12                                                             
*                                                                               
         TM    PBBILST,X'C0'       SKIP REVERSED AND REVERALS                   
         BNZ   LDESC2G0                                                         
         CLI   SCBNCSW,C'C'        UFC COMM BILLING                             
         BNE   *+16                                                             
         TM    PBBILST,X'01'       SEE IF RIGHT TYPE                            
         BZ    LDESC2G0                                                         
         B     LDESC2G3                                                         
*                                                                               
         CLI   SCBNCSW,C'N'         UFC NET BILLING                             
         BNE   LDESC2G3                                                         
         TM    PBBILST,X'02'        SEE IF RIGHT TYPE                           
         BZ    LDESC2G0                                                         
         DROP  R2                                                               
*                                                                               
*                                                                               
LDESC2G2 DS    0H                                                               
         L     R2,SAVER2                                                        
         B     LDESC2G4            MUST ADD BILLELEM WITH 0 DOLLARS             
*                                  SO I WON'T PROCESS AGAIN                     
*                                                                               
LDESC2G3 DS    0H                  DON'T ADD ELEMENT                            
         L     R2,SAVER2                                                        
         B     LDESC2IX            MUST STILL CHK OPEN BILLABLE                 
*                                                                               
*                                                                               
*                                                                               
LDESC2G4 CLI   UPASS,1        RETAIL - ONLY MARK REC ON CORP PASS               
         BH    LDESC2I            SKIP TO DBTOTS TOTALLING                      
*                                                                               
*                                                                               
         CLI   BYTE,1              SEE IF BILL ELEM ALREADY THERE               
         BE    LDESC2G5                                                         
         CLI   BYTE,2              SEE IF SUMMING TO EXISTING BILL ELEM         
         BNE   LDESC2H                                                          
LDESC2G5 LR    R4,R2                                                            
         B     LDESC2H5                                                         
LDESC2H  XC    X,X                                                              
         LA    R4,X                                                             
         USING PBILELEM,R4                                                      
LDESC2H5 MVC   PBILELEM(2),=X'2617' SET CODE AND LENGTH                         
***R***                                                                         
*                                                                               
         L     R1,ACTYP                                                         
         OC    0(L'PBACCODE,R1),0(R1) DO WE HAVE SPECIAL CHG?                   
         BZ    LDESC2H6            NO, NOTHING SPECIAL                          
         MVI   1(R4),X'19'         YES, BUMP UP LEN BY 2                        
         MVC   PBACCODE,0(R1)      PUT CHARGE CODE                              
*                                                                               
LDESC2H6 DS    0H                                                               
         CLI   PO#OPT,C'Y'         SEE IF BILLING BY PO#                        
         BNE   LDESC2H7                                                         
         L     R1,ASORTCOM                                                      
         MVC   PBPOSEQ,4(R1)       PO SEQ#                                      
         MVI   1(R4),X'1B'         YES, BUMP UP LEN BY 2 MORE                   
*                                                                               
LDESC2H7 CLC   QPROG,=C'R1'        FINANCIAL REBATE REVERSAL                    
         BNE   *+8                                                              
         MVI   PBILELEM,X'29'                                                   
         CLC   QPROG,=C'RD'        FINANCIAL REBATE REVERSAL - DRAFT            
         BNE   *+8                                                              
         MVI   PBILELEM,X'29'                                                   
***R***                                                                         
LDESC2H8 CLI   BILLPASS,0                                                       
         BE    *+8                                                              
         MVI   PBILELEM,X'28'                                                   
*                                                                               
         CLI   BYTE,2              SEE IF SUMMING TO EXISTING ELEM              
         BNE   LDESC2H9                                                         
         ICM   R0,15,PBGROSS                                                    
         A     R0,WORK                                                          
         STCM  R0,15,PBGROSS                                                    
         L     R0,WORK                                                          
         S     R0,WORK+4                                                        
         ST    R0,FULL                                                          
         ICM   R0,15,PBAGYCOM                                                   
         A     R0,FULL                                                          
         STCM  R0,15,PBAGYCOM                                                   
         ICM   R0,15,PBCSHDSC                                                   
         A     R0,WORK+8                                                        
         STCM  R0,15,PBCSHDSC                                                   
         B     LDESC2HX                                                         
LDESC2H9 MVC   PBLDATE,TODAYB                                                   
         MVC   PBPRD,WPRD                                                       
         MVC   PBINVNO,INVNO                                                    
         MVC   PBGROSS,WORK        GROSS                                        
         L     R0,WORK                                                          
         S     R0,WORK+4                                                        
         ST    R0,FULL                                                          
         MVC   PBAGYCOM,FULL       GROSS-NET = AC                               
         MVC   PBCSHDSC,WORK+8     CD                                           
LDESC2HX CLI   MANRVDTP,0          TEST REVERSAL                                
         BE    *+8                                                              
         OI    PBBILST,X'40'       SET REVERSAL ELEM                            
*                                                                               
         CLI   SCBNCSW,C'C'        UFC COMM BILLING                             
         BNE   *+8                                                              
         OI    PBBILST,X'01'                                                    
*                                                                               
         CLI   SCBNCSW,C'N'        UFC NET BILLING                              
         BNE   *+8                                                              
         OI    PBBILST,X'02'                                                    
*                                                                               
         CLI   PROGPRO3+12,C'P'    PLANNED COST?                                
         BNE   *+8                                                              
         OI    PBBILST,X'04'                                                    
*                                                                               
         CLI   PROGPRO3+12,C'A'    ACTUALIZED?                                  
         BNE   *+8                                                              
         OI    PBBILST,X'08'                                                    
*                                                                               
*        PROBLEM WITH C'B' - BOTH                                               
*                                                                               
         CLI   BYTE,1              SEE IF ELEM ALREADY EXISTED                  
         BE    LDESC2I                                                          
         CLI   BYTE,2              SEE IF ELEM ALREADY EXISTED                  
         BE    LDESC2I                                                          
*                                                                               
         GOTO1 RECUP,DMCB,(1,PBUYREC),X,(R2)                                    
*                                                                               
*                                                                               
LDESC2I  CLI   BILLPASS,0       SEE IF DOING FIRST BILL ELEM PASS               
         BE    LDESC2I5                                                         
         B     LDESC2IX                                                         
*                                                                               
LDESC2I5 L     R0,DBTOTS           ADD TO OVERALL BILLED TOTALS                 
         A     R0,WORK             GROSS                                        
         ST    R0,DBTOTS                                                        
         L     R0,DBTOTS+4                                                      
         A     R0,WORK+4           NET                                          
         ST    R0,DBTOTS+4                                                      
         L     R0,DBTOTS+8                                                      
         A     R0,WORK+8           CD                                           
         ST    R0,DBTOTS+8                                                      
*                                                                               
LDESC2IX CLI   BILLPASS,1          SEE IF I ALREADY DID 2ND PASS                
         BE    LDESC2K                                                          
         CLI   FINANSW,0           SEE IF DOING FINANCIAL CLIENT                
         BE    LDESC2K                                                          
*                                                                               
         CLI   SCBNCSW,C'C'     SEE IF COMMISSION BILL                          
         BE    LDESC2K          THEN NO BILLPASS=1 EVEN IF FINANCIAL            
*                                                                               
***R***                                                                         
         CLC   QPROG,=C'R1'        NO OPEN ELEMS FOR REBATE BILL                
         BE    LDESC2K                                                          
         CLC   QPROG,=C'RD'    NO OPEN ELEMS FOR REBATE BILL - DRAFT            
         BE    LDESC2K                                                          
***R***                                                                         
         MVI   BILLPASS,1          SET TO DO OPEN ELEMS                         
         B     LDESC2D5                                                         
*                                                                               
LDESC2K  CLI   UPASS,1             RETAIL - CORP PASS                           
         BH    LDESC2X             NO - SKIP RE-WRITE OF BUYREC                 
*                                                                               
         CLI   TESTFLAG,C'T'       DONT WRITE IF TEST MODE                      
         BE    LDESC2KB                                                         
         CLI   RCWRITE,C'N'                                                     
         BE    LDESC2KB                                                         
         MVC   AREC,ADWKREC                                                     
         GOTO1 PUTPRT                                                           
LDESC2KB DS    0H                                                               
*                                                                               
         CLI   SORTTRCE,C'Y'       TEST TO DUMP RECORD                          
         BNE   LDESC2X                                                          
*                                                                               
         MVC   HALF,PBUYLEN                                                     
         LH    R5,HALF                                                          
         CH    R5,=H'858'                                                       
         BNH   *+8                                                              
         LH    R5,=H'858'                                                       
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   P1(19),=C'PRINTPAK BUY RECORD'                                   
         MVC   P1(L'PP@PBR),PP@PBR                                              
         DROP  RE                                                               
         GOTO1 HEXOUT,DMCB,KEY+27,P1+22,4,=C'N'                                 
         GOTO1 (RF),DMCB,PBUYREC,P2,(R5)                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
         DROP  R4                                                               
*                                                                               
LDESC2X  DS    0H                                                               
*                                                                               
LDESC4   DS    0H                                                               
         CLI   SPOTCTL,C'Y'                                                     
         BE    LDESC4A                                                          
         L     RF,ADESC                                                         
         CLI   0(RF),X'F9'                                                      
         BH    LDESC7B             MAY STILL NEED TO MARK MANUAL BILLS          
         B     LDESCX                                                           
*                                                                               
LDESC4A  L     RF,ADESC                                                         
         CLI   0(RF),X'FA'         SKIP PREV UNITS                              
         BNE   LDESC4B                                                          
         CLI   ZUOPT,C'C'          UNLESS COMBINING                             
         BE    LDESC4B                                                          
         CLI   ZUOPT,C'P'          OR COMBINING ACROSS PUBS                     
         BE    LDESC4B                                                          
         CLC   P1(20),SPACES        ELSE CLEAR PRINT ANY RESIDUE                
         BE    LDESCX                                                           
         GOTO1 =A(PRNT)                                                         
         B     LDESCX                                                           
*                                                                               
LDESC4B  DS    0H                                                               
         CLI   0(RF),X'FB'         SKIP CURRENT MANUAL                          
         BE    LDESCX                                                           
*                                                                               
         CLI   0(RF),X'FC'         DONT SET ON ACTIVITY SWS                     
         BE    LDESC4C             FOR PREVIOUS MANUAL                          
*                                                                               
         MVI   PUBACTSW,C'Y'      SET ON ACTIVITY SWITCHES                      
         MVI   JOBACTSW,C'Y'      SET ON ACTIVITY SWITCHES                      
*                                                                               
LDESC4C  DS    0H                                                               
         CLI   0(RF),X'F9'                                                      
         BH    LDESC7B                                                          
         L     RE,ASORTCOM                                                      
         OC    0(4,RE),0(RE)       CHK FOR DISK ADDR                            
         BZ    LDESC7B                                                          
***                                                                             
         OC    ARECAP,ARECAP       SEE IF DOING RECAP PASS                      
         BNZ   LDESC4D                                                          
         CLI   NOINSSW,C'Y'        SEE IF NOT SHOWING INS DETAIL                
         BE    LDESCX              ON MAIN BILL                                 
*                                  SEE IF I MUST PRINT PUB NOW                  
***                                                                             
LDESC4D  MVC   KEY+27(4),0(RE)                                                  
*                                                                               
         CLC   P1(20),SPACES                                                    
         BE    LDESC4E                                                          
         GOTO1 =A(PRNT)                                                         
LDESC4E  DS    0H                                                               
         CLI   PRTINSW,C'N'  SEE IF NOT PRINTING ZERO COST2 INS.                
         BE    LDESCX                                                           
         MVC   AREC,ADWKREC        USE WKREC NOT BUYREC                         
         GOTO1 GETPRT              READ BUY FOR DESC AND COMMENTS               
*                                                                               
         L     R7,ADWKREC                                                       
         USING PBUYREC,R7                                                       
LDESC4F  CLI   WRKMED,C'N'          NEED GETINS FOR NEWSPAPERS                  
         BE    LDESC4F5                                                         
****R***                                                                        
         CLC   QPROG,=C'R1'        FOR REBATE BILLING NEED GROSS                
         BE    LDESC4F5                                                         
         CLC   QPROG,=C'RD'  FOR REBATE BILLING DRAFT NEED GROSS                
         BNE   LDESC4G                                                          
LDESC4F5 XC    W(70),W             USE FOR PVALUES                              
         GOTO1 GETINS,DMCB,PBUYREC,W,PBUYKPRD                                   
*                                                                               
LDESC4G  L     R6,=A(PPBYOWRK)                                                  
         USING PPBYOUTD,R6                                                      
         MVC   PBYOINPT,ADWKREC                                                 
         MVC   PBYODTCN,DATCON                                                  
         LA    R0,W                                                             
         ST    R0,PBYOVALS                                                      
         MVI   PBYOCTL,X'28'                                                    
         L     RE,ADAGY                                                         
         CLI   PAGYPROF+1-PAGYREC(RE),C'L'    LINE NUMBER CONTROL               
         BE    *+8                                                              
         OI    PBYOCTL,X'02'       SUPPRESS LINE NUMBER                         
*                                                                               
         MVC   SVCTYP,PBDCTYP      SAVE REAL COST TYPE                          
         CLI   PROFB2B+11,C'Y'     SEE IF NEWSPAPER UNIT RATES                  
         BNE   LDESC4G0                                                         
         CLI   PBUYKMED,C'N'       SEE IF NEWSPAPERS                            
         BNE   LDESC4G0                                                         
         OI    PBYOCTL,X'01'       UNIT RATES AT NET                            
         MVI   PBDCTYP,C'N'        FOOL PPBYOUT                                 
*                                                                               
LDESC4G0 DS    0H                                                               
         GOTO1 PPBYOUT,DMCB,PPBYOUTD                                            
         MVC   PBDCTYP,SVCTYP       RESTORE REAL COST TYPE                      
         MVC   MYOUR,SPACES                                                     
         MVC   MYOUR(8),PBYOUR                                                  
         CLI   PROFB2B+11,C'Y'    SEE IF SHOWING UNIT RATES AT NEW              
         BNE   LD20                                                             
         CLC   PBYOUR,SPACES                                                    
         BE    LD20                                                             
         MVC   MYOUR+1(8),PBYOUR                                                
         MVI   MYOUR,C' '                                                       
         LA    R1,MYOUR+5        DOESN'T LOOK RIGHT BUT IS                      
*                                SINCE UNIT RATES WILL ALWAYS                   
*                                NOT HAVE A SPACE HERE                          
LD15     CLI   0(R1),C' '                                                       
         BNH   LD18                                                             
         BCT   R1,LD15                                                          
*                                                                               
LD18     MVI   0(R1),C'N'         FLOAT "N" BEFORE RATE                         
LD20     DS    0H                                                               
**                                                                              
*                                                                               
         L     R2,ACTYP           POINT TO SPECIAL CHG IN SORTREC               
         OC    0(2,R2),0(R2)      DO WE HAVE A SPECIAL CHARGE ?                 
         BZ    LD30                                                             
*                                                                               
         L     RE,ASORTCOM                                                      
         CLC   SVDA,0(RE)          SEE IF SAME INSERTION (D/A)                  
         BE    LD23                                                             
         MVC   SVDA,0(RE)          SAVE DA FOR NEXT PASS                        
         MVI   PRSW,C'F'           NEED TO FLUSH PUB                            
         GOTO1 =A(PRNT)                                                         
         MVC   P1(11),PBYOMDY                                                   
         MVI   PRSW,C'M'           NEED TO MERGE NOT FLUSH                      
         GOTO1 =A(PRNT)                                                         
*                                                                               
LD23     GOTO1 =V(PPGETCG),DMCB,PBUYREC,DATAMGR                                 
         CLI   0(R1),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         ZIC   R0,0(R1)            GET NUMBER OF LINES (SPEC. CHGS)             
         L     R4,0(R1)            GET ADDRESS OF OUTPUT BLOCK                  
         USING ADDCHGD,R4                                                       
LD25     CLC   ADCCOD1,0(R2)       FIND THE RIGHT CHARGE                        
         BE    *+14                                                             
         LA    R4,ADCLNLEN(R4)     BUMP TO NEXT ROW                             
         BCT   R0,LD25                                                          
         DC    H'0'                CHARGE HAS TO BE THERE !                     
         MVC   P1+2(L'ADCCOD1+1+L'ADCDES1),0(R4)                                
*                                                                               
         CLC   0(2,R2),=C'FX' AM I DOING FOREIGN EXCHANGE?                      
         BNE   LD25A                                                            
         CLI   RCLANG,4       AM I DOING FRENCH?                                
         BNE   *+10                                                             
         MVC   P1+2+L'ADCCOD1+1(21),=C'* DEUSES ETRANGERES *'                   
*                                                                               
LD25A    DS    0H                                                               
**EDI**                                                                         
         MVC   X(10),SPACES      NO REFERENCE # FOR THESE                       
         GOTO1 ABILLEDI,DMCB,('EDMINS',0(R4))   CHARGE CALL                     
**EDI**                                                                         
*                                                                               
         CLC   0(2,R2),=C'FX'     AM I DOING FOREIGN EXCHANGE?                  
         BNE   LD25X                                                            
*                                                                               
**FXROPT                                                                        
         CLI   FXROPT,C'Y'        SEE IF SUPPRESSING FX RATE                    
         BE    LD25CR                                                           
**FXROPT                                                                        
         LA    R2,PBUYREC+33     LOOK FOR SPECIAL CUSTOM COLUMN ELEM            
         MVI   ELCODE,X'CC'                                                     
LD25C    BRAS  RE,NEXTEL                                                        
         BNE   LD25X                JUST EXIT IF NOT FOUND                      
         CLC   2(2,R2),=H'8207'     SPECIAL FOR FX                              
         BNE   LD25C                KEEP LOOKING                                
         USING BYCCELD,R2                                                       
         MVC   P2+2(05),=C'RATE='                                               
*                                                                               
         CLI   RCLANG,4          AM I DOING FRENCH?                             
         BNE   *+10                                                             
         MVC   P2+2(05),=C'TAUX='                                               
*                                                                               
         MVI   CURTAB+3,5        5 DECIMALS                                     
         CURED (P8,BYCCDATA),(20,P2+8),CURTAB,ALIGN=LEFT,FLOAT=-                
         MVI   CURTAB+3,2        RESET TO 2                                     
         DROP  R2                                                               
         B     LD25X                                                            
*                                                                               
*     IF SUPRESSING RATE,SHORTEN INFO IN P1                                     
*                                                                               
LD25CR   MVC   P1(23),P1+2+L'ADCCOD1+1                                          
         MVC   P1+23(5),SPACES                                                  
*                                                                               
LD25X    DS    0H                                                               
         GOTO1 =A(PRNT)                                                         
         B     LDESC8                                                           
         DROP  R4                                                               
*                                                                               
*                                                                               
LD30     L     RE,ASORTCOM                                                      
         MVC   SVDA,0(RE)          SAVE DA FOR NEXT PASS                        
         MVC   P1(11),PBYOMDY                                                   
*                                                                               
         CLC   QAGENCY,=C'MC'      ONLY FOR MCCANN (FOR NOW)                    
         BE    LD30C                                                            
         CLC   QAGENCY,=C'SJ'      OR SJR (FOR TESTING)                         
         BNE   LD30D                                                            
LD30C    CLI   PBDCOSIN,C'S'       S-RATE?                                      
         BNE   LD30D                                                            
         MVI   P1,C'*'                                                          
         MVC   P1+1(11),PBYOMDY                                                 
*                                                                               
LD30D    DS    0H                                                               
         MVC   P2+1(8),PBYOMDY2                                                 
         CLC   PBYOISNM,SPACES     IS ISSUE NAME PRESENT?                       
         BE    LDEC4G2                                                          
         MVC   P2+0(11),PBYOISNM     +0 SINCE SOMETHING MIGHT                   
*                                     BE PRINTING IN +12                        
         B     LDEC4G2                                                          
*                                                                               
*********   SPECIAL FOR DOREMUS TRADE (PRODUCTION CHARGES)                      
*********   SUPPRESS INSERTION DATE                                             
*********                                                                       
******** CLC   QAGENCY,=C'DM'                                                   
******** BNE   LDEC4G2                                                          
******** CLI   WRKMED,C'T'                                                      
*******  BNE   LDEC4G2                                                          
*******                                                                         
*******  MVC   P1(11),SPACES                                                    
*******  MVC   P2+1(8),SPACES                                                   
*                                                                               
LDEC4G2  DS    0H                                                               
         CLI   ORDSW,C'Y'          SEE IF SHOWING ORDERED                       
         BE    LDESC4G8            YES THEN USE OLD SPACE DISPLAY               
         CLI   TWOCOL,C'Y'         OR IF I HAVE 2 COLUMNS                       
         BE    LDESC4G8                                                         
*                                                                               
         CLI   ORDSW+1,C'Y'        SEE IF SHOWING PREV BILLING                  
         BNE   LDESC4G8            NO THEN CAN STILL USE OLD                    
         CLI   WRKMED,C'N'                                                      
         BNE   LDESC4G8                                                         
         LA    R1,P1+12                                                         
         CLI   P1+11,C' '      ANYTHING THERE?                                  
         BNH   *+8             (MAY HAPPEN FOR MCCANN)                          
         LA    R1,P1+13        IF SO USE P1+13                                  
         MVC   0(11,R1),PBYOSPC                                                 
         CLI   PBYOSPC,C' '                                                     
         BH    *+10                                                             
         MVC   0(7,R1),PBYOUNTS                                                 
         CLI   FINANSW,1            IF FINANCIAL CLIENT                         
         BNE   LDESC4G4             DISPLAY OPEN RATE                           
*                                  NOTE - ONLY "OLD" STYLE FINANCIAL            
*                                  BILLING DISPLAYS OPEN RATES                  
*                                  THE CLI ABOVE IS CORRECT                     
         LA    R2,PBUYREC+33                                                    
         MVI   ELCODE,X'30'                                                     
         BRAS  RE,NEXTEL                                                        
         BE    *+6                                                              
         DC    H'0'                 MUST HAVE OPEN RATE ELEM                    
         USING PORELED,R2                                                       
         CLC   QPROG,=C'R1'        ON REBATE BILL SHOW BOTH                     
         BE    LDESC4G1            OPEN AND CONTRACT                            
         CLC   QPROG,=C'RD'        ON REBATE BILL DRAFT SHOW BOTH               
         BE    LDESC4G1            OPEN AND CONTRACT                            
*                                                                               
         CLI   WIOPT,C'Y'           WESTERN COST SUPPRESSION                    
         BE    LDESC4G4                                                         
*                                                                               
         CLI   PORCOSTY,C'U'        SEE IF UNIT RATE GIVEN                      
         BNE   LDESC4G5                                                         
         EDIT  (P5,PORCOS),(9,P2+12),5,ALIGN=LEFT,DROP=3                        
         B     LDESC4G5                                                         
***R***                                                                         
LDESC4G1 DS    0H                                                               
         L     R4,=A(DICSECT)                                                   
         USING DICSECT,R4                                                       
         CLI   PORCOSTY,C'U'        SEE IF UNIT RATE GIVEN                      
         BNE   LDEC4G3B                                                         
*--->    MVC   P2+12(3),=C'OR='                                                 
         MVC   P2+12(L'PP@OR),PP@OR                                             
         EDIT  (P5,PORCOS),(9,P2+15),5,ALIGN=LEFT,DROP=3                        
*                                                                               
         LA    R5,P2+15                                                         
         AR    R5,R0                                                            
LDESC4G2 CLI   0(R5),C' '                                                       
         BNE   LDESC4G3                                                         
         BCTR  R5,0                                                             
         B     LDESC4G2                                                         
LDESC4G3 DS    0H                                                               
*--->    MVC   1(4,R5),=C'/CR='                                                 
         MVC   1(L'PP@CR,R5),PP@CR                                              
         MVC   5(9,R5),MYOUR       CONTRACT RATE                                
         B     LDESC4G5                                                         
*                                                                               
LDEC4G3B DS    0H                                                               
*--->    MVC   P2+12(3),=C'OC='                                                 
         MVC   P2+12(L'PP@OC),PP@OC                                             
*--->    EDIT  (P5,PORCOS),(14,P2+15),2,ALIGN=LEFT,COMMAS=YES,MINUS=YES         
         CURED (P5,PORCOS),(14,P2+15),CURTAB,ALIGN=LEFT,COMMAS=YES,    X        
               FLOAT=-                                                          
*                                                                               
         DROP  R2                                                               
         LA    R5,P2+15                                                         
         AR    R5,R0                                                            
LDEC4G3C CLI   0(R5),C' '                                                       
         BNE   LDEC4G3D                                                         
         BCTR  R5,0                                                             
         B     LDEC4G3C                                                         
LDEC4G3D DS    0H                                                               
*--->    MVC   1(4,R5),=C'/CC='                                                 
         MVC   1(L'PP@CC,R5),PP@CC                                              
         DROP  R4                                                               
*--->    EDIT  (B4,W),(14,5(R5)),2,ALIGN=LEFT,COMMAS=YES,MINUS=YES              
         CURED (B4,W),(14,5(R5)),CURTAB,ALIGN=LEFT,COMMAS=YES,FLOAT=-           
         B     LDESC4G5                                                         
***R***                                                                         
*                                                                               
LDESC4G4 DS    0H                                                               
         CLI   WIOPT,C'Y'      CHECK FOR WESTERN OPTION                         
         BE    LDESC4G5        NO UNIT RATES                                    
*                                                                               
         MVC   P2+12(9),MYOUR       UNIT RATE                                   
*                                                                               
LDESC4G5 LA    R5,P2+12                                                         
         CLI   P2+12,C' '                                                       
         BE    *+8                                                              
         LA    R5,P3+12                                                         
         MVC   0(17,R5),PBYOSPC2                                                
         LA    R5,P2+12                                                         
         CLI   P2+12,C' '                                                       
         BE    LDESC4G6                                                         
         LA    R5,P3+12                                                         
         CLI   0(R5),C' '                                                       
         BE    LDESC4G6                                                         
         LA    R5,P4+12                                                         
*                                                                               
LDESC4G6 CLI   PBYOPRM,C' '                                                     
         BNH   LDESC41                                                          
*                                                                               
         CLC   QPROG,=C'R1'      SHOW ON REBATE                                 
         BE    LDESC4G7                                                         
         CLC   QPROG,=C'RD'      SHOW ON REBATE- DRAFT                          
         BE    LDESC4G7                                                         
         CLI   WIOPT,C'Y'       CHECK WESTERN OPTION                            
         BNE   LDESC4G7         NO UNIT RATES OR PREMIUMS                       
*                                                                               
         CLI   PBYOPRM+1,C'C'        CHECK FOR A COLOR                          
         BNE   LDESC41              NO - DISPLAY NOTHING                        
         MVC   0(2,R5),PBYOPRM      YES - ONLY DISPLAY NC                       
         B     LDESC41                                                          
*                                                                               
LDESC4G7 MVC   0(11,R5),PBYOPRM     PREMIUM                                     
         B     LDESC41                                                          
*                                                                               
LDESC4G8 DS    0H                                                               
         LA    R1,P1+12                                                         
         CLI   P1+11,C' '       ANYTHING THERE?                                 
         BNH   *+8              (MAY HAPPEN ITH MCCANN)                         
         LA    R1,P1+13         IF SO, USE P1+13                                
         MVC   0(20,R1),PBYOSPC                                                 
         MVC   132(17,R1),PBYOSPC2                                              
*                                                                               
*        CLI   SHOWRATE,C'Y'                                                    
*        BNE   LDESC4GG                                                         
         TM    FLAG1,SHOWRATE                                                   
         BZ    LDESC4GG                                                         
         CLI   PBDCOSIN,C'C'       FOR 'C' RATE BUY                             
         BNE   LDESC4GG                                                         
         CLI   132(R1),C' '        PRINT BUY RATE                               
         BH    LDESC4GG            NO SPACE                                     
         ZAP   DUB,PBDCOS                                                       
         CLI   PBDCTYP,C'N'        DISPLAY AS NET?                              
         BNE   LDESC48G                                                         
*                                                                               
         ST    R1,FULL2                                                         
         CVB   R1,DUB                                                           
         ZAP   DUB,PBDACP                                                       
         CVB   RF,DUB                                                           
         S     RF,=F'100000'                                                    
         LCR   RF,RF                                                            
         MR    R0,RF                                                            
         L     RF,=F'100000'                                                    
         SLDA  R0,1                                                             
         DR    R0,RF                                                            
         LTR   R1,R1                                                            
         BNP   *+8                                                              
         A     R1,=F'1'                                                         
         SRA   R1,1                                                             
         CVD   R1,DUB                                                           
         L     R1,FULL2                                                         
*                                                                               
LDESC48G MVC   132(5,R1),=C'RATE='                                              
         EDIT  (P8,DUB),(12,137(R1)),2,COMMAS=YES,CR=YES                        
*                                                                               
LDESC4GG CLI   PBYOSPC,C' '        IF NO SPACE - USE PBYOUNTS                   
         BH    *+10                                                             
         MVC   0(7,R1),PBYOUNTS                                                 
         CLI   FINANSW,1            SEE IF FINANCIAL CLIENT                     
         BNE   LDESC40                                                          
*                                  NOTE - ONLY "OLD" STYLE FINANCIAL            
*                                  BILLING DISPLAYS OPEN RATES                  
*                                  THE CLI ABOVE IS CORRECT                     
         LA    R2,PBUYREC+33                                                    
         MVI   ELCODE,X'30'                                                     
         BRAS  RE,NEXTEL                                                        
         BE    *+6                                                              
         DC    H'0'                 MUST HAVE OPEN RATE ELEM                    
         USING PORELED,R2                                                       
*                                                                               
         CLC   QPROG,=C'R1'        ON REBATE BILL SHOW BOTH                     
         BE    LDESC4GK            OPEN AND CONTRACT RATES                      
         CLC   QPROG,=C'RD'        ON REBATE BILL DRAFT SHOW BOTH               
         BE    LDESC4GK            OPEN AND CONTRACT RATES                      
*                                                                               
         CLI   WIOPT,C'Y'      WESTERN OPTION                                   
         BE    LDESC40         NO COST OR PREMIUM (UNLESS REBATE)               
*                                                                               
         CLI   PORCOSTY,C'U'        SEE IF UNIT RATE GIVEN                      
         BNE   LDESC40B                                                         
         EDIT  (P5,PORCOS),(9,P1+21),5,ALIGN=LEFT,DROP=3                        
         B     LDESC40B                                                         
***R***                                                                         
LDESC4GK DS    0H                                                               
         L     R4,=A(DICSECT)                                                   
         USING DICSECT,R4                                                       
         CLI   PORCOSTY,C'U'        SEE IF UNIT RATE GIVEN                      
         BNE   LDESC4GH                                                         
*--->    MVC   P1+21(3),=C'OR='                                                 
         MVC   P1+21(L'PP@OR),PP@OR                                             
         EDIT  (P5,PORCOS),(9,P1+24),5,ALIGN=LEFT,DROP=3                        
         LA    R5,P1+24                                                         
         AR    R5,R0                                                            
LDESC4G9 CLI   0(R5),C' '                                                       
         BNE   LDESC4GA                                                         
         BCTR  R5,0                                                             
         B     LDESC4G9                                                         
LDESC4GA DS    0H                                                               
*--->    MVC   1(4,R5),=C'/CR='                                                 
         MVC   1(L'PP@CR,R5),PP@CR                                              
         MVC   5(9,R5),MYOUR       CONTRACT RATE                                
         B     LDESC40B                                                         
*                                                                               
LDESC4GH DS    0H                                                               
*--->    MVC   P1+21(3),=C'OC='                                                 
         MVC   P1+21(L'PP@OC),PP@OC                                             
*--->    EDIT  (P5,PORCOS),(14,P1+24),2,ALIGN=LEFT,COMMAS=YES                   
         CURED (P5,PORCOS),(14,P1+24),CURTAB,ALIGN=LEFT,COMMAS=YES              
         DROP  R2                                                               
         LA    R5,P1+24                                                         
         AR    R5,R0                                                            
LDESC4GI CLI   0(R5),C' '                                                       
         BNE   LDESC4GJ                                                         
         BCTR  R5,0                                                             
         B     LDESC4GI                                                         
LDESC4GJ DS    0H                                                               
*--->    MVC   1(4,R5),=C'/CC='                                                 
         MVC   1(L'PP@CC,R5),PP@CC                                              
*--->    EDIT  (B4,W),(14,5(R5)),2,ALIGN=LEFT,COMMAS=YES,MINUS=YES              
         CURED (B4,W),(14,5(R5)),CURTAB,ALIGN=LEFT,COMMAS=YES,FLOAT=-           
         B     LDESC40B                                                         
         DROP  R4                                                               
***R***                                                                         
*                                                                               
*                                                                               
LDESC40  DS    0H                                                               
*                                                                               
         CLI   WIOPT,C'Y'          WESTERN OPTION                               
         BNE   LDESC40A            NO COST OR PREMIUM $                         
*                                                                               
         CLI   PBYOPRM+1,C'C'        CHECK FOR A COLOR                          
         BNE   LDESC41              NO - DISPLAY NOTHING                        
         MVC   P1+21(2),PBYOPRM     YES - ONLY DISPLAY NC                       
         B     LDESC41                                                          
*                                                                               
*                                                                               
LDESC40A CLC   MYOUR,SPACES       CHK FOR RATE                                  
         BNH   *+10                                                             
         MVC   P1+21(9),MYOUR      ALSO SHOW RATE                               
LDESC40B CLI   PBYOPRM,C' '        CHK FOR PREMIUM                              
         BNH   *+10                                                             
         MVC   P2+12(11),PBYOPRM   AND PREMIUM                                  
*                                                                               
LDESC41  CLI   PBYOMDY2,C' '   OK SINCE PBYOMDY2 AND PBYOISNM                   
         BE    *+8             SHOULDN'T BOTH BE PRESENT                        
         MVI   P2,C'-'                                                          
*****    CLI   WRKMED,C'N'    NO-OPED SINCE ON-SALE DATES                       
*****    BE    LDESC43        MAY NOW EXIST FOR NEWSPAPERS                      
         OC    PBDSDATE,PBDSDATE                                                
         BZ    LDESC43                                                          
         CLI   OSDOPT,C'Y'         SEE IF SHOWING ON-SALE DATE                  
         BNE   LDESC43                                                          
         LA    R5,P2                                                            
         CLC   P2(20),SPACES        SEE IF P2 USED                              
         BE    *+8                                                              
         LA    R5,P3                                                            
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   0(12,R5),=C'ON-SALE DTE='                                        
         MVC   0(L'PP@OSDAT,R5),PP@OSDAT                                        
         DROP  RE                                                               
         GOTO1 DATCON,DMCB,(3,PBDSDATE),(5,12(R5))                              
*                                                                               
LDESC43  OC    PBDJOB,PBDJOB                                                    
         BZ    FB19                                                             
**WB**                                                                          
         CLI   WBSW,C'Y'         WB FLIGHT FEATURE?                             
         BE    FB18B                                                            
**WB**                                                                          
         CLI   JOBCTL,C'N'                                                      
         BE    FB18B                                                            
         CLI   JOBCTL,0                                                         
         BE    FB18B                                                            
         B     FB19                JOB INFO DONE AT FJOB                        
*                                                                               
FB18B    CLI   JOBOPT,C'N'    NO AD INFOR                                       
         BE    FB19                                                             
**PPNEW  L     RF,PPFILEC                                                       
**PPNEW  LA    R5,4095(RF)                                                      
**PPNEW  LA    R5,1(R5)                                                         
**PPNEW  USING PPFILED+4096,R5     NEEDED FOR PJOBREC                           
*                                                                               
         L     R5,PPFILEC         **PPNEW                                       
         USING PPFILED,R5         **PPNEW                                       
*                                                                               
*                                                                               
         L     R4,=A(DICSECT)      ** NOTE USE OF R4 TO COVER DICSECT           
         USING DICSECT,R4                                                       
*                                                                               
*****    CLI   JOBOPT,C'A'                                                      
*****    BE    FB18D               AD NO ONLY - STILL MUST READ JOB             
*                                  AS I NEED TO DISPLAY AD ID                   
         XC    WORK(25),WORK                                                    
         MVC   WORK(10),PBUYKEY                                                 
         MVI   WORK+3,X'15'                                                     
         MVC   WORK+10(6),PBDJOB                                                
         CLC   PJOBREC(25),WORK                                                 
         BE    FB18CX                                                           
         MVC   LSAVKEY,KEY                                                      
         MVC   KEY(25),WORK                                                     
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         GOTO1 GETJOB                                                           
*                                                                               
         MVC   KEY,LSAVKEY                                                      
         GOTO1 HIGH                                                             
*                                                                               
FB18CX   DS    0H                                                               
*                                                                               
         TM    JOBOPT,X'30'                                                     
         BZ    FB18D                                                            
*                                       COPY NO.                                
         LA    R2,P2                                                            
         BAS   RE,FNEXTP                FIND FIRST AVAILABLE PLINE              
         CLI   TWOCOL,C'Y'                                                      
         BE    FB18CX9                                                          
         MVC   WORK(26),SPACES                                                  
*--->    MVC   WORK(5),=C'COPY='                                                
         MVC   WORK(L'PP5COPY),PP5COPY                                          
         MVC   WORK+5(17),PJOBCPY                                               
         BAS   RE,GETANNO   GET NO.OF LINES WITH ANNO RETURN IN FULL            
         L     R0,FULL                                                          
         LA    R1,P1                                                            
         SH    R1,=H'132'                                                       
FB18C6   LA    R1,132(R1)                                                       
         BCT   R0,FB18C6                                                        
         CR    R2,R1                                                            
         BH    FB18CX9          NO ANNO IN THIS LINE - USE NORMAL               
         LA    R6,19            MUST CHOP FOR LINES THAT HAVE ANNO              
*                                                                               
FB18C7   GOTO1 =V(CHOPPER),DMCB,(25,WORK),((R6),4(R2)),(C'P',2)                 
         LA    R2,132(R2)                                                       
         CLI   4(R2),C' '     SEE IF I USED 2 LINES                             
         BNH   *+8                                                              
         LA    R2,132(R2)                                                       
         B     FB18F                                                            
*                                                                               
FB18CX9  LA    R2,4(R2)                                                         
*--->    MVC   0(5,R2),=C'COPY='                                                
         MVC   0(L'PP5COPY,R2),PP5COPY                                          
         MVC   5(17,R2),PJOBCPY                                                 
         B     FB18F                                                            
*                                       AD. NO.                                 
FB18D    DS    0H                                                               
         LA    R2,P2                                                            
         BAS   RE,FNEXTP                FIND FIRST AVAILABLE PLINE              
FB18D5   LA    R2,4(R2)                                                         
*--->    MVC   0(7,R2),=C'AD NO.='                                              
         MVC   0(L'PP@ADNO,R2),PP@ADNO                                          
         MVC   8(6,R2),PBDJOB                                                   
         CLC   PJOBADID,SPACES        AD ID PRESENT?                            
         BNH   FB18F                                                            
         MVC   132(7,R2),=C'AD ID= '                                            
         MVC   132+7(ADIDLQ,R2),PJOBADID                                        
*                                                                               
FB18F    DS    0H                                                               
         DROP  R4                                                               
*                                                                               
         TM    JOBOPT,X'02'                                                     
         BZ    FB19                                                             
         LA    R2,P2                                                            
         BAS   RE,FNEXTP                FIND FIRST AVAILABLE PLINE              
*                                  CAPTION                                      
FB18F5   DS    0H                                                               
         CLI   TWOCOL,C'Y'          SEE IF I HAVE 2 COLUMNS                     
         BE    FB18F8                                                           
         BAS   RE,GETANNO   GET NO.OF LINES WITH ANNO RETURN IN FULL            
         L     R0,FULL                                                          
         LA    R1,P1                                                            
         SH    R1,=H'132'                                                       
FB18F6   LA    R1,132(R1)                                                       
         BCT   R0,FB18F6                                                        
         CR    R2,R1                                                            
         BH    FB18F8                                                           
         LA    R6,19                  USE DIFFERENT CHOP FOR                    
*                                     LINES THAT HAVE TYPE ANNO                 
FB18F7   GOTO1 =V(CHOPPER),DMCB,(25,PJOBCAP1),((R6),4(R2)),(C'P',2)             
         LA    R2,132(R2)                                                       
         CLI   4(R2),C' '     SEE IF I USED 2 LINES                             
         BNH   *+8                                                              
         LA    R2,132(R2)                                                       
         BAS   RE,GETANNO   GET NO.OF LINES WITH ANNO RETURN IN FULL            
         L     R0,FULL                                                          
         LA    R1,P1                                                            
         SH    R1,=H'132'                                                       
FB18F7D  LA    R1,132(R1)                                                       
         BCT   R0,FB18F7D                                                       
         CR    R2,R1                                                            
         BH    FB18F9                                                           
         LA    R6,19                  USE DIFFERENT CHOP FOR                    
*                                     LINES THAT HAVE TYPE ANNO                 
FB18F7F  GOTO1 =V(CHOPPER),DMCB,(25,PJOBCAP2),((R6),4(R2)),(C'P',2)             
         LA    R2,132(R2)                                                       
         CLI   4(R2),C' '     SEE IF I USED 2 LINES                             
         BNH   *+8                                                              
         LA    R2,132(R2)                                                       
         B     FB19                                                             
*                                                                               
FB18F8   LA    R2,4(R2)                                                         
         MVC   0(25,R2),PJOBCAP1                                                
         MVC   132(25,R2),PJOBCAP2                                              
         B     FB19                                                             
*                                                                               
FB18F9   LA    R2,4(R2)                                                         
         MVC   0(25,R2),PJOBCAP2                                                
         DROP  R5                                                               
*                                                                               
FB19     DS    0H                                                               
         MVC   X(10),SPACES                                                     
         LA    R2,PBUYREC+33                                                    
         MVI   ELCODE,X'83'       SEARCH FOR REFERENCE NUMBER ELEM              
         BRAS  RE,NEXTEL                                                        
         BNE   FB19D                                                            
         ST    R2,FULL                                                          
         LA    R2,P2              FIND FIRST AVAILABLE PLINE                    
         BAS   RE,FNEXTP                                                        
         MVC   4(5,R2),=C'REF#='                                                
         L     RE,FULL            ADDRESS OF REF NUMBER ELEMENT                 
         MVC   9(10,R2),2(RE)                                                   
         MVC   X(10),2(RE)      ALSO SAVE IN X FOR EDI                          
*                                                                               
         DROP  R7                                                               
*                                                                               
FB19D    DS    0H                                                               
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMINS',0)    EDI CALL                           
**EDI**                                                                         
         LA    R2,P2                                                            
         BAS   RE,FNEXTP         FIND NEXT AVAILABLE PLINE                      
         BRAS  RE,CCOLRTN                                                       
*                                                                               
         L     R6,=A(PPBYOWRK)     MUST RESET R6 TO COVER PPBYOUT WRK           
         LA    R4,PBYOCOMS                                                      
         LA    R5,5                                                             
         LA    R2,P2                                                            
         BAS   RE,FNEXTP         FIND NEXT AVAILABLE PLINE                      
LDESC4I  CLC   0(47,R4),SPACES                                                  
         BE    LDESC4J                                                          
         CLI   JOBOPT,C'2'                                                      
         BE    LDESC4I2                                                         
         CLI   JOBOPT,C'1'                                                      
         BE    SKIPCAP                                                          
         CLC   =C'COPY=',0(R4)   BUY COMMENT THAT OVERRIDES JOBREC              
         BE    LDESC4J                                                          
         CLI   JOBOPT,C'B'                                                      
         BE    LDESC4I2                                                         
SKIPCAP  CLC   =C'CAP=',0(R4)   BUY COMMENT THAT OVERRIDES JOBREC               
         BE    LDESC4J                                                          
LDESC4I2 CLI   AGMSCOM,C'N'    SEE IF NOT PRINTING CERTAIN COMMENTS             
         BE    LDESC4I3                                                         
         CLC   0(1,R4),AGMSCOM    IF MATCHES FIRST CHARACTER - SKIP             
         BE    LDESC4J                                                          
LDESC4I3 LA    R6,47                                                            
         LA    R1,P14                                                           
         CR    R2,R1                                                            
         BNL   LDESC4JX             MUST STOP - CAN'T FIT IN PLINES             
*                                                                               
         CLI   TWOCOL,C'Y'                                                      
         BE    LDESC4I8                                                         
         LA    R1,P1                                                            
         SH    R1,=H'132'                                                       
         BAS   RE,GETANNO     RETURNS NO. OF LINES WITH ANNO IN FULL            
         L     R0,FULL                                                          
LDESC4I6 LA    R1,132(R1)                                                       
         BCT   R0,LDESC4I6                                                      
         CR    R2,R1                                                            
         BH    LDESC4I8                                                         
         LA    R6,19                  USE DIFFERENT CHOP FOR                    
*                                     LINES THAT HAVE TYPE ANNO                 
LDESC4I8 GOTO1 =V(CHOPPER),DMCB,(47,0(R4)),((R6),4(R2)),(C'P',3)                
         LA    R2,132(R2)                                                       
         CLI   4(R2),C' '     SEE IF I USED 2 LINES                             
         BNH   *+8                                                              
         LA    R2,132(R2)                                                       
         CLI   4(R2),C' '     SEE IF I USED 3 LINES                             
         BNH   *+8                                                              
         LA    R2,132(R2)                                                       
*                                                                               
LDESC4J  LA    R4,47(R4)                                                        
         BCT   R5,LDESC4I                                                       
*                                                                               
*        CALL TO CCOLRTN WAS HERE TO PRINT AFTER REGULAR COMMENTS               
*                                                                               
LDESC4JX L     R5,ADESC                                                         
         B     LDESC8                                                           
*                                                                               
LDESC7B  DS    0H                                                               
         LA    R7,P1+0                                                          
         CLI   0(RF),X'FA'                                                      
         BNE   LDESC7C                                                          
         CLI   SPOTCTL,C'Y'        SEE IF SHOWING DETAIL                        
         BNE   LDESCX                                                           
         CLC   P1(20),SPACES       SINCE I MAY NOT HAVE PRINTED PUB             
         BE    LDESC7B5                                                         
         GOTO1 =A(PRNT)                                                         
LDESC7B5 DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   1(10,R7),=C'PREVIOUSLY'                                          
         MVC   1(L'PP@PREV,R7),PP@PREV                                          
*--->    MVC   132+1(17,R7),=C'BILLED INSERTIONS'                               
         MVC   132+1(L'PP@BLDIN,R7),PP@BLDIN                                    
*                                                                               
*        SEE IF DOING ADDITIONAL CHARGES ON A SEPARATE INVOICE                  
*        IF THIS IS ONE, CHANGE TO "BILLED CHARGES"                             
*                                                                               
         CLI   PROGPRO2+13,C'B'  ADDITIONAL CHARGES ON SEPARATE INVS?           
         BE    LDESC7B6          (BOTH OPTION)                                  
         CLI   PROGPRO2+13,C'C'  ADDITIONAL CHARGES ON SEPARATE INVS?           
         BNE   LDESC7B7                                                         
LDESC7B6 DS    0H                                                               
         L     R1,ACTYP           POINT TO SPECIAL CHG IN SORTREC               
         OC    0(2,R1),0(R1)      DO WE HAVE A SPECIAL CHARGE ?                 
         BZ    LDESC7B7                                                         
         L     R1,ACRDB                                                         
         CLI   0(R1),C'D'        WILL BE D FOR ADDTIONAL CHARGE                 
         BNE   LDESC7B7                                                         
         MVC   132+8(10,R7),=CL10'CHARGES'                                      
         CLI   RCLANG,4            SEE IF FRENCH                                
         BNE   LDESC7W                                                          
         MVC   132+1(L'PP@BLDIN,R7),SPACES                                      
         MVC   132+1(14,R7),=C'CHARGES FACTUR'                                  
         B     LDESC7W                                                          
*                                                                               
LDESC7B7 DS    0H                                                               
         CLI   WRKMED,C'O'                                                      
         BNE   LDESC7W                                                          
         MVC   132+8(10,R7),=CL10'POSTINGS'                                     
*--->    MVC   132+8(10,R7),=CL10'POSTINGS'                                     
*****    MVC   132+8(L'PP@POST,R7),PP@POST                                      
         CLI   RCLANG,4            SEE IF FRENCH                                
         BNE   LDESC7W             MUST REDO WHOLE SECOND LINE                  
         MVC   132+1(L'PP@BLDIN,R7),SPACES     CLEAR                            
         MVC   132+1(L'PP@POST,R7),PP@POST                                      
         MVC   132+1+L'PP@POST(8,R7),=C'S FACTUR'                               
*                      MAKES AFFCHGE (POSTING) PLURAL                           
         DROP  RE                                                               
         B     LDESC7W                                                          
*                                                                               
LDESC7C  DS    0H                                                               
         CLI   0(RF),X'FB'         CURRENT MANUAL                               
         BE    LDESCX                                                           
*                                                                               
LDESC7D  DS    0H                                                               
         CLI   0(RF),X'FC'                                                      
         BNE   LDESC7W                                                          
         CLI   SPOTCTL,C'Y'         SEE IF SHOWING DETAIL                       
         BNE   LDESC7D8                                                         
         CLC   P1(20),SPACES       SINCE I MAY NOT HAVE PRINTED PUB             
         BE    LDESC7D5                                                         
         GOTO1 =A(PRNT)                                                         
         L     RF,ADESC            MUST RESET RF                                
LDESC7D5 DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   1(14,R7),=C'PREV. ONE-LINE'                                      
*--->    MVC   132+1(4,R7),=C'BILL'                                             
         MVC   1(L'PP@PRV01,R7),PP@PRV01                                        
         MVC   132+1(L'PP@BILL,R7),PP@BILL                                      
         DROP  RE                                                               
         MVC   W(2),1(RF)        YEAR/MONTH                                     
         MVC   HALF,3(RF)          INVOICE NUMBER                               
*                                                                               
         MVC   SVSVIMO,SVINVMO     SAVE 'REAL' INV MTH                          
*                                                                               
         GOTOR GETNUM,DMCB,(1,HALF),132+6(R7)                                   
*                                                                               
         MVC   SVINVMO,SVSVIMO     RESTORE 'REAL' INV MTH                       
*                                                                               
         MVI   264+1(R7),0                                                      
*                                                                               
LDESC7D8 CLI   PASSNO,1            ONLY MARK MANUAL BILL ON PASS 1              
         BNE   LDESC7H                                                          
*                                                                               
         L     R6,ASORTCOM         DISK ADDR IN COMMENT                         
         OC    0(4,R6),0(R6)                                                    
         BZ    LDESC7W             DISK ADDR SHOULD BE THERE                    
         MVC   KEY+27(4),0(R6)                                                  
         MVC   AREC,ADWKREC                                                     
         GOTO1 GETPRT                                                           
***            REREAD PREV MANUAL BILL AND MARK IT                              
         L     R7,ADWKREC                                                       
         USING PBILLREC,R7                                                      
         OC    MANRVNO,MANRVNO          SEE IF DOING REVERSAL                   
         BZ    LDESC7D9                                                         
         MVC   PBILMCAN,=12C'0'         RESET TO ZEROS                          
         MVC   PBILMDAT,=12C'0'         SO MANUAL BILL CAN BE                   
         B     LDESC7DA                 CREDITED AGAIN                          
*                                                                               
LDESC7D9 MVC   PBILMDAT,TODAY                                                   
         LH    R0,INVNO                                                         
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  PBILMCAN+2(4),DUB                                                
         MVC   PBILMCAN(2),TODAY+2 MONTH                                        
*                                                                               
LDESC7DA L     R5,BRKCODE                                                       
         L     R5,ATOTS(R5)                                                     
         AH    R5,=Y(MAXMOS*ROWL)                                               
***      LA    R5,MAXMOS*ROWL(R5)  POINT OT TOTAL ROW                           
*                                                                               
         XC    WORK,WORK                                                        
*                                                                               
         L     R0,0(R5)                                                         
         S     R0,ROWHL(R5)                                                     
         ST    R0,WORK                                                          
         L     R0,4(R5)                                                         
         S     R0,ROWHL+4(R5)                                                   
         ST    R0,WORK+4                                                        
         L     R0,8(R5)                                                         
         S     R0,ROWHL+8(R5)                                                   
         ST    R0,WORK+8                                                        
*                                                                               
         L     R0,DBTOTS           ADD TO OVERALL BILLED TOTALS                 
         A     R0,WORK             GROSS                                        
         ST    R0,DBTOTS                                                        
         L     R0,DBTOTS+4                                                      
         A     R0,WORK+4           NET                                          
         ST    R0,DBTOTS+4                                                      
         L     R0,DBTOTS+8                                                      
         A     R0,WORK+8           CD                                           
         ST    R0,DBTOTS+8                                                      
*                                                                               
         CLI   TESTFLAG,C'T'       DON'T WRITE BACK IF TEST MODE                
         BE    LDESC7F                                                          
         CLI   RCWRITE,C'N'                                                     
         BE    LDESC7F                                                          
         MVC   AREC,ADWKREC                                                     
         GOTO1 PUTPRT                                                           
LDESC7F  DS    0H                                                               
*                                                                               
         CLI   SORTTRCE,C'Y'       TEST TO DUMP RECORD                          
         BNE   LDESC7H                                                          
*                                                                               
         MVC   HALF,PBILLLEN                                                    
         LH    R5,HALF                                                          
         CH    R5,=H'858'                                                       
         BNH   *+8                                                              
         LH    R5,=H'858'                                                       
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   P1(19),=C'PREV MANUAL BILLREC'                                   
         MVC   P1(L'PP@PRV02),PP@PRV02                                          
         DROP  RE                                                               
         GOTO1 HEXOUT,DMCB,KEY+27,P1+22,4,=C'N'                                 
         GOTO1 (RF),DMCB,PBILLREC,P2,(R5)                                       
         GOTO1 =A(PRNT)                                                         
*                                                                               
LDESC7H  DS    0H                                                               
         CLI   SPOTCTL,C'Y'        SEE IF SHOWING DETAIL                        
         BNE   LDESCX                                                           
         B     LDESC7W                                                          
*                                                                               
LDESC7W  DS    0H                                                               
         CLI   PERCTL,C'T'         IF MONTHS TOGETHER                           
         BNE   LDESC8                                                           
*                                                                               
******   CLI   H7ATTSW,C'Y'        USING PACKED ACCUMS                          
******   BNE   LDESC7W5            FOR PREVIOUSLY BILLED INS.                   
         L     RF,ADESC                                                         
         CLI   0(RF),X'FA'         DOING PREVIOUSLY BILLED                      
         BE    LDESC8              DON'T SHOW MONTH                             
*                                                                               
LDESC7W5 L     RF,APER             SHOW MONTH HERE                              
         ZIC   R6,0(RF)            (MAYBE IT NEVER DO THIS                      
         MH    R6,=H'8'             FOR LUMPEB PREV. BILLIED INS.)              
         LA    R6,PERLIST(R6)                                                   
*                                                                               
         GOTO1 DATCON,DMCB,(3,(R6)),(6,WORK)                                    
         MVC   264+1(6,R7),WORK                                                 
         MVI   396+1(R7),0         SPACE                                        
*                                                                               
LDESC8   DS    0H                                                               
         BRAS  RE,TOTOUT                                                        
LDESCX   DS    0H                                                               
         MVI   PRTINSW,C'Y'                                                     
         XMOD1                                                                  
*                                                                               
         DROP  R7                                                               
*                                                                               
GETANNO  NTR1                                                                   
         L     R7,ADWKREC                                                       
         USING PBUYREC,R7                                                       
         ZIC   R6,DOLNUM                                                        
         CLI   DOLNUM,5                                                         
         BNL   GETANX                                                           
         ZIC   R6,TYPNUM                                                        
         CLI   LSTOPT,C'I'         SEE IF LISTING INVOICE DETAILS               
         BE    GETAN5              HERE AND AT END                              
         CLI   LSTOPT,C'B'         SEE IF LISTING INVOICE DETAILS               
         BE    GETAN5              HERE AND AT END (+RESTATE AMTDUE)            
         CLI   LSTOPT,C'D'         SEE IF LISTING INVOICE DETAILS               
         BNE   GETANX              HERE                                         
*                                                                               
GETAN5   LA    R2,PBUYREC+33                                                    
         SR    R5,R5                                                            
         MVI   ELCODE,X'26'        MUST COUNT BILLING ELEMS                     
*                                                                               
         CLI   FINANSW,0           SEE IF DOING FINANCIAL BILL                  
         BE    GETAN8                                                           
         MVI   ELCODE,X'28'                                                     
***R***                                                                         
         CLC   QPROG,=C'R1'        SEE IF FINANCIAL REBATE                      
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
         CLC   QPROG,=C'RD'        SEE IF FINANCIAL REBATE DRAFT                
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
***R***                                                                         
         USING PBILELEM,R2                                                      
GETAN8   BRAS  RE,UNEXTEL                                                       
         BNE   GETAN10                                                          
         OC    PBLDATE,PBLDATE                                                  
         BZ    GETAN8                                                           
         CLC   PBLDATE,TODAYB                                                   
         BE    GETAN8                                                           
         CLI   MANRVDTP,0          SEE IF DOING A REVERSAL                      
         BE    GETAN9                                                           
         CLC   PBINVNO,MANRVNO     ONLY SHOW BILL I'M REVERSING                 
         BE    GETAN9B                                                          
         B     GETAN8                                                           
*                                                                               
GETAN9   DS    0H                                                               
*                                                                               
         CLI   SHOWREV,C'Y'        INCLUDING?                                   
         BE    *+12                                                             
*                                                                               
         TM    PBBILST,X'C0'       OMIT REVERSED AND REVERSALS                  
         BNZ   GETAN8                                                           
*                                                                               
         CLI   SCBNCSW,C'C'        SEE IF UFC COMM BILLING                      
         BNE   GETAN9A                                                          
         TM    PBBILST,X'01'       SEE IF RIGHT TYPE                            
         BZ    GETAN8                                                           
         B     GETAN9B                                                          
*                                                                               
GETAN9A  DS    0H                                                               
         CLI   SCBNCSW,C'N'        SEE IF UFC NET BILLING                       
         BNE   GETAN9B                                                          
         TM    PBBILST,X'02'                                                    
         BZ    GETAN8                                                           
*                                                                               
GETAN9B  LA    R5,1(R5)                                                         
         B     GETAN8                                                           
*                                                                               
GETAN10  CH    R5,=H'1'                                                         
         BNH   GETANX                                                           
         BCTR  R5,0                                                             
         AR    R6,R5                                                            
GETANX   ST    R6,FULL                                                          
         XIT1                                                                   
*                                                                               
         DROP  R2                                                               
*                                                                               
         SPACE 2                                                                
FNEXTP   CLC   0(15,R2),SPACES                                                  
         BER   RE                                                               
         LA    R2,132(R2)                                                       
         B     FNEXTP                                                           
*                                                                               
BILLPASS DC    X'00'                                                            
WRKMED   DC    C' '                                                             
*                                                                               
SVCTYP   DS    CL1           SAVED COST TYPE                                    
*                                                                               
MYOUR    DS    CL9           POSSIBILY ALTERED PBYOUR                           
*                            IF PROFB2B+11 IS "Y"                               
*                            "N" WILL BE FLOATED BEFORE UNIT RATE               
*                                                                               
SAVER2   DC    F'0'                                                             
LSAVKEY  DS    CL32                                                             
PRTINSW  DS    CL1           N= NOT SHOWING A ZERO COST 2 INS                   
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
* GET B4 PROFILE                                                                
GETPROFS NMOD1 0,GETPROFS                                                       
         LA    RC,SPACEND                                                       
*                                                                               
         XC    WORK,WORK                                                        
         MVC   WORK(3),=C'POB'                                                  
         MVC   WORK+3(1),TYPE                                                   
         MVC   WORK+4(3),QAGENCY                                                
         L     RF,ADCLT                                                         
         MVC   WORK+7(3),PCLTKCLT-PCLTREC(RF)                                   
         LA    RF,PCLTOFF-PCLTREC(RF)                                           
         CLI   0(RF),C' '                                                       
         BNH   *+14                                                             
         MVI   WORK+10,C'*'        SET OFFICE CODE                              
         MVC   WORK+11(1),0(RF)                                                 
*                                                                               
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROGPRO2,DATAMGR,,WORK+16              
         GOTOR PRNTPROF,DMCB,WORK,PROGPRO2,WORK+16                              
         OC    PROGPRO2,PROGPRO2                                                
         BNZ   GETPX                                                            
*                                                                               
         MVI   ERR,TYPERR          NO PROFILE                                   
         BRAS  RE,ERRPROC                                                       
*                                                                               
GETPX    XIT1                                                                   
*                                                                               
*                                                                               
*                                                                               
* READ BILL ADDRESS RECORD FOR EXTENDED ADDRESS FIELDS                          
*                                                                               
RBILADDR NMOD1 0,RBILAD                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         NI    DMINBTS,X'F7'      NO DELETES                                    
*                                                                               
         CLC   THREE,=C'AAA'                                                    
         BNE   *+16                                                             
         CLI   PROGPRO2+14,C'Y'    CHECK FOR AAA ADDRESS OPTION                 
         BE    RBI02                                                            
         B     RBILX                                                            
*                                                                               
         L     R0,=A(BADDRS)       CLEAR PREV PROD ADDR                         
         LHI   R1,ADDRLEN                                                       
         SR    RE,RE                                                            
         LA    RF,X'40'            FILL WITH SPACES                             
         SLL   RF,24                                                            
         MVCL  (R0),(RE)                                                        
*                                                                               
RBI02    L     RF,ADCLT                                                         
         MVC   KEY(25),0(RF)                                                    
         MVI   KEY+3,X'D3'                                                      
         MVC   KEY+7(3),THREE      PRODUCT AAA OR ACTUAL BRAND                  
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE                                                  
         BNE   RBILX                                                            
         MVC   AREC,ADWKREC        READ INTO WORK REC                           
         GOTO1 GETPRT                                                           
*                                                                               
         L     R2,AREC             NOW HAS PRODUCT AAA                          
         LA    R2,33(R2)           TO FIRST ELEMENT                             
         CLI   0(R2),X'10'         NAME ELEMENT?                                
         BE    *+6                                                              
         DC    H'0'                                                             
         USING ADRNAMEL,R2                                                      
*                                                                               
         L     R0,=A(BADDRS)       BRAND ADDRESS                                
         CLC   THREE,=C'AAA'                                                    
         BNE   *+16                                                             
         L     R0,=A(AADDRS)       AAA CORPORATE ADDRESS FOUND                  
         OI    FLAG1,AADDRSW                                                    
         B     *+8                                                              
         OI    FLAG1,BADDRSW       BRAND ADDRESS RECORD FOUND                   
*                                                                               
         LR    R3,R0                                                            
*                                                                               
         LHI   R1,ADDRLEN                                                       
         SR    RE,RE                                                            
         LA    RF,X'40'                 FILL WITH SPACES                        
         SLL   RF,24                                                            
         MVCL  (R0),(RE)                                                        
*                                                                               
         CLC   =C'NONE',ADRNAM1                                                 
         BE    RBINEQ                                                           
         CLC   =C'XX',ADRNAM1                                                   
         BE    RBINEQ                                                           
         MVC   WORK(5),ADRNAM1                                                  
         OC    WORK(5),SPACES     SINCE THERE MAY BE BINARY ZEROS               
         CLC   WORK(5),=C'X    '                                                
         BE    RBINEQ                                                           
         CLI   ADRNAM1,C'A'                                                     
         BL    RBINEQ                                                           
*                                                                               
         MVC   0(L'ADRNAM1,R3),ADRNAM1                                          
         LA    R3,L'ADRNAM1(R3)                                                 
         CLC   ADRNAM2,SPACES      ANY NAME 2?                                  
         BE    *+14                                                             
         MVC   0(L'ADRNAM2,R3),ADRNAM2                                          
         LA    R3,L'ADRNAM2(R3)                                                 
         DROP  R2                                                               
*                                                                               
         MVI   ELCODE,X'20'        ADDRESS ELEMENT                              
         BRAS  RE,UNEXTEL                                                       
         BNE   RBI10                                                            
         USING ADRADDEL,R2                                                      
*                                                                               
         MVC   0(L'ADRADDR1,R3),ADRADDR1                                        
         LA    R3,L'ADRADDR1(R3)                                                
         CLC   ADRADDR2,SPACES     ANY ADDRESS 2?                               
         BE    *+14                                                             
         MVC   0(L'ADRADDR2,R3),ADRADDR2                                        
         LA    R3,L'ADRADDR2(R3)                                                
         DROP  R2                                                               
*                                                                               
RBI10    MVI   ELCODE,X'30'        ATTENTION OF ELEM                            
         BRAS  RE,UNEXTEL                                                       
         BNE   RBILX                                                            
         USING ADRATTEL,R2                                                      
*                                                                               
         MVC   0(L'ADRATTN,R3),ADRATTN                                          
         B     RBILX                                                            
*                                                                               
RBINEQ   LTR   RB,RB                                                            
         CLC   THREE,=C'AAA'                                                    
         BNE   *+12                                                             
         NI    FLAG1,X'FF'-AADDRSW                                              
         B     *+8                                                              
         NI    FLAG1,X'FF'-BADDRSW                                              
*                                                                               
RBILX    OI    DMINBTS,X'08'      RESET TO PASS DELETES                         
         XIT1                                                                   
*                                                                               
*                                                                               
*        ROUTINE TO PRINT CUSTOM COLUMNS                                        
*                                                                               
CCOLRTN  NMOD1 0,CCOL              STANDARD CUSTOM COLUMN                       
*                                                                               
         LA    RC,SPACEND                                                       
*                                                                               
*        OPEN THE CONTROL FILE                                                  
*                                                                               
         GOTO1 DATAMGR,DMCB,=CL8'DMOPEN',=CL8'PRINT',GENFILES,DMWORK            
*                                                                               
         L     R6,ASCCTAB          TABLE OF STANDARD CUSTOM COLUMNS             
*                                  TO REPORT                                    
         CLI   0(R6),X'FF'         NO ENTRIES                                   
         BE    CCOLX                                                            
         L     R7,ADWKREC          BUYREC THERE                                 
         USING PBUYREC,R7                                                       
*                                                                               
*    NOTE:  R2 SET TO FIRST AVAILABLE LINE BEFORE CALL                          
*                                                                               
CCOL05   ST    R2,ANXTCOM          WHERE TO START PRINTING                      
*                                                                               
CCOL20   LA    R2,PBUYREC+33                                                    
         USING BYCCELD,R2          BUY CUSTOM COLUMN ELEMENT                    
         MVI   ELCODE,BYCCIDQ                                                   
*                                                                               
         CLI   0(R6),X'FF'         END OF TABLE                                 
         BE    CCOLX                                                            
CCOL20N  BRAS  RE,CNXTEL                                                        
         BNE   CCOLBK5             TRY NEXT STANDARD CUSTOM COLUMN              
         CLC   BYCCSQN,0(R6)       MUST MATCH SEQ NO. I'M LOOKING FOR           
         BNE   CCOL20N             SKIP TO NEXT BUY ELEMENT                     
*                                                                               
         CLC   BYCCSQN,=X'2000'    STANDARIZED CUSTOM COLUMN?                   
*                                                                               
         BL    CCOL20F             BRANCH THERE TO REPORT NON-STANDARD          
*                                  (WON'T HAPPEN)                               
*                                                                               
         XC    GKEY,GKEY                                                        
C        USING GCOLPKEY,GKEY                                                    
         MVC   C.GCOLPRID,=AL3(GCOLPRIQ)  SET GENDIR PASSIVE KEY ID             
         MVI   C.GCOLPMED,C'A'       MEDIA ALWAYS A FOR CUST COL'S              
         MVI   C.GCOLPRCD,GCOLPRCQ   RECORD CODE FOR PASSIVE KEY                
         MVC   C.GCOLPSQN,BYCCSQN    SEQUENCE NUMBER                            
         XC    C.GCOLPSQN,=X'FFFF'   COMPLEMENT SEQUENCE NUMBER                 
         MVC   GKEYSAVE,GKEY                                                    
*                                                                               
         GOTOR DATAMGR,DMCB,(DMINBTS,=C'DMRDHI'),=C'GENDIR',           X        
               GKEY,GKEY,0                                                      
*******  GOTOR DATAMGR,DMCB,=CL8'DMRDHI',=CL8'GENDIR',GKEYSAVE,GKEY,0,0         
*                                                                               
         CLC   C.GCOLPKEY,GKEYSAVE                                              
         BE    *+6                                                              
         DC    H'0'                MUST BE THERE                                
         DROP  C                                                                
*                                                                               
         LA    RE,CCWIO                                                         
         ST    RE,AREC                                                          
*                                                                               
         GOTOR DATAMGR,DMCB,(DMINBTS,=C'GETREC'),=C'GENFILE',          X        
               GKEY+36,AREC,DMWORK                                              
*******  GOTOR DATAMGR,DMCB,=CL8'GETREC',=CL8'GENFIL',GKEY+36,AREC,             
*******        DMWORK                                                           
*                                                                               
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         LA    R5,CCWIO                                                         
         LA    R5,GCOLFRST-GCOLKEY(R5)                                          
         USING PCOLELEM,R5                                                      
         B     CCOL20M                                                          
*                                                                               
CCOL20F  XC    KEY,KEY                                                          
C        USING PCOLRECD,KEY                                                     
         MVC   C.PCOLPAGY,QAGENCY  AGENCY                                       
         MVI   C.PCOLPMED,C'A'     MEDIA ALWAYS A FOR CUST COL'S                
         MVI   C.PCOLPRCD,X'D1'    RECORD CODE FOR PASSIVE KEY                  
         MVC   C.PCOLPSQN,BYCCSQN  SEQUENCE NUMBER                              
         XC    C.PCOLPSQN,=X'FFFF' COMPLEMENT SEQUENCE NUMBER                   
         DROP  C                                                                
*                                                                               
         GOTOR HIGH                                                             
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         LA    RE,CCWIO            TEMP USE FOR CUSTOM COLUMN REC               
         ST    RE,AREC                                                          
*                                                                               
         GOTOR GETPRT                                                           
         LA    R5,CCWIO+(PCOLFRST-PCOLREC)                                      
*                                                                               
CCOL20M  DS    0H                  USED TO CHECK IF ON INS.ORDERS?              
*                                                                               
         L     R4,ANXTCOM          OUTPUT CUSTOM COLUMN DATA                    
******** XC    0(70,R4),0(R4)                                                   
         LR    R3,R4               LEAVE R4 POINTING TO NXTCOM                  
         CLI   2(R6),C'D'          SEE IF ONLY SHOWING DATA                     
         BE    CCOL26XX                                                         
         CLI   2(R6),C'B'          SEE IF SHOWING BOTH HEADERS                  
         BE    CCOL20P                                                          
         CLI   2(R6),C'2'          SEE IF SHOWING ONLY SECOND                   
         BE    CCOL25                                                           
*                                                                               
CCOL20P  MVC   0(12,R3),PCOLHDR1   COLUMN HEADER 1                              
*                                                                               
         LA    R3,11(R3)           POINT TO LAST CHAR IN HEADER 1               
CCOL22   CLI   0(R3),C' '          ANYTHING THERE?                              
         BH    CCOL24                                                           
         AHI   R3,-1               MOVE 1 "LEFT" ON LINE                        
         B     CCOL22              TEST AGAIN                                   
*                                                                               
CCOL24   DS    0H                  R3 POINTING TO END OF "HDR 1"                
         CLI   2(R6),C'1'          ONLY SHOWING FIRST HEADER?                   
         BE    CCOL26X                                                          
         CLI   PCOLHDR2,C' '       ANYTHING IN HEADER 2                         
         BNH   CCOL26X             NO                                           
         LA    R3,2(R3)            MOVE 2 "RIGHT" ON LINE                       
CCOL25   MVC   0(12,R3),PCOLHDR2   COLUMN HEADER 2                              
*                                                                               
         LA    R3,11(R3)           POINT R3 TO LAST POSSIBLE CHARACTER          
CCOL26   DS    0H                  IN PCOLHDR2                                  
         CLI   0(R3),C' '          ANYTHING THERE ?                             
         BH    CCOL26X             YES                                          
         AHI   R3,-1               MOVE 1 "LEFT" ON LINE                        
         B     CCOL26              TEST AGAIN                                   
*                                                                               
CCOL26X  DS    0H                                                               
         LA    R3,1(R3)            MOVE 1 "RIGHT" ON LINE                       
         MVI   0(R3),C':'          PLACE A COLON                                
         LA    R3,2(R3)                                                         
         CLC   PCOLHDR2(5),=C'UNITS'                                            
         BE    CCOL26XX                                                         
         CLC   PCOLHDR2(4),=C'RATE'                                             
         BE    CCOL26XX            PUT DATA ON SAME LINE FOR THESE              
*                                                                               
         LA    R4,132(R4)                                                       
         ST    R4,ANXTCOM          PUT DATA ON NEXT LINE                        
         LR    R3,R4                                                            
*                                                                               
*        NOTE: RIGHT TO CCOL26XX IF ONLY DATA BEING SHOWN                       
*                                                                               
CCOL26XX CLI   PCOLTYP,C'D'        DATE ?                                       
         BE    CCOL50              YES                                          
         CLI   PCOLTYP,C'P'        PERIOD ?                                     
         BE    CCOL60              YES                                          
         CLI   PCOLTYP,C'T'        TEXT ?                                       
         BNE   CCOL70              NO - MUST BE 1 OF 3 NUMERIC "TYPES"          
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
*                                                                               
* FOLLOWING CODE PROVIDES FOR PLACING VARIABLE LENGTH TEXT IN A                 
* VARIABLE LENGTH PRINT BLOCK                                                   
*                                                                               
* NTRY R4-> BEGINNING OF NEXT DATA "LINE"                                       
* NTRY R3-> BEGINNING OF VARIABLE LENGTH OUTPUT ON "LINE"                       
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
*                                                                               
         MVI   MAXLNTH,47                                                       
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         MVI   MAXLNTH,23                                                       
*****    LA    RE,90(R4)           POINT RE TO LINE END                         
*****    SR    RE,R3               RE HAS MAXIMUM LINE LENGTH                   
*****    STC   RE,MAXLNTH          SAVE                                         
*                                                                               
         ZICM  RF,BYCCLEN          TOTAL ELEMENT LENGTH                         
         LA    R1,BYCCHDRL         HEADER LENGTH (OVERHEAD)                     
         SR    RF,R1               RF HAS LENGTH OF CUST COL DATA               
         LTR   RF,RF                                                            
         BNP   CCOLBK5             NO DATA - NEXT ELEMENT IN ASCCTAB            
         LR    RE,RF               SAVE LENGTH OF DATA                          
*                                                                               
*        CHECK FOR UNPRINTABLE CHARACTERS (CAUSED BY CUTTING/PASTING)           
*        AND CHANGE THEM TO SPACES                                              
*        X'4B', X'41', X'0D', X'15'                                             
*                                                                               
         LA    R1,BYCCDATA                                                      
CCOL27   CLI   0(R1),X'4B'                                                      
         BNE   CCOL27A                                                          
         MVI   0(R1),X'40'                                                      
         B     CCOL27X                                                          
*                                                                               
CCOL27A  CLI   0(R1),X'0D'                                                      
         BNE   CCOL27B                                                          
         MVI   0(R1),X'40'                                                      
         B     CCOL27X                                                          
*                                                                               
CCOL27B  CLI   0(R1),X'15'                                                      
         BNE   CCOL27C                                                          
         MVI   0(R1),X'40'                                                      
         B     CCOL27X                                                          
*                                                                               
CCOL27C  CLI   0(R1),X'41'                                                      
         BNE   CCOL27X                                                          
         MVI   0(R1),X'40'                                                      
         B     CCOL27X                                                          
*                                                                               
CCOL27X  LA    R1,1(R1)      NEXT CHARACTER                                     
         BCT   RF,CCOL27                                                        
         LR    RF,RE         RESTORE RF TO DATA LENGTH                          
*                                                                               
* USE PLISREC FOR OUTPUT BLOCK                                                  
*                                                                               
         PRINT GEN                                                              
         GOTO1 =V(CHOPPER),DMCB,((RF),BYCCDATA),(MAXLNTH,ALISREC),     X        
               (47,4)                                                           
*                                                                               
         PRINT NOGEN                                                            
         L     RF,8(R1)            NUMBER OF LINES IN BLOCK                     
         LTR   RF,RF                                                            
         BNZ   *+6                                                              
         DC    H'0'                SHOULD NOT HAPPEN                            
*                                                                               
         L     R5,ALISREC          POINT R5 TO PLISREC (OUTPUT BLOCK)           
*                                                                               
CCOL30   DS    0H                                                               
         ZIC   R1,MAXLNTH          PREP FOR EXECUTED MOVE                       
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),0(R5)       EXEC MOVE OF 1 LINE OF TEXT                  
         BCT   RF,CCOL36                                                        
*                                                                               
         B     CCOLBK              DONE WITH THIS TEXT - NEXT ELEM              
*                                                                               
CCOL36   DS    0H                                                               
         L     R4,ANXTCOM          NEXT REPORT LINE                             
         LA    RE,P14                                                           
         CR    R4,RE                                                            
         BH    CCOLX               MUST STOP - OUT OF PRINT LINES               
*                                                                               
         LA    R4,132(R4)                                                       
         ST    R4,ANXTCOM                                                       
******** XC    0(70,R4),0(R4)                                                   
         LA    R3,132(R3)          NEXT TEXT AREA                               
         LA    R5,47(R5)           NEXT CHOPPER LINE                            
         LTR   RF,RF                                                            
         BZ    CCOLBK                                                           
         B     CCOL30              OUTPUT PRINT LINE                            
*                                                                               
CCOL50   DS    0H                  OUTPUT A SINGLE DATE                         
         GOTOR DATCON,DMCB,(X'03',BYCCDATA),(5,0(R3))                           
         B     CCOLBK              NEXT ELEMENT                                 
*                                                                               
CCOL60   DS    0H                  OUTPUT A DATE RANGE (PERIOD)                 
         GOTOR DATCON,DMCB,(X'13',BYCCDATA),(5,0(R3))                           
         B     CCOLBK              NEXT ELEMENT                                 
*                                                                               
CCOL70   DS    0H                  OUTPUT A NUMERIC FIELD (N, $, OR %)          
*                                                                               
         XC    DUB,DUB             DUMMY CURRENCY DEFINITION FLD                
         MVC   DUB+3(1),PCOLDECS                                                
         LA    RF,DUB                                                           
         CURED (P8,BYCCDATA),(20,0(R3)),(RF),ALIGN=LEFT,FLOAT=-,       X        
               COMMAS=YES                                                       
*                                                                               
CCOLBK   DS    0H                                                               
*******  BRAS  RE,RPYCUCOL         REPLY CUSTOM COLUMN FOR WEB IO               
*                                                                               
         L     R4,ANXTCOM          BUMP TO NEXT LINE                            
         LA    R4,132(R4)                                                       
         ST    R4,ANXTCOM                                                       
CCOLBK5  LA    R6,6(R6)            NEXT ONE TO LOOK FOR                         
         B     CCOL20              NEXT CUSTOM COLUMN BUY ELEMENT               
*                                                                               
CCOLX    DS    0H                                                               
******   MVC   KEY,TMPSVKEY        NOT NEEDED?                                  
******   GOTOR HIGH                                                             
******   CLI   DMCB+8,0                                                         
******   BE    *+6                                                              
******   DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         XMOD1                                                                  
*                                                                               
         LTORG                                                                  
MAXLNTH  DS    XL1                                                              
SAVSYS   DS    XL1                                                              
GKEY     DS    CL48                                                             
GKEYSAVE DS    CL48                                                             
ANXTCOM  DS    A                                                                
CCWIO    DS    CL400            IO AREA FOR CC RECORDS                          
*                                                                               
GENFILES DS    0D                                                               
         DC    CL8' GENDIR'                                                     
         DC    CL8' GENFIL'                                                     
         DC    C'X'                END OF LIST                                  
*                                                                               
         SPACE 2                                                                
CNXTEL   DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    CNXTEL2                                                          
         CLC   0(1,R2),ELCODE                                                   
         BER   RE                                                               
         B     CNXTEL                                                           
CNXTEL2  DS    0H                                                               
         LTR   RE,RE                                                            
         BR    RE                                                               
         DROP  R2,R5,R7                                                         
*                                                                               
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         
         TITLE 'TSTRET'                                                         
TSTRET   NMOD1 0,TSTRET                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         MVI   RETSKIP,C'N'                                                     
         CLI   UPASS,0                                                          
         BE    TRYES               OK OF NON-RETAIL                             
         L     R4,=A(GDAREA)                                                    
         USING GDSECT,R4                                                        
         L     RF,ADEST                                                         
         MVC   GDSCHM,PESTRSCH-PESTREC(RF)  RETAIL SCHEME                       
         CLC   GDSCHM,SPACES                                                    
         BNH   TR2A                                                             
         MVI   GDTEST,C'Y'         SET TEST MODE                                
         MVI   GDOUTNO,0                                                        
         CLI   UPASS,X'FE'         WAS C'T'                                     
         BE    *+10                                                             
         MVC   GDOUTNO,UPASS                                                    
         GOTO1 =V(FINDOUTP),DMCB,(R4)                                           
         MVI   GDTEST,C'N'                                                      
         CLI   UPASS,X'FE'        WAS C'T'                                      
         BNE   TR2D                                                             
         CLC   GDSHRP,=F'10000'    100 PCT                                      
         BE    TR2B                                                             
*                                                                               
TR2A     DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*--->    MVC   P1(28),=C'** SCHEME XX NOT CORRECT FOR'                          
         MVC   P1(L'PP@SCHM),PP@SCHM                                            
         MVC   P1+10(2),GDSCHM                                                  
         MVC   P1+29(15),GDMGRDSC                                               
         CLI   GDMKTLEN,0                                                       
         BE    *+10                                                             
         MVC   P1+29(15),GDMKTDSC                                               
         MVC   P1+45(6),GDMGR                                                   
         MVC   P1+50(2),GDMKT                                                   
*--->    MVC   P1+55(09),=C'(EST NNN)'                                          
         MVC   P1+55(L'PP@ESTN),PP@ESTN                                         
         DROP  RE                                                               
         MVC   P1+55+5(3),EST                                                   
*                                                                               
         CLC   GDSCHM,SPACES                                                    
         BH    *+14                                                             
         MVC   P1+10(2),=C'00'                                                  
         B     TR2A2                                                            
*                                                                               
         OC    GDSHRP,GDSHRP                                                    
         BZ    TR2A2                                                            
*--->    EDIT  (B4,GDSHRP),(7,P1+65),2                                          
         CURED (B4,GDSHRP),(7,P1+65),CURTAB                                     
         MVC   P1+73(3),=C'PCT'                                                 
TR2A2     DS    0H                                                              
         MVI   PRSW,C'N'                                                        
         MVI   SKIPSPEC,C'Y'                                                    
         GOTO1 =A(PRNT)                                                         
         MVI   RETERR,1                                                         
         MVC   PAGE,=H'1'                                                       
TR2B     DS    0H                                                               
         B     TRNO                                                             
TR2D     DS    0H                                                               
         CLI   UPASS,1             DONT SKIP IF CORT OUTLET                     
         BE    TRYES                                                            
         CLI   UPASS,X'FF'         WAS C'S'                                     
         BE    TRYES                                                            
         MVI   RETSKIP,C'N'                                                     
         OC    GDSHRP,GDSHRP                                                    
         BNZ   TRYES                                                            
*                                                                               
         MVI   RETSKIP,C'Y'        SKIP THIS EST - NO SHR PCT                   
*                                                                               
TRNO     DS    0H                                                               
         LTR   RE,RE                                                            
         B     TRX                                                              
TRYES    DS    0H                                                               
         SR    RE,RE                                                            
TRX      DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
*                                                                               
         EJECT                                                                  
*                             GETAOR - GET AOR INFO                             
         SPACE 2                                                                
GETAOR   NMOD1 0,GETAOR                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         XC    SVAORS,SVAORS                                                    
*                                                                               
****     L     RF,=A(AORADDR)                                                   
****     MVC   0(132,RF),SPACES                                                 
****     MVC   132(OADDRLEN-132,RF),SPACES                                      
         L     R0,=A(AORADDR)                                                   
         LHI   R1,ADDRLEN                                                       
         SR    RE,RE                                                            
         LA    RF,X'40'                 FILL WITH SPACES                        
         SLL   RF,24                                                            
         MVCL  (R0),(RE)                                                        
*                                                                               
         CLI   AORSW,C'Y'          FIRST TEST NEED AOR                          
         BNE   GETAORX                                                          
*                                                                               
         NI    DMINBTS,X'F7'       SET NOT TO PASS DELETES                      
*                                                                               
         XC    KEY,KEY                                                          
*                                                                               
         L     RF,ADCLT                                                         
         MVC   KEY(7),0(RF)       AGY/MED/CLT                                   
*                                                                               
         OC    AMED,AMED           FOR MULTI-MEDIA REQ GET MEDIA                
         BZ    GA02                FROM AMED                                    
         L     RF,AMED                                                          
         MVC   KEY+2(1),0(RF)                                                   
*                                                                               
GA02     L     RF,APRD                                                          
         MVC   KEY+7(3),0(RF)                                                   
         L     RF,AEST                                                          
         MVC   KEY+10(2),0(RF)                                                  
         MVI   KEY+3,X'14'                                                      
         GOTO1 HIGH                                                             
         CLC   KEY(12),KEYSAVE                                                  
         BE    GAO4                                                             
         MVC   KEYSAVE+10(2),FFS                                                
         CLC   KEY(12),KEYSAVE          SEE IF I FOUND ALL EST REC              
         BE    GAO4                                                             
         MVC   KEY(25),KEYSAVE                                                  
         GOTO1 HIGH                     TRY FOR ALL EST RECORD                  
         CLC   KEY(12),KEYSAVE                                                  
         BNE   GETAORX            NOT FOUND                                     
*                                                                               
*                                                                               
GAO4     DS    0H                                                               
         MVC   SVAORDA,KEY+27      SAVE AOR DISK ADDR                           
                                                                                
*****    L     RF,PPFILEC                                                       
*****    USING PPFILED,RF                                                       
*****    LA    R7,PCONREC          USE CONTRACT RECORD AREA                     
*****                                                                           
*****    DROP  RF                                                               
*****                                                                           
*                                                                               
         LA    R7,AORWRKA           USE AORWRK INSTEAD OF PCONREC               
         ST    R7,AREC                                                          
         USING AORREC,R7                                                        
         GOTO1 GETPRT                                                           
*                                                                               
         CLI   CVATCOD,0           IF VAT ACTIVE NEED TO SET CLT/PRD            
         BE    GA05                VAT CODES, BECAUSE MAY NOT HAVE BEEN         
         GOTO1 =A(SETCPVC),DMCB                                                 
*                                                                               
GA05     DS    0H                                                               
         LA    R2,AORELS                                                        
*                                                                               
GAO6     DS    0H                                                               
         CLI   0(R2),X'02'         ADDRESS ELEM                                 
         BE    GAO7                                                             
         CLI   0(R2),X'03'         AOR INFO ELEM                                
         BE    GAO8                                                             
         CLI   0(R2),0             EOR                                          
         BE    GAO9                                                             
*                                                                               
GAO6D    DS    0H                                                               
         ZIC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     GAO6                                                             
*                                                                               
GAO7     DS    0H                  AOR ADDRESS ELEM                             
         USING AORADREL,R2                                                      
         L     RF,=A(AORADDR)                                                   
         MVC   000(30,RF),AORLIN1                                               
         MVC   060(30,RF),AORLIN2                                               
         MVC   120(30,RF),AORLIN3                                               
         MVC   180(30,RF),AORLIN4                                               
*                                                                               
****     MVC   AORADR1(30),AORLIN1                                              
****     MVC   AORADR2(30),AORLIN2                                              
****     MVC   AORADR3(30),AORLIN3                                              
****     MVC   AORADR4(30),AORLIN4                                              
         B     GAO6D                                                            
*                                                                               
GAO8     DS    0H                  AOR INFO ELEM                                
         USING AORELEM,R2                                                       
**NEW 5/16/91                                                                   
******   CLI   AORRCVBL,C' '       IF NO ACCOUNT - REJECT WHOLE RECORD          
******   BNH   GAO9                THIS CHECK WAS NO-OPED 4/7/92                
*                                                                               
         CLI   PROFAOR+4,C'Y'      IS 0 PCT AOR O.K.?                           
         BE    GAO8B                                                            
         OC    AORPCT,AORPCT       CHK FOR AOR PCT                              
         BZ    GAO9                ZERO-SO SKIP                                 
*                                                                               
GAO8B    DS    0H                                                               
**NEW 5/16/91                                                                   
**NEW 10/18/89                                                                  
         MVC   SVAORPCT,AORPCT     PCT                                          
         MVC   SVAORBAS,AORBAS     BASIS X'00'= GROSS X'80'= AC                 
         MVC   SVAORACT,AORRCVBL   RCVBL/PAYABLE ACCOUNT                        
         CLC   SVAORACT,SPACES     SEE IF I HAVE AN ACCOUNT                     
         BH    *+10                                                             
         MVC   SVAORACT,AORLIN1    USE AGENCY NAME                              
*                             NEEDED FOR THOSE AGENCIES NOT ON ACC              
*                             THAT LEAVE ACCOUNT FIELD BLANK                    
**NEW 10/18/89                                                                  
         MVC   SVAOREFF,AOREFF     EFFECTIVE DATE                               
**NEW 5/16/91                                                                   
         MVC   SVAORKIL,AORKILL    KILL DATE                                    
         OC    AORKILL,AORKILL                                                  
         BNZ   *+10                                                             
         MVC   SVAORKIL,=X'FFFF'                                                
*                                                                               
         MVC   SVAORVCS,SPACES          CLEAR                                   
         MVI   SVAORMVP,0               CLEAR MAIN PST PROV.                    
         MVI   SVAORMVC,0               CLEAR MAIN PST CODE                     
*                                                                               
         MVC   SVAORVCD,CVATCOD    SET DEFAULT TO CLIENT VAT CODE               
         CLI   AORGSTCD,C' '                                                    
         BNH   *+10                                                             
         MVC   SVAORVCD,AORGSTCD                                                
         OC    AORPST,SPACES                                                    
         CLC   AORPST,SPACES                                                    
         BNH   *+10                                                             
         MVC   SVAORVCS+1(L'SVAORVCS-1),AORPST                                  
*                                                                               
         MVC   SVAORMVP,AORMPSTP         MAIN PST PROVINCE #                    
         MVC   SVAORMVC,AORMPSTC         AND CODE                               
*                                                                               
         B     GAO6D                                                            
*                                                                               
GAO9     DS    0H                                                               
GETAORX  DS    0H                                                               
         OI    DMINBTS,X'08'    RESET TO PASS DELETES                           
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
*                                                                               
AORWRKA  DS    XL500          AOR RECORD AREA                                   
         SPACE 2                                                                
         DROP  R2,R3,R4,R6,R7,R8                                                
         TITLE 'ENDINV - END OF INVOICE'                                        
*        CHANGE LOG                                                             
*                                                                               
*  BPLA    10/00   FIX BUG IN PRETADJ                                           
*                  EDI CALL WITH VAT - USE SAVER4                               
*                  TO STORE AND RESTORE ADDRESS OF                              
*                  BILLING FORMULA FOR EDI CALL                                 
*                                                                               
*  BPLA   10/00    CHANGES TO PRINT UCOMM RECORD DATA                           
*                  UNDER UDEF DATA (END OF INV ONLY)                            
*                                                                               
*  BPLA   08/00    COPY OF PPREPB12D AT LEVEL 60 5/31/00                        
*                  COPY MADE 8/16/00                                            
*                  CHANGES TO CATALP AND PPREPB1WKN                             
*                  (WHICH INCLUDES PNNEWFILE IN PLACE OF                        
*                  PPNEWFILE)                                                   
*                  PNNEWFILE INCLUDES PNBILREC IN PLACE                         
*                  OF PBILLREC                                                  
*                                                                               
*  BPLA    05/00   USE AORWRK INSTEAD OF PCONREC                                
*                                                                               
*  BPLA   02/00    CHANGE AGENCY FEE OPTION                                     
*                  A- NOW MEANS PRINT "AGENCY FEE'                              
*                  P- NOW MEANS PRINT AGENCY FEE WITH PCT.                      
*                     (WHAT A USED TO DO)                                       
*                                                                               
*  BPLA   10/99    IN PRTUSER DON'T DO USER FIELDS THAT WILL                    
*                  APPEAR IN THE HEADLINES                                      
*                                                                               
*  BPLA   9/99     B2A PROF CHECK IN AORINV - LIST FORMAT                       
*                                                                               
*  BPLA   9/99     B2A PROFILE OPTION TO CONTROL                                
*                  BASIS OF COST 2 AOR BILLING                                  
*                  CONTRACT OR COST2                                            
*                                                                               
*  BPLA   6/99     CHANGES FOR COST2 FEATURE                                    
*                                                                               
*  BPLA   6/99     COPY OF PPB12D AT LEVEL 46 MADE 6/15/99                      
*                                                                               
*  BPLA   5/25/99  SPECIAL FOR JW - IN ADJSEP ALWAYS USE                        
*                  "SHOW ON BILL AS" BASIS (IF PRESENT)                         
*                  THEY DON'T CARE IF THE MATH DOESN'T WORK                     
*                  SEE **JW** FLAGS                                             
*                                                                               
*  BPLA   5/21/99  IN ADJINV ACTUALLY PRINT THE COMMISSION ADJ                  
*                  BASIS FROM ANY "SHOW NO BILL AS"                             
*                  FORMULA OVERRIDES (CHAB SCREEN)                              
*                  ONLY ALLOWED FOR COMISSION ADJUSTMENT OPTION                 
*                  THIS CHANGE MADE FOR JWT 5/21/99                             
****************                                                                
****************   WARNING                                                      
****************   IT MAY WELL ADVERSELY AFFECT OTHER USERS                     
****************   AS THE ADJUSTMENT AMONT DISPLAYED                            
****************   CERAINLY MAY NOT ALWAYS MATCH THE CALCULATION                
****************   DISPLAYED !!!!!!                                             
*                                                                               
*  BPLA   4/99    NEW VALUE FOR PROFB1A+1                                       
*                 'A' = ALWAYS PRINT 'AGENCY FEE' PLUS PERCENTAGE               
*                                                                               
*  BPLA   1/99    FIX BUG IN PRTUSER-WAS PRINTING 2ND PRODUCT                   
*                 USER FIELD AT FRONT OF INVOICE WHEN IT SHOULDN'T              
*                                                                               
*                                                                               
*  BPLA   10/98   PRTUSER MOVED TO IT'S OWN CSECT AND                           
*                 CODE FOR PRINTING SOME USER COMMENTS                          
*                 AT FRONT OF INVOICE                                           
*                 PLUS EDI CALLS IN PRTAAAU                                     
*                                                                               
*  BPLA   10/98   RENAMED FROM PPB12DE                                          
*                                                                               
*  BPLA   8/98    CHANGES FOR SFM BILLING FORMULA RECS                          
*                                                                               
*  BPLA   7/98    CHANGES FOR EDITING BFCOMP AND BFPCOMP                        
*                 TO ALLOW FOR VALUES OVER 99.9999                              
*                                                                               
*  BPLA   5/98    CD SEPARATE EDI CALLS                                         
*                                                                               
*  BPLA   3/98    MULTI-MEDIA - SUPPRESS JOB TOTALS                             
*                 IF ONLY ONE MEDIA HAD BILLING                                 
*                 EDI IMPROVEMENTS                                              
*                                                                               
*  BPLA   1/98    CHANGES FOR EDI BILLING                                       
*                                                                               
*  BPLA   12/97   ADD DUMMY CSECT AT END                                        
*                                                                               
*  BPLA  9/97     CHANGES TO AORINV TO HANDLE MULTI-MEDIA                       
*                                                                               
*  BPLA  5/97     WESTERN OPTION TO SUPPRESS $                                  
*                 UNLESS AT END OF INVOICE                                      
*                                                                               
*  BPLA  2/97     ADDITIONAL WORK ON AOR BILL COMMENTS                          
*                                                                               
*  BPLA 10/96     CODE TO DISPLAY STANDARD COMMENT ATTACHED                     
*                 TO AOR RECORD                                                 
*                                                                               
*  BPLA 9/96      PPB12DO SOURCE MADE LIVE - NOW INCLUDES PPREPB1WRK            
*                 NEEDS PPB1ACC                                                 
*                                                                               
*  BPLA 3/96      IN PRTADJ - IF DOING SPECIAL CD HANDLING                      
*                 AND CD IS A CREDIT, I MUST ADD TOTVAT                         
*                 TO R0 BEFORE SUBTRACTING THE CD                               
*                 SO "ACTUAL AMOUNT" WILL BE CORRECT                            
*                 ALSO - NO-OP CHECK FOR MANUAL PCT OF LESS                     
*                 THAN 20 AT BCA4                                               
*                                                                               
*  BPLA 8/95      NEW OPTION ON B1A PROFILE                                     
*                 'Y' MEANS ALWAYS DISPLAY "COMMISSION ADJUSTMENT"              
*                 INSTEAD OF "+ (OR -) NNN.NN PCT. OF..."                       
*                                                                               
*  BPLA 8/10/95   DISPLAY TOTAL OF BASIS AMOUNTS ON PRD/EST LIST                
*                 AOR BILL                                                      
*                                                                               
*  BPLA 4/26/95   CHANGE FOR NET BASIS ON AOR BILLING                           
*                                                                               
*  BPLA 3/2/95    FIX BUG IN BILCALC - PST BASIS WAS WRONG WHENEVER             
*                 THERE WAS ZERO BILLABLE FOR A MONTH                           
*                 FIX - SET A SWITCH (PVATSW) IF THERE IS VAT BILLABLE          
*                 AND CHECK IT AT BC4 BEFORE CHECK FOR BILLABLES                
*                                                                               
*  BPLA 1/12/95   FIX BUG IN PRTADJ - FOR RETAIL AT PA25-PA26                   
*                                                                               
*  BPLA 10/5/94   IN ENDINV - ONLY RESET FINANSW TO FININVSW                    
*                 IF MULTI-MEDIA BILL                                           
*                                                                               
*  BPLA 9/20/94   FIX RETAIL BUG                                                
*                 ALSO SET PEPTFIN IN BCADD (IF FINANCIAL)                      
*                                                                               
*  BPLA 9/94      ADDITIONAL FIX FOR CDSEP OPTIONS C AND R                      
*                                                                               
*  BPLA 8/94      FOR CDSEP OPTIONS C AND R                                     
*                 REMOVE CD FROM BILL FORMULA BASIS                             
*                 ONLY WHEN PRINTING BASIS                                      
*                                                                               
*  BPLA 8/94      FIX BUG IN PRTADJ  (NEAR PA27A18E)                            
*                 CLI  ADJDSP,C'Y' SHOULD HAVE BEEN                             
*                 CLI  ADJSEP,C'Y'                                              
*                                                                               
*  BPLA 8/94      CODE TO HANDLE SUPPRESSION OF COMMENTS                        
*                 BY BILLING TYPES                                              
*                                                                               
*  BPLA 6/94      FIX BUG IN PRTADJ AT PA3B5                                    
*                 CHANGE CLC BFBASA(2),FFS TO CLI BFBASA,=X'FF'                 
*                 ALSO - ADJUST R2 IF DOING ONE TYPE AND CAT                    
*                                                                               
*  BPLA 6/94      FIX BUG IN LSTINV AT LI34                                     
*                 CLI  DOLNUM,2 WAS BE TO L130C INSTEAD OF LI34C                
*                                                                               
* BPLA 6/94       SET VATPSW TO 'Y' AFTER PRINTING VATS IN PRTADJ               
*                                                                               
* BPLA 6/94       SPECIAL CODE AROUND SOME GOTO GETNUMS                         
*                                                                               
* BPLA 6/8/94     FIX BUG IN PRTADJ - SAVE R4 IN SAVER4 NOT FULL                
*                                                                               
* BPLA 2/94       CHANGES FOR PST                                               
*                                                                               
* BPLA 1/25/94    IN SPECIAL CD HANDLING LOGIC                                  
*                 REMOVE THE ADJUSTMENT (IF ITS ON A SEPARATE BILL)             
*                 FROM THE 'ACUTAL AMOUNT' DATA                                 
*                                                                               
* BPLA 1/20/94    ON ADJ SEP BILL FIX "AMOUNT BILLED ON INVOICE" MESS.          
*                 CHECK LENGTH OF LASTPINV                                      
*                                                                               
* BPLA 10/18/93   NEW VALUES FOR RETPROF+13                                     
*                 "Y" = (OLD) SUPPRESS DISTRB ADJ AMTS (AMT DUE ONLY)           
*                 "I" = SUPPRESS $ ON DISTRIBUTOR BILLS (TOTOUT)                
*                 "B" = SUPPRESS $ ON DISTB BILLS AND NO ADJ AMTS               
*                                                                               
* BPLA 10/5/93    CHANGES FOR NEW CDSEP OPTION - R -                            
*                 USES APPLY INSTEAD OF DEDUCT IN CD MESSAGE                    
*                 PP@ACASH FOR PP@DCASH AND MAKES POSITIVE CD'S                 
*                 CR'S.                                                         
*                                                                               
* BPLA 10/1/93    CHANGES TO PRTUSER - IF PRD NOT "S"                           
*                 THE FIND AND PRINT PRD "AAA" USER FIELDS                      
*                 ALSO, IF PRD NOT "S" AND EST IS "S"                           
*                 THEN FIND AND PRINT "AAA" EST USER FIELDS                     
*                                                                               
* BPLA 9/30/93    CHANGE TO PP#GSTAC - 9 CHARS INSTEAD OF 15                    
*                                                                               
* BPLA 9/29/93   IN PRTADJ ADJUST DISPLACEMENT (SAVED IN WORD)                  
*                IF NOT AT END OF INVOICE - SO GST MESSAGE WON'T                
*                WRAP AROUND INTO PRIOR PRINT LINE                              
*                                                                               
* BPLA 5/10/93   DISPLAY USER FIELDS WITH COMMENTS                              
*                                                                               
* BPLA 4/7/93    USE FORMULA EVEN FOR FINANCIAL REBATE BILLING                  
*                BUT SET TO GROSS IF I HAVE NONE                                
* BPLA 3/4/93    NO-OP CODE THAT SET BILLING FORMULA TO                         
*                GROSS FOR REBATE BILLS IN BILLCALC                             
*                                                                               
* BPLA 1/7/93    NEW PROFILE BTYE (PROFB2B+4) TO CONTROL                        
*                CD ON NET BILL                                                 
*                                                                               
* BPLA 12/21/92  CD SEP CONTROL FOR UFC BILLING                                 
*                                                                               
* BPLA 10/23/92  BUG FIXED IN PRTADJ (PA27A18C)  *+12 TO *+14                   
*                                                                               
* BPLA 8/4/92    NEW RETAIL DISTRIBUTOR BILL OPTIONS                            
*                1) SELECTIVELY SUPPRESS COMMENTS (RETPROF+10)                  
*                2) OPTIONALLY SUPPRESS BILL DETAILS (RETPROF+13)               
*                                                                               
* BPLA 7/9/92    CHANGES TO CHECK PBBILST (IN PBILELEM) FOR UFC                 
*                INSTEAD OF X'46' ELEMS                                         
*                                                                               
* BPLA 6/16/92   ADD CHK FOR SCBNCSW = C'N' IN AORINV                           
*                AT PA21 ADD CHK FOR SCBNCSW = C'C'                             
*                                                                               
* BPLA 4/30/92   CHANGES FOR COMMISSION BILLING                                 
*                                                                               
* BPLA 4/20/92   COPY OF PPB12DL                                                
*                                                                               
* BPLA 2/6/92    FIX BUG IN AORINV - MUST BUMP INVNO AT AOI80 IF                
*                AORLOPT IS "C"                                                 
* BPLA 1/28/92   REACTIVATE DISPLAY OF GST PCTS ON AOR PRD/EST                  
*                LIST BILL - CAN DO SINCE THEY WILL HAVE SAME CODE              
*                                                                               
* BPLA 1/20/92   IN PRTADJ PRINT "AMOUNT DUE FOR" IF PRDS                       
*                TOGETHER WITH GST CODE                                         
*                ALSO SUPPRESS PRINTING OF GST %                                
*                                                                               
* BPLA 10/25/91  CLEAR P2 AND P3 WHEN DOING INV TOTALS (EI4X)                   
*                                                                               
* BPLA 10/17/91  FIX RETAIL GST SHARE CALC                                      
*                                                                               
* BPLA 7/22/91   FIX "BILLED TO.... " INVOICE NUMBER DISPLAY ON OLD             
*                STYLE  AOR BILL                                                
* BPLA 7/8/91    FIX RETAIL TAX BUG                                             
* BPLA 7/8/91    IN SAVCORP DON'T MOVE AC INTO SORTDATA                         
*                NOW MOVE TAX                                                   
*                CHANGE TO BILCALC (BC7D) TO STORE CALCULATED TAX               
*                SHARE AND NOT TO CALUCLATE IF UPASS = S (NOW X'FF')            
*                                                                               
* BPLA 6/13/91   FIX TO PPSIF01 LOGIC + PP@DCASH NOW 26 CHARS                   
*                                                                               
* BPLA 5/17/91   AOR KILL DATE AND VAT CODE CHANGES                             
*                PLUS BILLING FORMULA DISPLAY OVERRIDE FIELDS                   
*                BILPADJ AND BILPBASB (USED JUST TO PRINT ON BILL               
*                NOT FOR CALCULATION)                                           
*                                                                               
* BPLA 5/2/91    CHANGES INVOLVING PPSIF01,PP@IF01,PP@LESS                      
*                                                                               
* BPLA 3/26/91   DRAFT REBATE BILLING  (RD)                                     
*                                                                               
* BPLA 3/12/91   NEW AOR FEATURES AORLOPT (C) AND AORTXOPT                      
*                                                                               
* BPLA 9/7/90    DON'T DISPLAY CD MESSAGES IF F BFBASIS AGYCOMM                 
*                                                                               
*                ALSO SHOW "**ACTUAL AMOUNT**' EVEN IF CD IS IN                 
*                BFBASA AND  CD IS CREDIT                                       
*                                                                               
*                                  ENDINV - END OF INVOICE                      
***      PRINT NOGEN                                                            
         SPACE 2                                                                
ENDINV   NMOD1 0,ENDINV                                                         
         USING PPWORKD,RA                                                       
         L     R9,PPWORK2C                                                      
         USING PPWORK2D,R9                                                      
         LA    RC,SPACEND                                                       
         USING BILWRKD,RC                                                       
         USING BRKTABD,R3                                                       
         SPACE 2                                                                
*                                                                               
*              MUST STILL GO TO BILCALC                                         
*              ON SECOND PASS - IF DOING ADJSEP AND DETAIL RECAP                
*                                                                               
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)        POINT TO ACCUM                               
         AH    R7,=Y(MAXMOS*ROWL)  POINT TO TOTAL ROW                           
**NEW 10/27/89  WAS (16) NOW (40)                                               
         OC    ADJDSP(8,R7),ADJDSP(R7)  TEST FORMULA CALCS DONE                 
         BNZ   EI4                 YES                                          
         OC    AORDSP(8,R7),AORDSP(R7)  TEST FORMULA CALCS DONE - AOR           
         BNZ   EI4                 YES                                          
         OC    RETADSP(72,R7),RETADSP(R7) TEST FORMULA CALCS DONE - RET         
         BNZ   EI4                 YES                                          
         OC    VATDSP(176,R7),VATDSP(R7) TEST FORMULA CALCS DONE - VATS         
         BNZ   EI4                 MAIN,ADJ,AOR,CD (44 BYTES EACH)              
         OC    VATBDSP(176,R7),VATBDSP(R7) TEST FORMULA CALCS - BASIS           
         BNZ   EI4                 MAIN,ADJ,AOR,CD (44 BYTES EACH)              
*                                  CKECKS AOR,RETAIL FIELDS,VAT FIELDS          
         BRAS  RE,BILCALC          NO - DO THEM NOW                             
EI4      DS    0H                                                               
*                                                                               
         MVC   SVFINSW,FINANSW     SAVE FINANCIAL SWITCH                        
*                                                                               
         OC    AMED,AMED           SEE IF DOING MULTI-MEDIA BILL                
         BZ    *+10                                                             
         MVC   FINANSW,FININVSW    USE INVOICE FINANCIAL SWITCH                 
*                                                                               
*                                                                               
         CLI   PASSNO,1                                                         
         BNE   EI8                                                              
         CLI   DUESW,C'Y'          TEST AMT DUE PRINTED                         
         BE    EI6                                                              
         CLI   TOTSW,C'Y'          TEST HAVE PRINTED INV TOTS                   
         BE    EI5                                                              
         CLI   NDUES,1             BYPASS REPEAT OF TOTALS IF                   
         BE    EI5                 EXACTLY 1 DUE LEVEL PRINTED                  
*                                                                               
         CLI   JOBCTL,C'S'                                                      
         BE    EI4C                                                             
         CLI   PUBCTL,C'S'                                                      
         BNE   EI4X                                                             
EI4C     CLC   P1(10),SPACES     IF JOB OR PUB SEPARATE                         
         BE    EI4X              MAY STILL NEED TO PRINT THEM                   
         GOTO1 =A(PRNT)                                                         
*                                                                               
EI4X     MVI   PRSW,C'H'           SET TO HOLD LINES                            
         MVC   P1,SPACES            P1,P2,P3  MIGHT STILL HAVE AN               
         MVC   P2,SPACES            UNUSED PRODUCT FOR RETAIL                   
         MVC   P3,SPACES                                                        
*                                                                               
*        SEE IF RETAIL                                                          
*        MUST CHECK IF I'M SUPPRESSING DISTRIBUTOR BILL DETAILS                 
*                                                                               
         CLI   RETPROF,0                                                        
         BE    EI4X9                                                            
         CLI   RETPROF+13,C'Y'   SEE IF SUPPRESSING DISTRIB DETAILS             
         BE    EI4X7                                                            
         CLI   RETPROF+13,C'B'   SEE IF SUPPRESSING DISTRIB DETAILS             
         BNE   EI4X9             AND $                                          
EI4X7    CLI   UPASS,1         SEE IF CORP                                      
         BE    EI4X9                                                            
         CLI   UPASS,X'FF'     SEE IF CORP SUMMARY  - WAS C'S'                  
         BE    EI4X9                                                            
         B     EI5             MUST BE DISTRIBUTOR                              
*                                                                               
EI4X9    DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   P1(12),=C'** TOTALS **'                                          
         MVC   P1(L'PP@TOTS),PP@TOTS                                            
         DROP  RE                                                               
         MVC   TOTSTAR,=C'**'                                                   
         BRAS  RE,TOTOUT                                                        
         MVC   TOTSTAR,SPACES                                                   
EI5      DS    0H                                                               
*                                  TEST NEED TO SAVE CORP DATA NOW              
         CLI   SUMLEV,C'I'                                                      
         BE    EI5B                                                             
         CLI   SUMLEV,0                                                         
         BH    EI5D                ALREADY SAVED AT LOWER LEVEL                 
         MVI   SUMLEV,C'I'         CORP DATA SAVED AT INVOICE LEVEL             
EI5B     DS    0H                                                               
         BRAS  RE,SAVCORP                                                       
EI5D     DS    0H                                                               
         BRAS  RE,PRTADJ           NO - DO IT NOW                               
EI6      DS    0H                                                               
         MVI   CNMTCD,C'R'         PRINT REGULAR COMMENTS                       
         BRAS  RE,PRTCMNT                                                       
         BRAS  RE,WBILL            ADD OLD STYLE BILL RECS                      
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMEND',0)   EDI CALL                            
         CLI   OUTMODE,C'W'        FOR WORKER FILE MODE                         
         BNE   EI7                                                              
         GOTO1 ABILLEDI,DMCB,('EDMCLS',0)   CLOSE EDI FOR EACH INVOICE          
**EDI**                                                                         
*                                                                               
EI7      MVC   SINVNO(12),INVNO                                                 
         OC    ARECAP,ARECAP       FOR RECAP PASS                               
         BNZ   EI10                DONT BUMP INV NO                             
EI8      DS    0H                                                               
*                                                                               
         MVC   LASTPINV,PINVNO     SAVE INV NO FOR SEPARATE                     
***NEW 5/21/91                                                                  
***      ORDER OF BILLS CHANGED                                                 
***      WAS ADJ/CD/AOR                                                         
***      NOW AOR/ADJ/CD                                                         
***                                                                             
         CLI   AORSW,C'Y'                                                       
         BNE   EI9                                                              
         CLI   UPASS,1            IF RETAIL AND NOT "CORP" BILL                 
         BH    EI9                NO AOR BILL                                   
         MVI   AORLCTL,0                                                        
         BRAS  RE,AORINV                                                        
*                                                                               
EI9      DS    0H                                                               
         CLI   ADJSEP,C'Y'         ADJ OR CD INV                                
         BNE   EI9B                                                             
         BRAS  RE,ADJINV                                                        
*                                                                               
EI9B     DS    0H                                                               
         CLI   CDSEP,C'Y'                                                       
         BNE   EI9D                                                             
         BRAS  RE,CDINV                                                         
*                                                                               
EI9D     DS    0H                                                               
*                                                                               
*****    CLI   TESTFLAG,C'T'                                                    
*****    BE    EI10                                                             
         GOTOR GETNUM,DMCB,INVNO,PINVNO                                         
EI10     DS    0H                                                               
*                                                                               
         MVC   FINANSW,SVFINSW     RESTORE FINANSW                              
*                                                                               
         CLI   PASSNO,1            SEE IF PASS 1                                
         BNE   EI15                                                             
         OC    ARECAP,ARECAP       AND DOING DETAIL BACK-UP                     
         BZ    EI15                                                             
         JIF   ADJSEP,EQ,C'Y',OR,CDSEP,EQ,C'Y',OR,AORSW,EQ,C'Y',EI18,  +        
               JUMP=N                                                           
*                                                                               
*              CAN'T CLEAR PEPTAB IF DOING ADJSEP OR CDSEP OR AORINV            
*              WITH DETAIL BACK-UP                                              
*                                                                               
EI15     DS    0H                                                               
**NEW 3/12/91                                                                   
         CLI   AORLOPT,C'C'                                                     
         BE    *+10                                                             
**NEW 3/12/91                                                                   
         XC    PEPTABN,PEPTABN     CLEAR PEPTAB                                 
EI18     MVI   DUESW,C'N'                                                       
         MVI   TOTSW,C'N'                                                       
         MVI   SUMLEV,0                                                         
         MVI   ACTSW,C'Y'          SET ACTIVITY FOR REQ                         
***E***                                                                         
         CLC   QPROG,=C'E1'        ESTIMATE REPORT                              
         BE    *+10                DON'T RESET PAGE HERE                        
***E***                                                                         
         MVC   PAGE,=H'1'                                                       
         MVI   NDUES,0                                                          
         MVI   FORCEHED,C'Y'                                                    
         MVC   MKTCTL,SVMKTCTL                                                  
         XC    CVATPSWS,CVATPSWS                                                
         MVC   LASTPRD,=X'FFFFFF'                                               
*                                                                               
EIX      DS    0H                                                               
*                                  AT END OF INVOICE                            
         XIT1                                                                   
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'SAVCORP'                                                        
SAVCORP  NMOD1 0,SAVCORP                                                        
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   SUMOPT,C'Y'                                                      
         BNE   SAVCX                                                            
         CLI   UPASS,1             MUST BE RETAIL AND CORP                      
         BNE   SAVCX                                                            
*                                                                               
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)        POINT TO ACCUM                               
         LA    R4,MAXMOS                                                        
SAVC2    DS    0H                                                               
**8/29/88                                                                       
         OC    RETADSP(20,R7),RETADSP(R7) CHK FOR ADJ,GROSS,NET,CD,AC           
         BZ    SAVC3                       SKIP IF ALL ZEROS                    
**8/29/88                                                                       
**8/29/88 NO-OPED                                                               
**       L     R0,RETADSP(R7)                                                   
**       LTR   R0,R0                                                            
**       BZ    SAVC3                                                            
**8/29/88 NO-OPED                                                               
*                                                                               
         BAS   RE,SAVCW                                                         
*                                                                               
SAVC3    DS    0H                                                               
         LA    R7,ROWL(R7)         NEXT MONTH                                   
         BCT   R4,SAVC2                                                         
*                                                                               
         GOTO1 BUFFALO,DMCB,=C'HIGH',ABUFFC,THISREC,0                           
*                                                                               
*                                  SET PRD IN LIST FOR S PASS                   
         L     RE,APRD                                                          
         L     RF,=A(PDLIST)                                                    
*                                  FIND NEXT AVAILABLE ENTRY                    
SAVC4    CLI   0(RF),0                                                          
         BE    SAVC5                                                            
         CLC   0(3,RF),0(RE)       SEE IF PRODUCT ALREADY THERE                 
         BE    SAVCX                                                            
         LA    RF,3(RF)                                                         
         B     SAVC4                                                            
*                                                                               
SAVC5    MVC   0(3,RF),0(RE)       SAVE PRD IN ACTIVE PRD LIST                  
*                                  FOR RETAIL SUMMARY PASS                      
SAVCX    DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
SAVCW    NTR1                                                                   
*                                                                               
*                                                                               
*                                  THEN SAVE CURRENT INVOICE NUMBER             
*                                  IN BUFFALO TABLE                             
         L     R6,ABUFFC                                                        
         USING BUFFALOD,R6                                                      
         MVC   SORTREC,OLDREC      USE LAST RECORD                              
         LR    RF,R4                                                            
         SH    RF,=Y(MAXMOS)                                                    
         LPR   RF,RF                                                            
         L     RE,APER                                                          
         STC   RF,0(RE)                                                         
         L     RF,APUB                                                          
         XC    0(6,RF),0(RF)                                                    
*                                                                               
*                                                                               
         L     RF,ASORTCOM                                                      
         MVC   0(2,RF),TODAYB      YR/MTH                                       
         MVC   2(2,RF),INVNO       INV. NO.                                     
         L     RF,ASORTDTA                                                      
         XC    0(ROWTL,RF),0(RF)                                                
         MVC   0(16,RF),RETADSP(R7)  ACT,GROSS,NET,CD                           
*** NOTE THAT RETAIL AGY COMM SHARE IS NOT PASSED                               
         MVC   16(4,RF),RETTDSP(R7)    STORE RETAIL TAX SHARE                   
*                                      BILCALC FIXED TO NOT                     
*                                      RECALCULATE                              
         MVI   BUFFDOPT,C'Y'       SET TO REPLACE COMMENT                       
*                                                                               
         CLI   ESTQ,C'1'           SINGLE ESTIMATE REQUEST?                     
         BNE   SAVCW5                                                           
*                                                                               
         CLC   THISPER,CURPER      ANY CURRENT MTH DATA                         
         BNE   *+8                                                              
         MVI   CURSW,C'Y'          SET FOUND                                    
*                                  WILL BE CHECKED IN RDBUFF                    
*                                  FOR SOME OPTIONS                             
SAVCW5   BRAS  RE,TOSORT                                                        
         MVI   BUFFDOPT,C'N'                                                    
SAVCWX   DS    0H                                                               
         B     SAVCX                                                            
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'TOTOUT - PRINT TOTALS FOR LEVEL'                                
*                                                                               
TOTOUT   NMOD1 0,TOTOUT                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
*                                                                               
         CLI   WIOPT,C'Y'           WESTERN SUPPRESS $ OPTION                   
         BNE   TOUT1                                                            
         C     R3,AINVBRK           SEE IF AT END OF INVOICE                    
         BNE   TOUT2A              SAME AS PART OF RETAIL OPTION                
*                            SHOW INS DETAILS BUT NO OTHER TOTALS               
*                            AND NO COSTS                                       
TOUT1    DS    0H                                                               
         CLI   RETPROF,0            SEE IF RETAIL                               
         BE    TOUT2X                                                           
         CLI   RETPROF+13,C'I'      SEE IF SUPPRESSING $ ON DISTRB              
         BE    TOUT2                                                            
         CLI   RETPROF+13,C'B'     OR BOTH $ AND ADJ AMOUNTS                    
         BNE   TOUT2X                                                           
TOUT2    CLI   UPASS,1            SEE IF CORP BILL                              
         BE    TOUT2X                                                           
         CLI   UPASS,X'FF'      SEE IF CORP SUMMARY BILL  - WAS C'S'            
         BE    TOUT2X                                                           
*                                                                               
TOUT2A   CLI   BRKCODE+3,DESCEQ    SEE IF BUY DETAIL                            
         BNE   TOUT2C                                                           
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)           MUST PRINT THEM                               
         B     TOUTX              FLUSH PRINT LINES AND EXIT                    
*                                 MUST BE DISTRIBUTOR BILL                      
TOUT2C   MVC   P1,SPACES          CLEAR PRINT LINES AND EXIT                    
         MVC   P2,SPACES                                                        
         B     TOUTXX                                                           
*                                                                               
TOUT2X   DS    0H                                                               
***NEW                                                                          
         C     R3,AINVBRK          LEAVE ** FOR INVOICE TOTALS                  
         BE    TOUT3                                                            
         OC    ARECAP,ARECAP       SEE IF DOING BACK-UP                         
         BZ    TOUT3                                                            
         CLI   PASSNO,2                                                         
         BE    TOUT3                                                            
         MVC   TOTSTAR,SPACES      NO ** ON MAIN BILL IF DOING DETAIL           
*                                  BACK-UP                                      
***NEWEND                                                                       
*                                                                               
TOUT3    MVI   TOTSW,C'N'                                                       
         C     R3,AINVBRK                                                       
         BNE   *+8                                                              
         MVI   TOTSW,C'Y'          SET HAVE PRINTED INV TOTS                    
         MVI   PRSW,C'M'           SET TO 'MERGE UP' LINES                      
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)      POINT TO ACCUM                                 
         CLI   BRKCODE+3,DESCEQ                                                 
         BE    TOUT4               BUY DETAIL CAN ONLY BE ONE MTH               
*                                                                               
         CLI   PERCTL,C'T'                                                      
         BE    TOUT10                                                           
*                             SINGLE MONTH                                      
TOUT4    DS    0H                                                               
         AH    R7,=Y(MAXMOS*ROWL)         POINT TO TOTAL ROW                    
         L     RF,APER                                                          
         ZIC   R6,0(RF)                                                         
         MH    R6,=H'8'                                                         
*                                                                               
         ST    R6,PERLIND          SAVE DISPLACEMENT FOR EDI                    
*                                                                               
         LA    R6,INVLIST(R6)      POINT TO INV NO FOR THIS MONTH               
*                                                                               
         BAS   RE,TSET                                                          
         LA    R7,WK                                                            
*                                                                               
         CLI   MIDASSW,C'Y'           SEE IF GRP M MIDAS TRADE                  
         BNE   TOUT40                                                           
         C     R3,AINVBRK             MUST BE END OF INVOICE                    
         BNE   TOUT40                                                           
*                                                                               
*       ALTER OPEN GROSS AND NET TO REMOVE TRADE CREDITS                        
*       FOR PRINTING                                                            
*       DO I NEED TO STORE THEM?                                                
*                                                                               
*        R7 POINTS TO WK                                                        
*                                                                               
         L     RF,ROWTL(R7)            SHOULD BE OPEN GROSS ORD.                
         L     RE,ROWTL+20(R7)                                                  
         SR    RF,RE                                                            
         ST    RF,FULL                                                          
         MVC   ROWTL(4,R7),FULL                                                 
         L     RF,ROWTL+4(R7)         SHOULD BE OPEN NET                        
         L     RE,ROWTL+20(R7)                                                  
         SR    RF,RE                                                            
         ST    RF,FULL                                                          
         MVC   ROWTL+4(4,R7),FULL                                               
         L     RF,ROWTL+ROWHL(R7)     SHOULD BE OPEN GROSS PREV.                
         L     RE,ROWTL+20+ROWHL(R7)                                            
         SR    RF,RE                                                            
         ST    RF,FULL                                                          
         MVC   ROWTL+ROWHL(4,R7),FULL                                           
         L     RF,ROWTL+4+ROWHL(R7)   SHOULD BE OPEN NET PREV.                  
         L     RE,ROWTL+20+ROWHL(R7)                                            
         SR    RF,RE                                                            
         ST    RF,FULL                                                          
         MVC   ROWTL+ROWHL+4(4,R7),FULL                                         
*                                                                               
TOUT40   DS    0H                                                               
         B     TOUT40C                                                          
*                                                                               
TOUT40C  GOTOR FMTAMT,DMCB,(R7),(R6)                                            
TOUT40D  LA    RE,P1                                                            
         L     RF,=A(GRID)                                                      
         LA    R1,14               FOR BCT PLINES                               
         LA    R7,14               FOR AGRID                                    
TOUT4A   LR    R6,RE               FIND LAST NON-BLANK IN P LINE                
         LR    R5,RE                                                            
         LA    R0,132                                                           
TOUT4C   CLI   0(R5),C' '                                                       
         BNH   TOUT4D                                                           
         LR    R6,R5               SAVE ADDR                                    
TOUT4D   LA    R5,1(R5)                                                         
         BCT   R0,TOUT4C                                                        
*                                                                               
         SR    R6,RE               WILL HAVE DISPLACEMENT INTO                  
         LA    R6,1(R6)            ADD FOR ONE SPACE BETWEEN                    
         OC    AMED,AMED           IF DOING MULTI-MEDIA REQ                     
         BZ    TOUT4D2                                                          
         L     R5,AMED                                                          
         CLI   0(R5),C'N'                                                       
         BE    TOUT4D5                                                          
         B     TOUT4D3                                                          
*                                                                               
TOUT4D2  CLI   QMEDIA,C'N'                                                      
         BE    TOUT4D5                                                          
TOUT4D3  LA    R5,P1                                                            
         CR    R5,RE               SEE IF DOING FIRST P LINE                    
         BNE   *+8                                                              
         LA    R6,1(R6)            SO THERE WILL BE AT LEAST                    
*                                  2 SPACES BETWEEN SPACE AND ORDERED           
*                                  LINE OF LAST NON-BLANK                       
TOUT4D5  EX    R6,TOUT4E                                                        
         B     *+10                                                             
TOUT4E   CLC   0(0,RF),SPACES      SEE IF GRID ENTRY IS ALL SPACES              
         BE    TOUT5               UP TO LAST CHAR OF P LINE                    
TOUT4F   LA    RE,132(RE)           CAN'T USE THIS LINE IF DATA IN GRID         
         BCT   R1,TOUT4A                                                        
         B     TOUT8                                                            
*                                                                               
*                                                                               
TOUT5    OC    0(132,RE),0(RF)                                                  
         LA    RE,132(RE)                                                       
         LA    RF,132(RF)                                                       
         BCTR  R7,0                                                             
         BCT   R1,TOUT4A                                                        
         B     TOUT8                                                            
*                                                                               
TOUT8    DS    0H                                                               
         LR    R0,RF               MUST SAVE RF                                 
         GOTO1 =A(PRNT)                                                         
         LTR   R7,R7               SEE IF ALL OF GRID USED                      
         BNP   TOUT8C                                                           
         LR    RF,R0               RESTORE RF                                   
         CLC   0(132,RF),SPACES                                                 
         BE    TOUT8C          STILL NEEDED TO SKIP A LINE                      
         LA    R1,P1             I MUST PRINT REST OF GRID                      
TOUT8B   CLC   0(132,RF),SPACES                                                 
         BE    TOUT8C                                                           
         MVC   0(132,R1),0(RF)                                                  
         LA    R1,132(R1)                                                       
         LA    RF,132(RF)                                                       
         BCT   R7,TOUT8B                                                        
*                                                                               
TOUT8C   MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
TOUT8X   B     TOUTX                                                            
TOUT9    DS    0H                                                               
TOUT9B   DS    0H                                                               
         CLI   BRKCODE+3,PUBEQ                                                  
         BNL   *+8                                                              
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
         CLI   BRKCODE+3,PUBEQ                                                  
         BNL   TOUTXX              DONT FLUSH PRINT LINES                       
         B     TOUTX                                                            
*                             MULTI-MONTH                                       
TOUT10   DS    0H                                                               
***NEW                                                                          
***                            FOR MULTI-MONTH BILLS ONLY SHOW **               
***                            FOR TOTAL                                        
         MVC   DOUBLE(2),TOTSTAR   SAVE TOTSTAR                                 
         MVC   TOTSTAR,SPACES                                                   
***NEWEND                                                                       
         SR    R5,R5               R5 = INDEX INTO PERLIST                      
TOUT10A  DS    0H                                                               
*                                                                               
         ST    R5,PERLIND          SAVE DISP FOR EDI BILLING                    
*                                                                               
         LA    R6,P1                                                            
         LA    R4,11(R6)                                                        
         LR    RF,R4                                                            
         SH    RF,=H'2'                                                         
         CLC   0(10,RF),SPACES     SEE IF CAN PRINT ON SAME LINE                
         BE    TOUT10B                                                          
***E***                                                                         
         CLI   NOPMBRK,C'Y'        NO MONTHLY BREAK-OUT                         
         BE    TOUT10B                                                          
***E***                                                                         
         GOTO1 =A(PRNT)                                                         
TOUT10B  DS    0H                                                               
         LA    R2,PERLIST(R5)      POINT TO MONTH                               
         CLI   0(R2),X'FF'                                                      
         BNE   TOUT12                                                           
***NEW                                                                          
         MVC   TOTSTAR,DOUBLE     RESTORE TOTSTAR FOR TOTAL LINE                
***NEWEND                                                                       
***E***                                                                         
         CLI   NOPMBRK,C'Y'                                                     
         BE    TOUT11                                                           
***E***                                                                         
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   0(6,R4),=C'TOTAL*'                                               
         MVC   0(L'PP6TOTAL,R4),PP6TOTAL                                        
         DROP  RE                                                               
TOUT11   L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)                                                     
         AH    R7,=Y(MAXMOS*ROWL)         POINT TO TOTAL ROW                    
*                                                                               
         CLI   BRKCODE+3,PUBEQ  DON'T USE TOUTPK FOR THIS BREAK                 
         BE    TOUT11X          PUB MAY ONLY HAVE ONE MONTH                     
*                                                                               
         CLI   H7ATTSW,C'Y'                                                     
         BE    TOUTPK           USE BIGTOTS - PACKED                            
*                                                                               
TOUT11X  B     TOUT14                                                           
*                                                                               
TOUT12   DS    0H                                                               
         OC    0(ROWTL*2,R7),0(R7)    NO DATA                                   
         BZ    TOUT15                                                           
*                                                                               
***E***                                                                         
         CLI   NOPMBRK,C'Y'        NO MONTHLY BREAKOUT - SKIP                   
         BE    TOUT15              TO TOTALS                                    
***E***                                                                         
         GOTO1 DATCON,DMCB,(3,0(R2)),(6,0(R4))    NORMAL = MMMYY                
         B     TOUT14                                                           
TOUT13   DS    0H                                                               
         GOTO1 DATCON,DMCB,(2,2(R2)),(5,0(R4))    OTHER = MMMDD/YY              
TOUT14   DS    0H                                                               
*                                                                               
         BAS   RE,TSET                                                          
         LA    R0,INVLIST(R5)                                                   
         GOTOR FMTAMT,DMCB,WK,(R0)                                              
         LA    RE,P1                                                            
         L     RF,=A(GRID)                                                      
         LA    R1,14               FOR BCT                                      
TOUT14A  OC    0(132,RE),0(RF)                                                  
         LA    RE,132(RE)                                                       
         LA    RF,132(RF)                                                       
         BCT   R1,TOUT14A                                                       
         B     TOUT14P                                                          
*                                                                               
TOUT14P  DS    0H                                                               
         MVI   SPACING,2                                                        
TOUT14R  DS    0H                                                               
         GOTO1 =A(PRNT)                                                         
         CLI   0(R2),X'FF'                                                      
         BE    TOUTX                                                            
*                                                                               
TOUT15   DS    0H                                                               
         LA    R5,8(R5)            NEXT DATE                                    
         LA    R7,ROWL(R7)         NEXT DATA                                    
         B     TOUT10A                                                          
TOUTX    DS    0H                                                               
         MVI   PRSW,C'F'           SET TO FLUSH LINES                           
         GOTO1 =A(PRNT)                                                         
TOUTXX   DS    0H                                                               
         XIT1                                                                   
*                                                                               
TOUT20   DS    0H                                                               
         GOTOR FMTAMT,DMCB,(R7)                                                 
         LA    RE,P1                                                            
         L     RF,=A(GRID)                                                      
         LA    R1,14               FOR BCT                                      
TOUT20A  OC    0(132,RE),0(RF)                                                  
         LA    RE,132(RE)                                                       
         LA    RF,132(RF)                                                       
         BCT   R1,TOUT20A                                                       
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
         B     TOUTX                                                            
         SPACE 3                                                                
*                                                                               
TSET     DS    0H                                                               
*                                  CONTRACT AND OPEN                            
         MVC   WK(ROWTL),0(R7)                                                  
         MVC   WK+ROWTL(ROWTL),ROWTL(R7)                                        
*                                                                               
         BR    RE                                                               
*                                                                               
TOUTPK   DS    0H                  PACKED ROUTINE                               
*                                                                               
         LA    R0,INVLIST(R5)                                                   
         GOTOR PFMTAMT,DMCB,BIGTOTS,(R0)                                        
         LA    RE,P1                                                            
         L     RF,=A(GRID)                                                      
         LA    R1,14               FOR BCT                                      
TOUTPKA  OC    0(132,RE),0(RF)                                                  
         LA    RE,132(RE)                                                       
         LA    RF,132(RF)                                                       
         BCT   R1,TOUTPKA                                                       
         B     TOUTPKC             BY PASS THIS CODE                            
*                                                                               
TOUTPKC  LA    R1,12                                                            
         LA    RE,BIGTOTS           PACKED ACCUMS                               
TOUTPKD  ZAP   0(6,RE),=P'0'                                                    
         LA    RE,6(RE)                                                         
         BCT   R1,TOUTPKD                                                       
         B     TOUTPKP                                                          
*                                                                               
TOUTPKP  DS    0H                                                               
         MVI   SPACING,2                                                        
TOUTPKR  DS    0H                                                               
*                                                                               
         L     R3,SAVBRK             RESTORE BREAK CODE                         
         GOTO1 =A(PRNT)                                                         
         B     TOUTX                                                            
*                                                                               
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'PRTADJ - PRINT ADJUSTMENTS'                                     
PRTADJ   NMOD1 0,PRTADJ,R8                                                      
************************  NOTE USE OF R8 AS SECOND BASE REGISTER                
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         ST    R3,SAVBRK                                                        
*                                                                               
         CLI   PASSNO,1            ONLY PASS 1                                  
         BNE   PAX                                                              
**                                                                              
**       CODE BELOW FOR E1 REPORT NO-OPED FOR NOW                               
**       IF E1 EVER RELEASED WOULD NEED TO BE RE-INSTATED                       
**       NO-OPED NOW SO THAT I CAN ADDRESS SOME FIELDS                          
**       AT END OF THIS ROUTINE                                                 
**                                                                              
***E***                                                                         
*******  CLC   QPROG,=C'E1'                                                     
*******  BNE   PA01                                                             
*******  CLI   RETPROF,0                                                        
*******  BE    PAX                                                              
PA01     DS    0H                                                               
***E***                                                                         
         CLC   SAVBRK,AINVBRK      IF INV BRK                                   
         BE    PA2                                                              
         CLC   BORDSW(3),=C'YNN'   IF ORDERED ONLY FORMAT  PRINT                
         BNE   PA02                ADJ ONLY IF END OF INV                       
         CLI   RETDRAFT,C'Y'       UNLESS RETAIL DRAFT                          
         BNE   PAX                                                              
*                                                                               
PA02     DS    0H                                                               
         B     PA3                                                              
PA2      DS    0H                                                               
         MVI   DUESW,C'Y'          SET HAVE PRINTED AMOUNT DUE                  
         CLC   BORDSW(3),=C'YNN'      IF FORMAT (ORDERED ONLY)                  
         BNE   PA3                                                              
         BRAS  RE,LSTINV           NEED PREVIOUS BILLING                        
*                                                                               
PA3      DS    0H                                                               
**GST                                                                           
         MVI   VATPSW,C'N'                                                      
         MVI   BTDUET,C'N'  BEFORE CANADIAN TAX AMT DUE TRANSMITTED             
         MVI   PRSW,C'H'           SET TO HOLD PRINT LINES                      
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)           POINT TO ACCUM                            
         LR    R4,R7                                                            
         AH    R4,=Y(TOTSIZE-BFORML)                                            
         AH    R7,=Y(MAXMOS*ROWL)                                               
*                                                                               
         LA    R1,WKROW               PUT WHOLE ROW IN WKROW                    
         MVC   0(256,R1),000(R7)                                                
         MVC   256(256,R1),256(R7)                                              
         MVC   512(L'WKROW-512,R1),512(R7)                                      
*      REPLACES THESE THREE LINES                                               
*        MVC   WKROW+000(256),000(R7)      PUT WHOLE ROW IN WKROW               
*        MVC   WKROW+256(256),256(R7)                                           
*        MVC   WKROW+512(L'WKROW-512),512(R7)                                   
*                                                                               
**GST                                                                           
         USING BFORMD,R4                                                        
***E***                                                                         
***E***  NOW PRINT ADJ FOR RETAIL E1'S                                          
***E***                                                                         
**                                                                              
**       CODE BELOW FOR E1 REPORT NO-OPED FOR NOW                               
**       IF E1 EVER RELEASED WOULD NEED TO BE RE-INSTATED                       
**       NO-OPED NOW SO THAT I CAN ADDRESS SOME FIELDS                          
**       AT END OF THIS ROUTINE                                                 
**                                                                              
**       CLC   QPROG,=C'E1'        ON ESTIMATES - NO ADJUSTMENTS                
**       BNE   PA03                                                             
**       MVC   BFBASA(5),=X'0101000000'       SET BF TO GROSS                   
**       CLI   PROGPRO3,C'Y'                                                    
**       BE    PA03                                                             
**       MVC   BFBASA(5),=X'0202000000'       SET BF TO NET                     
**       CLI   PROGPRO3+1,C'Y'                                                  
**       BE    PA03                                                             
**       MVC   BFBASA(5),=X'0505000000'       SET BF TO GROSS-CD                
**       CLI   PROGPRO3+3,C'Y'                                                  
**       BE    PA03                                                             
**       MVC   BFBASA(5),=X'0606000000'       SET BF TO NET-CD                  
**       CLI   PROGPRO3+4,C'Y'                                                  
**       BE    PA03                                                             
**       MVC   BFBASA(5),=X'0101000000'       RESET TO GROSS                    
PA03     DS    0H                                                               
***E***                                                                         
         MVC   CVATSWS,BFVATSWS        VATABLE SWITCH                           
         DROP  R4                                                               
*                                  (O-NO,Y=YES,FF=MIXED)                        
         CLI   FINANSW,0           SEE IF FINANCIAL CLIENT                      
         BE    PA3A0                                                            
***R***                                                                         
         CLC   QPROG,=C'R1'       SEE IF FINANCIAL REBATE BILLING               
         BE    PA3A0              TREAT LIKE NON-FINANCIAL                      
         CLC   QPROG,=C'RD'  SEE IF FINANCIAL REBATE BILLING DRAFT              
         BE    PA3A0              TREAT LIKE NON-FINANCIAL                      
***R***                                                                         
         MVC   WKROW(ROWTL),ROWTL(R7) MOVE OPEN TO WKROW                        
         MVC   WKROW+ADJDSP(8),OADJDSP(R7) MOVE OPEN ADJ AND DUE                
*                                                                               
PA3A0    DS    0H                                                               
         LA    R7,WKROW                                                         
*                                                                               
***                           NOTE THAT R4 POINTS TO BILL FORMULA               
***                                                                             
         USING BFORMD,R4                                                        
         LA    R2,P1                                                            
         CLI   BDOLNUM,1                                                        
         BNE   PA3A2                                                            
         CLI   BTYPNUM,1                                                        
         BNE   PA3A2                                                            
PA3A     DS    0H                                                               
         SH    R2,=H'16'      SHIFT SINGLE COL. FORMATS LEFT 1 COL.             
PA3A2    DS    0H                                                               
         USING ALINED,R2                                                        
*                                                                               
         CLI   ALDESC,X'40'   ANYTHING IN THERE?                                
         BH    *+10                                                             
         XC    ALDESC,ALDESC  IF NOT, CLEAN IT UP                               
*                                                                               
         CLC   SAVBRK,AINVBRK      IF AT END OF INVOICE                         
         BNE   PA3B                                                             
***                                                                             
         CLI   RCMULTIQ,C'Y'       SEE IF MULTI-MEDIA REQUEST                   
         BNE   PA3A4               REPEAT FORMULA + AMT DUE                     
         CLI   JOBCTL,C'S'         UNLESS JOBS SEPARATE                         
         BNE   PA3B                                                             
         CLC   MEDCNT,=F'1'        AND ONLY ONE MEDIA                           
         BNE   PA3B                                                             
*                                  STILL FALL THRU TO CHECK NDUES               
***                                                                             
PA3A4    CLI   NDUES,1             AND EXACTLY 1 DUE LEVEL PRINTED              
         BE    PA20                DO NOT REPEAT FORMULA                        
PA3B     DS    0H                                                               
*                                                                               
*                                  STATE BASIS IF NOT ON BILL                   
         CLI   UPASS,X'FF'     NO FORMULAS ON SUMMARY BILL - WAS C'S'           
         BE    PA20                                                             
*                                                                               
         CLI   RETPROF+13,C'Y'     SEE IF SUPPRESSING DISTRIB DETAILS           
         BE    PA3B2                                                            
         CLI   RETPROF+13,C'B'     SEE IF SUPPRESSING DISTRIB DETAILS           
         BNE   PA3B5               AND $                                        
PA3B2    CLI   UPASS,1             SEE IF CORP                                  
         BE    PA3B5                                                            
         B     PA20                DISTRIB - NO DETAILS                         
*                                                                               
PA3B5    CLI   BFBASA,X'FF'      CHECK FOR UNEQUAL BASES                        
         BNE   PA3B8                                                            
*                                                                               
         JIF   BDOLNUM,EQ,1,AND,BTYPNUM,EQ,1,PA3B6,JUMP=N                       
         B     PA20                SKIP TO AMOUNT DUE                           
*                                                                               
*                                                                               
PA3B6    LA    R2,16(R2)           RESET TO LAST COLUMN                         
         B     PA20                SKIP TO AMOUNT DUE                           
*                                                                               
PA3B8    DS    0H                                                               
         OC    BFBASA(5),BFBASA                                                 
         BNZ   PA3C                                                             
         MVC   BFBASA(2),=X'0505'  SET DEFAULT     G-CD                         
***R***                                                                         
         CLC   QPROG,=C'R1'        SEE IF FINANCIAL REBATE                      
         BNE   *+10                                                             
         MVC   BFBASA(2),=X'0101'  DEFAULT TO GROSS                             
         CLC   QPROG,=C'RD'        SEE IF FINANCIAL REBATE DRAFT                
         BNE   *+10                                                             
         MVC   BFBASA(2),=X'0101'  DEFAULT TO GROSS                             
***R***                                                                         
*                                                                               
PA3C     CLI   CDSEP,C'Y'          SEE IF DOING CD SEP                          
         BNE   *+8                                                              
         NI    BFBASA,X'FB'        IF SO SET OFF CD IN BASE                     
*                                                                               
         CLI   PROFB2B+4,C'Y'      SEE IF CD IS ON NET BILL                     
         BNE   PA3C7                                                            
*                                                                               
         CLI   SCBNCSW,C'C'        SEE IF DOING COMMISSION BILL                 
         BNE   PA3C7                                                            
         NI    BFBASA,X'FB'        IF SO SET OFF CD IN BASE                     
*                                                                               
PA3C7    DS    0H                                                               
*                                                                               
         MVC   TBASA,BFBASA       TEMPORARY BASIS                               
*                                  SEE IF BASIS ON BILL                         
         CLI   CDSEP,C'R'         CD HANDLING WITH 'APPLY'                      
         BE    PA3C7C                                                           
         CLI   CDSEP,C'C'         CHK FOR SPECIAL CD HANDLING                   
         BNE   PA3D               IF NO ONLY SHOW BASE IF NOT ON BILL           
*                                                                               
PA3C7C   DS    0H                                                               
         NI    TBASA,X'FB'        IF SO SET OFF CD IN BASE                      
*                                                                               
         OC    BFCOMP,BFCOMP      FIRST CHECK FOR ADJUSTMENT                    
         BZ    PA3C7E                                                           
         CLI   ADJSEP,C'Y'        OR ADJ IS ON SEPARATE INVOIVE                 
         BE    PA3C7E                                                           
         B     PA4                SHOW BASE                                     
*                                                                               
PA3C7E   DS    0H                                                               
*                                                                               
PA3D     CLI   ORDSW+2,C'Y'        MUST BE SHOWING BILLABLE                     
         BNE   PA4                                                              
         LA    R5,BASISTAB                                                      
         MVC   BASISTAB(12),=X'01000200050006000800FFFF'                        
         MVC   1(1,R5),FORMAT      GROSS                                        
         MVC   3(1,R5),FORMAT+1    NET                                          
         MVC   5(1,R5),FORMAT+3    GROSS-CD                                     
         MVC   7(1,R5),FORMAT+4    NET-CD                                       
         MVC   9(1,R5),FORMAT+5    AGY COMM                                     
PA3F     CLI   0(R5),X'FF'         END OF TABLE                                 
         BE    PA4                                                              
         CLC   TBASA(1),0(R5)                                                   
         BE    PA3H                                                             
         LA    R5,2(R5)                                                         
         B     PA3F                                                             
*                                                                               
PA3H     CLI   1(R5),C'Y'                                                       
         BNE   PA4                                                              
*                                                                               
*   IF ONLY ONE TYP AND CAT - I CAN SKIP TO PRINT ADJ                           
*                                                                               
         JIF   BDOLNUM,EQ,1,AND,BTYPNUM,EQ,1,PA3K,JUMP=N                        
         OC    BFCOMP,BFCOMP       CHK FOR ADJ                                  
         BZ    PA20                SKIP TO AMOUNT DUE                           
         CLI   ADJSEP,C'Y'         OR ADJ ON SEPARATE INV                       
         BE    PA20                SKIP TO AMOUNT DUE                           
         B     PA4                 BASIS IS ON BILL BUT THERE IS AN ADJ         
*                                  THEN RESTATE BASIS                           
*                                                                               
*                                                                               
PA3K     LA    R2,16(R2)           RESET TO LAST COLUMN                         
         B     PA8                                                              
*                                                                               
*                                  BASIS NOT ON BILL                            
PA4      DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   ALCOL4-11(10),=C'NET AMOUNT'                                     
         MVC   ALCOL4-12(L'PP@NAMT),PP@NAMT                                     
         LA    R5,NDSP(R7)                                                      
         TM    TBASA,X'02'                                                      
         BZ    PA5                                                              
         TM    TBASA,X'04'        SEE IF SUBTRACTING CD                         
         BZ    PA6                                                              
*--->    MVC   ALCOL4-19(18),=C'NET LESS CD AMOUNT'                             
         MVC   ALCOL4-21(L'PP@NLCA),PP@NLCA                                     
         B     PA6                                                              
PA5      DS    0H                                                               
*--->    MVC   ALCOL4-20(19),=C'AGENCY COMM. AMOUNT'                            
         MVC   ALCOL4-25(L'PP@AGYCA),PP@AGYCA                                   
         LA    R5,ADSP(R7)                                                      
         TM    TBASA,X'08'                                                      
         BZ    PA5C                                                             
         B     PA6                AGY COMM-CD NOT ALLOWED                       
*                                                                               
PA5C     DS    0H                                                               
         MVC   ALCOL4-25(5),SPACES                                              
*                                                                               
*--->    MVC   ALCOL4-20(19),=C'       GROSS AMOUNT'                            
         MVC   ALCOL4-20(L'PPRGRSAM),PPRGRSAM                                   
         LR    R5,R7                                                            
         TM    TBASA,X'01'                                                      
         BZ    PA6                                                              
         TM    TBASA,X'04'                                                      
         BZ    PA6                                                              
*--->    MVC   ALCOL4-21(20),=C'GROSS LESS CD AMOUNT'                           
         MVC   ALCOL4-22(L'PP@GRSCD),PP@GRSCD                                   
         DROP  RE                                                               
PA6      DS    0H                                                               
         L     R0,0(R5)                                                         
         TM    TBASA,X'04'    SEE IF SUBTRACTING CD                             
         BZ    PA7                                                              
         S     R0,CDSP(R7)                                                      
         A     R0,ROWHL+CDSP(R7)   PREV BILLED CD (G-CD)-(BG-BCD)               
PA7      S     R0,ROWHL(R5)        PREV BILLED                                  
*                                                                               
         CLI   MIDASSW,C'Y'        IF MIDAS                                     
         BNE   PA7X                                                             
         OC    BCTRDC,BCTRDC       CHECK FOR A TRADE CREDIT                     
         BZ    PA7X                                                             
**NO-OP  TM    TBASA,X'02'         SEE IF BILLING NET                           
**NO-OP  BZ    PA7X                THEY SHOULD BE BUT MAY BE GROSS              
         S     R0,BCTRDC           REMOVE TRADE CREDIT HERE                     
*                                                                               
PA7X     DS    0H                                                               
         BAS   RE,PAEDIT                                                        
         MVI   148(R2),0                                                        
         LA    R2,264(R2)                                                       
*                                                                               
*                             PRINT ADJUSTMENT LINE                             
*                             LESS (PLUS) XX.XXXX PERCENT OF GROSS(NET)         
*                                                                               
PA8      DS    0H                                                               
         OC    BFCOMP,BFCOMP       NO ADJUSTMENT                                
         BZ    PA20                                                             
         CLI   ADJSEP,C'Y'         ADJUSTMENT ON SEP INV                        
         BE    PA20                                                             
*                                                                               
         MVC   W,SPACES                                                         
         MVC   BYTE,BFCOMP         USE SIGN OF FORMULA                          
***                                                                             
***      NOTE - $FILE CHECKS TO BE SURE "SHOW AS" ADJ HAS SAME                  
***      SIGN AS REGULAR ADJ                                                    
***                                                                             
         CLC   BFCOMP,FFS          UNLESS UNEQUAL FORMULAS                      
         BNE   *+10                                                             
         MVC   BYTE,ADJDSP(R7)         THEN USE SIGN OF ADJ AMOUNT              
*                                                                               
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   W(4),=C'LESS'                                                    
         MVC   W(L'PP@LESS),PP@LESS                                             
         TM    BYTE,X'80'                                                       
         BNZ   *+16                                                             
*--->    MVC   W(4),=C'PLUS'                                                    
         MVC   W(L'PP@LESS),SPACES                                              
         MVC   W(L'PP@PLUS),PP@PLUS                                             
*                                                                               
*        MUST FLOAT "ADJUSTMENT" AFTER LESS OR PLUS                             
         LA    RF,W+5                                                           
PA8B     CLI   0(RF),C' '                                                       
         BH    PA8C                                                             
         BCT   RF,PA8B                                                          
PA8C     ST    RF,WORD                                                          
*                                                                               
*                                                                               
         CLI   PROFB1A+1,C'Y'      SEE IF ALWAYS PRINTING COMM ADJ              
         BE    PA8C6                                                            
*                                                                               
         CLI   PROFB1A+1,C'P'  SEE IF ALWAYS PRINTING AGENCY FEE                
         BE    PA8C7           (WITH PCT.)                                      
*                                                                               
         CLI   PROFB1A+1,C'A'  SEE IF ALWAYS PRINTING AGENCY FEE                
         BE    PA8C7           (WITHOUT PCT.)                                   
*                                                                               
         CLI   PROFB1A+1,C'T'  SEE IF ALWAYS PRINTING TECH FEE                  
         BE    PA8C5                                                            
*                                                                               
         CLC   BFCOMP,FFS                                                       
         BNE   PA8D                                                             
*                                                                               
*--->    MVC   W+5(10),=C'ADJUSTMENT'                                           
         MVC   2(L'PP@ADJUS,RF),PP@ADJUS                                        
         B     PA12                                                             
*                                                                               
PA8C5    DS    0H                                                               
         MVC   W(5),SPACES          CLEAR PLUS OR MINUS                         
         MVC   W+5(8),=C'TECH FEE'                                              
         B     PA12                                                             
*                                                                               
PA8C6    DS    0H                                                               
*--->    MVC   W(21),=C'COMMISSION ADJUSTMENT'                                  
         MVC   W(L'PP@CMADJ),PP@CMADJ                                           
         B     PA12                                                             
*                                                                               
*        IF PROFB1A+1 = A EXPRESSION WILL READ                                  
*****   "PLUS (OR LESS) AGENCY FEE NN.NNNN PCT."  *FIRST TRY*                   
*       "AGENCY FEE NN.NNNN%"                                                   
*                                                                               
PA8C7    DS    0H                                                               
         MVC   W(5),SPACES          CLEAR PLUS OR MINUS                         
*******  MVC   W+5(10),=C'AGENCY FEE'                                           
         MVC   W(L'PP@AGYF),PP@AGYF                                             
*                                                                               
         CLI   PROFB1A+1,C'A'          SEE IF NOT SHOWING PCT.                  
         BE    PA12                                                             
*                                                                               
         CLC   BFCOMP,FFS              SEE IF MIXED PERCENTAGES                 
         BE    PA12                    DON'T DO PERCENTAGE                      
         MVI   CURTAB+3,4                                                       
******** CURED (B3,BFCOMP),(8,W+16),CURTAB                                      
         CURED (B3,BFCOMP),(8,W+19),CURTAB                                      
         MVI   CURTAB+3,2                                                       
         LA    RF,W+26                                                          
PA8C7B   DS    0H                                                               
         CLI   0(RF),C'0'                                                       
         BNE   *+12                                                             
         MVI   0(RF),C' '                                                       
         BCT   RF,PA8C7B                                                        
*                                                                               
         CLI   0(RF),C'.'                                                       
         BNE   PA8C7C                                                           
         MVI   0(RF),C' '                                                       
         BCTR  RF,R0                                                            
         B     PA8C7X                                                           
*                                                                               
PA8C7C   CLI   0(RF),C','            FOR THOSE COUNTRIES THAT USE ,             
         BNE   PA8C7X                FOR DECIMAL POINT                          
         MVI   0(RF),C' '                                                       
         BCTR  RF,R0                                                            
*                                                                               
**8C7X   MVC   2(4,RF),=C'PCT.'      *FIRST TRY*                                
PA8C7X   MVI   2(RF),C'%'                                                       
         B     PA12                                                             
*                                                                               
         DROP  RE                                                               
*                                                                               
PA8D     MVI   CURTAB+3,4                                                       
*--->    EDIT  (B3,BFCOMP),(7,W+5),4                                            
***NEW 5/20/91                                                                  
         OC    BFPCOMP,BFPCOMP         CKECK IF PRINTING ANOTHER PCT            
         BNZ   PA8H                                                             
***NEW 5/20/91                                                                  
         CURED (B3,BFCOMP),(8,2(RF)),CURTAB                                     
         MVI   CURTAB+3,2                                                       
         L     RF,WORD                                                          
         LA    RF,9(RF)        WAS W+11                                         
         B     PA9                                                              
*                                                                               
***NEW 5/20/91                                                                  
PA8H     DS    0H                                                               
         CURED (B3,BFPCOMP),(8,2(RF)),CURTAB                                    
         MVI   CURTAB+3,2                                                       
         L     RF,WORD                                                          
         LA    RF,9(RF)        WAS W+11                                         
         B     PA9                                                              
***NEW 5/20/91                                                                  
*                                                                               
PA9      DS    0H                                                               
         CLI   0(RF),C'0'                                                       
         BNE   *+12                                                             
         MVI   0(RF),C' '                                                       
         BCT   RF,PA9                                                           
*                                                                               
         CLI   0(RF),C'.'                                                       
         BNE   PA9D                                                             
         MVI   0(RF),C' '                                                       
         BCTR  RF,R0                                                            
         B     PA9F                                                             
*                                                                               
PA9D     CLI   0(RF),C','            FOR THOSE COUNTRIES THAT USE ,             
         BNE   PA9F                  FOR DECIMAL POINT                          
         MVI   0(RF),C' '                                                       
         BCTR  RF,R0                                                            
*                                                                               
PA9F     L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   2(10,RF),=C'PERCENT OF'                                          
**OLD    MVC   2(L'PP@PCTOF,RF),PP@PCTOF                                        
         MVC   2(10,RF),=C'PERCENT OF'                                          
         CLI   RCLANG,4           SEE IF DOING FRENCH                           
         BNE   PA9F5                                                            
         MVC   2(14,RF),=C'POURCENTAGE DE'                                      
         LA    RF,4(RF)    MUST BUMP RF                                         
*                                                                               
***NEW 5/20/91   SEE IF PRINTING ANOTHER BASB                                   
PA9F5    MVC   BYTE,BFBASB                                                      
         CLI   BFPBASB,0                                                        
         BE    *+10                                                             
         MVC   BYTE,BFPBASB                                                     
***NEW 5/20/91              NOW CHECKS BYTE INSTEAD OF BFBASB                   
*                           ONLY CONTROLS WHAT PRINTS                           
*                           NOT THE CALCULATION                                 
*--->    MVC   13(3,RF),=C'NET'                                                 
         MVC   13(L'PP@NET,RF),PP@NET                                           
         SR    R0,R0                                                            
         CLI   BYTE,X'02'                                                       
         BE    PA10                                                             
*--->    MVC   13(5,RF),=C'GROSS'                                               
         MVC   13(L'PP@GROSS,RF),PP@GROSS                                       
         LA    R0,L'PP@GROSS-3                                                  
         CLI   BYTE,X'01'                                                       
         BE    PA10                                                             
*--->    MVC   13(10,RF),=C'AGY. COMM.'                                         
         MVC   13(L'PP@AGYCM,RF),PP@AGYCM                                       
         LA    R0,L'PP@AGYCM-3                                                  
         CLI   BYTE,X'08'                                                       
         BE    PA10                                                             
*--->    MVC   13(11,RF),=C'NET LESS CD'                                        
         MVC   13(L'PP@NETCD,RF),PP@NETCD                                       
         LA    R0,L'PP@NETCD-3                                                  
         CLI   BYTE,X'06'                                                       
         BE    PA10                                                             
*--->    MVC   13(13,RF),=C'GROSS LESS CD'                                      
         MVC   13(L'PP@GRSLC,RF),PP@GRSLC                                       
         LA    R0,L'PP@GRSLC-3                                                  
         DROP  RE                                                               
*                                                                               
PA10     DS    0H                                                               
*                      SEE IF NEED TAX IN ADJUSTMENT EXPRESSION                 
PA10X    CLI   TAXOPT,C'N'                                                      
         BE    PA12                                                             
         CLI   BFBASB,X'08'        SEE IF AGY COMM (REAL ADJ)                   
         BNE   PA10X8              NO                                           
         CLI   BFPBASB,0           SEE IF OVERRIDDING FORMULA                   
         BE    PA12                IF NOT - SKIP (LESS TAX) MESSAGE             
*                                                                               
*                                                                               
PA10X8   CLI   UPASS,X'FF'     NO TAX ON SUMMARY - WAS C'S'                     
         BE    PA12                                                             
         L     RE,TDSP(R7)                                                      
         S     RE,ROWHL+TDSP(R7)                                                
         BZ    PA12                NO TAX                                       
         AR    RF,R0              ADD DISPLACEMENT                              
*                                                                               
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   17(10,RF),=C'(LESS TAX)'                                         
         MVC   17(L'PP@LTAX,RF),PP@LTAX                                         
         DROP  RE                                                               
*                                                                               
PA12     DS    0H                                                               
         LA    RF,W+54        (WAS W+50 - NOW FRENCH MIGHT USE MORE)            
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R0,W                                                             
         SR    RF,R0               RF = LENGTH - 1                              
         LA    RE,ALCOL4-2                                                      
         SR    RE,RF                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),W                                                        
*                                                                               
         L     R0,ADJDSP(R7)                                                    
         BAS   RE,PAEDIT                                                        
         MVI   148(R2),0                                                        
         LA    R2,264(R2)                                                       
*                                                                               
*                                  PRINT AMOUNT DUE                             
*                                                                               
PA20     DS    0H                                                               
*                                                                               
         CLC   SAVBRK,AINVBRK                                                   
         BE    PA22                                                             
*                                                                               
         CLC   SAVBRK,APRDBRK      PRODUCT - MULTIPLE PRDS ON ONE BILL          
         BNE   PA21                                                             
         CLI   CVATCOD,0                                                        
         BNE   PA22                IF ALSO DOING GST                            
*                                  PRINT "AMOUNT DUE FOR"                       
PA21     DS    0H                                                               
         LA    R0,P1               IF NOT END OF INV                            
         CR    R2,R0               AND NO ADJ OR SPECIAL BASE                   
         BH    PA22                                                             
         CLI   SCBNCSW,C'C'        SEP COMMISION BILL                           
         BE    PA22                                                             
         B     PA27C                                                            
*                                                                               
PA22     DS    0H                                                               
*                                                                               
         CLI   RETPROF+13,C'Y'     SEE IF SUPPRESSING DISTRIB DETAILS           
         BE    PA22A                                                            
         CLI   RETPROF+13,C'B'     SEE IF SUPPRESSING DISTRIB DETAILS           
         BNE   PA22C               AND $                                        
*                                                                               
PA22A    CLI   UPASS,1             SEE IF CORP                                  
         BE    PA22C                                                            
         CLI   UPASS,X'FF'         SEE IF CORP SUMMARY - WAS C'S'               
         BE    PA22C                                                            
         B     PA27B               DISTRIB - NO DETAILS                         
*                                  SKIP TO SHARE DISPLAY                        
*                                                                               
PA22C    DS    0H                                                               
         L     R0,DUEDSP(R7)           DUE                                      
         CLI   ADJSEP,C'Y'         IF ADJ ON SEP INV                            
         BNE   PA24                                                             
         L     RF,ADJDSP(R7)           THEN PRINT DUE +/- ADJ HERE              
         SR    R0,RF                                                            
*                                                                               
PA24     DS    0H                                                               
*                                                                               
         JIF   CDSEP,NE,C'C',AND,CDSEP,NE,C'R',PA24B,JUMP=N                     
         OC    BFCOMP,BFCOMP     CHECK FOR ADJUSTMENT                           
         BZ    PA24B             NONE                                           
         TM    BFBASA,X'04'      SEE IF CD WAS SUBTRACTED ON "REAL"             
         BZ    PA24B             FORMULA                                        
         A     R0,CDSP(R7)         ADD CD BACK IN TO "AMOUNT DUE"               
         S     R0,ROWHL+CDSP(R7)   PREV BILLED CD (G-CD)-(BG-BCD)               
*                                                                               
PA24B    DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*                                                                               
         ST    R0,SVAMTDUE        SAVE AMT DUE TO PRINT AT END                  
*                                 OF INVOICE LIST                               
         MVC   W,SPACES                                                         
***E***                                                                         
         CLC   QPROG,=C'E1'        NO DUES FOR ESTIMATE                         
         BE    PA27AXX                                                          
***E***                                                                         
         LTR   R0,R0               TEST DUE POS OR NEG                          
         BM    PA24D               WAS PA26                                     
*                                  MIGHT NEED TO DUE MIDAS STUFF                
*                                                                               
         CLI   RETPROF,0           FOR RETAIL USE DIFFERENT WORDS               
         BE    PA24D                                                            
***                                                                             
         CLI   RETPROF+11,C'X'     NO SHOWING 'YOUR SHARE'                      
         BE    PA24D                                                            
***                                                                             
         CLI   UPASS,X'FF'         UNLESS SUMMARY PASS - WAS C'S'               
         BNE   PA25                                                             
PA24D    DS    0H                                                               
*                                                                               
*        FOR MIDAS SHOW TRADE CREDIT HERE AND SUBTRACT FROM                     
*        AMOUNT DUE                                                             
*                                                                               
         CLC   SAVBRK,AINVBRK         END OF INVOICE?                           
         BNE   PA24D1X                                                          
         CLI   MIDASSW,C'Y'                                                     
         BNE   PA24D1X                                                          
         OC    BCTRDC,BCTRDC     ANY BILLABLE TRADE CREDITS                     
         BZ    PA24D1X                                                          
         MVC   W(17),=C'LESS TRADE CREDIT'                                      
         L     RF,BCTRDC       SEE IF NEGATIVE                                  
         C     RF,=F'0'                                                         
         BNH   *+10                                                             
         MVC   W(4),=C'PLUS'                                                    
*                                                                               
         L     R0,SVAMTDUE                                                      
         A     R0,BCTRDC     ADD TO AMOUNT DUE                                  
         ST    R0,SVAMTDUE                                                      
*                                                                               
         LA    RF,W+36                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R1,W                                                             
         SR    RF,R1               RF = LENGTH - 1                              
         LA    RE,ALCOL4-2                                                      
         SR    RE,RF               RE = TO ADDR                                 
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),W                                                        
         L     R0,BCTRDC                                                        
         BAS   RE,PAEDIT                                                        
         MVI   148(R2),0                                                        
         LA    R2,264(R2)                                                       
         L     R0,SVAMTDUE                                                      
*                                                                               
PA24D1X  DS    0H                                                               
*                                                                               
         L     RE,=A(DICSECT)      MUST RESET RE                                
         AH    RE,=Y(DSLIST-DICSECT)                                            
         LTR   R0,R0               THIS CHECK WAS IN PA24B                      
         BM    PA26                SEE IF CREDIT AMT                            
*                                                                               
*--->    MVC   W(16),=C'** AMOUNT DUE **'                                       
         MVC   W(30),SPACES                                                     
         MVC   W(L'PP@AMDUE),PP@AMDUE                                           
**GST                                                                           
         CLI   CVATSW,0                 SEE IF VAT                              
         BE    PA24E                                                            
         CLI   SCBNCSW,C'C'            SCB COMMISSION BILL                      
         BNE   PA24D2                                                           
         MVC   W(L'PP@TAMT),PP@TAMT     CALL IT TOTAL AMOUNT                    
         B     PA24E                                                            
*                                                                               
PA24D2   DS    0H                                                               
         CLC   SAVBRK,AINVBRK         END OF INVOICE?                           
         BNE   PA24E                                                            
         MVC   W(19),=C'AMOUNT BEFORE TAX  '                                    
         CLI   RCLANG,4                FRENCH?                                  
         BNE   PA24E                                                            
         MVC   W(19),=C'MONTANT AVANT TAXES'                                    
*                                                                               
PA24E    DS    0H                                                               
         CLC   SAVBRK,AINVBRK                                                   
         BE    PA27                                                             
         CLI   SCBNCSW,C'C'            SCB COMMISSION BILL                      
         BE    PA24F                                                            
*                                                                               
*--->    MVC   W(15),=C'AMOUNT DUE FOR '                                        
         MVC   W,SPACES                                                         
         MVC   W(L'PP@ADFOR),PP@ADFOR                                           
         MVC   W+L'PP@ADFOR+1(12),TOTNAME      LEVEL NAME                       
         B     PA27                                                             
*                                                                               
PA24F    DS    0H                                                               
         MVC   W,SPACES                                                         
         MVC   W(L'PP@TLFOR),PP@TLFOR                                           
         MVC   W+L'PP@TLFOR+1(12),TOTNAME                                       
         B     PA27                                                             
*                                                                               
*                                                                               
PA25     DS    0H                  RETAIL TOTAL WORDS                           
         MVC   W,SPACES                                                         
*--->    MVC   W(18),=C'** TOTAL AMOUNT **'                                     
         MVC   W(L'PP@TAMT),PP@TAMT                                             
         CLC   SAVBRK,AINVBRK                                                   
         BE    PA27                                                             
*--->    MVC   W(10),=C'TOTAL FOR '                                             
         MVC   W,SPACES      RECLEAR W                                          
         MVC   W(L'PP@TLFOR),PP@TLFOR                                           
         MVC   W+L'PP@TLFOR+1(12),TOTNAME          LEVEL NAME                   
         B     PA27                                                             
PA26     DS    0H                                                               
*--->    MVC   W(19),=C'** CREDIT AMOUNT **'                                    
         MVC   W(L'PP@CDAMT),PP@CDAMT                                           
*                                                                               
         CLI   CVATSW,0                    ANY TAXES?                           
         BE    PA26AX                                                           
*                                                                               
         CLC   SAVBRK,AINVBRK         END OF INVOICE?                           
         BNE   PA26AX                                                           
         MVC   W(19),=C'AMOUNT BEFORE TAX  '                                    
         CLI   RCLANG,4                FRENCH?                                  
         BNE   PA26AX                                                           
         MVC   W(19),=C'MONTANT AVANT TAXES'                                    
*                                                                               
PA26AX   CLC   SAVBRK,AINVBRK                                                   
         BE    PA27                                                             
*--->    MVC   W(18),=C'CREDIT AMOUNT FOR '                                     
         MVC   W(L'PP@CAMFR),PP@CAMFR                                           
         MVC   W+L'PP@CAMFR+1(12),TOTNAME       LEVEL NAME                      
         DROP  RE                                                               
*                                                                               
PA26B    DS    0H                                                               
PA27     DS    0H                                                               
         CLC   SAVBRK,AINVBRK                                                   
         BE    PA27A2              IF NOT END OF INV                            
         ZIC   RF,NDUES            COUNT NO OF DUE LINES PRINTED                
         LA    RF,1(RF)       **** THIS CODE WAS AT PA02                        
         STC   RF,NDUES                                                         
*                                                                               
PA27A2   LA    RF,W+36                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R1,W                                                             
         SR    RF,R1               RF = LENGTH - 1                              
         LA    RE,ALCOL4-2                                                      
         SR    RE,RF               RE = TO ADDR                                 
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),W                                                        
**GST                                                                           
*                                                                               
PA27A3   DS    0H                                                               
         CLI   0(RE),C' '       SCAN FOR FIST CHARACTER                         
         BH    PA27A3C                                                          
         LA    RE,1(RE)                                                         
         B     PA27A3                                                           
*                                                                               
PA27A3C  LR    RF,RE                                                            
         SR    RF,R2                                                            
         ST    RF,WORD          SAVE DISPALCEMENT IN CURRECNT LINE              
*                               USED FOR GST MESSAGE                            
*                                                                               
         CLC   SAVBRK,AINVBRK     SEE IF AT END OF INVOICE                      
         BE    PA27A4                                                           
         AH    RF,=H'7'    ADJUST FOR TOTNAME - TO INSURE                       
         ST    RF,WORD     GST MESSAGE WON'T WRAP TO PRIOR LINE                 
***TAX                                                                          
PA27A4   CLI   TAXOPT,C'N'                                                      
         BE    PA27A8                                                           
         CLI   UPASS,X'FF'       NO TAX ON SUMMARY PASS - WAS C'S'              
         BE    PA27A8                                                           
*                                                                               
         L     RF,TDSP(R7)         ORDERED TAX                                  
         S     RF,ROWHL+TDSP(R7)   LESS BILLED TAX                              
         BZ    PA27A8              NO TAX                                       
*                                                                               
         CLI   TAXOPT,C'S'         SEE IF SUPPRESSING TAX MESSAGE               
         BE    PA27A8                                                           
*                                                                               
         ST    R0,FULL             SAVE AMT DUE                                 
         LR    R5,RE                                                            
         SH    R5,=H'28'                                                        
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   0(9,R5),=C'SALES TAX'                                            
         MVC   0(L'PP@STAX,R5),PP@STAX                                          
         DROP  RE                                                               
         ST    RF,DUB                                                           
         LA    R5,L'PP@STAX(R5)                                                 
*--->    EDIT  (RF),(12,11(R5)),2,COMMAS=YES,CR=YES,FLOAT=$,ALIGN=LEFT          
         CURED (RF),(12,2(R5)),CURTAB,COMMAS=YES,CR=YES,FLOAT=$,       X        
               ALIGN=LEFT                                                       
         L     RF,DUB                                                           
         L     R0,FULL            RESTORE AMT DUE                               
*                                                                               
***TAX                                                                          
PA27A8   DS    0H                                                               
         CLI   CDSEP,C'R'         CD HANDLING WITH 'APPLY'                      
         BE    PA27A8C                                                          
         CLI   CDSEP,C'C'          CHK FOR SPECIAL CD HANDLING                  
         BNE   PA27AX                                                           
*                                                                               
PA27A8C  DS    0H                                                               
         CLC   SAVBRK,AINVBRK      SEE IF AT END OF INVOICE                     
         BNE   PA27A9                                                           
***                                                                             
         CLI   RCMULTIQ,C'Y'       SEE IF MULTI-MEDIA REQUEST                   
         BNE   PA27A8D             MUST REPEAT FORUMLA AND AMT DUE              
         CLI   JOBCTL,C'S'         UNLESS JOBS SEPARATE                         
         BNE   PA27A9                                                           
         CLC   MEDCNT,=F'1'        AND ONLY ONE MEDIA                           
         BNE   PA27A9                                                           
*                                  STILL FALL THRU TO CHECK NDUES               
***                                                                             
PA27A8D  DS    0H                                                               
         CLI   NDUES,1             AND ONLY ONE DUE LEVEL PRINTED               
         BNE   PA27A9                                                           
         MVC   P1,SPACES                                                        
         LA    R2,P1                                                            
         B     PA27AXX             DON'T NEED TO PRINT ANYTHING                 
*                                                                               
*              CHK FOR ADJUSTMENT                                               
*              PRINT AMOUNT DUE IF ANY FORMULA                                  
PA27A9   MVI   BYTE,0                                                           
         OC    ADJDSP(4,R7),ADJDSP(R7)                                          
         BZ    PA27A10                                                          
         CLI   ADJSEP,C'Y'         OR ADJ ON SEPARATE INV                       
         BE    PA27A10                                                          
         ST    R0,SVAMTDUE        SAVE AMT DUE TO PRINT AT END                  
*                                 OF INVOICE LIST                               
         BAS   RE,PAEDIT                                                        
*                                                                               
         MVI   BYTE,1              SET AMT DUE PRINTED                          
         MVI   148(R2),0                                                        
         LA    R2,264(R2)                                                       
*                                                                               
PA27A10  B     PA27A12             ALWAYS DO WHAT I USED TO DO                  
*                                  ONLY IF CD WAS ON BILL                       
*                                  FOLLOWING CODE NOW SKIPPED                   
*                                                                               
**27A10  CLI   BFORMAT+2,C'Y'      SEE IF CD ON BILL                            
         BNE   PA27A12                                                          
         LTR   R0,R0               AND BILL IS POSTIVE                          
         BP    PA27A12                                                          
         CLI   BYTE,1              SEE IF AMT DUE PRINTED                       
         BE    PA27AXX             YES - DONE                                   
         B     PA27AX              NO - DO IT NOW                               
*                                                                               
PA27A12  L     R6,CDSP(R7)         CD                                           
         S     R6,ROWHL+CDSP(R7)   LESS PREV BILLED CD                          
         LTR   R6,R6                                                            
         BNZ   PA27A13             SEE IF ANY BILLABLE CD                       
*                                  NO                                           
         CLI   BYTE,1              SEE IF AMT DUE PRINTED                       
         BE    PA27AXX             YES - DONE                                   
         B     PA27AX              NO - DO IT NOW                               
*                                                                               
PA27A13  B     PA27A14             NOW ALWAYS DO WHAT I USED TO DO              
*                                  ONLY IF CD WAS NOT ON BILL                   
*                                  FOLLOWING CODE NO-OPED                       
*                                                                               
**27A13  CLI   BFORMAT+2,C'Y'      SEE IF CD ON BILL                            
         BNE   PA27A14                                                          
         LTR   R6,R6               CD MUST ALSO BE POSTIVE                      
         BP    PA27A14                                                          
         CLI   BYTE,1              SEE IF AMT DUE PRINTED                       
         BE    PA27AXX             YES - DONE                                   
         B     PA27AX              NO - DO IT NOW                               
*                                                                               
PA27A14  DS    0H                                                               
         CLI   ADJSEP,C'Y'         IF ADJ ON SEPARATE INV                       
         BE    PA27A15             TREAT LIKE NO ADJ                            
         OC    ADJDSP(4,R7),ADJDSP(R7)                                          
         BNZ   PA27A18                                                          
*        IF THERE IS AN ADJ I WILL ALREADY HAVE PRINT AMT DUE                   
*        (UNLESS ADJ ON SEPARATE INV)                                           
*                                                                               
PA27A15  TM    BFBASA,X'04'        SEE IF CD IN FORMULA                         
         BNZ   PA27A16             NO                                           
         BAS   RE,PAEDIT           FINALLY PRINT AMT DUE                        
         MVI   148(R2),0                                                        
         LA    R2,264(R2)                                                       
         B     PA27A18             NOW GO PRINT CD MSGS                         
*                                                                               
PA27A16  MVC   W,SPACES                                                         
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   W(18),=C'** GROSS AMOUNT **'                                     
         MVC   W(L'PP@B1GRS),PP@B1GRS                                           
         TM    BFBASA,X'01'                                                     
         BO    PA27A17                                                          
         MVC   W,SPACES                                                         
*--->    MVC   W(8),=C'  ** NET'                                                
         MVC   W(L'PP@B1NET),PP@B1NET                                           
         TM    BFBASA,X'02'                                                     
         BO    PA27A17                                                          
         MVC   W,SPACES                                                         
*--->    MVC   W(18),=C'** AGENCY COMM. **'                                     
         MVC   W(L'PP@B1AC),PP@B1AC                                             
         TM    BFBASA,X'08'                                                     
         BO    PA27A17                                                          
         DROP  RE                                                               
*                                                                               
         DC    H'0'                BAD FORMULA                                  
*                                                                               
PA27A17  AR    R0,R6               PUT CD BACK IN                               
         LA    RF,W+32                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R1,W                                                             
         SR    RF,R1               RF = LENGTH - 1                              
         LA    RE,ALCOL4-2                                                      
         SR    RE,RF               RE = TO ADDR                                 
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),W                                                        
         BAS   RE,PAEDIT                                                        
         MVI   148(R2),0                                                        
         LA    R2,264(R2)                                                       
*                                                                               
PA27A18  DS    0H                                                               
**GST                                                                           
**                           IF CDSEP=C OR R (SPECIAL CD HANDLING)              
**                           MUST DO VAT NOW                                    
**                                                                              
         CLI   CVATSW,0            IF VAT                                       
         BE    PA27A19                                                          
*                                                                               
         ST    R4,SAVER4           SAVE ADDR OF BILL FORMULA                    
*                                                                               
         GOTO1 =A(PRNT)            SKIP A LINE                                  
         LA    R3,ALCOL4-ALINED    COLUMN FOR VATS                              
         GOTO1 =A(VBPRNT),DMCB,(C'N',SAVBRK),(R3)       'NORMAL'                
*                                                                               
         MVI   VATPSW,C'Y'         SO I WON'T REPRINT                           
*                                                                               
         MVC   TOTVAT,20(R1)       SAVE PST TOTAL                               
         LA    R2,P1                                                            
*                                                                               
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
         L     R4,WORD                                                          
         AR    R4,R2                                                            
         MVC   0(L'PP@AMDUE,R4),PP@AMDUE                                        
*                                                                               
         CLI   RETPROF,0           IF RETAIL                                    
         BE    *+12                                                             
         L     R0,RETADSP(R7)                                                   
         B     PA27A18E                                                         
*                                                                               
         L     R0,DUEDSP(R7)       NON-RETAIL                                   
         CLI   ADJSEP,C'Y'         SEE IF DOING SEP COMM ADJ                    
         BNE   *+8                                                              
         S     R0,ADJDSP(R7)                                                    
         CLI   SCBNCSW,C'C'        SEE IF SCB COMMISSION BILL                   
         BNE   *+12                                                             
         S     R0,NDSP(R7)         THEN LESS NET                                
         A     R0,BNDSP(R7)        PLUS PREVIUOSLY BILLED NET                   
*                                                                               
PA27A18E DS    0H                                                               
         A     R0,TOTVAT           ADD TOTAL VAT                                
**EDI**                                                                         
*                                                                               
* NOTE - CVATSW WILL BE NON-ZERO IF I GET HERE                                  
*                                                                               
         ST    R0,ECTOTD                                                        
         GOTO1 ABILLEDI,DMCB,('EDMTDUE',0)                                      
         L     R0,ECTOTD                                                        
**EDI**                                                                         
         L     RE,=A(DICSECT)          RESET RE                                 
         AH    RE,=Y(DSLIST-DICSECT)                                            
*                                                                               
         LTR   R0,R0                                                            
         BNM   *+10                                                             
         MVC   0(L'PP@CDAMT,R4),PP@CDAMT                                        
*                                                                               
         DROP  RE                                                               
*                                                                               
         BAS   RE,PAEDIT                                                        
         MVI   148(R2),0                                                        
         LA    R2,264(R2)                                                       
*                                                                               
PA27A18G DS    0H                                                               
         CLC   SAVBRK,AINVBRK      IF AT END OF INVOICE                         
         BNE   PA27A18I                                                         
         ST    R0,SVAMTDUE         SAVE AMOUNT DUE (INCLUDING GST)              
*                                                                               
PA27A18I DS    0H                                                               
*                                                                               
         L     R4,SAVER4           RESTORE R4 TO BILL FORMULA                   
*                                                                               
PA27A19  DS    0H                                                               
*                                                                               
         TM    BFBASA,X'08'        SEE IF AGY COMM FORMULA                      
         BO    PA27AXX                                                          
*                                                                               
         LA    R5,ALCOL3-18                                                     
         CLI   BFORMAT+2,C'Y'      SEE IF CD ON BILL                            
         BNE   PA27A22                                                          
*                                                                               
         CLI   CDSEP,C'R'        SEE IF USING 'APPLY' CD MESSAGE                
         BE    PA27A22           DO SAME AS CD NOT ON BILL                      
*                                                                               
PA27A20  MVC   0(33,R5),SPACES                                                  
         LTR   R6,R6               IF NO CD THEN NO MESSAGE                     
         BZ    PA27AXX                                                          
         BM    PA27A24       SEE IF CD IS MINUS                                 
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   6(27,R5),=C'IF PAID BY DUE DATE, DEDUCT'                         
         BCTR  R5,0        MUST ALSO DECREMENT R5 SO I CAN                      
*                          FIT THE LONGER FRENCH PHRASE                         
*                                                                               
PA27A20B MVC   0(L'PP@IF01,R5),PP@IF01                                          
*              0 SINCE PP@IF01 IS NOW LONGER                                    
         DROP  RE                                                               
         DS    0H                                                               
         B     PA27A26                                                          
*                                                                               
*                                                                               
PA27A22  MVC   0(33,R5),SPACES                                                  
         LTR   R6,R6               IF NO CD THEN NO MESSAGE                     
         BZ    PA27AXX                                                          
         BM    PA27A24                                                          
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   13(20,R5),=C'IF PAID BY DUE DATE,'                               
*--->    MVC   132+13(20,R5),=C'DEDUCT CASH DISCOUNT'                           
         MVC   7(L'PPSIF01,R5),PPSIF01                                          
*                                                                               
*    BELOW CODE SHOULD SHOULD MOVE MESSAGE UNDER START OF PPSIF01               
*                                                                               
PA27A23  CLI   7(R5),C' '      SERACH FOR FIRST NON-SPACE                       
         BH    PA27A23B                                                         
         LA    R5,1(R5)                                                         
         B     PA27A23                                                          
*                                                                               
PA27A23B DS    0H                                                               
         CLI   CDSEP,C'R'    SEE IF USING 'APPLY' MESSAGE                       
         BNE   PA27A23C                                                         
         MVC   132+7(L'PP@ACASH,R5),PP@ACASH                                    
         B     PA27A23D                                                         
*                                                                               
PA27A23C MVC   132+7(L'PP@DCASH,R5),PP@DCASH                                    
         DROP  RE                                                               
PA27A23D DS    0H                                                               
         B     PA27A26                                                          
*                                                                               
PA27A24  DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   13(18,R5),=C'PLUS CASH DISCOUNT'                                 
*--->    MVC   132+13(19,R5),=C'PREVIOUSLY DEDUCTED'                            
         MVC   13(L'PP@PCASH,R5),PP@PCASH                                       
         MVC   132+13(L'PP@PRV03,R5),PP@PRV03                                   
         DROP  RE                                                               
         LR    R0,R6                                                            
         LCR   R0,R0                                                            
         B     PA27A28                                                          
*                                                                               
PA27A26  LR    R0,R6           POSITIVE CD'S GET HERE                           
*                                                                               
         CLI   CDSEP,C'R'      SEE IF USING 'APPLY' MESSAGE                     
         BNE   PA27A28                                                          
         LCR   R0,R0          MAKE CD NEGATIVE SO 'CR' WILL PRINT               
*                                                                               
PA27A28  BAS   RE,PAEDIT                                                        
         MVI   148(R2),0                                                        
         LA    R2,264(R2)                                                       
*                                                                               
*                                  SPECIAL FOR BJ                               
         TM    BFBASA,X'04'        ONLY IF CD NOT IN FORMULA                    
         BNZ   PA27A32                                                          
*******  CLI   BFORMAT+2,C'Y'      SEE IF CD ON BILL-CHK NO-OPED                
*******  BE    PA27AXX             PER BJ REQUEST 9/87                          
         LTR   R6,R6               AND CD IS CREDIT                             
         BNM   PA27AXX                                                          
         L     R0,DUEDSP(R7)                                                    
         CLI   ADJSEP,C'Y'         SEE IF ADJ IS ON SEPARATE BILL               
         BNE   *+8                                                              
         S     R0,ADJDSP(R7)                                                    
*                                                                               
         CLI   CVATSW,0            MUST ADD TOTVAT BEFORE                       
         BE    *+8                 SUBTRACTING CD TO RESTATE                    
         A     R0,TOTVAT           CORRECT AMOUNT DUE                           
*                                                                               
         SR    R0,R6               SUBTRACT CD                                  
**EDI**                                                                         
         CLI   CVATSW,0                                                         
         BE    PA28A28                                                          
*                                                                               
         ST    R0,ECTOTD                                                        
         GOTO1 ABILLEDI,DMCB,('EDMTDUE',0)                                      
         L     R0,ECTOTD                                                        
PA28A28  DS    0H                                                               
**EDI**                                                                         
         LA    R5,ALCOL3-5                                                      
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   0(19,R5),=C'** ACTUAL AMOUNT **'                                 
         MVC   0(L'PP@AAMT,R5),PP@AAMT                                          
         DROP  RE                                                               
         ST    R0,SVAMTDUE                                                      
         B     PA27AX                                                           
*                                                                               
PA27A32  DS    0H                                                               
         LTR   R6,R6               SEE IF CD IS CREDIT                          
         BNM   PA27AXX                                                          
         L     R0,DUEDSP(R7)                                                    
         CLI   ADJSEP,C'Y'         SEE IF ADJ IS ON SEPARATE BILL               
         BNE   *+8                                                              
         S     R0,ADJDSP(R7)                                                    
*                                                                               
         CLI   CVATSW,0            MUST ADD TOTVAT BEFORE                       
         BE    *+8                 SUBTRACTING CD TO RESTATE                    
         A     R0,TOTVAT           CORRECT AMOUNT DUE                           
*                                                                               
**EDI**                                                                         
         CLI   CVATSW,0                                                         
         BE    PA27A33                                                          
         ST    R0,ECTOTD                                                        
         GOTO1 ABILLEDI,DMCB,('EDMTDUE',0)                                      
         L     R0,ECTOTD                                                        
PA27A33  DS    0H                                                               
**EDI**                                                                         
         LA    R5,ALCOL3-5                                                      
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   0(19,R5),=C'** ACTUAL AMOUNT **'                                 
         MVC   0(L'PP@AAMT,R5),PP@AAMT                                          
         DROP  RE                                                               
         ST    R0,SVAMTDUE                                                      
         B     PA27AX                                                           
*                                                                               
PA27AX   BAS   RE,PAEDIT           R0 STILL HAS AMOUNT FROM PA22                
         TM    FLAG1,PARENTH  PUT CREDI AMT IN PARENTHESIS?                     
         BZ    PA27AXE                                                          
*                                                                               
         CLC   W(19),=C'** CREDIT AMOUNT **'                                    
         BNE   PA27AXE                                                          
*                                                                               
         LA    R1,ALCOL4X     END OF CREDIT AMOUNT                              
         CLI   0(R1),C' '     FIND FIRST NON-SPACE                              
         BH    *+8                                                              
         BCT   R1,*-8                                                           
*                                                                               
         SHI   R1,3           BACK UP THREE                                     
         CLC   0(2,R1),=C'CR' SHOULD BE CR                                      
         BE    *+6                                                              
         DC    H'0'                                                             
         MVI   0(R1),C')'          REPLACE WITH ")"                             
         MVI   1(R1),C' '                                                       
*                                                                               
         LA    R1,ALCOL4-1                                                      
         CLI   1(R1),C' '     FIND FIRST NON-SPACE                              
         BH    *+12                                                             
         LA    R1,1(R1)                                                         
         B     *-12                                                             
*                                                                               
         MVI   0(R1),C'('                                                       
*                                                                               
PA27AXE  LA    R2,132(R2)                                                       
*                                                                               
PA27AXX  DS    0H                                                               
*                                                                               
PA27B    DS    0H                                                               
         CLI   SCBNCSW,C'C'        SEE IF COMMISSION BILLING                    
         BNE   PA27C                                                            
*                                  SUBTRACT NET                                 
         L     R3,WORD             POSITION IN LINE                             
         AR    R3,R2                                                            
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
         MVC   0(L'PP@LESS,R3),PP@LESS                                          
         LA    R3,L'PP@LESS+1(R3)                                               
         MVC   0(L'PP@NET,R3),PP@NET                                            
*                                                                               
         DROP  RE                                                               
*                                                                               
         LA    R3,L'PP@NET+1(R3)                                                
         L     R0,NDSP(R7)     ORDERED NET                                      
         S     R0,BNDSP(R7)    (LESS PREV BILLED NET)                           
         BAS   RE,PAEDIT                                                        
         LA    R2,132(R2)                                                       
*                                                                               
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
         MVC   W,SPACES                                                         
         CLI   CVATSW,0                 IF HAVE VAT                             
         BE    *+14                                                             
         MVC   W(L'PP@CMAMT),PP@CMAMT   SAY 'COMMISSION AMOUNT'                 
         B     PA27B4                                                           
         MVC   W(L'PP@AMDUE),PP@AMDUE   ELSE AMOUNT DUE                         
         CLC   SAVBRK,AINVBRK           IF AT INV BRK                           
         BE    PA27B4                                                           
         MVC   W,SPACES                                                         
*--->    MVC   W(15),=C'AMOUNT DUE FOR '                                        
         MVC   W(L'PP@ADFOR),PP@ADFOR                                           
         MVC   W+L'PP@ADFOR+1(12),TOTNAME   LEVEL NAME                          
         DROP  RE                                                               
*                                                                               
PA27B4   DS    0H                                                               
         L     R3,WORD                                                          
         AR    R3,R2                                                            
         MVC   0(L'W,R3),W                                                      
         L     R0,DUEDSP(R7)    AMOUNT DUE                                      
         S     R0,NDSP(R7)     LESS NET                                         
         A     R0,BNDSP(R7)    (PLUS PREV BILLED NET)                           
         BAS   RE,PAEDIT           = COMMISSION                                 
         LA    R2,132(R2)                                                       
*                                  RETAIL BILLING SHARES                        
*                                                                               
PA27C    DS    0H                                                               
         CLI   RETPROF,0                                                        
         BE    PA27M                                                            
         CLI   UPASS,X'FF'           WAS C'S'                                   
         BE    PA27M                                                            
*                                                                               
***                                                                             
         CLI   RETPROF+11,C'X'        NO 'YOUR SHARE' MESSAGE                   
         BE    PA27M                                                            
***                                                                             
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
         LA    R5,W                                                             
         MVC   W,SPACES                                                         
*--->    MVC   0(19,R5),=C'YOUR SHARE OF TOTAL'                                 
         MVC   0(L'PP@YSOT,R5),PP@YSOT                                          
         CLC   SAVBRK,AINVBRK                                                   
         BE    *+10                                                             
         MVC   14(12,R5),TOTNAME                                                
         LA    R5,27(R5)                                                        
         CLI   0(R5),C' '                                                       
         BH    *+8                                                              
         BCT   R5,*-8                                                           
         LA    R5,2(R5)                                                         
         CLI   BFRETSHR,X'FF'      TEST MIXTURE OF SHR PCTS                     
         BE    PA27D                                                            
         CLI   RETPROF+11,C'Y'     PRINT PCTS                                   
         BNE   PA27D                                                            
*--->    EDIT  (B3,BFRETSHR),(6,0(R5)),2                                        
         CURED (B3,BFRETSHR),(6,0(R5)),CURTAB                                   
*--->    MVC   7(3,R5),=C'PCT'                                                  
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         MVC   7(L'PP@PCT,R5),PP@PCT                                            
         LA    R5,10(R5)                                                        
*                                                                               
PA27D    DS    0H                                                               
         L     R0,RETADSP(R7)                                                   
         LTR   R0,R0               TEST POS AMOUNT                              
         BM    PA27E               NO                                           
         CLC   SAVBRK,AINVBRK      TEST INV BREAK                               
         BNE   PA27E               NO                                           
***E***                                                                         
         CLC   QPROG,=C'E1'                                                     
         BE    PA27E              NO DUE FOR ESTIMATE                           
***E***                                                                         
         CLI   RETDRAFT,C'Y'                                                    
         BE    PA27E               NO DUE FOR RETAIL DRAFT                      
*                                                                               
*--->    MVC   4(16,R5),=C'** AMOUNT DUE **'                                    
**GST                                                                           
         CLI   CVATSW,0              SEE IF VAT                                 
         BNE   PA27E                                                            
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         MVC   4(L'PP@AMDUE,R5),PP@AMDUE                                        
         DROP  RE                                                               
*                                                                               
PA27E    DS    0H                                                               
         LA    R0,P1                                                            
         CR    R2,R0               TEST PRINTED ANY TOTALS YET                  
         BNH   PA27E2              NO                                           
         MVI   16(R2),0                                                         
         LA    R2,132(R2)          2 LINES                                      
*                                                                               
PA27E2   DS    0H                                                               
         LA    RF,W+55                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R0,W                                                             
         SR    RF,R0               RF = LENGTH - 1                              
         LA    RE,ALCOL4-2                                                      
         SR    RE,RF               RE = TO ADDR                                 
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),W                                                        
**GST                                                                           
         SR    RE,R2                                                            
         ST    RE,WORD        SAVE DISPLACEMENT INTO CURRENT LINE               
*                                                                               
         L     R0,RETADSP(R7)                                                   
         MVC   FULL,SVAMTDUE      SAVE REAL AMOUNT DUE                          
         ST    R0,SVAMTDUE        FOR $ SIGN OPTION WILL                        
         BAS   RE,PAEDIT                                                        
         MVC   SVAMTDUE,FULL       RESTORE REAL AMOUNT DUE                      
**GST                                                                           
         LA    R2,132(R2)                                                       
*                                  TEST IF RETAIL CALCS OK                      
         B     PA27P               ** NO-OP **                                  
         MVC   BYTE,DUEDSP(R7)                                                  
         XC    BYTE,RETADSP(R7)                                                 
         TM    BYTE,X'80'                                                       
         BZ    *+6                                                              
         DC    H'0'                SIGNS DIFFER                                 
         L     R0,DUEDSP(R7)                                                    
         L     R1,RETADSP(R7)                                                   
         LPR   R0,R0                                                            
         LPR   R1,R1                                                            
         CR    R1,R0                                                            
         BNH   *+6                                                              
         DC    H'0'                SHARE GREATER THAN TOTAL                     
*                                                                               
         B     PA27P                                                            
*                                                                               
PA27F    DS    0H                                                               
         DROP  R4                                                               
*                                                                               
PA27M    DS    0H                                                               
         LA    R0,P1                                                            
         CR    R2,R0               TEST ANYTHING TO PRINT                       
         BNH   PA28                NO                                           
*                                                                               
PA27P    DS    0H                                                               
         CLI   CVATSW,0            IF VAT                                       
         BE    PA27P6                                                           
         CLI   VATPSW,C'Y'          SEE IF VAT ALREADY PRINTED                  
         BE    PA27P6              YES - DON'T REDO                             
*                                                                               
**EDI**                                                                         
         MVI   BTDUET,C'Y'     BEFORE TAX AMOUNT DUE PRINTED                    
*                                                                               
         GOTO1 ABILLEDI,DMCB,('EDMDUE',(R4)),(R7)   EDI CALL                    
**EDI**                                                                         
         GOTO1 =A(PRNT)                                                         
         LA    R3,ALCOL4-ALINED     COLUMN FOR VAT                              
         GOTO1 =A(VBPRNT),DMCB,(C'N',SAVBRK),(R3)                               
         MVC   TOTVAT,20(R1)        SAVE TOTAL OF VATS                          
*                                                                               
         LA    R2,P1              RESET R2                                      
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*                                                                               
         ST    R4,SAVER4         SAVE ADDRESS OF BILLING FORMULA                
*                                                                               
         L     R4,WORD                                                          
         AR    R4,R2                                                            
         MVC   0(L'PP@AMDUE,R4),PP@AMDUE                                        
         CLI   RETPROF,0           IF RETAIL                                    
         BE    *+12                                                             
         L     R0,RETADSP(R7)                                                   
         B     PA27P3D                                                          
*                                                                               
         L     R0,DUEDSP(R7)                                                    
*                                                                               
         CLI   ADJSEP,C'Y'         IF SEP COMM ADJ                              
         BNE   *+8                                                              
         S     R0,ADJDSP(R7)       REMOVE ADJUSTMENT FROM MAIN BILL             
*                                                                               
         CLI   SCBNCSW,C'C'         COMMISSION BILL                             
         BNE   *+12                                                             
         S     R0,NDSP(R7)          THEN LESS NET                               
         A     R0,BNDSP(R7)         (PLUS PREV BILLED NET)                      
*                                                                               
PA27P3D  DS    0H                                                               
         A     R0,TOTVAT        ADD TOTAL OF VATS                               
**EDI**                                                                         
*                                                                               
* NOTE - CVATSW WILL BE NON-ZERO IF I GET HERE                                  
*                                                                               
         ST    R0,ECTOTD                                                        
         GOTO1 ABILLEDI,DMCB,('EDMTDUE',0)                                      
         L     R0,ECTOTD                                                        
**EDI**                                                                         
         L     RE,=A(DICSECT)          RESET RE                                 
         AH    RE,=Y(DSLIST-DICSECT)                                            
*                                                                               
         LTR   R0,R0                                                            
         BNM   *+10                                                             
         MVC   0(L'PP@CDAMT,R4),PP@CDAMT                                        
*                                                                               
         L     R4,SAVER4          MUST RESTORE R4                               
*                                (NEEDED FOR EDI CALL)                          
         DROP  RE                                                               
*                                                                               
         CLC   SAVBRK,AINVBRK      IF AT END OF INVOICE                         
         BNE   PA27P4                                                           
         ST    R0,SVAMTDUE         SAVE AMOUNT DUE (INCLUDING GST)              
*                                                                               
PA27P4   BAS   RE,PAEDIT                                                        
         TM    FLAG1,PARENTH  PUT CREDI AMT IN PARENTHESIS?                     
         BZ    PA27P4X                                                          
*                                                                               
         CLC   ALCOL3+1(13),=C'CREDIT AMOUNT'                                   
         BNE   PA27P4X                                                          
*                                                                               
         LA    R1,ALCOL4X     END OF CREDIT AMOUNT                              
         CLI   0(R1),C' '     FIND FIRST NON-SPACE                              
         BH    *+8                                                              
         BCT   R1,*-8                                                           
*                                                                               
         SHI   R1,3           BACK UP THREE                                     
         CLC   0(2,R1),=C'CR' SHOULD BE CR                                      
         BE    *+6                                                              
         DC    H'0'                                                             
         MVI   0(R1),C')'          REPLACE WITH ")"                             
         MVI   1(R1),C' '                                                       
*                                                                               
         LA    R1,ALCOL4-1                                                      
         CLI   1(R1),C' '     FIND FIRST NON-SPACE                              
         BH    *+12                                                             
         LA    R1,1(R1)                                                         
         B     *-12                                                             
*                                                                               
         MVI   0(R1),C'('                                                       
*                                                                               
PA27P4X  LA    R2,132(R2)                                                       
*                                                                               
PA27P6   DS    0H                                                               
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
**EDI**                                                                         
         CLI   BTDUET,C'Y'    BEFORE TAX AMOUNT DUE TRANSMITTED?                
         BE    PA27P7                                                           
         GOTO1 ABILLEDI,DMCB,('EDMDUE',(R4)),(R7)   EDI CALL                    
**EDI**                                                                         
*                                  SEE IF LIST OF PREVIOUS                      
*                                  BILLS NEEDED  (FOR INFORMATION ONLY)         
PA27P7   CLC   SAVBRK,AINVBRK                                                   
         BNE   PA28                                                             
         CLC   BORDSW(3),=C'YNN'   ORDERED ONLY FORMAT                          
         BE    PA28                                                             
         CLI   LSTOPT,C'Y'       LIST ONLY                                      
         BE    PA27R                                                            
         CLI   LSTOPT,C'A'       LIST ONLY (SHOWING AMOUNTS DUE)                
         BE    PA27R                                                            
         CLI   LSTOPT,C'I'       LIST + AT INSERTION                            
         BE    PA27R                                                            
         CLI   LSTOPT,C'R'       LIST + RESTATE AMT DUE                         
         BE    PA27R             (+ NOT AT INSERTION)                           
         CLI   LSTOPT,C'B'       LIST + RESTATE AMT DUE                         
         BE    PA27R             (+ AT INSERTION)                               
         B     PA28                                                             
*                                                                               
PA27R    BRAS  RE,LSTINV                                                        
*                                                                               
PA28     DS    0H                                                               
         B     PAX                                                              
         SPACE 3                                                                
PAEDIT   DS    0H                                                               
         MVC   TOTSTAR,=C'* '                                                   
         CLC   SAVBRK,AINVBRK                                                   
         BNE   *+8                                                              
         MVI   TOTSTAR+1,C'*'                                                   
         ST    RE,DUB                                                           
*--->    EDIT  (R0),(16,ALCOL4-1),2,COMMAS=YES,CR=YES                           
*                                                                               
         C     R0,SVAMTDUE       BE SURE I'M DOING AMOUNT DUE                   
         BNE   PAED3                                                            
         CLC   SAVBRK,AINVBRK    ALSO MUST BE END OF INVOICE                    
         BNE   PAED3                                                            
         CLI   DOLSOPT,C'Y'                                                     
         BNE   PAED3                                                            
*--->    EDIT  (R0),(16,ALCOL4-1),2,COMMAS=YES,CR=YES,FLOAT=$                   
*                                                                               
*        FLOAT=$ DOES NOT SEEM TO WORK WITH CURED  (CUREDIT)                    
*                                                                               
         CURED (R0),(16,ALCOL4-1),CURTAB,COMMAS=YES,CR=YES                      
         LA    R1,ALCOL4-2                                                      
PAED1    CLI   1(R1),C' '     FIND FIRST NON-SPACE                              
         BH    PAED2                                                            
         LA    R1,1(R1)                                                         
         B     PAED1                                                            
*                                                                               
PAED2    MVI   0(R1),C'$'     FLOAT $ BEFORE FIRST NON-SPACE                    
         B     PAED4                                                            
*                                                                               
PAED3    CURED (R0),(16,ALCOL4-1),CURTAB,COMMAS=YES,CR=YES                      
PAED4    L     RE,DUB                                                           
         CLI   ALCOL4+13,C' '         SEE IF CR THERE                           
         BH    PAEDT5                                                           
*        CLI   NOSTAR,C'Y'         SUPPRESS ** ON TOTALS?                       
         TM    FLAG1,NOSTAR        SUPPRESS ** ON TOTALS?                       
         BO    *+10                                                             
         MVC   ALCOL4+13(2),TOTSTAR                                             
         B     PAEDITX                                                          
*                                                                               
*AEDT5   CLI   NOSTAR,C'Y'         SUPPRESS ** ON TOTALS?                       
PAEDT5   TM    FLAG1,NOSTAR        SUPPRESS ** ON TOTALS?                       
         BO    *+10                                                             
         MVC   ALCOL4+15(2),TOTSTAR         CR**                                
PAEDITX  MVC   TOTSTAR,SPACES                                                   
         BR    RE                                                               
         SPACE 2                                                                
PAX      DS    0H                                                               
         MVI   PRSW,C'F'           SET TO FLUSH LINES                           
         GOTO1 =A(PRNT)                                                         
         XIT1                                                                   
         SPACE 3                                                                
BASISTAB DS    CL12                                                             
*                                                                               
         LTORG                                                                  
*                                                                               
SAVER4   DS    F                                                                
TBASA    DS    CL1        TEMPORARY BASIS                                       
*                                                                               
         DROP  R8                                                               
*                                                                               
         TITLE 'ADJINV - PRINT ADJUSTMENT INVOICE'                              
ADJINV   NMOD1 0,ADJINV                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
*                                                                               
         CLI   SCBNCSW,C'C'            IF SCB COMMISSION BILL                   
         BE    AIX                     NO OLD STYLE SEP ADJ BILL                
*                                                                               
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)             POINT TO ACCUM                          
         LR    RF,R7                                                            
         AH    RF,=Y(TOTSIZE-BFORML)                                            
*****    LA    RF,TOTSIZE-BFORML(R7)                                            
         MVC   MYX(BFORML),0(RF)        HOLD FORMULA IN MYX                     
**GST                                                                           
         MVC   CVATSWS,BFVATSWS-BFORMD(RF)                                      
         MVC   SVVATCDS,BFVATCDS-BFORMD(RF)                                     
         AH    R7,=Y(MAXMOS*ROWL)       POINT TO TOTAL ROW                      
*                                                                               
         LA    R1,WKROW                 MOVE TOTALS TO WKROW                    
         MVC   0(250,R1),000(R7)                                                
         MVC   250(250,R1),250(R7)                                              
         MVC   500(ROWL-500,R1),500(R7)                                         
*     REPLACES THESE THREE LINES                                                
*        MVC   WKROW(250),0(R7)                                                 
*        MVC   WKROW+250(250),250(R7)                                           
*        MVC   WKROW+500(ROWL-500),500(R7)                                      
*                                                                               
         LA    R7,WKROW                                                         
         CLI   FINANSW,0                  CHK FOR FINANCIAL CLIENT              
         BE    AI1                                                              
***R***                                                                         
         CLC   QPROG,=C'R1'      SEE IF FINANCIAL REBATE BILLING                
         BE    AI1                                                              
         CLC   QPROG,=C'RD'  SEE IF FINANCIAL REBATE BILLING DRAFT              
         BE    AI1                                                              
***R***                                                                         
         MVC   WKROW(ROWTL),ROWTL(R7)      MOVE OPEN VALUES TO WKROW            
         MVC   WKROW+ADJDSP(8),OADJDSP(R7) MOVE OPEN ADJ + DUE                  
*                                                                               
AI1      OC    ADJDSP(4,R7),ADJDSP(R7)     NO ADJUSTMENT                        
         BZ    AIX                                                              
*                                                                               
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
         MVI   RCSUBPRG,100                                                     
         MVI   DUESW,C'A'                                                       
         GOTO1 =A(PRNT)                                                         
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
         MVC   PAGE,=H'1'                                                       
         L     R0,DUEDSP(R7)           'DUE' FROM LAST INVB                     
         S     R0,ADJDSP(R7)           LESS ADJ = TRUE BILLED                   
*                                                                               
         LA    R2,P1                                                            
         USING ALINED,R2                                                        
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
         LA    R1,P1+33                                                         
         CLI   LASTPINV+9,C' '       CHECK LENGTH OF LASTPINV                   
         BH    *+8                                                              
         LA    R1,P1+34                                                         
*                                                                               
*--->    MVC   P1+34(24),=C'AMOUNT BILLED ON INVOICE'                           
******** MVC   P1+34(L'PP@AMTBI),PP@AMTBI                                       
         MVC   0(L'PP@AMTBI,R1),PP@AMTBI                                        
         DROP  RE                                                               
*********MVC   P1+34+25(10),LASTPINV                                            
         MVC   25(10,R1),LASTPINV                                               
**NEW 10/18/89                                                                  
*****    CLI   TESTFLAG,C'T'                                                    
*****    BE    AI2                                                              
         GOTOR GETNUM,DMCB,INVNO,PINVNO      GET NEXT BILL NO.                  
AI2      DS    0H                                                               
         BAS   RE,AIEDIT                                                        
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
         LA    R4,MYX                                                           
         USING BFORMD,R4                                                        
*                                  TEST IF NEED COMMISSION BASIS                
         CLC   BFCOMP,FFS                                                       
         BE    AI4                                                              
         CLC   BFBASA(2),FFS                                                    
         BE    AI4                                                              
         CLI   CDSEP,C'Y'          SEE IF DOING SEPARATE CD INV                 
         BNE   *+8                                                              
         NI    BFBASA,X'FB'        YES - THEN NO CD IN BASE                     
*                                                                               
         CLC   BFBASA,BFBASB                                                    
         BE    AI4                 SAME AS DUE                                  
***NEW 5/20/91                                                                  
         MVC   BYTE,BFBASB                                                      
         CLI   BFPBASB,0          SEE IF PRINTING ANOTHER ADJ                   
         BE    *+10                                                             
         MVC   BYTE,BFPBASB                                                     
***NEW 5/20/91                                                                  
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   ALCOL4-11(10),=C'NET AMOUNT'                                     
         MVC   ALCOL4-12(L'PP@NAMT),PP@NAMT                                     
         TM    BYTE,X'02'                                                       
         BZ    AI3                                                              
         TM    BYTE,X'04'          SEE IF SUBTRACTING CD                        
         BZ    AI3C                                                             
*--->    MVC   ALCOL4-19(18),=C'NET LESS CD AMOUNT'                             
         MVC   ALCOL4-21(L'PP@NLCA),PP@NLCA                                     
         B     AI3C                                                             
AI3      DS    0H                                                               
*--->    MVC   ALCOL4-20(19),=C'AGENCY COMM. AMOUNT'                            
         MVC   ALCOL4-20(L'PP@AGYCA),PP@AGYCA                                   
         TM    BYTE,X'08'                                                       
         BZ    AI3B                  AGY COMM - CD (NOT VALID)                  
         B     AI3C                                                             
*                                                                               
AI3B     DS    0H                                                               
*--->    MVC   ALCOL4-20(19),=C'       GROSS AMOUNT'                            
         MVC   ALCOL4-20(L'PPRGRSAM),PPRGRSAM                                   
         TM    BYTE,X'01'                                                       
         BZ    AI3C                                                             
         TM    BYTE,X'04'                                                       
         BZ    AI3C                                                             
*--->    MVC   ALCOL4-21(20),=C'GROSS LESS CD AMOUNT'                           
         MVC   ALCOL4-22(L'PP@GRSCD),PP@GRSCD                                   
         DROP  RE                                                               
*                                                                               
AI3C     DS    0H                                                               
**JW**                                                                          
         CLC   QAGENCY,=C'JW'       SPECIAL FOR JWT                             
         BE    AI3C3                ALWAYS LEAVE BYTE ALONE                     
**JW**                                                                          
         CLI   PROFB1A+1,C'Y'      SEE IF JUST PRINTING                         
         BE    *+10               COMMISSION ADJUSTMENT                         
         MVC   BYTE,BFBASB        NO - RERSET TO "REAL" BASIS                   
*                                                                               
AI3C3    DS    0H                                                               
*                          OTHERWISE I CAN LEAVE BYTE AS BFPBASB                
*                                                                               
         LA    R5,NDSP(R7)         POINT TO NET                                 
******   TM    BFBASB,X'02'       NET                                           
         TM    BYTE,X'02'  NET - NOW HONORS "SHOW ON BILL AS"                   
         BNZ   AI3C5                                                            
         LA    R5,ADSP(R7)                                                      
******** TM    BFBASB,X'08'       AGY COMM                                      
         TM    BYTE,X'08' AGY COMM - NOW HONORS "SHOW ON BILL AS"               
         BNZ   AI3C5                                                            
         LR    R5,R7              MUST BE GROSS                                 
*                                                                               
AI3C5    DS    0H                                                               
*                                  MUST STATE COMMISSION BASIS                  
         L     R0,0(R5)                                                         
***NOTE THIS MUST REMAIN BFBASB - I CAN'T USE BFPBASB HERE                      
******** TM    BFBASB,X'04'        SEE IF SUBTRACTING CD                        
         TM    BYTE,X'04' SEE IF SUBTRACTING CD (USE SHOW ON BILL AS)           
         BZ    AI3E                                                             
         S     R0,CDSP(R7)                                                      
         A     R0,ROWHL+CDSP(R7)   PREV BILLED CD (G-CD)-(BG-BCD)               
AI3E     S     R0,ROWHL(R5)        PREV BILLED                                  
         BAS   RE,AIEDIT                                                        
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
AI4      DS    0H                                                               
         MVC   W,SPACES                                                         
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*                                                                               
*******  MVC   W+12(10),=C'AGENCY FEE'                                          
         MVC   W+5(8),=C'TECH FEE'                                              
         CLI   PROFB1A+1,C'T'  SEE IF ALWAYS PRINTING TECH   FEE                
         BE    AI6                                                              
         MVC   W+05(L'PP@AGYF),PP@AGYF                                          
         CLI   PROFB1A+1,C'A'  SEE IF ALWAYS PRINTING AGENCY FEE                
         BE    AI4C             (WITHOUT PCT.)                                  
         MVC   W+05(L'PP@AGYF),PP@AGYF                                          
         CLI   PROFB1A+1,C'A'  SEE IF ALWAYS PRINTING AGENCY FEE                
         BE    AI4C             (WITHOUT PCT.)                                  
*                                                                               
         CLI   PROFB1A+1,C'P'  SEE IF ALWAYS PRINTING AGENCY FEE                
         BE    AI4C            (WITH PCT.)                                      
*                                                                               
         MVC   W+12(10),SPACES      CLEAR AGENCY FEE                            
*--->    MVC   W(21),=C'COMMISSION ADJUSTMENT'                                  
         MVC   W(L'PP@CMADJ),PP@CMADJ                                           
         DROP  RE                                                               
*                                                                               
AI4C     DS    0H                                                               
         CLI   PROFB1A+1,C'A'  SEE IF ALWAYS PRINTING AGENCY FEE                
         BE    AI6              (WITHOUT PCT.)                                  
*                                                                               
         CLC   BFCOMP,FFS                                                       
         BE    AI6                                                              
*                                                                               
         CLI   PROFB1A+1,C'Y'  SEE IF ALWAYS PRINTING COMMISSION ADJ            
         BE    AI6                                                              
*                                                                               
*                                                                               
         LA    R6,W+23                                                          
***NEW 5/20/91                                                                  
         OC    BFPCOMP,BFPCOMP    SEE IF PRINTING A DIFFERENT PCT               
         BZ    AI4H                                                             
         TM    BFPCOMP,X'80'                                                    
         BZ    *+12                                                             
         MVI   0(R6),C'-'                                                       
         LA    R6,1(R6)                                                         
         MVI   CURTAB+3,4                                                       
*--->    EDIT  (B3,BFPCOMP),(7,0(R6)),4                                         
         CURED (B3,BFPCOMP),(8,0(R6)),CURTAB                                    
         MVI   CURTAB+3,2                                                       
         B     AI4X                                                             
***NEW 5/20/91                                                                  
AI4H     TM    BFCOMP,X'80'                                                     
         BZ    *+12                                                             
         MVI   0(R6),C'-'                                                       
         LA    R6,1(R6)                                                         
         MVI   CURTAB+3,4                                                       
*--->    EDIT  (B3,BFCOMP),(7,0(R6)),4                                          
         CURED (B3,BFCOMP),(8,0(R6)),CURTAB                                     
         MVI   CURTAB+3,2                                                       
*                                                                               
AI4X     DS    0H                                                               
         LA    RF,7(R6)                                                         
AI5      DS    0H                                                               
         CLI   0(RF),C'0'                                                       
         BNE   *+12                                                             
         MVI   0(RF),C' '                                                       
         BCT   RF,AI5                                                           
         CLI   0(RF),C'.'                                                       
         BNE   AI5D                                                             
         MVI   0(RF),C' '                                                       
         BCTR  RF,R0                                                            
         B     AI5F                                                             
*                                                                               
AI5D     CLI   0(RF),C','        ALLOW FOR THOSE COUNTRIES THAT USE ,           
         BNE   AI5F              FOR DECIMAL POINT                              
         MVI   0(RF),C' '                                                       
         BCTR  RF,R0                                                            
*                                                                               
AI5F     LA    RE,W+22                                                          
         CLI   W+23,C' '                                                        
         BH    *+8                                                              
         LA    RE,W+23                                                          
         MVI   0(RE),C'('                                                       
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   2(17,RF),=C'PERCENT OF ABOVE)'                                   
         MVC   2(L'PP@PCTAB,RF),PP@PCTAB                                        
         DROP  RE                                                               
AI6      DS    0H                                                               
         LA    RF,W+50                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R0,W                                                             
         SR    RF,R0               RF = LENGTH OF STRING - 1                    
         LA    RE,ALCOL4-2                                                      
         SR    RE,RF                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),W                                                        
*                                                                               
         L     R0,ADJDSP(R7)           ADJUSTMENT AMOUNT                        
         BAS   RE,AIEDIT                                                        
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
**GST                                                                           
*                                                                               
         MVI   BTDUET,C'N'     BEFORE TAX AMOUNT DUE NOT TRANSMITTED            
*                                                                               
         XC    TOTVAT,TOTVAT                                                    
         CLI   CVATSW,0            IF HAVE VAT CODE                             
         BE    AI8                                                              
*                                                                               
         MVI   BTDUET,C'Y'     BEFORE TAX AMOUNT DUE TRANSMITTED                
*                                                                               
         LA    R4,MYX        A(FORMULA)                                         
         GOTO1 ABILLEDI,DMCB,('EDMDUE',(R4)),(R7)  DUE                          
*                                                                               
         LA    R0,ALCOL4-ALINED     COLUMN FOR VAT CODE                         
         GOTO1 =A(VBPRNT),DMCB,(C'J',SAVBRK),(R0)                               
         MVC   TOTVAT,20(R1)      SAVE TOTAL VAT                                
*                                                                               
AI8      DS    0H                                                               
         L     R0,ADJDSP(R7)           ADJUSTMENT AMOUNT                        
*                                                                               
         A     R0,TOTVAT               ADD TOTAL VAT                            
**EDI**                                                                         
         CLI   CVATSW,0                                                         
         BE    AI6H                                                             
         ST    R0,ECTOTD                                                        
         GOTO1 ABILLEDI,DMCB,('EDMTDUE',0)                                      
         L     R0,ECTOTD                                                        
AI6H     DS    0H                                                               
**EDI**                                                                         
*                                                                               
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   ALCOL4-17(16),=C'** AMOUNT DUE **'                               
         MVC   ALCOL4-17(L'PP@AMDUE),PP@AMDUE                                   
         LTR   R0,R0                                                            
         BNM   *+10                                                             
*--->    MVC   ALCOL4-20(19),=C'** CREDIT AMOUNT **'                            
         MVC   ALCOL4-20(L'PP@CDAMT),PP@CDAMT                                   
         DROP  RE                                                               
         BAS   RE,TAIEDIT                                                       
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
**EDI**                                                                         
         CLI   BTDUET,C'Y'    ALREADY TRANSMITTED?                              
         BE    AI8A                                                             
         LA    R4,MYX        A(FORMULA)                                         
         GOTO1 ABILLEDI,DMCB,('EDMDUE',(R4)),(R7)  DUE                          
*                                                                               
AI8A     DS    0H                                                               
         LA    R4,RGRSD(R7)  GROSS                                              
         L     R0,0(R4)                                                         
         S     R0,ROWHL(R4)     LESS BILLED                                     
         ST    R0,ADJX                                                          
         LA    R4,RNETD(R7)  NET                                                
         L     R0,0(R4)                                                         
         S     R0,ROWHL(R4)     LESS BILLED                                     
         ST    R0,ADJX+4                                                        
         LA    R4,RCDD(R7)   CASH DISC.                                         
         L     R0,0(R4)                                                         
         S     R0,ROWHL(R4)     LESS BILLED                                     
         ST    R0,ADJX+8                                                        
         GOTO1 ABILLEDI,DMCB,('EDMLST',LASTPINV),ADJX,ADJX+4,ADJX+8             
**EDI**                                                                         
         MVI   CNMTCD,C'A'         PRINT ADJ COMMENTS                           
         BRAS  RE,PRTCMNT                                                       
*                                                                               
         BRAS  RE,WBILL                                                         
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMEND',0)   EDI CALL                            
         CLI   OUTMODE,C'W'        FOR WORKER FILE MODE                         
         BNE   AI8B                                                             
         GOTO1 ABILLEDI,DMCB,('EDMCLS',0)   CLOSE EDI FOR EACH INVOICE          
**EDI**                                                                         
*                                                                               
AI8B     DS    0H                                                               
         MVI   PRSW,C'F'           FLUSH PRINT LINES                            
         GOTO1 =A(PRNT)                                                         
         B     AIX                                                              
*                                                                               
         SPACE 3                                                                
AIEDIT   DS    0H                                                               
         ST    RE,DUB                                                           
*--->    EDIT  (R0),(16,ALCOL4-1),2,COMMAS=YES,CR=YES                           
         CURED (R0),(16,ALCOL4-1),CURTAB,COMMAS=YES,CR=YES                      
         L     RE,DUB                                                           
         BR    RE                                                               
         SPACE 3                                                                
TAIEDIT  DS    0H                                                               
         ST    RE,DUB                                                           
*--->    EDIT  (R0),(16,ALCOL4-1),2,COMMAS=YES,CR=YES                           
         CLI   DOLSOPT,C'Y'        $ SIGN BEFORE TOTAL?                         
         BNE   TAIEDIT5                                                         
*--->    EDIT  (R0),(16,ALCOL4-1),2,COMMAS=YES,CR=YES,FLOAT=$                   
*                                                                               
*        FLOAT=$ DOES NOT SEEM TO WORK WITH CURED  (CUREDIT)                    
*                                                                               
         CURED (R0),(16,ALCOL4-1),CURTAB,COMMAS=YES,CR=YES                      
         LA    R1,ALCOL4-2                                                      
TPAED1   CLI   1(R1),C' '     FIND FIRST NON-SPACE                              
         BH    TPAED2                                                           
         LA    R1,1(R1)                                                         
         B     TPAED1                                                           
*                                                                               
TPAED2   MVI   0(R1),C'$'     FLOAT $ BEFORE FIRST NON-SPACE                    
         B     TPAED4                                                           
*                                                                               
TAIEDIT5 CURED (R0),(16,ALCOL4-1),CURTAB,COMMAS=YES,CR=YES                      
TPAED4   L     RE,DUB                                                           
         BR    RE                                                               
         SPACE 2                                                                
AIX      DS    0H                                                               
         XIT1                                                                   
         DROP  R2                                                               
         DROP  R4                                                               
*                                                                               
SVVATCD  DS    0C                  SAVED VAT CODE (OLD TAG)                     
SVVATCDS DS    CL11                NAT AND PRV VAT CODES                        
*                                                                               
MYX      DC    100X'00'      SHOULD BE ENOUGH                                   
*                                                                               
ADJX     DC    4F'0'        USED FOR EDMLST EDI CALL                            
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'CDINV - PRINT CASH DISC. INVOICE'                               
CDINV    NMOD1 0,CDINV                                                          
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
*                                                                               
         CLI   SCBNCSW,C'C'            SEPARATE UFC COMMISSION BILL             
         BNE   CINV5                                                            
         CLI   PROFB2B+3,C'C'          CHK CD INV WITH COMM                     
         BE    CINV10                                                           
         B     CIX                                                              
*                                                                               
CINV5    CLI   SCBNCSW,C'N'            SEPARATE UFC NET BILL                    
         BNE   CINV10                  NO CD INV                                
         CLI   PROFB2B+3,C'N'          CHK CD INV WITH NET                      
         BE    CINV10                                                           
         B     CIX                                                              
*                                                                               
*                                                                               
CINV10   DS    0H                                                               
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)             POINT TO ACCUM                          
         LR    RF,R7                                                            
         AH    RF,=Y(TOTSIZE-BFORML)                                            
*****    LA    RF,TOTSIZE-BFORML(R7)                                            
         MVC   X(5),0(RF)               HOLD FORMULA IN X                       
         MVC   MYCX(BFORML),0(RF)       HOLD FORMULA IN MYCX                    
**GST                                                                           
         MVC   CVATSW,BFVATSW-BFORMD(RF)    SEE IF VATABLE                      
*                                                                               
         AH    R7,=Y(MAXMOS*ROWL)                                               
*                                                                               
         L     R0,CDSP(R7)              CHK FOR ZERO CD INV                     
         S     R0,ROWHL+CDSP(R7)                                                
         LCR   R0,R0                                                            
         LTR   R0,R0                                                            
         BZ    CIX                      NO ZERO CD INVOICES                     
*                                                                               
*                                                                               
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         MVI   DUESW,C'C'                                                       
*                                                                               
         MVI   BTDUET,C'N'                                                      
*                                                                               
*                                                                               
         LA    R2,P1                                                            
         USING ALINED,R2                                                        
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   P1+18(49),=C'**  THIS INVOICE REPRESENTS CASH DISCOUNTS          
*--->          OF  **'                                                          
         MVC   P1+18(L'PP@THE01),PP@THE01                                       
*--->    MVC   P2+18(49),=C'**  ITEMS BILLED ON INVOICE                         
*--->              **'                                                          
         MVC   P2+18(L'PP@ITEM),PP@ITEM                                         
         DROP  RE                                                               
         MVC   P2+18+28(10),LASTPINV                                            
****     CLI   TESTFLAG,C'T'                                                    
****     BE    CI2                                                              
         GOTOR GETNUM,DMCB,INVNO,PINVNO      GET NEXT BILL NO.                  
CI2      DS    0H                                                               
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
**GST                                                                           
*                                                                               
         XC    TOTVAT,TOTVAT                                                    
         CLI   CVATSW,0            IF HAVE VAT CODE                             
         BE    CI8                                                              
*                                                                               
         L     R0,CDSP(R7)        CD AMOUNT -GROSS                              
         S     R0,ROWHL+CDSP(R7)   SUBTRACT PREV BILLED CD                      
         LCR   R0,R0               REVERSE SIGN                                 
*                                                                               
         MVI   BTDUET,C'Y'         BEFORE TAX AMT DUE TRANSMITTED               
         LA    R4,MYCX       A(FORMULA)                                         
         GOTO1 ABILLEDI,DMCB,('EDMDUE',(R4)),(R7)  DUE                          
*                                                                               
*                                                                               
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   ALCOL4-17(16),=C'** AMOUNT DUE **'                               
         MVC   ALCOL4-17(L'PP@AMDUE),PP@AMDUE                                   
         LTR   R0,R0                                                            
         BNM   *+10                                                             
*--->    MVC   ALCOL4-20(19),=C'** CREDIT AMOUNT **'                            
         MVC   ALCOL4-20(L'PP@CDAMT),PP@CDAMT                                   
         DROP  RE                                                               
*                                                                               
         MVC   ALCOL4-20(19),=C'AMOUNT BEFORE TAX  '                            
         CLI   RCLANG,4                FRENCH?                                  
         BNE   CI4                                                              
         MVC   ALCOL4-20(19),=C'MONTANT AVANT TAXES'                            
*                                                                               
CI4      DS    0H                                                               
         BAS   RE,CIEDIT                                                        
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
         LA    R0,ALCOL4-ALINED                                                 
         GOTO1 =A(VBPRNT),DMCB,(C'C',SAVBRK),(R0)                               
         MVC   TOTVAT,20(R1)            SAVE TOTAL VAT                          
**                                                                              
CI8      DS    0H                                                               
         L     R0,CDSP(R7)        CD AMOUNT -GROSS                              
         S     R0,ROWHL+CDSP(R7)   SUBTRACT PREV BILLED CD                      
         LCR   R0,R0               REVERSE SIGN                                 
*                                                                               
         L     RE,TOTVAT           ADD TOTAL VAT                                
*                                 DO NOT REVERSE SIGN OF TOTVAT                 
*                                 HAS IT HAS BEEN REVERSED IN VBPRNT            
         AR    R0,RE                                                            
**EDI**                                                                         
         CLI   CVATSW,0                                                         
         BE    CI6H                                                             
         ST    R0,ECTOTD                                                        
         GOTO1 ABILLEDI,DMCB,('EDMTDUE',0)                                      
         L     R0,ECTOTD                                                        
CI6H     DS    0H                                                               
**EDI**                                                                         
*                                                                               
CI10     L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   ALCOL4-17(16),=C'** AMOUNT DUE **'                               
         MVC   ALCOL4-17(L'PP@AMDUE),PP@AMDUE                                   
         LTR   R0,R0                                                            
         BNM   *+10                                                             
*--->    MVC   ALCOL4-20(19),=C'** CREDIT AMOUNT **'                            
         MVC   ALCOL4-20(L'PP@CDAMT),PP@CDAMT                                   
         DROP  RE                                                               
         BAS   RE,CAIEDIT                                                       
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
**EDI**                                                                         
         CLI   BTDUET,C'Y'   BEFORE TAX ALREADY SENT?                           
         BE    CI17                                                             
*                                                                               
         LA    R4,MYCX       A(FORMULA)                                         
         GOTO1 ABILLEDI,DMCB,('EDMDUE',(R4)),(R7)  DUE                          
*                                                                               
CI17     DS    0H                                                               
         LA    R4,RGRSD(R7)  GROSS                                              
         L     R0,0(R4)                                                         
         S     R0,ROWHL(R4)     LESS BILLED                                     
         ST    R0,ADJCX                                                         
         LA    R4,RNETD(R7)  NET                                                
         L     R0,0(R4)                                                         
         S     R0,ROWHL(R4)     LESS BILLED                                     
         ST    R0,ADJCX+4                                                       
         LA    R4,RCDD(R7)   CASH DISC.                                         
         L     R0,0(R4)                                                         
         S     R0,ROWHL(R4)     LESS BILLED                                     
         ST    R0,ADJCX+8                                                       
         GOTO1 ABILLEDI,DMCB,('EDMLST',LASTPINV),ADJCX,ADJCX+4,ADJCX+8          
**EDI**                                                                         
         MVI   CNMTCD,C'C'         PRINT CD COMMENTS                            
         BRAS  RE,PRTCMNT                                                       
*                                                                               
         BRAS  RE,WBILL                                                         
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMEND',0)   EDI CALL                            
         CLI   OUTMODE,C'W'        FOR WORKER FILE MODE                         
         BNE   CI8B                                                             
         GOTO1 ABILLEDI,DMCB,('EDMCLS',0)   CLOSE EDI FOR EACH INVOICE          
**EDI**                                                                         
*                                                                               
CI8B     MVI   PRSW,C'F'           SET TO FLUSH LINES NOW                       
         GOTO1 =A(PRNT)                                                         
         B     CIX                                                              
*                                                                               
         SPACE 3                                                                
CIEDIT   DS    0H                                                               
         ST    RE,DUB                                                           
*--->    EDIT  (R0),(16,ALCOL4-1),2,COMMAS=YES,CR=YES                           
         CURED (R0),(16,ALCOL4-1),CURTAB,COMMAS=YES,CR=YES                      
         L     RE,DUB                                                           
         BR    RE                                                               
         SPACE 3                                                                
CAIEDIT  DS    0H                                                               
         ST    RE,DUB                                                           
*--->    EDIT  (R0),(16,ALCOL4-1),2,COMMAS=YES,CR=YES                           
         CLI   DOLSOPT,C'Y'        $ SIGN BEFORE TOTAL?                         
         BNE   CAIEDIT5                                                         
*--->    EDIT  (R0),(16,ALCOL4-1),2,COMMAS=YES,CR=YES,FLOAT=$                   
*                                                                               
*        FLOAT=$ DOES NOT SEEM TO WORK WITH CURED  (CUREDIT)                    
*                                                                               
         CURED (R0),(16,ALCOL4-1),CURTAB,COMMAS=YES,CR=YES                      
         LA    R1,ALCOL4-2                                                      
CPAED1   CLI   1(R1),C' '     FIND FIRST NON-SPACE                              
         BH    CPAED2                                                           
         LA    R1,1(R1)                                                         
         B     CPAED1                                                           
*                                                                               
CPAED2   MVI   0(R1),C'$'     FLOAT $ BEFORE FIRST NON-SPACE                    
         B     CPAED4                                                           
*                                                                               
CAIEDIT5 CURED (R0),(16,ALCOL4-1),CURTAB,COMMAS=YES,CR=YES                      
CPAED4   L     RE,DUB                                                           
         BR    RE                                                               
         SPACE 2                                                                
CIX      DS    0H                                                               
         XIT1                                                                   
         DROP  R2                                                               
         LTORG                                                                  
*                                                                               
MYCX     DC    100X'0'                                                          
*                                                                               
ADJCX    DC    4F'0'                                                            
*                                                                               
         TITLE 'AORINV - AOR INVOICE'                                           
AORINV   NMOD1 0,AORINV                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
*                                                                               
         XC    AOIDISK,AOIDISK         CLEAR EACH TIME                          
         MVI   MIXSW,C'N'              CLEAR THIS SWITCH                        
         XC    LASTMOS,LASTMOS                                                  
*                                                                               
*        NOW CHECK FOR SPECIAL SEPARATE INVOICING CONTROLLED BY                 
*        PROGPRO2+13 (NON-N VALUES)                                             
*                                                                               
         CLI   PROGPRO2+13,0       NOT PRESENT                                  
         BE    AOI1                                                             
         CLI   PROGPRO2+13,C'N'    OR N                                         
         BE    AOI1                                                             
         L     RE,ACRDB                                                         
         CLI   0(RE),C'D'   DEBIT CODE = SPECIAL SEPARATE INV                   
         BNE   AOI1                    IF SO, NO AOR                            
*                                                                               
         CLI   PROFAOR+7,C'Y'          SEE IF SUPPRESSING                       
         BE    AOIX                                                             
*                                                                               
*                                                                               
AOI1     CLI   AORSW,C'Y'              ANY AOR                                  
         BNE   AOIX                    NO                                       
*                                                                               
         CLI   SCBNCSW,C'N'            NO AOR FOR COMM NET BILL                 
         BE    AOIX                                                             
*                                                                               
         CLI   AORLOPT,C'N'              OPTION TO LIST PRD/EST/MOS             
         BNE   AOI20                                                            
*                                                                               
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)               POINT TO ACCUM                        
         LR    RF,R7                                                            
         AH    RF,=Y(TOTSIZE-BFORML)                                            
         MVC   X(BFORML),0(RF)            SET FORMULA AND AOR PCT               
*                                                                               
         AH    R7,=Y(MAXMOS*ROWL)         POINT TO TOTAL ROW                    
*                                                                               
         ICM   R6,15,PEPTABN                                                    
         BZ    AOIX                                                             
*                                                                               
         L     RF,APEPTAB                                                       
         USING PEPTD,RF                                                         
*                                                                               
         MVI   BYTE,0                                                           
         XC    LASTAOVS,LASTAOVS                                                
*                                                                               
AOI3     DS    0H                                                               
         OC    PEPTAORA,PEPTAORA         TEST FOR ANY ACCOUNT                   
         BZ    AOI3P                                                            
*                                                                               
         MVC   AOIDISK,PEPTAORD    MUST SAVE AOR DISK ADDRESS                   
*                                                                               
         MVI   BYTE,1              YES, SET FOUND ONE                           
*                                  AND 'ROLL-UP' AOR VAT CODES                  
         LA    R4,LASTAOVS                                                      
         LA    R5,PEPTAOVS                                                      
         LA    R0,NPROVS+1                                                      
*                                                                               
AOI3D    DS    0H                                                               
         CLI   0(R4),0             IF NO CODE YET                               
         BNE   *+14                                                             
         MVC   0(1,R4),0(R5)       JUST SAVE THIS ONE                           
         B     AOI3F                                                            
         CLC   0(1,R4),0(R5)       IS THIS ONA SAME AS SAVED?                   
         BE    AOI3F               YES, OK                                      
         MVI   0(R4),X'FF'          NO SET MIXED                                
*                                                                               
AOI3F    DS    0H                                                               
         LA    R4,1(R4)            NEXT PROVINCE                                
         LA    R5,1(R5)                                                         
         BCT   R0,AOI3D                                                         
*                                                                               
AOI3P    LA    RF,PEPTABRL(RF)          NOT AMOUNT                              
         BCT   R6,AOI3                                                          
         CLI   BYTE,0                  TEST ANY ACCOUNTS FOUND                  
         BE    AOIX                                                             
         DROP  RF                                                               
*                                                                               
AOI4     DS    0H                                                               
***NEW 5/17/91                                                                  
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         MVI   DUESW,C'R'                                                       
*                                                                               
         LA    R2,P1                                                            
         USING ALINED,R2                                                        
*                                                                               
         L     R4,=A(DICSECT)                                                   
         AH    R4,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,R4                                                        
*--->    MVC   P1+24(44),=C'** BILLED TO CLIENT ON INVOICE NN-NN-NNNN *         
*--->          *'                                                               
         MVC   P1+24(L'PP@BLDTO),PP@BLDTO                                       
**NEW 10/18/89               WAS PINVNO                                         
         MVC   P1+24+31(10),LASTPINV                                            
**NEW 10/18/89                                                                  
*--->    MVC   P2+24(44),=C'**     SUBJECT TO AGENCY OF RECORD FEE    *         
*--->          *'                                                               
         MVC   P2+24(L'PP@SUBTO),PP@SUBTO                                       
****     CLI   TESTFLAG,C'T'                                                    
****     BE    AOI5                                                             
         GOTOR GETNUM,DMCB,INVNO,PINVNO      GET NEXT BILL NO.                  
*                                                                               
AOI5     DS    0H                                                               
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
*--->    MVC   P1+30(32),=C'BASIS AMOUNT FROM CLIENT INVOICE'                   
         MVC   P1+21(L'PP@BA01),PP@BA01                                         
         DROP  R4                                                               
*                                                                               
         LR    R5,R7                                                            
AOI5D    DS    0H                                                               
**2/22/89L     R0,0(R5)                                                         
**2/22/89S     R0,ROWHL(R5)                SUBTRACT PREV BILLING                
*                                                                               
         L     R0,AORBDSP(R7)                                                   
**2/22/89                                                                       
**NEW 10/18/89                                                                  
         LA    R1,ALCOL4                                                        
**NEW 10/18/89                                                                  
         BAS   RE,AOIEDIT                                                       
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
         CLC   X+BFAORPCT-BFORMD(3),FFS        IF MIXED PCTS, SKIP              
         BE    AOI7                                                             
         MVC   W,SPACES                                                         
         LA    R4,W                                                             
*                                                                               
         XC    FULL,FULL                                                        
         MVC   FULL+1(3),X+BFAORPCT-BFORMD                                      
         TM    FULL+1,X'F0'         SEE IF NEGATIVE                             
         BNO   *+8                                                              
         MVI   FULL,X'FF'                                                       
         L     RE,FULL                                                          
         MVI   CURTAB+3,4                                                       
*--->    EDIT  (RE),(8,0(R4)),4,ALIGN=LEFT,FLOAT=-                              
         CURED (RE),(8,0(R4)),CURTAB,ALIGN=LEFT,FLOAT=-                         
         MVI   CURTAB+3,2                                                       
         CLC   6(2,R4),=C'00'                                                   
         BNE   *+14                                                             
         MVC   6(2,R4),=C'  '                                                   
         SH    R0,=H'2'                                                         
         CLC   5(2,R4),=C'00'                                                   
         BNE   *+14                                                             
         MVC   5(2,R4),=C'  '                                                   
         SH    R0,=H'2'                                                         
         AR    R4,R0                                                            
*                                                                               
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   1(12,R4),=C'PCT OF ABOVE'                                        
         MVC   1(L'PP@POFA,R4),PP@POFA                                          
         DROP  RE                                                               
         MVC   ALCOL4-25(24),W                                                  
*                                                                               
AOI7     DS    0H                                                               
         L     R0,AORDSP(R7)           AOR AMOUNT                               
**NEW 10/18/89                                                                  
         LA    R1,ALCOL4                                                        
**NEW 10/18/89                                                                  
         BAS   RE,AOIEDIT                                                       
*                                                                               
***NEW 5/17/91   CHANGED FROM CVATSW,0 TO CVATCOD,0                             
         CLI   CVATCOD,0           IF HAVE VAT CODE                             
         BE    AOI10                                                            
*                                                                               
****     NEW CODE FOR QST                                                       
         GOTO1 =A(PRNT)                                                         
         LA    R0,ALCOL4-ALINED                                                 
         PRINT GEN                                                              
         GOTO1 =A(VBPRNT),DMCB,(C'A',SAVBRK),(R0),LASTAOVS,AORDSP(R7), X        
               VATADSP(R7),0                                                    
         PRINT NOGEN                                                            
         MVC   TOTVAT,20(R1)        SAVE TOTAL OF VATS                          
*                                                                               
         L     R0,AORDSP(R7)                                                    
         A     R0,TOTVAT                                                        
         LA    R1,ALCOL4                                                        
         BAS   RE,AOIEDIT                                                       
*                                                                               
         LA    R1,ALCOL4                                                        
         BAS   RE,AOIEDIT                                                       
*                                                                               
AOI10    DS    0H                                                               
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
****                                                                            
****     NOTE IN THIS FORMAT-AOR COMMENTS WILL ONLY PRINT                       
****     FROM THE LAST SAVE AOR DISK ADDRESS                                    
****                                                                            
*****    L     RF,PPFILEC      READ AOR RECORD INTO PCONREC                     
*****    USING PPFILED,RF      AND CHECK FOR STANTARD COMMENT ELEM              
******   LA    R1,PCONREC                                                       
*****    DROP  RF                                                               
*                                                                               
         LA    R1,AORWRK                                                        
         ST    R1,AREC                                                          
         OC    AOIDISK,AOIDISK                                                  
         BNZ   *+6                                                              
         DC    H'0'                SOMETHING VERY WRONG                         
*                                                                               
         MVC   KEY+27(4),AOIDISK   AOR DISK ADDRESS                             
         GOTO1 GETPRT                                                           
*                                                                               
         CLI   PRDCTL,C'T'     SEE IF PRODUCTS TOGETHER                         
         BNE   AOI10H          ONLY PRINT COMMENT FOR PRD=AAA                   
         L     RF,AREC                                                          
         CLC   AORKPRD-AORREC(3,RF),=C'AAA'                                     
         BNE   AOI10W                                                           
*                                                                               
AOI10H   DS    0H                                                               
         CLI   ESTCTL,C'S'         SEE IF EST ON SEPARATE INV                   
         BE    AOI10P              ALWAYS TRY TO PRINT THE COMMENT              
*                                                                               
*                                  IF EST IS NOT SEPARATE                       
*                                  ONLY TRY TO PRINT COMMENT                    
*                                  IF I HAVE AN "ALL" EST                       
*                                  AOR RECORD                                   
         L     RF,AREC                                                          
         CLC   AORKEST-AORREC(2,RF),=X'FFFF'                                    
         BNE   AOI10W                                                           
*                                                                               
AOI10P   DS    0H                                                               
         BAS   RE,AOICOMM    CHECK FOR AOR STANDARD COMMENT                     
*                                                                               
AOI10W   DS    0H                                                               
*                                                                               
         CLI   WPPOPT,C'Y'         WPP CLIENT?                                  
         BNE   AOI10WX                                                          
*                                                                               
         BRAS  RE,PRTWCOM                                                       
*                                                                               
AOI10WX  DS    0H                                                               
         BRAS  RE,WBILL                                                         
*                                                                               
         MVI   PRSW,C'F'           SET TO FLUSH LINES NOW                       
         GOTO1 =A(PRNT)                                                         
         B     AOIX                                                             
         SPACE 3                                                                
***********************************************************************         
*        PRD/EST/MOS LISTING ON AOR BILLS                                       
***********************************************************************         
         SPACE 1                                                                
AOI20    DS    0H                                                               
**NEW 3/12/91                                                                   
         MVI   AOIBILL,C'N'       WILL BE SET TO Y IF BILL CREATED              
         MVI   AORFRST,C'Y'                                                     
         CLI   AORLOPT,C'C'                                                     
         BNE   AOI22                                                            
         CLI   AORLCTL,C'P'                                                     
         BNE   AOIX                                                             
*                                                                               
AOI22    DS    0H                                                               
**NEW 3/12/91                                                                   
         ICM   R6,15,PEPTABN       SORT PEPTAB ON AOR ACCT                      
         BZ    AOIX                                                             
         L     R7,APEPTAB                                                       
         USING PEPTD,R7                                                         
*                            NOTE USE OF XSORTL FOR LONG RECORDS                
         GOTO1 =V(XSORTL),DMCB,(R7),(R6),PEPTABRL,                     X        
               L'PEPTAORA+L'PEPTAOVS,PEPTAORA-PEPTD                             
*                                                                               
         XC    LASTAORA,LASTAORA                                                
         XC    LASTAOVS,LASTAOVS                                                
***NEW 5/17/91                                                                  
         MVI   LASTAORV,0                                                       
***NEW 5/17/91                                                                  
         MVI   AJUL10SW,0       CLEAR                                           
*                                                                               
AOI30    DS    0H                                                               
*                  WAS OC  PEPTAOR,PEPTAOR (SKIP IF NO AOR AMOUNT)              
         OC    PEPTAORA,PEPTAORA   SKIP IF NO AOR ACCOUNT                       
         BZ    AOI70                                                            
         CLC   PEPTAORA,LASTAORA   NEW AOR ACCT = NEW BILL                      
         BNE   AOI40                                                            
*                                                                               
         OC    PEPTAOVS,SPACES                                                  
         CLC   PEPTAOVS,LASTAOVS   NEW GST/PST STATUS = NEW BILL                
         BNE   AOI40                                                            
*                                                                               
         MVC   LASTMOS,PEPTMOS     SAVE THE LAST MOS                            
*                                                                               
         CLC   PEPTMOS,=X'6E07'     MOS BEFORE JUL/10?                          
         BL    AOI30B                                                           
         OI    AJUL10SW,X'02' BILL WITH MOS ON OR AFTER JUL/10                  
         B     AOI30X                                                           
*                                                                               
AOI30B   DS    0H                                                               
         OI    AJUL10SW,X'01' BILL WITH MOS BEFORE JUL/10                       
*                                                                               
AOI30X   TM    AJUL10SW,X'03'      SEE IF MIXTURE OF BEFORE AND                 
         BNO   *+8                 AFTER JUL/10 BILLS                           
         MVI   MIXSW,C'Y'                                                       
         B     AOI60                                                            
*                                  FINISH UP OLD BILL                           
*                                                                               
AOI40    DS    0H                                                               
         MVI   AJUL10SW,0          MUST CLEAR THIS SWITCH                       
*                                                                               
*                       CHECK MOS OF BILL THAT CAUSED                           
*                       THE BREAK                                               
*                                                                               
         CLC   PEPTMOS,=X'6E07'     MOS BEFORE JUL/10?                          
         BL    AOI40B                                                           
         OI    AJUL10SW,X'02' BILL WITH MOS ON OR AFTER JUL/10                  
         B     AOI40C                                                           
*                                                                               
AOI40B   DS    0H                                                               
         OI    AJUL10SW,X'01' BILL WITH MOS BEFORE JUL/10                       
*                                                                               
AOI40C   OC    LASTAORA,LASTAORA   NOT IF FIRST TIME                            
         BZ    AOI44                                                            
*            AT LAST ENTRY OR CHANGE OF ACCOUNT                                 
*            I MAY NEED TO PRINT A COMMENT                                      
         OC    LASTAORD,LASTAORD      BE SURE I HAVE AN ADDRESS                 
         BZ    AOI40F              GO PRINT TOTALS                              
*                                                                               
*****    L     RF,PPFILEC          USE CONTRACT AREA                            
****     USING PPFILED,RF                                                       
*****    LA    R1,PCONREC                                                       
******   DROP  RF                                                               
*                                                                               
         LA    R1,AORWRK                                                        
         ST    R1,AREC                                                          
         MVC   KEY+27(4),LASTAORD  DISK ADDRESS                                 
         GOTO1 GETPRT                                                           
*                                                                               
         BAS   RE,AOICOMM      GO CHECK FOR AOR STANDARD COMMENT                
*                              AND PRINT IT                                     
AOI40F   DS    0H                                                               
         XC    LASTAORD,LASTAORD     CLEAR LAST SAVE AOR DISK ADDR              
*                                                                               
         GOTO1 =A(PRNT)                                                         
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   ALCOL1+8(7),=C'TOTALS*'                                          
         MVC   ALCOL1+8(L'PP@TOTAL),PP@TOTAL                                    
         DROP  RE                                                               
         L     R0,X                TOTAL GROSS                                  
         LA    R1,ALCOL2                                                        
         BAS   RE,AOIEDIT                                                       
         L     R0,X+8              TOTAL AOR                                    
         LA    R1,ALCOL4                                                        
         BAS   RE,AOIEDIT                                                       
*                                                                               
         L     R0,X+4              TOTAL OF BASIS                               
         LA    R1,ALSTRIP                                                       
         BAS   RE,AOIEDIT                                                       
*                                                                               
**GET                                                                           
***NEW 5/17/91         WAS CVATSW,0                                             
         CLI   CVATCOD,0           IF HAVE VAT                                  
         BE    AOI42                                                            
         CLI   LASTAORV,C' '       ALSO SKIP IF NO VAT FOR                      
         BNH   AOI42               "OTHER AGENCY"                               
*                                                                               
*                                                                               
         GOTO1 =A(PRNT)                                                         
         LA    R0,ALCOL4-ALINED                                                 
         GOTO1 =A(VBPRNT),DMCB,(C'A',SAVBRK),(R0),LASTAOVS,            X        
               X+8,X+16,0          (VAT BASIS AND PROV. VATS)                   
         MVC   TOTVAT,20(R1)                                                    
*                                                                               
         LA    R2,132(R2)                                                       
         L     R0,X+8              AOR                                          
         A     R0,TOTVAT           PLUS TOTAL VAT                               
         LA    R1,ALCOL4                                                        
         BAS   RE,AOIEDIT                                                       
*                                                                               
AOI42    DS    0H                                                               
         GOTO1 =A(PRNT)                                                         
         MVI   AOIBILL,C'Y'                                                     
*                                                                               
         MVI   MIXSW,C'N'   CLEAR MIX OF BEFORE AND AFTER JUL/10 SW             
         XC    LASTMOS,LASTMOS     CLEAR LAST MOS                               
*                                                                               
AOI44    DS    0H                                                               
         LTR   R6,R6               END OF TABLE                                 
         BNP   AOI80                                                            
*                                                                               
AOI50    DS    0H                  START NEW BILL                               
         MVC   LASTAORA,PEPTAORA      SAVE ACCOUNT                              
***NEW 5/17/91                                                                  
         MVC   LASTAOVS,PEPTAOVS      AND SAVE VAT CODES                        
         OC    LASTAOVS,SPACES                                                  
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         MVI   DUESW,C'R'                                                       
         XC    X,X                 CLEAR TOTALS                                 
*                                                                               
         LA    R2,P1                                                            
         USING ALINED,R2                                                        
*                                  SET AOR ADDRESS                              
*****    L     RF,PPFILEC          USE CONTRACT AREA                            
*****    USING PPFILED,RF                                                       
*****    LA    R1,PCONREC                                                       
*****    DROP  RF                                                               
*                                                                               
         LA    R1,AORWRK                                                        
         ST    R1,AREC                                                          
         MVC   KEY+27(4),PEPTAORD  DISK ADDRESS                                 
         GOTO1 GETPRT                                                           
         L     RF,AREC                                                          
         USING AORREC,RF                                                        
*                                                                               
         LA    R1,AORELS                                                        
*                                                                               
AOI52    DS    0H                                                               
         CLI   0(R1),X'02'         ADDRESS ELEM                                 
         BE    AOI53                                                            
         CLI   0(R1),0             EOR                                          
         BE    AOI55                                                            
*                                                                               
AOI52D   DS    0H                                                               
         ZIC   R0,1(R1)                                                         
         AR    R1,R0                                                            
         B     AOI52                                                            
*                                                                               
AOI53    DS    0H                  AOR ADDRESS ELEM                             
         USING AORADREL,R1                                                      
         L     RE,=A(AORADDR)                                                   
         MVC   000(30,RE),AORLIN1                                               
         MVC   060(30,RE),AORLIN2                                               
         MVC   120(30,RE),AORLIN3                                               
         MVC   180(30,RE),AORLIN4                                               
         CLC   PEPTAORA(14),AORLIN1       CHECK FOR "DUMMY" ACCOUNT             
         BE    *+10                       THAT I PUT THERE                      
         MVC   180+60-14(14,RE),PEPTAORA    ACCT CODE AT END OF ADDR            
         DROP  RF                                                               
         DROP  R1                                                               
*                                                                               
AOI55    DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   P1+2(62),=C'** AGENCY OF RECORD FEES - CLIENT INVOICE NU         
*--->          MBER NN-NN-NNNN **'                                              
         MVC   P1+2(L'PP@AGYOF),PP@AGYOF                                        
         DROP  RE                                                               
         MVC   P1+2+46(10),LASTPINV                                             
**NEW 3/12/91                                                                   
         CLI   AORLOPT,C'C'                                                     
         BNE   AOI55D                                                           
         CLI   P1+2,C'T'             SEE IF FRENCH (T OF TARIF)                 
         BNE   AOI55C                                                           
         MVC   P1+30(29),SPACES      CLEAR CLIENT INVOICE MESSAGE               
         B     AOI55D                                                           
*                                                                               
AOI55C   MVC   P1+26(32),SPACES      CLEAR CLIENT INVOICE MESSAGE               
***                                                                             
*** NOTE THAT MESSAGE MUST BE SAME FORMAT IN ALL LANGUAGES ***                  
***                                                                             
AOI55D   DS    0H                                                               
****     CLI   TESTFLAG,C'T'                                                    
****     BE    AOI56                                                            
**NEW 3/12/91                                                                   
         CLI   AORLOPT,C'C'    SEE IF CLIENT RECAP MODE                         
         BNE   AOI55E                                                           
         CLI   AORFRST,C'Y'    ADD FIRST TIME                                   
         BE    AOI56           NO - ALREADY HAVE NUMBER                         
AOI55E   DS    0H                                                               
**NEW 3/12/91                                                                   
         GOTOR GETNUM,DMCB,INVNO,PINVNO      GET NEXT BILL NO.                  
*                                                                               
AOI56    DS    0H                                                               
**NEW 3/12/91                                                                   
         MVI   AORFRST,C'N'                                                     
**NEW 3/12/91                                                                   
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
AOI60    DS    0H                  CONTINUE BILL                                
         MVC   PEPTAORI,INVNO      SET INVOICE NUMBER IN PEPTAB                 
*                                                                               
         CLI   PEPTMED,0          WILL BE NON-ZERO FOR                          
         BE    AOI60D             MULTI-MEDIA REQUEST                           
         CLC   LASTAMPE(1),PEPTMED  CHECK FOR CHANGE OF MEDIA                   
         BE    AOI60D                                                           
         XC    KEY,KEY                                                          
         MVC   KEY(2),QAGENCY                                                   
         MVC   KEY+2(1),PEPTMED                                                 
         MVI   KEY+3,X'01'                                                      
         GOTO1 HIGH                                                             
         CLC   KEY(4),KEYSAVE                                                   
         BE    *+6                                                              
         DC    H'0'          SOMETHING VERY WRONG                               
         GOTO1 GETAGY                                                           
         L     RF,PPFILEC                                                       
         USING PPFILED,RF                                                       
         MVC   P1(10),PAGYMED                                                   
*                                                                               
         DROP  RF                                                               
*                                                                               
         BAS   RE,AULINE                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
AOI60D   DS    0H                                                               
         OC    LASTAMPE,LASTAMPE   SEE IF FIRST TIME                            
         BZ    AOI60L                                                           
         CLC   LASTAMPE,PEPTMED    SEE IF MED/FIN/PRD/EST CHGED                 
         BE    AOI60L                                                           
*                                                                               
*                                                                               
*                                  MUST READ AOR RECORD HERE                    
*                                  TO PRINT COMMENT                             
*                                  SINCE THE ACCOUNT MAY BE THE SAME            
*                                  BUT THE COMMENT MIGHT BE DIFFERENT           
         OC    LASTAORD,LASTAORD      BE SURE I HAVE AN ADDRESS                 
         BZ    AOI60L                                                           
******   L     RF,PPFILEC          USE CONTRACT AREA                            
******   USING PPFILED,RF                                                       
******   LA    R1,PCONREC          READ INTO CONTRACT AREA                      
******   DROP  RF                                                               
*                                                                               
         LA    R1,AORWRK                                                        
         ST    R1,AREC                                                          
         MVC   KEY+27(4),LASTAORD  DISK ADDRESS                                 
         GOTO1 GETPRT                                                           
*                                                                               
         L     R1,AREC                                                          
         CLC   AORKEST-AORREC(2,R1),=X'FFFF'                                    
         BNE   AOI60F     IF EST LEVEL MUST AOR COMMENT NOW                     
*                     MUST BE PRODUCT LEVEL                                     
*                     ONLY PRINT IF PRODUCT HAS CHANGED AS WELL                 
         CLC   LASTAMPE(5),PEPTMED   SEE IF MED/FIN/PRD SAME                    
         BE    AOI60L    PRD IS THE SAME - DON'T AOR COMMENT NOW                
*                        IT WILL PRINT WHEN PRD CHANGES                         
*                                                                               
AOI60F   DS    0H                                                               
         BAS   RE,AOICOMM      GO CHECK FOR AOR STANDARD COMMENT                
*                              AND PRINT IT                                     
*                                                                               
AOI60L   DS    0H                                                               
         L     RF,ADCLT                                                         
         XC    KEY,KEY                                                          
         MVC   KEY(07),0(RF)                                                    
*                                                                               
         CLI   PEPTMED,0          MULTI-MEDIA REQUEST                           
         BE    *+10                                                             
         MVC   KEY+2(1),PEPTMED                                                 
*                                                                               
         MVI   KEY+3,X'06'                                                      
         MVC   KEY+7(3),PEPTPRD    3 CHAR PRD CODE                              
         L     RF,ADPRD                                                         
         CLC   KEY(10),0(RF)       TEST ALREADY HAVE PRDHDR                     
         BE    AOI62                                                            
         GOTO1 HIGH                                                             
         CLC   KEY(10),KEYSAVE     MUST FIND PRD                                
         BE    *+6                                                              
         DC    H'0'                                                             
         L     RF,ADPRD                                                         
         ST    RF,AREC                                                          
         GOTO1 GETPRT                                                           
*                                                                               
AOI62    DS    0H                                                               
         L     RF,ADPRD                                                         
         MVC   P1(3),PPRDKPRD-PPRDREC(RF)                                       
*                                                                               
         MVC   W(20),PPRDNAME-PPRDREC(RF)                                       
         OC    W(20),SPACES                                                     
         GOTO1 =V(CHOPPER),DMCB,(20,W),(16,P1+4),(C'P',2)                       
*                                                                               
         EDIT  (B2,PEPTEST),(3,ALCOL1+1),FILL=0                                 
         GOTO1 DATCON,DMCB,(3,PEPTMOS),(6,ALCOL1+8)                             
*                                                                               
         MVC   WRKGRS,PEPTGRS                                                   
         MVC   WRKNET,PEPTNET                                                   
         MVC   WRKAC,PEPTAC                                                     
*                                                                               
         TM    FINANSW,X'80'       SEE IF COST 2 CLIENT                         
         BNO   AOI62C                                                           
         CLI   PROFAOR+5,C'Y'      SEE IF BASED ON COST 2 (OPEN)                
         BNE   AOI62C                                                           
*                                                                               
         MVC   WRKGRS,PEPTOGRS     SET TO COST2 (OPEN) AMOUNTS                  
         MVC   WRKNET,PEPTONET                                                  
         MVC   WRKAC,PEPTOAC                                                    
*                                                                               
AOI62C   DS    0H                                                               
         L     R0,WRKGRS           TOTAL GROSS                                  
*                                                                               
         CLI   AORNOPT,C'Y'        SHOWING NET INSTEAD?                         
         BNE   *+8                                                              
         L     R0,WRKNET           TOTAL NET                                    
*                                                                               
**NEW 3/12/91                                                                   
         CLI   AORTXOPT,C'Y'       TEST TO INCLUDE TAX                          
         BE    *+8                                                              
         S     R0,PEPTTAX          NO - REMOVE IT                               
**NEW 3/12/91                                                                   
         A     R0,X                                                             
         ST    R0,X                                                             
         L     R0,PEPTAOR          AND AOR AMOUNT                               
         A     R0,X+8                                                           
         ST    R0,X+8                                                           
*                                                                               
         L     R0,WRKAC            AC - NEVER SUBTRACT TAX                      
         TM    PEPTAORB,X'80'                                                   
         BO    AOI62ADD                                                         
*                                                                               
         L     R0,WRKNET           NET                                          
         TM    PEPTAORB,X'40'                                                   
         BO    AOI62TAX                                                         
         L     R0,WRKGRS           GROSS                                        
         CLI   PEPTAORB,0                                                       
         BE    AOI62TAX                                                         
         DC    H'0'                BAD AOR BASIS                                
*                                                                               
AOI62TAX DS    0H                                                               
         CLI   AORTXOPT,C'Y'       TEST TO INCLUDE TAX                          
         BE    *+8                                                              
         S     R0,PEPTTAX          NO - REMOVE IT                               
*                                                                               
AOI62ADD A     R0,X+4                                                           
         ST    R0,X+4               TOTAL OF BASIS IN X+4                       
*                                                                               
**GST                                                                           
         LA    R1,NPROVS+1                                                      
         LA    RE,PEPTVATA                                                      
         LA    RF,X+16                                                          
AOI63    DS    0H                                                               
         L     R0,0(RE)                                                         
         A     R0,0(RF)                                                         
         ST    R0,0(RF)                                                         
         LA    RE,4(RE)                                                         
         LA    RF,4(RF)                                                         
         BCT   R1,AOI63                                                         
*                                                                               
         L     R0,WRKGRS           GROSS                                        
*                                                                               
         CLI   AORNOPT,C'Y'        SHOWING NET INSTEAD?                         
         BNE   *+8                                                              
         L     R0,WRKNET           TOTAL NET                                    
*                                                                               
**NEW 3/12/91                                                                   
         CLI   AORTXOPT,C'Y'                                                    
         BE    *+8                                                              
         S     R0,PEPTTAX                                                       
**NEW 3/12/91                                                                   
         LA    R1,ALCOL2                                                        
         BAS   RE,AOIEDIT                                                       
*                                                                               
         ICM   R0,15,PEPTAOR       AOR AMOUNT                                   
         LA    R1,ALCOL4                                                        
         BAS   RE,AOIEDIT                                                       
*                                                                               
         ICM   RE,15,PEPTAORP         AOR PERCENT                               
         LA    R8,ALCOL3                                                        
         MVI   CURTAB+3,4                                                       
*--->    EDIT  (RE),(7,0(R8)),4,FLOAT=-                                         
         CURED (RE),(8,0(R8)),CURTAB,FLOAT=-                                    
         MVI   CURTAB+3,2                                                       
         CLC   6(2,R8),=C'00'                                                   
         BNE   *+10                                                             
         MVC   6(2,R8),SPACES                                                   
         LA    R8,9(R8)                                                         
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*                                                                               
         MVC   0(L'PP@NET,R8),PP@NET                                            
         L     R0,WRKNET                                                        
         TM    PEPTAORB,X'40'                                                   
         BO    AOI64                                                            
*                                                                               
*--->    MVC   0(5,R8),=C'GROSS'   BASIS                                        
         MVC   0(L'PP@GROSS,R8),PP@GROSS                                        
         L     R0,WRKGRS                                                        
         CLI   PEPTAORB,0                                                       
         BE    AOI64                                                            
*                                                                               
*--->    MVC   0(5,R8),=C'COMM.'                                                
         MVC   0(L'PP@COMM,R8),PP@COMM                                          
         DROP  RE                                                               
*                                                                               
         L     R0,WRKAC                                                         
         TM    PEPTAORB,X'80'         AGY COMMISSION                            
         BO    AOI65                 **NEW 3/12/91 WAS AOI64                    
         DC    H'0'                   INVALID AOR BASIS                         
*                                                                               
AOI64    DS    0H                                                               
**NEW 3/12/91                                                                   
         CLI   AORTXOPT,C'Y'                                                    
         BE    AOI65                                                            
         S     R0,PEPTTAX                                                       
**NEW 3/12/91                                                                   
*                                                                               
AOI65    DS    0H                                                               
         LA    R1,ALSTRIP          BASIS AMOUNT IN STRIP                        
         BAS   RE,AOIEDIT                                                       
*                                                                               
         GOTO1 =A(PRNT)                                                         
         MVI   AOIBILL,C'Y'       BILL CREATED                                  
*                                                                               
AOI70    DS    0H                  NEXT PEPTAB ENTRY                            
         MVC   LASTAMPE,PEPTMED    SAVE LAST MED/FIN/PRD/EST                    
         MVC   LASTAORD,PEPTAORD   AND DISK ADDRESS                             
         LA    R7,PEPTABRL(R7)                                                  
         BCT   R6,AOI30                                                         
*                                                                               
AOI70X   XC    LASTAMPE,LASTAMPE   CLEAR MED/FIN/PRD/EST                        
         B     AOI40               GO PRINT TOTALS                              
*                                                                               
AOI80    DS    0H                  END                                          
         CLI   AOIBILL,C'Y'       BILL CREATED?                                 
         BNE   AOIX                                                             
*                                                                               
         CLI   WPPOPT,C'Y'        WPP AGENCY?                                   
         BNE   AOI80X                                                           
*                                                                               
         BRAS  RE,PRTWCOM         PRINT WPP AGENCY COMMENT                      
*                                                                               
AOI80X   DS    0H                                                               
         BRAS  RE,WBILL                                                         
         MVI   PRSW,C'F'           SET TO FLUSH LINES NOW                       
         GOTO1 =A(PRNT)                                                         
*                                                                               
**NEW 3/12/91                                                                   
         MVI   DUESW,C'N'                                                       
*                                                                               
         CLI   AORLOPT,C'C'        SEE IF DOING 'CLIENT' SUMMARY                
         BNE   AOIX                                                             
         OC    LASTAORA,LASTAORA  AND ACTUALLY DID SOMETHING                    
         BZ    AOIX                                                             
         GOTOR GETNUM,DMCB,INVNO,PINVNO                                         
*                                  MUST BUMP BILL NUMBER WHEN DONE              
         B     AOIX                                                             
         SPACE 3                                                                
AOIEDIT  DS    0H                                                               
         ST    RE,DUB                                                           
         LR    R5,R1                                                            
*--->    EDIT  (R0),(16,0(R5)),2,COMMAS=YES,CR=YES                              
         CURED (R0),(16,0(R5)),CURTAB,COMMAS=YES,CR=YES                         
         LR    R1,R5                                                            
         L     RE,DUB                                                           
         BR    RE                                                               
*                                                                               
         SPACE 2                                                                
AOIX     DS    0H                                                               
         MVI   MIXSW,C'N'       CLEAR THIS SWITCH                               
         XIT1                                                                   
         EJECT                                                                  
*                                                                               
*    ROUTINE TO FIND AND PRINT STANDARD COMMENT FROM AOR RECORD                 
*    PCONREC SHOULD CONTAIN AOR RECORD                                          
*                                                                               
AOICOMM  NTR1                                                                   
*****    L     RF,PPFILEC      READ AOR RECORD INTO PCONREC                     
*****    USING PPFILED,RF      AND CHECK FOR STANTARD COMMENT ELEM              
*****    LA    R1,PCONREC                                                       
*****    DROP  RF                                                               
*****    LR    RF,R1               AOR RECORD IS NOW IN PCONREC                 
*                                                                               
         LA    RF,AORWRK       AOR RECORD NOW IN AORWRK                         
         USING AORREC,RF                                                        
*                                                                               
         LA    R1,AORELS                                                        
*                                                                               
AOIC2    DS    0H                                                               
         CLI   0(R1),X'66'         STANDARD COMMENT ELEM                        
         BE    AOIC3                                                            
         CLI   0(R1),0             EOR                                          
         BE    AOICX                                                            
*                                                                               
AOIC2D   DS    0H                                                               
         ZIC   R0,1(R1)                                                         
         AR    R1,R0                                                            
         B     AOIC2                                                            
*                                                                               
AOIC3    DS    0H                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(3),RCSVAGY                                                   
*                                                                               
         MVC   KEY+2(1),AORKMED    USE MEDIA FROM AORREC                        
*                                                                               
*****    OC    AMED,AMED    FOR MULTI-MEDIA REQ GET MEDIA FROM AMED             
*****    BZ    AOIC3D                                                           
*****    L     RF,AMED                                                          
*****    MVC   KEY+2(1),0(RF)                                                   
*                                                                               
AOIC3D   MVI   KEY+3,X'40'                                                      
         MVC   KEY+4(6),2(R1)      COMMENT CODE FROM ELEM                       
         L     RF,ACOMREC                                                       
         CLC   KEY(25),0(RF)                                                    
         BE    AOIC4               ALREADY HAVE                                 
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE                                                  
         BNE   AOIC13                                                           
*                                                                               
         MVC   AREC,ACOMREC                                                     
         GOTO1 GETPRT                                                           
*                                                                               
AOIC4    DS    0H                                                               
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
*                                  COUNT LINES NEEDED                           
         SR    RF,RF                                                            
         L     R2,ACOMREC                                                       
         LA    R2,33(R2)                                                        
         SR    R0,R0                                                            
AOIC6    DS    0H                                                               
         CLI   0(R2),0                                                          
         BE    AOIC9                                                            
         CLI   0(R2),X'40'                                                      
         BNE   AOIC8                                                            
         LA    R0,1                                                             
         CLI   2(R2),C'+'                                                       
         BNE   AOIC7                                                            
         CLI   3(R2),C'1'                                                       
         BL    AOIC7                                                            
         MVC   BYTE,3(R2)                                                       
         NI    BYTE,X'0F'                                                       
         IC    R0,BYTE                                                          
AOIC7    DS    0H                                                               
         AR    RF,R0                                                            
AOIC8    DS    0H                                                               
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     AOIC6                                                            
*                                                                               
AOIC9    DS    0H                                                               
         LA    RF,1(RF)                                                         
         STC   RF,ALLOWLIN         NUMBER OF LINES NEEDED                       
         L     R2,ACOMREC                                                       
         LA    R2,33(R2)                                                        
AOIC10   DS    0H                                                               
         CLI   0(R2),0                                                          
         BE    AOIC13                                                           
         CLI   0(R2),X'40'                                                      
         BNE   AOIC12                                                           
         LA    R6,2                                                             
         CLI   2(R2),C'+'                                                       
         BNE   AOIC11                                                           
         CLI   3(R2),C'1'                                                       
         BL    AOIC11                                                           
         MVC   SPACING,3(R2)                                                    
         NI    SPACING,X'0F'                                                    
         GOTO1 =A(PRNT)                                                         
*                                                                               
         LA    R6,4                                                             
AOIC11   DS    0H                                                               
         IC    RF,1(R2)                                                         
         SR    RF,R6                                                            
         AR    R6,R2                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   P1+8(0),0(R6)                                                    
         CLI   P1+8,X'00'    POSSIBLE FOR EMPTY LINES                           
         BNE   AOIC11X                                                          
         MVI   P1+8,C' '     CHANGE TO SPACE                                    
         MVI   P1,0          SO IT WILL PRINT                                   
*                                                                               
AOIC11X  DS    0H                                                               
*                                                                               
         GOTO1 =A(PRNT)                                                         
*                                                                               
AOIC12   DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     AOIC10                                                           
*                                                                               
AOIC13   DS    0H                                                               
         B     AOICX         COMMENT NOT FOUND - DON'T DIE                      
*                            JUST EXIT                                          
*                                                                               
AOIC20   DS    0H                                                               
AOICX    XIT1                                                                   
*                                                                               
         DROP  RF                                                               
*                                                                               
*        ULINE IN FIRST BLANK LINE                                              
AULINE   NTR1                                                                   
*                                  FIND FIRST BLANK LINE                        
         LA    R3,P1                                                            
         SR    RE,RE                                                            
AUL2     DS    0H                                                               
         OC    0(40,R3),SPACES                                                  
         CLC   0(40,R3),SPACES                                                  
         BE    AUL4                                                             
         LA    R3,132(R3)                                                       
         LA    RE,1(RE)                                                         
         B     AUL2                                                             
*                                                                               
AUL4     DS    0H                                                               
         LTR   RE,RE                                                            
         BNP   AULX                                                             
*                                                                               
         LA    RF,P1+40                                                         
AUL5     DS    0H                                                               
         LR    R1,RF                                                            
         LR    R0,RE                                                            
AUL6     DS    0H                                                               
         CLI   0(R1),C' '                                                       
         BH    AUL8                FIRST NON-BLACK CHAR                         
         LA    R1,132(R1)                                                       
         BCT   R0,AUL6                                                          
*                                                                               
         BCT   RF,AUL5                                                          
*                                                                               
AUL8     DS    0H                                                               
         LA    R0,P1                                                            
         SR    RF,R0                                                            
         BM    AULX                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),DASHES                                                   
*                                                                               
AULX     DS    0H                                                               
         XIT1                                                                   
         LTORG                                                                  
         DROP  R2                                                               
         DROP  R7                                                               
*                                                                               
AJUL10SW DC    X'00'                                                            
*                                                                               
AOIBILL  DC    C'N'                                                             
*                                                                               
AOIDISK  DC    F'0'              USED TO SAVE AOR DISK ADDR                     
*                                                                               
LASTAMPE DC    XL7'00'      LAST MED/FIN/PRD/EST                                
*                                                                               
LASTAORD DC    F'0'    AOR DISK ADDRESS FOR LAST MED/FIN/PRD/EST                
*                                                                               
*                                                                               
WRKGRS   DC    F'0'   WORKING VALUES - COULD BE CONTRACT OR COST2               
WRKNET   DC    F'0'                                         (OPEN)              
WRKAC    DC    F'0'                                                             
*                                                                               
LASTAORA DS    CL14                                                             
LASTAORV DS    0CL1             OLD TAG                                         
LASTAOVS DS    CL11             LAST AOR PST CODE SET                           
*                                                                               
*                                                                               
AORWRK   DS    XL500      FOR AOR RECORD                                        
*                                                                               
         TITLE 'BILCALC - CALCULATE AMOUNTS DUE'                                
BILCALC  NMOD1 0,BILCALC                                                        
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
*                                                                               
         XC    BCTRDC,BCTRDC        CLEAR BILLABLE TRADE CREDITS                
*                                                                               
         CLI   PASSNO,1                                                         
         BE    BC1                                                              
*                                                                               
*              ONLY REDO ADJUSTMENTS ON PASS 2                                  
*              IF DOING ADJSEP WITH DETAIL BACK-UP                              
*           OR IF DOING AORINV WITH DETAIL BACK-UP                              
*                                                                               
         CLI   PASSNO,2                                                         
         BNE   BCX                                                              
         OC    ARECAP,ARECAP                                                    
         BZ    BCX                                                              
         CLI   AORSW,C'Y'                                                       
         BE    BC1                                                              
         CLI   ADJSEP,C'Y'                                                      
         BNE   BCX                                                              
*                                                                               
BC1      DS    0H                                                               
*                                                                               
         MVI   PVATSW,0         CLEAR BILLABLE VAT SWITCH                       
*                                                                               
         LA    R1,WKROW                                                         
         XC    0(256,R1),0(R1)                                                  
         XC    256(256,R1),256(R1)                                              
         XC    512(L'WKROW-512,R1),512(R1)                                      
*      REPLACES THE FOLLOWING THREE LINES                                       
*        XC    WKROW(256),WKROW                                                 
*        XC    WKROW+256(256),WKROW+256                                         
*        XC    WKROW+512(L'WKROW-512),WKROW+512                                 
*                                                                               
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)      POINT TO ACCUM                                 
         LR    RF,R7                                                            
*                                                                               
         LR    RE,R7                                                            
         AH    RE,=Y(TOTSIZE-BFORML)     POINT TO FORMULA INFO                  
         OC    0(BFORML,RE),0(RE)      IF ROLLED UP FROM LOWER LEVEL            
         BNZ   BCX                     THEN DONE                                
*                                                                               
         LA    R6,MAXMOS                                                        
         LA    R5,PERLIST                                                       
         XC    DUB,DUB                                                          
BC2      DS    0H                                                               
         CLC   0(16,RF),ROWHL(RF)    WAS (16) NOW CHECKS TAX AND INS.           
         BNE   BC2A                                                             
         CLC   20(4,RF),ROWHL+20(RF) NOW CHECK # OF INS. AS WELL                
         BNE   BC2A                                                             
         CLC   ROWTL(16,RF),ROWTL+ROWHL(RF)  CAN STAY AT (16)                   
         BE    BC2A4                                                            
***TAX   NOTE CHECKS ABOVE WILL NOT DETECT BILLABLE TAX                         
***TAX        SHOULD BE OK SINCE TAX PCT WILL NOT CHANGE FOR                    
***TAX        BILLED INSERTIONS                                                 
***TAX        ALSO THERE MAY DESCRIPANCIES DUE TO ROUNDING ERRORS               
BC2A     DS    0H                                                               
         MVC   DUB(2),0(R5)        SAVE DATE FOR BILL FORM EFF DATE             
         MVC   BCMOS,0(R5)                                                      
*                                                                               
*                                                                               
BC2A4    DS    0H                                                               
*                                  NOTE-WHOLE BILL EITHER OK OR NOT             
         OC    OADJDSP(8,RF),OADJDSP(RF)                                        
         BNZ   BCX                                                              
         OC    ADJDSP(8,RF),ADJDSP(RF)     EXIT IF ADJ'S ALREADY THERE          
         BNZ   BCX                 (TOTAL'D UP FROM LOWER LEVEL)                
         OC    AORDSP(56,RF),AORDSP(RF)    EXIT IF ADJ'S ALREADY THERE          
         BNZ   BCX                 (TOTAL'D UP FROM LOWER LEVEL)                
         LA    RF,ROWL(RF)                                                      
         LA    R5,8(R5)            BUMP DATE                                    
         BCT   R6,BC2                                                           
*                                                                               
         OC    DUB,DUB             IF NO BILLABLES                              
         BNZ   BC2A6                                                            
BC2A5    SH    R5,=H'8'            BACK-UP ONE MONTH                            
         OC    0(2,R5),0(R5)       NO ENTRY                                     
         BZ    BC2A5                                                            
         CLC   0(2,R5),=X'FF00'    OR END OF LIST                               
         BE    BC2A5                                                            
         MVC   DUB(2),0(R5)        USE LAST DATE FOR EFF DATE CHECK             
*                                                                               
*                                                                               
*                                  SET BILLING FORMULA IN W                     
BC2A6    XC    W,W                                                              
         MVI   CRFORMSW,C'Y'       SPECIAL CORP RETAIL FORMULA                  
         CLI   RETPROF+15,C'Y'     TEST OPTION TO SKIP TO AAA                   
         BNE   BC2A6B                                                           
         CLI   UPASS,1                                                          
         BE    BC2B                                                             
         CLI   UPASS,X'FF'       WAS C'S'                                       
         BE    BC2B                                                             
*                                                                               
BC2A6B   DS    0H                                                               
         CLI   RETPROF+15,C'0'     TEST OUTLET CODE BASED ON AAA OPTION         
         BNH   BC2A6D              (LAST "N" DIGITS ARE 0)                      
         CLI   UPASS,X'FF'         USE AAA FOR SUMMARY - WAS C'S'               
         BE    BC2B                                                             
         L     R4,=A(GDAREA)                                                    
         USING GDSECT,R4                                                        
         ZIC   R1,GDOUTLEN-GDSECT(R4)                                           
         L     R4,GDOUTAD-GDSECT(R4)      A(OUTLET)                             
         LA    R4,GDOCODE-GDOUTD(R4,R1)                                         
         ZIC   R1,RETPROF+15                                                    
         SH    R1,=H'240'                                                       
         SR    R4,R1                                                            
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R4),=C'000000'                                               
         BE    BC2B                                                             
*                                                                               
BC2A6D   MVI   CRFORMSW,C'N'       NO SPECIAL CORP RETIAL FORMULA               
*                                                                               
         CLI   BFROPT,C'N'         TEST USING BILL FORM RECORDS                 
         BE    BC2A6DX                                                          
         LA    R4,GETBFRW          (NULLS FIRST TIME)                           
         USING PPGBFRDD,R4                                                      
*                                                                               
         MVC   PPGBAGY,QAGENCY                                                  
         MVC   PPGBMED,QMEDIA                                                   
         OC    AMED,AMED                                                        
         BZ    BC2A6F                                                           
         L     RF,AMED           MUST CHECK AMED FOR MEDIA                      
         MVC   PPGBMED,0(RF)                                                    
*                                                                               
BC2A6F   DS    0H                                                               
         L     RF,ADCLT                                                         
         MVC   PPGBCLT,4(RF)                                                    
         L     RF,APRD                                                          
         MVC   PPGBPRD,0(RF)        3 CHAR PRD CODE                             
         L     RF,AEST                                                          
         MVC   PPGBEST,0(RF)                                                    
         MVC   PPGBMOS,DUB         MONTH OF SERVICE                             
         CLI   PERCTL,C'S'         IF MONTHS SEPARATE                           
         BE    *+10                ELSE USE REQUEST MONTH                       
         MVC   PPGBMOS,CURPER                                                   
         MVC   PPGBACOM,VCOMFACS                                                
*                                                                               
         MVC   PPGBLODR,LOADER                                                  
         GOTO1 =V(PPGETBFR),DMCB,PPGBFRDD                                       
*                                                                               
BC2AU    DS    0H                                                               
         MVC   W(5),PPGBFORM                                                    
*                                                                               
         MVI   W+5,0                                                            
         TM    PPGBFORM,X'40'    SEE IF COMMISSION ONLY                         
         BZ    *+8                                                              
         MVI   W+5,C'C'                                                         
*                                                                               
*        BILLING FORMULA RECORDS WILL SOON SUPPORT PRINTING                     
*        AN ADJUSTMENT BASED ON AC TO PRINT AS SOMETHING                        
*        ELSE - THIS IS LIKE THE CHAB FEATURE RELEASED IN 1992                  
*                                                                               
         MVC   W+6(1),PPGBACO    ONLY FOR PRINTING                              
         MVC   W+7(3),PPGBACP    ONLY FOR PRINTING                              
         CLI   PPGBACO,X'01'     CHECK FOR VALID DATA - GROSS                   
         BE    BC3A                                                             
         CLI   PPGBACO,X'02'     CHECK FOR VALID DATA - NET                     
         BE    BC3A                                                             
         CLI   PPGBACO,X'05'     CHECK FOR VALID DATA - GROSS-CD                
         BE    BC3A                                                             
         CLI   PPGBACO,X'06'     CHECK FOR VALID DATA - NET-CD                  
         BE    BC3A                                                             
         XC    W+6(4),W+6        OTHERWISE CLEAR                                
         B     BC3A                                                             
         DROP  R4                                                               
*                                                                               
BC2A6DX  DS    0H                                                               
*                                                                               
         CLC   DUB(2),ESTFORM+5    EST EFFDATE                                  
         BL    BC2A8                                                            
         CLI   ESTFORM+BILNBSW-BILPROF,C'Y'  SEE IF NOT FOR BILLING             
         BE    BC2A8                                                            
         OC    W(5),ESTFORM                                                     
         BZ    BC2A8                                                            
         MVC   W+5(1),ESTFORM+BILCMSW-BILPROF                                   
***NEW 5/20/91                                                                  
         MVC   W+6(1),ESTFORM+BILPBASB-BILPROF   ONLY FOR PRINTING              
         MVC   W+7(3),ESTFORM+BILPADJ-BILPROF    ONLY FOR PRINTING              
***NEW 5/20/91                                                                  
         B     BC3                                                              
BC2A8    CLC   DUB(2),PRDFORM+5    PRD EFF DATE                                 
         BL    BC2B                                                             
         CLI   PRDFORM+BILNBSW-BILPROF,C'Y'  SEE IF NOT FOR BILLING             
         BE    BC2B                                                             
         OC    W(5),PRDFORM                                                     
         BZ    BC2B                                                             
         MVC   W+5(1),PRDFORM+BILCMSW-BILPROF                                   
***NEW 5/20/91                                                                  
         MVC   W+6(1),PRDFORM+BILPBASB-BILPROF   ONLY FOR PRINTING              
         MVC   W+7(3),PRDFORM+BILPADJ-BILPROF    ONLY FOR PRINTING              
***NEW 5/20/91                                                                  
         B     BC3                                                              
BC2B     DS    0H                                                               
         CLC   DUB(2),AAEFORM+5    AAA EST EFFDATE                              
         BL    BC2C                                                             
         CLI   AAEFORM+BILNBSW-BILPROF,C'Y'  SEE IF NOT FOR BILLING             
         BE    BC2C                                                             
         OC    W(5),AAEFORM    AAA EST FORMULA                                  
         BZ    BC2C                                                             
         MVC   W+5(1),AAEFORM+BILCMSW-BILPROF                                   
***NEW 5/20/91                                                                  
         MVC   W+6(1),AAEFORM+BILPBASB-BILPROF   ONLY FOR PRINTING              
         MVC   W+7(3),AAEFORM+BILPADJ-BILPROF    ONLY FOR PRINTING              
***NEW 5/20/91                                                                  
         B     BC3                                                              
BC2C     CLC   DUB(2),AAAFORM+5   AAA PRD FORMULA EFF DATE                      
         BL    BC3                                                              
         CLI   AAAFORM+BILNBSW-BILPROF,C'Y'  SEE IF NOT FOR BILLING             
         BE    BC3                                                              
         OC    W(5),AAAFORM    AAA PRD FORMULA                                  
         MVC   W+5(1),AAAFORM+BILCMSW-BILPROF                                   
***NEW 5/20/91                                                                  
         MVC   W+6(1),AAAFORM+BILPBASB-BILPROF   ONLY FOR PRINTING              
         MVC   W+7(3),AAAFORM+BILPADJ-BILPROF    ONLY FOR PRINTING              
***NEW 5/20/91                                                                  
BC3      DS    0H                                                               
BC3A     DS    0H      FROM SFM BF LOGIC - MAY SET NEW FORMULA                  
         LR    RF,R7                                                            
         AH    RF,=Y(TOTSIZE-BFORML)                                            
******** LA    RF,TOTSIZE-BFORML(R7)                                            
*                                                                               
         CLI   SCBNCSW,C'N'        NET BILLING IN SCB CASE                      
         BNE   BC3B                                                             
         MVC   FULL2(1),W          SAVE "REAL" FORMULA                          
         CLI   FULL2,0             SEE IF I HAVE ONE                            
         BNE   *+8                                                              
         MVI   FULL2,X'05'         DEFAULT TO G-CD                              
*                                                                               
         MVC   W(5),=X'0202000000'      SET TO NET + ZERO PCT OF NET            
*                                                                               
         TM    FULL2,X'04'      SEE IF "REAL" FORMULA SUBTRACTED CD             
         BZ    BC3B                                                             
         CLI   PROFB2B+4,C'Y'       SEE IF CD ON NET BILL                       
         BNE   *+10                                                             
         MVC   W(2),=X'0606'       CHANGE TO NET-CD                             
*                                                                               
BC3B     DS    0H                                                               
*                                                                               
         OC    ACRDB,ACRDB         CREDIT/DEBIT BREAK CODE?                     
         BZ    BC3B2                                                            
         CLI   PROGPRO2+13,C'Y'    CREDIT/DEBIT ON SEPARATE?                    
         BE    BC3B2               LEAVE FORMULA ALONE                          
         CLI   PROGPRO2+13,C'N'    NO BREAKOUT                                  
         BE    BC3B2                                                            
*                                                                               
*        FOR VALUES R (S-RATES) AND C (ADDITIONAL CHGS)                         
*        AND B (BOTH AC=0 AND ADDITIONAL CHARGES)                               
*        DON'T APPLY ANY FORMULA ADJUSTMENTS                                    
*       -NO COMMISSION ADJUSTMENTS FOR THESE INVOICES                           
*                                                                               
         L     RE,ACRDB                                                         
         CLI   0(RE),C'D'   DEBIT CODE?                                         
         BNE   BC3B2                                                            
         XC    W+2(8),W+2  CLEAR ADJ % AND ANY SHOW AS OVERRIDES                
*                                                                               
BC3B2    DS    0H                                                               
***E***                                                                         
**                                                                              
         CLC   QPROG,=C'E1'        ON ESTIMATES - NO ADJUSTMENTS                
         BNE   BC3B5                                                            
*                                                                               
**       CODE BELOW FOR E1 REPORT NO-OPED FOR NOW                               
**       IF E1 EVER RELEASED WOULD NEED TO BE RE-INSTATED                       
**       NO-OPED NOW SO THAT I CAN ADDRESS SOME FIELDS                          
**       AT END OF THIS ROUTINE                                                 
*                                                                               
*****    MVC   W(5),=X'0101000000'            SET BF TO GROSS                   
*****    CLI   PROGPRO3,C'Y'                                                    
*****    BE    BC3B4                                                            
*****    MVC   W(5),=X'0202000000'            SET BF TO NET                     
*****    CLI   PROGPRO3+1,C'Y'                                                  
*****    BE    BC3B4                                                            
*****    MVC   W(5),=X'0505000000'            SET BF TO GROSS-CD                
*****    CLI   PROGPRO3+3,C'Y'                                                  
*****    BE    BC3B4                                                            
*****    MVC   W(5),=X'0606000000'            SET BF TO NET-CD                  
*****    CLI   PROGPRO3+4,C'Y'                                                  
*****    BE    BC3B4                                                            
*****    MVC   W(5),=X'0101000000'            RESET TO GROSS                    
*                                                                               
BC3B4    XC    W+6(4),W+6            CLEAR OVERRIDES                            
BC3B5    DS    0H                                                               
***E***                                                                         
******                       SKIP CODE THAT SET FORMULA TO GROSS                
         OC    W(5),W        SEE IF I HAVE A FORMULA                            
         BNZ   BC3D          USE IT EVEN FOR FINANCIAL REBATE                   
*                                                                               
*                            IF NO FORMULA STILL SET TO GROSS                   
*                            FOR FINANCIAL REBATE BILLING                       
***R***                                                                         
         CLC   QPROG,=C'R1'        FOR FINANCIAL REBATE BILL                    
         BNE   *+16                                                             
         MVC   W(5),=X'0101000000'    SET FORMULA TO GROSS                      
         XC    W+6(4),W+6          CLEAR PRINTING OVERRIDES                     
         CLC   QPROG,=C'RD'        FOR FINANCIAL REBATE BILL DRAFT              
         BNE   *+16                                                             
         MVC   W(5),=X'0101000000'    SET FORMULA TO GROSS                      
         XC    W+6(4),W+6          CLEAR PRINTING OVERRIDES                     
***R***                                                                         
BC3D     MVC   0(6,RF),W           SET FORMULA IN ACCUM                         
***NEW 5/20/91                                                                  
         LA    RE,BFPBASB-BFORMD(RF)                                            
         MVC   0(1,RE),W+6                                                      
         LA    RE,BFPCOMP-BFORMD(RF)                                            
         MVC   0(3,RE),W+7                                                      
***NEW 5/20/91                                                                  
*                                                                               
         LA    RE,BFAORPCT-BFORMD(RF)                                           
         MVC   0(3,RE),SVAORPCT+1    SAVE AOR PCT                               
**GST                                                                           
***                                                                             
***      NOTE THAT CVATSW BY ITSELF (NOT THE PROVINCE SWITCHES)                 
***      ACTUALLY CONTROLS MOST THINGS                                          
***                                                                             
         XC    CVATSWS,CVATSWS   SET VATABLE OFF                                
         XC    NVATSWS,NVATSWS   SET VATABLE OFF                                
                                                                                
         MVI   PVATSW,0          GETS SET TO Y IF ANY PST BILLABLE              
*                                                                               
         CLI   CVATCOD,0         NOT VATABLE IF NO VAT CODE                     
         BE    BC3L                                                             
         CLC   DUB(2),CVATSTRT   CHK THIS MONTH VS. VAT START                   
         BL    BC3F              NOTE - EITHER ALL MTHS VATABLE                 
*                                OR ALL NOT VATABLE                             
         MVI   CVATSW,C'Y'                                                      
         MVI   NVATSW,C'Y'                                                      
*                                                                               
BC3F     DS    0H                SET ON VAT SWS FOR PROV                        
*                                NOTE - NO EFFECTIVE DATE CHECK                 
         LA    RE,CVATCDS+1                                                     
         LA    R1,CVATSWS+1                                                     
*                                                                               
         LA    R0,NPROVS                                                        
*                                                                               
BC3G     DS    0H                                                               
         CLI   0(RE),C' '                                                       
         BNH   *+12                                                             
         MVI   0(R1),C'Y'           SET PROV SWITCH ON                          
         MVI   PVATSW,C'Y'          CHECKED AT BC4 FOR BILLABLE VATS            
         LA    RE,1(RE)                                                         
         LA    R1,1(R1)                                                         
         BCT   R0,BC3G                                                          
*                                                                               
         LA    RE,NVATCDS+1         ALSO SET NVATSWS                            
         LA    R1,NVATSWS+1                                                     
*                                                                               
         LA    R0,NPROVS                                                        
*                                                                               
BC3G5    DS    0H                                                               
         CLI   0(RE),C' '                                                       
         BNH   *+12                                                             
         MVI   0(R1),C'Y'           SET PROV SWITCH ON                          
         MVI   PVATSW,C'Y'          CHECKED AT BC4 FOR BILLABLE VATS            
         LA    RE,1(RE)                                                         
         LA    R1,1(R1)                                                         
         BCT   R0,BC3G5                                                         
*                                                                               
BC3L     DS    0H                                                               
         MVC   BFVATCDS-BFORMD(,RF),CVATCDS    VAT DATA INTO BFORMD             
         MVC   BFVATSWS-BFORMD(,RF),CVATSWS                                     
*                                                                               
         CLC   BCMOS,=X'6E07'          MOS CHECK  - JUL/10                      
         BL    *+16                                                             
         MVC   BFVATCDS-BFORMD(,RF),NVATCDS    VAT DATA INTO BFORMD             
         MVC   BFVATSWS-BFORMD(,RF),NVATSWS                                     
*                                                                               
******   LA    RE,BFVATCOD-BFORMD(RF)                                           
******   MVC   0(1,RE),CVATCOD                                                  
******   LA    RE,BFVATSW-BFORMD(RF)                                            
******   MVC   0(1,RE),CVATSW                                                   
*                                                                               
         OC    W(5),W              CHK FOR FORMULA                              
         BNZ   *+10                                                             
         MVC   W(5),=X'0505000000'    SET DEFAULT FORMULA                       
         MVC   W+20(5),W           SAVE FORMULA FOR PEPTAB                      
*                                  G-CD - 0 PCT G-CD                            
*                                                                               
*              W+5  'C'  MEANS COMMISSION ONLY                                  
*                                                                               
         LA    R6,MAXMOS                                                        
         LA    R5,PERLIST                                                       
BC4      DS    0H                                                               
         XC    BCGRS(16),BCGRS      CLEAR DERIVED GR AND NET,CD,AC              
*                                                                               
         CLI   PVATSW,C'Y'             CHECK FOR BILLABLE VATS                  
         BE    BC4B                    MUST GO TO BC4B                          
*                                      EVEN IF THERE ARE NO BILLABLES           
*                                                                               
         CLC   0(16,R7),ROWHL(R7)      TEST ANY BALANCE                         
         BNE   BC4B                                                             
         CLC   ROWTL(16,R7),ROWTL+ROWHL(R7)       OPEN BALANCE                  
         BNE   BC4B                                                             
***TAX   NOTE CHECKS ABOVE WILL NOT DETECT BILLABLE TAX                         
***TAX        SHOULD BE OK SINCE TAX PCT WILL NOT CHANGE FOR                    
***TAX        BILLED INSERTIONS                                                 
***TAX        ALSO THERE MAY DESCRIPANCIES DUE TO ROUNDING ERRORS               
*                                                                               
         CLC   ROWTL+20(4,R7),ROWTL+20+ROWHL(R7)                                
         BE    BC6D       CHECKS FOR BILLABLE TRADE CREDITS (NET)               
*                                                                               
BC4B     DS    0H                                                               
*                                                                               
         CLI   W+5,0                                                            
         BNE   BC5                                                              
         MVI   W+5,X'FF'                                                        
*                                                                               
*                                  ON FIRST TIME THUR                           
*                                  ADD BILL BUCKET RECS                         
*                                  FOR DUMMY MKT/PUB IF NOT                     
*                                  DOING DETAIL MARKING                         
         CLC   ORIGTYPE,TYPE                                                    
         BNE   BC5                                                              
         BRAS  RE,WNBILL                                                        
*                                                                               
*                                                                               
BC5      DS    0H                                                               
         GOTO1 =A(VBADJ),DMCB,W,(R5),BRKTABD   GET VAT BASIS ADJ                
*                                              AMTS IN VBTAB                    
*                                                                               
*                                  SET BCGRS,BCNET,BCCD, BCAC                   
         MVC   BCGRS(16),4(R7)      GROSS + NET + CD + AC                       
         L     RF,0(R7)                                                         
         CLI   UPASS,X'FF'         FOR SUMMARY PASS - WAS C'S'                  
         BE    BC6                                                              
*                                                                               
         MVI   BCPASS,0                                                         
BC5A     LA    R2,0(R7)                                                         
         CLI   BCPASS,1                                                         
         BNE   *+8                                                              
         LA    R2,ROWTL(R7)        NOW DO OPEN ACCUMMS                          
         LA    RE,BCGRS                                                         
         LA    R0,4                FOR BCT                                      
*                                                                               
BC5A1    DS    0H                                                               
*                                                                               
         L     RF,0(R2)                                                         
         S     RF,ROWHL(R2)        SUBTRACT PREV BILLED                         
         ST    RF,0(RE)            BASIS                                        
*                                                                               
         CLI   BCPASS,1                                                         
         BNE   BC5A1C                                                           
         C     R0,=F'3'            SEE IF DOING NET $                           
         BNE   BC5A1C                                                           
         CLI   MIDASSW,C'Y'        MIDAS?                                       
         BNE   BC5A1C                                                           
         L     R1,ROWTL+20(R7) ORDERED TRADE CREDIT                             
         S     R1,ROWTL+ROWHL+20(R7)  LESS PREV. BILLED TRD CREDITS             
         ST    R1,BCTRDC    SAVE BILLABLE TRADE CREDITS                         
         S     RF,BCTRDC    SUBTRACT FROM COST2 NET                             
         ST    RF,0(RE)     (BCNET)                                             
*                                                                               
*        FOR MIDAS BASE BILL FORMULA ON COST2                                   
*        WITHOUT TRADE CREDIT - MUST BE BILLING NET                             
*                                                                               
BC5A1C   DS    0H                                                               
         LA    R2,4(R2)            NET                                          
         LA    RE,4(RE)                                                         
         BCT   R0,BC5A1                                                         
*                                                                               
*                                  GET BASIS                                    
BC5A2    DS    0H                                                               
         CLI   CDSEP,C'Y'          SEE IF DOING SEPARATE CD INV                 
         BNE   BC5A2C              NO                                           
         NI    W,X'FB'             SET OFF CD IN BASE                           
         B     BC5A3                                                            
*                                                                               
BC5A2C   CLI   SCBNCSW,C'C'        SEE IF UFC COMM BILL                         
         BNE   BC5A3                                                            
         CLI   PROFB2B+4,C'Y'      SEE IF CD IS ON NET BILLING                  
         BNE   BC5A3                                                            
         NI    W,X'FB'             SET OFF CD IN BASE                           
*                                  NET BILLING SHOULD BE NET-CD                 
*                                  WHEN PRINTING BILL                           
BC5A3    MVC   WK(4),BCGRS         GROSS                                        
         OC    W(5),W              CHK FOR FORMULA                              
         BZ    BC5A4               NONE - USE GROSS                             
         TM    W,X'01'                                                          
         BO    BC5A3C                                                           
         MVC   WK(4),BCNET         NET                                          
         TM    W,X'02'                                                          
         BO    BC5A3C                                                           
         MVC   WK(4),BCAC          AC      X'08'                                
*                                                                               
BC5A3C   TM    W,X'04'             SEE IF SUBTRACTING CD                        
         BZ    BC5A4                                                            
         L     R0,WK                                                            
         S     R0,BCCD                                                          
         ST    R0,WK                                                            
BC5A4    L     RF,WK                                                            
*                                  CALCULATE ADJUSTMENT                         
         OC    W+2(3),W+2                                                       
         BZ    BC6                 NO ADJ                                       
         L     RF,BCGRS            GRS                                          
         TM    W+1,X'01'                                                        
         BO    BC5A4B                                                           
         L     RF,BCNET            NET                                          
         TM    W+1,X'02'                                                        
         BO    BC5A4B                                                           
         L     RF,BCAC             AC      X'08'                                
*                                                                               
BC5A4B   TM    W+1,X'04'           SEE IF SUBTRACTING CD                        
         BZ    BC5A6                                                            
         S     RF,BCCD                                                          
*                                                                               
BC5A6    CLI   TAXOPT,C'N'         TEST SHOWING TAX                             
         BE    BC5B                                                             
         TM    W+1,X'08'           SEE IF AC                                    
         BO    BC5B                ALSO DON'T SUBTRACT TAX                      
*                                                                               
         S     RF,TDSP(R7)         LESS TAX                                     
         A     RF,ROWHL+TDSP(R7)   PLUS BILLED TAX                              
BC5B     DS    0H                                                               
         XC    FULL,FULL                                                        
         MVC   FULL+1(3),W+2                                                    
         TM    W+2,X'F0'                                                        
         BNO   *+8                                                              
         MVI   FULL,X'FF'                                                       
         M     RE,FULL             X ADJ PCT                                    
         SLDA  RE,1                                                             
         D     RE,=F'1000000'                                                   
         LTR   RF,RF                                                            
         BNP   *+8                                                              
         A     RF,=F'1'                                                         
         SRA   RF,1                                                             
*****                                                                           
*****    L     R0,=F'500000'       ROUNDING                                     
*****    LTR   RE,RE                                                            
*****    BNM   *+6                                                              
*****    LCR   R0,R0                                                            
*****    AR    RF,R0                                                            
*****    D     RE,=F'1000000'                                                   
*****                                                                           
         CLI   BCPASS,1                                                         
         BE    BC6B                                                             
         ST    RF,ADJDSP(R7)           ADJ                                      
         L     RE,WKROW+ADJDSP-EXTDSP                                           
         AR    RE,RF                                                            
         ST    RE,WKROW+ADJDSP-EXTDSP   TOTAL ADJUSTMENT                        
*                                                                               
         L     RF,TDSP(R7)                 ORDERED TAX                          
         S     RF,BTDSP(R7)                LESS PREV BILLED TAX                 
         ST    RF,TAXDSP(R7)                                                    
         A     RF,WKROW+TAXDSP-EXTDSP                                           
         ST    RF,WKROW+TAXDSP-EXTDSP      SAVE TOTAL TAX                       
*                                                                               
         L     RF,ADJDSP(R7)               RESET RF TO ADJDSP                   
         A     RF,WK               ADD BASIS                                    
*                                                                               
BC6      DS    0H                                                               
*                             COULD GET HERE VIA BC5A4 IF NO ADJ                
         CLI   BCPASS,1                                                         
         BE    BC6B5                                                            
*                                                                               
         ST    RF,DUEDSP(R7)           AMOUNT DUE                               
         A     RF,WKROW+DUEDSP-EXTDSP                                           
         ST    RF,WKROW+DUEDSP-EXTDSP     KEEP TOTAL DUE                        
*                                                                               
******   A     RF,WK+8                                                          
******   ST    RF,WK+8             KEEP DUE TOTAL                               
*                                                                               
*                                                                               
**GST                                                                           
         CLI   CVATSW,0            CHECK FOR CANADIAN VAT                       
         BE    BC6AX                                                            
*                                                                               
         GOTO1 =A(VBCALC),DMCB,(R5),(R7),BRKTABD     VAT CALC                   
         CLI   ADJSEP,C'Y'         SEP ADJ BILL                                 
         BNE   BC6C                                                             
*                                                                               
         GOTO1 =A(VBCALCJ),DMCB,(R5),(R7),BRKTABD    VAT FOR SEP ADJ            
         B     BC6C                                                             
*                                                                               
BC6C     DS    0H                                                               
         CLI   CDSEP,C'Y'         SEPARATE CD BILL?                             
         BNE   BC6CX                                                            
*                                                                               
         GOTO1 =A(VBCALCD),DMCB,(R5),(R7),BRKTABD    VAT FOR SEP CD             
*                                                                               
BC6CX    DS    0H                                                               
*                                                                               
BC6AX    DS    0H                                                               
         CLI   RETPROF,0           SEE IF DOING RETAIL                          
         BNE   BC6D                CAN'T DO FINANCIAL RETAIL                    
*                                                                               
         CLI   AORSW,C'Y'          SEE IF DOING AOR  - NO AOR FINANCIAL         
         BE    BC8                 NO AOR FOR RETAIL                            
*                                                                               
         MVI   BCPASS,1            DO OPEN DOLLARS                              
         B     BC5A                                                             
*                                                                               
BC6B     ST    RF,OADJDSP(R7)           ADJ                                     
*                                                                               
         L     RE,WKROW+OADJDSP-EXTDSP                                          
         AR    RE,RF                                                            
         ST    RE,WKROW+OADJDSP-EXTDSP    SAVE TOTAL OPEN ADJ                   
******   L     RE,WK+44                                                         
******   AR    RE,RF                                                            
******   ST    RE,WK+44            TOTAL ADJ                                    
         A     RF,WK               ADD BASIS                                    
BC6B5    DS    0H                                                               
*                                  COULD GET HERE VIA BC6                       
         ST    RF,ODUEDSP(R7)           AMOUNT DUE                              
         A     RF,WKROW+ODUEDSP-EXTDSP                                          
         ST    RF,WKROW+ODUEDSP-EXTDSP      SAVE TOTAL OPEN DUE                 
******   A     RF,WK+48                                                         
******   ST    RF,WK+48            KEEP DUE TOTAL                               
*                                                                               
BC6D     DS    0H                                                               
         CLI   RETPROF,0           TEST RETAIL                                  
         BE    BC8                 NO                                           
*                                                                               
         LR    RF,R6                                                            
         SH    RF,=Y(MAXMOS)                                                    
         LPR   RF,RF               RF = REL. NO. OF PERIOD                      
*                                                                               
         L     R4,=A(GDAREA)                                                    
         USING GDSECT,R4                                                        
         STC   RF,GDPER            RELATIVE PERIOD                              
*                                                                               
         XC    GDSHRA(20),GDSHRA                                                
*                                                                               
         MVC   GDTOTA,DUEDSP(R7)   DUE AMT                                      
         MVC   GDTOTG,BCGRS                                                     
         MVC   GDTOTN,BCNET                                                     
         MVC   GDTOTCD,BCCD                                                     
         MVC   GDTOTAC,BCAC        AGY COMM                                     
         L     RF,ADEST                                                         
         USING PESTREC,RF                                                       
         MVC   GDSCHM,PESTRSCH     RETAIL SCHEME                                
         DROP  RF                                                               
         L     RF,APRD                                                          
         MVC   GDPRD,0(RF)                                                      
         L     RF,AEST                                                          
         MVC   GDEST,0(RF)                                                      
         MVC   GDOUTNO,UPASS       OUTLET NO.                                   
         CLI   UPASS,X'FF'         IF SUMMARY PASS - WAS C'S'                   
         BNE   *+8                                                              
         MVI   GDOUTNO,1           USE CORP OUTLET                              
*                                                                               
         MVI   GDNOCUME,C'N'                                                    
         CLI   CRFORMSW,C'Y'                                                    
         BE    BC6P                                                             
         CLI   RETPROF+15,C'0'                                                  
         BH    BC6P                                                             
         MVI   GDNOCUME,C'Y'                                                    
*                                                                               
BC6P     DS    0H                                                               
         GOTO1 =V(FINDOUTP),DMCB,GDSECT                                         
*                                                                               
*        NOTE - THIS CODE IS ABN INDIRECT WAY TO DEAL WITH                      
*               A PROBLEM THAT ARISES IF ALL THE TOTALLED AMTS ARE O            
*                                                                               
         OC    GDSHRP,GDSHRP    SEE IF SHARE IS 0 PCT.                          
         BNZ   *+10                                                             
         XC    GDSHRA(20),GDSHRA    CLEAR AMOUNTS                               
*                                                                               
         OC    GDSCHMAD,GDSCHMAD                                                
         BNZ   BC7                                                              
         CLI   UPASS,X'FF'       WAS C'S'                                       
         BE    *+6                                                              
         DC    H'0'             NO SCHEME - SHOULD NOT HAPPEN HERE              
         XC    GDSHRA(20),GDSHRA       CLEAR SHARE                              
         XC    GDSHRP,GDSHRP                                                    
BC7      DS    0H                                                               
         CLI   UPASS,X'FF'         FOR SUMMARY PASS - WAS C'S'                  
         BNE   BC7D                                                             
         MVC   RETADSP(4,R7),DUEDSP(R7) RET DUE = DUE                           
         MVC   RETGDSP(4,R7),BCGRS                                              
         MVC   RETNDSP(4,R7),BCNET                                              
         MVC   RETCDSP(4,R7),BCCD  CD                                           
         MVC   RETACDSP(4,R7),BCAC     AGY COMM                                 
         B     *+10                                                             
BC7D     DS    0H                                                               
         MVC   RETADSP(20,R7),GDSHRA SET SHARE DUE (ACT,GRS,NET,CD,AC)          
         MVC   RETPDSP(4,R7),GDSHRP   SHARE PCT                                 
         L     RF,RETADSP(R7)                                                   
*                                                                               
         A     RF,WKROW+RETADSP-EXTDSP                                          
         ST    RF,WKROW+RETADSP-EXTDSP    TOTAL OF ACT SHARES                   
******   A     RF,WK+20                                                         
******   ST    RF,WK+20            TOTAL OF ACT SHARES                          
         L     RF,RETGDSP(R7)                                                   
         A     RF,WKROW+RETGDSP-EXTDSP                                          
         ST    RF,WKROW+RETGDSP-EXTDSP    TOTAL OF GROSS SHARES                 
******   A     RF,WK+24                                                         
******   ST    RF,WK+24            TOTAL OF GRS SHARES                          
         L     RF,RETNDSP(R7)                                                   
         A     RF,WKROW+RETNDSP-EXTDSP                                          
         ST    RF,WKROW+RETNDSP-EXTDSP    TOTAL OF NET SHARES                   
******   A     RF,WK+28                                                         
******   ST    RF,WK+28            TOTAL OF NET SHARES                          
         L     RF,RETCDSP(R7)                                                   
         A     RF,WKROW+RETCDSP-EXTDSP                                          
         ST    RF,WKROW+RETCDSP-EXTDSP    TOTAL OF CD SHARES                    
******   A     RF,WK+32                                                         
******   ST    RF,WK+32            TOTAL OF CD SHARES                           
         L     RF,RETACDSP(R7)                                                  
         A     RF,WKROW+RETACDSP-EXTDSP                                         
         ST    RF,WKROW+RETACDSP-EXTDSP    TOTAL OF AC SHARES                   
******   A     RF,WK+36                                                         
******   ST    RF,WK+36            TOTAL OF AC SHARES                           
         MVC   WKROW+RETPDSP-EXTDSP(4),GDSHRP     SAVE SHARE %                  
******   MVC   WK+40(4),GDSHRP     SAVE SHARE PCT                               
*                                                                               
**GST                                                                           
         L     RF,TDSP(R7)        YES, FIRST DO TAX CALC                        
         S     RF,ROWHL+TDSP(R7)                                                
******                                                                          
         CLI   UPASS,X'FF'         RETAIL SUMMARY PASS - WAS C'S'               
         BE    BC7E                TAX IS ALREADY SET TO THE SHARE              
***                                                                             
         L     R0,GDSHRP           TO GET TAX SHARE FOR THIS BILL               
         MR    RE,R0               NOTE- TAX CALCS DO NOT HAVE TO               
         SLDA  RE,1                ADD UP TO THE PENNY ACROSS DISTS             
         D     RE,=F'10000'        BECAUSE ARE ONLY USED FOR                    
         LTR   RF,RF               VAT CALC                                     
         BNP   *+8                                                              
         A     RF,=F'1'                                                         
         SRA   RF,1                                                             
*                                                                               
BC7E     ST    RF,RETTDSP(R7)       SAVE RETAIL SHARE OF TAX                    
         A     RF,WKROW+RETTDSP-EXTDSP                                          
         ST    RF,WKROW+RETTDSP-EXTDSP   TOTAL OF TAX SHARES                    
*******  A     RF,WK+72                                                         
*******  ST    RF,WK+72             TOTAL OF TAX SHARES                         
*                                                                               
         CLI   CVATSW,0            TEST VAT                                     
         BE    BC7G                                                             
*                                                                               
*        GST AND PST NOW CALCULATED IN VBCALCR                                  
*                                                                               
         GOTO1 =A(VBCALCR),DMCB,(R5),(R7),BRKTABD,GDSHRP                        
*                                                                               
*                                                                               
         DROP  R4                                                               
BC7G     DS    0H                                                               
         B     BC9                                                              
*                                                                               
BC8      DS    0H                  SET AOR AMOUNT                               
*                                  FOR FINANCIAL AOR                            
*                                  BASE AOR ON CONTRACT                         
         TM    FINANSW,X'80'       SEE IF COST 2                                
         BNO   BC8A                                                             
         CLI   PROFAOR+5,C'Y'     AOR ON COST2 (OPEN)                           
         BNE   BC8A                                                             
         CLI   BCPASS,1                                                         
         BE    BC8AX              BASE AOR ON OPEN (COST2) AMTS                 
         B     BC8X                                                             
*                                                                               
BC8A     DS    0H                                                               
**NEW 2/8/89                                                                    
         CLI   BCPASS,1                                                         
         BE    BC9                                                              
**NEW 2/8/89                                                                    
BC8AX    DS    0H                                                               
         ICM   R0,15,SVAORPCT      TEST ANY AOR PCT                             
         BZ    BC8X                                                             
**NEW 2/8/89        WAS  B   BC9                                                
         L     RF,BCGRS                                                         
         CLI   SVAORBAS,0          GROSS                                        
         BE    BC8B                **NEW 3/12/91 WAS BC8C                       
         L     RF,BCAC                                                          
         TM    SVAORBAS,X'80'      AGY COMM.                                    
         BO    BC8C                                                             
         L     RF,BCNET            NET                                          
         TM    SVAORBAS,X'40'                                                   
         BO    BC8B                **NEW 3/12/91 WAS BC8C                       
         DC    H'0'                INVALID AOR BASIS                            
*                                                                               
**NEW 3/12/91                                                                   
BC8B     CLI   AORTXOPT,C'Y'                                                    
         BE    BC8C                                                             
         TM    SVAORBAS,X'80'      AGY COMM BASIS                               
         BO    BC8C                SKIP TAX                                     
*                                                                               
         S     RF,TDSP(R7)         SUBTRACT ORDERED TAX                         
         A     RF,ROWHL+TDSP(R7)     RE-ADD PREVIOUSLY BILLED TAX               
**NEW 3/12/91                                                                   
*                                                                               
BC8C     LTR   RF,RF                                                            
         BZ    BC8X                NO DUE AMOUNT                                
**NEW 2/8/89        WAS  B   BC9                                                
         CLC   0(2,R5),SVAOREFF    TEST VS AOR EFF DATE                         
         BL    BC8G                                                             
***NEW 5/17/91                                                                  
         CLC   0(2,R5),SVAORKIL    TEST VS. KILL DATE                           
         BNL   BC8G                                                             
***NEW 5/17/91                                                                  
*                                                                               
**2/22/89                                                                       
         ST    RF,AORBDSP(R7)     SAVE AMOUNT SUBJECT TO AOR FEE                
*                                                                               
         A     RF,WKROW+AORBDSP-EXTDSP                                          
         ST    RF,WKROW+AORBDSP-EXTDSP    SAVE TOTAL AOR BASIS                  
*******  A     RF,WK+16            ADD TO TOTAL                                 
*******  ST    RF,WK+16            SAVE NEW RESULT                              
         L     RF,AORBDSP(R7)      RESTORE RF                                   
**2/22/89                                                                       
*                                  WILL BE SET INTO TOTAL ROW                   
         MR    RE,R0                                                            
         SLDA  RE,1                                                             
         D     RE,=F'1000000'                                                   
         LTR   RF,RF                                                            
         BNP   *+8                                                              
         A     RF,=F'1'                                                         
         SRA   RF,1                                                             
         LCR   RF,RF               COMPLEMENT                                   
         ST    RF,AORDSP(R7)       AOR AMOUNT                                   
*                                                                               
         A     RF,WKROW+AORDSP-EXTDSP                                           
         ST    RF,WKROW+AORDSP-EXTDSP   SAVE TOTAL AOR                          
******   A     RF,WK+12            ADD TO TOTAL                                 
******   ST    RF,WK+12            SAVE NEW RESULT                              
*                                  WILL BE SET INTO TOTAL ROW                   
**GST                                                                           
***NEW 5/17/91       WAS CLI  CVATSW,C'Y'                                       
         CLC   SVAORVCS,SPACES     SEE IF VAT FOR AOR AGENCY                    
         BNH   BC8F                                                             
         CLI   CVATCOD,0           PROVIDED VAT IS NOT                          
         BE    BC8F                IS NOT COMPLETELY EXCLUDED                   
         CLC   0(2,R5),CVATSTRT    OR BEFORE VAT START-UP                       
         BL    BC8F                                                             
*                                                                               
*        AOR GST AND PST NOW CALCULATED IN VBCALCA                              
*                                                                               
         GOTO1 =A(VBCALCA),DMCB,(R5),(R7),BRKTABD                               
         BAS   RE,BCPTCH1            *** TEST PATCH ***                         
*                                                                               
*                                                                               
BC8F     DS    0H                                                               
*                                                                               
         L     RF,BRKCODE          LOOK FOR AOR PCT IN ACCUM                    
         L     RF,ATOTS(RF)                                                     
         AH    RF,=Y(TOTSIZE-BFORML+BFAORPCT-BFORMD)                            
         CLC   0(3,RF),SVAORPCT+1  IF NOT THERE, DID MONTHS                     
         BE    *+10                BEFORE EFFECTIVE DATE                        
         MVC   0(3,RF),FFS         SET 'MIXED' AOR PCTS                         
         B     BC8X                                                             
**NEW 2/8/89        WAS  B   BC9                                                
*                                                                               
BC8G     DS    0H                  IF ACTIVE MONTH BEFORE                       
         L     RF,BRKCODE          EFFECTIVE DATE CLEAR OUT AORPCT              
         L     RF,ATOTS(RF)        FROM ACCUM                                   
         AH    RF,=Y(TOTSIZE-BFORML+BFAORPCT-BFORMD)                            
         XC    0(3,RF),0(RF)                                                    
*                                                                               
**NEW 2/8/89                                                                    
BC8X     DS    0H                                                               
         CLI   BCPASS,1            SEE IF I JUST DID OPEN PASS                  
         BE    BC9                 THEN DONE                                    
*                                                                               
         MVI   BCPASS,1                                                         
         B     BC5A                GO DO OPEN AMOUNTS                           
**NEW 2/8/89                                                                    
*                                                                               
BC9      DS    0H                                                               
         CLI   PASSNO,2            IF DOING PASS 2                              
         BNE   BC10                                                             
         OC    ARECAP,ARECAP       AND DETAIL BACK-UP                           
         BZ    BC10                                                             
*           OR IF DOING AORINV WITH DETAIL BACK-UP                              
         CLI   AORSW,C'Y'                                                       
         BE    BC20                SKIP BC ADD                                  
         CLI   ADJSEP,C'Y'         AND ADJ INVOICE                              
         BNE   BC10                                                             
         B     BC20                THEN SKIP BCADD                              
*                                                                               
BC10     BAS   RE,BCADD                                                         
*                                                                               
BC20     DS    0H                                                               
         LA    R7,ROWL(R7)                                                      
         LA    R5,8(R5)            BUMP DATE                                    
         BCT   R6,BC4                                                           
*                                                                               
BC20X    DS    0H                                                               
*                                                                               
*                                                                               
         MVC   OADJDSP+000(250,R7),WKROW+000                                    
         MVC   OADJDSP+250(ACMEXTL-250,R7),WKROW+250                            
*                                                                               
******   MVC   OADJDSP(8,R7),WK+44      OPEN ADJ AND DUE                        
******10/27/89 WAS (36) NOW (40) TO INCLUDE RETAIL PCT                          
*****    MVC   ADJDSP(8,R7),WK+4       TOTAL OF ADJ AND DUE AMOUNTS             
******   MVC   AORDSP(28,R7),WK+12                                              
******   AOR,AOR BASIS,RET ACT,RET GRS,RET NET,RET CD,RET AC                    
******   MVC   RETPDSP(4,R7),WK+40                                              
******                                  AND SHARE PCT                           
******                                  NOTE - TOTAL IS SUM OF PARTS            
******                                        (NOT RECALCULATED)                
******                                                                          
******   MVC   VATDSP(16,R7),WK+52     MAIN,COMM,AOR,CD  VATS                   
******   MVC   RETVDSP(4,R7),WK+68     RETAIL VAT                               
******   MVC   RETTDSP(4,R7),WK+72     RETAIL TAX                               
*                                                                               
         LA    R7,ROWL(R7)                                                      
         MVC   BFRETSHR-BFORMD(3,R7),WKROW+RETPDSP+1-EXTDSP                     
*                                              SAVE SHARE PCT.                  
*                                                                               
******   MVC   BFRETSHR-BFORMD(3,R7),WK+41     SET SHARE PCT                    
*                                                                               
*                                                                               
BCX      DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
*                                  ADD INTO PRD-EST-PER TAB                     
BCADD    NTR1                                                                   
         SPACE 2                                                                
         XC    PEPTW(250),PEPTW                                                 
         XC    PEPTW+250(250),PEPTW+250                                         
         XC    PEPTW+500(PEPTABRL-500),PEPTW+500                                
*                                                                               
         LA    RF,PEPTW                                                         
         USING PEPTD,RF                                                         
         OC    AMED,AMED                                                        
         BZ    BCA2                                                             
         L     RE,AMED                                                          
         MVC   PEPTMED,0(RE)                                                    
BCA2     L     RE,APRD                                                          
         MVC   PEPTPRD,0(RE)         PRD                                        
         L     RE,AEST                                                          
         MVC   PEPTEST,0(RE)       EST                                          
*                                                                               
         MVI   PEPTFIN,0                                                        
         CLI   FINANSW,0           SEE IF FINANCIAL CLT                         
         BE    *+10                                                             
         MVC   PEPTFIN,FINANSW                                                  
*                                                                               
         MVC   PEPTMOS,0(R5)       PERIOD                                       
         GOTO1 BINSRCH,PEPPARS,PEPTW                                            
         CLI   0(R1),1                                                          
         BE    BCAX                NOT IN PEPTAB                                
*                                                                               
         L     RF,0(R1)                                                         
         L     R0,PEPTADJ                                                       
         A     R0,ADJDSP(R7)           ADJ                                      
         ST    R0,PEPTADJ                                                       
         L     R0,PEPTDUE                                                       
         A     R0,DUEDSP(R7)           DUE                                      
         ST    R0,PEPTDUE                                                       
*                                      OPEN ADJ AND DUE                         
         L     R0,PEPTOADJ                                                      
         A     R0,OADJDSP(R7)                                                   
         ST    R0,PEPTOADJ                                                      
         L     R0,PEPTODUE                                                      
         A     R0,ODUEDSP(R7)                                                   
         ST    R0,PEPTODUE                                                      
         L     R0,PEPTRETA                                                      
         A     R0,RETADSP(R7)      RETAIL ACT                                   
         ST    R0,PEPTRETA                                                      
         L     R0,PEPTRETG                                                      
         A     R0,RETGDSP(R7)      RETAIL GROSS                                 
         ST    R0,PEPTRETG                                                      
         L     R0,PEPTRETN                                                      
         A     R0,RETNDSP(R7)      RETAIL NET                                   
         ST    R0,PEPTRETN                                                      
*                                                                               
         L     R0,PEPTRETC                                                      
         A     R0,RETCDSP(R7)      RETAIL CD                                    
         ST    R0,PEPTRETC                                                      
*                                                                               
         L     R0,PEPTRETM                                                      
         A     R0,RETACDSP(R7)     RETAIL AC                                    
         ST    R0,PEPTRETM                                                      
*                                                                               
         L     R0,PEPTRETT                                                      
         A     R0,RETTDSP(R7)     TAX                                           
         ST    R0,PEPTRETT                                                      
*                                                                               
**GST                                                                           
         CLI   CVATSW,0                 TEST BILL VATABLE                       
         BE    BCA2C                                                            
*                                                                               
*                                                                               
         LA    R6,PEPTVCDS         SET VAT CODES ONE AT A TIME                  
         LA    RE,CVATCDS                                                       
*                                                                               
         CLC   PEPTMOS,=X'6E07'    JUL/10  - USE NEW PSTS                       
         BL    *+8                                                              
         LA    RE,NVATCDS                                                       
*                                                                               
         LA    R0,NPROVS+1                                                      
*                                                                               
BCA05    DS    0H                                                               
         CLI   0(R6),C' '          ANYTHING ALREADY THERE?                      
         BNH   BCA05D              NO                                           
         CLI   0(RE),C' '          YES, ANYTHING NOW                            
         BNH   BCA05F              NO,OK                                        
         CLC   0(1,R6),0(RE)       IF EQUAL OK                                  
         BE    BCA05F                                                           
         MVI   0(R6),X'FF'         YES, SET MIXED (COULD THIS HAPPEN            
         B     BCA05F              AT THE PROV LEVEL IF DIFFERENT               
*                                  STATIONS HAVE DIFFERENT CODES?)              
BCA05D   DS    0H                  NOTHING ALREADY THERE                        
         MVC   0(1,R6),0(RE)       JUST SET CURRENT                             
*                                                                               
BCA05F   DS    0H                                                               
         LA    R6,1(R6)                                                         
         LA    RE,1(RE)                                                         
         BCT   R0,BCA05                                                         
*                                                                               
*                                                                               
         CLC   PEPTMOS,=X'6E07'    JUL/10  - USE NEW PSTS                       
         BL    BCA05G                                                           
         OC    PEPTVSWS,NVATSWS    AND SWITCHES (NOTE THE 'OC')                 
         B     BCA05H                                                           
BCA05G   OC    PEPTVSWS,CVATSWS    AND SWITCHES (NOTE THE 'OC')                 
*                                                                               
BCA05H   LA    R4,NPROVS*4         USED AS INDEX REGISTER                       
*                                                                               
BCA06    DS    0H                                                               
         L     R0,PEPTVTS+0(R4)     VAT - MAIN BILL                             
         A     R0,VATDSP+0(R7,R4)                                               
         ST    R0,PEPTVTS+0(R4)                                                 
*                                                                               
         L     R0,PEPTVTB+0(R4)      VAT BASIS - MAIN BILL                      
         A     R0,VATBDSP+0(R7,R4)                                              
         ST    R0,PEPTVTB+0(R4)                                                 
*                                                                               
         L     R0,PEPTVTCS+0(R4)      VAT FOR SEP COMM ADJ                      
         A     R0,VATCDSP+0(R7,R4)                                              
         ST    R0,PEPTVTCS+0(R4)                                                
*                                                                               
         L     R0,PEPTCVTB+0(R4)      VAT BASIS FOR SEP COMM ADJ                
         A     R0,VATCBDSP+0(R7,R4)                                             
         ST    R0,PEPTCVTB+0(R4)                                                
*                                                                               
         L     R0,PEPTVTDS+0(R4)      VAT FOR SEP CD BILL                       
         A     R0,VATDDSP+0(R7,R4)                                              
         ST    R0,PEPTVTDS+0(R4)                                                
*                                                                               
         L     R0,PEPTDVTB+0(R4)      VAT BASIS FOR SEP CD BILL                 
         A     R0,VATDBDSP+0(R7,R4)                                             
         ST    R0,PEPTDVTB+0(R4)                                                
*                                                                               
         L     R0,PEPTRTVS+0(R4)      VAT FOR RETAIL                            
         A     R0,RETVDSP+0(R7,R4)                                              
         ST    R0,PEPTRTVS+0(R4)                                                
*                                                                               
         L     R0,PEPTRVTB+0(R4)      VAT BASIS FOR RETAIL                      
         A     R0,VATRBDSP+0(R7,R4)                                             
         ST    R0,PEPTRVTB+0(R4)                                                
*                                                                               
         SH    R4,=H'4'            DECREMENT INDEX REGISTER                     
         BNM   BCA06                                                            
*                                                                               
*                                                                               
BCA09    DS    0H                                                               
*                                                                               
BCA2C    CLI   SVAORACT,C' '        SEE IF AOR                                  
         BNH   BCA3                                                             
         CLC   0(2,R5),SVAOREFF     AND EFFECTIVE THIS MOS                      
         BL    BCA3                                                             
***NEW 5/17/91                                                                  
         CLC   0(2,R5),SVAORKIL     AND KILL DATE                               
         BNL   BCA3                                                             
***NEW 5/17/91                                                                  
         L     R0,PEPTAOR                                                       
         A     R0,AORDSP(R7)                                                    
         ST    R0,PEPTAOR                                                       
         L     R0,PEPTAORT                                                      
         A     R0,AORBDSP(R7)                                                   
         ST    R0,PEPTAORT                                                      
*                                                                               
         LA    R4,NPROVS*4               USE AS INDEX                           
*                                                                               
BCA09B   DS    0H                                                               
         L     R0,PEPTVTAS(R4)           VAT FOR AOR                            
         A     R0,VATADSP(R7,R4)                                                
         ST    R0,PEPTVTAS(R4)                                                  
*                                                                               
         SH    R4,=H'4'                                                         
         BNM   BCA09B                                                           
*                                                                               
         MVC   PEPTAORP,SVAORPCT         AOR PCT                                
         MVC   PEPTAORD,SVAORDA          DISK ADDR                              
         MVC   PEPTAORB,SVAORBAS         BASIS                                  
         MVC   PEPTAORA,SVAORACT         ACCOUNT                                
***NEW 5/17/91                                                                  
*                                                                               
*                                                                               
         MVC   PKAORVCS,SVAORVCS         SET WORKING AOR PSTS                   
         CLC   PEPTMOS,=X'6E07'             MOS VS. JUL/2010                    
         BL    BCA09D                                                           
         CLI   SVAORMVC,C' '             DO I HAVE A MAIN VAT CODE?             
         BNH   BCA09D                                                           
         ZIC   R3,SVAORMVP          MAIN PST PROVINCE #                         
         SH    R3,=H'1'                                                         
         LTR   R3,R3                                                            
         BM    BCA09D               SHOULD NOT BE NEGATIVE                      
*                                                                               
         MVC   PKAORVCS+1(10),SPACES CLEAR OLD PSTS                             
         LA    R4,PKAORVCS+1                                                    
         AR    R4,R3                                                            
         MVC   0(1,R4),SVAORMVC     STORE CODE IN LIST                          
*                                                                               
BCA09D   MVC   PEPTAOVS,PKAORVCS         AOR VAT CODES                          
*                                                                               
BCA3     L     RE,ADPRD                                                         
         MVC   PEPTPACT,PPRDACCT-PPRDREC(RE) SET PRD ACCT CODE                  
*                                                                               
         CLI   W+5,C'C'            TEST COMM ONLY BILL                          
         BE    BCA4                YES                                          
         B     BCA4B                                                            
***      CHECK FOR MANUAL BILL PCT OF LESS THAN 20 NO-OPED                      
*                                                                               
*****    OC    MANPCT,MANPCT       OR IF PCT                                    
*****    BZ    BCA4B                                                            
*****    CLC   MANPCT,=F'2000'     LESS THAN 20 PCT                             
*****    BH    BCA4B                                                            
*                                                                               
BCA4     DS    0H                                                               
         OI    PEPTSTAT,X'80'      SET IN STATUS AREA                           
BCA4B    DS    0H                                                               
         MVC   PEPTBILF,W+20       STORE SAVED FORMULA                          
*                                                                               
         B     BCAX                 EXIT                                        
*                                                                               
BCAX     XIT1                                                                   
*                                                                               
BCPASS   DC    X'00'                                                            
BCPTCH1  BR    RE                   FOR PATCHING                                
         DC    10X'00'                                                          
         SPACE 2                                                                
         LTORG                                                                  
*                                                                               
BCMOS    DS    XL2                                                              
*                                                                               
PKAORVCS DS    CL11       PEPTAB WORKING AOR VATS  GST +10 PROV.                
*                                                                               
PVATSW   DS    XL1                                                              
*                                                                               
PEPTW    DS    XL(PEPTABRL)                                                     
*                                                                               
GETBFRW  DS    XL(PPGBFRDL)'00'                                                 
*                                                                               
         TITLE 'FMTAMT - FORMAT BILLING AMOUNTS'                                
*                                                                               
FMTAMT   NMOD1 0,FMTAMT                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         MVC   HLDINO,SPACES                                                    
*                                                                               
         ST    R3,SAVBRK           SAVE BRK LEVEL                               
*                                  SET ZLSW TO CONTROL ZERO LINE TOTALS         
         MVI   ZLSW,C'N'           N = NO SPECIAL TREATMENT                     
**NO-OP**                                                                       
*****    CLC   SAVBRK,ALOWTOG         IF AT LOWEST LEVEL                        
*****    BE    FA2D                                                             
**NO-OP **                                                                      
         CLI   ZLOPT,C'A'             OR IF NOT FOR THIS TYPE                   
         BE    FA2B                                                             
         CLC   TYPE,ZLOPT                                                       
         BNE   FA2D                                                             
FA2B     DS    0H                                                               
*                                  MUST SEE IF I'M SHOWING 3 TYPES              
*                                  IF SO THIS OPTION WILL SUPPRESS              
*                                  PREVIOUS BILLING AND BILLABLE LINE           
*                                  IF THERE IS NO PREVIOUS BILLINGS             
         LA    R2,ORDSW                                                         
         LA    R4,3                                                             
FA2B5    CLI   0(R2),C'Y'                                                       
         BE    FA2B8                                                            
         CLI   0(R2),C'D'          SHOWING ONLY FOR INS DETAIL                  
         BNE   FA2D                MUST BE 'N' SO LEAVE ZLSW='N'                
         CLI   BRKCODE+3,DESCEQ                                                 
         BNE   FA2D                                                             
FA2B8    LA    R2,1(R2)                                                         
         BCT   R4,FA2B5                                                         
         MVI   ZLSW,C'Y'                                                        
*                                                                               
FA2D     DS    0H                                                               
*                                                                               
         LM    R2,R3,0(R1)         R2 = A(ORD AND BILLED)                       
*                                  R3 = A(PREV INV NO.)                         
         CLI   FINANSW,0           FOR FINANCIAL CLIENTS USE                    
         BE    FA2D2               OPEN ORDERED ,BILLED                         
***R***                                                                         
         CLC   QPROG,=C'R1'    FINANCIAL REBATE BILLING                         
         BE    FA2D2           TREAT HERE AS NON-FINANCIAL                      
         CLC   QPROG,=C'RD'    FINANCIAL REBATE BILLING DRAFT                   
         BE    FA2D2           TREAT HERE AS NON-FINANCIAL                      
***R***                                                                         
         LA    R2,ROWTL(R2)                                                     
*                                                                               
FA2D2    ST    R2,ADACCUM    SAVE ACCUMLATOR ADDRESS FOR EDI CALL               
*                                                                               
         L     R8,=A(GRID)                                                      
         USING ALINED,R8                                                        
         LA    RE,14                                                            
FA2D5    MVC   0(132,R8),SPACES                                                 
         LA    R8,132(R8)                                                       
         BCT   RE,FA2D5                                                         
         L     R8,=A(GRID)                                                      
         CLI   UPASS,X'FF'         RETAIL SUMMARY PASS - WAS C'S'               
         BE    FMT40                                                            
*                                                                               
FMT5     DS    0H                                                               
*              BUILD MATRIX FOR DOLLARS                                         
         XC    ORGROSS(72),ORGROSS                                              
         MVC   ORGROSS(12),0(R2)      ORD GR,N,CD                               
         L     R0,ORGROSS                                                       
         S     R0,ORCD                                                          
         ST    R0,ORGLCD                                                        
         L     R0,ORNET                                                         
         S     R0,ORCD                                                          
         ST    R0,ORNLCD                                                        
         MVC   ORACOMM,ADSP(R2)      AGY COM                                    
         MVC   PBGROS(12),ROWHL(R2)  PREV BILLED GR,N,CD                        
         L     R0,PBGROS                                                        
         S     R0,PBCD                                                          
         ST    R0,PBGLCD                                                        
         L     R0,PBNET                                                         
         S     R0,PBCD                                                          
         ST    R0,PBNLCD                                                        
         MVC   PBACOMM,ROWHL+ADSP(R2)                                           
         MVC   BLGROSS(24),ORGROSS   CALC BILLABLE                              
         LA    R4,BLGROSS                                                       
         LA    R5,PBGROS                                                        
         LA    R6,6                FOR BCT                                      
FMT5C    L     R0,0(R4)                                                         
         S     R0,0(R5)                                                         
         ST    R0,0(R4)                                                         
         LA    R4,4(R4)                                                         
         LA    R5,4(R5)                                                         
         BCT   R6,FMT5C                                                         
*                                                                               
         MVC   HFORMAT,FORMAT                                                   
         MVC   HTYPES,ORDSW                                                     
         CLI   DOLNUM,1                                                         
         BNE   FMT6                                                             
         CLI   TYPNUM,1                                                         
         BNE   FMT6                                                             
*              ONE CAT AND 1 TYPE                                               
         LA    R7,ALCOL4           PUT IN COL4                                  
         BAS   RE,GETCAT           SETS FULL TO ORGROSS,OR NET,ETC..            
         L     R1,FULL                                                          
         BAS   RE,GETTYP           SETS FULL TO 0,20 OR 40- DISP                
         CLI   FULL,X'FF'          SEE IF NOT DISPLAYING THESE $                
         BE    FMT5X                                                            
         A     R1,FULL                                                          
         L     R6,0(R1)                                                         
         BAS   RE,FMTEDT                                                        
FMT5X    B     FMT9                GO DO STRIP-OFF                              
*                                                                               
FMT6     CLI   DOLNUM,1            ONE CAT SEVERAL TYPES                        
         BNE   FMT7                                                             
*                                                                               
*                                  IF DOING INS DETAILS WITH PREV               
*                                  INVOICES AT INSERTION LEVEL                  
*                                  THEN MUST USE GRID FORMAT EVEN FOR           
*                                  ONE CATEGROY                                 
         JIF   FMTSW,EQ,C'D',AND,LSTOPT,EQ,C'I',FMT7,JUMP=N                     
         JIF   FMTSW,EQ,C'D',AND,LSTOPT,EQ,C'D',FMT7,JUMP=N                     
         JIF   FMTSW,EQ,C'D',AND,LSTOPT,EQ,C'B',FMT7,JUMP=N                     
         LA    R7,ALCOL2                                                        
         CLI   TYPNUM,3                                                         
         BE    *+8                                                              
         LA    R7,ALCOL3                                                        
         ZIC   R4,TYPNUM                                                        
         BAS   RE,GETCAT                                                        
         L     R5,FULL                                                          
FMT6C    BAS   RE,GETTYP           SETS FULL TO 0,20 OR 40- DISP                
         CLI   FULL,X'FF'          SEE IF NOT DISPLAYING THESE $                
         BE    FMT6X               SKIP THIS COLUMN                             
         LR    R1,R5                                                            
         A     R1,FULL                                                          
         L     R6,0(R1)                                                         
         BAS   RE,FMTEDT                                                        
FMT6X    LA    R7,16(R7)                                                        
         BCT   R4,FMT6C                                                         
         B     FMT9                GO DO STRIP-OFF                              
*                                                                               
FMT7     CLI   TYPNUM,1                                                         
         BNE   FMT8                                                             
         CLI   DOLNUM,5                                                         
         BNL   FMT8                                                             
         LA    R7,ALCOL1                                                        
         CLI   DOLNUM,4                                                         
         BE    FMT7A                                                            
         LA    R7,ALCOL2                                                        
         CLI   DOLNUM,3                                                         
         BE    FMT7A                                                            
         LA    R7,ALCOL3                                                        
FMT7A    ZIC   R4,DOLNUM                                                        
         BAS   RE,GETTYP           SETS FULL TO 0,20,40 - DISP                  
         CLI   FULL,X'FF'          SEE IF NOT SHOWING THESE $                   
         BE    FMT7X               SKIP ALL COLUMNS TO STRIP-OFF                
         L     R5,FULL                                                          
FMT7C    BAS   RE,GETCAT                                                        
         L     R1,FULL                                                          
         AR    R1,R5                                                            
         L     R6,0(R1)                                                         
         BAS   RE,FMTEDT                                                        
         LA    R7,16(R7)                                                        
         BCT   R4,FMT7C                                                         
FMT7X    B     FMT9                GO DO STRIP-OFF                              
*                                                                               
FMT8     DS    0H                  MORE THAN 1 CATS AND TYPES                   
*                                  OR ALL 5 CATS                                
*                                  MUST BUILD 'BOX'                             
         CLI   DOLNUM,3            SEE IF MORE THAN 3 CATS                      
         BH    FMT8G               YES MUST PUT CATS AS ROWS                    
         MVI   NOPREVB,C'N'                                                     
         ZIC   R2,TYPNUM                                                        
FMT8B    LA    R7,ALCOL3            ELSE CATS AS COLUMNS                        
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         LA    R7,ALCOL2                                                        
         ZIC   R4,DOLNUM                                                        
         MVC   HFORMAT,FORMAT     MUST RESET FOR EACH TYPE                      
         BAS   RE,GETTYP           SETS FULL TO 0,20,40 - DISP                  
         L     R5,FULL                                                          
         CLI   FULL,X'FF'          SEE IF NOT SHOWING THESE $                   
         BE    FMT8E               SKIP ROW  - DUE NEXT TYPE                    
         MVC   SAVTYPE,WORK        SAVE TYPE TO CHK IN FMT8D                    
         LA    RF,ALCOL2                                                        
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         LA    RF,ALCOL1                                                        
         MVC   0(16,RF),WORK        HAS ANNOTATION - ORDERED,PREV,ETC           
*                                  MUST RESTORE R3 TO GET BRKCODE               
         L     R3,SAVBRK                                                        
         CLI   BRKCODE+3,DESCEQ    CHK AT INSERTN LEVEL                         
         BNE   FMT8D                                                            
*--->    CLC   WORK+4(5),=C'PREV.'   SEE IF DOING PREV BILLING                  
         CLC   WORK(16),TYPRVBD      SEE IF DOING PREV BILLING                  
         BNE   FMT8D                                                            
         L     RF,ADESC                                                         
         CLI   0(RF),X'F9'         SEE IF A 'REAL' BUY                          
         BH    FMT8D               NO                                           
*                                                                               
         CLI   LSTOPT,C'I'    SEE IF SHOWING PREV INVS AT INSERTION             
         BE    FMT8C                                                            
         CLI   LSTOPT,C'D'    SEE IF SHOWING PREV INVS AT INSERTION             
         BE    FMT8C                                                            
         CLI   LSTOPT,C'B'    SEE IF SHOWING PREV INVS AT INSERTION             
         BE    FMT8C                                                            
         B     FMT8D                                                            
*              BUY SHOULD BE IN ADWKREC                                         
*                                                                               
*              FOR EACH BILL ELEM PRINT PREV INV NO. AND AMTS                   
FMT8C    ST    R8,WK                                                            
         BAS   RE,GETINVS                                                       
***             GETINVS SETS WK TO NEXT LINE                                    
*                                                                               
         CLI   WK+4,X'01'          SEE IF PREV BILLING FOUND                    
         BNE   FMT8D                                                            
         L     R8,WK               SET LINE                                     
         BCT   R2,FMT8B                                                         
         B     FMT9                                                             
*                                                                               
FMT8D    MVI   NONZSW,1                                                         
         CLI   ZLSW,C'Y'   SEE IF SUPPRESSING ZERO PREV. BILL LINE              
         BNE   FMT8D3                                                           
*--->    CLC   SAVTYPE+4(5),=C'PREV.'  SEE IF DOING PREV BILLING                
         CLC   SAVTYPE(16),TYPRVBD     SEE IF DOING PREV BILLING                
         BNE   FMT8D3                                                           
         MVI   NONZSW,0                                                         
FMT8D3   BAS   RE,GETCAT                                                        
         LR    R1,R5                                                            
         A     R1,FULL                                                          
         L     R6,0(R1)                                                         
         LTR   R6,R6                                                            
         BZ    *+8                                                              
         OI    NONZSW,X'01'       SET NON-ZERO AMT FOUND                        
         BAS   RE,FMTEDT                                                        
         LA    R7,16(R7)                                                        
         BCT   R4,FMT8D3           GO CHK NEXT CAT                              
         CH    R2,=H'1'            SEE IF DOING BILLABLE LINE                   
         BE    FMT8D5                                                           
         TM    NONZSW,X'01'                                                     
         BNZ   FMT8D7                                                           
         B     FMT8D6              ALL PREV BILLED CATS ARE ZERO                
*                                  DON'T PRINT THIS LINE                        
*                                                                               
FMT8D5   CLI   NOPREVB,C'Y'        WILL ONLY BE 'Y' FOR BILLABLE LINE           
         BNE   FMT8D7              IF THERE WAS NO PREV BILLING                 
*                                  AND IT IS BEING SUPPRESSED                   
FMT8D6   MVC   0(132,R8),SPACES    MUST BLANK-OUT ANNO AND $'S                  
         MVI   NOPREVB,C'Y'        SET SO I WON'T PRINT BILLABLE LINE           
         B     FMT8E               AND NOT SKIP A LINE                          
*                                                                               
FMT8D7   LA    R8,132(R8)          DUE NEXT LINE                                
FMT8E    BCT   R2,FMT8B                                                         
         B     FMT9                NOW DO STRIP-OFF                             
*                                                                               
FMT8G    DS    0H                  CATS AS ROWS                                 
         ZIC   R2,DOLNUM                                                        
FMT8I    LA    R7,ALCOL3                                                        
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         LA    R7,ALCOL2                                                        
         ZIC   R4,TYPNUM                                                        
         BAS   RE,GETCAT           SETS FULL TO ORGROSS OR ORNET,ETC            
         MVC   HTYPES,ORDSW        MUST RESET EACH CAT                          
         L     R5,FULL                                                          
         LA    RF,ALCOL2                                                        
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         LA    RF,ALCOL1                                                        
         MVC   0(16,RF),WORK      HAS ANNOTATION - ORDERED,PREV,ETC             
FMT8K    BAS   RE,GETTYP           SETS FULL TO 0,20,40                         
         L     R1,FULL                                                          
         CLI   FULL,X'FF'          SEE IF NOT SHOWING THESE $                   
         BE    FMT8M                                                            
         AR    R1,R5                                                            
         L     R6,0(R1)                                                         
         BAS   RE,FMTEDT                                                        
FMT8M    LA    R7,16(R7)                                                        
         BCT   R4,FMT8K                                                         
         LA    R8,132(R8)          DO NEXT LINE                                 
         BCT   R2,FMT8I                                                         
         B     FMT9                NOW DO STRIP-OFF                             
*                                                                               
FMT9     DS    0H                  STRIP-OFF                                    
         L     R2,ADACCUM         RESET R2 TO ACCUMULATOR                       
         GOTO1 ABILLEDI,DMCB,('EDMMTA',HLDINO)   EDI CALL                       
         LA    R2,5                FOR BCT                                      
         L     R8,=A(GRID)         RESET TO FIRST LINE FOR STRIP                
         LA    R7,ALSTRIP                                                       
         LA    R1,BLGROSS                                                       
         LA    R5,STRIPT           STRIP TABLE                                  
FMT9B    CLC   STRIP,0(R5)                                                      
         BE    FMT9E                                                            
         LA    R1,4(R1)                                                         
         LA    R5,1(R5)                                                         
         BCT   R2,FMT9B                                                         
         B     FMT9X                IF STRIP NOT IN TABLE-SKIP                  
*                                                                               
FMT9E    L     R6,0(R1)                                                         
         BAS   RE,FMTEDT                                                        
FMT9X    B     FMTAMTX                                                          
         EJECT                                                                  
*              RETAIL SUMMARY PASS                                              
FMT40    DS    0H                                                               
         OC    0(4,R3),0(R3)                                                    
         BZ    FMT42               NO INV. NO.                                  
         CLC   SAVBRK,ALOWTOG                                                   
         BNE   FMT42               ONLY AT LOWEST LEVEL                         
         MVC   W(2),0(R3)                                                       
*                                                                               
         MVC   SVSVIMO,SVINVMO        SAVE 'REAL' INV MTH                       
*                                                                               
*                                                                               
*        CAN'T USE GOTOR HERE - CAUSES ASSEMBLY ERROR                           
*                                                                               
*****    GOTOR GETNUM,DMCB,(1,2(R3)),WORK                                       
         GOTO1 =A(GETNUM),DMCB,(1,2(R3)),WORK                                   
*                                                                               
         MVC   SVINVMO,SVSVIMO       RESTORE 'REAL INV MTH                      
*                                                                               
         MVC   ALCOL3+4(10),WORK                                                
*                                                                               
FMT42    DS    0H                                                               
         L     R6,0(R2)                                                         
         LA    R7,ALCOL4                                                        
         BAS   RE,FMTEDT                                                        
*                                                                               
         B     FMTAMTX                                                          
FMTAMTX  DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
FMTEDT   DS    0H                                                               
         LA    R1,ALCOL4        SEE IF DOING LAST COLUMN                        
         CR    R7,R1                                                            
         BNE   FMTEDT5          YES - MOVE EDITED AMT OVER 1 COL                
         ST    RE,DUB                                                           
*--->    EDIT  (R6),(15,0(R7)),2,COMMAS=YES,CR=YES                              
         CURED (R6),(15,0(R7)),CURTAB,COMMAS=YES,CR=YES                         
         L     RE,DUB                                                           
         CLI   13(R7),C' '                                                      
         BHR   RE                                                               
*        CLI   NOSTAR,C'Y'         SUPPRESS ** ON TOTALS?                       
         TM    FLAG1,NOSTAR        SUPPRESS ** ON TOTALS?                       
         BO    *+10                                                             
         MVC   13(2,R7),TOTSTAR                                                 
         BR    RE                                                               
FMTEDT5  DS    0H                                                               
         ST    RE,DUB                                                           
*--->    EDIT  (R6),(15,1(R7)),2,COMMAS=YES,CR=YES                              
         CURED (R6),(15,1(R7)),CURTAB,COMMAS=YES,CR=YES                         
         L     RE,DUB                                                           
         CLI   14(R7),C' '                                                      
         BHR   RE                                                               
*        CLI   NOSTAR,C'Y'         SUPPRESS ** ON TOTALS?                       
         TM    FLAG1,NOSTAR        SUPPRESS ** ON TOTALS?                       
         BO    *+10                                                             
         MVC   14(2,R7),TOTSTAR                                                 
         BR    RE                                                               
         SPACE 2                                                                
FMTEDTSP DS    0H                                                               
         L     R0,12(R2)                                                        
         EDIT  (R0),(5,10(R7))                                                  
         BR    RE                                                               
         SPACE 3                                                                
GETCAT   NTR1                                                                   
         MVC   WORK(16),SPACES                                                  
         XC    FULL,FULL                                                        
*                                                                               
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
         MVC   CATNAMES(L'PPRGROSS),PPRGROSS                                    
*COST2*                                                                         
         CLI   CAROPT,C'Y'    CHECK CARAT OPTION                                
         BNE   *+10                                                             
         MVC   CATNAMES(16),=C'  COST TO CLIENT'                                
*COST2*                                                                         
         MVC   CATNET(L'PPRNET),PPRNET                                          
         MVC   CATCDISC(L'PP@CDISC),PP@CDISC                                    
         MVC   CATGRSLC(L'PPRGRSLC),PPRGRSLC                                    
         MVC   CATNETCD(L'PPRNETCD),PPRNETCD                                    
         MVC   CATAGYCM(L'PPAAGYCM),PPAAGYCM                                    
         DROP  RE                                                               
*                                                                               
         LA    R4,6                FOR BCT                                      
         LA    R5,HFORMAT                                                       
         LA    R6,ORGROSS                                                       
         LA    R7,CATNAMES                                                      
GETC3    CLI   0(R5),C'Y'          SEE IF DOING THIS CAT                        
         BE    GETC5                                                            
         LA    R5,1(R5)                                                         
         LA    R6,4(R6)                                                         
         LA    R7,16(R7)                                                        
         BCT   R4,GETC3                                                         
         B     GETCX                                                            
*                                                                               
GETC5    ST    R6,FULL             SAVE ADDRESS OF DOLLARS                      
         MVI   0(R5),C'N'          SO I WON'T REDO THIS CAT                     
         MVC   WORK(16),0(R7)                                                   
GETCX    XIT1                                                                   
CATNAMES DC    CL16'           GROSS'                                           
CATNET   DC    CL16'             NET'                                           
CATCDISC DC    CL16'      CASH DISC.'                                           
CATGRSLC DC    CL16'   GROSS LESS CD'                                           
CATNETCD DC    CL16'     NET LESS CD'                                           
CATAGYCM DC    CL16'    AGENCY COMM.'                                           
**                                                                              
*                                                                               
GETTYP   NTR1                                                                   
         MVC   WORK(16),SPACES                                                  
*                                                                               
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
         MVC   TYPNAMES,PP@ORD                                                  
         MVC   TYPRVBD,PP@PRV04                                                 
         MVC   TYPBILLA,PP@BILLA                                                
         DROP  RE                                                               
*                                                                               
         XC    FULL,FULL                                                        
         LA    R5,HTYPES                                                        
         LA    R6,0                                                             
         LA    R7,TYPNAMES                                                      
         LA    R4,3                FOR BCT                                      
GETT3    CLI   0(R5),C'Y'          SEE IF DOING THIS CAT                        
         BE    GETT5                                                            
         CLI   0(R5),C'D'          SEE IF DOING THIS TYPE ONLY AT               
         BNE   GETT4               INSERTTION DETAIL LEVEL                      
         L     R3,SAVBRK           SEE IF AT INS DETAIL LEVEL                   
         CLI   BRKCODE+3,DESCEQ                                                 
         BE    GETT5                                                            
         MVI   FULL,X'FF'          SET NOT TO DISPLAY $                         
         B     GETT8                                                            
*                                                                               
GETT4    LA    R5,1(R5)                                                         
         LA    R6,24(R6)                                                        
         LA    R7,16(R7)                                                        
         BCT   R4,GETT3                                                         
         B     GETTX                                                            
*                                                                               
GETT5    ST    R6,FULL             SAVE DISP                                    
GETT8    MVI   0(R5),C'N'          SO I WON'T REDO THIS TYPE                    
         MVC   WORK(16),0(R7)                                                   
**NEW 10/17/89                                                                  
         CLI   PAYOPT,C'G'         SEE IF CHANGING ORDERED TO CLEARED           
         BE    GETT8C                                                           
         CLI   PAYOPT,C'C'         SEE IF CHANGING ORDERED TO CLEARED           
         BNE   GETTX                                                            
*                                                                               
GETT8C   L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    CLC   WORK+9(7),=C'ORDERED'                                            
         CLC   WORK(16),PP@ORD                                                  
         BNE   GETTX                                                            
*--->    MVC   WORK+9(7),=C'CLEARED'                                            
         MVC   WORK(16),SPACES                                                  
         MVC   WORK+16-L'PP@CLEAR(L'PP@CLEAR),PP@CLEAR                          
         DROP  RE                                                               
**NEW 10/17/89                                                                  
GETTX    XIT1                                                                   
*                                                                               
TYPNAMES DC    CL16'         ORDERED'                                           
TYPRVBD  DC    CL16'    PREV. BILLED'                                           
TYPBILLA DC    CL16'        BILLABLE'                                           
**                                                                              
GETINVS  NTR1                                                                   
         L     R8,WK               LINE                                         
         MVI   WK+4,0              WILL BE SET TO 1                             
*                                  IF PREV BILLING IS FOUND                     
         L     R2,ADWKREC                                                       
         LA    R2,33(R2)                                                        
         CLI   1(R2),0             JUST IN CASE - TO AVOID LOOPS                
         BE    GETINVSX                                                         
         MVI   ELCODE,X'26'                                                     
         CLI   FINANSW,0           FOR FINANCIAL CLIENTS LOOK FOR               
         BE    GETI5               X'28' BILL ELEMS                             
         MVI   ELCODE,X'28'                                                     
***R***                                                                         
         CLC   QPROG,=C'R1'       SEE IF FINANCIAL REBATE BILL                  
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
         CLC   QPROG,=C'RD'    SEE IF FINANCIAL REBATE BILL DRAFT               
         BNE   *+8                                                              
         MVI   ELCODE,X'29'                                                     
***R***                                                                         
GETI5    BAS   RE,INXTEL                                                        
         BNE   GETINVSX                                                         
         USING PBILELEM,R2                                                      
         OC    PBLDATE,PBLDATE     CHK FOR BILLED DATE                          
         BZ    GETI5               NONE - SKIP                                  
         CLC   PBLDATE,TODAYB      SKIP ELEM I JUST ADDED                       
         BNE   GETI6                                                            
         CLC   PBINVNO,INVNO       CHECK VERSES THIS INVOICE #                  
         BE    GETI5               IF SO, THEN SKIP                             
*                                                                               
GETI6    CLI   MANRVDTP,0          SEE IF DOING A REVERSAL                      
         BE    GETI7                                                            
         CLC   PBINVNO,MANRVNO     ONLY SHOW BILL I'M REVERSING                 
         BNE   GETI5                                                            
         B     GETI8                                                            
*                                                                               
GETI7    DS    0H                                                               
*                                                                               
         CLI   SHOWREV,C'Y'        INCLUDING?                                   
         BE    *+12                                                             
*                                                                               
         TM    PBBILST,X'C0'       SKIP REVERSED AND REVERSALS                  
         BNZ   GETI5                                                            
*                                                                               
         CLI   SCBNCSW,C'C'         UFC COMM BILLING                            
         BNE   GETI7C                                                           
         TM    PBBILST,X'01'       SEE IF RIGHT TYPE                            
         BZ    GETI5                                                            
         B     GETI8                                                            
*                                                                               
GETI7C   DS    0H                                                               
         CLI   SCBNCSW,C'N'         UFC NET BILLING                             
         BNE   GETI8                                                            
         TM    PBBILST,X'02'       SEE IF RIGHT TYPE                            
         BZ    GETI5                                                            
*                                                                               
GETI8    L     RF,APRD                                                          
         CLC   PBPRD,0(RF)         MUST BE RIGHT PRODUCT                        
         BNE   GETI5                                                            
*                                                                               
         CLI   MRDASS,C'Y'         CHECK FOR SPECIAL DRD SCHEME                 
         BNE   GETI8X                                                           
*                                                                               
*           READ BILL AND SEE IF REG/DST MATCH SAVMGRU                          
*                                                                               
         GOTOR RDBILL,DMCB,ADWKREC,(R2)                                         
         L     RF,ADBILL                                                        
         CLC   SAVMGRU(6),PNBMGR1-PBILLREC(RF)                                  
         BNE   GETI5           SKIP IF NO MATCH                                 
*                                                                               
GETI8X   DS    0H                                                               
*              FOR EACH BILL ELEM SET PBGROS, ETC                               
*                                                                               
         OI    WK+4,X'01'          SET PREV BILLING FOUND                       
         MVC   PBGROS,PBGROSS     GROSS                                         
         ICM   R0,15,PBGROSS                                                    
         ICM   RF,15,PBAGYCOM                                                   
         SR    R0,RF                                                            
         ST    R0,PBNET            NET                                          
         MVC   PBCD,PBCSHDSC       CD                                           
         ICM   RF,15,PBCSHDSC                                                   
         SR    R0,RF                                                            
         ST    R0,PBNLCD           N-CD                                         
         ICM   R0,15,PBGROSS                                                    
         ICM   RF,15,PBCSHDSC                                                   
         SR    R0,RF                                                            
         ST    R0,PBGLCD           GROSS-CD                                     
         MVC   PBACOMM,PBAGYCOM                                                 
         L     RF,ADBUY                                                         
         CLI   PBDCOSIN-PBUYREC(RF),C'C' SEE IF 'C' RATE BUY                    
         BNE   *+12                                                             
         LA    R4,PBACOMM                                                       
         BAS   RE,GFIXAC                                                        
*                                                                               
         LA    R7,ALCOL3            CATS AS COLUMNS                             
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         LA    R7,ALCOL2                                                        
         ZIC   R4,DOLNUM                                                        
         MVC   HFORMAT,FORMAT     MUST RESET FOR EACH INVOICE                   
         MVC   WORK(16),SPACES                                                  
         MVC   W(2),PBLDATE        GETNUM NEEDS Y/M IN W                        
*                                                                               
         MVC   SVSVIMO,SVINVMO     SAVE 'REAL' INV MTH                          
*                                                                               
*        CAN'T USE GOTOR HERE - CAUSES ADDEMBLY ERROR                           
*                                                                               
****     GOTOR GETNUM,DMCB,(1,PBINVNO),WORK+6                                   
         GOTO1 =A(GETNUM),DMCB,(1,PBINVNO),WORK+6                               
*                                                                               
         MVC   SVINVMO,SVSVIMO     RESTORE 'REAL' INV MO                        
         MVC   HLDINO,WORK+6                                                    
*                                                                               
         LA    RF,ALCOL2                                                        
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         LA    RF,ALCOL1                                                        
         MVC   1(15,RF),WORK                                                    
         CLI   WORK+15,C' '        SEE IF INV NUMBER ONLY 9 LONG                
         BE    GETI10              YES                                          
         MVC   0(16,RF),WORK                                                    
GETI10   BAS   RE,GETCAT                                                        
         LR    R1,R5                                                            
         A     R1,FULL                                                          
         L     R6,0(R1)                                                         
         BAS   RE,FMTEDT                                                        
         LA    R7,16(R7)                                                        
         BCT   R4,GETI10                                                        
         LA    R8,132(R8)          DUE NEXT LINE                                
         B     GETI5               GO DO NEXT ELEM                              
*                                                                               
GETINVSX ST   R8,WK                                                             
         XIT1                                                                   
         SPACE 2                                                                
INXTEL   DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    INXTEL2                                                          
         CLC   0(1,R2),ELCODE                                                   
         BER   RE                                                               
         B     INXTEL                                                           
INXTEL2  DS    0H                                                               
         LTR   RE,RE                                                            
         BR    RE                                                               
         DROP  R2                                                               
         EJECT                                                                  
GFIXAC   NTR1                                                                   
*                                  R4 HAS ADDR OF 'BAD' AC                      
*                                  WILL BE SAME AS GROSS                        
*                                  FOR 'C' RATE BUYS                            
         L     RF,ADBUY                                                         
         ZAP   DUB,PBDACP-PBUYREC(3,RF)                                         
         BNZ   GFIXAC5                                                          
         XC    0(4,R4),0(R4)       CLEAR AC                                     
         B     GFIXACX                                                          
*                                                                               
GFIXAC5  CVB   R0,DUB                                                           
         L     R1,0(R4)                                                         
         L     RF,=F'100000'                                                    
         SR    RF,R0                                                            
         MR    RE,R1                                                            
         SLDL  RE,1                                                             
         D     RE,=F'100000'                                                    
         LTR   RF,RF                                                            
         BM    *+8                                                              
         AH    RF,=H'1'                                                         
         SRA   RF,1                                                             
*                                                                               
         LR    R0,R1                                                            
         SR    R0,RF                                                            
         ST    R0,0(R4)            STORE 'FIXED' AGY COM                        
GFIXACX  XIT1                                                                   
*                                                                               
HLDINO   DS    CL10                                                             
ADACCUM  DS    F         SAVED ADDRESS OF ACCUMULATOR FOR EDI CALL              
*                                                                               
         EJECT                                                                  
ORGROSS  DS    F                ORDERED                                         
ORNET    DS    F                                                                
ORCD     DS    F                                                                
ORGLCD   DS    F                                                                
ORNLCD   DS    F                                                                
ORACOMM  DS    F                                                                
*                                                                               
PBGROS   DS    F                PREV BILLED                                     
PBNET    DS    F                                                                
PBCD     DS    F                                                                
PBGLCD   DS    F                                                                
PBNLCD   DS    F                                                                
PBACOMM  DS    F                                                                
*                                                                               
BLGROSS  DS    F                BILLABLE                                        
BLNET    DS    F                                                                
BLCD     DS    F                                                                
BLGLCD   DS    F                                                                
BLNLCD   DS    F                                                                
BLACOMM  DS    F                                                                
****                                                                            
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PFMTAMT - FORMAT PACKED BILLING AMOUNTS'                        
*                                                                               
PFMTAMT  NMOD1 0,PFMTAMT                                                        
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         MVC   PHLDINO,SPACES                                                   
*                                                                               
         ST    R3,SAVBRK           SAVE BRK LEVEL                               
*                                  SET ZLSW TO CONTROL ZERO LINE TOTALS         
         MVI   ZLSW,C'N'           N = NO SPECIAL TREATMENT                     
**NO-OP**                                                                       
*****    CLC   SAVBRK,ALOWTOG         IF AT LOWEST LEVEL                        
*****    BE    PFA2D                                                            
**NO-OP **                                                                      
         CLI   ZLOPT,C'A'             OR IF NOT FOR THIS TYPE                   
         BE    PFA2B                                                            
         CLC   TYPE,ZLOPT                                                       
         BNE   PFA2D                                                            
PFA2B    DS    0H                                                               
*                                  MUST SEE IF I'M SHOWING 3 TYPES              
*                                  IF SO THIS OPTION WILL SUPPRESS              
*                                  PREVIOUS BILLING AND BILLABLE LINE           
*                                  IF THERE IS NO PREVIOUS BILLINGS             
         LA    R2,ORDSW                                                         
         LA    R4,3                                                             
PFA2B5   CLI   0(R2),C'Y'                                                       
         BE    PFA2B8                                                           
         CLI   0(R2),C'D'          SHOWING ONLY FOR INS DETAIL                  
         BNE   PFA2D               MUST BE 'N' SO LEAVE ZLSW='N'                
         CLI   BRKCODE+3,DESCEQ                                                 
         BNE   PFA2D                                                            
PFA2B8   LA    R2,1(R2)                                                         
         BCT   R4,PFA2B5                                                        
         MVI   ZLSW,C'Y'                                                        
*                                                                               
PFA2D    DS    0H                                                               
*                                                                               
         LM    R2,R3,0(R1)         R2 = A(BIGTOTS) ORDERD + BILLED              
*                                  R3 = A(PREV INV NO.)                         
*                                                                               
PFA2D2   ST    R2,ADACCUMP   SAVE ACCUMLATOR ADDRESS FOR EDI CALL               
*                                                                               
         L     R8,=A(GRID)                                                      
         USING ALINED,R8                                                        
         LA    RE,14                                                            
PFA2D5   MVC   0(132,R8),SPACES                                                 
         LA    R8,132(R8)                                                       
         BCT   RE,PFA2D5                                                        
         L     R8,=A(GRID)                                                      
*****    CLI   UPASS,X'FF'         RETAIL SUMMARY PASS - WAS C'S'               
*****    BE    PFMT40                                                           
*                                                                               
PFMT5    DS    0H                                                               
         L     RF,SAVBRK                                                        
         CLI   3(RF),X'18'       ESTIMATE TOTALS                                
         BNE   PFMT5D                                                           
         CLI   PASSNO,2          DETAIL PACK-UP PASS?                           
         BNE   PFMT5D                                                           
         LA    RF,BIGTOTS        POINTED TO BIGTOTS                             
         CR    RF,R2                                                            
         BNE   PFMT5D                                                           
*                                I MUST ADD BIGTOTST                            
         LR    R4,R2             TO BIGTOTS HERE                                
         LA    R5,BIGTOTST                                                      
         LA    R6,12                                                            
PFMT5A   AP    0(6,R4),0(6,R5)                                                  
         LA    R4,6(R4)                                                         
         LA    R5,6(R5)                                                         
         BCT   R6,PFMT5A                                                        
*                                                                               
*              BUILD MATRIX FOR DOLLARS                                         
PFMT5D   MVC   PORGROSS(18),0(R2)      ORD GR,N,CD                              
         ZAP   PORGLCD,PORGROSS                                                 
         SP    PORGLCD,PORCD                                                    
         ZAP   PORNLCD,PORNET                                                   
         SP    PORNLCD,PORCD                                                    
         MVC   PORACOMM,18(R2)              AGY COM                             
         MVC   PPBGROS(18),36(R2)      PREV BILLED GR,N,CD                      
         ZAP   PPBGLCD,PPBGROS                                                  
         SP    PPBGLCD,PPBCD                                                    
         ZAP   PPBNLCD,PPBNET                                                   
         SP    PPBNLCD,PPBCD                                                    
         MVC   PPBACOMM,54(R2)                                                  
*                                                                               
         MVC   PPBLGROS(36),PORGROSS  CALCULATE BILLABLES                       
         LA    R4,PPBLGROS                                                      
         LA    R5,PPBGROS                                                       
         LA    R6,6                FOR BCT                                      
PFMT5G   SP    0(6,R4),0(6,R5)                                                  
         LA    R4,6(R4)                                                         
         LA    R5,6(R5)                                                         
         BCT   R6,PFMT5G                                                        
*                                                                               
         MVC   HFORMAT,FORMAT                                                   
         MVC   HTYPES,ORDSW                                                     
         CLI   DOLNUM,1                                                         
         BNE   PFMT6                                                            
         CLI   TYPNUM,1                                                         
         BNE   PFMT6                                                            
*              ONE CAT AND 1 TYPE                                               
         LA    R7,ALCOL4           PUT IN COL4                                  
         BAS   RE,PGETCAT          SETS FULL TO ORGROSS,OR NET,ETC..            
         L     R1,FULL                                                          
         BAS   RE,PGETTYP           SETS FULL TO 0,36,72 - DISP                 
         CLI   FULL,X'FF'          SEE IF NOT DISPLAYING THESE $                
         BE    PFMT5X                                                           
         A     R1,FULL             ADD DISP                                     
         LR    R6,R1               ADDRESS OF $                                 
         BAS   RE,PFMTEDT                                                       
PFMT5X   B     PFMT9               GO DO STRIP-OFF                              
*                                                                               
PFMT6    CLI   DOLNUM,1            ONE CAT SEVERAL TYPES                        
         BNE   PFMT7                                                            
*                                                                               
*                                  IF DOING INS DETAILS WITH PREV               
*                                  INVOICES AT INSERTION LEVEL                  
*                                  THEN MUST USE GRID FORMAT EVEN FOR           
*                                  ONE CATEGROY                                 
         JIF   FMTSW,EQ,C'D',AND,LSTOPT,EQ,C'I',PFMT7,JUMP=N                    
         JIF   FMTSW,EQ,C'D',AND,LSTOPT,EQ,C'D',PFMT7,JUMP=N                    
         JIF   FMTSW,EQ,C'D',AND,LSTOPT,EQ,C'B',PFMT7,JUMP=N                    
         LA    R7,ALCOL2                                                        
         CLI   TYPNUM,3                                                         
         BE    *+8                                                              
         LA    R7,ALCOL3                                                        
         ZIC   R4,TYPNUM                                                        
         BAS   RE,PGETCAT                                                       
         MVC   PSVFULL,FULL                                                     
PFMT6C   BAS   RE,PGETTYP           SETS FULL TO 0,36,72 DISP                   
         CLI   FULL,X'FF'          SEE IF NOT DISPLAYING THESE $                
         BE    PFMT6X              SKIP THIS COLUMN                             
         L     R5,PSVFULL                                                       
         A     R5,FULL             ADD DISPLACEMENT                             
         LR    R6,R5               ADDESSS OF THE $                             
         BAS   RE,PFMTEDT                                                       
PFMT6X   LA    R7,16(R7)                                                        
         BCT   R4,PFMT6C                                                        
         B     PFMT9               GO DO STRIP-OFF                              
*                                                                               
PFMT7    CLI   TYPNUM,1                                                         
         BNE   PFMT8                                                            
         CLI   DOLNUM,5                                                         
         BNL   PFMT8                                                            
         LA    R7,ALCOL1                                                        
         CLI   DOLNUM,4                                                         
         BE    PFMT7A                                                           
         LA    R7,ALCOL2                                                        
         CLI   DOLNUM,3                                                         
         BE    PFMT7A                                                           
         LA    R7,ALCOL3                                                        
PFMT7A   ZIC   R4,DOLNUM                                                        
         BAS   RE,PGETTYP          SETS FULL TO 0,36,72 - DISP                  
         CLI   FULL,X'FF'          SEE IF NOT SHOWING THESE $                   
         BE    PFMT7X              SKIP ALL COLUMNS TO STRIP-OFF                
         L     R5,FULL                                                          
PFMT7C   BAS   RE,PGETCAT                                                       
         L     R1,FULL                                                          
         AR    R1,R5                                                            
         LR    R6,R1        ADDRESS OF $                                        
         BAS   RE,PFMTEDT                                                       
         LA    R7,16(R7)                                                        
         BCT   R4,PFMT7C                                                        
PFMT7X   B     PFMT9               GO DO STRIP-OFF                              
*                                                                               
PFMT8    DS    0H                  MORE THAN 1 CATS AND TYPES                   
*                                  OR ALL 5 CATS                                
*                                  MUST BUILD 'BOX'                             
         CLI   DOLNUM,3            SEE IF MORE THAN 3 CATS                      
         BH    PFMT8G              YES MUST PUT CATS AS ROWS                    
         MVI   NOPREVB,C'N'                                                     
         ZIC   R2,TYPNUM                                                        
PFMT8B   LA    R7,ALCOL3            ELSE CATS AS COLUMNS                        
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         LA    R7,ALCOL2                                                        
         ZIC   R4,DOLNUM                                                        
         MVC   HFORMAT,FORMAT     MUST RESET FOR EACH TYPE                      
         BAS   RE,PGETTYP           SETS FULL TO 0,20,40 - DISP                 
         L     R5,FULL                                                          
         CLI   FULL,X'FF'          SEE IF NOT SHOWING THESE $                   
         BE    PFMT8E              SKIP ROW  - DUE NEXT TYPE                    
         MVC   SAVTYPE,WORK        SAVE TYPE TO CHK IN PFMT8D                   
         LA    RF,ALCOL2                                                        
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         LA    RF,ALCOL1                                                        
         MVC   0(16,RF),WORK        HAS ANNOTATION - ORDERED,PREV,ETC           
*                                  MUST RESTORE R3 TO GET BRKCODE               
*                                                                               
         B     PFMT8D               SKIP INSERTION CODE                         
*                                                                               
         L     R3,SAVBRK                                                        
         CLI   BRKCODE+3,DESCEQ    CHK AT INSERTN LEVEL                         
         BNE   PFMT8D                                                           
*--->    CLC   WORK+4(5),=C'PREV.'   SEE IF DOING PREV BILLING                  
         CLC   WORK(16),PTYPRVBD     SEE IF DOING PREV BILLING                  
         BNE   PFMT8D                                                           
         L     RF,ADESC                                                         
         CLI   0(RF),X'F9'         SEE IF A 'REAL' BUY                          
         BH    PFMT8D              NO                                           
*                                                                               
         CLI   LSTOPT,C'I'    SEE IF SHOWING PREV INVS AT INSERTION             
         BE    PFMT8C                                                           
         CLI   LSTOPT,C'D'    SEE IF SHOWING PREV INVS AT INSERTION             
         BE    PFMT8C                                                           
         CLI   LSTOPT,C'B'    SEE IF SHOWING PREV INVS AT INSERTION             
         BE    PFMT8C                                                           
         B     PFMT8D                                                           
*              BUY SHOULD BE IN ADWKREC                                         
*                                                                               
*              FOR EACH BILL ELEM PRINT PREV INV NO. AND AMTS                   
PFMT8C   ST    R8,WK                                                            
*****    BAS   RE,GETINVS                                                       
***             GETINVS SETS WK TO NEXT LINE                                    
*                                                                               
         CLI   WK+4,X'01'          SEE IF PREV BILLING FOUND                    
         BNE   PFMT8D                                                           
         L     R8,WK               SET LINE                                     
         BCT   R2,PFMT8B                                                        
         B     PFMT9                                                            
*                                                                               
PFMT8D   MVI   NONZSW,1                                                         
         CLI   ZLSW,C'Y'   SEE IF SUPPRESSING ZERO PREV. BILL LINE              
         BNE   PFMT8D3                                                          
*--->    CLC   SAVTYPE+4(5),=C'PREV.'  SEE IF DOING PREV BILLING                
         CLC   SAVTYPE(16),PTYPRVBD    SEE IF DOING PREV BILLING                
         BNE   PFMT8D3                                                          
         MVI   NONZSW,0                                                         
PFMT8D3  BAS   RE,PGETCAT                                                       
         L     R1,FULL                                                          
         AR    R1,R5                                                            
         LR    R6,R1                                                            
         CP    0(6,R6),=P'0'                                                    
         BNE   *+8                                                              
         OI    NONZSW,X'01'       SET NON-ZERO AMT FOUND                        
         BAS   RE,PFMTEDT                                                       
         LA    R7,16(R7)                                                        
         BCT   R4,PFMT8D3          GO CHK NEXT CAT                              
         CH    R2,=H'1'            SEE IF DOING BILLABLE LINE                   
         BE    PFMT8D5                                                          
         TM    NONZSW,X'01'                                                     
         BNZ   PFMT8D7                                                          
         B     PFMT8D6             ALL PREV BILLED CATS ARE ZERO                
*                                  DON'T PRINT THIS LINE                        
*                                                                               
PFMT8D5  CLI   NOPREVB,C'Y'        WILL ONLY BE 'Y' FOR BILLABLE LINE           
         BNE   PFMT8D7             IF THERE WAS NO PREV BILLING                 
*                                  AND IT IS BEING SUPPRESSED                   
PFMT8D6  MVC   0(132,R8),SPACES    MUST BLANK-OUT ANNO AND $'S                  
         MVI   NOPREVB,C'Y'        SET SO I WON'T PRINT BILLABLE LINE           
         B     PFMT8E              AND NOT SKIP A LINE                          
*                                                                               
PFMT8D7  LA    R8,132(R8)          DUE NEXT LINE                                
PFMT8E   BCT   R2,PFMT8B                                                        
         B     PFMT9               NOW DO STRIP-OFF                             
*                                                                               
PFMT8G   DS    0H                  CATS AS ROWS                                 
         ZIC   R2,DOLNUM                                                        
PFMT8I   LA    R7,ALCOL3                                                        
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         LA    R7,ALCOL2                                                        
         ZIC   R4,TYPNUM                                                        
         BAS   RE,PGETCAT          SETS FULL TO ORGROSS OR ORNET,ETC            
         MVC   HTYPES,ORDSW        MUST RESET EACH CAT                          
         L     R5,FULL                                                          
         LA    RF,ALCOL2                                                        
         CLI   TWOCOL,C'Y'                                                      
         BE    *+8                                                              
         LA    RF,ALCOL1                                                        
         MVC   0(16,RF),WORK      HAS ANNOTATION - ORDERED,PREV,ETC             
PFMT8K   BAS   RE,PGETTYP           SETS FULL TO 0,20,40                        
         L     R1,FULL                                                          
         CLI   FULL,X'FF'          SEE IF NOT SHOWING THESE $                   
         BE    PFMT8M                                                           
         AR    R5,R1               ADD DISPLACEMENT                             
         LR    R6,R5               ADDRESS 0F $                                 
         BAS   RE,PFMTEDT                                                       
PFMT8M   LA    R7,16(R7)                                                        
         BCT   R4,PFMT8K                                                        
         LA    R8,132(R8)          DO NEXT LINE                                 
         BCT   R2,PFMT8I                                                        
         B     PFMT9               NOW DO STRIP-OFF                             
*                                                                               
PFMT9    DS    0H                  STRIP-OFF                                    
         L     R2,ADACCUMP        RESET R2 TO ACCUMULATOR                       
         GOTO1 ABILLEDI,DMCB,('EDMMTA',PHLDINO)   EDI CALL                      
         LA    R2,5                FOR BCT                                      
         L     R8,=A(GRID)         RESET TO FIRST LINE FOR STRIP                
         LA    R7,ALSTRIP                                                       
         LA    R1,PPBLGROS                                                      
         LA    R5,STRIPT           STRIP TABLE                                  
PFMT9B   CLC   STRIP,0(R5)                                                      
         BE    PFMT9E                                                           
         LA    R1,6(R1)                                                         
         LA    R5,1(R5)                                                         
         BCT   R2,PFMT9B                                                        
         B     PFMT9X               IF STRIP NOT IN TABLE-SKIP                  
*                                                                               
PFMT9E   LR    R6,R1                ADDRESS OF $                                
         BAS   RE,PFMTEDT                                                       
PFMT9X   B     PFMTAMTX                                                         
*                                                                               
PFMTAMTX  DS    0H                                                              
         XIT1                                                                   
         SPACE 3                                                                
PFMTEDT  DS    0H                                                               
         LA    R1,ALCOL4        SEE IF DOING LAST COLUMN                        
         CR    R7,R1                                                            
         BNE   PFMTEDT5         YES - MOVE EDITED AMT OVER 1 COL                
         ST    RE,DUB                                                           
*                                                                               
*--->    EDIT  (R6),(15,0(R7)),2,COMMAS=YES,CR=YES                              
*******  CURED (R6),(15,0(R7)),CURTAB,COMMAS=YES,CR=YES                         
         CURED (P6,0(R6)),(15,0(R7)),CURTAB,COMMAS=YES,CR=YES                   
         L     RE,DUB                                                           
         CLI   13(R7),C' '                                                      
         BHR   RE                                                               
*        CLI   NOSTAR,C'Y'         SUPPRESS ** ON TOTALS?                       
         TM    FLAG1,NOSTAR        SUPPRESS ** ON TOTALS?                       
         BO    *+10                                                             
         MVC   13(2,R7),TOTSTAR                                                 
         BR    RE                                                               
PFMTEDT5 DS    0H                                                               
         ST    RE,DUB                                                           
*--->    EDIT  (R6),(15,1(R7)),2,COMMAS=YES,CR=YES                              
******   CURED (R6),(15,1(R7)),CURTAB,COMMAS=YES,CR=YES                         
         CURED (P6,0(R6)),(15,1(R7)),CURTAB,COMMAS=YES,CR=YES                   
         L     RE,DUB                                                           
         CLI   14(R7),C' '                                                      
         BHR   RE                                                               
*        CLI   NOSTAR,C'Y'         SUPPRESS ** ON TOTALS?                       
         TM    FLAG1,NOSTAR        SUPPRESS ** ON TOTALS?                       
         BO    *+10                                                             
         MVC   14(2,R7),TOTSTAR                                                 
         BR    RE                                                               
         SPACE 2                                                                
PFMTEDT6 DS   0H                                                                
         L     R0,12(R2)                                                        
         EDIT  (R0),(5,10(R7))                                                  
         BR    RE                                                               
         SPACE 3                                                                
         DROP  R8                                                               
*                                                                               
*                                                                               
STRIPT   DC    C'GNC12'      1=G-CD,2=N-CD                                      
NONZSW   DC    X'00'                                                            
NOPREVB  DC    C'N'          PRESET JUST IN CASE                                
SAVTYPE  DS    CL16                                                             
*                                                                               
         EJECT                                                                  
PGETCAT  NTR1                                                                   
         MVC   WORK(16),SPACES                                                  
         XC    FULL,FULL                                                        
*                                                                               
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
         MVC   PATNAMES(L'PPRGROSS),PPRGROSS                                    
*COST2*                                                                         
         CLI   CAROPT,C'Y'    CHECK CARAT OPTION                                
         BNE   *+10                                                             
         MVC   PATNAMES(16),=C'  COST TO CLIENT'                                
*COST2*                                                                         
         MVC   PATNET(L'PPRNET),PPRNET                                          
         MVC   PATCDISC(L'PP@CDISC),PP@CDISC                                    
         MVC   PATGRSLC(L'PPRGRSLC),PPRGRSLC                                    
         MVC   PATNETCD(L'PPRNETCD),PPRNETCD                                    
         MVC   PATAGYCM(L'PPAAGYCM),PPAAGYCM                                    
         DROP  RE                                                               
*                                                                               
         LA    R4,6                FOR BCT                                      
         LA    R5,HFORMAT                                                       
         LA    R6,PORGROSS                                                      
         LA    R7,PATNAMES                                                      
PGETC3   CLI   0(R5),C'Y'          SEE IF DOING THIS CAT                        
         BE    PGETC5                                                           
         LA    R5,1(R5)                                                         
         LA    R6,6(R6)            $ CAT                                        
         LA    R7,16(R7)                                                        
         BCT   R4,PGETC3                                                        
         B     PGETCX                                                           
*                                                                               
PGETC5   ST    R6,FULL             SAVE ADDRESS OF DOLLARS                      
         MVI   0(R5),C'N'          SO I WON'T REDO THIS CAT                     
         MVC   WORK(16),0(R7)                                                   
PGETCX   XIT1                                                                   
*                                                                               
PATNAMES DC    CL16'           GROSS'                                           
PATNET   DC    CL16'             NET'                                           
PATCDISC DC    CL16'      CASH DISC.'                                           
PATGRSLC DC    CL16'   GROSS LESS CD'                                           
PATNETCD DC    CL16'     NET LESS CD'                                           
PATAGYCM DC    CL16'    AGENCY COMM.'                                           
**                                                                              
         EJECT                                                                  
PGETTYP  NTR1                                                                   
         MVC   WORK(16),SPACES                                                  
*                                                                               
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
         MVC   PTYPNAME,PP@ORD                                                  
         MVC   PTYPRVBD,PP@PRV04                                                
         MVC   PTYPBILL,PP@BILLA                                                
         DROP  RE                                                               
*                                                                               
         XC    FULL,FULL                                                        
         LA    R5,HTYPES                                                        
******   LA    R6,PORGROSS                                                      
         SR    R6,R6                                                            
         LA    R7,PTYPNAME                                                      
         LA    R4,3                FOR BCT                                      
PGETT3   CLI   0(R5),C'Y'          SEE IF DOING THIS CAT                        
         BE    PGETT5                                                           
         CLI   0(R5),C'D'          SEE IF DOING THIS TYPE ONLY AT               
         BNE   PGETT4              INSERTTION DETAIL LEVEL                      
         L     R3,SAVBRK           SEE IF AT INS DETAIL LEVEL                   
         CLI   BRKCODE+3,DESCEQ                                                 
         BE    PGETT5                                                           
         MVI   FULL,X'FF'          SET NOT TO DISPLAY $                         
         B     PGETT8                                                           
*                                                                               
PGETT4   LA    R5,1(R5)                                                         
         LA    R6,36(R6)           NEXT SET                                     
         LA    R7,16(R7)                                                        
         BCT   R4,PGETT3                                                        
         B     PGETTX                                                           
*                                                                               
PGETT5   ST    R6,FULL             SAVE DISPLACEMENT                            
PGETT8   MVI   0(R5),C'N'          SO I WON'T REDO THIS TYPE                    
         MVC   WORK(16),0(R7)                                                   
**NEW 10/17/89                                                                  
         CLI   PAYOPT,C'G'         SEE IF CHANGING ORDERED TO CLEARED           
         BE    PGETT8C                                                          
         CLI   PAYOPT,C'C'         SEE IF CHANGING ORDERED TO CLEARED           
         BNE   PGETTX                                                           
*                                                                               
PGETT8C  L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    CLC   WORK+9(7),=C'ORDERED'                                            
         CLC   WORK(16),PP@ORD                                                  
         BNE   PGETTX                                                           
*--->    MVC   WORK+9(7),=C'CLEARED'                                            
         MVC   WORK(16),SPACES                                                  
         MVC   WORK+16-L'PP@CLEAR(L'PP@CLEAR),PP@CLEAR                          
         DROP  RE                                                               
**NEW 10/17/89                                                                  
PGETTX   XIT1                                                                   
*                                                                               
PTYPNAME DC    CL16'         ORDERED'                                           
PTYPRVBD DC    CL16'    PREV. BILLED'                                           
PTYPBILL DC    CL16'        BILLABLE'                                           
**                                                                              
PORGROSS DS    PL6              ORDERED                                         
PORNET   DS    PL6                                                              
PORCD    DS    PL6                                                              
PORGLCD  DS    PL6                                                              
PORNLCD  DS    PL6                                                              
PORACOMM DS    PL6                                                              
*                                                                               
PPBGROS  DS    PL6              PREV BILLED                                     
PPBNET   DS    PL6                                                              
PPBCD    DS    PL6                                                              
PPBGLCD  DS    PL6                                                              
PPBNLCD  DS    PL6                                                              
PPBACOMM DS    PL6                                                              
*                                                                               
PPBLGROS DS    PL6              BILLABLE                                        
PPBLNET  DS    PL6                                                              
PPBLCD   DS    PL6                                                              
PPBLGLCD DS    PL6                                                              
PPBLNLCD DS    PL6                                                              
PPBLACOM DS    PL6                                                              
****                                                                            
PHLDINO  DS    CL10                                                             
ADACCUMP DS    F         SAVED ADDRESS OF ACCUMULATOR FOR EDI CALL              
*                                                                               
PSVFULL  DS    F                                                                
*                                                                               
         SPACE 3                                                                
*                                                                               
         LTORG                                                                  
         TITLE 'LSTINV  - ROUTINE FOR PREVIOUS BILLING'                         
LSTINV   NMOD1 0,LSTINV                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         L     R3,SAVBRK                                                        
         L     RF,BRKCODE                                                       
         L     RF,ATOTS(RF)             POINT TO ACCUM                          
         LR    R7,RF                                                            
         AH    R7,=Y(MAXMOS*ROWL)       POINT TO TOTAL ROW                      
         CLI   FINANSW,0            FOR FINANCIAL USE OPEN BILLING              
         BE    LI20                                                             
***R***                                                                         
         CLC   QPROG,=C'R1'        EXCEPT FINANCIAL REBATE BILLING              
         BE    LI20                                                             
         CLC   QPROG,=C'RD'  EXCEPT FINANCIAL REBATE BILLING DRAFT              
         BE    LI20                                                             
***R***                                                                         
         LA    R7,ROWTL(R7)                                                     
LI20     OC    ROWHL(8,R7),ROWHL(R7)                                            
         BZ    LSTINVX             NO PREVIOUS BILLING                          
*                                                                               
         MVI   PRSW,C'H'           SET TO HOLD PRINT LINES                      
         LA    R2,P1                                                            
         USING ALINED,R2                                                        
*                                                                               
         LA    R1,6                                                             
         LA    RE,LSTTOTSP          CLEAR PACKED TOTALS                         
LI22     ZAP   0(6,RE),=P'0'                                                    
         LA    RE,6(RE)                                                         
         BCT   R1,LI22                                                          
*                                                                               
         XC    LSTTOTS,LSTTOTS      CLEAR BINARY TOTALS                         
*                                                                               
         CLC   BORDSW(3),=C'YNN'                                                
         BE    LI30                 (ORDERED ONLY)                              
         B     LI40                OTHERS                                       
*                                                                               
         EJECT                                                                  
*                             SUBTRACT OUT PREVIOUS BILLS                       
*                             ON SOME INVOICE                                   
LI30     DS    0H                                                               
*                                                                               
         CLI   LSTOPT,C'A'    SHOWING PREVIOUS BILL AMT DUES                    
         BE    LI40            - NO SUBTRACTION                                 
*                                                                               
         CLI   LSTOPT,C'Y'                                                      
         BE    LI34                                                             
         CLI   LSTOPT,C'I'                                                      
         BE    LI34                                                             
         CLI   LSTOPT,C'R'                                                      
         BE    LI34                                                             
         CLI   LSTOPT,C'B'                                                      
         BE    LI34                                                             
*                                  FOR LSTOPT 'N' OR 'D'                        
*                                  JUST SUBTRACTING TOTAL PREVIOUS              
         MVC   LSTGRS(16),ROWHL(R7)     GROSS,NET,CD,AC                         
         LA    R5,ALDESC                                                        
         CLI   DOLNUM,4                                                         
         BNL   LI30C               4 OR 5 OR 6                                  
         LA    R5,ALCOL1-8                                                      
         CLI   DOLNUM,3                                                         
         BE    LI30C                                                            
         LA    R5,ALCOL2-8                                                      
         CLI   DOLNUM,2                                                         
         BE    LI30C                                                            
         LA    R5,ALCOL3-8         MUST BE 1                                    
LI30C    DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   0(21,R5),=C'LESS PREVIOUS BILLING'                               
         MVC   0(L'PP@LPB,R5),PP@LPB                                            
         DROP  RE                                                               
         MVC   X(16),LSTGRS                                                     
         BAS   RE,LSTFMT                                                        
         GOTO1 =A(PRNT)                                                         
         LM    R0,R1,0(R7)                                                      
         S     R0,ROWHL(R7)                                                     
         S     R1,ROWHL+NDSP(R7)                                                
         STM   R0,R1,X             ORDERED LESS PREVIOUS                        
         L     R0,CDSP(R7)         CD                                           
         S     R0,ROWHL+CDSP(R7)                                                
         ST    R0,X+8                                                           
         L     R0,ADSP(R7)         AC                                           
         S     R0,ROWHL+ADSP(R7)                                                
         ST    R0,X+12                                                          
         BAS   RE,LSTFMT                                                        
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
         B     LI90                                                             
*                                                                               
LI34     DS    0H                                                               
         LA    R5,ALDESC                                                        
         CLI   DOLNUM,4                                                         
         BNL   LI34C               4 OR 5                                       
         LA    R5,ALCOL1-8                                                      
         CLI   DOLNUM,3                                                         
         BE    LI34C                                                            
         LA    R5,ALCOL2-8                                                      
         CLI   DOLNUM,2                                                         
         BE    LI34C                                                            
         LA    R5,ALCOL3-8         MUST BE 1                                    
LI34C    DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   0(21,R5),=C'LESS PREVIOUS BILLING'                               
         MVC   0(L'PP@LPB,R5),PP@LPB                                            
         DROP  RE                                                               
         MVC   132(21,R5),DASHES                                                
         GOTO1 =A(PRNT)                                                         
         BAS   RE,LSTLST                                                        
         LM    R0,R1,0(R7)                                                      
         S     R0,ROWHL(R7)                                                     
         S     R1,ROWHL+4(R7)                                                   
         STM   R0,R1,X                                                          
         L     R0,CDSP(R7)         CD                                           
         S     R0,ROWHL+CDSP(R7)                                                
         ST    R0,X+8                                                           
         L     R0,ADSP(R7)         AC                                           
         S     R0,ROWHL+ADSP(R7)                                                
         ST    R0,X+12                                                          
         BAS   RE,LSTFMT                                                        
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
         B     LI90                                                             
***                                                                             
***NOTE NO NEED TO RESTATE AMT DUE ON ORDERED ONLY BILL                         
***                                                                             
         EJECT                                                                  
*                             BILL IS COMPLETE                                  
*                             AND PREV LIST IS JUST FOR INFO                    
LI40     DS    0H                                                               
         MVI   P1,0                                                             
         MVI   P2,C'*'                                                          
         MVC   P2+1(83),P2                                                      
*                             PRINT A LINE OF STARS                             
         GOTO1 =A(PRNT)                                                         
*                                                                               
         LA    R5,ALCOL2                                                        
         CLI   LSTOPT,C'A'   SHOWING PREVIOUS AMT DUES                          
         BE    LI40C                                                            
*                                                                               
         LA    R5,ALDESC+3                                                      
         CLI   DOLNUM,4                                                         
         BNL   LI40C                                                            
         LA    R5,ALCOL1                                                        
         CLI   DOLNUM,3                                                         
         BE    LI40C                                                            
         LA    R5,ALCOL2                                                        
LI40C    DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*--->    MVC   0(14,R5),=C'PREVIOUS BILLS'                                      
         MVC   0(L'PP@PRVBL,R5),PP@PRVBL                                        
         MVC   LCATNAM(L'PPRGROSS),PPRGROSS                                     
         MVC   LCATNET(L'PPRNET),PPRNET                                         
         MVC   LCATCD(L'PP@CDISC),PP@CDISC                                      
         MVC   LCATGLCD(L'PPRGRSLC),PPRGRSLC                                    
         MVC   LCATNLCD(L'PPRNETCD),PPRNETCD                                    
         MVC   LCATAC(L'PPAAGYCM),PPAAGYCM                                      
         DROP  RE                                                               
         MVC   132(14,R5),DASHES                                                
*                                                                               
         CLI   LSTOPT,C'A'   SHOWING PREVIOUS BILLS AMT DUE                     
         BE    LI50                                                             
*                                                                               
*                                                                               
*              SEE IF CATS AS COLUMNS                                           
*              IF SO DON'T REDISPLAY THEM                                       
         JIF   TYPNUM,=,1,AND,DOLNUM,=,4,LI50,JUMP=N                            
         JIF   TYPNUM,LT,4,AND,DOLNUM,LT,4,LI50,JUMP=N                          
         ZIC   R4,DOLNUM                                                        
         CH    R4,=H'4'                                                         
         BNH   *+8                                                              
         LA    R4,4                CAN ONLY DO 4 DOL TYPES                      
         LA    R5,16(R5)                                                        
*                                                                               
         MVC   HFORMAT,FORMAT                                                   
*                                                                               
LI40F    BAS   RE,LGETCAT                                                       
         MVC   0(16,R5),WORK                                                    
         LA    R5,16(R5)                                                        
         BCT   R4,LI40F                                                         
LI50     GOTO1 =A(PRNT)                                                         
*                                                                               
         BAS   RE,LSTLST                                                        
         B     LI80                                                             
LI80     DS    0H                                                               
         CLI   LSTOPT,C'R'         SEE IF RESTATING AMT DUE                     
         BE    LI85                                                             
         CLI   LSTOPT,C'B'         SEE IF RESTATING AMT DUE                     
         BNE   LI90                                                             
LI85     GOTO1 =A(PRNT)            SKIP A LINE                                  
*                                                                               
         L     RE,=A(DICSECT)                                                   
         AH    RE,=Y(DSLIST-DICSECT)                                            
         USING DSLIST,RE                                                        
*                                                                               
         L     R0,SVAMTDUE                                                      
         LTR   R0,R0               TEST DUE POS OR NEG                          
         BM    LIA26                                                            
         CLI   RETPROF,0           FOR RETAIL USE DIFFERENT WORDS               
         BE    LIA24D                                                           
         CLI   UPASS,X'FF'         UNLESS SUMMARY PASS - WAS C'S'               
         BNE   LIA25                                                            
LIA24D   DS    0H                                                               
*--->    MVC   W(16),=C'** AMOUNT DUE **'                                       
         MVC   W(L'PP@AMDUE),PP@AMDUE                                           
         C     R3,AINVBRK                                                       
         BE    LIA27                                                            
*--->    MVC   W(15),=C'AMOUNT DUE FOR '                                        
         MVC   W(L'PP@ADFOR),PP@ADFOR                                           
         MVC   W+15(12),TOTNAME    LEVEL NAME                                   
         B     LIA27                                                            
*                                                                               
LIA25    DS    0H                  RETAIL TOTAL WORDS                           
         MVC   W,SPACES                                                         
*--->    MVC   W(18),=C'** TOTAL AMOUNT **'                                     
         MVC   W(L'PP@TAMT),PP@TAMT                                             
         C     R3,AINVBRK                                                       
         BE    LIA27                                                            
*--->    MVC   W(10),=C'TOTAL FOR '                                             
         MVC   W(L'PP@TLFOR),PP@TLFOR                                           
         MVC   W+L'PP@TLFOR+1(12),TOTNAME         LEVEL NAME                    
         B     LIA27                                                            
LIA26    DS    0H                                                               
*--->    MVC   W(19),=C'** CREDIT AMOUNT **'                                    
         MVC   W(L'PP@CDAMT),PP@CDAMT                                           
         CLC   SAVBRK,AINVBRK                                                   
         BE    LIA27                                                            
*--->    MVC   W(18),=C'CREDIT AMOUNT FOR '                                     
         MVC   W(L'PP@CAMFR),PP@CAMFR                                           
         MVC   W+L'PP@CAMFR+1(12),TOTNAME       LEVEL NAME                      
         DROP  RE                                                               
*                                                                               
LIA26B   DS    0H                                                               
LIA27    DS    0H                                                               
         LA    R2,P1                                                            
         CLI   BDOLNUM,1                                                        
         BNE   LIA3A2                                                           
         CLI   BTYPNUM,1                                                        
         BNE   LIA3A2                                                           
LIA3A    DS    0H                                                               
         SH    R2,=H'16'      SHIFT SINGLE COL. FORMATS LEFT 1 COL.             
LIA3A2   DS    0H                                                               
         LA    RF,W+32                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R1,W                                                             
         SR    RF,R1               RF = LENGTH - 1                              
         LA    RE,ALCOL4-2                                                      
         SR    RE,RF               RE = TO ADDR                                 
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),W                                                        
         ST    RE,DUB                                                           
*--->    EDIT  (R0),(16,ALCOL4-1),2,COMMAS=YES,CR=YES                           
         CURED (R0),(16,ALCOL4-1),CURTAB,COMMAS=YES,CR=YES                      
         L     RE,DUB                                                           
         CLI   ALCOL4+13,C' '                                                   
         BH    LI87                                                             
         MVC   ALCOL4+13(2),=C'**'                                              
         B     LI88                                                             
*                                                                               
LI87     MVC   ALCOL4+15(2),=C'**'                                              
LI88     GOTO1 =A(PRNT)                                                         
*                                                                               
LI90     MVI   PRSW,C'F'           FLUSH PRINT LINES                            
         GOTO1 =A(PRNT)                                                         
         SPACE 2                                                                
LSTINVX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         EJECT                                                                  
LSTLST   NTR1                                                                   
         SPACE 2                                                                
         L     R6,INVTABN          FOR BCT                                      
         LTR   R6,R6                                                            
         BNP   LSTINVX                                                          
         L     R4,AINVTAB          START OF TABLE                               
         XC    X,X                                                              
         USING INVLD,R4                                                         
*                                  SET TO HOLD PRINT LINES                      
         OC    AMED,AMED                                                        
         BZ    LST11                                                            
         CLC   AMEDBRK,AINVBRK                                                  
         BH    LST12                                                            
         L     RF,AMED                                                          
         CLC   INVLMED,0(RF)                                                    
         BNE   LST30                                                            
*                                                                               
LST11    DS    0H                                                               
         CLC   APRDBRK,AINVBRK     TEST PROD SEP                                
         BH    LST12               NO                                           
         L     RF,APRD             YES - MUST BE RIGHT PROD                     
         CLC   INVLPRD,0(RF)                                                    
         BNE   LST30                                                            
         B     LST14                                                            
*                                                                               
LST12    DS    0H                                                               
         OC    APGR1BRK,APGR1BRK                                                
         BZ    LST14                                                            
         CLC   APGR1BRK,AINVBRK    TEST PGR SEP                                 
         BH    LST14               NO                                           
         L     RF,APGR1                                                         
         CLC   INVLPGR,0(RF)                                                    
         BNE   LST30                                                            
*                                                                               
*                                                                               
LST14    DS    0H                                                               
         CLC   AESTBRK,AINVBRK     TEST EST SEP                                 
         BH    LST14C              NO                                           
*                                                                               
         L     RF,AEST             YES - MUST BE RIGHT EST                      
         CLC   INVLEST,0(RF)                                                    
         BNE   LST30                                                            
*                                                                               
LST14C   DS    0H                                                               
         OC    AJOBBRK,AJOBBRK                                                  
         BZ    LST15                                                            
         CLC   AJOBBRK,AINVBRK     TEST JOB SEP                                 
         BH    LST15               NO                                           
*                                                                               
         CLI   WBSW,C'Y'        WB FLIGHT ACTIVE                                
         BE    LST15               YES - DON'T ATTEMPT TO MATCH                 
*                                                                               
         L     RF,AJOB             YES - MUST BE RIGHT JOB                      
         CLC   INVLJOB,3(RF)       SINCE AJOB STARTS WITH PRD                   
         BNE   LST30                                                            
*                                                                               
LST15    DS    0H                                                               
         OC    APUBBRK,APUBBRK                                                  
         BZ    LST16                                                            
         CLC   APUBBRK,AINVBRK     TEST PUB SEP                                 
         BH    LST16               NO                                           
         L     RF,APUB             YES - MUST BE RIGHT PUB                      
         CLC   INVLPUB,0(RF)                                                    
         BNE   LST30                                                            
*                                                                               
LST16    DS    0H                                                               
         OC    AMKTBRK,AMKTBRK                                                  
         BZ    LST18                                                            
         CLC   AMKTBRK,AINVBRK     TEST MKT SEP                                 
         BH    LST18               NO                                           
         L     RF,AMKT             YES - MUST BE RIGHT MKT                      
         CLC   INVLMKT,0(RF)                                                    
         BNE   LST30                                                            
*                                                                               
LST18    DS    0H                                                               
*                                                                               
         OC    AMGR1BRK,AMGR1BRK                                                
         BZ    LST19                                                            
         CLC   AMGR1BRK,AINVBRK    TEST MGR SEP                                 
         BH    LST19               NO                                           
         L     RF,AMGR1                                                         
         CLC   INVLMGR(3),0(RF)    CHKS REG                                     
         BNE   LST30                                                            
*                                                                               
LST19    DS    0H                                                               
*                                                                               
         OC    AMGR2BRK,AMGR2BRK                                                
         BZ    LST20                                                            
         CLC   AMGR2BRK,AINVBRK    TEST MGR SEP                                 
         BH    LST20               NO                                           
         L     RF,AMGR2                                                         
         CLC   INVLMGR+3(3),0(RF)  CHKS DST                                     
         BNE   LST30                                                            
*                                                                               
LST20    DS    0H                                                               
         CLC   APERBRK,AINVBRK     TEST PERIOD SEP                              
         BH    LST22               NO                                           
         L     RE,APER                                                          
         ZIC   RF,0(RE)                                                         
         MH    RF,=H'8'                                                         
         LA    RF,PERLIST(RF)                                                   
         CLC   INVLPER,0(RF)                                                    
         BNE   LST30                                                            
*                                                                               
LST22    DS    0H                                                               
         OC    APERGBRK,APERGBRK                                                
         BZ    LST23                                                            
         CLC   APERGBRK,AINVBRK     TEST PERIOD GROUP SEPARATE                  
         BH    LST23               NO                                           
         L     RF,APERG                                                         
         CLC   INVLPERG,0(RF)                                                   
         BNE   LST30                                                            
*                                                                               
LST23    DS    0H                                                               
         OC    ACRDBBRK,ACRDBBRK                                                
         BZ    LST24                                                            
         CLC   ACRDBBRK,AINVBRK     TEST CREDIT/DEBITS SEPARATE                 
         BH    LST24               NO                                           
         L     RF,ACRDB                                                         
         CLC   INVLCRDB,0(RF)                                                   
         BNE   LST30                                                            
*                                                                               
*                                  BILL HAS PASSED ALL TESTS                    
LST24    DS    0H                                                               
         MVC   DUB,INVLGRS                                                      
         LM    RE,RF,DUB                                                        
         A     RE,X                                                             
         A     RF,X+4                                                           
         STM   RE,RF,X                                                          
         MVC   DUB,INVLCD       ALSO DO CD AND AC                               
         LM    RE,RF,DUB                                                        
         A     RE,X+8                                                           
         A     RF,X+12                                                          
         STM   RE,RF,X+8                                                        
*                                                                               
         MVC   X+16(4),INVLDUE  DON'T TOTAL - AMOUNT IS INVOICE TOTAL           
*                                                                               
         OC    ACRDBBRK,ACRDBBRK                                                
         BZ    LST24C                                                           
         CLC   ACRDBBRK,AINVBRK     TEST CREDIT/DEBITS SEPARATE                 
         BH    LST24C              NO                                           
*                                                                               
*        CODE BELOW MAYBE WRONG BUT IN ANY CASE SHOULD                          
*        ONLY BE CHECKED IF THE 2 TESTS ABOVE ARE PASSED                        
*                                                                               
*        THE CODE BELOW IS CHECKING IF THE NEXT ENTRY IS FOR                    
*        THE SAME INVOICE # AND IF IT IS, SKIPS THE FIRST ONE                   
*        I CAN'T RECALL WHY THIS WAS CODED                                      
*        AND WHY THE BRANCH IS 'BE' INSTEAD FOR 'BNE' WHEN                      
*        IT CHECKS FOR THE SAME INDICATOR                                       
*                                                                               
         CLC   INVLINV,INVLINV+INVTABRL                                         
         BNE   LST24C                                                           
         CLC   INVLCRDB,INVLCRDB+INVTABRL  CREDIT/DEBIT IND MUST MATCH          
         BE    LST30                                                            
*                                                                               
LST24C   MVC   W(2),INVLINV        SET YR AND MTH IN W FOR GETNUM               
*                                                                               
         LA    R5,ALCOL1+3                                                      
         CLI   LSTOPT,C'A'         AMOUNT DUE OPTION                            
         BE    LST25                                                            
*                                                                               
         LA    R5,ALDESC+3                                                      
         CLI   DOLNUM,4                                                         
         BNL   LST25                                                            
         LA    R5,ALCOL1+3                                                      
         CLI   DOLNUM,3                                                         
         BE    LST25                                                            
         LA    R5,16(R5)                                                        
         CLI   DOLNUM,2                                                         
         BE    LST25                                                            
         LA    R5,16(R5)           MUST BE 1                                    
*                                                                               
LST25    DS    0H                                                               
         MVC   SVSVIMO,SVINVMO       SAVE 'REAL' INV MTH                        
*                                                                               
****     GOTOR GETNUM,DMCB,(1,INVLINV+2),(R5)     FORMAT INV NO                 
**       CAN'T USE GOTOR HERE - GENERATES ERROR                                 
         GOTO1 =A(GETNUM),DMCB,(1,INVLINV+2),(R5)     FORMAT INV NO             
*                                                                               
         MVC   SVINVMO,SVSVIMO       RESTORE 'REAL' INV MTH                     
*                                                                               
         CLI   LSTOPT,C'A'  SHOWING AMT DUE OF PREVIOUS BILLS                   
         BE    LST25C       - EDI NOT SUPPORTED                                 
*                                                                               
**EDI**                                                                         
*        MUST GO BEFORE I PRINT LINE                                            
         GOTO1 ABILLEDI,DMCB,('EDMLST',0(R5)),X+RGRSD,X+RNETD,X+RCDD            
**EDI**                                                                         
*                                                                               
LST25C   BAS   RE,LSTFMT                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
         LA    R1,5         ROLL VALUES IN X TO THE PACKED TOTALS               
         LA    RE,LSTGRSP                                                       
         LA    RF,X                                                             
LST25C5  L     R0,0(RF)                                                         
         CVD   R0,DUB                                                           
         AP    0(6,RE),DUB                                                      
         LA    RE,6(RE)                                                         
         LA    RF,4(RF)                                                         
         BCT   R1,LST25C5                                                       
         AP    LSTNUMP,=P'1'       A COUNT                                      
*                                  TOTAL                                        
****     L     RF,LSTGRS           GROSS                                        
****     A     RF,X                                                             
****     ST    RF,LSTGRS                                                        
****     L     RF,LSTNET           NET                                          
****     A     RF,X+4                                                           
****     ST    RF,LSTNET                                                        
****     L     RF,LSTCD            CD                                           
****     A     RF,X+8                                                           
****     ST    RF,LSTCD                                                         
****     L     RF,LSTAC            CD                                           
****     A     RF,X+12                                                          
****     ST    RF,LSTAC                                                         
****     L     RF,LSTDUE           AMT DUE (PREVIOUS BILLS)                     
****     A     RF,X+16                                                          
****     ST    RF,LSTDUE                                                        
****     L     RF,LSTNUM           COUNT                                        
****     LA    RF,1(RF)                                                         
****     ST    RF,LSTNUM                                                        
         XC    X,X                                                              
*                                                                               
LST30    DS    0H                                                               
         A     R4,INVPARS+12                                                    
         BCT   R6,LST11                                                         
*                                                                               
         CP    LSTNUMP,=P'0'                                                    
         BNE   LST30A                                                           
         OC    LSTNUM,LSTNUM                                                    
         BZ    LST32                                                            
*                                                                               
LST30A   MVC   ALCOL2+4(10),DASHES                                              
         CLI   LSTOPT,C'A'   SHOWING AMOUNT DUE OF PREV. BILLS                  
         BE    LST30C        NO TOTALS                                          
         MVC   ALCOL2+4(10),SPACES     RECLEAR                                  
*                                                                               
                                                                                
         MVC   ALCOL4+3(10),DASHES     FOR LAST COLUMN                          
         CLI   DOLNUM,1                                                         
         BE    LST30C                                                           
         MVC   ALCOL3+4(10),DASHES                                              
         CLI   DOLNUM,2                                                         
         BE    LST30C                                                           
         MVC   ALCOL2+4(10),DASHES                                              
         CLI   DOLNUM,3                                                         
         BE    LST30C                                                           
         MVC   ALCOL1+4(10),DASHES    MUST BE 4 OR MORE                         
LST30C   GOTO1 =A(PRNT)                                                         
         CLC   BORDSW(3),=C'YNN'   BYPASS TOTAL OF BILLS                        
         BE    LST32               IF ORDERED ONLY FORMAT                       
*******  MVC   X(20),LSTGRS         TOTAL OF BILLS                              
*******  BAS   RE,LSTFMT                                                        
         BAS   RE,LSTFMTP           PACKED TOTAL LINE ROUTINE                   
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
LST32    DS    0H                                                               
         B     LSTINVX                                                          
         SPACE 3                                                                
LSTFMT   NTR1                                                                   
         SPACE 2                                                                
*                                                                               
         CLI   LSTOPT,C'A'     SHOWING AMOUNT DUE OF PREV. BILLS                
         BNE   LSTFMT5                                                          
         LA    R6,ALCOL2           USE THIS $ COLUMN                            
         L     R0,X+16             AMOUNT DUE                                   
         BAS   RE,LSTEDT                                                        
         B     LSTFMTX                                                          
*                                                                               
LSTFMT5  DS    0H                                                               
         MVC   HFORMAT,FORMAT                                                   
         MVC   PBLGROSS(12),X      GROSS,NET,CD                                 
         L     R0,X                                                             
         S     R0,X+8                                                           
         ST    R0,PBLGLCD          GROSS LESS CD                                
         L     R0,X+4                                                           
         S     R0,X+8                                                           
         ST    R0,PBLNLCD          NET LESS CD                                  
         MVC   PBLACOM,X+12        AC                                           
         LA    R6,ALCOL1                                                        
         CLI   DOLNUM,4                                                         
         BNL   LSTF5               4 OR 5                                       
         LA    R6,ALCOL2                                                        
         CLI   DOLNUM,3                                                         
         BE    LSTF5                                                            
         LA    R6,ALCOL3                                                        
         CLI   DOLNUM,2                                                         
         BE    LSTF5                                                            
         LA    R6,ALCOL4           MUST BE 1                                    
LSTF5    ZIC   R4,DOLNUM                                                        
         CH    R4,=H'4'                                                         
         BNH   LSTF8                                                            
         LA    R4,4                CAN ONLY DO FIRST 4 $ CATS                   
LSTF8    BAS   RE,LGETCAT                                                       
         L     R0,FULL                                                          
         BAS   RE,LSTEDT                                                        
         LA    R6,16(R6)           NEXT COL                                     
         BCT   R4,LSTF8                                                         
         B     LSTFMTX                                                          
*                                                                               
LSTFMTX  DS    0H                                                               
         B     LSTINVX                                                          
*                                                                               
LSTFMTP  NTR1                                                                   
         SPACE 2                                                                
*                                                                               
         CLI   LSTOPT,C'A'     SHOWING AMOUNT DUE OF PREV. BILLS                
         BNE   LSTFMT5P                                                         
         LA    R6,ALCOL2           USE THIS $ COLUMN                            
         ZAP   WKDUB,LSTDUEP          AMOUNT DUE                                
         BAS   RE,LSTEDTP                                                       
         B     LSTFMTX                                                          
*                                                                               
LSTFMT5P DS    0H                                                               
         MVC   HFORMAT,FORMAT                                                   
         MVC   PBLGROSP(18),LSTGRSP GROSS,NET,CD                                
         ZAP   DUB,LSTGRSP                                                      
         SP    DUB,LSTCDP                                                       
         ZAP   PBLGLCDP,DUB     GROSS LESS CD                                   
         ZAP   DUB,LSTNETP                                                      
         SP    DUB,LSTCDP                                                       
         ZAP   PBLNLCDP,DUB     NET LESS CD                                     
         ZAP   PBLACOMP,LSTACP     AC                                           
         LA    R6,ALCOL1                                                        
         CLI   DOLNUM,4                                                         
         BNL   LSTF5P              4 OR 5                                       
         LA    R6,ALCOL2                                                        
         CLI   DOLNUM,3                                                         
         BE    LSTF5P                                                           
         LA    R6,ALCOL3                                                        
         CLI   DOLNUM,2                                                         
         BE    LSTF5P                                                           
         LA    R6,ALCOL4           MUST BE 1                                    
LSTF5P   ZIC   R4,DOLNUM                                                        
         CH    R4,=H'4'                                                         
         BNH   LSTF8P                                                           
         LA    R4,4                CAN ONLY DO FIRST 4 $ CATS                   
LSTF8P   BAS   RE,LGETCATP         RETURNS $ IN MYDUB                           
         BAS   RE,LSTEDTP                                                       
         LA    R6,16(R6)           NEXT COL                                     
         BCT   R4,LSTF8P                                                        
         B     LSTFMTX                                                          
*                                                                               
****     THE BELOW USED IN LSTFMT AND LSTFMTP                                   
*                                  PREVIOUSLY BILLED                            
PBLGROSS DS    F                   GROSS                                        
PBLNET   DS    F                   NET                                          
PBLCD    DS    F                   CD                                           
PBLGLCD  DS    F                   GROSS LESS CD                                
PBLNLCD  DS    F                   NET LESS CD                                  
PBLACOM  DS    F                   AGY COM                                      
*                                  PREVIOUSLY BILLED                            
PBLGROSP DS    PL6              BILLABLE                                        
PBLNETP  DS    PL6                                                              
PBLCDP   DS    PL6                                                              
PBLGLCDP DS    PL6                                                              
PBLNLCDP DS    PL6                                                              
PBLACOMP DS    PL6                                                              
****                                                                            
         SPACE 3                                                                
LSTEDT   DS    0H                                                               
         LA    R1,ALCOL4           SEE IF DOING LAST COLUMN                     
         CR    R6,R1                                                            
         BNE   LSTEDT5             CAN ONLY DO 15 CHARS.                        
         ST    RE,DUB                                                           
*--->    EDIT  (R0),(15,0(R6)),2,COMMAS=YES,CR=YES                              
         CURED (R0),(15,0(R6)),CURTAB,COMMAS=YES,CR=YES                         
         L     RE,DUB                                                           
         CLI   13(R6),C' '                                                      
         BNER  RE                                                               
*        CLI   NOSTAR,C'Y'         SUPPRESS ** ON TOTALS?                       
         TM    FLAG1,NOSTAR        SUPPRESS ** ON TOTALS?                       
         BO    *+10                                                             
         MVC   13(2,R6),TOTSTAR                                                 
         BR    RE                                                               
LSTEDT5  DS    0H                                                               
         ST    RE,DUB                                                           
*--->    EDIT  (R0),(16,0(R6)),2,COMMAS=YES,CR=YES                              
         CURED (R0),(16,0(R6)),CURTAB,COMMAS=YES,CR=YES                         
         L     RE,DUB                                                           
         CLI   14(R6),C' '                                                      
         BNER  RE                                                               
*        CLI   NOSTAR,C'Y'         SUPPRESS ** ON TOTALS?                       
         TM    FLAG1,NOSTAR        SUPPRESS ** ON TOTALS?                       
         BO    *+10                                                             
         MVC   14(2,R6),TOTSTAR                                                 
         BR    RE                                                               
         SPACE 3                                                                
*                                  PACKED TOTAL ROUTINE                         
LSTEDTP  DS    0H                                                               
         LA    R1,ALCOL4           SEE IF DOING LAST COLUMN                     
         CR    R6,R1                                                            
         BNE   LSTEDT5P            CAN ONLY DO 15 CHARS.                        
         ST    RE,DUB                                                           
*--->    EDIT  (R0),(15,0(R6)),2,COMMAS=YES,CR=YES                              
         CURED WKDUB,(15,0(R6)),CURTAB,COMMAS=YES,CR=YES                        
         L     RE,DUB                                                           
         CLI   13(R6),C' '                                                      
         BNER  RE                                                               
*        CLI   NOSTAR,C'Y'         SUPPRESS ** ON TOTALS?                       
         TM    FLAG1,NOSTAR        SUPPRESS ** ON TOTALS?                       
         BO    *+10                                                             
         MVC   13(2,R6),TOTSTAR                                                 
         BR    RE                                                               
LSTEDT5P DS    0H                                                               
         ST    RE,DUB                                                           
*--->    EDIT  (R0),(16,0(R6)),2,COMMAS=YES,CR=YES                              
         CURED WKDUB,(16,0(R6)),CURTAB,COMMAS=YES,CR=YES                        
         L     RE,DUB                                                           
         CLI   14(R6),C' '                                                      
         BNER  RE                                                               
*        CLI   NOSTAR,C'Y'         SUPPRESS ** ON TOTALS?                       
         TM    FLAG1,NOSTAR        SUPPRESS ** ON TOTALS?                       
         BO    *+10                                                             
         MVC   14(2,R6),TOTSTAR                                                 
         BR    RE                                                               
         SPACE 3                                                                
LGETCAT  NTR1                                                                   
         MVC   WORK(16),SPACES                                                  
         XC    FULL,FULL                                                        
         LA    R4,6                FOR BCT                                      
         LA    R5,HFORMAT                                                       
         LA    R6,PBLGROSS                                                      
         LA    R7,LCATNAM                                                       
LGETC3   CLI   0(R5),C'Y'          SEE IF DOING THIS CAT                        
         BE    LGETC5                                                           
         LA    R5,1(R5)                                                         
         LA    R6,4(R6)                                                         
         LA    R7,16(R7)                                                        
         BCT   R4,LGETC3                                                        
         B     LGETCX                                                           
*                                                                               
LGETC5   MVC   FULL,0(R6)            SAVE  DOLLARS                              
         MVI   0(R5),C'N'          SO I WON'T REDO THIS CAT                     
         MVC   WORK(16),0(R7)                                                   
LGETCX   XIT1                                                                   
*                                                                               
         SPACE 3                                                                
LGETCATP NTR1                                                                   
         MVC   WORK(16),SPACES                                                  
         ZAP   WKDUB,=P'0'                                                      
         LA    R4,6                FOR BCT                                      
         LA    R5,HFORMAT                                                       
         LA    R6,PBLGROSP         PACKED TOTALS                                
         LA    R7,LCATNAM                                                       
LGETC3P  CLI   0(R5),C'Y'          SEE IF DOING THIS CAT                        
         BE    LGETC5P                                                          
         LA    R5,1(R5)                                                         
         LA    R6,6(R6)                                                         
         LA    R7,16(R7)                                                        
         BCT   R4,LGETC3P                                                       
         B     LGETCXP                                                          
*                                                                               
LGETC5P  ZAP   WKDUB,0(6,R6)            SAVE  DOLLARS                           
         MVI   0(R5),C'N'          SO I WON'T REDO THIS CAT                     
         MVC   WORK(16),0(R7)                                                   
LGETCXP  XIT1                                                                   
*                                                                               
LCATNAM  DC    CL16'           GROSS'                                           
LCATNET  DC    CL16'             NET'                                           
LCATCD   DC    CL16'      CASH DISC.'                                           
LCATGLCD DC    CL16'   GROSS LESS CD'                                           
LCATNLCD DC    CL16'     NET LESS CD'                                           
LCATAC   DC    CL16'    AGENCY COMM.'                                           
**                                                                              
         DS    0F                                                               
LSTTOTSP DS    0XL30                                                            
LSTGRSP  DS    PL6                                                              
LSTNETP  DS    PL6                                                              
LSTCDP   DS    PL6                                                              
LSTACP   DS    PL6                                                              
LSTDUEP  DS    PL6                                                              
LSTNUMP  DS    PL6                                                              
**                                                                              
LSTTOTS  DS    0XL24                                                            
LSTGRS   DS    F                                                                
LSTNET   DS    F                                                                
LSTCD    DS    F                                                                
LSTAC    DS    F                                                                
LSTDUE   DS    F                                                                
LSTNUM   DS    F                                                                
*                                                                               
WKDUB    DS    PL6                                                              
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
         TITLE 'FIND AND PRINT COMMENTS'                                        
PRTCMNT  NMOD1 0,PRTCMNT                                                        
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         XC    SAVKEY,SAVKEY                                                    
*                                                                               
*                                                                               
         LA    R3,ESTFORM                                                       
         USING PBPROFD,R3                                                       
         OC    0(L'ESTFORM,R3),0(R3)                                            
         BNZ   PRTC0B                                                           
         LA    R3,PRDFORM       SHOW PRD COMMENTS IF NO EST COMMENTS            
         OC    0(L'ESTFORM,R3),0(R3)                                            
         BNZ   PRTC0B                                                           
         LA    R3,AAEFORM                                                       
         OC    0(L'ESTFORM,R3),0(R3)                                            
         BNZ   PRTC0B                                                           
         LA    R3,AAAFORM                                                       
PRTC0B   JIF   ESTCTL,EQ,C'S',AND,PRDCTL,EQ,C'S',PRTC1,JUMP=N                   
         LA    R3,AAEFORM                                                       
         OC    0(L'ESTFORM,R3),0(R3)                                            
         BNZ   PRTC0C                                                           
         LA    R3,AAAFORM  SHOW PRD AAA COMMENTS IF NO EST COMMENTS             
PRTC0C   JIF   ESTCTL,EQ,C'S',AND,PRDCTL,NE,C'S',PRTC1,JUMP=N                   
         LA    R3,PRDFORM                                                       
         OC    0(L'ESTFORM,R3),0(R3)                                            
         BNZ   PRTC0D                                                           
         LA    R3,AAAFORM                                                       
PRTC0D   JIF   ESTCTL,NE,C'S',AND,PRDCTL,EQ,C'S',PRTC1,JUMP=N                   
         LA    R3,AAAFORM                                                       
         JIF   ESTCTL,NE,C'S',AND,PRDCTL,NE,C'S',PRTC1,JUMP=N                   
*                                                                               
*                                                                               
PRTC1    LA    R4,BILCMNTS                                                      
         LA    R5,3                                                             
PRTC2    DS    0H                                                               
         LA    RF,X'80'                                                         
         CLI   CNMTCD,C'R'         REG                                          
         BE    PRTC3                                                            
         LA    RF,X'40'                                                         
         CLI   CNMTCD,C'C'         CD INV                                       
         BE    PRTC3                                                            
         LA    RF,X'20'            MUST BE ADJ INV                              
PRTC3    DS    0H                                                               
         EX    RF,PRTCTM                                                        
         BZ    PRTC13                                                           
*                                                                               
*        NOW CHECK VS. BILLING TYPE                                             
         LA    RF,X'01'                                                         
         CLI   TYPE,C'4'                                                        
         BE    PTC5                                                             
         LA    RF,X'02'                                                         
         CLI   TYPE,C'5'                                                        
         BE    PTC5                                                             
         LA    RF,X'04'                                                         
         CLI   TYPE,C'6'                                                        
         BE    PTC5                                                             
         LA    RF,X'08'                                                         
         CLI   TYPE,C'7'                                                        
         BE    PTC5                                                             
         DC    H'0'              INVALID BILLING TYPE                           
*                                                                               
PTC5     DS    0H                                                               
         EX    RF,PRTCTM                                                        
         BNZ   PRTC13           SUPPRESS FROM THIS BILLING TYPE                 
*                                                                               
*                                                                               
*                                                                               
*        CHECK RETAIL PROFILE                                                   
*                                                                               
         CLI   RETPROF,0                                                        
         BE    PRTC3C                                                           
         CLI   UPASS,1              SEE CORP BILL                               
         BE    PRTC3C                                                           
         CLI   UPASS,X'FF'          CHK FOR CORP SUMMARY - WAS C'S'             
         BE    PRTC3C                                                           
*                                   MUST BE DISTRIBUTOR BILL                    
*                                                                               
         CLI   RETPROF+10,C'X'      SEE IF SUPPRESSING ALL COMMENTS             
         BE    PRTC13                                                           
*                                                                               
         CH    R5,=H'3'             SEE IF DOING FRIST COMMENT                  
         BNE   PRTC3A                                                           
         CLI   RETPROF+10,C'1'      SEE IF SUPPRESSING 1ST COMMENT              
         BE    PRTC13                                                           
         CLI   RETPROF+10,C'A'      SEE IF SUPPRESSING 1ST + 2ND                
         BE    PRTC13                                                           
         CLI   RETPROF+10,C'B'      SEE IF SUPPRESSING 1ST + 3RD                
         BE    PRTC13                                                           
         B     PRTC3C                                                           
*                                                                               
PRTC3A   CH    R5,=H'2'             SEE IF DOING 2ND COMMENT                    
         BNE   PRTC3B                                                           
         CLI   RETPROF+10,C'2'      SEE IF SUPPRESSING 2ND COMMENT              
         BE    PRTC13                                                           
         CLI   RETPROF+10,C'A'      SEE IF SUPPRESSING 1ST + 2ND                
         BE    PRTC13                                                           
         CLI   RETPROF+10,C'C'      SEE IF SUPPRESSING 2ND + 3RD                
         BE    PRTC13                                                           
         B     PRTC3C                                                           
*                                                                               
PRTC3B   CH    R5,=H'1'             SEE IF DOING 3RD COMMENT                    
         BNE   PRTC3C                                                           
         CLI   RETPROF+10,C'3'      SEE IF SUPPRESSING 3RD COMMENT              
         BE    PRTC13                                                           
         CLI   RETPROF+10,C'B'      SEE IF SUPPRESSING 1ST + 3RD                
         BE    PRTC13                                                           
         CLI   RETPROF+10,C'C'      SEE IF SUPPRESSING 2ND + 3RD                
         BE    PRTC13                                                           
*                                                                               
PRTC3C   MVC   WORK,KEY                                                         
         XC    KEY,KEY                                                          
         MVC   KEY(3),RCSVAGY                                                   
         OC    AMED,AMED    FOR MULTI-MEDIA REQ GET MEDIA FROM AMED             
         BZ    PRTC3D                                                           
         L     RF,AMED                                                          
         MVC   KEY+2(1),0(RF)                                                   
*                                                                               
PRTC3D   MVI   KEY+3,X'40'                                                      
         MVC   KEY+4(6),1(R4)                                                   
         L     RF,ACOMREC                                                       
         CLC   KEY(25),0(RF)                                                    
         BE    PRTC4               ALREADY HAVE                                 
         OC    SAVKEY,SAVKEY                                                    
         BNZ   *+10                                                             
         MVC   SAVKEY,WORK                                                      
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(25),KEYSAVE                                                  
         BNE   PRTC13                                                           
*                                                                               
         MVC   AREC,ACOMREC                                                     
         GOTO1 GETPRT                                                           
*                                                                               
PRTC4    DS    0H                                                               
*                                                                               
         GOTO1 ABILLEDI,DMCB,('EDMCOM',0)      EDI CALL                         
*                                                                               
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
*                                  COUNT LINES NEEDED                           
         SR    RF,RF                                                            
         L     R2,ACOMREC                                                       
         LA    R2,33(R2)                                                        
         SR    R0,R0                                                            
PRTC6    DS    0H                                                               
         CLI   0(R2),0                                                          
         BE    PRTC9                                                            
         CLI   0(R2),X'40'                                                      
         BNE   PRTC8                                                            
         LA    R0,1                                                             
         CLI   2(R2),C'+'                                                       
         BNE   PRTC7                                                            
         CLI   3(R2),C'1'                                                       
         BL    PRTC7                                                            
         MVC   BYTE,3(R2)                                                       
         NI    BYTE,X'0F'                                                       
         IC    R0,BYTE                                                          
PRTC7    DS    0H                                                               
         AR    RF,R0                                                            
PRTC8    DS    0H                                                               
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     PRTC6                                                            
*                                                                               
PRTC9    DS    0H                                                               
         LA    RF,1(RF)                                                         
         STC   RF,ALLOWLIN         NUMBER OF LINES NEEDED                       
         L     R2,ACOMREC                                                       
         LA    R2,33(R2)                                                        
PRTC10   DS    0H                                                               
         CLI   0(R2),0                                                          
         BE    PRTC13                                                           
         CLI   0(R2),X'40'                                                      
         BNE   PRTC12                                                           
         LA    R6,2                                                             
         CLI   2(R2),C'+'                                                       
         BNE   PRTC11                                                           
         CLI   3(R2),C'1'                                                       
         BL    PRTC11                                                           
         MVC   SPACING,3(R2)                                                    
         NI    SPACING,X'0F'                                                    
         GOTO1 =A(PRNT)                                                         
*                                                                               
         LA    R6,4                                                             
PRTC11   DS    0H                                                               
         IC    RF,1(R2)                                                         
         SR    RF,R6                                                            
         AR    R6,R2                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   P1+8(0),0(R6)                                                    
         CLI   P1+8,X'00'    POSSIBLE FOR EMPTY LINES                           
         BNE   PRTC11X                                                          
         MVI   P1+8,C' '     CHANGE TO SPACE                                    
         MVI   P1,0          SO IT WILL PRINT                                   
*                                                                               
PRTC11X  DS    0H                                                               
*                                                                               
         GOTO1 =A(PRNT)                                                         
*                                                                               
PRTC12   DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     PRTC10                                                           
*                                                                               
PRTC13   DS    0H                                                               
         LA    R4,7(R4)                                                         
         BCT   5,PRTC2                                                          
*                                                                               
*                                                                               
         OC    SAVKEY,SAVKEY                                                    
         BZ    PRTC20                                                           
         MVC   KEY,SAVKEY                                                       
         GOTO1 HIGH                                                             
*                                                                               
PRTC20   DS    0H                                                               
PRTCX    DS    0H                                                               
         MVI   PUMODE,C'E'       CHECK FOR USER FIELDS TO BE PRINTED            
*                                AT END OF INVOICE                              
         BRAS  RE,PRTUSER                                                       
*                                                                               
         CLI   WPPOPT,C'Y'        WPP AGENCY?                                   
         BNE   PRTCXX                                                           
*                                                                               
         BRAS  RE,PRTWCOM         PRINT WPP AGENCY COMMENT                      
*                                                                               
PRTCXX   DS    0H                                                               
         XIT1                                                                   
*                                                                               
SAVKEY   DS    CL32                                                             
*                                                                               
PRTCTM   TM    0(R4),X'00'     EXECUTED                                         
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
PRTWCOM  NMOD1 0,PRTWCOM                                                        
         LA    RC,SPACEND                                                       
         MVC   P1,SPACES                                                        
         GOTO1 =A(PRNT)       SKIP BEFORE                                       
***      MVC   P1+2(88),=C'THIS COMPANY IS PART OF THE WPP GROUP OF COM         
***            PANIES AND ADHERES TO WPP ETHICAL STANDARDS,'                    
***      MVC   P2+2(91),=C'WHICH CAN BE FOUND IN THE WPP CORPORATE SOCI         
***            AL RESPONSIBILITY REPORT ON THE WPP.COM WEBSITE'                 
         MVC   P1+8(62),=C'THIS COMPANY IS PART OF THE WPP GROUP OF COMX        
               PANIES AND ADHERES'                                              
         MVC   P2+8(55),=C'TO WPP ETHICAL STANDARDS, WHICH CAN BE FOUNDX        
                IN THE WPP'                                                     
         MVC   P3+8(61),=C'CORPORATE SOCIAL RESPONSIBILITY REPORT ON THX        
               E WPP.COM WEBSITE'                                               
         GOTO1 =A(PRNT)                                                         
*                                                                               
PRTACX   XIT1                                                                   
**                                                                              
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
PRTUSER  NMOD1 0,PRTUSER                                                        
         LA    RC,SPACEND                                                       
         MVI   HAVUSER,C'N'      GETS SET TO 'Y' IF I PRINT ONE                 
*                                                                               
         CLI   WMSW,C'Y'         WALMART PROCESSING                             
         BE    PRTUX             SKIP  - SPECIAL CODE DISPLAYS USERS            
*                                                                               
*                                                                               
         CLI   FOXSW,C'Y'        FOX PROCESSING                                 
         BE    PRTUX             SKIP  - SPECIAL CODE DISPLAYS USERS            
*                                                                               
         CLI   PUSRSW,C'Y'       PRD USER CONTROL                               
         BE    PRTUX             SKIP  - SPECIAL CODE DISPLAYS USERS            
*                                                                               
         CLI   EPUDEF,C'Y'       PRD & EST UDEFS IN BODY NXT TO NAME            
         BE    PRTUX             SKIP  - SPECIAL CODE DISPLAYS USERS            
**                                                                              
**       CLI   EPUDEF,C'P'       PRD UDEFS IN BODY NXT TO NAME                  
**       BE    PRTEX             SKIP TO ESTIMATE                               
*                                                                               
*                                SHOULD I DO THE SAME FOR PGSW?                 
*                                                                               
******   CLI   OUWBSW,C'Y'       FOR THIS CONTROL SKIP PRD USERS                
******   BE    PRTEX             SKIP TO ESTIMATE USER LOGIC                    
*                                                                               
         MVI   BYTE,0                                                           
         CLI   PRDCTL,C'S'       SEE IF PRODUCTS SEPARATE                       
         BE    PU0               NO THEN TRY FOR "AAA" USER FIELDS              
         GOTO1 =A(PRTAAAU)                                                      
         B     PRTUX                                                            
*                                                                               
PU0      L     R2,ADPRD                                                         
         LA    R2,33(R2)    TO FIRST ELEMENT                                    
         MVI   ELCODE,X'08'   LOOK FOR USER DATA                                
         BRAS  RE,UNEXTEL                                                       
         BNE   PRTEX        CAN SKIP PRD GETUER CALLS - GO TO ESTS.             
         USING PPRDUDEF,R2                                                      
         MVC   X+60(32),PUSER1 SAVE REAL PUSER1                                 
         MVC   X+60+32(16),PUSER2 AND PUSER2                                    
*                                                                               
*        STRIP-OFF #R# AND #F# PREFIXES HERE                                    
*                                                                               
         CLC   PUSER1(3),=C'#R#'      ONLY ON NON-ADJ INV?                      
         BE    PU1                                                              
         CLC   PUSER1(3),=C'#F#'      ONLY ON NON-ADJ INV?                      
         BNE   PU1B                                                             
PU1      MVC   WORK(32),PUSER1                                                  
         MVC   PUSER1(29),WORK+3                                                
         MVC   PUSER1+29(3),SPACES                                              
*                                                                               
PU1B     DS    0H                                                               
         CLC   PUSER2(3),=C'#R#'      ONLY ON NON-ADJ INV?                      
         BE    PU1C                                                             
         CLC   PUSER2(3),=C'#F#'      ONLY ON NON-ADJ INV?                      
         BNE   PU1D                                                             
PU1C     MVC   WORK(16),PUSER2                                                  
         MVC   PUSER2(13),WORK+3                                                
         MVC   PUSER2+13(3),SPACES                                              
*                                                                               
PU1D     DS    0H                                                               
         CLI   ADJSEP,C'Y'         DOING SEP ADJINV?                            
         BNE   PU2X                   PRINT BOTH UDEFS                          
*                                                                               
         CLC   X+60(3),=C'#R#'        ONLY ON NON-ADJ INV?                      
         BNE   PU2                                                              
         CLI   DUESW,C'A'         IS THE AN ADJ SEP INV?                        
         BE    PRTPU5             SKIP THE FIRST EST USER                       
         B     PU2X                                                             
*                                                                               
PU2      CLC   X+60(3),=C'#F#' ONLY ON ADJ SEP BILL?                            
         BNE   PU2X                                                             
         CLI   DUESW,C'A'         IS THE AN ADJ SEP INV?                        
         BNE   PRTPU5             SKIP THE FIRST EST USER                       
         B     PU2X                                                             
*                                                                               
PU2X     DS    0H                                                               
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'P',ADPRD),(C':',P1+8),0         
*                                                                               
         TM    DMCB+4,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    PRTPU5                                                           
*                                                                               
         TM    DMCB+4,X'04'       SEE IF IN HEADLINES                           
         BO    PRTPU5                                                           
*                                                                               
         CLI   PUMODE,C'F'         FRONT OF BILL?                               
         BNE   PU4D                                                             
         TM    DMCB+4,X'02'                                                     
         BZ    PRTPU5                                                           
         B     PU4F                                                             
*                                                                               
PU4D     DS    0H                  NOT DOING FRONT NOW                          
         TM    DMCB+4,X'02'                                                     
         BO    PRTPU5                                                           
*                                                                               
PU4F     DS    0H                                                               
         MVI   HAVUSER,C'Y'                                                     
         MVC   W(132),P1     SAVE P1                                            
         MVC   P1,SPACES                                                        
         GOTO1 =A(PRNT)       SKIP BEFORE                                       
         MVC   P1,W           RESTORE P1                                        
         GOTO1 =A(PRNT)                                                         
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'P1')   EDI CALL                       
**EDI**                                                                         
         MVI   BYTE,1          SO I WON'T SKIP AGAIN                            
*                                                                               
PRTPU5   DS    0H                                                               
*                                                                               
         CLI   ADJSEP,C'Y'         DOING SEP ADJINV?                            
         BNE   PU3X                PRINT BOTH UDEFS                             
*                                                                               
         CLC   X+60+32(3),=C'#R#' ONLY ON NON-ADJ INV?                          
         BNE   PU3                                                              
         CLI   DUESW,C'A'         IS THE AN ADJ SEP INV?                        
         BE    PRTE               SKIP THIS PRD USER                            
         B     PU3X                                                             
*                                                                               
PU3      CLC   X+60+32(3),=C'#F#' ONLY ON ADJ SEP BILL?                         
         BNE   PU3X                                                             
         CLI   DUESW,C'A'         IS THE AN ADJ SEP INV?                        
         BNE   PRTE               SKIP THIS PRD USER                            
         B     PU3X                                                             
*                                                                               
PU3X     DS    0H                                                               
         MVC   P1,SPACES                                                        
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'P',ADPRD),0,(C':',P1+8)         
*                                                                               
         TM    DMCB+6,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    PRTE                                                             
*                                                                               
         TM    DMCB+6,X'04'       SEE IF IN HEADLINES                           
         BO    PRTE                                                             
*                                                                               
         CLI   PUMODE,C'F'         FRONT OF BILL?                               
         BNE   PU5D                                                             
         TM    DMCB+6,X'02'                                                     
         BZ    PRTE                (BUG WHEN TO PRTPU8)                         
         B     PU5F                                                             
*                                                                               
PU5D     DS    0H                  NOT DOING FRONT NOW                          
         TM    DMCB+6,X'02'                                                     
         BO    PRTE                                                             
*                                                                               
PU5F     DS    0H                                                               
         MVI   HAVUSER,C'Y'                                                     
         MVC   W(132),P1      SAVE P1 IN W HERE FOR EDI CALL                    
         CLI   BYTE,1                                                           
         BE    PRTPU8                                                           
         MVC   P1,SPACES                                                        
         GOTO1 =A(PRNT)       SKIP BEFORE                                       
         MVC   P1,W           RESTORE P1                                        
PRTPU8   GOTO1 =A(PRNT)                                                         
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'P2')   EDI CALL                       
**EDI**                                                                         
*                                                                               
PRTE     DS    0H                                                               
         MVC   PUSER1,X+60        RESTORE REAL PRD USER1                        
         MVC   PUSER2,X+60+32 RESTORE REAL PRD USER 2                           
*                                                                               
PRTEX    DS    0H                                                               
         DROP  R2                                                               
*                                                                               
         CLI   EPUDEF,C'E'       EST UDEFS IN BODY NXT TO NAME                  
         BE    PRTEU10X          SKIP                                           
*                                                                               
         MVI   BYTE,0                                                           
         MVC   P1,SPACES                                                        
         CLI   ESTCTL,C'S'       SEE IF ESTIMATES SEPARATE                      
         BNE   PRTEU10X                                                         
*                                                                               
         L     R2,ADEST                                                         
         LA    R2,33(R2)    TO FIRST ELEMENT                                    
         MVI   ELCODE,X'08'   LOOK FOR USER DATA                                
         BRAS  RE,UNEXTEL                                                       
         BNE   PRTEU10      CAN SKIP EST GETUSER CALLS                          
         USING PESTUDEF,R2                                                      
         MVC   X+60(32),PEUSER1 SAVE REAL PEUSER1                               
         MVC   X+60+32(16),PEUSER2 AND PEUSER2                                  
*                                                                               
*        STRIP-OFF #R# AND #F# PREFIXES HERE                                    
*                                                                               
         CLC   PEUSER1(3),=C'#R#'     ONLY ON NON-ADJ INV?                      
         BE    PRTE5                                                            
         CLC   PEUSER1(3),=C'#F#'     ONLY ON NON-ADJ INV?                      
         BNE   PRTE6                                                            
PRTE5    MVC   WORK(32),PEUSER1                                                 
         MVC   PEUSER1(29),WORK+3                                               
         MVC   PEUSER1+29(3),SPACES                                             
*                                                                               
PRTE6    DS    0H                                                               
         CLC   PEUSER2(3),=C'#R#'     ONLY ON NON-ADJ INV?                      
         BE    PRTE7                                                            
         CLC   PEUSER2(3),=C'#F#'     ONLY ON NON-ADJ INV?                      
         BNE   PRTE8                                                            
PRTE7    MVC   WORK(16),PEUSER2                                                 
         MVC   PEUSER2(13),WORK+3                                               
         MVC   PEUSER2+13(3),SPACES                                             
*                                                                               
PRTE8    DS    0H                                                               
*                                                                               
         CLI   ADJSEP,C'Y'         NOT DOING ADJ SEP BILL?                      
         BNE   PU6X                                                             
*                                                                               
         CLC   X+60(3),=C'#R#' ONLY ON NON-ADJ INV?                             
         BNE   PU6                                                              
         CLI   DUESW,C'A'         IS THE AN ADJ SEP INV?                        
         BE    PRTEU5             SKIP THE FIRST EST USER                       
         B     PU6X                                                             
*                                                                               
PU6      CLC   X+60(3),=C'#F#' ONLY ON ADJ SEP BILL?                            
         BNE   PU6X                                                             
         CLI   DUESW,C'A'         IS THE AN ADJ SEP INV?                        
         BNE   PRTEU5             SKIP THE FIRST EST USER                       
         B     PU6X                                                             
*                                                                               
PU6X     DS    0H                                                               
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'E',ADEST),(C':',P1+8),0         
*                                                                               
         TM    DMCB+4,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    PRTEU5                                                           
*                                                                               
         TM    DMCB+4,X'04'       SEE IF IN HEADLINES                           
         BO    PRTEU5                                                           
*                                                                               
         CLI   PUMODE,C'F'         FRONT OF BILL?                               
         BNE   PUE4D                                                            
         TM    DMCB+4,X'02'                                                     
         BZ    PRTEU5                                                           
         B     PUE4F                                                            
*                                                                               
PUE4D    DS    0H                  NOT DOING FRONT NOW                          
         TM    DMCB+4,X'02'                                                     
         BO    PRTEU5                                                           
*                                                                               
PUE4F    DS    0H                                                               
         MVI   HAVUSER,C'Y'                                                     
         MVC   W(132),P1      SAVE P1                                           
         MVC   P1,SPACES                                                        
         MVI   P1,0           BE SURE IT PRINTS                                 
         GOTO1 =A(PRNT)       SKIP BEFORE                                       
         MVC   P1,W           RESTORE P1                                        
         GOTO1 =A(PRNT)                                                         
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'E1')    EDI CALL                      
**EDI**                                                                         
         MVI   BYTE,1          SO I WON'T SKIP AGAIN                            
*                                                                               
PRTEU5   DS    0H                                                               
*                                                                               
         CLI   ADJSEP,C'Y'     SEE IF DOINF ADJ SEP BILL?                       
         BNE   PU7X                                                             
*                                                                               
         CLC   X+60+32(3),=C'#R#' ONLY ON NON-ADJ INV?                          
         BNE   PU7                                                              
         CLI   DUESW,C'A'         IS THE AN ADJ SEP INV?                        
         BE    PRTEU10            SKIP THE FIRST EST USER                       
         B     PU7X                                                             
*                                                                               
PU7      CLC   X+60+32(3),=C'#F#' ONLY ON ADJ SEP BILL?                         
         BNE   PU7X                                                             
         CLI   DUESW,C'A'         IS THE AN ADJ SEP INV?                        
         BNE   PRTEU10            SKIP THE FIRST EST USER                       
         B     PU7X                                                             
*                                                                               
PU7X     DS    0H                                                               
         MVC   P1,SPACES                                                        
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'E',ADEST),0,(C':',P1+8)         
*                                                                               
*                                                                               
         TM    DMCB+6,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    PRTEU10                                                          
*                                                                               
         TM    DMCB+6,X'04'       SEE IF IN HEADLINES                           
         BO    PRTEU10                                                          
*                                                                               
         CLI   PUMODE,C'F'         FRONT OF BILL?                               
         BNE   PUE5D                                                            
         TM    DMCB+6,X'02'                                                     
         BZ    PRTEU10                                                          
         B     PUE5F                                                            
*                                                                               
PUE5D    DS    0H                  NOT DOING FRONT NOW                          
         TM    DMCB+6,X'02'                                                     
         BO    PRTEU10                                                          
*                                                                               
PUE5F    DS    0H                                                               
         MVI   HAVUSER,C'Y'                                                     
         MVC   W(132),P1      SAVE P1 IN W HERE (FOR EDI CALL)                  
         CLI   BYTE,1         SEE IF I PRINTED E1                               
         BE    PRTEU8         IF SO - NO NEED TO SKIP                           
         MVC   P1,SPACES                                                        
         MVI   P1,0           BE SURE IT PRINTS                                 
         GOTO1 =A(PRNT)       SKIP BEFORE                                       
         MVC   P1,W           RESTORE P1                                        
PRTEU8   GOTO1 =A(PRNT)                                                         
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'E2')   EDI CALL                       
**EDI**                                                                         
*                                                                               
PRTEU10  DS    0H                                                               
         MVC   PEUSER1,X+60       MUST RESTORE REAL EST USER1                   
         MVC   PEUSER2,X+60+32 RESTORE EST REAL USER 2                          
*                                                                               
         DROP  R2                                                               
*                                                                               
PRTEU10X MVC   P1,SPACES         IN CASE SOMETHING IS LEFT THERE                
         CLI   HAVUSER,C'Y'      SEE IF I PRINTED ONE                           
         BNE   PRTUX                                                            
         CLI   PUMODE,C'F'       ONLY NEEDED FOR FRONT PRINTING                 
         BNE   PRTUX                                                            
         MVI   P1,0              TO BE SURE IT PRINTS                           
         GOTO1 =A(PRNT)          SKIP A LINE AFTER LAST                         
         B     PRTUX                                                            
*                                                                               
PRTUX    DS    0H            NOW CHECK FOR UCOMM RECORDS                        
         CLI   PUMODE,C'E'   MUST BE END OF INVOICE                             
         BNE   PRTUXX        (FOR NOW)                                          
         MVC   USAVKEY,KEY   SAVE MY KEY                                        
         LA    R6,UCOMBLK     SET-UP UCOM CONTROL BLOCK                         
         XC    UCOMBLK(L'UCOMBLK),UCOMBLK                                       
         USING DDUCOMD,R6                                                       
*                                                                               
         MVC   UCACOMF,VCOMFACS     COMFACS                                     
         MVI   UCSYS,C'P'        SYSTEM TO PRINT                                
         MVC   UCAGY,QAGENCY                                                    
         MVC   UCMED,QMEDIA                                                     
         OC    AMED,AMED                                                        
         BZ    PRTUX5                                                           
         L     RF,AMED           MUST CHECK AMED FOR MEDIA                      
         MVC   UCMED,0(RF)                                                      
*                                                                               
PRTUX5   DS    0H                                                               
         L     RF,ADCLT                                                         
         MVC   UCCLT,4(RF)                                                      
         L     RF,APRD                                                          
         MVC   UCPRD,0(RF)          3 CHAR PRD CODE                             
*                                                                               
         CLI   PRDCTL,C'S'                                                      
         BE    *+10                                                             
         MVC   UCPRD,=C'AAA'     IF PRODUCTS NOT SEPARATE                       
*                                DO UCOMM FOR PRD AAA                           
         CLI   ATTSW,C'Y'        SEE IF DOING AT&T BILLING                      
         BE    *+8               IS SO, CAN'T DO PRODUCT UCOMMS                 
         OI    UCOPT,UCOPRD      RETURN PRODUCT UCOMMS                          
*                                                                               
         CLI   ESTCTL,C'S'       EST ON SEPARATE INVOICES                       
         BNE   PRTUX5X                                                          
         OI    UCOPT,UCOEST      RETURN ESTIMATE UCOMMS                         
         L     RF,AEST                                                          
         MVC   UCEST,0(RF)                                                      
*                                                                               
         CLI   ATTSW,C'Y'        SEE IF DOING AT&T BILLING                      
         BNE   *+8               IS SO, CAN'T DO PRODUCT UCOMMS                 
         OI    UCOPT,UCO8EST     RETURN OVER 4 IN PRD UCOMMS                    
*                                                                               
PRTUX5X  ICM   RF,15,APGR1         POINTER TO DIVISION DATA                     
         BZ    PRTUX6              IF 0 --> NO DATA, DON'T LOOK FURTHER         
         ICM   R1,15,AMGR1         POINTER TO REGION DATA                       
         BZ    PRTUX6              IF 0 --> NO DATA, DON'T LOOK FURTHER         
         MVC   UCDIV,0(RF)                                                      
         CLI   MGR1CTL,C'S'        REGIONS ON SEP INVOICES                      
         BNE   *+14                                                             
         MVC   UCREG,0(R1)         RETURN REGION UCOMS                          
         OI    UCOPT,UCOREG                                                     
         ICM   R1,15,AMGR2         POINTER TO DISTRICT DATA                     
         BZ    PRTUX6              IF 0 --> NO DATA, DON'T LOOK FURTHER         
         MVC   UCDST,0(R1)         RETURN DISTRICT UCOMS                        
         OI    UCOPT,UCODST                                                     
*                                                                               
PRTUX6   DS    0H                                                               
         GOTO1 =V(DDUCOM),UCOMBLK                                               
         CLI   UCERROR,0                                                        
         BNE   PRTUXX       ERROR RETURN - JUST EXIT DON'T DIE                  
         TM    UCDATA,UCDNOPRD+UCDNOEST+UCDNOREG+UCDNODST                       
         BO    PRTUXX       NO PRD NOR EST NOR REGION NOR DISTRICT DATA         
*                                                                               
         MVC   P1,SPACES                                                        
         MVI   P1,0           TO INSURE PRINTING                                
         LA    R2,P2+8        START AT SECOND PRINT LINE                        
         TM    UCDATA,UCDNOPRD                                                  
         BO    PRTUX10                                                          
*                                                                               
         CLI   ATTSW,C'Y'     CAN'T REPORT PRODUCT UCOMMS                       
         BE    PRTUX10                                                          
*                                                                               
         XC    UCTTLS(UCALL),UCTTLS                                             
         L     R4,UCPTTLS     PRD TITLES                                        
         MVC   UCTTLS,0(R4)        SAVE INFO IN MY STORAGE                      
         LA    R4,UCTTLS           AS OPPOSED TO RD CHANE                       
         L     R7,UCPDATA     PRD DATA                                          
         MVC   UCOMDATA,0(R7)                                                   
         LA    R7,UCOMDATA                                                      
         LA    R1,UCPLENS      DATA FIELD LENGTHS                               
*                                                                               
         LA    R5,4             FOR BCT                                         
         LHI   RF,1             FOR EDI,LINE COUNTER                            
PRTUX6B  DS    0H                                                               
         CLI   0(R1),0          CHECK DATA LENGTH                               
         BE    PRTUX6X                                                          
*                                                                               
*        MUST CHECK WHAT TYPE OF INVOICE I'M DOING                              
*        AS PRD UCOMMS THAT BEGIN WITH #R# ARE ONLY TO APPEAR                   
*        ON THE MAIN BILL AND ONES THAT BEGIN WITH #F#                          
*        ARE ONLY TO APPEAR ON COM ADJ BILLS (DUESW=A)                          
*        THE #R# AND #F# SHOULD NOT APPEAR ON THE BILL                          
*                                                                               
         CLC   0(3,R7),=C'#R#'                                                  
         BE    PCHKTYPR                                                         
         CLC   0(3,R7),=C'#F#'                                                  
         BE    PCHKTYPF                                                         
*                                                                               
PRTUX6B5 MVC   0(20,R2),0(R4)      MOVE TITLE                                   
         LA    RE,20(R2)                                                        
PRTUX6C  CLI   0(RE),C' '       SCAN BACKWARDS FOR NON-SPACE                    
         BH    PRTUX6D                                                          
         BCT   RE,PRTUX6C                                                       
*                                                                               
PRTUX6D  MVI   1(RE),C':'                                                       
         MVC   3(32,RE),0(R7)                                                   
         MVC   W(132),SPACES                                                    
         MVC   W+8(132-8),0(R2)    MOVE VALUE IN W FOR EDI CALL                 
         MVI   HALF,C'P'                                                        
         STC   RF,HALF+1           DECIDE WHICH SEQUENCE NUMBER                 
         OI    HALF+1,X'F0'                                                     
         ST    R1,DUB              SAVE R1                                      
         ST    RF,DUB+4            SAVE RF                                      
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUCM',HALF)    EDI CALL FOR PRODUCT            
**EDI**                                                                         
         L     R1,DUB              RESTORE R1                                   
         L     RF,DUB+4            RESTORE RF                                   
         LA    R2,132(R2)        NEXT PRINT LINE                                
*                                                                               
PRTUX6X  LA    R1,1(R1)          NEXT DATA LENGTH                               
         LA    R4,20(R4)         NEXT TITLE                                     
         LA    R7,32(R7)         NEXT DATA                                      
         AHI   RF,1                                                             
         BCT   R5,PRTUX6B                                                       
         B     PRTUX10                                                          
*                                                                               
PCHKTYPR DS    0H          CHECK INVOICE TYPE FOR #R# UCOM                      
*                                                                               
         CLI   ADJSEP,C'Y'       SEE IF I'M DOING ADJ ON SEPARATE INV           
         BNE   PCHKTYS           IF NOT PRINT IT                                
*                                                                               
         CLI   DUESW,C'A'        COM ADJ INVOICE?                               
         BE    PRTUX6X           SKIP THIS UCOM                                 
PCHKTYS  ZIC   R0,0(R1)                                                         
         SH    R0,=H'3'                                                         
         STC   R0,0(R1)                                                         
         CLI   0(R1),0           BE SURE THERE'S STILL DATA                     
         BE    PRTUX6X           IF NOT ALSO SKIP                               
         MVC   WORK(32),0(R7)                                                   
         MVC   0(29,R7),WORK+3   STRIP OFF #R# FOR DISPLAY                      
         MVC   29(3,R7),SPACES   CLEAR LAST 3 BYTES                             
         B     PRTUX6B5                                                         
*                                                                               
PCHKTYPF DS    0H          CHECK INVOICE TYPE FOR #F# UCOM                      
*                                                                               
         CLI   ADJSEP,C'Y'       SEE IF I'M DOING ADJ ON SEPARATE INV           
         BNE   PCHKTYG           IF NOT PRINT IT                                
*                                                                               
         CLI   DUESW,C'A'        COM ADJ INVOICE?                               
         BNE   PRTUX6X           IF NOT, SKIP THIS UCOM                         
PCHKTYG  ZIC   R0,0(R1)                                                         
         SH    R0,=H'3'                                                         
         STC   R0,0(R1)                                                         
         CLI   0(R1),0           BE SURE THERE'S STILL DATA                     
         BE    PRTUX6X           IF NOT ALSO SKIP                               
         MVC   WORK(32),0(R7)                                                   
         MVC   0(29,R7),WORK+3   STRIP OFF #F# FOR DISPLAY                      
         MVC   29(3,R7),SPACES   CLEAR LAST 3 BYTES                             
         B     PRTUX6B5                                                         
*                                                                               
*                                                                               
PRTUX10  DS    0H                NOW DO ESTIMATE FIELDS                         
         GOTO1 =V(DDUCOM),UCOMBLK                                               
         CLI   UCERROR,0                                                        
         BNE   PRTUXX       ERROR RETURN - JUST EXIT DON'T DIE                  
         TM    UCDATA,UCDNOEST+UCDNOREG+UCDNODST                                
         BO    PRTUXX       NO EST NOR REGION NOR DISTRICT DATA                 
         TM    UCDATA,UCDNOEST                                                  
         BO    PRTUX20                                                          
         XC    UCTTLS(UCALL),UCTTLS                                             
         L     R4,UCETTLS     EST TITLES                                        
         MVC   UCTTLS,0(R4)        SAVE INFO IN MY STORAGE                      
         LA    R4,UCTTLS           AS OPPOSED TO RD CHANE                       
         L     R7,UCEDATA     EST DATA                                          
         MVC   UCOMDATA,0(R7)                                                   
         LA    R7,UCOMDATA                                                      
         LA    R1,UCELENS     DATA FIELD LENGTHS                                
******** L     R4,UCETTLS     EST TITLES                                        
******** L     R7,UCEDATA     EST DATA                                          
*                                                                               
*        NOTE R2 SHOULD BE SET TO P1+8 OR                                       
*        NEXT AT +8 INTO NEXT AVAILABLE PRINT LINE                              
*                                                                               
         LA    R5,4             FOR BCT                                         
         LHI   RF,1             FOR EDI, LINE COUNTER                           
PRTUX10B DS    0H                                                               
         CLI   0(R1),0          CHECK DATA LENGTH                               
         BE    PRTUX10X                                                         
         CLC   0(3,R7),=C'#R#'                                                  
         BE    ECHKTYPR                                                         
         CLC   0(3,R7),=C'#F#'                                                  
         BE    ECHKTYPF                                                         
PRTUX1B5 MVC   0(20,R2),0(R4)      MOVE TITLE                                   
         LA    RE,20(R2)                                                        
PRTUX10C CLI   0(RE),C' '       SCAN BACKWARDS FOR NON-SPACE                    
         BH    PRTUX10D                                                         
         BCT   RE,PRTUX10C                                                      
*                                                                               
PRTUX10D MVI   1(RE),C':'                                                       
         MVC   3(32,RE),0(R7)                                                   
         MVC   W(132),SPACES                                                    
         MVC   W+8(132-8),0(R2)    MOVE VALUE IN W FOR EDI CALL                 
         MVI   HALF,C'E'                                                        
         STC   RF,HALF+1           DECIDE WHICH SEQUENCE NUMBER                 
         OI    HALF+1,X'F0'                                                     
         ST    R1,DUB              SAVE R1                                      
         ST    RF,DUB+4            SAVE RF                                      
         CLC   HALF(2),=C'E1'      FIRST EST UCOM?                              
         BNE   PRTUX10E                                                         
         CLI   SVWBSW,C'Y'         WB FLIGHT CLIENT?                            
         BNE   PRTUX10E                                                         
         CLI   WBSW,C'Y'           AM I IN WB FLIGHT MODE?                      
         BNE   PRTUX10F            NO - MEANS PRD IS NON-THEATRICAL             
*                                  SO DON'T SEND TO WORKER FILE                 
PRTUX10E DS    0H                                                               
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUCM',HALF)    EDI CALL FOR ESTIMATE           
**EDI**                                                                         
PRTUX10F L     R1,DUB              RESTORE R1                                   
         L     RF,DUB+4            RESTORE RF                                   
**WB**                                                                          
         CLC   HALF(2),=C'E1'    FIRST ESTIMATE UCOMM?                          
         BNE   PRTUX10H                                                         
         CLI   WBSW,C'Y'         WB FLIGHT MODE ACTIVE?                         
         BNE   PRTUX10H                                                         
         MVC   0(40,R2),SPACES  CLEAR AND DON'T PRINT                           
         B     PRTUX10X         IT WILL APPEAR IN THE BODY OF THE BILL          
*                               OR IN HEADLINES                                 
*                                                                               
PRTUX10H DS    0H                                                               
**WB**                                                                          
         LA    R2,132(R2)        NEXT PRINT LINE                                
*                                                                               
PRTUX10X LA    R1,1(R1)          NEXT DATA LENGTH                               
         LA    R4,20(R4)         NEXT TITLE                                     
         LA    R7,32(R7)         NEXT DATA                                      
         AHI   RF,1                                                             
         BCT   R5,PRTUX10B                                                      
*                                                                               
         CLI   ATTSW,C'Y'                                                       
         BNE   PRTUX20                                                          
*                                                                               
*                             ESTIMATE UCOMMS OVER 4 RETURNED                   
*                             IN PRODUCT FIELDS                                 
         L     R4,UCPTTLS     PRD TITLES                                        
         L     R7,UCPDATA     PRD DATA                                          
         LA    R1,UCPLENS     DATA FIELD LENGTHS                                
         CLI   0(R1),0        CHECK DATA LENGTH                                 
         BE    PRTUX20                                                          
         MVC   0(20,R2),0(R4)      MOVE TITLE                                   
         LA    RE,20(R2)                                                        
PRTUX10Y CLI   0(RE),C' '       SCAN BACKWARDS FOR NON-SPACE                    
         BH    PRTUX10Z                                                         
         BCT   RE,PRTUX10Y                                                      
*                                                                               
PRTUX10Z MVI   1(RE),C':'                                                       
         MVC   3(32,RE),0(R7)                                                   
         LA    R2,132(R2)        NEXT PRINT LINE                                
*                              ONLY SHOW EST UCOMM5                             
         B     PRTUX20                                                          
*                                                                               
ECHKTYPR DS    0H          CHECK INVOICE TYPE FOR #R# UCOM                      
*                                                                               
         CLI   ADJSEP,C'Y'       SEE IF I'M DOING ADJ ON SEPARATE INV           
         BNE   ECHKTYS           IF NOT PRINT IT                                
*                                                                               
         CLI   DUESW,C'A'        COM ADJ INVOICE?                               
         BE    PRTUX10X          SKIP THIS UCOM                                 
ECHKTYS  ZIC   R0,0(R1)                                                         
         SH    R0,=H'3'                                                         
         STC   R0,0(R1)                                                         
         CLI   0(R1),0           BE SURE THERE'S STILL DATA                     
         BE    PRTUX10X          IF NOT ALSO SKIP                               
         MVC   WORK(32),0(R7)                                                   
         MVC   0(29,R7),WORK+3   STRIP OFF #R# FOR DISPLAY                      
         MVC   29(3,R7),SPACES   CLEAR LAST 3 BYTES                             
         B     PRTUX1B5                                                         
*                                                                               
ECHKTYPF DS    0H          CHECK INVOICE TYPE FOR #F# UCOM                      
*                                                                               
         CLI   ADJSEP,C'Y'       SEE IF I'M DOING ADJ ON SEPARATE INV           
         BNE   ECHKTYG           IF NOT PRINT IT                                
*                                                                               
         CLI   DUESW,C'A'        COM ADJ INVOICE?                               
         BNE   PRTUX10X           IF NOT, SKIP THIS UCOM                        
ECHKTYG  ZIC   R0,0(R1)                                                         
         SH    R0,=H'3'                                                         
         STC   R0,0(R1)                                                         
         CLI   0(R1),0           BE SURE THERE'S STILL DATA                     
         BE    PRTUX10X          IF NOT ALSO SKIP                               
         MVC   WORK(32),0(R7)                                                   
         MVC   0(29,R7),WORK+3   STRIP OFF #F# FOR DISPLAY                      
         MVC   29(3,R7),SPACES   CLEAR LAST 3 BYTES                             
         B     PRTUX1B5                                                         
*                                                                               
PRTUX20  DS    0H                NOW DO REGION FIELDS                           
         GOTO1 =V(DDUCOM),UCOMBLK                                               
         CLI   UCERROR,0                                                        
         BNE   PRTUXX       ERROR RETURN - JUST EXIT DON'T DIE                  
         TM    UCDATA,UCDNOREG+UCDNODST                                         
         BO    PRTUXX       NO REGION NOR DISTRICT DATA                         
         TM    UCDATA,UCDNOREG                                                  
         BO    PRTUX30                                                          
         XC    UCTTLS(UCALL),UCTTLS                                             
         L     R4,UCRTTLS     REG TITLES                                        
         MVC   UCTTLS,0(R4)        SAVE INFO IN MY STORAGE                      
         LA    R4,UCTTLS           AS OPPOSED TO RD CHANE                       
         L     R7,UCRDATA     REG DATA                                          
         MVC   UCOMDATA,0(R7)                                                   
         LA    R7,UCOMDATA                                                      
         LA    R1,UCRLENS        DATA FIELD LENGTHS                             
******** L     R4,UCRTTLS        REGION TITLES                                  
******** L     R7,UCRDATA        REGION DATA                                    
*                                                                               
*        NOTE R2 SHOULD BE SET TO P1+8 OR                                       
*        NEXT AT +8 INTO NEXT AVAILABLE PRINT LINE                              
*                                                                               
         LA    R5,4             FOR BCT                                         
         AHI   RF,1             FOR EDI, LINE COUNTER                           
PRTUX20B DS    0H                                                               
         CLI   0(R1),0          CHECK DATA LENGTH                               
         BE    PRTUX20X                                                         
         MVC   0(20,R2),0(R4)      MOVE TITLE                                   
         LA    RE,20(R2)                                                        
PRTUX20C CLI   0(RE),C' '       SCAN BACKWARDS FOR NON-SPACE                    
         BH    PRTUX20D                                                         
         BCT   RE,PRTUX20C                                                      
*                                                                               
PRTUX20D MVI   1(RE),C':'                                                       
         MVC   3(32,RE),0(R7)                                                   
         MVC   W(132),SPACES                                                    
         MVC   W+8(132-8),0(R2)    MOVE VALUE IN W FOR EDI CALL                 
         MVI   HALF,C'R'                                                        
         STC   RF,HALF+1           DECIDE WHICH SEQUENCE NUMBER                 
         OI    HALF+1,X'F0'                                                     
         ST    R1,DUB              SAVE R1                                      
         ST    RF,DUB+4            SAVE RF                                      
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUCM',HALF)    EDI CALL FOR REGION             
**EDI**                                                                         
         L     R1,DUB              RESTORE R1                                   
         L     RF,DUB+4            RESTORE RF                                   
         LA    R2,132(R2)        NEXT PRINT LINE                                
*                                                                               
PRTUX20X LA    R1,1(R1)          NEXT DATA LENGTH                               
         LA    R4,20(R4)         NEXT TITLE                                     
         LA    R7,32(R7)         NEXT DATA                                      
         AHI   RF,1                                                             
         BCT   R5,PRTUX20B                                                      
*                                                                               
PRTUX30  DS    0H                NOW DO DISTRICT FIELDS                         
         GOTO1 =V(DDUCOM),UCOMBLK                                               
         CLI   UCERROR,0                                                        
         BNE   PRTUXX       ERROR RETURN - JUST EXIT DON'T DIE                  
         TM    UCDATA,UCDNODST                                                  
         BO    PRTUX40                                                          
         XC    UCTTLS(UCALL),UCTTLS                                             
         L     R4,UCDTTLS     DST TITLES                                        
         MVC   UCTTLS,0(R4)        SAVE INFO IN MY STORAGE                      
         LA    R4,UCTTLS           AS OPPOSED TO RD CHANE                       
         L     R7,UCDDATA     DST DATA                                          
         MVC   UCOMDATA,0(R7)                                                   
         LA    R7,UCOMDATA                                                      
         LA    R1,UCDLENS        DATA FIELD LENGTHS                             
******** L     R4,UCDTTLS        DISTRICT TITLES                                
******** L     R7,UCDDATA        DISTRICT DATA                                  
*                                                                               
*        NOTE R2 SHOULD BE SET TO P1+8 OR                                       
*        NEXT AT +8 INTO NEXT AVAILABLE PRINT LINE                              
*                                                                               
         LA    R5,4             FOR BCT                                         
         LHI   RF,1                                                             
PRTUX30B DS    0H                                                               
         CLI   0(R1),0          CHECK DATA LENGTH                               
         BE    PRTUX30X                                                         
         MVC   0(20,R2),0(R4)      MOVE TITLE                                   
         LA    RE,20(R2)                                                        
PRTUX30C CLI   0(RE),C' '       SCAN BACKWARDS FOR NON-SPACE                    
         BH    PRTUX30D                                                         
         BCT   RE,PRTUX30C                                                      
*                                                                               
PRTUX30D MVI   1(RE),C':'                                                       
         MVC   3(32,RE),0(R7)                                                   
         MVC   W(132),SPACES                                                    
         MVC   W+8(132-8),0(R2)    MOVE VALUE IN W FOR EDI CALL                 
         MVI   HALF,C'D'                                                        
         STC   RF,HALF+1           DECIDE WHICH SEQUENCE NUMBER                 
         OI    HALF+1,X'F0'                                                     
         ST    R1,DUB              SAVE R1                                      
         ST    RF,DUB+4            SAVE RF                                      
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUCM',HALF)    EDI CALL FOR DISTRICT           
**EDI**                                                                         
         L     R1,DUB              RESTORE R1                                   
         L     RF,DUB+4            RESTORE RF                                   
         LA    R2,132(R2)        NEXT PRINT LINE                                
*                                                                               
PRTUX30X LA    R1,1(R1)          NEXT DATA LENGTH                               
         LA    R4,20(R4)         NEXT TITLE                                     
         LA    R7,32(R7)         NEXT DATA                                      
         AHI   RF,1                                                             
         BCT   R5,PRTUX30B                                                      
*                                                                               
PRTUX40  DS    0H                                                               
         GOTO1 =A(PRNT)         FINALLY PRINT P LINES                           
         MVC   KEY,USAVKEY  SINCE SEQ READING MAY BE AFFECTED                   
         GOTO1 HIGH                                                             
*                                                                               
PRTUXX   XIT1                                                                   
**                                                                              
         DROP  R6                                                               
**                                                                              
         SPACE 3                                                                
UNEXTEL  DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         JE    UNEXTEL2                                                         
         CLC   0(1,R2),ELCODE                                                   
         BER   RE                                                               
         J     UNEXTEL                                                          
UNEXTEL2 DS    0H                                                               
         LTR   RE,RE                                                            
         BR    RE                                                               
*                                                                               
USAVKEY  DS    CL32                                                             
*                                                                               
HAVUSER  DS    CL1                                                              
*                                                                               
         LTORG                                                                  
*                                                                               
UCOMBLK  DS    CL(UCOMDLNQ)     DDUCOM CONTROL BLOCK                            
UCTTLS   DS    CL80             LEN=20*4                                        
UCOMDATA DS    CL128            LEN=32*4                                        
UCALL    EQU   *-UCTTLS                                                         
         SPACE 2                                                                
         DROP  R3,R4,RF                                                         
         EJECT                                                                  
*                    HERE IF PRODUCT NOT "S"                                    
*                    LOOK FOR "AAA" USER FIELDS                                 
*                                                                               
PRTAAAU  NMOD1 0,PRTAAAU                                                        
         LA    RC,SPACEND                                                       
*                                                                               
         MVC   UASAVKEY,KEY                                                     
*                                                                               
         XC    KEY,KEY                                                          
         L     RF,ADCLT                                                         
         MVC   KEY(7),0(RF)                                                     
         MVI   KEY+3,X'06'                                                      
         MVC   KEY+7(3),=C'AAA'                                                 
         GOTO1 HIGH                                                             
         CLC   KEY(10),KEYSAVE                                                  
         BNE   PRTAUX          EXIT IF PRD AAA NOT THERE                        
         MVC   AREC,ACOMREC                                                     
         GOTO1 GETPRT                                                           
*                                                                               
         CLI   EPUDEF,C'P'  PRINTED NEXT TO NAME?                               
         BE    PRTAE5       CAN SKIP PRD GETUER CALLS - GO TO ESTS.             
*                                                                               
         L     R2,AREC       NOW HAS PRODUCT AAA                                
         LA    R2,33(R2)    TO FIRST ELEMENT                                    
         MVI   ELCODE,X'08'   LOOK FOR USER DATA                                
         BRAS  RE,ANEXTEL                                                       
         BNE   PRTAE5       CAN SKIP PRD GETUER CALLS - GO TO ESTS.             
         USING PPRDUDEF,R2                                                      
         MVC   X+60(32),PUSER1 SAVE REAL PUSER1                                 
         MVC   X+60+32(16),PUSER2 AND PUSER2                                    
*                                                                               
*        STRIP-OFF #R# AND #F# PREFIXES HERE                                    
*                                                                               
         CLC   PUSER1(3),=C'#R#'      ONLY ON NON-ADJ INV?                      
         BE    PUA1                                                             
         CLC   PUSER1(3),=C'#F#'      ONLY ON NON-ADJ INV?                      
         BNE   PUA1B                                                            
PUA1     MVC   WORK(32),PUSER1                                                  
         MVC   PUSER1(29),WORK+3                                                
         MVC   PUSER1+29(3),SPACES                                              
*                                                                               
PUA1B    DS    0H                                                               
         CLC   PUSER2(3),=C'#R#'      ONLY ON NON-ADJ INV?                      
         BE    PUA1C                                                            
         CLC   PUSER2(3),=C'#F#'      ONLY ON NON-ADJ INV?                      
         BNE   PUA1D                                                            
PUA1C    MVC   WORK(16),PUSER2                                                  
         MVC   PUSER2(13),WORK+3                                                
         MVC   PUSER2+13(3),SPACES                                              
*                                                                               
PUA1D    DS    0H                                                               
*                                                                               
         CLI   ADJSEP,C'Y'                                                      
         BNE   PUA2X                                                            
*                                                                               
         CLC   X+60(3),=C'#R#'      ONLY ON NON-ADJ INV?                        
         BNE   PUA2                                                             
         CLI   DUESW,C'A'         IS THE AN ADJ SEP INV?                        
         BE    PRTAPU5            SKIP THE FIRST EST USER                       
         B     PUA2X                                                            
*                                                                               
PUA2     CLC   X+60(3),=C'#F#'      ONLY ON ADJ SEP BILL?                       
         BNE   PUA2X                                                            
         CLI   DUESW,C'A'         IS THE AN ADJ SEP INV?                        
         BNE   PRTAPU5            SKIP THE FIRST EST USER                       
         B     PUA2X                                                            
*                                                                               
PUA2X    DS    0H                                                               
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'P',AREC),(C':',P1+8),0          
         TM    DMCB+4,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    PRTAPU5                                                          
*                                                                               
         CLI   PUMODE,C'F'   FRONT OF BILL                                      
         BNE   PUA14D                                                           
         TM    DMCB+4,X'02'                                                     
         BZ    PUA15                                                            
         B     PUA14F                                                           
*                                                                               
PUA14D   DS    0H          NOT DOING FRONT NOW                                  
         TM    DMCB+4,X'02'                                                     
         BO    PUA15                                                            
*                                                                               
PUA14F   DS    0H                                                               
         MVI   AHAVUSER,C'Y'                                                    
         MVC   W(132),P1     SAVE P1                                            
         MVC   P1,SPACES                                                        
         GOTO1 =A(PRNT)       SKIP BEFORE                                       
         MVC   P1,W           RESTORE P1                                        
         GOTO1 =A(PRNT)                                                         
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'P1')   EDI CALL                       
**EDI**                                                                         
         MVI   BYTE,1          SO I WON'T SKIP AGAIN                            
*                                                                               
PUA15    DS    0H                                                               
PRTAPU5  DS    0H                                                               
*                                                                               
         CLI   ADJSEP,C'Y'                                                      
         BNE   PUA3X                                                            
*                                                                               
         CLC   X+60+32(3),=C'#R#'     ONLY ON NON-ADJ INV?                      
         BNE   PUA3                                                             
         CLI   DUESW,C'A'         IS THE AN ADJ SEP INV?                        
         BE    PRTAE              SKIP THIS PRD USER                            
         B     PUA3X                                                            
*                                                                               
PUA3     CLC   X+60+32(3),=C'#F#'     ONLY ON ADJ SEP BILL?                     
         BNE   PUA3X                                                            
         CLI   DUESW,C'A'         IS THE AN ADJ SEP INV?                        
         BNE   PRTAE              SKIP THIS PRD USER                            
         B     PUA3X                                                            
*                                                                               
PUA3X    DS    0H                                                               
         MVC   P1,SPACES                                                        
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'P',AREC),0,(C':',P1+8)          
*                                                                               
         TM    DMCB+6,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    PRTAE                                                            
*                                                                               
         CLI   PUMODE,C'F'   FRONT OF BILL                                      
         BNE   PUA16D                                                           
         TM    DMCB+4,X'02'                                                     
         BZ    PUA17                                                            
         B     PUA16F                                                           
*                                                                               
PUA16D   DS    0H          NOT DOING FRONT NOW                                  
         TM    DMCB+4,X'02'                                                     
         BO    PUA17                                                            
*                                                                               
PUA16F   DS    0H                                                               
         CLI   BYTE,1                                                           
         BE    PRTAPU8                                                          
         MVC   W(132),P1      SAVE P1                                           
         MVC   P1,SPACES                                                        
         GOTO1 =A(PRNT)       SKIP BEFORE                                       
         MVC   P1,W           RESTORE P1                                        
*                                                                               
PRTAPU8  GOTO1 =A(PRNT)                                                         
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'P2')   EDI CALL                       
**EDI**                                                                         
*                                                                               
PUA17    DS    0H                                                               
PRTAE    DS    0H                                                               
*                                                                               
         MVC   PUSER1,X+60         RESTORE REAL PRD USER DATA                   
         MVC   PUSER2,X+60+32                                                   
*                                                                               
         DROP  R2                                                               
PRTAE5   DS    0H               GET HERE IF NO USER DATA FOUND                  
         MVI   BYTE,0                                                           
         MVC   P1,SPACES                                                        
         CLI   ESTCTL,C'S'      SEE IF EST SEPARATE                             
         BNE   PRTAUX                                                           
*                                                                               
         XC    KEY,KEY                                                          
         L     RF,ADEST         I SHOULD HAVE AN ESTIMATE                       
         MVC   KEY(12),0(RF)    AGY/MED/CLT/PRD/EST                             
         MVI   KEY+3,X'07'                                                      
         MVC   KEY+7(3),=C'AAA'                                                 
         GOTO1 HIGH                                                             
         CLC   KEY(12),KEYSAVE                                                  
         BNE   PRTAUX          EXIT IF PRD AAA ESTIMATE NOT THERE               
         MVC   AREC,ACOMREC                                                     
         GOTO1 GETPRT                                                           
*                                                                               
         L     R2,AREC      NOW EST FOR PRD AAA                                 
         LA    R2,33(R2)    TO FIRST ELEMENT                                    
         MVI   ELCODE,X'08'   LOOK FOR USER DATA                                
         BRAS  RE,ANEXTEL                                                       
         BNE   PRTAEU11      CAN SKIP EST GETUSER CALLS                         
         USING PESTUDEF,R2                                                      
*                                                                               
         MVC   X+60(32),PEUSER1 SAVE REAL PEUSER1                               
         MVC   X+60+32(16),PEUSER2 AND PEUSER2                                  
*                                                                               
*        STRIP-OFF #R# AND #F# PREFIXES HERE                                    
*                                                                               
         CLC   PEUSER1(3),=C'#R#'     ONLY ON NON-ADJ INV?                      
         BE    PRTAE6                                                           
         CLC   PEUSER1(3),=C'#F#'     ONLY ON NON-ADJ INV?                      
         BNE   PRTAE7                                                           
PRTAE6   MVC   WORK(32),PEUSER1                                                 
         MVC   PEUSER1(29),WORK+3                                               
         MVC   PEUSER1+29(3),SPACES                                             
*                                                                               
PRTAE7   DS    0H                                                               
         CLC   PEUSER2(3),=C'#R#'     ONLY ON NON-ADJ INV?                      
         BE    PRTAE8                                                           
         CLC   PEUSER2(3),=C'#F#'     ONLY ON NON-ADJ INV?                      
         BNE   PRTAE9                                                           
PRTAE8   MVC   WORK(16),PEUSER2                                                 
         MVC   PEUSER2(13),WORK+3                                               
         MVC   PEUSER2+13(3),SPACES                                             
*                                                                               
PRTAE9   DS    0H                                                               
*                                                                               
         CLI   ADJSEP,C'Y'                                                      
         BNE   PUA6X                                                            
*                                                                               
         CLC   X+60(3),=C'#R#'        ONLY ON NON-ADJ INV?                      
         BNE   PUA6                                                             
         CLI   DUESW,C'A'         IS THE AN ADJ SEP INV?                        
         BE    PRTAEU5             SKIP THE FIRST EST USER                      
         B     PUA6X                                                            
*                                                                               
PUA6     CLC   X+60(3),=C'#F#'        ONLY ON ADJ SEP BILL?                     
         BNE   PUA6X                                                            
         CLI   DUESW,C'A'         IS THE AN ADJ SEP INV?                        
         BNE   PRTAEU5             SKIP THE FIRST EST USER                      
         B     PUA6X                                                            
*                                                                               
PUA6X    DS    0H                                                               
*                                                                               
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'E',AREC),(C':',P1+8),0          
         TM    DMCB+4,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    PRTAEU5                                                          
*                                                                               
         CLI   PUMODE,C'F'   FRONT OF BILL                                      
         BNE   PUAE14D                                                          
         TM    DMCB+4,X'02'                                                     
         BZ    PUAE15                                                           
         B     PUAE14F                                                          
*                                                                               
PUAE14D  DS    0H          NOT DOING FRONT NOW                                  
         TM    DMCB+4,X'02'                                                     
         BO    PUAE15                                                           
*                                                                               
PUAE14F  DS    0H                                                               
         MVI   AHAVUSER,C'Y'                                                    
         MVC   W(132),P1      SAVE P1                                           
         MVC   P1,SPACES                                                        
         GOTO1 =A(PRNT)       SKIP BEFORE                                       
         MVC   P1,W           RESTORE P1                                        
         GOTO1 =A(PRNT)                                                         
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'E1')    EDI CALL                      
**EDI**                                                                         
         MVI   BYTE,1          SO I WON'T SKIP AGAIN                            
*                                                                               
PUAE15   DS    0H                                                               
PRTAEU5  DS    0H                                                               
*                                                                               
         CLI   ADJSEP,C'Y'                                                      
         BNE   PUA7X                                                            
*                                                                               
         CLC   X+60+32(3),=C'#R#'     ONLY ON NON-ADJ INV?                      
         BNE   PUA7                                                             
         CLI   DUESW,C'A'         IS THE AN ADJ SEP INV?                        
         BE    PRTAEU10            SKIP THE FIRST EST USER                      
         B     PUA7X                                                            
*                                                                               
PUA7     CLC   X+60+32(3),=C'#F#'     ONLY ON ADJ SEP BILL?                     
         BNE   PUA7X                                                            
         CLI   DUESW,C'A'         IS THE AN ADJ SEP INV?                        
         BNE   PRTAEU10            SKIP THE FIRST EST USER                      
         B     PUA7X                                                            
*                                                                               
PUA7X    DS    0H                                                               
         MVC   P1,SPACES                                                        
         GOTO1 =V(GETUSER),DMCB,(C'P',ADCLT),(C'E',AREC),0,(C':',P1+8)          
*                                                                               
         MVC   PEUSER1,X          RESTORE REAL VALUES                           
         MVC   PEUSER2,X+32       RESTORE REAL VALUES                           
*                                                                               
         TM    DMCB+6,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    PRTAEU10                                                         
*                                                                               
         CLI   PUMODE,C'F'   FRONT OF BILL                                      
         BNE   PUAE16D                                                          
         TM    DMCB+4,X'02'                                                     
         BZ    PUAE17                                                           
         B     PUAE16F                                                          
*                                                                               
PUAE16D  DS    0H          NOT DOING FRONT NOW                                  
         TM    DMCB+4,X'02'                                                     
         BO    PUAE17                                                           
*                                                                               
PUAE16F  DS    0H                                                               
         MVI   AHAVUSER,C'Y'                                                    
         CLI   BYTE,1                                                           
         BE    PRTAEU8                                                          
         MVC   W(132),P1      SAVE P1                                           
         MVC   P1,SPACES                                                        
         GOTO1 =A(PRNT)       SKIP BEFORE                                       
         MVC   P1,W           RESTORE P1                                        
PRTAEU8  GOTO1 =A(PRNT)                                                         
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'E2')   EDI CALL                       
**EDI**                                                                         
*                                                                               
PUAE17   DS    0H                                                               
PRTAEU10 DS    0H                                                               
         MVC   PEUSER1,X+60       MUST RESTORE REAL EST USER1                   
         MVC   PEUSER2,X+60+32 RESTORE EST REAL USER 2                          
*                                                                               
         DROP  R2                                                               
*                                                                               
PRTAEU11 DS    0H                                                               
         MVC   P1,SPACES         IN CASE SOMETHING IS LEFT THERE                
         CLI   AHAVUSER,C'Y'                                                    
         BNE   PRTAUX                                                           
         CLI   PUMODE,C'F'    ONLY NEEDED FOR FRONT PRINTING                    
         BNE   PRTAUX                                                           
         GOTO1 =A(PRNT)         SKIP AFTER LAST                                 
         B     PRTAUX                                                           
         EJECT                                                                  
PRTAUX   MVC   KEY,UASAVKEY                                                     
         GOTO1 HIGH                                                             
         XIT1                                                                   
*                                                                               
         SPACE 3                                                                
ANEXTEL  DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    ANEXTEL2                                                         
         CLC   0(1,R2),ELCODE                                                   
         BER   RE                                                               
         B     ANEXTEL                                                          
ANEXTEL2 DS    0H                                                               
         LTR   RE,RE                                                            
         BR    RE                                                               
*                                                                               
         LTORG                                                                  
UASAVKEY DS    CL32                                                             
*                                                                               
AHAVUSER DS    CL1                                                              
*                                                                               
         EJECT                                                                  
         TITLE 'PPB12E - PRINTPAK BILLING/SOURCE BOOK E'                        
*                                                                               
*      CHANGE LOG                                                               
*                                                                               
*  BPLA   08/00    COPY OF PPREPB12E AT LEVEL 11 5/31/00                        
*                  COPY MADE 8/16/00                                            
*                  CHANGES TO CATALP AND PPREPB1WKN                             
*                  (WHICH INCLUDES PNNEWFILE IN PLACE OF                        
*                  PPNEWFILE)                                                   
*                  PNNEWFILE INCLUDES PNBILREC IN PLACE                         
*                  OF PBILLREC                                                  
*                                                                               
*   BPLA 6/99     COPY OF PPB12E ALT LEVEL 9 MADE 6/28/99                       
*                 CHANGES TO FINANCIAL CHECKS FOR COST2                         
*                                                                               
*   BPLA 6/99     CHANGE IN VBADD WHEN CHECK FOR PUB                            
*                                                                               
*   BPLA 12/97    IF REVERSING A 1997 BILL SUBJECT TO QST                       
*                 SET PERCENTAGE TO 6.5 (INSTEAD OF 7.5)                        
*                 JAN02/98 IS USED SINCE JAN01/98 WAS                           
*                 TREATED AS COMPUTER DAY DEC31/97                              
*                                                                               
*   BPLA 12/97    IF DOING A MANUAL BILL - IN VBADD SET                         
*                 HSTS TO 0 NOT "H".                                            
*                                                                               
*   BPLA 6/97     DON'T DIE IN VB2C3 IF NOT PST CODE FOUND                      
*                 JUST FALL THROUGH (SVPPSTS LEFT EMPTY)                        
*                                                                               
*   BPLA 5/97     NEW CHANGES FOR HST                                           
*                                                                               
*   BPLA 5/97     COPY OF PPB12EO                                               
*                                                                               
*   BPLA 3/97     CHANGES FOR HST                                               
*                                                                               
*   BPLA 9/18/96  PPB12EO SOURCE MADE LIVE - NOW INCLUDES PPREPB1WRK            
*                 NEEDS PPB1ACC                                                 
*                                                                               
*   BPLA 10/19/94  IN VBPRNT - IF AOR BILL DO NOT SHOW                          
*                  ZERO PROVINCIAL VATS FOR CODE S                              
*                                                                               
*                                                                               
*   BPLA 5/94   IF REVERSAL - AND REVESAL DATE IS BEFORE                        
*               JUNE 1/94 SET QST TO 4 PCT (IF APPLICABLE)                      
*                                                                               
*                                                                               
*   BPLA 3/94   NEW SOURCE BOOK - PST                                           
*                                                                               
***********************************************************************         
*                                                                               
*        SETCPVC  SETS CLIENT/PRODUCT VAT CODES (CVATCDS)                       
*                 AND 'MIXED PROD' SWITCHES     (CVATPSWS)                      
*                                                                               
*        PARM1  BYTE  0   PRODUCT CODE                                          
*               BYTES 1-3 NOTE USED                                             
*                                                                               
*        NOTE- MAYBE SHOULD TABLE PRODUCT INFO TO SAVE RE-READS                 
*        NOTE- MAYBE IT SHOULD BE POSSIBLE TO HAVE PST WITHOUT                  
*              GST BUT THAT WOULD NEED SOME WORK. (TOO MUCH RELIANCE            
*              ON CVATSW (NOT CVATSWS) TO CONTROL VAT LOGIC?)                   
*                                                                               
***********************************************************************         
         SPACE 2                                                                
         PRINT NOGEN                                                            
SETCPVC  NMOD1 SPCWRKL,SETCPVC                                                  
         USING PPWORKD,RA                                                       
         USING PPWORK2D,R9                                                      
         LR    R8,RC                                                            
         USING SPCWRKD,R8                                                       
         USING BILWRKD,RC                                                       
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   CVATCOD,0           IF GST CODE WAS SET TO NULLS                 
         BE    SCPVX               DONT PICK UP ANY NOW                         
*                                                                               
         LA    R6,NVATCDS          VAT CODES FOR JUL/10 MOS                     
         XC    0(NPROVS+1,R6),0(R6)                                             
         LA    R7,NVATPSWS         'MIXED PROD' SWITCHES  JUL/10 MOS            
         XC    0(NPROVS+1,R7),0(R7)                                             
*                                                                               
         LA    R2,CVATCDS          VAT CODES                                    
         XC    0(NPROVS+1,R2),0(R2)                                             
         LA    R3,CVATPSWS         'MIXED PROD' SWITCHES                        
         XC    0(NPROVS+1,R3),0(R3)                                             
*                                                                               
         L     R5,ADCLT                                                         
         LA    R5,33(R5)                                                        
         MVI   ELCODE,X'25'          SEARCH FOR PST ELEM                        
         BAS   RE,SNEXTEL                                                       
         BNE   SCPV2                                                            
         MVC   1(NPROVS,R2),2(R5)        MOVE FROM ELEM                         
SCPV2    DS    0H                                                               
         L     RF,ADCLT                                                         
         MVC   0(1,R2),PCLTGST-PCLTREC(RF)                                      
         CLI   0(R2),C' '                                                       
         BH    *+8                                                              
         MVI   0(R2),C'S'          GST DEFAULT IS S                             
*                                                                               
SCPV6    DS    0H                                                               
*                                                                               
         L     R5,ADCLT                                                         
         LA    R5,33(R5)                                                        
         MVI   ELCODE,X'26'          SEARCH FOR NEW PST ELEM                    
         BAS   RE,SNEXTEL                                                       
         BNE   SCPV7                                                            
         MVC   1(NPROVS,R6),2(R5)        MOVE FROM ELEM                         
SCPV7    DS    0H                                                               
         L     RF,ADCLT                                                         
         MVC   0(1,R6),PCLTGST-PCLTREC(RF)                                      
         CLI   0(R6),C' '                                                       
         BH    *+8                                                              
         MVI   0(R6),C'S'          GST DEFAULT IS S                             
*                                                                               
SCPV7X   DS    0H                                                               
         OC    0(NPROVS+1,R2),0(R2)              ANY VATS AT ALL?               
         BZ    SCPVX                             NO, DONE                       
*                                                                               
         L     RE,APRD              SEE IF I HAVE A PRODUCT                     
         LTR   RE,RE                                                            
         BZ    SCPVX                                                            
         L     RF,ADCLT                                                         
*                                                                               
         MVC   SPCWORK(7),0(RF)                                                 
         MVC   SPCWORK+7(3),0(RE)   3 CHAR PRD CODE                             
         MVI   SPCWORK+3,X'06'                                                  
         L     RF,ADPRD                                                         
         CLC   SPCWORK(10),0(RF)    TEST ALREADY HAVE PRDHDR                    
         BE    SCPV8                                                            
*                                                                               
         MVC   SCPSVKEY,KEY        SAVE KEY                                     
         XC    KEY,KEY                                                          
         MVC   KEY(10),SPCWORK                                                  
         GOTO1 READ                                                             
         L     RF,ADPRD                                                         
         ST    RF,AREC                                                          
         GOTO1 GETPRT                                                           
         MVC   KEY,SCPSVKEY        RESTORE KEY                                  
         GOTO1 HIGH                AND SEQ                                      
*                                                                               
SCPV8    DS    0H                                                               
         XC    SPCWORK(22),SPCWORK   11 X 2                                     
         L     RF,ADPRD                                                         
         MVC   SPCWORK(1),PPRDGST-PPRDREC(RF)                                   
         MVC   SPCWORK+11(1),PPRDGST-PPRDREC(RF)                                
         LR    R5,RF                                                            
         LA    R5,33(R5)                                                        
         MVI   ELCODE,X'25'                                                     
         BAS   RE,SNEXTEL                                                       
         BNE   SCPV8A                                                           
         MVC   SPCWORK+1(NPROVS),2(R5)                                          
*                                                                               
SCPV8A   LR    R5,RF          LOOK FOR NEW PST ELEMENT - JUL/10                 
         LA    R5,33(R5)                                                        
         MVI   ELCODE,X'26'                                                     
         BAS   RE,SNEXTEL                                                       
         BNE   SCPV8C                                                           
         MVC   SPCWORK+12(NPROVS),2(R5)                                         
*                                                                               
SCPV8C   LA    R4,SPCWORK                                                       
         LA    R5,NPROVS+1                                                      
*                                                                               
SCPV9    DS    0H                                                               
         CLI   0(R4),C'0'          ZERO                                         
         BNE   *+8                                                              
         MVI   0(R4),0             BECOMES NULL                                 
         CLI   0(R4),C' '               SET FROM PRDHDR                         
         BNH   SCPV12                   IF PRESENT                              
         CLC   0(1,R2),0(R4)            IF PRODUCT NOT = CLIENT                 
         BE    *+14                                                             
         MVI   0(R3),C'M'          SET HAVE MIXED PRD VAT CODES                 
         MVC   0(1,R2),0(R4)       SET VALUE FROM PRODUCT                       
*                                                                               
SCPV12   DS    0H                                                               
         LA    R2,1(R2)            NEXT PROVINCE                                
         LA    R3,1(R3)                                                         
         LA    R4,1(R4)                                                         
         BCT   R5,SCPV9                                                         
*                                                                               
         LA    R4,SPCWORK+11                                                    
         LA    R5,NPROVS+1                                                      
SCPV14   DS    0H                                                               
         CLI   0(R4),C'0'          ZERO                                         
         BNE   *+8                                                              
         MVI   0(R4),0             BECOMES NULL                                 
         CLI   0(R4),C' '               SET FROM PRDHDR                         
         BNH   SCPV15                   IF PRESENT                              
         CLC   0(1,R6),0(R4)            IF PRODUCT NOT = CLIENT                 
         BE    *+14                                                             
         MVI   0(R7),C'M'          SET HAVE MIXED PRD VAT CODES                 
         MVC   0(1,R6),0(R4)       SET VALUE FROM PRODUCT                       
         B     SCPV16                                                           
*                                                                               
SCPV15   OC    SPCWORK+12(10),SPCWORK+12  DO I HAVE ANY PRD MAIN PST?           
         BZ    SCPV16                                                           
         C     R5,=F'11'            GST FIELD?                                  
         BE    *+10                 IF SO DON'T STORE                           
*                                   NEEDED IN CASE THEY DID NOT SET             
*                                   GST TO S WHEN THE PRODUCT                   
*                                   HAS A MAIN PST OF PQ=S                      
*                                   LEAVE VALUE FROM THE CLIENT                 
*                                                                               
         MVC   0(1,R6),0(R4)        IF SO THEN STORE THIS VALUE                 
*                                                                               
SCPV16   DS    0H                                                               
         LA    R6,1(R6)            NEXT PROVINCE                                
         LA    R7,1(R7)                                                         
         LA    R4,1(R4)                                                         
         BCT   R5,SCPV14                                                        
         B     SCPVX                                                            
*                                                                               
SCPVX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
*                                                                               
SNEXTEL  DS    0H                                                               
         CLI   0(R5),0         SEE IF AT END OF RECORD                          
         BE    SNXTELX                                                          
         ZIC   R0,1(R5)                                                         
         AR    R5,R0                                                            
         CLC   0(1,R5),ELCODE                                                   
         BER   RE                                                               
         B     SNEXTEL                                                          
*                                                                               
SNXTELX  LTR   RE,RE              RETURN WITH CC NOT EQUAL                      
         BR    RE                                                               
*                                                                               
         LTORG                                                                  
*                                                                               
SPCWRKD  DSECT                                                                  
SPCWORK  DS    XL64                                                             
SCPSVKEY DS    XL32                                                             
SPCWRKL  EQU   *-SPCWRKD                                                        
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBADD    ADD TO VAT BASIS TABLE                                        
*                                                                               
*        PARM1  BYTE  0   C=CLEAR                                               
*               BYTES 1-3 A(RDBUFF BUFFALO RECORD)                              
*        PARM2  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(BRKTAB ENTRY)                                       
*                                                                               
*        NOTE-   PST LOGIC (SUCH AS IT IS) IS BUILT AROUND THERE                
*              BEING ONLY ONE EFFECTIVE VAT CODE FOR EACH PROVINCE              
*              (INCLUDING NATIONAL). THIS CODE IS S. OTHER CODES                
*              SHOULD HAVE 0%.                                                  
*                IF THIS IS A PROBLEM IT CAN BE AT LEAST PARTIALLY              
*              ADDRESSED BY RESTRUCTURING THE VBATAB TO INCLUDE                 
*              THE VAT CODE.                                                    
*                THE VBATAB IS NOW INDEXED BY PROVINCE NUMBER (0=GST).          
*              NOTE THAT CVATCDS IS SET FROM CLT/PRD AND NOT AFFECTED           
*              BY PUBL VAT CODES, WHICH ARE USED JUST TO BUILD THE              
*              VBTAB.                                                           
*                                                                               
***********************************************************************         
PPB102   CSECT                                                                  
         SPACE 2                                                                
         PRINT NOGEN                                                            
VBADD    NMOD1 VBAWRKL,VBADD                                                    
         USING PPWORKD,RA                                                       
         USING PPWORK2D,R9                                                      
         LR    R8,RC                                                            
         USING VBAWRKD,R8                                                       
*                                                                               
         USING BILWRKD,RC                                                       
         LA    RC,SPACEND                                                       
*                                                                               
         L     R3,4(R1)                                                         
         ST    R3,VBABRK           SAVE A(BREAK TABLE ENTRY)                    
         MVC   VBABRKC,BRKCODE-BRKTABD(R3)                                      
         ST    R1,VBASVR1                                                       
         SPACE 2                                                                
         CLI   0(R1),C'C'          CLEAR COMMAND                                
         BNE   VB2                                                              
*                                                                               
         L     R0,=A(VBTAB)                                                     
         L     R1,=A(VTOTSIZE*MAXLEVS)                                          
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         B     VBADDX                                                           
*                                                                               
VB2      DS    0H                                                               
         SR    R7,R7                                                            
         ICM   R7,7,1(R1)          A(RDBUFF BUFFALO RECORD)                     
         L     RF,ASORTDTA                                                      
         LA    R0,SORTREC                                                       
         SR    RF,R0                                                            
         AR    R7,RF               R7 NOW POINTS TO DATA AREA                   
*                                                                               
         L     RE,APRD             PRODUCT CODE                                 
         CLC   LASTPRD,0(RE)       SAME AS LAST?                                
         BE    VB2C                YES, SKIP GETTING VAT CODES FOR PROD         
         MVC   LASTPRD,0(RE)                                                    
*                                  GET PROPER PRODUCT CODE                      
         GOTO1 =A(SETCPVC),VBADMCB                                              
*                                                                               
VB2C     DS    0H                                                               
         XC    SVPPSTS,SVPPSTS                                                  
*                                                                               
         MVI   JUL10SW,C'Y'        SET JUL10SW TO Y IF MOS IS AFTER             
*                                  JUN/10                                       
         LA    R2,NVATCDS+1        NEW PST CODES                                
         L     RF,APER             PERIOD (MOS)                                 
         ZIC   R4,0(RF)                                                         
         SLL   R4,3                X 8                                          
         LA    R4,PERLIST(R4)                                                   
         CLC   0(2,R4),=X'6E07'    CHECK IF MOS JUL/10 OR LATER                 
         BNL   *+8                 IF SO TREAT LIKE PST FOR ALL PUBS            
         MVI   JUL10SW,C'N'                                                     
         CLI   JUL10SW,C'Y'                                                     
         BE    VB2C1                                                            
*                                  USING NEW PST CODES                          
         CLI   PROFB1A+0,C'Y'      TEST TO DO PST FOR ALL PUBS                  
         BNE   VB2C4                                                            
*                                                                               
*                                  SELECT 1ST PST                               
VB2CB    LA    R2,CVATCDS+1        IN CLT/PRD LIST                              
*                                                                               
VB2CB5   L     RE,APRD            SEE IF I HAVE A PRODUCT                       
         LTR   RE,RE                                                            
         BZ    VB2CC              NO - SKIP PRD CHECK                           
*                                 SHOULD PREVENT LOOPS                          
*                                                                               
         L     RF,ADPRD           IF PST NOT IN PRODUCT REC                     
         LR    R5,RF                                                            
         LA    R5,33(R5)                                                        
         MVI   ELCODE,X'25'                                                     
         BAS   RE,VNEXTEL                                                       
         BNE   VB2CC                                                            
         LA    R2,2(R5)          POINT TO PRODUCT'S PSTS                        
*                                                                               
VB2CC    DS    0H                                                               
*                                                                               
         CLI   JUL10SW,C'Y'       CHECK MOS (FROM APER) VS. JUL/10              
         BE    VB2C1              IF AFTER LEAVE CODES ALONE                    
*                                                                               
*        FOR PRIOR MOS DON'T HONOR BC NOR ON HST FOR                            
*        FOR THIS 'APPLY PST TO ALL PUBS' FEATURE                               
*        IN CASE THEY ADDED ON OR BC TO OLD PST LIST                            
*                                                                               
         MVI   0(R2),C' '         NO BC HST                                     
         MVI   4(R2),C' '         NOR ON HST                                    
*                                                                               
VB2C1    LA    R3,SVPPSTS                                                       
         LA    R0,NPROVS                                                        
*                                                                               
VB2C2    DS    0H                                                               
         CLI   0(R2),C' '          USE FIRST PST (NOT IDEAL)                    
         BNH   VB2C3                                                            
         MVC   0(1,R3),0(R2)                                                    
         B     VB2F                SET CODE AND SKIP STATION READ               
*                                                                               
VB2C3    DS    0H                                                               
         LA    R2,1(R2)            NEXT PROVINCE                                
         LA    R3,1(R3)                                                         
         BCT   R0,VB2C2                                                         
*****    DC    H'0'                NO VATS, SHOULD NOT HAPPEN                   
*****                              DON'T DIE JSUT FALL THROUGH                  
*                                                                               
VB2C4    DS    0H                                                               
         MVI   SVPPSTS+5,C'S'      ACTIVATE QST                                 
*                                                                               
         OC    MANGRS(12),MANGRS   SEE IF DOING A MANUAL BILL                   
         BNZ   VB2C4B              YES - CLEAR HSTS                             
*                                                                               
         MVI   SVPPSTS+0,C'H'      BRITISH COLUMBIA                             
         MVI   SVPPSTS+4,C'H'      ONTARIO                                      
         MVI   SVPPSTS+6,C'H'      NEW BRUNSWICK                                
         MVI   SVPPSTS+7,C'H'      NOVA SCOTIA                                  
         MVI   SVPPSTS+8,C'H'      P.E. ISLAND                                  
         MVI   SVPPSTS+9,C'H'      NEWFOUNFLAND                                 
         L     R4,APUB              CHK FOR PUB                                 
         LTR   R4,R4                                                            
         BZ    VB2F          NO PUB - LEAVE ALL SET                             
*                                                                               
         OC    0(6,R4),0(R4)    SEE IF PUB THERE                                
         BZ    VB2F          NO PUB - LEAVE ALL SET                             
*                                                                               
*                            FOR MANUAL BILLS  - ONLY QST FOR NOW               
*                            THIS MAY BE WRONG                                  
VB2C4B   DS    0H                                                               
         MVI   SVPPSTS+0,0         BRITISH COLUMBIA                             
         MVI   SVPPSTS+4,0         ONTARIO                                      
         MVI   SVPPSTS+6,0         NEW BRUNSWICK                                
         MVI   SVPPSTS+7,0         NOVA SCOTIA                                  
         MVI   SVPPSTS+8,0         P.E. ISLAND                                  
         MVI   SVPPSTS+9,0         NEWFOUNFLAND                                 
*                                                                               
         OC    MANGRS(12),MANGRS    THIS IS A MANUAL BILL                       
         BNZ   VB2F                 YES                                         
         CLC   XXPUB,0(R4)          OR PREVIUOU MANUAL BILL                     
         BE    VB2F                                                             
*                            FOR LUMPED PREVIOUSLY BILLED INSERTIONS            
*                            REACTIVATE ALL HSTS                                
*                            THIS IS PROBABLY UNNECESSARY                       
*                            BUT SHOULDN'T MATTER                               
         MVI   SVPPSTS+0,C'H'      BRITISH COLUMBIA                             
         MVI   SVPPSTS+4,C'H'      ONTARIO                                      
         MVI   SVPPSTS+6,C'H'      NEW BRUNSWICK                                
         MVI   SVPPSTS+7,C'H'      NOVA SCOTIA                                  
         MVI   SVPPSTS+8,C'H'      P.E. ISLAND                                  
         MVI   SVPPSTS+9,C'H'      NEWFOUNFLAND                                 
         CLC   0(6,R4),=X'FFFFFFFFFFFF'    PREVIOUSLY BILLED INS                
         BE    VB2F                 LUMPED TOGETHER                             
*                                                                               
         MVC   VBAWRK2(6),0(R4)                                                 
*                                                                               
         XC    SVPPSTS,SVPPSTS      CLEAR ALL PSTS                              
*                                                                               
         MVC   VBASAVK,KEY                                                      
         XC    KEY,KEY                                                          
         MVC   KEY(1),QMEDIA                                                    
         OC    AMED,AMED         SEE IF MULTI-MEDIA REQUEST                     
         BZ    VB2C4C                                                           
         L     RF,AMED           USE MEDIA FROM AMED                            
         MVC   KEY(1),0(RF)                                                     
*                                                                               
VB2C4C   DS    0H                                                               
         MVC   KEY+1(6),VBAWRK2         PUB                                     
         MVC   KEY+7(2),QAGENCY                                                 
         MVI   KEY+9,X'81'                                                      
         GOTO1 HIGHPUB                                                          
         CLC   KEY(25),KEYSAVE                                                  
         BE    VB2C4E                                                           
         L     RF,ADAGY                                                         
         CLI   PAGYPROF+16-PAGYREC(RF),C'0'    SEE IF USING DEFAULT             
         BNE   *+6                                                              
         DC    H'0'                 PUB NOT FOUND                               
         MVC   KEYSAVE+7(2),=C'ZZ'                                              
         CLC   KEYSAVE(25),KEY                                                  
         BE    VB2C4E                                                           
         MVC   KEY,KEYSAVE                                                      
         GOTO1 HIGHPUB                                                          
         CLC   KEY(25),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                 PUB NOT FOUND                               
*                                                                               
VB2C4E   DS    0H                                                               
         L     R4,ADPUB                                                         
         CLC   KEY(25),0(R4)       SEE IF ALREADY THERE                         
         BE    VB2C4F                                                           
         GOTO1 GETNAME                                                          
VB2C4F   DS    0H                                                               
*                                                                               
VB2D     DS    0H                                                               
         MVC   KEY,VBASAVK                                                      
         L     R5,ADPUB                                                         
         LA    R5,33(R5)                                                        
         MVI   ELCODE,X'90'                                                     
         BAS   RE,VNEXTEL                                                       
         BNE   VB2F                NOT FOUND                                    
         MVC   SVPPSTS,2(R5)       SAVE PUB PST CODES                           
*                                                                               
VB2F     DS    0H                                                               
         MVC   VBASVCDS,CVATCDS    SAVE VAT CODES                               
         CLI   JUL10SW,C'N'                                                     
         BE    *+10                                                             
         MVC   VBASVCDS,NVATCDS    USE NEW ONES                                 
*                                                                               
         LA    R3,SVPPSTS          PUB PST CODES                                
         LA    RE,VBASVCDS+1                                                    
         LA    R0,NPROVS                                                        
*                                                                               
VB3      DS    0H                  R3 POINTS TO PUB VAT LIST                    
         CLI   0(R3),C'0'          ZERO                                         
         BNE   *+8                                                              
         MVI   0(R3),0             BECOMES NULL                                 
         CLI   0(R3),C' '          IF NO PUB PST CODE                           
         BH    *+8                                                              
         MVI   0(RE),0             THEN NO PST - (BUT IF THERE IS PST           
*                                  THE CLT/PRD CODE IS PRESERVED ??'            
*                               ** NOTE THAT CODES THEMSELVES ARE               
*                                  NOT SET FROM PUB!                            
*                                                                               
VB4      DS    0H                                                               
         LA    RE,1(RE)                                                         
         LA    R3,1(R3)                                                         
         BCT   R0,VB3                                                           
*                                                                               
         LA    R2,VBASVCDS                                                      
         LA    R0,NPROVS+1                                                      
*                                                                               
VB6      DS    0H                                                               
         CLI   0(R2),C' '                                                       
         BNH   VB9                                                              
*                                                                               
         L     RF,APER             PERIOD (MOS)                                 
         ZIC   R5,0(RF)                                                         
         SLL   R5,3                X 8                                          
         LA    R5,PERLIST(R5)                                                   
         L     R4,=A(VCTAB)        VAT CODE TABLE                               
*                                                                               
         CLI   MANRVDTP,0              SEE IF REVERSAL                          
         BZ    VB6C                                                             
         CLC   MANRVDTP,=X'6A0701'  SEE IF ORIG. BILL WAS BEFORE                
         BL    VB6X                 JUL01/06 IF SO STILL USE OLD TABLE          
         L     R4,=A(VCTAB6)       JUL/06  VAT CODE TABLE                       
         CLC   MANRVDTP,=X'6C0101'  SEE IF ORIG. BILL WAS BEFORE                
         BL    VB6X                JAN01/08 IF SO STILL USE JUL/06              
         L     R4,=A(VCTAB8)      JAN01/08 VAT CODE TABLE                       
         CLC   MANRVDTP,=X'6E0501'  SEE IF ORIG. BILL WAS BEFORE                
         BL    VB6X                MAY01/10 IF SO STILL USE JAN/08              
         CLC   QAGENCY,=C'HD'      HDTO USES MAY01/10 FOR START                 
         BE    VB6A                                                             
         CLC   MANRVDTP,=X'6E0617'  SEE IF ORIG. BILL WAS BEFORE                
         BL    VB6X                JUN23/10 IF SO STILL USE JAN/08              
         CLC   QAGENCY,=C'PA'      PATO USES JUN23/10 FOR START                 
         BE    VB6A                                                             
         CLC   MANRVDTP,=X'6E0618'  SEE IF ORIG. BILL WAS BEFORE                
         BL    VB6X                JUN24/10 IF SO STILL USE JAN/08              
         CLC   QAGENCY,=C'H0'    MSHTOA USES JUN24/10 FOR START                 
         BE    VB6A                                                             
*                                                                               
         CLC   MANRVDTP,=X'6E061D'  SEE IF ORIG. BILL WAS BEFORE                
         BL    VB6X                JUN29/10 IF SO STILL USE JAN/08              
         CLC   QAGENCY,=C'OU'      OMD,M2,DONER,WASSERMAN START                 
         BE    VB6A                IS JUN29/10                                  
         CLC   QAGENCY,=C'U#'                                                   
         BE    VB6A                                                             
         CLC   QAGENCY,=C'DA'                                                   
         BE    VB6A                                                             
         CLC   QAGENCY,=C'S4'                                                   
         BE    VB6A                                                             
*                                  FOR ALL OTHER AGENCIES                       
         CLC   MANRVDTP,=X'6E0705'  SEE IF ORIG. BILL WAS BEFORE                
         BL    VB6X                JUL05/10 IF SO STILL USE JAN/08              
*                                                                               
VB6A     DS    0H                                                               
         L     R4,=A(VCTAB10)      USE JUN/10 TABLE                             
         CLC   QAGENCY,=C'HD'      SEE IF HDTO                                  
         BNE   VB6A5                                                            
         CLC   MANRVDTP,=X'6E0C01' FOR HDTO CHECK DEC1/2010                     
         BL    VB6X                                                             
         B     VB6A7                                                            
*                                                                               
VB6A5    CLC   MANRVDTP,=X'6F0101' SEE IF ORIG BILL WAS BEFORE JAN01/11         
         BL    VB6X                                                             
VB6A7    L     R4,=A(VCTAB11)      USE JAN/11 TABLE                             
         CLC   MANRVDTP,=X'700101' SEE IF ORIG BILL WAS BEFORE JAN01/12         
         BL    VB6X                                                             
         L     R4,=A(VCTAB12)      USE NEW TABLE                                
         CLC   MANRVDTP,=X'710101' SEE IF ORIG BILL WAS BEFORE JAN01/13         
         BL    VB6X                                                             
         L     R4,=A(VCTAB13)      USE NEW TABLE                                
         CLC   MANRVDTP,=X'710401' SEE IF ORIG BILL WAS BEFORE APR01/13         
         BL    VB6X                                                             
         L     R4,=A(VCTAB13R)     USE REVERSAL TABLE?                          
         CLC   MANRVDTP,=X'720A01' SEE IF ORIG BILL WAS BEFORE OCT01/14         
         BL    VB6X                                                             
         L     R4,=A(VCTAB13A)      USE NEW TABLE                               
         CLC   MANRVDTP,=X'740701'  SEE IF ORIG BILL WAS BEFORE JUL1/16         
         BL    VB6X                                                             
         L     R4,=A(VCTAB16)       USE NEW TABLE                               
         CLC   MANRVDTP,=X'740A01'  SEE IF ORIG BILL WAS BEFORE OCT1/16         
         BL    VB6X                                                             
         CLC   TODAYB,=X'740A01'    ARE WE AFTER OCT01/16?                      
         BL    VB6X                 IF NOT ALSO USE REVERSAL TABLE              
         L     R4,=A(VCTAB16A)      USE NEW TABLE                               
         B     VB6X                                                             
*                                                                               
VB6C     CLC   TODAYB,=X'6A0701'   ARE WE AFTER JUL01/06?                       
         BL    VB6X                                                             
         L     R4,=A(VCTAB6)       IF SO USE NEW TABLE                          
         CLC   TODAYB,=X'6C0101'   ARE WE AFTER JAN01/08?                       
         BL    VB6X                                                             
         L     R4,=A(VCTAB8)       IF SO USE NEW TABLE                          
         CLC   TODAYB,=X'6E0501'   ARE WE AFTER MAY1/10 (FOR TESTING)           
         BL    VB6X                                                             
*                                                                               
         CLC   QAGENCY,=C'HD'      HDTO - USE MAY01/2010 AS START OF            
         BE    VB6C5               USE OF NEW TABLE                             
*                                                                               
         CLC   TODAYB,=X'6E0617'   ARE WE ON OR AFTER JUN23/10?                 
         BL    VB6X                CHECK FOR PATO                               
         CLC   QAGENCY,=C'PA'      PATO - USE JUN23/2010 AS START OF            
         BE    VB6C5               USE OF NEW TABLE                             
*                                                                               
         CLC   TODAYB,=X'6E0618'   ARE WE ON OR AFTER JUN24/10?                 
         BL    VB6X                CHECK FOR MSHTOA                             
         CLC   QAGENCY,=C'H0'      MSHTOA USE JUN24/2010 AS START OF            
         BE    VB6C5               USE OF NEW TABLE                             
*                                                                               
         CLC   TODAYB,=X'6E061D'   ARE WE ON OR AFTER JUN29/10?                 
         BL    VB6X                CHECK FOR OU,U#,DA,S4                        
         CLC   QAGENCY,=C'OU'      THEY USE JUN29/2010 AS START OF              
         BE    VB6C5               USE OF NEW TABLE                             
         CLC   QAGENCY,=C'U#'                                                   
         BE    VB6C5                                                            
         CLC   QAGENCY,=C'DA'                                                   
         BE    VB6C5                                                            
         CLC   QAGENCY,=C'S4'                                                   
         BE    VB6C5                                                            
*                                                                               
         CLC   TODAYB,=X'6E0705'   ARE WE AFTER JUL05/10 FOR ALL OTHER          
         BL    VB6X                AGENCIES                                     
*                                                                               
VB6C5    CLC   QAGENCY,=C'HD'       IF HDTO SO USE NEW TABLE                    
         BE    VB6C6                                                            
         L     R4,=A(VCTAB10)                                                   
         CLC   TODAYB,=X'6F0101'   ARE WE AFTER JAN01/11?                       
         BL    VB6X                                                             
*                                                                               
VB6C6    DS    0H                                                               
         L     R4,=A(VCTAB11)                                                   
         CLC   TODAYB,=X'700101'   ARE WE BEFORE JAN01/2012?                    
         BL    VB6X                USE OLD TABLE                                
*                                                                               
VB6C7    L     R4,=A(VCTAB12)      USE NEW TABLE                                
         CLC   TODAYB,=X'710101'   ARE WE BEFORE JAN01/2013?                    
         BL    VB6X                USE OLD TABLE                                
         L     R4,=A(VCTAB13)      USE NEW TABLE                                
         CLC   TODAYB,=X'710401'   ARE WE BEFORE APR01/2013?                    
         BL    VB6X                USE OLD TABLE                                
         L     R4,=A(VCTAB13R)     USE REVERSAL TABLE (OLD)                     
         CLC   TODAYB,=X'720A01'   ARE WE BEFORE OCT01/2014?                    
         BL    VB6X                USE OLD TABLE                                
         L     R4,=A(VCTAB13A)     IF NOT USE NEW TABLE                         
         CLC   TODAYB,=X'740701'   ARE WE BEFORE JUL01/2016?                    
         BL    VB6X                USE OLD TABLE                                
         L     R4,=A(VCTAB16)      IF NOT USE NEW TABLE                         
         CLC   TODAYB,=X'740A01'   ARE WE BEFORE OCT01/2016?                    
         BL    VB6X                USE OLD TABLE                                
         L     R4,=A(VCTAB16A)     IF NOT USE NEW TABLE                         
         B     VB6X                                                             
*                                                                               
         USING VCTABD,R4                                                        
VB6X     LA    RE,NPROVS+1                                                      
         SR    RE,R0               PROVINCE NUMBER                              
*                                                                               
VB7      DS    0H                                                               
         CLM   RE,1,VCTPRV         PROVINCE                                     
         BNE   VB8                                                              
         CLC   VCTVCD,0(R2)        CODE                                         
         BNE   VB8                                                              
         CLC   0(2,R5),VCTSTRT     START MOS                                    
         BL    VB8                                                              
         CLC   0(2,R5),VCTEND      END MOS                                      
         BNH   VB8B                                                             
*                                                                               
VB8      DS    0H                                                               
         LA    R4,VCTABL(R4)       NEXT ENTRY                                   
         CLI   0(R4),X'FF'         END OF TABLE                                 
         BNE   VB7                                                              
         B     VB9                                                              
*                                                                               
VB8B     DS    0H                                                               
*                                 SAVE ENTRY IN MY WORK                         
         MVC   VBAPCTW(VCTABL),0(R4)                                            
*                                                                               
         CLI   0(R4),06            SEE IF QUEBEC                                
         BNE   VB8B5                                                            
         CLI   MANRVDTP,0              SEE IF REVERSAL                          
         BZ    VB8B5                                                            
         CLC   MANRVDTP,=X'5E0601'     SEE IF ORIG. BILL WAS BEFORE             
         BNL   VB8B3                   JUN01/94                                 
         OC    VBAPCTW+VCTABL-4(4),VBAPCTW+VCTABL-4                             
         BZ    VB8B5                                                            
         MVC   VBAPCTW+VCTABL-4(4),=AL4(4000)                                   
         B     VB8B5                                                            
*                                                                               
VB8B3    CLC   MANRVDTP,=X'620102'     SEE IF ORIG. BILL WAS BEFORE             
         BNL   VB8B4                   JAN02/98 SET % TO 6.5                    
         OC    VBAPCTW+VCTABL-4(4),VBAPCTW+VCTABL-4                             
         BZ    VB8B5                                                            
         MVC   VBAPCTW+VCTABL-4(4),=AL4(6500)                                   
         B     VB8B5                                                            
*                                                                               
VB8B4    CLC   MANRVDTP,=X'6F0101'     SEE IF ORIG. BILL WAS BEFORE             
         BNL   VB8B4F                  JAN01/11 SET % TO 7.5                    
*                                                                               
         CLC   QAGENCY,=C'HD'           SEE IF HDTO                             
         BNE   VB8B4C                  CHECK DEC1/10 INSTEAD                    
         CLC   MANRVDTP,=X'6E0C01'     SEE IF ORIG. BILL WAS BEFORE             
         BNL   VB8B4F                  DEC01/10 SET % TO 7.5                    
*                                                                               
VB8B4C   OC    VBAPCTW+VCTABL-4(4),VBAPCTW+VCTABL-4                             
         BZ    VB8B5                                                            
         MVC   VBAPCTW+VCTABL-4(4),=AL4(7500)                                   
         B     VB8B5                                                            
*                                                                               
VB8B4F   CLC   MANRVDTP,=X'700101'      SEE IF ORIGINAL BILL WAS                
         BNL   VB8B4H                   BEFORE JAN01/12                         
*                                                                               
         OC    VBAPCTW+VCTABL-4(4),VBAPCTW+VCTABL-4                             
         BZ    VB8B5                                                            
         MVC   VBAPCTW+VCTABL-4(4),=AL4(8500)                                   
         B     VB8B5                                                            
*                                                                               
VB8B4H   CLC   MANRVDTP,=X'710101'      SEE IF ORIGINAL BILL WAS                
         BNL   VB8B5                    BEFORE JAN01/13                         
*                                                                               
         OC    VBAPCTW+VCTABL-4(4),VBAPCTW+VCTABL-4                             
         BZ    VB8B5                                                            
         MVC   VBAPCTW+VCTABL-4(4),=AL4(9500)                                   
         B     VB8B5                                                            
*                                                                               
VB8B5    DS    0H                                                               
         DROP  R4                                                               
         LA    R4,VBAPCTW        POINT R4 TO MY ENTRY                           
         USING VCTABD,R4                                                        
*                                                                               
         L     RE,APER             PERIOD NUMBER                                
         ZIC   RF,0(RE)                                                         
         SR    RE,RE                                                            
         MH    RF,=Y(NPROVS+1)                                                  
*                                                                               
         LA    RE,NPROVS+1                                                      
         SR    RE,R0                                                            
         AR    RF,RE                                                            
         MH    RF,=Y(VBTABL)                                                    
*                                                                               
         L     RE,VBABRKC          POINT TO TOTALS FOR THIS LEVEL               
         L     RE,ATOTSV(RE)                                                    
         AR    RF,RE               PLUS DISP INTO TOTALS                        
         USING VBTABD,RF            VBTAB ENTRY                                 
         MVC   VBTPCT,VCTPCT       SET PERCENT                                  
         MVC   VBTCOD,VCTVCD       AND CODE                                     
*                                                                               
*              NOTE- HST IS CALCULATED BASED ON GROSS, NOT                      
*                    GROSS + GST, SO DON'T ADD TO GST FOR THOSE                 
*                    PROVINCES. (THIS CODE ASSUMES THAT NO STATION              
*                    HAS BOTH AN HST VAT AND A NON-HST VAT.                     
*                                                                               
         LA    RE,NPROVS+1         IS THIS THE GST PASS?                        
         CR    R0,RE               NO, OK                                       
         BNE   VB8C4               ELSE SKIP HST PROV'S                         
*                                                                               
         CLI   MANRVDTP,0                                                       
         BE    *+18                                                             
         CLC   MANRVDTP,=X'710401'                                              
         BNL   *+26                                                             
         B     *+14                                                             
         CLC   TODAYB,=X'710401'   SEE IF ON OR AFTER APR1/2013                 
         BNL   *+12                                                             
*                                                                               
         CLI   VBASVCDS+1,C' '     BRITISH COLUMBIA                             
         BH    VB8B7                                                            
         CLI   VBASVCDS+5,C' '     ONTARIO                                      
         BH    VB8B7                                                            
         CLI   VBASVCDS+7,C' '     NEW BRUNSWICK (#7)                           
         BH    VB8B8                                                            
         CLI   VBASVCDS+8,C' '     NOVA SCOTIA   (#8)                           
         BH    VB8B8                                                            
         CLI   VBASVCDS+9,C' '     P. E. ISLAND  (#9)                           
         BH    VB8B8                                                            
         CLI   VBASVCDS+10,C' '    NEWFOUNDLAND  (#10)                          
         BH    VB8B8                                                            
         B     VB8C4                                                            
*                                                                               
VB8B7    DS    0H          ON+BC  HST PROV - MUST CHECK DATE                    
         CLC   0(2,R5),=X'6E07'   IF BEFORE JUL/10 STILL DO GST                 
         BNL   VB9                                                              
         B     VB8C4                                                            
*                                                                               
VB8B8    DS    0H       NB+NS+NF  HST PROV - MUST CHECK DATE                    
         CLC   0(2,R5),=X'6104'   IF BEFORE APR/97 STILL DO GST                 
         BNL   VB9                                                              
*                                                                               
VB8C4    DS    0H                                                               
*                                                                               
         CLI   UPASS,X'FF'      FOR RETAIL SUMMARY PASS  - WAS C'S'             
         BE    VB8E                AMOUNTS ARE DIFFERENT                        
*                                                                               
         LA    RE,VBTBLBN          FOR BCT                                      
         LR    R6,R7               A(ORD/BILLED $)                              
*                                                                               
         TM    FINANSW,X'81'      SEE IF FINANCIAL/OR ANY TYPE COST2            
         BZ    *+8                                                              
         LA    R6,ROWTL(R6)       POINT TO OPEN ACCUMS                          
*                                                                               
VB8D     DS    0H                                                               
         L     R1,0(RF)                                                         
         A     R1,0(R6)            +ORDERED                                     
         S     R1,ROWHL(R6)        -BILLED                                      
         ST    R1,0(RF)                                                         
         LA    R6,4(R6)                                                         
         LA    RF,4(RF)                                                         
         BCT   RE,VB8D                                                          
         B     VB8F                                                             
*                                                                               
VB8E     DS    0H                  RETAIL SUMMARY PASS                          
*              **RETAIL SUMMARIES NOT HANDLED PROPERLY                          
*              **BUT NO ONE IN CANADA USES THEM                                 
         L     R1,0(RF)            GROSS                                        
         A     R1,4(R7)                                                         
         ST    R1,0(RF)                                                         
         L     R1,8(RF)            NET                                          
         A     R1,8(R7)                                                         
         ST    R1,8(RF)                                                         
*                                                                               
VB8F     DS    0H                  NOW DO FOR 'TOTAL' MONTH                     
         LA    RF,MAXMOS                                                        
         MH    RF,=Y(NPROVS+1)                                                  
*                                                                               
         LA    RE,NPROVS+1                                                      
         SR    RE,R0                                                            
         AR    RF,RE                                                            
         MH    RF,=Y(VBTABL)                                                    
*                                                                               
         L     RE,VBABRKC          POINT TO TOTALS FOR THIS LEVEL               
         L     RE,ATOTSV(RE)                                                    
         AR    RF,RE               PLUS DISP INTO TOTALS                        
         USING VBTABD,RF            VBTAB ENTRY                                 
         MVC   VBTPCT,VCTPCT       SET PERCENT                                  
         MVC   VBTCOD,VCTVCD       AND CODE                                     
*                                                                               
         CLI   UPASS,X'FF'         FOR RETAIL SUMMARY PASS - WAS C'S'           
         BE    VB8I                AMOUNTS ARE DIFFERENT                        
*                                                                               
         DROP  R4                                                               
         LA    RE,VBTBLBN          FOR BCT                                      
         LR    R6,R7               A(ORD/BILLED $)                              
*                                                                               
         TM    FINANSW,X'81'      SEE IF FINANCIAL/OR ANY TYPE COST2            
         BZ    *+8                                                              
         LA    R6,ROWTL(R6)       POINT TO OPEN ACCUMS                          
*                                                                               
VB8H     DS    0H                                                               
         L     R1,0(RF)                                                         
         A     R1,0(R6)            +ORDERED                                     
         S     R1,ROWHL(R6)        -BILLED                                      
         ST    R1,0(RF)                                                         
         LA    R6,4(R6)                                                         
         LA    RF,4(RF)                                                         
         BCT   RE,VB8H                                                          
         B     VB9                                                              
*                                                                               
VB8I     DS    0H                  RETAIL SUMMARY PASS                          
*              **CODE WILL SURELY HAVE TO BE CHANGED                            
*              **TO BETTER HANDLE RETAIL SUMMARIES PST                          
         L     R1,0(RF)            GROSS                                        
         A     R1,4(R7)                                                         
         ST    R1,0(RF)                                                         
         L     R1,8(RF)            NET                                          
         A     R1,8(R7)                                                         
         ST    R1,8(RF)                                                         
*                                                                               
VB9      DS    0H                                                               
         LA    R2,1(R2)                                                         
         BCT   R0,VB6                                                           
*                                                                               
         MVC   VBAMODE,=C'A '       VBADD MODE                                  
         GOTO1 =A(VBATRC),VBADMCB,(R8) TRACE                                    
         DROP  RF                                                               
*                                                                               
VBADDX   DS    0H                                                               
         XIT1                                                                   
*                                                                               
VNEXTEL  DS    0H                                                               
         CLI   0(R5),0         SEE IF AT END OF RECORD                          
         BE    VNXTELX                                                          
         ZIC   R0,1(R5)                                                         
         AR    R5,R0                                                            
         CLC   0(1,R5),ELCODE                                                   
         BER   RE                                                               
         B     VNEXTEL                                                          
*                                                                               
VNXTELX  LTR   RE,RE              RETURN WITH CC NOT EQUAL                      
         BR    RE                                                               
*                                                                               
         LTORG                                                                  
JUL10SW  DS    CL1                                                              
*                                                                               
VBAPCTW  DS    CL20               WORK AREA VCTAB ENTRY                         
*                                                                               
VBAWRKD  DSECT                                                                  
VBADMCB  DS    6F                                                               
VBAWORK  DS    XL64                                                             
VBAWRK2  DS    XL64                                                             
VBASAVK  DS    XL64                                                             
VBAPARMS DS    XL24                                                             
VBASVR1  DS    F                                                                
VBABRKC  DS    F                                                                
VBABRK   DS    F                                                                
VBASVGST DS    F                                                                
VBASVGSP DS    F                                                                
VBALINE  DS    A                                                                
VBADUB   DS    D                                                                
VBAFULL  DS    F                                                                
VBAHALF  DS    H                                                                
VBABYTE  DS    XL1                                                              
VBBBYTE  DS    XL1                                                              
VBASVCDS DS    XL11                                                             
VBAPASS  DS    XL1                                                              
VBAMODE  DS    CL2                                                              
VBPRMODE DS    C                                                                
VBAWRKL  EQU   *-VBAWRKD                                                        
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBATRC   TRACE VBTAB                                                   
*                                                                               
*                                                                               
***********************************************************************         
PPB102   CSECT                                                                  
         SPACE 2                                                                
         PRINT NOGEN                                                            
VBATRC   NMOD1 VBAWRKL,VBATRC                                                   
         USING PPWORKD,RA                                                       
         USING PPWORK2D,R9                                                      
         USING BILWRKD,RC                                                       
         LA    RC,SPACEND                                                       
*                                                                               
         L     R8,0(R1)            VBATRC CALLERS VBAWRKD                       
         USING VBAWRKD,R8                                                       
         ST    R1,VBASVR1                                                       
         SPACE 2                                                                
         L     RF,APATCH           TRACE?                                       
         TM    0(RF),X'40'                                                      
         BZ    VBATRCX                                                          
*                                                                               
         MVC   P1,SPACES                                                        
         GOTO1 =A(PRNT)                                                         
*                                                                               
         CLC   VBAMODE,=C'A '        VBADD MODE                                 
         BNE   VBATR3                                                           
         MVC   P1(2),=C'VB'                                                     
         MVC   P1+3(5),VBAWRK2     PUB                                          
         GOTO1 HEXOUT,VBADMCB,(R5),P1+9,2,=C'N'                                 
         GOTO1 (RF),(R1),CVATCDS,P1+14,11,=C'N'                                 
         GOTO1 (RF),(R1),SVPPSTS,P1+38,10,=C'N'                                 
         GOTO1 =A(PRNT)                                                         
*                                                                               
VBATR3   DS    0H                                                               
         LA    R2,P1                                                            
         L     R4,VBABRKC                                                       
         L     R4,ATOTSV(R4)                                                    
         SR    R5,R5                                                            
         LA    R3,(NPROVS+1)*(MAXMOS+1)                                         
         MVC   0(2,R2),=C'VB'                                                   
         MVC   2(2,R2),VBAMODE                                                  
         CLC   VBAMODE,=C'RU'        FOR ROLLUP SKIP IF                         
         BNE   VBATR4                                                           
         OC    VBABRKC,VBABRKC     AT FINAL ONE BECAUSE ITS MEANINGLESS         
         BNZ   VBATR4                                                           
         MVC   11(2,R2),=C'00'                                                  
         GOTO1 =A(PRNT)                                                         
         B     VBATR9                                                           
*                                                                               
VBATR4   DS    0H                                                               
         OC    0(VBTABL,R4),0(R4)                                               
         BZ    VBATR8                                                           
         LR    RF,R5                                                            
         SR    RE,RE                                                            
         D     RE,=A(NPROVS+1)                                                  
         LA    RF,1(RF)                      RF = PERIOD                        
         EDIT  (RF),(2,5(R2)),ZERO=NOBLANK                                      
         EDIT  (RE),(2,8(R2)),ZERO=NOBLANK   RE=PROVINCE                        
         GOTO1 HEXOUT,VBADMCB,VBABRKC+3,12(R2),1,=C'N' BRK CODE                 
         GOTO1 (RF),(R1),(R4),15(R2),VBTABL                                     
         GOTO1 =A(PRNT)                                                         
*                                                                               
VBATR8   DS    0H                                                               
         LA    R5,1(R5)                                                         
         LA    R4,VBTABL(R4)                                                    
         BCT   R3,VBATR4                                                        
*                                                                               
VBATR9   DS    0H                                                               
*                                                                               
VBATRCX  DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBADJ    SET COMMISSION ADJUSTMENTS AND                                
*                 AMOUNT DUE IN VBTAB                                           
*                                                                               
*        PARM1  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(BILL FORMULA) 5 BYTES                               
*        PARM2  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(PERLIST ENTRY)                                      
*        PARM3  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(BRKTAB ENTRY)                                       
*                                                                               
***********************************************************************         
         SPACE 2                                                                
         PRINT NOGEN                                                            
VBADJ    NMOD1 VBAWRKL,VBADJ                                                    
         USING PPWORKD,RA                                                       
         USING PPWORK2D,R9                                                      
         LR    R8,RC                                                            
         USING VBAWRKD,R8                                                       
         USING BILWRKD,RC                                                       
         LA    RC,SPACEND                                                       
*                                                                               
         L     R3,8(R1)                                                         
         ST    R3,VBABRK           SAVE A(BREAK TABLE ENTRY)                    
         MVC   VBABRKC,BRKCODE-BRKTABD(R3)                                      
         ST    R1,VBASVR1          SAVE R1                                      
         SPACE 2                                                                
*                                                                               
         L     RF,0(R1)            A(BILL FORMULA)                              
         MVC   VBABYTE,0(RF)         BASIS                                      
         MVC   VBBBYTE,1(RF)         ADJ BASIS                                  
         XC    VBAFULL,VBAFULL                                                  
         MVC   VBAFULL+1(3),2(RF)      ADJUSTMENT PERCENT                       
         TM    2(RF),X'F0'             SEE IF NEGATIVE                          
         BNO   *+8                                                              
         MVI   VBAFULL,X'FF'                                                    
*                                                                               
         L     RF,=F'1000000'                                                   
*                                                                               
VBJ3     DS    0H                                                               
         L     R1,VBASVR1                                                       
         L     R1,4(R1)            A(PERLIST ENTRY)                             
         LA    R0,PERLIST                                                       
         SR    R1,R0                                                            
         SR    R0,R0                                                            
         D     R0,=F'8'            8 BYTES PER PERLIST ENTRY                    
*                                                                               
VBJ3B    DS    0H                                                               
         MH    R1,=Y((NPROVS+1)*VBTABL)     X NO. OF PROVINCES AND NAT          
         L     R2,VBABRKC                                                       
         L     R2,ATOTSV(R2)                                                    
         AR    R2,R1               R2 POINTS TO MONTH                           
         USING VBTABD,R2                                                        
*                                                                               
         LA    R1,MAXMOS                                                        
         MH    R1,=Y((NPROVS+1)*VBTABL)     X NO. OF PROVINCES AND NAT          
         L     R6,VBABRKC                                                       
         L     R6,ATOTSV(R6)                                                    
         AR    R6,R1               R6 POINTS TO TOTAL MONTH ROW                 
*                                                                               
         LA    R3,NPROVS+1                                                      
*                                                                               
VBJ4     DS    0H                                                               
*                                                                               
         CLI   CDSEP,C'Y'          SEE IF CD ON SEPERATE BILL                   
         BNE   VBJ4C                                                            
         NI    VBABYTE,X'FB'      SET OFF CD IN FORMULA                         
         B     VBJ4X                                                            
*                                                                               
VBJ4C    CLI   SCBNCSW,C'C'        SEE IF UFC COMM BILL                         
         BNE   VBJ4X                                                            
         CLI   PROFB2B+4,C'Y'      SEE IF CD IS ON NET BILL                     
         BNE   VBJ4X                                                            
         NI    VBABYTE,X'FB'       SET CD OFF                                   
*                                                                               
VBJ4X    DS    0H                                                               
         L     R4,VBTGRS           BASIS IS GROSS                               
         TM    VBABYTE,X'01'                                                    
         BO    VBJ4X5                                                           
         L     R4,VBTNET           OR NET                                       
         TM    VBABYTE,X'02'                                                    
         BO    VBJ4X5                                                           
         L     R4,VBTAC            MUST BE AC                                   
*                                                                               
VBJ4X5   DS    0H                                                               
         TM    VBABYTE,X'04'       SEE IF SUBTRACTING CD                        
         BZ    VBJ6                                                             
         S     R4,VBTCD                                                         
*                                                                               
VBJ6     L     R1,VBTGRS           ADJUSTMENT BASIS IS GROSS                    
         TM    VBBBYTE,X'01'                                                    
         BO    VBJ6C                                                            
         L     R1,VBTNET           OR NET                                       
         TM    VBBBYTE,X'02'                                                    
         BO    VBJ6C                                                            
         L     R1,VBTAC            MUST BE CD                                   
*                                                                               
VBJ6C    DS    0H                                                               
         TM    VBBBYTE,X'04'       SEE IF SUBTRACTING CD FROM BASIS             
         BZ    *+8                                                              
         S     R1,VBTCD                                                         
*                                                                               
         CLI   TAXOPT,C'N'         OPTION TO REMOVE TAX                         
         BE    VBJ6F                                                            
         TM    VBBBYTE,X'08'      SEE IF AC                                     
         BO    VBJ6F              YES - THEN DON'T SUBTRACT TAX                 
         S     R1,VBTTAX                                                        
*                                                                               
VBJ6F    DS    0H                                                               
         M     R0,VBAFULL                                                       
         BAS   RE,VBJDIV                                                        
         ST    R1,VBTADJ           CALCULATED ADJUSTMENT AMOUNT                 
         AR    R4,R1               BASIS PLUS ADJ = DUE                         
         ST    R4,VBTDUE                                                        
*                                                                               
         A     R1,VBTADJ-VBTABD(R6)  ADD TO TOTAL ROW                           
         ST    R1,VBTADJ-VBTABD(R6)                                             
         A     R4,VBTDUE-VBTABD(R6)                                             
         ST    R4,VBTDUE-VBTABD(R6)                                             
*                                                                               
VBJ8     DS    0H                                                               
         LA    R2,VBTABL(R2)       NEXT PROVINCE                                
         LA    R6,VBTABL(R6)                                                    
         BCT   R3,VBJ4                                                          
*                                                                               
VBJ10    DS    0H                                                               
         MVC   VBAMODE,=C'J '        VBADJ MODE                                 
         GOTO1 =A(VBATRC),VBADMCB,(R8)                                          
*                                                                               
VBJX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
VBJDIV   DRNDR (R0),(RF)                                                        
         BR    RE                                                               
         DROP  R2                                                               
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBCALC   CALC VAT AMOUNTS AND ADD INTO WKROW                           
*                                                                               
*        PARM1  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(PERLIST ENTRY)                                      
*        PARM2  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(MONTH CUME SLOT - ATOTS)                            
*        PARM3  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(BRKTAB ENTRY)                                       
*                                                                               
*        NOTE - VAT IS CALCULATED FOR THE GIVEN MONTH AND                       
*               TOTALED IN WKROW TO STAY COMPATIBLE WITH OLD BILCALC.           
*               IT IS ALSO SET AT VATDSP IN THE REGULAR ACCUME (AT R7).         
*                                                                               
***********************************************************************         
         SPACE 2                                                                
         PRINT NOGEN                                                            
VBCALC   NMOD1 VBAWRKL,VBCALC                                                   
         USING PPWORKD,RA                                                       
         USING PPWORK2D,R9                                                      
         LR    R8,RC                                                            
         USING VBAWRKD,R8                                                       
         USING BILWRKD,RC                                                       
         LA    RC,SPACEND                                                       
*                                                                               
         L     R7,4(R1)            A(MONTH CUME CLOT)                           
         L     R3,8(R1)                                                         
         ST    R3,VBABRK           SAVE A(BREAK TABLE ENTRY)                    
         MVC   VBABRKC,BRKCODE-BRKTABD(R3)                                      
         ST    R1,VBASVR1                                                       
*                                                                               
*                                                                               
         XC    VBASVGSP,VBASVGSP                                                
*                                                                               
         L     RF,0(R1)                                                         
         LA    R0,PERLIST                                                       
         SR    RE,RE                                                            
         SR    RF,R0                                                            
         D     RE,=F'8'            PERLIST ENTRY IS 8 LONG                      
         MH    RF,=Y((NPROVS+1)*VBTABL)                                         
         L     R2,VBABRKC                                                       
         L     R2,ATOTSV(R2)                                                    
         AR    R2,RF                                                            
         USING VBTABD,R2                                                        
*                                                                               
         LA    R3,NPROVS+1                                                      
         LA    R5,WKROW                                                         
         L     RF,=F'100000'                                                    
*                                                                               
VBC4     DS    0H                                                               
         CLI   VBTCOD,C' '         SKIP IF NO VAT CODE                          
         BE    VBC8                                                             
         L     R1,VBTDUE           DUE AMOUNT                                   
         CLI   SCBNCSW,C'C'        IF SCB COMMISSIION BILL                      
         BNE   VBC6                                                             
         S     R1,VBTNET           THEN LESS NET                                
         B     VBC6A               (BUT DON'T SUBTRACT TAX FROM DUE)            
*                                                                               
VBC6     DS    0H                                                               
         S     R1,VBTTAX           LESS TAX (SALES)                             
VBC6A    CLI   ADJSEP,C'Y'         IF ADJ ON SEP INV                            
         BNE   *+8                                                              
         S     R1,VBTADJ           THEN LESS ADJ                                
*                                                                               
         CH    R3,=Y(NPROVS+1)     UNLESS DOING GST NOW                         
         BE    VBC6B                                                            
*                                                                               
*        HST BASE IS GROSS NOT GROSS+GST                                        
*                                                                               
*                                                                               
         CLI   MANRVDTP,0                                                       
         BE    *+18                                                             
         CLC   MANRVDTP,=X'710401'                                              
         BNL   *+26                                                             
         B     *+14                                                             
         CLC   TODAYB,=X'710401'   SEE IF ON OR AFTER APR1/2013                 
         BNL   *+12                                                             
*                                                                               
         CH    R3,=Y(NPROVS+1-1)   BRITISH COLUMBIA (1)                         
         BE    VBC6B                                                            
         CH    R3,=Y(NPROVS+1-5)   ONTARIO (5)                                  
         BE    VBC6B                                                            
         CH    R3,=Y(NPROVS+1-7)   NEW BRUNSWICK  (7)                           
         BE    VBC6B                                                            
         CH    R3,=Y(NPROVS+1-8)   NOVA SCOTIA    (8)                           
         BE    VBC6B                                                            
         CH    R3,=Y(NPROVS+1-9)   P.E. ISLAND   (9)                            
         BE    VBC6B                                                            
         CH    R3,=Y(NPROVS+1-10)  NEWFOUNDLAND   (10)                          
         BE    VBC6B                                                            
*                                                                               
         CH    R3,=Y(NPROVS+1-6)   QUEBEC (06)                                  
         BNE   VBC6AQ                                                           
*                                                                               
         CLI   MANRVDTP,0           ARE WE REVERSING?                           
         BE    VBC6AR                                                           
         CLC   MANRVDTP,=X'710101'  BILL BEFORE JAN01/2013?                     
         BL    VBC6AQ               YES - APPLY GST                             
         B     VBC6B                NO - DON'T APPLY GST                        
*                                                                               
VBC6AR   CLC   TODAYB,=X'710101'   ARE WE BEFORE JAN01/2013?                    
         BL    VBC6AQ              YES - APPLY GST                              
         B     VBC6B               NO - DON'T APPLY GST                         
*                                                                               
VBC6AQ   ICM   R0,15,VBASVGSP      FIRST APPLY GST TO GET BASIS                 
         A     R0,=F'100000'                                                    
         MR    R0,R0                                                            
         BAS   RE,VBCDIV                                                        
*                                                                               
VBC6B    DS    0H                                                               
         ST    R1,VBTVATB          STORE BASIS IN VBTAB                         
         LR    RE,R1                    VAT BASIS                               
         ST    RE,VATBDSP(R7)          SET IN MONTH CUME ROW                    
         A     RE,VATBDSP-EXTDSP(R5)   AND TOTAL IN WKROW                       
         ST    RE,VATBDSP-EXTDSP(R5)                                            
*                                                                               
VBC6D    DS    0H                                                               
         ICM   R0,15,VBTPCT        TIMES VAT PCT (N.NNN)                        
         MR    R0,R0                                                            
         BAS   RE,VBCDIV                                                        
         ST    R1,VBTVAT                                                        
         CH    R3,=Y(NPROVS+1)     IF DOING GST NOW                             
         BNE   *+10                                                             
         MVC   VBASVGSP,VBTPCT     SAVE ACTUAL GST %                            
         ST    R1,VATDSP(R7)       SET IN MONTH CUME ROW                        
         A     R1,VATDSP-EXTDSP(R5)    AND TOTAL IN WKROW                       
         ST    R1,VATDSP-EXTDSP(R5)                                             
*                                                                               
VBC8     DS    0H                                                               
         LA    R2,VBTABL(R2)       NEXT PROVINCE                                
         LA    R5,4(R5)            NEXT WKROW SLOT                              
         LA    R7,4(R7)            NEXT ACCUM SLOT                              
         BCT   R3,VBC4                                                          
*                                                                               
         MVC   VBAMODE,=C'C '        VBCALC MODE                                
         GOTO1 =A(VBATRC),VBADMCB,(R8)                                          
*                                                                               
VBCALCX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
VBCDIV   DRNDR (R0),(RF)                                                        
         BR    RE                                                               
         DROP  R2                                                               
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBCALCJ  CALC VAT AMOUNTS FOR SEP COMM BILLS                           
*                 AND ADD INTO WKROW                                            
*                                                                               
*        PARM1  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(PERLIST ENTRY)                                      
*        PARM2  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(MONTH CUME SLOT - ATOTS)                            
*        PARM3  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(BRKTAB ENTRY)                                       
*                                                                               
*        NOTE - VAT IS CALCULATED FOR THE GIVEN MONTH AND                       
*               TOTALED IN WKROW TO STAY COMPATIBLE WITH OLD BILCALC.           
*               IT IS ALSO SET AT VATCDSP IN THE REGULAR CUME (AT R7).          
*             **IT IS NOT STORED IN THE VBTAB                                   
*                                                                               
***********************************************************************         
         SPACE 2                                                                
         PRINT NOGEN                                                            
VBCALCJ  NMOD1 VBAWRKL,VBCALCJ                                                  
         USING PPWORKD,RA                                                       
         USING PPWORK2D,R9                                                      
         LR    R8,RC                                                            
         USING VBAWRKD,R8                                                       
         USING BILWRKD,RC                                                       
         LA    RC,SPACEND                                                       
*                                                                               
         L     R7,4(R1)            A(MONTH CUME CLOT)                           
         L     R3,8(R1)                                                         
         ST    R3,VBABRK           SAVE A(BREAK TABLE ENTRY)                    
         MVC   VBABRKC,BRKCODE-BRKTABD(R3)                                      
         ST    R1,VBASVR1                                                       
         SPACE 2                                                                
*                                                                               
         L     RF,0(R1)                                                         
         LA    R0,PERLIST                                                       
         SR    RE,RE                                                            
         SR    RF,R0                                                            
         D     RE,=F'8'            PERLIST ENTRY IS 8 LONG                      
         MH    RF,=Y((NPROVS+1)*VBTABL)                                         
         L     R2,VBABRKC                                                       
         L     R2,ATOTSV(R2)                                                    
         AR    R2,RF                                                            
         USING VBTABD,R2                                                        
*                                                                               
         LA    R3,NPROVS+1                                                      
         LA    R5,WKROW                                                         
         L     RF,=F'100000'                                                    
*                                                                               
VBCJ4    DS    0H                                                               
         L     R1,VBTADJ           CALC VAT OF COMM ADJ                         
         CH    R3,=Y(NPROVS+1)     UNLESS DOING GST NOW                         
         BE    VBCJ4B                                                           
*                                  FIRST APPLY GST TO GET BASIS                 
*                                  BUT FOR HST PROV'S BASE IS                   
*                                  GROSS, NOT GROSS+GST                         
*                                                                               
         CLI   MANRVDTP,0                                                       
         BE    *+18                                                             
         CLC   MANRVDTP,=X'710401'                                              
         BNL   *+26                                                             
         B     *+14                                                             
         CLC   TODAYB,=X'710401'   SEE IF ON OR AFTER APR1/2013                 
         BNL   *+12                                                             
*                                                                               
         CH    R3,=Y(NPROVS+1-1)   BRITISH COLUMBIA (1)                         
         BE    VBCJ4B                                                           
         CH    R3,=Y(NPROVS+1-5)   ONTARIO (5)                                  
         BE    VBCJ4B                                                           
         CH    R3,=Y(NPROVS+1-7)   NEW BRUNSWICK (#7)                           
         BE    VBCJ4B                                                           
         CH    R3,=Y(NPROVS+1-8)   NOVA SCOTIA   (#8)                           
         BE    VBCJ4B                                                           
         CH    R3,=Y(NPROVS+1-9)   P.E. ISLAND   (#9)                           
         BE    VBCJ4B                                                           
         CH    R3,=Y(NPROVS+1-10)  NEWFOUNDLAND  (#10)                          
         BE    VBCJ4B                                                           
*                                                                               
         CH    R3,=Y(NPROVS+1-6)   QUEBEC (06)                                  
         BNE   VBCJ4AQ             NO - APPLY GST OTHER PROV                    
*                                                                               
         CLI   MANRVDTP,0           REVERSING?                                  
         BE    VBCJ4AR                                                          
         CLC   MANRVDTP,=X'710101'  BILL BEFORE JAN01/2013?                     
         BL    VBCJ4AQ              YES - APPLY GST                             
         B     VBCJ4B               NO - DON'T APPLY GST                        
*                                                                               
VBCJ4AR  CLC   TODAYB,=X'710101'   ARE WE BEFORE JAN01/2013?                    
         BL    VBCJ4AQ             YES - APPLY GST                              
         B     VBCJ4B              NO - DON'T APPLY GST                         
*                                                                               
VBCJ4AQ  ICM   R0,15,VBASVGSP      FIRST APPLY GST TO GET BASIS                 
         A     R0,=F'100000'                                                    
         MR    R0,R0                                                            
         BAS   RE,VBCJDIV                                                       
*                                                                               
VBCJ4B   DS    0H                                                               
         LR    RE,R1                    VAT BASIS                               
         ST    RE,VATCBDSP(R7)          SET IN MONTH CUME ROW                   
         A     RE,VATCBDSP-EXTDSP(R5)   AND TOTAL IN WKROW                      
         ST    RE,VATCBDSP-EXTDSP(R5)                                           
*                                                                               
         ICM   R0,15,VBTPCT                                                     
         MR    R0,R0                                                            
         BAS   RE,VBCJDIV                                                       
*                   **NOTE-SEP COMM VAT NOT IN VBTAB                            
         CH    R3,=Y(NPROVS+1)     IF DOING GST NOW                             
         BNE   *+10                                                             
         MVC   VBASVGSP,VBTPCT     SAVE GST AMOUNT                              
         ST    R1,VATCDSP(R7)      SET IN MONTH CUME ROW                        
         A     R1,VATCDSP-EXTDSP(R5)   AND TOTAL IN WKROW                       
         ST    R1,VATCDSP-EXTDSP(R5)                                            
*                                                                               
VBCJ8    DS    0H                                                               
         LA    R2,VBTABL(R2)       NEXT PROVINCE                                
         LA    R5,4(R5)            NEXT WKROW SLOT                              
         LA    R7,4(R7)            NEXT ACCUM SLOT                              
         BCT   R3,VBCJ4                                                         
*                                                                               
         MVC   VBAMODE,=C'CJ'        VBCALC MODE - SEP ADJ                      
         GOTO1 =A(VBATRC),VBADMCB,(R8)                                          
*                                                                               
VBCJALCX DS    0H                                                               
         XIT1                                                                   
*                                                                               
VBCJDIV  DRNDR (R0),(RF)                                                        
         BR    RE                                                               
         DROP  R2                                                               
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBCALCD  CALC VAT AMOUNTS FOR SEP CD BILLS                             
*                 AND ADD INTO WKROW                                            
*                                                                               
*        PARM1  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(PERLIST ENTRY)                                      
*        PARM2  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(MONTH CUME SLOT - ATOTS)                            
*        PARM3  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(BRKTAB ENTRY)                                       
*                                                                               
*        NOTE - VAT IS CALCULATED FOR THE GIVEN MONTH AND                       
*               TOTALED IN WKROW TO STAY COMPATIBLE WITH OLD BILCALC.           
*               IT IS ALSO SET AT VATDDSP IN THE REGULAR CUME (AT R7).          
*             **IT IS NOT STORED IN THE VBTAB                                   
*                                                                               
***********************************************************************         
         SPACE 2                                                                
         PRINT NOGEN                                                            
VBCALCD  NMOD1 VBAWRKL,VBCALCD                                                  
         USING PPWORKD,RA                                                       
         USING PPWORK2D,R9                                                      
         LR    R8,RC                                                            
         USING VBAWRKD,R8                                                       
         USING BILWRKD,RC                                                       
         LA    RC,SPACEND                                                       
*                                                                               
         L     R7,4(R1)            A(MONTH CUME CLOT)                           
         L     R3,8(R1)                                                         
         ST    R3,VBABRK           SAVE A(BREAK TABLE ENTRY)                    
         MVC   VBABRKC,BRKCODE-BRKTABD(R3)                                      
         ST    R1,VBASVR1                                                       
         SPACE 2                                                                
*                                                                               
         L     RF,0(R1)                                                         
         LA    R0,PERLIST                                                       
         SR    RE,RE                                                            
         SR    RF,R0                                                            
         D     RE,=F'8'            PERLIST ENTRY IS 8 LONG                      
         MH    RF,=Y((NPROVS+1)*VBTABL)                                         
         L     R2,VBABRKC                                                       
         L     R2,ATOTSV(R2)                                                    
         AR    R2,RF                                                            
         USING VBTABD,R2                                                        
*                                                                               
         LA    R3,NPROVS+1                                                      
         LA    R5,WKROW                                                         
         L     RF,=F'100000'                                                    
*                                                                               
VBDJ4    DS    0H                                                               
         L     R1,VBTCD            CALC VAT OF CD                               
         CH    R3,=Y(NPROVS+1)     UNLESS DOING GST NOW                         
         BE    VBDJ4B                                                           
*                                                                               
         CLI   MANRVDTP,0                                                       
         BE    *+18                                                             
         CLC   MANRVDTP,=X'710401'                                              
         BNL   *+26                                                             
         B     *+14                                                             
         CLC   TODAYB,=X'710401'   SEE IF ON OR AFTER APR1/2013                 
         BNL   *+12                                                             
*                                                                               
         CH    R3,=Y(NPROVS+1-1)   BRITISH COLUMBIA (1)                         
         BE    VBDJ4B                                                           
         CH    R3,=Y(NPROVS+1-5)   ONTARIO (5)                                  
         BE    VBDJ4B                                                           
         CH    R3,=Y(NPROVS+1-7)   NEW BRUNSWICK  (7)                           
         BE    VBDJ4B                                                           
         CH    R3,=Y(NPROVS+1-8)   NOVA SCOTIA    (8)                           
         BE    VBDJ4B                                                           
         CH    R3,=Y(NPROVS+1-9)   P.E. ISLAND    (9)                           
         BE    VBDJ4B                                                           
         CH    R3,=Y(NPROVS+1-10)  NEWFOUNDLAND   (10)                          
         BE    VBDJ4B                                                           
*                                                                               
         CH    R3,=Y(NPROVS+1-6)   QUEBEC (06)                                  
         BNE   VBDJ4AQ             NO - APPLY GST OTHER PROV                    
*                                                                               
         CLI   MANRVDTP,0          REVERSING?                                   
         BE    VBDJ4AR             NO - CHECK TODAY                             
         CLC   MANRVDTP,=X'710101' BILL BEFORE JAN01/2013?                      
         BL    VBDJ4AQ             YES- APPLY GST                               
         B     VBDJ4B              NO - DON'T APPLY GST                         
*                                                                               
VBDJ4AR  CLC   TODAYB,=X'710101'   ARE WE BEFORE JAN01/2013?                    
         BL    VBDJ4AQ             YES - APPLY GST                              
         B     VBDJ4B              NO - DON'T APPLY GST                         
*                                                                               
VBDJ4AQ  ICM   R0,15,VBASVGSP      FIRST APPLY GST TO GET BASIS                 
         A     R0,=F'100000'                                                    
         MR    R0,R0                                                            
         BAS   RE,VBDJDIV                                                       
*                                                                               
VBDJ4B   DS    0H                                                               
         LR    RE,R1                    VAT BASIS                               
         ST    RE,VATDBDSP(R7)          SET IN MONTH CUME ROW                   
         A     RE,VATDBDSP-EXTDSP(R5)   AND TOTAL IN WKROW                      
         ST    RE,VATDBDSP-EXTDSP(R5)                                           
*                                                                               
         ICM   R0,15,VBTPCT                                                     
         MR    R0,R0                                                            
         BAS   RE,VBDJDIV                                                       
*                   **NOTE-SEP CD VAT NOT IN VBTAB                              
         CH    R3,=Y(NPROVS+1)     IF DOING GST NOW                             
         BNE   *+10                                                             
         MVC   VBASVGSP,VBTPCT     SAVE GST AMOUNT                              
         ST    R1,VATDDSP(R7)      SET IN MONTH CUME ROW                        
         A     R1,VATDDSP-EXTDSP(R5)   AND TOTAL IN WKROW                       
         ST    R1,VATDDSP-EXTDSP(R5)                                            
*                                                                               
VBDJ8    DS    0H                                                               
         LA    R2,VBTABL(R2)       NEXT PROVINCE                                
         LA    R5,4(R5)            NEXT WKROW SLOT                              
         LA    R7,4(R7)            NEXT ACCUM SLOT                              
         BCT   R3,VBDJ4                                                         
*                                                                               
         MVC   VBAMODE,=C'CD'        VBCALC MODE - SEP CD                       
         GOTO1 =A(VBATRC),VBADMCB,(R8)                                          
*                                                                               
VBDJALCX DS    0H                                                               
         XIT1                                                                   
*                                                                               
VBDJDIV  DRNDR (R0),(RF)                                                        
         BR    RE                                                               
         DROP  R2                                                               
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBCALCA  CALC VAT AMOUNTS FOR AOR BILLS                                
*                 AND ADD INTO WKROW                                            
*                                                                               
*        PARM1  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(PERLIST ENTRY)                                      
*        PARM2  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(MONTH CUME SLOT - ATOTS)                            
*        PARM3  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(BRKTAB ENTRY)                                       
*                                                                               
*        NOTE - VAT IS CALCULATED FOR THE GIVEN MONTH AND                       
*               TOTALED IN WKROW TO STAY COMPATIBLE WITH OLD BILCALC.           
*               IT IS ALSO SET AT VATADSP IN THE REGULAR CUME (AT R7).          
*             **IT IS NOT STORED IN THE VBTAB                                   
*                                                                               
***********************************************************************         
         SPACE 2                                                                
         PRINT GEN                                                              
VBCALCA  NMOD1 VBAWRKL,VBCALCA                                                  
         USING PPWORKD,RA                                                       
         USING PPWORK2D,R9                                                      
         LR    R8,RC                                                            
         USING VBAWRKD,R8                                                       
         USING BILWRKD,RC                                                       
         LA    RC,SPACEND                                                       
*                                                                               
         L     R7,4(R1)            A(MONTH CUME CLOT)                           
         L     R3,8(R1)                                                         
         ST    R3,VBABRK           SAVE A(BREAK TABLE ENTRY)                    
         MVC   VBABRKC,BRKCODE-BRKTABD(R3)                                      
         ST    R1,VBASVR1                                                       
*                                                                               
         XC    VBASVGST,VBASVGST                                                
*                                                                               
         SPACE 2                                                                
*                                                                               
         L     RF,0(R1)            A(PERLIST ENTRY)                             
         MVC   HALF,0(RF)          SAVE MOS                                     
*                                                                               
         MVC   WKAORVCS,SVAORVCS    SET INTO WORKING AOR VATS                   
         CLC   HALF,=X'6E07'        CHECK MOS VS JUL/10                         
         BL    VBCA2                                                            
*                                   IF JUL/2010 OR AFTER                        
*                                   ALTER AOR PSTS FOR MAIN PST                 
         CLI   SVAORMVC,C' '        DO I HAVE A MAIN VAT CODE?                  
         BNH   VBCA2                                                            
         ZIC   R3,SVAORMVP          MAIN PST PROVINCE #                         
         SH    R3,=H'1'                                                         
         LTR   R3,R3                                                            
         BM    VBCA2                SHOULD NOT BE NEGATIVE                      
*                                                                               
         MVC   WKAORVCS+1(10),SPACES CLEAR OLD PSTS                             
         LA    R4,WKAORVCS+1                                                    
         AR    R4,R3                                                            
         MVC   0(1,R4),SVAORMVC     STORE CODE IN LIST                          
*                                                                               
VBCA2    DS    0H                                                               
         SR    R3,R3                                                            
         LA    R5,WKROW                                                         
         LA    R4,WKAORVCS         WORKING AOR VAT CODES                        
         MVC   VBAFULL,AORDSP(R7)  ALL PROVS HAVE SAME AOR VAT BASIS            
*                                                                               
VBCA4    DS    0H                                                               
         CLI   0(R4),C'H'          HST                                          
         BE    VBCA4H                                                           
         CLI   0(R4),C'S'          % ONLY FOR CODE S AND H                      
         BNE   VBCA8                                                            
         LTR   R3,R3               SEE IF DOING GST                             
         BNZ   VBCA4H                                                           
*                                                                               
         CLC   HALF,=X'6104'       SEE IF BEFORE APR/97                         
         BL    VBCA4H              DO GST                                       
*                                                                               
         CLI   MANRVDTP,0                                                       
         BE    *+18                                                             
         CLC   MANRVDTP,=X'710401'                                              
         BNL   *+26                                                             
         B     *+14                                                             
         CLC   TODAYB,=X'710401'   SEE IF ON OR AFTER APR1/2013                 
         BNL   *+12                                                             
*                                                                               
         CLI   WKAORVCS+1,C' '     SEE IF BRITISH COL. APPLIES                  
         BH    VBCA8               THEN NO GST                                  
         CLI   WKAORVCS+5,C' '     SEE IF ONTARIO APPLIES                       
         BH    VBCA8               THEN NO GST                                  
         CLI   WKAORVCS+7,C' '     SEE IF NEW BRUNSWICK APPLIES                 
         BH    VBCA8               THEN NO GST                                  
         CLI   WKAORVCS+8,C' '     SEE IF NOVA SCOTIA APPLIES                   
         BH    VBCA8               THEN NO GST                                  
         CLI   WKAORVCS+9,C' '     SEE IF P.E. ISLAND APPLIES                   
         BH    VBCA8               THEN NO GST                                  
         CLI   WKAORVCS+10,C' '    SEE IF NEWFOUNDLAND APPLIES                  
         BH    VBCA8               THEN NO GST                                  
*                                                                               
VBCA4H   DS    0H                                                               
         GOTO1 =A(VBGETPCT),VBADMCB,((R3),HALF),(R4) GET VCTAB ENTRY            
         SR    R0,R0               VAT %                                        
         ICM   RF,15,4(R1)          A(VCTAB ENTRY)                              
         BNZ   VBCA5                                                            
         B     VBCA8               IF NOT FOUND SKIP TO NEXT PROV               
*                                                                               
VBCA5    L     R0,VCTPCT-VCTABD(RF)   VAT %                                     
         L     R1,VBAFULL          ALL PROVS HAVE SAME AOR VAT BASIS            
*                                                                               
         LTR   R3,R3               IF NOT DOING GST NOW                         
         BZ    VBCA6                                                            
*                                  ADD GST TO GET PROV BASIS                    
*                                  FIRST APPLY GST TO GET BASIS                 
*                                  BUT FOR HST PROV'S BASE IS                   
*                                  GROSS, NOT GROSS+GST                         
*                                                                               
         CLI   MANRVDTP,0                                                       
         BE    *+18                                                             
         CLC   MANRVDTP,=X'710401'                                              
         BNL   *+26                                                             
         B     *+14                                                             
         CLC   TODAYB,=X'710401'   SEE IF ON OR AFTER APR1/2013                 
         BNL   *+12                                                             
*                                                                               
         CH    R3,=Y(1)            BRITISH COLUMBIA (#1)                        
         BE    VBCA6                                                            
         CH    R3,=Y(5)            ONTARIO (#5)                                 
         BE    VBCA6                                                            
         CH    R3,=Y(7)            NEW BRUNSWICK (#7)                           
         BE    VBCA6                                                            
         CH    R3,=Y(8)            NOVA SCOTIA   (#8)                           
         BE    VBCA6                                                            
         CH    R3,=Y(9)            P.E. ISLAND   (#9)                           
         BE    VBCA6                                                            
         CH    R3,=Y(10)           NEWFOUNDLAND  (#10)                          
         BE    VBCA6                                                            
*                                                                               
         CH    R3,=Y(06)           QUEBEC (#06)                                 
         BNE   VBCA5Q                                                           
*                                                                               
         CLI   MANRVDTP,0          REVERSING?                                   
         BE    VBCA5A                                                           
         CLC   MANRVDTP,=X'710101'  BILL BEFORE JAN01/2013?                     
         BL    VBCA5Q               YES- APPLY GST                              
         B     VBCA6                NO - DON'T APPLY GST                        
*                                                                               
VBCA5A   CLC   TODAYB,=X'710101'   ARE WE BEFORE JAN01/13?                      
         BL    VBCA5Q              YES - APPLY GST                              
         B     VBCA6               NO - DON'T APPLY GST                         
*                                                                               
VBCA5Q   A     R1,VBASVGST         ADD GST TO GET PROV BASIS                    
*                                                                               
VBCA6    DS    0H                                                               
         MR    R0,R0                                                            
         L     RF,=F'100000'                                                    
         BAS   RE,VBCADIV                                                       
*                   **NOTE-AOR VAT NOT IN VBTAB                                 
         LTR   R3,R3               IF DOING GST NOW                             
         BNZ   *+8                                                              
         ST    R1,VBASVGST         SAVE GST AMOUNT                              
         ST    R1,VATADSP(R7)      SET IN MONTH CUME ROW                        
         A     R1,VATADSP-EXTDSP(R5)   AND TOTAL IN WKROW                       
         ST    R1,VATADSP-EXTDSP(R5)                                            
*                                                                               
VBCA8    DS    0H                                                               
         CH    R3,=Y(NPROVS)                                                    
         BNL   VBCA9                                                            
         LA    R3,1(R3)                                                         
         LA    R5,4(R5)            NEXT WKROW SLOT                              
         LA    R7,4(R7)            NEXT ACCUM SLOT                              
         LA    R4,1(R4)            NEXT PROVINCE                                
         B     VBCA4                                                            
*                                                                               
VBCA9    DS    0H                                                               
         MVC   VBAMODE,=C'CA'        VBCALC MODE - AOR                          
         GOTO1 =A(VBATRC),VBADMCB,(R8)                                          
*                                                                               
VBCAALCX DS    0H                                                               
         XIT1                                                                   
*                                                                               
VBCADIV  DRNDR (R0),(RF)                                                        
         BR    RE                                                               
*                                                                               
         LTORG                                                                  
*                                                                               
WKAORVCS DS     CL11     GST + 10 PROVINCES                                     
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBCALCR  CALC VAT AMOUNTS FOR RETAIL BILLS                             
*                 AND ADD INTO WKROW                                            
*                                                                               
*        PARM1  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(PERLIST ENTRY)                                      
*        PARM2  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(MONTH CUME SLOT - ATOTS)                            
*        PARM3  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(BRKTAB ENTRY)                                       
*        PARM4  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(RETAIL SHARE PCT)                                   
*                                                                               
*        NOTE - VAT IS CALCULATED FOR THE GIVEN MONTH AND                       
*               TOTALED IN WKROW TO STAY COMPATIBLE WITH OLD BILCALC.           
*               IT IS ALSO SET AT VATRDSP IN THE REGULAR CUME (AT R7).          
*               ALSO TAX IS SET AT RETTDSP.                                     
*             **IT IS NOT STORED IN THE VBTAB                                   
*                                                                               
***********************************************************************         
         SPACE 2                                                                
         PRINT NOGEN                                                            
VBCALCR  NMOD1 VBAWRKL,VBCALCR                                                  
         USING PPWORKD,RA                                                       
         USING PPWORK2D,R9                                                      
         LR    R8,RC                                                            
         USING VBAWRKD,R8                                                       
         USING BILWRKD,RC                                                       
         LA    RC,SPACEND                                                       
*                                                                               
         L     R7,4(R1)            A(MONTH CUME SLOT)                           
         L     R3,8(R1)                                                         
         ST    R3,VBABRK           SAVE A(BREAK TABLE ENTRY)                    
         MVC   VBABRKC,BRKCODE-BRKTABD(R3)                                      
         L     RF,12(R1)           RETAIL SHARE PCT                             
         MVC   VBAFULL,0(RF)                                                    
         ST    R1,VBASVR1                                                       
         SPACE 2                                                                
*                                                                               
         L     RF,0(R1)                                                         
         LA    R0,PERLIST                                                       
         SR    RE,RE                                                            
         SR    RF,R0                                                            
         D     RE,=F'8'            PERLIST ENTRY IS 8 LONG                      
         MH    RF,=Y((NPROVS+1)*VBTABL)                                         
         L     R2,VBABRKC                                                       
         L     R2,ATOTSV(R2)                                                    
         AR    R2,RF                                                            
         USING VBTABD,R2                                                        
*                                                                               
         LA    R3,NPROVS+1                                                      
         LA    R5,WKROW                                                         
*                                                                               
VBCR4    DS    0H                                                               
         L     R1,VBTTAX           TAX AMOUNT FROM VBTAB ENTRY                  
         L     R0,VBAFULL          X SHARE % (TAX WILL NOT ADD                  
         MR    R0,R0               UP TO THE PENNY LIKE OTHER RETAIL            
         L     RF,=F'10000'        FIELDS BUT THATS OK BECAUSE IT IS            
         BAS   RE,VBCRDIV          ONLY USED FOR THE VAT CALC)                  
*                                                                               
         LR    RE,R1                                                            
         ST    RE,RETTDSP(R7)      SET TAX IN ACCUM                             
         A     RE,RETTDSP-EXTDSP(R5)    AND ROW FOR TOTALS                      
         ST    RE,RETTDSP-EXTDSP(R5)                                            
*                                                                               
         L     R1,VBTVATB          VAT BASIS                                    
         L     R0,VBAFULL          X SHARE % (TOTAL MAY BE DIFFER               
         MR    R0,R0               SLIGHTLY FROM RETADSP BECAUSE                
         L     RF,=F'10000'        OF ROUNDING)                                 
         BAS   RE,VBCRDIV                                                       
         ST    R1,VBTVATB          STORE BASIS BACK IN VBTAB                    
*                                                                               
VBCR6    DS    0H                                                               
         LR    RE,R1                    VAT BASIS                               
         ST    RE,VATRBDSP(R7)          SET IN MONTH CUME ROW                   
         A     RE,VATRBDSP-EXTDSP(R5)   AND TOTAL IN WKROW                      
         ST    RE,VATRBDSP-EXTDSP(R5)                                           
*                                                                               
         ICM   R0,15,VBTPCT                                                     
         MR    R0,R0                                                            
         L     RF,=F'100000'                                                    
         BAS   RE,VBCRDIV                                                       
         ST    R1,VBTVAT                                                        
*                                                                               
         ST    R1,RETVDSP(R7)      SET IN MONTH CUME ROW                        
         A     R1,RETVDSP-EXTDSP(R5)   AND TOTAL IN WKROW                       
         ST    R1,RETVDSP-EXTDSP(R5)                                            
*                                                                               
VBCR8    DS    0H                                                               
         LA    R2,VBTABL(R2)       NEXT PROVINCE                                
         LA    R5,4(R5)            NEXT WKROW SLOT                              
         LA    R7,4(R7)            NEXT ACCUM SLOT                              
         BCT   R3,VBCR4                                                         
*                                                                               
         MVC   VBAMODE,=C'CR'        VBCALC MODE - RETAIL                       
         GOTO1 =A(VBATRC),VBADMCB,(R8)                                          
*                                                                               
VBCRX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
VBCRDIV  DRNDR (R0),(RF)                                                        
         BR    RE                                                               
         DROP  R2                                                               
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBGETPCT  - GET VCTAB ENTRY                                            
*                                                                               
*                    PARM1 BYTE  0     PROVINCE NUMBER                          
*                          BYTES 1-3   A(MOS)                                   
*                    PARM2 BYTE  0     NOT USED                                 
*                          BYTES 1-3   A(VAT CODE)                              
*                                      ON OUTPUT = A(TABLE ENTRY)               
*                                                                               
***********************************************************************         
         SPACE 2                                                                
         PRINT NOGEN                                                            
VBGETPCT NMOD1 VBAWRKL,VBGPC                                                    
         USING PPWORKD,RA                                                       
         USING PPWORK2D,R9                                                      
         LR    R8,RC                                                            
         USING VBAWRKD,R8                                                       
         USING BILWRKD,RC                                                       
         LA    RC,SPACEND                                                       
*                                                                               
         L     R2,=A(VCTAB)        VAT CODE TABLE                               
*                                                                               
         CLI   MANRVDTP,0              SEE IF REVERSAL                          
         BZ    VBGPC3                                                           
         CLC   MANRVDTP,=X'6A0701'  SEE IF ORIG. BILL WAS BEFORE                
         BL    VBGPC4               JUL01/06 IF SO STILL USE OLD TABLE          
         L     R2,=A(VCTAB6)       IF SO USE NEW TABLE                          
         CLC   MANRVDTP,=X'6C0101'  SEE IF ORIG. BILL WAS BEFORE                
         BL    VBGPC4               JAN01/08 IF SO STILL USE OLD TABLE          
         L     R2,=A(VCTAB8)       IF SO USE NEW TABLE                          
         CLC   MANRVDTP,=X'6E0501'  SEE IF ORIG. BILL WAS BEFORE                
         BL    VBGPC4               MAY01/10 IF SO STILL USE OLD TABLE          
         CLC   QAGENCY,=C'HD'       HDTO CHECK VS MAY01/2010                    
         BE    VBGPC2                                                           
         CLC   MANRVDTP,=X'6E0617'  SEE IF ORIG. BILL WAS BEFORE                
         BL    VBGPC4               JUN23/10 IF SO STILL USE OLD TABLE          
         CLC   QAGENCY,=C'PA'       PATO CHECK VS JUN23/2010                    
         BE    VBGPC2                                                           
*                                                                               
         CLC   MANRVDTP,=X'6E0618'  SEE IF ORIG. BILL WAS BEFORE                
         BL    VBGPC4               JUN24/10 IF SO STILL USE OLD TABLE          
         CLC   QAGENCY,=C'H0'    MSHTOA CHECK VS JUN24/2010                     
         BE    VBGPC2                                                           
*                                                                               
         CLC   MANRVDTP,=X'6E061D'  SEE IF ORIG. BILL WAS BEFORE                
         BL    VBGPC4               JUN29/10 IF SO STILL USE OLD TABLE          
         CLC   QAGENCY,=C'OU'       FOR OU,U#,DA AND S4 USE NEW TABLE           
         BE    VBGPC2               IF ON OR AFTER JUN29/2010                   
         CLC   QAGENCY,=C'U#'                                                   
         BE    VBGPC2                                                           
         CLC   QAGENCY,=C'DA'                                                   
         BE    VBGPC2                                                           
         CLC   QAGENCY,=C'S4'                                                   
         BE    VBGPC2                                                           
*                                   FOR ALL OTHER AGENCIES                      
         CLC   MANRVDTP,=X'6E0705'  SEE IF ORIG. BILL WAS BEFORE                
         BL    VBGPC4               JUL05/10 IF SO STILL USE OLD TABLE          
*                                                                               
VBGPC2   L     R2,=A(VCTAB10)       OTHERWISE USE JUN/10 TABLE                  
         CLC   MANRVDTP,=X'6E0C01'  CHECK DEC1/10 (HDTO)                        
         BL    VBGPC4                                                           
         CLC   QAGENCY,=C'HD'                                                   
         BE    VBGPC2B                                                          
         CLC   MANRVDTP,=X'6F0101'   CHECK JAN1/11 EVERYONE ELSE                
         BL    VBGPC4                                                           
VBGPC2B  L     R2,=A(VCTAB11)        USE 2011 TABLE                             
         CLC   MANRVDTP,=X'700101'   ORIG BILL BEFORE JAN01/12?                 
         BL    VBGPC4                                                           
         L     R2,=A(VCTAB12)        USE NEW TABLE                              
         CLC   MANRVDTP,=X'710101'   ORIG BILL BEFORE JAN01/13?                 
         BL    VBGPC4                                                           
         L     R2,=A(VCTAB13)        USE NEW TABLE                              
         CLC   MANRVDTP,=X'710401'   ORIG BILL BEFORE APR01/13?                 
         BL    VBGPC4                                                           
         L     R4,=A(VCTAB13R)      USE REVERSAL TABLE?                         
         CLC   MANRVDTP,=X'720A01' SEE IF ORIG BILL WAS BEFORE OCT01/14         
         BL    VBGPC4                                                           
         CLC   TODAYB,=X'720A01'   ARE WE AFTER OCT01/14?                       
         BL    VBGPC4              IF NOT, ALSO USE VCTAB13R                    
         L     R2,=A(VCTAB13A)     USE NEW TABLE                                
         CLC   MANRVDTP,=X'740701' SEE IF ORIG BILL WAS BEFORE JUL01/16         
         BL    VBGPC4                                                           
         L     R2,=A(VCTAB16)      USE NEW TABLE                                
         CLC   MANRVDTP,=X'740A01' SEE IF ORIG BILL WAS BEFORE OCT01/16         
         BL    VBGPC4              IF NOT, ALSO USE NEW                         
         CLC   TODAYB,=X'740A01'   ARE WE AFTER OCT01/16?                       
         BL    VBGPC4                                                           
         L     R2,=A(VCTAB16A)     USE NEW TABLE                                
         B     VBGPC4                                                           
*                                                                               
VBGPC3   DS    0H                                                               
         CLC   TODAYB,=X'6A0701'   ARE WE AFTER JUL01/06?                       
         BL    VBGPC4                                                           
         L     R2,=A(VCTAB6)       IF SO USE JUL/06 TABLE                       
         CLC   TODAYB,=X'6C0101'   ARE WE AFTER JAN01/08?                       
         BL    VBGPC4                                                           
         L     R2,=A(VCTAB8)       IF SO USE JAN/08 TABLE                       
         CLC   TODAYB,=X'6E0501'   ARE WE AFTER MAY1/10 (FOR TESTING)           
         BL    VBGPC4                                                           
*                                                                               
         CLC   QAGENCY,=C'HD'      HDTO - USE MAY01/2010 AS START OF            
         BE    VBGPC3C             USE OF NEW TABLE                             
         CLC   TODAYB,=X'6E0617'   ARE WE AFTER JUN23/2010?                     
         BL    VBGPC4              CHECK FOR PATO                               
         CLC   QAGENCY,=C'PA'      PATO - USE JUN23/2010 AS START OF            
         BE    VBGPC3C             USE OF NEW TABLE                             
*                                                                               
         CLC   TODAYB,=X'6E0618'   ARE WE AFTER JUN24/2010?                     
         BL    VBGPC4              CHECK FOR MSHTOA                             
         CLC   QAGENCY,=C'H0'   MSHTOA - USE JUN24/2010 AS START OF             
         BE    VBGPC3C             USE OF NEW TABLE                             
*                                                                               
         CLC   TODAYB,=X'6E061D'   ARE WE AFTER JUN29/2010?                     
         BL    VBGPC4              CHECK FOR OU,U#,DA, AND S4                   
         CLC   QAGENCY,=C'OU'      THEY USE JUN29/2010 AS START OF              
         BE    VBGPC3C             USE OF NEW TABLE                             
         CLC   QAGENCY,=C'U#'                                                   
         BE    VBGPC3C                                                          
         CLC   QAGENCY,=C'DA'                                                   
         BE    VBGPC3C                                                          
         CLC   QAGENCY,=C'S4'                                                   
         BE    VBGPC3C                                                          
*                                  FOR ALL OTHER AGENCIES                       
         CLC   TODAYB,=X'6E0705'   ARE WE AFTER JUL05/2010?                     
         BL    VBGPC4              NO - USE JAN/08 TABLE                        
*                                                                               
VBGPC3C  L     R2,=A(VCTAB10)      IF SO USE 2010 TABLE                         
         CLC   TODAYB,=X'6E0C01'   ARE WE ON OR AFTER DEC1/10  (HDTO)           
         BL    VBGPC4                                                           
         CLC   QAGENCY,=C'HD'       HDTO                                        
         BE    VBGPC3D                                                          
         CLC   TODAYB,=X'6F0101'   ARE WE ON OR AFTER JAN1/11                   
         BL    VBGPC4                                                           
VBGPC3D  L     R2,=A(VCTAB11)      IF SO USE 2011 TABLE                         
         CLC   TODAYB,=X'700101'   ARE WE BEFORE JAN01/12?                      
         BL    VBGPC4                                                           
         L     R2,=A(VCTAB12)      IF SO USE NEW TABLE                          
         CLC   TODAYB,=X'710101'   ARE WE BEFORE JAN01/13?                      
         BL    VBGPC4                                                           
         L     R2,=A(VCTAB13)      IF SO USE NEW TABLE                          
         CLC   TODAYB,=X'710401'   ARE WE BEFORE APR01/13?                      
         BL    VBGPC4                                                           
*                                                                               
         L     R2,=A(VCTAB13R)     USE OLD TABLE                                
         CLC   TODAYB,=X'720A01'   ARE WE BEFORE OCT01/14?                      
         BL    VBGPC4                                                           
*                                                                               
         L     R2,=A(VCTAB13A)                                                  
         CLC   TODAYB,=X'740701'   ARE WE BEFORE JUL01/16?                      
         BL    VBGPC4                                                           
         L     R2,=A(VCTAB16)     OTHERWISE USE NEW TABLE                       
         CLC   TODAYB,=X'740A01'   ARE WE BEFORE OCT01/16?                      
         BL    VBGPC4                                                           
         L     R2,=A(VCTAB16A)    OTHERWISE USE NEW TABLE                       
*                                                                               
*                                                                               
         USING VCTABD,R2                                                        
*                                                                               
VBGPC4   DS    0H                                                               
         CLC   0(1,R1),VCTPRV       PROVINCE                                    
         BNE   VBGPC8                                                           
         L     RF,4(R1)                                                         
         CLC   0(1,RF),VCTVCD       CODE                                        
         BNE   VBGPC8                                                           
         SR    RF,RF                                                            
         ICM   RF,7,1(R1)          MOS                                          
         BZ    VBGPC8B             IF 0, IGNORE                                 
         OC    0(2,RF),0(RF)                                                    
         BZ    VBGPC8B                                                          
         CLC   0(2,RF),VCTSTRT        START MOS                                 
         BL    VBGPC8                                                           
         CLC   0(2,RF),VCTEND         END MOS                                   
         BNH   VBGPC8B                                                          
*                                                                               
VBGPC8   DS    0H                                                               
         LA    R2,VCTABL(R2)       NEXT ENTRY                                   
         CLI   0(R2),X'FF'         END OF TABLE                                 
         BNE   VBGPC4                                                           
         XC    4(4,R1),4(R1)       NO ENTRY                                     
         B     VBGPCX                                                           
*                                                                               
VBGPC8B  DS    0H                                                               
         MVC   VBPCTWK(VCTABL),0(R2)                                            
         CLI   0(R2),06                 SEE IF QUEBEC                           
         BNE   VBGPC10                                                          
         CLI   MANRVDTP,0               SEE IF REVERSAL                         
         BZ    VBGPC10                                                          
         CLC   MANRVDTP,=X'5E0601'      SEE IF BEFORE JUN1/94                   
         BNL   VBGPC8D                                                          
         OC    VBPCTWK+VCTABL-4(4),VBPCTWK+VCTABL-4                             
         BZ    VBGPC10                                                          
         MVC   VBPCTWK+VCTABL-4(4),=AL4(4000)   USE 4.000                       
         B     VBGPC10                                                          
*                                                                               
VBGPC8D  CLC   MANRVDTP,=X'620102'     SEE IF ORIG. BILL WAS BEFORE             
         BNL   VBGPC8F                 JAN02/98 SET % TO 6.5                    
         OC    VBPCTWK+VCTABL-4(4),VBPCTWK+VCTABL-4                             
         BZ    VBGPC10                                                          
         MVC   VBPCTWK+VCTABL-4(4),=AL4(6500)   USE 6.500                       
         B     VBGPC10                                                          
*                                                                               
VBGPC8F  CLC   MANRVDTP,=X'6F0101'     SEE IF ORIG. BILL WAS BEFORE             
         BNL   VBGPC10                 JAN01/11 SET % TO 7.5                    
*                                                                               
         CLC   QAGENCY,=C'HD'           SEE IF HDTO                             
         BNE   VBGPC8H                 CHECK DEC1/10 INSTEAD                    
         CLC   MANRVDTP,=X'6E0C01'     SEE IF ORIG. BILL WAS BEFORE             
         BNL   VBGPC10                 DEC01/10 SET % TO 7.5                    
*                                                                               
VBGPC8H  OC    VBPCTWK+VCTABL-4(4),VBPCTWK+VCTABL-4                             
         BZ    VBGPC10                                                          
         MVC   VBPCTWK+VCTABL-4(4),=AL4(7500)   USE 7.500                       
         B     VBGPC10                                                          
*                                                                               
VBGPC10  DS    0H                                                               
         LA    RE,VBPCTWK                                                       
         ST    RE,4(R1)            RETURN A(ENTRY)  NOW VBPCTWK                 
******   ST    R2,4(R1)            RETURN A(ENTRY)                              
*                                                                               
VBGPCX   DS    0H                                                               
         XIT1                                                                   
         DROP  R2                                                               
         LTORG                                                                  
VBPCTWK  DS    CL20                                                             
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBPRNT   CREATE GST/PST PRINT LINES                                    
*                                                                               
*        PARM1  BYTE  0   MODE- N=NORMAL,J=SEP ADJ,A=AOR                        
*               BYTES 1-3 A(BRKTAB ENTRY)                                       
*        PARM2  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(DISP INTO LINE OF WHERE VAT$ TO PRINT)              
*        PARM3  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(VAT CODES) FOR OTHER AGY  ** AOR MODE ONLY          
*        PARM4  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(AOR VAT BASIS)    = AOR AMOUNT                      
*        PARM5  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(AOR VAT AMOUNTS)                                    
*        PARM6  BYTES 1-4 ON RETURN = SUM OF ALL VATS                           
*                                                                               
*              NOTE - 'NORMAL' MODE INCLUDES RETAIL                             
*                                                                               
***********************************************************************         
         SPACE 2                                                                
         PRINT NOGEN                                                            
VBPRNT   NMOD1 VBAWRKL,VBPRNT                                                   
         USING PPWORKD,RA                                                       
         USING PPWORK2D,R9                                                      
         LR    R8,RC                                                            
         USING VBAWRKD,R8                                                       
         USING BILWRKD,RC                                                       
         LA    RC,SPACEND                                                       
*                                                                               
         SR    R3,R3                                                            
         ICM   R3,7,1(R1)                                                       
         ST    R3,VBABRK           SAVE A(BREAK TABLE ENTRY)                    
         MVC   VBABRKC,BRKCODE-BRKTABD(R3)                                      
         MVC   VBPRMODE,0(R1)      MODE                                         
         ST    R1,VBASVR1                                                       
         MVC   VBAPARMS,0(R1)      SAVE PARMS                                   
         XC    VBASVGSP,VBASVGSP                                                
         SPACE 2                                                                
*                                                                               
         CLI   VBPRMODE,C'N'       IF 'NORMAL' MODE                             
         BNE   *+8                                                              
         BAS   RE,VBPRMTOT         ADD UP TO 'TOTAL MONTH'                      
*                                                                               
         L     R2,VBABRKC                      RIGHT LEVEL                      
         L     R2,ATOTSV(R2)                                                    
         LH    RF,=Y(MAXMOS*(NPROVS+1)*VBTABL)  POINT TO 'TOTAL MONTH'          
         AR    R2,RF                                                            
         USING VBTABD,R2                                                        
*                                                                               
         SR    R3,R3               PROVINCE INDEX                               
         L     R4,4(R1)            A(DISPL WHERE VAT $ TO PRINT)                
         CLI   VBPRMODE,C'A'       SEE IF AOR                                   
         BNE   VBPR2                                                            
         CLI   AORLOPT,C'N'        AND DOING CLT/PRD LIST                       
         BNE   VBPR2A              DON'T ADJUST R4                              
*                                                                               
VBPR2    SH    R4,=H'1'            ADJUST BY ONE BYTE                           
VBPR2A   LA    R4,P1(R4)                                                        
         ST    R4,VBALINE                                                       
         L     R5,8(R1)            A(AOR VAT CODES)                             
*                                                                               
         MVC   VBASVGSP,VBTPCT     SAVE GST %                                   
         XC    VBADUB,VBADUB                                                    
*                                                                               
VBPR4    DS    0H                                                               
         CLI   VBPRMODE,C'A'       FOR AOR                                      
         BNE   VBPR4D                                                           
         CLI   0(R5),C' '          CHECK AOR VAT CODE ACTIVE                    
         BH    VBPR4E                                                           
*                                                                               
VBPR4C   DS    0H                                                               
         LTR   R3,R3               GST - DO EVEN IF NO CODE?                    
         BZ    VBPR4E              (WILL ONLY BE HERE IF                        
         B     VBPR21               CVATSW NOT = 0)                             
*                                                                               
VBPR4D   DS    0H                  NOT AOR INVOICE                              
*                                                                               
*     CODE BELOW PREVENTS PRINTING OF GST IF THE GST BASIS IS ZERO              
*     I MAY WANT TO PUT A DATE CHECK HERE - BUT I DON'T HAVE THE                
*     MOS - SO MAYBE I COULD CHECK "TODAY"                                      
*                                                                               
         L     RF,APER             PERIOD (MOS)                                 
         ZIC   RE,0(RF)                                                         
         SLL   RE,3                X 8                                          
         LA    RE,PERLIST(RE)                                                   
         CLC   0(2,RE),=X'6E07'    CHECK IF MOS JUL/10 OR LATER                 
         BL    VBPR4D5             IF SO TREAT LIKE PST FOR ALL PUBS            
*                                                                               
         LTR   R3,R3               DOING GST?                                   
         BNZ   VBPR4D5                                                          
         CLI   CVATCDS,C'X'                                                     
         BE    VBPR4D5                                                          
         CLI   CVATCDS,C'Z'                                                     
         BE    VBPR4D5                                                          
         L     R1,VBTVATB          SEE IF BASIS IS ZERO                         
         LTR   R1,R1                                                            
         BZ    VBPR21              SKIP GST GO TO NEXT PROVINCE                 
*                                                                               
VBPR4D5  DS    0H                  DO GST EVEN IF NO CODE??                     
         CLI   VBTCOD,C' '        ACTIVE PROVINCE?                              
         BNH   VBPR4C                                                           
*                                                                               
VBPR4E   DS    0H                                                               
         CLI   VBPRMODE,C'A'        SEE IF AOR                                  
         BNE   VBPR4E5                                                          
         LTR   R3,R3                SEE IF DOING GST                            
         BNZ   VBPR4E1                                                          
*                                                                               
**       L     RF,APER             PERIOD (MOS)                                 
**       ZIC   RE,0(RF)                                                         
**       SLL   RE,3                X 8                                          
**       LA    RE,PERLIST(RE)                                                   
**       CLC   0(2,RE),=X'6E07'    CHECK IF MOS JUL/10 OR LATER                 
**       BL    VBPR4E5             IF SO TREAT LIKE PST FOR ALL PUBS            
**                                                                              
         CLI   0(R5),C'X'         FOR THESE CODES - ALWAYS SHOW GST             
         BE    VBPR4E5                                                          
         CLI   0(R5),C'Z'                                                       
         BE    VBPR4E5                                                          
*                                                                               
         LR    RF,R3                                                            
         SLL   RF,2                  X 4                                        
         L     R1,VBAPARMS+16        A(AOR VAT AMOUNTS)                         
         L     RE,0(R1,RF)                                                      
         LTR   RE,RE                                                            
         BNZ   VBPR4E5             IS THERE ANY GST AMOUNT                      
         B     VBPR21              SKP TO NEXT PROVINCE                         
*                                  IF NOT-SET PCT TO ZERO                       
**       L     R1,VBTPCT            IS % ZERO?  (CAN'T CHECK BASIS)             
**       LTR   R1,R1                                                            
**       BZ    VBPR21               SKIP TO NEXT PROVINCE                       
**       B     VBPR4E5                                                          
*                                                                               
VBPR4E1  CLI   0(R5),C'H'           HST                                         
         BE    VBPR4E2                                                          
*                                                                               
         CLI   0(R5),C'S'       ALL NON-'S' CODES ARE NOW ZERO PCT.             
         BNE   VBPR4E5              SHOW THEM EVEN IF VAT IS ZERO               
*                                                                               
VBPR4E2  DS    0H                                                               
         LR    RF,R3                                                            
         SLL   RF,2                  X 4                                        
         L     R1,VBAPARMS+16        A(AOR VAT AMOUNTS)                         
         L     RE,0(R1,RF)                                                      
         LTR   RE,RE                                                            
         BZ    VBPR21                SKIP TO NEXT PROVINCE IF NO VAT            
*                                                                               
VBPR4E5  MVC   VBAWRK2,SPACES                                                   
         LA    RE,VBAWRK2                                                       
         LR    RF,R3                                                            
         MH    RF,=H'14'                                                        
         A     RF,=A(PSTNAMS)      'NAME' OF GST/PST                            
         MVC   0(7,RE),0(RF)       ENGLISH                                      
         CLI   RCLANG,4                                                         
         BNE   *+10                                                             
         MVC   0(7,RE),7(RF)       OR FRENCH                                    
**EDI**                                                                         
         MVC   ECTAXT,0(RE)    SAVE FOR EDI TRANSMISSION                        
**EDI**                                                                         
         LA    RE,8(RE)                                                         
         CLI   0(RE),C' '                                                       
         BH    *+8                                                              
         BCT   RE,*-8                                                           
         LA    RE,3(RE)                                                         
*                                                                               
         LR    RF,R3                                                            
         MH    RF,=H'16'                                                        
         A     RF,=A(VATACCS)      ACCOUNT # TABLE                              
**EDI**                                                                         
         MVC   ECTAXA(16),SPACES                                                
**EDI**                                                                         
         CLI   0(RF),C' '          ANY # PRESENT?                               
         BNH   VBPR4F                                                           
         MVI   0(RE),C'#'                                                       
         MVC   1(16,RE),0(RF)                                                   
**EDI**                                                                         
         MVC   ECTAXA,1(RE)    SAVE FOR EDI TRANSMISSION                        
**EDI**                                                                         
         LA    RE,16(RE)                                                        
         CLI   0(RE),C' '                                                       
         BH    *+8                                                              
         BCT   RE,*-8                                                           
*                                                                               
VBPR4F   DS    0H                                                               
         SH    R4,=H'27'           BACK UP 27 SPACES                            
         LA    R0,VBAWRK2                                                       
         SR    RE,R0               RE = LEN(NAME + ACCT -1)                     
         LR    RF,R4                                                            
         SR    RF,RE                                                            
         SH    RF,=H'3'                                                         
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),VBAWRK2                                                  
*                                                                               
         MVC   VBAFULL,VBTPCT      %                                            
*                                                                               
         CLI   VBPRMODE,C'A'       FOR AOR, GET % FROM VCTAB                    
         BNE   VBPR4H                                                           
*                                                                               
         CLI   0(R5),C'X'          SEE IF EXEMPT                                
         BE    VBPR4F5                                                          
         CLI   0(R5),C'Z'          OR ZERO RATED                                
         BE    VBPR4F5                                                          
*                                                                               
******** LTR   R3,R3               DOING GST?                                   
******** BNZ   VBPRF41                                                          
******** OC    VBAFULL,VBAFULL     DO I HAVE A % (FROM VBTPCT)                  
******** BNZ   VBPRF41                                                          
******** MVC   VBAFULL,=C'FFFFFFFF'  GST AMT WITH NO % - SET AS MIXED           
*                                                                               
VBPRF41  CLC   VBAFULL,=X'FFFFFFFF'    SEE IF MIXED                             
         BNE   VBPR4F2                                                          
         CLI   0(R5),X'FF'         SEE IF MIXED VAT CODES                       
         BE    VBPR4H              LEAVE VBAFULL ALONE                          
         CLI   MIXSW,C'Y'          SEE IF REALLY MIXED                          
         BNE   VBPR4F5             IF NOT  - GET %                              
*                                                                               
VBPR4F2  OC    VBAFULL,VBAFULL     IF NOT, GET % UNLESS I HAVE ONE              
         BNZ   VBPR4H                                                           
*                                                                               
VBPR4F5  XC    VBAFULL,VBAFULL                                                  
         CLI   0(R5),C'H'          HST                                          
         BE    VBPR4G                                                           
         CLI   0(R5),C'S'          % ONLY FOR CODE S?                           
         BNE   VBPR4H                                                           
***                                                                             
         LTR   R3,R3              SEE IF DOING GST                              
         BNZ   VBPR4G                                                           
         LR    RF,R3                                                            
         SLL   RF,2                  X 4                                        
         L     R1,VBAPARMS+16        A(AOR VAT AMOUNTS)                         
         L     RE,0(R1,RF)                                                      
         LTR   RE,RE                                                            
         BNZ   VBPR4G              IS THERE ANY GST AMOUNT                      
*                                  IF NOT-SET PCT TO ZERO                       
         XC    VBAFULL,VBAFULL                                                  
         B     VBPR4H1                                                          
*                                                                               
*                                                                               
VBPR4G   DS    0H                                                               
         CLI   MIXSW,C'Y'      MIXED BEFORE AND AFTER JUL/10                    
         BNE   VBPR4G5         MOS FOUND                                        
         MVC   VBAFULL,=X'FFFFFFFF'                                             
         B     VBPR4H                                                           
*                              MOS FOUND                                        
*                                                                               
VBPR4G5  DS    0H                                                               
         CLI   VBPRMODE,C'A'      SEE IF DOING AOR                              
         BNE   VBPR4G6                                                          
         OC    LASTMOS,LASTMOS    DO I HAVE A LAST MOS?                         
         BZ    VBPR4G6                                                          
*                                                                               
         GOTO1 =A(VBGETPCT),VBADMCB,((R3),LASTMOS),(R5)                         
         B     VBPR4G8                                                          
*                                                                               
VBPR4G6  GOTO1 =A(VBGETPCT),VBADMCB,((R3),0),(R5)                               
VBPR4G8  ICM   RF,15,4(R1)                                                      
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   VBAFULL,VCTPCT-VCTABD(RF)  SET %                                 
*                                                                               
VBPR4H   DS    0H                                                               
         LTR   R3,R3               IF DOING GST NOW                             
         BNZ   VBPR4H0                                                          
         MVC   VBASVGSP,VBAFULL    SAVE GST %                                   
VBPR4H0  CLC   VBAFULL,=X'FFFFFFFF'    MIXED %'S  (SHOULDN'T HAPPEN)?           
         BE    VBPR8                                                            
         LTR   R3,R3               SEE IF DOING GST                             
         BZ    VBPR4H1                                                          
*                                                                               
         CLI   VBPRMODE,C'A'       DOING AOR INV?                               
         BNE   VBPR4H0B                                                         
         CLI   0(R5),X'FF'         MIXED PROVINCIAL CODES                       
         BE    VBPR8               IF SO DON'T SHOW % OR BASIS                  
         B     VBPR4H1                                                          
*                                                                               
VBPR4H0B CLI   VBTCOD,X'FF'         MIXED HST VAT CODES                         
         BE    VBPR8                SKIP % AND BASIS                            
*                                                                               
VBPR4H1  CLI   VBTCOD,X'FF'         MIXED HST VAT CODES                         
         BE    VBPR8                SKIP % AND BASIS                            
         MVI   0(R4),C'('                                                       
         LA    R4,1(R4)                                                         
         OC    VBAFULL,VBAFULL     IF NO %                                      
         BNZ   VBPR4H2                                                          
         MVC   0(5,R4),=C'0.000'                                                
         LA    R4,5(R4)                                                         
         B     VBPR4H3                                                          
*                                                                               
VBPR4H2  DS    0H                                                               
         EDIT  (B4,VBAFULL),(7,0(R4)),3,ALIGN=LEFT   %                          
         AR    R4,R0                                                            
VBPR4H3  DS    0H                                                               
**EDI**                                                                         
         MVC   ECTAXP,VBAFULL    SAVE FOR EDIT TRANSMISSION                     
**EDI**                                                                         
         MVI   0(R4),C'%'                                                       
         MVI   1(R4),C')'                                                       
*                                                                               
*                                  GET BASIS AMOUNTS                            
*                                  -----------------                            
*                                                                               
         OC    VBAFULL,VBAFULL                                                  
         BZ    VBPR8               SKIP IF NO PCT.                              
*                                                                               
         CLI   VBPRMODE,C'A'       AOR MODE                                     
         BNE   VBPR4I                                                           
         L     R1,VBAPARMS+12      A(AMOUNT) IN PARM4                           
         L     R1,0(R1)                                                         
         LTR   R3,R3               IF NOT DOING GST NOW                         
         BZ    VBPR4H4                                                          
*                                                                               
         CLI   MANRVDTP,0                                                       
         BE    *+18                                                             
         CLC   MANRVDTP,=X'710401'                                              
         BNL   *+26                                                             
         B     *+14                                                             
         CLC   TODAYB,=X'710401'   SEE IF ON OR AFTER APR1/2013                 
         BNL   *+12                                                             
*                                                                               
         CH    R3,=Y(1)            OR BRITISH COLUMBIA                          
         BE    VBPR4H4                                                          
         CH    R3,=Y(5)            OR ONTARIO                                   
         BE    VBPR4H4                                                          
         CH    R3,=Y(7)            OR NEW BRUNSWICK                             
         BE    VBPR4H4                                                          
         CH    R3,=Y(8)            OR NOVA SCOTIA                               
         BE    VBPR4H4                                                          
         CH    R3,=Y(9)            OR P.E. ISLAND                               
         BE    VBPR4H4                                                          
         CH    R3,=Y(10)           OR NEWFOUNDLAND                              
         BE    VBPR4H4                                                          
*                                                                               
         CH    R3,=Y(06)           QUEBEC?                                      
         BNE   VBPR4H3Q                                                         
*                                                                               
         CLI   MANRVDTP,0          REVERSING?                                   
         BE    VBPR4H3A                                                         
         CLC   MANRVDTP,=X'710101'  BILL BEFORE JAN01/2013?                     
         BL    VBPR4H3Q            YES - APPLY GST                              
         B     VBPR4H4             NO - DON'T APPLY GST                         
*                                                                               
VBPR4H3A CLC   TODAYB,=X'710101'   ARE WE BEFORE JAN01/2013?                    
         BL    VBPR4H3Q            YES - APPLY GST                              
         B     VBPR4H4             NO - DON'T APPLY GST                         
*                                                                               
VBPR4H3Q ICM   R0,15,VBASVGSP      FIRST APPLY GST TO GET BASIS                 
         A     R0,=F'100000'                                                    
         MR    R0,R0                                                            
         L     RF,=F'100000'                                                    
         BAS   RE,VBPRDIV                                                       
*                                                                               
VBPR4H4  DS    0H                                                               
         B     VBPR6B                                                           
*                                                                               
VBPR4I   DS    0H                                                               
         CLI   VBPRMODE,C'J'       SEP ADJ BILL MODE                            
         BNE   VBPR4K                                                           
         LR    RF,R3               PROVINCE INDEX                               
         SLL   RF,2                X4 FOR DISP                                  
         L     R1,VATCBDSP(R7,RF)  ADJ VAT BASIS                                
*                                                                               
VBPR4J   DS    0H                                                               
         B     VBPR6B                                                           
*                                                                               
VBPR4K   DS    0H                                                               
         CLI   VBPRMODE,C'C'       SEP CD BILL MODE                             
         BNE   VBPR4L                                                           
         LR    RF,R3               PROVINCE INDEX                               
         SLL   RF,2                X4 FOR DISP                                  
         L     R1,VATDBDSP(R7,RF)  CD VAT BASIS                                 
*                                                                               
VBPR4K4  DS    0H                                                               
         B     VBPR6B                                                           
*                                                                               
VBPR4L   DS    0H                  'NORMAL' MODE                                
         CLI   RETPROF,0           IF RETAIL                                    
         BE    VBPR4R                                                           
         L     R1,VBTVATB          BASIS FROM VBTAB                             
         B     VBPR6B                                                           
*                                                                               
VBPR4R   DS    0H                  NON-RETAIL                                   
         L     R1,VBTVATB          BASIS FROM VBTAB                             
*                                                                               
VBPR6B   DS    0H                                                               
**EDI**                                                                         
         ST    R1,ECTAXB           SAVE FOR EDI TRANSMISSION                    
**EDI**                                                                         
         LTR   R1,R1               ANY BASIS ?                                  
         BZ    VBPR8               NO, DONT SHOW IT                             
         MVI   1(R4),C' '                                                       
         MVC   2(2,R4),=C'OF'                                                   
         CLI   RCLANG,4            FRENCH                                       
         BNE   *+10                                                             
         MVC   2(2,R4),=C'DE'                                                   
         LA    R4,5(R4)                                                         
*                                  BASIS AMOUNT                                 
         LR    R0,R1                                                            
*                                                                               
         CLI   VBPRMODE,C'C'       SEE IF DOING CD SEP BILL                     
         BNE   VBPR6D                                                           
         LCR   R0,R0              REVERSE SIGN                                  
*                                                                               
**EDI**                                                                         
VBPR6D   DS    0H                                                               
         ST    R0,ECTAXB       SAVE FOR EDI TRANSMISSION                        
**EDI**                                                                         
         CURED (R0),(14,0(R4)),CURTAB,CR=YES,COMMAS=YES,ALIGN=LEFT              
         AR    R4,R0                                                            
         MVI   0(R4),C')'                                                       
*                                                                               
*                                  ACTUAL VAT AMOUNT                            
*                                  **NOTE- COULD GET SOME FROM VBTAB            
*                                  **NOTE- 'TOTAL MONTH' CUMES                  
VBPR8    DS    0H                                                               
         L     R7,VBABRKC                                                       
         L     R7,ATOTS(R7)        POINT TO ACCUME                              
         AH    R7,=Y(MAXMOS*ROWL)  TOTAL MONTH ROW                              
         LR    RF,R3               PROVINCE INDEX                               
         SLL   RF,2                X4 FOR DISP INTO VAT AMOUNTS                 
         L     RE,RETVDSP(R7,RF)   USE RETAIL VAT                               
         CLI   RETPROF,0           IF RETAIL                                    
         BNE   *+8                                                              
         L     RE,VATDSP(R7,RF)                                                 
*                                                                               
         CLI   VBPRMODE,C'J'       IF SEP ADJ BILL NOW                          
         BNE   *+8                                                              
         L     RE,VATCDSP(R7,RF)   USE ADJ VAT                                  
*                                                                               
         CLI   VBPRMODE,C'C'       IF SEP CD BILL NOW                           
         BNE   *+8                                                              
         L     RE,VATDDSP(R7,RF)   USE CD VAT                                   
*                                                                               
         CLI   VBPRMODE,C'A'       IF AOR                                       
         BNE   VBPR9                                                            
         L     R1,VBAPARMS+16      PARM5 HAS A(AMOUNTS)                         
         L     RE,0(R1,RF)         USE AOR VAT                                  
*                                                                               
VBPR9    DS    0H                                                               
         L     R4,VBALINE          WHERE TO PRINT VAT $                         
         LR    R0,RE                                                            
*                                                                               
         CLI   VBPRMODE,C'C'       SEE IF DOING CD SEP BILL                     
         BNE   VBPR9C                                                           
         LCR   R0,R0              REVERSE SIGN                                  
*                                                                               
**EDI**                                                                         
VBPR9C   DS    0H                                                               
         ST    R0,ECTAX        SAVE FOR EDI TRANSMISSION                        
**EDI**                                                                         
         CURED (R0),(16,0(R4)),CURTAB,CR=YES,COMMAS=YES                         
*                                                                               
         A     R0,VBADUB           CUME VAT AMOUNTS                             
         ST    R0,VBADUB                                                        
*                                                                               
**EDI**                                                                         
         GOTO1 ABILLEDI,DMCB,('EDMCTX',0)                                       
**EDI**                                                                         
         L     R4,VBALINE          BUMP TO NEXT LINE                            
         LA    R4,132(R4)                                                       
         ST    R4,VBALINE                                                       
*                                                                               
VBPR21   DS    0H                                                               
         LA    R2,VBTABL(R2)       NEXT PROVINCE                                
         LA    R5,1(R5)                                                         
         LA    R3,1(R3)                                                         
         CH    R3,=Y(NPROVS)                                                    
         BNH   VBPR4                                                            
         GOTO1 =A(PRNT)                                                         
*                                                                               
VBPRX    DS    0H                                                               
         L     R1,VBASVR1          RESTORE R1                                   
         MVC   20(4,R1),VBADUB     RETURN VAT TOTAL IN PARM 6                   
         MVI   MIXSW,C'N'          SET OFF MIXED JUL/10 SWITCH                  
         XIT1                                                                   
*                                                                               
VBPRDIV  DRNDR (R0),(RF)                                                        
         BR    RE                                                               
         SPACE 2                                                                
***********************************************************************         
*   VBPRMTOT - ADD UP TO 'TOTAL MONTH'                                          
***********************************************************************         
*                                                                               
VBPRMTOT NTR1                                                                   
         L     R2,VBABRKC                      FIRST MONTH/PROV                 
         L     R2,ATOTSV(R2)                                                    
         LH    R3,=Y(MAXMOS*(NPROVS+1)*VBTABL)  POINT TO 'TOTAL MONTH'          
         AR    R3,R2                                                            
*                                                                               
         LA    R0,NPROVS+1         FIRST CLEAR TOTAL                            
         LR    R4,R3                                                            
         XC    0(VBTABL,R4),0(R4)                                               
         LA    R4,VBTABL(R4)                                                    
         BCT   R0,*-10                                                          
*                                  NOW ROLL UP TOTALS                           
         LA    R5,MAXMOS           PROVINCES WITHIN MONTHS                      
*                                                                               
VBMT2    DS    0H                                                               
         LA    R0,NPROVS+1                                                      
         LR    R4,R3                                                            
*                                                                               
VBMT3    DS    0H                                                               
         LA    R1,VBTBLTN          COUNT OF FIELDS                              
*                                                                               
VBMT4    DS    0H                  ROLL UP DOLLAR FIELDS                        
         L     RF,0(R2)                                                         
         A     RF,0(R4)                                                         
         ST    RF,0(R4)                                                         
         LA    R2,4(R2)                                                         
         LA    R4,4(R4)                                                         
         BCT   R1,VBMT4                                                         
*                                  R2 AND R4 NOW AT %,CODE,ETC                  
         OC    0(4,R4),0(R4)       DO WE ALREADY HAVE %                         
         BNZ   VBMT7                                                            
         MVC   0(4,R4),0(R2)       NO, JUST SET %                               
         B     VBMT7B                                                           
*                                                                               
VBMT7    DS    0H                                                               
         OC    0(4,R2),0(R2)    BUT DON'T OVERRIDE WITH NULLS (NO PST)          
         BZ    VBMT7B                                                           
         CLC   0(4,R4),0(R2)       ELSE, ARE THEY THE SAME                      
         BE    VBMT7B                                                           
*                                                                               
VBMT7A   MVC   0(4,R4),=X'FFFFFFFF'  NO, SET MIXED (SHOULDNT HAPPEN??)          
*                                                                               
VBMT7B   DS    0H                                                               
         CLI   4(R4),0             DO WE ALREADY HAVE CODE                      
         BNE   VBMT7D                                                           
         MVC   4(1,R4),4(R2)       NO, JUST SET %                               
         B     VBMT7F                                                           
*                                                                               
VBMT7D   DS    0H                                                               
         CLI   4(R2),0        BUT DON'T OVERRIDE WITH NULLS (NO PST)            
         BE    VBMT7F                                                           
         CLC   4(1,R4),4(R2)       ELSE, ARE THEY THE SAME                      
         BE    VBMT7F                                                           
         MVI   4(R4),X'FF'         NO, SET MIXED (SHOULDNT HAPPEN??)            
*                                                                               
VBMT7F   DS    0H                                                               
VBMT8    DS    0H                                                               
         LA    R2,VBTABL-(VBTBLTN*4)(R2)          BUMP PAST %, ETC.             
         LA    R4,VBTABL-(VBTBLTN*4)(R4)                                        
         BCT   R0,VBMT3                                                         
*                                                                               
         BCT   R5,VBMT2            NEXT MONTH  (NOTE- R2                        
*                                  AUTOMATICALLY POSITIONED)                    
VBPRMX   DS    0H                                                               
         XIT1                                                                   
         DROP  R2                                                               
*                                                                               
         LTORG                                                                  
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBROLL   ROLL-UP VBTAB                                                 
*                                                                               
*        PARM1  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(BRKTAB ENTRY)                                       
*                                                                               
***********************************************************************         
         SPACE 2                                                                
         PRINT NOGEN                                                            
VBROLL   NMOD1 VBAWRKL,VBROLL                                                   
         USING PPWORKD,RA                                                       
         USING PPWORK2D,R9                                                      
         LR    R8,RC                                                            
         USING VBAWRKD,R8                                                       
         LA    RC,SPACEND                                                       
         USING BILWRKD,RC                                                       
*                                                                               
         ICM   R3,15,0(R1)                                                      
         ST    R3,VBABRK           SAVE A(BREAK TABLE ENTRY)                    
         MVC   VBABRKC,BRKCODE-BRKTABD(R3)  BRKTAB ENTRY                        
         ST    R1,VBASVR1                                                       
         SPACE 2                                                                
*                                                                               
         L     R2,VBABRKC          R2 IS THIS LEVEL                             
         L     R2,ATOTSV(R2)                                                    
         LR    R3,R2                                                            
         AH    R3,=Y(VTOTSIZE)     R3 IS NEXT LEVEL                             
*                                                                               
         USING VBTABD,R2                                                        
         LA    R4,(NPROVS+1)*(MAXMOS+1)                                         
*                                                                               
VBR4     DS    0H                                                               
         LA    R5,VBTBLTN          COUNT OF FIELDS                              
*                                                                               
VBR6     DS    0H                                                               
         L     RF,0(R2)                                                         
         A     RF,0(R3)                                                         
         ST    RF,0(R3)                                                         
         XC    0(4,R2),0(R2)       CLEAR OLD                                    
         LA    R2,4(R2)                                                         
         LA    R3,4(R3)                                                         
         BCT   R5,VBR6             NEXT FIELD ENTRY                             
*                                  NOW POINTED AT % AND CODE                    
         OC    0(4,R3),0(R3)       DO WE ALREADY HAVE %                         
         BNZ   VBR7                                                             
         MVC   0(4,R3),0(R2)       NO, JUST SET %                               
         B     VBR7B                                                            
*                                                                               
VBR7     DS    0H                                                               
         OC    0(4,R2),0(R2)    BUT DON'T OVERRIDE WITH NULLS (NO PST)          
         BZ    VBR7B                                                            
         CLC   0(4,R3),0(R2)       ELSE, ARE THEY THE SAME                      
         BE    VBR7B                                                            
         MVC   0(4,R3),=X'FFFFFFFF'  NO, SET MIXED (SHOULDNT HAPPEN??)          
*                                                                               
VBR7B    DS    0H                                                               
         CLI   4(R3),0             DO WE ALREADY HAVE CODE                      
         BNE   VBR7D                                                            
         MVC   4(1,R3),4(R2)       NO, JUST SET %                               
         B     VBR7F                                                            
*                                                                               
VBR7D    DS    0H                                                               
         CLI   4(R2),0        BUT DON'T OVERRIDE WITH NULLS (NO PST)            
         BE    VBR7F                                                            
         CLC   4(1,R3),4(R2)       ELSE, ARE THEY THE SAME                      
         BE    VBR7F                                                            
         MVI   4(R3),X'FF'         NO, SET MIXED (SHOULDNT HAPPEN??)            
*                                                                               
VBR7F    DS    0H                                                               
VBR8     DS    0H                                                               
         XC    0(VBTABL-(VBTBLTN*4),(R2)),0(R2)          CLEAR OLD              
         LA    R2,VBTABL-(VBTBLTN*4)(R2)          BUMP PAST %, ETC.             
         LA    R3,VBTABL-(VBTBLTN*4)(R3)                                        
         BCT   R4,VBR4             NEXT PROVINCE/MONTH                          
*                                                                               
         MVC   VBAMODE,=C'RU'       VBCALC MODE - ROLLUP                        
         L     RF,VBABRK           POINT TO NEXT LEVEL FOR TRACE DESC           
         SH    RF,=Y(BRKL)                                                      
         MVC   VBABRKC,0(RF)                                                    
         GOTO1 =A(VBATRC),VBADMCB,(R8)                                          
*                                                                               
VBROLLX  DS    0H                                                               
         XIT1                                                                   
         DROP  R2                                                               
*                                                                               
         LTORG                                                                  
         TITLE 'PPB12F - PRINTPAK BILLING/SOURCE BOOK F'                        
***********************************************************************         
*                                                                               
*        CONTAINS VARIOUS MODULES FOR BILLING EDI.                              
*                                                                               
***********************************************************************         
*                                                                               
*                                                                               
*        CHANGE LOG                                                             
*                                                                               
*  BPLA   08/00    COPY OF PPB12F AT LEVEL 26 5/04/99                           
*                  COPY MADE 8/16/00                                            
*                  CHANGES TO CATALP AND PPREPB1WKN                             
*                  (WHICH INCLUDES PNNEWFILE IN PLACE OF                        
*                  PPNEWFILE)                                                   
*                  PNNEWFILE INCLUDES PNBILREC IN PLACE                         
*                  OF PBILLREC                                                  
*                                                                               
*   BPLA  5/99   CHECK FOR ERRORS WHEN CALLING TSAROFF                          
*               +CHANGE WLAGEDD TO WLUDATA (SAME FIELD)                         
*                                                                               
*   BPLA  5/98   CD SEPERATE CODE                                               
*                                                                               
*   BPLA  5/98   EDI "CLIENT" NOW IN PROFB1A (+10(3))                           
*                                                                               
*   BPLA 5/98    CHANGES IN MFHDR - EDI CONTROLS                                
*                                                                               
*   BPLA 1/98    CHANGES FOR WORKER FILE, ETC.                                  
*                                                                               
*   BPLA 8/97    MODIFICATIONS FOR PRINTPAK                                     
*                                                                               
*   BPLA 8/97    COPY FROM SPB12E                                               
*                                                                               
         SPACE 2                                                                
         PRINT NOGEN                                                            
BILLEDI  NMOD1 0,**EDI***,(R5)                                                  
***                                                                             
***      NOTE R5 IS SECOND BASE REGISTER                                        
***                                                                             
         USING PPWORKD,RA                                                       
         L     R9,PPWORK2C                                                      
         USING PPWORK2D,R9                                                      
         LA    RC,SPACEND                                                       
         USING BILWRKD,RC                                                       
         L     R8,=A(COMSUBS)      COMMON AREA                                  
         USING COMSUBS,R8                                                       
         LA    R7,BREC                                                          
         USING BILLEDID,R7                                                      
         LA    R6,TSARB                                                         
         USING TSARD,R6                                                         
*                                                                               
         MVC   EDPARMS(24),0(R1)   AND PARMS                                    
         MVC   EDMODE,0(R1)        MODE IS HOB OF PARM1                         
*                                                                               
         CLI   DUESW,C'R'          DON'T PROCESS AOR                            
         BE    XIT                                                              
         CLI   DUESW,C'A'          SEP ADJ BILLS ARE OK                         
         BE    MP03                                                             
         CLI   DUESW,C'C'          SEP CD BILLS ARE OK                          
         BE    MP03                                                             
         CLI   PASSNO,1            DON'T PROCESS DETAIL BACKUP                  
         BH    XIT                                                              
*                                                                               
MP03     DS    0H                                                               
         CLI   FRSTSW,0                                                         
         BNE   *+8                                                              
         BAS   RE,INIT                                                          
*                                                                               
         BAS   RE,SETGN                                                         
*                                  FIND MODE                                    
         LA    RF,MODLIST                                                       
         LA    R0,MODLISTN                                                      
*                                                                               
MP04     DS    0H                                                               
         CLC   EDMODE,0(RF)                                                     
         BE    MP04D                                                            
         LA    RF,5(RF)                                                         
         BCT   R0,MP04                                                          
         DC    H'0'                                                             
*                                                                               
MP04D    DS    0H                                                               
         ICM   RF,15,1(RF)                                                      
         BASR  RE,RF                                                            
         B     XIT                                                              
         EJECT                                                                  
**********************************************************************          
*        INITIALIZATION                                                         
**********************************************************************          
*                                                                               
INIT     NTR1                                                                   
         CLI   EDMODE,EDMCLS       IF CLOSING, NO INIT                          
         BE    INITX                                                            
         MVI   FRSTSW,1                                                         
*                                                                               
*              NOTE- IF WORKER FILES USED, THEY ARE OPENED AT MMFHDR            
*                                                                               
         CLI   OUTMODE,C'D'        DATASET OUTPUT                               
         BNE   INIT4                                                            
         OPEN  (EDIOUT,OUTPUT)                                                  
         B     INIT5                                                            
*                                                                               
INIT4    DS    0H                                                               
INIT5    DS    0H                                                               
         MVC   WORK(8),=CL8'T00A7D'    LOAD TSAROFF                             
         GOTO1 LOADER,DMCB,WORK,0,0                                             
         OC    DMCB+4(4),DMCB+4                                                 
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   ATSAROFF,4(R1)                                                   
*                                                                               
         L     R0,=A(BESIZE)                                                    
         GETMAIN RU,LV=(0),LOC=(ANY,ANY)                                        
         LTR   R1,R1                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         ST    R1,TSABUF                                                        
*                                                                               
         MVC   TSACOM,VCOMFACS                                                  
         MVI   TSKEYL,BEKLN                                                     
         OI    TSRECI,TSRVAR       SET FOR VARIABLE RECS                        
         MVC   TSRECL,=Y(BERECL)                                                
         MVI   TSOFFACT,TSAINI                                                  
         MVC   TSAREC,=A(BESIZE)                                                
         GOTO1 ATSAROFF,(R6)                                                    
*                                                                               
         CLI   TSERRS,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    RF,BREC             SET ADDR'S OF REC AREAS                      
         ST    RF,ABREC                                                         
         LA    RF,ABREC+L'ABREC                                                 
         LA    RF,FREC                                                          
         ST    RF,AFREC                                                         
         LA    RF,4(RF)                                                         
         ST    RF,AFRECP4          REC+4 IS START OF DATA                       
         LA    RF,AFREC+L'AFREC                                                 
         ST    RF,AFRECX                                                        
*                                                                               
INITX    DS    0H                                                               
         B     XIT                                                              
         EJECT                                                                  
**********************************************************************          
*        PRODUCT GROUP                                                          
**********************************************************************          
*                                                                               
EDPGR    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEPGRLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDPGRQ       RECORD TYPE                                  
*                                                                               
         C     R3,APGR3BRK                                                      
         BNE   EDPGR4                                                           
         MVI   BEPGRL,C'3'                                                      
         MVC   BEPGRC,PGR3                                                      
         MVC   BEPGRD,PGR3BK                                                    
         MVC   BEPGRN,PGR3NM                                                    
         BAS   RE,EDPUT                                                         
         B     EDPGRX                                                           
*                                                                               
EDPGR4   DS    0H                                                               
         C     R3,APGR2BRK                                                      
         BNE   EDPGR6                                                           
         MVI   BEPGRL,C'2'                                                      
         MVC   BEPGRC,PGR2                                                      
         MVC   BEPGRD,PGR2BK                                                    
         MVC   BEPGRN,PGR2NM                                                    
         BAS   RE,EDPUT                                                         
         B     EDPGRX                                                           
*                                                                               
EDPGR6   DS    0H                                                               
         MVI   BEPGRL,C'1'                                                      
         MVC   BEPGRC,PGR1                                                      
         MVC   BEPGRD,PGR1BK                                                    
         MVC   BEPGRN,PGR1NM                                                    
         BAS   RE,EDPUT                                                         
*                                                                               
EDPGRX   DS    0H                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        PRODUCT                                                                
**********************************************************************          
*                                                                               
EDPRD    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEPRDLN)   PRODUCT RECORD                            
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDPRDQ       RECORD CODE                                  
         MVC   BEPRD,PRD                                                        
         MVC   BEPRDN,PRDNM                                                     
         OC    BEPRDN,SPACES                                                    
*                                                                               
         MVC   BEPRICD,SPACES                                                   
         L     RF,ADPRD            PRD NUMBER                                   
         LA    RF,PPRDACCT-PPRDREC(RF)                                          
         MVC   BEPRICD(4),0(RF)                                                 
         CLI   0(RF),X'FF'                                                      
         BNE   EDPRD4                                                           
         MVC   FULL,0(RF)                                                       
         MVI   FULL,0                                                           
         EDIT  (B4,FULL),(5,BEPRICD),ALIGN=LEFT                                 
*                                                                               
EDPRD4   DS    0H                                                               
         OC    BEPRICD,SPACES                                                   
         BAS   RE,EDPUT                                                         
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        ESTIMATE                                                               
**********************************************************************          
*                                                                               
EDEST    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEESTLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDESTQ                                                    
         MVC   BEEST,EST                                                        
         MVC   BEESTN,ESTNM                                                     
         OC    BEESTN,SPACES                                                    
         MVC   BEESTN2,ESTNAM2                                                  
         OC    BEESTN2,SPACES                                                   
         BAS   RE,EDPUT                                                         
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        MARKET GROUP                                                           
**********************************************************************          
*                                                                               
EDMGR    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEMGRLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDMGRQ       RECORD TYPE                                  
*                                                                               
         C     R3,AMGR3BRK                                                      
         BNE   EDMGR4                                                           
         MVI   BEMGRL,C'3'                                                      
         MVC   BEMGRC,MGR3                                                      
         MVC   BEMGRD,MGR3BK                                                    
         MVC   BEMGRN,MGR3NM                                                    
         BAS   RE,EDPUT                                                         
         B     EDMGRX                                                           
*                                                                               
EDMGR4   DS    0H                                                               
         C     R3,AMGR2BRK                                                      
         BNE   EDMGR6                                                           
         MVI   BEMGRL,C'2'                                                      
         MVC   BEMGRC,MGR2                                                      
         MVC   BEMGRD,MGR2BK                                                    
         MVC   BEMGRN,MGR2NM                                                    
         BAS   RE,EDPUT                                                         
         B     EDMGRX                                                           
*                                                                               
EDMGR6   DS    0H                                                               
         MVI   BEMGRL,C'2'                                                      
         MVC   BEMGRC,MGR1                                                      
         MVC   BEMGRD,MGR1BK                                                    
         MVC   BEMGRN,MGR1NM                                                    
         BAS   RE,EDPUT                                                         
*                                                                               
EDMGRX   DS    0H                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        MARKET                                                                 
**********************************************************************          
*                                                                               
EDMKT    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEMKTLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDMKTQ       RECORD TYPE                                  
         L     RF,AMKT                                                          
         MVC   BEMKTN(20),0(RF)                                                 
         OC    BEMKTN,SPACES                                                    
         BAS   RE,EDPUT                                                         
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        PUBLICATION                                                            
**********************************************************************          
*                                                                               
EDPUB    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEPUBLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDPUBQ       RECORD TYPE                                  
         MVC   BEPUBN,PPUBL1                                                    
         MVC   BEPUBN2,PPUBL2                                                   
         BAS   RE,EDPUT                                                         
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        JOB OR AD                                                              
**********************************************************************          
*                                                                               
EDJOB    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEJOBLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDJOBQ       RECORD TYPE                                  
         MVC   BEJOB1,JOBL1                                                     
         MVC   BEJOB2,JOBL2                                                     
         MVC   BEJOB3,JOBL3                                                     
         MVC   BEJOB4,JOBL4                                                     
         MVC   BEJOB5,JOBL5                                                     
         BAS   RE,EDPUT                                                         
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        INSERTION DATE AND AMOUNTS                                             
**********************************************************************          
*                                                                               
EDINS    NTR1                                                                   
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEIDETLN)                                            
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDINSQ                                                    
*                                                                               
*                                                                               
EDINS12  DS    0H                 INSERTION DATE                                
         L     RF,=A(PPBYOWRK)                                                  
         USING PPBYOUTD,RF                                                      
         MVC   BEIDDESC,SPACES        CLEAR                                     
         MVC   BEIDDESC(20),PBYOSPC  DESCRIPTION  (FIRST 20)                    
         OC    BEIDDESC,SPACES     (MIGHT HAVE X'00'S AT END                    
*                                                                               
         CLC   PBYOSPC2,SPACES     SOMETHING THERE?                             
         BE    EDINS13X                                                         
*                                                                               
         CLC   BEIDDESC,SPACES       IS IT STILL SPACES (NO PBYOSPC1)           
         BNE   EDINS12A                                                         
         MVC   BEIDDESC(L'PBYOSPC2),PBYOSPC2                                    
         B     EDINS13X                                                         
*                                                                               
EDINS12A DS    0H                                                               
         CLI   QMEDIA,C'O'            SEE IF OUTDOOR                            
         BNE   EDINS13A                                                         
         MVI   BEIDIDAT+10,X'FF'     SO SCAN WON'T GO BACK TOO FAR              
         LA    R1,BEIDDESC+L'BEIDDESC-1                                         
EDINS12B CLI   0(R1),C'G'            'G' OF SHOWING                             
         BE    EDINS12D                                                         
         CLI   0(R1),X'FF'           PAST START OF BEIDDESC?                    
         BE    EDINS13A              YES                                        
*                                                                               
EDINS12C BCT   R1,EDINS12B                                                      
         B     EDINS13A              NO 'G' FOUND                               
*                                                                               
EDINS12D LR    R2,R1                                                            
         SH    R2,=H'6'                                                         
         CLC   0(6,R2),=C'SHOWING'                                              
         BNE   EDINS13A              IF NOT CAN'T DO ANYTHING                   
         MVC   4(3,R2),SPACES        CHANGE TO SHOW                             
*                                    SO THAT MORE OF PBYOSPC2 CAN FIT           
*                                                                               
EDINS13A MVI   BEIDIDAT+10,X'FF'     SO SCAN WON'T GO BACK TOO FAR              
*                                    WILL BE OVERWRITTEN BY INS DATE            
         LA    R1,BEIDDESC+L'BEIDDESC-1                                         
         LR    R2,R1                                                            
EDINS13B CLI   0(R1),C' '         SCAN BACKWARD FOR FIRST NON-SPACE             
         BH    EDINS13C                                                         
         BCT   R1,EDINS13B                                                      
*                                                                               
EDINS13C SR    R2,R1    TO GET LENGTH AVAILABLE                                 
         SH    R2,=H'2' MUST SUBTRACT 2                                         
*                                                                               
         CH    R2,=AL2(L'PBYOSPC2)  SEE IF ALL CAN FIT                          
         BNH   *+8                                                              
         LH    R2,=AL2(L'PBYOSPC2)  RE-SET R2 TO LENGTH OF PBYOSPC2             
*                                                                               
         EX    R2,*+8                                                           
         B     *+10                                                             
*                                                                               
         MVC   2(0,R1),PBYOSPC2   MOVE THE PART THAT I HAVE ROOM FOR            
*                                                                               
EDINS13X MVC   BEIDIDAT(11),PBYOMDY    INSERTION DATE                           
*                                                                               
         DROP  RF                                                               
*                                 MAY INCLUDE LINE NO.                          
         OC    EDPARMS+1(3),EDPARMS+1    DO I HAVE A SPECIAL CHARGE?            
         BZ    EDINS13                                                          
         L     RF,EDPARMS                                                       
         MVC   BEIDDESC,SPACES        CLEAR                                     
         MVC   BEIDDESC(L'ADCCOD1+1+L'ADCDES1),0(RF)                            
         OC    BEIDDESC,SPACES                                                  
*                                                                               
EDINS13  DS    0H                                                               
         MVC   BEIDREFN,X          REFERENCE NUMBER                             
         OC    BEIDREFN,SPACES                                                  
*                                                                               
EDINS15  L     R2,ASORTDTA         POINT TO $                                   
*                                                                               
         TM    GNCTL,X'80'         GROSS                                        
         BZ    EDINS16                                                          
         EDIT  (B4,00(R2)),(11,BEIDOGRS),FLOAT=-,ALIGN=LEFT,           X        
               ZERO=NOBLANK                                                     
         EDIT  (B4,ROWHL+00(R2)),(11,BEIDPGRS),FLOAT=-,ALIGN=LEFT,     X        
               ZERO=NOBLANK                                                     
*                                                                               
EDINS16  DS    0H                                                               
         TM    GNCTL,X'40'         NET                                          
         BZ    EDINS18                                                          
         EDIT  (B4,04(R2)),(11,BEIDONET),FLOAT=-,ALIGN=LEFT,           X        
               ZERO=NOBLANK                                                     
         EDIT  (B4,ROWHL+04(R2)),(11,BEIDPNET),FLOAT=-,ALIGN=LEFT,     X        
               ZERO=NOBLANK                                                     
*                                                                               
EDINS18  DS    0H                                                               
         EDIT  (B4,08(R2)),(11,BEIDOCD),FLOAT=-,ALIGN=LEFT,            X        
               ZERO=NOBLANK                                                     
         EDIT  (B4,ROWHL+08(R2)),(11,BEIDPCD),FLOAT=-,ALIGN=LEFT,      X        
               ZERO=NOBLANK                                                     
         EDIT  (B4,16(R2)),(11,BEIDOTAX),FLOAT=-,ALIGN=LEFT,           X        
               ZERO=NOBLANK                                                     
         EDIT  (B4,ROWHL+16(R2)),(11,BEIDPTAX),FLOAT=-,ALIGN=LEFT,     X        
               ZERO=NOBLANK                                                     
*                                                                               
*                                                                               
         MVC   BEIDMISC,SPACES         CLEAR MISCELLANEOUS INFO                 
         CLC   QAGENCY,=C'YN'          YNR OUTDOOR?                             
         BNE   EDINSX                                                           
         CLI   QMEDIA,C'O'            OUTDOOR?                                  
         BNE   EDINSX                                                           
         L     RF,=A(PPBYOWRK)                                                  
         USING PPBYOUTD,RF                                                      
         CLC   PBYOCOMS+47(4),=C'-   ' MKT IN SECOND BEGINS LIKE THIS           
         MVC   BEIDMISC(37),PBYOCOMS+47+10  MKT NAME HERE                       
*                                                                               
*                                                                               
EDINSX   BAS   RE,EDPUT                                                         
*                                                                               
         DROP  RF                                                               
*                                                                               
         B     XIT                                                              
         EJECT                                                                  
**********************************************************************          
*        MONTHLY TOTAL AMOUNTS                                                  
**********************************************************************          
*                                                                               
EDMTA    NTR1                                                                   
*                                                                               
         L     R3,SAVBRK                                                        
         CLI   3(R3),X'34'          SEE IF INSERTION LEVEL                      
         BE    XIT                  NO TOTALS (FOR NOW)                         
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEDETLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDMTAQ                                                    
*                                                                               
         L     R3,SAVBRK           BREAK TABLE ENTRY                            
         MVC   BEDLEV,3(R3)        BREAK LEVEL CODE                             
         C     R3,AINVBRK          IF AND END OF INVOICE                        
         BNE   *+8                                                              
         MVI   BEDLEV,X'FF'        SAY SO                                       
*                                                                               
         L     R3,PERLIND          PERIOD (PERLIST INDEX)                       
         LA    R3,PERLIST(R3)                                                   
*                                                                               
         CLI   0(R3),X'FF'                                                      
         BNE   EDMTA12                                                          
         MVC   BEDMOS(5),=C'TOTAL'                                              
         B     EDMTA14                                                          
*                                                                               
EDMTA12  DS    0H                                                               
**SPOT** CLI   SPOTPROF+2,0        TEST CALENDAR TYPE                           
**SPOT** BNE   EDMTA13                                                          
         GOTO1 DATCON,DMCB,(3,0(R3)),(6,BEDMOS)  NORMAL MMMYY                   
         B     EDMTA14                                                          
*                                                                               
EDMTA13  DS    0H                                                               
         GOTO1 DATCON,DMCB,(2,2(R3)),(5,BEDMOS)  OTHER MMMDD/YY                 
*                                                                               
EDMTA14  DS    0H                                                               
*                                                                               
*****                                                                           
*****    NOTE-I'M NOT SET-UP TO HANDLE BILLING AGY COMM.                        
*****                                                                           
         L     RF,EDPARMS                                                       
         MVC   BEDPINV,0(RF)                                                    
*                                                                               
         TM    GNCTL,X'80'         GROSS                                        
         BZ    EDMTA16                                                          
         EDIT  (B4,00(R2)),(11,BEDOGRS),FLOAT=-,ALIGN=LEFT,            X        
               ZERO=NOBLANK                                                     
         EDIT  (B4,ROWHL+00(R2)),(11,BEDPGRS),FLOAT=-,ALIGN=LEFT,      X        
               ZERO=NOBLANK                                                     
*                                                                               
EDMTA16  DS    0H                                                               
         TM    GNCTL,X'40'         NET                                          
         BZ    EDMTA18                                                          
         EDIT  (B4,04(R2)),(11,BEDONET),FLOAT=-,ALIGN=LEFT,            X        
               ZERO=NOBLANK                                                     
         EDIT  (B4,ROWHL+04(R2)),(11,BEDPNET),FLOAT=-,ALIGN=LEFT,      X        
               ZERO=NOBLANK                                                     
*                                                                               
EDMTA18  DS    0H                                                               
         EDIT  (B4,08(R2)),(11,BEDOCD),FLOAT=-,ALIGN=LEFT,             X        
               ZERO=NOBLANK                                                     
         EDIT  (B4,ROWHL+08(R2)),(11,BEDPCD),FLOAT=-,ALIGN=LEFT,       X        
               ZERO=NOBLANK                                                     
         EDIT  (B4,16(R2)),(11,BEDOTAX),FLOAT=-,ALIGN=LEFT,            X        
               ZERO=NOBLANK                                                     
         EDIT  (B4,ROWHL+16(R2)),(11,BEDPTAX),FLOAT=-,ALIGN=LEFT,      X        
               ZERO=NOBLANK                                                     
         EDIT  (B4,20(R2)),(11,BEDOINS),FLOAT=-,ALIGN=LEFT,            X        
               ZERO=NOBLANK                                                     
         EDIT  (B4,ROWHL+20(R2)),(11,BEDPINS),FLOAT=-,ALIGN=LEFT,      X        
               ZERO=NOBLANK                                                     
*                                                                               
         BAS   RE,EDPUT                                                         
*                                                                               
         B     XIT                                                              
         EJECT                                                                  
**********************************************************************          
*        DETAIL AMOUNTS, ETC.  NO-OPED (REPLACED BY EDMTA)                      
*                              IF RESTORING, CONTINUATION NEEDED FOR            
*                              EDIT STATEMENTS                                  
**********************************************************************          
*                                                                               
**DET    NTR1                                                                   
**       XC    BEKEY,BEKEY                                                      
**       MVC   BEREC(2),=Y(BEDETLN)                                             
**       MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
**       MVI   BEKRCD,EDDETQ                                                    
**                                                                              
**       L     R3,SAVBRK           BREAK TABLE ENTRY                            
**       MVC   BEDLEV,3(R3)        BREAK LEVEL CODE                             
**       C     R3,AINVBRK          IF AND END OF INVOICE                        
**       BNE   *+8                                                              
**       MVI   BEDLEV,X'FF'        SAY SO                                       
**                                                                              
**SPOT** L     R3,PERLIND          PERIOD (PERLIST INDEX)                       
**SPOT** LA    R3,PERLIST(R3)                                                   
**                                                                              
**       LA    R3,PERLIST                                                       
**       CLI   0(R3),X'FF'                                                      
**       BNE   EDD20                                                            
**       MVC   BEDMOS(5),=C'TOTAL'                                              
**       B     EDD30                                                            
**                                                                              
**D20    DS    0H                                                               
**SPOT** CLI   SPOTPROF+2,0        TEST CALENDAR TYPE                           
**SPOT** BNE   EDD25                                                            
**       GOTO1 DATCON,DMCB,(3,0(R3)),(6,BEDMOS)  NORMAL MMMYY                   
**       B     EDD30                                                            
**                                                                              
**D25    DS    0H                                                               
**       GOTO1 DATCON,DMCB,(2,2(R3)),(5,BEDMOS)  OTHER MMMDD/YY                 
**                                                                              
**D30    DS    0H                                                               
**       MVI   BEDTYP,C'T'         T=TIME COSTS                                 
**                                                                              
**       L     RF,EDPARMS                                                       
**       MVC   BEDPINV,0(RF)                                                    
**                                                                              
**       EDIT  (B4,00(R2)),(11,BEDOGRS),FLOAT=-,ALIGN=LEFT,                     
**             ZERO=NOBLANK                                                     
**       EDIT  (B4,04(R2)),(11,BEDONET),FLOAT=-,ALIGN=LEFT,                     
**             ZERO=NOBLANK                                                     
**       EDIT  (B4,08(R2)),(11,BEDOCD),FLOAT=-,ALIGN=LEFT,                      
**             ZERO=NOBLANK                                                     
**       EDIT  (B4,16(R2)),(11,BEDOTAX),FLOAT=-,ALIGN=LEFT,                     
**             ZERO=NOBLANK                                                     
**       EDIT  (B4,20(R2)),(11,BEDOINS),FLOAT=-,ALIGN=LEFT,                     
**             ZERO=NOBLANK                                                     
**                                                                              
**       EDIT  (B4,ROWHL+00(R2)),(11,BEDPGRS),FLOAT=-,ALIGN=LEFT,               
**             ZERO=NOBLANK                                                     
**       EDIT  (B4,ROWHL+04(R2)),(11,BEDPNET),FLOAT=-,ALIGN=LEFT,               
**             ZERO=NOBLANK                                                     
**       EDIT  (B4,ROWHL+08(R2)),(11,BEDPCD),FLOAT=-,ALIGN=LEFT,                
**             ZERO=NOBLANK                                                     
**       EDIT  (B4,ROWHL+16(R2)),(11,BEDPTAX),FLOAT=-,ALIGN=LEFT,               
**             ZERO=NOBLANK                                                     
**       EDIT  (B4,ROWHL+20(R2)),(11,BEDPINS),FLOAT=-,ALIGN=LEFT,               
**             ZERO=NOBLANK                                                     
**                                                                              
**       BAS   RE,EDPUT                                                         
**                                                                              
**       B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        COMMENTS                                                               
**********************************************************************          
*                                                                               
EDCOM    NTR1                                                                   
         L     R4,ACOMREC                                                       
         CLI   0(R4),0             TEST COMMENT PRESENT                         
         BE    EDCMX                                                            
*                                                                               
         LA    R4,33(R4)           FIRST ELEM                                   
*                                                                               
EDCM2    DS    0H                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BECOMLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDCOMQ                                                    
*                                                                               
         L     R3,SAVBRK           BREAK TABLE ENTRY                            
         MVC   BECOMLEV,3(R3)      BREAK LEVEL CODE                             
         C     R3,AINVBRK          IF AND END OF INVOICE                        
         BNE   *+8                                                              
         MVI   BECOMLEV,X'FF'      SAY SO                                       
*                                                                               
         CLI   0(R4),0             EOR                                          
         BE    EDCM10                                                           
         CLI   0(R4),X'40'         COMMENT ELEM                                 
         BNE   EDCM4                                                            
         ZIC   RE,1(R4)            ELEM LENGTH                                  
         SH    RE,=H'3'            SET FOR EX                                   
         BM    EDCM4                                                            
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   BECOMTXT(0),2(R4)                                                
         BAS   RE,EDPUT                                                         
*                                                                               
EDCM4    DS    0H                                                               
         ZIC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         B     EDCM2                                                            
*                                                                               
EDCM10   DS    0H                                                               
*                                                                               
EDCMX    DS    0H                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        BILLING HEADER                                                         
**********************************************************************          
*                                                                               
EDHDR    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVI   BEKRCLS,EDRSRTHQ    HEADER CLASS                                 
         MVI   BEKRCD,EDHDRQ                                                    
         L     RF,ADBILL                                                        
         SR    RE,RE                                                            
         ICM   RE,3,25(RF)                                                      
         STH   RE,BEREC            SET RECORD LENGTH                            
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   BEHDRC(0),0(RF)                                                  
         BAS   RE,EDPUT                                                         
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        BILLING ADDRESS                                                        
**********************************************************************          
*                                                                               
EDADD    NTR1                                                                   
         TM    EDNEWSW,X'80'       TEST HAVE ALAREADY DONE ADDRESS              
         BNZ   EDADDX                                                           
         OI    EDNEWSW,X'80'                                                    
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEADDLN)                                             
         MVI   BEKRCLS,EDRSRTAQ    ADDRESS SORT GROUP                           
         MVI   BEKRCD,EDADDQ                                                    
         MVC   BEADDL1,HEAD7+46                                                 
         MVC   BEADDL2,HEAD8+46                                                 
         MVC   BEADDL3,HEAD9+46                                                 
         MVC   BEADDL4,HEAD10+46                                                
         MVC   BEADDL5,HEAD11+46                                                
*                                                                               
         BAS   RE,EDPUT                                                         
*                                                                               
EDADDX   DS    0H                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        USER DEFINITION FIELDS                                                 
**********************************************************************          
*                                                                               
EDUSR    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEUSRLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDUSRQ                                                    
         L     RF,EDPARMS                                                       
         MVC   BEUSRTXT(2),0(RF)                                                
*                                                                               
         MVC   BEUSRTXT+2(L'BEUSRTXT-2),W     (W FOR PRINT)                     
*                                  (MFUSR ROUTINE WILL SORT IT OUT)             
         BAS   RE,EDPUT                                                         
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        USER COMMENT FIELDS                                                    
**********************************************************************          
*                                                                               
EDUCM    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEUCMLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDUCMQ                                                    
         L     RF,EDPARMS                                                       
         MVC   BEUCMTXT(2),0(RF)                                                
*                                                                               
         MVC   BEUCMTXT+2(L'BEUCMTXT-2),W     (W FOR PRINT)                     
*                                  (MFUCM ROUTINE WILL SORT IT OUT)             
         BAS   RE,EDPUT                                                         
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        LIST OF PREVIOUS BILLS                                                 
**********************************************************************          
*                                                                               
EDLST    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BDLSTLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDLSTQ                                                    
*                                                                               
         L     RF,EDPARMS                                                       
         MVC   BDLSTIN,0(RF)    INVOICE NUMBER                                  
         L     RF,EDPARMS+4                                                     
         EDIT  (B4,0(RF)),(11,BDLSTG),FLOAT=-,ALIGN=LEFT,              X        
               ZERO=NOBLANK                                                     
         L     RF,EDPARMS+8                                                     
         EDIT  (B4,0(RF)),(11,BDLSTN),FLOAT=-,ALIGN=LEFT,              X        
               ZERO=NOBLANK                                                     
         L     RF,EDPARMS+12                                                    
         EDIT  (B4,0(RF)),(11,BDLSTCD),FLOAT=-,ALIGN=LEFT,             X        
               ZERO=NOBLANK                                                     
*                                                                               
         BAS   RE,EDPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        AMOUNT DUE                                                             
*          P1=A(FORMULA)  R4 IN PRTADJ                                          
*          P2=A(TOTAL)    R7 IN PRTADJ                                          
*  (SPOT)  P3=INDEX TO CURRENCY (0=AGENCY, 4=CLIENT)   R6 IN PRTADJ             
*                                                                               
**********************************************************************          
*                                                                               
EDDUE    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BDUELN)                                              
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDDUEQ                                                    
*                                                                               
         L     R3,SAVBRK                                                        
         MVC   BDULEV,3(R3)        BREAK LEVEL CODE                             
         C     R3,AINVBRK          IF END OF INVOICE                            
         BNE   *+8                                                              
         MVI   BDULEV,X'FF'        SAY SO                                       
*                                                                               
         L     R4,EDPARMS          A(BFORM)                                     
         USING BFORMD,R4                                                        
         MVI   BDUBB,C'G'          BILL BASIS - GROSS                           
         CLI   BFBASA,X'01'                                                     
         BE    EDD4                                                             
         MVI   BDUBB,C'N'          BILL BASIS - NET                             
         CLI   BFBASA,X'02'                                                     
         BE    EDD4                                                             
         MVI   BDUBB,C'1'          GROSS-CD                                     
         CLI   BFBASA,X'05'        GROSS-CD                                     
         BE    EDD4                                                             
         MVI   BDUBB,C'2'          NET-CD                                       
         CLI   BFBASA,X'06'        NET-CD                                       
         BE    EDD4                                                             
         MVI   BDUBB,C'A'          AGY COMM                                     
         CLI   BFBASA,X'08'        AGY COMM                                     
         BE    EDD4                                                             
         MVI   BDUBB,C'M'          AGY COMM                                     
         CLI   BFBASA,X'FF'                                                     
         BE    EDD4                                                             
         DC    H'0'                BAD BILLING FORMULA                          
*                                                                               
EDD4     DS    0H                  COMMISSION BASIS                             
         MVI   BDUCB,C'G'          BILL BASIS - GROSS                           
         CLI   BFBASB,X'01'                                                     
         BE    EDD6                                                             
         MVI   BDUCB,C'N'          BILL BASIS - NET                             
         CLI   BFBASB,X'02'                                                     
         BE    EDD6                                                             
         MVI   BDUCB,C'1'          GROSS-CD                                     
         CLI   BFBASB,X'05'        GROSS-CD                                     
         BE    EDD6                                                             
         MVI   BDUCB,C'2'          NET-CD                                       
         CLI   BFBASB,X'06'        NET-CD                                       
         BE    EDD6                                                             
         MVI   BDUCB,C'A'          AGY COMM                                     
         CLI   BFBASB,X'08'        AGY COMM                                     
         BE    EDD6                                                             
         MVI   BDUCB,C'M'          AGY COMM                                     
         CLI   BFBASB,X'FF'                                                     
         BE    EDD6                                                             
*                                                                               
         MVC   BDUCB,BDUBB    IF NONE OF THESE, SET TO SAME AS BFBASA           
*                                                                               
*        DON'T DUMP AS BILLING FORMULA RECORDS MAY NOT HAVE A BFBASB            
*        % SHOULD BE ZERO                                                       
*                                                                               
******   DC    H'0'                BAD BILLING FORMULA                          
*                                                                               
EDD6     DS    0H                                                               
         CLC   BFCOMP,FFS          MIXED %'S                                    
         BE    EDD8                                                             
         EDIT  (B3,BFCOMP),(11,BDUCP),FLOAT=-,ALIGN=LEFT,ZERO=NOBLANK           
*                                                                               
EDD8     DS    0H                                                               
         L     R3,EDPARMS+4        A(TOTALS)                                    
**SPOT** A     R3,EDPARMS+8        CURRENCY INDEX                               
*                                                                               
         CLI   DUESW,C'C'          SEE IF DOING CD SEPERATE INV                 
         BE    EDD15                                                            
*                                                                               
         CLI   ADJSEP,C'Y'                                                      
         BE    EDD10                                                            
*                                                                               
         L     RE,DUEDSP(R3)       AMOUNT DUE                                   
         S     RE,ADJDSP(R3)       LESS ADJUSTMENT = BASIS AMOUNT               
         EDIT  (RE),(11,BDUBBA),FLOAT=-,ALIGN=LEFT,ZERO=NOBLANK                 
*                                                                               
         L     RE,ADJDSP(R3)       ADJUSTMENT                                   
         EDIT  (RE),(11,BDUCBA),FLOAT=-,ALIGN=LEFT,ZERO=NOBLANK                 
*                                                                               
         CLI   MIDASSW,C'Y'        SEE IF MIDAS                                 
         BNE   EDD8C                                                            
         CLI   BDULEV,X'FF'        INVOICE LEVEL                                
         BNE   EDD8C                                                            
         L     RE,SVAMTDUE         IT INCLUDES TRADE CREDIT                     
         B     EDD8D                                                            
*                                                                               
EDD8C    L     RE,DUEDSP(R3)       AMOUNT DUE                                   
EDD8D    EDIT  (RE),(11,BDUAMT),FLOAT=-,ALIGN=LEFT,ZERO=NOBLANK                 
         B     EDD18                                                            
*                                                                               
EDD10    DS    0H                  SEP ADJUSTMENT                               
         CLI   DUESW,C'A'          ACTUAL ADJUSTMENT BILL?                      
         BNE   EDD12                                                            
*                                  YES, SPECIAL AMOUNTS                         
         MVI   BDUBBA,C'0'         BASE IS $0??                                 
*                                                                               
         L     RE,ADJDSP(R3)       ADJUSTMENT                                   
         EDIT  (RE),(11,BDUCBA),FLOAT=-,ALIGN=LEFT,ZERO=NOBLANK                 
*                                                                               
         MVC   BDUAMT,BDUCBA       ADJUSTMENT IS AMOUNT DUE                     
*                                                                               
         B     EDD18                                                            
*                                                                               
EDD12    DS    0H                  BASE BILL IN SEP ADJ SITUATION               
         L     RE,DUEDSP(R3)       AMOUNT DUE                                   
         S     RE,ADJDSP(R3)       LESS ADJUSTMENT = BASIS AMOUNT               
         EDIT  (RE),(11,BDUBBA),FLOAT=-,ALIGN=LEFT,ZERO=NOBLANK                 
*                                                                               
         MVI   BDUCBA,C'0'         ADJUSTMENT IS $0.                            
*                                                                               
         MVC   BDUAMT,BDUBBA       DUE IS BASE AMOUNT                           
         B     EDD18                                                            
*                                                                               
EDD15    DS    0H              CD SEPERATE INVOICE                              
         MVI   BDUBBA,C'0'     BASIS IS 0                                       
         MVI   BDUCBA,C'0'     ADJUSTMENT IS 0                                  
         L     RE,RCDD(R3)     CD                                               
         S     RE,RBCDD(R3)    LESS PREV. BILLED CD                             
*                                                                               
         LCR   RE,RE           REVERSE SIGN                                     
*                              AMOUNT DUE IS CD                                 
         EDIT  (RE),(11,BDUAMT),FLOAT=-,ALIGN=LEFT,ZERO=NOBLANK                 
*                                                                               
EDD18    DS    0H                                                               
*                                                                               
         BAS   RE,EDPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        CANADIAN TAXES - DATA WILL BE IN ECTAX FIELDS                          
**********************************************************************          
*                                                                               
EDCTAX   NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BCTXLN)                                              
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDCTAXQ                                                   
*                                                                               
         MVC   BCTXT,ECTAXT        TYPE                                         
         MVC   BCTXA,ECTAXA        ACCOUNT NUMBER                               
         CLC   ECTAXP,FFS          MIXED %                                      
         BE    EDCX8                                                            
         EDIT  (B4,ECTAXP),(11,BCTXP),FLOAT=-,ALIGN=LEFT,ZERO=NOBLANK           
*                                                                               
EDCX8    DS    0H                                                               
         EDIT  (B4,ECTAXB),(11,BCTXB),FLOAT=-,ALIGN=LEFT,ZERO=NOBLANK           
         EDIT  (B4,ECTAX),(11,BCTXTAX),FLOAT=-,ALIGN=LEFT,ZERO=NOBLANK          
*                                                                               
         BAS   RE,EDPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        TOTAL AMOUNT DUE INCLUDING CANADIAN TAXES                              
*        ONLY PRESENT WHEN CANADIAN TAXES ARE                                   
**********************************************************************          
*                                                                               
EDTDUE   NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BTDUELN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDTDUEQ      RECORD TYPE                                  
         EDIT  (B4,ECTOTD),(11,BTDUAMT),FLOAT=-,ALIGN=LEFT,ZERO=NOBLANK         
         BAS   RE,EDPUT                                                         
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        REMITTANCE ADDRESS                                                     
*        NOT AVAILABLE FOR PRINTPAK                                             
**********************************************************************          
*                                                                               
*DRMA    NTR1                                                                   
*        MVC   BEREC(2),=Y(BERMALN)                                             
*        MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
*        MVI   BEKRCD,EDRMAQ                                                    
*        L     R4,ADSTATAD                                                      
*        USING ADDRREC,R4                                                       
*        MVC   BERMNAM,ANAME                                                    
*        MVC   BERMADR,A1LINE                                                   
*        MVC   BERMCTY,A2LINE                                                   
*        MVC   BERMSTA,A3LINE                                                   
*        MVC   BERMZIP,ABIGZIP                                                  
*                                                                               
*        OC    BERMNAM,SPACES                                                   
*        OC    BERMADR,SPACES                                                   
*        OC    BERMCTY,SPACES                                                   
*        OC    BERMSTA,SPACES                                                   
*        OC    BERMZIP,SPACES                                                   
*                                                                               
*        BAS   RE,EDPUT                                                         
*        DROP  R4                                                               
*                                                                               
*        B     XIT                                                              
         EJECT                                                                  
**********************************************************************          
*        END OF INVOICE                                                         
**********************************************************************          
*                                                                               
EDEND    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BECLTLN)   CLIENT RECORD                             
         MVI   BEKRCLS,EDRSRTHQ    HEADER CLASS                                 
         MVI   BEKRCD,EDADVQ                                                    
         MVC   BECLT,CLIENT                                                     
         L     RF,ADCLT                                                         
         MVC   BECLTN(L'PCLTNAME),PCLTNAME-PCLTREC(RF)                          
         OC    BECLTN,SPACES                                                    
EDENDB   DS    0H                                                               
         CLI   PCLTNUM-PCLTREC(RF),X'FF'                                        
         BNE   EDENDC                       PWOS                                
         UNPK  WORK(5),PCLTNUM+1-PCLTREC(3,RF)                                  
         B     EDENDD                                                           
*                                                                               
EDENDC   MVC   BYTE,PCLTNUM-PCLTREC(RF)                                         
         NI    BYTE,X'F0'                                                       
         CLI   BYTE,X'80'                                                       
         BNE   EDENDC8                                                          
         XC    FULL,FULL                                                        
         MVC   FULL+1(3),PCLTNUM-PCLTREC(RF)                                    
         NI    FULL+1,X'7F'              SET-OFF X'80'                          
         L     R0,FULL                                                          
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  WORK(5),DUB                                                      
         CLC   QAGENCY,=C'KA'        SPECIAL FOR KA                             
         BNE   EDENDC4                                                          
         MVC   WORK+10(5),WORK                                                  
         MVC   WORK(5),SPACES                                                   
         MVC   WORK(4),WORK+1       NOTE - DROPS HIGH DIGIT                     
         B     EDENDD                                                           
*                                                                               
EDENDC4  DS    0H                                                               
         B     EDENDD                                                           
*                                                                               
EDENDC8  MVC   WORK(3),PCLTNUM-PCLTREC(RF)                                      
         OC    WORK(5),SPACES                                                   
EDENDD   MVC   BECLTICD(5),WORK                                                 
         OC    BECLTICD,SPACES                                                  
         BAS   RE,EDPUT                                                         
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEAGMLN)    AGENCY/MEDIA RECORD                      
         MVI   BEKRCLS,EDRSRTHQ    HEADER CLASS                                 
         MVI   BEKRCD,EDAGMQ                                                    
         MVI   BEAGMMED,C'P'           FOR PRINTPAK                             
         MVC   BEAGMMED+1(1),MEDIA     MEDIA                                    
         MVC   BEAGMMN,MEDNM           MEDIA NAME                               
         MVC   BEAGMAN,AGYNM           AGENCY NAME                              
         MVC   BEAGMAD,AGYADR          AGENCY ADDRESS                           
         BAS   RE,EDPUT                                                         
*                                  AT END OF INVOICE                            
         BAS   RE,EDTRC            TRACE                                        
*                                                                               
         GOTO1 =A(MAKEFILE),DMCB,SPACEND   CREATE OUTPUT FILE                   
*                                                                               
         MVI   TSOFFACT,TSAINI     RE-INITIALIZE TSAROFF                        
         MVC   TSAREC,=A(BESIZE)                                                
         GOTO1 ATSAROFF,(R6)                                                    
*                                                                               
         CLI   TSERRS,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVI   EDNEWSW,X'00'       CLEAR ED ROUTINES NEWSW                      
         B     XIT                                                              
         EJECT                                                                  
**********************************************************************          
*        CLOSE                                                                  
**********************************************************************          
*                                                                               
EDCLS    NTR1                                                                   
         CLI   FRSTSW,0            TEST EDI OPEN                                
         BE    ECLX                                                             
*                                                                               
         CLI   OUTMODE,C'D'        DATASET OUTPUT                               
         BNE   EDCLS8                                                           
*                                                                               
         CLOSE EDIOUT                                                           
*                                TRACE OUTPUT FILE                              
         L     RF,APATCH                                                        
         TM    0(RF),X'04'         TEST NEED FINAL TRACE                        
         BZ    ECLX                                                             
*                                                                               
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
         OPEN  (EDITRC,INPUT)                                                   
*                                                                               
EDCLS2   DS    0H                                                               
         BAS   RE,CLRFREC                                                       
         LA    R2,EDITRC                                                        
         GET   (R2),FREC                                                        
         MVC   P1(132),FREC                                                     
         MVI   SKIPSPEC,C'Y'                                                    
         GOTO1 =A(PRNT)                                                         
         B     EDCLS2                                                           
*                                                                               
EDCLS4   DS    0H                                                               
         B     XIT                                                              
*                                  CLOSE FOR WORKER FILE                        
EDCLS8   DS    0H                                                               
         GOTO1 DATAMGR,DMCB,=C'CLOSE',WRKRFIL,0,FREC,AWRKBUFF                   
*                                NO TRACE OF OUTPUT FILE                        
         B     XIT                                                              
*                                                                               
EDTRCEOF DS    0H                                                               
         CLOSE EDITRC                                                           
*                                                                               
ECLX     DS    0H                                                               
         B     XIT                                                              
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
*        MAKEFILE - CREATE OUTPUT FILE FROM TSAR BUFFER                         
**********************************************************************          
*                                                                               
MAKEFILE DS    0D                                                               
         NMOD1 0,**MKF***                                                       
         LA    RC,SPACEND                                                       
*                                  READ THRU TSAR BUFFER                        
         ST    R7,TSAREC                                                        
         XC    BREC(BEKLN),BREC                                                 
         MVI   TSOFFACT,TSARDH                                                  
         B     MKF4B                                                            
*                                                                               
MKF4     DS    0H                                                               
         MVI   TSOFFACT,TSANXT                                                  
*                                                                               
MKF4B    DS    0H                                                               
         GOTO1 ATSAROFF,(R6)                                                    
         TM    TSERRS,TSEEOF                                                    
         BO    MKF20                                                            
*                                                                               
         TM    TSERRS,X'FF'-TSERNF (RECORD NOT FOUND IS OK)                     
         BZ    *+6                                                              
         DC    H'0'                NO OTHER ERROR IS ACCEPTABLE                 
*                                                                               
*                                  FIND ROUTINE                                 
         LA    RF,MKFROUTS                                                      
         LA    R0,MKFRTSN                                                       
*                                                                               
MKF5     DS    0H                                                               
         CLC   BREC+5(1),0(RF)                                                  
         BE    MKF6                                                             
         LA    RF,5(RF)                                                         
         BCT   R0,MKF5                                                          
         DC    H'0'                                                             
*                                                                               
MKF6     DS    0H                                                               
         ICM   RF,15,1(RF)                                                      
         BASR  RE,RF                                                            
         B     MKF4                NEXT TSAR RECORD                             
*                                                                               
MKF20    DS    0H                                                               
         MVI   MFNEWSW,0             CLEAR NEWSW BITS                           
*                                                                               
MKFX     DS    0H                                                               
         B     XIT                                                              
         EJECT                                                                  
***********************************************************************         
*        MFHDR - INVOICE HEADER                                                 
***********************************************************************         
*                                                                               
MFHDR    NTR1                                                                   
         TM    MFNEWSW,X'80'         NEW INVOICE?                               
         BO    MFHDR4                                                           
         OI    MFNEWSW,X'80'                                                    
*                                  YES, START NEW RECORD                        
         CLI   OUTMODE,C'W'        FOR WORKER FILES DO OPEN                     
         BNE   MFHDR08                                                          
*                                                                               
         L     R0,=A(WRKRBUFF)                                                  
         ST    R0,AWRKBUFF                                                      
         L     R1,=A(WRKRBEND-WRKRBUFF)                                         
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         XC    WRKRIND,WRKRIND                                                  
         LA    R4,FREC                                                          
         USING WLHDRD,R4                                                        
         XC    WLHDRD(WLSOFEND-WLHDRD),WLHDRD                                   
         MVC   WLUSRID,RCORIGID    USER ID                                      
         MVC   WLSYSPRG(1),MED     MEDIA                                        
         MVC   WLSYSPRG+1(3),CLT   CLIENT                                       
         CLI   CLT+2,C' '          SPACE TO DOT                                 
         BH    *+8                                                              
         MVI   WLSYSPRG+3,C'.'                                                  
         MVI   WLDAY,X'97'         EDI BILLING IDENTIFIER                       
         MVI   WLCLASS,C'P'        SYSTEM = PRINT                               
*                                                                               
         MVC   WLAGELD,TODAYP                                                   
         MVI   WLUDATA,X'FF'       WAS  MVC   WLUDATA,=X'FFFF'                  
         MVC   WLAGELT,=X'FFFF'                                                 
         MVC   WLRETNL,=H'17520'   2 YEARS=17520 HOURS                          
*        MVC   WLRETND,=X'FFFF'                                                 
*                                                                               
         MVC   WLDESC(10),PINVNO   COMMENT                                      
         DROP  R4                                                               
*                                                                               
         GOTO1 DATAMGR,DMCB,(0,=C'GFILE'),=C'WRKFIL',                  X        
               WRKRIND,FREC,AWRKBUFF                                            
         LA    R1,WRKRIND                                                       
         USING UKRECD,R1                                                        
         MVC   WRKRFIL,UKUSRINF                                                 
         DROP  R1                                                               
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'OPEN',WRKRFIL,0,FREC,AWRKBUFF                    
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
MFHDR08  DS    0H                                                               
         L     RF,ADCLT            FIRST PUT EDI CONTROLS                       
         MVC   FREC+4(45),SPACES                                                
         MVI   FREC+04,C'H'                                                     
******   MVC   FREC+05(3),PCLTKCLT-PCLTREC(RF)                                  
         MVC   FREC+05(3),PROFB1A+10   "CLIENT"  FROM PROFILE                   
         OC    FREC+05(3),SPACES                                                
         MVI   FREC+08,C'P'    SYSTEM = PRINTPAK                                
         MVC   FREC+09(2),PCLTKAGY-PCLTREC(RF)                                  
         MVI   FREC+20,C'X'        STANDARD                                     
         MVC   FREC+21(4),PROFB1A+6    VERSION NUMBER                           
         MVC   FREC+25(3),=C'810'     DOCUMENT TYPE                             
         MVI   FREC+28,C'P'       PRODUCTION RUN                                
         CLI   TESTFLAG,C'T'       DRAFT BILLING (TEST)                         
         BNE   *+8                                                              
         MVI   FREC+28,C'T'        OR TEST                                      
*                                                                               
***      MVC   FREC+04(03),=C'HMR'                                              
***      MVC   FREC+07(20),PCLTBNAM-PCLTREC(RF)  BILL RECEIPT NAME              
***      OC    FREC+07(20),SPACES                                               
***      MVC   FREC+27(18),=C'X          810   T'                               
***      MVC   FREC+28(06),PCLTATTN-PCLTREC(RF) FIRST 6 OF ATTENTION            
*                                                                               
         LA    RF,FREC+45+4        MFPUT WILL SET LENGTH                        
         ST    RF,ANXTPOS                                                       
         XC    FREC+2(2),FREC+2                                                 
*                                                                               
         BAS   RE,MFPUT                                                         
*                                                                               
         MVC   ANXTPOS,AFRECP4     YES, START NEW RECORD                        
         GOTO1 BLDREC,DMCB,(2,=C'IH')                                           
         GOTO1 (RF),(R1),(10,PINVNO)                                            
         LA    R4,BEDATA                                                        
         USING PBILLREC,R4                                                      
         GOTO1 DATCON,DMCB,(3,PBILINVD),(17,DUB)                                
         GOTO1 BLDREC,DMCB,(8,DUB)                                              
         GOTO1 DATCON,DMCB,(3,PBILDUED),(17,DUB)                                
         GOTO1 BLDREC,DMCB,(8,DUB)                                              
         MVI   WORK,C'A'           SEP ADJUSTMENT BILL                          
         CLI   PBILSEP,C'A'                                                     
         BE    MFHDR3                                                           
         MVI   WORK,C'D'           SEP CASH DISCOUNT BILL                       
         CLI   PBILSEP,C'C'                                                     
         BE    MFHDR3                                                           
         MVI   WORK,C'C'           SEP COMMISSION BILL                          
         TM    PBILCMSW,BSTSCOMQ                                                
         BNZ   MFHDR3                                                           
         MVI   WORK,C'N'           NORMAL BILL                                  
*                                                                               
MFHDR3   DS    0H                                                               
         GOTO1 BLDREC,DMCB,(1,WORK)                                             
         DROP  R4                                                               
*                                                                               
         BAS   RE,MFPUT                                                         
*                                                                               
MFHDR4   DS    0H                                                               
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFAGM - AGENCY/MEDIA                                                   
***********************************************************************         
*                                                                               
MFAGM    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4          START NEW RECORD                        
         GOTO1 BLDREC,DMCB,(2,=C'AG')   AGENCY                                  
         GOTO1 (RF),(R1),(33,BEAGMAN)   NAME                                    
         GOTO1 (RF),(R1),(33,BEAGMAD)   ADDRESS                                 
         BAS   RE,MFPUT                                                         
*                                                                               
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'ME')    MEDIA                                  
         GOTO1 (RF),(R1),(2,BEAGMMED)    MEDIA CODE                             
         GOTO1 (RF),(R1),(10,BEAGMMN)    MEDIA NAME                             
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFADV - ADVERTISER                                                     
***********************************************************************         
*                                                                               
MFADV    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'AV')                                           
         GOTO1 (RF),(R1),(3,BECLT)      CODE                                    
         GOTO1 (RF),(R1),(20,BECLTN)    NAME                                    
         GOTO1 (RF),(R1),(5,BECLTICD)   INTERFACE CODE                          
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFADD - BILLING ADDRESS                                                
***********************************************************************         
*                                                                               
MFADD    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'BT')                                           
         GOTO1 (RF),(R1),(36,BEADDL1)                                           
         GOTO1 (RF),(R1),(36,BEADDL2)                                           
         GOTO1 (RF),(R1),(36,BEADDL3)                                           
         GOTO1 (RF),(R1),(36,BEADDL4)                                           
         GOTO1 (RF),(R1),(36,BEADDL5)                                           
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFPGR - PRODUCT GROUP                                                  
***********************************************************************         
*                                                                               
MFPGR    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         MVI   WORK,C'P'           PN IS PGR LEVEL N                            
         MVC   WORK+1(1),BEPGRL                                                 
         GOTO1 BLDREC,DMCB,(2,WORK)                                             
         GOTO1 (RF),(R1),(05,BEPGRC)    CODE                                    
         GOTO1 (RF),(R1),(12,BEPGRD)    DESC                                    
         GOTO1 (RF),(R1),(24,BEPGRN)    NAME                                    
*                                                                               
         BAS   RE,MFPUT                                                         
*                                                                               
MFPGRX   DS    0H                                                               
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFPRD - PRODUCT                                                        
***********************************************************************         
*                                                                               
MFPRD    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'PR')                                           
         GOTO1 (RF),(R1),(3,BEPRD)      CODE                                    
         GOTO1 (RF),(R1),(20,BEPRDN)    NAME                                    
         GOTO1 (RF),(R1),(5,BEPRICD)    INTERFACE CODE                          
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFEST - ESTIMATE                                                       
***********************************************************************         
*                                                                               
MFEST    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'ES')                                           
         GOTO1 (RF),(R1),(3,BEEST)      CODE                                    
         GOTO1 (RF),(R1),(20,BEESTN)    NAME                                    
         GOTO1 (RF),(R1),(20,BEESTN2)   NAME                                    
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFMGR - MARKET GROUP                                                   
***********************************************************************         
*                                                                               
MFMGR    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         MVI   WORK,C'M'           MN IS MGR LEVEL N                            
         MVC   WORK+1(1),BEMGRL                                                 
         GOTO1 BLDREC,DMCB,(2,WORK)                                             
         GOTO1 (RF),(R1),(05,BEMGRC)    CODE                                    
         GOTO1 (RF),(R1),(12,BEMGRD)    DESC                                    
         GOTO1 (RF),(R1),(24,BEMGRN)    NAME                                    
*                                                                               
         BAS   RE,MFPUT                                                         
*                                                                               
MFMGRX   DS    0H                                                               
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFMKT - MARKET                                                         
***********************************************************************         
*                                                                               
MFMKT    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'MK')                                           
         GOTO1 (RF),(R1),(20,BEMKTN)   NAME                                     
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFPUB - PUBLICATION                                                    
***********************************************************************         
*                                                                               
MFPUB    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'PB')                                           
         GOTO1 (RF),(R1),(60,BEPUBN)     NAME                                   
         GOTO1 (RF),(R1),(20,BEPUBN2)    NAME - PART 2                          
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFJOB - JOB (OR AD)                                                    
***********************************************************************         
*                                                                               
MFJOB    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'JB')                                           
         GOTO1 (RF),(R1),(25,BEJOB1)     JOB INFO LINE 1                        
         GOTO1 (RF),(R1),(25,BEJOB2)     JOB INFO LINE 2                        
         GOTO1 (RF),(R1),(30,BEJOB3)     JOB INFO LINE 3                        
         GOTO1 (RF),(R1),(30,BEJOB4)     JOB INFO LINE 4                        
         GOTO1 (RF),(R1),(25,BEJOB5)     JOB INFO LINE 5                        
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFUSR - USER DEF RECORDS                                               
***********************************************************************         
*                                                                               
MFUSR    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'UD')                                           
         GOTO1 BLDREC,DMCB,(2,BEUSRTXT)   DATA POSITION- P1,P2...               
*                                                                               
*              USER LINE IS 8 SPACES, DESC: NAME                                
*              (DESC CAN BE UP TO 20, NAME TO 32)                               
*                                                                               
         LA    R4,BEUSRTXT+10                                                   
         LA    R0,22+1                                                          
*                                                                               
MFUSR04  DS    0H                                                               
         CLI   0(R4),C':'                                                       
         BE    MFUSR06                                                          
         LA    R4,1(R4)                                                         
         BCT   R0,MFUSR04                                                       
         B     MFUSRX              SHOULD HAVE FOUND A :                        
*                                                                               
MFUSR06  DS    0H                                                               
         LR    R2,R4               SAVE A(:)                                    
         LA    R0,BEUSRTXT+11                                                   
         SR    R4,R0             R4 = DESC LENGTH                               
*                                                                               
         MVC   X(20),SPACES                                                     
         EX    R4,*+8                                                           
         B     *+10                                                             
         MVC   X(0),BEUSRTXT+10                                                 
*                                                                               
         GOTO1 (RF),(R1),(20,X)                                                 
         GOTO1 (RF),(R1),(32,2(R2))                                             
*                                                                               
         BAS   RE,MFPUT                                                         
*                                                                               
MFUSRX   DS    0H                                                               
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFUCM - USER COM RECORDS                                               
***********************************************************************         
*                                                                               
MFUCM    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'UC')                                           
         GOTO1 BLDREC,DMCB,(2,BEUCMTXT)   DATA POSITION- P1,P2...               
*                                                                               
*              USER LINE IS 8 SPACES, DESC: NAME                                
*              (DESC CAN BE UP TO 20, NAME TO 32)                               
*                                                                               
         LA    R4,BEUCMTXT+10                                                   
         LA    R0,22+1                                                          
*                                                                               
MFUCM04  DS    0H                                                               
         CLI   0(R4),C':'                                                       
         BE    MFUCM06                                                          
         LA    R4,1(R4)                                                         
         BCT   R0,MFUCM04                                                       
         B     MFUCMX              SHOULD HAVE FOUND A :                        
*                                                                               
MFUCM06  DS    0H                                                               
         LR    R2,R4               SAVE A(:)                                    
         LA    R0,BEUCMTXT+11                                                   
         SR    R4,R0             R4 = DESC LENGTH                               
*                                                                               
         MVC   X(20),SPACES                                                     
         EX    R4,*+8                                                           
         B     *+10                                                             
         MVC   X(0),BEUCMTXT+10                                                 
*                                                                               
         GOTO1 (RF),(R1),(20,X)                                                 
         GOTO1 (RF),(R1),(32,2(R2))                                             
*                                                                               
         BAS   RE,MFPUT                                                         
*                                                                               
MFUCMX   DS    0H                                                               
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFCOM - COMMENT LINE RECORD                                            
***********************************************************************         
*                                                                               
MFCOM    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'CM')                                           
*                                                                               
         LA    R2,LEVNAMS          GET LEVEL NAME                               
         LA    R0,LEVNAMSN                                                      
*                                                                               
MFCOM4   DS    0H                                                               
         CLC   BECOMLEV,0(R2)                                                   
         BE    MFCOM5                                                           
         LA    R2,5(R2)                                                         
         BCT   R0,MFCOM4                                                        
         DC    H'0'                                                             
*                                                                               
MFCOM5   DS    0H                                                               
         GOTO1 (RF),(R1),(4,1(R2))  LEVEL NAME                                  
*                                                                               
         GOTO1 (RF),(R1),(80,BECOMTXT)                                          
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFDET - DETAIL                                                         
***********************************************************************         
*                                                                               
MFDET    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'MT')                                           
*                                                                               
         LA    R2,LEVNAMS          GET LEVEL NAME                               
         LA    R0,LEVNAMSN                                                      
*                                                                               
MFDET4   DS    0H                                                               
         CLC   BEDLEV,0(R2)                                                     
         BE    MFDET5                                                           
         LA    R2,5(R2)                                                         
         BCT   R0,MFDET4                                                        
         DC    H'0'                                                             
*                                                                               
MFDET5   DS    0H                                                               
         GOTO1 (RF),(R1),(4,1(R2))  LEVEL NAME                                  
*                                                                               
         GOTO1 (RF),(R1),(8,BEDMOS)                                             
         GOTO1 (RF),(R1),(10,BEDPINV)                                           
*                                                                               
         GOTO1 (RF),(R1),(11,BEDOGRS)                                           
         GOTO1 (RF),(R1),(11,BEDONET)                                           
         GOTO1 (RF),(R1),(11,BEDOCD)                                            
         GOTO1 (RF),(R1),(11,BEDOTAX)                                           
         GOTO1 (RF),(R1),(11,BEDOINS)                                           
         GOTO1 (RF),(R1),(11,BEDPGRS)                                           
         GOTO1 (RF),(R1),(11,BEDPNET)                                           
         GOTO1 (RF),(R1),(11,BEDPCD)                                            
         GOTO1 (RF),(R1),(11,BEDPTAX)                                           
         GOTO1 (RF),(R1),(11,BEDPINS)                                           
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFINS - INSERTION DETAILS                                              
***********************************************************************         
*                                                                               
MFINS    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'ID')                                           
*                                                                               
         GOTO1 (RF),(R1),(11,BEIDIDAT)     INSERTION DATE                       
         GOTO1 (RF),(R1),(25,BEIDDESC)     DESCRIPTION                          
*                                                                               
         GOTO1 (RF),(R1),(11,BEIDOGRS)                                          
         GOTO1 (RF),(R1),(11,BEIDONET)                                          
         GOTO1 (RF),(R1),(11,BEIDOCD)                                           
         GOTO1 (RF),(R1),(11,BEIDOTAX)                                          
         GOTO1 (RF),(R1),(11,BEIDPGRS)                                          
         GOTO1 (RF),(R1),(11,BEIDPNET)                                          
         GOTO1 (RF),(R1),(11,BEIDPCD)                                           
         GOTO1 (RF),(R1),(11,BEIDPTAX)                                          
         GOTO1 (RF),(R1),(10,BEIDREFN)                                          
         GOTO1 (RF),(R1),(50,BEIDMISC)                                          
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFRMA - REMITTANCE ADDRESS                                             
**********************************************************************          
*                                                                               
MFRMA    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'RA')                                           
         GOTO1 (RF),(R1),(20,BERMNAM)   NAME                                    
         GOTO1 (RF),(R1),(24,BERMADR)   ADDRESS                                 
         GOTO1 (RF),(R1),(24,BERMCTY)   CITY                                    
         GOTO1 (RF),(R1),(03,BERMSTA)   STATE                                   
         GOTO1 (RF),(R1),(10,BERMZIP)   ZIP                                     
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
*                                                                               
         SPACE 2                                                                
***********************************************************************         
*        MFLST - PREVIOUS BILL LIST                                             
**********************************************************************          
*                                                                               
MFLST    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'PI')                                           
         GOTO1 (RF),(R1),(10,BDLSTIN)   INVOICE NUMBER                          
         GOTO1 (RF),(R1),(11,BDLSTG)    GROSS                                   
         GOTO1 (RF),(R1),(11,BDLSTN)    NET                                     
         GOTO1 (RF),(R1),(11,BDLSTCD)   CD                                      
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFDUE - FORMULA ADJUSTMENTS AND AMOUNT DUE                             
**********************************************************************          
*                                                                               
MFDUE    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'AD')                                           
*                                                                               
         LA    R2,LEVNAMS          GET LEVEL NAME                               
         LA    R0,LEVNAMSN                                                      
*                                                                               
MFDUE4   DS    0H                                                               
         CLC   BDULEV,0(R2)                                                     
         BE    MFDUE5                                                           
         LA    R2,5(R2)                                                         
         BCT   R0,MFDUE4                                                        
         DC    H'0'                                                             
*                                                                               
MFDUE5   DS    0H                                                               
         GOTO1 (RF),(R1),(4,1(R2))  LEVEL NAME                                  
*                                                                               
         GOTO1 (RF),(R1),(1,BDUBB)   BILL BASIS (G,N,M)                         
         GOTO1 (RF),(R1),(1,BDUCB)   COMM ADJUST BASIS (G,N,M)                  
         GOTO1 (RF),(R1),(11,BDUCP)   COMM ADJUST % SNNVNNNN                    
         GOTO1 (RF),(R1),(11,BDUBBA)  BILL BASIS AMOUNT                         
         GOTO1 (RF),(R1),(11,BDUCBA)  COMM ADJST AMOUNT                         
         GOTO1 (RF),(R1),(11,BDUAMT)  AMOUNT DUE                                
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
***********************************************************************         
*        MFCTAX - CANADIAN TAXES                                                
**********************************************************************          
*                                                                               
MFCTAX   NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'CT')                                           
*                                                                               
         GOTO1 (RF),(R1),(7,BCTXT)   TAX TYPE                                   
         GOTO1 (RF),(R1),(16,BCTXA)  ACCOUNT NUMBER                             
         GOTO1 (RF),(R1),(11,BCTXP)  BASIS AMOUNT                               
         GOTO1 (RF),(R1),(11,BCTXB)  BASIS AMOUNT                               
         GOTO1 (RF),(R1),(11,BCTXTAX)  TAX AMOUNT                               
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
*                                                                               
***********************************************************************         
*        MFTDUE - TOTAL AMOUNT DUE (INCLUDING CANADIAN TAXES)                   
*        ONLY PRESENT WHEN CANADIAN TAXES ARE                                   
**********************************************************************          
*                                                                               
MFTDUE   NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'TD')                                           
*                                                                               
         GOTO1 (RF),(R1),(11,BTDUAMT)  TOTAL AMOUNT DUE                         
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
*                                                                               
         LTORG                                                                  
*                                                                               
BSTCMONQ EQU   X'02'                                                            
BSTCAORQ EQU   X'10'                                                            
BSTTAORQ EQU   X'20'                                                            
BSTSADJQ EQU   X'80'        NOT SET IN PRINTPAK                                 
BSTNTXAQ EQU   X'04'                                                            
BSTSCOMQ EQU   X'01'                                                            
BSTSNETQ EQU   X'08'                                                            
         EJECT                                                                  
**********************************************************************          
*        COMMON SUBROUTINES AND DATA AREAS                                      
**********************************************************************          
*                                                                               
COMSUBS  DS    0D                                                               
*                                                                               
MODLIST  DS    0X                  MODE LIST                                    
         DC    AL1(EDMPGR),AL4(EDPGR)                                           
         DC    AL1(EDMPRD),AL4(EDPRD)                                           
         DC    AL1(EDMEST),AL4(EDEST)                                           
         DC    AL1(EDMMGR),AL4(EDMGR)                                           
         DC    AL1(EDMMKT),AL4(EDMKT)                                           
         DC    AL1(EDMPUB),AL4(EDPUB)                                           
         DC    AL1(EDMJOB),AL4(EDJOB)                                           
         DC    AL1(EDMMTA),AL4(EDMTA)   (REPLACED EDDET)                        
         DC    AL1(EDMCOM),AL4(EDCOM)                                           
         DC    AL1(EDMEND),AL4(EDEND)                                           
         DC    AL1(EDMLST),AL4(EDLST)                                           
         DC    AL1(EDMDUE),AL4(EDDUE)                                           
         DC    AL1(EDMADD),AL4(EDADD)                                           
         DC    AL1(EDMHDR),AL4(EDHDR)                                           
         DC    AL1(EDMUSR),AL4(EDUSR)                                           
         DC    AL1(EDMUCM),AL4(EDUCM)                                           
**SPOT** DC    AL1(EDMRMA),AL4(EDRMA)   NOT FOR PRINTPAK                        
         DC    AL1(EDMINS),AL4(EDINS)     INSERTION                             
         DC    AL1(EDMCLS),AL4(EDCLS)                                           
         DC    AL1(EDMCTX),AL4(EDCTAX)   CANADIAN TAXES                         
         DC    AL1(EDMTDUE),AL4(EDTDUE)  TOTAL DUE WITH CANADIAN TAXES          
MODLISTN EQU   (*-MODLIST)/5                                                    
*                                  TSAR RECORD TYPE EQUATES                     
*                                                                               
MKFROUTS DS    0X                  MAKEFILE RECORD ROUTINE LIST                 
         DC    AL1(EDAGMQ),AL4(MFAGM)                                           
         DC    AL1(EDADVQ),AL4(MFADV)                                           
         DC    AL1(EDADDQ),AL4(MFADD)                                           
         DC    AL1(EDPGRQ),AL4(MFPGR)                                           
         DC    AL1(EDPRDQ),AL4(MFPRD)                                           
         DC    AL1(EDESTQ),AL4(MFEST)                                           
         DC    AL1(EDMGRQ),AL4(MFMGR)                                           
         DC    AL1(EDMKTQ),AL4(MFMKT)                                           
         DC    AL1(EDPUBQ),AL4(MFPUB)                                           
         DC    AL1(EDJOBQ),AL4(MFJOB)                                           
         DC    AL1(EDHDRQ),AL4(MFHDR)                                           
         DC    AL1(EDMTAQ),AL4(MFDET)                                           
         DC    AL1(EDUSRQ),AL4(MFUSR)                                           
         DC    AL1(EDUCMQ),AL4(MFUCM)                                           
         DC    AL1(EDCOMQ),AL4(MFCOM)                                           
         DC    AL1(EDLSTQ),AL4(MFLST)                                           
         DC    AL1(EDDUEQ),AL4(MFDUE)                                           
**SPOT** DC    AL1(EDRMAQ),AL4(MFRMA)   NOT FOR PRINTPAK                        
         DC    AL1(EDCTAXQ),AL4(MFCTAX)                                         
         DC    AL1(EDTDUEQ),AL4(MFTDUE)                                         
         DC    AL1(EDINSQ),AL4(MFINS)                                           
MKFRTSN  EQU   (*-MKFROUTS)/5                                                   
*                                                                               
*                                  BREAK LEVEL NAMES                            
*                                                                               
LEVNAMS  DS    0X                                                               
         DC    X'04',C'MED '       MEDIA                                        
         DC    X'08',C'PGR1'       PGR1                                         
         DC    X'0C',C'PGR2'       PGR2                                         
         DC    X'10',C'PGR3'       PGR3                                         
         DC    X'14',C'PRD '       PRD                                          
         DC    X'18',C'EST '       EST                                          
         DC    X'1C',C'MGR1'       MGR1                                         
         DC    X'20',C'MGR2'       MGR2                                         
         DC    X'24',C'MGR3'       MGR3                                         
         DC    X'28',C'MKT '       MKT                                          
         DC    X'2C',C'JOB '       JOB                                          
         DC    X'30',C'PUB '       PUBLICATION                                  
         DC    X'34',C'DESC'       DESCRIPTION                                  
         DC    X'38',C'PER '       PERIOD                                       
         DC    X'3C',C'PERG'       PERIOD GROUP                                 
         DC    X'40',C'TYPE'       TYPE - DEBIT/CREDIT (SPECIAL)                
         DC    X'FF',C'INV '       INVOICE                                      
LEVNAMSN EQU   (*-LEVNAMS)/5                                                    
*                                                                               
*                                  TSAR RECORD TYPE EQUATES                     
EDHDRQ   EQU   10                                                               
EDAGMQ   EQU   20                                                               
EDADVQ   EQU   30                                                               
EDADDQ   EQU   32                                                               
EDPGRQ   EQU   40                                                               
EDPRDQ   EQU   50                                                               
EDESTQ   EQU   60                                                               
EDJOBQ   EQU   61                  ONLY FOR PRINTPAK                            
EDPUBQ   EQU   62                                                               
EDCOMQ   EQU   64                                                               
EDUSRQ   EQU   66                                                               
EDUCMQ   EQU   68                                                               
EDMGRQ   EQU   70                                                               
EDINSQ   EQU   75                  INSERTION                                    
EDMKTQ   EQU   80                                                               
EDDUEQ   EQU   81                                                               
EDLSTQ   EQU   83                                                               
EDRMAQ   EQU   85                                                               
EDMTAQ   EQU   90                                                               
EDCTAXQ  EQU   91                                                               
EDTDUEQ  EQU   92                                                               
*                                  SORT SEQUENCE GROUPS                         
EDRSRTHQ EQU   10                  HEADER                                       
EDRSRTAQ EQU   15                  BILLING ADDR                                 
EDRSRTMQ EQU   20                  MAIN                                         
*                                                                               
FDELIM   EQU   X'5E'               FIELD DELIMITER  (SEMI-COLON)                
*                                                                               
XIT      DS    0H                                                               
         XIT1                                                                   
*                                                                               
*********************************************************************           
*        EDPUT - RECORD TO TSAR                                                 
*********************************************************************           
*                                                                               
EDPUT    NTR1                                                                   
         MVC   BEKSEQ,SEQNO        SET SEQUENCE NUMBER                          
         LH    RF,SEQNO            AND BUMP                                     
         LA    RF,1(RF)                                                         
         STH   RF,SEQNO                                                         
*                                                                               
         LA    R1,BREC                                                          
         ST    R1,TSAREC                                                        
         MVI   TSOFFACT,TSAADD                                                  
         GOTO1 ATSAROFF,(R6)                                                    
*                                                                               
         CLI   TSERRS,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         BAS   RE,CLRBREC          SET BUFFER REC TO SPACES                     
         B     XIT                                                              
*                                                                               
*********************************************************************           
*        MFPUT - RECORD TO OUTPUT FILE                                          
*********************************************************************           
*                                                                               
MFPUT    NTR1                                                                   
         L     R2,ANXTPOS          SET RECORD LENGTH                            
         S     R2,AFREC                                                         
         STCM  R2,3,FREC                                                        
*                                                                               
         CLI   OUTMODE,C'D'        DATASET OUTPUT                               
         BE    MFPUT4                                                           
*                                  ELSE WORKER OTUPUT                           
         GOTO1 DATAMGR,DMCB,=C'ADD',WRKRFIL,WRKRIND,FREC,AWRKBUFF               
         CLI   DMCB+8,0                                                         
         BE    MFPUT6                                                           
         DC    H'0'                                                             
*                                                                               
MFPUT4   DS    0H                                                               
         LA    R2,EDIOUT                                                        
         PUT   (R2),FREC                                                        
*                                                                               
MFPUT6   DS    0H                                                               
         B     XIT                                                              
*                                                                               
*********************************************************************           
*        TRACE TSAROFF BUFFER                                                   
*********************************************************************           
*                                                                               
EDTRC    NTR1                                                                   
         L     RF,APATCH                                                        
         TM    0(RF),X'08'         TEST NEED TRACE                              
         BZ    EDTRX                                                            
*                                                                               
         MVC   P1(7),=C'**EDI**'                                                
         GOTO1 =A(PRNT)                                                         
*                                                                               
         LA    R4,BREC                                                          
         ST    R4,TSAREC                                                        
         XC    BREC(BEKLN),BREC                                                 
         MVI   TSOFFACT,TSARDH                                                  
         B     EDTR4B                                                           
*                                                                               
EDTR4    DS    0H                                                               
         MVI   TSOFFACT,TSANXT                                                  
*                                                                               
EDTR4B   DS    0H                                                               
         GOTO1 ATSAROFF,(R6)                                                    
         TM    TSERRS,TSEEOF                                                    
         BO    EDTRX                                                            
*                                                                               
         TM    TSERRS,X'FF'-TSERNF (RECORD NOT FOUND IS OK)                     
         BZ    *+6                                                              
         DC    H'0'                NO OTHER ERROR IS ACCEPTABLE                 
*                                                                               
         SR    R2,R2                                                            
         ICM   R2,3,0(R4)                                                       
         CH    R2,=H'133'                                                       
         BNH   *+8                                                              
         LA    R2,133                                                           
         BCTR  R2,0                                                             
         EX    R2,*+8                                                           
         B     *+10                                                             
         MVC   P1(0),0(R4)                                                      
*                                                                               
         LA    R2,1(R2)                                                         
         GOTO1 HEXOUT,DMCB,0(R4),P4,(R2),=C'N'                                  
*                                                                               
         LR    R0,R2                                                            
         LA    R3,P2                                                            
         LA    R2,P4                                                            
*                                                                               
EDTR5    DS    0H                                                               
         MVC   0(1,R3),0(R2)                                                    
         MVC   132(1,R3),1(R2)                                                  
         LA    R3,1(R3)                                                         
         LA    R2,2(R2)                                                         
         BCT   R0,EDTR5                                                         
*                                                                               
         MVC   P4,SPACES                                                        
         MVC   P5,SPACES                                                        
*                                                                               
         MVI   SPACING,2                                                        
         GOTO1 =A(PRNT)                                                         
         B     EDTR4                                                            
*                                                                               
EDTRX    DS    0H                                                               
         B     XIT                                                              
*                                                                               
**********************************************************************          
*        CLEAR RECORD AREAS                                                     
**********************************************************************          
*                                                                               
CLRBREC  NTR1                                                                   
         LA    R0,BREC             SET BUFFER REC TO SPACES                     
         LA    R1,L'BREC                                                        
         SR    RE,RE                                                            
         IC    RF,=X'40'                                                        
         SLL   RF,24                                                            
         MVCL  R0,RE                                                            
         B     XIT                                                              
*                                                                               
CLRFREC  NTR1                                                                   
         LA    R0,FREC+4           SET FILE REC TO SPACES                       
         LA    R1,L'FREC-4                                                      
         SR    RE,RE                                                            
         IC    RF,=X'40'                                                        
         SLL   RF,24                                                            
         MVCL  R0,RE                                                            
         XC    FREC(4),FREC                                                     
         B     XIT                                                              
         EJECT                                                                  
**********************************************************************          
*        SETGN - SET GROSS/NET CONTROL                                          
**********************************************************************          
*                                                                               
SETGN    DS    0H                                                               
*                                                                               
         MVI   GNCTL,X'C0'          SET BOTH GROSS AND NET ON                   
         B     SETGNX                                                           
*                                                                               
         MVI   GNCTL,0                                                          
         CLI   FORMAT,C'Y'          GROSS                                       
         BE    SETGN5                                                           
         CLI   FORMAT+3,C'Y'        OR GROSS-CD                                 
         BE    SETGN5                                                           
         B     SETGN8                                                           
*                                                                               
SETGN5   OI    GNCTL,X'80'         GROSS SHOWN                                  
*                                                                               
SETGN8   CLI   FORMAT+1,C'Y'       NET                                          
         BE    SETGN10                                                          
         CLI   FORMAT+4,C'Y'       OR NET-CD                                    
         BE    SETGN10                                                          
         B     SETGNX                                                           
*                                                                               
SETGN10  OI    GNCTL,X'40'        NET SHOWN                                     
*                                                                               
SETGNX   DS    0H                                                               
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
*        BLDREC -  ADD DATA ITEM TO RECORD                                      
*                  P1 POINTS TO ITEM, BYTE 0 = LENGTH                           
***********************************************************************         
         SPACE 2                                                                
BLDREC   NTR1                                                                   
         SR    R2,R2                                                            
         ICM   R2,7,1(R1)          A(DATA ITEM)                                 
         SR    RF,RF                                                            
         ICM   RF,1,0(R1)          LENGTH                                       
         BNZ   BR02                                                             
*                                                                               
         CLI   OUTMODE,C'W'        VARIABLE LENGTH FLDS FOR WKR FILES           
         BE    BR03                                                             
*                                  ZERO LENGTH GIVEN                            
         CLI   PROFB1A+5,C'F'      FIXED FIELD FORMAT                           
         BNE   BR03                NO, OK                                       
*                                                                               
         LA    RF,1                ASSUME 1                                     
         LA    R2,SPACES           SPACE                                        
         B     BR03                                                             
*                                                                               
BR02     DS    0H                  NON-ZERO LENGTH                              
         CLI   OUTMODE,C'W'        VARIABLE LENGTH FLDS FOR WKR FILES           
         BE    BR02B                                                            
*                                                                               
         CLI   PROFB1A+5,C'F'      FIXED FIELD FORMAT                           
         BE    BR03                SKIP STRIP OFF                               
*                                                                               
BR02B    DS    0H                                                               
         LA    RF,0(R2,RF)         STRIP ANY TRAILING BLANKS                    
         BCTR  RF,0                                                             
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         SR    RF,R2                                                            
         BNM   *+10                                                             
         SR    RF,RF                                                            
         B     BR03                                                             
         LA    RF,1(RF)                                                         
*                                                                               
BR03     DS    0H                                                               
         L     R3,ANXTPOS          WHERE TO PUT                                 
         LA    R4,1(RF,R3)                                                      
         C     R4,AFRECX                                                        
         BL    BR04                                                             
         DC    H'0'                REC OVERFLOW                                 
*                                                                               
BR04     DS    0H                                                               
         LTR   RF,RF                                                            
         BNP   BR06                                                             
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),0(R2)                                                    
         LA    R3,1(R3,RF)                                                      
*                                                                               
BR06     DS    0H                                                               
         CLI   OUTMODE,C'W'        VARIABLE LENGTH FLDS FOR WKR FILES           
         BE    BR06B               NO FIELD DELIMITER                           
         CLI   PROFB1A+5,C'F'      IF FIXED FIELD FORMAT                        
         BE    BR07                NO FIELD DELIMITER                           
*                                                                               
BR06B    DS    0H                                                               
         MVI   0(R3),FDELIM                                                     
         LA    R3,1(R3)                                                         
*                                                                               
BR07     DS    0H                                                               
         ST    R3,ANXTPOS                                                       
*                                                                               
BRX      DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
EDIOUT   DCB   DDNAME=EDIOUT,                                          X        
               DSORG=PS,                                               X        
               RECFM=VB,                                               X        
               MACRF=PM                                                         
*                                                                               
EDITRC   DCB   DDNAME=EDIOUT,                                          X        
               DSORG=PS,                                               X        
               RECFM=VB,                                               X        
               MACRF=GM,                                               X        
               EODAD=EDTRCEOF                                                   
*                                                                               
OUT      DCB   DDNAME=OUT,DSORG=PS,RECFM=VB,MACRF=(GM,PM),LRECL=512,   +        
               EODAD=INVR29                                                     
*                                                                               
FRSTSW   DC    X'00'                                                            
SEQNO    DC    H'1'                                                             
MFNEWSW  DC    X'00'                                                            
EDNEWSW  DC    X'00'                                                            
GNCTL    DC    X'00'           GROSS/NET - X'80'=GROSS, X'40'=NET               
*                                                                               
EDMODE   DS    XL1                                                              
EDPARMS  DS    6F                                                               
ATSAROFF DS    A                                                                
TSARB    DS    XL(TSARDL)                                                       
*                                                                               
BREC     DS    XL300               TSAR BUFFER RECORD                           
FREC     DS    XL300               OUTUT FILE RECORD                            
*                                                                               
ABREC    DS    A                                                                
AFREC    DS    A                                                                
AFRECP4  DS    A                                                                
ABRECX   DS    A                                                                
AFRECX   DS    A                                                                
ANXTPOS  DS    A                                                                
*                                                                               
AWRKBUFF DS    A                                                                
WRKRIND  DS    XL44                                                             
WRKRFIL  DS    CL8                                                              
*                                                                               
         LTORG                                                                  
         SPACE 2                                                                
         DS    0D                                                               
         DC    CL8'*WKRBUF*'                                                    
WRKRBUFF DS    14336X                                                           
WRKRBEND EQU   *                                                                
         SPACE 2                                                                
         EJECT                                                                  
* ESTIMATE RECORD EXPECTED IN PESTREC                                           
CHKUCOM  NMOD1 0,CKUCOM                                                         
         LA    RC,SPACEND                                                       
*                                                                               
**WB**                                                                          
         XC    ESTWBFLT,ESTWBFLT                                                
**WB**                                                                          
         MVI   BYTE,C'N'           SET FOUND UCOMM                              
*                                  WILL BE CHANGED TO C IF MISSING              
         MVC   CSAVKEY,KEY         SAVE MY KEY                                  
         LA    R6,CCOMBLK          SET-UP DDUCOM CONTROL BLOCK                  
         XC    CCOMBLK(L'CCOMBLK),CCOMBLK                                       
         USING DDUCOMD,R6                                                       
*                                                                               
*                                  WILL BE CHANGED TO C IF MISSING              
         MVI   BYTE2,0        WILL HOLD # OF REQUIRED UCOMS                     
         L     R7,ADCLT                                                         
         USING PCLTREC,R7                                                       
*                                                                               
         LA    R2,33(R7)      TO FIRST ELEMENT                                  
         MVI   ELCODE,X'85'   LOOK FOR MIN UCOMM NUMBER                         
         BRAS  RE,UNXTEL                                                        
         BNE   CKUC08         NOT FOUND REGULAR CHECK                           
         USING PCLTUEL,R2                                                       
         MVC   BYTE2,PCLTUCOM    # OF UCOMS                                     
         CLI   BYTE2,4           IF MORE THAN 4, RETURN UP TO 8                 
         BNH   CKUC08                                                           
         OI    UCOPT,UCO8EST     RETURN OVER 4 IN PRD UCOMMS                    
         DROP  R7                                                               
*                                                                               
*                                                                               
CKUC08   L     R7,ADEST                                                         
         USING PESTREC,R7                                                       
         MVC   UCEST,PESTKEST                                                   
         MVC   UCPRD,PESTKPRD                                                   
*                                                                               
CKUC10   MVC   UCACOMF,VCOMFACS    COMFACS                                      
         MVI   UCSYS,C'P'          SYSTEM TO PRINT                              
         MVC   UCAGY,QAGENCY                                                    
         MVC   UCMED,QMEDIA                                                     
         OC    AMED,AMED                                                        
         BZ    CKUC10A                                                          
         L     RF,AMED           MUST CHECK AMED FOR MEDIA                      
         MVC   UCMED,0(RF)                                                      
*                                                                               
CKUC10A  DS    0H                                                               
         L     RF,ADCLT                                                         
         L     R7,ADEST                                                         
         MVC   UCEST,PESTKEST                                                   
         MVC   UCCLT,4(RF)                                                      
         OI    UCOPT,UCOEST        RETURN ESTIMATE UCOMMS                       
         XC    CCTTLS,CCTTLS                                                    
         XC    CCOMDATA,CCOMDATA                                                
         GOTO1 =V(DDUCOM),CCOMBLK                                               
         CLI   UCERROR,0                                                        
         BNE   CHKUCNQX            ERROR RETURN - JUST EXIT DON'T DIE           
*                                                                               
         TM    UCDATA,UCDNOEST     NO ESTIMATE DATA ?                           
         BNO   CHKUC20                                                          
*                                                                               
CHKUC15  CLC   =C'AAA',UCPRD       DID WE READ FOR AAA YET?                     
         BNE   *+14                                                             
         XC    CCOMDATA,CCOMDATA                                                
         B     CHKUCNQX            YES, DONE                                    
*                                                                               
         XC    CCOMBLK(L'CCOMBLK),CCOMBLK  TRY FOR IT                           
         MVC   UCPRD,=C'AAA'                                                    
         B     CKUC10                                                           
*                                                                               
CHKUC20  L     RE,UCETTLS          ESTIMATE TITLES                              
         MVC   CCTTLS,0(RE)                                                     
         L     RF,UCEDATA          ESTIMATE DATA                                
*                                                                               
         CLC   0(10,RF),SPACES   IS DATA PRESENT IN FIRST UCOMM?                
         BNH   CHKUC15           GO CHECK PRD AAA (UNLESS I'M READING)          
*                                                                               
         CLI   QADID,C'.'        REQUEST FOR ONE FILGHT?                        
         BNE   CHKUC25                                                          
         OC    0(10,RF),SPACES  JUST IN CASE                                    
         CLC   0(10,RF),QADID+1   FLIGHTS MUST MATCH                            
         BNE   CHKUCNQX            IF NOT - SET TO SKIP                         
*                                  (TREAT AS MISSING UCOMM)                     
CHKUC25  MVC   CCOMDATA,0(RF)                                                   
**WB**                                                                          
         MVC   ESTWBFLT,CCOMDATA   SAVE WB FLIGHT (10 CHARATERS)                
**WB**                                                                          
*                                                                               
         CLI BYTE2,0               IS MIN# OF UCOMS REQUIRED?                   
         BE  CHKUCQX               NO, DONE                                     
*                                                                               
         LA    RF,0                COUNTER                                      
         LA    R0,4                4 LENGTHS                                    
         LA    R1,UCELENS          PT TO LEN OF 4 DATA FLDS THAT FOLLOW         
         BAS   RE,CHKLEN                                                        
*                                                                               
         CLI   BYTE2,4             MORE THAN 4 UCOMS?                           
         BNH   CHKUC30                                                          
         LA    R0,4                4 LENGTHS                                    
         LA    R1,UCPLENS          PT TO LEN OF 4 DATA FLDS THAT FOLLOW         
         BAS   RE,CHKLEN                                                        
*                                                                               
CHKUC30  ZIC   R0,BYTE2                                                         
         CR    R0,RF               CHECK FOR MINIMUM NUM OF UCOMMS              
         BH    CHKUCNQX            NOT ENOUGH                                   
*                                                                               
CHKUCQX  DS    0H                                                               
         MVC   KEY,CSAVKEY         SINCE SEQ READING MAY BE AFFECTED            
         GOTO1 HIGH                                                             
         B     CHKUCXIT                                                         
*                                                                               
CHKUCNQX DS    0H                                                               
         MVC   KEY,CSAVKEY         SINCE SEQ READING MAY BE AFFECTED            
         GOTO1 HIGH                                                             
         MVI   BYTE,C'C'           SET MISSING UCOMM                            
*                                                                               
CHKUCXIT DS    0H                                                               
         XIT1                                                                   
*                                                                               
CHKLEN   CLI   0(R1),0                                                          
         BE    *+8                                                              
         AHI   RF,1                INCREMENT COUNTER                            
         LA    R1,1(R1)            BUMP TO NEXT LEN                             
         BCT   R0,CHKLEN                                                        
         BR    RE                                                               
*                                                                               
UNXTEL   DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    UNXTEL2                                                          
         CLC   0(1,R2),ELCODE                                                   
         BER   RE                                                               
         B     UNXTEL                                                           
UNXTEL2  DS    0H                                                               
         LTR   RE,RE                                                            
         BR    RE                                                               
*                                                                               
         LTORG                                                                  
         DROP  R6,R7,RB                                                         
         LTORG                                                                  
*                                                                               
CSAVKEY  DS    CL32                                                             
*                                                                               
CCOMBLK  DS    CL(UCOMDLNQ)     DDUCOM CONTROL BLOCK                            
CCTTLS   DS    CL80             LEN=20*4                                        
CCOMDATA DS    CL128            LEN=32*4                                        
CCALL    EQU   *-CCTTLS                                                         
         SPACE 2                                                                
* ESTIMATE RECORD EXPECTED IN PESTREC                                           
CHKUDEF  NMOD1 0,CKUDEF                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         MVI   BYTE,C'N'           SET UDEF FOUND                               
*                                  WILL BE CHANGED TO C IF MISSING              
         L     R7,ADEST                                                         
         USING PESTREC,R7                                                       
*                                                                               
         LA    R2,33(R7)      TO FIRST ELEMENT                                  
         MVI   ELCODE,X'08'   LOOK FOR USER DATA                                
         BRAS  RE,ENEXTEL                                                       
         BNE   CHKUEX         NOT UDEF ELEMENT FOUND - SET TO SKIP              
         USING PESTUDEF,R2                                                      
         TM    UDEFESW,X'01'  FIRST REQUIRED?                                   
         BZ    CHKUE5                                                           
         CLC   PEUSER1,SPACES                                                   
         BNH   CHKUEX         MISSING - SET TO SKIP                             
CHKUE5   TM    UDEFESW,X'02'  2ND REQUIRED?                                     
         BZ    CHKUE7                                                           
         CLC   PEUSER2,SPACES                                                   
         BNH   CHKUEX         MISSING - SET TO SKIP                             
CHKUE7   B     CHKUEXIT                                                         
*                                                                               
CHKUEX   MVI   BYTE,C'C'      SET TO SKIP THIS ESTIMATE                         
CHKUEXIT DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
ENEXTEL  DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R2)                                                         
         AR    R2,R0                                                            
         CLI   0(R2),0                                                          
         BE    ENEXTEL2                                                         
         CLC   0(1,R2),ELCODE                                                   
         BER   RE                                                               
         B     ENEXTEL                                                          
ENEXTEL2 DS    0H                                                               
         LTR   RE,RE                                                            
         BR    RE                                                               
         LTORG                                                                  
*                                                                               
*                                                                               
         TITLE 'PPB102 - ACCUMULATORS'                                          
*                                                                               
*      CHANGE LOG                                                               
*                                                                               
*    BPLA 05/10      HST FOR BC AND ON + PCT. CHG FOR NS HST                    
*                                                                               
*    BPLA 12/97      QST PERCENTAGE CHANGE 6.5 TO 7.5 IN VCTAB                  
*                                                                               
*    BPLA 3/97       CHANGE FOR HST                                             
*                                                                               
*    BPLA 11/13/96   FOTAB EXPANDED AGAIN                                       
*                    FROM 420,000 TO 460,000                                    
*                                                                               
*    BPLA 9/18/96 PPB1ACCO MADE LIVE - NOW INLUDES PPREPB1WRK                   
*                                                                               
         SPACE 2                                                                
         DS    0D                                                               
         DC    CL8'*WKREC**'                                                    
WKREC    DS    4000C                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*LEVTOTS'                                                    
LEVTOTS  ORG   *+TOTSIZE*MAXLEVS                                                
*                                  THIS AREA IS FOR HOLDING                     
*                                  MONTHLY ORD AND BILLED FOR                   
*                                  AS MANY LEVELS AS NECESSARY                  
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*PEPTAB*'                                                    
PEPTAB   ORG   *+PEPTABRL*PEPTBN                                                
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*INVTAB*'                                                    
INVTAB   ORG   INVTAB+INVTABRL*INVTBN                                           
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*UPETAB*'                                                    
UPETAB   ORG   UPETAB+UPETABRL*UPETBN                                           
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*LINTAB*'                                                    
*INTAB   DS    200CL132                                                         
LINTAB   DS    (LINTABN)CL132                                                   
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*MYHEADS'                                                    
MYHEADS  DS    450C               45 X 10 = 450                                 
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'PPBYOWRK'                                                    
PPBYOWRK DS    600C                                                             
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*GDAREA*'                                                    
GDAREA   DS    360C               340 USED SO FAR                               
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'**GRID**'                                                    
GRID     DS    14CL132            USED FOR FMTAMT GRID                          
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*SCCOLT*'      STANDARD CUSTOM COLUMN TABLE                  
SCCTAB   DS    5CL5               USED IN CCOLRTN                               
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*AELIST*'                                                    
AELIST   DS    5300C               53 X 100 AAA EST FORMULAS                    
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*PDLIST*'                                                    
PDLIST   DS    1500C              3 X 500 PRDS                                  
         DC    X'00'                                                            
         SPACE 2                                                                
*        NOTE - QST WAS 4.000 FOR BILLS CREATED BEFORE JUNE1/94                 
*               FOR REVERSALS OF BILLS DONE BEFORE THEN                         
*               4.000 IS USED IN VBGETPCT                                       
*                                                                               
         DS    0D                                                               
         DC    CL8'*VCTAB**'                                                    
VCTAB    DS    0C                  TABLE OF VAT CODES - NAT AND PRV             
         DC    AL1(00),C'S',X'5B01',X'FFFF',AL4(7000)  NAT STANDARD             
         DC    AL1(06),C'S',X'5C07',X'FFFF',AL4(7500)  QUEBEC STANDARD          
         DC    AL1(07),C'H',X'6104',X'FFFF',AL4(15000) NEW BRUNSWICK            
         DC    AL1(08),C'H',X'6104',X'FFFF',AL4(15000) NOVA SCOTIA              
         DC    AL1(10),C'H',X'6104',X'FFFF',AL4(15000) NWFLND                   
         DC    X'FF'                                                            
*                                                                               
* VCTAB6 USED IF TODAY IS ON OR AFTER JUL01/2006                                
*                                                                               
         DS    0D                                                               
         DC    CL8'*VCTAB6*'                                                    
VCTAB6   DS    0C                  TABLE OF VAT CODES - NAT AND PRV             
         DC    AL1(00),C'S',X'5B01',X'FFFF',AL4(6000)  NAT STANDARD             
         DC    AL1(06),C'S',X'5C07',X'FFFF',AL4(7500)  QUEBEC STANDARD          
         DC    AL1(07),C'H',X'6104',X'FFFF',AL4(14000) NEW BRUNSWICK            
         DC    AL1(08),C'H',X'6104',X'FFFF',AL4(14000) NOVA SCOTIA              
         DC    AL1(10),C'H',X'6104',X'FFFF',AL4(14000) NWFLND                   
         DC    X'FF'                                                            
*                                                                               
*                                                                               
* VCTAB8 USED IF TODAY IS ON OR AFTER JAN01/2008                                
*                                                                               
         DS    0D                                                               
         DC    CL8'*VCTAB8*'                                                    
VCTAB8   DS    0C                  TABLE OF VAT CODES - NAT AND PRV             
         DC    AL1(00),C'S',X'5B01',X'FFFF',AL4(5000)  NAT STANDARD             
         DC    AL1(06),C'S',X'5C07',X'FFFF',AL4(7500)  QUEBEC STANDARD          
         DC    AL1(07),C'H',X'6104',X'FFFF',AL4(13000) NEW BRUNSWICK            
         DC    AL1(08),C'H',X'6104',X'FFFF',AL4(13000) NOVA SCOTIA              
         DC    AL1(10),C'H',X'6104',X'FFFF',AL4(13000) NWFLND                   
         DC    X'FF'                                                            
*                                                                               
*                                                                               
* VCTAB10 USED IF TODAY IS ON OR AFTER MAY01/2010  (HDTO - TESTING)             
*                                      JUN18/2010 ALL OTHERE                    
*                                                                               
         DS    0D                                                               
         DC    CL8'*VCTAB10*'                                                   
VCTAB10  DS    0C                  TABLE OF VAT CODES - NAT AND PRV             
         DC    AL1(00),C'S',X'5B01',X'FFFF',AL4(5000)  NAT STANDARD             
         DC    AL1(01),C'H',X'6E07',X'FFFF',AL4(12000) BRITISH COLUMBIA         
         DC    AL1(01),C'X',X'6E07',X'FFFF',AL4(00000) BRITISH COLUMBIA         
         DC    AL1(01),C'Z',X'6E07',X'FFFF',AL4(00000) BRITISH COLUMBIA         
         DC    AL1(05),C'H',X'6E07',X'FFFF',AL4(13000) ONTARIO                  
         DC    AL1(05),C'X',X'6E07',X'FFFF',AL4(00000) ONTARIO                  
         DC    AL1(05),C'Z',X'6E07',X'FFFF',AL4(00000) ONTARIO                  
         DC    AL1(06),C'S',X'5C07',X'FFFF',AL4(7500)  QUEBEC STANDARD          
         DC    AL1(07),C'H',X'6104',X'FFFF',AL4(13000) NEW BRUNSWICK            
         DC    AL1(07),C'X',X'6104',X'FFFF',AL4(00000) NEW BRUNSWICK            
         DC    AL1(07),C'Z',X'6104',X'FFFF',AL4(00000) NEW BRUNSWICK            
         DC    AL1(08),C'H',X'6104',X'6E06',AL4(13000) NOVA SCOTIA              
         DC    AL1(08),C'X',X'6104',X'6E06',AL4(00000) NOVA SCOTIA              
         DC    AL1(08),C'Z',X'6104',X'6E06',AL4(00000) NOVA SCOTIA              
         DC    AL1(08),C'H',X'6E07',X'FFFF',AL4(15000) NOVA SCOTIA              
         DC    AL1(08),C'X',X'6E07',X'FFFF',AL4(00000) NOVA SCOTIA              
         DC    AL1(08),C'Z',X'6E07',X'FFFF',AL4(00000) NOVA SCOTIA              
         DC    AL1(10),C'H',X'6104',X'FFFF',AL4(13000) NEWFOUNDLAND             
         DC    AL1(10),C'X',X'6104',X'FFFF',AL4(00000) NEWFOUNDLAND             
         DC    AL1(10),C'Z',X'6104',X'FFFF',AL4(00000) NEWFOUNDLAND             
         DC    X'FF'                                                            
*                                                                               
*                                                                               
* VCTAB11 USED IF TODAY IS ON OR AFTER DEC01/2010  (HDTO - TESTING)             
*                                      JAN01/2011 ALL OTHERS                    
*                                                                               
         DS    0D                                                               
         DC    CL8'*VCTAB11*'                                                   
VCTAB11  DS    0C                  TABLE OF VAT CODES - NAT AND PRV             
         DC    AL1(00),C'S',X'5B01',X'FFFF',AL4(5000)  NAT STANDARD             
         DC    AL1(01),C'H',X'6E07',X'FFFF',AL4(12000) BRITISH COLUMBIA         
         DC    AL1(01),C'X',X'6E07',X'FFFF',AL4(00000) BRITISH COLUMBIA         
         DC    AL1(01),C'Z',X'6E07',X'FFFF',AL4(00000) BRITISH COLUMBIA         
         DC    AL1(05),C'H',X'6E07',X'FFFF',AL4(13000) ONTARIO                  
         DC    AL1(05),C'X',X'6E07',X'FFFF',AL4(00000) ONTARIO                  
         DC    AL1(05),C'Z',X'6E07',X'FFFF',AL4(00000) ONTARIO                  
         DC    AL1(06),C'S',X'5C07',X'FFFF',AL4(8500)  QUEBEC STANDARD          
         DC    AL1(07),C'H',X'6104',X'FFFF',AL4(13000) NEW BRUNSWICK            
         DC    AL1(07),C'X',X'6104',X'FFFF',AL4(00000) NEW BRUNSWICK            
         DC    AL1(07),C'Z',X'6104',X'FFFF',AL4(00000) NEW BRUNSWICK            
         DC    AL1(08),C'H',X'6104',X'6E06',AL4(13000) NOVA SCOTIA              
         DC    AL1(08),C'X',X'6104',X'6E06',AL4(00000) NOVA SCOTIA              
         DC    AL1(08),C'Z',X'6104',X'6E06',AL4(00000) NOVA SCOTIA              
         DC    AL1(08),C'H',X'6E07',X'FFFF',AL4(15000) NOVA SCOTIA              
         DC    AL1(08),C'X',X'6E07',X'FFFF',AL4(00000) NOVA SCOTIA              
         DC    AL1(08),C'Z',X'6E07',X'FFFF',AL4(00000) NOVA SCOTIA              
         DC    AL1(10),C'H',X'6104',X'FFFF',AL4(13000) NEWFOUNDLAND             
         DC    AL1(10),C'X',X'6104',X'FFFF',AL4(00000) NEWFOUNDLAND             
         DC    AL1(10),C'Z',X'6104',X'FFFF',AL4(00000) NEWFOUNDLAND             
         DC    X'FF'                                                            
*                                                                               
*                                                                               
* VCTAB12 USED IF TODAY IS ON OR AFTER JAN01/2012 FOR ALL AGENCIES              
*                                                                               
         DC    CL8'*VCTAB12*'                                                   
VCTAB12  DS    0C                  TABLE OF VAT CODES - NAT AND PRV             
         DC    AL1(00),C'S',X'5B01',X'FFFF',AL4(5000)  NAT STANDARD             
         DC    AL1(01),C'H',X'6E07',X'FFFF',AL4(12000) BRITISH COLUMBIA         
         DC    AL1(01),C'X',X'6E07',X'FFFF',AL4(00000) BRITISH COLUMBIA         
         DC    AL1(01),C'Z',X'6E07',X'FFFF',AL4(00000) BRITISH COLUMBIA         
         DC    AL1(05),C'H',X'6E07',X'FFFF',AL4(13000) ONTARIO                  
         DC    AL1(05),C'X',X'6E07',X'FFFF',AL4(00000) ONTARIO                  
         DC    AL1(05),C'Z',X'6E07',X'FFFF',AL4(00000) ONTARIO                  
         DC    AL1(06),C'S',X'5C07',X'FFFF',AL4(9500) QUEBEC STANDARD           
         DC    AL1(07),C'H',X'6104',X'FFFF',AL4(13000) NEW BRUNSWICK            
         DC    AL1(07),C'X',X'6104',X'FFFF',AL4(00000) NEW BRUNSWICK            
         DC    AL1(07),C'Z',X'6104',X'FFFF',AL4(00000) NEW BRUNSWICK            
*****    DC    AL1(08),C'H',X'6104',X'6E06',AL4(13000) NOVA SCOTIA              
*****    DC    AL1(08),C'X',X'6104',X'6E06',AL4(00000) NOVA SCOTIA              
****     DC    AL1(08),C'Z',X'6104',X'6E06',AL4(00000) NOVA SCOTIA              
         DC    AL1(08),C'H',X'6E07',X'FFFF',AL4(15000) NOVA SCOTIA              
         DC    AL1(08),C'X',X'6E07',X'FFFF',AL4(00000) NOVA SCOTIA              
         DC    AL1(08),C'Z',X'6E07',X'FFFF',AL4(00000) NOVA SCOTIA              
         DC    AL1(10),C'H',X'6104',X'FFFF',AL4(13000) NEWFOUNDLAND             
         DC    AL1(10),C'X',X'6104',X'FFFF',AL4(00000) NEWFOUNDLAND             
         DC    AL1(10),C'Z',X'6104',X'FFFF',AL4(00000) NEWFOUNDLAND             
         DC    X'FF'                                                            
*                                                                               
*                                                                               
* VCTAB13 USED IF TODAY IS ON OR AFTER JAN01/2013 FOR ALL AGENCIES              
*                                                                               
         DC    CL8'*VCTAB13*'                                                   
VCTAB13  DS    0C                  TABLE OF VAT CODES - NAT AND PRV             
         DC    AL1(00),C'S',X'5B01',X'FFFF',AL4(5000)  NAT STANDARD             
         DC    AL1(01),C'H',X'6E07',X'FFFF',AL4(12000) BRITISH COLUMBIA         
         DC    AL1(01),C'X',X'6E07',X'FFFF',AL4(00000) BRITISH COLUMBIA         
         DC    AL1(01),C'Z',X'6E07',X'FFFF',AL4(00000) BRITISH COLUMBIA         
         DC    AL1(05),C'H',X'6E07',X'FFFF',AL4(13000) ONTARIO                  
         DC    AL1(05),C'X',X'6E07',X'FFFF',AL4(00000) ONTARIO                  
         DC    AL1(05),C'Z',X'6E07',X'FFFF',AL4(00000) ONTARIO                  
         DC    AL1(06),C'S',X'5C07',X'FFFF',AL4(9975) QUEBEC STANDARD           
         DC    AL1(07),C'H',X'6104',X'FFFF',AL4(13000) NEW BRUNSWICK            
         DC    AL1(07),C'X',X'6104',X'FFFF',AL4(00000) NEW BRUNSWICK            
         DC    AL1(07),C'Z',X'6104',X'FFFF',AL4(00000) NEW BRUNSWICK            
*****    DC    AL1(08),C'H',X'6104',X'6E06',AL4(13000) NOVA SCOTIA              
*****    DC    AL1(08),C'X',X'6104',X'6E06',AL4(00000) NOVA SCOTIA              
*****    DC    AL1(08),C'Z',X'6104',X'6E06',AL4(00000) NOVA SCOTIA              
         DC    AL1(08),C'H',X'6E07',X'FFFF',AL4(15000) NOVA SCOTIA              
         DC    AL1(08),C'X',X'6E07',X'FFFF',AL4(00000) NOVA SCOTIA              
         DC    AL1(08),C'Z',X'6E07',X'FFFF',AL4(00000) NOVA SCOTIA              
         DC    AL1(10),C'H',X'6104',X'FFFF',AL4(13000) NEWFOUNDLAND             
         DC    AL1(10),C'X',X'6104',X'FFFF',AL4(00000) NEWFOUNDLAND             
         DC    AL1(10),C'Z',X'6104',X'FFFF',AL4(00000) NEWFOUNDLAND             
         DC    X'FF'                                                            
*                                                                               
* VCTAB13A USED IF TODAY IS ON OR AFTER OCT01/2014 FOR ALL AGENCIES             
*          UNLESS DOING A REVERSAL OF BILLING CREATED BEFORE                    
*          OCT01/2014 - FOR THOSE USE VCTAB13R                                  
*                                                                               
         DC    CL8'*VCTAB13A*'                                                  
VCTAB13A DS    0C                  TABLE OF VAT CODES - NAT AND PRV             
         DC    AL1(00),C'S',X'5B01',X'FFFF',AL4(5000)  NAT STANDARD             
         DC    AL1(00),C'X',X'5B01',X'FFFF',AL4(0000)  NAT EXEMPT               
         DC    AL1(00),C'Z',X'5B01',X'FFFF',AL4(0000)  NAT ZERO-RATED           
******   DC    AL1(01),C'H',X'6E07',X'FFFF',AL4(00000) BRITISH COLUMBIA         
******   DC    AL1(01),C'X',X'6E07',X'FFFF',AL4(00000) BRITISH COLUMBIA         
******   DC    AL1(01),C'Z',X'6E07',X'FFFF',AL4(00000) BRITISH COLUMBIA         
         DC    AL1(05),C'H',X'6E07',X'FFFF',AL4(13000) ONTARIO                  
         DC    AL1(05),C'X',X'6E07',X'FFFF',AL4(00000) ONTARIO                  
         DC    AL1(05),C'Z',X'6E07',X'FFFF',AL4(00000) ONTARIO                  
         DC    AL1(06),C'S',X'5C07',X'FFFF',AL4(9975)  QUEBEC STANDARD          
         DC    AL1(07),C'H',X'6104',X'FFFF',AL4(13000) NEW BRUNSWICK            
         DC    AL1(07),C'X',X'6104',X'FFFF',AL4(00000) NEW BRUNSWICK            
         DC    AL1(07),C'Z',X'6104',X'FFFF',AL4(00000) NEW BRUNSWICK            
*****    DC    AL1(08),C'H',X'6104',X'6E06',AL4(13000) NOVA SCOTIA              
*****    DC    AL1(08),C'X',X'6104',X'6E06',AL4(00000) NOVA SCOTIA              
*****    DC    AL1(08),C'Z',X'6104',X'6E06',AL4(00000) NOVA SCOTIA              
         DC    AL1(08),C'H',X'6E07',X'FFFF',AL4(15000) NOVA SCOTIA              
         DC    AL1(08),C'X',X'6E07',X'FFFF',AL4(00000) NOVA SCOTIA              
         DC    AL1(08),C'Z',X'6E07',X'FFFF',AL4(00000) NOVA SCOTIA              
         DC    AL1(09),C'H',X'6E07',X'FFFF',AL4(14000) P.E. ISLAND              
         DC    AL1(09),C'X',X'6E07',X'FFFF',AL4(00000) P.E. ISLAND              
         DC    AL1(09),C'Z',X'6E07',X'FFFF',AL4(00000) P.E. ISLAND              
         DC    AL1(10),C'H',X'6104',X'FFFF',AL4(13000) NEWFOUNDLAND             
         DC    AL1(10),C'X',X'6104',X'FFFF',AL4(00000) NEWFOUNDLAND             
         DC    AL1(10),C'Z',X'6104',X'FFFF',AL4(00000) NEWFOUNDLAND             
         DC    X'FF'                                                            
*                                                                               
* VCTAB13R USE FOR HDTO REVERSALS OF BILLING DONE BEFORE 9/10/14                
*          FOR OTHER AGENCIES USE DATE OF GST FIX RELEASE (9/30/14?)            
*                                                                               
         DC    CL8'*VCTAB13R*'                                                  
VCTAB13R DS    0C                  TABLE OF VAT CODES - NAT AND PRV             
         DC    AL1(00),C'S',X'5B01',X'FFFF',AL4(5000)  NAT STANDARD             
******   DC    AL1(01),C'H',X'6E07',X'FFFF',AL4(00000) BRITISH COLUMBIA         
******   DC    AL1(01),C'X',X'6E07',X'FFFF',AL4(00000) BRITISH COLUMBIA         
******   DC    AL1(01),C'Z',X'6E07',X'FFFF',AL4(00000) BRITISH COLUMBIA         
         DC    AL1(05),C'H',X'6E07',X'FFFF',AL4(13000) ONTARIO                  
         DC    AL1(05),C'X',X'6E07',X'FFFF',AL4(00000) ONTARIO                  
         DC    AL1(05),C'Z',X'6E07',X'FFFF',AL4(00000) ONTARIO                  
         DC    AL1(06),C'S',X'5C07',X'FFFF',AL4(9975)  QUEBEC STANDARD          
         DC    AL1(07),C'H',X'6104',X'FFFF',AL4(13000) NEW BRUNSWICK            
         DC    AL1(07),C'X',X'6104',X'FFFF',AL4(00000) NEW BRUNSWICK            
         DC    AL1(07),C'Z',X'6104',X'FFFF',AL4(00000) NEW BRUNSWICK            
*****    DC    AL1(08),C'H',X'6104',X'6E06',AL4(13000) NOVA SCOTIA              
*****    DC    AL1(08),C'X',X'6104',X'6E06',AL4(00000) NOVA SCOTIA              
*****    DC    AL1(08),C'Z',X'6104',X'6E06',AL4(00000) NOVA SCOTIA              
         DC    AL1(08),C'H',X'6E07',X'FFFF',AL4(15000) NOVA SCOTIA              
         DC    AL1(08),C'X',X'6E07',X'FFFF',AL4(00000) NOVA SCOTIA              
         DC    AL1(08),C'Z',X'6E07',X'FFFF',AL4(00000) NOVA SCOTIA              
         DC    AL1(09),C'H',X'6E07',X'FFFF',AL4(14000) P.E. ISLAND              
         DC    AL1(09),C'X',X'6E07',X'FFFF',AL4(00000) P.E. ISLAND              
         DC    AL1(09),C'Z',X'6E07',X'FFFF',AL4(00000) P.E. ISLAND              
         DC    AL1(10),C'H',X'6104',X'FFFF',AL4(13000) NEWFOUNDLAND             
         DC    AL1(10),C'X',X'6104',X'FFFF',AL4(00000) NEWFOUNDLAND             
         DC    AL1(10),C'Z',X'6104',X'FFFF',AL4(00000) NEWFOUNDLAND             
         DC    X'FF'                                                            
*                                                                               
* VCTAB16 USED IF TODAY IS ON OR AFTER JUL01/2016 FOR ALL AGENCIES              
*          UNLESS DOING A REVERSAL OF BILLING CREATED BEFORE                    
*                                                                               
         DC    CL8'*VCTAB16*'                                                   
VCTAB16  DS    0C                  TABLE OF VAT CODES - NAT AND PRV             
         DC    AL1(00),C'S',X'5B01',X'FFFF',AL4(5000)  NAT STANDARD             
         DC    AL1(00),C'X',X'5B01',X'FFFF',AL4(0000)  NAT EXEMPT               
         DC    AL1(00),C'Z',X'5B01',X'FFFF',AL4(0000)  NAT ZERO-RATED           
******   DC    AL1(01),C'H',X'6E07',X'FFFF',AL4(00000) BRITISH COLUMBIA         
******   DC    AL1(01),C'X',X'6E07',X'FFFF',AL4(00000) BRITISH COLUMBIA         
******   DC    AL1(01),C'Z',X'6E07',X'FFFF',AL4(00000) BRITISH COLUMBIA         
         DC    AL1(05),C'H',X'6E07',X'FFFF',AL4(13000) ONTARIO                  
         DC    AL1(05),C'X',X'6E07',X'FFFF',AL4(00000) ONTARIO                  
         DC    AL1(05),C'Z',X'6E07',X'FFFF',AL4(00000) ONTARIO                  
         DC    AL1(06),C'S',X'5C07',X'FFFF',AL4(9975)  QUEBEC STANDARD          
         DC    AL1(07),C'H',X'6104',X'FFFF',AL4(15000) NEW BRUNSWICK            
         DC    AL1(07),C'X',X'6104',X'FFFF',AL4(00000) NEW BRUNSWICK            
         DC    AL1(07),C'Z',X'6104',X'FFFF',AL4(00000) NEW BRUNSWICK            
*****    DC    AL1(08),C'H',X'6104',X'6E06',AL4(13000) NOVA SCOTIA              
*****    DC    AL1(08),C'X',X'6104',X'6E06',AL4(00000) NOVA SCOTIA              
*****    DC    AL1(08),C'Z',X'6104',X'6E06',AL4(00000) NOVA SCOTIA              
         DC    AL1(08),C'H',X'6E07',X'FFFF',AL4(15000) NOVA SCOTIA              
         DC    AL1(08),C'X',X'6E07',X'FFFF',AL4(00000) NOVA SCOTIA              
         DC    AL1(08),C'Z',X'6E07',X'FFFF',AL4(00000) NOVA SCOTIA              
         DC    AL1(09),C'H',X'6E07',X'FFFF',AL4(14000) P.E. ISLAND              
         DC    AL1(09),C'X',X'6E07',X'FFFF',AL4(00000) P.E. ISLAND              
         DC    AL1(09),C'Z',X'6E07',X'FFFF',AL4(00000) P.E. ISLAND              
         DC    AL1(10),C'H',X'6104',X'FFFF',AL4(15000) NEWFOUNDLAND             
         DC    AL1(10),C'X',X'6104',X'FFFF',AL4(00000) NEWFOUNDLAND             
         DC    AL1(10),C'Z',X'6104',X'FFFF',AL4(00000) NEWFOUNDLAND             
         DC    X'FF'                                                            
*                                                                               
*                                                                               
* VCTAB16A USED IF TODAY IS ON OR AFTER OCT01/2016 FOR ALL AGENCIES             
*          UNLESS DOING A REVERSAL OF BILLING CREATED BEFORE                    
*                                                                               
         DC    CL8'*VCTAB16A*'                                                  
VCTAB16A DS    0C                  TABLE OF VAT CODES - NAT AND PRV             
         DC    AL1(00),C'S',X'5B01',X'FFFF',AL4(5000)  NAT STANDARD             
         DC    AL1(00),C'X',X'5B01',X'FFFF',AL4(0000)  NAT EXEMPT               
         DC    AL1(00),C'Z',X'5B01',X'FFFF',AL4(0000)  NAT ZERO-RATED           
******   DC    AL1(01),C'H',X'6E07',X'FFFF',AL4(00000) BRITISH COLUMBIA         
******   DC    AL1(01),C'X',X'6E07',X'FFFF',AL4(00000) BRITISH COLUMBIA         
******   DC    AL1(01),C'Z',X'6E07',X'FFFF',AL4(00000) BRITISH COLUMBIA         
         DC    AL1(05),C'H',X'6E07',X'FFFF',AL4(13000) ONTARIO                  
         DC    AL1(05),C'X',X'6E07',X'FFFF',AL4(00000) ONTARIO                  
         DC    AL1(05),C'Z',X'6E07',X'FFFF',AL4(00000) ONTARIO                  
         DC    AL1(06),C'S',X'5C07',X'FFFF',AL4(9975)  QUEBEC STANDARD          
         DC    AL1(07),C'H',X'6104',X'FFFF',AL4(15000) NEW BRUNSWICK            
         DC    AL1(07),C'X',X'6104',X'FFFF',AL4(00000) NEW BRUNSWICK            
         DC    AL1(07),C'Z',X'6104',X'FFFF',AL4(00000) NEW BRUNSWICK            
*****    DC    AL1(08),C'H',X'6104',X'6E06',AL4(13000) NOVA SCOTIA              
*****    DC    AL1(08),C'X',X'6104',X'6E06',AL4(00000) NOVA SCOTIA              
*****    DC    AL1(08),C'Z',X'6104',X'6E06',AL4(00000) NOVA SCOTIA              
         DC    AL1(08),C'H',X'6E07',X'FFFF',AL4(15000) NOVA SCOTIA              
         DC    AL1(08),C'X',X'6E07',X'FFFF',AL4(00000) NOVA SCOTIA              
         DC    AL1(08),C'Z',X'6E07',X'FFFF',AL4(00000) NOVA SCOTIA              
         DC    AL1(09),C'H',X'6E07',X'FFFF',AL4(15000) P.E. ISLAND              
         DC    AL1(09),C'X',X'6E07',X'FFFF',AL4(00000) P.E. ISLAND              
         DC    AL1(09),C'Z',X'6E07',X'FFFF',AL4(00000) P.E. ISLAND              
         DC    AL1(10),C'H',X'6104',X'FFFF',AL4(15000) NEWFOUNDLAND             
         DC    AL1(10),C'X',X'6104',X'FFFF',AL4(00000) NEWFOUNDLAND             
         DC    AL1(10),C'Z',X'6104',X'FFFF',AL4(00000) NEWFOUNDLAND             
         DC    X'FF'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*VATACCS'                                                    
VATACCS  ORG   *+(16*(NPROVS+1))   TABLE OF VAT ACCOUNTS - NAT AND PRV          
         DC    X'00'                                                            
*                                                                               
*                                                                               
         DS    0D                                                               
         DC    CL8'*VBTAB**'                                                    
VBTAB    ORG   *+(VTOTSIZE*MAXLEVS)  TABLE OF VAT BASES (NAT AND PRV)           
         DC    X'00'                                                            
*                                                                               
*                                                                               
         DS    0D                                                               
         DC    CL8'*PSTNAMS'                                                    
PSTNAMS  DS    0C                  TABLE OF GST/PST NAMES- ENG,FRENCH           
         DC    CL14'GST    TPS    '      NATIONAL                               
         DC    CL14'HST-BC HST-BC '                                             
         DC    CL14'PST-AL PST-AL '                                             
         DC    CL14'PST-SA PST-SA '                                             
         DC    CL14'PST-MA PST-MA '                                             
         DC    CL14'HST-ON HST-ON '                                             
         DC    CL14'QST    TVQ    '                                             
         DC    CL14'HST-NB HST-NB '                                             
         DC    CL14'HST-NS HST-NS '                                             
         DC    CL14'HST-PEIHST-PEI'                                             
         DC    CL14'HST-NFDHST-NFD'                                             
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*JADDRS*'                                                    
JADDRS   ORG   *+(310)             JOB- REP ADDRESS                             
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*EADDRS*'                                                    
EADDRS   ORG   *+(310)             EST- REP ADDRESS                             
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*DADDRS*'                                                    
DADDRS   ORG   *+(310)             DIV- REP ADDRESS                             
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*RADDRS*'                                                    
RADDRS   ORG   *+(310)             REG- REP ADDRESS                             
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*BADDRS*'                                                    
BADDRS   ORG   *+(310)             BRAND ADDRESS  (WAS 180)                     
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*AADDRS*'                                                    
AADDRS   ORG   *+(310)             AAA ADDRESS  (WAS 180)                       
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*CADDRS*'                                                    
CADDRS   ORG   *+(310)             CORPORATE ADDRESS (RETAIL)                   
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*AORADDR'                                                    
AORADDR  ORG   *+(310)             AOR ADDRESS                                  
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*PEPTWRK'                                                    
PEPTWRK  ORG   *+(PEPTABRL)        WORK SPACE FOR PEPTAB ENTRY                  
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*CLTTAB*'                                                    
CLTTAB   ORG  *+(CLTBMAX*4)                                                     
         DC   X'00'                                                             
         EJECT                                                                  
DICSECT  DS    0D                                                               
*                                                                               
*        PRINTPAK DICTIONARY ENTRIES FOR BILLING (PPB1,PPD1,PPR1)               
*                                                                               
DCLIST   DS    0C                                                               
* LITERALS FOR PPB12A                                                           
         DCDDL PP#ALL,3                                                         
         DCDDL PP#AOR,3                                                         
*                              NOTE PP#AOR ALSO USED IN PPB12B                  
         DCDDL PP#AORBL,60                                                      
         DCDDL PP#AORBS,14                                                      
         DCDDL PP#AORFE,14                                                      
         DCDDL PP#BASAM,14                                                      
         DCDDL PP#BILPD,22                                                      
         DCDDL PP#BLNG,11                                                       
         DCDDL PP#CDIO,30                                                       
         DCDDL PP#CDVIO,34                                                      
         DCDDL PP#CDVNC,39                                                      
         DCDDL PP#CDVO,32                                                       
         DCDDL PP#CLEAR,9                                                       
         DCDDL PP#CRB,23                                                        
         DCDDL PP#CTRLN,11                                                      
         DCDDL PP#DATE,4                                                        
         DCDDL PP#DIST,8                                                        
         DCDDL PP#DIV,8                                                         
         DCDDL PP#DOCDT,13                                                      
         DCDDL PP#DOCNO,12                                                      
         DCDDL PP#DRFBL,17                                                      
         DCDDL PP#DTL1,60                                                       
         DCDDL PP#DTLBK,20                                                      
         DCDDL PP#DUEDT,14                                                      
         DCDDL PP#EST,8                                                         
         DCDDL PP#ESTSV,16,R                                                    
         DCDDL PP#GRSAM,14                                                      
         DCDDL PP#INSRT,6                                                       
         DCDDL PP#INVOC,7                                                       
         DCDDL PP#INVL3,60                                                      
         DCDDL PP#INVL4,60                                                      
         DCDDL PP#INVL5,60                                                      
         DCDDL PP#INVL6,60                                                      
         DCDDL PP#INVL7,60                                                      
         DCDDL PP#INVBK,21                                                      
         DCDDL PP#INVDT,12                                                      
         DCDDL PP#MARKT,6,LABEL=PP6MARKT                                        
         DCDDL PP#MARKT,7,LABEL=PP7MARKT                                        
         DCDDL PP#MED,5                                                         
         DCDDL PP#MED02,29                                                      
         DCDDL PP#MEDBL,20                                                      
         DCDDL PP#MERR1,60                                                      
         DCDDL PP#MERR2,60                                                      
         DCDDL PP#MLT01,60         MLT01+MLT02                                  
         DCDDL PP#MLT02,60                                                      
         DCDDL PP#MTHOF,8                                                       
         DCDDL PP#MTHSV,16,R                                                    
         DCDDL PP#NCDVC,36                                                      
         DCDDL PP#NCDIO,34                                                      
         DCDDL PP#NCDVN,38                                                      
         DCDDL PP#NCDVO,36                                                      
         DCDDL PP#NEWB,60                                                       
         DCDDL PP#NOBG,60                                                       
         DCDDL PP#NOBIL,34,R                                                    
         DCDDL PP#PAGE,4                                                        
         DCDDL PP#PERD,6                                                        
         DCDDL PP#POST,7                                                        
         DCDDL PP#PRO,7                                                         
         DCDDL PP#PROF,60                                                       
         DCDDL PP#PUB,3                                                         
         DCDDL PP#REG,60                                                        
         DCDDL PP#REGN,6                                                        
         DCDDL PP#REVIS,3                                                       
         DCDDL PP#SPACE,6                                                       
         DCDDL PP#THRU,4                                                        
         DCDDL PP#TSTBL,16                                                      
* LITERALS FOR INVWD1                                                           
         DCDDL PP#CNTRL,11,C                                                    
         DCDDL PP#NUM,10,C                                                      
         DCDDL PP#BLAMT,16,C                                                    
* LITERALS FOR TYPNAMES AND CATNAMES    - MUST BE 16 BYTES                      
         DCDDL PP#ORD,16,R                                                      
         DCDDL PP#PRV04,16,R                                                    
         DCDDL PP#BILLA,16,R                                                    
         DCDDL PP#GROSS,16,R,LABEL=PPRGROSS                                     
         DCDDL PP#NET,16,R,LABEL=PPRNET                                         
         DCDDL PP#CDISC,16,R                                                    
         DCDDL PP#GRSLC,16,R,LABEL=PPRGRSLC                                     
         DCDDL PP#NETCD,16,R,LABEL=PPRNETCD                                     
         DCDDL PP#AGYCM,16,R,LABEL=PPAAGYCM                                     
* LITERALS FOR PPB12B                                                           
         DCDDL PP#CD,2                                                          
         DCDDL PP#CLI,6                                                         
         DCDDL PP#CLI,7,LABEL=PP7CLI                                            
         DCDDL PP#GRTOT,16                                                      
         DCDDL PP#MDTOT,16                                                      
         DCDDL PP#OPEN,5                                                        
         DCDDL PP#TOTAL,5                                                       
         DCDDL PP#TOTAL,7,LABEL=PP7TOTAL                                        
* FOR MEDLIST                                                                   
         DCDDL PP#NEWS,10                                                       
         DCDDL PP#MAG,10                                                        
         DCDDL PP#TRD,10                                                        
         DCDDL PP#SPL,10                                                        
         DCDDL PP#OUT,10                                                        
* LITERALS FOR PPB12C                                                           
         DCDDL PP#ORD01,57                                                      
         DCDDL PP#AMT01,14,R                                                    
         DCDDL PP#PCORD,21                                                      
         DCDDL PP#REV01,36                                                      
         DCDDL PP#PRO,8,LABEL=PP8PRO                                            
         DCDDL PP#TOTAL,8,LABEL=PP8TOTAL                                        
         DCDDL PP#PRDTL,14                                                      
         DCDDL PP#PRO,7,LABEL=PP7PRO                                            
         DCDDL PP#ESTOT,15                                                      
         DCDDL PP#TOTAL,9,LABEL=PP9TOTAL                                        
         DCDDL PP#MKTST,13,LABEL=PPAMKTST                                       
         DCDDL PP#MKTST,15,LABEL=PPBMKTST                                       
         DCDDL PP#MKTST,12,LABEL=PPCMKTST                                       
         DCDDL PP#MARKT,6                                                       
         DCDDL PP#VEND,6                                                        
         DCDDL PP#VNTOT,14                                                      
         DCDDL PP#VSTOT,15                                                      
         DCDDL PP#ADCOD,7,LABEL=PPAADCOD                                        
         DCDDL PP#TOTS,8,LABEL=PP8TOTS           *TOTAL*                        
         DCDDL PP#TOTS,12                        ** TOTALS **                   
         DCDDL PP#NO,5                                                          
         DCDDL PP#FOR,3                                                         
         DCDDL PP#ESTN,9                                                        
         DCDDL PP#ADCOD,8                                                       
         DCDDL PP#NONE,7                                                        
         DCDDL PP#COPY,6                                                        
         DCDDL PP#PBR,19                                                        
         DCDDL PP#OR,3                                                          
         DCDDL PP#CR,4                                                          
         DCDDL PP#OC,3                                                          
         DCDDL PP#CC,4                                                          
         DCDDL PP#OSDAT,12                                                      
         DCDDL PP#COPY,5,LABEL=PP5COPY                                          
         DCDDL PP#ADNO,7                                                        
         DCDDL PP#PREV,10                                                       
         DCDDL PP#BLDIN,17                                                      
         DCDDL PP#PRV01,14                                                      
         DCDDL PP#BILL,4                                                        
         DCDDL PP#PRV02,19                                                      
         DCDDL PP#SCHM,28                                                       
* LITERALS FOR PPB12D                                                           
         DCDDL PP#AAMT,19                                                       
         DCDDL PP#ACASH,26                                                      
         DCDDL PP#ADFOR,15,R                                                    
         DCDDL PP#ADJUS,11,R                                                    
         DCDDL PP#AGYCA,25,R                                                    
         DCDDL PP#AGYCM,10                                                      
         DCDDL PP#AGYF,17,R                                                     
         DCDDL PP#AGYOF,62                                                      
         DCDDL PP#AMDUE,16                                                      
         DCDDL PP#AMTBI,24                                                      
         DCDDL PP#BA01,39,R                                                     
         DCDDL PP#B1GRS,18                                                      
         DCDDL PP#B1NET,18                                                      
         DCDDL PP#B1AC,18                                                       
         DCDDL PP#BLDTO,44                                                      
         DCDDL PP#CAMFR,22,R                                                    
         DCDDL PP#CDAMT,19                                                      
         DCDDL PP#CMADJ,21,R                                                    
         DCDDL PP#COMM,5                                                        
         DCDDL PP#DCASH,26                                                      
         DCDDL PP#GROSS,5                                                       
         DCDDL PP#GRSAM,19,R,LABEL=PPRGRSAM                                     
         DCDDL PP#GRSCD,21,R                                                    
         DCDDL PP#GRSLC,13                                                      
         DCDDL PP#IF01,26,R,LABEL=PPSIF01                                       
         DCDDL PP#IF01,34,R                                                     
         DCDDL PP#ITEM,49                                                       
         DCDDL PP#LPB,21                                                        
         DCDDL PP#LESS,5,R                                                      
         DCDDL PP#LTAX,10                                                       
         DCDDL PP#NAMT,11,R                                                     
         DCDDL PP#NLCA,20,R                                                     
         DCDDL PP#NET,3                                                         
         DCDDL PP#NETCD,11                                                      
         DCDDL PP#PCASH,18                                                      
         DCDDL PP#PCT,3                                                         
         DCDDL PP#PCTAB,18                                                      
         DCDDL PP#PCTOF,10                                                      
         DCDDL PP#PLUS,4                                                        
         DCDDL PP#POFA,12                                                       
         DCDDL PP#PRV03,19                                                      
         DCDDL PP#PRVBL,17                                                      
         DCDDL PP#STAX,13                                                       
         DCDDL PP#SUBTO,44                                                      
         DCDDL PP#TAMT,18                                                       
         DCDDL PP#THE01,49                                                      
         DCDDL PP#TLFOR,10,R                                                    
         DCDDL PP#TOTAL,6,LABEL=PP6TOTAL       TOTALS                           
*                                          NOTE - PPB12C ALSO USES              
*                                          PP6TOTAL                             
         DCDDL PP#YSOT,19                                                       
         DCDDL PP#GST,6                                                         
         DCDDL PP#GSTAC,9                                                       
         DCDDL PP#CMAMT,18                                                      
*                                                                               
DCLISTX  DC    X'00'                                                            
*                                                                               
DSLIST   DS    0C                                                               
         DSDDL PRINT=YES                                                        
DSLISTX  EQU   *                                                                
*                                                                               
         PRINT OFF                                                              
       ++INCLUDE PPDDEQUS                                                       
         PRINT ON                                                               
         EJECT                                                                  
*                                  BUFFALO CSECT                                
         PRINT GEN                                                              
         BUFF  LINES=01000,ROWS=1,COLUMNS=24,COMMENT=6,FLAVOR=BINARY,  X        
               KEYLIST=(1,A)                                                    
         PRINT NOGEN                                                            
*                                                                               
         DC    50X'00'                                                          
         EJECT                                                                  
PPB102   CSECT                                                                  
         EJECT                                                                  
*       BILLING WORK AREA DSECT                                                 
*                                                                               
*   NOTE - WHEN ADDING NEW FULL OR HALF WORD FIELDS DO SO                       
*          BEFORE BRKTAB   TO SAVE WASTING SPARE BYTES                          
*                                                                               
*   CHANGE LOG                                                                  
*                                                                               
*   DEIS   12/5/01  INVTBN CHANGED FROM 2000 TO 3000                            
*                                                                               
*   BPLA   8/16/00  COPY OF PPREPB1WRK                                          
*                   THIS INCLUDES PNNEWFILE IN PLACE                            
*                   OF PPNEWFILE                                                
*                                                                               
*   BPLA   6/99   CAROPT AND CAROPTC ADDED (NEEDED FOR COST2)                   
*                                                                               
*   BPLA   10/98  PUMODE ADDED AFTER FMULTMED                                   
*                 PRTUSER ADDED TO RCONS - LAST SPARE NOW USED                  
*                                                                               
*   BPLA   9/98   FMULTMED ADDED AFTER PSHPDTE (SPARE ADJUSTED)                 
*                                                                               
*   BPLA   8/98   ADDED PSHPDTE FOR SHIP DATE (FORD)                            
*                 ADDED AFTER OUTMODE - SPARE ADJUSTED                          
*                                                                               
*   BPLA   1/98   ADDED OUTMODE (FOR EDI BILLING)                               
*                 RGRSD,RNETD,RCDD,RACD,RTAXD,RINSD EQUATES                     
*                 RBGRSD,RBNETD,RBCDD,RBACD,RBTAXD,RBINSD EQUATES               
*                                                                               
*   BPLA  8/97    ADDED INCLUDE FOR PPBILLEDID                                  
*                 AND ABILLEDI ADDED (SPARE CHANGED)                            
*                                                                               
*   BPLA  5/97    WIOPT ADDED (WESTERN SUPPRESS $ OPTION)                       
*                                                                               
*   BPLA  2/97    ARDBILL ADDED TO RCONS                                        
*                 MRDASS ADDED                                                  
*                 (SPARES WERE ADJUSTED)                                        
*                                                                               
*   BPLA  10/96    NOZEOPT AND RD1OPT ADDED                                     
*                                                                               
*   BPLA 9/18/96   PPREPB1WKO MADE LIVE - USE WITH PPB12A,                      
*                  PPB12B,PPB12C,PPB12D,PPB12E,PPB1ACC                          
*                                                                               
*   BPLA 9/95      REARRANGE FIELDS TO MAXIMIZE SPARE                           
*                  AND ADD NEW FIELDS FOR INVOICING BY OFFICE                   
*                  ALSO REMOVE SOME UNUSED FIELDS                               
*                                                                               
*   BPLA 2/24/95   BFROPT AND BFRMOS ADDED                                      
*                  THEY ARE SET FROM B1X PROFILE (+11 AND +12)                  
*                                                                               
*   BPLA 6/94      PEPTKEYL EQUATE ADDED                                        
*                                                                               
*   BPLA 6/94      ADD FINANCIAL IND TO PEPTAB                                  
*                  ADD FININVSW AND SVFINSW                                     
*                                                                               
*   BPLA 6/94      FIELDS ADDED AND FIELDS REMOVED                              
*                                                                               
*   BPLA 1/3/94    CHANGES FOR CANADIAN PST                                     
*                                                                               
*   BPLA 1/3/94    COPY OF PPREPB1WK                                            
*                                                                               
*   BPLA 7/30/92   FREEOPT ADDED (PRIOR SPARE USED)                             
*                                                                               
*   BPLA 5/22/92   LINTABN (EQU) CHANGED FROM 100 TO 200                        
*                                                                               
*   BPLA 4/29/92   COMMISSION BILLING FIELDS ADDED                              
*                  SCBOPT,SCBNCSW, PROFB2B                                      
*                                                                               
*   BPLA 4/20/92   COPY OF PPREPB1WKL (LEVEL 170)                               
*                                                                               
*   BPLA 4/1/92    ADD PCTCTL  PERCENTAGE BILLING CONTROL                       
*                  FROM B4A-B7A PROFILE                                         
*   BPLA 5/17/91   BFPBASB AND BFPCOMP ADDED TO BFORMD                          
*                  LASTAORV ADDED, PEPTAB ADDITIONS                             
*                                                                               
*   BPLA 4/16/91   INVTBN CHANGED FROM 1000 TO 2000                             
*                                                                               
*   BPLA 3/11/91   AORTXOPT,AORLCTL,AORFRST ADDED (SPARE BYTES USED)            
*                                                                               
*   BPLA 11/30/90   CANADIAN GST CHANGES                                        
*                                                                               
*   BPLA 7/16/90    QMANUAL MOVED TO QAREA2 +27                                 
*                   NEEDED TO ACCOMODATE 2 REQ CARDS                            
*                   ALSO QINVDATE AND QDUEDAYS MOVED FROM                       
*                   COL 28 (8) TO COL 53 (8)                                    
*                   THIS WILL ALLOW REQUEST FOR INV DATE + DUE DAYS             
*                   WITH A PUB OR JOB OR RD= REQUEST                            
*                                                                               
*   YKVA 3/16/01    PNNEWFILE CHANGED TO PPNEWFILE                              
*                                                                               
*                   ABRKS, ATOTS,ALEVS,LEVCTLS INCREASED BY 4 TO HOLD           
*                   THE ADDRESS OF SPECIAL CHARGE BREAK                         
*                                                                               
*                   BILLWRKD IS CURRENTLY OVER 4K                               
*                                                                               
*       NEW VERSION FOR AGY COM 'C' RATE CHANGES 4/6/89                         
*       AND GRANT'S AOR CHANGES                                                 
*       BILLING WORK AREA DSECT                                                 
BILWRKD  DSECT                                                                  
BILWRK   DS    0C                                                               
*                                                                               
ADWKREC  DS    A                   A(WKREC)                                     
ABUFFC   DS    A                   A(BUFFALOC)                                  
ALINTAB  DS    A                   A(LINTAB)                                    
APATCH   DS    A                   A(PATCH)                                     
ABILLEDI DS    A                   A(USER BILLEDI ROUTINE)                      
AAELIST  DS    A                   A(AELIST)                                    
ASCCTAB  DS    A                   A(SCCTAB)                                    
AFOTABS  DS    A                   A(FOTAB) - COVAIL                            
*                                                                               
ABRKS    DS    0F                                                               
AMEDBRK  DS    A                                                                
APGR1BRK DS    A                                                                
APGR2BRK DS    A                                                                
APGR3BRK DS    A                                                                
APRDBRK  DS    A                                                                
AESTBRK  DS    A                                                                
AMGR1BRK DS    A                                                                
AMGR2BRK DS    A                                                                
AMGR3BRK DS    A                                                                
AMKTBRK  DS    A                                                                
AJOBBRK  DS    A                                                                
APUBBRK  DS    A                                                                
ADESCBRK DS    A                                                                
APERBRK  DS    A                                                                
APERGBRK DS    A                                                                
ACTYPBRK DS    A                                                                
ACRDBBRK DS    A                                                                
*                                                                               
ABRKS2   DS    0F                                                               
APAGBRK  DS    A                                                                
ARECAP   DS    A                                                                
AINVBRK  DS    A                                                                
APMSELO  DS    A                                                                
APEPLO   DS    A                                                                
APEPHI   DS    A                                                                
ALOWBRK  DS    A                                                                
ALOWTOG  DS    A                                                                
AHITOG   DS    A                                                                
ATHISBRK DS    A                                                                
SVPAGBRK DS    A                                                                
SVLOWTOG DS    A                                                                
ABRKSL   EQU   *-ABRKS                                                          
*                                                                               
         DS    0F                                                               
ATOTS    DS    0CL72                                                            
ACLTTOT  DS    A                                                                
AMEDTOT  DS    A                                                                
APGR1TOT DS    A                                                                
APGR2TOT DS    A                                                                
APGR3TOT DS    A                                                                
APRDTOT  DS    A                                                                
AESTTOT  DS    A                                                                
AMGR1TOT DS    A                                                                
AMGR2TOT DS    A                                                                
AMGR3TOT DS    A                                                                
AMKTTOT  DS    A                                                                
AJOBTOT  DS    A                                                                
APUBTOT  DS    A                                                                
ADESCTOT DS    A                                                                
APERTOT  DS    A                                                                
APERGTOT DS    A                                                                
ACTYPTOT DS    A                                                                
ACRDBTOT DS    A                                                                
*                                                                               
ATHISTOT DS    A                                                                
ANXTLIN  DS    A                                                                
*                                                                               
         DS    0F                                                               
ATOTSV   DS    0CL72      A(VAT TOTALS FOR LEVEL)                               
ACLTTOV  DS    A                                                                
AMEDTOV  DS    A                                                                
APGR1TOV DS    A                                                                
APGR2TOV DS    A                                                                
APGR3TOV DS    A                                                                
APRDTOV  DS    A                                                                
AESTTOV  DS    A                                                                
AMGR1TOV DS    A                                                                
AMGR2TOV DS    A                                                                
AMGR3TOV DS    A                                                                
AMKTTOV  DS    A                                                                
AJOBTOV  DS    A                                                                
APUBTOV  DS    A                                                                
ADESCTOV DS    A                                                                
APERTOV  DS    A                                                                
APERGTOV DS    A                                                                
ACTYPTOV DS    A                                                                
ACRDBTOV DS    A                                                                
*                                                                               
         DS    0F                                                               
ALEVS    DS    0CL72                                                            
ACLT     DS    A                                                                
AMED     DS    A                                                                
APGR1    DS    A                                                                
APGR2    DS    A                                                                
APGR3    DS    A                                                                
APRD     DS    A                                                                
AEST     DS    A                                                                
AMGR1    DS    A                                                                
AMGR2    DS    A                                                                
AMGR3    DS    A                                                                
AMKT     DS    A                                                                
AJOB     DS    A                                                                
APUB     DS    A                                                                
ADESC    DS    A                                                                
APER     DS    A                                                                
APERG    DS    A                                                                
ACTYP    DS    A                                                                
ACRDB    DS    A                                                                
*                                                                               
         DS    0F                                                               
LEVCTLS  DS    0CL72                                                            
CLTCTL   DS    F                                                                
MEDCTL   DS    F                                                                
PGR1CTL  DS    F                                                                
PGR2CTL  DS    F                                                                
PGR3CTL  DS    F                                                                
PRDCTL   DS    F                                                                
ESTCTL   DS    F                                                                
MGR1CTL  DS    F                                                                
MGR2CTL  DS    F                                                                
MGR3CTL  DS    F                                                                
MKTCTL   DS    F                                                                
JOBCTL   DS    F                                                                
PUBCTL   DS    F                                                                
DESCCTL  DS    F                                                                
PERCTL   DS    F                                                                
PERGCTL  DS    F                                                                
CTYPCTL  DS    F                                                                
CRDBCTL  DS    F                                                                
*                                                                               
SORTRLEN DS    A                                                                
SORTKLEN DS    A                                                                
ASORTDTA DS    A                                                                
ASORTCOM DS    A                                                                
*                                                                               
PEPPARS  DS    F                                                                
APEPTAB  DS    F                                                                
PEPTABN  DS    F                                                                
         DS    3F                                                               
*                                                                               
INVPARS  DS    F                                                                
AINVTAB  DS    F                                                                
INVTABN  DS    F                                                                
         DS    3F                                                               
*                                                                               
UPEPARS  DS    F                                                                
AUPETAB  DS    F                                                                
UPETABN  DS    F                                                                
         DS    3F                                                               
*                                                                               
CLTPARS  DS    6F                                                               
*LTBMAX  EQU   5000  5000 MAXIMUM CLIENTS FOR CLIENT TABLE                      
*LTBMAX  EQU   8000  8000 MAXIMUM CLIENTS FOR CLIENT TABLE                      
CLTBMAX  EQU   15000 15000 MAXIMUM CLIENTS FOR CLIENT TABLE                     
*                     ENTRIES ARE MED(1)/CLT(3)                                 
*                                                                               
INVBKLEN DS    F                                                                
*                                                                               
SVDA     DS    XL4                SAVE DISK ADDR                                
*                                 CLEARED AT PUBF CHECKED AND SET               
*                                 IN LDESC                                      
SVAMTDUE DS    F                                                                
MEDCNT   DS    F                  MEDIA COUNT FOR MULTIMEDIA REQ                
*                                 COUNTED AT FMED, CHECKED AT                   
*                                 LJOB, CLEARED AT FJOB                         
*                           ALSO CHECKED IN PRTADJ AT PA27A8C                   
PERLIND  DS    F     USED BY EDI BILLING  - DISP INTO PERLIST                   
         DS    0F                                                               
TOTVAT   DS    F                                                                
         DS    0F                                                               
MANUALS  DS    0CL25                                                            
MANGRS   DS    F                                                                
MANNET   DS    F                                                                
MANCD    DS    F                                                                
MANAC    DS    F                NEW 4/6/89                                      
MANPCT   DS    F                                                                
MANRVNO  DS    H                                                                
MANRVDTP DS    XL3                                                              
         DS    0F                                                               
SAVBRK   DS    A                                                                
FULL2    DS    F                                                                
SAVEDA   DS    F                                                                
SAVR1    DS    F                                                                
         DS    0F                                                               
**RLIST  DS    XL105          13 X (YM, YMD-YMD) +1                             
**RLSTLQ EQU   105                                                              
*                                                                               
PERLIST  DS    (MAXMOS)XL8                                                      
PERLISTX DS    X                                                                
PERLSTLQ EQU   *-PERLIST                                                        
*                                                                               
CURPER   DS    XL2                                                              
CURSTA   DS    XL3                                                              
CUREND   DS    XL3                                                              
INVLIST  DS    XL112        14 X 8 (MONTHS X L'INV NO X 2 + 2 SPARE)            
*                                                                               
         DS    0F                                                               
DBTOTS   DS    XL12                                                             
OBTOTS   DS    XL12                                                             
*                                                                               
BCGRS    DS    F                   GROSS                                        
BCNET    DS    F                   NET                                          
BCCD     DS    F                   CD                                           
BCAC     DS    F                   AC  NEW 4/6/89                               
*                                                                               
BCTRDC   DS    F                   TRADE CREDITS                                
*                                                                               
INVNO    DS    H                                                                
PINVNO   DS    CL10                                                             
SINVNO   DS    H                                                                
SPINVNO  DS    CL10                                                             
*                                                                               
SPTSEQ   DS    H                                                                
TOTSIZH  DS    H                                                                
AGMSTANO DS    H                   STARTING INV NO.                             
AGMSKP1S DS    H                   SKIP FROM HERE                               
AGMSKP1E DS    H                          TO HERE                               
SVAGMINV DS    3H                  SAVED AGMSTANO,AGMSKP1S,AGMSKP1E             
         DS    1H                  SPARE HALF WORDS                             
*                                                                               
BRKTAB   DS    CL240               TABLE OF SORT/BREAK CONTROLS                 
*                                                                               
*                                                                               
NORMREG  DS    C                   'Y' = BILL FOR NORMAL REGISTER FOUND         
SEPREG   DS    C                   'Y' = BILL FOR SEPARATE REGISTER FND         
SREGPASS DS    XL1                 1 = NORMAL REGISTER PASS                     
*                                  2 = SECOND OUTPUT REGISTER PASS              
*                                                                               
HAVEBILL DS    C                   'Y' = WE HAVE INVOICE REGISTER DATA          
DOINVREG DS    C                   'Y' = USER WANTS INVOICE REGISTER            
OUTDDFLG DS    C                   'Y' = INVOICE REG. DATASET ALLOCATED         
*                                                                               
SVOFF    DS    CL1                                                              
SVAGMOCT DS    CL1                                                              
*                                                                               
***                                                                             
***      NOTE PROGPROF HOLDS B2 PROFILE                                         
***                                                                             
PROFB1   DS    XL16                B1 PROFILE                                   
PROGPRO2 DS    XL16                B4-7 PROFILE                                 
PROGPRO3 DS    XL16                B4-7A PROFILE                                
PROGPRO4 DS    XL16                B4-7B DETAIL BACK-UP PROFILE                 
RETPROF  DS    XL16                RETAIL PROFILE                               
PROFAOR  DS    XL16                AOR PROFILE                                  
PROFB2B  DS    XL16                B2B PROFILE                                  
PROGPROX DS    XL16                B1X PROFILE                                  
PROFB1A  DS    XL16                B1A PROFILE                                  
PROFSCC  DS    XL16                B4-7C  STANDARD CUSTOM COL                   
SAVPRD   DS    CL3                                                              
SAVPGRU  DS    CL4                                                              
SAVMGRU  DS    CL6                                                              
LASTPINV DS    CL10                                                             
*                                                                               
PPUBL1   DS    CL60                PUBLINE1  NAME AND NUMBER                    
PPUBL2   DS    CL20                PUBLINE2 ZONENAME                            
*                                                                               
JOBL1    DS    CL25                JOB LINES 1-6 SAVED                          
JOBL2    DS    CL25                                                             
JOBL3    DS    CL30                                                             
JOBL4    DS    CL30                                                             
JOBL5    DS    CL30                                                             
JOBL6    DS    CL30                                                             
*                                                                               
W        DS    CL132                                                            
*                                                                               
SAVMODE  DS    X                                                                
EFFDTE   DS    XL2                 FOR PRINT IS IN PRDFORM AND ESTFORM          
*                                                                               
AAAFORM  DS    CL37                                                             
*AAFORM2 DS    CL7                 FOR FUTURE ADDITIONAL FORMULAS               
*AAFORM3 DS    CL7                 FOR FUTURE ADDITIONAL FORMULAS               
*                                                                               
AAEFORM  DS    CL37                                                             
*AEFORM2 DS    CL7                 FOR FUTURE ADDITIONAL FORMULAS               
*AEFORM3 DS    CL7                 FOR FUTURE ADDITIONAL FORMULAS               
*                                                                               
PRDFORM  DS    CL37                BILLING FORMULA FROM PRDHDR                  
*RDFORM2 DS    CL7                 FOR FUTURE ADDITIONAL FORMULAS               
*RDFORM3 DS    CL7                 FOR FUTURE ADDITIONAL FORMULAS               
*                                  USE PBILPROF TO COVER                        
*                                                                               
ESTFORM  DS    CL37                BILLING FORMULA FROM ESTHDR                  
*STFORM2 DS    CL7                 FOR FUTURE ADDITIONAL FORMULAS               
*STFORM3 DS    CL7                 FOR FUTURE ADDITIONAL FORMULAS               
*                                  USE PBILPROF TO COVER                        
*                                  CANADIAN VAT FIELDS                          
CVATCOD  DS    0CL1                VAT CODE (OLD TAG)                           
CVATCDS  DS    CL11                NAT AND PRV VAT CODES                        
CVATSTRT DS    XL2                 YYMM - MOS FOR START FOR GST                 
CVATPSW  DS    0CL1                SWITCH FOR MIXED PRD VAT CODES               
CVATPSWS DS    CL11                NAT AND PRV SWITCH                           
CVATSW   DS    0CL1                Y= IF BILL ELLIGIBLE FOR GST                 
CVATSWS  DS    CL11                NAT AND PRV SWITCHES                         
*                                                                               
*                                  THE FIELDS BELOW SET FROM                    
*                                  NEW X'26' PST ELEMENTS                       
*                                  ON CLIENTS/PRDS                              
*                                                                               
NVATCOD  DS    0CL1                VAT CODE                                     
NVATCDS  DS    CL11                NAT AND PRV VAT CODES                        
NVATPSW  DS    0CL1                SWITCH FOR MIXED PRD VAT CODES               
NVATPSWS DS    CL11                NAT AND PRV SWITCH                           
NVATSW   DS    0CL1                Y= IF BILL ELLIGIBLE FOR GST                 
NVATSWS  DS    CL11                NAT AND PRV SWITCHES                         
*                                                                               
*                                                                               
ELEM     DS    CL30                                                             
*                                                                               
SVPPSTS  DS    XL(NPROVS)                                                       
*                                                                               
OUTMODE  DS    CL1                 EDI BILLING MODE                             
PSHPDTE  DS    CL8                 PRINTING SHIP DATE                           
FMULTMED DS    CL1                 1ST MED FOR MULTI-MED REQ                    
PUMODE   DS    CL1                 CONTROL FOR PRTUSER                          
CAROPT   DS    CL1                 'Y' FOR COST 2                               
CAROPTC  DS    CL1                 'Y' FOR COST 2 (FROM CLIENT HDR)             
MYMEDNM  DS    CL11                MEDIA NANE FOR PRINTING                      
*                                                                               
FXROPT   DS    CL1                 IF Y DON'T DISPLAY FX RATE                   
*                                                                               
SRCHSW   DS    CL1                 Y MEANS AGENCY MEDIA NAME                    
*                                  MEDIA S IS SEARCH                            
*                                                                               
PGSW     DS    CL1                 GETS SET TO Y IN CFIRST                      
*                                  FOR P&G PROCESSING                           
WMSW     DS    CL1                 GETS SET TO Y IN CFIRST                      
*                                  FOR WALMART PROCESSING                       
MSSW     DS    CL1                 GETS SET TO Y IN CFIRST                      
*                                  TO GET EST USER FLDS TO                      
*                                  PRINT IN FEST                                
FOXSW    DS    CL1                 GETS SET TO Y IN CFIRST                      
*                                  FOR FOX PROCESSING                           
*                                  1ST PRD AND 1ST EST USER                     
*                                  DATA WITH PRODUCT NAME                       
PUSRSW   DS    CL1                 GETS SET TO Y IN CFIRST                      
*                                  PRD USER DATA WITH PRD NAME                  
*                                  WHEN PRDS TOGETHER                           
*                                  AT LEAST ONE USER FIELDS SET TO 'F'          
*                                  AND THE OTHER (IF ONE SET TO 'F')            
*                                  NOT DEFINED OR NOT TO SHOW ON BILL           
AORNOPT  DS    C                                                                
MIDASSW  DS    C                                                                
OUWBSW   DS    C                   'Y' = SPECIAL FOR OMDTOA (OU)                
*                                        WB CLIENTS - SHOWS PRD                 
*                                        USER1 IN HEADLINES                     
*                                                                               
UCOMMSW  DS    CL1                 'Y' = EST UCOMM REQUIRED                     
UDEFESW  DS    XL1                 X'00' - NO EST UDEF CONTROL                  
*                                  X'01' - 1ST EST UDEF REQUIRED                
*                                  X'02' - 2ND EST UDEF REQUIRED                
ATTSW    DS    C                   AT&T OPTION 5 EST UCOMMS                     
*                                  SET UCO8EST IN UCOPT                         
**WB**                                                                          
WBSW     DS    C                   WB FLIGHT PROCESSING                         
SVWBSW   DS    C                   SAVED ORIGINAL VALUE                         
**WB**                                                                          
H7ATTSW  DS    C                   IF Y PACKED FOR BIG AMOUNTS                  
*                                  AFFECTS ONLY PRINTING THE BILL               
*                     **NOTE**     WON'T WORK FOR BILLING FORMULAS              
*                                  WITH AN ADJUSTMENT                           
*                                                                               
ACCSYSOV DS    XL1                 ACC SYS OVERRIDE (FROM B9A PROF)             
WIOPT    DS    CL1                 WESTERN OPTION (SUPRESS $)                   
MRDASS   DS    CL1                 SPECIAL REG/DST SCHEME SWITCH                
*                                                                               
NOZEOPT  DS    CL1                 FROM B2 PROFILE (PROGPRO2+15)                
RD1OPT   DS    CL1                 REQUEST OPTION RO9 (CARD 2)                  
*                                  RETAIL BILLING OPT (E -ERROR ONLY)           
CURSW    DS    CL1                 CURRENT MONTH SWITCH                         
MOLSON   DS    CL1                 SPECIAL FOR BACKER - ZENIETH                 
WPPOPT   DS    CL1                 WPP AGENCY COMMENT OPTION                    
INV#ERR  DS    C                   Y=INVOICE OVER 9999                          
*                                                                               
KPRD     DS    CL3                                                              
KPUB     DS    XL6                                                              
FFS      DS    XL6'FF'                                                          
BILTRACE DS    C                                                                
SORTTRCE DS    C                                                                
TESTFLAG DS    C                                                                
SAVTRACE DS    C                                                                
FMTSW    DS    CL1                 D = INSERTION DETAILS                        
PUBSW    DS    CL1                 0 = PROCESS THIS PUB   1 = DON'T             
*                                                                               
LASTPRD  DS    CL3                                                              
PCTCTL   DS    C                                                                
DONESW   DS    C                                                                
OPENSW   DS    C                                                                
FINANSW  DS    C                                                                
ACTSW    DS    C                                                                
DUESW    DS    C                                                                
BILSW    DS    C                                                                
LSTOPT   DS    C                                                                
SHOWREV  DS    C               Y IF INCLUDING REVERSED AND REVERSALS            
JOBOPT   DS    C                   SET TO N,1,2,A,B                             
ZEROSW   DS    C                                                                
ZBOPT    DS    C                                                                
PRSW     DS    C                                                                
ADJSEP   DS    C                   Y=ADJSEPERATE                                
CDSEP    DS    C                   Y=CD SEPERATE                                
CNMTCD   DS    C                   COMMENT CODE FOR PRTCMNT                     
BOXNO    DS    C                                                                
PAYOPT   DS    C                                                                
PARTIAL  DS    C                                                                
PRIOR    DS    C                                                                
BYTE2    DS    X                                                                
PUDEFON  EQU   X'80'                                                            
EUDEFON  EQU   X'40'                                                            
PASSNO   DS    X                                                                
PGRQ     DS    C                                                                
PRDQ     DS    C                                                                
ESTQ     DS    C                                                                
MGRQ     DS    C                                                                
MKTQ     DS    C                                                                
ERR      DS    X                                                                
ERRPROF  DS    CL5    MAY CONTAIN PROFILE AND FIELD IF ERR=PROFERR              
*                     SHOULD HELP IN TRACKING DOWN INVALID BILLING              
*                     PROFILE ERRORS                                            
PERDISP  DS    X                                                                
GNSW     DS    C                                                                
COLMNS   DS    C                                                                
BFORMAT  DS    CL6                 FOR BILL                                     
*               GROSS,NET,CD,G-CD,N-CD,AC                                       
*               Y=SHOW                                                          
BSTRIP   DS    CL1                 G,N,C,1=G-CD,2=N-CD                          
BORDSW   DS    CL1                 Y=SHOW ORDERED                               
BPBILSW  DS    CL1                 Y= SHOW PREV BILLED                          
BBILLSW  DS    CL1                 Y=SHOW BILLABLE                              
BDOLNUM  DS    CL1                 NUMBER OF CATS                               
BTYPNUM  DS    CL1                 NUMBER OF TYPES                              
DFORMAT  DS    CL6                 FOR DETAIL BACK-UP                           
DSTRIP   DS    CL1                                                              
DORDSW   DS    CL1                                                              
DPBILSW  DS    CL1                                                              
DBILLSW  DS    CL1                                                              
DDOLNUM  DS    CL1                 NUMBER OF CATS                               
DTYPNUM  DS    CL1                 NUMBER OF TYPES                              
FORMAT   DS    CL6                 USED IN FMTAMT AND BILHEAD                   
STRIP    DS    CL1                                                              
ORDSW    DS    CL1                                                              
PBILSW   DS    CL1                                                              
BILLSW   DS    CL1                                                              
DOLNUM   DS    CL1                 NUMBER OF CATS                               
TYPNUM   DS    CL1                 NUMBER OF TYPES                              
*                                                                               
HFORMAT  DS    CL6                                                              
HTYPES   DS    CL3                                                              
*                                                                               
TOTSTAR  DS    CL2                                                              
TOTNAME  DS    CL12                                                             
PINVDTE  DS    CL10                                                             
EINVDTE  DS    CL6                                                              
BINVDTE  DS    XL3                                                              
BINVDTEP DS    XL2                                                              
*                                                                               
PDUEDTE  DS    CL10                                                             
EDUEDTE  DS    CL6                                                              
BDUEDTE  DS    XL3                                                              
BDUEDTEP DS    XL2                                                              
*                                                                               
NEWSTART DS    XL2                                                              
SPOTSW   DS    XL1                                                              
*                                                                               
NONRET   DS    C                                                                
RETDRAFT DS    C                                                                
*                                                                               
SPOTCTL  DS    XL1                                                              
PROGSW   DS    C                                                                
CLMCTLS  DS    XL3                                                              
ESTNAM2  DS    CL20                SAVED SECOND EST NAME                        
ESTREV   DS    CL3                 SAVED EST REV NUMBER                         
CLTSW    DS    CL1                 IF 'N' IGNORE THIS CLIENT                    
EXDATE   DS    XL3                                                              
VATPSW   DS    CL1                                                              
BTDUET   DS    CL1      SET TO Y WHEN BEFORE CANADIAN TAX AMT DUE               
*                       IS TRANSMITTED (EDI)                                    
COMMSW   DS    C                                                                
ZLOPT    DS    C                                                                
ZLSW     DS    C                                                                
UPASS    DS    X                                                                
         DS    0F                                                               
RETERR   DS    X                                                                
RETSKIP  DS    CL1                                                              
SUMOPT   DS    CL1                                                              
INVSKIP  DS    CL1                                                              
*                                                                               
SVPACCT  DS    XL4                                                              
*                                                                               
SVFINSW  DS    CL1        USES TO SAVE FINANSW                                  
FININVSW DS    CL1        USED AT ENDINV                                        
*                                                                               
BFROPT   DS    CL1        'Y' IF USING BILLING FORMULA RECORDS                  
BFRMOS   DS    CL1        'Y' IF BILLING FORMULA RECORDS ARE BY MOS             
*                                                                               
PRDMKT   DS    X                                                                
TWOCOL   DS    X                                                                
MIXSW    DS    CL1         Y MEANS AOR BILL WITH A MIXTURE OF                   
*                          MOS BEFORE AND AFTER JUL/10 FOUND                    
LASTMOS  DS    XL2                                                              
*                                                                               
SUMLEV   DS    X                                                                
PRDSKIP  DS    X                                                                
CORPZ    DS    X                                                                
CRFORMSW DS    C                                                                
WPRD     DS    CL3                                                              
WPRDSQ   DS    CL3                                                              
ZEROLSW  DS    X                                                                
LVACTSWS DS    0CL6                                                             
PUBACTSW DS    CL1                                                              
JOBACTSW DS    CL1                                                              
SVREGLEN DS    CL1                                                              
SVDSTLEN DS    CL1                                                              
SETDSW   DS    CL1     SET TO 'Y' WHEN SETTING DATES ON MULTI-MED REQ           
BTABSW   DS    CL1     SET TO 'Y' WHEN BUILDING BRKTAB ON M-MED REQ             
*                                                                               
CLTRDSW  DS    CL1     SET TO 'Y' IF REQUEST READS A CLIENT                     
*                      AT REQLAST IF STILL 'N' CLEAR QSAVE                      
*                      UNLESS MULTI-MEDIA REQUEST                               
FREEOPT  DS    CL1                 FROM B2 PROFILE (+6)                         
*                                  Y= BILL FREE BUYS WHOSE INS DATE             
*                                  IS NOT BEFORE AUG01/92                       
*                                  C= DON'T SHOW ZERO COST2 INS.                
SCBOPT   DS    CL1                 FROM B2B PROFILE                             
SCBNCSW  DS    CL1                 FROM QOPT6                                   
ZUOPT    DS    C                                                                
*                                                                               
SVAORS   DS    0CL45                                                            
SVAORACT DS    CL14     AOR RCVBL/PAYABLE ACCOUNT                               
SVAORPCT DS    XL4      AOR PCT. FOR CALCULATIONS                               
SVAORBAS DS    CL1      AOR BASIS X'00' = GROSS, X'01' = AC                     
SVAOREFF DS    XL2      AOR EFFECTIVE DATE                                      
SVAORDA  DS    XL4      AOR RECORD DISK ADDRESS                                 
SVAORVCD DS    0CL1     AOR VAT CODE (OLD TAG)                                  
SVAORVCS DS    CL11     AOR NAT AND PRV VAT CODES                               
SVAORKIL DS    XL2      AOR KILL DATE                                           
SVAORMVP DS    XL1      AOR MAIN PST PROVINCE #                                 
SVAORMVC DS    CL1      AOR MAIN PST CODE                                       
         DS    XL05     AOR SPARE                                               
*                                                                               
SVTODAYB DS    XL3                                                              
SVINVMO  DS    CL2              'MONTH' PORTION OF INVOICE #                    
SVSVIMO  DS    CL2                                                              
SVINVMED DS    CL2              MEDIA CHARACTERS OF INVOICE #                   
*                                                                               
OSDOPT   DS    C                   SHOW ON-SALE DATE                            
JOBQ     DS    C                  =C'1' IF REQ FOR ONE JOB                      
PEOVOPT  DS    C         'Y' = USE PRD/EST COLUMNS OVERRIDE (CHAB)              
NOPMBRK  DS    C         'Y' = DON'T BREAKOUT PRIOR MTHS IN TOUTOUT             
NOINSSW  DS    C         'Y' = DON'T SHOW INS DETAIL ON MAIN BILL               
AGMINBY  DS    X               FROM PB01X PROFILE+4                             
*                              BINARY YEAR TO START INV MONTH                   
*                              DISPLAY FROM                                     
         SPACE 3                                                                
AGMCLNO  DS    C                   PRINT CLIENT INTERFACE NO.                   
AGMSTADT DS    XL2                 START MOS FOR NEW BILLING                    
AGMEXP   DS    CL2                 MEDIA EXPANSION FOR INV. NO.                 
AGMFMT   DS    CL1                 FMT (1=EX-MM-NNNN, 2=MM-EX-NNNN)             
AGMSEQ   DS    CL1                 A=AGY, M=MED, C=CLT                          
AGMCLOPT DS    C                                                                
AGMFORMS DS    C                                                                
AGMMTH   DS    C                                                                
AGMTITL  DS    C                                                                
AGMSCOM  DS    C         SKIP PBUYREC COMMENTS STARTING WITH THIS               
AGMOCTL  DS    C                                                                
MOSOPT   DS    C                                                                
*                                                                               
TOTSW    DS    C                                                                
UPDTSOON DS    C        'Y' WHEN DOING UPDATIVE SOON                            
*                                                                               
SORTREC  DS    CL187         WAS 162                                            
SORTKEY  EQU   SORTREC                                                          
THISREC  DS    CL187                                                            
THISKEY  EQU   THISREC                                                          
OLDREC   DS    CL187                                                            
OLDKEY   EQU   OLDREC                                                           
*                                                                               
*  BIGTOTS USED IN PFMTAMT                                                      
*                                                                               
BIGTOTS  DS    12PL6         ORD - GRS/NET/CD/AC/TAX/INS                        
*                            BILLED - GRS/NET/CD/AC/TAX/INS                     
*                                                                               
BIGTOTST DS    12PL6         ORD - GRS/NET/CD/AC/TAX/INS                        
*                            BILLED - GRS/NET/CD/AC/TAX/INS                     
*                                                                               
*                                                                               
ADIDLQ   EQU   12            LENGTH OF AD ID                                    
JOBDSP   EQU   15            DISPLACEMENT TO JOB IN AJOB                        
ADIDDSP  EQU   3             DISPLACEMENT TO AD ID IN AJOB                      
ADIDDSP2 EQU   21            DISPLACEMENT TO AD ID2 IN AJOB                     
*                                                                               
PREVSW   DS    C                                                                
AORSW    DS    C                                                                
AORLOPT  DS    C                                                                
AORTXOPT DS    C                                                                
AORLCTL  DS    C                                                                
AORFRST  DS    C                                                                
*                                                                               
TYPE     DS    C                                                                
DATEOPT  DS    C        SET FROM B8 PROFILE - CENTURY                           
DOLSOPT  DS    C        SET FROM B8 PROFILE - $ BEFORE AMOUNT DUE               
BILLADR  DS    C        SET FROM B8 PROFILE 3 READ BILL ADDRESS REC             
*OSTAR   DS    C        SET FROM B8 PROFILE 4 NO ** BY TOTALS                   
*HOWRATE DS    C        SET FROM B8 PROFILE                                     
EPUDEF   DS    C        SET FROM B8 PROFILE                                     
*                                                                               
FLAG1    DS    C                                                                
BADDRSW  EQU   X'80'    BRAND BILL ADDRESS RECORD FOUND                         
AADDRSW  EQU   X'40'    AAA BILL ADDRESS RECORD FOUND                           
SHOWRATE EQU   X'20'    SET FROM B8 PROFILE                                     
NOSTAR   EQU   X'10'    SET FROM B8 PROFILE 4 NO ** BY TOTALS                   
PARENTH  EQU   X'08'    SHOW CREDIT AMT IN PARENTHESIS                          
NOBILPRD EQU   X'04'    DON'T BILL THIS PRODUCT                                 
SHOWMVEN EQU   X'02'    SHOW VENDOR ON MIDAS BILLS                              
*                                                                               
PO#OPT   DS    C      **WILL BE SET FROM CLIENT HDR**   N,Y                     
PO#TYPE  DS    C      **WILL BE SET FROM CLIENT HDR**   C,P,E                   
PO#ANNO  DS    CL12   **WILL BE SET FROM CLIENT HDR**                           
PO#EFFD  DS    XL2      EFFECTIVE MOS FOR BILLING BY PO#                        
MIXEDPO# DS    C        SET TO Y IF MIXED PO# IN BUY                            
*                                                                               
ORIGTYPE DS    C                                                                
XXPUB    DS    XL6                                                              
ESTWBFLT DS    CL10                                                             
SVMANFLT DS    CL10                                                             
SVMANPO# DS    XL2           MANUAL BILL'S PO#                                  
SVCURPO# DS    XL2           SAVE BUY'S CURRENT PO#                             
*                                                                               
NMOS     DS    X                                                                
NDUES    DS    X                                                                
SVSTAP   DS    XL2                                                              
SVENDP   DS    XL2                                                              
SAVSTRT  DS    CL6                                                              
SAVEND   DS    CL6                                                              
DOCOPT   DS    CL1           DOCUMENT/INVOICE OPTION                            
*                                                                               
MGRBKTS  DS    C                                                                
THISPER  DS    XL2                                                              
SVMKTCTL DS    X                                                                
TAXSW    DS    X                                                                
TAXOPT   DS    X                                                                
PCTNET   DS    X                                                                
SVFORMAT DS    CL6      SAVED AT FPRD RESTORED AT LPRD                          
SVSTRIP  DS    CL1                                                              
SVDOLN   DS    X                                                                
SV2COL   DS    CL1                                                              
*                                                                               
SVPFORMT DS    CL6       SAVED AT FEST RESTORED AT LEST                         
SVPSTRIP DS    CL1                                                              
SVPDOLN  DS    X                                                                
SVP2COL  DS    CL1                                                              
*                                                                               
QSAVE    DS    CL10                                                             
KEY1     DS    CL32                                                             
         SPACE 2                                                                
INRSQYM  DS    XL2                 IGNORE INVOICES BEFORE THIS YEAR/MTH         
INRSQDA  DS    CL2                 DAY - FOR INVOICE SEQUENCING                 
*                                  THE ABOVE ARE THE FIRST 4 BYTES OF           
*                                  PB01X PROFILE                                
SQEND    DS    CL6                 QEND SAVE AT REQFRST                         
         DS    0F                                                               
WK       DS    XL(ROWTL)           WORK AREA - LENGTH OF ROWTL                  
*                                                                               
X        DS    XL132   (WAS 150)                                                
         DS    0F                                                               
*                                                                               
ECTAXD   DS    0CL40   CANADAIN TAX DATA                                        
ECTAXT   DS    CL7     CANADIAN EDI TAX TYPE                                    
ECTAXA   DS    CL16    ACCOUNT NUMBER                                           
         DS    CL1     FOR ALIGNMENT                                            
ECTAXP   DS    F       TAX %                                                    
ECTAXB   DS    F       TAX BASIS                                                
ECTAX    DS    F       TAX AMOUNT                                               
ECTOTD   DS    F       TOTAL DUE (INCLUDING TAXES)                              
*                                                                               
         DS    0F                  ALIGNMENT                                    
WKROW    DS    XL(ROWL)                                                         
*                                                                               
****NO MORE SPARE BYTES, OVER 4K BY 17 AS OF 3/16/01                            
****LWSPARE  EQU   BILWRKD+4095-*                                               
****WSPARE   DS    XL(LWSPARE)                                                  
*                                                                               
         SPACE 2                                                                
*        DSECT FOR SORT CONTROL TABLE                                           
         SPACE 2                                                                
BRKTABD  DSECT                                                                  
BRKCODE  DS    F                   CODE                                         
BRKDISP  DS    F                   DISP INTO KEY                                
BRKLENM1 DS    F                   CUMULATIVE LENGTH - 1                        
BRKCTL1  DS    X                                                                
BRKCTL2  DS    X                                                                
BRKCTL3  DS    X                                                                
BRKCTL4  DS    X                                                                
BRKCTL5  DS    X                                                                
BRKCTL6  DS    X                                                                
BRKCTL7  DS    X                                                                
BRKCTL8  DS    X                                                                
*                                                                               
BRKINV   EQU   BRKCTL1                                                          
BRKL     EQU   *-BRKTABD                                                        
         SPACE 3                                                                
*                                  DSECT FOR AMOUNT LINE                        
ALINED   DSECT                                                                  
ALINE    DS    0CL132                                                           
ALDESC   DS    CL20                                                             
         DS    CL1                                                              
ALCOL1   DS    CL16                                                             
ALCOL2   DS    CL16                                                             
ALCOL3   DS    CL16                                                             
ALCOL4   DS    CL16                                                             
         DS    CL2                                                              
ALCOL4X  EQU   *                                                                
ALSTRIP  DS    CL16                                                             
         DS    CL29                                                             
         SPACE 3                                                                
ILINED   DSECT                     DSECT FOR INV REG LINE                       
ILINE    DS    0CL132                                                           
ILINV    DS    CL4                                                              
         DS    CL1                                                              
ILPRD    DS    CL3                                                              
         DS    CL1                                                              
ILEST    DS    CL3                                                              
         DS    CL1                                                              
ILPER    DS    CL5                                                              
         DS    CL1                                                              
ILTYPE   DS    CL2                                                              
ILCOL1   DS    CL16                                                             
ILCOL2   DS    CL16                                                             
ILCOL3   DS    CL16                                                             
ILCOL4   DS    CL16                                                             
         DS    CL2                                                              
ILSTRIP  DS    CL16                                                             
         DS    CL29                                                             
         SPACE 3                                                                
INVLD    DSECT                     DSECT FOR INVOICE TABLE                      
INVLMED  DS    XL1                                                              
INVLINV  DS    XL4                 Y/M AND INV NUMBER                           
INVLPGR  DS    XL3                 PGROUP - DIVISION                            
INVLPRD  DS    XL3                 PRD IS 3 BYTES FOR PRINT                     
INVLEST  DS    XL2                 EST IS 2 BYTES FOR PRINT                     
INVLMGR  DS    XL6                 MGR - REG/DST                                
INVLMKT  DS    XL20                                                             
INVLJOB  DS    XL6                                                              
INVLPUB  DS    XL6                                                              
INVLPER  DS    XL2                                                              
INVLPERG DS    XL1                 PERIOD GROUP                                 
INVLCRDB DS    XL1                 CREDIT/DEBIT BREAKOUT                        
INVTABKL EQU   *-INVLD                                                          
         DS    0F                  TO INSURE ALIGNMENT                          
INVLGRS  DS    XL4                                                              
INVLNET  DS    XL4                                                              
INVLCD   DS    XL4                                                              
INVLAC   DS    XL4                                                              
INVLDUE  DS    XL4              NON-TOTALLED AMOUNT DUE                         
*                               OF PRIOR INVOICES                               
INVTABRL EQU   *-INVLD                                                          
         SPACE 3                                                                
*                                                                               
UPED     DSECT                     DSECT FOR UNPAID EST TABLE (UPETAB)          
*                                  NOW ALSO USED FOR PLANNED COST INFO          
UPEPRD   DS    XL3                                                              
UPEEST   DS    XL2                                                              
UPETABKL EQU   *-UPED                                                           
UPESTAT  DS    XL1                 X'01'= UNPAID, X'02' = PLANNED COST          
UPEPEDT  DS    XL2                 IF PLANNED COST - EFFECTIVE INS YM           
UPEPADT  DS    XL2                 IF PLANNED COST - ACTUALZAION YM             
UPETABRL EQU   *-UPED                                                           
*                                  DSECT FOR FORMULA INFO                       
BFORMD   DSECT                                                                  
BFBASA   DS    X                                                                
BFBASB   DS    X                                                                
*                                                                               
BFCOMP   DS    XL3                                                              
BFCOMSW  DS    X                   X'80'=COMM ONLY BILL                         
BFRETSHR DS    XL3                                                              
BFTAXMIX DS    XL1                                                              
BFAORPCT DS    XL3                 WAS SPARE                                    
BFVATCOD DS    0XL1                VAT CODE (OLD TAG)                           
BFVATCDS DS    XL11                NAT AND PRV VAT CODES                        
BFVATSW  DS    0XL1                VAT SWITCH (OLD TAG)                         
BFVATSWS DS    XL11                NAT AND PRV VAT SWITCHES                     
BFPBASB  DS    X                   BASB FOR PRINTING ON BILL                    
BFPCOMP  DS    XL3                 COMP FOR PRINTING ON BILL                    
BFORML   EQU   *-BFORMD                                                         
         SPACE 2                                                                
*                                                                               
MEDEQ    EQU   X'04'                                                            
PGR1EQ   EQU   X'08'                                                            
PGR2EQ   EQU   X'0C'                                                            
PGR3EQ   EQU   X'10'                                                            
PRDEQ    EQU   X'14'                                                            
ESTEQ    EQU   X'18'                                                            
MGR1EQ   EQU   X'1C'                                                            
MGR2EQ   EQU   X'20'                                                            
MGR3EQ   EQU   X'24'                                                            
MKTEQ    EQU   X'28'                                                            
JOBEQ    EQU   X'2C'                                                            
PUBEQ    EQU   X'30'                                                            
DESCEQ   EQU   X'34'                                                            
PEREQ    EQU   X'38'                                                            
PERGEQ   EQU   X'3C'                                                            
CRBDEQ   EQU   X'40'           CREDIT/DEBIT BREAKOUT                            
*                                                                               
MAXMOS   EQU   25     CHANGE TO THIS ALSO AFFECTS FINDOUTP                      
*                     AND PFOLINKD                                              
*                                                                               
*     ACCUMLATOR      ORDERED      GRS,NET,CD,AC,TAX,INS                        
*     LAYOUT          BILLED       GRS,NET,CD,AC,TAX,INS                        
*                     OPEN ORDERD  GRS,NET,CD,AC,TAX,INS                        
*                     OPEN BILLED  GRS,NET,CD,AC,TAX,INS                        
*                     OPEN ADJUSTMENT AND DUE AMOUNT                            
*                     ADJUSTMENT AND DUE AMOUNT                                 
*                     TAX                                                       
*                     AOR AMOUNT AND BASIS AMOUNT                               
*                     DUE X RETAIL SHR                                          
*                     GROSS X RETAIL SHARE                                      
*                     NET X RETAIL SHARE                                        
*                     CD X RETAIL SHARE                                         
*                     AC X RETAIL SHARE                                         
*                     VAT X RETAIL SHARE (44 BYTES)                             
*                     TAX X RETAIL SHARE                                        
*                     RETAIL SHARE PCT                                          
*                                                                               
*                                                                               
*                     VATS- MAIN BILL (44 BYTES)                                
*                     VATS - COMM ADJ BILL (44 BYTES)                           
*                     VATS - AOR BILL (44 BYTES)                                
*                     VATS - CD SEPERATE BILL (44 BYTES)                        
*                                                                               
*                     VAT BASIS - MAIN BILL (44 BYTES)                          
*                     VAT BASIS - RETAIL BILL (44 BYTES)                        
*                     VAT BASIS - ADJ BILL (44 BYTES)                           
*                     VAT BASIS - CD BILL (44 BYTES)                            
*                                                                               
*                     CONTROL WORD                                              
*                                                                               
*                     DSECT FOR ACCUMULATORS                                    
*                                                                               
ACMD     DSECT                                                                  
ACMORD   DS    XL24         ORDERED GRS,NET,CD,AC,TAX,INS                       
ACMBIL   DS    XL24          BILLED GRS,NET,CD,AC,TAX,INS                       
ACMOORD  DS    XL24            OPEN GRS,NET,CD,AC,TAX,INS                       
ACMOBIL  DS    XL24     OPEN BILLED GRS,NET,CD,AC,TAX,INS                       
*                                                                               
ACMEXT   DS    0X            EXTRAS                                             
ACMOADJ  DS    XL4            OPEN ADJUSTMENT                                   
ACMODUE  DS    XL4            OPEN DUE                                          
ACMADJ   DS    XL4            ADJUSTMENT                                        
ACMDUE   DS    XL4            DUE                                               
ACMTAX   DS    XL4            TAX                                               
ACMAOR   DS    XL4            AOR AMOUNT                                        
ACMAORB  DS    XL4            AOR BASIS AMOUNT                                  
ACMEXTBL EQU   *-ACMEXT       LENGTH OF BASIC EXTRAS                            
*                                                                               
ACMRETA  DS    XL4            RETAIL ACTUAL X SHARE                             
ACMRETG  DS    XL4            RETAIL GROSS                                      
ACMRETN  DS    XL4            RETAIL NET                                        
ACMRETC  DS    XL4            RETAIL CD                                         
ACMRETAC DS    XL4            RETAIL AC                                         
ACMRETVS DS    XL44           RETAIL VATS                                       
ACMRETT  DS    XL4            RETAIL TAX                                        
ACMRETP  DS    XL4            RETAIL SHARE PCT                                  
*                                                                               
ACMVATS  DS    XL44           VATS MAIN BILL                                    
ACMVATCS DS    XL44           VATS COMM ADJ BILL                                
ACMVATAS DS    XL44           VATS AOR BILL                                     
ACMVATDS DS    XL44           VATS CD BILL                                      
ACMVTBS  DS    XL44           VAT BASIS MAIN BILL                               
ACMVTRBS DS    XL44           VAT BASIS RETAIL BILL                             
ACMVTCBS DS    XL44           VAT BASIS COMM ADJ BILL                           
ACMVTDBS DS    XL44           VAT BASIS CD BILL                                 
*                                                                               
         DS    XL8             SPARE                                            
ACMEXTL  EQU   *-ACMEXT        LENGTH OF ALL EXTRAS                             
ACMDL    EQU   *-ACMD          LENGTH OF TOTAL ACCUMULATOR                      
*                                                                               
ROWL     EQU   ACMDL                                                            
ROWTL    EQU   L'ACMORD+L'ACMBIL                                                
ROWHL    EQU   ROWTL/2                                                          
*                                                                               
ROW2L    EQU   ROWTL*2                                                          
*                                                                               
MAXLEVS  EQU   16                                                               
*                                                                               
*                                 ACCUMULATOR DISPLACEMENT EQUATES              
RGRSD    EQU   0                  GROSS ORDERED                                 
RNETD    EQU   4                  NET ORDERED                                   
RCDD     EQU   8                  CD ORDERED                                    
RACD     EQU   12                 AC ORDERED                                    
RTAXD    EQU   16                 TAX ORDERED                                   
RINSD    EQU   20                 INS ORDERED                                   
*                                                                               
RBGRSD   EQU   24                  GROSS BILLED                                 
RBNETD   EQU   28                  NET BILLED                                   
RBCDD    EQU   32                  CD BILLED                                    
RBACD    EQU   36                  AC BILLED                                    
RBTAXD   EQU   40                  TAX BILLED                                   
RBINSD   EQU   44                  INS BILLED                                   
*                                                                               
EXTDSP   EQU   ACMEXT-ACMD         START OF EXTRAS                              
OADJDSP  EQU   ACMOADJ-ACMD                                                     
ODUEDSP  EQU   ACMODUE-ACMD                                                     
ADJDSP   EQU   ACMADJ-ACMD                                                      
DUEDSP   EQU   ACMDUE-ACMD                                                      
TAXDSP   EQU   ACMTAX-ACMD                                                      
AORDSP   EQU   ACMAOR-ACMD         AOR AMOUNT                                   
AORBDSP  EQU   ACMAORB-ACMD        AOR BASIS AMOUNT                             
RETADSP  EQU   ACMRETA-ACMD        RETAIL ACTUAL SHARE                          
RETGDSP  EQU   ACMRETG-ACMD        REATIL GROSS SHARE                           
RETNDSP  EQU   ACMRETN-ACMD        RETAIL NET SHARE                             
RETCDSP  EQU   ACMRETC-ACMD       RETAIL CD SHARE                               
RETACDSP EQU   ACMRETAC-ACMD      RETAIL AC SHARE                               
RETVDSP  EQU   ACMRETVS-ACMD      RETAIL VAT SHARE  (44 BYTES)                  
RETTDSP  EQU   ACMRETT-ACMD       RETAIL TAX SHARE                              
RETPDSP  EQU   ACMRETP-ACMD       RETAIL SHARE PCT                              
*                                                                               
VATDSP   EQU   ACMVATS-ACMD        VATS MAIN BILL                               
VATCDSP  EQU   ACMVATCS-ACMD       VATS ADJ BILL                                
VATADSP  EQU   ACMVATAS-ACMD       VATS AOR BILL                                
VATDDSP  EQU   ACMVATDS-ACMD       VATS CD BILL                                 
*                                                                               
VATBDSP  EQU   ACMVTBS-ACMD        VAT BASIS MAIN BILL                          
VATRBDSP EQU   ACMVTRBS-ACMD       VAT BASIS RETAIL BILL                        
VATCBDSP EQU   ACMVTCBS-ACMD       VAT BASIS ADJ BILL                           
VATDBDSP EQU   ACMVTDBS-ACMD       VAT BASIS CD BILL                            
*****                                                                           
*                                  NOTE - MONTHLY TOTALS ARE FOLLOWED           
*                                  BY AN AREA FOR FORMULA INFO                  
*                                  SEE BFORMD FOR DSECT                         
TOTSIZE  EQU   (MAXMOS+1)*ROWL+BFORML                                           
VTOTSIZE EQU   (MAXMOS+1)*VBTABL*(NPROVS+1)                                     
*                                                                               
*        DISPLACEMENTS INTO SORTDATA (IN SORTREC)                               
*                                                                               
GDSP     EQU   0           ORDERED GROSS                                        
NDSP     EQU   4                   NET                                          
CDSP     EQU   8                   CD                                           
ADSP     EQU   12                  AC                                           
TDSP     EQU   16                  TAX                                          
IDSP     EQU   20                  INS                                          
*                                                                               
BGDSP    EQU   24          PREV. BILLED GROSS                                   
BNDSP    EQU   28                       NET                                     
BCDSP    EQU   32                       CD                                      
BADSP    EQU   36                       AC                                      
BTDSP    EQU   40                       TAX                                     
BIDSP    EQU   44                       INS                                     
*                                                                               
OGDSP    EQU   48          OPEN ORDERED GROSS                                   
ONDSP    EQU   52                       NET                                     
OCDSP    EQU   56                       CD                                      
OADSP    EQU   60                       AC                                      
OTDSP    EQU   64                       TAX                                     
OTRDC    EQU   68                   WAS INS NOW TRADE CREDIT                    
*                                                                               
OBGDSP   EQU   72          OPEN PREV. BILLED GROSS                              
OBNDSP   EQU   76                            NET                                
OBCDSP   EQU   80                            CD                                 
OBADSP   EQU   84                            AC                                 
OBTDSP   EQU   88                            TAX                                
OBTRDC   EQU   92                    WAS INS NOW TRADE CREDIT                   
*                                                                               
PEPTBN   EQU   500                                                              
INVTBN   EQU   4000                                                             
UPETBN   EQU   20000                                                            
LINTABN  EQU   300                                                              
NPROVS   EQU   10                                                               
ADDRLEN  EQU   306                                                              
*OADDRLEN EQU   180                                                             
         SPACE 2                                                                
*                                                                               
*        PEPTAB            KEY(9),GRS,NET,CD,AC,ADJ,DUE                         
*                                 OGRS,ONET,OCD,OAC,OADJ,ODUE                   
*                                 TAX,AOR,AOR BASIS AMT                         
*                                 RET SHR(A,G,N,CD,AC,TAX,GST                   
*                                 VAT (MAIN,COMM,CD,AOR)                        
*                          PRD ACCT,STATUS,SPARE(2),BILL FORMULA(5)             
*                          JOB CODE(6),SPARE(3)                                 
*                          AOR RCVBL/PAYABLE ACCNT (14)                         
*                          AOR PCT  (4)                                         
*                          AOR BASE (1)                                         
*                          AOR REC DISK ADDR (4)                                
*                          AOR INVOICE NUMBER (2)                               
*                                                                               
*                          VAT CODE (1)                                         
*                          VAT SW   (1)                                         
*        DSECT FOR PEPTAB                                                       
*                                                                               
*                                                                               
PEPTD    DSECT                                                                  
PEPTKEY  DS    0XL12               'KEY'                                        
PEPTMED  DS    CL1                 MEDIA (ONLY PRESENT FOR MULTI-MEDIA)         
PEPTFIN  DS    CL1                 FINANCIAL IND (FINANSW)                      
PEPTPRD  DS    CL3                 PRODUCT                                      
PEPTEST  DS    XL2                 ESTIMATE                                     
PEPTMOS  DS    XL2                 MOS                                          
*                                                                               
         DS    0F                  NOW 3 SPARE (FOR ALIGNMENT)                  
PEPTKEYL EQU   *-PEPTD                                                          
*                                                                               
PEPTGRS  DS    XL4                 GROSS                                        
PEPTNET  DS    XL4                 NET                                          
PEPTCD   DS    XL4                 CD                                           
PEPTAC   DS    XL4                 AC                                           
PEPTADJ  DS    XL4                 ADJ                                          
PEPTDUE  DS    XL4                 DUE                                          
PEPTOGRS DS    XL4                 OPEN GROSS                                   
PEPTONET DS    XL4                 OPEN NET                                     
PEPTOCD  DS    XL4                 OPEN CD (SAME AS CONTRACT)                   
PEPTOAC  DS    XL4                 OPEN AC                                      
PEPTOADJ DS    XL4                 OPEN ADJ                                     
PEPTODUE DS    XL4                 OPEN DUE                                     
*                                                                               
PEPTTRDC DS    XL4                 TRADE CREDIT                                 
*                                                                               
PEPTTAX  DS    XL4                 SALES TAX                                    
PEPTAOR  DS    XL4                 AOR                                          
PEPTAORT DS    XL4                 AOR BASIS AMOUNT                             
PEPTRETA DS    XL4                 RETAIL ACTUAL                                
PEPTRETG DS    XL4                 RETAIL GROSS                                 
PEPTRETN DS    XL4                 RETAIL NET                                   
PEPTRETC DS    XL4                 RETAIL CD                                    
PEPTRETM DS    XL4                 RETAIL AC                                    
PEPTRETT DS    XL4                 RETAIL TAX                                   
PEPTRETV DS    0XL4                RETAIL GST  (OLD TAG)                        
PEPTRTVS DS    11XL4               RETAIL VATS                                  
*                                                                               
PEPTVAT  DS    0XL4                GST (FOR MAIN BILL) (OLD TAG)                
PEPTVTS  DS    11XL4               VATS (MAIN BILL)                             
PEPTVATC DS    0XL4                GST (FOR COMM ADJ BILL) (OLD TAG)            
PEPTVTCS DS    11XL4               VATS (COMM ADJ BILL)                         
PEPTVATD DS    0XL4                GST (FOR CD BILL) (OLD TAG)                  
PEPTVTDS DS    11XL4               VATS (CD BILL)                               
PEPTVATA DS    0XL4                GST (FOR AOR BILL) (OLD TAG)                 
PEPTVTAS DS    11XL4               VATS (AOR BILL)                              
*                                                                               
PEPTVTB  DS    11XL4               VAT BASIS - MAIN BILL                        
PEPTRVTB DS    11XL4               VAT BASIS RETAIL BILL                        
PEPTCVTB DS    11XL4               VAT BASIS - COMM ADJ BILL                    
PEPTDVTB DS    11XL4               VAT BASIS - CD BILL                          
*                                                                               
PEPTPACT DS    XL4                 PRODUCT ACCOUNT                              
PEPTSTAT DS    XL1                 STATUS                                       
         DS    XL2                 SPARE                                        
*                                                                               
PEPTBILF DS    XL5                 BILLING FORMULA (5)                          
PEPTJOB  DS    CL6                 JOB CODE (FINANCIAL)                         
PEPTAID  DS    CL12                AD ID                                        
         DS    XL3                 SPARE                                        
PEPTAORA DS    CL14                AOR RCVBL/PAYABLE ACCT                       
PEPTAORV DS    0CL1                AOR OTHER AGY VAT CODE (OLD TAG)             
PEPTAOVS DS    CL11                AOR VAT CODES                                
PEPTAORP DS    XL4                 AOR PCT                                      
PEPTAORB DS    XL1                 AORBAS                                       
PEPTAORD DS    XL4                 AOR RECORD DISK ADDRESS                      
PEPTAORI DS    XL2                 AOR INVOICE NUMBER                           
*                                                                               
*                                                                               
PEPTVCD  DS    0CL1                VAT CODE (OLD TAG)                           
PEPTVCDS DS    CL11                VAT CODES                                    
PEPTVSW  DS    0CL1                Y= BILL ACTUALLY VATABLE (OLD TAG)           
PEPTVSWS DS    CL11                VAT SWITCHES                                 
         DS    CL2                 SPARE                                        
*                                                                               
PEPTABRL EQU   *-PEPTD                                                          
*                                                                               
         SPACE 2                                                                
*        DSECT FOR VAT CODE TABLE                                               
VCTABD   DSECT                                                                  
VCTPRV   DS    XL1                 PROVINCE                                     
VCTVCD   DS    C                   VAT CODE                                     
VCTSTRT  DS    XL2                 START MOS                                    
VCTEND   DS    XL2                 END MOS                                      
VCTPCT   DS    XL4                 VAT PCT                                      
VCTABL   EQU   *-VCTABD                                                         
         SPACE 2                                                                
*        DSECT FOR VAT BASE TABLE                                               
*                                                                               
*              DSECT COVERS ENTRY IN TABLE OF PROVINCES                         
*              WITHIN MONTHS WITHIN LEVELS                                      
*                                                                               
VBTABD   DSECT                                                                  
*                                                                               
*                          NOTE THAT FOR FINANCIAL CLTS                         
*                          THESE ARE THE "OPEN" ACCUMS                          
VBTGRS   DS    XL4                 GROSS                                        
VBTNET   DS    XL4                 NET                                          
VBTCD    DS    XL4                 CD                                           
VBTAC    DS    XL4                 AC                                           
VBTTAX   DS    XL4                 TAX (SALES)                                  
*                                                                               
VBTBLBN  EQU   (*-VBTABD)/4        COUNT OF BILLABLE FIELDS                     
VBTADJ   DS    XL4                 COMMISSION ADJUSTMENT                        
VBTDUE   DS    XL4                 DUE AMOUNT                                   
VBTVAT   DS    XL4                 VAT AMOUNT                                   
VBTVATB  DS    XL4                 VAT BASIS                                    
VBTBLTN  EQU   (*-VBTABD)/4        COUNT OF 'TOTALABLE' FIELDS                  
VBTPCT   DS    XL4                 VAT PERCENT                                  
VBTCOD   DS    CL1                 VAT CODE                                     
         DS    XL3                 SPARE                                        
VBTABL   EQU   *-VBTABD                                                         
*                                                                               
         PRINT OFF                                                              
       ++INCLUDE PPREPWORK                                                      
         PRINT ON                                                               
PPWORKD  DSECT                                                                  
         ORG   QPROG+52            USED TO BE COL 28 (QPROG+27)                 
QINVDATE DS    CL6                                                              
QDUEDAYS DS    CL2                                                              
         ORG   QPROG+64            COL 65-68                                    
QMANCD   DS    CL4                 4 BYTES BINARY                               
         ORG                                                                    
         PRINT OFF                                                              
       ++INCLUDE PPREPWORK2                                                     
         PRINT ON                                                               
         ORG   QAREA2+8                                                         
QADID    DS    CL12                COL 9 CARD 2                                 
         ORG   QAREA2+26           COL 27 CARD 2                                
QMANUAL  DS    CL9                 G OR P FOLLOWED BY 4 BINARY                  
         ORG   QAREA2+39           CARD 2 COL 40                                
QPRIOR   DS    0CL3                                                             
QPRIORMO DS    CL2                 NUMBER OF PRIOR MONTHS - REQ                 
QPRIORMD DS    CL1                 C'T' (TOGETHER) SUPPORTED NOW                
         ORG   QAREA2+45                                                        
QPO#SEQ  DS    CL2                 REQ BY PO#                                   
         ORG                                                                    
*                                  OR SPECIAL CODES                             
PACELEMD DSECT                                                                  
       ++INCLUDE PACELEM                                                        
         EJECT                                                                  
*                                                                               
PCOLRECD DSECT                     CUSTOM COLUMN RECORD                         
       ++INCLUDE PCOLREC                                                        
         EJECT                                                                  
*                                                                               
         PRINT OFF                                                              
       ++INCLUDE PPNEWFILE                                                      
         EJECT                                                                  
       ++INCLUDE PPMODEQU                                                       
         EJECT                                                                  
       ++INCLUDE DDDICTATED                                                     
         EJECT                                                                  
       ++INCLUDE DDLOGOD                                                        
         EJECT                                                                  
       ++INCLUDE DDREPMASTD                                                     
         EJECT                                                                  
       ++INCLUDE PBLPSTEL                                                       
         EJECT                                                                  
PORELED  DSECT                                                                  
       ++INCLUDE PORELEM                                                        
         EJECT                                                                  
       ++INCLUDE PPGENBYCC                                                      
         EJECT                                                                  
       ++INCLUDE PAORREC                                                        
         EJECT                                                                  
       ++INCLUDE DDBUFFALOD                                                     
         EJECT                                                                  
       ++INCLUDE PPGETCGD                                                       
         EJECT                                                                  
       ++INCLUDE DDUCOMD                                                        
         EJECT                                                                  
       ++INCLUDE DDGETPROFD                                                     
         EJECT                                                                  
       ++INCLUDE DDOFFICED                                                      
         EJECT                                                                  
PPGBFRDD DSECT                                                                  
       ++INCLUDE PPGETBFRD                                                      
         EJECT                                                                  
       ++INCLUDE DDTSARD                                                        
         EJECT                                                                  
       ++INCLUDE DMWRKFK                                                        
         EJECT                                                                  
       ++INCLUDE DMWRKFL                                                        
         EJECT                                                                  
       ++INCLUDE DMWRKFD                                                        
         EJECT                                                                  
PBPROFD  DSECT                                                                  
       ++INCLUDE PBILPROF                                                       
         EJECT                                                                  
       ++INCLUDE PFOLINKD                                                       
         EJECT                                                                  
       ++INCLUDE PPBILLEDID                                                     
         EJECT                                                                  
         PRINT ON                                                               
       ++INCLUDE DDREMOTED                                                      
         EJECT                                                                  
       ++INCLUDE DDCOMFACSD                                                     
         EJECT                                                                  
       ++INCLUDE DDCOREQUS                                                      
         EJECT                                                                  
       ++INCLUDE FALOCKETD                                                      
         EJECT                                                                  
       ++INCLUDE PPGENBYPO                                                      
*                                                                               
       ++INCLUDE FASSB                                                          
         ORG   SSBD                                                             
       ++INCLUDE FASSBOFF                                                       
         ORG                                                                    
*                                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'184PPREPB102 01/20/21'                                      
         END                                                                    
