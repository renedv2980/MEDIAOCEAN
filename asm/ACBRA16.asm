*          DATA SET ACBRA16    AT LEVEL 066 AS OF 01/06/21                      
*PHASE T62416A                                                                  
                                                                                
ACBRA16  TITLE '- BRA Expenses upload server'                                   
                                                                                
* Level change comments                                                         
* ---------------------                                                         
* UK Levels                                                                     
* ---------                                                                     
* NSHE 001 09JUN09 DDLink upload server for Expenses 2nd version                
* NSHE 002 08JAN10 Add US fix and fix to office validation                      
* NRAK 003 14JAN10 Support CLDAPPID in UK - includes RGUP fix                   
* TFRY/NRAK 004 15JAN10 <BR29982L> Bigger,capped errtab                         
* NSHE 005 20JAN10 When resubmitting insist on a change and                     
*                  capture submit comments                                      
* NSHE 006 13MAY10 Change error message when no default expense ac              
* SMAN 007 01SEP10 <BR35679L> Do not remove prev apprvls if rej or app          
* NSHE 008 10AUG10 Check for unbillable work codes - optimise getopt            
* NRAK             OILL change                                                  
* NRAK 009 19JAN10 <br17188d> getlid must allow for lidloff                     
* SMAN 010 18MAR11 <UKCR00030417> Change error message in VALWCD                
* SMAN     27APR11 Skip VALOFF if QI_TYPE invalid                               
* MPEN 011 06JAN11 <PR001318> Upload client manager approvers                   
* MPEN 013 24JUN11 Bug fix if sequential is deleted read for it                 
* MPEN 015 24MAY11 For WPP workflow ensure HD_LMAPN is set                      
* NSHE     19OCT11 New mileage rate system and approver workflow                
* NSHE 016 26OCT11 Fix to bufrec so indicator is refreshed                      
* NSHE 018 01DEC11 Use SORTER to buffer records instead of FACWRK               
* JFOS 019 12APR12 <BR48756L> extend APPTAB/skip duplcate appr. entries         
* NSHE 021 20JUL12 Trap bad currency posting issue                              
* NSHE 022 01AUG12 Fix claim reference issue in US                              
* NSHE 023 22AUG12 Fix 29 default account look up                               
*NRAK 024 17DEC12 <BR53176L> Ignore TNB if 2nd lvl appr req'd on exp            
*NSHE 025 03SEP12 Change to IO routine for auto switching system                
*NRAK 025 23MAY13 <DSBO-17> error if exchange rate too large                    
*NRAK 026 28aug13 <DSRD-31> responses for 'Add to limlist', and                 
*NRAK 026              control modules to activate                              
*JFOS 027 30AUG13 <DSBO245> Defensive code when CIDMNUM = 0                     
*NRAK 028 02SEP13 <DSRD-31> Unrelated bug - RACDATE not set                     
*JFOS 029 30DEC13 <DSBO574> Fix backup approver issue, WPP workflow             
*MPEN 030 25MAR14 <DSBO-763> Don't check 2D if not doing dep analysis           
*MPEN 031 12MAY14 <OT79420L> Use RUNNER's DDSORTER                              
*NRAK 032 12JUN14 <DSBO-906> Fix default 29 account building                    
*TKLU 033 01Sep14 <PCA01157> DATCON/15 for post production gap issue            
*NSHE     20NOV14 <PCA01109> Use claim number in the posting reference          
*NRAK     18NOV14 <DSRD-5182> fix error messages from GETSJOF                   
*NRAK 034 01apr15 <DSRD-6750> fix add to limlist if acc exists, dis'd           
*MPEN 035 22MAY15 <DSRD-7283> Enable user to add entries if no limlist          
*MPEN 036 24JUL15 <DSBO-1540> Fix for finance approver reject                   
*JFOS 038 13OCT15 <PCA-1989> Support Limit a/c access                           
*NRAK     11NOV15 <DSBO-1627> Fix for approver selection                        
*NSHE     08Jan15 <DSRD-9925> Fix for updating limit list                       
*NSHE 039 02Aug16 <DSRD-12404> Fix approver count                               
*TKLU 040 12Oct16 <PCA02486>  Pass user ID to BMONVAL                           
*NSHE 041 12Oct16 <DSRD-13116> Remove brandocean date control                   
*MPEN             <DSRD-13862> Fix for claimant email not being sent            
*TKLU 042 15Nov16 <PCA01157> Adjustments for DATCON/15                          
*MPEN 043 25Oct16 <DSRD-13862> Fix for claimant email not being sent            
*MPEN     26Oct16 <DSRD-13869> Output approval status in email not              
*NSHE     31Oct16 <DSRD-13859> Aura don't need back up approver setting         
*MPEN     31Oct16 <DSRD-13894> Skip deleted lines for approver not              
*NSHE     09Nov16 <DSRD-13988> Allow to save a claim without any items          
*NSHE     11Nov16 <DSRD-13821> Keep finance comments when claim amended         
*MPEN 044 01Dec16 <DSRD-14272> Fix for errors on deleted claim lines            
*MPEN 045 09Dec16 <ITMF-11894> Ensure TSAR buffer is not reallocated            
*MPEN 046 13Dec16 <DSRD-14272> Xdata fix                                        
*MPEN 047 28Nov16 <DSRD-14210> Canadian tax/GST/PST province changes            
*MPEN     24Oct16 <DSRD-2606>  Improve add to limlist call                      
*MPEN     24Oct16 <DSRD-14193> Fixes for add to limlist                         
*MPEN     07Dec16 <DSRD-14315> Don't audit items already deleted                
*MPEN     12Dec16 <DSRD-14002> Fix for add to GRPLIST                           
*MPEN     15Dec16 <DSRD-14365> Fix for backup approval                          
*MPEN     03Jan17 <DSRD-14537> Fix for finance edit                             
*MPEN     12Jan17 <DSRD-14654> Fix for net when adding -ve amounts              
*MPEN 048 18Jan17 <DSRD-14663> Fix for add to grplist                           
*NSHE 049 20Feb17 <DSRD-14868> Fix when adding 1 client to limit list           
*MPEN 050 11Apr17 <DSRD-15416> Fix for Aura backup approval                     
*NRAK 051 27Apr17 <DSRD-15612> Skip validation when rejecting.                  
*MPEN     13Jun17 <DSRD-16030> Fix for the above                                
*MPEN     23Jan17 <DSRD-14301> Remove temp MF fix                               
*MPEN             <SPEC-9729>  Bad LIDELD fix                                   
*MPEN     17May17 <DSRD-15807> MF Fix for client approval not set               
*NSHE     08Jun17 <DSRD-15940> Limit error messages due to output size          
*NSHE 052 20Jul17 <DSRD-16387> Add receipt image changed field                  
*MPEN     02Aug17 <DSRD-16415> Don't clear pids and status if copy item         
*MPEN     09Aug17 <DSRD-16548> Remove line man app status on response           
*MPEN 053 17Aug17 <DSRD-16653> Limit error messages to 20                       
*MPEN 054 21Sep17 <DSRD-16937> Fix for lvl 52 only clear pids                   
*MPEN 055 26Sep17 <DSRD-16862> Additional fix for the above                     
*nrak 056 26Sep17 <DSRD-17551> fix limlist reading                              
*NSHE 057 28Dec17 <DSRD-17744> Make expense postings distinguishable            
*NSHE 058 29Aug18 <DSRD-19479> Pass office to POSTOFF routine                   
*MPEN 059 23Oct18 <DSRD-20447> Relink for new DPAPASD                           
*MPEN 060 19Nov18 <DSRD-20738> Office/country changes                           
*NSHE     20Dec18 <DSRD-21084> Fix when province is not PQ                      
*JSHA 061 24Jun19 <DSRD-22878> Fix for CL_PSTAC length                          
*MPEN     03May19 <DSRD-21614> Extend rejection comments to 1000 chars          
*NSHE 062 14Feb20 <DSRD-24903> fix claim number in elements when it             
*                              goes from saved to submitted                     
*MPEN     18Feb20 <DSRD-24720> Skip VAT validation if del line + post           
*ABID 063 16MAY20 <DSRD-25289> EXPENSES EU MF A55/5P - SEED CLAIM ON            
*                              Payment                                          
*NRAK     06MAY20 SPEC-45730 Skip SRUPD60 if SORTER empty                       
*MPEN 064 14JUL20 <DSRD-26551> Expense finance search                           
*MPEN 065 06OCT20 <DSRD-27741> Fix for claim item comment audit UK              
*NSHE     07OCT20 DSRD-26734 Ensure mf gets total from all items                
*NRAK 066 04NOV20 SPEC-51378 Error on bad narrative length                      
*YNGX 067 13Nov20 DSRD-27019 New application bit for mobile                     
*MPEN 068 23Dec20 DSRD-28099 Fix for multiple audit approver comments           
*MPEN 069 06Jan21 DSRD-28363 Don't set date for QA                              
*                                                                               
                                                                                
         PRINT NOGEN                                                            
SVRDEF   CSECT                                                                  
         LKSVR TYPE=UO,CODE=ENTRY,RLEN=2000,REQUEST=*,WORKERKEY=ACXU,  +        
               LINKIO=Y,BLOCKS=(B#SAVED,SAVED),SYSTEM=ACCSYSQ,         +        
               FILES=FILES,SERVERTYPE=TSTBOTU,SYSPHASE=SYSPHASE,IDF=Y, +        
               PROGRAM=RCVPBRAQ                                                 
                                                                                
ENTRY    NMOD1 0,**BO16**,RR=RE                                                 
         LR    R5,R1                                                            
         USING LP_D,R5                                                          
         L     R7,LP_ARUNP                                                      
         USING RUNPARMD,R7         R7=A(RUNPARMS)                               
         XR    R6,R6                                                            
         ICM   R6,7,RUNPARUN                                                    
         USING RUNFACSD,R6         R6=A(RUNFACS)                                
         LARL  RA,GLOBALS                                                       
         USING GLOBALS,RA          R5=A(GLOBAL LITERALS)                        
                                                                                
         TM    LP_FLAG,LP_FOFFL    Test off-line                                
         BNZ   ENTRY02                                                          
         L     R9,LP_ABLK1                                                      
         ICM   R8,15,RSVRSAVE      R8=A(Save area)                              
         B     ENTRY04                                                          
                                                                                
ENTRY02  L     R9,RSVRSAVE                                                      
         ST    R9,LP_ABLK1                                                      
         USING WORKD,R9            R9=A(Global w/s)                             
         SR    R8,R8                                                            
         ICM   R8,3,WORKLEN                                                     
         LA    R8,WORKD(R8)                                                     
         USING SAVED,R8            R8=A(Save w/s)                               
         MVC   MASTC,RMASTC        Set A(MASTC)                                 
         MVC   VSORTER,RSORTER                                                  
                                                                                
ENTRY04  ST    R8,LP_ABLK2                                                      
         MVC   WRKBLKR,RWRKBLKR    Set A(FACWRK WRKIO block)                    
         ST    RE,SRVRRELO         Save program relocation factor               
         MVC   RUNMODE,RUNPMODE    Set calling mode                             
         DROP  R6,R7                                                            
                                                                                
         LAY   R7,CL_CUR                                                        
         USING CL_CUR,R7           R7=A(Current claim buffer record)            
         USING CL_D,CL_CUR         R7=A(Current claim buffer record)            
OLD      USING CL_D,CL_OLD         Old claim item record                        
NEW      USING CL_D,CL_NEW         New claim item record                        
                                                                                
         STM   R2,RB,LP_R2RB       Save registers for sub-routines              
                                                                                
***********************************************************************         
* Handle DDLINK/RUNNER modes                                          *         
***********************************************************************         
                                                                                
         CLI   RUNMODE,RRUNSTRQ    Test 'First for run' mode                    
         BE    SRUN                                                             
         CLI   RUNMODE,RINIREQQ    Test 'Initialise' mode                       
         BE    SREQ                                                             
         CLI   RUNMODE,RVALREQQ    Test 'Validate record' mode                  
         BE    UPLD                                                             
         CLI   RUNMODE,RRUNREQQ    Test 'Run request' mode                      
         BE    UPLD                                                             
         CLI   RUNMODE,RRUNENDQ    Test 'Last for request' mode                 
         JE    EREQ                                                             
         J     EXITY               Ignore any other modes                       
         EJECT                                                                  
***********************************************************************         
* Handle 'First for run' (once only off-line) mode                    *         
***********************************************************************         
                                                                                
SRUN     LA    R0,SAVED            Clear sacred storage                         
         LHI   R1,SAVEVAR-SAVED                                                 
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         L     RE,LP_ACOM                                                       
         MVC   DATAMGR,CDATAMGR-COMFACSD(RE)                                    
         MVC   PROTOFF,CPROTOFF-COMFACSD(RE)                                    
         MVC   PROTON,CPROTON-COMFACSD(RE)                                      
         MVC   LOCKET,CLOCKET-COMFACSD(RE)                                      
         MVC   XDATAMGR,VDATAMGR   Point to real DATAMGR entry point            
         MVC   IDATAMGR,VDATAMGR                                                
                                                                                
         TM    LP_FLAG,LP_FOFFL    Test off-line                                
         JZ    EXITY                                                            
         L     RF,LP_ACOM          Load subsidiary phases & initialise          
         L     RF,CCALLOV-COMFACSD(RF)                                          
         LA    R1,DMCB                                                          
         GOTOR (RF),(R1),('O#ROU1',0),0,0                                       
         MVC   AROUT1,0(R1)        Set A(Routine overlay 1)                     
         MVC   LP_AUIR1,AROUT1                                                  
         GOTOR (RF),(R1),('O#ROU2',0),0,0                                       
         MVC   AROUT2,0(R1)        Set A(Routine overlay 2)                     
         MVC   LP_AUIR2,AROUT2                                                  
         GOTOR (RF),(R1),0,(C'E',SRUPD60)                                       
         MVC   ASRUPD60,0(R1)      Set A(SRUPD60)                               
         LA    R0,LP_D                                                          
         ST    R0,ALP              Set A(LP_D) in global w/s                    
         MVC   ACOMFACS,LP_ACOM    Set A(COMFACS)                               
         MVC   ATWA,LP_ATWA        Set A(TWA)                                   
         GOTOR (#WRKINI,AWRKINI)   Initialise working storage                   
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Handle 'First for request' (before first upload record) mode        *         
***********************************************************************         
                                                                                
SREQ     LA    R0,SAVEVAR                                                       
         LHI   R1,SAVEVARL                                                      
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         XC    CLMLOCK(CLMLOCKL),CLMLOCK                                        
         XC    APRPIDS(APRPIDSL),APRPIDS                                        
         MVI   TWAMODE,0           Set no errors encountered                    
                                                                                
         L     RF,LP_ACOM          Extract A(LINKIO) from COMFACS               
         MVC   AALINKIO,CLINKIO-COMFACSD(RF)                                    
         MVC   AALIOB,LP_ALIOB     Set A(LIOB)                                  
                                                                                
         NI    RUNINDS,FF-RUNIPUTF Set first time for PUTOUT                    
         NI    RUNINDS,FF-RUNIBUFF Set first time for BUFREC                    
         NI    RUNINDS,FF-RUNIATRF Set first time for GOATRN                    
         NI    RUNINDS,FF-RUNICOMA Remove comment audit flag                    
         NI    RUNINDS,FF-(RUNIAURA+RUNIMOB) Remove connected app               
                                                                                
         TM    LP_FLAG,LP_FOFFL    Test off-line                                
         JZ    SREQ02                                                           
                                                                                
         GOTOR DATAMGR,DMCB,DMKEY,ACCDIR,(4,0),0                                
         GOTOR DATAMGR,DMCB,DMKEY,ACCMST,(4,0),0                                
         GOTOR DATAMGR,DMCB,DMKEY,ACCARC,(4,0),0                                
                                                                                
         L     RF,MASTC            Set I/O trace option                         
         MVC   IOTRACE,MCTRACE-MASTD(RF)                                        
                                                                                
SREQ02   GOTOR PROTOFF             Turn off storage protection                  
         LA    R0,LP_D                                                          
         ST    R0,LLP              Save A(LP_D) locally                         
         GOTOR PROTON              Turn on storage protection                   
                                                                                
         MVC   ACOMFACS,LP_ACOM    Point to real copy of COMFACS                
                                                                                
         MVI   GIND2,GI2EEXP                                                    
         GOTOR (#CPYINI,ACPYINI)   Initialise company values                    
         USING CPYELD,SCPYEL                                                    
         USING CPXELD,SCPXEL                                                    
         GOTO1 VDICTATE,DMCB,C'LL  ',DCDICTL,DSDICTL                            
                                                                                
         GOTOR INIBUF              Initialise record buffer                     
                                                                                
         TM    LP_FLAG,LP_FDRFT    Test validation mode                         
         JNZ   EXITY                                                            
                                                                                
SREQ04   LA    R0,COMFACS          Take local copy of COMFACS                   
         LHI   R1,COMFACSL                                                      
         L     RE,LP_ACOM                                                       
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         LA    RF,COMFACS                                                       
         ST    RF,ACOMFACS         Set A(COMFACS) as local copy                 
         LARL  R0,DMGRITRN                                                      
         ST    R0,IDATAMGR         Set internal DATAMGR entry point             
         LARL  R0,DMGRXTRN                                                      
         ST    R0,XDATAMGR         Set external DATAMGR entry point             
         MVC   VDATAMGR,IDATAMGR   Set addresses for callers                    
         MVC   CDATAMGR-COMFACSD(,RF),XDATAMGR                                  
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Handle 'Run request' (upload a record) mode                         *         
***********************************************************************         
                                                                                
UPLD     LA    RF,RECTAB                                                        
         USING RECTABD,RF          RF=A(Record map table)                       
         LHI   R0,RECTABN                                                       
         BASR  RE,0                                                             
         CLC   RECTMAP#,LP_QMAPN   Look up record map code                      
         BE    *+12                                                             
         AHI   RF,RECTABL                                                       
         BCTR  R0,RE                                                            
         DC    H'0'                                                             
         MVC   RECTYPE,RECTTYPE    Set internal record type                     
         DROP  RF                                                               
         SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM                                                     
         CHI   RF,XPRODIKQ         Aura                                         
         JNE   *+8                 No                                           
         OI    RUNINDS,RUNIAURA    Aura is the connected app                    
                                                                                
         CHI   RF,XPMOBILQ         Mobile                                       
         JNE   *+8                                                              
         OI    RUNINDS,RUNIMOB     Mobile is the connected app                  
                                                                                
         LAY   RE,BLOCK                                                         
         MVI   0(RE),ET_EOTQ       Clear error table                            
         CLI   RECTYPE,RECTHDRQ    Test header record                           
         JE    UHDR                                                             
         CLI   RECTYPE,RECTITMQ    Test claim item line                         
         JE    UITM                                                             
         CLI   RECTYPE,RECTXDTQ    Test Extra data line                         
         JE    UXDT                                                             
         CLI   RECTYPE,RECTTRLQ    Test Trailer record                          
         JE    UTRL                                                             
         CLI   RECTYPE,RECTALLQ    Test Account add to limit list rec           
         JE    UALL                                                             
         DC    H'0'                Invalid record                               
         DROP  RB                                                               
         EJECT                                                                  
***********************************************************************         
* Process claim upload header record                                  *         
***********************************************************************         
                                                                                
UHDR     MVI   TWAMODE,0           set to no error                              
                                                                                
         GOTOR BUFCLM,DMCB,('TSAINI',OLDBUF),0                                  
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         CLI   RUNMODE,RVALREQQ    Test 'Validate request' mode                 
         JE    UHDR0010                                                         
         ICM   RE,15,QH_AHEAD      Test header values passed                    
         JNZ   *+6                                                              
         DC    H'0'                                                             
         AHI   RE,LW_LN1Q                                                       
         LA    R0,HD_VALS                                                       
         LHI   R1,HD_VALSL                                                      
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         TM    HD_IND,HD_INOPR     Test any previous claim recs found           
         JNZ   UHDR0250            No                                           
         TM    HD_ST1FR,EXCSCOMP   Don't allow further processing of            
         JZ    *+6                 completed claims                             
         DC    H'0'                                                             
         ZAP   TR_TAMT,PZERO       Zero total claim amount                      
         GOTOR OLDCLM              Build old claim item buffer                  
         JE    UHDR0250                                                         
         DC    H'0'                                                             
                                                                                
UHDR0010 LA    R0,HD_VALS          Initialise header values                     
         LHI   R1,HD_VALSL                                                      
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         LA    R0,TR_VALS          Initialise trailer values                    
         LHI   R1,TR_VALSL                                                      
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         ZAP   HD_ITCNT,PZERO      Zero count                                   
         ZAP   TR_TAMT,PZERO       Zero total claim amount                      
                                                                                
UHDR0020 DS    0H                                                               
***      GOTOR VDATCON,DMCB,(5,0),(1,HD_TODP)                                   
***      GOTOR (RF),(R1),(5,0),(2,HD_TODC)                                      
***      GOTOR (RF),(R1),(5,0),(0,HD_TODF)                                      
         GOTOR VDATCON,DMCB,(15,0),(1,HD_TODP)                                  
         GOTOR (RF),(R1),(15,0),(2,HD_TODC)                                     
         GOTOR (RF),(R1),(15,0),(0,HD_TODF)                                     
         GOTOR VDATCON,DMCB,(5,0),(1,HD_TODP5)                                  
                                                                                
UHDR0030 GOTOR OLDCLM              Build old claim item buffer                  
         JE    UHDR0060                                                         
         OI    HD_IND,HD_INOPR     Set no previous claim record found           
         MVC   HD_OPID,CCTPID      Set original pid who adds claim              
         MVC   HD_OUID,CUUSER      Set original user id                         
                                                                                
         MVC   HD_DATE,QH_DATE                                                  
         XR    R1,R1               complement the date                          
         ICM   R1,3,HD_DATE                                                     
         LNR   R1,R1                                                            
         STCM  R1,3,HD_DATEC                                                    
                                                                                
         OC    QH_PER,QH_PER       any claimant override?                       
         JZ    UHDR0040                                                         
         OI    TR_ST2NW,EXCKSOBQ                                                
         GOTOR SETCOD                                                           
         JE    UHDR0060                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'QH_PER,QH_PER),0                          
         J     UFATAL                                                           
                                                                                
UHDR0040 MVC   HD_PPID#,CCTPID                                                  
         MVC   TEMP2(2),CCTPID     read for acc person code of claimer          
         GOTOR (#ACCPID,AACCPID)                                                
         JE    UHDR0045                                                         
         GOTOR SAVERR,DMCB,FULL2,0,0                                            
         J     UFATAL                                                           
                                                                                
UHDR0045 MVC   HD_1RPER,TEMP2+10   Person account code                          
                                                                                
UHDR0060 CLC   HD_INDX,QH_IDNUM                                                 
         JE    UHDR0065                                                         
         MVC   ROUERRV,=AL2(AE$FATAL)                                           
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
         J     UFATAL                                                           
                                                                                
UHDR0065 TM    CPXSTAT6,CPX2LAEI  WPP workflow                                  
         JZ    *+8                                                              
         OI    TR_ST2NW,EXCKWPPQ                                                
         GOTOR VDATCON,DMCB,(2,HD_DATE),(1,HD_DATEP)                            
         GOTOR GETODS                                                           
         JE    UHDR0070                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'HD_1RPER,HD_1RPER),0                      
         J     UFATAL                                                           
                                                                                
UHDR0070 DS   0H                                                                
*&&UK*&& GOTOR GETCCT              Get currency country                         
         GOTOR GETCLN              Get claim number                             
         JE    UHDR0075                                                         
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
                                                                                
UHDR0075 GOTOR DOLOCK                                                           
         JE    UHDR0080                                                         
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
         J     UFATAL                                                           
                                                                                
UHDR0080 ZAP   HD_APCNT,PZERO      Zero count                                   
*                                                                               
         L     R2,ACOBLOCK         Get cost allocation profiles                 
         USING COBLOCKD,R2                                                      
         XC    COBLOCKD(COPTIONS-COBLOCKD),COBLOCKD                             
         MVC   COADM,XDATAMGR                                                   
         MVC   COBKEY(COBKEYLN),SPACES                                          
         MVC   COKCPY,CUXCPY                                                    
         MVC   COKOFC,HD_1ROFF                                                  
         MVC   COKDPT,HD_1RDEP                                                  
         MVC   COKSDT,HD_1RSUB                                                  
         MVC   COKPER,HD_1RPER                                                  
         GOTOR VGETCAP,DMCB,COBLOCK                                             
         CLI   COSTATUS,0                                                       
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         GOTOR GETMAP,HD_1RACT     Get approver and back-up PIDs                
         JE    UHDR0085                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'HD_1RACT,HD_1RACT),0                      
                                                                                
UHDR0085 GOTOR GETFAP,HD_1RACT     Get finance approver                         
         JE    UHDR0090                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'HD_1RACT,HD_1RACT),0                      
                                                                                
UHDR0090 L     R2,ACOBLOCK                                                      
         MVC   HD_COCCM,COCCM      Extract option values we need                
         MVC   HD_COACM,COACM                                                   
         MVC   HD_CONMX,CONMX                                                   
         MVC   HD_COBDT,COBDT                                                   
         MVC   HD_COECL,COECL                                                   
         MVC   HD_COENR,COENR                                                   
         MVC   HD_COBCA,COBCA                                                   
         MVC   HD_COTNB,COTNB                                                   
         MVC   HD_COLMA,COLMA                                                   
         MVC   HD_COCAE,COCAE                                                   
         MVC   HD_COMIL,COMIL                                                   
         TM    HD_IND,HD_INOPR     No previous claim record found               
         JZ    UHDR0095                                                         
         CLI   HD_COCAE,YESQ       New claim so ensure behaviour                
         JNE   *+8                 switches if profile is on                    
         OI    TR_ST2NW,EXCKCLAQ                                                
                                                                                
UHDR0095 ZAP   DUB1,COBDT                                                       
         CVB   R0,DUB1                                                          
         DROP  R2                                                               
                                                                                
         GOTO1 VADDAY,PARM,(C'M',HD_TODF),TEMP2,(R0)                            
         LNR   R0,R0                                                            
         GOTO1 (RF),(R1),,TEMP2+6,(R0)                                          
         GOTO1 VDATCON,DMCB,(0,TEMP2),(2,HD_DTHI)                               
         GOTO1 (RF),(R1),(0,TEMP2+6),(2,HD_DTLO)                                
         TM    CPYSTAT4,CPYSOV12                                                
         JZ    UHDR0100                                                         
         XC    HD_DTLO,HD_DTLO     Any date backwards allowable                 
                                                                                
UHDR0100 GOTOR POSTOFF,HD_1ROFF                                                 
                                                                                
UHDR0105 CLI   QH_STAT,QH_DELQ     Test deleting expense claim                  
         JNE   *+8                                                              
         MVI   TR_ST1NW,EXCSLOGD                                                
         CLI   QH_IFAMZ,YESQ       Do we want to suppress zero lines            
         JNE   *+8                                                              
         OI    HD_CLSTA,CLDSZRAQ   Yes - set bit for record                     
                                                                                
         TM    CPXSTAT6,CPX2LAEI   WPP workflow                                 
         JNZ   UHDR0160            Yes                                          
         MVI   HD_USRLM,NOQ                                                     
         LA    R6,HD_LMAP                                                       
AP       USING HD_LMAP,R6                                                       
         XR    RF,RF                                                            
         ICM   RF,1,HD_LMAPN                                                    
         JZ    UHDR0160                                                         
UHDR0110 AP    HD_APCNT,PONE       count approvers                              
         CLI   QH_STAT,QH_SAVEQ    Test saving                                  
         JE    UHDR0120                                                         
         CLC   HD_PPID#,AP.HD_LMPID Is line manager approver the user?          
         JNE   UHDR0120                                                         
         CLC   HD_PPID#,CCTPID     Is it user?                                  
         JE    UHDR0140                                                         
                                                                                
UHDR0120 CLC   HD_PPID#,CCTPID     Is it user?                                  
         JE    UHDR0150                                                         
         CLC   AP.HD_LMPID,CCTPID  Is it line manager?                          
         JE    UHDR0130                                                         
         CLI   QH_BKUP,C'Y'        Back up approver?                            
         JNE   UHDR0155                                                         
         LA    R0,HD_BAMAX         Max Backup Approvers                         
         LA    R1,AP.HD_LMBUP      Search backups approvers for match           
UHDR0125 OC    0(L'PIDNO,R1),0(R1) Any Pids left in table?                      
         JZ    UHDR0155                                                         
         CLC   CCTPID,0(R1)        Is line manager a back up approver?          
         JE    UHDR0130                                                         
         LA    R1,L'PIDNO(R1)                                                   
         JCT   R0,UHDR0125                                                      
         J     UHDR0155                                                         
                                                                                
UHDR0130 CLI   QH_STAT,QH_APPQ     Are we approving?                            
         JE    UHDR0140                                                         
         CLI   QH_STAT,QH_REJQ     or rejecting?                                
         JNE   UHDR0145                                                         
         MVI   AP.HD_LMSTA,CIDAREJ+HD_THIST                                     
         J     UHDR0145                                                         
                                                                                
UHDR0140 MVI   AP.HD_LMSTA,CIDAAPP+HD_THIST                                     
UHDR0145 MVI   HD_USRLM,YESQ       Yes                                          
         J     UHDR0155                                                         
                                                                                
UHDR0150 NI    AP.HD_LMSTA,X'FF'-CIDAREJ                                        
                                                                                
UHDR0155 LA    R6,HD_LMAPL(R6)                                                  
         JCT   RF,UHDR0110                                                      
                                                                                
UHDR0160 TM    HD_ST1FR,EXCSCOMP   Claim has been posted                        
         JZ    UHDR0210                                                         
         CLI   TR_ST1NW,EXCSDELT   Are we trying to Delete it?                  
         JNE   UHDR0210                                                         
         MVC   ROUERRV,=AL2(AE$DELOO)                                           
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
                                                                                
UHDR0210 L     R2,AAPPTAB          Initialise approver table                    
         TM    CPXSTAT6,CPX2LAEI   WPP workflow                                 
         JNZ   UHDR0230            Yes                                          
         LA    R6,HD_LMAP                                                       
AP       USING HD_LMAP,R6                                                       
         XR    RF,RF                                                            
         ICM   RF,1,HD_LMAPN       Do we have any line managers                 
         JZ    UHDR0230                                                         
         LHI   R1,APPRTMAN                                                      
         USING APPTABD,R2                                                       
UHDR0220 MVI   APPRLN,APPKLNQ                                                   
         OC    AP.HD_LMLVL,AP.HD_LMLVL                                          
         JZ    UHDR0221                                                         
         LHI   R1,APPRTMAN                                                      
         LLC   RE,AP.HD_LMLVL                                                   
         SHI   RE,1                                                             
         AR    R1,RE                                                            
UHDR0221 STC   R1,APPRTYP                                                       
         MVC   APPRTOKN,QH_TOKEN                                                
         MVC   APPRPID,AP.HD_LMPID                                              
         MVC   APPRAST,AP.HD_LMSTA                                              
         AHI   R2,APPKLNQ                                                       
                                                                                
         OC    AP.HD_LMPID,AP.HD_LMPID Any approver                             
         JZ    UHDR0222            No                                           
         TM    AP.HD_LMSTA,CIDAANR Is approval not required                     
         JNZ   UHDR0222            Yes                                          
         TM    AP.HD_LMSTA,CIDAAPP No - is it approved                          
         JNZ   UHDR0224            Yes                                          
         OI    TR_INDLM,TR_IMLMG   Set missing line manager approval            
         J     UHDR0226                                                         
                                                                                
UHDR0222 OI    TR_INDLM,TR_INLMG   No line manager approval required            
         J     UHDR0226                                                         
                                                                                
UHDR0224 OI    TR_INDLM,TR_ILMGA   At least one line manager approved           
                                                                                
UHDR0226 LA    R6,HD_LMAPL(R6)                                                  
         OC    AP.HD_LMLVL,AP.HD_LMLVL                                          
         JNZ   *+8                                                              
         AHI   R1,1                                                             
         JCT   RF,UHDR0220                                                      
         TM    TR_INDLM,TR_IMLMG   Missing some line managers approvals         
         JNZ   *+8                                                              
         OI    TR_INDLM,TR_ILNMG   Set all line man approvals present           
         MVI   APPRLN,0                                                         
UHDR0230 ST    R2,AAPPTN           Set A(Next approver entry)                   
         DROP  AP,R2                                                            
                                                                                
UHDR0232 LA    R6,HD_FNAP                                                       
AP       USING HD_FNAP,R6                                                       
         LLC   RF,HD_FNAPN                                                      
         LHI   R1,APPRTFIN                                                      
         L     R2,AAPPTN                                                        
         USING APPTABD,R2                                                       
UHDR0240 MVI   APPRLN,APPKLNQ                                                   
         STC   R1,APPRTYP                                                       
         MVC   APPRTOKN,QH_TOKEN                                                
         MVC   APPRPID,AP.HD_FNPID                                              
         MVC   APPRAST,AP.HD_FNSTA                                              
         AHI   R2,APPKLNQ                                                       
                                                                                
         OC    AP.HD_FNPID,AP.HD_FNPID Any approver                             
         JZ    UHDR0244            No                                           
         TM    AP.HD_FNSTA,CIDAANR Is approval not required                     
         JNZ   UHDR0244            Yes                                          
         TM    AP.HD_FNSTA,CIDAREJ No - is it rejected                          
         JNZ   UHDR0242            Yes                                          
         TM    AP.HD_FNSTA,CIDAAPP No - is it approved                          
         JNZ   UHDR0246            Yes                                          
         J     *+8                                                              
UHDR0242 OI    TR_ST2NW,EXCKSFRQ   Set finance rejected                         
         OI    TR_INDFN,TR_IMFMG   Set missing finance man approval             
         J     UHDR0248                                                         
                                                                                
UHDR0244 OI    TR_INDFN,TR_INFMG   No finance man approval required             
         J     UHDR0248                                                         
                                                                                
UHDR0246 OI    TR_INDFN,TR_IFMGA   At least one finance man approved            
                                                                                
UHDR0248 LA    R6,HD_FNAPL(R6)                                                  
         AHI   R1,1                                                             
         JCT   RF,UHDR0240                                                      
         MVI   APPRLN,0                                                         
         ST    R2,AAPPTN           Set A(Next approver entry)                   
         TM    TR_INDFN,TR_IMFMG   Missing some finance approvals               
         JNZ   UHDR0250                                                         
         OI    TR_INDFN,TR_IFNMG   Set all finance approvals present            
         DROP  AP,R2                                                            
         GOTOR CHKMOA                                                           
         JE    UHDR0250                                                         
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
                                                                                
                                                                                
UHDR0250 GOTOR BUFCLM,DMCB,('TSAINI',NEWBUF)                                    
                                                                                
         CLI   RUNMODE,RVALREQQ    Test 'Validate request' mode                 
         JNE   UEXIT                                                            
                                                                                
UHDR0260 GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),                     +        
               ('LIOTLRQ',64),('LQ_TSINQ',HD_VALS),HD_VALSL                     
         GOTOR (RF),(R1),('LIOAPUT',LP_ALIOB),('LIOTGEL',0),RETDATEL            
         J     UEXIT                                                            
         EJECT                                                                  
***********************************************************************         
* Process item record                                                 *         
***********************************************************************         
                                                                                
UITM     TM    TWAMODE,TWAMEDP     Exit on previous fatal error                 
         JNZ   UEXIT               (No further processing)                      
                                                                                
         GOTOR CLRCLD              Clear claim record                           
         LA    R0,CS_VALS          Clear item line values                       
         LHI   R1,CS_VALSL                                                      
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         LA    R0,QX_VALS          Clear extra data line values                 
         LHI   R1,QX_DLNQ                                                       
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         CLI   QH_STAT,QH_DELQ     Test deleting a row                          
         JE    UEXIT                                                            
         TM    HD_IND,HD_INOPR     Test previous claim existed                  
         JNZ   UITM0010                                                         
         CLI   QI_CHNGE,C'Y'       Test changing a line                         
         JE    UITM0010                                                         
         GOTOR CPYONE              No - copy from old buffer                    
         J     UEXIT                                                            
                                                                                
UITM0010 GOTOR DOTSAR,QX_TSAR      Use TSAR record if passed                    
         JE    UEXIT               (adds CL_D record if true)                   
                                                                                
         MVC   ANYACCNT,SPACES                                                  
         MVC   CS_ITYPE,QI_TYPE    Set claim item type                          
         GOTOR VALETY,QI_ETYP      Validate expenditure type                    
         JE    UITM0020                                                         
         CLI   QI_DELT,YESQ        Don't error for deleted lines                
         JE    UITM0020                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'QI_ETYP,QI_ETYP),QI_ITM#                  
                                                                                
UITM0020 OC    QI_CLI,QI_CLI       Test client given                            
         JZ    UITM0040                                                         
         GOTOR BLDJOB,DMCB,ANYACCNT,QI_CLI,QI_PRO,QI_JOB                        
         GOTOR VALJOB,ANYACCNT                                                  
         JE    UITM0030                                                         
         CLI   QI_DELT,YESQ                                                     
         JE    UITM0030                                                         
         OI    CS_IND1,CS_IERR     Set found error                              
         GOTOR SAVERR,DMCB,ROUERRV,(L'ANYACCNT,ANYACCNT),QI_ITM#                
                                                                                
UITM0030 MVC   CL_CLINM,CS_CLNAM                                                
         MVC   CS_ULA,ANYACCNT     Set SJ account code                          
         TM    CPYSTAT1,CPYSOROE   Is agency on offices                         
         JNZ   *+10                                                             
         MVC   CS_SJOFF,SPACES                                                  
                                                                                
         GOTOR VALWCD,QI_WC        Validate work code                           
         JE    UITM0040                                                         
         CLI   QI_DELT,YESQ        Don't error for deleted lines                
         JE    UITM0040                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'QI_WC,QI_WC),QI_ITM#                      
                                                                                
UITM0040 GOTOR DATCHK,QI_DATE                                                   
         JE    UITM0050                                                         
         CLI   QI_DELT,YESQ        Don't error for deleted lines                
         JE    UITM0050                                                         
         GOTOR SAVERR,DMCB,ROUERRV,0,QI_ITM#                                    
                                                                                
UITM0050 CLI   QI_TYPE,QI_BILLQ    billable                                     
         JE    UITM0060                                                         
         CLI   QI_TYPE,QI_NBILQ    non-billable                                 
         JE    UITM0060                                                         
         CLI   QI_TYPE,QI_ADVQ     advances                                     
         JE    UITM0060                                                         
         CLI   QI_DELT,YESQ        Don't error for deleted lines                
         JE    UITM0060                                                         
         MVC   ROUERRV,=AL2(AE$NAWTT)                                           
         GOTOR SAVERR,DMCB,ROUERRV,(L'QI_TYPE,QI_TYPE),QI_ITM#                  
         J     UITM0065                                                         
                                                                                
UITM0060 GOTOR VALOFF,QI_OFF                                                    
         JE    UITM0065                                                         
         CLI   QI_DELT,YESQ        Don't error for deleted lines                
         JE    UITM0065                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'QI_OFF,QI_OFF),QI_ITM#                    
                                                                                
UITM0065 MVC   CS_SUPAC,QI_SUPAC                                                
         CLC   QI_SUPAC,SPACES                                                  
         JH    *+10                                                             
         MVC   CS_SUPAC,HD_SUPAC                                                
         GOTOR VALSUP,CS_SUPAC                                                  
         JE    UITM0070                                                         
         CLI   QI_DELT,YESQ        Don't error for deleted lines                
         JE    UITM0070                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'ACTKULA,CS_SUPAC),QI_ITM#                 
*        J     UEXIT                                                            
                                                                                
UITM0070 CLC   CS_2DAC,SPACES      if department not from creditor              
         JH    UITM0075                                                         
         MVC   CS_2DAC,SPACES      set from 1R off/department                   
         LA    RE,CS_2DAC                                                       
         LLC   R1,ONERL2L                                                       
         SHI   R1,1                                                             
         BASR  RF,0                                                             
         MVC   0(0,RE),HD_1RACT                                                 
         EX    R1,0(RF)                                                         
                                                                                
UITM0075 MVC   CS_EXULA,SPACES                                                  
         MVC   CS_EXULA,CS_DEXAC                                                
                                                                                
         CLI   HD_USRFN,YESQ       Check it's finance otherwise                 
         JNE   UITM0080               it's not needed                           
                                                                                
         OC    QI_EXPAC,QI_EXPAC                                                
         JZ    *+10                                                             
         MVC   CS_EXULA,QI_EXPAC                                                
                                                                                
UITM0080 GOTOR VALEXP,DMCB,CS_EXULA,QI_2DAC,QI_MILES                            
*&&UK*&& JE    UITM0085                                                         
*&&US*&& JE    UITM0090                                                         
         JL    UITM0082                                                         
         CLI   QI_DELT,YESQ        Don't error for deleted lines                
*&&UK*&& JE    UITM0085                                                         
*&&US*&& JE    UITM0090                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'ACTKULA,CS_EXULA),QI_ITM#                 
*&&UK*&& J     UITM0085                                                         
*&&US*&& J     UITM0090                                                         
                                                                                
UITM0082 CLI   QI_DELT,YESQ        Don't error for deleted lines                
*&&UK*&& JE    UITM0085                                                         
*&&US*&& JE    UITM0090                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'ACTKULA,CS_13ULA),QI_ITM#                 
*&&UK                                                                           
UITM0085 GOTOR VALCUR,QI_CUR                                                    
         JE    UITM0090                                                         
         CLI   QI_DELT,YESQ        Don't error for deleted lines                
         JE    UITM0090                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'QI_CUR,CS_CURC),QI_ITM#                   
*&&                                                                             
UITM0090 GOTOR VALMIL,QI_MILES     validate miles                               
         JE    UITM0095                                                         
         CLI   QI_DELT,YESQ        Don't error for deleted lines                
         JE    UITM0095                                                         
         GOTOR SAVERR,DMCB,ROUERRV,0,QI_ITM#                                    
                                                                                
UITM0095 GOTOR VAL2PA,QI_2PAC                                                   
         JE    UITM0100                                                         
         CLI   QI_DELT,YESQ        Don't error for deleted lines                
         JE    UITM0100                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'CS_2PAC,CS_2PAC),QI_ITM#                  
                                                                                
UITM0100 GOTOR VAL2DA,QI_2DAC                                                   
         JE    UITM0110                                                         
         CLI   QI_DELT,YESQ        Don't error for deleted lines                
         JE    UITM0110                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'CS_2DULA,CS_2DULA),QI_ITM#                
                                                                                
UITM0110 DS    0H                                                               
*&&US*&& GOTOR VALGPT,DMCB,QI_PROVI,QI_VATC,QI_PSTCD                            
*&&UK*&& GOTOR VALVAT,QI_VATC                                                   
         JE    UITM0140                                                         
         CLI   QI_DELT,YESQ        Don't error for deleted lines                
         JE    UITM0140                                                         
*&&UK*&& TM    CPYSTAT5,CPYSNVAT   US all on new VAT                            
*&&UK*&& JZ    UITM0120                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'CS_VATC,CS_VATC),QI_ITM#                  
         J     UITM0140                                                         
UITM0120 GOTOR SAVERR,DMCB,ROUERRV,(L'CS_VATAC,CS_VATAC),QI_ITM#                
                                                                                
                                                                                
UITM0140 OC    QI_ONARL,QI_ONARL   Test any narrative entered                   
         JNZ   UITM0150                                                         
         OC    QI_NARL,QI_NARL     Finance narrative                            
         JNZ   UITM0150            Narrative is present                         
*   no narrative                                                                
         CLI   HD_COENR,C'Y'       Test forcing narrative                       
         JE    UITM0145            Yes - error                                  
         CLI   HD_COENR,C'O'       Only when no receipt                         
         JNE   UITM0170            No - must be no                              
         CLI   QI_RCPT,C'Y'        Have we got a recept                         
         JE    UITM0170            Yes - ok to continue                         
         CLI   QH_FINVW,YESQ       Yes - no need from finance update            
         JE    UITM0170                                                         
                                                                                
UITM0145 CLI   QI_DELT,YESQ        Don't error for deleted lines                
         JE    UITM0170                                                         
         MVC   ROUERRV,=AL2(AE$NARRQ)                                           
         GOTOR SAVERR,DMCB,ROUERRV,0,QI_ITM#                                    
         J     UITM0170                                                         
*   some narrative                                                              
UITM0150 DS    0H                  Check comments fit into elements             
         LA    RF,L'CIDNARR                                                     
         LA    RE,L'STCXNARR                                                    
         CR    RE,RF                                                            
         JNL   *+6                                                              
         LR    RF,RE                                                            
         CLM   RF,1,QI_ONARL                                                    
         JL    UITM0155                                                         
         CLM   RF,1,QI_NARL                                                     
         JNL   UITM0170                                                         
*                                                                               
UITM0155 MVC   ROUERRV,=AL2(AE$FLDTL)                                           
         GOTOR SAVERR,DMCB,ROUERRV,(L'AC@NRTV,AC@NRTV),QI_ITM#                  
*                                                                               
UITM0170 GOTOR VALDSC,QI_DISC                                                   
*                                                                               
*                                                                               
UITM0190 GOTOR NEWCLM              Add record to TSAR buffer                    
         JNH   UEXIT                                                            
         GOTOR SAVERR,DMCB,ROUERRV,0,QI_ITM#                                    
         J     UEXIT                                                            
         EJECT                                                                  
***********************************************************************         
* Process extra data record                                           *         
***********************************************************************         
UXDT     TM    TWAMODE,TWAMEDP     Exit on previous fatal error                 
         JNZ   UEXIT               (No further processing)                      
         GOTOR CLRCLD              Clear claim record                           
                                                                                
         CLI   QH_STAT,QH_DELQ     Test deleting a claim                        
         JE    UEXIT                                                            
                                                                                
         TM    HD_IND,HD_INOPR     Test previous claim existed                  
         JNZ   UXDT0010                                                         
         CLI   QI_CHNGE,C'Y'       Test changing a line                         
         JE    UXDT0010                                                         
         GOTOR CPYONE              No - copy from old buffer                    
         J     UEXIT                                                            
                                                                                
UXDT0010 GOTOR DOTSAR,QX_TSAR      Use TSAR record if passed                    
         JE    UEXIT               (adds CL_D record if true)                   
                                                                                
UXDT0160 GOTOR NEWCLM              Add record to TSAR buffer                    
         JNH   UEXIT                                                            
         GOTOR SAVERR,DMCB,ROUERRV,0,QI_ITM#                                    
         J     UEXIT                                                            
         EJECT                                                                  
***********************************************************************         
* Process trailer record                                              *         
***********************************************************************         
UTRL     TM    TWAMODE,TWAMEDP     Exit on previous fatal error                 
         JNZ   UEXIT               (no further processing)                      
         CLI   RUNMODE,RVALREQQ    Test 'Validate request' mode                 
         JE    UTRL0005                                                         
                                                                                
         ICM   RE,15,QT_ATRLR      Test trailer values passed                   
         JNZ   *+6                                                              
         DC    H'0'                                                             
         LA    R0,TR_VALS                                                       
         LHI   R1,TR_VALSL                                                      
         AHI   RE,LW_LN1Q                                                       
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         GOTOR BLDLOK,HD_CLM#      Build LOCKET key in WORK                     
         GOTOR DMGRITRN,DMCB,$LOKREC,WORK                                       
                                                                                
UTRL0005 ZAP   HD_ITCNT,PZERO      Zero count                                   
         ZAP   TR_TAMT,PZERO       Zero total claim amount                      
         LH    RF,HD_INDX                                                       
         CLI   QH_ACTN,QH_APRQ     Approval only?                               
         JNE   UTRL0020            No - must be change                          
         CLC   CCTPID,HD_LMPID     Yes - is it manager approval?                
         JE    UTRL0020            Yes - index must increment                   
         CLI   QH_BKUP,C'Y'        Back up approver possible?                   
         JNE   UTRL0030            No                                           
         LA    R0,HD_BAMAX         Max Backup Approvers                         
         LA    R1,HD_LMBUP         Search backups approvers for match           
UTRL0010 OC    0(L'PIDNO,R1),0(R1) Any Pids left in table?                      
         JZ    UTRL0030                                                         
         CLC   CCTPID,0(R1)        Is line manager a back up approver?          
         JE    UTRL0020                                                         
         LA    R1,L'PIDNO(R1)                                                   
         JCT   R0,UTRL0010                                                      
         J     UTRL0030                                                         
                                                                                
UTRL0020 AHI   RF,1                Increment index number for change            
UTRL0030 STH   RF,HD_INDXN         Set new audit index number                   
                                                                                
         CLI   QH_STAT,QH_DELQ     Test deleting expense claim                  
         JE    UTRL0040                                                         
         TM    HD_IND,HD_INOPR     No previous claim existed                    
         JNZ   UTRL0060                                                         
         CLI   QH_ACTN,QH_APRQ     Approval only?                               
         JNE   UTRL0060            No                                           
                                                                                
UTRL0040 GOTOR CPYALL              Copy claim itm buffer 2 to buffer 1          
                                                                                
UTRL0060 LAY   R4,GENAREA          Point to status element stack                
         MVI   0(R4),0             Set as empty                                 
                                                                                
UTRL0070 TM    TWAMODE,TWAMERP+TWAMEDP                                          
         JNZ   UEXIT                                                            
         CLI   QH_STAT,QH_DELQ     Test deleting expense claim                  
         JE    UTRL0075                                                         
         GOTOR DOSTAT              Create status elements                       
         LAY   R4,GENAREA          Point to status element stack                
         CLI   0(R4),0             Have we made any changes                     
         J     UTRL0075                                                         
         MVC   ROUERRV,=AL2(AE$NTGUP)                                           
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
         J     UEXIT                                                            
                                                                                
                                                                                
UTRL0075 CLI   RUNMODE,RVALREQQ    Test 'Validate request' mode                 
         JNE   UTRL0090                                                         
                                                                                
* Validate old buffer records if creating postings from it                      
                                                                                
         CLI   HD_ST1FR,EXCSCOMP   If previous status was posted                
         JNE   UTRL0080            we must be creating back out postngs         
         GOTOR VALOLD              Validate old buffer                          
                                                                                
UTRL0080 TM    TWAMODE,TWAMERP+TWAMEDP                                          
         JNZ   UEXIT                                                            
         J     UTRL0130                                                         
                                                                                
UTRL0090 GOTOR UPDCLM              update the claim records                     
                                                                                
UTRL0110 GOTOR CLMTRN              Send transactions and batches                
         TM    HD_PIND,HD_PBINI                                                 
         JZ    UTRL0115                                                         
         GOTOR CLOBAT              Close batch header record                    
UTRL0115 TM    HD_PIND,HD_PBINR                                                 
         JZ    UTRL0120                                                         
         GOTOR CLOBATR             Close batch header record                    
                                                                                
UTRL0120 TM    HD_IND,HD_INOPR     Test no previous claim existed               
         JZ    *+12                                                             
         CLI   QH_STAT,QH_DELQ     Test deleting claim                          
         JE    UTRL0130                                                         
                                                                                
                                                                                
         GOTOR UPDAUD              Update claim audit record                    
         JE    UTRL0130                                                         
         LAY   RE,BLOCK                                                         
         MVI   0(RE),ET_EOTQ       Clear error table                            
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
         J     UEXIT                                                            
AP       USING HD_LMAP,R2                                                       
UTRL0130 CLI   QH_BKUP,YESQ        Doing backup approval?                       
         JNE   UTRL0155                                                         
         LA    R2,HD_LMAP          Search backups approvers for match           
*                                                                               
UTRL0135 LA    R3,HD_LMBUP                                                      
         LA    R6,HD_BAMAX         Max Backup Approvers                         
*                                                                               
                                                                                
UTRL0140 OC    0(L'PIDNO,R3),0(R3) Any Pids left in table?                      
         JZ    UTRL0150                                                         
         CLC   CCTPID,0(R3)        Is line manager a back up approver?          
         JE    UTRL0145                                                         
         LA    R3,L'PIDNO(R3)                                                   
         JCT   R6,UTRL0140                                                      
         J     UTRL0150                                                         
                                                                                
UTRL0145 GOTOR SETAPP,HD_LMPID     Set approved by line manager                 
                                                                                
UTRL0150 LA    R2,HD_LMAPL(R2)                                                  
         JCT   R2,UTRL0135                                                      
         J     UTRL0160                                                         
                                                                                
UTRL0155 GOTOR SETAPP,CCTPID       Update apptab approval status                
                                                                                
UTRL0160 CLI   RUNMODE,RVALREQQ    Test 'Validate request' mode                 
         JNE   UEXIT                                                            
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),                     +        
               ('LIOTLRQ',64),('LQ_TSINQ',TR_VALS),TR_VALSL                     
         GOTOR (RF),(R1),('LIOAPUT',LP_ALIOB),('LIOTGEL',0),RETDATEL            
         J     UEXIT                                                            
         EJECT                                                                  
***********************************************************************         
* Process add account etc to limit list record                        *         
***********************************************************************         
         SPACE 1                                                                
         USING TYPTABD,R2                                                       
UALL     CLI   RUNMODE,RVALREQQ    Test 'Validate request' mode                 
         JNE   EXITY                                                            
*                                                                               
         LA    R0,HD_VALS          Initialise header values                     
         LHI   R1,HD_VALSL                                                      
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         OC    QL_VAL,SPACES       Value received?                              
         CLC   QL_VAL,SPACES                                                    
         JH    UPDAL02                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$MISIF)                                           
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
         J     UPDALEX                                                          
                                                                                
UPDAL02  LA    R2,TYPTAB           Look for limit list type                     
                                                                                
UPDAL04  CLI   0(R2),FF                                                         
         JE    UPDAL06                                                          
         CLC   QL_TYPE,TYPCTYP                                                  
         JE    UPDAL08                                                          
         AHI   R2,TYPTABLQ                                                      
         J     UPDAL04                                                          
                                                                                
UPDAL06  MVC   ROUERRV,=AL2(AE$PARNR)                                           
         GOTOR SAVERR,DMCB,ROUERRV,(L'QL_TYPE,QL_TYPE),0                        
         J     UPDALEX                                                          
                                                                                
UPDAL08  MVC   HD_LTYPE,TYPETYP    Set list element type                        
         ST    R2,ACURTYP          Store A(current entry in table)              
                                                                                
         OC    CCTPID,CCTPID                                                    
         JNZ   UPDAL10                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$NCPID)                                           
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
         J     UPDALEX                                                          
                                                                                
UPDAL10  GOTOR GETSJOF                                                          
         JE    UPDAL11                                                          
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
         J     UPDALEX                                                          
*                                                                               
UPDAL11  MVI   HD_MODS,0           Establish HD_MODS                            
         CLI   QL_EST,C'Y'                                                      
         JNE   *+8                                                              
         OI    HD_MODS,LIDLESTM                                                 
         CLI   QL_EXP,C'Y'                                                      
         JNE   *+8                                                              
         OI    HD_MODS,LIDLEXPN                                                 
         CLI   QL_INV,C'Y'                                                      
         JNE   *+8                                                              
         OI    HD_MODS,LIDLINVC                                                 
         CLI   QL_JOB,C'Y'                                                      
         JNE   *+8                                                              
         OI    HD_MODS,LIDLJOBS                                                 
         CLI   QL_ORD,C'Y'                                                      
         JNE   *+8                                                              
         OI    HD_MODS,LIDLORDS                                                 
         CLI   QL_RES,C'Y'                                                      
         JNE   *+8                                                              
         OI    HD_MODS,LIDLRESC                                                 
         CLI   QL_TIME,C'Y'                                                     
         JNE   *+8                                                              
         OI    HD_MODS,LIDLTIME                                                 
         CLI   QL_REP,C'Y'                                                      
         JNE   *+8                                                              
         OI    HD_MODS,LIDLREPT                                                 
*                                                                               
         GOTOR BUFLID              Read all limlist records and                 
         JE    UPDAL12             put to buffer                                
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
         J     UPDALEX                                                          
*                                  Extract ledger details                       
UPDAL12  LA    RF,LEDGERSJ                                                      
         CLI   QL_TYPE,QL_CPJQ     SJ account                                   
         JE    UPDAL14                                                          
         LA    RF,LEDGER1R                                                      
         CLI   QL_TYPE,QL_1RACQ    1R account                                   
         JE    UPDAL14                                                          
         LA    RF,QL_VAL           Read ledger lengths                          
         CLI   QL_TYPE,QL_EXACQ    Expense account                              
         JE    UPDAL14                                                          
         CLI   QL_TYPE,QL_SUPQ     Supplier account                             
         JNE   UPDAL16                                                          
*                                                                               
UPDAL14  MVC   LDGAUL(L'ACTKUNT+L'ACTKLDG),0(RF)                                
         GOTOR (#SETLDG,ASETLDG)                                                
*                                  Byte2 = length of account to compare         
UPDAL16  GOTOR CHKHEX              Check any higher level accounts              
         JE    UPDAL18                                                          
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
         J     UPDALEX                                                          
*                                                                               
UPDAL18  GOTOR CHKLEX              Check any lower level accounts               
         JE    UPDAL20                                                          
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
         J     UPDALEX                                                          
*                                                                               
UPDAL20  GOTOR BLDLID              Check if entry exists if not add             
         GOTOR UPDLID              Read back lidelds and update                 
                                                                                
UPDALLX  XC    QL_VAL(QL_DLNQ),QL_VAL                                           
         J     UEXIT                                                            
                                                                                
UPDALEX  XC    QL_VAL(QL_DLNQ),QL_VAL                                           
         TM    TWAMODE,TWAMUWD     unwind required?                             
         JZ    UEXIT                                                            
         NI    TWAMODE,FF-TWAMUWD                                               
         OI    GIND1,GIUNWIND      DDLINK will unwind/abend                     
         J     UEXIT                                                            
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* Exit handling for all upload records                                *         
***********************************************************************         
                                                                                
UFATAL   OI    TWAMODE,TWAMEDP     Set fatal error on                           
                                                                                
UEXIT    TM    TWAMODE,TWAMERP+TWAMEDP                                          
         JNZ   UEXIT40                                                          
         TM    TWAMODE,TWAMPER     Any previous error                           
         JZ    UEXIT02             No                                           
         GOTOR UNLOCK              Yes - unlock record locked this time         
UEXIT02  TM    LP_FLAG,LP_FOFFL    Test off-line                                
         JNZ   UEXIT90             Yes - nothing more to do                     
         CLI   RECTYPE,RECTALLQ       or add-to-limlist                         
         JE    UEXIT20                                                          
         CLI   RECTYPE,RECTTRLQ    Test just processed trailer record           
         JNE   UEXIT90                                                          
         TM    LP_FLAG,LP_FDRFT    Only send reply in 'draft' mode              
         JZ    UEXIT90                                                          
* Claim OK response                                                             
         SR    R0,R0                                                            
         ICM   R0,3,LP_QMAPN       Build download map element                   
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),('LIOTMAP',(R0))              
         GOTOR (RF),(R1),('LIOAPUT',LP_ALIOB),                         +        
               ('LIOTRAW',D#TOKEN),('LD_CHARQ',QH_TOKEN),(L'QH_TOKEN,0)         
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),                     +        
               ('LIOTRAW',D#CLM),('LD_CHARQ',HD_CLM#),(L'HD_CLM#,0)             
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),                     +        
               ('LIOTRAW',D#CLMTY),('LD_CHARQ',HD_CLMTY),(L'HD_CLMTY,0)         
         GOTOR VHEXOUT,DMCB,HD_INDXN,WORK,L'HD_INDXN                            
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),                     +        
               ('LIOTRAW',D#IDN),('LD_CHARQ',WORK),(L'HD_INDXN*2,0)             
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),                     +        
               ('LIOTRAW',D#BAT),('LD_CHARQ',QH_BREF),(L'QH_BREF,0)             
                                                                                
         CLI   TR_ST1NW,0          Set claim status and send                    
         JNE   *+8                                                              
         MVI   BYTE1,CL#PROGR      'In progress'                                
         TM    TR_ST1NW,EXCSREJE                                                
         JZ    *+8                                                              
         MVI   BYTE1,CL#REJEC      'Rejected'                                   
         TM    TR_ST1NW,EXCSSUBM                                                
         JZ    *+8                                                              
         MVI   BYTE1,CL#SUBMT      'Submitted'                                  
         TM    TR_ST1NW,EXCSPAPP                                                
         JZ    *+8                                                              
         MVI   BYTE1,CL#PAAPR      'Partly approved'                            
                                                                                
         TM    TR_ST1NW,EXCSFNTA                                                
         JZ    *+8                                                              
         MVI   BYTE1,CL#APPRO      'Fully approved'                             
                                                                                
         TM    TR_ST1NW,EXCSCOMP                                                
         JZ    *+8                                                              
         MVI   BYTE1,CL#COMP       'Complete and posted'                        
                                                                                
         TM    TR_ST1NW,EXCSLOGD                                                
         JZ    *+8                                                              
         MVI   BYTE1,CL#DELET      'Deleted'                                    
                                                                                
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),                     +        
               ('LIOTRAW',D#STA),('LD_CHARQ',BYTE1),(L'BYTE1,0)                 
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),                     +        
               ('LIOTRAW',D#EML),('LD_CHARQ',HD_EMLCL),(L'HD_EMLCL,0)           
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),                     +        
               ('LIOTRAW',D#EMLR),('LD_CHARQ',HD_EMLRS),(L'HD_EMLRS,0)          
                                                                                
         SR    R0,R0                                                            
         ICM   R0,3,LP_QMAPN       Send approver run sequence                   
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),('LIOTMAP',(R0))              
                                                                                
         GOTOR (RF),(R1),('LIOAPUT',LP_ALIOB),('LIOTRUN',A#TEAP)                
                                                                                
         MVI   BYTE1,C'1'          = 'Expenses'                                 
         GOTOR (RF),(R1),('LIOAPUT',LP_ALIOB),('LIOTRAW',D#CAE),       +        
               ('LD_CHARQ',BYTE1),(L'BYTE1,0)                                   
                                                                                
         TM    HD_IND,HD_NOEM      Sending any emails?                          
         JZ    UEXIT10             Yes                                          
         MVI   BYTE1,C'N'          No emails                                    
         GOTOR (RF),(R1),('LIOAPUT',LP_ALIOB),('LIOTRAW',D#CAEML),     +        
               ('LD_CHARQ',BYTE1),(L'BYTE1,0)                                   
                                                                                
UEXIT10  GOTOR (RF),(R1),('LIOAPUT',LP_ALIOB),('LIOTERU',0),0,0                 
         J     UEXIT90                                                          
                                                                                
* Add-to-Limlist OK response.                                                   
                                                                                
UEXIT20  SR    R0,R0                                                            
         ICM   R0,3,LP_QMAPN       Build download map element                   
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),('LIOTMAP',(R0))              
         J     UEXIT90                                                          
                                                                                
* error handling                                                                
                                                                                
UEXIT40  GOTOR UNLOCK              Unlock everything I locked so far            
         CLI   RECTYPE,RECTTRLQ    Test just processed trailer record           
         JNE   UEXIT45                                                          
         NI    TWAMODE,FF-(TWAMERP+TWAMEDP)  remove error this time             
         OI    TWAMODE,TWAMPER     set previous error                           
UEXIT45  TM    LP_FLAG,LP_FOFFL    Test off-line                                
         JZ    *+6                                                              
         DC    H'0'                Die to unwind any updates                    
                                                                                
UEXIT50  LAY   R2,BLOCK            Send errors                                  
         USING ET_D,R2             R2=A(Error table)                            
UEXIT55  SR    R0,R0                                                            
         ICM   R0,3,LP_QMAPN       Build download map element                   
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),('LIOTMAP',(R0))              
         CLI   RECTYPE,RECTALLQ    Test add-to-limlist                          
         JE    UEXIT70                                                          
         CLI   RECTYPE,RECTTRLQ    Test trailer record                          
         JE    UEXIT65                                                          
         CLI   RECTYPE,RECTHDRQ    Test header record                           
         JE    UEXIT60                                                          
         GOTOR (RF),(R1),('LIOAPUT',LP_ALIOB),                         +        
               ('LIOTRAW',D#TOKEN),('LD_CHARQ',QX_TOKEN),(L'QX_TOKEN,0)         
         J     UEXIT70                                                          
UEXIT60  GOTOR (RF),(R1),('LIOAPUT',LP_ALIOB),                         +        
               ('LIOTRAW',D#TOKEN),('LD_CHARQ',QH_TOKEN),(L'QH_TOKEN,0)         
         J     UEXIT70                                                          
UEXIT65  GOTOR (RF),(R1),('LIOAPUT',LP_ALIOB),                         +        
               ('LIOTRAW',D#TOKEN),('LD_CHARQ',QT_TOKEN),(L'QT_TOKEN,0)         
                                                                                
UEXIT70  LA    R1,DMCB                                                          
         USING GETTXTD,R1          Build error text string in ELEMENT           
         CLI   ET_D,ET_EOTQ        Test end of error table                      
         JE    UEXIT85                                                          
         LLC   RF,ERRCNT           Check if max no. of errors                   
         CHI   RF,ERRMAX                                                        
         JNL   UEXIT85                                                          
         XC    GTBLOCK,GTBLOCK     Resolve error text                           
         MVI   GTMAXL,80                                                        
         MVC   GTMSGNO,ET_ERRNO                                                 
         LA    R0,ELEMENT                                                       
         STCM  R0,7,GTAOUT                                                      
         MVI   GTMTYP,GTMERR                                                    
         MVI   GT1INDS,GT1NOREF+GT1OWRK                                         
         LLC   R0,ET_LN                                                         
         SHI   R0,ET_LN1Q                                                       
         LTR   R0,R0                                                            
         JZ    UEXIT75                                                          
         STC   R0,GTLTXT           Set length of extra text                     
         LA    R0,ET_EXTRA                                                      
         STCM  R0,7,GTATXT         Set A(Extra text)                            
UEXIT75  GOTOR VGETTXT,(R1)                                                     
         LLC   R0,4(R1)            Length of text just added                    
         GOTOR AALINKIO,(R1),('LIOAPUT',LP_ALIOB),                     +        
               ('LIOTRAW',D#ERR),('LD_CHARQ',ELEMENT),((R0),0)                  
         OC    ET_ROWNM,ET_ROWNM                                                
         JZ    UEXIT80                                                          
         GOTOR AALINKIO,(R1),('LIOAPUT',LP_ALIOB),                     +        
               ('LIOTRAW',D#ERROW),('LD_LBINQ',ET_ROWNM),(L'ET_ROWNM,0)         
UEXIT80  LLC   R0,ET_LN            Bump to next error table entry               
         AR    R2,R0                                                            
         LLC   RF,ERRCNT           Bump error counter                           
         AHI   RF,1                                                             
         STC   RF,ERRCNT                                                        
         J     UEXIT55                                                          
         DROP  R1,R2                                                            
                                                                                
UEXIT85  CLI   RUNMODE,RVALREQQ    Test 'Validate request' mode                 
         JE    EXITN                                                            
                                                                                
UEXIT90  J     EXITY               Exit back to DDLINK                          
         EJECT                                                                  
***********************************************************************         
* Handle 'Last for request' mode (only passed when running live)      *         
***********************************************************************         
                                                                                
EREQ     GOTOR GOATRN,0            Call GOATRN for last time                    
         GOTOR BUFREC,0            Flush pending updative I/Os                  
                                                                                
         TM    LP_FLAG,LP_FOFFL    Test off-line                                
         JNZ   EREQ02              Yes - using SORTER not FACWRK                
         L     R1,WRKBLKR          Copy WRKR parameters                         
         MVC   PARM(WRKINDX-WRKIPARM),WRKIPARM-WRKIOD(R1)                       
         GOTOR DATAMGR,PARM,CLOSE  Close the FACWRK file                        
                                                                                
EREQ02   OI    LP_FLAG,LP_FFWRK    Set FACWRK file built                        
         MVC   VDATAMGR,DATAMGR    Point to real DATAMGR                        
         MVC   ACOMFACS,LP_ACOM    Point to real COMFACS                        
                                                                                
***********************************************************************         
* If we are running off-line with updative (global) files re-open the *         
* FACWRK recovery file and read the header record,  call  DATAMGR to  *         
* checkpoint recovery (COMMIT), call SRUPD60 to update the files and  *         
* then checkpoint recovery again to clear the global lock table.      *         
***********************************************************************         
                                                                                
         TM    LP_FLAG,LP_FOFFL    Test off-line                                
         JZ    EXITY                                                            
         CLI   RECTYPE,RECTALLQ    Test Account add to limit list rec           
         JE    EXITY                                                            
         TM    RUNINDS,RUNIPUTF    no SORTER Puts, nothing to post              
         JZ    EXITY                                                            
         TM    LP_OFLG1,LP_OFDFT   Test 'draft' upload                          
         JNZ   EREQ04                                                           
         TM    LP_INDS,LP_IGLOB    Test global (updative) file                  
         JZ    EXITY                                                            
                                                                                
EREQ04   GOTOR DATAMGR,DMCB,DMCOMMIT,0                                          
                                                                                
         LA    RE,TSARPASS         Pass A(TSARPASS) in LP_ABLK3                 
         LA    RF,TSARRECS         Pass A(TSARRECS) in LP_ABLK4                 
         LA    R0,TSAROLDI         Pass A(TSAROLDI) in LP_ABLK5                 
         LA    R1,TSARNEWI         Pass A(TSARNEWI) in LP_ABLK6                 
         LA    R2,TSAROBUF         Pass A(TSAROBUF) in LP_ABLK7                 
         LA    R3,VSORTER          Pass A(VSORTER) in LP_ABLK8                  
         STM   RE,R3,LP_ABLK3                                                   
         GOTOR ASRUPD60,DMCB,('FF',LP_D),('00',PARM),AIO1                       
                                                                                
         GOTOR DATAMGR,DMCB,DMCOMMIT,0                                          
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Get claim number (for draft or live)                                *         
***********************************************************************         
                                                                                
GETCLN   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GETCLN*'                                                      
                                                                                
         MVI   BYTE1,0                                                          
         MVC   HD_CLM#,QH_NUM                                                   
         MVC   HD_CLMTY,QH_TYPE                                                 
         MVC   ROUERRV,=AL2(AE$NCNAL)                                           
                                                                                
         CLI   HD_ST1FR,EXCSLOGD   Was claim previously deleted                 
         JE    *+12                Yes - should be draft                        
         CLI   HD_ST1FR,0          Any previous status                          
         JNE   EXITY               Yes - number already exists                  
         CLI   HD_CLMTY,EXNPTLQ    Have we already got a live number            
         JE    EXITY               Yes                                          
         CLI   QH_STAT,QH_SUBMQ    Are we now submitting                        
         JNE   *+12                                                             
         MVI   HD_CLMTY,EXNPTLQ    Set to get live number                       
         J     GETCLN02                                                         
                                                                                
         OC    QH_NUM,QH_NUM       Have we already got a draft number           
         JNZ   EXITY               Yes - nothing to do                          
         MVI   HD_CLMTY,EXNPTDQ    Set to get draft number                      
         TM    CPXSTAT6,CPX2LAEI   WPP workflow - No draft numbers              
         JZ    *+8                                                              
         MVI   HD_CLMTY,EXNPTLQ    Set to get live number                       
         MVC   QH_TYPE,HD_CLMTY                                                 
                                                                                
GETCLN02 CLC   HD_OFFC,SPACES      is office supplied?                          
         JNH   GETCLN32                                                         
         CLI   CPYLN,CPYLN4Q                                                    
         JL    GETCLN32                                                         
         TM    CPYSTATB,CPYSCNOB                                                
         JZ    GETCLN32                                                         
                                                                                
         USING OGRRECD,R2                                                       
         LA    R2,IOKEY            look for number on office                    
         XC    OGRKEY,OGRKEY                                                    
         MVI   OGRKTYP,OGRKTYPQ                                                 
         MVI   OGRKSUB,OGRKOFFQ                                                 
         MVC   OGRKCPY,CUXCPY                                                   
         MVC   OGRKUNT(2),PRODUL                                                
         MVC   OGRKOFC,HD_OFFC                                                  
                                                                                
         L     R1,=AL4(IORDUP+IODIR+IO2)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   GETCLN22                                                         
                                                                                
         L     R1,=AL4(IOGETRUP+IOMST+IO2)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   GETCLN22                                                         
                                                                                
         USING FFTELD,R3                                                        
         L     R2,AIO2                                                          
         LA    R3,OGRRFST                                                       
         XR    R0,R0                                                            
GETCLN04 CLI   FFTEL,0                                                          
         JE    GETCLN22                                                         
         CLI   FFTEL,FFTELQ                                                     
         JNE   GETCLN20                                                         
         CLI   FFTTYPE,FFTTDCLN                                                 
         JNE   GETCLN06                                                         
         CLI   HD_CLMTY,EXNPTDQ                                                 
         JNE   GETCLN20                                                         
         MVC   HD_CLM#,FFTDATA                                                  
         MVI   BYTE1,C'O'                                                       
         J     GETCLN40                                                         
GETCLN06 CLI   FFTTYPE,FFTTLCLN                                                 
         JNE   GETCLN20                                                         
         CLI   HD_CLMTY,EXNPTLQ                                                 
         JNE   GETCLN20                                                         
         MVC   HD_CLM#,FFTDATA                                                  
         MVI   BYTE1,C'O'                                                       
         J     GETCLN40                                                         
GETCLN20 IC    R0,FFTLN                                                         
         AR    R3,R0                                                            
         J     GETCLN04                                                         
                                                                                
GETCLN22 MVC   ROUERRV,=AL2(AE$CLMOF)                                           
         J     GETCLNN                                                          
                                                                                
         USING CPYRECD,R2                                                       
GETCLN32 LA    R2,IOKEY            look for number on agency                    
         MVC   CPYKEY,SPACES                                                    
         MVC   CPYKCPY,CUXCPY                                                   
                                                                                
         L     R1,=AL4(IORDUP+IODIR+IO2)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   GETCLNN                                                          
                                                                                
         L     R1,=AL4(IOGETRUP+IOMST+IO2)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   GETCLNN                                                          
                                                                                
         USING FFTELD,R3                                                        
         L     R2,AIO2                                                          
         LA    R3,CPYRFST                                                       
         XR    R0,R0                                                            
GETCLN34 CLI   FFTEL,0                                                          
         JE    GETCLNN                                                          
         CLI   FFTEL,FFTELQ                                                     
         JNE   GETCLN38                                                         
         CLI   FFTTYPE,FFTTDCLN                                                 
         JNE   GETCLN36                                                         
         CLI   HD_CLMTY,EXNPTDQ                                                 
         JNE   GETCLN38                                                         
         MVC   HD_CLM#,FFTDATA                                                  
         MVI   BYTE1,C'A'                                                       
         J     GETCLN40                                                         
GETCLN36 CLI   FFTTYPE,FFTTLCLN                                                 
         JNE   GETCLN38                                                         
         CLI   HD_CLMTY,EXNPTLQ                                                 
         JNE   GETCLN38                                                         
         MVC   HD_CLM#,FFTDATA                                                  
         MVI   BYTE1,C'A'                                                       
         J     GETCLN40                                                         
                                                                                
GETCLN38 IC    R0,FFTLN                                                         
         AR    R3,R0                                                            
         J     GETCLN34                                                         
                                                                                
GETCLN40 CLI   BYTE1,C'O'                                                       
         JNE   GETCLN44                                                         
         MVC   HALF1,HD_CLM#                                                    
         XR    R1,R1                                                            
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    *+8                                                              
         AHI   R1,1                                                             
         BASR  RE,0                                                             
GETCLN42 MVC   HD_CLM#(0),=C'00'                                                
         EX    R1,0(RE)                                                         
                                                                                
GETCLN44 PACK  DUB1,HD_CLM#                                                     
         ZAP   DUB1,DUB1                                                        
         AP    DUB1,PONE                                                        
         UNPK  HD_CLM#,DUB1                                                     
         OI    HD_CLM#+L'HD_CLM#-1,X'F0'                                        
         CLI   BYTE1,C'O'                                                       
         JNE   GETCLN48                                                         
         BASR  RE,0                                                             
GETCLN46 MVC   HD_CLM#(0),HALF1                                                 
         EX    R1,0(RE)                                                         
                                                                                
GETCLN48 MVC   FFTDATA(6),HD_CLM#  save new # and write back record             
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO2'                           
         JE    GETCLN50                                                         
         DC    H'0'                                                             
                                                                                
         USING EXNPASD,R2                                                       
GETCLN50 LA    R2,IOKEY                                                         
         XC    EXNPAS,EXNPAS                                                    
         MVI   EXNPTYP,EXNPTYPQ                                                 
         MVI   EXNPSUB,EXNPSUBQ                                                 
         MVC   EXNPCPY,CUXCPY                                                   
         MVC   EXNPTYPE,HD_CLMTY                                                
         MVC   EXNPNUM,HD_CLM#                                                  
                                                                                
         L     R1,=AL4(IORDUP+IODIR+IO2)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    GETCLN52                                                         
         CLI   IOERR,IOEDEL                                                     
         JE    GETCLN52                                                         
         J     GETCLNY                                                          
                                                                                
GETCLN52 MVC   ROUERRV,=AL2(AE$RECAE)                                           
GETCLNN  J     EXITN               no number found or duplicate                 
                                                                                
GETCLNY  J     EXITY               number found                                 
         DROP  R2,R3                                                            
***********************************************************************         
* Read all limit list records and buffer all the lidelds              *         
***********************************************************************         
         USING LLSRECD,R2                                                       
         USING LIDELD,R3                                                        
         USING BSWORKD,RC                                                       
         USING OB_D,BSRBAREA                                                    
BUFLID   NTR1  LABEL=NO,WORK=(RC,BSWORKL)                                       
         J     *+12                                                             
         DC    C'*BUFLID*'                                                      
*                                                                               
         GOTOR CLRWRK,BSWORKL      Clear work area                              
*                                                                               
         MVI   BYTE1,0             init flags                                   
         MVI   BYTE2,FF                                                         
         LA    R2,IOKEY            build LimList key                            
         XC    LLSKEY,LLSKEY                                                    
         MVI   LLSKTYP,LLSKTYPQ                                                 
         MVI   LLSKSUB,LLSKSUBQ                                                 
         MVC   LLSKCPY,CUXCPY                                                   
         MVC   LLSKPIDB,CCTPID                                                  
         MVC   CSVKEY1,LLSKEY      read and lock LimitList record               
                                                                                
         L     R1,=AL4(IOHIUP+IODIR+IO2)                                        
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         CLC   CSVKEY1(LLSKGRP-LLSRECD),LLSKEY                                  
         JE    BUFLID02                                                         
                                                                                
         MVC   ROUERRV,=AL2(AE$RECNF)    no LimList record found                
         J     EXITN                                                            
                                                                                
BUFLID02 CLI   QL_SEC,YESQ         security for groups?                         
         JE    BUFLID06                                                         
                                                                                
         CLC   LLSKGRP,SPACES      is it a group (passive)?                     
         JNH   BUFLID06                                                         
                                                                                
         MVC   ROUERRV,=AL2(AE$ANACR)                                           
         J     EXITN                                                            
                                                                                
BUFLID04 LA    R2,IOKEY                                                         
         L     R1,=AL4(IOSQ+IODIR+IO2)                                          
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   *+2                                                              
                                                                                
         CLC   CSVKEY1(LLSKGRP-LLSRECD),LLSKEY                                  
         JNE   BUFLIDX                                                          
                                                                                
BUFLID06 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
         L     R2,AIO2                                                          
*        MVC   CSVKEY1,LLSKEY      save real key (from DA record)               
         LA    R3,LLSRFST                                                       
                                                                                
BUFLID08 CLI   LIDEL,0                                                          
         JE    BUFLID04            Read next limit list record                  
         CLI   LIDEL,LIDELQ                                                     
         JNE   BUFLID10                                                         
         CLI   LIDLN,LIDLNDQ       Ignore short elements                        
         JNH   BUFLID10                                                         
         CLI   LIDTYPE,LIDTPID     Ignore as for group records                  
         JNE   BUFLID12                                                         
BUFLID10 LLC   R0,LIDLN                                                         
         AR    R3,R0                                                            
         J     BUFLID08                                                         
                                                                                
EN       USING LIDDATA,R6                                                       
BUFLID12 LA    R6,LIDDATA                                                       
         LR    R5,R3                                                            
         LLC   RF,LIDLN                                                         
         AR    R5,RF                                                            
*                                                                               
         LA    R4,TYPTAB           Look for limit list type                     
*                                                                               
         USING TYPTABD,R4                                                       
BUFLID14 CLI   0(R4),FF                                                         
         JE    *+2                 Invalid type                                 
         CLC   TYPETYP,LIDTYPE                                                  
         JE    BUFLID16                                                         
         AHI   R4,TYPTABLQ                                                      
         J     BUFLID14                                                         
*                                                                               
BUFLID16 XC    OB_D(OB_LNQ),OB_D                                                
         MVC   OB_TYPE,TYPCTYP                                                  
         MVC   OB_APPL1,EN.LIDLAPPL                                             
         MVC   OB_APPL2,EN.LIDLAPP2                                             
*                                                                               
         LLC   RF,TYPEDIS                                                       
         LA    RF,EN.LIDDATA(RF)                                                
         LLC   R1,TYPBDIS                                                       
         LA    R1,OB_D(R1)                                                      
         LLC   RE,TYPBLEN                                                       
         BCTR  RE,0                                                             
         BASR  R7,0                                                             
         MVC   0(0,R1),0(RF)                                                    
         EX    RE,0(R7)                                                         
*                                                                               
         CLI   TYPISOF,YESQ        Any office code?                             
         JNE   BUFLID18                                                         
         LLC   RF,TYPOEDI                                                       
         LA    RF,EN.LIDDATA(RF)                                                
         LLC   R1,TYPOBDI          Get displacement in buffer                   
         LA    R1,OB_D(R1)                                                      
         MVC   0(L'LIDLOFF,R1),0(RF)                                            
*                                                                               
BUFLID18 OC    OB_KEY,SPACES                                                    
         GOTOR ADDBUF,OB_D                                                      
         LLC   RF,LIDITLN          Bump to next entry                           
         AR    R6,RF                                                            
         CR    R6,R5                                                            
         JL    BUFLID16                                                         
         J     BUFLID10                                                         
*                                                                               
BUFLIDX  J     EXITY                                                            
*                                                                               
BSWORKD  DSECT                     ** VALSUP local w/s **                       
BSRBAREA DS    XL(OB_LNQ)                                                       
BSWORKL  EQU   *-BSWORKD                                                        
SVRDEF   CSECT                                                                  
         DROP  EN,R2,R3,R4                                                      
         EJECT                                                                  
***********************************************************************         
* Read to see if new entry already exists if not add it               *         
***********************************************************************         
         SPACE 1                                                                
         USING BLDWRKD,RC                                                       
         USING OB_D,BLRBAREA                                                    
         USING TYPTABD,R2                                                       
T        USING TSARD,TSAROBUF                                                   
BLDLID   NTR1  LABEL=NO,WORK=(RC,BLDWRKL)                                       
         J     *+12                                                             
         DC    C'*BLDLID*'                                                      
*                                                                               
         GOTOR CLRWRK,BLDWRKL      Clear work area                              
*                                                                               
         L     R2,ACURTYP                                                       
         LLC   RF,TYPBDIS                                                       
         LLC   RE,TYPBLEN                                                       
         LA    RF,OB_D(RF)                                                      
         BCTR  RE,0                                                             
         BASR  R7,0                                                             
         MVC   0(0,RF),QL_VAL      Insert into key for read                     
         EX    RE,0(R7)                                                         
         MVC   OB_TYPE,QL_TYPE                                                  
         OC    OB_KEY,SPACES                                                    
         MVI   T.TSACTN,TSARDH     Set action to 'Read High'                    
         LA    R0,OB_D                                                          
         ST    R0,T.TSAREC                                                      
         J     *+8                                                              
*                                                                               
BLDLID02 MVI   T.TSACTN,TSANXT     Read next record                             
         GOTOR VTSAR,T.TSARD                                                    
         TM    T.TSERRS,TSEEOF     Hit the end?                                 
         JZ    BLDLID06                                                         
*                                                                               
BLDLID04 XC    OB_D(OB_LNQ),OB_D                                                
         LLC   RF,TYPBDIS                                                       
         LLC   RE,TYPBLEN                                                       
         LA    RF,OB_D(RF)                                                      
         BCTR  RE,0                                                             
         BASR  R7,0                                                             
         MVC   0(0,RF),QL_VAL                                                   
         EX    RE,0(R7)                                                         
         MVC   OB_TYPE,QL_TYPE                                                  
         MVC   OB_APPL1,HD_MODS                                                 
         CLI   HD_MODS,0                                                        
         JNE   *+8                                                              
         MVI   OB_APPL1,X'FF'      Set all applications                         
         CLI   QL_TYPE,QL_CPJQ                                                  
         JNE   *+10                                                             
         MVC   OB_ACCO,CS_SJOFF                                                 
         OC    OB_KEY,SPACES                                                    
         GOTOR ADDBUF,OB_D                                                      
         J     BLDLIDX                                                          
*                                                                               
BLDLID06 LLC   RE,TYPBLEN                                                       
         LLC   RF,TYPBDIS                                                       
         LA    RF,OB_D(RF)                                                      
         BCTR  RE,0                                                             
         BASR  R7,0                                                             
         CLC   0(0,RF),QL_VAL                                                   
         EX    RE,0(R7)                                                         
         JNE   BLDLID02                                                         
*                                                                               
         OI    HD_IND,HD_VALAQ     If already exists update existing            
         OC    OB_APPL1,HD_MODS                                                 
         CLI   HD_MODS,0                                                        
         JNE   *+8                                                              
         MVI   OB_APPL1,X'FF'                                                   
         GOTOR WRIBUF,OB_D                                                      
         J     BLDLIDX                                                          
*                                  Build new element                            
BLDLIDX  J     EXITY                                                            
*                                                                               
BLDWRKD  DSECT                                                                  
BLRBAREA DS    XL(OB_LNQ)                                                       
BLDWRKL  EQU   *-BLDWRKD                                                        
SVRDEF   CSECT                                                                  
         EJECT                                                                  
         DROP  R2,T                                                             
***********************************************************************         
* Check for lower level entries in limlist and remove them            *         
* Note only for SJ, 1R, Expense account and Suppliers                 *         
***********************************************************************         
         SPACE 1                                                                
         USING CHLWRKD,RC                                                       
         USING OB_D,CHLBAREA                                                    
T        USING TSARD,TSAROBUF                                                   
CHKLEX   NTR1  LABEL=NO,WORK=(RC,CHLWRKL)                                       
         J     *+12                                                             
         DC    C'*CHKLEX*'                                                      
         GOTOR CLRWRK,CHLWRKL      Clear work area                              
         MVI   BYTE1,NOQ                                                        
         MVI   BYTE2,0                                                          
         CLI   QL_TYPE,QL_CPJQ     SJ account                                   
         JE    CHKL02                                                           
         CLI   QL_TYPE,QL_1RACQ    1R account                                   
         JE    CHKL02                                                           
         CLI   QL_TYPE,QL_EXACQ    Expense account                              
         JE    CHKL02                                                           
         CLI   QL_TYPE,QL_SUPQ     Supplier account                             
         JNE   CHKLEY                                                           
*                                                                               
CHKL02   LA    RF,QL_VAL                                                        
         LLC   R0,LDGAL1                                                        
         CHI   R0,L'ACTKACT        Same as max l'acc?  Nothing to do            
         JE    CHKLEY                                                           
         STC   R0,BYTE2                                                         
         AR    RF,R0                                                            
         CLI   0(RF),C' '          level 1 account?                             
         JNH   CHKL04                                                           
*                                                                               
         LA    RF,QL_VAL                                                        
         LLC   R0,LDGAL2                                                        
         STC   R0,BYTE2                                                         
         CHI   R0,L'ACTKACT        Same as max l'acc?  Nothing to do            
         JE    CHKLEY                                                           
         AR    RF,R0                                                            
         CLI   0(RF),C' '          level 2 account?                             
         JNH   CHKL04                                                           
*                                                                               
         LA    RF,QL_VAL                                                        
         LLC   R0,LDGAL3                                                        
         STC   R0,BYTE2                                                         
         CHI   R0,L'ACTKACT        Same as max l'acc?  Nothing to do            
         JE    CHKLEY                                                           
         AR    RF,R0                                                            
         CLI   0(RF),C' '          level 3 account?                             
         JNH   CHKL04                                                           
         J     CHKLEY              Must be lvl 4 acc nothing to do              
*                                                                               
CHKL04   MVC   OB_ACCC,QL_VAL                                                   
         MVC   OB_TYPE,QL_TYPE                                                  
         OC    OB_KEY,SPACES                                                    
         LA    R0,OB_D                                                          
         ST    R0,T.TSAREC                                                      
         MVI   T.TSACTN,TSARDH     Read next record                             
         J     *+8                                                              
*                                                                               
CHKL06   MVI   T.TSACTN,TSANXT     Read next record                             
         GOTOR VTSAR,T.TSARD                                                    
         TM    T.TSERRS,TSEEOF     Test end of buffer                           
         JNZ   CHKLEY                                                           
         LLC   RF,BYTE2                                                         
         BCTR  RF,0                                                             
         BASR  R7,0                                                             
         CLC   OB_ACCC(0),QL_VAL   Still reading same account?                  
         EX    RF,0(R7)                                                         
         JNE   CHKLEY                                                           
*                                                                               
CHKL08   CLC   QL_TYPE,OB_TYPE     Check still same type                        
         JNE   CHKLEY                                                           
         LLC   R0,BYTE2                                                         
         LA    RF,OB_ACCC                                                       
         AR    RF,R0                                                            
         CLI   0(RF),C' '          Check if lower level account                 
         JNH   CHKL06              if so don't add this entry                   
         J     CHKLEN                                                           
*                                                                               
CHKLEY   J     EXITY                                                            
*                                                                               
CHKLEN   MVC   ROUERRV,=AL2(AE$UNLOW)                                           
         J     EXITN                                                            
*                                                                               
CHLWRKD  DSECT                                                                  
CHLBAREA DS    XL(OB_LNQ)                                                       
CHLWRKL  EQU   *-CHLWRKD                                                        
SVRDEF   CSECT                                                                  
         EJECT                                                                  
         DROP  T                                                                
***********************************************************************         
* Check for any higher level entries and if so don't do any updates   *         
***********************************************************************         
         SPACE 1                                                                
         USING CHKWRKD,RC                                                       
         USING OB_D,CHKBAREA                                                    
T        USING TSARD,TSAROBUF                                                   
CHKHEX   NTR1  LABEL=NO,WORK=(RC,CHKWRKL)                                       
         J     *+12                                                             
         DC    C'*CHKHEX*'                                                      
         GOTOR CLRWRK,CHKWRKL      Clear work area                              
*                                                                               
         MVI   BYTE2,0                                                          
         CLI   QL_TYPE,QL_CPJQ     SJ account                                   
         JE    CHKH02                                                           
         CLI   QL_TYPE,QL_1RACQ    1R account                                   
         JE    CHKH02                                                           
         CLI   QL_TYPE,QL_EXACQ    Expense account                              
         JE    CHKH02                                                           
         CLI   QL_TYPE,QL_SUPQ     Supplier account                             
         JNE   CHKHOK                                                           
*                                                                               
CHKH02   LA    RF,QL_VAL                                                        
         LLC   R0,LDGAL1                                                        
         CHI   R0,L'ACTKACT        Same as max l'acc?  Nothing to do            
         JE    CHKHOK                                                           
         STC   R0,BYTE2                                                         
         AR    RF,R0                                                            
         CLI   0(RF),C' '          level 1 account?                             
         JNH   CHKH04                                                           
*                                                                               
         LA    RF,QL_VAL                                                        
         LLC   R0,LDGAL2                                                        
         STC   R0,BYTE2                                                         
         CHI   R0,L'ACTKACT                                                     
         JE    CHKH04                                                           
         AR    RF,R0                                                            
         CLI   0(RF),C' '          level 2 account?                             
         JNH   CHKH04                                                           
*                                                                               
         LA    RF,QL_VAL                                                        
         LLC   R0,LDGAL3                                                        
         STC   R0,BYTE2                                                         
         CHI   R0,L'ACTKACT                                                     
         JE    CHKH04                                                           
         CLI   0(RF),C' '          level 3 account?                             
         JNH   CHKH04                                                           
         LLC   R0,LDGAL4                                                        
         STC   R0,BYTE2            Must be level 4 account                      
*                                                                               
CHKH04   LLC   RF,LDGAL1           Use lowest level                             
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   OB_ACCC(0),QL_VAL                                                
         EX    RF,0(RE)                                                         
         MVC   OB_TYPE,QL_TYPE                                                  
         OC    OB_KEY,SPACES                                                    
         LA    R0,OB_D                                                          
         ST    R0,T.TSAREC                                                      
         MVI   T.TSACTN,TSARDH     Read next record                             
         GOTOR VTSAR,T.TSARD                                                    
         TM    T.TSERRS,TSEEOF     Test end of buffer                           
         JNZ   CHKHOK                                                           
*                                                                               
         LLC   RF,LDGAL1                                                        
         BCTR  RF,0                                                             
         BASR  R7,0                                                             
         CLC   OB_ACCC(0),QL_VAL   Still reading same account?                  
         EX    RF,0(R7)                                                         
         JNE   CHKHOK                                                           
         CLC   QL_TYPE,OB_TYPE     Check still same type                        
         JNE   CHKHOK                                                           
*                                                                               
         LA    RF,OB_ACCC                                                       
         LLC   R0,LDGAL1                                                        
         AR    RF,R0                                                            
         CLI   0(RF),C' '          level 1 account?                             
         JNH   CHKH06                                                           
*                                                                               
         LA    RF,OB_ACCC                                                       
         LLC   R0,LDGAL2                                                        
         CHI   R0,L'ACTKACT                                                     
         JE    CHKH06                                                           
         AR    RF,R0                                                            
         CLI   0(RF),C' '          level 2 account?                             
         JNH   CHKH06                                                           
*                                                                               
         LA    RF,OB_ACCC                                                       
         LLC   R0,LDGAL3                                                        
         CHI   R0,L'ACTKACT        Same as max l'acc?  Nothing to do            
         JE    CHKH06                                                           
         CLI   0(RF),C' '          level 4 account?                             
         JNH   CHKH06                                                           
         LLC   R0,LDGAL4                                                        
*                                                                               
CHKH06   LLC   RF,BYTE2            Is it a higher level account?                
         CR    R0,RF                                                            
         JL    CHKHNO                                                           
*                                                                               
CHKHOK   J     EXITY                                                            
*                                                                               
CHKHNO   MVC   ROUERRV,=AL2(AE$UNHIG)                                           
         J     EXITN                                                            
*                                                                               
CHKWRKD  DSECT                                                                  
CHKBAREA DS    XL(OB_LNQ)                                                       
CHKWRKL  EQU   *-CHKWRKD                                                        
SVRDEF   CSECT                                                                  
         EJECT                                                                  
         DROP  T                                                                
***********************************************************************         
* Write back lidelds to limit list record                             *         
***********************************************************************         
         SPACE 1                                                                
         USING UPDWRKD,RC                                                       
         USING OB_D,UARBAREA                                                    
         USING LLSRECD,R2                                                       
T        USING TSARD,TSAROBUF                                                   
UPDLID   NTR1  LABEL=NO,WORK=(RC,UPDWRKL)                                       
         J     *+12                                                             
         DC    C'*UPDLID*'                                                      
*                                                                               
***      GOTOR VDATCON,DMCB,(5,0),(1,HD_TODP)  for racel                        
         GOTOR VDATCON,DMCB,(15,0),(1,HD_TODP) for racel                        
         GOTOR VDATCON,DMCB,(5,0),(1,HD_TODP5) for racel                        
         GOTOR CLRWRK,UPDWRKL      Clear work area                              
         MVC   OB_KEY,SPACES                                                    
         XC    HALF2,HALF2                                                      
*                                                                               
         LA    R2,IOKEY            build LimList key                            
         XC    LLSKEY,LLSKEY                                                    
         MVI   LLSKTYP,LLSKTYPQ                                                 
         MVI   LLSKSUB,LLSKSUBQ                                                 
         MVC   LLSKCPY,CUXCPY                                                   
         MVC   LLSKPIDB,CCTPID                                                  
         MVC   CSVKEY1,LLSKEY      read and lock LimitList record               
         MVC   BYTE2,LLSKSEQ       and sequence of record for update            
*                                                                               
         L     R1,=AL4(IOHID+IODIR+IO2)                                         
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    UPDLID04                                                         
         TM    IOERR,IOEDEL        Is it deleted?                               
         JNZ   UPDLID02                                                         
         J     UPDLID06            No add new record                            
*                                                                               
UPDLID02 LA    R2,IOKEY            Read for sequential record                   
         MVC   LLSKEY,CSVKEY1                                                   
         LLC   RF,LLSKSEQ                                                       
         AHI   RF,1                                                             
         STC   RF,LLSKSEQ                                                       
         STC   RF,BYTE2                                                         
         MVC   CSVKEY1,LLSKEY                                                   
         L     R1,=AL4(IORDD+IODIR+IO2)                                         
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    UPDLID04            Sequential record already exists             
         J     UPDLID06            If it doesn't add it                         
*                                                                               
UPDLID04 NI    HD_IND,X'FF'-HD_ADDRQ                                            
         CLC   CSVKEY1(LLSKGRP-LLSRECD),LLSKEY                                  
         JE    UPDLID08                                                         
*                                                                               
UPDLID06 OI    HD_IND,HD_ADDRQ     Set we are adding a new record               
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO2                                        
         L     R2,AIO2                                                          
         MVC   0(L'ACTKEY,R2),CSVKEY1                                           
         LHI   RF,LLSRFST-LLSRECD                                               
         STH   RF,LLSRLEN                                                       
         J     UPDLID21                                                         
*                                                                               
UPDLID08 L     R1,=AL4(IORDUPD+IODIR+IO2)                                       
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    UPDLID10                                                         
         CLI   IOERR,IOEDEL        must be deleted                              
         JNE   *+2                                                              
*                                                                               
UPDLID10 L     R1,=AL4(IOGETRUP+IOMST+IO2)                                      
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JNE   *+2                                                              
*                                                                               
         L     R2,AIO2                                                          
         MVC   CSVKEY1,LLSKEY      save real key (from DA record)               
         LA    R3,LLSRFST                                                       
*                                                                               
         USING LIDELD,R3                                                        
UPDLID11 CLI   LIDEL,0             Remove all existing elements                 
         JE    UPDLID13                                                         
         CLI   LIDEL,LIDELQ                                                     
         JNE   UPDLID12                                                         
         CLI   LIDTYPE,LIDTPID     Keep on group records                        
         JE    UPDLID12                                                         
         MVI   LIDEL,X'FF'                                                      
*                                                                               
UPDLID12 LLC   R0,LIDLN                                                         
         AR    R3,R0                                                            
         J     UPDLID11                                                         
*                                                                               
UPDLID13 GOTO1 VHELLO,DMCB,(C'D',ACCMST),(X'FF',LLSRECD),0                      
         CLI   12(R1),0                                                         
         JNE   *+2                                                              
*                                                                               
         USING RACELD,RF           Add raceld to record                         
UPDLID14 OC    LLSKSEQ,LLSKSEQ     Check if sequential record                   
         JNZ   UPDLID24            No racelds on sequential records             
         LA    RF,LLSRFST          update activity element (see                 
         XR    R0,R0               UPDAL14 comments)                            
         XR    R4,R4                                                            
         XC    DUB,DUB                                                          
                                                                                
UPDLID16 CLI   RACEL,0                                                          
         JE    UPDLID20                                                         
         CLI   RACEL,RACELQ                                                     
         JNE   UPDLID18                                                         
         CLI   RACTYPE,RACTCHA                                                  
         JNE   UPDLID18                                                         
         AHI   R4,1                                                             
         CLC   RACDATE(L'RACDATE+L'RACDATE),DUB                                 
         JL    UPDLID18                                                         
         MVC   DUB(L'RACDATE+L'RACDATE),RACDATE                                 
         LR    R1,RF                                                            
                                                                                
UPDLID18 IC    R0,RACLN                                                         
         AR    RF,R0                                                            
         J     UPDLID16                                                         
                                                                                
UPDLID20 CHI   R4,0                at least one RACTCHA element                 
         JNH   *+2                                                              
         LR    RF,R1                                                            
         CHI   R4,RACMAXQ          Hit maximum number of raceld elems           
         JNL   UPDLID22                                                         
*                                                                               
UPDLID21 LA    RF,TEMP             No so build a new one                        
         XC    RACEL(RACLNQ),RACEL                                              
         MVI   RACEL,RACELQ                                                     
         MVI   RACLN,RACLNQ                                                     
         MVI   RACTYPE,RACTCHA                                                  
         MVC   RACUSER,CUUSER                                                   
         MVC   RACPERS,CCTPID                                                   
         MVC   RACTERM,CUTERM                                                   
         MVC   RACDATE,HD_TODP5                                                 
         MVC   RACTIME,CTIME                                                    
*                                                                               
         LA    RF,=CL8'ADD=END'                                                 
         GOTO1 VHELLO,DMCB,(C'P',ACCMST),AIO2,TEMP,(RF)                         
         CLI   12(R1),0                                                         
         JE    UPDLID24                                                         
         DC    H'0'                                                             
                                                                                
UPDLID22 MVC   RACUSER,CUUSER                                                   
         MVC   RACPERS,CCTPID                                                   
         MVC   RACTERM,CUTERM                                                   
         MVC   RACDATE,HD_TODP5                                                 
         MVC   RACTIME,CTIME                                                    
         DROP  RF                                                               
*                                  Rebuild elements                             
UPDLID24 TM    HD_IND,HD_OVFLQ                                                  
         JZ    *+12                                                             
         NI    HD_IND,X'FF'-HD_OVFLQ Turn off overflow                          
         J     UPDLID26                                                         
*                                                                               
UPDLID25 MVI   T.TSACTN,TSARDH    SET ACTION TO 'READ HIGH'                     
         LA    R0,OB_D                                                          
         ST    R0,T.TSAREC        READ INTO ACQUIRED STORAGE    ck              
         GOTOR VTSAR,T.TSARD                                                    
         TM    T.TSERRS,TSEEOF    Finished?                                     
         JNZ   UPDLID45                                                         
*                                                                               
         OC    SVTYPE,SVTYPE       Same type                                    
         JNZ   UPDLID26                                                         
         MVC   SVTYPE,OB_TYPE                                                   
*                                                                               
EN       USING LIDELD,R6                                                        
UPDLID26 LA    R3,ELEMENT          Build a new element                          
         LR    R6,R3               R6=A(current item)                           
         XC    ELEMENT,ELEMENT                                                  
         MVI   LIDEL,LIDELQ                                                     
         MVI   LIDLN,LIDLNDQ                                                    
*                                                                               
         LA    R4,TYPTAB                                                        
*                                                                               
         USING TYPTABD,R4                                                       
UPDLID28 CLI   0(RF),X'FF'                                                      
         JE    *+2                                                              
         CLC   OB_TYPE,TYPCTYP     Match on type?                               
         JE    UPDLID30                                                         
         LA    R4,TYPTABLQ(R4)                                                  
         J     UPDLID28                                                         
*                                                                               
UPDLID30 MVC   LIDITLN,TYPELML     Set item length                              
         MVC   LIDTYPE,TYPETYP                                                  
*                                                                               
UPDLID32 LLC   RF,LIDLN                                                         
         LLC   R0,TYPELML                                                       
         AR    RF,R0                                                            
         CHI   RF,X'FF'                                                         
         JH    UPDLID42                                                         
         MVC   EN.LIDLAPPL,OB_APPL1                                             
         MVC   EN.LIDLAPP2,OB_APPL2                                             
*                                                                               
         LLC   R0,TYPBDIS                                                       
         LA    RF,OB_D                                                          
         AR    RF,R0                                                            
         LLC   RE,TYPBLEN                                                       
         BCTR  RE,0                                                             
         LLC   R1,TYPEDIS                                                       
         LA    R1,EN.LIDDATA(R1)                                                
         BASR  R7,0                                                             
         MVC   0(0,R1),0(RF)                                                    
         EX    RE,0(R7)                                                         
*                                                                               
         CLI   TYPISOF,YESQ        Any office present?                          
         JNE   UPDLID33                                                         
         LLC   R0,TYPOBDI          Get displacement in buffer                   
         LA    RF,OB_D                                                          
         AR    RF,R0                                                            
         LLC   R1,TYPOEDI                                                       
         LA    R1,EN.LIDDATA(R1)   Get displacement in element                  
         MVC   0(L'LIDLOFF,R1),0(RF)                                            
*                                                                               
UPDLID33 LLC   R0,LIDITLN          Bump to next sub element                     
         LLC   RF,LIDLN                                                         
         AR    RF,R0                                                            
         STC   RF,LIDLN                                                         
*                                                                               
         MVI   T.TSACTN,TSANXT     Set action to 'read next'                    
         GOTOR VTSAR,T.TSARD                                                    
         TM    T.TSERRS,TSEEOF                                                  
         JNZ   UPDLID42                                                         
*                                                                               
UPDLID34 CLC   OB_TYPE,SVTYPE      Same type as before?                         
         JNE   UPDLID42                                                         
UPDLID36 LLC   R0,LIDITLN                                                       
         AR    R6,R0                                                            
         J     UPDLID32                                                         
*                                                                               
UPDLID42 LLC   RF,LIDLN                                                         
         MVC   SVTYPE,OB_TYPE      Save type                                    
         XR    R0,R0                                                            
         ICM   R0,3,LLSRLEN                                                     
         AR    R0,RF                                                            
         CHI   R0,MAXRECLN         Room for another element                     
         JNH   UPDLID44                                                         
         OI    HD_IND,HD_OVFLQ     Overflow                                     
         J     UPDLID45                                                         
*                                                                               
UPDLID44 GOTO1 VHELLO,DMCB,(C'P',ACCMST),LLSRECD,LIDELD,0,0                     
         CLI   12(R1),0            add to end of record                         
         JNE   *+2                 What went wrong here?                        
         TM    T.TSERRS,TSEEOF                                                  
         JZ    UPDLID26                                                         
*                                                                               
UPDLID45 TM    HD_IND,HD_ADDRQ     Adding a new record?                         
         JNZ   UPDLID48                                                         
         NI    LLSRSTAT,X'FF'-LLSSDELT turn off delete status                   
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO2'                           
         JE    *+6                 record put back - all OK                     
         DC    H'0'                                                             
         LA    R2,IOKEY                                                         
         TM    LLSKSTAT,LLSSDELT  Deleted record?                               
         JZ    UPDLID46                                                         
         NI    LLSKSTAT,X'FF'-LLSSDELT Undelete it                              
         GOTOR (#IOEXEC,AIOEXEC),'IOWRITE+IODIR+IO2'                            
         JE    *+6                 record put back - all OK                     
         DC    H'0'                                                             
*                                                                               
N        USING CPTRBLK,ELEMENT                                                  
UPDLID46 XC    N.CPTRBLK(CPTRBLKL),N.CPTRBLK     delete passives                
         MVC   N.LDGLVALN(4),ONERL1L                                            
         GOTO1 VPADDLE,DMCB,(C'D',AIO2),(C'K',N.CPTRBLK),0,0,ACOMFACS           
         J     UPDLID50                                                         
*                                                                               
UPDLID48 NI    HD_IND,X'FF'-HD_ADDRQ                                            
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO2'                           
         JE    *+6                 Add a new record                             
         DC    H'0'                                                             
*                                                                               
UPDLID50 XC    N.CPTRBLK(CPTRBLKL),N.CPTRBLK     add passives                   
         MVC   N.LDGLVALN(4),ONERL1L                                            
         GOTO1 VPADDLE,DMCB,(C'A',AIO2),N.CPTRBLK,IODA,0,ACOMFACS               
         TM    T.TSERRS,TSEEOF     End of file?                                 
         JNZ   EXITY                                                            
         TM    HD_IND,HD_OVFLQ     More to add?                                 
         JNZ   UPDLID02                                                         
         J     EXITY                                                            
*                                                                               
UPDWRKD  DSECT                                                                  
UARBAREA DS    XL(OB_LNQ)          Area for tsar buffer                         
UPDWRKL  EQU   *-UPDWRKD                                                        
SVRDEF   CSECT                                                                  
         DROP  R2,R3,R4,N,T,EN                                                  
         EJECT                                                                  
***********************************************************************         
* Get SJ office                                                       *         
***********************************************************************         
                                                                                
GETSJOF  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GETSJOF'                                                      
                                                                                
         CLI   HD_LTYPE,LIDTCPJL   Are we adding SJ account to limit            
         JNE   EXITY               No                                           
         MVC   CS_SJOFF,SPACES     Initialise office                            
         TM    CPYSTAT1,CPYSOROE   Are we on offices                            
         JZ    EXITY               No                                           
                                                                                
         USING ACTRECD,R2                                                       
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(L'PRODUL),PRODUL                                         
         LLC   RE,PCLILEN                                                       
         LA    RF,QL_VAL(RE)                                                    
         CLI   0(RF),C' '          Have we got product                          
         JNH   GETJOF15            No                                           
         LLC   RE,PPROLEN                                                       
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   ACTKACT(0),QL_VAL                                                
         EX    RE,0(RF)                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    GETJOF03                                                         
         MVC   ROUERRV,=AL2(AE$ACTNF)                                           
         J     EXITN                                                            
*                                                                               
GETJOF03 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R2,AIO1                                                          
         LA    R3,ACTRFST                                                       
         USING PPRELD,R3                                                        
         XR    R0,R0                                                            
                                                                                
GETJOF05 CLI   PPREL,0                                                          
         JE    GETJOF15                                                         
         CLI   PPREL,PPRELQ                                                     
         JE    GETJOF10                                                         
         IC    R0,PPRLN                                                         
         AR    R3,R0                                                            
         J     GETJOF05                                                         
                                                                                
GETJOF10 MVC   CS_SJOFF,PPRGAOFF                                                
         OC    CS_SJOFF,SPACES                                                  
         CLC   CS_SJOFF,SPACES                                                  
         JH    GETJOF30                                                         
                                                                                
GETJOF15 LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(L'PRODUL),PRODUL                                         
         LLC   RE,PCLILEN                                                       
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   ACTKACT(0),QL_VAL                                                
         EX    RE,0(RF)                                                         
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    GETJOF18                                                         
         MVC   ROUERRV,=AL2(AE$ACTNF)                                           
         J     EXITN                                                            
*                                                                               
GETJOF18 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R2,AIO1                                                          
         LA    R3,ACTRFST                                                       
         USING PPRELD,R3                                                        
         XR    R0,R0                                                            
                                                                                
GETJOF20 CLI   PPREL,0                                                          
         JE    GETJOF30                                                         
         CLI   PPREL,PPRELQ                                                     
         JE    GETJOF25                                                         
         IC    R0,PPRLN                                                         
         AR    R3,R0                                                            
         J     GETJOF20                                                         
                                                                                
GETJOF25 CLC   PPRGAOFF,SPACES                                                  
         JNH   GETJOF30                                                         
         MVC   CS_SJOFF,PPRGAOFF                                                
         OC    CS_SJOFF,SPACES                                                  
                                                                                
         USING OFFALD,R3                                                        
GETJOF30 L     R3,AOFFAREA                                                      
         MVC   OFFAOFFC,CS_SJOFF                                                
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL,OFFALD       VALIDATE OFFICE                              
         JE    EXITY                                                            
         MVC   ROUERRV,=AL2(AE$SECLK)                                           
         J     EXITN                                                            
         DROP  R2,R3                                                            
                                                                                
***********************************************************************         
* Validate office code                                                *         
***********************************************************************         
                                                                                
VALOFF   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    CL8'*VALOFF*'                                                    
                                                                                
         LR    R2,R1                                                            
         CLI   CS_ITYPE,CS_IADVQ   Don't validate office for                    
         JE    EXITY                    advance or non office agencies          
         CLI   OFFIND,NONEQ                                                     
         JE    EXITY                                                            
         CLC   QI_OFF,SPACES       Has the user entered an office               
         JNH   VALOFF10            No                                           
                                                                                
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,0(R2)                                                   
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL              Validate office                              
         JE    VALOFF02                                                         
                                                                                
         MVC   ROUERRV,=AL2(AE$SECLK)  Office is invalid for logon              
         J     EXITN                                                            
                                                                                
VALOFF02 MVC   CS_OFF,0(R2)                                                     
                                                                                
         CLI   OFFIND,FULLYQ       Full office                                  
         JNE   VALOFF18                                                         
         CLI   CS_ITYPE,CS_IBILQ   Billable claim item                          
         JNE   VALOFF04            No                                           
         TM    HD_PIND,HD_PBOFF    Are we to use 1R office over SJ off          
         JZ    VALOFF08            No                                           
         J     VALOFF06                                                         
                                                                                
VALOFF04 CLI   CS_ITYPE,CS_INONQ   Non-billable claim item                      
         JE    *+6                 Yes                                          
         DC    H'0'                                                             
         TM    HD_PIND,HD_PNOFF    Are we to use 1R office over SJ off          
         JZ    VALOFF08            No                                           
VALOFF06 MVC   CS_OFF,HD_1ROFF     Always set posting office as 1R              
         J     VALOFF18                                                         
                                                                                
VALOFF08 TM    CS_IND1,CS_ICLI     Has a client been entered                    
         JZ    VALOFF18            No - skip office check                       
         CLC   CS_OFF,CS_SJOFF     Check office matches client office           
         JE    VALOFF18                                                         
*&&UK                                                                           
         MVC   ROUERRV,=AL2(AE$MIXOF)                                           
         J     EXITN                                                            
*&&                                                                             
                                                                                
VALOFF10 CLI   CS_ITYPE,CS_IBILQ   Billable claim item                          
         JNE   VALOFF12            No                                           
         TM    HD_PIND,HD_PBOFF    Are we to use 1R office over SJ off          
         JZ    VALOFF14            No                                           
         MVC   CS_OFF,HD_1ROFF     Yes                                          
         J     VALOFF18                                                         
                                                                                
VALOFF12 CLI   CS_ITYPE,CS_INONQ   Non-billable claim item                      
         JE    *+6                 Yes                                          
         DC    H'0'                No - invalid die                             
         TM    HD_PIND,HD_PNOFF    Are we to use 1R office over SJ off          
         JZ    VALOFF14            No                                           
         MVC   CS_OFF,HD_1ROFF     Yes                                          
         J     VALOFF18                                                         
                                                                                
VALOFF14 MVC   CS_OFF,CS_SJOFF     Otherwise use SJ office                      
         CLC   CS_OFF,SPACES       Do we have a SJ office                       
         JH    VALOFF18            Yes                                          
         MVC   CS_OFF,HD_OFFC      Use default office from 2D/1R                
                                                                                
VALOFF18 J     EXITY                                                            
         DROP  R1                                                               
         EJECT                                                                  
***********************************************************************         
* Validate miles                                                      *         
***********************************************************************         
                                                                                
VALMIL   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    CL8'*VALMIL*'                                                    
                                                                                
         ZAP   CS_MILES,PZERO                                                   
         LR    R2,R1                                                            
         OC    0(L'QI_MILES,R2),0(R2)                                           
         JZ    VALMIL02                                                         
         CP    0(L'QI_MILES,R2),PZERO                                           
         JNE   VALMIL04                                                         
VALMIL02 TM    CS_ESTA2,RSTSMILE   Miles required but not passed                
         JZ    EXITY                                                            
         CLI   HD_USRFN,YESQ       Is user finance approver                     
         JNE   EXITY               No - skip error                              
         CLI   QH_STAT,QH_SAVEQ                                                 
         JE    EXITY                                                            
         MVC   ROUERRV,=AL2(AE$MLEXA)                                           
         J     EXITN                                                            
                                                                                
VALMIL04 TM    CS_ESTA2,RSTSMILE   miles not required but passed                
         JNZ   VALMIL06                                                         
         CLI   HD_USRFN,YESQ       Is user finance approver                     
         JNE   VALMIL06            No - skip error                              
         CLI   QH_STAT,QH_SAVEQ                                                 
         JE    EXITY                                                            
         MVC   ROUERRV,=AL2(AE$MNRFE)                                           
         J     EXITN                                                            
                                                                                
VALMIL06 ZAP   CS_MILES,0(L'QI_MILES,R2)                                        
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Update expense claim record - rebuild record with data held on TSAR *         
* buffer  - add new records when changing draft to live or when there *         
* isn't enough room to store the data                                 *         
***********************************************************************         
                                                                                
UPDCLM   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*UPDCLM*'                                                      
                                                                                
         MVI   BYTE1,0             Sequence number                              
         MVI   BYTE2,0             Indicators                                   
         XC    SVCLKEY,SVCLKEY     Clear Tsar buffer key                        
         XC    CLMERR,CLMERR       Clear Tsar buffer error                      
                                                                                
         L     R3,AEXPREC                                                       
         USING EXCRECD,R3          R3=A(Claim record)                           
                                                                                
K        USING EXCKEY,IOKEY                                                     
UPDCLM02 XC    K.EXCKEY,K.EXCKEY   Build key of claim record                    
         MVI   K.EXCKTYP,EXCKTYPQ                                               
         MVI   K.EXCKSUB,EXCKSUBQ                                               
         MVC   K.EXCKCPY,CUXCPY                                                 
         MVC   K.EXCKPIDB,HD_PPID#                                              
         MVC   K.EXCKDATE,HD_DATEC                                              
         MVC   K.EXCKTYPE,QH_TYPE                                               
         MVC   K.EXCKREF,QH_NUM                                                 
         MVC   K.EXCK1RAC,HD_1RACT                                              
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JNE   UPDCLM24                                                         
         CLC   QH_NUM,HD_CLM#      Are the claim number and type                
         JNE   UPDCLM06                          the same                       
         CLC   QH_TYPE,HD_CLMTY    If not mark records to be deleted            
         JNE   UPDCLM06                                                         
UPDCLM04 TM    CLMERR,TSEEOF       Is it the end of the buffer?                 
         JZ    *+8                 No                                           
UPDCLM06 OI    BYTE2,X'80'         Yes - delete original records                
                                                                                
UPDCLM08 MVC   BYTE1,K.EXCKSEQ     Save current sequence number                 
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         TM    BYTE2,X'80'         Are we deleting                              
         JNZ   UPDCLM12            Yes                                          
         LHI   R0,EXCRFST+1-EXCRECD                                             
         STCM  R0,3,EXCRLEN                                                     
         MVC   EXCRSTAT,TR_ST1NW                                                
         MVC   EXCRSTA2,TR_ST2NW                                                
         CLI   QH_STAT,QH_DELQ     Test deleting expense claim                  
         JE    *+16                Don't overwrite item and appvr count         
         ZAP   EXCRNAPP,HD_APCNT                                                
         ZAP   EXCRNITM,HD_ITCNT                                                
         GOTOR BLDCLD              Build CLDELD header element                  
                                                                                
UPDCLM10 GOTOR BLDCID              Build CIDELD from new item buffer            
                                                                                
         J     UPDCLM14                                                         
                                                                                
***********************************************************************         
* Here to write back current audit record and get next one            *         
***********************************************************************         
                                                                                
UPDCLM12 OI    EXCRSTAT,EXCSDELT                                                
UPDCLM14 GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO1'                           
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
UPDCLM16 L     R1,=AL4(IOSQD+IODIR+IO1)                                         
         GOTOR (#IOEXEC,AIOEXEC)                                                
         CLC   K.EXCKEY(EXCKSEQ-EXCRECD),IOKEYSAV                               
         JE    UPDCLM04            Process next record                          
                                                                                
***********************************************************************         
* Here when all current claim records have been processed - set       *         
* sequence number of next claim record (to be added) and test if we   *         
* we have further elements to add                                     *         
***********************************************************************         
                                                                                
         TM    BYTE2,X'80'                                                      
         JZ    UPDCLM22                                                         
         MVI   BYTE1,0                                                          
         J     UPDCLM24                                                         
                                                                                
UPDCLM22 LLC   RE,BYTE1            Bump key sequence number                     
         AHI   RE,1                                                             
         STC   RE,BYTE1                                                         
                                                                                
UPDCLM24 TM    CLMERR,TSEEOF       Is it the end of the buffer?                 
         JNZ   EXITY               Yes                                          
                                                                                
***********************************************************************         
* Here if claim record for current claim doesn't exist or we have     *         
* run out of space for elements - create a new record and set flag    *         
* so that we issue an ADDREC                                          *         
***********************************************************************         
                                                                                
UPDCLM28 XC    EXCRECD(256),EXCRECD                                             
         MVC   EXCKEY,IOKEYSAV     Build a new audit record                     
         MVC   EXCKTYPE,HD_CLMTY                                                
         MVC   EXCKREF,HD_CLM#                                                  
         MVC   EXCKSEQ,BYTE1                                                    
         LHI   R0,EXCRFST+1-EXCRECD                                             
         STCM  R0,3,EXCRLEN                                                     
         MVC   EXCRSTAT,TR_ST1NW                                                
         MVC   EXCRSTA2,TR_ST2NW                                                
         ZAP   EXCRNAPP,HD_APCNT                                                
         ZAP   EXCRNITM,HD_ITCNT                                                
         OI    BYTE2,X'40'         Set adding new records                       
                                                                                
         GOTOR BLDCLD              Build CLDELD header element                  
                                                                                
UPDCLM30 GOTOR BLDCID              Add CIDELD from buffer recs                  
                                                                                
UPDCLM32 GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO1'                           
         JE    UPDCLM22                                                         
         DC    H'0'                                                             
         DROP  K,R3                                                             
         EJECT                                                                  
***********************************************************************         
* Build CIDELD from buffer records                                    *         
***********************************************************************         
                                                                                
BLDCID   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*BLDCID*'                                                      
                                                                                
         L     R3,AEXPREC                                                       
         USING EXCRECD,R3          R3=A(Claim record)                           
                                                                                
         XC    NEW.CL_D(CL_KEYL),NEW.CL_D                                       
         MVC   NEW.CL_KEY(CL_KEYL),SVCLKEY                                      
         GOTOR BUFCLM,DMCB,('TSARDH',NEWBUF),NEW.CL_D                           
         TM    CLMERR,TSEEOF       Is it the end of the buffer?                 
         JNO   BLDCID04            No                                           
         J     EXITY               Yes - no item lines to add                   
                                                                                
                                                                                
BLDCID02 GOTOR BUFCLM,DMCB,('TSANXT',NEWBUF),NEW.CL_D                           
         TM    CLMERR,TSEEOF       Is it the end of the buffer?                 
         JNZ   EXITY               Yes                                          
                                                                                
BLDCID04 SR    R0,R0                                                            
         ICM   R0,3,EXCRLEN        Get current record length                    
         JNZ   *+8                                                              
         LHI   R0,EXCRFST+1-EXCRECD                                             
                                                                                
         OC    NEW.CL_XDAT#,NEW.CL_XDAT#                                        
         JZ    BLDCID08                                                         
         LHI   RF,XDFXLNQ                                                       
         XR    RE,RE                                                            
         ICM   RE,1,NEW.CL_XCHLN                                                
         JZ    BLDCID16                                                         
         AR    RF,RE                                                            
         J     BLDCID16                                                         
                                                                                
BLDCID08 LHI   RF,CIDMLNQ                                                       
         AHI   RF,CIDCLNQ                                                       
         OC    NEW.CL_VEHC,NEW.CL_VEHC                                          
         JZ    BLDCID09                                                         
         SHI   RF,CIDMLNQ                                                       
         AHI   RF,CIDMLN1Q+(CIDMDLNQ*2)                                         
                                                                                
BLDCID09 OC    NEW.CL_EST,NEW.CL_EST                                            
         JZ    BLDCID10                                                         
         SHI   RF,CIDCLNQ                                                       
         AHI   RF,CIDCLXQ                                                       
BLDCID10 XR    RE,RE                                                            
         ICM   RE,1,NEW.CL_NAROL                                                
         JZ    BLDCID12                                                         
         AHI   RE,4                                                             
         AR    RF,RE                                                            
BLDCID12 XR    RE,RE                                                            
         ICM   RE,1,NEW.CL_NARL                                                 
         JZ    BLDCID14                                                         
         AHI   RE,4                                                             
         AR    RF,RE                                                            
BLDCID14 AHI   RF,CIDALN1Q+(CIDALNQ*2)                                          
         AHI   RF,CIDEPTQ          ADD LENGTH OF CIDEL PAYMENT TYPE             
*                                                                               
BLDCID16 AR    R0,RF               Update record length                         
         CHI   R0,MAXRECLN                                                      
         JNH   BLDCID18                                                         
         MVC   SVCLKEY,NEW.CL_KEY                                               
         J     EXITY                                                            
                                                                                
BLDCID18 OC    NEW.CL_XDAT#,NEW.CL_XDAT#                                        
         JNZ   BLDCID90                                                         
N        USING CIDELD,ELEMENT                                                   
         XC    N.CIDEL(CIDMLNQ),N.CIDEL                                         
         MVI   N.CIDEL,CIDELQ      Build main CIDELD element                    
         MVI   N.CIDLN,CIDMLNQ                                                  
         MVC   N.CIDSEQ,NEW.CL_ITEM#                                            
         MVI   N.CIDTYPE,CIDTYMQ                                                
         MVC   N.CIDMEXP,NEW.CL_ETYP                                            
         MVC   N.CIDMDAT,NEW.CL_ADAT                                            
         MVC   N.CIDMINT,NEW.CL_INT                                             
         MVC   N.CIDMTYP,NEW.CL_ITYPE                                           
         MVC   N.CIDMREC,NEW.CL_RECPT                                           
         MVC   N.CIDMSTA,NEW.CL_STAT                                            
         MVC   N.CIDMCUR,NEW.CL_FCUR                                            
         MVC   N.CIDMAMT,NEW.CL_AMT                                             
         MVC   N.CIDMFCA,NEW.CL_FAMT                                            
         MVC   N.CIDMMIL,NEW.CL_MILE                                            
         MVC   N.CIDMNET,NEW.CL_NET                                             
         MVC   N.CIDMDISC,NEW.CL_DAMT                                           
         MVC   N.CIDMRAT,NEW.CL_XRT                                             
         MVC   N.CIDMOFF,NEW.CL_OFF                                             
         MVC   N.CIDMWCD,NEW.CL_WC                                              
         MVC   N.CIDMREF,NEW.CL_REF                                             
         MVC   N.CIDMDRT,NEW.CL_DSCRT                                           
*&&US                                                                           
         MVC   N.CIDMPROV,NEW.CL_PROV                                           
         ZAP   N.CIDMGST,NEW.CL_GSTA                                            
         ZAP   N.CIDMPST,NEW.CL_PSTA                                            
*&&                                                                             
         OC    NEW.CL_VEHC,NEW.CL_VEHC Have we any vehicle code                 
         JZ    BLDCID24            No                                           
         MVI   N.CIDLN,CIDMLN1Q    Yes - new mileage system in use              
         MVC   N.CIDMVEH,NEW.CL_VEHC                                            
         MVC   N.CIDMENG,NEW.CL_ENGC                                            
         MVC   N.CIDMFUEL,NEW.CL_FUEL                                           
         MVC   N.CIDMPASS,NEW.CL_PASS                                           
         MVC   N.CIDMACNM,NEW.CL_ACUNM                                          
         ZAP   N.CIDMACDS,NEW.CL_ACUDS                                          
         ZAP   N.CIDMNVTA,NEW.CL_NONVT                                          
         XC    N.CIDMNUM,N.CIDMNUM                                              
         LA    R6,NEW.CL_DRTE                                                   
         LA    R2,N.CIDMDNTY                                                    
CI       USING CIDMDNTY,R2                                                      
DB       USING CL_DRTE,R6                                                       
         LHI   RF,CL_MAXD                                                       
                                                                                
BLDCID22 OC    DB.CL_DIST,DB.CL_DIST   Have we got any distance                 
         JZ    BLDCID24                No                                       
         CP    DB.CL_DIST,PZERO                                                 
         JE    BLDCID24                                                         
         MVC   CI.CIDMDNTY,DB.CL_DRTE  Save band, dist and rates                
         LLC   RE,N.CIDMNUM            Increment number of entries              
         AHI   RE,1                                                             
         STC   RE,N.CIDMNUM                                                     
         LLC   RE,N.CIDLN              Increment length of element              
         AHI   RE,CIDMDLNQ                                                      
         STC   RE,N.CIDLN                                                       
         LA    R2,CIDMDLNQ(R2)         Bump R2 to next entry                    
         LA    R6,CL_DRTEL(R6)         Bump R6 to next data                     
         JCT   RF,BLDCID22                                                      
         DROP  DB,CI                                                            
                                                                                
BLDCID24 GOTOR ADDELE,EXCRECD                                                   
                                                                                
         CLI   NEW.CL_ITYPE,CS_IADVQ                                            
         JE    BLDCID28                                                         
         XC    N.CIDEL(CIDCLNQ),N.CIDEL                                         
         MVI   N.CIDEL,CIDELQ      Build account CIDELD element                 
         MVI   N.CIDLN,CIDCLNQ                                                  
         MVC   N.CIDSEQ,NEW.CL_ITEM#                                            
         MVI   N.CIDTYPE,CIDTYCQ                                                
         MVC   N.CIDCCPJ,NEW.CL_SJAC                                            
         MVC   N.CIDCOFF,NEW.CL_SJOFF                                           
         MVC   N.CIDCEXP,NEW.CL_EXAC                                            
         MVC   N.CIDCSUP,NEW.CL_SUPAC                                           
         MVC   N.CIDC2DA,NEW.CL_2DAC                                            
         MVC   N.CIDC2PA,NEW.CL_2PAC                                            
         MVC   N.CIDCVAT,NEW.CL_VATC                                            
         MVC   N.CIDCVAC,NEW.CL_VATAC                                           
         MVC   N.CIDCMED,NEW.CL_MED                                             
*&&US*&& MVC   N.CIDCPST,NEW.CL_PSTC                                            
*&&US*&& MVC   N.CIDCPSTA,NEW.CL_PSTAC                                          
                                                                                
         OC    NEW.CL_EST,NEW.CL_EST                                            
         JZ    BLDCID26                                                         
         MVC   N.CIDCEGN,NEW.CL_EST                                             
         MVI   N.CIDLN,CIDCLXQ                                                  
                                                                                
BLDCID26 GOTOR ADDELE,EXCRECD                                                   
                                                                                
BLDCID28 XC    N.CIDEL(CIDALN1Q),N.CIDEL                                        
         MVI   N.CIDEL,CIDELQ      Build approval CIDELD element                
         MVI   N.CIDLN,CIDALN1Q                                                 
         MVC   N.CIDSEQ,NEW.CL_ITEM#                                            
         MVI   N.CIDTYPE,CIDTYAQ                                                
         LA    R6,NEW.CL_AP                                                     
         LA    R2,N.CIDANTRY                                                    
CI       USING CIDANTRY,R2                                                      
AP       USING CL_AP,R6                                                         
         LHI   RF,CL_MAXA                                                       
BLDCID30 OC    AP.CL_APPID,AP.CL_APPID Have we got a client approver            
         JZ    BLDCID36            No - first time don't build element          
                                                                                
BLDCID32 OC    AP.CL_APPID,AP.CL_APPID Have we got a client approver            
         JZ    BLDCID34                                                         
         MVC   CI.CIDANTRY,AP.CL_AP                                             
         LLC   RE,N.CIDANUM                                                     
         AHI   RE,1                                                             
         STC   RE,N.CIDANUM                                                     
         LLC   RE,N.CIDLN                                                       
         AHI   RE,CIDALNQ                                                       
         STC   RE,N.CIDLN                                                       
         LA    R2,CIDALNQ(R2)                                                   
         LA    R6,CL_APL(R6)                                                    
         JCT   RF,BLDCID32                                                      
         DROP  AP,CI                                                            
BLDCID34 GOTOR ADDELE,EXCRECD                                                   
                                                                                
BLDCID36 OC    NEW.CL_NARL,NEW.CL_NARL                                          
         JZ    BLDCID38                                                         
         XC    N.CIDEL(CIDALN1Q),N.CIDEL                                        
         MVI   N.CIDEL,CIDELQ      Build approval CIDELD element                
         MVI   N.CIDLN,4                                                        
         MVC   N.CIDSEQ,NEW.CL_ITEM#                                            
         MVI   N.CIDTYPE,CIDTYNQ                                                
         LLC   RF,NEW.CL_NARL                                                   
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   N.CIDNARR(0),NEW.CL_NAR  Finance narrative                       
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         LLC   RE,N.CIDLN                                                       
         AR    RE,RF                                                            
         STC   RE,N.CIDLN                                                       
         GOTOR ADDELE,EXCRECD                                                   
                                                                                
BLDCID38 OC    NEW.CL_NAROL,NEW.CL_NAROL   Claimant narrative                   
         JZ    BLDCID40                                                         
         XC    N.CIDEL(CIDALN1Q),N.CIDEL                                        
         MVI   N.CIDEL,CIDELQ      Build approval CIDELD element                
         MVI   N.CIDLN,4                                                        
         MVC   N.CIDSEQ,NEW.CL_ITEM#                                            
         MVI   N.CIDTYPE,CIDTYOQ                                                
         LLC   RF,NEW.CL_NAROL                                                  
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   N.CIDNARR(0),NEW.CL_NARO                                         
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         LLC   RE,N.CIDLN                                                       
         AR    RE,RF                                                            
         STC   RE,N.CIDLN                                                       
         GOTOR ADDELE,EXCRECD                                                   
*                                                                               
BLDCID40 XC    N.CIDEL(CIDEPTQ),N.CIDEL  clear work area                        
         MVI   N.CIDEL,CIDELQ      Build approval CIDELD element                
         MVI   N.CIDLN,CIDEPTQ     length of the element                        
         MVC   N.CIDSEQ,NEW.CL_ITEM#  sequence number                           
         MVI   N.CIDTYPE,CIDTYPQ   Expense Payment details type                 
         ZAP   N.CIDPYAMT,PZERO      set Payment amount to zero                 
*                                                                               
         GOTOR ADDELE,EXCRECD                                                   
*                                                                               
BLDCID80 J     BLDCID02            Read next item from buffer                   
                                                                                
N        USING XDFELD,ELEMENT                                                   
BLDCID90 XC    N.XDFEL(XDFXLNQ),N.XDFEL                                         
         MVI   N.XDFEL,XDFELQ                                                   
         MVI   N.XDFLN,XDFXLNQ                                                  
         MVC   N.XDFXPTC,NEW.CL_ITEM#                                           
         MVC   N.XDFXPTX,NEW.CL_XDAT#                                           
         MVC   N.XDFXTYP,NEW.CL_XTYPE                                           
         LLC   RF,NEW.CL_XCHLN                                                  
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   N.XDFXDTA(0),NEW.CL_XCHAR                                        
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         LLC   RE,N.XDFLN                                                       
         AR    RE,RF                                                            
         STC   RE,N.XDFLN                                                       
                                                                                
         GOTOR ADDELE,EXCRECD                                                   
                                                                                
BLDCID92 J     BLDCID02            Read next item from buffer                   
         DROP  N,R3                                                             
         EJECT                                                                  
***********************************************************************         
* Build CLDELD from header info                                       *         
***********************************************************************         
                                                                                
BLDCLD   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*BLDCLD*'                                                      
                                                                                
         TM    HD_IND,HD_CLDEL     Are CLDELDs created                          
         JNZ   EXITY               Yes                                          
         L     R3,AEXPREC                                                       
         USING EXCRECD,R3          R3=A(Claim record)                           
                                                                                
N        USING CLDELD,ELEMENT                                                   
         XC    N.CLDEL(CLDLNQ),N.CLDEL                                          
         MVI   N.CLDEL,CLDELQ                                                   
         MVI   N.CLDLN,CLDLNQ                                                   
         MVI   N.CLDTYPE,CLDTHDRQ                                               
         MVC   N.CLDSTAT,HD_CLSTA                                               
         MVC   N.CLDUID,HD_OUID                                                 
         MVC   N.CLDIDN,HD_INDXN                                                
         ZAP   N.CLDTAMT,TR_TAMT                                                
         OC    QH_TOTAD,QH_TOTAD                                                
         JZ    *+10                                                             
         SP    N.CLDTAMT,QH_TOTAD                                               
                                                                                
         CLC   QH_BREF,SPACES      Check for batch ref and moa                  
         JNH   BLDCLD10                                                         
         OC    HD_MOA,HD_MOA                                                    
         JZ    BLDCLD10                                                         
         MVC   N.CLDBMON,HD_MOA    Convert YYMM -> YM ebcdic                    
         OI    N.CLDBMON,X'F0'                                                  
         LLC   R1,N.CLDBMON+1                                                   
         LHI   RF,X'F0'                                                         
         TM    N.CLDBMON+1,X'10'                                                
         JNO   *+8                                                              
         LHI   RF,X'B1'                                                         
         AR    R1,RF                                                            
         STC   R1,N.CLDBMON+1                                                   
         MVC   N.CLDBNUM,QH_BREF                                                
         MVC   N.CLDBUID,CUUSER                                                 
         MVC   N.CLDBADD,HD_TODC                                                
         MVC   N.CLDBABY,CCTPID                                                 
BLDCLD10 MVC   N.CLDPIDAD,HD_OPID                                               
         MVC   N.CLDAPDTE,HD_APDTE                                              
         MVC   N.CLDAPPID,HD_APPID                                              
                                                                                
         OC    QH_DESCL,QH_DESCL                                                
         JZ    BLDCLD20                                                         
         LLC   RF,QH_DESCL                                                      
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   N.CLDDESC(0),QH_DESC                                             
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         LLC   RE,N.CLDLN                                                       
         AR    RE,RF                                                            
         STC   RE,N.CLDLN                                                       
                                                                                
BLDCLD20 GOTOR ADDELE,EXCRECD                                                   
                                                                                
         OC    QH_CCMTL,QH_CCMTL                                                
         JZ    BLDCLD25                                                         
         XC    N.CLDEL(CLDLNQ),N.CLDEL                                          
         MVI   N.CLDEL,CLDELQ                                                   
         MVI   N.CLDLN,L'CLDEL+L'CLDLN+L'CLDTYPE                                
         MVI   N.CLDTYPE,CLDCCMTQ                                               
         LLC   RF,QH_CCMTL                                                      
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   N.CLDCCMT(0),QH_CCMT                                             
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         LLC   RE,N.CLDLN                                                       
         AR    RE,RF                                                            
         STC   RE,N.CLDLN                                                       
         GOTOR ADDELE,EXCRECD                                                   
                                                                                
BLDCLD25 TM    CPXSTAT6,CPX2LAEI     WPP workflow                               
         JNZ   BLDCLD40                                                         
         XC    N.CLDEL(CLDLNQ),N.CLDEL                                          
         MVI   N.CLDEL,CLDELQ                                                   
         MVI   N.CLDLN,CLDL1LNQ                                                 
         MVI   N.CLDTYPE,CLDLMAPQ                                               
         LA    R6,HD_LMAP                                                       
AP       USING HD_LMAP,R6                                                       
         LA    R2,N.CLDLNTRY                                                    
CL       USING CLDLNTRY,R2                                                      
         MVC   N.CLDLNUM,HD_LMAPN                                               
         XR    RF,RF                                                            
         ICM   RF,1,HD_LMAPN       Do we have any line managers                 
         JZ    BLDCLD35                                                         
BLDCLD30 MVC   CL.CLDLSTAT,AP.HD_LMSTA                                          
         NI    CL.CLDLSTAT,FF-HD_THIST                                          
         MVC   CL.CLDLAPP,AP.HD_LMPID                                           
         MVC   CL.CLDLAPVL,AP.HD_LMVAL                                          
         MVC   CL.CLDLAPLV,AP.HD_LMLVL                                          
         LLC   RE,N.CLDLN                                                       
         AHI   RE,CLDLLNQ                                                       
         STC   RE,N.CLDLN                                                       
         LA    R6,HD_LMAPL(R6)                                                  
         LA    R2,CLDLLNQ(R2)                                                   
         JCT   RF,BLDCLD30                                                      
         DROP  AP,CL                                                            
                                                                                
BLDCLD35 GOTOR ADDELE,EXCRECD                                                   
                                                                                
BLDCLD40 XC    N.CLDEL(CLDLNQ),N.CLDEL                                          
         MVI   N.CLDEL,CLDELQ                                                   
         MVI   N.CLDLN,CLDL1LNQ                                                 
         MVI   N.CLDTYPE,CLDFNAPQ                                               
         LA    R6,HD_FNAP                                                       
AP       USING HD_FNAP,R6                                                       
         LA    R2,N.CLDFNTRY                                                    
CL       USING CLDFNTRY,R2                                                      
         MVC   N.CLDFNUM,HD_FNAPN                                               
         LLC   RF,HD_FNAPN                                                      
BLDCLD50 MVC   CL.CLDFSTAT,AP.HD_FNSTA                                          
         NI    CL.CLDFSTAT,FF-HD_THIST                                          
         MVC   CL.CLDFAPP,AP.HD_FNPID                                           
         LLC   RE,N.CLDLN                                                       
         AHI   RE,CLDFLNQ                                                       
         STC   RE,N.CLDLN                                                       
         LA    R6,HD_FNAPL(R6)                                                  
         LA    R2,CLDFLNQ(R2)                                                   
         JCT   RF,BLDCLD50                                                      
         DROP  AP,CL                                                            
                                                                                
         GOTOR ADDELE,EXCRECD                                                   
                                                                                
N        USING CBIELD,ELEMENT                                                   
         XC    N.CBIEL(CBILNQ),N.CBIEL                                          
         MVI   N.CBIEL,CBIELQ                                                   
         MVI   N.CBILN,CBILNQ                                                   
         MVC   N.CBIBNA,QH_BNAM                                                 
                                                                                
         OC    QH_BCOML,QH_BCOML                                                
         JZ    BLDCLD60                                                         
         LLC   RF,QH_BCOML                                                      
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   N.CBIBCO(0),QH_BCOM                                              
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         LLC   RE,N.CBILN                                                       
         AR    RE,RF                                                            
         STC   RE,N.CBILN                                                       
                                                                                
BLDCLD60 GOTOR ADDELE,EXCRECD                                                   
                                                                                
         CLC   HD_SUBP,SPACES      Already have submitted pid?                  
         JH    BLDCLD62                                                         
         CLI   QH_STAT,QH_SUBMQ    Submitting the expense claim?                
         JNE   BLDCLD70                                                         
         MVC   HD_SUBP,CCTPID      Only build when submitting the claim         
         GOTO1 VDATCON,DMCB,(5,0),(1,HD_SUBD)                                   
*                                                                               
N        USING CLDELD,ELEMENT                                                   
BLDCLD62 XC    N.CLDEL(CLDLNQ),N.CLDEL                                          
         MVI   N.CLDEL,CLDELQ      Build submitted CLDELD                       
         MVI   N.CLDLN,CLDSLNQ                                                  
         MVI   N.CLDTYPE,CLDSUBQ                                                
         MVC   N.CLDSTAT,HD_CLSTA                                               
         MVC   N.CLDSPID,HD_SUBP                                                
         MVC   N.CLDSDAT,HD_SUBD                                                
         GOTOR ADDELE,EXCRECD                                                   
                                                                                
BLDCLD70 OI    HD_IND,HD_CLDEL     Set CLDELD created                           
         J     EXITY                                                            
         DROP  N,R3                                                             
         EJECT                                                                  
***********************************************************************         
* Update index on audit claim record and update status elements to    *         
* last record - add new records where none exist or there isn't       *         
* enough room to store the audit data                                 *         
***********************************************************************         
                                                                                
UPDAUD   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*UPDAUD*'                                                      
                                                                                
         MVI   BYTE1,0             Sequence number                              
         MVI   BYTE2,0             Indicators                                   
                                                                                
         L     R3,AAUDREC                                                       
         USING AUDRECD,R3          R3=A(Audit record)                           
                                                                                
         CLI   QH_STAT,QH_DELQ     Is change to delete claim?                   
         JNE   UPDAUD02                                                         
         LA    R4,ELEMENT          Build delete status element                  
AUD      USING STCELD,R4                                                        
         GOTOR BLDSTC,STCXCLDL                                                  
                                                                                
***********************************************************************         
* Read audit record for current expense claim - update expense claim  *         
* status on all audit records for this period                         *         
***********************************************************************         
                                                                                
K        USING AUDKEY,IOKEY                                                     
UPDAUD02 XC    K.AUDKEY,K.AUDKEY   Build key of audit record                    
         MVI   K.AUDKTYP,AUDKTYPQ                                               
         MVI   K.AUDKSUB,AUDKSUBQ                                               
         MVI   K.AUDKAUDT,AUDKEXPC                                              
         MVC   K.AUDKCPY,CUXCPY                                                 
         MVC   K.AUDKCLM,QH_NUM                                                 
         MVC   K.AUDKCTY,QH_TYPE                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JNE   UPDAUD24                                                         
                                                                                
UPDAUD04 MVC   BYTE1,K.AUDKSEQ     Save current sequence number                 
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         MVC   AUDRINDX,HD_INDXN   Set new index number in record               
         MVC   AUDRSTAT,TR_ST1NW   Set new claim status                         
                                                                                
UPDAUD06 CLI   AUD.STCEL,0         Test end of status elements                  
         JE    UPDAUD12                                                         
                                                                                
UPDAUD08 GOTOR TSTFIT              Test data fits on current record             
         JH    UPDAUD12            No                                           
         GOTOR VHELLO,DMCB,(C'P',ACCMST),AUDRECD,AUD.STCELD,ADDEND              
         CLI   12(R1),0                                                         
         JE    UPDAUD10                                                         
         DC    H'0'                                                             
                                                                                
UPDAUD10 LLC   RE,AUD.STCLN        Bump to next audit element                   
         AR    R4,RE                                                            
         J     UPDAUD06                                                         
                                                                                
***********************************************************************         
* Here to write back current audit record and get next one            *         
***********************************************************************         
                                                                                
UPDAUD12 GOTOR SETDTE              Set low and high date on audit rec           
         CLC   HD_CLM#,QH_NUM                                                   
         JNE   UPDAUD14                                                         
         CLC   HD_CLMTY,QH_TYPE                                                 
         JE    *+8                                                              
UPDAUD14 OI    AUDRSTAT,EXCSDELT                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO1'                           
         JE    *+6                                                              
         DC    H'0'                                                             
         CLC   HD_CLM#,QH_NUM                                                   
         JNE   UPDAUD16                                                         
         CLC   HD_CLMTY,QH_TYPE                                                 
         JE    UPDAUD18                                                         
                                                                                
UPDAUD16 MVC   AUDKCLM,HD_CLM#                                                  
         MVC   AUDKCTY,HD_CLMTY                                                 
         NI    AUDRSTAT,X'FF'-EXCSDELT                                          
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO1'                           
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
UPDAUD18 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'                               
         CLC   K.AUDKEY(AUDKSEQ-AUDRECD),IOKEYSAV                               
         JE    UPDAUD04            Process next record                          
                                                                                
***********************************************************************         
* Here when all current audit records have been processed - set       *         
* sequence number of next audit record (to be added) and test if we   *         
* we have further elements to add                                     *         
***********************************************************************         
                                                                                
UPDAUD22 LLC   RE,BYTE1            Bump key sequence number                     
         AHI   RE,1                                                             
         STC   RE,BYTE1                                                         
                                                                                
UPDAUD24 CLI   AUD.STCEL,0         Test any status to add                       
         JE    EXITY               No - all done                                
         CLI   AUD.STCEL,STCELQ    Test status element                          
         JE    UPDAUD28                                                         
UPDAUD26 LLC   RE,AUD.STCLN        Bump to next audit element                   
         AR    R4,RE                                                            
         J     UPDAUD24                                                         
                                                                                
***********************************************************************         
* Here if audit record for current period doesn't exist or we have    *         
* run out of space for audit elements - create a new record and set   *         
* flag so that we issue an ADDREC                                     *         
***********************************************************************         
                                                                                
UPDAUD28 XC    AUDRECD(256),AUDRECD                                             
         MVC   AUDKEY,IOKEYSAV     Build a new audit record                     
         MVC   AUDKCLM,HD_CLM#                                                  
         MVC   AUDKCTY,HD_CLMTY                                                 
         MVC   AUDKSEQ,BYTE1                                                    
         LHI   R0,AUDRFST-AUDRECD                                               
         STCM  R0,3,AUDRLEN                                                     
         MVC   AUDRSTAT,TR_ST1NW                                                
         MVC   AUDRINDX,HD_INDXN                                                
         OI    BYTE2,X'40'         Set adding new records                       
                                                                                
UPDAUD30 CLI   AUD.STCEL,0         Test end of audit elements                   
         JE    UPDAUD36                                                         
                                                                                
UPDAUD32 GOTOR TSTFIT              Test element fits on current record          
         JH    UPDAUD36            No                                           
         GOTOR VHELLO,DMCB,(C'P',ACCMST),AUDRECD,AUD.STCELD,ADDEND              
         CLI   12(R1),0                                                         
         JE    UPDAUD34                                                         
         DC    H'0'                                                             
                                                                                
UPDAUD34 LLC   RE,AUD.STCLN        Bump to next element                         
         AR    R4,RE                                                            
         J     UPDAUD30                                                         
                                                                                
UPDAUD36 GOTOR SETDTE              Set low and high date on audit rec           
         TM    BYTE2,X'40'         Test creating a new record                   
         JZ    UPDAUD38                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO1'                           
         JE    UPDAUD22                                                         
         DC    H'0'                                                             
                                                                                
UPDAUD38 GOTOR (#IOEXEC,AIOEXEC),'IOPUTREC+IOMST+IO1'                           
         JE    UPDAUD22                                                         
         DC    H'0'                                                             
                                                                                
TSTFIT   SR    R0,R0               Test element fits on audit record            
         ICM   R0,3,AUDRLEN                                                     
         LLC   RF,AUD.STCLN                                                     
         AR    R0,RF                                                            
         CHI   R0,MAXRECLN         Set condition code                           
         BR    RE                                                               
                                                                                
SETDTE   XC    FULL2,FULL2                                                      
         MVC   FULL1,EFFS                                                       
         SR    R0,R0                                                            
         LA    R2,AUDRFST                                                       
         USING STCELD,R2                                                        
SETDTE02 CLI   STCEL,0                                                          
         JE    SETDTE08                                                         
         CLI   STCEL,STCELQ                                                     
         JE    SETDTE06                                                         
SETDTE04 LLC   RF,STCLN                                                         
         AR    R2,RF                                                            
         J     SETDTE02                                                         
                                                                                
SETDTE06 CLC   FULL2,STCDATE                                                    
         JNL   *+10                                                             
         MVC   FULL2,STCDATE                                                    
         CLC   FULL1,STCDATE                                                    
         JNH   *+10                                                             
         MVC   FULL1,STCDATE                                                    
         J     SETDTE04                                                         
                                                                                
SETDTE08 LR    R2,RE                                                            
         GOTOR VDATCON,DMCB,(1,FULL1),(2,AUDRSTDT)                              
         GOTOR VDATCON,DMCB,(1,FULL2),(2,AUDRENDT)                              
         BR    R2                                                               
         DROP  R2,R3,K,AUD                                                      
         EJECT                                                                  
***********************************************************************         
* Copy item line from old buffer to new buffer and flag as copied     *         
***********************************************************************         
                                                                                
CPYONE   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*CPYONE*'                                                      
                                                                                
         XC    CL_D(CL_KEYL),CL_D                                               
         OC    QX_ITM#,QX_ITM#     Are we dealing with extra data               
         JZ    CPYONE02            No                                           
         MVC   CL_ITEM#,QX_ITM#    Yes - use extra data item number             
         J     *+10                                                             
CPYONE02 MVC   CL_ITEM#,QI_ITM#    Set item row                                 
         MVC   CL_XDAT#,QX_CODE    Set extra data code                          
         GOTOR BUFCLM,DMCB,('TSARDH',OLDBUF),0                                  
         JE    *+6                                                              
         DC    H'0'                Yes die as it shouldn't be empty             
         OI    CL_BSTAT,CL_BSRCO   Set record copied from old buffer            
         GOTOR BUFCLM,DMCB,('TSAADD',NEWBUF),0                                  
         JE    EXITY                                                            
         DC    H'0'                                                             
         EJECT                                                                  
***********************************************************************         
* Copy old claim buffer to new claim buffer and flag records as copied*         
***********************************************************************         
                                                                                
CPYALL   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*CPYALL*'                                                      
                                                                                
         XC    CL_D(CL_KEYL),CL_D                                               
         GOTOR BUFCLM,DMCB,('TSARDH',OLDBUF),0                                  
         J     CPYALL04                                                         
CPYALL02 GOTOR BUFCLM,DMCB,('TSANXT',OLDBUF),0                                  
CPYALL04 TM    CLMERR,TSEEOF                                                    
         JNZ   EXITY                                                            
         OI    CL_BSTAT,CL_BSRCO   Set record copied from old buffer            
         GOTOR BUFCLM,DMCB,('TSAADD',NEWBUF),0                                  
         JE    CPYALL02            Get next record to add                       
         DC    H'0'                                                             
         EJECT                                                                  
***********************************************************************         
* Validate old buffer as we are going to create postings from it      *         
***********************************************************************         
                                                                                
VALOLD   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*VALOLD*'                                                      
                                                                                
         XC    OLD.CL_D(CL_KEYL),OLD.CL_D                                       
         GOTOR BUFCLM,DMCB,('TSARDH',OLDBUF),OLD.CL_D                           
         TM    CLMERR,TSEEOF       Is it the end of the buffer?                 
         JNO   VALOLD04            No                                           
         DC    H'0'                Yes die as it shouldn't be empty             
                                                                                
VALOLD02 GOTOR BUFCLM,DMCB,('TSANXT',OLDBUF),OLD.CL_D                           
         TM    CLMERR,TSEEOF       Is it the end of the buffer?                 
         JNZ   EXITY               Yes                                          
                                                                                
VALOLD04 GOTOR CHKCLD,OLD.CL_D                                                  
         OI    OLD.CL_BSTAT,CL_BSROB   Set we found this one                    
         GOTOR BUFCLM,DMCB,('TSAWRT',OLDBUF),0                                  
         JE    *+6                                                              
         DC    H'0'                                                             
         J     VALOLD02                                                         
                                                                                
***********************************************************************         
* Create status change elements and set approval elements             *         
* determine what the status should be for the expense claim           *         
***********************************************************************         
                                                                                
DOSTAT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*DOSTAT*'                                                      
                                                                                
         TM    HD_IND,HD_INOPR     Test no previous claim                       
         JNZ   DOST0150            Yes                                          
                                                                                
         GOTOR BLDAPP              Build table of approvers                     
                                                                                
         XC    NEW.CL_D(CL_KEYL),NEW.CL_D                                       
         GOTOR BUFCLM,DMCB,('TSARDH',NEWBUF),NEW.CL_D                           
         TM    CLMERR,TSEEOF       Is it the end of the buffer?                 
         JNO   DOST0012            No                                           
         SR    RF,RF                                                            
         ICM   RF,3,CUXPNUM                                                     
         CHI   RF,XPRODIKQ         Aura                                         
         JE    DOST0140            Yes don't die if empty                       
         DC    H'0'                BO die as it shouldn't be empty              
                                                                                
DOST0010 GOTOR BUFCLM,DMCB,('TSANXT',NEWBUF),NEW.CL_D                           
         TM    CLMERR,TSEEOF       Is it the end of the buffer?                 
         JNZ   DOST0140            Yes                                          
                                                                                
DOST0012 OC    NEW.CL_XDAT#,NEW.CL_XDAT# Xdata doesn't have deleted             
         JNZ   *+12                         status bit so don't test            
         TM    NEW.CL_STAT,CIDMSID Was this item deleted                        
         JNZ   DOST0010            Yes                                          
         NI    TR_INDCL,X'FF'-TR_IAPTT  Clear approved this time                
         XC    CS_IND1,CS_IND1                                                  
         XC    CL_D(CL_KEYL),CL_D                                               
         MVC   CL_#,NEW.CL_#       Read old buffer record                       
         GOTOR BUFCLM,DMCB,('TSARDH',OLDBUF),0                                  
         JNE   DOST0060            Not found  - must be a new row               
                                                                                
         MVI   BYTE1,0             Set nothing has changed                      
         MVI   BYTE2,0                                                          
         MVI   BYTE3,0                                                          
         MVI   BYTE4,0                                                          
         MVI   MYBYTE5,0                                                        
         OC    NEW.CL_XDAT#,NEW.CL_XDAT#                                        
         JZ    DOST0014                                                         
                                                                                
***********************************************************************         
* Test changes to extra data                                          *         
***********************************************************************         
                                                                                
         CLC   CL_XVALS(CL_XVALL),NEW.CL_XVALS                                  
         JE    DOST0070                                                         
         J     DOST0055                                                         
                                                                                
***********************************************************************         
* Test changes to claim item data                                     *         
***********************************************************************         
                                                                                
DOST0014 TM    NEW.CL_BSTAT,CL_BSRCO Was this record copied                     
         JZ    DOST0017            No - therefore already validated             
         GOTOR CHKCLD,NEW.CL_D     Check details                                
         GOTOR GETCAP,DMCB,NEW.CL_D Get app for client account                  
         JE    DOST0016                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'CL_SJAC,NEW.CL_SJAC),NEW.CL_ITEM#         
DOST0016 GOTOR ADDAPP,NEW.CL_BDATA                                              
*                                                                               
DOST0017 CP    CL_DAMT,NEW.CL_DAMT                                              
         JE    *+8                                                              
         OI    BYTE4,STCXSDSC      Set discount amount has changed              
                                                                                
         LLC   RF,PCLILEN                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         CLC   CL_SJAC(0),NEW.CL_SJAC                                           
         EX    RF,0(RE)                                                         
         JE    DOST0018                                                         
         OI    BYTE3,STCXSCLI      Set client is different                      
         LLC   RF,PCLILEN                                                       
         LA    RF,NEW.CL_SJAC(RF)                                               
         CLI   0(RF),C' '          Have we got a product                        
         JNH   DOST0024            No                                           
         OI    BYTE3,STCXSPRO      Yes - must be a new product                  
         J     DOST0020            Check if we have job                         
                                                                                
DOST0018 AHI   RF,1                                                             
         LA    R1,CL_SJAC                                                       
         LA    R2,NEW.CL_SJAC                                                   
         AR    R1,RF                                                            
         AR    R2,RF                                                            
         LLC   RE,PPROLEN                                                       
         SR    RE,RF                                                            
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         CLC   0(0,R1),0(R2)       Compare product codes                        
         EX    RE,0(RF)                                                         
         JE    DOST0022                                                         
         OI    BYTE3,STCXSPRO      Set product is different                     
DOST0020 LLC   RE,PPROLEN                                                       
         LA    RF,NEW.CL_SJAC(RE)                                               
         CLI   0(RF),C' '          Have we got a job                            
         JNH   DOST0024                                                         
         OI    BYTE3,STCXSJOB      Yes  - job must be different                 
         J     DOST0024                                                         
                                                                                
DOST0022 AHI   RE,1                                                             
         AR    R1,RE                                                            
         AR    R2,RE                                                            
         LLC   RE,PJOBLEN                                                       
         LLC   RF,PPROLEN                                                       
         SR    RE,RF                                                            
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         CLC   0(0,R1),0(R2)       Compare job codes                            
         EX    RE,0(RF)                                                         
         JE    *+8                                                              
         OI    BYTE3,STCXSJOB      Set job is different                         
                                                                                
DOST0024 CLC   CL_ADAT,NEW.CL_ADAT                                              
         JE    *+8                                                              
         OI    BYTE3,STCXSDTE      Set date has changed                         
         CLC   CL_FCUR,NEW.CL_FCUR                                              
         JE    *+8                                                              
         OI    BYTE3,STCXSFCC      Set currency code has changed                
         CP    CL_FAMT,NEW.CL_FAMT                                              
         JE    *+8                                                              
         OI    BYTE3,STCXSFAM      Set currency amount has changed              
                                                                                
         CP    CL_MILE,NEW.CL_MILE                                              
         JE    *+8                                                              
         OI    BYTE2,STCXSMIL      Set miles has changed                        
                                                                                
         MVC   MYBYTE1,NEW.CL_STAT                                              
         MVC   MYBYTE4,CL_STAT                                                  
         NI    MYBYTE4,CIDMDIS                                                  
         NI    MYBYTE1,CIDMDIS                                                  
         CLC   MYBYTE1,MYBYTE4                                                  
         JE    *+8                                                              
         OI    BYTE4,STCXSDIS      Set disclaimer has changed                   
                                                                                
         CLC   CL_VEHC,NEW.CL_VEHC Has vehicle changed                          
         JE    *+8                                                              
         OI    BYTE4,STCXSVEH                                                   
                                                                                
         CLC   CL_ENGC,NEW.CL_ENGC Has engine changed                           
         JE    *+8                                                              
         OI    BYTE4,STCXSENG                                                   
                                                                                
         CLC   CL_FUEL,NEW.CL_FUEL Has fuel changed                             
         JE    *+8                                                              
         OI    BYTE4,STCXSFUE                                                   
                                                                                
         CLC   CL_PASS,NEW.CL_PASS Have the number of passengers                
         JE    *+8                                       changed                
         OI    MYBYTE5,STCXSPAS                                                 
                                                                                
         CLI   NEW.CL_RCPTC,YESQ   Has the receipt image changed                
         JNE   *+8                                                              
         OI    MYBYTE5,STCXRCPT    Set it has changed                           
                                                                                
         CLI   HD_USRFN,YESQ       Check the following fields as they           
         JNE   DOST0040            are only available to finance                
         TM    RUNINDS,RUNIAURA                                                 
         JNZ   *+12                                                             
         CLI   QH_STAT,QH_SAVEQ    and not when only saving on brandocn         
         JE    DOST0040                                                         
         CLC   CL_NARL(L'CL_NARL+L'CL_NAR),NEW.CL_NARL                          
         JE    DOST0034                                                         
         OC    CL_NARL,CL_NARL     Did we have a finance narrative              
         JNZ   DOST0026            Yes                                          
         OI    BYTE4,STCXSFNA      No - Set fin narr added                      
         J     DOST0034                                                         
                                                                                
DOST0026 OC    NEW.CL_NARL,NEW.CL_NARL Do we have a fin narrative               
         JZ    DOST0028            No                                           
         OI    BYTE4,STCXSFNC      Yes - Set fin narr changed                   
         J     DOST0034                                                         
                                                                                
DOST0028 OI    BYTE4,STCXSFND      Set fin narr deleted                         
                                                                                
DOST0034 CLC   CL_EXAC,NEW.CL_EXAC                                              
         JE    *+8                                                              
         OI    BYTE1,STCXXAC      Set expense account changed                   
                                                                                
         CLC   CL_INT,NEW.CL_INT                                                
         JE    *+8                                                              
         OI    BYTE3,STCXSINT      Set internal ref has changed                 
                                                                                
         CLC   CL_OFF,NEW.CL_OFF                                                
         JE    *+8                                                              
         OI    BYTE3,STCXSOFF      Set office has changed                       
                                                                                
         CLC   CL_SUPAC,NEW.CL_SUPAC                                            
         JE    *+8                                                              
         OI    BYTE2,STCXSSAC      Set supplier account has changed             
*&&US                                                                           
         CLC   CL_VATC,NEW.CL_VATC Change of GST code?                          
         JNE   DOST0035                                                         
         CLC   CL_PSTC,NEW.CL_PSTC Change of PST code?                          
         JNE   DOST0035                                                         
         CLC   CL_PROV,NEW.CL_PROV Or change of province?                       
         JE    DOST0038                                                         
*&&                                                                             
*&&UK                                                                           
         TM    CPYSTAT5,CPYSNVAT                                                
         JZ    DOST0036                                                         
         CLC   CL_VATC,NEW.CL_VATC                                              
         JE    DOST0038                                                         
*&&                                                                             
DOST0035 OI    BYTE2,STCXSVAT      Set VAT account has changed                  
         J     DOST0038                                                         
                                                                                
DOST0036 OC    CL_VATAC,SPACES                                                  
         OC    NEW.CL_VATAC,SPACES                                              
         CLC   CL_VATAC,NEW.CL_VATAC                                            
         JE    *+8                                                              
         OI    BYTE2,STCXSVAT      Set VAT account has changed                  
                                                                                
DOST0038 OC    CL_2DAC,SPACES                                                   
         OC    NEW.CL_2DAC,SPACES                                               
         CLC   CL_2DAC,NEW.CL_2DAC                                              
         JE    *+8                                                              
         OI    BYTE2,STCXS2DA      Set dept account has changed                 
                                                                                
         OC    CL_2PAC,SPACES                                                   
         OC    NEW.CL_2PAC,SPACES                                               
         CLC   CL_2PAC,NEW.CL_2PAC                                              
         JE    *+8                                                              
         OI    BYTE2,STCXS2PA      Set personnel account has changed            
                                                                                
         CLC   CL_REF,NEW.CL_REF                                                
         JE    *+8                                                              
         OI    BYTE2,STCXSREF      Set reference has changed                    
                                                                                
         MVC   MYBYTE1,NEW.CL_STAT                                              
         MVC   MYBYTE4,CL_STAT                                                  
         NI    MYBYTE4,CIDMSSS                                                  
         NI    MYBYTE1,CIDMSSS                                                  
         CLC   MYBYTE1,MYBYTE4                                                  
         JE    *+8                                                              
         OI    BYTE2,STCXSSEL      Set is selected  has changed                 
                                                                                
         CLC   CL_WC,NEW.CL_WC     Has the work code changed?                   
         JE    *+8                 No                                           
         OI    BYTE1,STCXSWC       Set work code changed                        
                                                                                
DOST0040 CLC   CL_RECPT,NEW.CL_RECPT                                            
         JE    *+8                                                              
         OI    BYTE2,STCXSRCP      Set has receipt  has changed                 
                                                                                
         CLC   CL_ITYPE,NEW.CL_ITYPE                                            
         JE    *+8                                                              
         OI    BYTE1,STCXSTYP      Set type of item changed                     
                                                                                
         CLC   CL_NAROL(L'CL_NAROL+L'CL_NARO),NEW.CL_NAROL                      
         JE    *+8                                                              
         OI    BYTE1,STCXSNAR      Set text has changed                         
         CLC   CL_EST,NEW.CL_EST                                                
         JE    *+8                                                              
         OI    BYTE1,STCXSEST      Set estimate has changed                     
         CLC   CL_ETYP,NEW.CL_ETYP                                              
         JE    *+8                                                              
         OI    BYTE1,STCXSETY      Set etype has changed                        
         CP    CL_AMT,NEW.CL_AMT                                                
         JE    *+8                                                              
         OI    BYTE1,STCXSAMT      Set amount has changed                       
                                                                                
DOST0050 CLI   BYTE1,0             Has anything changed                         
         JNE   DOST0055            Yes                                          
         CLI   BYTE2,0                                                          
         JNE   DOST0055            Yes                                          
         CLI   BYTE3,0                                                          
         JNE   DOST0055            Yes                                          
         CLI   BYTE4,0                                                          
         JNE   DOST0055            Yes                                          
         CLI   MYBYTE5,0                                                        
         JE    DOST0070            No                                           
                                                                                
***********************************************************************         
* Changes to this row                                                 *         
***********************************************************************         
                                                                                
DOST0055 GOTOR AUDCHA              Log changes for audit record                 
         OC    NEW.CL_XDAT#,NEW.CL_XDAT#                                        
         JNZ   DOST0080                                                         
         OI    CS_IND1,CS_ICHG                                                  
         GOTOR SUBDIS,CL_D         Subtract the old distance                    
         GOTOR ADDDIS,NEW.CL_D     Add the new distance                         
         AP    HD_ITCNT,PONE       count items                                  
         AP    TR_TAMT,NEW.CL_AMT  total up claims items                        
         J     DOST0080                                                         
                                                                                
***********************************************************************         
* New row added                                                       *         
***********************************************************************         
                                                                                
DOST0060 GOTOR AUDADD              Log additions to audit record                
         OC    NEW.CL_XDAT#,NEW.CL_XDAT#                                        
         JNZ   DOST0065                                                         
         OI    CS_IND1,CS_IADD                                                  
         GOTOR ADDDIS,NEW.CL_D     Add the new distance                         
         AP    HD_ITCNT,PONE       count items                                  
         AP    TR_TAMT,NEW.CL_AMT  total up claims items                        
DOST0065 OI    NEW.CL_BSTAT,CL_BSRNR                                            
         J     DOST0085                                                         
                                                                                
***********************************************************************         
* No changes to this row                                              *         
***********************************************************************         
                                                                                
DOST0070 GOTOR AUDAPP              Log approvals                                
         OC    NEW.CL_XDAT#,NEW.CL_XDAT#                                        
         JNZ   DOST0080                                                         
         GOTOR WRKDIS                                                           
         AP    HD_ITCNT,PONE       count items                                  
         AP    TR_TAMT,NEW.CL_AMT  total up claims items                        
                                                                                
DOST0080 OI    CL_BSTAT,CL_BSROB   Set we found this one                        
         GOTOR BUFCLM,DMCB,('TSAWRT',OLDBUF),0                                  
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
DOST0085 OC    NEW.CL_XDAT#,NEW.CL_XDAT#                                        
         JNZ   DOST0010                                                         
         CLI   NEW.CL_ITYPE,CS_IADVQ                                            
         JE    *+8                                                              
         OI    HD_IND,HD_NADV      Set not all advances                         
         CLI   NEW.CL_ITYPE,CS_IADVQ                                            
         JNE   DOST0090                                                         
         OI    HD_CLSTA,CLDSADVQ   Set we have advances                         
         OI    TR_ST2NW,EXCKSADQ                                                
*&&UK                                                                           
DOST0090 CLC   NEW.CL_FCUR,HD_CURR                                              
*&&                                                                             
*&&US                                                                           
DOST0090 CLC   NEW.CL_FCUR,AGYCURR                                              
*&&                                                                             
         JE    DOST0095                                                         
         OI    TR_ST2NW,EXCKSFCQ                                                
                                                                                
DOST0095 LA    RF,NEW.CL_AP                                                     
         LA    R0,CL_MAXA                                                       
DOST0100 OC    L'CL_APSTA(L'CL_APPID,RF),L'CL_APSTA(RF) Any approvers           
         JZ    DOST0110            No - treat as approved                       
         TM    0(RF),CIDAANR       Do we require approval                       
         JNZ   DOST0110            no                                           
         LA    R2,APRPIDS                                                       
DOST0102 OC    0(L'CL_APPID,R2),0(R2)                                           
         JZ    DOST0104                                                         
         CLC   L'CL_APSTA(L'CL_APPID,RF),0(R2)                                  
         JE    DOST0106                                                         
         LA    R2,L'CL_APPID(R2)                                                
         J     DOST0102                                                         
                                                                                
DOST0104 MVC   0(L'CL_APPID,R2),L'CL_APSTA(RF)                                  
         AP    HD_APCNT,PONE       count approvers                              
                                                                                
DOST0106 TM    0(RF),CIDAAPP       Yes - is it approved                         
         JNZ   DOST0120            Yes                                          
         OI    TR_INDCL,TR_IMCLI   Set missing client approval                  
         J     DOST0130                                                         
                                                                                
DOST0110 OI    TR_INDCL,TR_INCLI   No client approval required                  
         J     DOST0130                                                         
                                                                                
DOST0120 OI    TR_INDCL,TR_ICLIA   Some time is client approved                 
                                                                                
DOST0130 LA    RF,CL_APL(RF)                                                    
         JCT   R0,DOST0100                                                      
                                                                                
DOST0135 GOTOR BUFCLM,DMCB,('TSAWRT',NEWBUF),NEW.CL_D                           
         JE    DOST0010                                                         
         DC    H'0'                                                             
                                                                                
DOST0140 GOTOR AUDDEL              Audit deleted claim rows                     
         J     DOST0250                                                         
                                                                                
***********************************************************************         
* Create status elements and update approvals for new claims          *         
***********************************************************************         
                                                                                
DOST0150 XC    NEW.CL_D(CL_KEYL),NEW.CL_D                                       
         GOTOR BUFCLM,DMCB,('TSARDH',NEWBUF),NEW.CL_D                           
         TM    CLMERR,TSEEOF       Is it the end of the buffer?                 
         JNO   DOST0170            No                                           
         J     DOST0230            Yes - no items                               
                                                                                
DOST0160 GOTOR BUFCLM,DMCB,('TSANXT',NEWBUF),NEW.CL_D                           
         TM    CLMERR,TSEEOF       Is it the end of the buffer?                 
         JNZ   DOST0230            Yes - add line manager approval el           
                                                                                
DOST0170 GOTOR AUDADD                                                           
         OC    NEW.CL_XDAT#,NEW.CL_XDAT#                                        
         JNZ   DOST0160                                                         
         GOTOR ADDDIS,NEW.CL_D     Add the new distance                         
         CLI   NEW.CL_ITYPE,CS_IADVQ                                            
         JNE   DOST0175                                                         
         OI    HD_CLSTA,CLDSADVQ   Set we have advances                         
         OI    TR_ST2NW,EXCKSADQ                                                
                                                                                
DOST0175 CLI   NEW.CL_ITYPE,CS_IADVQ                                            
         JE    *+8                                                              
         OI    HD_IND,HD_NADV      Set not all advances                         
                                                                                
*&&UK*&& CLC   NEW.CL_FCUR,HD_CURR                                              
*&&US*&& CLC   NEW.CL_FCUR,AGYCURR                                              
         JE    DOST0180                                                         
         OI    TR_ST2NW,EXCKSFCQ                                                
                                                                                
DOST0180 AP    HD_ITCNT,PONE       count items                                  
         AP    TR_TAMT,NEW.CL_AMT  total up claims items                        
         LA    RF,NEW.CL_AP                                                     
         LA    R0,CL_MAXA                                                       
DOST0182 OC    L'CL_APSTA(L'CL_APPID,RF),L'CL_APSTA(RF)  Any approver           
         JZ    DOST0190            No - treat as approved                       
         TM    0(RF),CIDAANR       Do we require approval                       
         JNZ   DOST0190            no                                           
         LA    R2,APRPIDS                                                       
DOST0184 OC    0(L'CL_APPID,R2),0(R2)                                           
         JZ    DOST0186                                                         
         CLC   L'CL_APSTA(L'CL_APPID,RF),0(R2)                                  
         JE    DOST0188                                                         
         LA    R2,L'CL_APPID(R2)                                                
         J     DOST0184                                                         
                                                                                
DOST0186 MVC   0(L'CL_APPID,R2),L'CL_APSTA(RF)                                  
         AP    HD_APCNT,PONE       count approvers                              
                                                                                
DOST0188 TM    0(RF),CIDAAPP       Yes - is it approved                         
         JNZ   DOST0200            Yes                                          
         OI    TR_INDCL,TR_IMCLI   Set missing client approval                  
         J     DOST0210                                                         
                                                                                
DOST0190 OI    TR_INDCL,TR_INCLI   No client approval required                  
         J     DOST0210                                                         
                                                                                
DOST0200 OI    TR_INDCL,TR_ICLIA   Some time is client approved                 
                                                                                
DOST0210 LA    RF,CL_APL(RF)                                                    
         JCT   R0,DOST0182                                                      
                                                                                
DOST0220 GOTOR BUFCLM,DMCB,('TSAWRT',NEWBUF),NEW.CL_D                           
         JE    DOST0160                                                         
         DC    H'0'                                                             
                                                                                
         USING STCELD,R4                                                        
DOST0230 GOTOR BLDSTC,STCXCLAD                                                  
         MVI   STCDFR,C'A'                                                      
         LA    R1,EXSTTAB                                                       
         USING EXSTTABD,R1                                                      
DOST0235 CLI   EXSTCHAR,X'FF'                                                   
         JE    DOST0245                                                         
         CLC   EXSTSTA,TR_ST1NW                                                 
         JE    DOST0240                                                         
         LA    R1,EXSTTABL(R1)                                                  
         J     DOST0235                                                         
                                                                                
DOST0240 MVC   STCDTO,EXSTCHAR                                                  
DOST0245 AHI   R4,STCXLN1Q                                                      
         DROP  R1                                                               
***********************************************************************         
* Look at approvals and work out new overall status for expense claim *         
***********************************************************************         
                                                                                
* claim was saved previously                                                    
                                                                                
DOST0250 CLC   QH_CCMTL(L'QH_CCMT+L'QH_CCMTL),HD_CCMTL Comments change          
         JE    DOST0254            No                                           
         GOTOR BLDSTC,STCXCMTC     Yes                                          
         CLI   QH_CCMTL,0          Have we deleted the comments                 
         JE    DOST0252            Yes                                          
         CLI   HD_CCMTL,0          No - Did we have comments prev               
         JNE   *+8                 No                                           
         MVI   STCXTYP,STCXCMTA    Yes - Set claimant comments added            
         LLC   RF,QH_CCMTL                                                      
         BCTR  RF,0                                                             
         BASR  R1,0                                                             
         MVC   STCXCOMT(0),QH_CCMT                                              
         EX    RF,0(R1)                                                         
         AHI   RF,STCXLN2Q+1                                                    
         STC   RF,STCLN                                                         
         J     *+8                                                              
                                                                                
DOST0252 MVI   STCXTYP,STCXCMTD                                                 
         LLC   RF,STCLN                                                         
         AR    R4,RF               Point to next output element                 
                                                                                
DOST0254 CLC   QH_DESCL(L'QH_DESC+L'QH_DESCL),HD_DESCL Descript change          
         JE    DOST0258            No                                           
         GOTOR BLDSTC,STCXDESC     Yes                                          
         CLI   HD_DESCL,0          No - Did we have a description prev          
         JNE   *+8                 No                                           
         MVI   STCXTYP,STCXDESA    Yes - Set description added                  
         LLC   RF,QH_DESCL                                                      
         BCTR  RF,0                                                             
         BASR  R1,0                                                             
         MVC   STCXCOMT(0),QH_DESC                                              
         EX    RF,0(R1)                                                         
         AHI   RF,STCXLN2Q+1                                                    
         STC   RF,STCLN                                                         
         AR    R4,RF               Point to next output element                 
         DROP  R4                                                               
                                                                                
DOST0258 CLI   QH_STAT,QH_SUBMQ    Are we now submitting?                       
         JNE   DOST0260            No                                           
         TM    HD_IND,HD_NADV      Check claim contains more than advce         
         JNZ   DOST0260                                                         
         MVC   ROUERRV,=AL2(AE$ADVNA)                                           
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
DOST0260 CLI   HD_ST1FR,0          Claim saved before                           
         JE    DOST0262            Yes                                          
         TM    HD_ST1FR,EXCSLOGD                                                
         JZ    DOST0268                                                         
DOST0262 CLI   QH_STAT,QH_SUBMQ    Are we now submitting?                       
         JE    DOST0290                                                         
         CLI   QH_STAT,QH_SAVEQ    Or are we saving again?                      
         JE    *+6                                                              
         DC    H'0'                Anything else from save should die           
         MVI   TR_ST1NW,0                                                       
         J     DOST0350                                                         
                                                                                
* Claim was previously submitted, part approved, rejected                       
                                                                                
DOST0268 TM    HD_ST1FR,EXCSSUBM   Claim submitted before                       
         JNZ   DOST0270                                                         
         TM    HD_ST1FR,EXCSPAPP   Claim part approved                          
         JNZ   DOST0270                                                         
         TM    HD_ST1FR,EXCSCOMP   Claim was fully approved                     
         JNZ   DOST0270                                                         
         TM    HD_ST1FR,EXCSFNTA   Finance need to approve                      
         JNZ   DOST0270                                                         
         TM    HD_ST1FR,EXCSREJE   Claim was rejected                           
         JNZ   *+6                                                              
         DC    H'0'                                                             
                                                                                
DOST0270 CLI   QH_STAT,QH_SUBMQ    Are we now submitting?                       
         JE    DOST0290            Yes                                          
         CLI   HD_USRFN,YESQ       If finance edit all ok stay as               
         JNE   DOST0272                                                         
         CLI   QH_STAT,QH_SAVEQ    Are we making changes?                       
         JE    DOST0300                                                         
         CLI   QH_STAT,QH_APPQ                                                  
         JE    DOST0300                                                         
         J     DOST0340                                                         
DOST0272 CLI   HD_USRLM,YESQ                                                    
         JNE   *+12                                                             
DOST0275 CLI   QH_STAT,QH_SAVEQ    Are we now submitting?                       
         JE    DOST0290            Yes                                          
         CLI   QH_STAT,QH_APPQ     Are we approving?                            
         JNE   DOST0340            No                                           
         J     DOST0290                                                         
                                                                                
*OST0280 CLI   QH_STAT,QH_REJQ     Are we rejecting?                            
*        JE    DOST0290            Yes                                          
*        TM    TR_INDFN,TR_IRMFN   Was there any change to the data             
*        JNZ   DOST0290            Yes                                          
*        TM    HD_ST1FR,EXCSREJE   No - Claim was rejected previously           
*        JZ    DOST0290            No                                           
*        MVC   ROUERRV,=AL2(AE$MXCHG) Yes - error user must make change         
*        GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
                                                                                
DOST0290 TM    TR_INDCL,TR_IMCLI   Are we missing some cli approvals?           
         JZ    DOST0300            No                                           
         TM    CPXSTAT6,CPX2LAEI   WPP workflow                                 
         JNZ   DOST0295            Yes                                          
         OI    TR_ST2NW,EXCKSLMQ   Set missing line manager                     
         TM    TR_INDLM,TR_ILMGA   Has a line manager approved?                 
         JZ    DOST0295                                                         
         MVI   TR_ST1NW,EXCSPAPP   Yes - line manager approved                  
         TM    TR_INDLM,TR_ILNMG   Have we got all line manager app             
         JZ    DOST0350            No                                           
         NI    TR_ST2NW,FF-EXCKSLMQ Set missing line manager                    
         J     DOST0350                                                         
                                                                                
DOST0295 OI    TR_ST2NW,EXCKSCLQ   Set missing client approvals                 
         MVI   TR_ST1NW,EXCSSUBM   Awaiting line man approval                   
         TM    TR_INDLM,TR_ILMGA   Has a line manager approved?                 
         JNZ   *+12                                                             
         TM    TR_INDCL,TR_ICLIA   Have we got any client approval              
         JZ    DOST0350            No - so claim sub and awaiting               
         MVI   TR_ST1NW,EXCSPAPP   Yes - ts part approved n wait                
         J     DOST0350                                                         
                                                                                
DOST0300 MVI   TR_ST1NW,EXCSFNTA   Set fully approved if line man app           
         TM    CPXSTAT6,CPX2LAEI                                                
         JNZ   DOST0310                                                         
         TM    TR_INDLM,TR_ILNMG   Have we got line manager app                 
         JZ    DOST0295            No                                           
DOST0310 TM    TR_INDFN,TR_IFNMG   Have we got finance  app                     
         JZ    DOST0320            No                                           
         MVI   TR_ST1NW,EXCSCOMP   Yes - set as complete                        
         TM    HD_ST1FR,EXCSFNTA   Was the claim awaiting finance               
         JNZ   DOST0350            Yes                                          
                                                                                
DOST0320 CLC   TR_ST1NW,HD_ST1FR   Is the claim status different?               
         JE    DOST0350            No                                           
         TM    HD_ST2FR,EXCKSFRQ   Did finance reject previously?               
         JNZ   DOST0350                                                         
         MVC   HD_APDTE,HD_TODP    Set today as the date it became              
         MVC   HD_APPID,CCTPID     available to finance approvers               
         J     DOST0350                                                         
                                                                                
DOST0340 CLI   QH_STAT,QH_REJQ     Are we rejecting?                            
         JNE   *+12                                                             
         MVI   TR_ST1NW,EXCSREJE                                                
         J     DOST0350                                                         
                                                                                
         CLI   QH_STAT,QH_SAVEQ    Are we saving?                               
         JE    *+6                                                              
         DC    H'0'                                                             
         MVI   TR_ST1NW,0                                                       
         TM    HD_ST1FR,EXCSREJE   Was it rejected before?                      
         JZ    DOST0350                                                         
         MVI   TR_ST1NW,EXCSREJE   Yes - keep as rejected until submit          
                                                                                
DOST0350 TM    HD_ST1FR,EXCSREJE   No - Claim was rejected previously           
         JZ    DOST0352            No                                           
         TM    TR_ST1NW,EXCSREJE   Are we still rejected                        
         JNZ   DOST0352            Yes                                          
         TM    TR_ST1NW,EXCSFNTA   Has it gone straight back                    
         JNZ   DOST0352                          to fully approved              
         XC    HD_APDTE,HD_APDTE   No - then clear approved date and            
         XC    HD_APPID,HD_APPID   pid                                          
                                                                                
DOST0352 TM    TR_ST1NW,EXCSSUBM   Is the claim status submitted?               
         JZ    DOST0370            No                                           
         CLI   HD_ST1FR,0          Was it saved before?                         
         JE    DOST0360            Yes                                          
         TM    HD_ST1FR,EXCSLOGD   Was it deleted before?                       
         JNZ   DOST0360                                                         
         TM    HD_ST1FR,EXCSREJE   Was it rejected before?                      
         JZ    DOST0390                                                         
                                                                                
DOST0360 GOTOR NOTCLI              Set cli approvers for notification           
         GOTOR SETMGR              Set manager for notification                 
         J     DOST0390                                                         
                                                                                
DOST0370 TM    TR_ST1NW,EXCSFNTA   Test awaiting fin manager approval           
         JZ    DOST0390            No                                           
         CLI   HD_ST1FR,0          Previous just saved?                         
         JE    DOST0380                                                         
         TM    HD_ST1FR,EXCSREJE   Was it rejected before?                      
         JNZ   DOST0380                                                         
         TM    HD_ST1FR,EXCSSUBM   Was it submitted before?                     
         JNZ   DOST0380                                                         
         TM    HD_ST1FR,EXCSPAPP   Was it part approved before?                 
         JZ    DOST0390                                                         
DOST0380 GOTOR SETFIN              Set manager for notification                 
                                                                                
DOST0390 CLC   TR_ST1NW,HD_ST1FR   Is the claim status different?               
         JE    DOST0460                                                         
         USING STCELD,R4                                                        
         GOTOR BLDSTC,STCXCLMS                                                  
         MVI   STCDFR,C'A'                                                      
         LA    R1,EXSTTAB                                                       
         USING EXSTTABD,R1                                                      
DOST0400 CLI   EXSTCHAR,X'FF'                                                   
         JE    DOST0420                                                         
         CLC   EXSTSTA,HD_ST1FR                                                 
         JE    DOST0410                                                         
         LA    R1,EXSTTABL(R1)                                                  
         J     DOST0400                                                         
                                                                                
DOST0410 MVC   STCDFR,EXSTCHAR                                                  
                                                                                
DOST0420 LA    R1,EXSTTAB                                                       
         USING EXSTTABD,R1                                                      
DOST0430 CLI   EXSTCHAR,X'FF'                                                   
         JNE   *+6                                                              
         DC    H'0'                                                             
         CLC   EXSTSTA,TR_ST1NW                                                 
         JE    DOST0440                                                         
         LA    R1,EXSTTABL(R1)                                                  
         J     DOST0430                                                         
                                                                                
DOST0440 MVC   STCDTO,EXSTCHAR                                                  
         DROP  R1                                                               
         MVC   STCXALVL,HD_HIST                                                 
         CLI   HD_USRFN,YESQ                                                    
         JNE   *+8                                                              
         OI    STCXALVL,STCXALVF   Finance approval                             
         CLI   HD_USRLM,YESQ                                                    
         JNE   *+8                                                              
         OI    STCXALVL,STCXALM1   Line manager                                 
DOST0450 MVI   STCLN,STCXLN2Q                                                   
         AHI   R4,STCXLN2Q                                                      
                                                                                
DOST0460 CLI   HD_COCAE,YESQ       Do we chose own approvers                    
         JNE   DOST0468            No                                           
         LA    R3,HD_OLMAP         Yes - audit any changes made                 
OLM      USING HD_OLMAP,R3                                                      
         LA    R6,HD_LMAP                                                       
LM       USING HD_LMAP,R6                                                       
         LA    R2,HD_MAXA                                                       
DOST0462 CLC   LM.HD_LMPID,OLM.HD_OLMPD                                         
         JE    DOST0466                                                         
         OC    LM.HD_LMPID,LM.HD_LMPID Do we now have a PID                     
         JZ    DOST0464            No                                           
         GOTOR BLDSTC,STCXAPAD     Yes - audit change                           
         MVC   STCXAPLV,LM.HD_LMLVL                                             
         MVC   STCXAPID,LM.HD_LMPID                                             
         MVI   STCLN,STCXLN5Q                                                   
         AHI   R4,STCXLN5Q                                                      
                                                                                
DOST0464 OC    OLM.HD_OLMPD,OLM.HD_OLMPD Did we have a PID previously           
         JZ    DOST0466            No                                           
         GOTOR BLDSTC,STCXAPDL     Yes - audit deletion                         
         MVC   STCXAPID,OLM.HD_OLMPD                                            
         MVC   STCXAPLV,OLM.HD_OLMLV                                            
         MVI   STCLN,STCXLN5Q                                                   
         AHI   R4,STCXLN5Q                                                      
                                                                                
DOST0466 LA    R6,HD_LMAPL(R6)                                                  
         LA    R3,HD_OLMAL(R3)                                                  
         JCT   R2,DOST0462                                                      
         DROP  LM,OLM                                                           
                                                                                
DOST0468 CLI   HD_USRFN,YESQ       Is the connected user from finance           
         JE    DOST0470                                                         
         CLI   HD_USRLM,YESQ       Is the connected user line manager           
         JNE   DOST0500                                                         
         J     DOST0475                                                         
                                                                                
DOST0470 CLI   QH_STAT,QH_SAVEQ    Are we changing the claim                    
         JE    DOST0480                                                         
DOST0475 CLI   QH_STAT,QH_APPQ     Are we approving?                            
         JE    DOST0480                                                         
         CLI   QH_STAT,QH_REJQ     Are we rejecting?                            
         JNE   DOST0500                                                         
                                                                                
DOST0480 GOTOR BLDSTC,STCXAPP                                                   
         MVI   STCXALVL,0                                                       
         CLI   HD_USRFN,YESQ                                                    
         JNE   *+8                                                              
         OI    STCXALVL,STCXALVF   Finance approval                             
         CLI   HD_USRLM,YESQ                                                    
         JNE   *+8                                                              
         OI    STCXALVL,STCXALM1   Line manager                                 
         GOTOR BLDCOM,0                                                         
                                                                                
DOST0500 LA    R6,HD_LMAP                                                       
         TM    TR_INDLM,TR_IRMLN                                                
         JZ    DOST0520                                                         
AP       USING HD_LMAP,R6                                                       
         XR    RF,RF                                                            
         ICM   RF,1,HD_LMAPN       Do we have any line managers                 
         JZ    DOST0520                                                         
DOST0510 XC    AP.HD_LMSTA,AP.HD_LMSTA                                          
         LA    R6,HD_LMAPL(R6)                                                  
         JCT   RF,DOST0510                                                      
         J     DOST0540                                                         
                                                                                
DOST0520 TM    HD_ST1FR,EXCSREJE   Was it rejected before?                      
         JZ    DOST0540                                                         
         CLI   QH_STAT,QH_SUBMQ    Are we now submitting?                       
         JNE   DOST0540            Yes - clear previous rejection               
         XR    RF,RF                                                            
         ICM   RF,1,HD_LMAPN       Do we have any line managers                 
         JZ    DOST0540                                                         
DOST0530 NI    AP.HD_LMSTA,FF-CIDAREJ                                           
         LA    R6,HD_LMAPL(R6)                                                  
         JCT   RF,DOST0530                                                      
         DROP  AP                                                               
                                                                                
DOST0540 TM    TR_INDFN,TR_IRMFN                                                
         JZ    DOST0560                                                         
         LA    R6,HD_FNAP                                                       
AP       USING HD_FNAP,R6                                                       
         LLC   RF,HD_FNAPN                                                      
DOST0550 XC    AP.HD_FNSTA,AP.HD_FNSTA  Clear approval status                   
         LA    R6,HD_FNAPL(R6)                                                  
         JCT   RF,DOST0550                                                      
         DROP  AP                                                               
                                                                                
DOST0560 J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Work out how to treat distance recorded                             *         
***********************************************************************         
                                                                                
WRKDIS   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*WRKDIS*'                                                      
*        TM    HD_ST1FR,EXCSFNTA   Finance to approve                           
*        JNZ   WRKDIS20                                                         
         TM    HD_ST1FR,EXCSREJE   Was claim previously rejected                
         JNZ   WRKDIS02            Yes                                          
         TM    HD_ST1FR,EXCSLOGD   Was claim previously deleted                 
         JNZ   WRKDIS02            Yes                                          
         CLI   HD_ST1FR,0          Any previous status                          
         JNE   WRKDIS10            Yes - already accumulated distance           
WRKDIS02 CLI   QH_STAT,QH_SUBMQ    Are we now submitting                        
         JNE   EXITY               No                                           
         GOTOR ADDDIS,NEW.CL_D     Add the new distance                         
         J     EXITY                                                            
                                                                                
WRKDIS10 CLI   HD_USRFN,YESQ                                                    
         JNE   WRKDIS20                                                         
         TM    TR_INDFN,TR_IFNMG   Have we got finance  app                     
         JZ    WRKDIS20                                                         
         CLI   QH_STAT,QH_APPQ     Are we approving?                            
         JNE   WRKDIS20                                                         
         GOTOR ADDDIS,NEW.CL_D     Add the new distance                         
         J     EXITY                                                            
                                                                                
WRKDIS20 CLI   QH_STAT,QH_DELQ     Are we now deleting                          
         JE    *+12                                                             
         CLI   QH_STAT,QH_REJQ     Are we now rejecting                         
         JNE   EXITY                                                            
         GOTOR SUBDIS,CL_D         Subtract old distance                        
         J     EXITY                                                            
                                                                                
***********************************************************************         
* Add distance to the person accumulator                              *         
***********************************************************************         
                                                                                
ADDDIS   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDDIS*'                                                      
         CLI   QH_STAT,QH_SUBMQ    Are we now submitting                        
         JE    ADDDIS02                                                         
         CLI   QH_STAT,QH_APPQ     Or approving                                 
         JNE   EXITY                                                            
                                                                                
ADDDIS02 LR    R7,R1                                                            
         CP    CL_MILE,PZERO       Have we any mileage                          
         JE    EXITY               No                                           
         OC    CL_VEHC,CL_VEHC     Any vehicle code                             
         JZ    EXITY               No - can't be using mileage rates            
         OC    CL_ACUNM,CL_ACUNM   Any accumulator to update                    
         JZ    EXITY               None so exit                                 
                                                                                
         GOTO1 VDATCON,PARM,(2,CL_ADAT),(1,POSDATE)                             
         MVC   DSTDTE,POSDATE                                                   
         MVC   DSTDTE+1(L'POSDATE-1),CPXDRDTE                                   
         CLC   DSTDTE,POSDATE                                                   
         JNH   ADDDIS03                                                         
         GOTO1 VDATCON,DMCB,(1,DSTDTE),(0,WORK)                                 
         GOTO1 VADDAY,DMCB,(C'Y',WORK),WORK+6,F'-1'                             
         GOTO1 VDATCON,DMCB,(0,WORK+6),(1,DSTDTE)                               
ADDDIS03 GOTO1 VDATCON,DMCB,(1,DSTDTE),(0,WORK)                                 
         GOTO1 VADDAY,DMCB,(C'Y',WORK),WORK+6,F'1'                              
         GOTO1 VADDAY,DMCB,(C'D',WORK+6),WORK,F'-1'                             
         GOTO1 VDATCON,DMCB,(0,WORK),(1,DENDTE)                                 
                                                                                
K        USING PERRECD,IOKEY                                                    
         MVC   K.PERKEY,SPACES     Build key of supplier ledger                 
         MVI   K.PERKTYP,PERKTYPQ                                               
         MVC   K.PERKCPY,CUXCPY                                                 
         MVC   K.PERKCODE,HD_1RPER                                              
         MVI   BYTE1,BUFPUT        Set need to put buffer entry                 
         GOTOR BUFREC,DMCB,('BUFGDR',0),(0,APERREC)                             
         JE    ADDDIS04                                                         
         DC    H'0'                                                             
*                                                                               
ADDDIS04 L     R3,APERREC                                                       
         AHI   R3,PERRFST-PERRECD                                               
         XC    FULL1,FULL1                                                      
         USING LIDELD,R3                                                        
ADDDIS06 CLI   LIDEL,0             Test end of record                           
         JE    ADDDIS16                                                         
         CLI   LIDEL,LIDELQ                                                     
         JE    ADDDIS10                                                         
ADDDIS08 LLC   R0,LIDLN                                                         
         AR    R3,R0                                                            
         J     ADDDIS06                                                         
                                                                                
ADDDIS10 CLI   LIDTYPE,LIDTDTAC    Is it distance accumulator element           
         JNE   ADDDIS08                                                         
         ST    R3,FULL1                                                         
         LLC   R2,LIDLN                                                         
         AR    R2,R3               R2=A(End of element)                         
         LA    R1,LIDDATA                                                       
M        USING LIDDATA,R1                                                       
ADDDIS12 CR    R1,R2               Have we reached end of element               
         JNL   ADDDIS08            Yes - get next element                       
         CLC   POSDATE,M.LIDDSTDT  Check date range                             
         JL    ADDDIS14                                                         
         CLC   POSDATE,M.LIDDENDT                                               
         JH    ADDDIS14                                                         
         CLC   CL_ACUNM,M.LIDDNUM                                               
         JNE   ADDDIS14                                                         
         CLI   HD_USRFN,YESQ                                                    
         JNE   ADDDIS13                                                         
         CLI   QH_STAT,QH_APPQ     Are we approving?                            
         JNE   ADDDIS13                                                         
         AP    M.LIDDDISP,CL_MILE                                               
         TM    CS_IND1,CS_IADD+CS_ICHG                                          
         JZ    ADDDIS26                                                         
ADDDIS13 AP    M.LIDDDISS,CL_MILE                                               
         J     ADDDIS26                                                         
                                                                                
ADDDIS14 AHI   R1,LIDDLNQ                                                       
         J     ADDDIS12                                                         
                                                                                
N        USING LIDELD,R2                                                        
ADDDIS16 LA    R2,ELEMENT                                                       
         OC    FULL1,FULL1         Any list element found                       
         JZ    ADDDIS18            No - build new element                       
         L     R3,FULL1            R3=A(last list element)                      
         LLC   RF,LIDLN            RF=length of element                         
         AHI   RF,LIDDLNQ                                                       
         CHI   RF,L'ELEMENT        Can we fit another entry on element          
         JL    ADDDIS20            Yes                                          
ADDDIS18 XC    ELEMENT,ELEMENT     No - build new element                       
         MVI   N.LIDEL,LIDELQ      No - build new element                       
         MVI   N.LIDTYPE,LIDTDTAC                                               
         MVI   N.LIDLN,LIDLNDQ                                                  
         MVI   N.LIDITLN,LIDDLNQ                                                
         J     ADDDIS22                                                         
                                                                                
ADDDIS20 MVC   N.LIDELD(L'ELEMENT),LIDELD Copy existing element                 
         MVI   LIDEL,X'FF'         Mark existing element for deletion           
         GOTO1 VHELLO,DMCB,(C'D',ACCMST),(X'FF',APERREC),0                      
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
ADDDIS22 LLC   R1,N.LIDLN          R1=Old element length                        
         LHI   RF,LIDDLNQ                                                       
         AR    RF,R1                                                            
         STC   RF,N.LIDLN          Set new element length                       
         AR    R1,R2               R1=A(of new entry)                           
         MVC   M.LIDDSTDT,DSTDTE   Add data                                     
         MVC   M.LIDDENDT,DENDTE                                                
         MVC   M.LIDDNUM,CL_ACUNM                                               
         CLI   HD_USRFN,YESQ                                                    
         JNE   ADDDIS23                                                         
         CLI   QH_STAT,QH_APPQ     Are we approving?                            
         JNE   ADDDIS23                                                         
         TM    CS_IND1,CS_IADD+CS_ICHG                                          
         JZ    *+10                                                             
ADDDIS23 ZAP   M.LIDDDISS,CL_MILE                                               
         ZAP   M.LIDDDISP,PZERO                                                 
         CLI   HD_USRFN,YESQ                                                    
         JNE   ADDDIS24                                                         
         CLI   QH_STAT,QH_APPQ     Are we approving?                            
         JNE   ADDDIS24                                                         
         ZAP   M.LIDDDISP,CL_MILE                                               
ADDDIS24 GOTO1 VHELLO,DMCB,(C'P',ACCMST),APERREC,N.LIDELD,0                     
         CLI   12(R1),0                                                         
         JE    ADDDIS26                                                         
         DC    H'0'                                                             
ADDDIS26 GOTOR BUFREC,DMCB,(BYTE1,0),APERREC                                    
         J     EXITY                                                            
         DROP  N,M                                                              
***********************************************************************         
* Subtract distance eat distance recorded                             *         
***********************************************************************         
                                                                                
SUBDIS   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*SUBDIS*'                                                      
         TM    HD_ST1FR,EXCSREJE   Was claim previously rejected                
         JNZ   EXITY               Yes - ignore old distance                    
         CLI   QH_STAT,QH_SUBMQ    Are we now submitting                        
         JE    SUBDIS02                                                         
         CLI   QH_STAT,QH_APPQ     Or approving                                 
         JE    SUBDIS02                                                         
         CLI   QH_STAT,QH_REJQ     No - are we rejecting now                    
         JNE   EXITY               No                                           
                                                                                
SUBDIS02 LR    R7,R1               Remove old distance from accumulator         
         CP    CL_MILE,PZERO                                                    
         JE    EXITY                                                            
         OC    CL_VEHC,CL_VEHC                                                  
         JZ    EXITY                                                            
         OC    CL_ACUNM,CL_ACUNM   Any accumulator to update                    
         JZ    EXITY               None so exit                                 
                                                                                
         GOTO1 VDATCON,PARM,(2,CL_ADAT),(1,POSDATE)                             
                                                                                
K        USING PERRECD,IOKEY                                                    
         MVC   K.PERKEY,SPACES     Build key of supplier ledger                 
         MVI   K.PERKTYP,PERKTYPQ                                               
         MVC   K.PERKCPY,CUXCPY                                                 
         MVC   K.PERKCODE,HD_1RPER                                              
         MVI   BYTE1,BUFPUT        Set need to put buffer entry                 
         GOTOR BUFREC,DMCB,('BUFGDR',0),(0,APERREC)                             
         JE    SUBDIS04                                                         
         DC    H'0'                                                             
*                                                                               
SUBDIS04 L     R3,APERREC                                                       
         AHI   R3,PERRFST-PERRECD                                               
         XC    FULL1,FULL1                                                      
         USING LIDELD,R3                                                        
SUBDIS06 CLI   LIDEL,0             Test end of record                           
         JNE   *+6                                                              
         DC    H'0'                Die as accumulator should be present         
         CLI   LIDEL,LIDELQ                                                     
         JE    SUBDIS10                                                         
SUBDIS08 LLC   R0,LIDLN                                                         
         AR    R3,R0                                                            
         J     SUBDIS06                                                         
                                                                                
SUBDIS10 CLI   LIDTYPE,LIDTDTAC    Is it distance accumulator element           
         JNE   SUBDIS08                                                         
         ST    R3,FULL1                                                         
         LLC   R2,LIDLN                                                         
         AR    R2,R3               R2=A(End of element)                         
         LA    R1,LIDDATA                                                       
M        USING LIDDATA,R1                                                       
SUBDIS12 CR    R1,R2               Have we reached end of element               
         JNL   SUBDIS08            Yes - get next element                       
         CLC   POSDATE,M.LIDDSTDT  Check date range                             
         JL    SUBDIS14                                                         
         CLC   POSDATE,M.LIDDENDT                                               
         JH    SUBDIS14                                                         
         CLC   CL_ACUNM,M.LIDDNUM                                               
         JNE   SUBDIS14                                                         
         SP    M.LIDDDISS,CL_MILE                                               
         GOTOR BUFREC,DMCB,(BYTE1,0),APERREC                                    
         J     EXITY                                                            
                                                                                
SUBDIS14 AHI   R1,LIDDLNQ                                                       
         J     SUBDIS12                                                         
         DROP  M,R3                                                             
***********************************************************************         
* Build table of approvers - used for when adjusters make changes     *         
***********************************************************************         
                                                                                
BLDAPP   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*BLDAPP*'                                                      
                                                                                
         L     R3,ACOBLOCK                                                      
         XC    0(L'CIDAPID,R3),0(R3)                                            
         XC    CL_D(CL_KEYL),CL_D                                               
         GOTOR BUFCLM,DMCB,('TSARDH',OLDBUF),0                                  
         TM    CLMERR,TSEEOF       Is it the end of the buffer?                 
         JZ    BLDAPP03            No                                           
         J     BLDAPPX                                                          
                                                                                
BLDAPP02 GOTOR BUFCLM,DMCB,('TSANXT',OLDBUF),0                                  
         TM    CLMERR,TSEEOF       Is it the end of the buffer?                 
         JNZ   BLDAPPX             Yes                                          
                                                                                
BLDAPP03 OC    CL_XDAT#,CL_XDAT#   Ignore extra data                            
         JNZ   BLDAPP02                                                         
         LA    R2,CL_AP                                                         
         LA    R0,CL_MAXA                                                       
BLDAPP04 OC    L'CL_APSTA(L'CL_APPID,R2),L'CL_APSTA(R2)                         
         JZ    BLDAPP06                                                         
         TM    0(R2),CIDAAPP       Is it approved?                              
         JNZ   BLDAPP08                                                         
                                                                                
BLDAPP06 LA    R2,CL_APL(R2)                                                    
         JCT   R0,BLDAPP04                                                      
         J     BLDAPP02                                                         
                                                                                
BLDAPP08 MVC   0(L'CIDAPID,R3),CL_APPID                                         
         AHI   R3,L'CIDAPID                                                     
         XC    0(L'CIDAPID,R3),0(R3)                                            
         J     BLDAPP02                                                         
                                                                                
BLDAPPX  J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Log changes made and ensure approver info is correct                *         
***********************************************************************         
                                                                                
AUDCHA   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDCHA*'                                                      
                                                                                
         TM    CPXSTAT6,CPX2LAEI   WPP workflow                                 
         JNZ   AUDCHA06            No line managers so skip check               
         LA    R6,HD_LMAP                                                       
AP       USING HD_LMAP,R6                                                       
         XR    RF,RF                                                            
         ICM   RF,1,HD_LMAPN       Do we have any line managers                 
         JZ    AUDCHA06                                                         
AUDCHA02 CLC   AP.HD_LMPID,CCTPID  Is it line manager approver?                 
         JE    AUDCHA08                                                         
         CLI   QH_BKUP,C'Y'        Back up approver?                            
         JNE   AUDCHA04                                                         
         LA    R0,HD_BAMAX         Max Backup Approvers                         
         LA    R1,AP.HD_LMBUP      Search backups approvers for match           
AUDCHA03 OC    0(L'PIDNO,R1),0(R1) Any Pids left in table?                      
         JZ    AUDCHA04                                                         
         CLC   CCTPID,0(R1)        Is line manager a back up approver?          
         JE    AUDCHA08                                                         
         LA    R1,L'PIDNO(R1)                                                   
         JCT   R0,AUDCHA03                                                      
                                                                                
AUDCHA04 LA    R6,HD_LMAPL(R6)                                                  
         JCT   RF,AUDCHA02                                                      
         DROP  AP                                                               
AUDCHA06 CLI   HD_USRFN,YESQ                                                    
         JE    AUDCHA08                                                         
                                                                                
         CLI   QH_STAT,QH_APPQ     Are we approving?                            
         JE    AUDCHA08                                                         
         CLI   QH_STAT,QH_REJQ     or rejecting?                                
         JE    AUDCHA08                                                         
         NI    TR_INDFN,FF-(TR_IFNMG) Set no longer all approved                
         OI    TR_INDFN,TR_IRMFN   Set to remove previous approvals             
         TM    CPXSTAT6,CPX2LAEI   WPP workflow                                 
         JNZ   AUDCHA08            No line managers so skip removing            
         NI    TR_INDLM,FF-(TR_ILNMG+TR_ILMGA)                                  
         OI    TR_INDLM,TR_IRMLN                                                
         GOTOR RMLMAP                                                           
                                                                                
         USING STCELD,R4                                                        
AUDCHA08 GOTOR BLDSTC,STCXITAM                                                  
         OC    NEW.CL_XDAT#,NEW.CL_XDAT#                                        
         JZ    AUDCHA10                                                         
         MVC   STCXITEM,NEW.CL_ITEM#                                            
         MVI   STCXTYP,STCXXDAM    Set as row amendment                         
         MVC   STCXXDTC,NEW.CL_XDAT#                                            
         MVC   STCXXDTT,NEW.CL_XTYPE                                            
         LLC   RF,NEW.CL_XCHLN                                                  
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   STCXXDCH(0),NEW.CL_XCHAR                                         
         EX    RF,0(RE)                                                         
         AHI   RF,STCXLN4Q+1                                                    
         STC   RF,STCLN                                                         
         AR    R4,RF                                                            
         J     AUDALLX                                                          
                                                                                
AUDCHA10 MVC   STCXITEM,NEW.CL_ITEM#                                            
         MVC   STCXSTAT,BYTE1      Set type of changes for claim line           
         MVC   STCXSTA2,BYTE2                                                   
         MVC   STCXSTA3,BYTE3                                                   
         MVC   STCXSTA4,BYTE4                                                   
         MVC   STCXSTA5,MYBYTE5                                                 
         MVC   STCXXULA,NEW.CL_EXAC                                             
         MVC   STCXCPJ,NEW.CL_SJAC                                              
         MVC   STCXSULA,NEW.CL_SUPAC                                            
         MVC   STCX2PA,NEW.CL_2PAC                                              
         MVC   STCX2DA,NEW.CL_2DAC                                              
*&&US                              Canadian taxes change of GST/PST/prv         
         MVC   STCXVAT,SPACES                                                   
         MVC   STCXGST,NEW.CL_VATC                                              
         MVC   STCXPST,NEW.CL_PSTC                                              
         MVC   STCXPRV,NEW.CL_PROV                                              
*&&                                                                             
*&&UK                                                                           
         MVC   STCXVAT,NEW.CL_VATAC+L'LEDGERSG                                  
         TM    CPYSTAT5,CPYSNVAT                                                
         JZ    *+16                                                             
         MVC   STCXVAT,SPACES                                                   
         MVC   STCXVAT(L'CL_VATC),NEW.CL_VATC                                   
*&&                                                                             
         MVC   STCXWC,NEW.CL_WC                                                 
         MVC   STCXOFF,NEW.CL_OFF                                               
         MVC   STCXETYP,NEW.CL_ETYP                                             
         ZAP   STCXAMNT,NEW.CL_AMT                                              
         MVC   STCXFCUR,NEW.CL_FCUR                                             
         ZAP   STCXFAMT,NEW.CL_FAMT                                             
         MVC   STCXTYPE,NEW.CL_ITYPE                                            
         MVC   STCXEST#,NEW.CL_EST                                              
         MVC   STCXMILE,NEW.CL_MILE                                             
         MVC   STCXDATE,NEW.CL_ADAT                                             
         MVC   STCXREF,NEW.CL_REF                                               
         MVC   STCXFUEL,NEW.CL_FUEL                                             
         MVC   STCXVEHC,NEW.CL_VEHC                                             
         MVC   STCXENG,NEW.CL_ENGC                                              
         MVC   STCXPASS,NEW.CL_PASS                                             
         MVC   STCXISTA,NEW.CL_STAT                                             
         NI    STCXISTA,X'FF'-(CIDMSID+CIDMSCI+CIDMSAI+CIDMSNT)                 
         CLI   NEW.CL_RECPT,YESQ                                                
         JNE   *+8                                                              
         OI    STCXISTA,STCXIRCP                                                
         XR    RF,RF                                                            
         TM    STCXSTAT,STCXSNAR                                                
         JZ    AUDCHA14                                                         
         ICM   RF,1,NEW.CL_NAROL                                                
         JZ    AUDCHA18                                                         
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   STCXNARR(0),NEW.CL_NARO                                          
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         J     AUDCHA18                                                         
                                                                                
AUDCHA14 XR    RF,RF                                                            
         TM    STCXSTA4,STCXSFNA   Any finance narrative change                 
         JNZ   AUDCHA16            Yes                                          
         TM    STCXSTA4,STCXSFNC                                                
         JNZ   AUDCHA16            Yes                                          
         TM    STCXSTA4,STCXSFND                                                
         JZ    AUDCHA18            No                                           
AUDCHA16 ICM   RF,1,NEW.CL_NARL                                                 
         JZ    AUDCHA18                                                         
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   STCXNARR(0),NEW.CL_NAR                                           
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
                                                                                
AUDCHA18 DS    0H                                                               
         LA    R2,STCXNARR                                                      
         AR    RF,R2                                                            
         SR    RF,R4                                                            
         STC   RF,STCLN                                                         
         AR    R4,RF                                                            
         CLI   HD_USRFN,YESQ       Finance preserve previous approvals          
         JE    *+12                                                             
         CLI   QH_STAT,QH_SAVEQ                                                 
         JE    AUDCHA42                                                         
         LA    R2,NEW.CL_AP                                                     
         LA    R3,OLD.CL_AP                                                     
         LA    R0,CL_MAXA                                                       
         GOTOR BLDSTC,STCXAPP                                                   
         LA    R6,ALVLTAB                                                       
AUDCHA20 OC    L'CL_APSTA(L'CL_APPID,R2),L'CL_APSTA(R2)                         
         JZ    AUDCHA40                                                         
                                                                                
         CLC   CCTPID,L'CL_APSTA(R2) Is it approver for this item?              
         JE    AUDCHA24            Yes                                          
         CLI   QH_BKUP,C'Y'        No - could it be back up approver?           
         JNE   AUDCHA22            No - must be adjuster                        
         LA    RF,HD_BAMAX         Max Backup Approvers                         
         LA    R1,L'CL_APSTA+L'CL_APPID(R2)                                     
AUDCHA21 OC    0(L'PIDNO,R1),0(R1) Any Pids left in table?                      
         JZ    AUDCHA22                                                         
         CLC   CCTPID,0(R1)        Is a back up client approver?                
         JE    AUDCHA24                                                         
         LA    R1,L'PIDNO(R1)                                                   
         JCT   RF,AUDCHA21                                                      
                                                                                
AUDCHA22 CLI   HD_USRFN,YESQ       If finance changing and approval             
         JNE   AUDCHA36            needed mark as approval not needed           
         CLI   QH_STAT,QH_REJQ                                                  
         JE    *+10                                                             
         MVC   0(L'CIDASTAT,R2),0(R3) Copy previous status                      
         GOTOR SETAPP,L'CL_APSTA(R2)                                            
         TM    BYTE1,STCXSAMT                                                   
         JZ    AUDCHA37                                                         
         J     AUDCHA36                                                         
                                                                                
AUDCHA24 CLC   HD_PPID#,CCTPID     Is user the approver                         
         JE    AUDCHA28            Then assume auto approval                    
                                                                                
AUDCHA26 CLI   QH_STAT,QH_APPQ     Are we approving?                            
         JNE   AUDCHA30                                                         
AUDCHA28 OI    0(R2),CIDAAPP       Set item as approved                         
         CLI   QH_BKUP,C'Y'        If backup approval                           
         JNE   AUDCHA32            Set approved by client approver              
         GOTOR SETAPP,L'CL_APSTA(R2)                                            
         J     AUDCHA32                                                         
                                                                                
AUDCHA30 CLI   QH_STAT,QH_REJQ     Are we rejecting?                            
         JNE   AUDCHA36                                                         
         OI    0(R2),CIDAREJ       Set item as rejected                         
                                                                                
AUDCHA32 OC    STCXALVL,1(R6)      Set approval level bits                      
AUDCHA34 OI    TR_INDCL,TR_IAPTT   Approved this time                           
         CLI   HD_USRFN,YESQ                                                    
         JNE   *+8                                                              
         OI    STCXALVL,STCXALVF   Finance approval                             
         CLI   HD_USRLM,YESQ                                                    
         JNE   *+8                                                              
         OI    STCXALVL,STCXALM1   Line manager                                 
         OC    HD_HIST,STCXALVL                                                 
         J     AUDCHA38                                                         
                                                                                
AUDCHA36 GOTOR NOTAPP,NEW.CL_SJAC  Notify approver as changed                   
         CLI   HD_USRFN,YESQ       If finance changing ensure manager           
         JNE   AUDCHA37            also notified                                
         GOTOR SETMGR              Set manager for notification                 
AUDCHA37 NI    0(R2),X'FF'-CIDAREJ Clear rejection when resubmitted             
                                                                                
AUDCHA38 LA    R2,CL_APL(R2)                                                    
         LA    R3,CL_APL(R3)                                                    
         LA    R6,ALVLTABL(R6)                                                  
         JCT   R0,AUDCHA20                                                      
                                                                                
AUDCHA40 TM    TR_INDCL,TR_IAPTT   Approved this time                           
         JZ    AUDCHA42                                                         
         GOTOR BLDCOM,NEW.CL_ITEM# Build comments element if required           
                                                                                
AUDCHA42 J     AUDALLX                                                          
         EJECT                                                                  
***********************************************************************         
* Log additions made and ensure approver info is correct              *         
***********************************************************************         
                                                                                
AUDADD   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDADD*'                                                      
                                                                                
         TM    CPXSTAT6,CPX2LAEI   WPP workflow                                 
         JNZ   AUDADD10            No line managers so skip check               
         LA    R6,HD_LMAP                                                       
AP       USING HD_LMAP,R6                                                       
         XR    RF,RF                                                            
         ICM   RF,1,HD_LMAPN       Do we have any line managers                 
         JZ    AUDADD10                                                         
AUDADD02 CLC   AP.HD_LMPID,CCTPID  Is it line manager approver?                 
         JE    AUDADD12                                                         
         TM    HD_IND,HD_INOPR     No previous claim record found               
         JZ    AUDADD04                                                         
         CLC   AP.HD_LMPID,HD_PPID# Are we submitting as a delegate             
         JE    AUDADD12                    for a self approval                  
                                                                                
AUDADD04 CLI   QH_BKUP,C'Y'        Back up approver?                            
         JNE   AUDADD08                                                         
         LA    R0,HD_BAMAX         Max Backup Approvers                         
         LA    R1,AP.HD_LMBUP      Search backups approvers for match           
AUDADD06 OC    0(L'PIDNO,R1),0(R1) Any Pids left in table?                      
         JZ    AUDADD08                                                         
         CLC   CCTPID,0(R1)        Is line manager a back up approver?          
         JE    AUDADD12                                                         
         LA    R1,L'PIDNO(R1)                                                   
         JCT   R0,AUDADD06                                                      
AUDADD08 LA    R6,HD_LMAPL(R6)                                                  
         JCT   RF,AUDADD02                                                      
         DROP  AP                                                               
AUDADD10 CLI   HD_USRFN,YESQ                                                    
         JE    AUDADD12                                                         
                                                                                
         CLI   QH_STAT,QH_APPQ     Are we approving?                            
         JE    AUDADD12                                                         
         CLI   QH_STAT,QH_REJQ     or rejecting?                                
         JE    AUDADD12                                                         
         NI    TR_INDFN,FF-(TR_IFNMG) Set no longer all approved                
         OI    TR_INDFN,TR_IRMFN   Set to remove previous approvals             
         TM    CPXSTAT6,CPX2LAEI   WPP workflow                                 
         JNZ   AUDADD12            No line managers so skip removing            
         NI    TR_INDLM,FF-(TR_ILNMG+TR_ILMGA)                                  
         OI    TR_INDLM,TR_IRMLN                                                
         GOTOR RMLMAP                                                           
                                                                                
         USING STCELD,R4                                                        
AUDADD12 GOTOR BLDSTC,STCXITAD                                                  
         MVC   STCXITEM,NEW.CL_ITEM#                                            
         OC    NEW.CL_XDAT#,NEW.CL_XDAT#                                        
         JZ    AUDADD14                                                         
         MVI   STCXTYP,STCXXDAD                                                 
         MVC   STCXXDTC,NEW.CL_XDAT#                                            
         MVC   STCXXDTT,NEW.CL_XTYPE                                            
         LLC   RF,NEW.CL_XCHLN                                                  
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   STCXXDCH(0),NEW.CL_XCHAR                                         
         EX    RF,0(RE)                                                         
         AHI   RF,STCXLN4Q+1                                                    
         STC   RF,STCLN                                                         
         AR    R4,RF                                                            
         J     AUDALLX                                                          
                                                                                
AUDADD14 MVC   STCXITEM,NEW.CL_ITEM#                                            
         MVC   STCXSTAT,BYTE1      Set type of changes for claim line           
         MVC   STCXSTA2,BYTE2                                                   
         MVC   STCXSTA3,BYTE3                                                   
         MVC   STCXSTA4,BYTE4                                                   
         MVC   STCXSTA5,MYBYTE5                                                 
         MVC   STCXXULA,NEW.CL_EXAC                                             
         MVC   STCXCPJ,NEW.CL_SJAC                                              
         MVC   STCXSULA,NEW.CL_SUPAC                                            
         MVC   STCX2PA,NEW.CL_2PAC                                              
         MVC   STCX2DA,NEW.CL_2DAC                                              
*&&UK                                                                           
         MVC   STCXVAT,NEW.CL_VATAC+L'LEDGERSG                                  
         TM    CPYSTAT5,CPYSNVAT                                                
         JZ    *+16                                                             
         MVC   STCXVAT,SPACES                                                   
         MVC   STCXVAT(L'CL_VATC),NEW.CL_VATC                                   
*&&                                                                             
*&&US                              Canadian taxes change of GST/PST/prv         
         MVC   STCXVAT,SPACES                                                   
         MVC   STCXGST,NEW.CL_VATC                                              
         MVC   STCXPST,NEW.CL_PSTC                                              
         MVC   STCXPRV,NEW.CL_PROV                                              
*&&                                                                             
         MVC   STCXWC,NEW.CL_WC                                                 
         MVC   STCXOFF,NEW.CL_OFF                                               
         MVC   STCXETYP,NEW.CL_ETYP                                             
         ZAP   STCXAMNT,NEW.CL_AMT                                              
         MVC   STCXFCUR,NEW.CL_FCUR                                             
         ZAP   STCXFAMT,NEW.CL_FAMT                                             
         MVC   STCXTYPE,NEW.CL_ITYPE                                            
         MVC   STCXEST#,NEW.CL_EST                                              
         MVC   STCXMILE,NEW.CL_MILE                                             
         MVC   STCXDATE,NEW.CL_ADAT                                             
         MVC   STCXREF,NEW.CL_REF                                               
         MVC   STCXFUEL,NEW.CL_FUEL                                             
         MVC   STCXVEHC,NEW.CL_VEHC                                             
         MVC   STCXENG,NEW.CL_ENGC                                              
         MVC   STCXPASS,NEW.CL_PASS                                             
         MVC   STCXISTA,NEW.CL_STAT                                             
         NI    STCXISTA,X'FF'-(CIDMSID+CIDMSCI+CIDMSAI+CIDMSNT)                 
         CLI   NEW.CL_RECPT,YESQ                                                
         JNE   *+8                                                              
         OI    STCXISTA,STCXIRCP                                                
         XR    RF,RF                                                            
         ICM   RF,1,NEW.CL_NAROL                                                
         JZ    AUDADD16                                                         
         LA    R2,NEW.CL_NARO                                                   
         J     AUDADD17                                                         
*                                                                               
AUDADD16 XR    RF,RF                                                            
         ICM   RF,1,NEW.CL_NARL                                                 
         JZ    AUDADD18                                                         
         LA    R2,NEW.CL_NAR                                                    
*                                                                               
AUDADD17 DS    0H                                                               
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   STCXNARR(0),0(R2)                                                
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
                                                                                
AUDADD18 LA    R2,STCXNARR                                                      
         AR    RF,R2                                                            
         SR    RF,R4                                                            
         STC   RF,STCLN                                                         
         AR    R4,RF                                                            
         CLI   QH_STAT,QH_SAVEQ    Are we saving?                               
         JE    AUDADD40            Yes                                          
                                                                                
         LA    R2,NEW.CL_AP                                                     
         LA    R0,CL_MAXA                                                       
         GOTOR BLDSTC,STCXAPP                                                   
         LA    R6,ALVLTAB                                                       
AUDADD20 OC    L'CL_APSTA(L'CL_APPID,R2),L'CL_APSTA(R2)                         
         JZ    AUDADD38                                                         
         CLC   CCTPID,L'CL_APSTA(R2) Is it approver for this item?              
         JE    AUDADD23            Yes                                          
         CLI   QH_BKUP,C'Y'        No - could it be back up approver?           
         JNE   AUDADD22            No - must be adjuster                        
         LA    RF,HD_BAMAX         Max Backup Approvers                         
         LA    R1,L'CL_APSTA+L'CL_APPID(R2)                                     
AUDADD21 OC    0(L'PIDNO,R1),0(R1) Any Pids left in table?                      
         JZ    AUDADD22                                                         
         CLC   CCTPID,0(R1)        Is a back up client approver?                
         JE    AUDADD23                                                         
         LA    R1,L'PIDNO(R1)                                                   
         JCT   RF,AUDADD21                                                      
                                                                                
AUDADD22 CLI   HD_USRFN,YESQ       If finance changing and approval             
         JNE   AUDADD34            needed mark as approval not needed           
         CLI   QH_STAT,QH_REJQ                                                  
         JE    AUDADD34                                                         
         OI    0(R2),CIDAANR                                                    
         GOTOR SETAPP,L'CL_APSTA(R2)                                            
         J     AUDADD34                                                         
                                                                                
AUDADD23 CLC   HD_PPID#,CCTPID     Is user the approver                         
         JE    AUDADD26            Then assume auto approval                    
                                                                                
AUDADD24 CLI   QH_STAT,QH_APPQ     Are we approving?                            
         JNE   AUDADD28                                                         
AUDADD26 OI    0(R2),CIDAAPP       Set item as approved                         
         CLI   QH_BKUP,C'Y'        If backup approval                           
         JNE   AUDADD32            Set approved by client approver              
         GOTOR SETAPP,L'CL_APSTA(R2)                                            
         J     AUDADD32                                                         
                                                                                
AUDADD28 CLI   QH_STAT,QH_REJQ     Are we rejecting?                            
         JNE   AUDADD30                                                         
         OI    0(R2),CIDAREJ       Set item as rejected                         
         J     AUDADD32                                                         
                                                                                
AUDADD30 GOTOR CHKAPP                                                           
         JNE   AUDADD34                                                         
         OI    0(R2),CIDAAPP       Set item as approved                         
                                                                                
AUDADD32 OI    TR_INDCL,TR_IAPTT   Approved this time                           
         OC    STCXALVL,1(R6)      Set approval level bits                      
         CLI   HD_USRFN,YESQ                                                    
         JNE   *+8                                                              
         OI    STCXALVL,STCXALVF   Finance approval                             
         CLI   HD_USRLM,YESQ                                                    
         JNE   *+8                                                              
         OI    STCXALVL,STCXALM1   Line manager                                 
         OC    HD_HIST,STCXALVL                                                 
         J     AUDADD36                                                         
                                                                                
AUDADD34 GOTOR NOTAPP,NEW.CL_SJAC  Notify approver as changed                   
         CLI   HD_USRFN,YESQ       If finance changing ensure manager           
         JNE   AUDADD36            also notified                                
         GOTOR SETMGR              Set manager for notification                 
                                                                                
AUDADD36 LA    R2,CL_APL(R2)                                                    
         LA    R6,ALVLTABL(R6)                                                  
         JCT   R0,AUDADD20                                                      
AUDADD38 TM    TR_INDCL,TR_IAPTT   Approved this time                           
         JZ    AUDADD40                                                         
         GOTOR BLDCOM,NEW.CL_ITEM# Build comments element if required           
                                                                                
AUDADD40 J     AUDALLX                                                          
         EJECT                                                                  
***********************************************************************         
* No changes but item could be approved - need to log this for audit  *         
***********************************************************************         
                                                                                
AUDAPP   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDAPP*'                                                      
                                                                                
         OC    NEW.CL_XDAT#,NEW.CL_XDAT#                                        
         JNZ   AUDALLX                                                          
         TM    NEW.CL_BSTAT,CL_BSRCO Was this record copied                     
         JNZ   AUDAPP12            Yes no need to check approver change         
                                                                                
AUDAPP06 LA    R2,NEW.CL_AP                                                     
         LA    R3,CL_AP                                                         
         LA    R0,CL_MAXA                                                       
                                                                                
AUDAPP08 CLC   L'CL_APSTA(L'CL_APPID,R2),L'CL_APSTA(R3)                         
         JE    AUDAPP10                                                         
         OI    NEW.CL_BSTAT,CL_BSRCR no - set change status                     
                                                                                
AUDAPP10 MVC   0(L'CL_APSTA,R2),0(R3)                                           
         LA    R2,CL_APL(R2)                                                    
         LA    R3,CL_APL(R3)                                                    
         JCT   R0,AUDAPP08                                                      
                                                                                
AUDAPP12 CLI   QH_STAT,QH_SAVEQ    Are we saving?                               
         JE    AUDAPP32            Yes                                          
                                                                                
         LA    R2,NEW.CL_AP                                                     
         LA    R3,CL_AP                                                         
         LA    R0,CL_MAXA                                                       
         GOTOR BLDSTC,STCXAPP                                                   
         LA    R6,ALVLTAB                                                       
AUDAPP14 OC    L'CL_APSTA(L'CL_APPID,R2),L'CL_APSTA(R2)                         
         JZ    AUDAPP32                                                         
         TM    CPXSTAT6,CPX2LAEI   WPP workflow                                 
         JZ    AUDAPP16            No                                           
         CLI   QH_STAT,QH_REJQ     Yes - if rejecting clear all status          
         JNE   AUDAPP16                                                         
         NI    0(R2),X'FF'-CIDAAPP                                              
                                                                                
AUDAPP16 CLC   CCTPID,L'CL_APSTA(R2) Is it approver for this item?              
         JE    AUDAPP18            Yes                                          
         CLI   QH_BKUP,C'Y'        No - could it be back up approver?           
         JNE   AUDAPP28            No - must be adjuster                        
         LA    RF,HD_BAMAX         Max Backup Approvers                         
         LA    R1,L'CL_APSTA+L'CL_APPID(R2)                                     
AUDAPP17 OC    0(L'PIDNO,R1),0(R1) Any Pids left in table?                      
         JZ    AUDAPP28                                                         
         CLC   CCTPID,0(R1)        Is a back up client approver?                
         JE    AUDAPP18                                                         
         LA    R1,L'PIDNO(R1)                                                   
         JCT   RF,AUDAPP17                                                      
         J     AUDAPP28                                                         
                                                                                
AUDAPP18 CLC   HD_PPID#,CCTPID     Is user the approver                         
         JE    AUDAPP20            Then assume auto approval                    
                                                                                
         CLI   QH_STAT,QH_APPQ     Are we approving?                            
         JNE   AUDAPP22                                                         
AUDAPP20 OI    0(R2),CIDAAPP       Set item as approved                         
         CLI   QH_BKUP,C'Y'        If backup approval                           
         JNE   AUDAPP26            Set approved by client approver              
         GOTOR SETAPP,L'CL_APSTA(R2)                                            
         J     AUDAPP26                                                         
                                                                                
AUDAPP22 CLI   QH_STAT,QH_REJQ     Are we rejecting?                            
         JNE   AUDAPP28                                                         
         OI    0(R2),CIDAREJ       Set item as rejected                         
                                                                                
AUDAPP26 OI    TR_INDCL,TR_IAPTT   Approved this time                           
         OC    STCXALVL,1(R6)      Set approval level bits                      
         CLI   HD_USRFN,YESQ                                                    
         JNE   *+8                                                              
         OI    STCXALVL,STCXALVF   Finance approval                             
         CLI   HD_USRLM,YESQ                                                    
         JNE   *+8                                                              
         OI    STCXALVL,STCXALM1   Line manager                                 
         OC    HD_HIST,STCXALVL                                                 
         J     AUDAPP30                                                         
                                                                                
AUDAPP28 MVC   0(L'CL_APSTA,R2),0(R3)                                           
         NI    0(R2),X'FF'-CIDAREJ Clear rejection when resubmitted             
                                                                                
AUDAPP30 LA    R2,CL_APL(R2)                                                    
         LA    R3,CL_APL(R3)                                                    
         LA    R6,ALVLTABL(R6)                                                  
         JCT   R0,AUDAPP14                                                      
AUDAPP32 TM    TR_INDCL,TR_IAPTT                                                
         JZ    AUDAPP34                                                         
         TM    RUNINDS,RUNICOMA    Audit comment element already built?         
         JNZ   AUDAPP34                                                         
         GOTOR BLDCOM,NEW.CL_ITEM# Build comments element if required           
         OI    RUNINDS,RUNICOMA                                                 
                                                                                
AUDAPP34 J     AUDALLX                                                          
                                                                                
         EJECT                                                                  
***********************************************************************         
* Build rejection/approval comments element                           *         
*                                                                     *         
* Ntry:- R1=Claim line row number or zero                             *         
*        R4=A(Where to build comments element)                        *         
***********************************************************************         
                                                                                
         USING STCELD,R4                                                        
BLDCOM   LTR   R1,R1               Test claim row number passed                 
         JZ    *+10                                                             
         MVC   STCXITEM,0(R1)                                                   
*                                                                               
         MVI   BYTE1,0             Initialize comment sequence                  
         MVI   STCLN,STCXLN2Q                                                   
         CLI   QH_STAT,QH_APPQ     Are we approving?                            
         JE    BLDCOM04                                                         
         MVI   STCXTYP,STCXREJ     Yes                                          
         CLI   QH_STAT,QH_REJQ     Are we rejeccting?                           
         JE    BLDCOM04            Yes                                          
         CLI   QH_STAT,QH_SAVEQ    Otherwise must be finance making             
         BNER  RE                   changes to claim                            
         MVI   STCXTYP,STCXFCMT      only want this if there are                
*                                                                               
BLDCOM04 MVC   ELEMENT,0(R4)       Save off basic element                       
         XR    R2,R2                                                            
         ICM   R2,7,QT_COMTA                                                    
         XR    R3,R3                                                            
         ICM   R3,3,LW_NUMN-LW_D(R2) Number of approver entries                 
         BZR   RE                  No comments                                  
         LA    R2,LW_LN2Q(,R2)     Bump over header                             
         MVI   BYTE1,0             byte1 = comment sequence                     
         J     BLDCOM08                                                         
*                                  Initialise next element                      
BLDCOM06 MVC   0(L'ELEMENT,R4),ELEMENT                                          
*                                                                               
         USING QT_COMTD,R2                                                      
BLDCOM08 LLC   RF,QT_COML                                                       
         BCTR  RF,0                                                             
         BASR  R1,0                                                             
         MVC   STCXCOMT(0),QT_COMR                                              
         EX    RF,0(R1)                                                         
         AHI   RF,STCXLN2Q+1                                                    
         STC   RF,STCLN                                                         
         MVC   STCXCSEQ,BYTE1                                                   
*                                                                               
         AR    R4,RF               Point to next output element                 
         AHI   R2,QT_COMLL                                                      
         LLC   RF,BYTE1                                                         
         AHI   RF,1                                                             
         STC   RF,BYTE1                                                         
         JCT   R3,BLDCOM06                                                      
         BR    RE                                                               
         DROP  R2,R4                                                            
         EJECT                                                                  
***********************************************************************         
* Log claim lines that are deleted                                    *         
***********************************************************************         
                                                                                
AUDDEL   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*AUDDEL*'                                                      
                                                                                
         XC    SAVEITEM,SAVEITEM                                                
         XC    CL_D(CL_KEYL),CL_D                                               
         GOTOR BUFCLM,DMCB,('TSARDH',OLDBUF),0                                  
         J     AUDDEL04                                                         
AUDDEL02 GOTOR BUFCLM,DMCB,('TSANXT',OLDBUF),0                                  
AUDDEL04 TM    CLMERR,TSEEOF       Have we reached end of this buffer           
         JNZ   AUDALLX                                                          
         TM    CL_BSTAT,CL_BSROB   Test this exists in the new buffer           
         JNZ   AUDDEL02                                                         
         TM    CL_BSTAT,CL_BSRNR   or is to be treated as a new record          
         JNZ   AUDDEL02                                                         
         CLC   CL_ITEM#,SAVEITEM   Is it a row we have already audited          
         JE    AUDDEL02            Yes - skip this item                         
         TM    CL_STAT,CIDMSID     Was item deleted before?                     
         JNZ   AUDDEL02            Yes - don't audit again                      
         TM    CPXSTAT6,CPX2LAEI                                                
         JNZ   AUDDEL10                                                         
                                                                                
         LA    R6,HD_LMAP                                                       
AP       USING HD_LMAP,R6                                                       
         XR    RF,RF                                                            
         ICM   RF,1,HD_LMAPN       Do we have any line managers                 
         JZ    AUDDEL10                                                         
AUDDEL06 CLC   AP.HD_LMPID,CCTPID  Is it line manager approver?                 
         JE    AUDDEL16                                                         
         CLI   QH_BKUP,C'Y'        Back up approver?                            
         JNE   AUDDEL08                                                         
         LA    R0,HD_BAMAX         Max Backup Approvers                         
         LA    R1,AP.HD_LMBUP      Search backups approvers for match           
AUDDEL07 OC    0(L'PIDNO,R1),0(R1) Any Pids left in table?                      
         JZ    AUDDEL08                                                         
         CLC   CCTPID,0(R1)        Is line manager a back up approver?          
         JE    AUDDEL16                                                         
         LA    R1,L'PIDNO(R1)                                                   
         JCT   R0,AUDDEL07                                                      
AUDDEL08 LA    R6,HD_LMAPL(R6)                                                  
         JCT   RF,AUDDEL06                                                      
         DROP  AP                                                               
AUDDEL10 CLI   HD_USRFN,YESQ                                                    
         JE    AUDDEL16                                                         
                                                                                
         CLI   QH_STAT,QH_APPQ     Are we approving?                            
         JE    AUDDEL16                                                         
         CLI   QH_STAT,QH_REJQ     or rejecting?                                
         JE    AUDDEL16                                                         
         NI    TR_INDFN,FF-(TR_IFNMG) Set no longer all approved                
         OI    TR_INDFN,TR_IRMFN   Set to remove previous approvals             
         TM    CPXSTAT6,CPX2LAEI   WPP workflow                                 
         JNZ   AUDDEL16            No line managers so skip removing            
         NI    TR_INDLM,FF-(TR_ILNMG+TR_ILMGA)                                  
         OI    TR_INDLM,TR_IRMLN                                                
         GOTOR RMLMAP                                                           
                                                                                
         USING STCELD,R4                                                        
AUDDEL16 GOTOR BLDSTC,STCXITDL                                                  
         MVC   STCXITEM,CL_ITEM#                                                
         OC    CL_XDAT#,CL_XDAT#                                                
         JZ    AUDDEL20                                                         
         MVI   STCXTYP,STCXXDDL                                                 
         MVC   STCXXDTC,CL_XDAT#                                                
         MVC   STCXXDTT,CL_XTYPE                                                
         LLC   RF,CL_XCHLN                                                      
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   STCXXDCH(0),CL_XCHAR                                             
         EX    RF,0(RE)                                                         
         AHI   RF,STCXLN4Q+1                                                    
         STC   RF,STCLN                                                         
         AR    R4,RF                                                            
         J     AUDDEL02                                                         
                                                                                
AUDDEL20 AHI   R4,STCXLN1Q                                                      
         MVC   SAVEITEM,CL_ITEM#                                                
         J     AUDDEL02                                                         
                                                                                
AUDALLX  MVI   0(R4),0                                                          
         LAY   R0,GENAREAX         ** TEST **                                   
         SHI   R0,255                                                           
         CR    R4,R0                                                            
         JNH   AUDALLX2                                                         
         CLI   RUNMODE,RVALREQQ    Are we online?                               
         JE    *+6                 yes                                          
         DC    H'0'                                                             
         MVC   ROUERRV,=AL2(AE$TMROW) too many rows                             
         GOTOR SAVERR,DMCB,ROUERRV,0,0                                          
AUDALLX2 XIT1  REGS=(R4)           Exit with R4 intact                          
         DROP  R4                                                               
         EJECT                                                                  
***********************************************************************         
* Build basic status element - R1=STCXTYP value, R4=A(Element)        *         
***********************************************************************         
                                                                                
         USING STCELD,R4                                                        
BLDSTC   NTR1  LABEL=NO                                                         
         XC    STCELD(256),STCELD                                               
         MVI   STCEL,STCELQ                                                     
         MVI   STCLN,STCXLN1Q                                                   
         STC   R1,STCXTYP                                                       
         MVI   STCIND,STCIEXP2                                                  
         MVC   STCDATE,HD_TODP5                                                 
         MVC   STCUSER,LP_USRID                                                 
         GOTOR GETTIM,STCTIME                                                   
         MVC   STCPERS,CCTPID                                                   
                                                                                
         TM    RUNINDS,RUNIAURA                                                 
         JZ    *+12                                                             
         MVI   STCXAPPL,STCXAURA   Set Aura is the application                  
         J     EXITY                                                            
                                                                                
         TM    RUNINDS,RUNIMOB                                                  
         JZ    EXITY                                                            
         MVI   STCXAPPL,STCXMOB    Set Mobile is the application                
         J     EXITY                                                            
         DROP  R4                                                               
                                                                                
***********************************************************************         
* Get current time in packed decimal                                  *         
*                                                                     *         
* Ntry:- R1=A(Where to store time value)                              *         
* Exit:- R0=Current time (0hhmmssC)                                   *         
***********************************************************************         
                                                                                
GETTIM   NTR1  LABEL=NO                                                         
         LR    R2,R1                                                            
         TIME  DEC                                                              
         SRL   R0,8                                                             
         SLL   R0,4                                                             
         OILL  GR0,X'000C'          'OR' in packed sign value                   
         STCM  R0,15,0(R2)                                                      
*&&US*&& AP    0(4,R2),=P'60000'   Adjust to real (EST) time in US              
*&&US*&& ICM   R0,15,0(R2)         and update R0                                
         XIT1  REGS=(R0)           Exit with R0 intact                          
         EJECT                                                                  
***********************************************************************         
* Set line manager for notification                                   *         
***********************************************************************         
                                                                                
SETMGR   L     RF,AAPPTAB          Manager is always first entry                
         USING APPTABD,RF                                                       
SETMGR02 CLI   APPRTYP,APPRTMAN                                                 
         JL    SETMGR04                                                         
         CLI   APPRTYP,APPRTFIN                                                 
         JNL   SETMGR04                                                         
         MVI   APPRNTFY,C'Y'                                                    
SETMGR04 SR    R0,R0                                                            
         IC    R0,APPRLN                                                        
         AR    RF,R0                                                            
         CLI   APPRLN,0            Test end of table                            
         BER   RE                  Yes                                          
         J     SETMGR02                                                         
         EJECT                                                                  
***********************************************************************         
* Set finance manager for notification                                *         
***********************************************************************         
                                                                                
SETFIN   L     RF,AAPPTAB          Manager is always first entry                
         USING APPTABD,RF                                                       
         SR    R0,R0                                                            
SETFIN02 IC    R0,APPRLN                                                        
         AR    RF,R0                                                            
         CLI   APPRLN,0            Test end of table                            
         BER   RE                  Yes                                          
         CLI   APPRTYP,APPRTFIN                                                 
         JL    SETFIN02                                                         
         MVI   APPRNTFY,C'Y'                                                    
         J     SETFIN02                                                         
         EJECT                                                                  
***********************************************************************         
* Set client approves for notification                                *         
***********************************************************************         
                                                                                
NOTCLI   L     RF,AAPPTAB                                                       
         USING APPTABD,RF                                                       
NOTCLI02 CLI   APPRTYP,APPRTMAN                                                 
         JNL   NOTCLI04                                                         
         MVI   APPRNTFY,C'Y'                                                    
NOTCLI04 SR    R0,R0                                                            
         IC    R0,APPRLN                                                        
         AR    RF,R0                                                            
         CLI   APPRLN,0            Test end of table                            
         BER   RE                  Yes                                          
         J     NOTCLI02                                                         
         DROP  RF                                                               
                                                                                
***********************************************************************         
* Set to notify approver of changes                                   *         
***********************************************************************         
                                                                                
NOTAPP   CLI   QH_STAT,QH_SAVEQ    Are we only saving the record?               
         BER   RE                  Yes                                          
                                                                                
         L     RF,AAPPTAB          Could be submitting, approving               
         USING APPTABD,RF                                                       
NOTAPP02 CLI   APPRLN,0            End of table                                 
         BER   RE                                                               
         CLI   APPRLN,APPKLNQ                                                   
         JE    NOTAPP10                                                         
         CLC   APPRACT,0(R1)       Match account code                           
         JNE   NOTAPP10                                                         
         CLC   APPRTYP,0(R6)                                                    
         JE    NOTAPP12                                                         
                                                                                
NOTAPP10 LLC   R0,APPRLN           Bump to next table entry                     
         AR    RF,R0                                                            
         J     NOTAPP02                                                         
                                                                                
NOTAPP12 MVI   APPRNTFY,C'Y'       Set notify approver as changed               
         BR    RE                                                               
         DROP  RF                                                               
         EJECT                                                                  
***********************************************************************         
* Build job key from client, product and job codes                    *         
*                                                                     *         
* Ntry:- P1=A(Area to build key into)                                 *         
*        P2=A(Client code)                                            *         
*        P3=A(Product code)                                           *         
*        P4=A(Job code)                                               *         
***********************************************************************         
                                                                                
BLDJOB   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*BLDJOB*'                                                      
                                                                                
         LM    R2,R5,0(R1)                                                      
         USING ACTKULA,R2                                                       
         MVC   ACTKULA(L'PRODUL),PRODUL                                         
         LLC   RF,PCLILEN                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   ACTKACT(0),0(R3)                                                 
         EX    RF,0(RE)            Move client code to key                      
         LA    R1,ACTKACT+1(RF)                                                 
         LLC   RE,PCLILEN                                                       
         LLC   RF,PPROLEN                                                       
         SR    RF,RE                                                            
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R1),0(R4)       Move product code to key                     
         EX    RF,0(RE)                                                         
         LA    R1,1(RF,R1)                                                      
         LLC   RE,PPROLEN                                                       
         IC    RF,PJOBLEN                                                       
         SR    RF,RE                                                            
         CHI   RF,L'GOSELJOB       Job can't be longer than GOSELJOB            
         JNH   *+8                                                              
         LHI   RF,L'GOSELJOB                                                    
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R1),0(R5)       Move job code to key                         
         EX    RF,0(RE)                                                         
         OC    ACTKACT,SPACES      (ensure space filled key)                    
         J     EXITY                                                            
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* Validate supplier account                                           *         
***********************************************************************         
                                                                                
VALSUP   NTR1  LABEL=NO,WORK=(RC,VSWORKL)                                       
         J     *+12                                                             
         DC    C'*VALSUP*'                                                      
                                                                                
         USING VSWORKD,RC                                                       
         LR    R2,R1               R2=A(Supplier account code)                  
         GOTOR CLRWRK,VSWORKL      Clear work area                              
         USING OB_D,VSRBAREA                                                    
         XC    CS_DISC,CS_DISC                                                  
         XC    ROUERRV,ROUERRV                                                  
                                                                                
K        USING LDGRECD,IOKEY                                                    
         MVC   K.LDGKEY,SPACES                                                  
         MVC   K.LDGKCPY,CUXCPY                                                 
         MVC   K.LDGKUNT(L'LDGKUNT+L'LDGKLDG),0(R2)                             
         MVC   OB_KEY(L'LDGKEY),K.LDGKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALSUP02                                                         
         JH    EXITN                                                            
         MVC   VSOPOS,OB_DATA                                                   
         CLI   CS_ITYPE,CS_INONQ                                                
         JNE   VALSUP06                                                         
         MVC   CS_DSULA,OB_DSCAC                                                
         J     VALSUP06                                                         
                                                                                
VALSUP02 CLC   =C'SX',0(R2)        Only SX or SV allowed                        
         JE    VALSUP04                                                         
         CLC   =C'SV',0(R2)                                                     
         JE    VALSUP04                                                         
*&&US                                                                           
         CLC   =C'SY',0(R2)   US also allows SY and SW                          
         JE    VALSUP04                                                         
         CLC   =C'SW',0(R2)   US also allows SY                                 
         JE    VALSUP04                                                         
*&&                                                                             
         MVC   ROUERRV,=AL2(AE$INLDG)                                           
         J     VALSUPN                                                          
                                                                                
VALSUP04 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR TSTSEC,0            Test security                                
         MVC   OB_ERROR,ROUERRV    Set error if any                             
         GOTOR GETELA,LDGELQ       Locate ledger element on record              
         JE    *+6                                                              
         DC    H'0'                                                             
         USING LDGELD,R1                                                        
         MVC   VSOPOS,LDGOPOS                                                   
         MVC   OB_DATA(L'VSOPOS),VSOPOS                                         
         CLI   CS_ITYPE,CS_INONQ                                                
         JNE   VALSUP05                                                         
         CLC   LDGCDSCA,SPACES     Do we have a discount account                
         JNH   VALSUP05                                                         
         MVC   OB_DSCAC(L'ACTKULA),LDGCDSCU                                     
         MVC   CS_DSULA,OB_DSCAC                                                
                                                                                
VALSUP05 GOTOR ADDBUF,OB_D                                                      
         OC    OB_ERROR,OB_ERROR                                                
         JNZ   EXITN                                                            
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
K        USING ACTRECD,IOKEY                                                    
VALSUP06 MVC   K.ACTKEY,SPACES                                                  
         MVC   K.ACTKCPY,CUXCPY                                                 
         MVC   K.ACTKULA,0(R2)                                                  
         MVC   OB_KEY(L'ACTKEY),K.ACTKEY                                        
*&&UK*&& MVC   CS_SUCUR,HD_CURR                                                 
*&&US*&& MVC   CS_SUCUR,AGYCURR                                                 
                                                                                
         CLI   OFFIND,NONEQ        No office - no checking                      
         JE    VALSUP10                                                         
         CLI   VSOPOS,0            OFFPOS=T scenarios are OK                    
         JE    VALSUP10                                                         
         CLI   VSOPOS,LDGOTRAN                                                  
         JE    VALSUP10                                                         
                                                                                
         NI    VSOPOS,FF-LDGOKEY2                                               
         LLC   RF,VSOPOS                                                        
         LA    RF,1(R2,RF)                                                      
                                                                                
         L     R1,AOFFAREA                                                      
         USING OFFALD,R1                                                        
         MVC   OFFAOFFC+0(1),0(RF)                                              
         MVI   OFFAOFFC+1,C' '                                                  
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    *+10                                                             
         MVC   OFFAOFFC+1(1),1(RF)                                              
         MVI   OFFAACT,OFFAVAL                                                  
         GOTOR VOFFAL              Validate office                              
         JE    VALSUP08                                                         
         MVC   ROUERRV,=AL2(AE$SECLK)                                           
                                                                                
VALSUP08 CLI   OFFIND,FULLYQ       Full office                                  
         JNE   VALSUP10                                                         
         CLC   OFFAOFFC,CS_OFF                                                  
         JE    VALSUP10                                                         
         MVC   ROUERRV,=AL2(AE$MIXOF)                                           
         J     EXITN                                                            
                                                                                
VALSUP10 GOTOR GETBUF,OB_D                                                      
         JL    VALSUP12                                                         
         JH    EXITN                                                            
         MVC   CS_SUNAM,OB_NAME                                                 
         MVC   CS_SUCUR,OB_CUR                                                  
         MVC   CS_2DAC,OB_2DAC                                                  
         MVC   CS_2PAC,OB_2PAC                                                  
         MVC   CS_DISC,OB_DSCRT                                                 
         J     EXITY                                                            
                                                                                
VALSUP12 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+10                                                             
         MVC   ROUERRV,=AL2(AE$INACC)                                           
                                                                                
         CLI   QH_STAT,QH_REJQ     or rejecting?                                
         JNE   VALSUP13                                                         
                                                                                
                                                                                
         TM    K.ACTKSTAT,ACTSLOCK                                              
         JZ    *+10                                                             
         MVC   ROUERRV,=AL2(AE$ACTLK)                                           
                                                                                
         TM    K.ACTKSTAT,ACTSABLP                                              
         JNZ   *+10                                                             
         MVC   ROUERRV,=AL2(AE$INACP)                                           
                                                                                
VALSUP13 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,IOADDR                                                        
         AHI   R2,ACTRFST-ACTRECD                                               
         XC    CS_2DAC,CS_2DAC                                                  
         XC    CS_2PAC,CS_2PAC                                                  
         USING SPAELD,R2                                                        
VALSUP14 CLI   SPAEL,0                                                          
         JE    VALSUP26                                                         
         CLI   SPAEL,SPAELQ                                                     
         JE    VALSUP18                                                         
         CLI   SPAEL,ASTELQ                                                     
         JE    VALSUP22                                                         
*&&US                                                                           
         CLI   SPAEL,RATEDSCQ                                                   
         JE    VALSUP24                                                         
*&&                                                                             
VALSUP16 LLC   RF,SPALN                                                         
         AR    R2,RF                                                            
         J     VALSUP14                                                         
                                                                                
VALSUP18 LA    RF,CS_2DAC                                                       
         CLI   SPATYPE,SPATDEPT                                                 
         JE    VALSUP20                                                         
         LA    RF,CS_2PAC                                                       
         CLI   SPATYPE,SPATPERS                                                 
         JNE   VALSUP16                                                         
                                                                                
VALSUP20 MVC   0(L'SPAAACT,RF),SPAAACT                                          
         J     VALSUP16                                                         
                                                                                
         USING ASTELD,R2                                                        
VALSUP22 MVC   CS_SUCUR,ASTCUR                                                  
         CLC   CS_SUCUR,SPACES                                                  
         JH    VALSUP16                                                         
*&&UK*&& MVC   CS_SUCUR,HD_CURR                                                 
*&&US*&& MVC   CS_SUCUR,AGYCURR                                                 
         J     VALSUP16                                                         
                                                                                
*&&US                                                                           
         USING RATELD,R2                                                        
VALSUP24 MVC   CS_DISC,RATRATE                                                  
         J     VALSUP16                                                         
*&&                                                                             
                                                                                
VALSUP26 GOTOR TSTSEC,0            Test security                                
         GOTOR GETNAM,OB_NAME      Set supplier account name                    
         MVC   CS_SUNAM,OB_NAME                                                 
         MVC   OB_CUR,CS_SUCUR                                                  
         MVC   OB_2DAC,CS_2DAC                                                  
         MVC   OB_2PAC,CS_2PAC                                                  
         MVC   OB_DSCRT,CS_DISC                                                 
         OC    ROUERRV,ROUERRV                                                  
         JNZ   VALSUPN                                                          
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         J     EXITY                                                            
                                                                                
VALSUPN  MVC   OB_ERROR,ROUERRV    Add record in error to buffer                
         GOTOR ADDBUF,OB_D                                                      
         J     EXITN                                                            
         DROP  RC,K                                                             
                                                                                
VSWORKD  DSECT                     ** VALSUP local w/s **                       
VSOPOS   DS    XL(L'LDGOPOS)                                                    
VSRBAREA DS    XL(OB_LNQ)                                                       
         ORG   VSRBAREA+(OB_OTHER-OB_D)                                         
OB_CUR   DS    CL(L'ASTCUR)        Currency code of supplier                    
OB_2DAC  DS    CL(L'ACTKACT)       2D account code                              
OB_2PAC  DS    CL(L'ACTKACT)       2P account code                              
OB_DSCAC DS    CL(L'ACTKULA)       Discount account                             
OB_DSCRT DS    CL(L'RATRATE)       Discount rate                                
         ORG                                                                    
VSWORKL  EQU   *-VSWORKD                                                        
SVRDEF   CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* Validate currency code                                              *         
***********************************************************************         
*&&UK                                                                           
                                                                                
VALCUR   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    CL8'*VALCUR*'                                                    
                                                                                
         LR    R2,R1                                                            
         MVC   CS_CURC,0(R2)                                                    
         CLC   CS_CURC,SPACES                                                   
         JH    VALCUR10                                                         
                                                                                
*&&UK*&& MVC   CS_CURC,HD_CURR                                                  
*&&US*&& MVC   CS_CURC,AGYCURR                                                  
                                                                                
VALCUR10 CLC   CS_CURC,CS_SUCUR                                                 
         JE    VALCUR20                                                         
                                                                                
         CLI   CS_SUCUR,ASTCANY                                                 
         JE    VALCUR20                                                         
                                                                                
         MVC   ROUERRV,=AL2(AE$CURMC)                                           
         J     EXITN                                                            
                                                                                
VALCUR20 DS    0H                                                               
*&&UK*&& CLC   CS_CURC,HD_CURR     Foreign currency in use                      
*&&US*&& CLC   CS_CURC,AGYCURR     Foreign currency in use                      
         JE    VALCUR30            No                                           
                                                                                
         CLI   HD_USRFN,YESQ       Finance user                                 
         JNE   VALCUR22            No                                           
         CLI   QH_STAT,QH_SAVEQ    and not when only saving                     
         JE    VALCUR22                                                         
         CLI   CS_ITYPE,CS_IADVQ   Don't need rate for advance                  
         JE    VALCUR22                                                         
                                                                                
         OC    QI_XRAT+1(5),QI_XRAT+1  Check we were passed a rate              
         JNZ   VALCUR22                                                         
         MVC   ROUERRV,=AL2(AE$NORAT)                                           
         J     EXITN                                                            
                                                                                
VALCUR22 TM    CPYSTAT6,CPYSFMCR+CPYSFOCR   check it's allowed                  
         JNZ   VALCUR30                                                         
                                                                                
         MVC   ROUERRV,=AL2(AE$SUPCC)                                           
         J     EXITN                                                            
                                                                                
VALCUR30 CLI   QI_XRAT,0           we're not supporting shifts yet              
         JE    VALCURX                assume unshifted rate too big             
         MVC   ROUERRV,=AL2(AE$EXRNV)                                           
         OI    CS_IND2,CS_I2BEX                                                 
         J     EXITN                                                            
*                                                                               
VALCURX  J     EXITY                                                            
         EJECT                                                                  
*&&                                                                             
***********************************************************************         
* Validate other accounts                                             *         
* Build contra/accounts needed for analysis client, dept  and staff   *         
* Build discount accounts needed for cash discount                    *         
***********************************************************************         
                                                                                
VALACS   NTR1  LABEL=NO,WORK=(RC,VAWORKL)                                       
         J     *+12                                                             
         DC    C'*VALACS*'                                                      
                                                                                
         TM    TR_INDFN,TR_IFNMG   Are we likely to post?                       
         JZ    EXITY               No - not interested as not posting           
         USING VAWORKD,RC                                                       
         GOTOR CLRWRK,VAWORKL      Clear work area                              
         USING OB_D,VARBAREA                                                    
         XC    ROUERRV,ROUERRV                                                  
         MVC   CL_29NAM,SPACES                                                  
         MVC   CL_28NAM,SPACES                                                  
         MVC   CL_13NAM,SPACES                                                  
         MVC   CS_ACCER,SPACES                                                  
                                                                                
*&&US*&& CLI   CL_EXPJB,YESQ       If Job is an expense job                     
*&&US*&& JE    VALACS00            then treat it as non-billable                
         CP    CS_MILES,PZERO                                                   
         JNE   VALACS00                                                         
         CLI   CL_ITYPE,CS_INONQ   Only applicable for non-billable             
         JNE   VALACS72            Skip to discount validation                  
                                                                                
VALACS00 DS    0H                                                               
*&&UK                                                                           
         CLI   CL_ITYPE,CS_INONQ   Only want staff for billable                 
         JNE   VALACS10                                                         
*&&                                                                             
         TM    CS_ESTA1,RSTSEADD   Have we got department postings to           
         JZ    VALACS10                                         make            
         MVC   CL_28ULA,CS_EXULA                                                
         MVC   CL_28ULA(L'ACTKUNT+L'ACTKLDG),LEDGER28                           
K        USING LDGRECD,IOKEY                                                    
         MVC   K.LDGKEY,SPACES                                                  
         MVC   K.LDGKCPY,CUXCPY                                                 
         MVC   K.LDGKUNT(L'LDGKUNT+L'LDGKLDG),CL_28ULA                          
         MVC   CS_ACCER,K.LDGKUNT                                               
         MVC   OB_KEY(L'LDGKEY),K.LDGKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALACS02                                                         
         JH    EXITN                                                            
         J     VALACS04                                                         
                                                                                
VALACS02 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR TSTSEC,0            Test security                                
         MVC   OB_ERROR,ROUERRV    Set error if any                             
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         OC    OB_ERROR,OB_ERROR                                                
         JNZ   EXITN                                                            
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
K        USING ACTRECD,IOKEY                                                    
VALACS04 MVC   K.ACTKEY,SPACES                                                  
         MVC   K.ACTKCPY,CUXCPY                                                 
         MVC   K.ACTKULA,CL_28ULA                                               
         MVC   CS_ACCER,K.ACTKULA                                               
         MVC   OB_KEY(L'ACTKEY),K.ACTKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALACS06                                                         
         JH    EXITN                                                            
         MVC   CL_28NAM,OB_NAME                                                 
         J     VALACS10                                                         
                                                                                
VALACS06 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACC)                                           
         J     VALACSN                                                          
                                                                                
         TM    K.ACTKSTAT,ACTSLOCK                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACTLK)                                           
         J     VALACSN                                                          
                                                                                
         TM    K.ACTKSTAT,ACTSABLP                                              
         JNZ   *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACP)                                           
         J     VALACSN                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR TSTSEC,0            Test security                                
         JNE   VALACSN                                                          
         GOTOR GETNAM,OB_NAME      Set 28 account name                          
         MVC   CL_28NAM,OB_NAME                                                 
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
VALACS10 TM    CS_ESTA1,RSTSGPEI   Have we got staff analysis                   
         JZ    VALACS46            No                                           
         MVC   CL_29ULA,CL_1CULA                                                
         MVC   CL_29ULA(L'ACTKUNT+L'ACTKLDG),LEDGER29                           
         OC    CL_29ULA,SPACES                                                  
K        USING LDGRECD,IOKEY                                                    
         MVC   K.LDGKEY,SPACES                                                  
         MVC   K.LDGKCPY,CUXCPY                                                 
         MVC   K.LDGKUNT(L'LDGKUNT+L'LDGKLDG),CL_29ULA                          
         MVC   CS_ACCER,K.LDGKUNT                                               
         MVC   OB_KEY(L'LDGKEY),K.LDGKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALACS12                                                         
         JH    EXITN                                                            
         MVC   VAOPOS,OB_DATA                                                   
         J     VALACS14                                                         
                                                                                
VALACS12 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR GETELA,LDGELQ       Locate ledger element on record              
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   VAOPOS,LDGOPOS-LDGELD(R1)                                        
         GOTOR GETELA,ACLELQ                                                    
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   VALDGL1,ACLELLVA-ACLELD(R1)                                      
         MVC   VALDGL2,ACLELLVB-ACLELD(R1)                                      
         MVC   VALDGL3,ACLELLVC-ACLELD(R1)                                      
         MVC   VALDGL4,ACLELLVD-ACLELD(R1)                                      
         MVC   OB_DATA(L'VAOPOS),VAOPOS                                         
         GOTOR TSTSEC,0            Test security                                
         MVC   OB_ERROR,ROUERRV    Set error if any                             
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         OC    OB_ERROR,OB_ERROR                                                
         JNZ   EXITN                                                            
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
VALACS14 CLC   CL_1CULA,SPACES     Do we have a costing account                 
         JH    VALACS20            Yes                                          
*&&US*&& MVC   CL_29ACT(2),ACT999                                               
*&&UK*&& MVC   CL_29ACT(3),ACT999                                               
         SR    RE,RE                                                            
         CLI   VALDGL2,0           Find min length low level acc                
         JE    VALACS16                                                         
         IC    RE,VALDGL1                                                       
         CLI   VALDGL3,0                                                        
         JE    VALACS16                                                         
         IC    RE,VALDGL2                                                       
         CLI   VALDGL4,0                                                        
         JE    VALACS16                                                         
         IC    RE,VALDGL3                                                       
VALACS16 DS    0H                                                               
         LA    RF,CL_29ACT                                                      
         AR    RF,RE                                                            
         CLI   0(RF),C' '                                                       
         JNH   VALACS30            NOT LONG ENOUGH FOR LOW LEVEL                
                                                                                
VALACS20 CLI   OFFIND,NONEQ        No office - no checking                      
         JE    VALACS26                                                         
         CLI   VAOPOS,0            OFFPOS=T scenarios are OK                    
         JE    VALACS26                                                         
         CLI   VAOPOS,LDGOTRAN                                                  
         JE    VALACS26                                                         
                                                                                
         NI    VAOPOS,FF-LDGOKEY2  Do office substitution where                 
         LLC   R3,VAOPOS              office is in key                          
         LA    R2,CL_29ULA                                                      
         LA    R3,1(R2,R3)                                                      
         XR    RF,RF                                                            
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    *+8                                                              
         LHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R3),CL_OFF                                                   
         EX    RF,0(RE)                                                         
                                                                                
K        USING ACTRECD,IOKEY                                                    
VALACS26 MVC   K.ACTKEY,SPACES                                                  
         MVC   K.ACTKCPY,CUXCPY                                                 
         MVC   K.ACTKULA,CL_29ULA                                               
         MVC   CS_ACCER,K.ACTKULA                                               
         MVC   OB_KEY(L'ACTKEY),K.ACTKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALACS28                                                         
         JH    EXITN                                                            
         MVC   CL_29NAM,OB_NAME                                                 
         J     VALACS44                                                         
                                                                                
VALACS28 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    VALACS42                                                         
         CLC   CL_1CULA,SPACES     Do we have a costing account                 
         JNH   VALACS30            No                                           
         MVC   ROUERRV,=AL2(AE$INACC)  Yes - error as we should find ac         
         J     VALACSN                                                          
                                                                                
VALACS30 DS    0H                                                               
*&&US*&& MVC   CL_29ACT+2(2),=C'00'   TRY 299900                                
*&&UK*&& MVC   CL_29ACT+3(2),=C'00'   TRY 2999900                               
         SR    RE,RE                                                            
         CLI   VALDGL2,0           Find min length low level acc                
         JE    VALACS34                                                         
         IC    RE,VALDGL1                                                       
         CLI   VALDGL3,0                                                        
         JE    VALACS34                                                         
         IC    RE,VALDGL2                                                       
         CLI   VALDGL4,0                                                        
         JE    VALACS34                                                         
         IC    RE,VALDGL3                                                       
VALACS34 DS    0H                                                               
         LA    RF,CL_29ACT                                                      
         AR    RF,RE                                                            
         CLI   0(RF),C' '                                                       
         JNH   VALACS40            NOT LONG ENOUGH FOR LOW LEVEL                
                                                                                
         CLI   OFFIND,NONEQ        No office - no checking                      
         JE    VALACS37                                                         
         CLI   VAOPOS,0            OFFPOS=T scenarios are OK                    
         JE    VALACS37                                                         
         CLI   VAOPOS,LDGOTRAN                                                  
         JE    VALACS37                                                         
                                                                                
         NI    VAOPOS,FF-LDGOKEY2  Do office substitution where                 
         LLC   R3,VAOPOS              office is in key                          
         LA    R2,CL_29ULA                                                      
         LA    R3,1(R2,R3)                                                      
         XR    RF,RF                                                            
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    *+8                                                              
         LHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R3),CL_OFF                                                   
         EX    RF,0(RE)                                                         
                                                                                
VALACS37 MVC   K.ACTKEY,SPACES                                                  
         MVC   K.ACTKCPY,CUXCPY                                                 
         MVC   K.ACTKULA,CL_29ULA                                               
         MVC   CS_ACCER,K.ACTKULA                                               
         MVC   OB_KEY(L'ACTKEY),K.ACTKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALACS39                                                         
         JH    EXITN                                                            
         MVC   CL_29NAM,OB_NAME                                                 
         J     VALACS44                                                         
                                                                                
VALACS39 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    VALACS42                                                         
VALACS40 MVC   CL_29ACT,ACT999                                                  
         MVC   K.ACTKEY,SPACES                                                  
         MVC   K.ACTKCPY,CUXCPY                                                 
         MVC   K.ACTKULA,CL_29ULA                                               
         MVC   CS_ACCER,K.ACTKULA                                               
         MVC   OB_KEY(L'ACTKEY),K.ACTKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALACS41                                                         
         JH    EXITN                                                            
         MVC   CL_29NAM,OB_NAME                                                 
         J     VALACS44                                                         
                                                                                
VALACS41 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACC)                                           
         J     VALACSN                                                          
                                                                                
VALACS42 TM    K.ACTKSTAT,ACTSLOCK                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACTLK)                                           
         J     VALACSN                                                          
                                                                                
         TM    K.ACTKSTAT,ACTSABLP                                              
         JNZ   *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACP)                                           
         J     VALACSN                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR TSTSEC,0            Test security                                
         JNE   VALACSN                                                          
         GOTOR GETNAM,OB_NAME      Set 29 account name                          
         MVC   CL_29NAM,OB_NAME                                                 
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
VALACS44 LA    R1,L'CS_EXACT       set R1=length of expense account             
         LA    RF,CS_EXACT+L'CS_EXACT-1                                         
         CLI   0(RF),C' '                                                       
         JH    *+12                                                             
         SHI   RF,1                                                             
         JCT   R1,*-12                                                          
         SHI   R1,1                                                             
         BASR  RE,0                                                             
         MVC   CL_29ULC(0),CS_EXACT                                             
         EX    R1,0(RE)                                                         
*                                                                               
         XR    R0,R0               Test take 'N' bytes from                     
         IC    R0,CPYTENO          r.h. end of t/e account                      
         SHI   R0,X'F0'                                                         
         JNP   VALACS45                                                         
         MVC   CL_29ULC,SPACES                                                  
         LA    RF,1(R1)                                                         
         SR    RF,R0                                                            
         JNM   *+14                                                             
         MVC   ROUERRV,=AL2(AE$ISTFQ)                                           
         J     EXITN                                                            
                                                                                
         LA    RE,CS_EXACT(RF)                                                  
         LR    RF,R0                                                            
         BCTR  RF,0                                                             
         BASR  R1,0                                                             
         MVC   CL_29ULC(0),0(RE)                                                
         EX    RF,0(R1)                                                         
         LR    R1,RF                                                            
                                                                                
VALACS45 LA    RF,CL_29ULC+1(R1)                                                
         MVI   0(RF),C'-'                                                       
         LA    R1,CL_29ULC+L'CL_29ULC-1                                         
         SR    R1,RF                                                            
         BCTR  R1,0                                                             
         BASR  RE,0                                                             
         MVC   1(0,RF),CL_29ACT                                                 
         EX    R1,0(RE)                                                         
         MVC   CL_2PULC,CL_29ULC                                                
         BASR  RE,0                                                             
         MVC   1(0,RF),CL_2PAC     C/A = exspense-person                        
         EX    R1,0(RE)                                                         
                                                                                
VALACS46 DS    0H                                                               
*&&UK                                                                           
         CLI   CL_ITYPE,CS_INONQ   Only want staff for billable                 
         JNE   VALACS72            so skip costing                              
*&&                                                                             
         CLC   CS_COSTG,SPACES     Are we making client costing postngs         
         JNH   VALACS72            No                                           
                                                                                
K        USING LDGRECD,IOKEY                                                    
         MVC   K.LDGKEY,SPACES                                                  
         MVC   K.LDGKCPY,CUXCPY                                                 
         MVC   K.LDGKUNT(L'LDGKUNT+L'LDGKLDG),LEDGER1C                          
         MVC   CS_ACCER,K.LDGKUNT                                               
         MVC   OB_KEY(L'LDGKEY),K.LDGKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALACS48                                                         
         JH    EXITN                                                            
         MVC   VAOPOS,OB_DATA                                                   
         J     VALACS50                                                         
                                                                                
VALACS48 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR TSTSEC,0            Test security                                
         MVC   OB_ERROR,ROUERRV    Set error if any                             
         GOTOR GETELA,LDGELQ       Locate ledger element on record              
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   VAOPOS,LDGOPOS-LDGELD(R1)                                        
         MVC   OB_DATA(L'VAOPOS),VAOPOS                                         
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         OC    OB_ERROR,OB_ERROR                                                
         JNZ   EXITN                                                            
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
VALACS50 CLI   OFFIND,NONEQ        No office - no checking                      
         JE    VALACS52                                                         
         CLI   VAOPOS,0            OFFPOS=T scenarios are OK                    
         JE    VALACS52                                                         
         CLI   VAOPOS,LDGOTRAN                                                  
         JE    VALACS52                                                         
                                                                                
*&&UK                                                                           
         NI    VAOPOS,FF-LDGOKEY2  Do office substitution where                 
         LLC   R3,VAOPOS              office is in key                          
         LA    R2,CL_1CULA                                                      
         LA    R3,1(R2,R3)                                                      
         XR    RF,RF                                                            
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    *+8                                                              
         LHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R3),CL_OFF                                                   
         EX    RF,0(RE)                                                         
*&&                                                                             
                                                                                
K        USING ACTRECD,IOKEY                                                    
VALACS52 MVC   K.ACTKEY,SPACES                                                  
         MVC   K.ACTKCPY,CUXCPY                                                 
         MVC   K.ACTKULA,CL_1CULA                                               
         MVC   CS_ACCER,K.ACTKULA                                               
         MVC   OB_KEY(L'ACTKEY),K.ACTKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALACS54                                                         
         JH    EXITN                                                            
         MVC   CL_1CNAM,OB_NAME                                                 
         J     VALACS56                                                         
                                                                                
VALACS54 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    VALACS55                                                         
         MVC   ROUERRV,=AL2(AE$INACC)                                           
         CLC   CS_ACCER,SPACES                                                  
         JH    VALACSN                                                          
         TM    CS_IND1,CS_ICLI      No client means no 1C                       
         JZ    VALACS56             Just send missing cli error.                
         MVC   CS_ACCER(2),LEDGER1C                                             
         J     VALACSN                                                          
*                                                                               
VALACS55 TM    K.ACTKSTAT,ACTSDRFT                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACCNA)                                           
         J     VALACSN                                                          
                                                                                
         TM    K.ACTKSTAT,ACTSLOCK                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACTLK)                                           
         J     VALACSN                                                          
                                                                                
         TM    K.ACTKSTAT,ACTSABLP                                              
         JNZ   *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACP)                                           
         J     VALACSN                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR TSTSEC,0            Test security                                
         JNE   VALACSN                                                          
                                                                                
         GOTOR GETNAM,OB_NAME      Set 2P account name                          
         MVC   CL_1CNAM,OB_NAME                                                 
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
VALACS56 DS    0H                                                               
*&&UK                                                                           
         TM    CPYSTAT8,CPYS1P13   Post as 13/1C not 1P/1C                      
         JNZ   VALACS68            Yes                                          
*&&                                                                             
         MVC   CL_1PULA,SPACES                                                  
         MVC   CL_1PULA(L'LEDGER1P),LEDGER1P                                    
*&&UK                                                                           
         TM    CS_ESTA1,RSTSEADD   Have we got department postings to           
         JNZ   VALACS58                                         make            
         MVC   CL_1PACT(2),ACT999  No - use default dept                        
         J     VALACS64                                                         
*&&                                                                             
*&&US                                                                           
         TM    CPYSTAT5,CPYSNCST   Test new cost accounting ?                   
         JZ    VALACS58                                                         
         MVC   CL_1PACT,ACT999     No - use default dept                        
         J     VALACS64                                                         
*&&                                                                             
K        USING LDGRECD,IOKEY                                                    
VALACS58 MVC   K.LDGKEY,SPACES                                                  
         MVC   K.LDGKCPY,CUXCPY                                                 
         MVC   K.LDGKUNT(L'LDGKUNT+L'LDGKLDG),LEDGER2D                          
         MVC   CS_ACCER,K.LDGKUNT                                               
         MVC   OB_KEY(L'LDGKEY),K.LDGKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALACS60                                                         
         JH    EXITN                                                            
         MVC   VAOPOS(5),OB_DATA                                                
         J     VALACS62                                                         
                                                                                
VALACS60 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR TSTSEC,0            Test security                                
         MVC   OB_ERROR,ROUERRV    Set error if any                             
         GOTOR GETELA,ACLELQ       Locate account length element on rec         
         JE    *+6                                                              
         DC    H'0'                                                             
         USING ACLELD,R1                                                        
         MVC   VALDGL1,ACLELLVA                                                 
         MVC   VALDGL2,ACLELLVB                                                 
         MVC   VALDGL3,ACLELLVC                                                 
         MVC   VALDGL4,ACLELLVD                                                 
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         OC    OB_ERROR,OB_ERROR                                                
         JNZ   EXITN                                                            
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
VALACS62 XR    RE,RE                                                            
         CLI   VALDGL1,L'ACTKACT                                                
         JE    *+8                                                              
         IC    RE,VALDGL1                                                       
         LA    RE,CL_2DAC(RE)                                                   
         MVC   CL_1PACT(2),0(RE)                                                
VALACS64 DS    0H                                                               
*&&UK*&& MVC   CL_1PACT+2(L'RSTCOSTG),CS_COSTG                                  
                                                                                
K        USING ACTRECD,IOKEY                                                    
         MVC   K.ACTKEY,SPACES                                                  
         MVC   K.ACTKCPY,CUXCPY                                                 
         MVC   K.ACTKULA,CL_1PULA                                               
         MVC   CS_ACCER,K.ACTKULA                                               
         MVC   OB_KEY(L'ACTKEY),K.ACTKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALACS66                                                         
         JH    EXITN                                                            
         MVC   CL_1PNAM,OB_NAME                                                 
         J     VALACS68                                                         
                                                                                
VALACS66 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACC)                                           
         J     VALACSN                                                          
                                                                                
         TM    K.ACTKSTAT,ACTSLOCK                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACTLK)                                           
         J     VALACSN                                                          
                                                                                
         TM    K.ACTKSTAT,ACTSABLP                                              
         JNZ   *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACP)                                           
         J     VALACSN                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR TSTSEC,0            Test security                                
         JNE   VALACSN                                                          
         GOTOR GETNAM,OB_NAME      Set 1P account name                          
         MVC   CL_1PNAM,OB_NAME                                                 
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
VALACS68 MVC   CL_13ULA,SPACES                                                  
*&&UK                                                                           
         MVC   CL_13ULA(L'LEDGER13),LEDGER13                                    
         MVC   CL_13ACT(L'CS_COSTG),CS_COSTG                                    
*&&                                                                             
*&&US*&& MVC   CL_13ULA,CS_13ULA       From Catcall                             
*&&UK                                                                           
         TM    CPYSTAT8,CPYS1P13       Post to 13 not 1P                        
         JZ    VALACS72                                                         
                                                                                
K        USING ACTRECD,IOKEY                                                    
         MVC   K.ACTKEY,SPACES                                                  
         MVC   K.ACTKCPY,CUXCPY                                                 
         MVC   K.ACTKULA,CL_13ULA                                               
         MVC   CS_ACCER,K.ACTKULA                                               
         MVC   OB_KEY(L'ACTKEY),K.ACTKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALACS70                                                         
         JH    EXITN                                                            
         MVC   CL_13NAM,OB_NAME                                                 
         J     VALACS72                                                         
                                                                                
VALACS70 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACC)                                           
         J     VALACSN                                                          
                                                                                
         TM    K.ACTKSTAT,ACTSLOCK                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACTLK)                                           
         J     VALACSN                                                          
                                                                                
         TM    K.ACTKSTAT,ACTSABLP                                              
         JNZ   *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACP)                                           
         J     VALACSN                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR TSTSEC,0            Test security                                
         JNE   VALACSN                                                          
         GOTOR GETNAM,OB_NAME      Set 13 account name                          
         MVC   CL_13NAM,OB_NAME                                                 
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         XC    OB_D(OB_LNQ),OB_D                                                
*&&                                                                             
                                                                                
VALACS72 OC    CS_DISC,CS_DISC     Any discount for this supplier               
         JZ    EXITY               No                                           
         CLI   CL_ITYPE,CS_INONQ   Is the item non billable                     
         JNE   VALACS74            No                                           
         TM    CPYSTAT1,CPYSDISC   Check we post discount                       
         JZ    EXITY                                                            
         J     VALACS76                                                         
                                                                                
VALACS74 CLI   CL_ITYPE,CS_IBILQ   Is it billable item                          
         JNE   EXITY               No                                           
         CLI   CS_CLICD,NOQ        Is opt maint setting on to pass              
         JNE   EXITY                    discount to client                      
*                                  No pocket money ourselves                    
VALACS76 MVI   CS_CLICD,NOQ        Use this field from now on                   
         CLC   CS_DSACT,SPACES     Have we got a discount account               
         JH    *+16                Yes                                          
         MVC   CS_DSUNT(L'LEDGERSI),LEDGERSI  No - use default                  
         MVC   CS_DSACT,ACTDISC                                                 
                                                                                
K        USING LDGRECD,IOKEY                                                    
         MVC   K.LDGKEY,SPACES                                                  
         MVC   K.LDGKCPY,CUXCPY                                                 
         MVC   K.LDGKUNT(L'LDGKUNT+L'LDGKLDG),CS_DSULA                          
         MVC   CS_ACCER,K.LDGKUNT                                               
         MVC   OB_KEY(L'LDGKEY),K.LDGKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALACS78                                                         
         JH    EXITN                                                            
         MVC   VAOPOS,OB_DATA                                                   
         J     VALACS80                                                         
                                                                                
VALACS78 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR TSTSEC,0            Test security                                
         MVC   OB_ERROR,ROUERRV    Set error if any                             
         GOTOR GETELA,LDGELQ       Locate ledger element on record              
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   VAOPOS,LDGOPOS-LDGELD(R1)                                        
         MVC   OB_DATA(L'VAOPOS),VAOPOS                                         
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         OC    OB_ERROR,OB_ERROR                                                
         JNZ   EXITN                                                            
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
VALACS80 CLI   OFFIND,NONEQ        No office - no checking                      
         JE    VALACS82                                                         
         CLI   VAOPOS,0            OFFPOS=T scenarios are OK                    
         JE    VALACS82                                                         
         CLI   VAOPOS,LDGOTRAN                                                  
         JE    VALACS82                                                         
                                                                                
         NI    VAOPOS,FF-LDGOKEY2  Do office substitution where                 
         LLC   R3,VAOPOS              office is in key                          
         LA    R2,CS_DSULA                                                      
         LA    R3,1(R2,R3)                                                      
         XR    RF,RF                                                            
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    *+8                                                              
         LHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R3),CL_OFF                                                   
         EX    RF,0(RE)                                                         
                                                                                
K        USING ACTRECD,IOKEY                                                    
VALACS82 MVC   K.ACTKEY,SPACES                                                  
         MVC   K.ACTKCPY,CUXCPY                                                 
         MVC   K.ACTKULA,0(R2)                                                  
         MVC   CS_ACCER,K.ACTKULA                                               
         MVC   OB_KEY(L'ACTKEY),K.ACTKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALACS84                                                         
         JH    EXITN                                                            
         J     VALACS88                                                         
                                                                                
VALACS84 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACC)                                           
         J     VALACSN                                                          
                                                                                
*&&UK                                                                           
         TM    K.ACTKSTAT,ACTSDRFT                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACCNA)                                           
         J     VALACSN                                                          
*&&                                                                             
         TM    K.ACTKSTAT,ACTSLOCK                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACTLK)                                           
         J     VALACSN                                                          
                                                                                
         TM    K.ACTKSTAT,ACTSABLP                                              
         JNZ   *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACP)                                           
         J     VALACSN                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR TSTSEC,0            Test security                                
         JNE   VALACSN                                                          
*&&UK                                                                           
         CLI   CUACCS,0            Test any user limit access                   
         JE    VALACS86                                                         
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    VALACS86                                                         
         TM    CPXSTATA,CPXLACAC   Test limit account access in use             
         JZ    VALACS86                                                         
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA                                                      
         L     RF,IOADDR                                                        
         ST    RF,OFFAREC                                                       
         MVC   OFFAOPOS,VAOPOS                                                  
         MVI   OFFAACT,OFFATST                                                  
         GOTO1 VOFFAL                                                           
         JE    VALACS86                                                         
         MVC   ROUERRV,=AL2(AE$SECLK)                                           
         J     EXITN                                                            
         DROP  R1                                                               
*&&                                                                             
                                                                                
VALACS86 GOTOR GETNAM,OB_NAME      Set discount account name                    
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
VALACS88 J     EXITY                                                            
                                                                                
VALACSN  MVC   OB_ERROR,ROUERRV    Add record in error to buffer                
         GOTOR ADDBUF,OB_D                                                      
         J     EXITN                                                            
         DROP  RC,K                                                             
                                                                                
VAWORKD  DSECT                     ** VALACS local w/s **                       
VAOPOS   DS    XL(L'LDGOPOS)                                                    
VALDGL1  DS    XL1                                                              
VALDGL2  DS    XL1                                                              
VALDGL3  DS    XL1                                                              
VALDGL4  DS    XL1                                                              
VARBAREA DS    XL(OB_LNQ)                                                       
         ORG   VARBAREA+(OB_OTHER-OB_D)                                         
         ORG                                                                    
VAWORKL  EQU   *-VAWORKD                                                        
SVRDEF   CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* Validate expense account                                            *         
***********************************************************************         
                                                                                
VALEXP   NTR1  LABEL=NO,WORK=(RC,VXWORKL)                                       
         J     *+12                                                             
         DC    C'*VALEXP*'                                                      
*                                                                               
         USING VXWORKD,RC                                                       
         LM    R2,R4,0(R1)         R2=A(Expense a/c), R3=A(Dept a/c)            
         GOTOR CLRWRK,VXWORKL      Clear work area                              
         MVC   VX2DAC,0(R3)        Save 2D account                              
         MVC   VXMILE,0(R4)        Save miles                                   
         CLC   VX2DAC,SPACES       If there a 2D account                        
         JH    *+10                Yes                                          
         MVC   VX2DAC,CS_2DAC      No - use default from supplier               
         USING OB_D,VXRBAREA                                                    
         XC    ROUERRV,ROUERRV                                                  
         XC    CS_ESTA1,CS_ESTA1                                                
         XC    CS_ESTA2,CS_ESTA2                                                
         XC    CS_ESTA4,CS_ESTA4                                                
         XC    CS_ESTA5,CS_ESTA5                                                
         XC    CS_COSTG,CS_COSTG                                                
*&&US*&& CLI   CS_EXPJB,YESQ       If Job is an expense job                     
*&&US*&& JE    VALEXP00            then treat it as non-billable                
         OC    VXMILE,VXMILE                                                    
         JZ    *+14                                                             
         CP    VXMILE,PZERO                                                     
         JNE   VALEXP00                                                         
         CLI   CS_ITYPE,CS_INONQ   Only interested for non billable             
         JNE   EXITY                                                            
                                                                                
K        USING LDGRECD,IOKEY                                                    
VALEXP00 MVC   K.LDGKEY,SPACES                                                  
         MVC   K.LDGKCPY,CUXCPY                                                 
         MVC   K.LDGKUNT(L'LDGKUNT+L'LDGKLDG),0(R2)                             
         MVC   OB_KEY(L'LDGKEY),K.LDGKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALEXP02                                                         
         JH    EXITH                                                            
         MVC   VXOPOS,OB_DATA                                                   
         J     VALEXP06                                                         
                                                                                
VALEXP02 CLC   =C'SE',0(R2)        Only SE or SQ allowed                        
         JE    VALEXP04                                                         
         CLC   =C'SQ',0(R2)                                                     
         JE    VALEXP04                                                         
*&&US                                                                           
         CLC   =C'SB',0(R2)        US also allows SB                            
         JE    VALEXP04                                                         
*&&                                                                             
         MVC   ROUERRV,=AL2(AE$INLDG)                                           
         CLI   HD_USRFN,YESQ       Finance user?                                
         JE    VALEXPNH            Yes                                          
         MVC   ROUERRV,=AL2(AE$NXETY) User has no access to expense             
         J     VALEXPNH               so it comes from etype                    
                                                                                
VALEXP04 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR TSTSEC,0            Test security                                
         MVC   OB_ERROR,ROUERRV    Set error if any                             
         GOTOR GETELA,LDGELQ       Locate ledger element on record              
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   VXOPOS,LDGOPOS-LDGELD(R1)                                        
         MVC   OB_DATA(L'VXOPOS),VXOPOS                                         
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         OC    OB_ERROR,OB_ERROR                                                
         JNZ   EXITH                                                            
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
VALEXP06 CLI   OFFIND,NONEQ        No office - no checking                      
         JE    VALEXP08                                                         
         CLI   VXOPOS,0            OFFPOS=T scenarios are OK                    
         JE    VALEXP08                                                         
         CLI   VXOPOS,LDGOTRAN                                                  
         JE    VALEXP08                                                         
                                                                                
         NI    VXOPOS,FF-LDGOKEY2  Do office substitution where                 
         LLC   R3,VXOPOS              office is in key                          
         LA    R3,1(R2,R3)                                                      
         XR    RF,RF                                                            
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    *+8                                                              
         LHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R3),CS_OFF                                                   
         EX    RF,0(RE)                                                         
                                                                                
K        USING ACTRECD,IOKEY                                                    
VALEXP08 MVC   K.ACTKEY,SPACES                                                  
         MVC   K.ACTKCPY,CUXCPY                                                 
         MVC   K.ACTKULA,0(R2)                                                  
         MVC   OB_KEY(L'ACTKEY),K.ACTKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALEXP22                                                         
         JH    EXITH                                                            
         MVC   CS_EXNAM,OB_NAME                                                 
         MVC   CS_ESTA1,OB_STAT1                                                
         MVC   CS_ESTA2,OB_STAT2                                                
         MVC   CS_ESTA4,OB_STAT4                                                
         MVC   CS_ESTA5,OB_STAT5                                                
         MVC   CS_COSTG,OB_COSTG                                                
*&&US                                                                           
         MVC   CS_CATCD,OB_CATCD                                                
         MVC   CS_13ULA,OB_13ULA                                                
         CLI   CS_COSTG,YESQ       Any SJ analysis                              
         JNE   VALEXP18            No                                           
*&&                                                                             
                                                                                
*&&UK*&& CLC   CS_COSTG,SPACES     Any SJ analysis                              
*&&UK*&& JNH   VALEXP18            No                                           
         TM    CS_IND1,CS_ICLI     Have we got a client                         
         JNZ   VALEXP18            Yes                                          
*&&UK                                                                           
         TM    CS_ESTA5,RSTSPREA   Product required for expense                 
         JZ    VALEXP12            Client missing error                         
         J     VALEXP10                                                         
*&&                                                                             
*&&US                                                                           
         TM    CPYSTAT5,CPYSEXPP   Product required for expenses                
         JZ    VALEXP12            Client missing error                         
*&&                                                                             
VALEXP10 TM    CS_IND1,CS_IPRO     Have we got product ?                        
         JNZ   VALEXP12                                                         
         MVC   ROUERRV,=AL2(AE$ICLPQ)  required client/product                  
         J     EXITH                                                            
VALEXP12 MVC   ROUERRV,=AL2(AE$CLEXA)  Only client is required                  
         J     EXITH                                                            
                                                                                
VALEXP18 TM    CS_ESTA4,RSTSJREA   Job required for expense                     
         JZ    VALEXP20                                                         
         TM    CS_IND1,CS_IJOB     Have we got a job                            
         JNZ   VALEXP20            Yes                                          
         MVC   ROUERRV,=AL2(AE$JBEXA)                                           
         J     EXITH                                                            
*&&UK                                                                           
VALEXP20 TM    CS_ESTA5,RSTSPREA   Product required for expense                 
         JZ    EXITY                                                            
         TM    CS_IND1,CS_IPRO     Have we got a product                        
         JNZ   EXITY               Yes                                          
         MVC   ROUERRV,=AL2(AE$MSPRD)                                           
         J     EXITH                                                            
*&&                                                                             
*&&US                                                                           
VALEXP20 CLI   CS_COSTG,YESQ       Any SJ analysis                              
         JNE   EXITY               No                                           
         TM    CPYSTAT5,CPYSEXPP   Product required for expenses                
         JZ    EXITY                                                            
         TM    CS_IND1,CS_IPRO                                                  
         JNZ   EXITY                                                            
         MVC   ROUERRV,=AL2(AE$MSPRD)                                           
         J     EXITH                                                            
*&&                                                                             
                                                                                
VALEXP22 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACC)                                           
         J     VALEXPNH                                                         
                                                                                
         CLI   QH_STAT,QH_REJQ     or rejecting?                                
         JE    VALEXP24                                                         
*&&UK                                                                           
         TM    K.ACTKSTAT,ACTSDRFT                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACCNA)                                           
         J     VALEXPNH                                                         
*&&                                                                             
         TM    K.ACTKSTAT,ACTSLOCK                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACTLK)                                           
         J     VALEXPNH                                                         
                                                                                
         TM    K.ACTKSTAT,ACTSCLOS                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACTCL)                                           
         J     VALEXPNH                                                         
                                                                                
         TM    K.ACTKSTAT,ACTSABLP                                              
         JNZ   *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACP)                                           
         J     VALEXPNH                                                         
                                                                                
VALEXP24 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
*&&US                                                                           
*        CLI   HD_USRFN,YESQ       Finance user?                                
*        JNE   VALEXP28            No                                           
*                                                                               
         USING CATD,R1                                                          
         LA    R1,CATBLK           Get cost setting from CATCALL                
         XC    CATD(CATLNQ),CATD                                                
         MVC   CATDMGR,XDATAMGR                                                 
         MVC   CATSEAC(L'ACTKCPY),CUXCPY  Company code                          
         MVC   CATSEAC+1(L'ACTKULA),0(R2) SE account from above                 
         LA    RF,1                                                             
         TM    CPYSTAT4,CPYSOFF2                                                
         JNZ   *+6                                                              
         XR    RF,RF                     sub 1 for ex move                      
         BASR  RE,0                                                             
         MVC   CATOFF(0),VX2DAC                                                 
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         LA    RE,VX2DAC                                                        
         AR    RE,RF                                                            
         MVC   CATDPT,0(RE)                                                     
         GOTO1 VCATCALL                                                         
         CLI   CATERR,0                                                         
         JE    VALEXP26                                                         
         MVC   ROUERRV,=AL2(AE$IANAL)    Invalid Analysis Account               
         MVC   CS_13ULA,CATACC3+1                                               
         J     VALEXPNL                                                         
                                                                                
VALEXP26 CLI   CATPST,C'Y'         Do they require cost postings?               
         JNE   VALEXP28                                                         
         MVI   CS_COSTG,YESQ       Equivalent to rstcostg in UK                 
         MVC   CS_CATCD,CATCDE                                                  
         MVC   CS_13ULA,CATACC3+1                                               
*&&                                                                             
                                                                                
VALEXP28 GOTOR GETELA,RSTELQ       Locate record status element                 
         JE    *+6                                                              
         DC    H'0'                                                             
         USING RSTELD,R1                                                        
         MVC   CS_ESTA1,RSTSTAT1                                                
*&&UK                                                                           
         MVC   CS_COSTG,RSTCOSTG                                                
         CLC   RSTCOSTG,SPACES     Any SJ analysis needed                       
         JNH   VALEXP34            No                                           
*&&                                                                             
*&&US                                                                           
         CLI   CS_COSTG,YESQ                                                    
         JNE   VALEXP34                                                         
*&&                                                                             
         TM    CS_IND1,CS_ICLI     Have we got a client                         
         JNZ   VALEXP34            Yes                                          
*&&UK                                                                           
         CLI   RSTLN,RSTLN2Q                                                    
         JL    VALEXP32            Client missing error                         
         TM    RSTSTAT5,RSTSPREA   Product required for expense                 
         JZ    VALEXP32            Client missing error                         
         J     VALEXP30                                                         
*&&                                                                             
*&&US                                                                           
         TM    CPYSTAT5,CPYSEXPP   Product required for expenses                
         JZ    VALEXP32            Client missing error                         
*&&                                                                             
VALEXP30 TM    CS_IND1,CS_IPRO     Have we got product ?                        
         JNZ   VALEXP32                                                         
         MVC   ROUERRV,=AL2(AE$ICLPQ)  required client/product                  
         J     EXITH                                                            
VALEXP32 MVC   ROUERRV,=AL2(AE$CLEXA)  Only client is required                  
         J     EXITH                                                            
                                                                                
VALEXP34 CLI   RSTLN,RSTLN2Q                                                    
*&&US*&& JL    VALEXP36                                                         
*&&UK*&& JL    VALEXP38                                                         
         MVC   CS_ESTA2,RSTSTAT2                                                
         MVC   CS_ESTA4,RSTSTAT4                                                
         MVC   CS_ESTA5,RSTSTAT5                                                
         TM    RSTSTAT4,RSTSJREA   Job required for expense                     
         JZ    VALEXP36                                                         
         TM    CS_IND1,CS_IJOB     Have we got a job                            
         JNZ   VALEXP36            Yes                                          
         MVC   ROUERRV,=AL2(AE$JBEXA)                                           
         J     EXITH                                                            
                                                                                
*&&UK                                                                           
VALEXP36 TM    RSTSTAT5,RSTSPREA   Product required for expense                 
         JZ    VALEXP38                                                         
         TM    CS_IND1,CS_IPRO     Have we got a product                        
         JNZ   VALEXP38            Yes                                          
         MVC   ROUERRV,=AL2(AE$MSPRD)                                           
         J     EXITH                                                            
*&&                                                                             
*&&US                                                                           
VALEXP36 CLI   CS_COSTG,YESQ       Any SJ analysis                              
         JNE   VALEXP38            No                                           
         TM    CPYSTAT5,CPYSEXPP   Product required for exp                     
         JZ    VALEXP38                                                         
         TM    CS_IND1,CS_IPRO                                                  
         JNZ   VALEXP38                                                         
         MVC   ROUERRV,=AL2(AE$MSPRD)                                           
         J     EXITH                                                            
*&&                                                                             
                                                                                
VALEXP38 GOTOR TSTSEC,0            Test security                                
         JNE   VALEXPNH                                                         
*&&UK                                                                           
         CLI   CUACCS,0            Test any user limit access                   
         JE    VALEXP40                                                         
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    VALEXP40                                                         
         TM    CPXSTATA,CPXLACAC   Test limit account access in use             
         JZ    VALEXP40                                                         
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA                                                      
         L     RF,IOADDR                                                        
         ST    RF,OFFAREC                                                       
         MVC   OFFAOPOS,VXOPOS                                                  
         MVI   OFFAACT,OFFATST                                                  
         GOTO1 VOFFAL                                                           
         JE    VALEXP40                                                         
         MVC   ROUERRV,=AL2(AE$SECLK)                                           
         J     EXITH                                                            
         DROP  R1                                                               
*&&                                                                             
VALEXP40 GOTOR GETNAM,OB_NAME      Set expense account name                     
                                                                                
         MVC   CS_EXNAM,OB_NAME                                                 
         MVC   OB_STAT1,CS_ESTA1                                                
         MVC   OB_STAT2,CS_ESTA2                                                
         MVC   OB_STAT4,CS_ESTA4                                                
         MVC   OB_STAT5,CS_ESTA5                                                
         MVC   OB_COSTG,CS_COSTG                                                
*&&US                                                                           
         MVC   OB_CATCD,CS_CATCD                                                
         MVC   OB_13ULA,CS_13ULA                                                
*&&                                                                             
         GOTOR ADDBUF,OB_D                                                      
         J     EXITY                                                            
                                                                                
VALEXPNL MVC   OB_ERROR,ROUERRV    Add record in error to buffer                
         GOTOR ADDBUF,OB_D                                                      
         J     EXITL                                                            
                                                                                
VALEXPNH MVC   OB_ERROR,ROUERRV    Add record in error to buffer                
         GOTOR ADDBUF,OB_D                                                      
         J     EXITH                                                            
         DROP  RC,K                                                             
                                                                                
VXWORKD  DSECT                     ** VALEXP local w/s **                       
VX2DAC   DS    CL(L'CL_2DAC)                                                    
VXMILE   DS    CL(L'CL_MILE)                                                    
VXOPOS   DS    XL(L'LDGOPOS)                                                    
VXRBAREA DS    XL(OB_LNQ)                                                       
         ORG   VXRBAREA+(OB_OTHER-OB_D)                                         
OB_COSTG DS    CL(L'RSTCOSTG)                                                   
OB_STAT1 DS    CL(L'RSTSTAT1)                                                   
OB_STAT2 DS    CL(L'RSTSTAT2)                                                   
OB_STAT4 DS    CL(L'RSTSTAT4)                                                   
OB_STAT5 DS    CL(L'RSTSTAT5)                                                   
*&&US                                                                           
OB_CATCD DS    CL(L'CATCDE)                                                     
OB_13ULA DS    CL(L'ACTKULA)                                                    
*&&                                                                             
         ORG                                                                    
VXWORKL  EQU   *-VXWORKD                                                        
SVRDEF   CSECT                                                                  
         EJECT                                                                  
*&&US                                                                           
***********************************************************************         
* Validate GST/PST codes for the US                                   *         
* ENTRY: P1 - Province code                                           *         
*        P2 - GST code                                                *         
*        P3 - PST code                                                *         
***********************************************************************         
         SPACE 1                                                                
VALGPT   NTR1  LABEL=NO,WORK=(RC,VGWORKL)                                       
         J     *+12                                                             
         DC    C'*VALGPT*'                                                      
         USING VGWORKD,RC                                                       
         CLI   CUCTRY,CTRYCAN      Only posting VAT if Canada                   
         JNE   EXITY                                                            
         LR    R2,R1               R2=A(Expense account code)                   
         GOTOR CLRWRK,VGWORKL      Clear work area                              
         USING OB_D,VGRBAREA                                                    
         L     RF,0(R2)                                                         
         MVC   CS_PROV,0(RF)       Province Code                                
         L     RF,4(R2)                                                         
         MVC   CS_VATC,0(RF)       GST Code                                     
         L     RF,8(R2)                                                         
         MVC   CS_PSTC,0(RF)       PST Code                                     
*                                                                               
         CLI   HD_USRFN,YESQ       Finance user                                 
         JNE   VALGPT04            No                                           
         CLI   QH_STAT,QH_REJQ     If rejecting or saving ignore vat            
         JE    VALGPT04                 not completed                           
         CLI   QH_STAT,QH_SAVEQ                                                 
         JE    VALGPT04                                                         
         CLC   CS_PROV,SPACES      Any province code                            
         JH    VALGPT02                                                         
         CLI   CS_VATC,C' '        Any GST Code?                                
         JH    *+14                                                             
         MVC   ROUERRV,=AL2(AE$GSTCR)                                           
         J     EXITN               GST code required                            
         CLI   CS_PSTC,C' '        Any PST Code?                                
         JNH   VALGPT04                                                         
         MVC   ROUERRV,=AL2(AE$PSTNA)                                           
         J     EXITN               PST code not applicable                      
*                                                                               
VALGPT02 CLI   CS_PSTC,C' '        Any PST Code?                                
         JH    *+14                                                             
         MVC   ROUERRV,=AL2(AE$PSTCR)                                           
         J     EXITN               PST code required                            
         CLI   CS_VATC,C' '        Any GST Code?                                
         JH    VALGPT04                                                         
         MVC   ROUERRV,=AL2(AE$GSTCR)                                           
         J     EXITN               GST code required                            
*                                                                               
K        USING LDGRECD,IOKEY                                                    
VALGPT04 CLI   CS_VATC,C' '        Any GST/PST code                             
         JH    *+12                                                             
         CLI   CS_PSTC,C' '                                                     
         JNH   EXITY               No - OK                                      
*                                                                               
         MVI   BYTE1,0             Clear GST/PST flag                           
*                                                                               
         MVC   K.LDGKEY,SPACES                                                  
         MVC   K.LDGKCPY,CUXCPY                                                 
         MVC   K.LDGKUNT(L'LDGKUNT+L'LDGKLDG),=C'SG'                            
         MVC   OB_KEY(L'LDGKEY),K.LDGKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALGPT06                                                         
         JH    EXITN                                                            
         MVC   VGOPOS,OB_DATA                                                   
         J     VALGPT08                                                         
                                                                                
VALGPT06 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         DROP  K                                                                
                                                                                
         GOTOR TSTSEC,0            Test security                                
         MVC   OB_ERROR,ROUERRV    Set error if any                             
         GOTOR GETELA,LDGELQ       Locate ledger element on record              
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   VGOPOS,LDGOPOS-LDGELD(R1)                                        
         MVC   OB_DATA(L'VGOPOS),VGOPOS                                         
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         OC    OB_ERROR,OB_ERROR                                                
         JNZ   EXITN                                                            
         XC    OB_D(OB_LNQ),OB_D                                                
*                                                                               
         USING TAXRECD,R3                                                       
VALGPT08 LA    R3,IOKEY                                                         
         XC    TAXKEY,TAXKEY                                                    
         MVI   TAXKTYP,TAXKTYPQ                                                 
         MVC   TAXKCPY,CUXCPY                                                   
         CLI   BYTE1,1             Only pass province for                       
         JNE   *+10                                                             
         MVC   TAXKPRV,CS_PROV                                                  
*                                                                               
         CLI   VGOPOS,LDGONONE     don't pass office for offpos=T               
         JE    VALGPT12                                                         
         CLI   VGOPOS,LDGOTRAN                                                  
         JE    VALGPT12                                                         
         MVC   TAXKOFF,CS_OFF                                                   
*                                                                               
VALGPT12 LA    RF,CS_VATC                                                       
         CLI   BYTE1,1             Second pass for PST?                         
         JNE   *+8                                                              
         LA    RF,CS_PSTC                                                       
         CLI   0(RF),C' '          Any GST/PST code                             
         JNH   VALGPT26            No                                           
*                                                                               
         XR    RE,RE                                                            
         ICM   RE,7,CS_DATE                                                     
         LNR   RE,RE                                                            
         STCM  RE,7,TAXKDATE                                                    
                                                                                
         MVC   CSVKEY2,TAXKEY                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         CLC   CSVKEY2(TAXKDATE-TAXRECD),TAXKEY                                 
         JE    VALGPT14                                                         
                                                                                
         MVC   TAXKEY,CSVKEY2      read for current agency VAT record           
         MVC   TAXKOFF,EFFS                                                     
         MVC   CSVKEY2,TAXKEY                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         CLC   CSVKEY2(TAXKDATE-TAXRECD),TAXKEY                                 
         JNE   EXITY                                                            
                                                                                
VALGPT14 DS    0H                  process VAT record                           
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R3,AIO1                                                          
         LA    R3,TAXRFST          look for VAT elements                        
                                                                                
         USING TAXELD,R3                                                        
VALGPT16 CLI   TAXEL,0                                                          
         JNE   VALGPT18                                                         
         MVC   ROUERRV,=AL2(AE$VRNDE)                                           
         J     VALGPTN                                                          
*                                                                               
VALGPT18 CLI   TAXEL,TAXIELQ                                                    
         JE    VALGPT22                                                         
*                                                                               
VALGPT20 LLC   R0,TAXLN                                                         
         AR    R3,R0                                                            
         J     VALGPT16                                                         
*                                                                               
VALGPT22 LA    RF,CS_VATC                                                       
         CLI   BYTE1,1             Second pass?                                 
         JNE   *+8                                                              
         LA    RF,CS_PSTC                                                       
         CLC   TAXCODE,0(RF)       Match on code                                
         JNE   VALGPT20                                                         
         LA    RF,CS_VATAC                                                      
         LA    RE,CS_VATRT                                                      
         CLI   BYTE1,1             Second pass?                                 
         JNE   VALGPT24                                                         
         LA    RF,CS_PSTAC                                                      
         LA    RE,CS_PSTRT                                                      
VALGPT24 MVC   0(L'CS_VATAC,RF),TAXACTA                                         
         MVC   0(L'CS_VATRT,RE),TAXRATE                                         
*                                                                               
VALGPT26 CLI   BYTE1,1                                                          
         JE    VALGPTX                                                          
         CLI   CS_PSTC,C' '                                                     
         JNH   VALGPTX                                                          
         MVI   BYTE1,1                                                          
         J     VALGPT08                                                         
*                                                                               
VALGPTX  J     EXITY                                                            
*                                                                               
VALGPTN  J     EXITN                                                            
         EJECT                                                                  
VGWORKD  DSECT                     ** VALVAT local w/s **                       
VGOPOS   DS    XL(L'LDGOPOS)                                                    
VGRBAREA DS    XL(OB_LNQ)                                                       
VGWORKL  EQU   *-VGWORKD                                                        
SVRDEF   CSECT                                                                  
         EJECT                                                                  
*&&                                                                             
***********************************************************************         
* Validate VAT account or code                                        *         
***********************************************************************         
*&&UK                                                                           
VALVAT   NTR1  LABEL=NO,WORK=(RC,VVWORKL)                                       
         J     *+12                                                             
         DC    C'*VALVAT*'                                                      
                                                                                
         CLI   CS_ITYPE,CS_IADVQ   Don't validate office for                    
         JE    EXITY                    advance or non office agencies          
         USING VVWORKD,RC                                                       
         LR    R2,R1               R2=A(Expense account code)                   
         GOTOR CLRWRK,VVWORKL      Clear work area                              
         USING OB_D,VVRBAREA                                                    
         XC    ROUERRV,ROUERRV                                                  
         TM    CPYSTAT5,CPYSNVAT                                                
         JZ    VALVAT20                                                         
         CLC   0(L'CS_VATC,R2),SPACES                                           
         JNH   VALVAT02                                                         
         MVC   CS_VATC,0(R2)                                                    
                                                                                
VALVAT02 CLC   CS_VATC,SPACES                                                   
         JH    VALVAT04                                                         
         CLI   HD_USRFN,YESQ       Finance user                                 
         JNE   EXITY               No                                           
         CLI   QH_STAT,QH_REJQ     If rejecting or saving ignore vat            
         JE    EXITY                    not completed                           
         CLI   QH_STAT,QH_SAVEQ                                                 
         JE    EXITY                                                            
         MVC   ROUERRV,=AL2(AE$VATCR)                                           
         J     EXITN                                                            
                                                                                
K        USING LDGRECD,IOKEY                                                    
VALVAT04 MVC   K.LDGKEY,SPACES                                                  
         MVC   K.LDGKCPY,CUXCPY                                                 
         MVC   K.LDGKUNT(L'LDGKUNT+L'LDGKLDG),=C'SG'                            
         MVC   OB_KEY(L'LDGKEY),K.LDGKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALVAT06                                                         
         JH    EXITN                                                            
         MVC   VVOPOS,OB_DATA                                                   
         J     VALVAT08                                                         
                                                                                
VALVAT06 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         DROP  K                                                                
                                                                                
         GOTOR TSTSEC,0            Test security                                
         MVC   OB_ERROR,ROUERRV    Set error if any                             
         GOTOR GETELA,LDGELQ       Locate ledger element on record              
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   VVOPOS,LDGOPOS-LDGELD(R1)                                        
         MVC   OB_DATA(L'VVOPOS),VVOPOS                                         
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         OC    OB_ERROR,OB_ERROR                                                
         JNZ   EXITN                                                            
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
V        USING VTCD,ELEMENT                                                     
VALVAT08 XC    V.VTCD(VTCLNQ),V.VTCD                                            
         MVI   V.VTCACTN,VTCAILUP                                               
         MVC   V.VTCCPY,CUXCPY                                                  
         MVC   V.VTCOFFC,SPACES                                                 
         MVC   V.VTCCOMF,ACOMFACS                                               
         MVC   V.VTCINVD,CS_DATE                                                
         MVC   V.VTCTYPE,CS_VATC                                                
         MVC   V.VTCCPYS1,CPYSTAT1                                              
         MVC   V.VTCSGOPO,VVOPOS                                                
         CLI   VVOPOS,LDGONONE     don't pass office for offpos=T               
         JE    VALVAT10            as VATICAN won't work                        
         CLI   VVOPOS,LDGOTRAN                                                  
         JE    VALVAT10                                                         
         MVC   V.VTCOFFC,CS_OFF                                                 
                                                                                
VALVAT10 GOTO1 VATICAN,V.VTCD                                                   
         JNE   VALVAT12                                                         
         TM    V.VTCINDS,VTCINA                                                 
         JZ    VALVAT14                                                         
         MVC   ROUERRV,=AL2(AE$VRNDE)                                           
         J     EXITN                                                            
                                                                                
VALVAT12 MVC   ROUERRV,V.VTCERR                                                 
         J     EXITN                                                            
                                                                                
VALVAT14 MVC   CS_VATAC,V.VTCACT+L'ACTKCPY+L'ACTKLDG+L'ACTKUNT                  
         MVC   CS_VATRT,V.VTCRATE                                               
         CLI   CUACCS,0            Test any user limit access                   
         JE    VALVAT15                                                         
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    VALVAT15                                                         
         TM    CPXSTATA,CPXLACAC   Test limit account access in use             
         JZ    VALVAT15                                                         
K        USING ACTRECD,IOKEY                                                    
         MVC   K.ACTKEY,SPACES                                                  
         MVC   K.ACTKCULA,V.VTCACT Need low-lvl account for OFFAL call          
         DROP  K                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA                                                      
         L     RF,IOADDR                                                        
         ST    RF,OFFAREC                                                       
         MVC   OFFAOPOS,VVOPOS                                                  
         MVI   OFFAACT,OFFATST                                                  
         GOTO1 VOFFAL                                                           
         JE    VALVAT15                                                         
         MVC   ROUERRV,=AL2(AE$SECLK)  Security lock out                        
         J     EXITN                                                            
         DROP  R1                                                               
*                                                                               
VALVAT15 CLI   HD_COMIL,YESQ       Are we using mileage rates                   
         JNE   EXITY               No                                           
         CP    CS_MILES,PZERO      Have we any miles to calculate               
         JE    EXITY               No                                           
                                                                                
V        USING VTCD,ELEMENT                                                     
         XC    V.VTCD(VTCLNQ),V.VTCD                                            
         MVI   V.VTCACTN,VTCAILUP                                               
         MVC   V.VTCCPY,CUXCPY                                                  
         MVC   V.VTCOFFC,SPACES                                                 
         MVC   V.VTCCOMF,ACOMFACS                                               
         MVC   V.VTCINVD,CS_DATE                                                
         MVC   V.VTCTYPE,CPXDNVAT                                               
         MVC   CL_MVTC,CPXDNVAT                                                 
         MVC   V.VTCCPYS1,CPYSTAT1                                              
         MVC   V.VTCSGOPO,VVOPOS                                                
         CLI   VVOPOS,LDGONONE     don't pass office for offpos=T               
         JE    VALVAT16            as VATICAN won't work                        
         CLI   VVOPOS,LDGOTRAN                                                  
         JE    VALVAT16                                                         
         MVC   V.VTCOFFC,CS_OFF                                                 
                                                                                
VALVAT16 GOTO1 VATICAN,V.VTCD                                                   
         JNE   VALVAT18                                                         
         TM    V.VTCINDS,VTCINA                                                 
         JZ    VALVAT19                                                         
         MVC   ROUERRV,=AL2(AE$VRNDE)                                           
         J     EXITN                                                            
                                                                                
VALVAT18 MVC   ROUERRV,V.VTCERR                                                 
         J     EXITN                                                            
                                                                                
VALVAT19 MVC   CL_MVTAC,V.VTCACT+L'ACTKCPY+L'ACTKLDG+L'ACTKUNT                  
         MVC   CL_MVTRT,V.VTCRATE                                               
         J     EXITY                                                            
         DROP  V                                                                
                                                                                
VALVAT20 CLC   0(L'CS_VATAC,R2),SPACES                                          
         JNH   VALVAT22                                                         
         MVC   CS_VATAC,0(R2)                                                   
                                                                                
VALVAT22 CLC   CS_VATAC,SPACES                                                  
         JH    VALVAT24                                                         
         CLI   HD_USRFN,YESQ       Finance user                                 
         JNE   EXITY               No                                           
         CLI   QH_STAT,QH_REJQ     If rejecting or saving ignore vat            
         JE    EXITY                    not completed                           
         CLI   QH_STAT,QH_SAVEQ                                                 
         JE    EXITY                                                            
         MVC   ROUERRV,=AL2(AE$VATCR)                                           
         J     EXITN                                                            
                                                                                
K        USING LDGRECD,IOKEY                                                    
VALVAT24 MVC   K.LDGKEY,SPACES                                                  
         MVC   K.LDGKCPY,CUXCPY                                                 
         MVC   K.LDGKUNT(L'LDGKUNT+L'LDGKLDG),=C'SG'                            
         MVC   OB_KEY(L'LDGKEY),K.LDGKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALVAT26                                                         
         JH    EXITN                                                            
         MVC   VVOPOS,OB_DATA                                                   
         J     VALVAT28                                                         
                                                                                
VALVAT26 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR TSTSEC,0            Test security                                
         MVC   OB_ERROR,ROUERRV    Set error if any                             
         GOTOR GETELA,LDGELQ       Locate ledger element on record              
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   VVOPOS,LDGOPOS-LDGELD(R1)                                        
         MVC   OB_DATA(L'VVOPOS),VVOPOS                                         
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         OC    OB_ERROR,OB_ERROR                                                
         JNZ   EXITN                                                            
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
VALVAT28 LA    R2,CS_VATAC                                                      
         CLI   OFFIND,NONEQ        No office - no checking                      
         JE    VALVAT30                                                         
         CLI   VVOPOS,0            OFFPOS=T scenarios are OK                    
         JE    VALVAT30                                                         
         CLI   VVOPOS,LDGOTRAN                                                  
         JE    VALVAT30                                                         
                                                                                
         NI    VVOPOS,FF-LDGOKEY2  Do office substitution where                 
         LLC   R3,VVOPOS              office is in key                          
         SHI   R3,1                                                             
         AR    R3,R2                                                            
         XR    RF,RF                                                            
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    *+8                                                              
         LHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R3),CS_OFF                                                   
         EX    RF,0(RE)                                                         
                                                                                
K        USING ACTRECD,IOKEY                                                    
VALVAT30 MVC   K.ACTKEY,SPACES                                                  
         MVC   K.ACTKCPY,CUXCPY                                                 
         MVC   K.ACTKUNT(L'LDGKUNT+L'LDGKLDG),LEDGERSG                          
         MVC   K.ACTKACT,0(R2)                                                  
         MVC   OB_KEY(L'ACTKEY),K.ACTKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALVAT32                                                         
         JH    EXITN                                                            
         MVC   CS_VATRT,OB_VATRT                                                
         J     VALVAT40                                                         
                                                                                
VALVAT32 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACC)                                           
         J     VALVATN                                                          
                                                                                
                                                                                
         TM    K.ACTKSTAT,ACTSDRFT                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACCNA)                                           
         J     VALVATN                                                          
                                                                                
         TM    K.ACTKSTAT,ACTSLOCK                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACTLK)                                           
         J     VALVATN                                                          
                                                                                
         TM    K.ACTKSTAT,ACTSABLP                                              
         JNZ   *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACP)                                           
         J     VALVATN                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR GETELA,RSTELQ       Locate record status element                 
         JE    *+6                                                              
         DC    H'0'                                                             
         USING RSTELD,R1                                                        
         TM    RSTSTAT1,RSTSIVAT                                                
         JNZ   VALVAT34                                                         
         MVC   ROUERRV,=AL2(AE$WVAPS)                                           
         J     VALVATN                                                          
                                                                                
VALVAT34 GOTOR GETELA,RATEVATQ     Locate vat rates element                     
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$VINAP)                                           
         J     VALVATN                                                          
         USING RATELD,R1                                                        
         MVC   CS_VATRT,RATRATE                                                 
         MVC   OB_VATRT,RATRATE                                                 
                                                                                
         GOTOR TSTSEC,0            Test security                                
         JNE   VALVATN                                                          
         CLI   CUACCS,0            Test any user limit access                   
         JE    VALVAT36                                                         
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    VALVAT36                                                         
         TM    CPXSTATA,CPXLACAC   Test limit account access in use             
         JZ    VALVAT36                                                         
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA                                                      
         L     RF,IOADDR                                                        
         ST    RF,OFFAREC                                                       
         MVC   OFFAOPOS,VVOPOS                                                  
         MVI   OFFAACT,OFFATST                                                  
         GOTO1 VOFFAL                                                           
         JE    VALVAT36                                                         
         MVC   ROUERRV,=AL2(AE$SECLK)  Security lock out                        
         J     EXITN                                                            
         DROP  R1                                                               
                                                                                
VALVAT36 GOTOR GETNAM,OB_NAME      Set expense account name                     
                                                                                
         GOTOR ADDBUF,OB_D                                                      
                                                                                
VALVAT40 CLI   HD_COMIL,YESQ       Are we using mileage rates                   
         JNE   EXITY               No                                           
         CP    CS_MILES,PZERO      Have we any miles to calculate               
         JE    EXITY               No                                           
         LA    R2,CPXDNVAT                                                      
         CLI   OFFIND,NONEQ        No office - no checking                      
         JE    VALVAT42                                                         
         CLI   VVOPOS,0            OFFPOS=T scenarios are OK                    
         JE    VALVAT42                                                         
         CLI   VVOPOS,LDGOTRAN                                                  
         JE    VALVAT42                                                         
                                                                                
         NI    VVOPOS,FF-LDGOKEY2  Do office substitution where                 
         LLC   R3,VVOPOS              office is in key                          
         SHI   R3,1                                                             
         AR    R3,R2                                                            
         XR    RF,RF                                                            
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    *+8                                                              
         LHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R3),CS_OFF                                                   
         EX    RF,0(RE)                                                         
                                                                                
K        USING ACTRECD,IOKEY                                                    
VALVAT42 MVC   K.ACTKEY,SPACES                                                  
         MVC   K.ACTKCPY,CUXCPY                                                 
         MVC   K.ACTKUNT(L'LDGKUNT+L'LDGKLDG),LEDGERSG                          
         MVC   K.ACTKACT,0(R2)                                                  
         MVC   CL_MVTAC,0(R2)                                                   
         MVC   OB_KEY(L'ACTKEY),K.ACTKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALVAT44                                                         
         JH    EXITN                                                            
         MVC   CL_MVTRT,OB_VATRT                                                
         J     EXITY                                                            
                                                                                
VALVAT44 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACC)                                           
         J     VALVATN                                                          
                                                                                
         TM    K.ACTKSTAT,ACTSDRFT                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACCNA)                                           
         J     VALVATN                                                          
                                                                                
         TM    K.ACTKSTAT,ACTSLOCK                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACTLK)                                           
         J     VALVATN                                                          
                                                                                
         TM    K.ACTKSTAT,ACTSABLP                                              
         JNZ   *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACP)                                           
         J     VALVATN                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR GETELA,RSTELQ       Locate record status element                 
         JE    *+6                                                              
         DC    H'0'                                                             
         USING RSTELD,R1                                                        
         TM    RSTSTAT1,RSTSIVAT                                                
         JNZ   VALVAT46                                                         
         MVC   ROUERRV,=AL2(AE$WVAPS)                                           
         J     VALVATN                                                          
                                                                                
VALVAT46 GOTOR GETELA,RATEVATQ     Locate vat rates element                     
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$VINAP)                                           
         J     VALVATN                                                          
         USING RATELD,R1                                                        
         MVC   CL_MVTRT,RATRATE                                                 
         MVC   OB_VATRT,RATRATE                                                 
                                                                                
         GOTOR TSTSEC,0            Test security                                
         JNE   VALVATN                                                          
         CLI   CUACCS,0            Test any user limit access                   
         JE    VALVAT48                                                         
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    VALVAT48                                                         
         TM    CPXSTATA,CPXLACAC   Test limit account access in use             
         JZ    VALVAT48                                                         
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA                                                      
         L     RF,IOADDR                                                        
         ST    RF,OFFAREC                                                       
         MVC   OFFAOPOS,VVOPOS                                                  
         MVI   OFFAACT,OFFATST                                                  
         GOTO1 VOFFAL                                                           
         JE    VALVAT48                                                         
         MVC   ROUERRV,=AL2(AE$SECLK)  Security lock out                        
         J     EXITN                                                            
         DROP  R1                                                               
*                                                                               
VALVAT48 GOTOR GETNAM,OB_NAME      Set expense account name                     
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         J     EXITY                                                            
                                                                                
VALVATN  MVC   OB_ERROR,ROUERRV    Add record in error to buffer                
         GOTOR ADDBUF,OB_D                                                      
         J     EXITN                                                            
         DROP  RC,K                                                             
                                                                                
VVWORKD  DSECT                     ** VALVAT local w/s **                       
VVOPOS   DS    XL(L'LDGOPOS)                                                    
VVRBAREA DS    XL(OB_LNQ)                                                       
         ORG   VVRBAREA+(OB_OTHER-OB_D)                                         
OB_VATRT DS    XL(L'RATRATE)                                                    
         ORG                                                                    
VVWORKL  EQU   *-VVWORKD                                                        
*&&                                                                             
SVRDEF   CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* Validate 2P Account                                                 *         
***********************************************************************         
                                                                                
VAL2PA   NTR1  LABEL=NO,WORK=(RC,VPWORKL)                                       
         J     *+12                                                             
         DC    C'*VAL2PA*'                                                      
                                                                                
         USING VPWORKD,RC                                                       
         LR    R2,R1               R2=A(2P account code)                        
         GOTOR CLRWRK,VPWORKL      Clear work area                              
         USING OB_D,VPRBAREA                                                    
         XC    ROUERRV,ROUERRV                                                  
         TM    TR_INDFN,TR_IFNMG   Are we likely to post?                       
         JZ    VAL2PA02            No - not interested as not posting           
         CLC   0(L'ACTKULA,R2),SPACES  Yes - have they cleared 2P acc           
         JH    VAL2PA02            No                                           
         MVC   CS_2PAC,SPACES      Yes - clear 2P acc and exit                  
         TM    CS_ESTA1,RSTSGPEI   Is staff analysis required                   
         JZ    EXITY               No                                           
*&&US*&& CLI   CS_EXPJB,YESQ       If Job is an expense job                     
*&&US*&& JE    VAL2PA00            then treat it as non-billable                
         CP    CS_MILES,PZERO                                                   
         JNE   VAL2PA00                                                         
         CLI   CS_ITYPE,CS_INONQ   Only interested for non billable             
         JNE   EXITY                                                            
VAL2PA00 MVC   ROUERRV,=AL2(AE$ISTFQ)                                           
         J     EXITN                                                            
                                                                                
VAL2PA02 CLC   0(L'ACTKULA,R2),SPACES   Have we got an account                  
         JNH   VAL2PA04            No                                           
         MVC   CS_2PAC,0(R2)       Yes - use override                           
VAL2PA04 CLC   CS_2PAC,SPACES      Have we got 2P account from supplier         
         JNH   EXITY               No - exit nothing to do                      
*        TM    CS_ESTA1,RSTSGPEI   Is staff analysis required                   
*        JZ    EXITY               No                                           
                                                                                
K        USING LDGRECD,IOKEY                                                    
         MVC   K.LDGKEY,SPACES                                                  
         MVC   K.LDGKCPY,CUXCPY                                                 
         MVC   K.LDGKUNT(L'LDGKUNT+L'LDGKLDG),=C'2P'                            
         MVC   OB_KEY(L'LDGKEY),K.LDGKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VAL2PA06                                                         
         JH    EXITN                                                            
         MVC   VPOPOS,OB_DATA                                                   
         J     VAL2PA08                                                         
                                                                                
VAL2PA06 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR TSTSEC,0            Test security                                
         MVC   OB_ERROR,ROUERRV    Set error if any                             
         GOTOR GETELA,LDGELQ       Locate ledger element on record              
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   VPOPOS,LDGOPOS-LDGELD(R1)                                        
         MVC   OB_DATA(L'VPOPOS),VPOPOS                                         
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         OC    OB_ERROR,OB_ERROR                                                
         JNZ   EXITN                                                            
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
VAL2PA08 CLI   OFFIND,NONEQ        No office - no checking                      
         JE    VAL2PA10                                                         
         CLI   VPOPOS,0            OFFPOS=T scenarios are OK                    
         JE    VAL2PA10                                                         
         CLI   VPOPOS,LDGOTRAN                                                  
         JE    VAL2PA10                                                         
                                                                                
*&&UK                                                                           
         NI    VPOPOS,FF-LDGOKEY2  Do office substitution where                 
         LLC   R3,VPOPOS              office is in key                          
         SHI   R3,1                                                             
         LA    R2,CS_2PAC                                                       
         LA    R3,0(R2,R3)                                                      
         XR    RF,RF                                                            
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    *+8                                                              
         LHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R3),CS_OFF                                                   
         EX    RF,0(RE)                                                         
*&&                                                                             
                                                                                
K        USING ACTRECD,IOKEY                                                    
VAL2PA10 MVC   K.ACTKEY,SPACES                                                  
         MVC   K.ACTKCPY,CUXCPY                                                 
         MVC   K.ACTKUNT(L'LDGKUNT+L'LDGKLDG),=C'2P'                            
         MVC   K.ACTKACT,CS_2PAC                                                
         MVC   OB_KEY(L'ACTKEY),K.ACTKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VAL2PA12                                                         
         JH    EXITN                                                            
         MVC   CS_2PNAM,OB_NAME                                                 
         J     EXITY                                                            
                                                                                
VAL2PA12 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACC)                                           
         J     VAL2PAN                                                          
                                                                                
*&&UK                                                                           
         TM    K.ACTKSTAT,ACTSDRFT                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACCNA)                                           
         J     VAL2PAN                                                          
*&&                                                                             
         TM    K.ACTKSTAT,ACTSLOCK                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACTLK)                                           
         J     VAL2PAN                                                          
                                                                                
         TM    K.ACTKSTAT,ACTSABLP                                              
         JNZ   *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACP)                                           
         J     VAL2PAN                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
VAL2PA14 GOTOR TSTSEC,0            Test security                                
         JNE   VAL2PAN                                                          
                                                                                
         GOTOR GETNAM,OB_NAME      Set 2P account name                          
         MVC   CS_2PNAM,OB_NAME                                                 
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         J     EXITY                                                            
                                                                                
VAL2PAN  MVC   OB_ERROR,ROUERRV    Add record in error to buffer                
         GOTOR ADDBUF,OB_D                                                      
         J     EXITN                                                            
         DROP  RC,K                                                             
                                                                                
VPWORKD  DSECT                     ** VAL2PA local w/s **                       
VPOPOS   DS    XL(L'LDGOPOS)                                                    
VPRBAREA DS    XL(OB_LNQ)                                                       
VPWORKL  EQU   *-VPWORKD                                                        
SVRDEF   CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* Validate 2D Account                                                 *         
***********************************************************************         
                                                                                
VAL2DA   NTR1  LABEL=NO,WORK=(RC,VDWORKL)                                       
         J     *+12                                                             
         DC    C'*VAL2DA*'                                                      
                                                                                
         USING VDWORKD,RC                                                       
         LR    R2,R1               R2=A(2D account code)                        
         GOTOR CLRWRK,VDWORKL      Clear work area                              
         USING OB_D,VDRBAREA                                                    
         XC    ROUERRV,ROUERRV                                                  
         CLI   CS_ITYPE,CS_IADVQ   Not interested for advances                  
         JE    EXITY                                                            
                                                                                
         MVC   CS_2DUL,LEDGER2D    Department ledger                            
         TM    TR_INDFN,TR_IFNMG   Are we likely to post?                       
         JZ    VAL2DA02            No - not interested as not posting           
         CLC   0(L'ACTKULA,R2),SPACES  Yes - have they cleared 2D acc           
         JH    VAL2DA02            No                                           
         MVC   CS_2DAC,SPACES      Yes - clear 2D acc and exit                  
         TM    CS_ESTA1,RSTSEADD   Is dept required                             
         JZ    EXITY                                                            
*&&US*&& CLI   CS_EXPJB,YESQ       If Job is an expense job                     
*&&US*&& JE    *+12                then treat it as non-billable                
         CLI   CS_ITYPE,CS_INONQ   Only interested for non billable             
         JNE   EXITY                                                            
         MVC   ROUERRV,=AL2(AE$IDPTQ)                                           
         J     EXITN                                                            
                                                                                
VAL2DA02 CLC   0(L'ACTKULA,R2),SPACES   Have we got an account                  
         JNH   VAL2DA04            No                                           
         MVC   CS_2DAC,0(R2)       Yes - use override                           
VAL2DA04 CLC   CS_2DAC,SPACES      Have we got 2D account from supplier         
         JNH   EXITY               No - exit nothing to do                      
         TM    CS_ESTA1,RSTSEADD   Is dept required?                            
         JZ    EXITY                                                            
                                                                                
K        USING LDGRECD,IOKEY                                                    
         MVC   K.LDGKEY,SPACES                                                  
         MVC   K.LDGKCPY,CUXCPY                                                 
         MVC   K.LDGKUNT(L'LDGKUNT+L'LDGKLDG),LEDGER2D                          
         MVC   OB_KEY(L'LDGKEY),K.LDGKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VAL2DA06                                                         
         JH    EXITN                                                            
         MVC   VDOPOS(5),OB_DATA                                                
         J     VAL2DA08                                                         
                                                                                
VAL2DA06 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR TSTSEC,0            Test security                                
         MVC   OB_ERROR,ROUERRV    Set error if any                             
         GOTOR GETELA,LDGELQ       Locate ledger element on record              
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   VDOPOS,LDGOPOS-LDGELD(R1)                                        
         MVC   OB_DATA(L'VDOPOS),VDOPOS                                         
         GOTOR GETELA,ACLELQ       Locate account length element on rec         
         JE    *+6                                                              
         DC    H'0'                                                             
         USING ACLELD,R1                                                        
         MVC   OB_DATA+L'VDOPOS(L'ACLELLVA),ACLELLVA                            
         MVC   OB_DATA+2(L'ACLELLVB),ACLELLVB                                   
         MVC   OB_DATA+3(L'ACLELLVB),ACLELLVC                                   
         MVC   OB_DATA+4(L'ACLELLVB),ACLELLVD                                   
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         OC    OB_ERROR,OB_ERROR                                                
         JNZ   EXITN                                                            
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
VAL2DA08 CLI   OFFIND,NONEQ        No office - no checking                      
         JE    VAL2DA10                                                         
         CLI   VDOPOS,0            OFFPOS=T scenarios are OK                    
         JE    VAL2DA10                                                         
         CLI   VDOPOS,LDGOTRAN                                                  
         JE    VAL2DA10                                                         
                                                                                
*&&UK                                                                           
         NI    VDOPOS,FF-LDGOKEY2  Do office substitution where                 
         LLC   R3,VDOPOS              office is in key                          
         SHI   R3,1                                                             
         LA    R2,CS_2DAC                                                       
         LA    R3,0(R2,R3)                                                      
         XR    RF,RF                                                            
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    *+8                                                              
         LHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R3),CS_OFF                                                   
         EX    RF,0(RE)                                                         
*&&                                                                             
                                                                                
K        USING ACTRECD,IOKEY                                                    
VAL2DA10 MVC   K.ACTKEY,SPACES                                                  
         MVC   K.ACTKCPY,CUXCPY                                                 
         MVC   K.ACTKULA,CS_2DULA                                               
         MVC   OB_KEY(L'ACTKEY),K.ACTKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VAL2DA12                                                         
         JH    EXITN                                                            
         MVC   CS_2DNAM,OB_NAME                                                 
         J     EXITY                                                            
                                                                                
VAL2DA12 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACC)                                           
         J     VAL2DAN                                                          
                                                                                
*&&UK                                                                           
         TM    K.ACTKSTAT,ACTSDRFT                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACCNA)                                           
         J     VAL2DAN                                                          
*&&                                                                             
         TM    K.ACTKSTAT,ACTSLOCK                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACTLK)                                           
         J     VAL2DAN                                                          
                                                                                
         TM    K.ACTKSTAT,ACTSABLP                                              
         JNZ   *+14                                                             
         MVC   ROUERRV,=AL2(AE$INACP)                                           
         J     VAL2DAN                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
VAL2DA14 GOTOR TSTSEC,0            Test security                                
         JNE   VAL2DAN                                                          
                                                                                
         GOTOR GETNAM,OB_NAME      Set 2D account name                          
         MVC   CS_2DNAM,OB_NAME                                                 
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         J     EXITY                                                            
                                                                                
VAL2DAN  MVC   OB_ERROR,ROUERRV    Add record in error to buffer                
         GOTOR ADDBUF,OB_D                                                      
         J     EXITN                                                            
         DROP  RC,K                                                             
                                                                                
VDWORKD  DSECT                     ** VAL2DA local w/s **                       
VDOPOS   DS    XL(L'LDGOPOS)                                                    
VDLDGL1  DS    XL1                                                              
VDLDGL2  DS    XL1                                                              
VDLDGL3  DS    XL1                                                              
VDLDGL4  DS    XL1                                                              
VDRBAREA DS    XL(OB_LNQ)                                                       
VDWORKL  EQU   *-VDWORKD                                                        
SVRDEF   CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* Validate discount rate                                              *         
***********************************************************************         
                                                                                
VALDSC   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*VALDSC*'                                                      
                                                                                
         LR    R2,R1               R2=A(Discount rate)                          
         CLI   HD_USRFN,YESQ       Finance user?                                
         JNE   VALDSC02            No                                           
         CLI   QH_STAT,QH_SAVEQ    and not when only saving                     
         JE    VALDSC02                                                         
         OC    0(L'RATRATE,R2),0(R2) Yes - have they cleared discount           
         JNZ   VALDSC04            No                                           
VALDSC02 XC    CS_DISC,CS_DISC     Yes - clear discount rate and exit           
         J     EXITY                                                            
                                                                                
VALDSC04 MVC   CS_DISC,0(R2)                                                    
         J     EXITY                                                            
                                                                                
         EJECT                                                                  
***********************************************************************         
* Validate job code                                                   *         
*                                                                     *         
* Ntry:- R1=A(ULCliProJob)                                            *         
***********************************************************************         
                                                                                
VALJOB   NTR1  LABEL=NO,WORK=(RC,VJWORKL)                                       
         J     *+12                                                             
         DC    C'*VALJOB*'                                                      
                                                                                
         USING VJWORKD,RC          RC=A(local working storage)                  
         LR    R2,R1               R2=A(Job code)                               
         GOTOR CLRWRK,VJWORKL      Clear work area                              
         USING OB_D,VJRBAREA                                                    
                                                                                
         XC    ROUERRV,ROUERRV                                                  
         MVC   CS_SJOFF,SPACES                                                  
         MVC   CS_OFNAM,SPACES                                                  
         MVC   CS_CLNAM,SPACES                                                  
         MVC   CS_PRNAM,SPACES                                                  
         MVC   CS_JBNAM,SPACES                                                  
         MVC   CS_MDNAM,SPACES                                                  
         MVC   CS_MED,SPACES                                                    
         XC    CS_1CULA,CS_1CULA                                                
         XC    CS_DSULA,CS_DSULA                                                
         XC    CS_IND1,CS_IND1                                                  
         MVI   CS_EXPJB,NOQ                                                     
                                                                                
P        USING ACTKULA,R2                                                       
                                                                                
         CLI   CS_ITYPE,CS_IBILQ                                                
         JNE   VALJOB08                                                         
K        USING LDGRECD,IOKEY                                                    
         MVC   K.LDGKEY,SPACES                                                  
         MVC   K.LDGKCPY,CUXCPY                                                 
         MVC   K.LDGKUNT(L'LDGKUNT+L'LDGKLDG),P.ACTKUNT                         
         MVC   OB_KEY(L'LDGKEY),K.LDGKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALJOB04                                                         
         JH    EXITN                                                            
         MVC   CS_DSULA,OB_DATA                                                 
         J     VALJOB08                                                         
                                                                                
VALJOB04 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR TSTSEC,0            Test security                                
         MVC   OB_ERROR,ROUERRV    Set error if any                             
         GOTOR GETELA,LDGELQ       Locate ledger element on record              
         JE    *+6                                                              
         DC    H'0'                                                             
         USING LDGELD,R1                                                        
         CLC   LDGCDSCA,SPACES                                                  
         JNH   VALJOB06                                                         
         MVC   OB_DATA(L'ACTKULA),LDGCDSCU                                      
         MVC   CS_DSULA,OB_DATA                                                 
                                                                                
VALJOB06 GOTOR ADDBUF,OB_D                                                      
         OC    OB_ERROR,OB_ERROR                                                
         JNZ   EXITN                                                            
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
                                                                                
K        USING ACTRECD,IOKEY       Build key of client                          
VALJOB08 MVC   K.ACTKEY,SPACES                                                  
         MVC   K.ACTKCPY,CUXCPY                                                 
         MVC   K.ACTKUNT(L'ACTKUNT+L'ACTKLDG),P.ACTKUNT                         
         LLC   RF,PCLILEN                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   K.ACTKACT(0),P.ACTKACT                                           
         EX    RF,0(RE)                                                         
                                                                                
         MVC   OB_KEY(L'ACTKEY),K.ACTKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALJOB10                                                         
         JH    EXITN                                                            
                                                                                
         MVC   CS_CLNAM,OB_NAME                                                 
         MVC   CS_SJOFF,OB_SJOFF                                                
         MVC   CS_1CULA,OB_1CAC                                                 
         OI    CS_IND1,CS_ICLI     Set client level                             
         J     VALJOB18                                                         
                                                                                
VALJOB10 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$INCLI)                                           
         J     VALJOBN                                                          
                                                                                
         CLI   QH_STAT,QH_REJQ     If rejecting ignore locked/closed            
         JE    VALJOB12                                                         
         TM    K.ACTKSTAT,ACTSLOCK                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$CLILK)                                           
         J     VALJOBN                                                          
                                                                                
         TM    K.ACTKSTAT,ACTSCLOS                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACTCL)                                           
         J     VALJOBN                                                          
                                                                                
VALJOB12 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         OI    CS_IND1,CS_ICLI     Set client level                             
                                                                                
         GOTOR TSTSEC,0            Test security                                
         JNE   VALJOBN                                                          
VALJOB14 GOTOR GETNAM,OB_NAME      Set client name                              
         MVC   CS_CLNAM,OB_NAME                                                 
         GOTOR GETELA,PPRELQ       Locate production profile element            
         JE    *+6                                                              
         DC    H'0'                                                             
         USING PPRELD,R1                                                        
         MVC   CS_SJOFF,PPRGAOFF                                                
         OC    CS_SJOFF,SPACES                                                  
         MVC   OB_SJOFF,CS_SJOFF                                                
         CLC   PPRCOST,SPACES                                                   
         JNH   VALJOB16                                                         
         MVC   CS_1CULA,PPRCOSTU                                                
         OC    CS_1CULA,SPACES                                                  
         MVC   OB_1CAC,CS_1CULA                                                 
         DROP  R1                                                               
                                                                                
VALJOB16 GOTOR ADDBUF,OB_D                                                      
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
VALJOB18 LLC   RE,PCLILEN                                                       
         LLC   RF,PPROLEN                                                       
         LA    R1,P.ACTKACT(RE)                                                 
         SR    RF,RE                                                            
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         CLC   0(0,R1),SPACES                                                   
         EX    RF,0(RE)                                                         
         JH    VALJOB20                                                         
         LLC   RF,PJOBLEN          Clear the rest of anyaccnt                   
         LLC   RE,PCLILEN          to ensure any job code from web app          
         SR    RF,RE               is cleared if there is no product            
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   0(0,R1),SPACES                                                   
         EX    RF,0(RE)                                                         
         CLI   CS_ITYPE,CS_IBILQ   Billable expense needs product               
         JNE   VALJOB62                                                         
         MVC   ROUERRV,=AL2(AE$MSPRD)                                           
         J     EXITN                                                            
                                                                                
VALJOB20 LLC   RF,PPROLEN          Build key of product                         
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   K.ACTKACT(0),P.ACTKACT                                           
         EX    RF,0(RE)                                                         
         MVC   OB_KEY(L'ACTKEY),K.ACTKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALJOB22                                                         
         JH    EXITN                                                            
                                                                                
         MVC   CS_PRNAM,OB_NAME                                                 
         CLC   OB_SJOFF,SPACES                                                  
         JNH   *+10                                                             
         MVC   CS_SJOFF,OB_SJOFF                                                
         CLC   OB_1CAC,SPACES                                                   
         JNH   *+10                                                             
         MVC   CS_1CULA,OB_1CAC                                                 
         OI    CS_IND1,CS_IPRO     Set product level                            
         J     VALJOB32                                                         
                                                                                
VALJOB22 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$INPRO)                                           
         J     VALJOBN                                                          
                                                                                
         CLI   QH_STAT,QH_REJQ     If rejecting ignore locked/closed            
         JE    VALJOB24                                                         
         TM    K.ACTKSTAT,ACTSLOCK                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACTLK)                                           
         J     VALJOBN                                                          
                                                                                
         TM    K.ACTKSTAT,ACTSCLOS                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACTCL)                                           
         J     VALJOBN                                                          
                                                                                
VALJOB24 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         OI    CS_IND1,CS_IPRO     Set product level                            
                                                                                
         GOTOR TSTSEC,0            Test security                                
         JNE   VALJOBN                                                          
VALJOB26 GOTOR GETNAM,OB_NAME      Set product name                             
         MVC   CS_PRNAM,OB_NAME                                                 
         GOTOR GETELA,PPRELQ       Locate production profile element            
         JNE   VALJOB30                                                         
         USING PPRELD,R1                                                        
         MVC   OB_SJOFF,PPRGAOFF                                                
         CLI   PPRGAOFF,C' '                                                    
         JNH   VALJOB28                                                         
         MVC   CS_SJOFF,PPRGAOFF                                                
         OC    CS_SJOFF,SPACES                                                  
VALJOB28 MVC   OB_1CAC,PPRCOSTU                                                 
         CLC   PPRCOST,SPACES                                                   
         JNH   VALJOB30                                                         
         MVC   CS_1CULA,PPRCOSTU                                                
         OC    CS_1CULA,SPACES                                                  
                                                                                
VALJOB30 GOTOR ADDBUF,OB_D                                                      
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
VALJOB32 LLC   RE,PPROLEN                                                       
         LLC   RF,PJOBLEN                                                       
         LA    R1,P.ACTKACT(RE)                                                 
         SR    RF,RE                                                            
         SHI   RF,1                                                             
         CLC   0(0,R1),SPACES                                                   
         JH    VALJOB34                                                         
         CLI   CS_ITYPE,CS_IBILQ   Billable expense needs job                   
         JNE   VALJOB62                                                         
         MVC   ROUERRV,=AL2(AE$MSJOB)                                           
         J     EXITN                                                            
                                                                                
VALJOB34 MVC   K.ACTKACT,P.ACTKACT                                              
         MVC   OB_KEY(L'ACTKEY),K.ACTKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALJOB40                                                         
         JH    EXITN                                                            
                                                                                
         MVC   CS_JBNAM,OB_NAME                                                 
         MVC   CS_CLICD,OB_CLICD                                                
         MVC   CS_UWLST,OB_UWLST                                                
         CLC   OB_SJOFF,SPACES                                                  
         JNH   *+10                                                             
         MVC   CS_SJOFF,OB_SJOFF                                                
         CLC   OB_1CAC,SPACES                                                   
         JNH   *+10                                                             
         MVC   CS_1CULA,OB_1CAC                                                 
*&&US                                                                           
         USING JOBELD,R1                                                        
         TM    OB_JSTA1,JOBSXJOB   Is this an expense job?                      
         JNO   VALJOB36                                                         
         MVI   CS_EXPJB,YESQ       Set job is an expense job.                   
VALJOB36 CLI   CS_ITYPE,CS_INONQ   Non-Billable item cant post to job           
         JNE   VALJOB38                                                         
         MVC   ROUERRV,=AL2(AE$NEXPJ)                                           
         J     EXITN                                                            
*&&                                                                             
VALJOB38 OI    CS_IND1,CS_IJOB     Set job level                                
         J     VALJOB56                                                         
                                                                                
VALJOB40 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$INJOB)                                           
         J     VALJOBN                                                          
                                                                                
         CLI   QH_STAT,QH_REJQ     If rejecting ignore locked/closed            
         JE    VALJOB42                                                         
         TM    K.ACTKSTAT,ACTSDRFT                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACCNA)                                           
         J     VALJOB42                                                         
                                                                                
         TM    K.ACTKSTAT,ACTSLOCK                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$JOBLK)                                           
         J     VALJOB42                                                         
                                                                                
         TM    K.ACTKSTAT,ACTSCLOS                                              
         JZ    *+10                                                             
         MVC   ROUERRV,=AL2(AE$JOBCL)                                           
                                                                                
VALJOB42 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         OI    CS_IND1,CS_IJOB     Set job level                                
                                                                                
         GOTOR TSTSEC,0            Test security                                
         JNE   VALJOBN                                                          
         CLI   QH_STAT,QH_REJQ     If rejecting ignore locked/closed            
         JE    VALJOB46                                                         
         USING RSTELD,R1                                                        
         TM    RSTLSTAT,RSTLSEXQ   Locked from external postings                
         JZ    VALJOB46                                                         
         MVC   ROUERRV,=AL2(AE$INACC)                                           
                                                                                
VALJOB46 GOTOR GETOPT,P.ACTKULA    Read opt maint settings                      
         MVC   OB_CLICD,CS_CLICD                                                
         MVC   OB_UWLST,CS_UWLST                                                
         GOTOR GETNAM,OB_NAME      Set job name                                 
         MVC   CS_JBNAM,OB_NAME                                                 
         GOTOR GETELA,PPRELQ                                                    
*&&UK*&& JNH   VALJOB54                                                         
*&&US*&& JNH   VALJOB50                                                         
         USING PPRELD,R1                                                        
         MVC   OB_SJOFF,PPRGAOFF                                                
         CLI   PPRGAOFF,C' '                                                    
         JNH   VALJOB48                                                         
         MVC   CS_SJOFF,PPRGAOFF                                                
         OC    CS_SJOFF,SPACES                                                  
                                                                                
VALJOB48 MVC   OB_1CAC,PPRCOSTU                                                 
         CLC   PPRCOST,SPACES                                                   
*&&UK*&& JNH   VALJOB54                                                         
*&&US*&& JNH   VALJOB50                                                         
         MVC   CS_1CULA,PPRCOSTU                                                
         OC    CS_1CULA,SPACES                                                  
         DROP  R1                                                               
                                                                                
*&&US                                                                           
VALJOB50 GOTOR GETELA,JOBELQ                                                    
         JNE   VALJOB54                                                         
         USING JOBELD,R1                                                        
         CLI   JOBLN,JOBLN3Q                                                    
         JL    VALJOB54                                                         
         MVC   OB_JSTA1,JOBSTA1    Save off status byte for later test          
         TM    JOBSTA1,JOBSXJOB    Is this an expense job?                      
         JNO   VALJOB52                                                         
         MVI   CS_EXPJB,YESQ       Set job is an expense job.                   
                                                                                
VALJOB52 CLI   CS_ITYPE,CS_INONQ   Non-Billable item cant post to job           
         JNE   VALJOB54                                                         
         MVC   ROUERRV,=AL2(AE$NEXPJ)                                           
         J     EXITN                                                            
*&&                                                                             
                                                                                
VALJOB54 OC    ROUERRV,ROUERRV                                                  
         JNZ   VALJOBN                                                          
         GOTOR ADDBUF,OB_D                                                      
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
K        USING PMDRECD,IOKEY                                                    
VALJOB56 MVC   K.PMDKEY,SPACES                                                  
         MVI   K.PMDKTYP,PMDKTYPQ                                               
         MVC   K.PMDKCPY,CUXCPY                                                 
         LLC   RE,PPROLEN                                                       
         LA    R1,P.ACTKACT(RE)                                                 
         MVC   K.PMDKMED,0(R1)                                                  
         MVC   CS_MED,0(R1)                                                     
         MVC   OB_KEY(L'PMDKEY),K.PMDKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALJOB58                                                         
         JH    EXITN                                                            
         MVC   CS_MDNAM,OB_NAME                                                 
         CLI   CS_ITYPE,CS_IBILQ   Is it billable                               
         JNE   VALJOB62            No                                           
         OC    OB_DISC,OB_DISC     Have we got discount at media level          
         JZ    VALJOB62            No                                           
         MVC   CS_DSULA,OB_DISC    Save discount account                        
         J     VALJOB62                                                         
                                                                                
VALJOB58 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$MCMIS)                                           
         J     VALJOBN                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         CLI   CS_ITYPE,CS_IBILQ   Is it billable                               
         JNE   VALJOB60            No                                           
         GOTOR GETELA,PMDELQ       Locate prod media element                    
         JNE   VALJOB60            Element doesn't exist                        
         USING PMDELD,R1                                                        
         CLC   PMDCSHDA,SPACES     Any discount account                         
         JNH   VALJOB60            No                                           
         MVC   OB_DISC,PMDCSHDU    Yes - extract account                        
         MVC   CS_DSULA,OB_DISC                                                 
                                                                                
VALJOB60 GOTOR GETNAM,OB_NAME      Set media name                               
         MVC   CS_MDNAM,OB_NAME                                                 
         GOTOR ADDBUF,OB_D                                                      
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
VALJOB62 CLI   OFFIND,NONEQ        Test office checking                         
         JE    VALJOB72                                                         
         CLC   CS_SJOFF,SPACES                                                  
         JNE   *+14                                                             
         MVC   ROUERRV,=AL2(AE$INVPO)                                           
         J     EXITN                                                            
                                                                                
         L     R1,AOFFAREA                                                      
         USING OFFALD,R1                                                        
         MVC   OFFAOFFC,CS_SJOFF                                                
         MVI   OFFAACT,OFFAVAL                                                  
         GOTOR VOFFAL              Validate office                              
         JE    VALJOB64                                                         
         MVC   ROUERRV,=AL2(AE$SECLK)                                           
         J     EXITN                                                            
         DROP  R1                                                               
                                                                                
VALJOB64 TM    CPYSTAT4,CPYSOFF2                                                
         JNZ   VALJOB68                                                         
                                                                                
K        USING ACTRECD,IOKEY                                                    
         MVC   K.ACTKEY,SPACES                                                  
         MVC   K.ACTKCPY,CUXCPY                                                 
         MVC   K.ACTKUNT(L'ACTKUNT+L'ACTKLDG),=C'2D'                            
         MVC   K.ACTKACT(1),CS_SJOFF                                            
         MVC   OB_KEY(L'ACTKEY),K.ACTKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALJOB66                                                         
         JH    EXITN                                                            
         MVC   CS_OFNAM,OB_NAME                                                 
         J     VALJOB72                                                         
                                                                                
VALJOB66 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$OFCNF)                                           
         J     VALJOBN                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR GETNAM,OB_NAME      Set job name                                 
         MVC   CS_OFNAM,OB_NAME                                                 
         GOTOR ADDBUF,OB_D                                                      
         XC    OB_D(OB_LNQ),OB_D                                                
         J     VALJOB72                                                         
                                                                                
K        USING OFFRECD,IOKEY                                                    
VALJOB68 MVC   K.OFFKEY,SPACES                                                  
         MVI   K.OFFKTYP,OFFKTYPQ                                               
         MVC   K.OFFKCPY,CUXCPY                                                 
         MVC   K.OFFKOFF(L'CS_SJOFF),CS_SJOFF                                   
         MVC   OB_KEY(L'OFFKEY),K.OFFKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALJOB70                                                         
         JH    EXITN                                                            
         MVC   CS_OFNAM,OB_NAME                                                 
         J     VALJOB72                                                         
                                                                                
VALJOB70 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$OFCNF)                                           
         J     VALJOBN                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR GETNAM,OB_NAME      Set job name                                 
         MVC   CS_OFNAM,OB_NAME                                                 
         GOTOR ADDBUF,OB_D                                                      
         XC    OB_D(OB_LNQ),OB_D                                                
                                                                                
VALJOB72 CLC   CS_1CULA,SPACES                                                  
         JH    *+14                                                             
         MVC   ROUERRV,=AL2(AE$COSTG)                                           
         J     VALJOBN                                                          
                                                                                
K        USING ACTRECD,IOKEY                                                    
         MVC   K.ACTKEY,SPACES                                                  
         MVC   K.ACTKCPY,CUXCPY                                                 
         MVC   K.ACTKULA,CS_1CULA                                               
         MVC   OB_KEY(L'ACTKEY),K.ACTKEY                                        
         GOTOR GETBUF,OB_D                                                      
         JL    VALJOB74                                                         
         JH    EXITN                                                            
         J     EXITY                                                            
                                                                                
VALJOB74 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$COSTG)                                           
         J     VALJOBN                                                          
                                                                                
         CLI   QH_STAT,QH_REJQ     If rejecting ignore locked/closed            
         JE    VALJOB76                                                         
         TM    K.ACTKSTAT,ACTSDRFT                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ACCNA)                                           
         J     VALJOBN                                                          
                                                                                
         TM    K.ACTKSTAT,ACTSLOCK                                              
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$LOCKD)                                           
         J     VALJOBN                                                          
                                                                                
VALJOB76 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR TSTSEC,0            Test security                                
         JNE   VALJOBN                                                          
         GOTOR ADDBUF,OB_D                                                      
         J     EXITY                                                            
                                                                                
VALJOBN  OC    OB_KEY,OB_KEY       Test have record key                         
         JZ    EXITN                                                            
         MVC   OB_ERROR,ROUERRV    Add record in error to buffer                
         GOTOR ADDBUF,OB_D                                                      
         J     EXITN                                                            
         DROP  RC,K,P                                                           
                                                                                
VJWORKD  DSECT                     ** VALJOB local w/s **                       
VJRBAREA DS    XL(OB_LNQ)          Buffer area                                  
         ORG   VJRBAREA+(OB_OTHER-OB_D)                                         
OB_SJOFF DS    CL(L'CS_SJOFF)      SJ office code                               
OB_1CAC  DS    CL(L'CS_1CULA)      Costing account code                         
OB_DISC  DS    CL(L'ACTKULA)       Discount account                             
OB_UWLST DS    CL(L'GOUWLIST)      List of unbillable work codes                
OB_CLICD DS    CL(L'GOCLICD)       Pass cash discount to client                 
*&&US                                                                           
OB_JSTA1 DS    CL(L'JOBSTA1)       Job status 1                                 
*&&                                                                             
         ORG                                                                    
VJWORKL  EQU   *-VJWORKD                                                        
SVRDEF   CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* Get options for client/product/job                                  *         
***********************************************************************         
                                                                                
GETOPT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GETOPT*'                                                      
         LR    R2,R1               R2=A(SJ Account code)                        
P        USING ACTKULA,R2                                                       
                                                                                
         USING GOBLOCKD,R3                                                      
         L     R3,AGOBLOCB         GETOPT call                                  
         LR    R0,R3                                                            
         LA    R1,GOBLOCKX-GOBLOCK                                              
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         MVC   GOADM,VDATAMGR                                                   
         MVC   GOSELCUL,SPACES                                                  
         MVC   GOSELCUL(1),CUXCPY                                               
         MVC   GOSELCUL+1(2),PRODUL                                             
         MVC   GOSELCLI,SPACES                                                  
         LLC   RE,PCLILEN                                                       
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   GOSELCLI(0),P.ACTKACT                                            
         EX    RE,0(RF)                                                         
         MVC   GOSELPRO,SPACES                                                  
         LLC   RE,PCLILEN                                                       
                                                                                
         LLC   RF,PPROLEN                                                       
         SR    RF,RE                                                            
         SHI   RF,1                                                             
         LLC   RE,PCLILEN                                                       
         LA    RE,P.ACTKACT(RE)                                                 
         BASR  R1,0                                                             
         MVC   GOSELPRO(0),0(RE)                                                
         EX    RF,0(R1)                                                         
         LLC   RE,PPROLEN                                                       
         LLC   RF,PJOBLEN                                                       
         SR    RF,RE                                                            
         CHI   RF,L'GOSELJOB                                                    
         JNH   *+8                                                              
         LA    RF,L'GOSELJOB                                                    
         SHI   RF,1                                                             
         LLC   RE,PPROLEN                                                       
         LA    RE,P.ACTKACT(RE)                                                 
         BASR  R1,0                                                             
         CLC   0(0,RE),SPACES      DO WE HAVE A JOB CODE                        
         EX    RF,0(R1)                                                         
         JNH   GETOPT02            NO                                           
         MVC   GOSELJOB,SPACES                                                  
         BASR  R1,0                                                             
         MVC   GOSELJOB(0),0(RE)                                                
         EX    RF,0(R1)                                                         
GETOPT02 MVI   GOWHICH,0                                                        
         GOTO1 VGETOPT,DMCB,GOBLOCKD                                            
*                                                                               
         MVC   CS_CLICD,GOCLICD                                                 
         MVC   CS_UWLST,GOUWLIST                                                
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Validate work code                                                  *         
***********************************************************************         
                                                                                
VALWCD   NTR1  LABEL=NO,WORK=(RC,VWWORKL)                                       
         J     *+12                                                             
         DC    C'*VALWCD*'                                                      
                                                                                
         USING VWWORKD,RC                                                       
         MVC   CS_WC,0(R1)                                                      
                                                                                
         CLC   CS_WC,SPACES        Test work code present                       
         JH    VALWCD02                                                         
                                                                                
         TM    CS_IND1,CS_IJOB     Do we have job                               
         JZ    EXITY               No                                           
                                                                                
         MVC   CS_WC,CS_DWC        See if default work code exists              
         MVC   0(L'CS_WC,R1),CS_DWC                                             
         TM    TR_INDFN,TR_IFNMG   Are we likely to post?                       
         JZ    EXITY               No - not interested as not posting           
         CLC   CS_WC,SPACES                                                     
         JH    VALWCD02                                                         
                                                                                
         CLI   HD_USRFN,YESQ       Finance user?                                
         JNE   EXITY               No                                           
         CLI   QH_STAT,QH_SAVEQ    and not when only saving                     
         JE    EXITY                                                            
         MVC   ROUERRV,=AL2(AE$WCREQ)                                           
         CLI   CS_ITYPE,CS_IBILQ                                                
         JNE   EXITN                                                            
         MVC   ROUERRV,=AL2(AE$WCNIB)                                           
         J     EXITN                                                            
                                                                                
VALWCD02 TM    TR_INDFN,TR_IFNMG   Are we likely to post?                       
         JZ    EXITY               No - not interested as not posting           
         CLC   CS_WC,=C'99'        Can't be special types                       
         JE    *+14                                                             
         CLC   CS_WC,=C'**'                                                     
         JNE   *+14                                                             
         MVC   ROUERRV,=AL2(AE$INWRK)                                           
         J     EXITN                                                            
*&&UK                                                                           
         CLI   CUCTRY,CTRYGER      Type of work code OK?                        
         JNE   VALWCD04                                                         
         CLI   CS_WC,C'0'          Disallow external work codes                 
         JNL   VALWCD04                                                         
         MVC   ROUERRV,=AL2(AE$INWRK)                                           
         J     EXITN                                                            
*&&                                                                             
VALWCD04 CLI   CS_ITYPE,CS_IBILQ   Do we have a billable expense item           
         JNE   VALWCD10            No                                           
         LA    RF,CS_UWLST         Check for unbillable work codes              
         LA    R0,GOUWLSTN                                                      
                                                                                
VALWCD06 CLC   CS_WC,0(RF)         Check for match on non-bill workcode         
         JE    VALWCD08            'unbillable workcode'                        
         LA    RF,2(RF)                                                         
         JCT   R0,VALWCD06                                                      
         J     VALWCD10                                                         
                                                                                
VALWCD08 MVC   ROUERRV,=AL2(AE$PNBWC) Non-billable workcode                     
         J     EXITN                                                            
                                                                                
K        USING WCORECD,IOKEY                                                    
VALWCD10 GOTOR CLRWRK,VWWORKL      Clear work area                              
         USING OB_D,VWRBAREA                                                    
         MVC   K.WCOKEY,SPACES      Build key of work code record               
         MVI   K.WCOKTYP,WCOKTYPQ                                               
         MVC   K.WCOKCPY,CUXCPY                                                 
         MVC   K.WCOKUNT(L'PRODUL),PRODUL                                       
         MVC   K.WCOKWRK,CS_WC                                                  
         MVC   OB_KEY(L'WCOKEY),K.WCOKEY                                        
         DROP  K                                                                
                                                                                
         GOTOR GETBUF,OB_D         Read buffer record                           
         JH    EXITN               Exit if found or bad                         
         JE    EXITY                                                            
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$WRKNF)                                           
         J     VALWCDN                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR GETELA,WCOELQ       Locate work code element                     
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$INWRK)                                           
         J     VALWCDN                                                          
                                                                                
         USING WCOELD,R1                                                        
         CLI   QH_STAT,QH_REJQ     If rejecting ignore locked                   
         JE    VALWCD12                                                         
         TM    WCOSTAT2,WCOSLPST   work code locked for postings?               
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$WCLCK)                                           
         J     VALWCDN                                                          
         DROP  R1                                                               
VALWCD12 GOTOR ADDBUF,OB_D         Add valid entry to buffer                    
         J     EXITY                                                            
                                                                                
VALWCDN  MVC   OB_ERROR,ROUERRV    Add invalid entry buffer                     
         GOTOR ADDBUF,OB_D                                                      
         J     EXITN                                                            
         DROP  RC                                                               
                                                                                
VWWORKD  DSECT                     ** VALWCD local w/s **                       
VWRBAREA DS    XL(OB_LNQ)                                                       
         ORG   VWRBAREA+(OB_OTHER-OB_D)                                         
         ORG                                                                    
VWWORKL  EQU   *-VWWORKD                                                        
SVRDEF   CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* Validate expenditure type code                                      *         
***********************************************************************         
                                                                                
VALETY   NTR1  LABEL=NO,WORK=(RC,VEWORKL)                                       
         J     *+12                                                             
         DC    C'*VALETY*'                                                      
                                                                                
         USING VEWORKD,RC                                                       
         MVC   CS_ETYP,0(R1)                                                    
         GOTOR CLRWRK,VEWORKL       Clear work area                             
         USING OB_D,VERBAREA                                                    
                                                                                
         OC    CS_ETYP,CS_ETYP     Test etype code present                      
         JNZ   VALETY02                                                         
         MVC   ROUERRV,=AL2(AE$MIETY)                                           
         J     EXITN                                                            
                                                                                
K        USING ETYRECD,IOKEY                                                    
VALETY02 XC    K.ETYKEY,K.ETYKEY   Build key of etype code record               
         MVI   K.ETYKTYP,ETYKTYPQ                                               
         MVI   K.ETYKSUB,ETYKSUBQ                                               
         MVC   K.ETYKCPY,CUXCPY                                                 
         MVC   K.ETYKCODE,CS_ETYP                                               
         MVC   OB_KEY(L'ETYKEY),K.ETYKEY                                        
         GOTOR GETBUF,OB_D         Read buffer record                           
         JL    VALETY04            Not found                                    
         JH    EXITN               Previous error                               
                                                                                
         MVC   CS_ETST2,OB_ESTA2                                                
         MVC   CS_DWC,OB_WC                                                     
*&&UK*&& MVC   CS_VATAC,OB_VATAC                                                
         MVC   CS_VATC,OB_VATC                                                  
         MVC   CS_DEXAC,OB_EXAC                                                 
         J     EXITY                                                            
                                                                                
VALETY04 GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         CLC   K.ETYKEY(ETYKOFFC-ETYKEY),IOKEYSAV                               
         JE    *+14                                                             
         MVC   ROUERRV,=AL2(AE$INETY)                                           
         J     VALETYN                                                          
                                                                                
         CLI   QH_STAT,QH_REJQ     If rejecting ignore locked/closed            
         JE    VALETY06                                                         
         TM    K.ETYKSTAT,ETYSLOCK   Locked?                                    
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ETYLO)                                           
         J     EXITN                                                            
                                                                                
         TM    K.ETYKSAPP,ETYKSAEQ   Locked from Expenses?                      
         JZ    *+14                                                             
         MVC   ROUERRV,=AL2(AE$ETYLO)                                           
         J     EXITN                                                            
                                                                                
VALETY06 MVC   OB_ESTA2,K.ETYKSTA2                                              
         MVC   CS_ETST2,K.ETYKSTA2                                              
         DROP  K                                                                
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R2,IOADDR                                                        
         AHI   R2,ETYRFST-ETYRECD                                               
         USING LIDELD,R2                                                        
                                                                                
VALETY08 CLI   LIDEL,0                                                          
         JE    VALETY28                                                         
*&&UK*&& CLI   LIDEL,SPAELQ                                                     
*&&UK*&& JE    VALETY18                                                         
         CLI   LIDEL,FFTELQ                                                     
         JE    VALETY20                                                         
         CLI   LIDEL,LIDELQ                                                     
         JNE   VALETY10                                                         
         CLI   LIDTYPE,LIDTWKCD                                                 
         JE    VALETY12                                                         
         CLI   LIDTYPE,LIDTEXPS                                                 
         JE    VALETY22                                                         
VALETY10 LLC   R0,LIDLN                                                         
         AR    R2,R0                                                            
         J     VALETY08                                                         
                                                                                
VALETY12 LA    RF,LIDDWORK         look for default work code                   
         LLC   RE,LIDLN                                                         
         LA    RE,LIDEL(RE)                                                     
                                                                                
VALETY14 CR    RF,RE                                                            
         JNL   VALETY10                                                         
         TM    0(RF),X'40'                                                      
         JZ    VALETY16                                                         
         AHI   RF,L'LIDDWORK                                                    
         J     VALETY14                                                         
                                                                                
VALETY16 MVC   OB_WC,0(RF)                                                      
         OI    OB_WC,X'40'                                                      
         MVC   CS_DWC,OB_WC                                                     
         J     VALETY10                                                         
                                                                                
*&&UK                                                                           
         USING SPAELD,R2                                                        
VALETY18 CLI   SPATYPE,SPATITAX    VAT account                                  
         JNE   VALETY10                                                         
         TM    CPYSTAT5,CPYSNVAT                                                
         JNZ   VALETY10                                                         
         MVC   OB_VATAC,SPAAACT                                                 
         MVC   CS_VATAC,SPAAACT                                                 
         J     VALETY10                                                         
*&&                                                                             
         USING FFTELD,R2                                                        
VALETY20 CLI   FFTTYPE,FFTTVATC    VAT code                                     
         JNE   VALETY10                                                         
*&&UK*&& TM    CPYSTAT5,CPYSNVAT                                                
*&&UK*&& JZ    VALETY10                                                         
         MVC   OB_VATC,FFTDATA                                                  
         MVC   CS_VATC,FFTDATA                                                  
         J     VALETY10                                                         
                                                                                
         USING LIDELD,R2                                                        
VALETY22 LA    RF,LIDDAUNT                                                      
         LLC   R1,LIDLN                                                         
         LA    R1,LIDEL(R1)                                                     
                                                                                
VALETY24 TM    0(RF),X'40'         look out for default                         
         JZ    VALETY26                                                         
         AHI   RF,L'ACTKULA                                                     
         CR    RF,R1                                                            
         JNL   VALETY10                                                         
         J     VALETY24                                                         
                                                                                
VALETY26 MVC   OB_EXAC,0(RF)                                                    
         OI    OB_EXAC,X'40'                                                    
         MVC   CS_DEXAC,OB_EXAC                                                 
         J     VALETY10                                                         
                                                                                
                                                                                
VALETY28 GOTOR ADDBUF,OB_D         Add valid entry to buffer                    
         J     EXITY                                                            
                                                                                
VALETYN  MVC   OB_ERROR,ROUERRV    Add invalid entry buffer                     
                                                                                
         GOTOR ADDBUF,OB_D                                                      
         J     EXITN                                                            
         DROP  R2,RC                                                            
                                                                                
VEWORKD  DSECT                     ** VALETY local w/s **                       
VERBAREA DS    XL(OB_LNQ)                                                       
         ORG   VERBAREA+(OB_OTHER-OB_D)                                         
OB_ESTA2 DS    XL(L'ETYKSTA2)      Status byte 2 of Etype rec                   
OB_WC    DS    CL(L'LIDDWORK)      Default workcode for Etype                   
OB_VATAC DS    CL(L'ACTKULA)       VAT account                                  
OB_VATC  DS    CL1                 VAT code                                     
OB_EXAC  DS    CL(L'ACTKULA)       Default expense account                      
         ORG                                                                    
VEWORKL  EQU   *-VEWORKD                                                        
SVRDEF   CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* Check date is within limits of Postman logic                        *         
***********************************************************************         
         SPACE 1                                                                
DATCHK   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*DATCHK*'                                                      
         LR    R2,R1                                                            
DATCHK2  GOTOR VDATCON,DMCB,(2,(R2)),(1,CS_DATE)                                
         CLI   HD_USRFN,YESQ       Finance user?                                
         JE    DATCHK10                                                         
*                                                                               
         CLI   QH_STAT,QH_SUBMQ    Are we now submitting?                       
         JNE   EXITY               No - no checking required                    
         LA    R3,HD_DTLO          non-finance uses BDT cost profile            
         LA    R4,HD_DTHI                                                       
         J     DATCHK20                                                         
*                                                                               
DATCHK10 DS    0H                  finance uses fixed periods                   
*&&UK*&& LA    R0,1                    +/-one year in UK                        
*&&US*&& LA    R0,2                    +/-two in US                             
         GOTO1 VADDAY,PARM,(C'Y',HD_TODF),TEMP2,(R0)                            
         LNR   R0,R0                                                            
         GOTO1 (RF),(R1),,TEMP2+6,(R0)                                          
         GOTO1 VDATCON,DMCB,(0,TEMP2),(2,WORK+2)                                
         GOTO1 (RF),(R1),(0,TEMP2+6),(2,WORK)                                   
         LA    R4,WORK+2           high date finance approve                    
         LA    R3,WORK             low date finance approve                     
         OC    HD_DTLO,HD_DTLO     =PM CONTROL MAY MEAN NO LIMIT                
         JNZ   DATCHK20                                                         
         LA    R3,HD_DTLO          so respect that                              
*                                                                               
*                                                                               
DATCHK20 CLC   0(L'QI_DATE,R2),0(R3)     Common date checking                   
         JNL   DATCHK25                                                         
         CLI   QH_STAT,QH_REJQ                                                  
         JE    DATCHK25                                                         
         MVC   ROUERRV,=AL2(AE$CITOL)         Too low                           
         J     EXITN                                                            
*                                                                               
DATCHK25 CLC   0(L'QI_DATE,R2),0(R4)                                            
         JNH   EXITY                                                            
         MVC   ROUERRV,=AL2(AE$CITFF)         Too high                          
         J     EXITN                                                            
*                                                                               
         EJECT                                                                  
***********************************************************************         
* See what office we should post to                                   *         
* - Reads company or office list or office records                    *         
* - Parm1 = Office                                                    *         
***********************************************************************         
                                                                                
POSTOFF  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    CL8'*POSTOFF'                                                    
*                                                                               
         LR    R3,R1                                                            
         TM    CPXSTAT5,CPXUS1PY   Do we use 1R office for billable             
         JZ    POSTOF02            No                                           
         OI    HD_PIND,HD_PBOFF    Yes                                          
*                                                                               
POSTOF02 TM    CPXSTAT5,CPXUS1HY   Do we use 1R office for non-billable         
         JZ    POSTOF04                                                         
         OI    HD_PIND,HD_PNOFF                                                 
         TM    HD_PIND,HD_PBOFF                                                 
         JNZ   EXITY                                                            
*                                                                               
K        USING OFLPASD,IOKEY                                                    
POSTOF04 XC    K.OFLPAS,K.OFLPAS   Build office list passive key                
         MVI   K.OFLPTYP,OFLPTYPQ                                               
         MVI   K.OFLPSUB,OFLPSUBQ                                               
         MVC   K.OFLPCPY,CUXCPY                                                 
         MVC   K.OFLPOFF,0(R3)                                                  
         OC    K.OFLPOFF,SPACES                                                 
         MVC   CSVKEY1,K.OFLPAS                                                 
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         J     POSTOF08                                                         
*                                                                               
POSTOF06 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
*                                                                               
POSTOF08 CLC   CSVKEY1(OFLPOFL-OFLPAS),K.OFLPAS NO OFFICE LIST SETTING          
         JNE   POSTOF14                                                         
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         GOTOR GETELA,CPXELQ                                                    
         JNE   POSTOF06                                                         
OF       USING CPXELD,R1                                                        
         TM    OF.CPXSTAT5,CPXUS1PY   Check office to see whether               
         JZ    POSTOF12               to use 1R office                          
         OI    HD_PIND,HD_PBOFF                                                 
                                                                                
POSTOF12 TM    OF.CPXSTAT5,CPXUS1HY                                             
         JZ    POSTOF06                                                         
         OI    HD_PIND,HD_PNOFF                                                 
         J     POSTOF06                                                         
         DROP  OF                                                               
*                                                                               
K        USING OFFRECD,IOKEY                                                    
POSTOF14 MVC   K.OFFKEY,SPACES                                                  
         MVI   K.OFFKTYP,OFFKTYPQ                                               
         MVC   K.OFFKCPY,CUXCPY                                                 
         MVC   K.OFFKOFF,0(R3)                                                  
         OC    K.OFFKOFF,SPACES                                                 
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   EXITY                                                            
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         GOTOR GETELA,CPXELQ                                                    
         JNE   EXITY                                                            
OF       USING CPXELD,R1                                                        
         TM    OF.CPXSTAT5,CPXUS1PY                                             
         JZ    POSTOF16                                                         
         OI    HD_PIND,HD_PBOFF                                                 
                                                                                
POSTOF16 TM    OF.CPXSTAT5,CPXUS1HY                                             
         JZ    EXITY                                                            
         OI    HD_PIND,HD_PNOFF                                                 
         J     EXITY                                                            
         DROP  OF                                                               
         EJECT                                                                  
***********************************************************************         
* Check MOA for open expense                                          *         
***********************************************************************         
                                                                                
CHKMOA   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*CHKMOA*'                                                      
         CLI   QH_STAT,QH_APPQ     Are we approving?                            
         JE    *+12                                                             
         CLI   QH_STAT,QH_REJQ     or rejecting?                                
         JNE   EXITY                                                            
                                                                                
         LA    RF,HD_DATEP                                                      
                                                                                
         OC    QH_BMOA,QH_BMOA     if MOA passed then set from there            
         JZ    CHKMOA02                                                         
         LA    RF,QH_BMOA                                                       
CHKMOA02 GOTOR MTHLCK,DMCB,(RF)                                                 
         JE    EXITY                                                            
         MVC   ROUERRV,=AL2(AE$MOSLK)                                           
         J     EXITN                                                            
         EJECT                                                                  
***********************************************************************         
* Check for month lock                                                *         
***********************************************************************         
                                                                                
MTHLCK   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    CL8'*MTHLCK*'                                                    
                                                                                
         L     R2,0(R1)                                                         
         MVC   HD_MOA(2),0(R2)    Period month                                  
                                                                                
MTHLCK02 MVI   HD_MOA+2,1         Set first of month                            
         GOTOR VDATCON,DMCB,(1,HD_MOA),(0,WORK)                                 
         GOTOR VDATCON,DMCB,(0,WORK),(1,HD_MOA)                                 
         GOTOR VDATCON,DMCB,(X'81',HD_MOA),(6,DUB2)                             
*&&US*&& MVI   BYTE2,10                                                         
         MVC   BYTE1,4(R1)                                                      
*&&UK*&& MVI   BYTE2,70                                                         
***      GOTO1 BMONVAL,PARM,(BYTE1,DUB2),(BYTE2,ACOMFACS),             *        
               (CULANG,TEMP2),(CUXCPY,0)                                        
*&&US                                                                           
         GOTO1 BMONVAL,PARM,(BYTE1,DUB2),(BYTE2,ACOMFACS),             *        
               (CULANG,TEMP2),(CUXCPY,0)                                        
*&&                                                                             
*&&UK                                                                           
         GOTO1 BMONVAL,PARM,(BYTE1,DUB2),(BYTE2,ACOMFACS),             *        
               (CULANG,TEMP2),(CUXCPY,CUUSER)                                   
*&&                                                                             
         CLI   TEMP2+(BMOERR-BMONVALD),BMOEOKQ                                  
         JE    EXITY                                                            
         J     EXITN                                                            
                                                                                
*        GOTOR VDATCON,DMCB,(1,HD_MOA),(0,WORK)                                 
*        GOTOR VADDAY,DMCB,(C'M',WORK),WORK+6,1                                 
*        GOTOR VDATCON,DMCB,(0,WORK+6),(1,HD_MOA)                               
*        J     MTHLCK02                                                         
         EJECT                                                                  
***********************************************************************         
* Get Off/Dep/Subd for HD_1RPER person code                           *         
***********************************************************************         
                                                                                
GETODS   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GETODS*'                                                      
                                                                                
K        USING PERRECD,IOKEY                                                    
         MVC   K.PERKEY,SPACES                                                  
         MVI   K.PERKTYP,PERKTYPQ                                               
         MVC   K.PERKCPY,CUXCPY                                                 
         MVC   K.PERKCODE,HD_1RPER                                              
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JE    GETODS02                                                         
         MVC   ROUERRV,=AL2(AE$IVPER)                                           
         J     EXITN                                                            
         DROP  K                                                                
                                                                                
GETODS02 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,IOADDR                                                        
         AHI   R2,PERRFST-PERRECD  Locate elements                              
         USING LOCELD,R2                                                        
                                                                                
GETODS10 CLI   LOCEL,0                                                          
         JE    GETODSE                                                          
         CLI   LOCEL,LOCELQ                                                     
         JNE   GETODS20                                                         
         CLC   LOCSTART,HD_DATEP                                                
         JH    GETODS20                                                         
         OC    LOCEND,LOCEND                                                    
         JZ    GETODS30                                                         
         CLC   LOCEND,HD_DATEP                                                  
*        JH    GETODS30                                                         
         JNL   GETODS30                                                         
                                                                                
GETODS20 LLC   R0,LOCLN                                                         
         AR    R2,R0                                                            
         J     GETODS10                                                         
                                                                                
GETODS30 MVC   HD_1ROFF,LOCOFF                                                  
         MVC   HD_1RDEP,LOCDEPT                                                 
         MVC   HD_1RSUB,LOCSUB                                                  
         MVC   HD_1RULA,LEDGER1R                                                
         MVC   HD_1RACT,SPACES                                                  
         LLC   RF,ONERL1L                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   HD_1RACT(0),HD_1ROFF                                             
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         LA    R2,HD_1RACT                                                      
         AR    R2,RF                                                            
         LLC   RE,ONERL2L                                                       
         SR    RE,RF                                                            
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   0(0,R2),HD_1RDEP                                                 
         EX    RE,0(RF)                                                         
         AHI   RE,1                                                             
         AR    R2,RE                                                            
                                                                                
         LLC   RE,ONERL3L                                                       
         LLC   RF,ONERL2L                                                       
         SR    RE,RF                                                            
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   0(0,R2),HD_1RSUB                                                 
         EX    RE,0(RF)                                                         
         AHI   RE,1                                                             
         AR    R2,RE                                                            
                                                                                
         LLC   RE,ONERL4L                                                       
         LLC   RF,ONERL3L                                                       
         SR    RE,RF                                                            
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   0(0,R2),HD_1RPER                                                 
         EX    RE,0(RF)                                                         
                                                                                
         MVC   TEMP2(2),HD_PPID#                                                
         GOTOR (#GETPID,AGETPID)                                                
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   GETODS50                                                         
         MVC   HD_EMLCL,APPEMAIL                                                
         MVI   BYTE4,SE#EXPS                                                    
         GOTOR (#SEMAIL,ASEMAIL),DMCB,HD_1ROFF,BYTE4                            
         JE    GETODS50                                                         
                                                                                
         OI    HD_IND,HD_NOEM      Send no emails                               
         XC    HD_EMLCL,HD_EMLCL                                                
         XC    HD_EMLRS,HD_EMLRS                                                
                                                                                
GETODS50 MVC   HD_SUPAC,SPACES     get default supplier account                 
         MVC   HD_2DOF,SPACES      and office (from 2D)                         
K        USING PIDRECD,IOKEY                                                    
         XC    K.PIDKEY,K.PIDKEY                                                
         MVI   K.PIDKTYP,PIDKTYPQ                                               
         MVI   K.PIDKSUB,PIDKSUBQ                                               
         MVC   K.PIDKCPY,CUXCPY                                                 
         MVC   K.PIDKPID,HD_PPID#                                               
         MVI   K.PIDKSTYP,PIDKCRDQ                                              
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         CLC   K.PIDKEY(PIDKPER-PIDRECD),IOKEYSAV                               
         JE    GETODS52                                                         
         MVC   ROUERRV,=AL2(AE$PIDCR)                                           
         J     EXITN                                                            
                                                                                
GETODS52 MVC   HD_SUPAC,K.PIDKULA                                               
         DROP  K                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R2,IOADDR                                                        
         AHI   R2,ACTRFST-ACTRECD  Locate elements                              
         USING SPAELD,R2                                                        
                                                                                
GETODS54 CLI   SPAEL,0                                                          
         JE    GETODS60                                                         
         CLI   SPAEL,SPAELQ                                                     
         JE    GETODS58                                                         
                                                                                
GETODS56 LLC   R0,SPALN                                                         
         AR    R2,R0                                                            
         J     GETODS54                                                         
                                                                                
GETODS58 CLI   SPATYPE,SPATDEPT                                                 
         JNE   GETODS56                                                         
         LLC   RF,ONERL1L                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   HD_2DOF(0),SPAAACT                                               
         EX    RF,0(RE)                                                         
                                                                                
         USING OFFALD,R1                                                        
GETODS60 L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,HD_1ROFF                                                
         CLC   HD_2DOF,SPACES                                                   
         JNH   *+10                                                             
         MVC   OFFAOFFC,HD_2DOF                                                 
         MVC   HD_OFFC,OFFAOFFC                                                 
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL              VALIDATE OFFICE                              
         JE    EXITY                                                            
         MVC   ROUERRV,=AL2(AE$SECLK)                                           
         J     EXITN                                                            
         DROP  R1                                                               
                                                                                
GETODSE  MVC   ROUERRV,=AL2(AE$NODRT)                                           
         J     EXITN                                                            
         EJECT                                                                  
***********************************************************************         
* Validate Claimant override                                          *         
***********************************************************************         
SETCOD   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*SETCOD*'                                                      
                                                                                
         MVC   TEMP2(8),QH_PER                                                  
         MVC   HD_1RPER,QH_PER     Set person code (accounting)                 
                                                                                
         GOTOR (#ACCPFP,AACCPFP)                                                
         JE    SETCOD2                                                          
         MVC   ROUERRV,=AL2(AE$INPID)                                           
         J     EXITN                                                            
                                                                                
SETCOD2  MVC   HD_PPID#,TEMP2+8                                                 
         MVC   TEMP2(L'SA0KNUM),CCTPID                                          
         GOTOR (#GETPID,AGETPID)                                                
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   EXITY                                                            
         MVC   HD_EMLRS,APPEMAIL                                                
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Build a new claim buffer record and add it to new claim buffer      *         
***********************************************************************         
                                                                                
NEWCLM   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*NEWCLM*'                                                      
                                                                                
         MVC   CL_ITEM#,QI_ITM#    Set item row rumber                          
                                                                                
         TM    HD_IND,HD_INOPR     No previous claim records found              
         JZ    *+8                                                              
         OI    CL_BSTAT,CL_BSRNR   All records must be adds                     
                                                                                
         CLI   QI_DELT,YESQ                                                     
         JNE   *+8                                                              
         OI    CL_STAT,CIDMSID                                                  
                                                                                
         OC    QX_ITM#,QX_ITM#     Is it extra data                             
         JNZ   NEWCLM26            Yes                                          
                                                                                
         MVC   CL_SJAC,CS_ACT      Set production account                       
*&&US*&& MVC   CL_EXPJB,CS_EXPJB   Set job is an expense job                    
         MVC   CL_CLINM,CS_CLNAM                                                
         CLI   CS_ITYPE,CS_IBILQ   Only interested in WC for billable           
         JE    NEWCLM02                                                         
         TM    CS_IND1,CS_IJOB     Or non billable with job                     
         JZ    *+10                                                             
NEWCLM02 MVC   CL_WC,CS_WC         Set work code                                
         MVC   CL_OFF,CS_OFF       Set posting office                           
         MVC   CL_SJOFF,CS_SJOFF   Set client office                            
         MVC   CL_MED,CS_MED       Set media code                               
         MVC   CL_ADAT,QI_DATE     Set item date                                
         MVC   CL_ITYPE,CS_ITYPE   Set item type                                
         MVC   CL_ETYP,CS_ETYP     Set expenditure type                         
         ZAP   CL_AMT,QI_AMT       Set amount                                   
         GOTOR GETCAP,DMCB,CL_D                                                 
         JNE   EXITH                                                            
         OC    CS_VATAC,CS_VATAC                                                
         JZ    *+16                                                             
         MVC   CL_VATAC(L'LEDGERSG),LEDGERSG                                    
         MVC   CL_VATAC+L'LEDGERSG(L'ACTKACT),CS_VATAC Set VAT account          
         MVC   CL_VATC,CS_VATC     Set VAT code                                 
*&&US                     **  For Canadian tax populate PST **                  
         OC    CS_PSTAC,CS_PSTAC                                                
         JZ    *+16                                                             
         MVC   CL_PSTAC(L'LEDGERSG),LEDGERSG                                    
         MVC   CL_PSTAC+L'LEDGERSG(L'ACTKACT),CS_PSTAC Set PST account          
         MVC   CL_PSTC,CS_PSTC     Set PST code                                 
*&&                                                                             
         MVC   CL_NARL(L'CL_NARL+L'CL_NAR),QI_NARL                              
         MVC   CL_NAROL(L'CL_NARL+L'CL_NAR),QI_ONARL                            
         MVC   CL_EST,QI_EST                                                    
*&&US                                                                           
         CLI   HD_USRFN,YESQ       Finance user connected?                      
         JNE   NEWCLM04            No                                           
         MVC   CL_INT,QI_INT#      Yes - they can add own internal              
         MVC   CL_REF,QI_REF                                  reference         
         OC    CL_REF,CL_REF                                                    
         JNZ   NEWCLM06                                                         
NEWCLM04 MVC   CL_REF,HD_CLM#      Set claim number as trans reference          
*&&                                                                             
                                                                                
*&&UK                                                                           
         CLI   HD_USRFN,YESQ       Finance user connected?                      
         JNE   NEWCLM03            No                                           
         MVC   CL_INT,QI_INT#                                                   
                                                                                
         OC    CL_INT,CL_INT       If the internal ref isn't present            
         JNZ   NEWCLM04                                                         
NEWCLM03 MVC   CL_INT,SPACES                                                    
         MVC   CL_INT(L'HD_CLM#),HD_CLM#  Use claim number                      
                                                                                
NEWCLM04 MVC   CL_REF,QI_REF       Was own reference set                        
         OC    CL_REF,CL_REF                                                    
         JNZ   NEWCLM06            Yes - otherwise use default                  
                                                                                
         CURED (B1,QI_ITM#),(L'CL_REF,CL_REF),0                                 
         OC    CL_REF,=C'000000'                                                
                                                                                
         TM    CPXSTAT8,CPXCLNTR   Is this agency set to use claim              
         JZ    NEWCLM06                   number as transaction ref             
         MVC   CL_REF,HD_CLM#      Yes - set reference appropriately            
*&&                                                                             
NEWCLM06 GOTOR ADDAPP,CL_BDATA                                                  
                                                                                
         CLI   CS_ITYPE,CS_IADVQ   For advances don't buffer accounts           
         JE    NEWCLM10                                                         
         MVC   CL_SUPAC,CS_SUPAC                                                
         MVC   CL_SUNAM,CS_SUNAM                                                
         MVC   CL_2DAC,CS_2DAC                                                  
         MVC   CL_2DNAM,CS_2DNAM                                                
         MVC   CL_2PAC,CS_2PAC                                                  
         MVC   CL_2PNAM,CS_2PNAM                                                
*&&US*&& CLI   CS_EXPJB,YESQ       If Job is an expense job                     
*&&US*&& JE    NEWCLM07            then treat it as non-billable                
         CP    CS_MILES,PZERO      If miles and billable may have staff         
         JNE   NEWCLM07                                   analysis              
         CLI   CS_ITYPE,CS_INONQ   Only interested for non billable             
         JNE   NEWCLM08                                                         
NEWCLM07 MVC   CL_EXAC,CS_EXULA                                                 
         MVC   CL_EXNAM,CS_EXNAM                                                
         MVC   CL_ESTA1,CS_ESTA1                                                
         MVC   CL_ECSTG,CS_COSTG                                                
         MVC   CL_1CULA,CS_1CULA                                                
NEWCLM08 GOTOR VALACS              Validate other accounts for posting          
         JE    NEWCLM10                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'CS_ACCER,CS_ACCER),CL_ITEM#               
         J     EXITL                                                            
                                                                                
NEWCLM10 ZAP   CL_DAMT,PZERO                                                    
         SR    RF,RF                                                            
         ICM   RF,3,CS_DISC        Set discount rate                            
         JZ    NEWCLM12                                                         
         ZAP   CL_DAMT,QI_DAMT     Set discount amount                          
         MVC   CL_DSULA,CS_DSULA                                                
         MVC   CL_CLICD,CS_CLICD                                                
                                                                                
NEWCLM12 ZAP   CL_FAMT,PZERO                                                    
         OC    QI_FAMT,QI_FAMT                                                  
         JZ    *+10                                                             
         ZAP   CL_FAMT,QI_FAMT     Set foreign amount                           
         ZAP   CL_NET,PZERO                                                     
         OC    QI_NAMT,QI_NAMT                                                  
         JZ    *+10                                                             
         ZAP   CL_NET,QI_NAMT      Set net amount                               
         MVC   CL_XRT,QI_XRAT                                                   
         MVC   CL_FCUR,CS_CURC                                                  
         CP    CL_NET,PZERO        Test if net set                              
         JNE   NEWCLM20                                                         
         CP    CL_FAMT,PZERO       No - so set net amount and vat codes         
         JE    *+14                                                             
         ZAP   CL_NET,CL_FAMT                                                   
         J     *+10                                                             
         ZAP   CL_NET,CL_AMT                                                    
                                                                                
*&&UK                                                                           
         J     NEWCLM20            Skip test below                              
*                                  As we have to allow items where              
*                                  they have no rate and agency amount          
*                                  where they previously had an advance         
         CLC   HD_CURR,CL_FCUR     Test if in agency currency                   
         JE    NEWCLM20            No                                           
         CLI   CS_ITYPE,CS_IADVQ   For advances don't do this                   
         JE    NEWCLM20                                                         
         TM    CS_IND2,CS_I2BEX    Rate known to be bad?                        
         JNZ   NEWCLM20            yes, don't use - assumes error               
*                                        already set!                           
         ZAP   DUB,CL_NET          Convert expense net to agency net            
         USING EURKBLKD,ELEMENT                                                 
         XC    EURKBLKD(EURKBLKL),EURKBLKD                                      
         MVC   EURKCUFR,HD_CURR                                                 
         MVC   EURKCUTO,CL_FCUR                                                 
         MVC   EURKALPH,CUAALF                                                  
         MVC   EURKDATE,HD_TODC                                                 
         MVC   EURKAFAC,ACOMFACS                                                
         MVI   EURKTYPE,ACCQ                                                    
         OI    EURKTYPE,ALLOWFTQ+SWAPQ                                          
         GOTO1 VEUREKA,PARM,('GETQ',EURKBLKD)                                   
         CLI   0(R1),0                                                          
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   EXRULE,EURKRULE                                                  
*                                                                               
         XC    EURKBLKD(EURKBLKL),EURKBLKD                                      
         MVC   EURKCUFR,HD_CURR                                                 
         MVC   EURKCUTO,CL_FCUR                                                 
         MVC   EURKRULE,CL_XRT                                                  
         MVC   EURKRLST,EXRULE+EURKRLST-EURKRULE                                
         MVC   EURKRLSH,EXRULE+EURKRLSH-EURKRULE                                
         GOTO1 VEUREKA,PARM,('INVERTQ+APPLYQ',EURKBLKD),DUB,DUB                 
         ZAP   AMTANET,DUB                                                      
         CLC   AMTANET,CL_AMT                                                   
         JNH   NEWCLM20                                                         
         DC    H'0'                                                             
*&&                                                                             
NEWCLM20 DS    0H                                                               
*&&US                                                                           
         MVC   CL_PROV,QI_PROVI                                                 
         ZAP   CL_GSTA,PZERO                                                    
         ZAP   CL_PSTA,PZERO                                                    
         OC    QI_AMTGS,QI_AMTGS                                                
         JZ    *+10                                                             
         ZAP   CL_GSTA,QI_AMTGS                                                 
         OC    QI_AMTPS,QI_AMTPS                                                
         JZ    *+10                                                             
         ZAP   CL_PSTA,QI_AMTPS                                                 
         MVC   CL_PSTC,QI_PSTCD                                                 
*&&                                                                             
         ZAP   CL_MILE,CS_MILES                                                 
         MVC   CL_RECPT,QI_RCPT                                                 
         MVC   CL_RCPTC,QI_RCPTC                                                
         MVC   CL_VEHC,QI_VEHCD                                                 
         MVC   CL_ENGC,QI_ENGCD                                                 
         MVC   CL_FUEL,QI_FUECD                                                 
         MVC   CL_PASS,QI_NMPAS                                                 
         MVC   CL_ACUNM,QI_ACUNM                                                
         ZAP   CL_ACUDS,PZERO                                                   
         OC    QI_ACUDS,QI_ACUDS                                                
         JZ    *+10                                                             
         ZAP   CL_ACUDS,QI_ACUDS                                                
         ZAP   CL_NONVT,PZERO                                                   
         OC    QI_NONVT,QI_NONVT                                                
         JZ    *+10                                                             
         ZAP   CL_NONVT,QI_NONVT                                                
         USING LW_D,R2                                                          
         XR    R2,R2                                                            
         ICM   R2,7,QI_ADIST                                                    
         JZ    NEWCLM24                                                         
         XR    R3,R3                                                            
         ICM   R3,3,LW_NUMN        Number of mileage rate entries               
         LTR   R3,R3                                                            
         JZ    NEWCLM24                                                         
         LA    R2,LW_LN2Q(,R2)     Bump over header                             
                                                                                
         LA    R6,CL_DRTE                                                       
DB       USING CL_DRTE,R6                                                       
NEWCLM22 MVC   DB.CL_DRTE(CL_DRTEL),0(R2)                                       
         LA    R6,CL_DRTEL(R6)                                                  
         LA    R2,CL_DRTEL(R2)                                                  
         JCT   R3,NEWCLM22                                                      
         DROP  DB                                                               
NEWCLM24 CLI   QI_ISSEL,YESQ                                                    
         JNE   *+8                                                              
         OI    CL_STAT,CIDMSSS                                                  
         CLI   QI_AGYIN,YESQ                                                    
         JNE   *+8                                                              
         OI    CL_STAT,CIDMSAI                                                  
         CLI   QI_DISCL,YESQ                                                    
         JNE   *+8                                                              
         OI    CL_STAT,CIDMDIS                                                  
         J     NEWCLM38                                                         
                                                                                
NEWCLM26 MVC   CL_ITEM#,QX_ITM#     Is it extra data                            
         MVC   CL_XDAT#,QX_CODE                                                 
         MVC   CL_XTYPE,QX_TYPE                                                 
         CLI   QX_TYPE,XDFEDDQ      date?                                       
         JE    NEWCLM34                                                         
         CLI   QX_TYPE,XDFEDAQ      amount?                                     
         JE    NEWCLM36                                                         
         CLI   QX_TYPE,XDFEDCQ      character                                   
         JE    NEWCLM28                                                         
         CLI   QX_TYPE,XDFEDXQ      drop down                                   
         JE    NEWCLM28                                                         
         CLI   QX_TYPE,XDFEDNQ      or number string?                           
         JE    NEWCLM28                                                         
         CLI   QX_TYPE,XDFEDYQ      yes/no                                      
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         MVI   CL_XCHLN,01                                                      
         MVC   CL_XCHAR(1),QX_DATA                                              
         J     NEWCLM38                                                         
                                                                                
NEWCLM28 LA    RF,QX_DATA+L'QX_DATA-1                                           
         LA    R1,L'QX_DATA                                                     
                                                                                
NEWCLM30 CLI   0(RF),C' '                                                       
         JH    NEWCLM32                                                         
         SHI   RF,1                                                             
         JCT   R1,NEWCLM30                                                      
*        DC    H'0'                                                             
         J     NEWCLM38                                                         
                                                                                
NEWCLM32 STC   R1,CL_XCHLN         Store length of string                       
         SHI   R1,1                                                             
         BASR  RF,0                                                             
         MVC   CL_XCHAR(0),QX_DATA                                              
         EX    R1,0(RF)                                                         
         J     NEWCLM38                                                         
                                                                                
NEWCLM34 OC    QX_DATA+2(1),QX_DATA+2                                           
         JZ    NEWCLM38                                                         
         GOTOR VDATCON,DMCB,(0,QX_DATA+2),(1,CL_XCHAR)                          
         MVI   CL_XCHLN,3                                                       
         J     NEWCLM38                                                         
                                                                                
NEWCLM36 OC    QX_DATA(16),QX_DATA                                              
         JZ    NEWCLM38                                                         
         MVC   TEMP2(16),QX_DATA                                                
         GOTOR (#CONAMT,ACONAMT)                                                
         ZAP   CL_XCHAR(6),TEMP2+16(8)                                          
         MVI   CL_XCHLN,6                                                       
                                                                                
NEWCLM38 GOTOR BUFCLM,DMCB,('TSAADD',NEWBUF),0                                  
         JE    NEWCLM40                                                         
         TM    CLMERR,TSEEOF       Test end of buffer                           
         JNZ   *+6                                                              
         DC    H'0'                Duplicate key                                
         MVC   ROUERRV,=AL2(AE$MAX#)                                            
         J     EXITH                                                            
                                                                                
NEWCLM40 CLI   RUNMODE,RVALREQQ    Test 'Validate request' mode                 
         JNE   EXITY                                                            
         GOTOR AALINKIO,DMCB,('LIOAPUT',LP_ALIOB),                     +        
               ('LIOTLRQ',64),('LQ_TSINQ',CL_D),CL_LN1Q                         
         GOTOR (RF),(R1),('LIOAPUT',LP_ALIOB),('LIOTGEL',0),RETDATEL            
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Build old claim buffer from existing claim records                  *         
***********************************************************************         
                                                                                
OLDCLM   NTR1  LABEL=NO,WORK=(RC,OTWORKL)                                       
         J     *+12                                                             
         DC    C'*OLDCLM*'                                                      
         USING OTWORKD,RC                                                       
         GOTOR CLRWRK,OTWORKL      Clear work area                              
         XC    CS_SEQ,CS_SEQ                                                    
                                                                                
K        USING EXNPASD,IOKEY       Read expense claim num passives              
         XC    K.EXNPAS,K.EXNPAS                                                
         MVI   K.EXNPTYP,EXNPTYPQ                                               
         MVI   K.EXNPSUB,EXNPSUBQ                                               
         MVC   K.EXNPCPY,CUXCPY                                                 
         MVC   K.EXNPNUM,QH_NUM                                                 
         MVC   K.EXNPTYPE,QH_TYPE                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         CLC   K.EXNPAS(EXNPSEQ-EXNPAS),IOKEYSAV                                
         JNE   EXITH               No data for this claim number/type           
                                                                                
         CLI   RUNMODE,RVALREQQ    Test 'Validate request' mode                 
         JNE   OLDCLM02            No                                           
         MVC   HD_ST1FR,K.EXNPSTAT Save status of first EXN passive             
         MVC   HD_ST2FR,K.EXNPSTA2                                              
         MVC   TR_ST2NW,K.EXNPSTA2                                              
         NI    TR_ST2NW,EXCKCLAQ                                                
                                                                                
OLDCLM02 CLC   HD_ST1FR,K.EXNPSTAT Test status same as first/saved              
         JE    *+6                                                              
         DC    H'0'                No - bad EXN passive status                  
         MVC   CSVKEY1,K.EXNPAS                                                 
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R4,IOADDR                                                        
         USING EXCRECD,R4          R4=A(Claim record)                           
         MVC   HD_1RULA,LEDGER1R                                                
         MVC   HD_1RACT,EXCK1RAC   Extract 1R account code                      
         LLC   RE,ONERL4L                                                       
         LLC   RF,ONERL3L                                                       
         SR    RE,RF                                                            
         SHI   RE,1                                                             
         LA    RF,EXCK1RAC(RF)                                                  
         BASR  R1,0                                                             
         MVC   HD_1RPER(0),0(RF)   Extract accounting person code               
         EX    RE,0(R1)                                                         
         OC    HD_1RPER,SPACES                                                  
                                                                                
         MVC   HD_PPID#,EXCKPIDB                                                
         MVC   HD_DATEC,EXCKDATE                                                
         XR    R1,R1               complement the date                          
         ICM   R1,3,HD_DATEC                                                    
         LNR   R1,R1                                                            
         STCM  R1,3,HD_DATE                                                     
         MVC   WORK(L'EXCKEY),EXCKEY                                            
                                                                                
         AHI   R4,EXCRFST-EXCRECD                                               
         USING CIDELD,R4                                                        
                                                                                
OLDCLM04 CLI   CIDEL,0             Test end of record                           
         JE    OLDCLM42                                                         
         CLI   CIDEL,XDFELQ        Test claim xdata element                     
         JE    OLDCLM20                                                         
         CLI   CIDEL,CLDELQ        Test claim data element                      
         JE    OLDCLM28                                                         
         CLI   CIDEL,CIDELQ        Test claim item element                      
         JNE   OLDCLM06                                                         
         CLI   CIDTYPE,CIDTYMQ     Test main type                               
         JE    OLDCLM08                                                         
OLDCLM06 LLC   R0,CIDLN            Bump to next input element                   
         AR    R4,R0                                                            
         J     OLDCLM04                                                         
         DROP  R4                                                               
                                                                                
OLDCLM08 GOTOR CLRCLD              Clear claim record                           
                                                                                
         LR    R2,R4               R2=A(Current detail item)                    
         USING CIDELD,R2                                                        
                                                                                
         LA    R0,CIDELD                                                        
         S     R0,AIO2                                                          
         STCM  R0,3,CL_SCLST       Set disp. to start of claim cluster          
                                                                                
         MVC   CL_ITEM#,CIDSEQ     Set current sequence number                  
         MVC   CS_SEQ,CIDSEQ                                                    
                                                                                
         MVC   CL_ADAT,CIDMDAT     Set item date                                
         MVC   CL_ETYP,CIDMEXP     Set item expenditure type                    
         MVC   CL_INT,CIDMINT      Set item internal reference                  
         MVC   CL_ITYPE,CIDMTYP     Set type of item: billable/non bill         
         MVC   CL_RECPT,CIDMREC    Set receipt for item                         
         MVC   CL_STAT,CIDMSTA     Set status of item                           
         MVC   CL_FCUR,CIDMCUR      Set currency code                           
         MVC   CL_XRT,CIDMRAT      Set exchange rate                            
         MVC   CL_AMT,CIDMAMT      Set amount                                   
         AP    TR_TAMT,CIDMAMT     Total up claim amounts                       
         MVC   CL_DAMT,CIDMDISC    Set discount amount                          
         MVC   CL_FAMT,CIDMFCA     Set foreign currency amount                  
         MVC   CL_MILE,CIDMMIL     Set miles                                    
*&&US                                                                           
         OC    CL_MILE,CL_MILE                                                  
         JNZ   *+10                                                             
         ZAP   CL_MILE,PZERO                                                    
         MVC   CL_PROV,CIDMPROV    Set Canadian tax province                    
         OC    CIDMGST,CIDMGST                                                  
         JNZ   OLDCLM8A                                                         
         ZAP   CL_GSTA,PZERO                                                    
         J     *+10                                                             
OLDCLM8A ZAP   CL_GSTA,CIDMGST     Set GST VAT amount                           
         OC    CIDMPST,CIDMPST                                                  
         JNZ   OLDCLM8B                                                         
         ZAP   CL_PSTA,PZERO                                                    
         J     *+10                                                             
OLDCLM8B ZAP   CL_PSTA,CIDMPST     Set PST VAT amount                           
*&&                                                                             
         MVC   CL_NET,CIDMNET      Set net amount                               
         MVC   CL_OFF,CIDMOFF      Set office of item                           
         MVC   CL_WC,CIDMWCD       Set workcode                                 
         MVC   CL_REF,CIDMREF      Set item reference                           
         ZAP   CL_NONVT,PZERO                                                   
         ZAP   CL_ACUDS,PZERO                                                   
         CLI   CIDLN,CIDMLNQ       Longer element with new mileage              
         JNH   OLDCLM10            No                                           
         MVC   CL_VEHC,CIDMVEH     Yes - set vehicle code                       
         MVC   CL_ENGC,CIDMENG     Set engine code                              
         MVC   CL_FUEL,CIDMFUEL    Set fuel type                                
         MVC   CL_PASS,CIDMPASS    Set number of passengers                     
         ZAP   CL_NONVT,CIDMNVTA   Set non vatable amount for distance          
         ZAP   CL_ACUDS,CIDMACDS   Set accumulated distance                     
         MVC   CL_ACUNM,CIDMACNM   Set accumulator number                       
         LA    RE,CIDMDNTY                                                      
         LA    R1,CL_DRTE                                                       
         XR    R0,R0                                                            
         ICM   R0,1,CIDMNUM                                                     
         JZ    OLDCLM10                                                         
OLDCLM09 MVC   0(CIDMDLNQ,R1),0(RE) Set status and pid of approver              
         LA    R1,CL_DRTEL(R1)                                                  
         LA    RE,CIDMDLNQ(RE)    Bump distance rate entry on CIDEL             
         JCT   R0,OLDCLM09                                                      
                                                                                
OLDCLM10 LLC   R0,CIDLN            Bump to next element                         
         AR    R2,R0                                                            
         CLI   CIDEL,CIDELQ        Test end of cluster/record                   
         JNE   OLDCLM40                                                         
         CLI   CIDTYPE,CIDTYMQ     Test main type                               
         JE    OLDCLM40                                                         
         CLI   CIDTYPE,CIDTYCQ     Test account type                            
         JE    OLDCLM14                                                         
         CLI   CIDTYPE,CIDTYAQ     Test approval type                           
         JE    OLDCLM16                                                         
         CLI   CIDTYPE,CIDTYOQ     Test claimant narrative type                 
         JE    OLDCLM12                                                         
         CLI   CIDTYPE,CIDTYNQ     Test finance narrative type                  
         JNE   OLDCLM10                                                         
         LLC   R1,CIDLN                                                         
         SHI   R1,L'CIDEL+L'CIDLN+L'CIDSEQ+L'CIDTYPE                            
         JNP   OLDCLM10                                                         
         STC   R1,CL_NARL                                                       
         BCTR  R1,0                                                             
         BASR  RE,0                                                             
         MVC   CL_NAR(0),CIDNARR   Set item narrative                           
         EX    R1,0(RE)                                                         
         J     OLDCLM10                                                         
                                                                                
OLDCLM12 LLC   R1,CIDLN                                                         
         SHI   R1,L'CIDEL+L'CIDLN+L'CIDSEQ+L'CIDTYPE                            
         JNP   OLDCLM10                                                         
         STC   R1,CL_NAROL                                                      
         BCTR  R1,0                                                             
         BASR  RE,0                                                             
         MVC   CL_NARO(0),CIDNARR  Set item narrative                           
         EX    R1,0(RE)                                                         
         J     OLDCLM10                                                         
                                                                                
OLDCLM14 MVC   CL_SJAC,CIDCCPJ     Set client product job                       
         MVC   CL_SJOFF,CIDCOFF    Set client office                            
         MVC   CL_EXAC,CIDCEXP     Set expense account                          
         MVC   CL_SUPAC,CIDCSUP    Set supplier account                         
         MVC   CL_2PAC,CIDC2PA     Set 2P account                               
         MVC   CL_2DAC,CIDC2DA     Set 2D account                               
         MVC   CL_VATC,CIDCVAT     Set vat code (Canadian GST code)             
         MVC   CL_VATAC,CIDCVAC    Set vat account (Canadian GST acc)           
*&&US*&& MVC   CL_PSTC,CIDCPST     Set Canadian PST Code                        
*&&US*&& MVC   CL_PSTAC,CIDCPSTA   Set Canadian PST Account                     
         MVC   CL_MED,CIDCMED      Set media                                    
         CLI   CIDLN,CIDCLNQ                                                    
         JNH   OLDCLM10                                                         
         MVC   CL_EST,CIDCEGN     Set estimate global number                    
         J     OLDCLM10                                                         
                                                                                
OLDCLM16 LA    RE,CIDANTRY                                                      
         LA    R1,CL_AP                                                         
         LLC   R0,CIDANUM                                                       
OLDCLM18 OC    1(L'CIDAPID,RE),1(RE) Is a PID present?                          
         JZ    OLDCLM10             No - then no further entries to get         
         MVC   0(L'CIDANTRY,R1),0(RE) Set status and pid of approver            
         LA    R1,CL_APL(R1)        Bump tsar record                            
         LA    RE,L'CIDANTRY(RE)    Bump approver entry on CIDEL                
         JCT   R0,OLDCLM18                                                      
         J     OLDCLM10                                                         
                                                                                
OLDCLM20 LR    R2,R4               R2=A(Current detail item)                    
         USING XDFELD,R2                                                        
         GOTOR CLRCLD              Clear claim record                           
         MVC   CL_ITEM#,XDFXPTC                                                 
         MVC   CL_XDAT#,XDFXPTX                                                 
         MVC   CL_XTYPE,XDFXTYP                                                 
OLDCLM24 LLC   R1,XDFLN                                                         
         SHI   R1,XDFXLNQ          R1=length of extra data                      
         STC   R1,CL_XCHLN                                                      
         BCTR  R1,0                Execute                                      
         BASR  RE,0                                                             
         MVC   CL_XCHAR(0),XDFXDTA Set data                                     
         EX    R1,0(RE)                                                         
         J     OLDCLM40                                                         
                                                                                
         USING CLDELD,R4                                                        
OLDCLM28 CLI   RUNMODE,RVALREQQ    Test 'Validate request' mode                 
         JNE   OLDCLM06            No                                           
         CLI   CLDTYPE,CLDTHDRQ    Header element                               
         JNE   OLDCLM30            No - get next element                        
         MVC   HD_INDX,CLDIDN      Index                                        
         MVC   HD_OUID,CLDUID      Userid                                       
         MVC   HD_APDTE,CLDAPDTE   Date approved for finance                    
         MVC   HD_APPID,CLDAPPID   PID of final approver                        
         MVC   HD_OPID,CLDPIDAD    Original pid that added claim                
         CLI   CLDLN,CLDLNQ                                                     
         JNH   OLDCLM06                                                         
         LLC   RF,CLDLN                                                         
         SHI   RF,CLDLNQ+1                                                      
         BASR  R1,0                                                             
         MVC   HD_DESC(0),CLDDESC                                               
         EX    RF,0(R1)                                                         
         AHI   RF,1                                                             
         STC   RF,HD_DESCL                                                      
         J     OLDCLM06                                                         
                                                                                
OLDCLM30 CLI   CLDTYPE,CLDCCMTQ    Claimant comments                            
         JNE   OLDCLM32            No - get next element                        
         LLC   RF,CLDLN                                                         
         SHI   RF,L'CLDLN+L'CLDEL+L'CLDTYPE+1                                   
         BASR  R1,0                                                             
         MVC   HD_CCMT(0),CLDCCMT                                               
         EX    RF,0(R1)                                                         
         AHI   RF,1                                                             
         STC   RF,HD_CCMTL                                                      
         J     OLDCLM06                                                         
                                                                                
OLDCLM32 CLI   CLDTYPE,CLDLMAPQ    Line manager approval element                
         JNE   OLDCLM36            No - get next element                        
         LA    RE,CLDLNTRY                                                      
         XR    RF,RF                                                            
         ICM   RF,1,CLDLNUM                                                     
         JZ    OLDCLM36                                                         
         STC   RF,HD_OLMPN                                                      
         LA    R6,HD_OLMAP                                                      
OLM      USING HD_OLMAP,R6                                                      
         LA    R1,HD_LMAP                                                       
LM       USING HD_LMAP,R1                                                       
OLDCLM34 OC    1(L'CIDAPID,RE),1(RE) Is a PID present?                          
         JZ    OLDCLM06             No - then no further entries to get         
         MVC   OLM.HD_OLMPD,1(RE)   Set PID                                     
         MVC   OLM.HD_OLMST,0(RE)   Set status                                  
         MVC   OLM.HD_OLMLV,3(RE)   Set level                                   
         MVC   OLM.HD_OLMVL,4(RE)   Set value                                   
         MVC   LM.HD_LMSTA,0(RE)    Set status                                  
         LA    R1,HD_LMAPL(R1)                                                  
         LA    R6,HD_OLMAL(R6)                                                  
         LA    RE,CLDLLNQ(RE)       Bump approver entry on CLDEL                
         JCT   RF,OLDCLM34                                                      
         J     OLDCLM06                                                         
         DROP  LM,OLM                                                           
                                                                                
OLDCLM36 CLI   CLDTYPE,CLDFNAPQ    Line manager approval element                
         JNE   OLDCLM39            No - get next element                        
         LA    RE,CLDFNTRY                                                      
         LLC   RF,CLDFNUM                                                       
         LA    R1,HD_FNAP                                                       
FN       USING HD_LMAP,R1                                                       
OLDCLM38 OC    1(L'CIDAPID,RE),1(RE) Is a PID present?                          
         JZ    OLDCLM06             No - then no further entries to get         
         MVC   FN.HD_FNSTA,0(RE)    Set status of approver                      
         LA    R1,HD_FNAPL(R1)                                                  
         LA    RE,CLDFLNQ(RE)       Bump approver entry on CLDEL                
         JCT   RF,OLDCLM38                                                      
         J     OLDCLM06                                                         
         DROP  FN                                                               
                                                                                
OLDCLM39 CLI   CLDTYPE,CLDSUBQ     Submitted date element                       
         JNE   OLDCLM06            No - get next element                        
         MVC   HD_SUBP,CLDSPID                                                  
         MVC   HD_SUBD,CLDSDAT                                                  
         J     OLDCLM06                                                         
         DROP  R4                                                               
                                                                                
OLDCLM40 S     R2,AIO2                                                          
         STCM  R2,3,CL_ECLST       Set disp. to end of claim cluster            
         MVC   CL_DA,IODA          Set disk address of record                   
         GOTOR BUFCLM,DMCB,('TSAADD',OLDBUF),0                                  
         JE    OLDCLM06                                                         
         DC    H'0'                                                             
         DROP  R2                                                               
                                                                                
OLDCLM42 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         CLC   K.EXNPAS(EXNPSEQ-EXNPAS),IOKEYSAV                                
         JE    OLDCLM02                                                         
         CLI   RUNMODE,RVALREQQ    Test 'Validate request' mode                 
         JNE   EXITY               No                                           
         MVC   TEMP2(L'SA0KNUM),HD_OPID                                         
         GOTOR (#GETPID,AGETPID)                                                
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   EXITY                                                            
         MVC   HD_EMLRS,APPEMAIL                                                
         J     EXITY                                                            
         DROP  K,RC                                                             
                                                                                
                                                                                
OTWORKD  DSECT                     ** OLDTIM local w/s **                       
OTRBAREA DS    XL(OB_LNQ)                                                       
OTWORKL  EQU   *-OTWORKD                                                        
SVRDEF   CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* Add entry to approver table for sending emails                      *         
***********************************************************************         
                                                                                
ADDAPP   ICM   RF,15,AAPPTN        AAPPTN will be zero if off-line              
         BZR   RE                                                               
         ST    RE,SAVERE                                                        
         LHI   R3,1                                                             
         TM    CL_STAT-CL_BDATA(R1),CIDMSID                                     
         BNZR  RE                  Ignore deleted item lines                    
         LA    R1,CL_APSTA-CL_BDATA(R1)                                         
*                                                                               
ADDAPP02 OC    L'CL_APSTA(L'APPRPID,R1),L'CL_APSTA(R1)                          
         JNZ   *+10                                                             
         L     RE,SAVERE                                                        
         BR    RE                  end of approvers to add                      
         XC    ELEMENT,ELEMENT                                                  
         USING APPTABD,RF                                                       
         LA    RF,ELEMENT          build new table entry here                   
         STC   R3,APPRTYP                                                       
         MVC   APPRPID,L'CL_APSTA(R1)                                           
         MVC   APPRULA,ANYACCNT                                                 
         MVC   APPRTOKN,QH_TOKEN                                                
         MVC   APPROFFC,CS_SJOFF   SJ office                                    
         MVC   APPRCLNM,CS_CLNAM   Client name                                  
         MVC   APPROFNM,CS_OFNAM   SJ office name                               
         MVC   APPRAST,0(R1)       Approval status                              
         LHI   R2,APPCLNQ                                                       
         CLC   PRODUL,ANYACCNT     Test production ledger                       
         JNE   ADDAPP04                                                         
         CLC   CS_PRNAM,SPACES                                                  
         JE    ADDAPP04                                                         
         MVC   APPRPRNM,CS_PRNAM   Set product name if present                  
         LHI   R2,APPPLNQ                                                       
         CLC   CS_JBNAM,SPACES                                                  
         JE    ADDAPP04                                                         
         MVC   APPRJBNM,CS_JBNAM   Set job name if present                      
         MVC   APPRMDNM,CS_MDNAM   Set media name                               
         MVC   APPRMED,CS_MED                                                   
         LHI   R2,APPJLNQ                                                       
ADDAPP04 STC   R2,APPRLN           Set length of this entry                     
                                                                                
TAB      USING APPTABD,RE                                                       
         ICM   RE,15,AAPPTAB       Look for same entry already in table         
         XR    R0,R0                                                            
ADDAPP06 CLI   TAB.APPRLN,0                                                     
         JE    ADDAPP10            EOT, add the new one                         
         CLC   TAB.APPRLN(L'APPRLN+L'APPRTYP+L'APPRPID),APPRLN                  
         JNE   ADDAPP08                                                         
         CLC   TAB.APPRULA,APPRULA                                              
         JE    ADDAPP12            existing entry, don't add again              
ADDAPP08 IC    R0,TAB.APPRLN                                                    
         AR    RE,R0                                                            
         J     ADDAPP06                                                         
         DROP  RF                                                               
*                                  RE=A(next free APPTAB slot)                  
ADDAPP10 AHI   R2,-1                                                            
         BASR  RF,0                                                             
         MVC   TAB.APPRLN(0),ELEMENT  Add new entry to table                    
         EX    R2,0(RF)                                                         
         LA    RE,1(R2,RE)                                                      
         ST    RE,AAPPTN           Set address of next free entry               
         MVI   0(RE),0             Set new EOT                                  
ADDAPP12 LA    R1,CL_APL(R1)                                                    
         AHI   R3,1                                                             
         J     ADDAPP02                                                         
         DROP  TAB                                                              
                                                                                
***********************************************************************         
* Check to see if approver for this adjustment has approved before    *         
***********************************************************************         
                                                                                
CHKAPP   L     RF,ACOBLOCK                                                      
                                                                                
CHKAP02  OC    0(L'CIDAPID,RF),0(RF)                                            
         JNZ   *+8                                                              
         LTR   RE,RE               End of list - set CC not equal               
         BR    RE                                                               
         CLC   0(L'CIDAPID,RF),NEW.CL_APPID                                     
         BER   RE                                                               
         AHI   RF,L'CIDAPID                                                     
         J     CHKAP02                                                          
         EJECT                                                                  
***********************************************************************         
* Check to see claim is correct and update approver table             *         
***********************************************************************         
                                                                                
CHKCLD   NTR1  LABEL=NO,WORK=(RC,CTWORKL)                                       
         J     *+12                                                             
         DC    C'*CHKCLD*'                                                      
                                                                                
         USING CTWORKD,RC                                                       
         LR    R7,R1               R7=A(current buffer)                         
         GOTOR CLRWRK,CTWORKL      Clear work area                              
         MVC   CS_SJOFF,SPACES                                                  
         MVC   CS_OFNAM,SPACES                                                  
         MVC   CS_CLNAM,SPACES                                                  
         MVC   CS_PRNAM,SPACES                                                  
         MVC   CS_JBNAM,SPACES                                                  
         MVC   CS_VATC,SPACES                                                   
         MVC   CS_VATAC,SPACES                                                  
*&&US                                                                           
         MVC   CS_PROV,SPACES                                                   
         MVC   CS_PSTC,SPACES                                                   
         MVC   CS_PSTAC,SPACES                                                  
*&&                                                                             
         MVC   CS_MDNAM,SPACES                                                  
         MVC   CS_MED,SPACES                                                    
         MVC   CS_DEXAC,SPACES     Clear Expense account                        
         XC    CS_1CULA,CS_1CULA                                                
         XC    CS_DSULA,CS_DSULA                                                
         MVC   ANYACCNT,SPACES                                                  
         MVC   ANYACCD,CL_SJAC                                                  
         MVC   ANYACUN(L'ACTKUNT+L'ACTKLDG),PRODUL                              
         MVC   CS_ITYPE,CL_ITYPE   Set claim type                               
         GOTOR VALETY,CL_ETYP      Validate expenditure type                    
         JE    CHKCLD02                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'CL_ETYP,CL_ETYP),CL_ITEM#                 
                                                                                
CHKCLD02 CP    CL_NET,PZERO        Test if net set                              
         JNE   CHKCLD03                                                         
         CP    CL_FAMT,PZERO       No - so set net amount and vat codes         
         JE    *+14                                                             
         ZAP   CL_NET,CL_FAMT                                                   
         J     *+10                                                             
         ZAP   CL_NET,CL_AMT                                                    
                                                                                
CHKCLD03 CLC   CL_SJAC,SPACES      Test client given                            
         JNH   CHKCLD06                                                         
         MVC   ANYACCD,CL_SJAC                                                  
         MVC   ANYACCNT(L'ACTKUNT+L'ACTKLDG),PRODUL                             
         GOTOR VALJOB,ANYACCNT                                                  
         JE    CHKCLD04                                                         
         OI    CS_IND1,CS_IERR     Set found error                              
         GOTOR SAVERR,DMCB,ROUERRV,(L'ANYACCNT,ANYACCNT),CL_ITEM#               
                                                                                
CHKCLD04 MVC   CL_CLINM,CS_CLNAM                                                
         MVC   CS_ULA,ANYACCNT     Set SJ account code                          
         TM    CPYSTAT1,CPYSOROE   Is agency on offices                         
         JNZ   *+10                                                             
         MVC   CS_SJOFF,SPACES                                                  
                                                                                
         GOTOR VALWCD,CL_WC        Validate work code                           
         JE    CHKCLD06                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'CL_WC,CL_WC),CL_ITEM#                     
                                                                                
CHKCLD06 GOTOR DATCHK,CL_ADAT                                                   
         JE    CHKCLD08                                                         
         GOTOR SAVERR,DMCB,ROUERRV,0,CL_ITEM#                                   
                                                                                
CHKCLD08 GOTOR VALOFF,CL_OFF                                                    
         JE    CHKCLD10                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'CL_OFF,CL_OFF),CL_ITEM#                   
                                                                                
CHKCLD10 MVC   CS_SUPAC,CL_SUPAC                                                
         CLC   CL_SUPAC,SPACES                                                  
         JH    *+10                                                             
         MVC   CS_SUPAC,HD_SUPAC                                                
         GOTOR VALSUP,CS_SUPAC                                                  
         JE    CHKCLD12                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'ACTKULA,CS_SUPAC),CL_ITEM#                
                                                                                
CHKCLD12 MVC   CS_EXULA,SPACES                                                  
         MVC   CS_EXULA,CS_DEXAC                                                
         CLC   CL_EXAC,SPACES                                                   
         JNH   *+10                                                             
         MVC   CS_EXULA,CL_EXAC                                                 
                                                                                
CHKCLD14 CLI   QH_STAT,QH_REJQ     If rejecting skip everything                 
         JE    CHKCLD32                                                         
         GOTOR VALEXP,DMCB,CS_EXULA,CL_2DAC,CL_MILE                             
         JE    CHKCLD16                                                         
         JL    CHKCLD15                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'ACTKULA,CS_EXULA),CL_ITEM#                
         J     CHKCLD16                                                         
CHKCLD15 GOTOR SAVERR,DMCB,ROUERRV,(L'ACTKULA,CS_13ULA),CL_ITEM#                
                                                                                
CHKCLD16 GOTOR VALMIL,CL_MILE      validate miles                               
         JE    CHKCLD18                                                         
         GOTOR SAVERR,DMCB,ROUERRV,0,CL_ITEM#                                   
                                                                                
CHKCLD18 GOTOR VAL2PA,CL_2PAC                                                   
         JE    CHKCLD20                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'CL_2PAC,CS_2PAC),CL_ITEM#                 
                                                                                
CHKCLD20 GOTOR VAL2DA,CL_2DAC                                                   
         JE    CHKCLD22                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'CS_2DULA,CS_2DULA),CL_ITEM#               
                                                                                
CHKCLD22 DS    0H                                                               
*&&UK*&& TM    CPYSTAT5,CPYSNVAT                                                
*&&UK*&& JZ    CHKCLD24                                                         
*&&UK*&& GOTOR VALVAT,CL_VATC                                                   
*&&US*&& GOTOR VALGPT,DMCB,CL_PROV,CL_VATC,CL_PSTC                              
         JE    CHKCLD26                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'CS_VATC,CS_VATC),CL_ITEM#                 
         J     CHKCLD26                                                         
*&&UK                                                                           
CHKCLD24 GOTOR VALVAT,CL_VATAC+L'ACTKUNT+L'ACTKLDG                              
         JE    CHKCLD26                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'CS_VATAC,CS_VATAC),CL_ITEM#               
*&&                                                                             
CHKCLD26 GOTOR VALDSC,CL_DSCRT                                                  
                                                                                
*        CLI   HD_USRFN,YESQ       Finance user?                                
*        JE    CHKCLD28            Yes                                          
*&&UK                                                                           
         MVC   CL_INT,SPACES       No - internal ref is always claim no         
         MVC   CL_INT(L'HD_CLM#),HD_CLM#  Use claim number                      
                                                                                
         TM    CPXSTAT8,CPXCLNTR   Is this agency set to use claim              
         JZ    CHKCLD28                   number as transaction ref             
*&&                                                                             
                                                                                
*        CLC   QH_NUM,HD_CLM#      Have we gone from in progress                
*        JE    CHKCLD28                          to submitted                   
* for Aura always make reference match claim number                             
         MVC   CL_REF,HD_CLM#      Yes - get new claim number                   
                                                                                
                                                                                
CHKCLD28 CLI   CS_ITYPE,CS_IADVQ   For advances don't buffer accounts           
         JE    CHKCLD32                                                         
         MVC   CL_SUPAC,CS_SUPAC                                                
         MVC   CL_SUNAM,CS_SUNAM                                                
         MVC   CL_2DAC,CS_2DAC                                                  
         MVC   CL_2DNAM,CS_2DNAM                                                
         MVC   CL_2PAC,CS_2PAC                                                  
         MVC   CL_2PNAM,CS_2PNAM                                                
*&&US*&& CLI   CS_EXPJB,YESQ       If Job is an expense job                     
*&&US*&& JE    CHKCLD29            then treat it as non-billable                
         CP    CS_MILES,PZERO      If miles and billable may have staff         
         JNE   CHKCLD29                                   analysis              
         CLI   CS_ITYPE,CS_INONQ   Only interested for non billable             
         JNE   CHKCLD30                                                         
CHKCLD29 MVC   CL_EXAC,CS_EXULA                                                 
*&&US*&& MVC   CL_EXPJB,CS_EXPJB                                                
         MVC   CL_EXNAM,CS_EXNAM                                                
         MVC   CL_ESTA1,CS_ESTA1                                                
         MVC   CL_ECSTG,CS_COSTG                                                
         MVC   CL_1CULA,CS_1CULA                                                
CHKCLD30 GOTOR VALACS              Validate other accounts for posting          
         JE    CHKCLD32                                                         
         GOTOR SAVERR,DMCB,ROUERRV,(L'CS_ACCER,CS_ACCER),CL_ITEM#               
                                                                                
CHKCLD32 GOTOR ADDAPP,CL_BDATA                                                  
         J     EXITY                                                            
         DROP  RC                                                               
                                                                                
CTWORKD  DSECT                     ** CHKCLD local w/s **                       
CTRBAREA DS    XL(OB_LNQ)                                                       
CTWORKL  EQU   *-CTWORKD                                                        
SVRDEF   CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* Establish approver and back-up approver PID for claim item          *         
* on NTRY P1 byte 1 = A (approver block)                              *         
***********************************************************************         
                                                                                
GETCAP   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GETCAP*'                                                      
                                                                                
         L     R7,0(R1)                                                         
*                                                                               
         LA    R6,CL_AP                                                         
         LHI   R0,CL_MAXA                                                       
*                                                                               
A        USING CL_AP,R6                                                         
GETCAP00 XC    A.CL_APPID,A.CL_APPID   Clear out PIDs but not statuses          
         XC    A.CL_APBUP,A.CL_APBUP                                            
         AHI   R6,CL_APL                                                        
         JCT   R0,GETCAP00                                                      
         DROP  A                                                                
*                                                                               
         CLC   CL_SJAC,SPACES      Do we have a production account              
         JH    *+16                No                                           
         TM    CPXSTAT6,CPX2LAEI                                                
         JZ    EXITY                                                            
         J     GETCAP42                                                         
         CLI   HD_COBCA,YESQ       Are we by passing client approvals           
         JE    EXITY               Yes                                          
         CLI   CL_ITYPE,CS_INONQ   For non billable check whether               
         JNE   GETCAP02                    etype requires approval              
         TM    CS_ETST2,ETYSAPND                                                
         JZ    EXITY               No approval required                         
         TM    CPXSTAT6,CPX2LAEI                                                
         JNZ   GETCAP02            2nd lvl req'd, skip threshold                
         CP    CL_AMT,HD_COTNB     Is item above threshold for approver         
         JL    EXITY               No - no approval required                    
                                                                                
GETCAP02 LA    R6,CL_AP                                                         
         LA    R5,JOBTYPE                                                       
         USING JOBTYPD,R5                                                       
GETCAP04 LA    R2,APRTAB                                                        
         USING APRTABD,R2                                                       
SJ       USING JOBPASD,IOKEY       Find job, product or client approver         
GETCAP06 XC    SJ.JOBPAS,SJ.JOBPAS                                              
         MVI   SJ.JOBPTYP,JOBPTYPQ                                              
         MVI   SJ.JOBPSUB,JOBPSUBQ                                              
         MVC   SJ.JOBPCPY,CUXCPY                                                
         MVI   SJ.JOBPVIEW,JOBPVOFF                                             
         MVC   SJ.JOBPAPPL,JOBBILL                                              
         CLI   CL_ITYPE,CS_INONQ   Is item billable or non-billable             
         JNE   *+10                Billable                                     
         MVC   SJ.JOBPAPPL,JOBNONB Non-Billable                                 
         TM    CPXSTAT6,CPX2LAEI                                                
         JNZ   *+8                                                              
         MVI   SJ.JOBPAPPL,JOBPAEXP                                             
         MVC   SJ.JOBPCPJ,SPACES                                                
         MVC   SJ.JOBPCOFF,SPACES                                               
         MVC   SJ.JOBPCMED,SPACES                                               
         TM    APRSTAT,APRJOB      Are we looking at job level                  
         JZ    GETCAP08                                                         
         LLC   RF,PPROLEN                                                       
         LA    RF,CL_SJAC(RF)                                                   
         CLI   0(RF),X'40'         Have we got a job                            
         JNH   GETCAP18            No                                           
         LLC   RF,PJOBLEN                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   SJ.JOBPCPJ(0),CL_SJAC                                            
         EX    RF,0(RE)                                                         
         J     GETCAP12                                                         
GETCAP08 TM    APRSTAT,APRPRO                                                   
         JZ    GETCAP10                                                         
         LLC   RF,PCLILEN                                                       
         LA    RF,CL_SJAC(RF)                                                   
         CLI   0(RF),X'40'         Have we got a product                        
         JNH   GETCAP18            No                                           
         LLC   RF,PPROLEN                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   SJ.JOBPCPJ(0),CL_SJAC                                            
         EX    RF,0(RE)                                                         
         J     GETCAP12                                                         
GETCAP10 TM    APRSTAT,APRCLI                                                   
         JZ    GETCAP12                                                         
         LLC   RF,PCLILEN                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   SJ.JOBPCPJ(0),CL_SJAC                                            
         EX    RF,0(RE)                                                         
GETCAP12 TM    APRSTAT,APRMED                                                   
         JZ    GETCAP14                                                         
         CLC   CL_MED,SPACES                                                    
         JNH   GETCAP18                                                         
         MVC   SJ.JOBPCMED,CL_MED                                               
                                                                                
GETCAP14 TM    APRSTAT,APROFF                                                   
         JZ    GETCAP16                                                         
         OC    CL_SJOFF,CL_SJOFF                                                
         JZ    GETCAP18                                                         
         MVC   SJ.JOBPCOFF,CL_SJOFF                                             
                                                                                
                                                                                
GETCAP16 GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         CLC   SJ.JOBPAS(JOBPPIDB-JOBPASD),IOKEYSAV                             
         JE    GETCAP20                                                         
GETCAP18 LA    R2,APRTABL(R2)                                                   
         CLI   0(R2),X'FF'                                                      
         JNE   GETCAP06                                                         
         TM    CPXSTAT6,CPX2LAEI   WPP workflow                                 
         JZ    GETCAP40            No                                           
         CLI   CL_ITYPE,CS_IBILQ   For billable error as we should              
         JNE   GETCAP40            always have a client level approver          
         J     GETCAPN                                                          
*                                                                               
GETCAP20 TM    CPXSTAT6,CPX2LAEI   New expense workflow                         
         JZ    GETCAP22            No                                           
         CLC   HD_PPID#,SJ.JOBPPIDB                                             
         JE    GETCAP40                                                         
                                                                                
GETCAP22 MVC   L'CL_APSTA(L'CL_APPID,R6),SJ.JOBPPIDB                            
         DROP  SJ                                                               
PP       USING APPRECD,IOKEY                                                    
GETCAP24 XC    PP.APPKEY,PP.APPKEY                                              
         MVI   PP.APPKTYP,APPKTYPQ                                              
         MVI   PP.APPKSUB,APPKSUBQ                                              
         MVC   PP.APPKCPY,CUXCPY                                                
         MVC   PP.APPKPIDB,L'CL_APSTA(R6)                                       
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         J     GETCAP28                                                         
                                                                                
GETCAP26 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'                               
GETCAP28 CLC   PP.APPKEY(APPKSEQ-APPRECD),IOKEYSAV                              
         JNE   GETCAP40                                                         
         DROP  PP                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R1,IOADDR                                                        
         AHI   R1,ACCRFST-ACCRECD                                               
         SR    R0,R0                                                            
         USING LIDELD,R1                                                        
GETCAP30 CLI   LIDEL,0             Test end of record                           
         JE    GETCAP26                                                         
         CLI   LIDEL,LIDELQ        Test end of record                           
         JE    GETCAP34                                                         
GETCAP32 IC    R0,LIDLN                                                         
         AR    R1,R0                                                            
         J     GETCAP30                                                         
                                                                                
GETCAP34 CLI   LIDTYPE,LIDTBACK                                                 
         JNE   GETCAP32                                                         
         LA    R4,LIDDATA                                                       
         USING LIDDATA,R4                                                       
         LLC   R3,LIDLN                                                         
         AR    R3,R1               R3=End of element                            
         LA    RF,L'CL_APSTA+L'CL_APPID(R6)                                     
         XR    RE,RE                                                            
GETCAP36 TM    LIDLAPPL,LIDLEXPN   Is this entry for expenses                   
         JZ    GETCAP38            No                                           
         MVC   0(L'PIDNO,RF),LIDLPID  Yes - Get back up approver PID            
         LA    RF,L'PIDNO(RF)                                                   
         AHI   RE,1                                                             
                                                                                
GETCAP38 CHI   RE,HD_BAMAX         Did we fill up the whole table?              
         JE    GETCAP40                                                         
         LLC   R0,LIDITLN          Increment R4 to look at next entry           
         AR    R4,R0                                                            
         CR    R3,R4               Check we haven't reached end of el           
         JH    GETCAP36            No - check next entry                        
                                                                                
GETCAP40 TM    CPXSTAT6,CPX2LAEI                                                
         JZ    EXITY                                                            
         LA    R6,CL_APL(R6)                                                    
         LA    R5,JOBTYPLQ(R5)                                                  
         CLI   0(R5),X'FF'                                                      
         JNE   GETCAP04                                                         
GETCAP42 LA    R6,CL_AP                                                         
         LA    R5,HD_LMAP                                                       
K        USING HD_LMAP,R5                                                       
         CLI   CL_ITYPE,CS_INONQ   Is item billable or non-billable             
         JE    GETCAP44            Non-billable                                 
         LA    R5,2*HD_LMAPL(R5)                                                
                                                                                
GETCAP44 LHI   R0,CL_MAXA                                                       
GETCAP46 OC    L'CL_APSTA(L'CL_APPID,R6),L'CL_APSTA(R6)                         
         JNZ   GETCAP48                                                         
         MVC   L'CL_APSTA(CL_APL-1,R6),K.HD_LMPID                               
         OI    0(R6),CIDA1RL                                                    
GETCAP48 LA    R6,CL_APL(R6)                                                    
         LA    R5,HD_LMAPL(R5)                                                  
         JCT   R0,GETCAP46                                                      
         J     EXITY                                                            
         DROP  K,R2,R4,R5                                                       
                                                                                
GETCAPN  MVC   ROUERRV,=AL2(AE$CLAPX)                                           
         J     EXITN                                                            
         EJECT                                                                  
***********************************************************************         
* Get approver and back-up approver PID for expense claim             *         
***********************************************************************         
         USING LP_D,R5                                                          
GETMAP   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GETMAP*'                                                      
                                                                                
         LR    R2,R1                                                            
P        USING ACTKACT,R2                                                       
         USING COBLOCKD,R4                                                      
                                                                                
         LA    R6,HD_LMAP                                                       
         L     R4,ACOBLOCK                                                      
         USING HD_LMAP,R6                                                       
         ZAP   HD_LMVAL,PZERO                                                   
         ZAP   HD_OWNVL,PZERO      Initialise own approval value                
         CLI   COCAE,YESQ          Is the user choosing their own               
         JNE   GETMAP08            Approvers?                                   
         TM    HD_IND,HD_INOPR     No previous claim record found               
         JNZ   GETMAP02            then approvers should be present             
         TM    HD_ST2FR,EXCKCLAQ   Does existing claim follow new or            
         JZ    GETMAP08            old workflow                                 
         USING LW_D,R2                                                          
GETMAP02 XR    R2,R2                                                            
         ICM   R2,7,QH_AAPPR                                                    
         XR    R3,R3                                                            
         ICM   R3,3,LW_NUMN        Number of approver entries                   
         LTR   R3,R3                                                            
         JNZ   GETMAP04            Must be passed some approvers!               
         CLI   QH_STAT,QH_SAVEQ                                                 
         JE    EXITY                                                            
         CLI   QH_STAT,QH_DELQ                                                  
         JE    EXITY                                                            
         J     GETMAPN3                                                         
GETMAP04 STCM  R3,1,HD_LMAPN                                                    
         LA    R2,LW_LN2Q(,R2)     Bump over header                             
*                                                                               
GETMAP06 MVC   HD_LMLVL,0(R2)                                                   
         ZAP   HD_LMVAL,1(L'APPPVAL,R2)                                         
         XC    HD_LMSTA,HD_LMSTA                                                
         MVC   TEMP2(L'PERKCODE),L'APPPVAL+1(R2)                                
         OC    TEMP2,SPACES                                                     
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   GETMAPN4            Pid invalid!                                 
         MVC   HD_LMPID,TEMP2+50                                                
         CLI   1+L'PERKCODE+L'APPPVAL(R2),1  Approved?                          
         JNE   *+8                                                              
         OI    HD_LMSTA,CIDAAPP+HD_THIST                                        
         CLI   1+L'PERKCODE+L'APPPVAL(R2),3  Rejected?                          
         JNE   *+8                                                              
         OI    HD_LMSTA,CIDAREJ+HD_THIST                                        
         AHI   R2,1+L'APPPVAL+L'PERKCODE+L'APPKSTAT                             
         LA    R6,HD_LMAPL(R6)                                                  
         JCT   R3,GETMAP06                                                      
         J     EXITY                                                            
*                                                                               
OWN      USING APPRECD,IOKEY                                                    
GETMAP08 TM    CPXSTAT6,CPX2LAEI   WPP workflow                                 
         JNZ   GETMAP64            Yes                                          
         XC    OWN.APPKEY,OWN.APPKEY                                            
         MVI   OWN.APPKTYP,DPAPTYPQ                                             
         MVI   OWN.APPKSUB,DPAPSUBQ                                             
         MVC   OWN.APPKCPY,CUXCPY                                               
         MVC   OWN.APPKPIDB,HD_PPID#                                            
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         JE    GETMAP12                                                         
         DC    H'0'                                                             
GETMAP10 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'                               
         JE    GETMAP12                                                         
         DC    H'0'                                                             
GETMAP12 CLC   OWN.APPKEY(APPKSEQ-APPRECD),IOKEYSAV                             
         JNE   GETMAP24                                                         
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R1,IOADDR                                                        
         AHI   R1,ACCRFST-ACCRECD                                               
         SR    R0,R0                                                            
         USING LIDELD,R1                                                        
GETMAP14 CLI   LIDEL,0             Test end of record                           
         JE    GETMAP10                                                         
         CLI   LIDEL,LIDELQ        Test end of record                           
         JE    GETMAP18                                                         
GETMAP16 IC    R0,LIDLN                                                         
         AR    R1,R0                                                            
         J     GETMAP14                                                         
                                                                                
GETMAP18 CLI   LIDTYPE,LIDT1RAC                                                 
         JNE   GETMAP16                                                         
         LA    R4,LIDDATA                                                       
         USING LIDDATA,R4                                                       
         LLC   R3,LIDLN                                                         
         AR    R3,R1               R3=End of element                            
                                                                                
GETMAP20 TM    LIDAPDTY,LIDAPDEX   Is this entry for expenses                   
         JZ    GETMAP22            No                                           
         CP    LIDAPEXV,HD_OWNVL                                                
         JNH   GETMAP22                                                         
         ZAP   HD_OWNVL,LIDAPEXV   Extract highest value I approve              
                                                                                
GETMAP22 LLC   R0,LIDITLN          Increment R4 to look at next entry           
         AR    R4,R0                                                            
         CR    R3,R4               Check we haven't reached end of el           
         JH    GETMAP20            No - check next entry                        
         J     GETMAP16            Yes - look for other elements                
         DROP  R4                                                               
                                                                                
MN       USING DPAPASD,IOKEY                                                    
GETMAP24 XC    MN.DPAPAS,MN.DPAPAS Work out levels of approval                  
         MVI   MN.DPAPTYP,DPAPTYPQ                                              
         MVI   MN.DPAPSUB,DPAPSUBQ                                              
         MVI   MN.DPAPAPPL,DPAPAEXP                                             
         MVC   MN.DPAPCPY,CUXCPY                                                
         ZAP   MN.DPAPXVAL,HD_LMVAL                                             
         MVC   CSVKEY2,MN.DPAPASD                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         JE    GETMAP26                                                         
         DC    H'0'                                                             
                                                                                
GETMAP26 CLC   MN.DPAPAS(DPAPXVAL-DPAPASD),IOKEYSAV                             
         JNE   GETMAP34                                                         
         ZAP   HD_LMVAL,MN.DPAPXVAL                                             
         CP    MN.DPAPXVAL,HD_OWNVL   Approval value lower than own             
         JNL   GETMAP28               No                                        
         OI    HD_LMSTA,CIDAANR       Set approval not required                 
                                                                                
GETMAP28 CP    QH_TOTAL,HD_OWNVL      Claim higher than own                     
         JH    GETMAP30               Yes                                       
         CP    MN.DPAPXVAL,HD_OWNVL   Approval value lower than own             
         JH    GETMAP36               No                                        
         J     GETMAP32                                                         
                                                                                
GETMAP30 CP    MN.DPAPXVAL,QH_TOTAL   Approver higher than claim                
         JH    GETMAP36                                                         
GETMAP32 AP    MN.DPAPXVAL,=P'1'                                                
         LA    R6,HD_LMAPL(R6)                                                  
         LLC   RF,HD_LMAPN                                                      
         AHI   RF,1                                                             
         STC   RF,HD_LMAPN                                                      
*        MVI   HD_LMLVL,1                                                       
         ZAP   HD_LMVAL,MN.DPAPXVAL                                             
         J     GETMAP24                                                         
                                                                                
GETMAP34 XC    HD_LMAP(HD_LMAPL),HD_LMAP                                        
         ZAP   HD_LMVAL,PZERO                                                   
         DROP  R6                                                               
                                                                                
GETMAP36 LA    R6,HD_LMAP                                                       
         USING HD_LMAP,R6                                                       
MN       USING DPAPASD,IOKEY                                                    
GETMAP38 XC    MN.DPAPAS,MN.DPAPAS                                              
         MVI   MN.DPAPTYP,DPAPTYPQ                                              
         MVI   MN.DPAPSUB,DPAPSUBQ                                              
         MVI   MN.DPAPAPPL,DPAPAEXP                                             
         MVC   MN.DPAPCPY,CUXCPY                                                
         ZAP   MN.DPAPXVAL,HD_LMVAL                                             
         LA    R3,ONERL4L          R3=A(Person length)                          
         LHI   R0,4                R0=Number of levels to search                
                                                                                
GETMAP40 MVC   MN.DPAP1RAC,SPACES                                               
         LLC   RF,0(R3)                                                         
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   MN.DPAP1RAC(0),P.ACTKACT                                         
         EX    RF,0(RE)                                                         
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         JE    GETMAP42                                                         
         DC    H'0'                                                             
                                                                                
GETMAP42 CLC   MN.DPAPAS(DPAPPIDB-DPAPASD),IOKEYSAV                             
         JNE   GETMAP44                                                         
                                                                                
         MVC   HD_LMPID,MN.DPAPPIDB                                             
         J     GETMAP46                                                         
                                                                                
GETMAP44 MVC   MN.DPAPAS,IOKEYSAV  Reset key                                    
         SHI   R3,L'ONERL4L        Point to previous key length                 
         JCT   R0,GETMAP40         Do for number of 1R levels                   
         MVC   MN.DPAP1RAC,SPACES                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         CLC   MN.DPAPAS(DPAPPIDB-DPAPASD),IOKEYSAV                             
         JNE   GETMAPN1                                                         
         MVC   HD_LMPID,MN.DPAPPIDB                                             
         DROP  MN                                                               
                                                                                
PP       USING APPRECD,IOKEY                                                    
GETMAP46 XC    PP.APPKEY,PP.APPKEY                                              
         MVI   PP.APPKTYP,APPKTYPQ                                              
         MVI   PP.APPKSUB,APPKSUBQ                                              
         MVC   PP.APPKCPY,CUXCPY                                                
         MVC   PP.APPKPIDB,HD_LMPID                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         J     GETMAP50                                                         
                                                                                
GETMAP48 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'                               
GETMAP50 CLC   PP.APPKEY(APPKSEQ-APPRECD),IOKEYSAV                              
         JNE   GETMAP62                                                         
         DROP  PP                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R1,IOADDR                                                        
         AHI   R1,ACCRFST-ACCRECD                                               
         SR    R0,R0                                                            
         USING LIDELD,R1                                                        
GETMAP52 CLI   LIDEL,0             Test end of record                           
         JE    GETMAP48                                                         
         CLI   LIDEL,LIDELQ        Test end of record                           
         JE    GETMAP56                                                         
GETMAP54 IC    R0,LIDLN                                                         
         AR    R1,R0                                                            
         J     GETMAP52                                                         
                                                                                
GETMAP56 CLI   LIDTYPE,LIDTBACK                                                 
         JNE   GETMAP54                                                         
         LA    R4,LIDDATA                                                       
         USING LIDDATA,R4                                                       
         LLC   R3,LIDLN                                                         
         AR    R3,R1               R3=End of element                            
         LA    RF,HD_LMBUP                                                      
         XR    RE,RE                                                            
GETMAP58 TM    LIDLAPPL,LIDLEXPN   Is this entry for expenses                   
         JZ    GETMAP60            No                                           
         MVC   0(L'PIDNO,RF),LIDLPID  Yes - Get back up approver PID            
         LA    RF,L'PIDNO(RF)                                                   
         AHI   RE,1                                                             
                                                                                
GETMAP60 CHI   RE,HD_BAMAX         Did we fill up the whole table?              
         JE    GETMAP62                                                         
         LLC   R0,LIDITLN          Increment R4 to look at next entry           
         AR    R4,R0                                                            
         CR    R3,R4               Check we haven't reached end of el           
         JH    GETMAP58            No - check next entry                        
                                                                                
*ETMAP62 MVI   HD_LMLVL,1                                                       
GETMAP62 LA    R6,HD_LMAPL(R6)                                                  
         OC    HD_LMVAL,HD_LMVAL                                                
         JNZ   GETMAP38                                                         
         J     EXITY                                                            
         DROP  R4                                                               
                                                                                
GETMAP64 LA    R6,HD_LMAP                                                       
         LA    R5,EXPTYPE                                                       
MN       USING DPAPASD,IOKEY                                                    
GETMAP66 XC    MN.DPAPAS,MN.DPAPAS                                              
         MVI   MN.DPAPTYP,DPAPTYPQ                                              
         MVI   MN.DPAPSUB,DPAPSUBQ                                              
         MVC   MN.DPAPAPPL,0(R5)                                                
         MVC   MN.DPAPCPY,CUXCPY                                                
         ZAP   MN.DPAPXVAL,PZERO                                                
         ZAP   HD_LMVAL,PZERO                                                   
         LA    R3,ONERL4L          R3=A(Person length)                          
         LHI   R0,4                R0=Number of levels to search                
                                                                                
GETMAP68 MVC   MN.DPAP1RAC,SPACES                                               
         LLC   RF,0(R3)                                                         
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   MN.DPAP1RAC(0),P.ACTKACT                                         
         EX    RF,0(RE)                                                         
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         JE    GETMAP70                                                         
         DC    H'0'                                                             
                                                                                
GETMAP70 CLC   MN.DPAPAS(DPAPPIDB-DPAPASD),IOKEYSAV                             
         JNE   GETMAP72                                                         
                                                                                
         LLC   RF,HD_LMAPN                                                      
         AHI   RF,1                                                             
         STC   RF,HD_LMAPN                                                      
                                                                                
         MVC   HD_LMPID,MN.DPAPPIDB                                             
         CLC   HD_PPID#,MN.DPAPPIDB                                             
         JE    GETMAPN2                                                         
         J     GETMAP74                                                         
                                                                                
GETMAP72 MVC   MN.DPAPAS,IOKEYSAV  Reset key                                    
         SHI   R3,L'ONERL4L        Point to previous key length                 
         JCT   R0,GETMAP68         Do for number of 1R levels                   
         MVC   MN.DPAP1RAC,SPACES                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         CLC   MN.DPAPAS(DPAPPIDB-DPAPASD),IOKEYSAV                             
         JNE   GETMAPN1                                                         
         MVC   HD_LMPID,MN.DPAPPIDB                                             
         CLC   HD_PPID#,MN.DPAPPIDB                                             
         JE    GETMAPN2                                                         
         DROP  MN,P                                                             
                                                                                
PP       USING APPRECD,IOKEY                                                    
GETMAP74 XC    PP.APPKEY,PP.APPKEY                                              
         MVI   PP.APPKTYP,APPKTYPQ                                              
         MVI   PP.APPKSUB,APPKSUBQ                                              
         MVC   PP.APPKCPY,CUXCPY                                                
         MVC   PP.APPKPIDB,HD_LMPID                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         J     GETMAP78                                                         
                                                                                
GETMAP76 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'                               
GETMAP78 CLC   PP.APPKEY(APPKSEQ-APPRECD),IOKEYSAV                              
         JNE   GETMAP90                                                         
         DROP  PP                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R1,IOADDR                                                        
         MVC   IOKEY,0(R1)                                                      
         AHI   R1,ACCRFST-ACCRECD                                               
         SR    R0,R0                                                            
         USING LIDELD,R1                                                        
GETMAP80 CLI   LIDEL,0             Test end of record                           
         JE    GETMAP76                                                         
         CLI   LIDEL,LIDELQ        Test end of record                           
         JE    GETMAP84                                                         
GETMAP82 IC    R0,LIDLN                                                         
         AR    R1,R0                                                            
         J     GETMAP80                                                         
                                                                                
GETMAP84 CLI   LIDTYPE,LIDTBACK                                                 
         JNE   GETMAP82                                                         
         LA    R4,LIDDATA                                                       
         USING LIDDATA,R4                                                       
         LLC   R3,LIDLN                                                         
         AR    R3,R1               R3=End of element                            
         LA    RF,HD_LMBUP                                                      
         XR    RE,RE                                                            
                                                                                
GETMAP86 TM    LIDLAPPL,LIDLEXPN   Is this entry for expenses                   
         JZ    GETMAP88            No                                           
         MVC   0(L'PIDNO,RF),LIDLPID  Yes - Get back up approver PID            
         LA    RF,L'PIDNO(RF)                                                   
         AHI   RE,1                                                             
                                                                                
GETMAP88 CHI   RE,HD_BAMAX         Did we fill up the whole table?              
         JE    GETMAP90                                                         
         LLC   R0,LIDITLN          Increment R4 to look at next entry           
         AR    R4,R0                                                            
         CR    R3,R4               Check we haven't reached end of el           
         JH    GETMAP86            No - check next entry                        
                                                                                
*ETMAP90 MVI   HD_LMLVL,1                                                       
GETMAP90 LA    R6,HD_LMAPL(R6)                                                  
         LA    R5,1(R5)                                                         
         CLI   0(R5),X'FF'                                                      
         JNE   GETMAP66                                                         
         J     EXITY                                                            
         DROP  OWN,R1,R4,R6                                                     
                                                                                
GETMAPN1 MVC   ROUERRV,=AL2(AE$NOLMA)                                           
         J     *+10                                                             
GETMAPN2 MVC   ROUERRV,=AL2(AE$LMNSL)                                           
         J     EXITN                                                            
GETMAPN3 MVC   ROUERRV,=AL2(AE$MIAPP)                                           
         J     EXITN                                                            
GETMAPN4 MVC   ROUERRV,=AL2(AE$INVPD)                                           
         J     EXITN                                                            
         EJECT                                                                  
***********************************************************************         
* Get fiance approver and back-up approver PID for expense claim      *         
***********************************************************************         
                                                                                
GETFAP   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GETFAP*'                                                      
                                                                                
         LR    R2,R1                                                            
P        USING ACTKACT,R2                                                       
         MVI   FNIND,0                                                          
         MVI   HD_USRFN,NOQ                                                     
         MVI   HD_FNAPN,1          Set always one finance approver              
         XC    HD_FNAP(HD_FNAPL*HD_FMAXA),HD_FNAP                               
MN       USING DPAPASD,IOKEY                                                    
GETFAP02 XC    MN.DPAPAS,MN.DPAPAS                                              
         MVI   MN.DPAPTYP,DPAPTYPQ                                              
         MVI   MN.DPAPSUB,DPAPSUBQ                                              
         MVI   MN.DPAPAPPL,DPAPAEXF                                             
         MVC   MN.DPAPCPY,CUXCPY                                                
         ZAP   MN.DPAPXVAL,PZERO                                                
         ZAP   HD_FNVAL,PZERO                                                   
         LA    R3,ONERL4L          R3=A(Person length)                          
         LHI   R0,4                R0=Number of levels to search                
                                                                                
GETFAP04 MVC   MN.DPAP1RAC,SPACES                                               
         LLC   RF,0(R3)                                                         
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   MN.DPAP1RAC(0),P.ACTKACT                                         
         EX    RF,0(RE)                                                         
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         JE    GETFAP08                                                         
         DC    H'0'                                                             
GETFAP06 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'                               
         JE    GETFAP08                                                         
         DC    H'0'                                                             
                                                                                
GETFAP08 CLC   MN.DPAPAS(DPAPPIDB-DPAPASD),IOKEYSAV                             
         JNE   GETFAP16                                                         
                                                                                
GETFAP10 OI    FNIND,FNIFND        Set finance approver found                   
         MVC   CSVKEY1,MN.DPAPAS                                                
         TM    MN.DPAPSTAT,DPAPDFLT                                             
         JZ    GETFAP12                                                         
         MVC   HD_FNPID,MN.DPAPPIDB                                             
         AP    HD_APCNT,PONE       count approvers                              
GETFAP12 CLC   MN.DPAPPIDB,CCTPID  Is connected user finance approver           
         JNE   GETFAP06            No                                           
         CLC   HD_PPID#,CCTPID     Is it user?                                  
         JE    GETFAP06                                                         
                                                                                
*        TM    CPXSTAT6,CPX2LAEI   WPP workflow                                 
*        JZ    *+12                No                                           
         CLI   QH_FINVW,YESQ       Yes - don't allow same approver              
         JNE   GETFAP06            for all three levels                         
         MVI   HD_USRFN,YESQ       Yes                                          
         CLI   QH_STAT,QH_SAVEQ    Test saving                                  
         JE    GETFAP06                                                         
         CLI   QH_STAT,QH_APPQ     Are we approving?                            
         JE    GETFAP14                                                         
         CLI   QH_STAT,QH_REJQ     or rejecting?                                
         JNE   GETFAP06                                                         
         MVI   HD_FNSTA,CIDAREJ+HD_THIST  Rejected                              
         J     GETFAP06                                                         
                                                                                
GETFAP14 MVI   HD_FNSTA,CIDAAPP+HD_THIST  Approved                              
         J     GETFAP06                                                         
                                                                                
GETFAP16 TM    FNIND,FNIFND+FNIHIGH Have we found approver                      
         JNZ   GETFAP40            Yes - don't go down 1R levels                
         MVC   MN.DPAPAS,IOKEYSAV  Reset key                                    
         SHI   R3,L'ONERL4L        Point to previous key length                 
         JCT   R0,GETFAP04         Do for number of 1R levels                   
         OI    FNIND,FNIHIGH       set read highest level                       
GETFAP18 MVI   MN.DPAP1RAC,X'FF'                                                
         MVC   MN.DPAP1RAC+1(L'DPAP1RAC-1),MN.DPAP1RAC                          
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         CLC   MN.DPAPAS(DPAPPIDB-DPAPASD),IOKEYSAV                             
         JE    GETFAP10                                                         
         J     GETFAP40                                                         
         DROP  MN,P                                                             
                                                                                
GETFAP40 TM    FNIND,FNIFND        Have we found approver                       
         JZ    GETFAPN             No                                           
         OC    HD_FNPID,HD_FNPID   Did we find a default approver               
         JNZ   EXITY               Yes                                          
         MVC   ROUERRV,=AL2(AE$NDFFN) No - set error message                    
         J     EXITN                                                            
                                                                                
GETFAPN  MVC   ROUERRV,=AL2(AE$NOFIA)                                           
         J     EXITN                                                            
         EJECT                                                                  
***********************************************************************         
* Save error messages in an area so we can send all errors together   *         
***********************************************************************         
                                                                                
SAVERR   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*SAVERR*'                                                      
                                                                                
         CLI   RUNMODE,RVALREQQ    Can't handle errors if live update           
         JE    *+6                                                              
         DC    H'0'                                                             
         L     RF,ANXTERR          Address of next error in table               
         LAY   RE,BLOCK                                                         
*        LR    RF,RE                                                            
         CLI   0(RE),ET_EOTQ      If table is empty                             
         JNE   SAVERR10                                                         
         LAY   RF,BLOCK            Point to start of table                      
         XC    ALSTERR,ALSTERR                                                  
         USING ET_D,RF                                                          
SAVERR10 LLC   R0,4(R1)                                                         
         AHI   R0,ET_LN1Q          R0=Length of new entry                       
         AR    R0,RF                                                            
         LAY   RE,BLOCK+L'BLOCK                                                 
         CR    R0,RE                                                            
         JH    SAVERR30            No room left                                 
         SR    R0,RF                                                            
         STC   R0,0(RF)            Set length of new entry                      
         OI    TWAMODE,TWAMERP     Set we have validation error                 
         LM    R2,R4,0(R1)                                                      
         MVC   ET_ERRNO,0(R2)                                                   
         MVC   ET_ROWNM,0(R4)                                                   
         SHI   R0,ET_LN1Q                                                       
         LTR   R1,R0               Test any extra text to be added              
         JZ    SAVERR20            No                                           
         SHI   R1,1                                                             
         BASR  RE,0                                                             
         MVC   ET_EXTRA(0),0(R3)   Move extra text into entry                   
         EX    R1,0(RE)                                                         
SAVERR20 ST    RF,ALSTERR          REMEMBER PREVIOUS ERROR SLOT                 
         LA    RF,ET_D+ET_LN1Q     Point to next error slot                     
         AR    RF,R0               Add length of extra text                     
         ST    RF,ANXTERR          Set A(Next entry to be added)                
         MVI   ET_D,ET_EOTQ        Set new end of table                         
         J     EXITY                                                            
                                                                                
SAVERR30 DS    0H                  Too many errors for DDLINKIO                 
         L     RF,ALSTERR          Truncate it                                  
         LA    R0,ET_LN1Q                                                       
         AR    R0,RF                                                            
         LAY   RE,BLOCK+L'BLOCK                                                 
         CR    R0,RE                                                            
         JNH   *+6                 Room left to warn user                       
         DC    H'0'                table still too long                         
         SR    R0,RF                                                            
         STC   R0,0(RF)            Set length of new entry                      
         OI    TWAMODE,TWAMEDP     Give up now                                  
         MVC   ET_ERRNO,=AL2(AE$TMERR)                                          
         MVI   ET_LN1Q(RF),ET_EOTQ                                              
         J     EXITY                                                            
         DROP  RF                                                               
         EJECT                                                                  
***********************************************************************         
* Clear TSAR record                                                   *         
***********************************************************************         
                                                                                
CLRCLD   STM   RE,R1,12(RD)                                                     
         LA    R0,CL_D                                                          
         LHI   R1,CL_LN1Q                                                       
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         LM    RE,R1,12(RD)                                                     
         BR    RE                                                               
                                                                                
***********************************************************************         
* Clear work area (RC=A(Work area), R1=L'Work area)                   *         
***********************************************************************         
                                                                                
CLRWRK   STM   RE,R1,12(RD)                                                     
         LR    R0,RC                                                            
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         LM    RE,R1,12(RD)                                                     
         BR    RE                                                               
                                                                                
***********************************************************************         
* Extract name of record pointed to by IOADDR                         *         
*                                                                     *         
* Ntry:- R1=A(Output area)                                            *         
***********************************************************************         
                                                                                
GETNAM   STM   RE,R2,12(RD)                                                     
         LR    R2,R1               R2=A(Output area)                            
         MVC   0(L'NAMEREC,R2),SPACES                                           
         GOTOR GETELA,NAMELQ       Locate name element on record                
         JNE   GETNAMX                                                          
         USING NAMELD,R1                                                        
         CLI   NAMLN,NAMLN1Q       Test good length                             
         JNH   GETNAMX                                                          
         LLC   RF,NAMLN                                                         
         SHI   RF,NAMLN1Q+1                                                     
         CHI   RF,L'NAMEREC-1                                                   
         JNH   *+8                                                              
         LHI   RF,L'NAMEREC-1                                                   
         BASR  RE,0                                                             
         MVC   0(0,R2),NAMEREC     Move name to output area                     
         EX    RF,0(RE)                                                         
GETNAMX  LM    RE,R2,12(RD)                                                     
         BR    RE                                                               
         DROP  R1                                                               
                                                                                
***********************************************************************         
* Locate an element in record pointed to by IOADDR                    *         
*                                                                     *         
* Ntry:- R1=Element code                                              *         
* Exit:- R1=A(Element) and CC=Equal if element found                  *         
*        R1=0 and CC=Not equal if element not found                   *         
***********************************************************************         
                                                                                
GETELA   LR    RF,R1               RF=Element code to search for                
         L     R1,IOADDR                                                        
         AHI   R1,ACCRFST-ACCRECD                                               
         SR    R0,R0                                                            
GETELA02 CLI   0(R1),0             Test end of record                           
         JNE   *+10                                                             
         SR    R1,R1               Yes - clear pointer address                  
         CR    RE,R1               Set CC to not equal                          
         BR    RE                                                               
         CLM   RF,1,0(R1)          Test correct element                         
         BER   RE                  Yes - exit with CC equal                     
         IC    R0,1(R1)            No - bump to next element on record          
         AR    R1,R0                                                            
         J     GETELA02                                                         
                                                                                
***********************************************************************         
* Test security for an account record                                 *         
*                                                                     *         
* Ntry:- R1=A(Account status element) or 0 to locate status element   *         
*        on current record                                            *         
* Exit:- CC=Equal if okay, not equal if security lockout with ROUERRV *         
*        set to message number                                        *         
***********************************************************************         
                                                                                
TSTSEC   LTR   R1,R1               Test pointing to status element              
         JNZ   TSTSEC02                                                         
         ST    RE,12(RD)                                                        
         GOTOR GETELA,RSTELQ       Locate status element on record              
         L     RE,12(RD)                                                        
         JE    TSTSEC02                                                         
         CR    RE,RE               No status element - set OK                   
         BR    RE                  (Element pointer will be zero)               
                                                                                
         USING RSTELD,R1                                                        
TSTSEC02 CLI   CUAUTH+1,0          Allow if zero                                
         BER   RE                                                               
         CLC   RSTSECY+1(1),CUAUTH+1                                            
         JNH   *+12                                                             
         MVC   ROUERRV,=AL2(AE$SECLK)                                           
         BR    RE                                                               
         CR    RE,RE               Set CC=Equal                                 
         BR    RE                                                               
         DROP  R1                                                               
                                                                                
***********************************************************************         
* Add claim line/extra data TSAR record if passed                     *         
***********************************************************************         
                                                                                
DOTSAR   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*DOTSAR*'                                                      
                                                                                
         ICM   RE,15,0(R1)         RE=Index to work pool element                
         JZ    EXITN               CC=Low if element not found                  
         SR    RF,RF                                                            
         ICM   RF,3,LW_LN-LW_D(RE)                                              
         SHI   RF,LW_LN1Q          RF=L'TSAR record                             
         AHI   RE,LW_LN1Q          RE=A(TSAR record)                            
         LA    R0,CL_D             To address                                   
         LR    R1,RF               To length                                    
         MVCL  R0,RE               Copy record to I/O area 1                    
         GOTOR BUFCLM,DMCB,('TSAADD',NEWBUF),0                                  
         JE    EXITY                                                            
         DC    H'0'                                                             
         EJECT                                                                  
***********************************************************************         
* Interface to TSAR for claim buffers                                 *         
*                                                                     *         
* Note that when running off-line the TSAR buffers are acquired only  *         
* once - the XC(TSPNEWL) below is intentional as the first time       *         
* through the code TSAR will issue the GETMAIN for the buffer         *         
***********************************************************************         
                                                                                
BUFCLM   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*BUFCLM*'                                                      
                                                                                
         LR    R2,R1               R2=A(Caller's parameter list)                
         LA    R3,TSAROLDI         Point to correct TSAR block                  
         CLI   3(R2),OLDBUF                                                     
         JNE   *+8                                                              
         LA    R3,TSARNEWI                                                      
                                                                                
         USING TSARD,R3            R3=A(TSAR block)                             
         LA    R0,CL_D                                                          
         ST    R0,TSAREC           Set A(Record)                                
         CLI   0(R2),TSAINI        Test initialisation call                     
         JNE   BUFCLM02                                                         
         XC    TSARD(TSPNEWL),TSARD                                             
         MVC   TSACTN,0(R2)                                                     
         MVC   TSACOM,ACOMFACS                                                  
         LHI   R0,ONEK                                                          
         STCM  R0,3,TSBUFFL        Set require 1MB off-line                     
         MVI   TSRECI,TSRTSAB1                                                  
         CLI   3(R2),OLDBUF                                                     
         JNE   *+8                                                              
         MVI   TSRECI,TSRTSAB2                                                  
         OI    TSRECI,TSRXTN                                                    
         MVI   TSKEYL,CL_KEYL      Set key length                               
         LHI   R0,CL_LN1Q                                                       
         STCM  R0,3,TSRECL         Set record length                            
         MVI   TSINDS,TSINODSK     Set no disk writes (save/restore)            
         GOTOR VTSAR,TSARD                                                      
         TM    TSINDS,TSIINIOK                                                  
         JNZ   EXITY                                                            
         DC    H'0'                Initialisation failure                       
                                                                                
BUFCLM02 TM    TSINDS,TSIINIOK     Test initialised                             
         JZ    BUFCLM04                                                         
                                                                                
         MVC   TSACTN,0(R2)        Set action                                   
         OC    4(L'TSAREC,R2),4(R2)                                             
         JZ    *+10                                                             
         MVC   TSAREC,4(R2)        Set A(record) if passed                      
         GOTOR VTSAR,TSARD         Call TSAR                                    
         MVC   CLMERR,TSERRS       Return TSERRS in CLMERR                      
         J     BUFCLMX                                                          
                                                                                
BUFCLM04 MVI   CLMERR,TSEEOF       Set EOF if not initialised                   
                                                                                
BUFCLMX  CLI   CLMERR,0            Set condition code for caller                
         J     EXIT                                                             
         DROP  R3                                                               
         EJECT                                                                  
***********************************************************************         
* Manage a TSAR buffer of ACCMST records that are to be updated       *         
*                                                                     *         
* This routine will add an entry to the buffer for the first read     *         
* of the record, provided that the record is found and not deleted.   *         
* The caller may add new records to the buffer (with a disk address   *         
* of zero) and records which are to replace deleted records (which    *         
* are not added automatically).  When the routine is called for the   *         
* last time (R1=0) the buffer records are read back and the internal  *         
* DATAMGR routine is called to add the records to the output FACWRK   *         
* recovery file - any records with a zero disk address will cause     *         
* an ADDREC in SRUPD60 else a PUTREC will be done instead.            *         
*                                                                     *         
* Ntry:- R1 points to a parameter list as follows or zero if last     *         
*        time call (to flush buffer and write recovery records)       *         
*                                                                     *         
*        P1/0   - Action/read flags                                   *         
*        P2/1-3 - A(Record)                                           *         
*        P3     - A(Caller hook routine for buffer add)               *         
***********************************************************************         
                                                                                
BUFGET   EQU   1                   Get/create a buffer entry                    
BUFGDR   EQU   BUFGET+X'08'        Get/create - read for deletes                
BUFPUT   EQU   2                   Update a buffer entry                        
BUFADD   EQU   3                   Add a new buffer entry                       
BUFRDH   EQU   4                   Read high for a record key                   
BUFNXT   EQU   5                   Get next record (after read high)            
                                                                                
BUFREC   NTR1  LABEL=NO,WORK=(RC,BRWORKL)                                       
         J     *+12                                                             
         DC    C'*BUFREC*'                                                      
                                                                                
         USING BRWORKD,RC          RC=A(local working storage)                  
TB       USING TSARD,TSARRECS      BUFREC TSAR block                            
         LTR   R2,R1               Test last time call                          
         JZ    BUFREC16                                                         
         MVC   BRACTN,0(R2)                                                     
         MVC   BRINDS,0(R2)                                                     
         NI    BRACTN,B'00000111'  Isolate action number                        
         NI    BRINDS,B'11111000'  Isolate read flags                           
                                                                                
         TM    RUNINDS,RUNIBUFF    Test first time                              
         JNZ   BUFREC02                                                         
         MVI   TB.TSACTN,TSAINI    Yes - initialise TSAR buffer                 
         MVI   TB.TSRECI,TSRXTN+TSRMINB1+TSRVAR                                 
         MVI   TB.TSKEYL,L'BR_KEY                                               
         LHI   R0,BR_LNQ                                                        
         STCM  R0,3,TB.TSRECL      Set maximum record length                    
         LHI   R0,2*ONEK           Default to 2MB off-line                      
         OC    TB.TSBUFFL,TB.TSBUFFL                                            
         JNZ   *+8                                                              
         STCM  R0,3,TB.TSBUFFL     Set buffer length if not set                 
         MVC   TB.TSACOM,ACOMFACS                                               
         GOTOR VTSAR,TB.TSARD      Initialise TSAR buffer                       
         JE    *+6                                                              
         DC    H'0'                                                             
         OI    RUNINDS,RUNIBUFF    Set not first time                           
                                                                                
BUFREC02 L     R4,4(R2)            R4=A(Record)                                 
         SHI   R4,BR_HL            Back up by header length                     
         ST    R4,TB.TSAREC        Set A(TSAR record)                           
R        USING BR_D,R4                                                          
         MVC   BRSAVE(BR_HL),0(R4) Save what's there                            
         XC    R.BR_D(BR_HL),R.BR_D                                             
         MVI   BRTSARER,0          Clear TSAR return flags                      
                                                                                
         CLI   BRACTN,BUFGET       Test get record from buffer                  
         JNE   BUFREC04                                                         
         MVC   R.BR_KEY,IOKEY                                                   
         MVI   TB.TSACTN,TSARDH                                                 
         GOTOR VTSAR,TB.TSARD      See if we have record already                
         JE    BUFREC12                                                         
         MVI   TB.TSACTN,TSAADD    Set action to add record                     
         MVC   R.BR_KEY,IOKEY      Set record key                               
                                                                                
         MVC   IOKEYSAV,IOKEY      Save record key (emulate IOEXEC)             
         GOTOR DATAMGR,PARM,(BRINDS,DMREAD),ACCDIR,IOKEY,IOKEY                  
         MVC   IODA,IOKEY+(ACCKDA-ACCRECD)                                      
         MVC   IOERR,8(R1)         Save directory return                        
         JNE   EXITN               Exit on any errors                           
                                                                                
         MVC   R.BR_DA,IODA        Set disk address                             
         GOTOR (RF),(R1),(BRINDS,DMGETR),ACCMST,R.BR_DA,R.BR_REC,      +        
               R.BR_WORK                                                        
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         SR    R0,R0               Set buffer record length                     
         ICM   R0,3,R.BR_REC+(ACCRLEN-ACCRECD)                                  
         AHI   R0,BR_REC-BR_D                                                   
         STCM  R0,3,R.BR_LEN                                                    
                                                                                
         GOTOR VTSAR,TB.TSARD      Add record to TSAR buffer                    
         JE    BUFREC12                                                         
         DC    H'0'                                                             
                                                                                
BUFREC04 CLI   BRACTN,BUFPUT       Test put record                              
         JE    *+12                                                             
         CLI   BRACTN,BUFADD       Test add record                              
         JNE   BUFREC06                                                         
         SR    R0,R0               Set buffer record length                     
         ICM   R0,3,R.BR_REC+(ACCRLEN-ACCRECD)                                  
         AHI   R0,BR_REC-BR_D                                                   
         STCM  R0,3,R.BR_LEN                                                    
         MVC   R.BR_KEY,IOKEY      Set record key                               
         MVC   R.BR_ERRS,IOERR     Set error flags                              
         MVC   R.BR_DA,IODA        Set disk address                             
         MVC   R.BR_WORK,IOWORK    Set PUTREC work area                         
         MVI   TB.TSACTN,TSAADD    Set action to add                            
         CLI   BRACTN,BUFPUT                                                    
         JNE   *+8                                                              
         MVI   TB.TSACTN,TSAPUT    Set action to put                            
         GOTOR VTSAR,TB.TSARD                                                   
         JE    BUFREC14                                                         
         DC    H'0'                                                             
                                                                                
BUFREC06 CLI   BRACTN,BUFRDH       Test read high for a record key              
         JNE   BUFREC08                                                         
         MVC   IOKEYSAV,IOKEY      Save caller's key                            
         MVC   R.BR_KEY,IOKEY      Set read high key                            
         MVI   TB.TSACTN,TSARDH    Set action to 'read high'                    
         J     BUFREC10                                                         
                                                                                
BUFREC08 CLI   BRACTN,BUFNXT       Get next record for a record key             
         JE    *+6                                                              
         DC    H'0'                                                             
         MVI   TB.TSACTN,TSANXT    Set action to 'get next'                     
                                                                                
BUFREC10 GOTOR VTSAR,TB.TSARD      Read high/get next                           
         MVC   BRTSARER,TB.TSERRS                                               
         TM    BRTSARER,TSEEOF     Test end of file                             
         JNZ   BUFREC14                                                         
         MVI   BRTSARER,0          Clear error for read high                    
                                                                                
BUFREC12 MVC   IODA,R.BR_DA        Set disk address                             
         MVC   IOWORK,R.BR_WORK    Set PUTREC work area                         
K        USING ACCRECD,IOKEY       Build directory record                       
         MVC   K.ACCKEY,R.BR_REC                                                
         MVC   K.ACCKSTA,R.BR_REC+(ACCRSTA-ACCRECD)                             
         MVC   K.ACCKDA,IODA                                                    
                                                                                
BUFREC14 MVC   R.BR_D(BR_HL),BRSAVE                                             
         CLI   BRTSARER,0          Set condition code for caller                
         J     EXIT                                                             
         DROP  R                                                                
                                                                                
BUFREC16 TM    RUNINDS,RUNIBUFF    Test first time flag set                     
         JZ    EXITY               No - buffer must be empty                    
                                                                                
         MVI   TB.TSACTN,TSARDH                                                 
         L     R2,AIO1             Use IO1 for these calls                      
         ST    R2,TB.TSAREC                                                     
         USING BR_D,R2                                                          
         XC    BR_KEY,BR_KEY                                                    
                                                                                
BUFREC18 GOTOR VTSAR,TB.TSARD      Get first/next buffer record                 
         MVI   TB.TSACTN,TSANXT                                                 
         TM    TB.TSERRS,TSEEOF    Test end of buffer                           
         JNZ   EXITY                                                            
                                                                                
         OC    BR_DA,BR_DA         Test new record                              
         JZ    BUFREC22                                                         
BUFREC20 GOTOR DMGRITRN,DMCB,DMPUTF,ACCMST,BR_DA,BR_REC,BR_WORK                 
                                                                                
         GOTOR DATAMGR,DMCB,(X'08',DMREAD),ACCDIR,BR_KEY,IOKEYSAV               
         TM    8(R1),FF-(IOEDEL)                                                
         JZ    *+6                                                              
         DC    H'0'                                                             
                                                                                
         MVC   K.ACCKEY,BR_REC     Build directory record                       
         MVC   K.ACCKSTA,BR_REC+(ACCRSTA-ACCRECD)                               
         MVC   K.ACCKDA,BR_DA                                                   
         CLC   K.ACCRECD(ACCKLEN),IOKEYSAV                                      
         JE    BUFREC18            Done if no change to it                      
         GOTOR DMGRITRN,DMCB,DMWRTD,ACCDIR,K.ACCKEY,K.ACCKEY                    
         J     BUFREC18                                                         
                                                                                
BUFREC22 GOTOR DMGRITRN,DMCB,DMADDF,ACCMST,BR_DA,BR_REC,BR_WORK                 
         J     BUFREC18                                                         
         DROP  RC,K,R2,TB                                                       
                                                                                
BRWORKD  DSECT                     ** BUFREC local working storage **           
BRACTN   DS    X                   Action                                       
BRINDS   DS    X                   Read flags                                   
BRTSARER DS    XL(L'TSERRS)        TSAR error                                   
BRSAVE   DS    XL(BR_HL)           Save area                                    
BRWORKL  EQU   *-BRWORKD                                                        
                                                                                
BR_D     DSECT                     ** Record buffer **                          
BR_LEN   DS    AL2                 Buffer record length                         
                                                                                
BR_KEY   DS    XL(L'ACCKEY)        Record key                                   
                                                                                
BR_ERRS  DS    XL(L'IOERR)         Error flags                                  
BR_DA    DS    XL(L'IODA)          Disk address                                 
BR_WORK  DS    XL(L'IOWORK)        PUTREC work area                             
BR_HL    EQU   *-BR_D              Length of header                             
                                                                                
BR_REC   DS    XL(IOLENQ)          ACCMST record (including key)                
BR_LNQ   EQU   *-BR_D              Maximum record size                          
SVRDEF   CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* Initialise optimisation buffer (uses WSSVR buffer)                  *         
***********************************************************************         
                                                                                
INIBUF   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*INIBUF*'                                                      
                                                                                
T        USING TSARD,TSAROBUF                                                   
         MVI   T.TSACTN,TSAINI     Set action to 'Initialise'                   
         MVI   T.TSRECI,TSRXTN+TSRWSSVR                                         
         MVI   T.TSKEYL,L'OB_KEY                                                
         LHI   R0,ONEK                                                          
         STCM  R0,3,T.TSBUFFL                                                   
         LHI   R0,OB_LNQ                                                        
         STCM  R0,3,T.TSRECL                                                    
         MVC   T.TSACOM,ACOMFACS                                                
         GOTOR VTSAR,T.TSARD                                                    
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  T                                                                
         EJECT                                                                  
***********************************************************************         
* Delete a record from the optimisation buffer                        *         
*                                                                     *         
* Ntry:- R1 points to caller's OB_D                                   *         
***********************************************************************         
DELBUF   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*DELBUF*'                                                      
T        USING TSARD,TSAROBUF                                                   
         MVI   T.TSACTN,TSADEL     Set action to 'Delete'                       
         ST    R1,T.TSAREC                                                      
         GOTOR VTSAR,T.TSARD                                                    
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  T                                                                
***********************************************************************         
* Add a record to optimisation buffer                                 *         
*                                                                     *         
* Ntry:- R1 points to caller's OB_D                                   *         
***********************************************************************         
                                                                                
ADDBUF   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*ADDBUF*'                                                      
                                                                                
T        USING TSARD,TSAROBUF                                                   
         MVI   T.TSACTN,TSAADD     Set action to 'Add'                          
         ST    R1,T.TSAREC                                                      
         GOTOR VTSAR,T.TSARD                                                    
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  T                                                                
         EJECT                                                                  
***********************************************************************         
* Write back a record to optimisation buffer                          *         
*                                                                     *         
* Ntry:- R1 points to caller's OB_D                                   *         
***********************************************************************         
                                                                                
WRIBUF   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*WRIBUF*'                                                      
                                                                                
T        USING TSARD,TSAROBUF                                                   
         MVI   T.TSACTN,TSAWRT     Set action to 'Write'                        
         ST    R1,T.TSAREC                                                      
         GOTOR VTSAR,T.TSARD                                                    
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  T                                                                
         EJECT                                                                  
***********************************************************************         
* Get a record from optimisation buffer                               *         
*                                                                     *         
* Ntry:- R1 points to caller's OB_D                                   *         
* Exit:- CC=Low if record not found in buffer                         *         
*        CC=Equal if record found and is not posted with an error     *         
*           - record is returned in caller's OB_D                     *         
*        CC=High if record found and is posted with an error (set in  *         
*           ROUERRV)                                                  *         
***********************************************************************         
                                                                                
GETBUF   NTR1  LABEL=NO,WORK=(RC,OB_LNQ)                                        
         J     *+12                                                             
         DC    C'*GETBUF*'                                                      
                                                                                
W        USING OB_D,RC                                                          
         LR    R2,R1                                                            
P        USING OB_D,R2             R2=A(caller's OB_D)                          
         MVC   W.OB_KEY,P.OB_KEY                                                
                                                                                
T        USING TSARD,TSAROBUF                                                   
         MVI   T.TSACTN,TSARDH     Set action to 'Read High'                    
         LA    R0,W.OB_D                                                        
         ST    R0,T.TSAREC         Read into acquired storage                   
         GOTOR VTSAR,T.TSARD                                                    
         MVC   TSARERRS,T.TSERRS   Return TSARERRS                              
         JNE   EXITL               Not found/EOF                                
         DROP  T                                                                
                                                                                
         MVC   P.OB_D(OB_LNQ),W.OB_D                                            
                                                                                
         MVC   ROUERRV,P.OB_ERROR  Set/test record in error                     
         OC    ROUERRV,ROUERRV                                                  
         JNZ   EXITH                                                            
         J     EXITY                                                            
         DROP  W,P                                                              
         EJECT                                                                  
***********************************************************************         
* Expense claim upload header record                                  *         
***********************************************************************         
                                                                                
HDRREC   LKREQ H,A#XHDR,NEWREC=Y                                                
Action   LKREQ F,01,(D,B#SAVED,QH_ACTN),LBIN,TEXT=AC#ACT                        
Type     LKREQ F,02,(D,B#SAVED,QH_TYPE),CHAR,TEXT=AC#TYPE                       
Number   LKREQ F,03,(D,B#SAVED,QH_NUM),CHAR,TEXT=AC#NUM                         
Descr    LKREQ F,04,(D,B#SAVED,QH_DESCL),(R,VALTXT),                   +        
               LOWERCASE=Y,TEXT=AC#DESC,OLEN=L'QH_DESC+L'QH_DESCL               
NewStat  LKREQ F,05,(D,B#SAVED,QH_STAT),LBIN,TEXT=AC#AMDTO                      
Index    LKREQ F,07,(D,B#SAVED,QH_IDNUM),HEXD,TEXT=AC#INDEX                     
BatRf    LKREQ F,08,(D,B#SAVED,QH_BREF),CHAR,TEXT=AC#BATRF                      
BatMOA   LKREQ F,09,(D,B#SAVED,QH_BMOA),HEXD,TEXT=AC#MOA                        
BatNm    LKREQ F,10,(D,B#SAVED,QH_BNAM),CHAR,TEXT=AC#BATN                       
BatCm    LKREQ F,11,(D,B#SAVED,QH_BCOML),(R,VALTXT),TEXT=AC#CMTS,      +        
               LOWERCASE=Y,OLEN=L'QH_BCOM+L'QH_BCOML                            
Date     LKREQ F,12,(D,B#SAVED,QH_DATE),CDAT,TEXT=AC#DATE                       
Claimer  LKREQ F,13,(D,B#SAVED,QH_PER),CHAR,TEXT=AC#ORGL                        
Backup   LKREQ F,14,(D,B#SAVED,QH_BKUP),CHAR,TEXT=AC#BCAPP                      
TotItms  LKREQ F,15,(D,B#SAVED,QH_TOTAL),SPAK,TEXT=(*,TOTELIT)                  
TotAdvs  LKREQ F,16,(D,B#SAVED,QH_TOTAD),SPAK,TEXT=(*,TOTELIT)                  
PCToken  LKREQ F,17,(D,B#SAVED,QH_TOKEN),CHAR,TEXT=(*,TOKNLIT)                  
FinView  LKREQ F,18,(D,B#SAVED,QH_FINVW),CHAR,TEXT=(*,FINVLIT)                  
ClCom    LKREQ F,19,(D,B#SAVED,QH_CCMTL),(R,VALTXT),TEXT=AC#CMTS,      +        
               LOWERCASE=Y,OLEN=L'QH_CCMTL+L'QH_CCMT                            
IfAmtZ   LKREQ F,20,(D,B#SAVED,QH_IFAMZ),CHAR,TEXT=(*,AMZRLIT)                  
Apprlvl  LKREQ F,21,(I,B#SAVED,QH_APPRI),LBIN,OLEN=1,                  +        
               LIST=NOSORT,TEXT=AC#APLVL,ARRAY=S                                
Applim   LKREQ F,22,,SPAK,OLEN=L'APPPVAL,                              +        
               TEXT=AC#APLIM                                                    
Apppid   LKREQ F,23,,CHAR,OLEN=L'PERKCODE,                             +        
               TEXT=AC#APPID                                                    
Appsta   LKREQ F,24,,HEXD,OLEN=1,                                      +        
               TEXT=AC#APSTA,ARRAY=E                                            
HDRVals  LKREQ F,64,(I,B#SAVED,QH_AHEAD),CHAR,TEXT=(*,HEADLIT),OLEN=1           
                                                                                
         LKREQ E                                                                
                                                                                
***********************************************************************         
* Expense claim upload item record                                    *         
***********************************************************************         
                                                                                
ITMREC   LKREQ H,A#XITM,NEWREC=Y                                                
PCToken  LKREQ F,01,(D,B#SAVED,QX_TOKEN),CHAR,TEXT=(*,TOKNLIT)                  
Item#    LKREQ F,02,(D,B#SAVED,QI_ITM#),LBIN,TEXT=AC#ITEM                       
Date     LKREQ F,03,(D,B#SAVED,QI_DATE),CDAT,TEXT=AC#DATE                       
ExpTyp   LKREQ F,04,(D,B#SAVED,QI_ETYP),CHAR,TEXT=AC#RSEXP                      
Billable LKREQ F,05,(D,B#SAVED,QI_TYPE),CHAR,TEXT=AC#BLBNB                      
Client   LKREQ F,06,(D,B#SAVED,QI_CLI),CHAR,TEXT=AC#CLIC                        
Product  LKREQ F,07,(D,B#SAVED,QI_PRO),CHAR,TEXT=AC#PROC                        
Job      LKREQ F,08,(D,B#SAVED,QI_JOB),CHAR,TEXT=AC#JOBC                        
WC       LKREQ F,09,(D,B#SAVED,QI_WC),CHAR,TEXT=AC#WC                           
Receipt  LKREQ F,10,(D,B#SAVED,QI_RCPT),CHAR,TEXT=AC#RCPTS                      
Amount   LKREQ F,11,(D,B#SAVED,QI_AMT),SPAK,TEXT=AC#AMT                         
CurCode  LKREQ F,12,(D,B#SAVED,QI_CUR),CHAR,TEXT=AC#CURRC                       
CurAmnt  LKREQ F,13,(D,B#SAVED,QI_FAMT),SPAK,TEXT=AC#FCAMT                      
RefNum   LKREQ F,14,(D,B#SAVED,QI_REF),CHAR,TEXT=AC#REF                         
Narr     LKREQ F,15,(D,B#SAVED,QI_NARL),(R,VALTXT),TEXT=AC#STDCT,      +        
               OLEN=L'QI_NAR+L'QI_NARL,LOWERCASE=Y                              
ExpAc    LKREQ F,16,(D,B#SAVED,QI_EXPAC),CHAR,TEXT=AC#EXPA                      
SupAc    LKREQ F,17,(D,B#SAVED,QI_SUPAC),CHAR,TEXT=AC#SUPC                      
Staff    LKREQ F,18,(D,B#SAVED,QI_2PAC),CHAR,TEXT=AC#STFC                       
Dept     LKREQ F,19,(D,B#SAVED,QI_2DAC),CHAR,TEXT=AC#DPT                        
Miles    LKREQ F,20,(D,B#SAVED,QI_MILES),SPAK,TEXT=AC#MILES                     
IntNum   LKREQ F,21,(D,B#SAVED,QI_INT#),CHAR,TEXT=AC#INTC                       
Rate     LKREQ F,22,(D,B#SAVED,QI_XRAT),HEXD,TEXT=AC#EXCHR                      
VATcod   LKREQ F,23,(D,B#SAVED,QI_VATC),CHAR,TEXT=AC#VATC                       
NetAmnt  LKREQ F,24,(D,B#SAVED,QI_NAMT),SPAK,TEXT=AC#NETAM                      
OffCod   LKREQ F,25,(D,B#SAVED,QI_OFF),CHAR,TEXT=AC#OFFC                        
Deletd   LKREQ F,26,(D,B#SAVED,QI_DELT),CHAR,TEXT=AC#DELIT                      
*&&UK                                                                           
ISSel    LKREQ F,27,(D,B#SAVED,QI_ISSEL),CHAR,TEXT=AC#SSEL                      
*&&                                                                             
*&&US                                                                           
ISSel    LKREQ F,27,(D,B#SAVED,QI_ISSEL),CHAR,TEXT=AC#SELED                     
*&&                                                                             
EstNum   LKREQ F,28,(D,B#SAVED,QI_EST),CHAR,TEXT=AC#EST                         
ONarr    LKREQ F,29,(D,B#SAVED,QI_ONARL),(R,VALTXT),TEXT=AC#DTOPC,     +        
               OLEN=L'QI_NAR+L'QI_NARL,LOWERCASE=Y                              
IsChgd   LKREQ F,30,(D,B#SAVED,QI_CHNGE),CHAR,TEXT=(*,ICHGLIT)                  
DiscRate LKREQ F,31,(D,B#SAVED,QI_DISC),LBIN,TEXT=(*,DISCLIT)                   
DscAmnt  LKREQ F,32,(D,B#SAVED,QI_DAMT),SPAK,TEXT=(*,DAMTLIT)                   
AgyInpt  LKREQ F,33,(D,B#SAVED,QI_AGYIN),CHAR,TEXT=(*,AGYILIT)                  
Vehicle  LKREQ F,34,(D,B#SAVED,QI_VEHCD),CHAR,TEXT=(*,VEHCLIT)                  
Fuel     LKREQ F,35,(D,B#SAVED,QI_FUECD),CHAR,TEXT=(*,FUECLIT)                  
Engine   LKREQ F,36,(D,B#SAVED,QI_ENGCD),CHAR,TEXT=(*,ENGCLIT)                  
Disclmr  LKREQ F,37,(D,B#SAVED,QI_DISCL),CHAR,TEXT=(*,DISLLIT)                  
NumPass  LKREQ F,38,(D,B#SAVED,QI_NMPAS),LBIN,TEXT=(*,NPASLIT)                  
NonVATA  LKREQ F,39,(D,B#SAVED,QI_NONVT),SPAK,TEXT=(*,NVATLIT)                  
                                                                                
DisBnd   LKREQ F,40,(I,B#SAVED,QI_DISTI),CHAR,OLEN=L'FFTDISC,          +        
               LIST=NOSORT,TEXT=(*,DISBLIT),ARRAY=S                             
DisAmt   LKREQ F,41,,SPAK,OLEN=L'FFTDISA,                              +        
               TEXT=(*,DISTLIT)                                                 
GrsRt    LKREQ F,42,,SPAK,OLEN=L'LIDRGRSR,                             +        
               TEXT=(*,GRSRLIT)                                                 
VatRt    LKREQ F,43,,SPAK,OLEN=L'LIDRVATR,                             +        
               TEXT=(*,VATRLIT)                                                 
PasRt    LKREQ F,44,,SPAK,OLEN=L'LIDRPASR,                             +        
               TEXT=(*,PASRLIT),ARRAY=E                                         
AccuNm   LKREQ F,45,(D,B#SAVED,QI_ACUNM),LBIN,TEXT=(*,ACNMLIT)                  
AccuDis  LKREQ F,46,(D,B#SAVED,QI_ACUDS),SPAK,TEXT=(*,ACDSLIT)                  
*&&US                                                                           
Prvinc   LKREQ F,47,(D,B#SAVED,QI_PROVI),CHAR,TEXT=(*,PROVLIT)                  
AmtGST   LKREQ F,48,(D,B#SAVED,QI_AMTGS),SPAK,TEXT=(*,GSTALIT)                  
AmtPST   LKREQ F,49,(D,B#SAVED,QI_AMTPS),SPAK,TEXT=(*,PSTALIT)                  
PSTCod   LKREQ F,50,(D,B#SAVED,QI_PSTCD),CHAR,TEXT=(*,PSTCLIT)                  
*&&                                                                             
RptChg   LKREQ F,51,(D,B#SAVED,QI_RCPTC),CHAR,TEXT=(*,RCPCLIT)                  
                                                                                
TSARRec  LKREQ F,64,(I,B#SAVED,QX_TSAR),CHAR,TEXT=(*,TSARLIT),OLEN=1            
                                                                                
         LKREQ E                                                                
                                                                                
***********************************************************************         
* Expense claim upload extra data record                              *         
***********************************************************************         
                                                                                
XDTREC   LKREQ H,A#XXDT,NEWREC=Y                                                
PCToken  LKREQ F,01,(D,B#SAVED,QX_TOKEN),CHAR,TEXT=(*,TOKNLIT)                  
Item     LKREQ F,02,(D,B#SAVED,QX_ITM#),LBIN,TEXT=AC#ITEM                       
XPtr     LKREQ F,03,(D,B#SAVED,QX_CODE),HEXD,TEXT=AC#CODE                       
Type     LKREQ F,04,(D,B#SAVED,QX_TYPE),CHAR,TEXT=AC#TYPE                       
Data     LKREQ F,05,(D,B#SAVED,QX_DATA),CHAR,TEXT=AC#DATA                       
                                                                                
TSARRec  LKREQ F,64,(I,B#SAVED,QX_TSAR),CHAR,TEXT=(*,TSARLIT),OLEN=1            
                                                                                
         LKREQ E                                                                
                                                                                
***********************************************************************         
* Expense claim upload trailer record                                 *         
***********************************************************************         
                                                                                
TRLREC   LKREQ H,A#XTRL,NEWREC=Y                                                
PCToken  LKREQ F,1,(D,B#SAVED,QT_TOKEN),CHAR,TEXT=(*,TOKNLIT)                   
SCCom    LKREQ F,2,(I,B#SAVED,QT_COMTI),(R,VALTXT),TEXT=AC#CMTS,       +        
               LIST=(F,NOSORT),OLEN=L'STCXCOMT+1,LOWERCASE=Y                    
                                                                                
TRLVals  LKREQ F,64,(I,B#SAVED,QT_ATRLR),CHAR,TEXT=(*,TRLRLIT),OLEN=1           
                                                                                
         LKREQ E                                                                
                                                                                
***********************************************************************         
* Request map for add acc to limit list                               *         
***********************************************************************         
                                                                                
ALLUPL   LKREQ H,A#AALL,NEWREC=Y                                                
Type     LKREQ F,01,(D,B#SAVED,QL_TYPE),CHAR,TEXT=AC#TYPE                       
Value    LKREQ F,02,(D,B#SAVED,QL_VAL),CHAR,TEXT=AC#VALUE                       
Sec4G    LKREQ F,03,(D,B#SAVED,QL_SEC),CHAR,TEXT=AC#SEC                         
ModEst   LKREQ F,04,(D,B#SAVED,QL_EST),CHAR,TEXT=AC#ESTS                        
ModExp   LKREQ F,05,(D,B#SAVED,QL_EXP),CHAR,TEXT=AC#EXPEN                       
ModInv   LKREQ F,06,(D,B#SAVED,QL_INV),CHAR,TEXT=AC#INVS                        
ModJob   LKREQ F,07,(D,B#SAVED,QL_JOB),CHAR,TEXT=AC#JOBS                        
ModOrd   LKREQ F,08,(D,B#SAVED,QL_ORD),CHAR,TEXT=AC#ORDS                        
ModRes   LKREQ F,09,(D,B#SAVED,QL_RES),CHAR,TEXT=AC#BORES                       
ModTime  LKREQ F,10,(D,B#SAVED,QL_TIME),CHAR,TEXT=AC#TIME                       
ModRept  LKREQ F,11,(D,B#SAVED,QL_REP),CHAR,TEXT=AC#RPT                         
                                                                                
         LKREQ E                                                                
                                                                                
***********************************************************************         
* End of request map tables                                          *          
***********************************************************************         
                                                                                
         LKMAP X                                                                
         EJECT                                                                  
***********************************************************************         
* Validate rejection comment/claim item narrative                     *         
***********************************************************************         
                                                                                
VALTXT   LM    R2,R4,LP_AINP-LP_D(R5)                                           
         STC   R3,0(R4)            Returns L'Text,Text string                   
         BCTR  R3,0                                                             
         BASR  RE,0                                                             
         MVC   1(0,R4),0(R2)                                                    
         EX    R3,0(RE)                                                         
         J     EXITY                                                            
                                                                                
         EJECT                                                                  
* *********************************************************************         
* Create transactions and/or update/create buckets                    *         
***********************************************************************         
                                                                                
CLMTRN   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*CLMTRN*'                                                      
                                                                                
CLMTRN02 XC    OLD.CL_#,OLD.CL_#   Get first old claim buffer record            
         GOTOR NXTBUF,OLDBUF                                                    
         XC    NEW.CL_#,NEW.CL_#   Get first new claim buffer record            
         GOTOR NXTBUF,NEWBUF                                                    
                                                                                
CLMTRN04 MVI   STPOSTNG,0          Initialise action controls                   
                                                                                
         CLC   OLD.CL_#,EFFS       Test old buffer is empty                     
         JNE   *+8                                                              
         OI    STPOSTNG,STADDNEW   Yes - create new postings                    
                                                                                
         CLC   NEW.CL_#,EFFS       Test new buffer is empty                     
         JNE   *+8                                                              
         OI    STPOSTNG,STBCKOUT   Yes - back out old postings                  
                                                                                
         TM    STPOSTNG,STADDNEW+STBCKOUT                                       
         JO    CLMTRNX             Back out old and create new postings         
         TM    STPOSTNG,STBCKOUT                                                
         JNZ   CLMTRN16            Back out old postings                        
         TM    STPOSTNG,STADDNEW                                                
         JNZ   CLMTRN18            Create new postings                          
                                                                                
         CLC   OLD.CL_#,NEW.CL_#   Compare keys                                 
         JL    CLMTRN16            Line deleted - back out old postings         
         JH    CLMTRN18            Line added - create new postings             
                                                                                
***********************************************************************         
* Old and new records are present - check for pertinent data changes  *         
***********************************************************************         
                                                                                
         LA    R0,OLD.CL_IVALS                                                  
         LHI   R1,CL_IVALL                                                      
         LA    RE,NEW.CL_IVALS                                                  
         LR    RF,R1                                                            
         CLCL  RE,R0                                                            
         JNE   CLMTRN10                                                         
                                                                                
         TM    NEW.CL_BSTAT,CL_BSRCR          Was any change marked             
         JNZ   CLMTRN10                       Yes - update postings             
                                                                                
CLMTRN08 CLC   HD_ST1FR,TR_ST1NW   Test claim status has changed                
         JNE   CLMTRN10            Yes - need to update postings                
         CLC   HD_ST2FR,TR_ST2NW   Test 2nd status byte                         
         JE    CLMTRN14            Nothing changed - get next pair              
                                                                                
                                                                                
***********************************************************************         
* Changed entry - back out old postings and create new postings       *         
***********************************************************************         
                                                                                
CLMTRN10 OI    STPOSTNG,STNEGATE                                                
         GOTOR BLDTRN,OLD.CL_D     Back out old postings                        
                                                                                
CLMTRN12 GOTOR BLDTRN,NEW.CL_D     Create new postings/buckets                  
                                                                                
CLMTRN14 GOTOR NXTBUF,OLDBUF       Get next old claim item record               
         GOTOR NXTBUF,NEWBUF       Get next new claim item record               
         J     CLMTRN04                                                         
                                                                                
***********************************************************************         
* Deleted entry - back out old postings                               *         
***********************************************************************         
                                                                                
CLMTRN16 OI    STPOSTNG,STNEGATE                                                
         GOTOR BLDTRN,OLD.CL_D     Back out old postings                        
         GOTOR NXTBUF,OLDBUF       Get next old claim item record               
         J     CLMTRN04                                                         
                                                                                
***********************************************************************         
* New entry added - create new postings                               *         
***********************************************************************         
                                                                                
CLMTRN18 GOTOR BLDTRN,NEW.CL_D     Create new postings                          
         GOTOR NXTBUF,NEWBUF       Get next new claim record                    
         J     CLMTRN04                                                         
                                                                                
CLMTRNX  J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Get first/next record from old or new claim buffer                  *         
*                                                                     *         
* Ntry:- R1=TSAR buffer number (old or new)                           *         
* Exit:- Record returned in CL_OLD or CL_NEW - CL_# is set to EFFS if *         
*        the buffer is empty or exhausted                             *         
***********************************************************************         
                                                                                
NXTBUF   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*NXTBUF*'                                                      
                                                                                
                                                                                
         STC   R1,MYBYTE1                                                       
         LA    R7,CL_OLD           Point to correct output record               
         CLI   MYBYTE1,OLDBUF                                                   
         JE    *+8                                                              
         LA    R7,CL_NEW                                                        
         CLC   CL_#,EFFS           Shouldn't be here if EOF is set              
         JNE   NXTBUF02                                                         
         DC    H'0'                                                             
                                                                                
NXTBUF02 LHI   RF,TSARDH           Set to do read high (first time)             
         OC    CL_#,CL_#           Test record read previously                  
         JZ    *+8                                                              
         LHI   RF,TSANXT           Yes - get next record                        
         LLC   R0,MYBYTE1                                                       
         GOTOR BUFCLM,DMCB,((RF),(R0)),CL_D                                     
         TM    CLMERR,TSEEOF       Test end of file                             
         JZ    NXTBUF06                                                         
         MVC   CL_#,EFFS           Set buffer is empty/exhausted                
         J     NXTBUFX                                                          
                                                                                
NXTBUF06 CLI   MYBYTE1,OLDBUF      Build before buffer?                         
         JE    NXTBUF08                                                         
         TM    TR_ST1NW,EXCSCOMP   No - is claim now fully approved?            
         JO    NXTBUF10            Yes                                          
         J     NXTBUF02            No - get next record                         
                                                                                
NXTBUF08 TM    HD_ST1FR,EXCSCOMP   Was claim previously fully approved?         
         JNO   NXTBUF02            No                                           
                                                                                
                                                                                
NXTBUF10 OC    CL_XDAT#,CL_XDAT#                                                
         JNZ   NXTBUF02                                                         
         CLI   CL_ITYPE,CS_IADVQ   Ignore advances                              
         JE    NXTBUF02                                                         
         TM    CL_STAT,CIDMSID     Ignore items marked as deleted               
         JNZ   NXTBUF02                                                         
                                                                                
         XR    RE,RE               Clear extra data element table               
         XR    RF,RF                                                            
         LAY   R0,XDFELTAB                                                      
         LHI   R1,L'XDFELTAB                                                    
         MVCL  R0,RE                                                            
         LAY   R3,XDFELTAB                                                      
                                                                                
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO1  Clear IO1 to read XDFRECs             
                                                                                
         MVC   SVCLKEY,CL_KEY      Save Tsar record key to restore rec          
                                                                                
NXTBUF12 LLC   R0,MYBYTE1                                                       
         GOTOR BUFCLM,DMCB,('TSANXT',(R0)),CL_D  Get next record                
         TM    CLMERR,TSEEOF       Test end of file                             
         JZ    NXTBUF14                                                         
         J     NXTBUF30                                                         
                                                                                
NXTBUF14 CLC   CL_ITEM#,SVCLKEY    Ensure item number matches                   
         JNE   NXTBUF30            No - must be at end                          
         OC    CL_XDAT#,CL_XDAT#   Should be an extra data item                 
         JNZ   *+6                 If not die                                   
         DC    H'0'                                                             
         USING XDFPASD,R2                                                       
NXTBUF16 L     R2,AIO1                                                          
         CLC   XDFPPTR(L'XDFXPTX),CL_XDAT# Don't read same XDFREC again         
         JE    NXTBUF20                                                         
         LA    R2,IOKEY            Read XDFRECD using passives                  
         XC    IOKEY,IOKEY                                                      
         MVI   XDFPTYP,XDFPTYPQ                                                 
         MVI   XDFPSUB,XDFPSUBQ                                                 
         MVC   XDFPCPY,CUXCPY                                                   
         MVC   XDFPPTR(L'XDFXPTX),CL_XDAT#                                      
*                                                                               
NXTBUF18 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         CLC   IOKEYSAV(XDFPSEQ-XDFPASD),IOKEY                                  
         JE    *+6                                                              
         DC    H'0'                Die if we can't find labels                  
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
*                                                                               
         USING XDFRECD,R2                                                       
         L     R2,AIO1                                                          
NXTBUF20 LA    R2,XDFRFST                                                       
         XR    R0,R0                                                            
XDFR     USING XDFELD,R2                                                        
NXTBUF22 CLI   XDFR.XDFEL,0        If element not found die                     
         JNE   *+6                                                              
         DC    H'0'                                                             
         CLI   XDFR.XDFEL,XDFELQ                                                
         JE    NXTBUF26                                                         
NXTBUF24 IC    R0,XDFR.XDFLN       Bump to next element                         
         AR    R2,R0                                                            
         J     NXTBUF22                                                         
*                                                                               
NXTBUF26 CLC   XDFR.XDFSEQ,CL_XDAT#+L'XDFPPTR                                   
         JNE   NXTBUF24            Skip if seq number doesn't match             
TRN      USING XDFELD,R3                                                        
         MVI   TRN.XDFEL,XDFELQ                                                 
         XR    R1,R1                                                            
         IC    R1,XDFR.XDFLN                                                    
         SHI   R1,XDFLN1Q                                                       
         LTR   R1,R1                                                            
         JNZ   *+6                                                              
         DC    H'0'                                                             
         SHI   R1,1                                                             
         MVC   TRN.XDFXEDIT,XDFR.XDFEDIT                                        
         BASR  RE,0                                                             
         MVC   TRN.XDFXDATA(0),XDFR.XDFNAME Store header name                   
         EX    R1,0(RE)                                                         
         AHI   R1,1                                                             
         STCM  R1,1,TRN.XDFXDALN   Store length                                 
         AHI   R1,2                                                             
         XR    RE,RE                                                            
         IC    RE,CL_XCHLN                                                      
         LTR   RE,RE                                                            
         JNZ   *+6                                                              
         DC    H'0'                                                             
         AHI   RE,1                                                             
         LR    R2,R1                                                            
         AR    R2,RE                                                            
         AHI   R2,XDFSEQL                                                       
         STC   R2,TRN.XDFLN                                                     
         AR    R3,R1                                                            
         SHI   R3,1                                                             
         SHI   RE,2                                                             
         BASR  RF,0                                                             
         MVC   TRN.XDFXDATA(0),CL_XCHAR  Move data back in                      
         EX    RE,0(RF)                                                         
         AHI   RE,1                                                             
         STC   RE,TRN.XDFXDALN     Store lenght of data                         
         SR    R3,R1                                                            
         AHI   R3,1                Move forward to counter XDFXEDIT             
         AR    R3,R2                                                            
         J     NXTBUF12                                                         
                                                                                
NXTBUF30 MVC   CL_KEY(CL_ROW#L),SVCLKEY Read for record read previously         
         LLC   R0,MYBYTE1                                                       
         GOTOR BUFCLM,DMCB,('TSARDH',(R0)),CL_D                                 
         TM    CLMERR,TSEEOF       Test end of file                             
         JZ    NXTBUFX                                                          
         MVC   CL_#,EFFS           Set buffer is empty/exhausted                
         J     NXTBUFX                                                          
                                                                                
NXTBUFX  J     EXIT                                                             
         DROP  XDFR,TRN                                                         
         EJECT                                                                  
***********************************************************************         
* Build transactions                                                  *         
***********************************************************************         
                                                                                
BLDTRN   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*BLDTRN*'                                                      
                                                                                
         LR    R7,R1               Point to CL_D                                
                                                                                
BLDTRN04 ZAP   AMTAGRS,CL_AMT      Set gross (agency currency)                  
         SP    AMTAGRS,CL_NONVT    Subtract non vat amount                      
         ZAP   AMTENET,CL_NET      Set net (expense currency)                   
         SP    AMTENET,CL_NONVT    Subtract non vat amount                      
         ZAP   AMTEDSC,CL_DAMT     Set discount (expense currency)              
*&&UK                                                                           
         CLC   HD_CURR,CL_FCUR     Test if in agency currency                   
         JNE   BLDTRN06                                                         
*&&                                                                             
         ZAP   AMTEGRS,AMTAGRS     Gross (expense) = gross (agency)             
         ZAP   AMTANET,AMTENET     Net (agency) = net (expense)                 
         ZAP   AMTADSC,AMTEDSC     Discount (agy) = discount (expense)          
         J     BLDTRN10                                                         
*                                                                               
*&&UK                                                                           
BLDTRN06 ZAP   DUB,AMTENET         Convert expense net to agency net            
         USING EURKBLKD,ELEMENT                                                 
         XC    EURKBLKD(EURKBLKL),EURKBLKD                                      
         MVC   EURKCUFR,HD_CURR                                                 
         MVC   EURKCUTO,CL_FCUR                                                 
         MVC   EURKALPH,CUAALF                                                  
         MVC   EURKDATE,HD_TODC                                                 
         MVC   EURKAFAC,ACOMFACS                                                
         MVI   EURKTYPE,ACCQ                                                    
         OI    EURKTYPE,ALLOWFTQ+SWAPQ                                          
         GOTO1 VEUREKA,PARM,('GETQ',EURKBLKD)                                   
         CLI   0(R1),0                                                          
         JE    *+6                                                              
         DC    H'0'                                                             
         MVC   EXRULE,EURKRULE                                                  
*                                                                               
         ZAP   AMTEGRS,CL_FAMT     Set gross (expense currency)                 
         CP    AMTENET,AMTEGRS     Test net = gross                             
         JNE   BLDTRN08                                                         
         ZAP   AMTANET,AMTAGRS                                                  
         J     BLDTRN09                                                         
                                                                                
BLDTRN08 XC    EURKBLKD(EURKBLKL),EURKBLKD                                      
         MVC   EURKCUFR,HD_CURR                                                 
         MVC   EURKCUTO,CL_FCUR                                                 
         MVC   EURKRULE,CL_XRT                                                  
         MVC   EURKRLST,EXRULE+EURKRLST-EURKRULE                                
         MVC   EURKRLSH,EXRULE+EURKRLSH-EURKRULE                                
         GOTO1 VEUREKA,PARM,('INVERTQ+APPLYQ',EURKBLKD),DUB,DUB                 
         ZAP   AMTANET,DUB                                                      
*                                                                               
BLDTRN09 ZAP   AMTADSC,PZERO                                                    
         ZAP   DUB,AMTEDSC         Convert expense disc to agy disc             
         CP    DUB,PZERO                                                        
         JE    BLDTRN10                                                         
         XC    EURKBLKD(EURKBLKL),EURKBLKD                                      
         MVC   EURKCUFR,HD_CURR                                                 
         MVC   EURKCUTO,CL_FCUR                                                 
         MVC   EURKRULE,CL_XRT                                                  
         MVC   EURKRLST,EXRULE+EURKRLST-EURKRULE                                
         MVC   EURKRLSH,EXRULE+EURKRLSH-EURKRULE                                
         GOTO1 VEUREKA,PARM,('INVERTQ+APPLYQ',EURKBLKD),DUB,DUB                 
         ZAP   AMTADSC,DUB                                                      
*&&                                                                             
BLDTRN10 ZAP   AMTAVAT,AMTAGRS     Set VAT (agency currency)                    
         SP    AMTAVAT,AMTANET                                                  
         ZAP   AMTEVAT,AMTEGRS     Set VAT (expense currency)                   
         SP    AMTEVAT,AMTENET                                                  
         ZAP   AMTANETM,PZERO      Set -NET (agency currency)                   
         SP    AMTANETM,AMTANET                                                 
         ZAP   AMTENETM,PZERO      Set -NET (expense currency)                  
         SP    AMTENETM,AMTENET                                                 
         SP    AMTAGRS,AMTADSC     Remove discount from gross                   
         SP    AMTEGRS,AMTEDSC                                                  
         CLI   CL_CLICD,NOQ        If posting discount to income                
         JE    BLDTRN12                                     account             
         SP    AMTANET,AMTADSC     subtract discount from net also              
         SP    AMTENET,AMTEDSC                                                  
                                                                                
BLDTRN12 GOTO1 VDATCON,PARM,(2,CL_ADAT),(1,POSDATE)                             
*&&UK*&& MVI   POSSTAT,TRNSAUTH    ALL TRANSACTINS ARE AUTHORISED               
*                                                                               
         CLI   CL_ITYPE,CS_INONQ   Test non-billable                            
         JNE   BLDTRN14                                                         
*&&US*&& MVI   POSOBTYP,10         Always type 10 for US                        
*&&UK*&& MVI   POSOBTYP,21         Yes - override batch type = 21               
         J     BLDTRN16                                                         
BLDTRN14 CLI   CL_ITYPE,CS_IBILQ   Test billable                                
         JE    *+6                                                              
         DC    H'0'                                                             
*&&US*&& MVI   POSOBTYP,10         Leave as type 10 for US                      
*&&UK*&& MVI   POSOBTYP,1          Yes - ovveride batch type = 1                
*                                                                               
BLDTRN16 GOTOR OPNBAT              Initialise batch header record               
         CP    CL_NONVT,CL_AMT     If the non vatable amount matches            
         JE    BLDTRN18            the total amount there is no 1st pst         
         GOTOR OPNITM              Initialise batch item record                 
         GOTOR PSTNET              Net posting                                  
*&&UK*&& GOTOR PSTVAT              VAT posting (UK)                             
*&&US*&& GOTOR PSTGPT              GST/PST VAT posting for Canada               
         GOTOR PSTMEMO             Memo job posting                             
         GOTOR PSTGRS              Gross posting                                
*&&US*&& GOTOR PSTDISC             Discount posting                             
         GOTOR PSTDEPT             Department postings                          
         GOTOR PSTSTAFF            Staff posting                                
         GOTOR PSTANAL             Analysis posting                             
         GOTOR CLOITM              Close batch item record                      
         OI    STPOSTNG,STPOSTG1   Set posting one made                         
BLDTRN18 CP    CL_NONVT,PZERO      Do we need to create 2nd posting             
         JE    BLDTRNX                   for non vatable element                
         OI    STPOSTNG,STMILVAT                                                
         ZAP   AMTAGRS,CL_NONVT    Yes                                          
         ZAP   AMTENET,CL_NONVT                                                 
         ZAP   AMTEGRS,AMTAGRS                                                  
         ZAP   AMTANET,AMTENET                                                  
         ZAP   AMTAVAT,PZERO       Set VAT (agency currency)                    
         ZAP   AMTEVAT,PZERO                                                    
         ZAP   AMTANETM,PZERO      Set -NET (agency currency)                   
         SP    AMTANETM,AMTANET                                                 
         ZAP   AMTENETM,PZERO      Set -NET (expense currency)                  
         SP    AMTENETM,AMTENET                                                 
         GOTOR OPNITM              Initialise batch item record                 
         GOTOR PSTNET              Net posting                                  
*&&UK*&& GOTOR PSTVAT              VAT posting  (UK)                            
*&&US*&& GOTOR PSTGPT              GST/PST VAT posting for Canada               
         GOTOR PSTMEMO             Memo job posting                             
         GOTOR PSTGRS              Gross posting                                
         GOTOR PSTDEPT             Department postings                          
         GOTOR PSTSTAFF            Staff posting                                
         GOTOR PSTANAL             Analysis posting                             
         GOTOR CLOITM              Close batch item record                      
                                                                                
BLDTRNX  NI    STPOSTNG,FF-(STNEGATE+STMILVAT+STPOSTG1)                         
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* Initialise batch item record                                        *         
***********************************************************************         
                                                                                
OPNBAT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*OPNBAT*'                                                      
                                                                                
                                                                                
         TM    STPOSTNG,STNEGATE   Making negative posting                      
         JZ    OPNBAT02            No                                           
         TM    HD_PIND,HD_PBINR    Have we already opened revs batch            
         JNZ   EXITY               Yes nothing to do                            
         L     R2,ATBHRECR         Use different IO area for reversal           
         ZAP   POSBTOTR,PZERO      Zero total for batch                         
         XC    POSITMSR,POSITMSR   Zero item count for                          
         OI    HD_PIND,HD_PBINR    Set we opened reversal batch                 
         J     OPNBAT04                                                         
                                                                                
OPNBAT02 TM    HD_PIND,HD_PBINI    Have we already opened batch                 
         JNZ   EXITY               Yes nothing to do                            
         ZAP   POSBTOT,PZERO       Zero total for batch                         
         XC    POSITMS,POSITMS                                                  
         OI    HD_PIND,HD_PBINI    Set we opened batch                          
         L     R2,ATBHREC          Initialise batch header record               
         USING TBARECD,R2                                                       
OPNBAT04 XC    TBARECD(TBARFST+1-TBARECD),TBARECD                               
         LHI   RF,TBARFST+1-TBARECD                                             
         STH   RF,TBARLEN                                                       
         MVI   TBAKTYP,TBAKTYPQ                                                 
         MVC   TBAKCPY,CUXCPY                                                   
         MVC   TBAKUSER,CUUSER                                                  
         MVC   TBAKADDT,HD_TODC                                                 
         XC    TBAKADDT,EFFS                                                    
*&&UK*&& MVI   TBAKGRUP,TBAGGENQ                                                
*&&US*&& MVI   TBAKGRUP,TBAGPRDQ                                                
                                                                                
*&&UK*&& MVI   TBAKBTYP,70                                                      
*&&US*&& MVI   TBAKBTYP,10                                                      
         MVC   TBAKBMOS,HD_MOA                                                  
         MVC   TBAKBREF,QH_BREF                                                 
         MVC   TBAKBCHR,CCTPID                                                  
         CLI   CUACCS,C'*'         Are we limit access                          
         JNE   OPNBAT05                                                         
         MVC   TBAKOFFC(1),CUACCS+1                                             
         TM    CPYSTAT4,CPYSOFF2   Is it 2 char offices                         
         JZ    OPNBAT05                                                         
         MVC   TBAKOFFC,CUACCS+2   Yes                                          
                                                                                
OPNBAT05 MVI   TBARHSTA,TBAHSUPD                                                
         MVC   TBAHRADT,HD_TODC    Date batch added                             
         MVC   TBAHREDT,HD_TODC    Effective date                               
         MVC   TBAHRUDT,HD_TODC    Date batch updated                           
*&&DO*&& OI    TBAHRIND,TBAHIGDJ   Turning this bit on means do not             
*                                  display item/display screen sfseld           
                                                                                
K        USING TBARECD,IOKEY                                                    
OPNBAT06 MVC   K.TBAKEY,TBAKEY                                                  
         XC    K.TBAKTSEQ,K.TBAKTSEQ                                            
         L     R1,=AL4(IOHID+IODIR+IO1)                                         
         GOTOR (#IOEXEC,AIOEXEC)                                                
         CLC   K.TBAKEY(TBAKOFFC-TBAKEY),TBAKEY                                 
         JNE   OPNBAT08                                                         
         CLI   TBAKSEQN,FF         Error if all sequence's used                 
         JNE   *+6                                                              
         DC    H'0'                                                             
         IC    RE,TBAKSEQN         Increment sequence number                    
         AHI   RE,1                                                             
         STC   RE,TBAKSEQN                                                      
         J     OPNBAT06                                                         
                                                                                
N        USING BHDELD,ELEMENT                                                   
OPNBAT08 XC    N.BHDELD(BHDLNQ),N.BHDELD                                        
         MVI   N.BHDEL,BHDELQ                                                   
         MVI   N.BHDLN,BHDLNQ                                                   
         MVC   N.BHDNAME,QH_BNAM                                                
         ZAP   N.BHDCASHC,PZERO                                                 
         ZAP   N.BHDCASHA,PZERO                                                 
*&&UK*&& MVC   N.BHDLUID,CUTSYM                                                 
*&&US*&& MVC   N.BHDLUID,SPACES                                                 
         MVC   N.BHDIBNO,CCTPID                                                 
         MVC   N.BHDAPRVR,CCTPID                                                
         TM    STPOSTNG,STNEGATE   Making negative posting                      
         JZ    OPNBAT10                                                         
         OI    N.BHDSTAT1,BHDSNREV   Set as reversal                            
OPNBAT10 MVI   N.BHDPRGNO,RCVPBRAQ                                              
         GOTOR ADDELE,TBARECD                                                   
*                                                                               
N        USING FFTELD,ELEMENT                                                   
         XC    ELEMENT,ELEMENT                                                  
         MVI   N.FFTEL,FFTELQ      Add comments                                 
         MVI   N.FFTTYPE,FFTTFREE                                               
         MVI   N.FFTSEQ,1                                                       
         MVI   N.FFTLN,FFTLN1Q                                                  
         GOTOR BATCOM,QH_BCOML                                                  
         CLI   N.FFTLN,FFTLN1Q                                                  
         JNH   OPNBAT12                                                         
         GOTOR ADDELE,TBARECD                                                   
                                                                                
OPNBAT12 J     EXITY                                                            
         DROP  N,K                                                              
**********************************************************************          
* Build comments for batch                                           *          
**********************************************************************          
                                                                                
N        USING FFTELD,ELEMENT                                                   
BATCOM   NTR1  ,                                                                
         XR    RE,RE                                                            
         ICM   RE,1,0(R1)          RE = L(comment)                              
         JZ    EXIT                                                             
         LA    RF,1(R1)            RF = A(comment)                              
         LA    R3,0(RE,RF)                                                      
         SHI   R3,1                R3 = A(Last character)                       
BCOM02   CLI   0(R3),C' '          Remove trailing blanks                       
         JH    BCOM04                                                           
         SHI   R3,1                                                             
         JCT   RE,BCOM02                                                        
         J     EXIT                Effectively zero length                      
                                                                                
BCOM04   XR    R2,R2                                                            
         IC    R2,N.FFTLN                                                       
         LA    R3,N.FFTELD(R2)                                                  
         USING FFTDLEN,R3                                                       
         STC   RE,FFTDLEN                                                       
         SHI   RE,1                                                             
         BASR  R1,0                                                             
         MVC   FFTDATA(0),0(RF)                                                 
         EX    RE,0(R1)                                                         
         LA    R2,2(RE,R2)                                                      
         CHI   R2,X'FF'                                                         
         JNH   *+6                                                              
         DC    H'0'                                                             
         STC   R2,N.FFTLN                                                       
         J     EXIT                                                             
         DROP  N,R3                                                             
         EJECT                                                                  
                                                                                
***********************************************************************         
* Initialise batch item record                                        *         
***********************************************************************         
                                                                                
OPNITM   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*OPNITM*'                                                      
                                                                                
         ZAP   POSTOTDR,PZERO                                                   
         ZAP   POSTOTCR,PZERO                                                   
                                                                                
         TM    STPOSTNG,STNEGATE   Making negative posting                      
         JZ    OPNITM02            No                                           
         LH    RE,POSITMSR         Increment item count                         
         AHI   RE,1                                                             
         STH   RE,POSITMSR                                                      
         SP    POSBTOTR,AMTAGRS                                                 
         L     R2,ATBARECR         Use different IO area for reversals          
         J     OPNITM04                                                         
                                                                                
OPNITM02 LH    RE,POSITMS          Increment item count                         
         AHI   RE,1                                                             
         STH   RE,POSITMS                                                       
         AP    POSBTOT,AMTAGRS                                                  
         L     R2,ATBAREC                                                       
                                                                                
         USING TBARECD,R2                                                       
OPNITM04 XC    TBARECD(TBARFST+1-TBARECD),TBARECD                               
         L     RF,ATBHREC                                                       
         MVC   TBAKEY,0(RF)                                                     
         MVC   TBAKTSEQ,POSITMS                                                 
         LHI   RF,TBARFST+1-TBARECD                                             
         STH   RF,TBARLEN                                                       
                                                                                
N        USING BIAELD,ELEMENT                                                   
         XC    N.BIAELD(BIALNQ),N.BIAELD                                        
         MVI   N.BIAEL,BIAELQ                                                   
         MVI   N.BIALN,BIALNQ                                                   
         ZAP   N.BIAAMT,AMTAGRS                                                 
         TM    STPOSTNG,STNEGATE   Making reversal (negative) posting           
         JNO   OPNITM06                                                         
         ZAP   DUB,N.BIAAMT                                                     
         MP    DUB,PNEGONE                                                      
         ZAP   N.BIAAMT,DUB                                                     
OPNITM06 MVC   N.BIAREF,CL_REF                                                  
         GOTOR ADDELE,TBARECD                                                   
         J     EXITY                                                            
         DROP  N,R2                                                             
***********************************************************************         
* Update item after posting has been added                            *         
***********************************************************************         
                                                                                
UPDITM   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*UPDITM*'                                                      
                                                                                
         L     R2,ATBAREC                                                       
         TM    STPOSTNG,STNEGATE   Making negative posting                      
         JZ    UPDITM02            No                                           
         L     R2,ATBARECR         Yes - use different IO area                  
         USING TBARECD,R2                                                       
UPDITM02 L     R4,ATRNREC                                                       
         USING TRNRECD,R4                                                       
N        USING TRNELD,TRNRFST                                                   
                                                                                
         TM    N.TRNSTAT,TRNSDR      UPDATE DEBIT/CREDIT ITEM TOTAL             
         JZ    UPDITM04                                                         
         AP    POSTOTDR,N.TRNAMNT                                               
         J     UPDITM06                                                         
UPDITM04 AP    POSTOTCR,N.TRNAMNT                                               
                                                                                
N        USING ASKELD,ELEMENT                                                   
UPDITM06 MVI   N.ASKEL,ASKELQ                                                   
         MVI   N.ASKLN,ASKLNQ                                                   
         MVI   N.ASKSEQN,0                                                      
         MVC   N.ASKKEY,TRNKEY                                                  
                                                                                
         GOTOR ADDELE,TBARECD                                                   
         J     EXITY                                                            
         DROP  N,R2,R4                                                          
***********************************************************************         
* Close item after last posting has been added                        *         
***********************************************************************         
                                                                                
CLOITM   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*CLOITM*'                                                      
         CP    POSTOTDR,POSTOTCR   ITEM MUST BALANCE                            
         JE    *+6                                                              
         DC    H'0'                                                             
         TM    STPOSTNG,STNEGATE   Making negative posting                      
         JZ    CLOITM02            No                                           
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO4'                           
         JE    EXITY                                                            
         DC    H'0'                                                             
CLOITM02 GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO1'                           
         JE    EXITY                                                            
         DC    H'0'                                                             
***********************************************************************         
* Close batch                                                         *         
***********************************************************************         
         SPACE 1                                                                
                                                                                
CLOBAT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*CLOBAT*'                                                      
         L     R2,ATBHREC                                                       
         USING TBARECD,R2                                                       
N        USING BHDELD,TBARFST                                                   
                                                                                
         OI    TBARHSTA,TBAHSUPD                                                
         MVC   N.BHDITEMC,POSITMS    Items control total                        
         MVC   N.BHDITEMA,POSITMS    Items input                                
         ZAP   N.BHDCASHC,POSBTOT    Cash control total                         
         ZAP   N.BHDCASHA,POSBTOT    Cash total                                 
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO3'                           
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  N                                                                
         EJECT                                                                  
***********************************************************************         
* Close reversal bacth                                                *         
***********************************************************************         
         SPACE 1                                                                
                                                                                
CLOBATR  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*CLOBATR'                                                      
         L     R2,ATBHRECR                                                      
         USING TBARECD,R2                                                       
N        USING BHDELD,TBARFST                                                   
                                                                                
         OI    TBARHSTA,TBAHSUPD                                                
         MVC   N.BHDITEMC,POSITMSR   Items control total                        
         MVC   N.BHDITEMA,POSITMSR   Items input                                
         ZAP   N.BHDCASHC,POSBTOTR   Cash control total                         
         ZAP   N.BHDCASHA,POSBTOTR   Cash total                                 
         GOTOR (#IOEXEC,AIOEXEC),'IOADDREC+IOMST+IO5'                           
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  N                                                                
         EJECT                                                                  
***********************************************************************         
* Post Net postings                                                   *         
* if billable to SJ contra creditor contra                            *         
* if non-billable to Expense account contra creditor account          *         
***********************************************************************         
                                                                                
PSTNET   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*PSTNET*'                                                      
                                                                                
         L     R2,ATRNREC                                                       
         USING TRNRECD,R2                                                       
         XC    TRNRECD(TRNRFST-TRNRECD),TRNRECD                                 
         MVC   TRNKCPY,CUXCPY                                                   
         CLI   CL_ITYPE,CS_INONQ   Non-billable item                            
         JE    PSTNET02            Yes - post to expense account                
*&&US*&& CLI   CL_EXPJB,YESQ       If billable & job is an expense job          
*&&US*&& JE    PSTNET02            then treat it as non-billable                
         MVC   TRNKULA(L'PRODUL),PRODUL No billable post to production          
         MVC   TRNKACT,CL_SJAC     SJ account                                   
         MVC   TRNKWORK,CL_WC      Task code                                    
         J     PSTNET04                                                         
                                                                                
PSTNET02 MVC   TRNKULA,CL_EXAC                                                  
         MVC   TRNKOFF,CL_OFF      Posting office                               
         TM    CPYSTAT4,CPYSOFF2                                                
         JO    *+10                                                             
         MVC   TRNKOFF,SPACES      Old offices = no office in key               
                                                                                
PSTNET04 MVI   POSTYPE,POSTDR      Debit                                        
         ZAP   POSAMNT,AMTANET                                                  
         MVC   TRNKCCPY,CUXCPY                                                  
         MVC   TRNKULC,CL_SUPAC                                                 
         MVC   TRNKDATE,POSDATE                                                 
         MVC   TRNKREF,CL_REF                                                   
                                                                                
         GOTOR EL_TRN                                                           
         GOTOR EL_MIL                                                           
*&&UK*&& GOTOR EL_VAT                                                           
                                                                                
         CLI   CL_CLICD,NOQ        Are we posting discount to income            
         JE    PSTNET06            Yes                                          
         GOTOR EL_DISC             No - need to show discount on net            
PSTNET06 GOTOR EL_TRS                                                           
*&&UK*&& GOTOR EL_AFC                                                           
         GOTOR EL_APE                                                           
         GOTOR EL_PID                                                           
         GOTOR EL_XDF                                                           
         GOTOR EL_ORD                                                           
*&&UK*&& GOTOR EL_INT                                                           
         GOTOR EL_EST                                                           
         GOTOR EL_FFTCL                                                         
*&&US*&& GOTOR EL_FFTKR                                                         
*&&US*&& GOTOR EL_FFTIN                                                         
*&&US*&& GOTOR EL_FFTCN                                                         
         GOTOR EL_ETY                                                           
                                                                                
         GOTOR GOATRN,CL_SUNAM     Put transaction record                       
         GOTOR UPDITM                                                           
         J     EXIT                                                             
                                                                                
***********************************************************************         
* Post Vat postings                                                   *         
***********************************************************************         
                                                                                
PSTVAT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*PSTVAT*'                                                      
                                                                                
         L     R2,ATRNREC                                                       
         XC    TRNRECD(TRNRFST-TRNRECD),TRNRECD                                 
         MVC   TRNKCPY,CUXCPY                                                   
         MVC   TRNKULA,CL_VATAC                                                 
         TM    STPOSTNG,STMILVAT                                                
         JZ    *+10                                                             
         MVC   TRNKACT,CL_MVTAC                                                 
         MVC   TRNKOFF,CL_OFF      Posting office                               
         TM    CPYSTAT4,CPYSOFF2                                                
         JO    *+10                                                             
         MVC   TRNKOFF,SPACES      Old offices = no office in key               
                                                                                
         MVI   POSTYPE,POSTDR      Debit                                        
         ZAP   POSAMNT,AMTAVAT                                                  
         MVC   TRNKCCPY,CUXCPY                                                  
         MVC   TRNKULC,CL_SUPAC                                                 
         MVC   TRNKDATE,POSDATE                                                 
         MVC   TRNKREF,CL_REF                                                   
                                                                                
         GOTOR EL_TRN                                                           
         GOTOR EL_NET                                                           
         GOTOR EL_TRS                                                           
*&&UK*&& GOTOR EL_AFC                                                           
         GOTOR EL_APE                                                           
         GOTOR EL_XDF                                                           
         GOTOR EL_ORD                                                           
         GOTOR EL_PID                                                           
         GOTOR EL_EST                                                           
         GOTOR EL_FFTCL                                                         
         GOTOR EL_ETY                                                           
                                                                                
         GOTOR GOATRN,CL_SUNAM     Put transaction record                       
         GOTOR UPDITM                                                           
         J     EXIT                                                             
*&&US                                                                           
***********************************************************************         
* Post GST/PST postings for Canada                                    *         
***********************************************************************         
                                                                                
PSTGPT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*PSTGPT*'                                                      
*                                  For now no mileage VAT for Canada/US         
         L     R2,ATRNREC                                                       
         TM    STPOSTNG,STMILVAT                                                
         JNZ   EXITY                                                            
         CLI   CUCTRY,CTRYCAN      Only posting VAT if Canada                   
         JNE   EXITY                                                            
         CLC   CL_VATAC,SPACES                                                  
         JNH   PSTGPT02                                                         
         XC    TRNRECD(TRNRFST-TRNRECD),TRNRECD                                 
         MVC   TRNKCPY,CUXCPY                                                   
         MVC   TRNKULA,CL_VATAC    GST account                                  
         MVC   TRNKOFF,CL_OFF      Posting office                               
         TM    CPYSTAT4,CPYSOFF2                                                
         JO    *+10                                                             
         MVC   TRNKOFF,SPACES      Old offices = no office in key               
                                                                                
         MVI   POSTYPE,POSTDR      Debit                                        
         ZAP   POSAMNT,CL_GSTA     GST amount                                   
         MVC   TRNKCCPY,CUXCPY                                                  
         MVC   TRNKULC,CL_SUPAC                                                 
         MVC   TRNKDATE,POSDATE                                                 
         MVC   TRNKREF,CL_REF                                                   
                                                                                
         GOTOR EL_TRN                                                           
         GOTOR EL_NET                                                           
         GOTOR EL_TRS                                                           
         GOTOR EL_APE                                                           
         GOTOR EL_XDF                                                           
         GOTOR EL_ORD                                                           
         GOTOR EL_PID                                                           
         GOTOR EL_EST                                                           
         GOTOR EL_FFTCL                                                         
         GOTOR EL_ETY                                                           
                                                                                
         GOTOR GOATRN,CL_SUNAM     Put transaction record                       
         GOTOR UPDITM                                                           
*                                                                               
PSTGPT02 CLC   CL_PSTAC,SPACES                                                  
         JNH   PSTGPTX                                                          
         XC    TRNRECD(TRNRFST-TRNRECD),TRNRECD                                 
         MVC   TRNKCPY,CUXCPY                                                   
         MVC   TRNKULA,CL_PSTAC                                                 
         MVC   TRNKOFF,CL_OFF      Posting office                               
         TM    CPYSTAT4,CPYSOFF2                                                
         JO    *+10                                                             
         MVC   TRNKOFF,SPACES      Old offices = no office in key               
                                                                                
         MVI   POSTYPE,POSTDR      Debit                                        
         ZAP   POSAMNT,CL_PSTA     PST amount                                   
         MVC   TRNKCCPY,CUXCPY                                                  
         MVC   TRNKULC,CL_SUPAC                                                 
         MVC   TRNKDATE,POSDATE                                                 
         MVC   TRNKREF,CL_REF                                                   
                                                                                
         GOTOR EL_TRN                                                           
         GOTOR EL_NET                                                           
         GOTOR EL_TRS                                                           
         GOTOR EL_APE                                                           
         GOTOR EL_XDF                                                           
         GOTOR EL_ORD                                                           
         GOTOR EL_PID                                                           
         GOTOR EL_EST                                                           
         GOTOR EL_FFTCL                                                         
         GOTOR EL_ETY                                                           
                                                                                
         GOTOR GOATRN,CL_SUNAM     Put transaction record                       
         GOTOR UPDITM                                                           
*                                                                               
PSTGPTX  J     EXIT                                                             
*&&                                                                             
***********************************************************************         
* Post memo posting                                                   *         
***********************************************************************         
                                                                                
PSTMEMO  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*PSTMEM*'                                                      
                                                                                
*&&US*&& CLI   CL_EXPJB,YESQ       If billable & job is an expense job          
*&&US*&& JE    PSTMEM02            then treat it as non-billable                
         CLI   CL_ITYPE,CS_INONQ   Non-billable item                            
         JNE   EXITY               No - no memo posting                         
         LLC   RE,PPROLEN                                                       
         LA    R4,CL_SJAC                                                       
         AR    R4,RE                                                            
         CLI   0(R4),C' '                                                       
         JNH   EXITY                                                            
                                                                                
PSTMEM02 L     R2,ATRNREC                                                       
         XC    TRNRECD(TRNRFST-TRNRECD),TRNRECD                                 
         MVC   TRNKCPY,CUXCPY                                                   
         MVC   TRNKULA(L'PRODUL),PRODUL No billable post to production          
         MVC   TRNKACT,CL_SJAC     SJ account                                   
         MVC   TRNKWORK,CL_WC      Task code                                    
         MVI   POSTYPE,POSTDR      Debit                                        
         ZAP   POSAMNT,PZERO                                                    
         MVC   TRNKCCPY,CUXCPY                                                  
         MVC   TRNKULC,CL_EXAC                                                  
         MVC   TRNKDATE,POSDATE                                                 
         MVC   TRNKREF,CL_REF                                                   
                                                                                
         GOTOR EL_TRN                                                           
*&&US*&& GOTOR EL_MIL                                                           
         GOTOR EL_MEMO                                                          
         GOTOR EL_TRS                                                           
*&&UK*&& GOTOR EL_AFC                                                           
*&&US*&& GOTOR EL_FFTIN                                                         
*&&US*&& GOTOR EL_FFTCN                                                         
         GOTOR EL_APE                                                           
         GOTOR EL_XDF                                                           
         GOTOR EL_PID                                                           
         GOTOR EL_EST                                                           
         GOTOR EL_ETY                                                           
                                                                                
         GOTOR GOATRN,CL_EXNAM     Put transaction record                       
         GOTOR UPDITM                                                           
         J     EXIT                                                             
                                                                                
***********************************************************************         
* Post Gross postings                                                 *         
***********************************************************************         
                                                                                
PSTGRS   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*PSTGRS*'                                                      
                                                                                
         L     R2,ATRNREC                                                       
         XC    TRNRECD(TRNRFST-TRNRECD),TRNRECD                                 
         MVC   TRNKCPY,CUXCPY                                                   
         MVC   TRNKULA,CL_SUPAC                                                 
         MVC   TRNKOFF,CL_OFF      Posting office                               
         TM    CPYSTAT4,CPYSOFF2                                                
         JO    *+10                                                             
         MVC   TRNKOFF,SPACES      Old offices = no office in key               
         MVC   TRNKCCPY,CUXCPY                                                  
                                                                                
*&&US                                                                           
         MVC   TRNKULC,SPACES                                                   
         LA    R4,CL_SJAC                                                       
         LLC   RE,PPROLEN                                                       
         AR    R4,RE               R4=A(Job)                                    
         CLI   0(R4),C' '          Have we got a job                            
         JH    *+12                yes                                          
         CLI   CL_ITYPE,CS_INONQ                                                
         JE    PSTGRS02                                                         
         SR    R1,R1               BUILD CONTRA                                 
         IC    R1,PCLILEN                                                       
         SHI   R1,1                R1=Length of client minus 1                  
         MVC   TRNKULC(L'PRODUL),PRODUL                                         
         BASR  RE,0                                                             
         MVC   TRNKCACT(0),CL_SJAC C/A =client                                  
         EX    R1,0(RE)                                                         
         MVC   POSDUMNM,CL_CLINM   Use client name in contra                    
         J     PSTGRS04                                                         
                                                                                
PSTGRS02 MVC   TRNKULC,CL_EXAC                                                  
         MVC   POSDUMNM,CL_EXNAM                                                
         J     PSTGRS04                                                         
*&&                                                                             
                                                                                
*&&UK                                                                           
         MVC   TRNKULC(L'PRODUL),PRODUL                                         
         MVC   TRNKCACT,SPACES                                                  
         MVC   TRNKCACT(3),ACT999                                               
         MVC   POSDUMNM,AC@ALLCS                                                
*&&                                                                             
                                                                                
PSTGRS04 ZAP   POSAMNT,AMTAGRS                                                  
         MVC   TRNKDATE,POSDATE                                                 
         MVC   TRNKREF,CL_REF                                                   
         MVI   POSTYPE,POSTCR      Credit                                       
         TM    CL_STAT,CIDMSSS     Test selected status is on                   
         JZ    *+8                                                              
         OI    POSSTAT,TRNSAPPR    Yes - set approved                           
                                                                                
         GOTOR EL_TRN                                                           
*&&US*&& GOTOR EL_MIL                                                           
         GOTOR EL_DISC                                                          
*&&UK*&& GOTOR EL_CPJ                                                           
*&&US                                                                           
         LA    R4,CL_SJAC                                                       
         LLC   RE,PPROLEN                                                       
         AR    R4,RE               R4=A(Job)                                    
         CLI   0(R4),C' '          Have we got a job                            
         JH    *+12                yes                                          
         CLI   CL_ITYPE,CS_INONQ                                                
         JE    *+8                                                              
         GOTOR EL_PRJB                                                          
*&&                                                                             
*&&US*&& GOTOR EL_WRKC                                                          
         GOTOR EL_TRS                                                           
*&&UK*&& GOTOR EL_AFC                                                           
         GOTOR EL_APE                                                           
         GOTOR EL_XDF                                                           
         GOTOR EL_NUM                                                           
         GOTOR EL_ORD                                                           
*&&UK*&& GOTOR EL_INT                                                           
         GOTOR EL_PID                                                           
         GOTOR EL_EST                                                           
         GOTOR EL_FFTCL                                                         
*&&US*&& GOTOR EL_FFTKR                                                         
*&&US*&& GOTOR EL_FFTIN                                                         
*&&US*&& GOTOR EL_FFTCN                                                         
         GOTOR EL_ETY                                                           
                                                                                
         GOTOR GOATRN,POSDUMNM     Put transaction record                       
         GOTOR UPDITM                                                           
         NI    POSSTAT,FF-TRNSAPPR                                              
         J     EXITY                                                            
                                                                                
***********************************************************************         
* Post discount posting                                               *         
***********************************************************************         
                                                                                
*&&US                                                                           
PSTDISC  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*PSTDISC'                                                      
                                                                                
         CLC   CL_DSULA,SPACES     Have we got discount to post                 
         JNH   EXITY                                                            
         CLI   CL_CLICD,NOQ        Are we posting to income                     
         JNE   EXITY               No - don't create posting                    
         L     R2,ATRNREC                                                       
         XC    TRNRECD(TRNRFST-TRNRECD),TRNRECD                                 
         MVC   TRNKCPY,CUXCPY                                                   
         MVC   TRNKULA,CL_DSULA                                                 
         MVC   TRNKOFF,CL_OFF      Posting office                               
         TM    CPYSTAT4,CPYSOFF2                                                
         JO    *+10                                                             
         MVC   TRNKOFF,SPACES      Old offices = no office in key               
         MVC   TRNKCCPY,CUXCPY                                                  
         MVC   TRNKULC,CL_SUPAC                                                 
                                                                                
         ZAP   POSAMNT,AMTADSC                                                  
         MVC   TRNKDATE,POSDATE                                                 
         MVC   TRNKREF,CL_REF                                                   
         MVI   POSTYPE,POSTCR      Credit                                       
                                                                                
         GOTOR EL_TRN                                                           
         GOTOR EL_WRKC                                                          
         GOTOR EL_TRS                                                           
         GOTOR EL_APE                                                           
         GOTOR EL_XDF                                                           
         GOTOR EL_PID                                                           
         GOTOR EL_EST                                                           
         GOTOR EL_FFTCL                                                         
         GOTOR EL_ETY                                                           
                                                                                
         GOTOR GOATRN,CL_SUNAM     Put transaction record                       
         GOTOR UPDITM                                                           
         J     EXITY                                                            
*&&                                                                             
***********************************************************************         
* Post department posting                                             *         
***********************************************************************         
                                                                                
PSTDEPT  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*PSTDEPT'                                                      
                                                                                
         CLC   CL_2DAC,SPACES      Have we got dept                             
         JNH   EXITY               No - nothing to do                           
         TM    CL_ESTA1,RSTSEADD   Have we got department postings to           
         JZ    EXITY                                            make            
*&&UK                                                                           
         CLI   CL_ITYPE,CS_INONQ   Non-billable item                            
         JNE   EXITY               No dept postings                             
*&&                                                                             
                                                                                
         L     R2,ATRNREC                                                       
         XC    TRNRECD(TRNRFST-TRNRECD),TRNRECD                                 
         MVC   TRNKCPY,CUXCPY                                                   
         MVC   TRNKUNT(L'LEDGER2D),LEDGER2D                                     
         MVC   TRNKACT,CL_2DAC                                                  
         MVC   TRNKOFF,CL_OFF      Posting office                               
         TM    CPYSTAT4,CPYSOFF2                                                
         JO    *+10                                                             
         MVC   TRNKOFF,SPACES      Old offices = no office in key               
         MVC   TRNKCCPY,CUXCPY                                                  
         MVC   TRNKULC,CL_28ULA                                                 
                                                                                
         ZAP   POSAMNT,AMTANET                                                  
         MVC   TRNKDATE,POSDATE                                                 
         MVC   TRNKREF,CL_REF                                                   
         MVI   POSTYPE,POSTDR      Debit                                        
                                                                                
         GOTOR EL_TRN                                                           
         GOTOR EL_TRS                                                           
         GOTOR EL_APE                                                           
         GOTOR EL_XDF                                                           
         GOTOR EL_PID                                                           
         GOTOR EL_EST                                                           
         GOTOR EL_FFTCL                                                         
         GOTOR EL_ETY                                                           
                                                                                
         GOTOR GOATRN,CL_28NAM     Put transaction record                       
         GOTOR UPDITM                                                           
                                                                                
         L     R2,ATRNREC                                                       
         XC    TRNRECD(TRNRFST-TRNRECD),TRNRECD                                 
         MVC   TRNKCPY,CUXCPY                                                   
         MVC   TRNKULA,CL_28ULA                                                 
         MVC   TRNKOFF,CL_OFF      Posting office                               
         TM    CPYSTAT4,CPYSOFF2                                                
         JO    *+10                                                             
         MVC   TRNKOFF,SPACES      Old offices = no office in key               
         MVC   TRNKCCPY,CUXCPY                                                  
         MVC   TRNKULC(L'LEDGER2D),LEDGER2D                                     
         MVC   TRNKCACT,CL_2DAC                                                 
         MVC   TRNKDATE,POSDATE                                                 
         MVC   TRNKREF,CL_REF                                                   
         MVI   POSTYPE,POSTCR      credit                                       
                                                                                
         GOTOR EL_TRN                                                           
         GOTOR EL_TRS                                                           
         GOTOR EL_APE                                                           
         GOTOR EL_XDF                                                           
         GOTOR EL_PID                                                           
         GOTOR EL_EST                                                           
         GOTOR EL_FFTCL                                                         
         GOTOR EL_ETY                                                           
                                                                                
         GOTOR GOATRN,CL_2DNAM     Put transaction record                       
         GOTOR UPDITM                                                           
         J     EXITY                                                            
                                                                                
***********************************************************************         
* Post staff posting                                                  *         
***********************************************************************         
                                                                                
PSTSTAFF NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*PSTSTAF'                                                      
                                                                                
         CLC   CL_2PAC,SPACES      Have we got staff                            
         JNH   EXITY               No - nothing to do                           
         TM    CL_ESTA1,RSTSGPEI   Have we got staff analysis                   
         JZ    EXITY               No                                           
                                                                                
         L     R2,ATRNREC                                                       
         XC    TRNRECD(TRNRFST-TRNRECD),TRNRECD                                 
         MVC   TRNKCPY,CUXCPY                                                   
         MVC   TRNKUNT(L'LEDGER2P),LEDGER2P                                     
         MVC   TRNKACT,CL_2PAC                                                  
         MVC   TRNKOFF,CL_OFF      Posting office                               
         TM    CPYSTAT4,CPYSOFF2                                                
         JO    *+10                                                             
         MVC   TRNKOFF,SPACES      Old offices = no office in key               
         MVC   TRNKCCPY,CUXCPY                                                  
         MVC   TRNKULC,CL_2PULC                                                 
                                                                                
         ZAP   POSAMNT,AMTANET                                                  
         MVC   TRNKDATE,POSDATE                                                 
         MVC   TRNKREF,CL_REF                                                   
         MVI   POSTYPE,POSTDR      Debit                                        
                                                                                
         GOTOR EL_TRN                                                           
         GOTOR EL_MIL                                                           
*&&UK*&& GOTOR EL_VAT                                                           
         GOTOR EL_TRS                                                           
         GOTOR EL_APE                                                           
         GOTOR EL_XDF                                                           
         GOTOR EL_PID                                                           
         GOTOR EL_EST                                                           
         GOTOR EL_FFTCL                                                         
         GOTOR EL_ETY                                                           
                                                                                
         GOTOR GOATRN,CL_29NAM     Put transaction record                       
         GOTOR UPDITM                                                           
                                                                                
         L     R2,ATRNREC                                                       
         XC    TRNRECD(TRNRFST-TRNRECD),TRNRECD                                 
         MVC   TRNKCPY,CUXCPY                                                   
         MVC   TRNKULA,CL_29ULA                                                 
*&&UK                                                                           
         CLI   CL_ITYPE,CS_INONQ   For billable item                            
         JE    PSTSTF02            Double entry is different                    
         MVC   TRNKUNT(L'LEDGER2P),LEDGER2P                                     
         MVC   TRNKACT,CL_2PAC                                                  
*&&                                                                             
PSTSTF02 MVC   TRNKOFF,CL_OFF      Posting office                               
         TM    CPYSTAT4,CPYSOFF2                                                
         JO    *+10                                                             
         MVC   TRNKOFF,SPACES      Old offices = no office in key               
         MVC   TRNKCCPY,CUXCPY                                                  
         MVC   TRNKULC,CL_29ULC                                                 
*&&UK                                                                           
         CLI   CL_ITYPE,CS_INONQ   For billable item                            
         JE    PSTSTF04            Double entry is different                    
         MVC   TRNKULC,CL_2PULC                                                 
*&&                                                                             
PSTSTF04 MVC   TRNKDATE,POSDATE                                                 
         MVC   TRNKREF,CL_REF                                                   
         MVI   POSTYPE,POSTCR      credit                                       
                                                                                
         GOTOR EL_TRN                                                           
*&&UK                                                                           
         CLI   CL_ITYPE,CS_INONQ   For billable item                            
         JNE   PSTSTF06            Double entry is different                    
*&&                                                                             
         GOTOR EL_MIL                                                           
PSTSTF06 DS    0H                                                               
*&&UK*&& GOTOR EL_VAT                                                           
         GOTOR EL_TRS                                                           
         GOTOR EL_APE                                                           
         GOTOR EL_XDF                                                           
         GOTOR EL_PID                                                           
         GOTOR EL_EST                                                           
         GOTOR EL_FFTCL                                                         
         GOTOR EL_ETY                                                           
                                                                                
         LA    R1,CL_2PNAM                                                      
         CLI   CL_ITYPE,CS_INONQ   For billable item                            
         JE    PSTSTF08            Double entry is different                    
         LA    R1,CL_29NAM                                                      
PSTSTF08 GOTOR GOATRN,(R1)         Put transaction record                       
                                                                                
         GOTOR UPDITM                                                           
         J     EXITY                                                            
                                                                                
***********************************************************************         
* Post client analysis posting                                        *         
***********************************************************************         
                                                                                
PSTANAL  NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*PSTANAL'                                                      
                                                                                
         CLC   CL_1CULA,SPACES     Have we got client costing                   
         JNH   EXITY               No - nothing to do                           
         CLC   CL_ECSTG,SPACES     Have we got staff analysis                   
         JNH   EXITY               No                                           
*&&UK                                                                           
         CLI   CL_ITYPE,CS_INONQ   Non-billable item                            
         JNE   EXITY               No analysis postings                         
*&&                                                                             
         L     R2,ATRNREC                                                       
         XC    TRNRECD(TRNRFST-TRNRECD),TRNRECD                                 
         MVC   TRNKCPY,CUXCPY                                                   
         MVC   TRNKULA,CL_1PULA                                                 
         MVC   POSDUMNM,CL_1PNAM                                                
*&&UK                                                                           
         TM    CPYSTAT8,CPYS1P13  Post to 13 not 1P                             
         JZ    PSTANA02                                                         
         MVC   TRNKULA,CL_13ULA                                                 
         MVC   POSDUMNM,CL_13NAM                                                
*&&                                                                             
                                                                                
PSTANA02 MVC   TRNKOFF,CL_OFF      Posting office                               
         TM    CPYSTAT4,CPYSOFF2                                                
         JO    *+10                                                             
         MVC   TRNKOFF,SPACES      Old offices = no office in key               
         MVC   TRNKCCPY,CUXCPY                                                  
         MVC   TRNKULC,CL_1CULA                                                 
                                                                                
         ZAP   POSAMNT,AMTANET                                                  
         MVC   TRNKDATE,POSDATE                                                 
         MVC   TRNKREF,CL_REF                                                   
         MVI   POSTYPE,POSTDR      Debit                                        
                                                                                
         GOTOR EL_TRN                                                           
         GOTOR EL_TRS                                                           
         GOTOR EL_APE                                                           
         GOTOR EL_XDF                                                           
         GOTOR EL_PID                                                           
         GOTOR EL_EST                                                           
         GOTOR EL_FFTCL                                                         
         GOTOR EL_ETY                                                           
                                                                                
         GOTOR GOATRN,CL_1CNAM     Put transaction record                       
         GOTOR UPDITM                                                           
                                                                                
         L     R2,ATRNREC                                                       
         XC    TRNRECD(TRNRFST-TRNRECD),TRNRECD                                 
         MVC   TRNKCPY,CUXCPY                                                   
         MVC   TRNKULA,CL_1CULA                                                 
         MVC   TRNKOFF,CL_OFF      Posting office                               
         TM    CPYSTAT4,CPYSOFF2                                                
         JO    *+10                                                             
         MVC   TRNKOFF,SPACES      Old offices = no office in key               
         MVC   TRNKCCPY,CUXCPY                                                  
         MVC   TRNKULC,CL_13ULA                                                 
         MVC   TRNKDATE,POSDATE                                                 
         MVC   TRNKREF,CL_REF                                                   
         MVI   POSTYPE,POSTCR      credit                                       
                                                                                
         GOTOR EL_TRN                                                           
         GOTOR EL_TRS                                                           
         GOTOR EL_APE                                                           
         GOTOR EL_XDF                                                           
         GOTOR EL_PID                                                           
         GOTOR EL_EST                                                           
         GOTOR EL_FFTCL                                                         
         GOTOR EL_ETY                                                           
                                                                                
         GOTOR GOATRN,POSDUMNM     Put transaction record                       
         GOTOR UPDITM                                                           
         J     EXITY                                                            
                                                                                
***********************************************************************         
* X'44' Transaction element                                           *         
***********************************************************************         
                                                                                
EL_TRN   NTR1  LABEL=NO                                                         
N        USING TRNELD,ELEMENT                                                   
         XC    N.TRNELD(TRNLN1Q),N.TRNELD                                       
         MVI   N.TRNEL,TRNELQ                                                   
         GOTOR VDATCON,DMCB,(2,CL_ADAT),(1,TEMP2)                               
         MVC   N.TRNDATE,POSDATE                                                
                                                                                
EL_TRN02 MVC   N.TRNREF,CL_REF                                                  
         MVC   N.TRNTYPE,POSOBTYP                                               
         MVC   N.TRNMOS,HD_MOA     Convert YYMM -> YM ebcdic                    
         OI    N.TRNMOS,X'F0'                                                   
         LLC   R1,N.TRNMOS+1                                                    
         LHI   RF,X'F0'                                                         
         TM    N.TRNMOS+1,X'10'                                                 
         JNO   *+8                                                              
         LHI   RF,X'B1'                                                         
         AR    R1,RF                                                            
         STC   R1,N.TRNMOS+1                                                    
         MVC   N.TRNBREF,QH_BREF                                                
                                                                                
         MVC   N.TRNSTAT,POSSTAT                                                
         TM    POSTYPE,POSTDR                                                   
         JZ    *+8                                                              
         OI    N.TRNSTAT,TRNSDR    Debit posting for SE/SJ/SG/2D/2P/1P          
EL_TRN08 ZAP   N.TRNAMNT,POSAMNT   Amount                                       
         TM    STPOSTNG,STNEGATE   Making negative posting                      
         JNO   EL_TRN10                                                         
         ZAP   DUB,N.TRNAMNT                                                    
         MP    DUB,PNEGONE                                                      
         ZAP   N.TRNAMNT,DUB                                                    
                                                                                
EL_TRN10 MVC   N.TRNOFFC,CL_OFF    Client office                                
         CLC   PRODUL,TRNKULA                                                   
         JNE   *+10                                                             
         MVC   N.TRNOFFC,CL_WC     SJ posting uses work code                    
         TM    CPYSTAT4,CPYSOFF2                                                
         JZ    EL_TRN12                                                         
         CLC   N.TRNOFFC,SPACES                                                 
         JH    EL_TRN12                                                         
         DC    H'0'                                                             
*                                                                               
EL_TRN12 SR    R1,R1               See if we have finance narrative             
         ICM   R1,1,CL_NARL                                                     
         JZ    EL_TRN14            No - see if we have original narr            
         BCTR  R1,0                Yes - add to trans element                   
         BASR  RE,0                                                             
         MVC   N.TRNNARR(0),CL_NAR                                              
         EX    R1,0(RE)                                                         
         AHI   R1,1                                                             
         J     EL_TRN16                                                         
                                                                                
EL_TRN14 ICM   R1,1,CL_NAROL       Any claimant narrative                       
         JZ    EL_TRN16            No                                           
         BCTR  R1,0                Yes add to trans element                     
         BASR  RE,0                                                             
         MVC   N.TRNNARR(0),CL_NARO                                             
         EX    R1,0(RE)                                                         
         AHI   R1,1                                                             
                                                                                
EL_TRN16 LA    RF,TRNLN1Q(R1)                                                   
         STC   RF,N.TRNLN                                                       
                                                                                
         GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
                                                                                
***********************************************************************         
* X'60' Transaction status element                                    *         
***********************************************************************         
                                                                                
EL_TRS   NTR1  LABEL=NO                                                         
N        USING TRSELD,ELEMENT                                                   
         XC    N.TRSEL(TRSLNQ),N.TRSELD                                         
         MVI   N.TRSEL,TRSELQ                                                   
         MVI   N.TRSLN,TRSLNQ                                                   
         MVC   N.TRSDATE,HD_TODC                                                
         MVC   N.TRSEFDT,N.TRSDATE Effective date                               
         MVC   N.TRSPMOS,HD_MOA                                                 
         OI    N.TRSSTAT3,TRSSMCS  Set created by Aura                          
         MVC   N.TRSUSER,CUUSER    User id                                      
         GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
                                                                                
***********************************************************************         
* X'4F' client product job source element                             *         
***********************************************************************         
                                                                                
EL_CPJ   NTR1  LABEL=NO                                                         
N        USING CPJELD,ELEMENT                                                   
         XC    N.CPJELD(CPJLN2Q),N.CPJELD                                       
         MVI   N.CPJEL,CPJELQ                                                   
         CLI   CL_ITYPE,CS_IBILQ                                                
         JNE   EL_CPJ02                                                         
         MVI   N.CPJLN,CPJLNQ                                                   
         MVI   N.CPJTYPE,CPJTJOB                                                
         LLC   RF,PCLILEN                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   N.CPJCLI(0),CL_SJAC   client code                                
         EX    RF,0(RE)                                                         
         OC    N.CPJCLI,SPACES                                                  
         LA    R4,CL_SJAC                                                       
         LLC   RE,PCLILEN                                                       
         LLC   RF,PPROLEN                                                       
         AR    R4,RE                 R4=A(product)                              
         SR    RF,RE                                                            
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   N.CPJPRO(0),0(R4)     product code to element                    
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         AR    R4,RF                 R4=A(job)                                  
         LLC   RE,PPROLEN                                                       
         LLC   RF,PJOBLEN                                                       
         SR    RF,RE                                                            
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   N.CPJJOB(0),0(R4)                                                
         EX    RF,0(RE)                                                         
         MVC   N.CPJWRK,CL_WC                                                   
         J     EL_CPJ06                                                         
                                                                                
EL_CPJ02 MVI   N.CPJLN,CPJLN2Q                                                  
         CLC   =C'SE',CL_EXAC                                                   
         JNE   EL_CPJ04                                                         
         MVI   N.CPJTYPE,CPJTEXP     EXPENSE ACCOUNT                            
         MVC   N.CPJEXP,CL_EXAC+L'ACTKUNT+L'ACTKLDG                             
         J     EL_CPJ06                                                         
EL_CPJ04 MVI   N.CPJTYPE,CPJTOTH     OTHER ACCOUNT                              
         MVC   N.CPJOULA,CL_EXAC                                                
                                                                                
EL_CPJ06 GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
                                                                                
***********************************************************************         
* X'23' Internal reference element                                    *         
***********************************************************************         
                                                                                
EL_INT   NTR1  LABEL=NO                                                         
         CLI   CL_INT,C' '         Have we internal reference                   
         JNH   EXITY               No                                           
*&&UK                                                                           
N        USING OTHELD,ELEMENT                                                   
         MVC   N.OTHEL(OTHLN1Q),SPACES  Add other element for int               
         MVI   N.OTHEL,OTHELQ               reference in UK                     
         MVI   N.OTHLN,OTHLN1Q                                                  
         MVC   N.OTHNUM(L'CL_INT),CL_INT                                        
*&&                                                                             
*&&US                                                                           
N        USING FFTELD,ELEMENT                                                   
         MVI   N.FFTEL,FFTELQ         Add freeform in US for internal           
         MVI   N.FFTLN,FFTLN1Q+L'FFTDLEN+L'CL_INT  reference number             
         MVI   N.FFTTYPE,FFTTCLMN                                               
         MVI   N.FFTSEQ,0                                                       
         MVI   N.FFTDLEN,L'CL_INT                                               
         MVC   N.FFTDATA(L'CL_INT),CL_INT                                       
*&&                                                                             
         GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
                                                                                
***********************************************************************         
* X'50' Subsidiary cash element VAT amount                            *         
***********************************************************************         
*&&UK                                                                           
EL_VAT   NTR1  LABEL=NO                                                         
N        USING SCIELD,ELEMENT                                                   
         MVI   N.SCIEL,SCIELQ                                                   
         MVI   N.SCILN,SCILN1Q                                                  
         MVI   N.SCITYPE,SCITIVAT                                               
         ZAP   N.SCIAMNT,AMTAVAT                                                
                                                                                
EL_VAT02 TM    STPOSTNG,STNEGATE                                                
         JNO   EL_VAT04                                                         
         ZAP   DUB,N.SCIAMNT                                                    
         MP    DUB,PNEGONE                                                      
         ZAP   N.SCIAMNT,DUB                                                    
                                                                                
EL_VAT04 GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
*&&                                                                             
***********************************************************************         
* X'50' Subsidiary cash element memo VAT amount                       *         
***********************************************************************         
*&&UK                                                                           
EL_MVAT  NTR1  LABEL=NO                                                         
N        USING SCIELD,ELEMENT                                                   
         MVI   N.SCIEL,SCIELQ                                                   
         MVI   N.SCILN,SCILN1Q                                                  
         MVI   N.SCITYPE,SCITMTAX                                               
         ZAP   N.SCIAMNT,AMTAVAT                                                
                                                                                
EL_MVT02 TM    STPOSTNG,STNEGATE                                                
         JNO   EL_MVT04                                                         
         ZAP   DUB,N.SCIAMNT                                                    
         MP    DUB,PNEGONE                                                      
         ZAP   N.SCIAMNT,DUB                                                    
                                                                                
EL_MVT04 GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
*&&                                                                             
***********************************************************************         
* X'50' Subsidiary cash element net amount                            *         
***********************************************************************         
                                                                                
EL_NET   NTR1  LABEL=NO                                                         
N        USING SCIELD,ELEMENT                                                   
         MVI   N.SCIEL,SCIELQ                                                   
         MVI   N.SCILN,SCILN1Q                                                  
         MVI   N.SCITYPE,SCITGLEV                                               
         ZAP   N.SCIAMNT,AMTANET                                                
         CLI   CL_CLICD,NOQ        Are we posting to discount                   
         JE    EL_NET02            Yes                                          
         AP    N.SCIAMNT,AMTADSC   No - Need to add discount back in            
                                                                                
EL_NET02 TM    STPOSTNG,STNEGATE                                                
         JNO   EL_NET04                                                         
         ZAP   DUB,N.SCIAMNT                                                    
         MP    DUB,PNEGONE                                                      
         ZAP   N.SCIAMNT,DUB                                                    
                                                                                
EL_NET04 GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
                                                                                
***********************************************************************         
* X'50' Subsidiary cash element memo                                  *         
***********************************************************************         
                                                                                
EL_MEMO  NTR1  LABEL=NO                                                         
N        USING SCIELD,ELEMENT                                                   
         MVI   N.SCIEL,SCIELQ                                                   
         MVI   N.SCILN,SCILN1Q                                                  
*&&UK*&& MVI   N.SCITYPE,SCITMEXP                                               
*&&US*&& MVI   N.SCITYPE,SCITSJXP                                               
         ZAP   N.SCIAMNT,AMTANET                                                
                                                                                
         TM    STPOSTNG,STNEGATE                                                
         JNO   EL_MEM02                                                         
         ZAP   DUB,N.SCIAMNT                                                    
         MP    DUB,PNEGONE                                                      
         ZAP   N.SCIAMNT,DUB                                                    
                                                                                
EL_MEM02 GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
                                                                                
***********************************************************************         
* X'50' Subsidiary cash element miles                                 *         
***********************************************************************         
                                                                                
EL_MIL   NTR1  LABEL=NO                                                         
         CP    CL_MILE,PZERO       Don't add if no miles input                  
         JE    EXITY                                                            
         TM    STPOSTNG,STPOSTG1   Mileage on first posting so not              
         JNZ   EXITY                 needed on 2nd posting                      
N        USING SCIELD,ELEMENT                                                   
         XC    N.SCIELD(SCILN1Q),N.SCIELD                                       
         MVI   N.SCIEL,SCIELQ                                                   
         MVI   N.SCILN,SCILN1Q                                                  
         MVI   N.SCITYPE,SCITMILE  miles                                        
         ZAP   N.SCIAMNT,CL_MILE                                                
                                                                                
EL_MIL02 TM    STPOSTNG,STNEGATE                                                
         JNO   EL_MIL04                                                         
         ZAP   DUB,N.SCIAMNT                                                    
         MP    DUB,PNEGONE                                                      
         ZAP   N.SCIAMNT,DUB                                                    
                                                                                
EL_MIL04 GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
***********************************************************************         
* X'50' Subsidiary cash element discount                              *         
***********************************************************************         
                                                                                
EL_DISC  NTR1  LABEL=NO                                                         
         CP    CL_DAMT,PZERO       Don't add if no discount input               
         JE    EXITY                                                            
N        USING SCIELD,ELEMENT                                                   
         XC    N.SCIELD(SCILN1Q),N.SCIELD                                       
         MVI   N.SCIEL,SCIELQ                                                   
         MVI   N.SCILN,SCILN1Q                                                  
         MVI   N.SCITYPE,SCITCDSC                                               
         ZAP   N.SCIAMNT,AMTADSC                                                
                                                                                
         TM    STPOSTNG,STNEGATE   Reverse amount if backing out                
         JNO   EL_DIS02                                                         
         ZAP   DUB,N.SCIAMNT                                                    
         MP    DUB,PNEGONE                                                      
         ZAP   N.SCIAMNT,DUB                                                    
                                                                                
EL_DIS02 GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
***********************************************************************         
* X'7F' Foreign currency element                                      *         
***********************************************************************         
                                                                                
*&&UK                                                                           
EL_AFC   NTR1  LABEL=NO                                                         
         CLC   HD_CURR,CL_FCUR     Test we have foreign currency                
         JE    EXITY               No                                           
*                                                                               
N        USING AFCELD,ELEMENT                                                   
         XC    N.AFCELD(AFCLNQ),N.AFCELD                                        
         MVI   N.AFCEL,AFCELQ                                                   
         MVI   N.AFCLN,AFCLNQ                                                   
         MVC   N.AFCCURR,CL_FCUR                                                
         MVC   N.AFCX,CL_XRT                                                    
         MVI   N.AFCXSTA2,AFCXPRIM                                              
*                                                                               
         CP    POSAMNT,=P'0'       Test for zero                                
         JNE   *+14                                                             
         ZAP   N.AFCAMNT,=P'0'                                                  
         J     EL_AFC6                                                          
                                                                                
         LA    RF,AMT#             Match on agency amount                       
         LA    R0,AMT#N                                                         
EL_AFC2  CP    POSAMNT,0(L'AMTANET,RF)                                          
         JE    EL_AFC4                                                          
         AHI   RF,L'AMT#                                                        
         JCT   R0,EL_AFC2                                                       
         DC    H'0'                                                             
EL_AFC4  ZAP   N.AFCAMNT,L'AMTANET(L'AMTENET,RF) Set foreign currency           
*                                                                               
EL_AFC6  GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
*&&                                                                             
                                                                                
***********************************************************************         
* X'25' Order number free form number element                         *         
***********************************************************************         
                                                                                
EL_ORD   NTR1  LABEL=NO                                                         
N        USING FFNELD,ELEMENT                                                   
         TM    CPYSTAT1,CPYSIOMR   Only needed if order matching req'd          
         JZ    EXITY                                                            
         XC    N.FFNELD(FFNLN2Q),N.FFNELD                                       
         MVI   N.FFNEL,FFNELQ                                                   
         MVI   N.FFNLN,FFNLN2Q                                                  
         MVC   N.FFNONUM,AC@NOORD                                               
         GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
         DROP  N                                                                
                                                                                
***********************************************************************         
* X'21' Number element - for claim Number and item row number         *         
***********************************************************************         
                                                                                
EL_NUM   NTR1  LABEL=NO                                                         
         CLI   HD_CLM#,C' '        Have we Claim Number?                        
         JNH   EXITY               No                                           
*                                  Yes, Continue                                
N        USING NUMELD,ELEMENT      MAP with number element                      
         XC    N.NUMELD(NUMLN2Q),N.NUMELD                                       
         MVI   N.NUMEL,NUMELQ      Element type - X'21'                         
         MVI   N.NUMLN,NUMLN2Q     Length of the element                        
         MVI   N.NUMTYPE,NUMTYCLM  Claim number and item details type           
         MVC   N.NUMCLM#,HD_CLM#   save claim number details                    
         MVC   N.NUMITMR#,CL_ITEM#  save  item row number                       
         GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
         DROP  N                                                                
                                                                                
***********************************************************************         
* X'C0' Analysis pointer element                                      *         
***********************************************************************         
                                                                                
EL_APE   NTR1  LABEL=NO,WORK=(RC,APEACTL)                                       
         USING APEACTD,RC                                                       
                                                                                
         XC    APEACTD(APEACTSL),APEACTD                                        
         MVC   APECRAA,CL_SUPAC                                                 
         MVI   APECRAS,0                                                        
*&&US*&& CLI   CL_EXPJB,YESQ       If Job is an expense job                     
*&&US*&& JE    *+12                then treat it as non-billable                
         CLI   CL_ITYPE,CS_INONQ   Non billable                                 
         JNE   EL_APE02            No                                           
         MVC   APENTAA,CL_EXAC     Set expense account as net account           
         MVI   APENTAS,APENSDR                                                  
         LLC   RE,PPROLEN                                                       
         LA    R4,CL_SJAC                                                       
         CLI   0(R4),C' '                                                       
         JNH   EL_APE06                                                         
         AR    R4,RE                                                            
         CLI   0(R4),C' '                                                       
         JE    EL_APE06                                                         
         MVC   APEMEAA(L'ACTKUNT+L'ACTKLDG),PRODUL                              
         MVC   APEMEAA+L'ACTKUNT+L'ACTKLDG(L'ACTKACT),CL_SJAC                   
         MVI   APEMEAS,APENSDR                                                  
         J     EL_APE06                                                         
                                                                                
EL_APE02 MVC   APENTAA(L'ACTKUNT+L'ACTKLDG),PRODUL                              
         MVC   APENTAA+L'ACTKUNT+L'ACTKLDG(L'ACTKACT),CL_SJAC                   
         MVI   APENTAS,APENSDR                                                  
                                                                                
EL_APE06 MVC   APESGAA,CL_VATAC                                                 
         TM    STPOSTNG,STMILVAT                                                
         JZ    *+10                                                             
         MVC   APESGAA+L'ACTKUNT+L'ACTKLDG(L'ACTKACT),CL_MVTAC                  
         MVI   APESGAS,APENSDR                                                  
                                                                                
         CLC   CL_ECSTG,SPACES                                                  
         JNH   EL_APE08                                                         
         MVC   APEDSAA,CL_DSULA                                                 
         MVC   APE1CAA,CL_1CULA                                                 
         MVC   APE1PAA,CL_1PULA                                                 
         MVI   APE1PAS,APENSDR                                                  
*&&US                                                                           
         MVC   APE13AA,CL_13ULA                                                 
         MVI   APE13AS,APENSDR                                                  
*&&                                                                             
*&&UK                                                                           
         TM    CPYSTAT8,CPYS1P13  Post to 13 not 1P                             
         JZ    EL_APE08                                                         
         MVC   APE1PAA,CL_13ULA                                                 
*&&                                                                             
                                                                                
EL_APE08 CLC   CL_2DAC,SPACES                                                   
         JNH   EL_APE10                                                         
         TM    CL_ESTA1,RSTSEADD   Have we got department postings to           
         JZ    EL_APE10                                         make            
         MVC   APE2DAA(L'ACTKUNT+L'ACTKLDG),LEDGER2D                            
         MVC   APE2DAA+L'ACTKUNT+L'ACTKLDG(L'ACTKACT),CL_2DAC                   
         MVI   APE2DAS,APENSDR                                                  
         MVC   APE28AA,CL_28ULA                                                 
                                                                                
EL_APE10 CLC   CL_2PAC,SPACES                                                   
         JNH   EL_APE12                                                         
         TM    CL_ESTA1,RSTSGPEI   Have we got staff analysis                   
         JZ    EL_APE12            No                                           
         MVC   APE2PAA(L'ACTKUNT+L'ACTKLDG),LEDGER2P                            
         MVC   APE2PAA+L'ACTKUNT+L'ACTKLDG(L'ACTKACT),CL_2PAC                   
         MVI   APE2PAS,APENSDR                                                  
*&&UK                                                                           
         CLI   CL_ITYPE,CS_INONQ   For billable item                            
         JNE   EL_APE12            Double entry is different                    
*&&                                                                             
         MVC   APE29AA,CL_29ULA                                                 
                                                                                
EL_APE12 LA    R3,ELEMENT                                                       
         USING APEELD,R3           R3=A(Element)                                
         MVI   APEEL,APEELQ                                                     
                                                                                
         LA    R6,APENTRYS                                                      
A        USING APENTRYS,R6         R6=A(Analysis account list)                  
         LHI   R0,APEACTSN         R0=Number of accounts in list                
                                                                                
         MVI   APENUM,0            Set no analysis accounts                     
         LA    R5,APENTRY                                                       
         USING APENTRY,R5          R5=A(Analysis account entry)                 
                                                                                
EL_APE14 CLC   A.APEACTA,SPACES    Test any account here                        
         JNH   EL_APE16                                                         
         CLC   A.APEACTA,TRNKULA   Is it the account?                           
         JE    EL_APE16                                                         
*&&US                                                                           
         CLC   A.APEACTA,TRNKULC   Is it the contra account?                    
         JE    EL_APE16                                                         
*&&                                                                             
                                                                                
         MVC   APENSTAT,A.APEACTS  Set status                                   
         MVC   APENACT,A.APEACTA   Set account                                  
         LA    R1,APENACT+L'APENACT-1                                           
         BASR  RE,0                                                             
         CLI   0(R1),C' '          Locate end of account code                   
         JH    *+6                                                              
         BCTR  R1,RE                                                            
         AHI   R1,1                                                             
         SR    R1,R5                                                            
         STC   R1,APENLEN          Set length of entry                          
         AR    R5,R1               Point to next entry                          
         IC    R1,APENUM           Bump number of entries                       
         AHI   R1,1                                                             
         STC   R1,APENUM                                                        
                                                                                
EL_APE16 AHI   R6,APENTRYL         Bump to next account                         
         JCT   R0,EL_APE14                                                      
                                                                                
         CLI   APENUM,0            Test any entries added                       
         JE    EXITY                                                            
         SR    R5,R3                                                            
         STC   R5,APELN            Set length of element                        
         GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
         DROP  R3,R5,RC,A                                                       
                                                                                
APEACTD  DSECT                     ** Analysis account list **                  
APENTRYS DS    0X                                                               
APEACTA  DS    0XL(L'APENACT)                                                   
APENTAA  DS    CL(L'CL_EXAC)                                                    
APEACTS  DS    0XL(L'APENSTAT)                                                  
APENTAS  DS    X                                                                
APENTRYL EQU   *-APENTRYS                                                       
APEMEAA  DS    CL(L'ACTKULA)                                                    
APEMEAS  DS    X                                                                
APECRAA  DS    CL(L'CL_SUPAC)                                                   
APECRAS  DS    X                                                                
APESGAA  DS    CL(L'CL_VATAC)                                                   
APESGAS  DS    X                                                                
APEDSAA  DS    CL(L'CL_DSULA)                                                   
APEDSAS  DS    X                                                                
APE1CAA  DS    CL(L'CL_1CULA)                                                   
APE1CAS  DS    X                                                                
APE1PAA  DS    CL(L'CL_1PULA)                                                   
APE1PAS  DS    X                                                                
*&&US                                                                           
APE13AA  DS    CL(L'CL_1PULA)                                                   
APE13AS  DS    X                                                                
*&&                                                                             
APE2DAA  DS    CL(L'CL_1CULA)                                                   
APE2DAS  DS    X                                                                
APE28AA  DS    CL(L'CL_1CULA)                                                   
APE28AS  DS    X                                                                
APE2PAA  DS    CL(L'CL_1CULA)                                                   
APE2PAS  DS    X                                                                
APE29AA  DS    CL(L'CL_1CULA)                                                   
APE29AS  DS    X                                                                
APEACTSL EQU   *-APEACTD                                                        
APEACTSN EQU   APEACTSL/APENTRYL                                                
APEACTL  EQU   *-APEACTD                                                        
SVRDEF   CSECT                                                                  
                                                                                
***********************************************************************         
* X'A2' Post extra data elements                                      *         
***********************************************************************         
                                                                                
EL_XDF   NTR1  LABEL=NO                                                         
         USING XDFELD,R3                                                        
         LAY   R3,XDFELTAB                                                      
EL_XDF02 CLI   XDFEL,0             End of table                                 
         JE    EXITY               Yes                                          
         XR    R1,R1                                                            
         IC    R1,XDFLN                                                         
         SHI   R1,1                                                             
         BASR  RE,0                                                             
         MVC   ELEMENT(0),0(R3)    Take elements from table                     
         EX    R1,0(RE)                                                         
         AHI   R1,1                                                             
         AR    R3,R1                                                            
         GOTOR ADDELE,TRNRECD                                                   
         J     EL_XDF02                                                         
         DROP  R3                                                               
                                                                                
*&&US                                                                           
***********************************************************************         
* X'DB' free form text element for workcode and net amount            *         
***********************************************************************         
                                                                                
EL_WRKC  NTR1  LABEL=NO                                                         
         LA    R4,CL_SJAC                                                       
         LLC   RE,PPROLEN                                                       
         AR    R4,RE               R4=A(Job)                                    
         CLI   0(R4),C' '          Have we got a job                            
         JH    *+12                yes                                          
         CLI   CL_ITYPE,CS_IBILQ   Test billable                                
         JNE   EL_WRKCX                                                         
N        USING FFTELD,ELEMENT                                                   
         XC    ELEMENT,ELEMENT                                                  
         MVI   N.FFTEL,FFTELQ                                                   
         MVI   N.FFTLN,13                                                       
         MVI   N.FFTTYPE,FFTTWRKC                                               
         MVI   N.FFTDLEN,8                                                      
         MVC   N.FFTDATA(2),CL_WC  Workcode                                     
         ZAP   N.FFTDATA+2(6),AMTANET  Net amount                               
                                                                                
         TM    STPOSTNG,STNEGATE   Reverse amount if backing out                
         JNO   EL_WRKC2                                                         
         ZAP   DUB,AMTANET                                                      
         MP    DUB,PNEGONE                                                      
         ZAP   N.FFTDATA+2(6),DUB                                               
                                                                                
EL_WRKC2 GOTOR ADDELE,TRNRECD                                                   
EL_WRKCX J     EXIT                                                             
                                                                                
***********************************************************************         
* X'23' Other element for product job                                 *         
***********************************************************************         
         SPACE 1                                                                
EL_PRJB  NTR1  LABEL=NO                                                         
N        USING OTHELD,ELEMENT                                                   
         MVI   N.OTHEL,OTHELQ                                                   
         MVI   N.OTHLN,OTHLN1Q                                                  
         MVC   N.OTHNUM(13),SPACES                                              
                                                                                
         LA    R4,CL_SJAC                                                       
         LLC   RE,PCLILEN                                                       
         LLC   RF,PPROLEN                                                       
         AR    R4,RE                 R4=A(product)                              
         SR    RF,RE                                                            
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   N.OTHNUM(0),0(R4)     Move product code to key                   
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         AR    R4,RF                 R4=A(job)                                  
         LLC   RE,PPROLEN                                                       
         LLC   RF,PJOBLEN                                                       
         SR    RF,RE                                                            
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   N.OTHNUM+6(0),0(R4)                                              
         EX    RF,0(RE)                                                         
         GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
*&&                                                                             
***********************************************************************         
* X'D8' Person ID element                                             *         
***********************************************************************         
                                                                                
EL_PID   NTR1  LABEL=NO                                                         
         OC    CCTPID,CCTPID                                                    
         JZ    EXITY                                                            
N        USING PIDELD,ELEMENT                                                   
         XC    N.PIDEL(PIDLNQ),N.PIDEL                                          
         MVI   N.PIDEL,PIDELQ                                                   
         MVI   N.PIDLN,PIDLNQ                                                   
         MVC   N.PIDNO,CCTPID       User's PID #                                
         GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
                                                                                
**********************************************************************          
* X'DB' Free form text element for expenditure type                  *          
**********************************************************************          
                                                                                
EL_ETY   NTR1  LABEL=NO                                                         
         CLC   CL_ETYP,SPACES                                                   
         JNH   EXITY                                                            
N        USING FFTELD,ELEMENT                                                   
         XC    N.FFTELD(FFTLN1Q+L'ETYKCODE+L'FFTDLEN+1),N.FFTELD                
         MVI   N.FFTEL,FFTELQ                                                   
         MVI   N.FFTLN,FFTLN1Q+L'ETYKCODE+L'FFTDLEN                             
         MVI   N.FFTTYPE,FFTTEXTY                                               
         MVI   N.FFTDLEN,L'ETYKCODE                                             
         MVC   N.FFTDATA(L'ETYKCODE),CL_ETYP                                    
         GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
                                                                                
**********************************************************************          
* X'DB' Free form text element for estimate number                   *          
**********************************************************************          
                                                                                
EL_EST   NTR1  LABEL=NO                                                         
         CLC   CL_EST,SPACES                                                    
         JNH   EXITY                                                            
N        USING FFTELD,ELEMENT                                                   
         XC    ELEMENT,ELEMENT                                                  
         MVI   N.FFTEL,FFTELQ                                                   
         MVI   N.FFTLN,FFTLN1Q+L'FFTESTN+L'FFTOESTN+L'FFTDLEN                   
         MVI   N.FFTTYPE,FFTTESTN                                               
         MVI   N.FFTDLEN,L'FFTESTN+L'FFTOESTN                                   
         MVC   N.FFTESTN,CL_EST                                                 
         MVC   N.FFTOESTN,SPACES                                                
         GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
                                                                                
**********************************************************************          
* X'DB' ADD REF# FFTTKREF NEEDED FOR TYPE 34 TRANSFERS             *            
**********************************************************************          
                                                                                
EL_FFTKR NTR1  LABEL=NO                                                         
         XC    N.FFTELD(FFTLN1Q+L'TRNKREF+L'FFTDLEN+1),N.FFTELD                 
         MVI   N.FFTEL,FFTELQ                                                   
         MVI   N.FFTLN,FFTLN1Q+L'TRNKREF+L'FFTDLEN                              
         MVI   N.FFTTYPE,FFTTKREF                                               
         MVI   N.FFTDLEN,L'TRNKREF                                              
         MVC   N.FFTDATA(L'TRNKREF),CL_REF                                      
         GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
                                                                                
**********************************************************************          
* X'DB' ADD INV# FFTTINVN                                          *            
**********************************************************************          
                                                                                
EL_FFTIN NTR1  LABEL=NO                                                         
N        USING FFTELD,ELEMENT                                                   
         XC    N.FFTELD(FFTLN1Q+L'TRNKREF+L'FFTDLEN+1),N.FFTELD                 
         MVI   N.FFTEL,FFTELQ                                                   
         MVI   N.FFTLN,FFTLN1Q+L'TRNKREF+L'FFTDLEN                              
         MVI   N.FFTTYPE,FFTTINVN                                               
         MVI   N.FFTDLEN,L'TRNKREF                                              
         MVC   N.FFTDATA(L'TRNKREF),CL_REF                                      
         GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
                                                                                
**********************************************************************          
* X'DB' Free form text element for memo client product               *          
**********************************************************************          
                                                                                
EL_FFTCL NTR1  LABEL=NO                                                         
*&&UK*&& CLI   CL_ITYPE,CS_INONQ   Non-billable item                            
*&&UK*&& JNE   EXITY                                                            
N        USING FFTELD,ELEMENT                                                   
         MVI   N.FFTEL,FFTELQ                                                   
         MVI   N.FFTLN,FFTLN1Q+L'FFTDLEN+L'FFTCLPRA                             
         MVI   N.FFTTYPE,FFTTCLPR                                               
         MVI   N.FFTSEQ,0                                                       
         MVI   N.FFTDLEN,L'FFTCLPRA                                             
         MVC   N.FFTCLPRA,SPACES                                                
         LA    R4,CL_SJAC                                                       
         CLI   0(R4),C' '            Test have memo client                      
         JNH   EXITY                                                            
         LLC   RF,PCLILEN                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   N.FFTCLAC(0),0(R4)                                               
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         AR    R4,RF                 R4=A(product)                              
         CLI   0(R4),C' '            Test have memo product                     
         JNH   EL_FFCL2                                                         
         LLC   RE,PCLILEN                                                       
         LLC   RF,PPROLEN                                                       
         SR    RF,RE                                                            
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   N.FFTPRAC(0),0(R4)                                               
         EX    RF,0(RE)                                                         
                                                                                
EL_FFCL2 GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
         EJECT                                                                  
***********************************************************************         
* X'DB' Free form text element for CLaim Number                      *          
***********************************************************************         
*&&US                                                                           
EL_FFTCN NTR1  LABEL=NO                                                         
         CLI   HD_CLM#,C' '        Have we Claim Number?                        
         JNH   EXITY               No                                           
                                                                                
N        USING FFTELD,ELEMENT                                                   
         MVI   N.FFTEL,FFTELQ         Add freeform in US for internal           
         MVI   N.FFTLN,FFTLN1Q+L'FFTDLEN+L'HD_CLM#   Claim number               
         MVI   N.FFTTYPE,FFTTCLMN                                               
         MVI   N.FFTSEQ,0                                                       
         MVI   N.FFTDLEN,L'HD_CLM#                                              
         MVC   N.FFTDATA(L'HD_CLM#),HD_CLM#                                     
                                                                                
         GOTOR ADDELE,TRNRECD                                                   
         J     EXITY                                                            
*&&                                                                             
         DROP  R2                                                               
***********************************************************************         
* Add an element to end of record pointed to by ATRNREC               *         
***********************************************************************         
                                                                                
ADDELE   NTR1  LABEL=NO                                                         
         LR    RE,R1               RE=A(Record)                                 
         USING TRNRECD,RE                                                       
         SR    R0,R0                                                            
         ICM   R0,3,TRNRLEN        Get current record length                    
         JNZ   *+8                                                              
         LHI   R0,TRNRFST+1-TRNRECD                                             
         LLC   RF,ELEMENT+1        RF=L'element to be added                     
         AR    R0,RF               Update record length                         
         STCM  R0,3,TRNRLEN-TRNRECD(RE)                                         
         CHI   R0,MAXRECLN                                                      
         JNH   *+6                                                              
         DC    H'0'                Record became too big                        
         SR    R0,RF                                                            
         BCTR  R0,0                Decrement for EOR                            
         AR    R0,RE               R0=A(Element insertion point)                
         LR    R1,R0                                                            
         AR    R1,RF                                                            
         MVI   0(R1),0             Set new EOR                                  
         LR    R1,RF               Set 'to' length                              
         LA    RE,ELEMENT          Set 'from' address                           
         MVCL  R0,RE               Move element to record                       
         J     EXITY                                                            
         DROP  RE                                                               
         EJECT                                                                  
***********************************************************************         
* Call DMGRITRN to put ADDTRN transaction record to output file       *         
***********************************************************************         
                                                                                
GOATRN   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*GOATRN*'                                                      
                                                                                
         LTR   R2,R1               Test last time call                          
         JZ    GOATRN04                                                         
         TM    RUNINDS,RUNIATRF    Test first time call                         
         JNZ   GOATRN02                                                         
         OI    RUNINDS,RUNIATRF    Set not first time/Put header                
         GOTOR DMGRITRN,DMCB,('FW_AAHDR',$ADDTRN)                               
                                                                                
GOATRN02 GOTOR DMGRITRN,DMCB,('FW_AATRN',$ADDTRN),(R2)                          
         J     EXITY                                                            
                                                                                
GOATRN04 TM    RUNINDS,RUNIATRF    Test any transactions put                    
         JZ    EXITY                                                            
         GOTOR DMGRITRN,DMCB,('FW_AAEND',$ADDTRN)                               
         J     EXITY                                                            
         DROP  RA                  Drop GLOBALS                                 
         EJECT                                                                  
***********************************************************************         
* Data Manager routines                                               *         
*                                                                     *         
* DMGRITRN will be entered for any call to VDATAMGR (internal calls)  *         
* DMGRXTRN will be entered for any call to CDATAMGR (external calls)  *         
***********************************************************************         
                                                                                
DMGRITRN SR    RF,RF               Internal entry point - clear RF              
                                                                                
DMGRXTRN NTR1  LABEL=NO,WORK=(RC,DMWORKL)                                       
         J     *+12                                                             
         DC    C'*BODMGR*'                                                      
                                                                                
         USING DMWORKD,RC          RC=A(Local w/s)                              
         LARL  RA,GLOBALS                                                       
         USING GLOBALS,RA          RA=A(Global literals)                        
         L     R5,LLP                                                           
         USING LP_D,R5             R5=A(LP_D)                                   
         LM    R2,RB,LP_R2RB                                                    
         USING WORKD,R9            R9=A(WORKD)                                  
         USING SAVED,R8            R8=A(SAVED)                                  
         USING CPYELD,SCPYEL                                                    
         ST    R1,DMGRSVR1         Save A(Caller's parameter list)              
         MVC   DMGRDMCB,0(R1)      Save caller's DMCB                           
         MVI   DMGRERRS,0          Set no errors                                
                                                                                
         MVI   DMGRFLAG,DMGRFEXT   Set external I/O call                        
         LTR   RF,RF               Test called internally                       
         JNZ   *+8                                                              
         MVI   DMGRFLAG,DMGRFINT   Set internal I/O call                        
                                                                                
         LM    R3,R4,DMGRP1        R3=A(Command), R4=A(File)                    
                                                                                
         CLC   $ADDTRN,0(R3)       Test ADDTRN handler record                   
         JE    ADDTRN                                                           
         CLC   $LOKREC,0(R3)       Test LOKREC handler record                   
         JE    LOKREC                                                           
                                                                                
         CLC   ACCOUNT,0(R4)       Only interested in Account files             
         JNE   DMGRREAL                                                         
                                                                                
         CLC   DMPUTF,0(R3)        Test updative I/O                            
         JE    DMGR0010                                                         
         CLC   DMWRTD,0(R3)                                                     
         JE    DMGR0010                                                         
         CLC   DMADDD,0(R3)                                                     
         JE    DMGR0010                                                         
         CLC   DMADDF,0(R3)                                                     
         JNE   DMGRREAL            No - issue non-updative I/O                  
                                                                                
DMGR0010 LHI   R0,FW_FDIR                                                       
         CLC   ACCDIR,0(R4)        Test ACCDIR I/O                              
         JE    DMGR0020                                                         
         LHI   R0,FW_FMST                                                       
         CLC   ACCMST,0(R4)        Test ACCMST I/O                              
         JE    DMGR0030                                                         
         LHI   R0,FW_FARC                                                       
         CLC   ACCARC,0(R4)        Test ACCARC I/O                              
         JE    DMGR0030                                                         
         DC    H'0'                Disallow other files                         
                                                                                
DMGR0020 L     R2,DMGRP4           ACCDIR updative I/O                          
         MVC   DMGRKEY,0(R2)                                                    
         SHI   R2,FW_DIROL         Back up by overhead length                   
         USING FW_D,R2             Build directory record                       
         MVC   DMGRSAVE(FW_DIRHL),0(R2)                                         
         XC    FW_D(FW_DIRHL),FW_D                                              
         STC   R0,FW_FILE          Set file number                              
         LHI   RF,FW_DIRRL                                                      
         STCM  RF,3,FW_RLEN        Set length of record                         
         MVC   FW_RKEY,DMGRKEY     Set record key                               
         MVI   FW_ACT,FW_AADDD     Set action to DMADD                          
         CLC   DMADDD,0(R3)        Test DMADD                                   
         JE    *+8                                                              
         MVI   FW_ACT,FW_AWRTD     No - set action to DMWRITE                   
         GOTOR PUTOUT,FW_D         Put output record                            
         MVC   FW_D(FW_DIRHL),DMGRSAVE                                          
         J     DMGREXIT                                                         
                                                                                
DMGR0030 L     R2,DMGRP3           ACCMST/ACCARC updative I/O                   
         MVC   DMGRDA,0(R2)        Set disk address                             
         L     R2,DMGRP4           Point to I/O area                            
         MVC   DMGRKEY,0(R2)       Save record key                              
         SR    RF,RF                                                            
         ICM   RF,3,ACCRLEN-ACCRECD(R2)                                         
         AHI   RF,FW_RECOL         Add on length of overhead                    
         SHI   R2,FW_RECOL         Back up by overhead length                   
         USING FW_D,R2             Build file record                            
         MVC   DMGRSAVE(FW_RECHL),0(R2)                                         
         XC    FW_D(FW_RECHL),FW_D                                              
         STC   R0,FW_FILE          Set file number                              
         STCM  RF,3,FW_RLEN        Set record length                            
         MVC   FW_RKEY,DMGRKEY     Set record key                               
         CLI   FW_RKEY+TBAKTYP-TBARECD,TBAKTYPQ                                 
         JNE   DMGR0040                                                         
         MVI   FW_RTYP,ACRTNBT                                                  
DMGR0040 CLI   FW_RKEY+EXCKTYP-EXCRECD,EXCKTYPQ                                 
         JNE   DMGR0050                                                         
         CLI   FW_RKEY+EXCKSUB-EXCRECD,EXCKSUBQ                                 
         JNE   DMGR0050                                                         
         MVI   FW_RTYP,ACRTEXPC                                                 
DMGR0050 MVI   FW_ACT,FW_APUTR     Set action to PUTREC                         
         MVC   FW_RDA,DMGRDA       Set disk address                             
         CLC   DMPUTF,0(R3)        Test PUTREC                                  
         JE    *+14                                                             
         MVI   FW_ACT,FW_AADDR     No - set action to ADDREC                    
         XC    FW_RDA,FW_RDA       and clear disk address                       
         GOTOR PUTOUT,FW_D         Put output record                            
         MVC   FW_D(FW_RECHL),DMGRSAVE                                          
         J     DMGREXIT                                                         
                                                                                
DMGRREAL GOTOR DATAMGR,DMGRDMCB    Call real DATAMGR                            
                                                                                
DMGREXIT L     R1,DMGRSVR1         Restore caller's parameter list              
         MVC   0(DMGRPL,R1),DMGRDMCB                                            
         CLI   DMGRERRS,0          Set condition code for caller                
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Handle special $ADDTRN actions                                      *         
***********************************************************************         
                                                                                
         USING OB_D,VKEYAREA                                                    
ADDTRN   CLI   DMGRACTN,FW_AAHDR   Test ADDTRN header                           
         JNE   ADDTRN02                                                         
         LA    R2,DMGRSAVE                                                      
         XC    FW_D(FW_HLNQ),FW_D                                               
         MVI   FW_FILE,FW_FTRN$    Set file to 'ADDTRN'                         
         MVI   FW_ACT,FW_AAHDR     Set action                                   
         LHI   RF,FW_HLNQ                                                       
         STCM  RF,3,FW_RLEN                                                     
         GOTOR PUTOUT,FW_D         Put ADDTRN header record                     
         MVC   FW_D(FW_HLNQ),DMGRSAVE                                           
         GOTOR INIBUF                                                           
         J     DMGREXIT                                                         
                                                                                
ADDTRN02 CLI   DMGRACTN,FW_AATRN   Test ADDTRN transaction record               
         JNE   ADDTRN10                                                         
         L     R2,ATRNREC                                                       
ADDTRN04 MVC   OB_KEY(L'ACTKEY),0(R2)                                           
         GOTOR GETBUF,OB_D         See if key of trans already exists           
         JL    ADDTRN06            No - add to buffer                           
         LLC   RF,TRNKSBR-TRNRECD(R2)                                           
         AHI   RF,1                                                             
         STC   RF,TRNKSBR-TRNRECD(R2)                                           
         J     ADDTRN04                                                         
                                                                                
ADDTRN06 GOTOR ADDBUF,OB_D                                                      
         XC    OB_D(OB_LNQ),OB_D                                                
         MVC   DMGRKEY,0(R2)       Save transaction record key                  
         SR    RF,RF                                                            
         ICM   RF,3,TRNRLEN-TRNRECD(R2)                                         
         JNZ   *+6                                                              
         DC    H'0'                Record length can't be zero                  
         CHI   RF,MAXRECLN                                                      
         JNH   *+6                                                              
         DC    H'0'                Nor greater than the maximum                 
         AHI   RF,FW_ATOLQ         Add on overhead length                       
         SHI   R2,FW_ATOLQ         Back-up by overhead length                   
         MVC   DMGRSAVE(FW_ATHLQ),0(R2)                                         
         XC    FW_D(FW_ATHLQ),FW_D                                              
         STCM  RF,3,FW_RLEN        Set record length                            
         MVI   FW_FILE,FW_FTRN$    Set file to 'ADDTRN'                         
         MVI   FW_ACT,FW_AATRN     Set action                                   
         MVC   FW_RKEY,DMGRKEY     Set transaction key                          
         TM    STPOSTNG,STBUCKET   Test posting buckets only                    
         JZ    *+8                                                              
         MVI   FW_ATTI2,TRNIUBKO+TRNIUOFC                                       
         MVC   FW_ATMOA,HD_MOA     Set month of activity                        
         L     R1,DMGRP2                                                        
         MVC   FW_ATCAN,0(R1)      Set contra-account name                      
         GOTOR PUTOUT,FW_D         Put ADDTRN transaction record                
         MVC   FW_D(FW_ATHLQ),DMGRSAVE                                          
         J     DMGREXIT                                                         
                                                                                
ADDTRN10 CLI   DMGRACTN,FW_AAEND   Test ADDTRN end record                       
         JE    *+6                                                              
         DC    H'0'                                                             
         LA    R2,DMGRSAVE                                                      
         XC    FW_D(FW_HLNQ),FW_D                                               
         MVI   FW_FILE,FW_FTRN$    Set file to 'ADDTRN'                         
         MVI   FW_ACT,FW_AAEND     Set action                                   
         MVI   FW_RKEY,FF          Set key to high values                       
         MVC   FW_RKEY+1(L'FW_RKEY-1),FW_RKEY                                   
         LHI   RF,FW_HLNQ                                                       
         STCM  RF,3,FW_RLEN                                                     
         GOTOR PUTOUT,FW_D         Put ADDTRN end record                        
         J     DMGREXIT                                                         
         EJECT                                                                  
***********************************************************************         
* Handle special $LOKREC actions                                      *         
***********************************************************************         
                                                                                
LOKREC   LA    R2,DMGRSAVE         Point to build area                          
         XC    FW_D(FW_DIRRL),FW_D                                              
         MVI   FW_FILE,FW_FLOK$    Set file                                     
         L     R1,DMGRP2           Point to lock key                            
         MVC   FW_LKKEY,0(R1)      Set LOCKET key to be unlocked                
         LHI   R0,FW_LKRL                                                       
         STCM  R0,3,FW_RLEN                                                     
         GOTOR PUTOUT,FW_D         Put LOCKET record to output file             
         J     DMGREXIT                                                         
         DROP  R2,RC                                                            
                                                                                
DMWORKD  DSECT                     ** DMGRXTRN s/r local w/s **                 
DMGRSVR1 DS    A                   A(Caller's parameter list)                   
                                                                                
DMGRDMCB DS    0XL(DMGRPL)         ** Caller's parameter list **                
DMGRACTN DS    0X                  Action code (special records)                
DMGRP1   DS    A                   A(Action)                                    
DMGRP2   DS    A                   A(File)                                      
DMGRERRS DS    0X                  Error return byte                            
DMGRP3   DS    A                   A(Disk address)                              
DMGRP4   DS    A                   A(I/O area)                                  
DMGRP5   DS    A                   A(DMWORK area)                               
DMGRP6   DS    A                   N/D                                          
DMGRPL   EQU   *-DMGRP1                                                         
                                                                                
DMGRFLAG DS    X                   ** DMGRXTRN flag byte **                     
DMGRFINT EQU   X'80'               Internal (VDATAMGR) call                     
DMGRFEXT EQU   X'40'               External (CDATAMGR) call                     
                                                                                
DMGRDA   DS    XL(L'IODA)          Disk address                                 
DMGRKEY  DS    XL(L'ACCKEY)        Key                                          
DMGRSAVE DS    XL128               Save area                                    
VKEYAREA DS    XL(OB_LNQ)                                                       
         ORG   VKEYAREA+(OB_DATA-OB_D)                                          
OB_KEY2  DS    CL(L'ACTKEY)        Real key                                     
         ORG                                                                    
DMWORKL  EQU   *-DMWORKD                                                        
SVRDEF   CSECT                                                                  
         EJECT                                                                  
***********************************************************************         
* Put record to FACWRK recovery                                       *         
***********************************************************************         
                                                                                
PUTOUT   NTR1  LABEL=NO                                                         
         J     *+12                                                             
         DC    C'*PUTOUT*'                                                      
                                                                                
         LR    R2,R1                                                            
         USING FW_D,R2             R2=A(Record to put)                          
                                                                                
         TM    LP_FLAG,LP_FDRFT    Test 'draft' (validation) mode               
         JZ    *+6                 No                                           
         DC    H'0'                Updative I/O in draft mode                   
                                                                                
         TM    RUNINDS,RUNIPUTF    Test first time call                         
         JNZ   PUTOUT06                                                         
         OI    RUNINDS,RUNIPUTF    Set not first time call                      
         XC    DMGRSEQ#,DMGRSEQ#   Initialise sequence number                   
                                                                                
         TM    LP_FLAG,LP_FOFFL    Test running off-line                        
         JZ    PUTOUT02            No - use FACWRK                              
         GOTO1 VSORTER,DMCB,SORTCARD,SORTTYPE                                   
                                                                                
PUTOUT02 L     R3,WRKBLKR                                                       
         USING WRKIOD,R3           R3=A(FACWRK WRKIO block)                     
         L     R4,WRKIAREC                                                      
H        USING FW_D,R4             Build FACWRK header record                   
         LA    R0,H.FW_D                                                        
         LHI   R1,FW_HDRL                                                       
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         LHI   R0,FW_HDRL                                                       
         STCM  R0,3,H.FW_RLEN                                                   
         MVC   H.FW_HSTMP,FWHSTAMP Set SRUPDxx file stamp                       
         MVI   H.FW_HOLAY,FW_OBOTU Set to call SRUPD60 in FACPAK                
         MVC   H.FW_HSENA,LP_SENO  Set SE number                                
         TM    LP_FLAG,LP_FOFFL    Test running off-line                        
         JZ    *+8                                                              
         OI    H.FW_FLAG,FW_FOFFL  Set running off-line                         
         TM    LP_OFLG1,LP_OFKFW   Test don't purge =FWK file                   
         JZ    *+8                                                              
         OI    H.FW_FLAG,FW_FKFWK  Set don't purge =FWK file                    
         MVC   H.FW_AGY,LP_AGY     Set agency alpha ID                          
         MVC   H.FW_USER,LP_USRID  Set user-ID                                  
         MVC   H.FW_CPY,CUXCPY     Set company code                             
         MVC   H.FW_CPYS1,CPYSTAT1 Set company status bytes                     
         MVC   H.FW_CPYS2,CPYSTAT2                                              
         MVC   H.FW_CPYS3,CPYSTAT3                                              
         MVC   H.FW_CPYS4,CPYSTAT4                                              
         MVC   H.FW_CPYS5,CPYSTAT5                                              
         MVC   H.FW_CPYS6,CPYSTAT6                                              
         MVC   H.FW_CPYS7,CPYSTAT7                                              
         MVC   H.FW_CPYS8,CPYSTAT8                                              
         MVC   H.FW_CPYS9,CPYSTAT9                                              
         MVC   H.FW_CPYSA,CPYSTATA                                              
*&&UK*&& MVC   H.FW_CPYSB,CPYSTATB                                              
*&&UK*&& MVC   H.FW_CPYSC,CPYSTATC                                              
         MVC   H.FW_CPYGL,CPYGLMOA GL MOA                                       
         MVC   H.FW_PERLV,ONERL1L  Set 1R ledger levels                         
         MVI   H.FW_BOVLY,FW_BEXPN Set expense module calling                   
         TM    LP_FLAG,LP_FOFFL    Test running off-line                        
         JZ    PUTOUT04            No - use FACWRK                              
         GOTO1 VSORTER,DMCB,SORTPUT,H.FW_RLEN                                   
         J     PUTOUT06                                                         
                                                                                
PUTOUT04 GOTOR DATAMGR,WRKIPARM,ADD                                             
         JE    PUTOUT06                                                         
         DC    H'0'                                                             
         DROP  R3,H                                                             
                                                                                
PUTOUT06 TM    FW_FILE,FW_DMGR     Test normal DATAMGR I/O                      
         JNO   PUTOUT08            No                                           
         ICM   R0,15,DMGRSEQ#      Bump record sequence number                  
         AHI   R0,1                                                             
         STCM  R0,15,DMGRSEQ#                                                   
         STCM  R0,15,FW_SEQ#       Set sequence number in record                
                                                                                
PUTOUT08 TM    LP_FLAG,LP_FOFFL    Test running off-line                        
         JZ    PUTOUT10            No - use FACWRK                              
         GOTO1 VSORTER,DMCB,SORTPUT,FW_D                                        
         J     EXITY                                                            
                                                                                
PUTOUT10 L     R1,WRKBLKR          Put record to FACWRK recovery file           
         MVC   PARM(WRKINDX-WRKIPARM),WRKIPARM-WRKIOD(R1)                       
         GOTOR DATAMGR,PARM,ADD,,,FW_D                                          
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  R2                                                               
         EJECT                                                                  
***********************************************************************         
* Lock the PID for the duration of the upload.  Exit with CC=equal if *         
* locked this time or previously by me.  Exit with CC=not equal if    *         
* there is a lock failure                                             *         
***********************************************************************         
                                                                                
DOLOCK   NTR1  LABEL=NO                                                         
         USING LLKKEYD,WORK                                                     
                                                                                
         LA    R2,CLMLOCK          Point to claim lock table                    
DOLOCK02 OC    0(L'CLMLOCK,R2),0(R2)                                            
         JZ    DOLOCK04            Add new entry if not already locked          
         CLC   HD_CLM#,0(R2)       Test already locked this claim               
         JNE   *+6                 Yes - I own the lock so all is fine          
         DC    H'0'                                                             
         AHI   R2,L'CLMLOCK        Bump to next entry                           
         J     DOLOCK02                                                         
                                                                                
DOLOCK04 MVC   0(L'CLMLOCK,R2),HD_CLM#                                          
                                                                                
         GOTOR BLDLOK,HD_CLM#      Build LOCKET key                             
         GOTOR LOCKET,DMCB,('LLKTESTQ',LLKKEYD),ACOMFACS                        
         JE    DOLOCK08                                                         
         XC    0(L'CLMLOCK,R2),0(R2)                                            
         MVC   ROUERRV,=AL2(AE$X#LOK)                                           
         J     EXITN                                                            
                                                                                
                                                                                
DOLOCK08 GOTOR LOCKET,DMCB,('LLKLOCKQ',LLKKEYD),ACOMFACS                        
         JE    EXIT                                                             
         DC    H'0'                                                             
                                                                                
***********************************************************************         
* Build a LOCKET key - R1=A(PID#)                                     *         
***********************************************************************         
                                                                                
BLDLOK   NTR1  LABEL=NO            Build LOCKET key                             
         LR    R0,R1               Point to PID                                 
         MVC   LLOCKSE,LP_SENO                                                  
         MVC   LLOCKAGY,LP_AGY                                                  
         MVC   LLOCKRTY,=C'P#'                                                  
         MVC   LLOCKKEY,SPACES                                                  
         MVC   LLOCKKEY(L'HD_CLM#),0(R1)                                        
*        GOTOR VHEXOUT,DMCB,(R0),LLOCKKEY,L'HD_PPID#,0                          
         OC    LLOCKKEY,SPACES                                                  
*        MVI   LLOCKKEY+4,C'X'                                                  
         J     EXIT                                                             
         EJECT                                                                  
***********************************************************************         
* Lock the PID for the duration of the upload.  Exit with CC=equal if *         
* locked this time or previously by me.  Exit with CC=not equal if    *         
* there is a lock failure                                             *         
***********************************************************************         
                                                                                
UNLOCK   NTR1  LABEL=NO                                                         
                                                                                
ULOCK02  LA    R2,CLMLOCK          Unlock everything I locked so far            
ULOCK04  OC    0(L'CLMLOCK,R2),CLMLOCK                                          
         JZ    EXITY                                                            
         GOTOR BLDLOK,(R2)         Build LOCKET key                             
         LHI   R0,LLKUNLKQ         On-line unlock action                        
         TM    LP_FLAG,LP_FOFFL                                                 
         JZ    *+8                                                              
         LHI   R0,LLKUNGLQ         Off-line - running as global                 
         GOTOR LOCKET,DMCB,((R0),LLKKEYD),ACOMFACS                              
         JE    *+6                                                              
         DC    H'0'                Failure to unlock                            
         XC    0(L'CLMLOCK,R2),0(R2)                                            
         AHI   R2,L'CLMLOCK                                                     
         J     ULOCK04                                                          
         EJECT                                                                  
***********************************************************************         
* Set to update manager/client approval status in APPTAB              *         
* On NTRY P1 = A(PID) for approval                                    *         
***********************************************************************         
         SPACE 1                                                                
         USING APPTABD,RF                                                       
SETAPP   NTR1  LABEL=NO                                                         
         L     RF,AAPPTAB          Could be submitting, approving               
*                                                                               
SETAPP02 CLI   APPRLN,0            End of table                                 
         JE    EXITY                                                            
         CLC   APPRPID,0(R1)       Match account code                           
         JE    SETAPP06                                                         
         LLC   R0,APPRLN           Bump to next table entry                     
         AR    RF,R0                                                            
         J     SETAPP02                                                         
                                                                                
SETAPP06 CLI   QH_STAT,QH_APPQ     Approving this time?                         
         JNE   SETAPP08                                                         
         MVI   APPRAST,CIDAAPP                                                  
         J     EXITY                                                            
*                                                                               
SETAPP08 CLI   QH_STAT,QH_REJQ     Rejecting this time?                         
         JNE   EXITY                                                            
         MVI   APPRAST,CIDAREJ                                                  
         J     EXITY                                                            
         DROP  RF                                                               
         EJECT                                                                  
***********************************************************************         
* Remove all line manager approvals from the email notification       *         
***********************************************************************         
         SPACE 1                                                                
         USING APPTABD,RF                                                       
RMLMAP   NTR1  LABEL=NO                                                         
         L     RF,AAPPTAB                                                       
*                                                                               
RMLMAP02 CLI   APPRTYP,APPRTMAN    Check line manager approver lvl 1-3          
         JE    RMLMAP04                                                         
         CLI   APPRTYP,APPRTMA2                                                 
         JE    RMLMAP04                                                         
         CLI   APPRTYP,APPRTMA3                                                 
         JNE   RMLMAP06                                                         
RMLMAP04 NI    APPRAST,X'FF'-CIDAAPP                                            
*                                                                               
RMLMAP06 LLC   R0,APPRLN                                                        
         AR    RF,R0                                                            
         CLI   APPRLN,0            Test end of table                            
         JNE   RMLMAP02                                                         
         J     EXITY               Yes                                          
         EJECT                                                                  
         DROP  RF                                                               
*&&UK                                                                           
***********************************************************************         
* Read office for connected country and currency                      *         
***********************************************************************         
         SPACE 1                                                                
K        USING OFFRECD,IOKEY                                                    
GETCCT   NTR1  LABEL=NO                                                         
         MVC   HD_CURR,AGYCURR     Default to agency currency                   
         MVC   K.OFFKEY,SPACES                                                  
         MVI   K.OFFKTYP,OFFKTYPQ                                               
         MVC   K.OFFKCPY,CUXCPY                                                 
         MVC   K.OFFKOFF,HD_1ROFF                                               
         OC    K.OFFKOFF,SPACES                                                 
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   EXITY                                                            
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     RF,AIO2                                                          
         LA    RF,OFFRFST-OFFRECD(RF)                                           
*                                                                               
         USING OFIELD,RF                                                        
GETCC02  CLI   OFIEL,0                                                          
         JE    EXITY                                                            
         CLI   OFIEL,OFIELQ                                                     
         JE    GETCC04                                                          
         LLC   R0,OFILN                                                         
         AR    RF,R0                                                            
         J     GETCC02                                                          
*                                                                               
GETCC04  CLI   OFILN,OFILNQ        Check element is long enough                 
         JNH   EXITY                                                            
         MVC   HD_CTRY,OFICTRY     Country                                      
         CLC   OFICUR,SPACES                                                    
         JNH   EXITY                                                            
         MVC   HD_CURR,OFICUR      Currency                                     
         J     EXITY                                                            
         EJECT                                                                  
*&&                                                                             
***********************************************************************         
* GENERAL EXITS HERE                                                  *         
***********************************************************************         
                                                                                
EXITH    LHI   RE,2                                                             
         J     EXITCC                                                           
EXITL    DS    0H                                                               
EXITN    LHI   RE,0                                                             
         J     EXITCC                                                           
EXITY    LHI   RE,1                                                             
EXITCC   CHI   RE,1                                                             
EXIT     XIT1  ,                                                                
         EJECT                                                                  
AAUDREC  EQU   AIO1,,C'A'          A(Expense claim audit record)                
APERREC  EQU   AIO1,,C'A'          A(Person record)                             
AEXPREC  EQU   AIO1,,C'A'          A(Expense claim record)                      
*APPTAB  EQU   AIO6,,C'A'          A(APPTAB) - uses IO7 also                    
AAPPTAB  EQU   AIO4,,C'A'          A(APPTAB) - uses IO4/5/6 ONLINE              
ATRNREC  EQU   AIO2,,C'A'          A(Transaction record)                        
ATBAREC  EQU   AIO1,,C'A'          A(Batch item record)                         
ATBARECR EQU   AIO4,,C'A'          A(Reversing batch item record)               
ATBHREC  EQU   AIO3,,C'A'          A(Batch header record)                       
ATBHRECR EQU   AIO5,,C'A'          A(Reversing batch header record)             
                                                                                
MAXRECLN EQU   IOLENQ-(L'IODA+L'IOWORK)                                         
                                                                                
OLDBUF   EQU   1                   Old claim item buffer                        
NEWBUF   EQU   2                   New claim item buffer                        
                                                                                
ONEACU   EQU   1                   Update one accumulator                       
BOTHACU  EQU   2                   Update both accumulators                     
                                                                                
D#TOKEN  EQU   1                   PC token map number                          
D#ERR    EQU   2                   Error message number                         
D#CLM    EQU   3                   claim number                                 
D#CLMTY  EQU   4                   claim type: live or draft                    
D#IDN    EQU   5                   New ID number                                
D#BAT    EQU   6                   Batch ref                                    
D#STA    EQU   7                   New status if changed                        
D#EML    EQU   8                   Email of person claiming                     
D#EMLR   EQU   9                   Email of person who raised claim             
D#ERROW  EQU   10                  Error row number                             
D#CAE    EQU   1                   Type field in TEAP call                      
D#CAEML  EQU   2                   emails required Y/N blank is Y               
                                                                                
CL#PROGR EQU  C'1'                 Claim in progress - saved                    
CL#SUBMT EQU  C'2'                 Claim submitted                              
CL#APPRO EQU  C'3'                 Claim fully approved                         
CL#REJEC EQU  C'4'                 Claim rejected                               
CL#DELET EQU  C'5'                 Claim deleted                                
CL#PAAPR EQU  C'6'                 Claim part approved                          
CL#COMP  EQU  C'7'                 Claim completed and posted                   
                                                                                
TOKNLIT  DC    C'PC Token'                                                      
TOTELIT  DC    C'Total for expense'                                             
FINVLIT  DC    C'Finance view'                                                  
AMZRLIT  DC    C'If amount zero suppress line'                                  
ICHGLIT  DC    C'Is changed'                                                    
AGYILIT  DC    C'Agency input with foreign currency'                            
VEHCLIT  DC    C'Vehicle code'                                                  
FUECLIT  DC    C'Fuel code'                                                     
ENGCLIT  DC    C'Engine size code'                                              
DISLLIT  DC    C'Disclaimer'                                                    
NPASLIT  DC    C'Number of passengers'                                          
ACNMLIT  DC    C'Accumulator number'                                            
RCPCLIT  DC    C'Receipt image changed'                                         
ACDSLIT  DC    C'Accumulated distance'                                          
NVATLIT  DC    C'Non vatable amount'                                            
GRSRLIT  DC    C'Gross rate per mile'                                           
VATRLIT  DC    C'VAT rate per mile'                                             
PASRLIT  DC    C'Passenger rate per mile'                                       
DISBLIT  DC    C'Distance band code'                                            
DISTLIT  DC    C'Distance within band'                                          
DISCLIT  DC    C'Discount rate %'                                               
DAMTLIT  DC    C'Discount amount'                                               
CHTYLIT  DC    C'Change type'                                                   
CETYLIT  DC    C'Etype change'                                                  
CSJALIT  DC    C'Production account change'                                     
CSUPLIT  DC    C'Supplier account change'                                       
COFFLIT  DC    C'Office change'                                                 
*&&US                                                                           
PROVLIT  DC    C'Province'                                                      
GSTALIT  DC    C'GST Amount'                                                    
PSTALIT  DC    C'PST Amount'                                                    
PSTCLIT  DC    C'GST Code'                                                      
*&&                                                                             
TSARLIT  DC    C'*** TSAR Record ***'                                           
HEADLIT  DC    C'*** Header Values **'                                          
TRLRLIT  DC    C'*** Trailer Values **'                                         
         EJECT                                                                  
                                                                                
GLOBALS  DS    0D                  ** GLOBAL LITERALS **                        
         LTORG                                                                  
                                                                                
WORKLEN  DC    AL2(WORKL)                                                       
                                                                                
SRUPD60  DC    C'T10D60  '         Update program phase name                    
SORTCARD DC    C'SORT FIELDS=(5,43,A),FORMAT=BI,WORK=1 '                        
SORTTYPE DC    C'RECORD TYPE=V,LENGTH=(2048,,,100,150) '                        
SORTGET  DC    C'GET'                                                           
SORTPUT  DC    C'PUT'                                                           
                                                                                
PZERO    DC    P'0'                                                             
PNEGONE  DC    P'-1'                                                            
P1HUND   DC    P'100'                                                           
P1THOU   DC    P'1000'                                                          
P1MILL   DC    P'1000000'                                                       
MAXHOURS DC    P'2400'                                                          
EFFS     DC    X'FFFFFFFF'                                                      
PONE     DC    P'1'                                                             
P50MAX   DC    P'50'                                                            
ADDEND   DC    C'ADD=END'                                                       
                                                                                
LEDGERSI DC    C'SI'                                                            
LEDGER28 DC    C'28'                                                            
LEDGER29 DC    C'29'                                                            
LEDGER2D DC    C'2D'                                                            
LEDGER2P DC    C'2P'                                                            
LEDGER1P DC    C'1P'                                                            
LEDGER1R DC    C'1R'                                                            
LEDGER13 DC    C'13'                                                            
LEDGER1C DC    C'1C'                                                            
LEDGERSG DC    C'SG'                                                            
LEDGERSJ DC    C'SJ'                                                            
                                                                                
ACT999   DC    CL12'999999999999'                                               
ACTDISC  DC    CL12'MD          '                                               
                                                                                
FWHSTAMP DC    X'00',C'UO'         FACWRK header record stamp                   
                                                                                
RETDATEL DC    AL1(LQ_RDATQ),AL2(LQ_LN1Q)                                       
                                                                                
ACCOUNT  DC    C'ACC'              Account file prefix                          
                                                                                
DMWRTD   DC    C'DMW'              DMWRITE (directory)                          
DMADDD   DC    C'DMA'              DMADD   (directory)                          
DMPUTF   DC    C'PUT'              PUTREC  (file)                               
DMADDF   DC    C'ADD'              ADDREC  (file)                               
                                                                                
DMREAD   DC    C'DMREAD  '         DMREAD  (directory)                          
DMGETR   DC    C'GETREC  '         GETREC  (file)                               
                                                                                
DMCOMMIT DC    C'COMMIT  '         Recovery checkpoint command                  
                                                                                
$ADDTRN  DC    C'$ATR'             ADDTRN file prefix                           
$PLDREC  DC    C'$PLD'             PLDREC file prefix                           
$TIMREC  DC    C'$TIM'             TIMREC file prefix                           
$LOKREC  DC    C'$LOK'             LOKREC file prefix                           
                                                                                
ADD      DC    C'ADD     '         FACWRK add                                   
CLOSE    DC    C'CLOSE   '         FACWRK close                                 
INDEX    DC    C'INDEX   '         FACWRK index                                 
READ     DC    C'READ    '         FACWRK read                                  
                                                                                
DMKEY    DC    C'DMKEY   '                                                      
                                                                                
FILES    DS    0C                  ** System/File list **                       
         DC    C'ACCOUNT'                                                       
         DC    C'U'                                                             
ACCDIR   DC    C'ACCDIR '                                                       
         DC    C'U'                                                             
ACCMST   DC    C'ACCMST '                                                       
         DC    C'U'                                                             
ACCARC   DC    C'ACCARC '                                                       
         DC    C'U'                                                             
ACCRCV   DC    C'ACCRCV '                                                       
         DC    C'N'                                                             
CTFILE   DC    C'CTFILE '                                                       
         DC    C'X'                                                             
                                                                                
RECTAB   DS    0XL(RECTABL)        ** RECORD TABLE **                           
         DC    AL2(A#XHDR),AL1(RECTHDRQ)                                        
         DC    AL2(A#XITM),AL1(RECTITMQ)                                        
         DC    AL2(A#XXDT),AL1(RECTXDTQ)                                        
         DC    AL2(A#XTRL),AL1(RECTTRLQ)                                        
         DC    AL2(A#AALL),AL1(RECTALLQ)                                        
RECTABN  EQU   (*-RECTAB)/L'RECTAB                                              
                                                                                
APRTAB   DS    0XL1                                                             
         DC    B'11111000'         Office/client/product/job/media              
         DC    B'11011000'         Office/client/product/media                  
         DC    B'10011000'         Office/client/media                          
         DC    B'10010000'         Client/media                                 
         DC    B'00011000'         Office/media                                 
         DC    B'00010000'         Media                                        
         DC    B'11001000'         Office/client/product                        
         DC    B'10001000'         Office/client                                
         DC    B'10000000'         Client                                       
         DC    B'00001000'         Office                                       
         DC    B'00000000'         Agency - use 1R approvers                    
         DC    X'FF'                                                            
                                                                                
JOBTYPE  DS    0H                                                               
         DC    AL1(JOBPAX1B,JOBPAX1N)  Level 1 approvers                        
         DC    AL1(JOBPAX2B,JOBPAX2N)  Level 2 approvers                        
         DC    X'FF'                                                            
                                                                                
EXPTYPE  DS    0H                                                               
         DC    AL1(DPAPAEX1)           Level 1 approver - non bill              
         DC    AL1(DPAPAEX2)           Level 2 approver - non bill              
         DC    AL1(DPAPAEB1)           Level 1 approver - billable              
         DC    AL1(DPAPAEB2)           Level 2 approver - billable              
         DC    X'FF'                                                            
                                                                                
ALVLTAB  DS    0XL1                                                             
         DC    AL1(APPRTCLI,STCXALV1)  Level 1 client approver                  
ALVLTABL EQU   *-ALVLTAB                                                        
         DC    AL1(APPRTCL2,STCXALV2)  Level 2 client approver                  
         DC    AL1(APPRTCL3,STCXALV3)  Level 3 client approver                  
         DC    X'FF'                                                            
                                                                                
TYPTAB   DS    0X                                                               
         DC    AL1(QL_CPJQ),AL1(LIDTCPJL),AL1(LIDLLN9Q)                         
         DC    AL1(OB_ACCC-OB_D)                                                
         DC    AL1(L'OB_ACCC)                                                   
         DC    AL1(LIDLACT-LIDDATA)                                             
         DC    AL1(YESQ),AL1(OB_ACCO-OB_D),AL1(LIDLOFF-LIDDATA)                 
TYPTABLQ EQU   *-TYPTAB                                                         
*                                                                               
         DC    AL1(QL_SUPQ),AL1(LIDTSUPP),AL1(LIDLLN8Q)                         
         DC    AL1(OB_SUC-OB_D)                                                 
         DC    AL1(L'OB_SUC)                                                    
         DC    AL1(LIDLSULA-LIDDATA)                                            
         DC    AL1(YESQ),AL1(OB_SOFF-OB_D),AL1(LIDLOFFC-LIDDATA)                
*                                                                               
         DC    AL1(QL_WCQ),AL1(LIDTWCL),AL1(LIDLLN2Q)                           
         DC    AL1(OB_WCC-OB_D)                                                 
         DC    AL1(L'OB_WCC)                                                    
         DC    AL1(LIDLWC-LIDDATA)                                              
         DC    AL1(NOQ),AL1(0),AL1(0)                                           
*                                                                               
         DC    AL1(QL_ETYQ),AL1(LIDTEXPL),AL1(LIDLLN4Q)                         
         DC    AL1(OB_ETYC-OB_D)                                                
         DC    AL1(L'OB_ETYC)                                                   
         DC    AL1(LIDLETY-LIDDATA)                                             
         DC    AL1(NOQ),AL1(0),AL1(0)                                           
*                                                                               
         DC    AL1(QL_MEDQ),AL1(LIDTMEDL),AL1(LIDLLN3Q)                         
         DC    AL1(OB_MEDC-OB_D)                                                
         DC    AL1(L'OB_MEDC)                                                   
         DC    AL1(LIDLMED-LIDDATA)                                             
         DC    AL1(NOQ),AL1(0),AL1(0)                                           
*                                                                               
         DC    AL1(QL_1RACQ),AL1(LIDT1RAC),AL1(LIDLLN1Q)                        
         DC    AL1(OB_1RAC-OB_D)                                                
         DC    AL1(L'OB_1RAC)                                                   
         DC    AL1(LIDLACT-LIDDATA)                                             
         DC    AL1(NOQ),AL1(0),AL1(0)                                           
*                                                                               
         DC    AL1(QL_NCLQ),AL1(LIDTNCLL),AL1(LIDLLN1Q)                         
         DC    AL1(OB_ACCC-OB_D)                                                
         DC    AL1(L'OB_ACCC)                                                   
         DC    AL1(LIDLACT-LIDDATA)                                             
         DC    AL1(NOQ),AL1(0),AL1(0)                                           
*                                                                               
         DC    AL1(QL_SCRIQ),AL1(LIDTSCRB),AL1(LIDLLN5Q)                        
         DC    AL1(OB_ACCC-OB_D)                                                
         DC    AL1(L'OB_ACCC)                                                   
         DC    AL1(LIDLREP-LIDDATA)                                             
         DC    AL1(NOQ),AL1(0),AL1(0)                                           
*                                                                               
         DC    AL1(QL_ESCHQ),AL1(LIDTESCH),AL1(LIDLLN5Q)                        
         DC    AL1(OB_ACCC-OB_D)                                                
         DC    AL1(L'OB_ACCC)                                                   
         DC    AL1(LIDLSCH-LIDDATA)                                             
         DC    AL1(NOQ),AL1(0),AL1(0)                                           
*                                                                               
         DC    AL1(QL_EXACQ),AL1(LIDTEXPS),AL1(LIDLLN5Q)                        
         DC    AL1(OB_ACCC-OB_D)                                                
         DC    AL1(L'OB_ACCC)                                                   
         DC    AL1(LIDLSCH-LIDDATA)                                             
         DC    AL1(NOQ),AL1(0),AL1(0)                                           
*                                                                               
         DC    X'FF'                                                            
                                                                                
EXSTTAB  DS    0X                                                               
         DC    AL1(STCXINPG,0)                                                  
         DC    AL1(STCXSUBM,EXCSSUBM)                                           
         DC    AL1(STCXLOGD,EXCSLOGD)                                           
         DC    AL1(STCXPAPP,EXCSPAPP)                                           
         DC    AL1(STCXREJE,EXCSREJE)                                           
         DC    AL1(STCXAWFN,EXCSFNTA)                                           
         DC    AL1(STCXCOMP,EXCSCOMP)                                           
         DC    X'FF'                                                            
                                                                                
DCDICTL  DS    0X                                                               
         DCDDL AC#ALLCS,L'AC@ALLCS                                              
         DCDDL AC#NOORD,L'AC@NOORD                                              
         DCDDL AC#NRTV,L'AC@NRTV                                                
DCDICTLX DC    X'FF'                                                            
                                                                                
RECTABD  DSECT                     ** DSECT TO COVER RECORD TABLE **            
RECTMAP# DS    AL2                 RECORD MAP NUMBER                            
RECTTYPE DS    AL1                 ** RECORD TYPE **                            
RECTABL  EQU   *-RECTABD                                                        
                                                                                
RECTHDRQ EQU   1                   Claim header                                 
RECTITMQ EQU   2                   Claim item                                   
RECTXDTQ EQU   3                   Claim extra data                             
RECTTRLQ EQU   4                   Claim trailer                                
RECTALLQ EQU   5                   Add a/c to LimitList                         
                                                                                
         EJECT                                                                  
SVRDEF   CSECT                                                                  
LLP      DC    A(0)                A(LP_D)                                      
         EJECT                                                                  
                                                                                
*** GENERAL UPLOAD RESPONSE DATA MAP NUMBERS                                    
                                                                                
D#UPLERR EQU   255                                                              
D#UPLNOD EQU   254                                                              
                                                                                
         EJECT                                                                  
***********************************************************************         
* Saved working storage                                               *         
***********************************************************************         
                                                                                
SAVED    DSECT                                                                  
                                                                                
***********************************************************************         
* Sacred values                                                       *         
***********************************************************************         
                                                                                
RUNMODE  DS    XL(L'RUNPMODE)      DDLINK/RUNNER mode                           
                                                                                
RUNINDS  DS    X                   ** Run indicators **                         
RUNIPUTF EQU   X'40'               PUTOUT initialised                           
RUNIATRF EQU   X'20'               GOATRN first time flag                       
RUNIBUFF EQU   X'10'               BUFREC first time flag                       
RUNIAURA EQU   X'80'               Aura is the connected application            
RUNIMOB  EQU   X'08'               Mobile is the connected application          
RUNICOMA EQU   X'04'               Comment audit created                        
                                                                                
ASRUPD60 DS    A                   A(SRUPD60)                                   
PROTOFF  DS    A                   A(PROTOFF)                                   
PROTON   DS    A                   A(PROTON)                                    
LOCKET   DS    A                   A(LOCKET)                                    
IDATAMGR DS    A                   A(DMGRITRN)                                  
XDATAMGR DS    A                   A(DMGRXTRN)                                  
MASTC    DS    A                   A(MASTC)                                     
DATAMGR  DS    A                   A(DATAMGR)                                   
WRKBLKR  DS    A                   A(FACWRK WRKIO block)                        
AAPPTN   DS    A                   A(Next APPTAB entry)                         
ACURTYP  DS    A                   A(current TYPTAB entry)                      
VSORTER  DS    A                   A(SORTER) from RSORTER                       
                                                                                
TSARPASS DS    XL(TSPXTNL)         TSAR block for passive pointers              
TSARRECS DS    XL(TSPXTNL)         TSAR block for record buffer                 
TSAROBUF DS    XL(TSPXTNL)         TSAR block for optimisation buffer           
TSAROLDI DS    XL(TSPXTNL)         TSAR block for old claim item buffer         
TSARNEWI DS    XL(TSPXTNL)         TSAR block for new claim item buffer         
                                                                                
COMFACS  DS    XL(COMFACSL)        Local copy of COMFACS                        
                                                                                
CLMLOCK  DS    20XL(L'HD_CLM#)     Claim lock table                             
CLMLOCKL EQU   *-CLMLOCK                                                        
                                                                                
APRPIDS  DS    100XL(L'CL_APPID)   Table of approver pids                       
APRPIDSL EQU   *-APRPIDS                                                        
                                                                                
MYBYTE1  DS    XL1                 Byte 1                                       
MYBYTE2  DS    XL1                 Byte 2                                       
MYBYTE3  DS    XL1                 Byte 3                                       
MYBYTE4  DS    XL1                 Byte 4                                       
MYBYTE5  DS    XL1                 Byte 5                                       
SVTYPE   DS    XL1                 Saved LIDTYPE                                
ERRCNT   DS    XL1                 Error count                                  
ERRMAX   EQU   20                                                               
                                                                                
DSDICTL  DS    0C                                                               
AC@ALLCS DS    CL36                                                             
AC@NOORD DS    CL6                                                              
AC@NRTV  DS    CL10                                                             
                                                                                
SAVEVAR  DS    0F                  ** Variables follow **                       
                                                                                
***********************************************************************         
* Request values                                                      *         
***********************************************************************         
                                                                                
*              *** Claim header ***                                             
                                                                                
QH_VALS  DS    0X                                                               
QH_AHEAD DS    AL4                 A(Passed header values)                      
QH_ACTN  DS    CL1                 Action                                       
QH_APRQ  EQU   X'01'               Approve/reject/submit from list call         
QH_UPDQ  EQU   X'02'               Update call                                  
QH_TYPE  DS    CL1                 Type: Live or draft                          
QH_NUM   DS    CL6                 Claim # (not set on add)                     
QH_DESCL DS    XL1                 Description length                           
QH_DESC  DS    CL36                Description                                  
QH_STAT  DS    CL1                 Status                                       
QH_SAVEQ EQU   X'01'               Save claim                                   
QH_SUBMQ EQU   X'02'               Submit claim                                 
QH_APPQ  EQU   X'03'               Approve claim                                
QH_REJQ  EQU   X'04'               Reject claim                                 
QH_DELQ  EQU   X'05'               Delete claim                                 
QH_CCMTL DS    XL1                 Claimant comment length                      
QH_CCMT  DS    CL100               Claimant comment                             
QH_BKUP  DS    CL1                 Back up approval Yes/No                      
QH_BREF  DS    CL4                 - Batch reference                            
QH_BMOA  DS    XL2                 - Batch MOA                                  
QH_BNAM  DS    CL15                - Batch Name                                 
QH_BCOML DS    XL1                 - Batch Comment length                       
QH_BCOM  DS    CL50                - Batch Comment                              
QH_DATE  DS    XL2                 Claim date (on add only) compressed          
QH_PER   DS    CL8                 Claimant (on behalf of person code)          
QH_IDNUM DS    XL2                 - ID number of claim                         
QH_TOTAL DS    PL6                 Total amount of claim items                  
QH_TOTAD DS    PL6                 Total amount of claim advances               
QH_TOKEN DS    CL8                 PC Token (echoed in error response)          
QH_FINVW DS    CL1                 Finance view was open for update             
QH_IFAMZ DS    CL1                 If amount zero suppress line print           
                                                                                
QH_APPRI DS    X                   Approval indicator                           
QH_AAPPR DS    AL3                 Address of approver list                     
QH_DLNQ  EQU   *-QH_VALS                                                        
                                                                                
*              ** Common item/extra data values **                              
                                                                                
QX_TSAR  DS    AL4                 A(Passed TSAR record)                        
QX_TOKEN DS    CL8                 PC Token (echoed in error response)          
                                                                                
*              *** Claim item data here ***                                     
                                                                                
QI_VALS  DS    0X                                                               
QI_ITM#  DS    XL1                 Item number                                  
QI_DATE  DS    XL2                 Item date                                    
QI_ETYP  DS    CL3                 Expense type code                            
QI_TYPE  DS    CL1                 Bill/Non Bill                                
QI_BILLQ EQU   C'B'                (billable)                                   
QI_NBILQ EQU   C'N'                (non billable)                               
QI_ADVQ  EQU   C'A'                (advance)                                    
QI_CLI   DS    CL6                 Client code                                  
QI_PRO   DS    CL6                 Product code                                 
QI_JOB   DS    CL6                 Job code                                     
QI_RCPT  DS    CL1                 Receipt Y/N                                  
QI_AMT   DS    PL6                 Amount agency currency                       
QI_CUR   DS    CL3                 Currency code of item                        
QI_FAMT  DS    PL6                 FC amount                                    
QI_REF   DS    CL6                 Reference number                             
QI_NARL  DS    XL1                 Finance narrative length                     
QI_NAR   DS    CL100               Finance narrative                            
QI_ONARL DS    XL1                 Claimant narrative length                    
QI_ONAR  DS    CL100               Claimant narrative                           
QI_EXPAC DS    CL14                Expense A/C                                  
QI_SUPAC DS    CL14                Supplier A/C                                 
QI_2PAC  DS    CL12                2P A/C                                       
QI_2DAC  DS    CL12                2D A/C                                       
QI_MILES DS    PL6                 Miles                                        
QI_INT#  DS    CL7                 Internal reference                           
QI_XRAT  DS    XL7                 Exchange rate                                
QI_VATC  DS    CL12                VAT A/C or Code                              
QI_NAMT  DS    PL6                 Net amount                                   
QI_OFF   DS    CL2                 Office of item                               
QI_WC    DS    CL2                 Work code                                    
QI_EST   DS    CL6                 Global/local estimate number                 
QI_DELT  DS    CL1                 Y/N for 'deleted item'                       
QI_ISSEL DS    CL1                 Y/N for select status                        
QI_AGYIN DS    CL1                 Y/N for agency input for foreign cur         
QI_CHNGE DS    CL1                 Y/N for item amended                         
QI_DISC  DS    XL2                 Discount rate                                
QI_DAMT  DS    PL6                 Discount amount                              
QI_VEHCD DS    CL2                 Vehicle code                                 
QI_FUECD DS    CL2                 Fuel code                                    
QI_ENGCD DS    CL2                 Engine code                                  
QI_DISCL DS    CL1                 Disclaimer                                   
QI_NMPAS DS    XL1                 Number of passengers                         
QI_NONVT DS    PL6                 Non vatable amount of distance claim         
QI_DISTI DS    X                   Distance rate indicator                      
QI_ADIST DS    AL3                 Address of distance rate list                
QI_ACUNM DS    XL1                 Accumulator number                           
QI_ACUDS DS    PL6                 Accumulated distance                         
*&&US                                                                           
QI_PROVI DS    CL2                 Province                                     
QI_AMTGS DS    PL6                 GST amount                                   
QI_AMTPS DS    PL6                 PST amount                                   
QI_PSTCD DS    CL1                 PST code                                     
*&&                                                                             
QI_RCPTC DS    CL1                 Receipt image changed Y/N                    
QI_DLNQ  EQU   *-QI_VALS                                                        
                                                                                
*              *** Claim XData ***                                              
                                                                                
QX_VALS  DS    0X                                                               
QX_ITM#  DS    XL1                 - Item number                                
QX_CODE  DS    XL3                 - XDF code                                   
QX_TYPE  DS    CL1                 - XDF type                                   
QX_DATA  DS    CL90                - Data string                                
QX_DLNQ  EQU   *-QX_VALS                                                        
                                                                                
*              ** Trailer record **                                             
QT_TOKEN DS    CL8                 PC Token (echoed in error response)          
QT_COMTI DS    XL1                 Status change comment length                 
QT_COMTA DS    AL3                 Status change comment array                  
QT_ATRLR DS    AL4                 A(Passed trailer values)                     
QT_ATRLQ EQU   *-QH_VALS                                                        
                                                                                
                                                                                
*              *** Add a/c to LimList ***                                       
QL_TYPE  DS    CL1                 - Type                                       
QL_WCQ   EQU   C'W'                  * Work code                                
QL_EXACQ EQU   C'E'                  * Expense account                          
QL_SUPQ  EQU   C'S'                  * Supplier                                 
QL_CPJQ  EQU   C'C'                  * Cli/Pro/Job                              
QL_MEDQ  EQU   C'M'                  * Media code                               
QL_ETYQ  EQU   C'X'                  * Expenditure type                         
QL_NCLQ  EQU   C'N'                  * Non client account                       
QL_1RACQ EQU   C'R'                  * 1R account                               
QL_SCRIQ EQU   C'Q'                  * Scribe report                            
QL_ESCHQ EQU   C'H'                  * Estimate scheme                          
QL_VAL   DS    CL14                - Account (or any value)                     
QL_SEC   DS    CL1                 - Security for groups (Y/N)                  
QL_EST   DS    CL1                 - Activate for Estimates (Y/N)               
QL_EXP   DS    CL1                 - Activate for Expenses (Y/N)                
QL_INV   DS    CL1                 - Activate for Invoices (Y/N)                
QL_JOB   DS    CL1                 - Activate for Jobs (Y/N)                    
QL_ORD   DS    CL1                 - Activate for Orders (Y/N)                  
QL_RES   DS    CL1                 - Activate for Resources (Y/N)               
QL_TIME  DS    CL1                 - Activate for Time (Y/N)                    
QL_REP   DS    CL1                 - Activate for Reports (Y/N)                 
QL_MODLQ EQU   *-QL_EST            Length of modules to activate                
QL_DLNQ  EQU   *-QL_TYPE                                                        
**********************************************************************          
* Derived header values (passed to update phase)                                
**********************************************************************          
HD_VALS  DS    0F                                                               
                                                                                
HD_IND   DS    X                   Header status (see FW_HDIND)                 
*** For expense claims ***                                                      
HD_INOPR EQU   X'80'               No previous claim                            
HD_CLDEL EQU   X'40'               CLDELD added                                 
HD_NOEM  EQU   X'20'               Send no emails                               
HD_NADV  EQU   X'10'               Not all advances                             
                                                                                
*** For update limit list ***                                                   
HD_ADDRQ EQU   X'08'               new record to be added                       
HD_OVFLQ EQU   X'80'               Overflow on audit record                     
HD_VALAQ EQU   X'40'               element for value add found                  
HD_NEWEQ EQU   X'01'               element needs to be added                    
                                                                                
HD_HIST  DS    XL1                 The level of all approvals                   
                                                                                
HD_LTYPE DS    XL1                 List element type                            
*                                                                               
HD_MODS  DS    XL1                 See LIDLAPPL                                 
*HD_VAL   DS    CL(L'QL_VAL)                                                    
*                                                                               
HD_PIND  DS    XL1                 Posting indicator                            
HD_PBOFF EQU   X'40'               Billable posting use 1R office               
HD_PNOFF EQU   X'20'               Non-billable posting use 1R office           
HD_PBINR EQU   X'10'               Reversal batch header initialised            
HD_PBINI EQU   X'08'               Batch header initialised                     
                                                                                
HD_TODP  DS    XL3                 Today's date packed                          
HD_TODC  DS    XL2                 Today's date compressed                      
HD_TODF  DS    CL6                 Today's date character                       
HD_TODP5 DS    XL3                 Today's date packed (from Datcon/15)         
HD_DTHI  DS    XL2                 Highest date for claim item                  
HD_DTLO  DS    XL2                 Lowest date for claim item                   
                                                                                
HD_ST1FR DS    XL(L'EXCKSTAT)      Previous cliam status                        
HD_ST2FR DS    XL(L'EXCKSTA2)      Previous claim status                        
HD_INDX  DS    H                   Previous index number                        
HD_INDXN DS    H                   Next index number                            
                                                                                
HD_OFFC  DS    CL(L'TRNOFFC)       Office                                       
HD_2DOF  DS    CL(L'TRNOFFC)       2D office from person creditor               
HD_1ROFF DS    CL(L'LOCOFF)        Person office code                           
HD_1RDEP DS    CL(L'LOCDEPT)       Department code                              
HD_1RSUB DS    CL(L'LOCSUB)        Sub-department code                          
HD_PPID  DS    0CL(L'PERKCODE)     Synonym for HD_1RPER                         
HD_1RPER DS    CL(L'PERKCODE)      Person code                                  
HD_PPID# DS    XL(L'PIDNO)         Person PID number                            
HD_DATEC DS    XL(L'EXCKDATE)      Claim date compressed complimented           
HD_DATE  DS    XL(L'EXCKDATE)      Claim date compressed                        
HD_DATEP DS    XL3                 Claim date packed                            
HD_MOA   DS    XL3                 Claim MOA                                    
                                                                                
HD_CLM#  DS    CL(L'EXCKREF)       Claim number                                 
HD_CLMTY DS    CL(L'EXCKTYPE)      Claim type: Live or draft                    
HD_OPID  DS    XL(L'CLDPIDAD)      Original pid that added claim                
HD_OUID  DS    XL(L'CLDUID)        Original user id that added claim            
HD_APDTE DS    XL(L'CLDAPDTE)      Approved for finance date                    
HD_APPID DS    XL(L'CLDPIDAD)      Final approver who approved                  
HD_ITCNT DS    PL(L'EXCKNITM)      Number of items on claim                     
HD_APCNT DS    PL(L'EXCKNAPP)      Number of approvers on claim                 
HD_CCMTL DS    XL1                 Length of claimant comments                  
HD_CCMT  DS    CL(L'CLDCCMT)       Claimant comments                            
HD_DESCL DS    XL1                 Description length                           
HD_DESC  DS    CL36                Description                                  
                                                                                
HD_1RULA DS    0CL(L'ACTKULA)      ** Person 1R account **                      
HD_1RUNT DS    CL(L'ACTKUNT)       Unit                                         
HD_1RLDG DS    CL(L'ACTKLDG)       Ledger                                       
HD_1RACT DS    CL(L'ACTKACT)       Account code                                 
HD_SUPAC DS    CL(L'ACTKULA)       Supplier account code                        
                                                                                
HD_COCCM DS    CL(L'COCCM)         Force comments on submitting claim           
HD_COACM DS    CL(L'COACM)         Force comments on approving claim            
HD_CONMX DS    CL(L'CONMX)         No mixing of types billable and non          
HD_COBDT DS    PL(L'COBDT)         Number of months they can back date          
HD_COECL DS    CL(L'COECL)         Estimate on claim items                      
HD_COENR DS    CL(L'COENR)         Narrative:Yes No Only when no recpt          
HD_COBCA DS    CL(L'COBCA)         Bypass client approvals                      
HD_COTNB DS    PL(L'COTNB)         Threshold for non billable claims            
HD_COLMA DS    CL(L'COLMA)         Line manager not reqd when cli apprd         
HD_COCAE DS    CL(L'COCAE)         New approver workflow in expenses            
HD_COMIL DS    CL(L'COMIL)         New mileage rate system in use               
                                                                                
HD_OWNVL DS    PL6                 Highest value users approves                 
                                                                                
HD_CLSTA DS    XL1                 Status byte for CLDELD element               
                                                                                
HD_LMAPN DS    X                   Number of line manager approvers             
                                                                                
HD_LMAP  DS    0X                  ** Line manager approver array **            
HD_LMVAL DS    PL6                 Line manager value                           
HD_LMSTA DS    XL1                 Line manager approver status                 
HD_THIST EQU   X'40'               Approved/rejected this time                  
HD_LMPID DS    XL2                 Line manager approver PID                    
HD_LMBUP DS    10XL(L'PIDNO)       Back up line manager approver PID            
HD_LMLVL DS    XL1                 Level of approver                            
HD_LMAPL EQU   *-HD_LMAP           Length of entry                              
         DS    (HD_MAXA-1)XL(HD_LMAPL)                                          
                                                                                
HD_OLMPN DS    XL1                 Previous number of line managers             
                                                                                
HD_OLMAP DS    0X                  ** Prev line manager apprvr array **         
HD_OLMVL DS    PL6                 Line manager value                           
HD_OLMST DS    XL1                 Line manager approver status                 
HD_OLMPD DS    XL2                 Line manager approver PID                    
HD_OLMLV DS    XL1                 Level of approver                            
HD_OLMAL EQU   *-HD_OLMAP          Length of entry                              
         DS    (HD_MAXA-1)XL(HD_OLMAL)                                          
                                                                                
HD_MAXA  EQU   8                                                                
HD_FMAXA EQU   2                                                                
HD_BAMAX EQU   10                                                               
                                                                                
HD_FNAPN DS    X                   Number of finance approvers                  
                                                                                
HD_FNAP  DS    0X                  ** Finance approver array **                 
HD_FNVAL DS    PL6                 Finance approver value                       
HD_FNSTA DS    XL1                 Finance approver status                      
HD_FNPID DS    XL2                 Finance approver PID Default                 
HD_FNAPL EQU   *-HD_FNAP           Length of entry                              
         DS    (HD_FMAXA-1)XL(HD_FNAPL)                                         
                                                                                
HD_USRFN DS    CL1                 Is user finance approver, Y or N             
HD_USRLM DS    CL1                 Is user line manager, Y or N                 
                                                                                
HD_EMLCL DS    CL52                Email of claimer                             
HD_EMLRS DS    CL52                Email of raiser if diff to claimer           
                                                                                
*&&UK                                                                           
HD_CTRY  DS    XL1                 Country of connected user                    
HD_CURR  DS    CL3                 Currency of connected user                   
*&&                                                                             
HD_SUBP  DS    CL8                 Submitted PID                                
HD_SUBD  DS    PL3                 Submitted date                               
HD_VALSL EQU   *-HD_VALS                                                        
***********************************************************************         
* Derived claim line values                                           *         
***********************************************************************         
CS_VALS  DS    0F                                                               
                                                                                
CS_SEQ   DS    XL(L'CIDSEQ)        Saved working item sequence                  
                                                                                
CS_ULA   DS    0CL(L'ACTKULA)      ** SJ account code **                        
CS_UNT   DS    CL(L'ACTKUNT)       Unit code                                    
CS_LGD   DS    CL(L'ACTKLDG)       Ledger code                                  
CS_ACT   DS    CL(L'ACTKACT)       Account code                                 
CS_EXPJB DS    CL1                 Job is an expense job                        
CS_CLICD DS    CL(L'GOCLICD)       Cash discount pass to client                 
CS_UWLST DS    CL(L'GOUWLIST)      Unbillable work code list                    
                                                                                
CS_DATE  DS    XL(L'TRNDATE)       Item date                                    
                                                                                
CS_ETYP  DS    CL(L'ETYKCODE)      Etype code                                   
CS_ETST2 DS    CL(L'ETYKSTA2)      Etype status byte 2                          
                                                                                
CS_2DULA DS    0CL(L'ACTKULA)      2D unit ledger account                       
CS_2DUL  DS    CL(L'ACTKUNT+L'ACTKLDG) 2D unit ledger                           
CS_2DAC  DS    CL(L'ACTKACT)       2D account                                   
CS_2DNAM DS    CL(L'NAMEREC)       2D account name                              
CS_2PAC  DS    CL(L'ACTKACT)       2P account                                   
CS_2PNAM DS    CL(L'NAMEREC)       2P account name                              
                                                                                
CS_SUPAC DS    CL(L'ACTKULA)       Supplier account                             
CS_SUNAM DS    CL(L'NAMEREC)       Supplier account name                        
CS_DISC  DS    CL(L'RATRATE)       Supplier discount rate                       
CS_DSULA DS    0CL(L'ACTKULA)      Discount unit ledger account                 
CS_DSUNT DS    CL(L'ACTKUNT)       Discount unit                                
CS_DSLDG DS    CL(L'ACTKLDG)       Discount ledger                              
CS_DSACT DS    CL(L'ACTKACT)       Discount account                             
                                                                                
CS_DEXAC DS    CL(L'ACTKULA)       Default expense ac from etype rec            
CS_EXULA DS    0CL(L'ACTKULA)      Expense unit ledger account                  
CS_EXUNT DS    CL(L'ACTKUNT)       Expense unit                                 
CS_EXLDG DS    CL(L'ACTKLDG)       Expense ledger                               
CS_EXACT DS    CL(L'ACTKACT)       Expense account                              
CS_EXNAM DS    CL(L'NAMEREC)       Expense account name                         
CS_ESTA1 DS    CL(L'RSTSTAT1)      Expense status byte 1                        
CS_ESTA2 DS    CL(L'RSTSTAT2)      Expense status byte 2                        
CS_ESTA4 DS    CL(L'RSTSTAT4)      Expense status byte 4                        
CS_ESTA5 DS    CL(L'RSTSTAT5)      Expense status byte 5                        
CS_COSTG DS    CL(L'RSTCOSTG)      Expense costing group client analys          
*&&US                                                                           
CS_CATCD DS    CL(L'CATCDE)        Category Code - Merged                       
*&&                                                                             
                                                                                
CS_13ULA DS    0CL(L'ACTKULA)      Costing revenue unit ledger account          
CS_13UNT DS    CL(L'ACTKUNT)       Costing revenue unit                         
CS_13LDG DS    CL(L'ACTKLDG)       Costing revenue ledger                       
CS_13ACT DS    CL(L'ACTKACT)       Costing revenue account                      
CS_13NAM DS    CL(L'NAMEREC)       Costing revenue account name                 
CS_1PULA DS    0CL(L'ACTKULA)      Personnel unit ledger account                
CS_1PUNT DS    CL(L'ACTKUNT)       Personnel unit                               
CS_1PLDG DS    CL(L'ACTKLDG)       Personnel ledger                             
CS_1PACT DS    CL(L'ACTKACT)       Personnel account                            
CS_1PNAM DS    CL(L'NAMEREC)       Personnel account name                       
CS_1CULA DS    CL(L'ACTKULA)       Costing client account                       
CS_CLNAM DS    CL(L'NAMEREC)       Client name                                  
CS_PRNAM DS    CL(L'NAMEREC)       Product name                                 
CS_JBNAM DS    CL(L'NAMEREC)       Job name                                     
CS_OFNAM DS    CL(L'NAMEREC)       Office name                                  
CS_MDNAM DS    CL(L'NAMEREC)       Media name                                   
CS_MED   DS    CL1                 Media code                                   
                                                                                
CS_ITYPE DS    C                   ** item type **                              
CS_IBILQ EQU   C'B'                Billable                                     
CS_INONQ EQU   C'N'                Non-billable                                 
CS_IADVQ EQU   C'A'                Advance                                      
                                                                                
CS_OFF   DS    CL(L'QI_OFF)        Office code                                  
CS_SJOFF DS    CL(L'PPRGAOFF)      SJ office code                               
                                                                                
CS_WC    DS    CL(L'CIDMWCD)       work code                                    
CS_DWC   DS    CL(L'CIDMWCD)       Default workcode from etype rec              
                                                                                
CS_MILES DS    PL6                 Miles                                        
                                                                                
CS_VATAC DS    CL(L'ACTKACT)       VAT account (GST for Canada)                 
CS_VATC  DS    CL(L'CIDCVAT)       VAT code    (GST acc for Canada)             
CS_VATRT DS    XL(L'RATRATE)       VAT rate                                     
*&&US                                                                           
CS_PSTC  DS    CL1                 PST Code                                     
CS_PSTAC DS    CL(L'ACTKACT)       PST Account                                  
CS_PSTRT DS    XL(L'RATRATE)       VAT rate                                     
CS_PROV  DS    CL2                 Province code                                
*&&                                                                             
CS_CURC  DS    CL(L'CIDMCUR)       Currency code                                
CS_SUCUR DS    CL(L'CIDMCUR)       Supplier currency code                       
                                                                                
CS_IND1  DS    X                   ** SJ indicators **                          
CS_ICLI  EQU   X'80'               Client level found                           
CS_IPRO  EQU   X'40'               Product level found                          
CS_IJOB  EQU   X'20'               Job level found                              
CS_IERR  EQU   X'10'               Client/prod/job error                        
CS_IADD  EQU   X'08'               Item add                                     
CS_IDEL  EQU   X'04'               Item delete                                  
CS_ICHG  EQU   X'02'               Item change                                  
*                                                                               
CS_IND2  DS    X                                                                
CS_I2BEX EQU   X'80'               Invalid exchange rate, do not use            
*                                                                               
CS_ACCER DS    CL14                Unit ledger account in error                 
                                                                                
CS_VALSL EQU   *-CS_VALS                                                        
                                                                                
***********************************************************************         
* Derived trailer values (passed to update phase)                     *         
***********************************************************************         
                                                                                
TR_VALS  DS    0F                                                               
                                                                                
TR_ST1NW DS    XL(L'EXCKSTAT)      Current/new claim status byte 1              
TR_ST2NW DS    XL(L'EXCKSTA2)      Current/new claim status byte 2              
                                                                                
TR_INDCL DS    X                   Client approval status                       
TR_IMCLI EQU   X'80'               Missing client approval                      
TR_ICLIA EQU   X'40'               Client approval has occurred                 
TR_INCLI EQU   X'20'               No client approval is required               
TR_IAPTT EQU   X'10'               Client approved this time                    
                                                                                
TR_INDLM DS    X                   Line manager approval status                 
TR_IMLMG EQU   X'80'               Missing line manager approval                
TR_ILMGA EQU   X'40'               Line manager approval has occurred           
TR_INLMG EQU   X'20'               No line manager approval is required         
TR_ILNMG EQU   X'10'               We have all line manager approvers           
TR_IRMLN EQU   X'08'               Remove line man approvals from claim         
                                                                                
TR_INDFN DS    X                   Finance approval status                      
TR_IMFMG EQU   X'80'               Missing finance manager approval             
TR_IFMGA EQU   X'40'               Finance man approval has occurred            
TR_INFMG EQU   X'20'               No finance man approval is required          
TR_IFNMG EQU   X'10'               We have all finance approvers                
TR_IRMFN EQU   X'08'               Remove finance approvals from claim          
                                                                                
TR_TAMT  DS    PL6                 Total of claim                               
                                                                                
TR_VALSL EQU   *-TR_VALS                                                        
                                                                                
         EJECT                                                                  
                                                                                
***********************************************************************         
* General working storage values                                      *         
***********************************************************************         
                                                                                
RECTYPE  DS    AL(L'RECTTYPE)      RECORD TYPE                                  
                                                                                
CLMERR   DS    XL(L'TSERRS)        Claim item buffer error return               
                                                                                
SVCLKEY  DS    XL(CL_KEYL)         Save buffer key                              
SAVEITEM DS    XL1                 Item number saved                            
                                                                                
ANXTERR  DS    A                   A(Next error entry)                          
ALSTERR  DS    A                   A(Previous error entry in errtab)            
                                                                                
DMGRSEQ# DS    XL(L'FW_SEQ#)       DATAMGR record sequence number               
                                                                                
STPOSTNG DS    X                   ** CLMTRN s/r posting status **              
STBCKOUT EQU   X'80'               Back out old posting                         
STADDNEW EQU   X'40'               Add new posting                              
STNEGATE EQU   X'20'               Post negative amount                         
STBUCKET EQU   X'10'               Update buckets only                          
STMILVAT EQU   X'08'               Use mileage non vatable code                 
STPOSTG1 EQU   X'04'               Posting 1 has been made                      
                                                                                
POSDATE  DS    XL(L'TRNDATE)       Transaction date                             
POSSTAT  DS    XL(L'TRNSTAT)       Transaction status                           
POSOBTYP DS    XL(L'TRNTYPE)       Transaction batch type                       
POSAMNT  DS    XL(L'TRNAMNT)       Transaction amount                           
POSTYPE  DS    XL1                 Posting type                                 
POSTDR   EQU   X'80'               Debit                                        
POSTCR   EQU   X'40'               Credit                                       
POSDUMNM DS    CL36                Dummy name for contra                        
         DS    0D                                                               
POSITMS  DS    XL(L'TBAKTSEQ)      Number items in batch                        
POSITMSR DS    XL(L'TBAKTSEQ)      Number items in batch - For reversal         
POSBTOT  DS    PL6                 Batch total                                  
POSBTOTR DS    PL6                 Batch total - For reversal                   
POSTOTCR DS    PL6                 Batch credits                                
POSTOTDR DS    PL6                 Batch debits                                 
DSTDTE   DS    XL3                 Distance start date                          
DENDTE   DS    XL3                 Distance end date                            
                                                                                
FNIND    DS    X                   Finance approver indicator                   
FNIHIGH  EQU   X'80'               Highest level read                           
FNIFND   EQU   X'40'               Approver found                               
                                                                                
AMT#     DS    0XL12                                                            
AMTANET  DS    PL6                 Net agency currency                          
AMTENET  DS    PL6                 Net expense currency                         
AMTAGRS  DS    PL6                 Gross agency currency                        
AMTEGRS  DS    PL6                 Gross expense currency                       
AMTANETM DS    PL6                 Minus net agency currency                    
AMTENETM DS    PL6                 Minus net expense currency                   
AMTAVAT  DS    PL6                 VAT agency currency                          
AMTEVAT  DS    PL6                 VAT expense currency                         
AMTADSC  DS    PL6                 Discount agency currency                     
AMTEDSC  DS    PL6                 Discount expense currency                    
AMT#N    EQU   (*-AMT#)/L'AMT#                                                  
                                                                                
EXRULE   DS    XL(L'AFCX)          Foreign exchange rate rule                   
XDFELTAB DS    XL1636              Extra data elements table                    
SAVEVARL EQU   *-SAVEVAR                                                        
                                                                                
CL_CUR   DS    0X                  Current claim item buffer record             
CL_OLD   DS    (CL_LN1Q)X          Old item buffer record (NXTBUF)              
CL_NEW   DS    (CL_LN1Q)X          New item buffer record (NXTBUF)              
                                                                                
         EJECT                                                                  
                                                                                
SAVEL    EQU   *-SAVED                                                          
         ORG   SAVED+(L'SVSERVER-(*-SAVED))  Online SAVED overflow trap         
         EJECT                                                                  
***********************************************************************         
* Claim item/extra data buffer (passed in FW_?????)                   *         
***********************************************************************         
                                                                                
CL_D     DSECT                                                                  
                                                                                
CL_KEY   DS    0X                                                               
                                                                                
CL_#     DS    0XL(CL_ROW#L)       ** item/extra data seq number **             
CL_ITEM# DS    XL1                 Claim item number                            
CL_XDAT# DS    XL3                 Extra data pointer (claim item=zero)         
CL_ROW#L EQU   *-CL_ITEM#                                                       
                                                                                
CL_KEYL  EQU   *-CL_KEY                                                         
                                                                                
CL_LOC   DS    0XL(CL_LOCL)        ** Data location **                          
CL_DA    DS    XL(L'ACCKDA)        Disk address of claim record                 
CL_SCLST DS    AL2                 Displacement to start of cluster             
CL_ECLST DS    AL2                 Displacement to end of cluster               
CL_LOCL  EQU   *-CL_DA                                                          
                                                                                
CL_BSTAT DS    X                   ** Buffer status **                          
CL_BSROB EQU   X'40'               Item exists in other buffer                  
CL_BSRIA EQU   X'20'               Item approved/rejected client mgr.           
CL_BSRNR EQU   X'10'               Row added                                    
CL_BSRCR EQU   X'08'               Row amended                                  
CL_BSRCO EQU   X'04'               New row copied from old buffer               
                                                                                
CL_BDATA DS    0X                  ** Record data follows **                    
                                                                                
***********************************************************************         
* Claim item values                                                   *         
***********************************************************************         
                                                                                
         ORG   CL_BDATA                                                         
CL_IVALS DS    0X                                                               
CL_ADAT  DS    CL(L'CIDMDAT)       Item date                                    
CL_ETYP  DS    CL(L'CIDMEXP)       Item expenditure type                        
CL_INT   DS    CL(L'CIDMINT)       Item internal ref                            
CL_ITYPE DS    CL(L'CIDMTYP)       Item type                                    
CL_RECPT DS    CL(L'CIDMREC)       Item receipt                                 
CL_STAT  DS    XL(L'CIDMSTA)       Item status                                  
CL_CLICD DS    XL1                 Discount taken                               
CL_FCUR  DS    CL(L'CIDMCUR)       Item currency                                
CL_XRT   DS    XL(L'CIDMRAT)       Item exchange rate                           
CL_DSCRT DS    XL(L'CIDMDRT)       Item discount rate                           
CL_AMT   DS    PL(L'CIDMAMT)       Item amount                                  
CL_FAMT  DS    PL(L'CIDMFCA)       Item currency amount                         
CL_DAMT  DS    PL(L'CIDMDISC)      Item discount amount                         
CL_MILE  DS    PL(L'CIDMMIL)       Item mileage                                 
CL_NET   DS    PL(L'CIDMNET)       Item net amount                              
CL_OFF   DS    CL(L'CIDMOFF)       Item office posting                          
CL_SJOFF DS    CL(L'CIDMOFF)       Item client office                           
CL_CLINM DS    CL(L'NAMEREC)       Item client name                             
CL_WC    DS    CL(L'CIDMWCD)       Item workcode                                
CL_REF   DS    CL(L'CIDMREF)       Item reference                               
CL_SJAC  DS    CL(L'CIDCCPJ)       Item production account code                 
CL_EXPJB DS    CL1                 Job is an expense job                        
CL_SUPAC DS    CL(L'CIDCSUP)       Item supplier account incl u/l               
CL_SUNAM DS    CL(L'NAMEREC)       Item supplier account name                   
CL_EXAC  DS    CL(L'CIDCEXP)       Item expense account incl u/l                
CL_EXNAM DS    CL(L'NAMEREC)       Item expense account name                    
CL_ESTA1 DS    XL(L'RSTSTAT1)      Item expense status byte 1                   
CL_ECSTG DS    CL(L'RSTCOSTG)      Item expense costing account                 
CL_1CULA DS    CL(L'ACTKULA)       Item 1C account code incl u/l                
CL_1CNAM DS    CL(L'NAMEREC)       Item 1C account name                         
CL_13ULA DS    0CL(L'ACTKULA)      Item 13 account code incl u/l                
CL_13UNT DS    CL(L'ACTKUNT)       Item 13 unit                                 
CL_13LDG DS    CL(L'ACTKLDG)       Item 13 ledger                               
CL_13ACT DS    CL(L'ACTKACT)       Item 13 account code                         
CL_13NAM DS    CL(L'NAMEREC)       Item 13 account name                         
CL_1PULA DS    0CL(L'ACTKULA)      Item 1P account code incl u/l                
CL_1PUNT DS    CL(L'ACTKUNT)       Item 1P unit                                 
CL_1PLDG DS    CL(L'ACTKLDG)       Item 1P ledger                               
CL_1PACT DS    CL(L'ACTKACT)       Item 1P account code incl u/l                
CL_1PNAM DS    CL(L'NAMEREC)       Item 1P account name                         
CL_2DAC  DS    CL(L'CIDC2DA)       Item 2D account code                         
CL_2DNAM DS    CL(L'NAMEREC)       Item 2D account name                         
CL_28ULA DS    0CL(L'ACTKULA)      28 unit ledger account                       
CL_28UNT DS    CL(L'ACTKUNT)       28 unit                                      
CL_28LDG DS    CL(L'ACTKLDG)       28 ledger                                    
CL_28ACT DS    CL(L'ACTKACT)       28 account                                   
CL_28NAM DS    CL(L'NAMEREC)       Item 28 account name                         
CL_2PAC  DS    CL(L'CIDC2PA)       Item 2P account code                         
CL_2PNAM DS    CL(L'NAMEREC)       Item 2P account name                         
CL_29ULA DS    0CL(L'ACTKULA)      29 unit ledger account                       
CL_29UNT DS    CL(L'ACTKUNT)       29 unit                                      
CL_29LDG DS    CL(L'ACTKLDG)       29 ledger                                    
CL_29ACT DS    CL(L'ACTKACT)       29 account                                   
CL_29NAM DS    CL(L'NAMEREC)       Item 29 account name                         
CL_29ULC DS    0CL(L'ACTKULA)      29 contra unit ledger account                
CL_29UNC DS    CL(L'ACTKUNT)       29 contra unit                               
CL_29LDC DS    CL(L'ACTKLDG)       29 contra ledger                             
CL_29ACC DS    CL(L'ACTKACT)       29 contra account                            
CL_2PULC DS    0CL(L'ACTKULA)      2P contra unit ledger account                
CL_2PUNC DS    CL(L'ACTKUNT)       2P contra unit                               
CL_2PLDC DS    CL(L'ACTKLDG)       2P contra ledger                             
CL_2PACC DS    CL(L'ACTKACT)       2P contra account                            
CL_VATC  DS    CL(L'CIDCVAT)       Item Vat code                                
CL_VATAC DS    CL(L'CIDCVAC)       Item Vat account incl u/l                    
CL_MVTAC DS    CL(L'ACTKACT)       VAT account code for mileage non vat         
CL_MVTC  DS    CL(L'CIDCVAT)       VAT code for mileage non vatable             
CL_MVTRT DS    XL(L'RATRATE)       VAT rate for mileage non vatable             
CL_DSULA DS    CL(L'ACTKULA)       Item discount account code incl u/l          
CL_MED   DS    CL(L'CIDCMED)       Item media code                              
CL_EST   DS    CL(L'CIDCEGN)       Item global estimate number                  
CL_NARL  DS    X                   Narrative length                             
CL_NAR   DS    CL(L'CIDNARR)       Narrative finance                            
CL_NAROL DS    X                   Narrative claimant length                    
CL_NARO  DS    CL(L'CIDNARR)       Narrative claimant                           
*&&US                                                                           
CL_PROV  DS    CL2                 Canadian tax Province code                   
CL_GSTA  DS    PL6                 GST Tax amount                               
CL_PSTA  DS    PL6                 PST Tax amount                               
CL_PSTC  DS    CL1                 PST Code                                     
CL_PSTAC DS    CL(L'ACTKULA)       PST Unit/Ledger/Account                      
*&&                                                                             
CL_RCPTC DS    CL1                 Receipt image changed Y/N                    
                                                                                
CL_MAXA  EQU   2                   Maximum number of approvers                  
CL_AP    DS    0X                                                               
CL_APSTA DS    XL1                 Status of approval                           
CL_APPID DS    XL2                 PID of approver                              
CL_APBUP DS    10XL(L'PIDNO)       Back up approver                             
CL_APL   EQU   *-CL_AP                                                          
         DS    (CL_MAXA-1)XL(CL_APL)                                            
                                                                                
CL_VEHC  DS    CL(L'CIDMVEH)       Vehicle code                                 
CL_ENGC  DS    CL(L'CIDMENG)       Engine code                                  
CL_FUEL  DS    CL(L'CIDMFUEL)      Fuel type                                    
CL_PASS  DS    CL(L'CIDMPASS)      Number of passengers                         
CL_NONVT DS    CL(L'CIDMNVTA)      Non vatable amount of distance claim         
CL_ACUNM DS    CL(L'CIDMACNM)      Accumulator number                           
CL_ACUDS DS    CL(L'CIDMACDS)      Accumulated distance                         
                                                                                
CL_MAXD  EQU   3                   Maximum number of distance bands             
CL_DRTE  DS    0X                                                               
CL_DBND  DS    CL(L'CIDMDBND)      Distance band                                
CL_DIST  DS    PL(L'CIDMDIST)      Distance covered in band                     
CL_GRSRT DS    PL(L'CIDMDGRT)      Gross rate                                   
CL_VATRT DS    PL(L'CIDMDVRT)      Vat rate                                     
CL_PASRT DS    PL(L'CIDMDPRT)      Passenger rate                               
CL_DRTEL EQU   *-CL_DRTE                                                        
         DS    (CL_MAXD-1)XL(CL_DRTEL)                                          
                                                                                
CL_IVALL EQU   *-CL_IVALS                                                       
                                                                                
***********************************************************************         
* Extra data values                                                   *         
***********************************************************************         
                                                                                
         ORG   CL_BDATA                                                         
CL_XVALS DS    0X                                                               
CL_XTYPE DS    XL(L'XDFXTYP)                                                    
CL_XCHLN DS    XL1                                                              
CL_XCHAR DS    CL(L'STCXXDCH)                                                   
                                                                                
CL_XVALL EQU   *-CL_XVALS                                                       
                                                                                
         ORG                                                                    
                                                                                
CL_LN1Q  EQU   *-CL_D                                                           
                                                                                
***********************************************************************         
* Error table                                                         *         
***********************************************************************         
                                                                                
ET_D     DSECT                                                                  
ET_EOTQ  EQU   FF                  End of table indiciator                      
ET_LN    DS    X                   Length of this entry                         
ET_ERRNO DS    XL(L'ROUERRV)       Error number                                 
ET_ROWNM DS    XL1                 Row number error applies                     
ET_LN1Q  EQU   *-ET_D                                                           
ET_EXTRA DS    0C                  Extra error text                             
                                                                                
***********************************************************************         
* Approval hierarchy search table DSECT                               *         
***********************************************************************         
                                                                                
APRTABD  DSECT                                                                  
APRSTAT  DS    XL1                 Levels to include                            
APRCLI   EQU   X'80'               Client                                       
APRPRO   EQU   X'40'               Product                                      
APRJOB   EQU   X'20'               Job                                          
APRMED   EQU   X'10'               Media                                        
APROFF   EQU   X'08'               Office                                       
APRTABL  EQU   *-APRTABD                                                        
                                                                                
***********************************************************************         
* Job passive type search table DSECT                                 *         
***********************************************************************         
                                                                                
JOBTYPD  DSECT                                                                  
JOBBILL  DS    XL1                 Billable                                     
JOBNONB  DS    XL1                 Non-billable                                 
JOBTYPLQ EQU   *-JOBTYPD                                                        
                                                                                
***********************************************************************         
* Audit expense status table DSECT                                    *         
***********************************************************************         
                                                                                
EXSTTABD DSECT                                                                  
EXSTCHAR DS    CL1                 Character for status element                 
EXSTSTA  DS    XL1                 Status bit on expense record                 
EXSTTABL EQU   *-EXSTTABD                                                       
                                                                                
***********************************************************************         
* Optimisation buffer record layout                                   *         
***********************************************************************         
                                                                                
OB_D     DSECT                                                                  
                                                                                
OB_KEY   DS    XL42                Record key                                   
                                                                                
OB_ERROR DS    XL2                 Error number (Zero=OK)                       
                                                                                
OB_DATA  DS    0X                  Data starts here                             
OB_NAME  DS    CL(L'NAMEREC)       Record name                                  
OB_OTHER DS    0X                  Other data                                   
         ORG   OB_D+256                                                         
                                                                                
OB_DATAL EQU   *-OB_ERROR                                                       
OB_LNQ   EQU   *-OB_D                                                           
*                                                                               
         ORG   OB_KEY                                                           
OB_TYPE  DS    CL1                 LIDELD TYPE                                  
OB_ELEM  DS    0CL16                                                            
OB_PID   DS    XL2                 PERSONAL ID                                  
         DS    CL14                                                             
         ORG   OB_PID                                                           
OB_ACCC  DS    CL12                ACCOUNT CODE                                 
OB_ACCO  DS    CL2                 ACCOUNT OFFICE                               
         DS    CL2                                                              
         ORG   OB_ACCC                                                          
OB_ETYC  DS    CL3                 EXPENDITURE TYPE CODE                        
         DS    CL13                                                             
         ORG   OB_ETYC                                                          
OB_WCC   DS    CL2                 WORK CODE                                    
         DS    CL14                                                             
         ORG   OB_WCC                                                           
OB_MEDC  DS    CL(L'LIDLMED)       MEDIA CODE                                   
         DS    CL17                                                             
         ORG   OB_MEDC                                                          
OB_1RAC  DS    CL(L'ACTKULA)       1R ACCOUNT CODE                              
         DS    CL2                                                              
         ORG   OB_1RAC                                                          
OB_FORM  DS    CL8                 FORMAT CODE                                  
         DS    CL8                                                              
         ORG   OB_FORM                                                          
OB_SUOF  DS    0CL(L'OB_SOFF+L'OB_SUC)                                          
OB_SOFF  DS    CL2                 SUPPLIER OFFICE CODE                         
OB_SUC   DS    CL(L'ACTKACT+2)     SUPPLIER ACCOUNT CODE                        
         ORG   OB_SUOF                                                          
OB_SCHCD DS    CL8                 SCHEME CODE                                  
         DS    CL8                                                              
         ORG                                                                    
         ORG   OB_DATA                                                          
OB_APPLS DS    0XL2                APPLICATION FILTER TO THE END                
OB_APPL1 DS    XL1                                                              
OB_APPL2 DS    XL1                                                              
         ORG                                                                    
***********************************************************************         
* Type table dsect                                                    *         
***********************************************************************         
         SPACE 1                                                                
TYPTABD  DSECT                                                                  
TYPCTYP  DS    CL1                 CHARACTER TYPE                               
TYPETYP  DS    XL1                 LIDTYPE TYPE OF LIDELD                       
TYPELML  DS    XL1                 SUB-ELEMENT LENGTH                           
TYPBDIS  DS    XL1                 DISPLACEMENT IN BUFFER                       
TYPBLEN  DS    XL1                 LENGTH OF ITEM IN BUFFER                     
TYPEDIS  DS    XL1                 DISPLACEMENT OF DATA ENTRY IN LIDELD         
TYPISOF  DS    XL1                 IS OFFICE PRESENT                            
TYPOBDI  DS    XL1                 OFFICE DISPLACEMENT IN BUFFER                
TYPOEDI  DS    XL1                 OFFICE DISPLACEMENT IN ELEMENT               
                                                                                
QT_COMTD DSECT ,                   ** Comment array DSECT **                    
QT_COML  DS    XL1                                                              
QT_COMR  DS    CL(L'STCXCOMT)                                                   
QT_COMLL EQU   *-QT_COML                                                        
                                                                                
       ++INCLUDE SRUPD60D                                                       
       ++INCLUDE ACTRAND                                                        
                                                                                
*  Other included books follow                                                  
         PRINT OFF                                                              
       ++INCLUDE ACBRAWRKD                                                      
*&&US                                                                           
       ++INCLUDE ACCATCALLD                                                     
*&&                                                                             
ADDTRND  DSECT                                                                  
       ++INCLUDE ACADDTRND                                                      
       ++INCLUDE ACRCVRECD                                                      
*PREFIX=L                                                                       
       ++INCLUDE FALOCKETD                                                      
*PREFIX=                                                                        
LOCKETD  DSECT                                                                  
LOCKETL  EQU   *-LOCKETD                                                        
       ++INCLUDE ACVATICAND                                                     
         PRINT ON                                                               
                                                                                
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'066ACBRA16   01/06/21'                                      
         END                                                                    
