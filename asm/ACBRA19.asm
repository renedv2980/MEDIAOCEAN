*          DATA SET ACBRA19    AT LEVEL 102 AS OF 11/20/17                      
*PHASE T62419A                                                                  
                                                                                
         TITLE 'Aura Job Download Server'                                       
                                                                                
***********************************************************************         
* Level change comments                                                         
* ---------------------                                                         
* UK Levels                                                                     
* ---------                                                                     
* TKLU 001 04MAY06 Jobs DownLoads - made a seperate server                      
* TKLU 002 05JUL06 <DU01-5577> 'draft account' flag for SJ ledger               
* TKLU     10JUL06 Preparations for JobBag download                             
* TKLU 003 26JUL06 Further preparations for JobBag download                     
* TKLU 004 09AUG06 <DU01-5577> draft account checking                           
* TKLU 005 17AUG06 Final work on JobBag download                                
* TKLU 006 04AUG06 Some additions for JobBag details download                   
* TKLU 007 08SEP06 <DU01-5771> Job approvals - new list/search parms            
* TKLU 008 12SEP06 <DU01-5771> Job approvals - implement list columns           
* TKLU 009 13SEP06 Apply limit lists to JobList (missing from phase 1)          
*                  + Security passed to exclude hours from JobBag               
*                  + implementation of job approver (Job List)                  
* TKLU 010 20SEP06 <tk1049375> user field changes for non office based          
*                  agencies                                                     
* TKLU 011 18SEP06 JobBag distinguish internal from external costs              
*          19SEP06 <DU01-5734> column restrictions for GAOV calls               
*          26SEP06 New Job Audit download (Jobs phase 2)                        
*          27SEP06 Preparations for MCS -> BRA                                  
*                  + new job ID number (JOBREVNO)                               
* TKLU 012 09OCT06 JobBag bug fixes                                             
* TKLU 013 17OCT06 Preparations for Status/PID search in Jobs                   
* TKLU 014 23OCT06 FINAL RENAME FROM MCS TO BRA                                 
* TKLU 015 26OCT06 <DU01-5771> Status/PID search completion +                   
*                  JobBag pass back order number and estimate name              
* TKLU 016 06DEC06 Job approver bug fix                                         
*                  Ensure 'EX   Rn,*+4' is not used anymore (assembler)         
* TKLU 017 18DEC06 Job list & search additional return fields                   
* TKLU 018 03JAN07 CHKJAL - fix a bad branch instruction                        
* TKLU 019 03JAN07 New Job Approver download                                    
* TKLU 020 10JAN07 Job submitter and status search bug fixes                    
* TKLU 021 15JAN07 Show whether user is valid approver in status                
*                  and fix various job costs inconsistencies                    
*          18JAN07 Add level of approver to approver d/load                     
* TKLU 022 26JAN07 <UKCR00010516> client/product name bug fix                   
* TKLU 023 20FEB07 Job approvals - GAOV call - skip errors                      
*          21FEB07 <UKCR00011466> Bug fix when PID=FFFF                         
* TKLU 024 16APR07 Job approvals - bug fix for multiple clients in list         
* TKLU 025 26APR07 <UKCR00012419> Ensure job creator cannot approve             
* TKLU 026 11JUN07 US merger (JSHA)                                             
* TKLU 027 18JUN07 Bug fix from US/JSHA                                         
* TKLU 028 20JUL07 JD_CPC vs. JD_CPX efficiency change/fix, JAPPGET fix         
* TKLU 029 07AUG07 US merger                                                    
* TKLU 030 23AUG07 <UKCR00013970> Job List bug with 'same as before'            
* TKLU 031 31AUG07 <LO01-6336> Campaign code and name on job                    
*          06SEP07 <UKCR00013619> Job approver d/l bug fix                      
* TKLU 032 12SEP07 <BR10037Y> Clear PRORATAD in SETALL routine                  
* TKLU 033 27SEP07 <BR10050Y> Exclude reversal transactions                     
*                  <UKCR00010005> Fix to 'exclude hours' security               
* TKLU 034 19OCT07 <UKCR00014761> JobBag unmatched order amount bug fix         
* NSHE 035 08NOV07 <LO01-6995> Add FACPAK code                                  
* TKLU 036 05DEC07 <LO01-7081> JobCost Summary - add memo hours to              
*                  internal charges                                             
* TKLU 037 19FEB08 <UKCR00015992> Archive Transaction IO bug fix                
* TKLU 038 08MAR08 <UKCR00016524> GETOPT call init bug fix                      
* TKLU 039 17JUN08 <LO01-7747/LO01-7748> Gross/Commission + Internal            
*                  Reference for JobDashBoard                                   
* TKLU 040 04AUG08 <LO01-7324> JobDashBoard - Additions to the summary          
*                  views and new Job/Accounting view as well as new             
*                  Job/Billing View (WIP), all within JOBBAG                    
* NSHE 041 10AUG08 <LO01-7743> Separate client approvers                        
* TKLU 042 18SEP08 <LO01-7324> Job/List bug fix                                 
* NSHE 042 08OCT08 Fix to job approver read                                     
* TKLU 042 08OCT08 <LO01-7324> Job/List bug fix and reenable a field,           
*                  add exchange rate, skip Estim.s in Accounting view           
* NSHE 043 20OCT08 change to JOBPASD structure                                  
* TKLU     04NOV08 <LO01-8082> 'Estimate % Committed' columns                   
* TKLU     10NOV08 Media code filter fix in Job/List                            
* TKLU     11NOV08 <DU01-8304> Expanded locks d/loaded in List & Search         
* TKLU/MPEN 044 27/03/2009 FIX NOT ALL JOBS RETURNED WHEN MAP 27=Y              
* MPEN 045 30APR09 <BR14154D> PASS COUNTRY CODE TO GETOPT                       
* NSHE 046 20APR09 NEW AUDIT RECORD FOR JOBS                                    
* TKLU     06MAY09 <UKCR00022222> Split multiple w/cs in Job Acc View           
*                  and skip order transactions in 'transactions' mode           
*          26MAY09 <UKCR00022486> remove chargeable time from debits            
* TKLU 047 04JUN09 <BR25230L> Check whether TRNRECD by testing TRNELQ           
* MPEN 048 17APR09 <LO01-8463> CONTROL NOTIFICATNS ON SUBMIT BY OFFICE          
* TKLU     02JUL09 <LO01-9099> Show commission billed on all trxs               
*          24JUL09 <UKCR00023146> implement 'status' for JobBag                 
*          25JUL09 <UKCR00022890> Bill numbers return for JobBag                
*          27JUL09 <LO01-9098> Expense claim and time items into JobBag         
*                  Extended summary view: include orders/claims/time            
*          29JUL09 <UKCR00023136> BT6 bill - include commission                 
* MPEN 049 10JUL09 <LO01-9092> JOB LOCK STATUS CHECKBOXES                       
*          10JUL09 <LO01-9107> RETURN INVOICE NUMBER                            
*          10JUL09 <LO01-9100> SHOW RECEIVED STATUS AND AMOUNT OF INV           
*          16JUL09 <LO01-9090> SALES AND COST RATES                             
*          04AUG09 <LO01-9228> MASTER JOB, FEE CLI PROD JOB TO 2C               
* TKLU     10SEP09 <UKCR00023116> EXTEND trx narr from 50 to 101 chars          
*          15SEP09 <LO01-9099> Include FlexiBill advances into JobDB            
* NSHE     19SEP09 Implement change to job approvers to enable media            
* MPEN 050 21SEP09 <UKCR00023505> FIX FOR LAST AMENDER                          
* NSHE 051 07OCT09 Various fixes for job summary and accounting                 
* NSHE 052 09OCT09 Stop loop                                                    
* NSHE 053 28OCT09 Various audit fixes                                          
* NSHE 054 30OCT09 Fix client team for job audit                                
* NSHE 055 05NOV09 Allow arrays for audit info                                  
* NSHE 056 12NOV09 Job approver bring back level for approved jobs              
* NSHE 057 01DEC09 Show INV log number when job bag accounting                  
* SMAN 058 23DEC09 UKCR00026251 Remove duplicate rows                           
* SMAN     23DEC09 Fix from US (CQTST00041388)                                  
* NSHE 059 04JAN10 Fix for job accounting/workcode costs                        
* NSHE 060 13JAN10 Fix for missing jobs in own jobs view                        
* NSHE 061 26JAN10 Allow close from list - ensure can close is sent             
* MPEN 062 29JAN10 <LO01-9750> PASS OPT MAINT SETTINGS                          
* SMAN 064 12MAY10 <BR33103L> Check TRNKDATE prior to FLTTIM calls              
* NSHE 065 04JUN10 <UKCR00028081> Read new opt main setting to                  
* NSHE             determine how to treat R time                                
* NSHE 066 05AUG10 Remove CONPIDC and replace with CCTPID                       
* NRAK 067 20DEC10 <BR17007D> FIX FOR 'GOODS RECEIVED' ORDERS                   
* NRAK 070 18JAN11 <BR17146d> preserve fablk for falink                         
* NSHE 071 19JAN11 <BR17171D> Correct mistake at previous level                 
* NRAK 072 09FEB11 SIMILAR FIX TO LVL 70, FOR JOBBAG                            
* MPEN 073 15DEC10 <Change all downloads to show job lock sta                   
* NSHE 074 15JUN11 Fix limit list issues for US                                 
* NSHE     15JUN11 Fix memo invoices for US                                     
* NSHE 075 04NOV11 US merge and fix                                             
* JFOS 076 18JUL13 <PR003402>New JOBBER:skip 1r-lvl ents on Job summary         
*                   + larger area for JOBBER column table                       
* MPEN     25FEB13 <BR54230L> Check order fully billed first!                   
* NRAK     19JUL13 <DSBO-138> Ignore rejected jobs by default                   
* TKLU 077 27Aug13 <BO000195> If LLSRECD passive from GLSRECD read              
*                  GLSRECD sequentials as LLSRECD seq's don't exist             
* TKLU 078 06Jul14 <RD000869> Aura Job Search improvements & additions          
*                  This version alos contains:                                  
*                             Return 'IsForeignUser' flag in JobList            
*                  <RD003081> Taken out CHKACT under Aura (efficiency)          
*                             and added PIDKADAT 13 months support              
*                  <RD003056> Handle STCELs on AUDREC not ACTRECD (Job)         
*                  <RD003224> Add 'filter on filters' 2 XJOBDRA/XJOBPID         
*                  <RD003224> Application lock status checks readjusted         
*                  <RD003258> Skip GOAFROM as GETOPT corrupts w/s               
*                  <RD003036> User fields search redefined under Aura           
*                             Report expense job in job list/search             
* NSHE             <RD002732> Add application to audit return                   
* NSHE 079 07JUL14 Fix to application in audit                                  
* TKLU 080 21JUL14 <RD003528> Apply FLTLIM in all job searches + CASPRO         
*                             allow for dupe TSAR                               
*                  <RD003528> Translate name search data to upper case          
* TKLU 081 23Jul14 <RD003673> Return JD_MAST in GETSVV, too                     
*                  <RD003668> JD_OFF/JD_OFN bug fixes                           
*          24Jul14 <RD003680> Add JobList return 'Bra Estimates on job'         
*                  <RD003679> Apply GESRCHPARS translate table for name         
*                             search in JobList                                 
*                  <RD003709> Return JD_FEE in GETSVV, too                      
*                  <RD003687> Clarify passive handling - see X#PTYP             
* MPEN     24Jul14 <RD003702> Open up A#UFDL call to be more flexible           
*                  <RD001740> Fix for the above, plus TKLU fix (use             
*                             ABLOCK rather than WORK/WORK2)                    
* TKLU     19Aug14 <RD001069> More TRACE details for Job/Search                 
* TKLU 082 05Sep14 <RD004149> Exclude closed jobs from JLUDDL / JLREDL          
* YNGX 083 18SEP14 <FLX00071> HANDLE FLEXIBILL FEE BILLING AMOUNTS              
* TKLU 084 17Nov14 <RD005147> Skip deleted job records in JLSD                  
*NRAK 085 06Feb15 <OT82475L> Crapper                                            
* TKLU 086 23Mar15 <BO001001> Remove >< optimisation under BrandOcean           
* NSHE 087 24Apr15 <DSBO-1406> Remove SETFAC                                    
* NSHE 088 11May15 US fixes passed by Jim Shea                                  
* NSHE 089 01Jul15 <DSRD-7784> Ensure filter is checked if date search          
* YNGX 090 11AUG15 <DSFLX-299> Don't read bill alloc from Estimate (UK)         
* NSHE 091 25SEP15 <DSRD-7903> Remove SJ prefix for audit                       
* MPEN 092 11NOV15 <DSRD-7507> Amend to handle additional info type             
* TKLU     06Jan15             Improve offline tracing support                  
* TKLU 093 27Jan16 <RD010160>  Performance improvements (GETOPT), minor         
*                              status filter adjustments (DSRD-10476)           
* TKLU 094 08Apr16 <RD010957>  Adjust PIDJKOBQ use if draft accounts            
*                              are requested                                    
* NSHE 095 24May16 DSRD-11237 New job list option to show jobs assigned         
* NSHE     08Jun16 DSRD-11739 Reporting across jobs                             
* MPEN     16Jun16 DSRD-11912 Return approval status for rejected by me         
* NSHE 096 27Jun16 DSRD-12042 Use jobs opt maint for job reports                
* MPEN     10Aug16 DSRD-12035 Fix GETOPT call                                   
* MPEN     11Aug16 DSRD-12325 User field issue in the US use UK code            
* MPEN     11Aug16 DSRD-12442 Fix for zero length job name                      
* MPEN     12Aug16 DSRD-11821 Fix for limlist filtering                         
* MPEN 097 13Aug16 DSRD-13629 Fix for assigned jobs filtering                   
*                  DSRD-13702 Don't filter assigned jobs by limlist             
* MPEN 098 02Nov16 DSRD-11821 Additional fix for limlist                        
*                  DSRD-11947 Ensure limlist filt only for my assigned          
*                  DSRD-14110 Fix for job filtering                             
*                  DSRD-14071 Skip backdate maximum for job assigned            
* GHOA 099 31Jan17 DSRD-14484 Include studio code and link                      
* TKLU 100 12May17 DSRD-15067 Return SCITCPAD payments values                   
* NSHE 101 02Jun17 DSRD-15939 ensure name search doesn't skip filters           
* NSHE     02Jun17 DSRD-15858 Allow code and name search                        
* NSHE 102 31Oct17 DSRD-16866 Return amber and red % for job list               
*                                                                               
***********************************************************************         
                                                                                
SVRDEF   CSECT                                                                  
         LKSVR TYPE=D,IDF=Y,REQUEST=*,CODE=CODE,FILES=FILES,           x        
               WORKERKEY=ACBO,                                         x        
               SYSPHASE=X'0624',SYSTEM=ACCSYSQ,APPEND=Y,               x        
               SERVERTYPE=TSTACBO,SEGMENT=Y,LOADFACSOFF=Y,             x        
               BLOCKS=(B#WORKD,WORKD,B#SAVED,SAVED,B#TWA,TWAD)                  
                                                                                
CODE     DS    0D                                                               
         PRINT NOGEN                                                            
         NMOD1 0,**BO19**,R7,CLEAR=YES,RR=RE                                    
         LR    R5,R1                                                            
         USING LP_D,R5                                                          
         L     R1,LP_ARUNP         R1=A(RUNPARMS)                               
         USING RUNPARMD,R1                                                      
         XR    R4,R4                                                            
         ICM   R4,7,RUNPARUN                                                    
         USING RUNFACSD,R4         R4=A(RUNFACS)                                
         DROP  R1                                                               
                                                                                
         LHI   R0,LVALUESL                                                      
         CHI   R0,OVALUESL                                                      
         JNE   *+2                 LITERALS OUT OF STEP                         
                                                                                
         USING WORKD,R9            R9=A(GLOBAL W/S)                             
         USING SAVED,R8            R8=A(SAVE W/S)                               
                                                                                
         TM    LP_FLAG,LP_FOFFL    TEST OFFLINE                                 
         JNZ   INIT02                                                           
         ICM   R9,15,LP_ABLK1      ROOT SETS A(WORKD)          BLOCK #1         
         JZ    *+2                                                              
         ICM   R8,15,RSVRSAVE      R8=A(4K SAVE AREA)                           
         LR    RC,R8                                                            
         AHI   RC,4096                                                          
         USING SAVED+4096,RC       RC=A(2ND 4K OF W/S)                          
         J     INIT04                                                           
                                                                                
INIT02   L     R9,RSVRSAVE         A(64K SAVE AREA)                             
         ST    R9,LP_BLKS+((B#WORKD-1)*L'LP_BLKS)              BLOCK #1         
         LAY   R8,WORKD+WORKL      R8=A(46K SAVE AREA)                          
         MVC   ATWA,LP_ATWA        OFFLINE TWA AREA SET BY RUNNER               
                                                                                
INIT04   L     RA,ATWA             RA=A(ON/OFFLINE TWA)                         
         USING TWAD,RA                                                          
                                                                                
         MVC   VMASTC,RMASTC                                                    
         MVC   APRINTER,RPRINTER                                                
         ST    R4,ARUNFACS                                                      
                                                                                
         MVI   TWAMODE,0                                                        
                                                                                
         ST    R5,ALP              SAVE A(DDLINK PARAMETER LIST)                
         ST    RE,SRVRRELO         SAVE PROGRAM RELOCATION FACTOR               
         STM   R2,RB,LP_R2RB       SAVE REGISTERS FOR SUB-ROUTINES              
                                                                                
         USING ELES_DS,ELEMENT                                                  
                                                                                
         L     R1,LP_ARUNP         R1=A(RUNPARMS)                               
         USING RUNPARMD,R1                                                      
         CLI   RUNPMODE,RRUNSTRQ   FIRST FOR RUN                                
         JE    RUNSTR                                                           
         CLI   RUNPMODE,RPRCWRKQ   PROCESS WORK                                 
         JE    PRCWRK                                                           
         CLI   RUNPMODE,RRUNREQQ   RUN REQUEST                                  
         JE    RUNREQ                                                           
         J     EXITY                                                            
         DROP  R1                                                               
                                                                                
***********************************************************************         
* INITIALISE FOR RUNNING                                              *         
***********************************************************************         
                                                                                
RUNSTR   TM    LP_FLAG,LP_FOFFL                                                 
         JNZ   RUNSTR02                                                         
         L     RF,AACCFACS                                                      
         MVC   VACCEMU,X_AACCEMU-X_ACCFACSD(RF)                                 
         J     RUNSTR04                                                         
                                                                                
RUNSTR02 L     RF,VMASTC                                                        
         MVC   VACCEMU,MCVACEMU-MASTD(RF)                                       
                                                                                
         L     RF,RCOMFACS         YES - LOAD FACILITIES OVERLAYS               
         ST    RF,ACOMFACS                                                      
         L     RF,CCALLOV-COMFACSD(RF)                                          
         GOTOR (RF),DMCB,(1,0),0,0                                              
         MVC   AROUT1,0(R1)                                                     
         GOTOR (RF),DMCB,(2,0),0,0                                              
         MVC   AROUT2,0(R1)                                                     
                                                                                
         GOTOR (#WRKINI,AWRKINI)   INITIALISE WORKING STORAGE                   
                                                                                
         MVC   LP_AUIR1,AROUT1     SET A(INDEX ROUTINES 1)                      
         MVC   LP_AUIR2,AROUT2     SET A(INDEX ROUTINES 2)                      
                                                                                
RUNSTR04 MVC   OVALUES(OVALUESL),LVALUES                                        
         MVC   EXPTTAB(EXPTTABL),EXPTYTAB                                       
                                                                                
         LA    R0,SAVED                                                         
         ST    R0,LP_BLKS+((B#SAVED-1)*L'LP_BLKS)              BLOCK #2         
                                                                                
         OI    LP_AIND1,LP_AICOM   COMMA OK FOR LIST DELIMITERS                 
                                                                                
         J     EXITY                                                            
                                                                                
***********************************************************************         
* FIRST FOR NEW WORK                                                  *         
***********************************************************************         
                                                                                
PRCWRK   LA    R0,XLOCAL                                                        
         LHI   R1,XLOCALNQ                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         TM    LP_FLAG,LP_FOFFL    TEST RUNNING OFFLINE                         
         JZ    PRCWRK02                                                         
                                                                                
         LA    R0,WORKD            CLEAR I/O AREAS                              
         AHI   R0,IOAREA1-WORKD                                                 
         LHI   R1,IOAREASL                                                      
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
PRCWRK02 DS    0H                                                               
         J     EXITY                                                            
         DROP  R4                                                               
                                                                                
***********************************************************************         
* RUN A DOWNLOAD REQUEST                                              *         
***********************************************************************         
                                                                                
RUNREQ   MVI   GIND2,GI2EJOB                                                    
                                                                                
         GOTOR (#CPYINI,ACPYINI)   (RE)INITIALISE COMPANY VALUES                
         USING CPXELD,SCPXEL                                                    
         GOTO1 VDICTATE,DMCB,C'LL  ',DCDICTL,DSDICTL                            
                                                                                
         TM    LP_FLAG,LP_FOFFL    TEST RUNNING OFFLINE                         
         JZ    RUNREQ02                                                         
         L     R0,AGOBLOCB                                                      
         AHI   R0,GOADM-GOBLOCK                                                 
         LHI   R1,GOBLOCKX-GOBLOCKD                                             
         SHI   R0,GOADM-GOBLOCK                                                 
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
RUNREQ02 L     RE,ATWA                                                          
         LA    RE,2304+FALINKDL(RE)                                             
         ST    RE,AESTWRKA          ATWA AFTER FALINK BLOCK OFFLINE             
         TM    LP_FLAG,LP_FOFFL                                                 
         JNZ   *+10                                                             
         MVC   AESTWRKA,ATIA        USE TIA ONLINE                              
                                                                                
         XR    RF,RF                                                            
         ICM   RF,3,LP_QMAPN                                                    
         CHI   RF,A#JAUD           *** JOB AUDIT                                
         JE    JAUDIT                                                           
         CHI   RF,A#UFDL           *** USER FIELDS                              
         JE    USRFDL                                                           
         CHI   RF,A#JLSD           *** JOB LIST/SEARCH                          
         JE    JLSDLD                                                           
         CHI   RF,A#JBAG           *** JOB BAG (DASHBOARD)                      
         JE    JOBBAG                                                           
         CHI   RF,A#JAPP           *** JOB APPROVER                             
         JE    JOBAPP                                                           
         DC    H'0'                UNKNOWN REQUEST                              
         EJECT                                                                  
                                                                                
***********************************************************************         
* USER FIELDS DOWNLOAD (=PROD) FOR JOB/LAUNCH                         *         
***********************************************************************         
                                                                                
USRFDL   DS    0H                  ** USER FIELDS DOWNLOAD **                   
         USING LW_D,RF                                                          
                                                                                
         GOTOR TRACEIT,0                                                        
                                                                                
         GOTOR XUFDL                                                            
         JE    EXITY                                                            
                                                                                
         MVC   LP_ERROR,ROUERRV                                                 
         J     XERROR                                                           
         EJECT                                                                  
                                                                                
***********************************************************************         
* JOB AUDIT DOWNLOAD                                                  *         
***********************************************************************         
                                                                                
JAUDIT   DS    0H                  ** JOB AUDIT DOWNLOAD **                     
         USING LW_D,RF                                                          
                                                                                
         GOTOR TRACEIT,0                                                        
                                                                                
         GOTOR XJAUD                                                            
         JE    EXITY                                                            
                                                                                
         MVC   LP_ERROR,ROUERRV                                                 
         J     XERROR                                                           
         EJECT                                                                  
                                                                                
***********************************************************************         
* JOB BAG DOWNLOAD                                                    *         
***********************************************************************         
                                                                                
JOBBAG   DS    0H                  ** JOB BAG DOWNLOAD **                       
         USING LW_D,RF                                                          
         CLI   RQ_ESTCH,YESQ       ESTIMATE CHECKING TO BE DONE?                
         JNE   *+8                                                              
         OI    SAVEIND,SAVESTC     SET TO DO ESTIMATE CHECKING                  
                                                                                
         GOTOR TRACEIT,0                                                        
                                                                                
         GOTOR JBVALSJ                                                          
         JNE   JOBBAGER                                                         
                                                                                
         USING GOBLOCKD,RF                                                      
         L     RF,AGOBLOCB                                                      
                                                                                
         XC    GOADM(GOABUFF-GOADM),GOADM                                       
         XC    GOADETS(GOACOVL-GOADETS),GOADETS                                 
                                                                                
         MVC   GOADM,VDATAMGR                                                   
         MVC   GOABEXT,AGOBBLCK                                                 
         MVC   GOAEXT,AGOXBLCK                                                  
         MVC   GOSELCUL(1),CUXCPY                                               
         MVC   GOSELCUL+1(2),PRODUL                                             
         MVC   GOSELCLI,X#CLIC                                                  
         MVC   GOSELPRO,X#PROC                                                  
         MVC   GOSELJOB,X#JOBC                                                  
         MVC   GOCTRY,CUCTRY                                                    
         OI    GOSPEC3,GOSPNERQ    USE NONE EMULATED IOS                        
                                                                                
         GOTO1 VGETOPT,DMCB,GOBLOCKD                                            
         DROP  RF                                                               
                                                                                
         GOTOR GETTUP                                                           
         CLI   RQ_JBTYP,RQ_JBWCS   Summary?                                     
         JE    JOBBAG05                                                         
         CLI   RQ_JBTYP,RQ_JBWCX   Extended summary?                            
         JNE   JOBBAG10                                                         
                                                                                
JOBBAG05 GOTOR PROSUM                                                           
         JE    EXITY                                                            
         J     JOBBAGER                                                         
                                                                                
JOBBAG10 CLI   RQ_JBTYP,RQ_JBWCD   Details?                                     
         JE    JOBBAG15                                                         
         CLI   RQ_JBTYP,RQ_JBWCW   Extended Details?                            
         JE    JOBBAG15                                                         
         CLI   RQ_JBTYP,RQ_JBACC   Accounting?                                  
         JE    JOBBAG15                                                         
         CLI   RQ_JBTYP,RQ_JBBIL   Billing?                                     
         JNE   JOBBAG20                                                         
                                                                                
JOBBAG15 GOTOR JBGETJV                                                          
                                                                                
         GOTOR PROJBWD                                                          
         JE    EXITY                                                            
         J     JOBBAGER                                                         
                                                                                
JOBBAG20 DC    H'0'                unknown                                      
                                                                                
JOBBAG30 MVC   ROUERRV,=AL2(AE$IVREQ)                                           
                                                                                
JOBBAGER MVC   LP_ERROR,ROUERRV                                                 
         J     XERROR                                                           
         EJECT                                                                  
                                                                                
***********************************************************************         
* JOB APPROVER DOWNLOAD                                               *         
***********************************************************************         
                                                                                
JOBAPP   DS    0H                  ** JOB APPROVER DOWNLOAD **                  
         USING LW_D,RF                                                          
                                                                                
         GOTOR TRACEIT,0                                                        
                                                                                
         GOTOR JAPPGET                                                          
         JNE   JOBAPPER                                                         
         J     EXITY                                                            
                                                                                
JOBAPPER MVC   LP_ERROR,ROUERRV                                                 
         J     XERROR                                                           
         DROP  RF                                                               
                                                                                
***********************************************************************         
* JOB LIST AND SEARCH DOWNLOAD                                        *         
***********************************************************************         
                                                                                
JLSDLD   DS    0H                  ** JOB LIST AND SEARCH DOWNLOAD **           
                                                                                
         XR    RF,RF                                                            
         NI    SAVEIND,FF-(SAVEXDL+SAVEML2+SAVEAUR+SAVESTC)                     
         ICM   RF,B'0011',CUXPNUM                                               
         CHI   RF,XPRODIKQ                                                      
         JNE   JLSD002                                                          
         OI    SAVEIND,SAVEAUR                                                  
                                                                                
JLSD002  XC    X#13MDAT,X#13MDAT   All, if Aura 13 months only for some         
         TM    SAVEIND,SAVEAUR     requests (PIDKJOBQ)                          
         JZ    JLSD004                                                          
*&&UK*&& DS    0H                  Own 'today', no retrieval of TODAYF          
*&&UK*&& DS    0H                  as in ACBAR12 e.g.                           
         GOTOR VDATCON,DMCB,(5,0),(0,DUB1)                                      
         GOTOR VADDAY,DMCB,(C'M',DUB1),DUB2,-13                                 
         GOTOR VDATCON,DMCB,(0,DUB2),(2,X#13MDAT)                               
                                                                                
JLSD004  GOTOR TRACEIT,0           trace in SYSPRINT                            
                                                                                
         JAS   RE,PROCARRY         process arrays                               
         JNE   XERROR                                                           
                                                                                
JLSD006  CLI   RQ_JDCST,C' '                                                    
         JH    JLSD007                                                          
         MVI   RQ_JDCST,NOQ                                                     
                                                                                
JLSD007  CLI   RQ_JDLST,C' '                                                    
         JH    JLSD008                                                          
         MVI   RQ_JDLST,NOQ                                                     
                                                                                
JLSD008  OC    CCTPID,CCTPID                                                    
         JNZ   JLSD010                                                          
                                                                                
         MVC   LP_ERROR,=AL2(AE$INPID)                                          
         J     XERROR                                                           
                                                                                
JLSD010  LA    R0,OLDJDTL                                                       
         LHI   R1,L'OLDJDTL                                                     
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         MVI   TSARTYPE,TSARTJSQ                                                
         GOTOR GOTSAR,DMCB,('TSAINI',0)  to buffer cli/pro/off details          
                                                                                
         OC    RQ_JDSPC,SPACES                                                  
         XC    X#PIDSU,X#PIDSU                                                  
         CLC   RQ_JDSPC,SPACES                                                  
         JE    JLSD014                                                          
         MVC   TEMP2(8),RQ_JDSPC                                                
         GOTOR (#GETPIN,AGETPIN)                                                
         JE    JLSD012                                                          
         MVC   LP_ERROR,=AL2(AE$INPID)                                          
         J     XERROR                                                           
                                                                                
JLSD012  MVC   X#PIDSU,TEMP2+50                                                 
                                                                                
JLSD014  OC    RQ_JDAPC,SPACES                                                  
         XC    X#PIDAP,X#PIDAP                                                  
         CLC   RQ_JDAPC,SPACES                                                  
         JNH   JLSD018                                                          
         MVC   TEMP2(8),RQ_JDAPC                                                
         GOTOR (#GETPIN,AGETPIN)                                                
         JE    JLSD016                                                          
         MVC   LP_ERROR,=AL2(AE$INPID)                                          
         J     XERROR                                                           
                                                                                
JLSD016  MVC   X#PIDAP,TEMP2+50                                                 
                                                                                
JLSD018  XC    X#PIDRJ,X#PIDRJ                                                  
         CLC   RQ_JDRPC,SPACES                                                  
         JNH   JLSD020                                                          
         MVC   TEMP2(8),RQ_JDRPC                                                
         GOTOR (#GETPIN,AGETPIN)                                                
         JE    JLSD019                                                          
         MVC   LP_ERROR,=AL2(AE$INPID)                                          
         J     XERROR                                                           
                                                                                
JLSD019  MVC   X#PIDRJ,TEMP2+50                                                 
                                                                                
JLSD020  OC    RQ_JDCLC,SPACES     client                                       
         OC    RQ_JDPRO,SPACES                                                  
         OC    RQ_JDJOB,SPACES                                                  
                                                                                
         CLI   RQ_JDTYP,RQ_JDTNQ   New status call?                             
         JNH   *+12                No                                           
         CLI   RQ_JDTYP,RQ_JDT7Q   Yes but only want to get Limlist for         
         JNE   JLSD022               for assigned list call                     
         CLI   RQ_JDOVR,YESQ       Do we have override on                       
         JE    JLSD022             Yes - let all through                        
         GOTOR GETLIM              get limit lists                              
                                                                                
         CLI   X#MLLIU,YESQ                                                     
         JE    JLSD021                                                          
         CLI   X#LLTMED,NOQ        if media or SJ limit list says N             
         JE    JLSD999             then exit empty here                         
                                                                                
JLSD021  CLI   X#JLLIU,YESQ                                                     
         JE    JLSD022                                                          
         CLI   X#LLTCPJ,NOQ                                                     
         JE    JLSD999                                                          
                                                                                
JLSD022  MVI   X#JDTPAS,0          Check open/close dates                       
         MVI   X#SRCL,FF           Set no name search                           
         XC    X#OPND,X#OPND                                                    
         XC    X#CLOD,X#CLOD                                                    
         MVC   X#OPNX,XFFS                                                      
         MVC   X#CLOX,XFFS                                                      
                                                                                
         CLC   RQ_JDOPN,SPACES                                                  
         JNH   JLSD022A                                                         
         GOTOR VDATCON,DMCB,(0,RQ_JDOPN+2),(1,X#OPND)                           
         OI    X#JDTPAS,X#JDTPOQ                                                
                                                                                
JLSD022A CLC   RQ_JDOPX,SPACES                                                  
         JNH   JLSD022B                                                         
         GOTOR VDATCON,DMCB,(0,RQ_JDOPX+2),(1,X#OPNX)                           
         OI    X#JDTPAS,X#JDTPOQ                                                
                                                                                
JLSD022B CLC   RQ_JDCLO,SPACES                                                  
         JNH   JLSD022C                                                         
         GOTOR VDATCON,DMCB,(0,RQ_JDCLO+2),(1,X#CLOD)                           
         OI    X#JDTPAS,X#JDTPCQ                                                
                                                                                
JLSD022C CLC   RQ_JDCLX,SPACES                                                  
         JNH   JLSD023                                                          
         GOTOR VDATCON,DMCB,(0,RQ_JDCLX+2),(1,X#CLOX)                           
         OI    X#JDTPAS,X#JDTPCQ                                                
*                                                                               
                                                                                
JLSD023  CLI   RQ_JDTYP,RQ_JDTNQ   New status call?                             
         JH    JLSD300             ----------------                             
         TM    SAVEIND,SAVEAUR     for Aura see PROCARRY                        
         JNZ   JLSD031                                                          
*                                                                               
         XC    X#UFLD,X#UFLD       set user field filter lengths                
         LA    RE,X#UFLD                                                        
         LA    RF,RQ_JDUF1                                                      
         LA    R1,10                                                            
                                                                                
JLSD024  XR    R3,R3                                                            
         CLC   0(L'RQ_JDUF1,RF),SPACES                                          
         JNH   JLSD026                                                          
                                                                                
         LA    R2,(L'RQ_JDUF1-1)(RF)                                            
         LA    R3,L'RQ_JDUF1                                                    
                                                                                
JLSD025  CLI   0(R2),C' '                                                       
         JH    JLSD026                                                          
         SHI   R2,1                                                             
         JCT   R3,JLSD025                                                       
         DC    H'0'                                                             
                                                                                
JLSD026  STC   R3,0(RE)                                                         
         AHI   RE,1                                                             
         AHI   RF,L'RQ_JDUF1                                                    
         JCT   R1,JLSD024                                                       
         J     JLSD031                                                          
                                                                                
JLSD030  XR    R0,R0               SAVEML2 start point                          
                                                                                
         USING ACTRECD,R2                                                       
JLSD031  LA    R2,IOKEY            read for client account record               
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(2),PRODUL                                                
         MVI   X#PTYP,X#PTYPAQ                                                  
                                                                                
         CLC   RQ_JDCLC,SPACES     - but only if passed                         
         JH    JLSD032                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         J     JLSD044                                                          
                                                                                
JLSD032  MVC   ACTKACT(5),RQ_JDCLC                                              
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    JLSD034                                                          
                                                                                
*&&UK*&& MVC   LP_ERROR,=AL2(AE$CLINF)                                          
*&&US*&& MVC   LP_ERROR,=AL2(AE$INCLI)                                          
         J     XERROR                                                           
                                                                                
JLSD034  CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    JLSD036                                                          
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    JLSD036                                                          
         CLI   RQ_JDLST,YESQ       include locked jobs?                         
         JE    JLSD036                                                          
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    JLSD036                                                          
                                                                                
         TM    ACTKSTAT,ACTSLOCK   client locked?                               
         JZ    JLSD036                                                          
                                                                                
         MVC   LP_ERROR,=AL2(AE$CLILK)                                          
         J     XERROR                                                           
                                                                                
JLSD036  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                 Bad master record                            
                                                                                
         L     R0,AIO4             Copy SJ client to AIO4                       
         LA    R1,IOLENQ                                                        
         L     RE,AIO2                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         L     R2,AIO2                                                          
                                                                                
         LLC   RE,PCLILEN                                                       
         AHI   RE,ACTKACT-ACTKCPY-1                                             
         STC   RE,X#CLVL                                                        
                                                                                
         GOTOR XJOBGOF                                                          
         MVC   X#HOFF,X#AOFF                                                    
         MVC   X#POFF,X#AOFF                                                    
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
         XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         LHI   R1,JSBDLNQ                                                       
         STH   R1,TSB.JSBDLEN                                                   
         MVI   TSB.JSBDTYP,JSBDTCQ                                              
         MVC   TSB.JSBDCOD,ACTKACT                                              
         MVC   TSB.JSBDOFF,X#AOFF                                               
         MVC   TSB.JSBDNAM,SPACES                                               
                                                                                
         USING NAMELD,R1                                                        
         LA    R1,ACTRFST                                                       
JLSD038  CLI   NAMEL,NAMELQ                                                     
         JE    JLSD040                                                          
         CLI   NAMEL,0                                                          
         JE    *+2                                                              
         LLC   R0,NAMLN                                                         
         AR    R1,R0                                                            
         J     JLSD038                                                          
JLSD040  LLC   RE,NAMLN                                                         
         SHI   RE,NAMLN1Q+1                                                     
         MVC   TSB.JSBDNAM(0),NAMEREC                                           
         EX    RE,*-6                                                           
         DROP  R1                                                               
                                                                                
         GOTOR SETXDB,DMCB,TSB.JSBDXDB,ACTRECD                                  
                                                                                
         TM    SAVEIND,SAVEML2     lap 2?                                       
         JZ    JLSD041                                                          
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         JE    JLSD042                                                          
         TM    TSARERRS,TSERNF     Test record not found                        
         JNZ   JLSD041                                                          
         DC    H'0'                                                             
                                                                                
JLSD041  GOTOR GOTSAR,DMCB,('TSAADD',0)  add client to buffer                   
         JE    JLSD042                                                          
         TM    TSARERRS,TSEEOF     buffer full - so it is ...                   
         JNZ   JLSD042                                                          
         DC    H'0'                duplicate key                                
                                                                                
JLSD042  MVC   ELESDCLI,TSB.JSBDCOD save current client details                 
         MVC   ELESDCST,TSB.JSBDSTA                                             
         MVC   ELESDCOF,TSB.JSBDOFF                                             
         MVC   ELESDCLN,TSB.JSBDNAM                                             
         MVC   ELESDCXD,TSB.JSBDXDB                                             
         MVC   X#HOFF,ELESDCOF                                                  
         MVC   X#POFF,ELESDCOF                                                  
         J     JLSD046                                                          
         DROP  TSB                                                              
                                                                                
JLSD044  CLC   RQ_JDPRO,SPACES     cannot have product if no client             
         JH    *+2                                                              
                                                                                
JLSD046  CLC   RQ_JDPRO,SPACES     validate product if selected                 
         JNH   JLSD062                                                          
                                                                                
         OC    RQ_JDPRO,SPACES                                                  
         LA    R2,IOKEY                                                         
         LLC   R1,PPROLEN                                                       
         LLC   RE,PCLILEN                                                       
         SR    R1,RE                                                            
         LA    RE,ACTKACT(RE)                                                   
         SHI   R1,1                                                             
         MVC   0(0,RE),RQ_JDPRO                                                 
         EX    R1,*-6                                                           
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    JLSD048                                                          
                                                                                
*&&UK*&& MVC   LP_ERROR,=AL2(AE$PRONF)                                          
*&&US*&& MVC   LP_ERROR,=AL2(AE$INPRO)                                          
         J     XERROR                                                           
                                                                                
JLSD048  CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    JLSD050                                                          
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    JLSD050                                                          
         CLI   RQ_JDLST,YESQ       include locked jobs?                         
         JE    JLSD050                                                          
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    JLSD050                                                          
                                                                                
         TM    ACTKSTAT,ACTSLOCK   product locked?                              
         JZ    JLSD050                                                          
                                                                                
         MVC   LP_ERROR,=AL2(AE$LOCKD)                                          
         J     XERROR                                                           
                                                                                
JLSD050  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                 Bad master record                            
                                                                                
         L     R2,AIO2                                                          
                                                                                
         LLC   RE,PPROLEN                                                       
         AHI   RE,ACTKACT-ACTKCPY-1                                             
         STC   RE,X#CLVL                                                        
                                                                                
         GOTOR XJOBGOF                                                          
                                                                                
         MVC   X#POFF,X#HOFF                                                    
         CLC   X#AOFF,SPACES                                                    
         JNH   JLSD052                                                          
         MVC   X#POFF,X#AOFF                                                    
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
JLSD052  XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         LHI   R1,JSBDLNQ                                                       
         STH   R1,TSB.JSBDLEN                                                   
         MVI   TSB.JSBDTYP,JSBDTPQ                                              
         LLC   RE,PPROLEN                                                       
         SHI   RE,1                                                             
         MVC   TSB.JSBDCOD,SPACES                                               
         MVC   TSB.JSBDCOD(0),ACTKACT                                           
         EX    RE,*-6                                                           
         MVC   TSB.JSBDOFF,X#POFF                                               
         MVC   TSB.JSBDNAM,SPACES                                               
                                                                                
         USING NAMELD,R1                                                        
         LA    R1,ACTRFST                                                       
JLSD054  CLI   NAMEL,NAMELQ                                                     
         JE    JLSD056                                                          
         CLI   NAMEL,0                                                          
         JE    *+2                                                              
         LLC   R0,NAMLN                                                         
         AR    R1,R0                                                            
         J     JLSD054                                                          
JLSD056  LLC   RE,NAMLN                                                         
         SHI   RE,NAMLN1Q+1                                                     
         MVC   TSB.JSBDNAM(0),NAMEREC                                           
         EX    RE,*-6                                                           
         DROP  R1                                                               
                                                                                
         GOTOR SETXDB,DMCB,TSB.JSBDXDB,ACTRECD                                  
                                                                                
         TM    SAVEIND,SAVEML2     lap 2?                                       
         JZ    JLSD058                                                          
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         JE    JLSD060                                                          
         TM    TSARERRS,TSERNF     Test record not found                        
         JNZ   JLSD060                                                          
         DC    H'0'                                                             
                                                                                
         GOTOR GOTSAR,DMCB,('TSAADD',0)  add product to buffer                  
JLSD058  JE    JLSD060                                                          
         TM    TSARERRS,TSEEOF     buffer full - so it is ...                   
         JNZ   JLSD060                                                          
         DC    H'0'                duplicate key                                
                                                                                
JLSD060  LLC   RF,PCLILEN          save current product details                 
         LA    RF,TSB.JSBDCOD(RF)                                               
         MVC   ELESDPRO,0(RF)                                                   
         MVC   ELESDPST,TSB.JSBDSTA                                             
         MVC   ELESDPOF,TSB.JSBDOFF                                             
         MVC   ELESDPRN,TSB.JSBDNAM                                             
         MVC   ELESDPXD,TSB.JSBDXDB                                             
         DROP  TSB                                                              
                                                                                
JLSD062  MVC   SAVEKEY4,IOKEY      save SJ(/client/product) key                 
         MVI   X#TSAYN,NOQ                                                      
                                                                                
         CLC   RQ_JDJOB,SPACES     validate job if selected                     
         JNH   JLSD064                                                          
                                                                                
         LA    R2,IOKEY                                                         
         LLC   R1,PJOBLEN                                                       
         LLC   RE,PPROLEN                                                       
         SR    R1,RE                                                            
         LA    RE,ACTKACT(RE)                                                   
         SHI   R1,1                                                             
         MVC   0(0,RE),RQ_JDJOB                                                 
         EX    R1,*-6                                                           
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    JLSD116                                                          
                                                                                
*&&UK*&& MVC   LP_ERROR,=AL2(AE$JOBNF)                                          
*&&US*&& MVC   LP_ERROR,=AL2(AE$INJOB)                                          
         J     XERROR                                                           
                                                                                
                                                                                
JLSD064  MVI   X#HIGH,NOQ          for first time read sequential               
                                                                                
         MVI   X#PAST,0                                                         
***      CLC   RQ_JDNAM,SPACES     name search required?                        
***      JH    JLSD076                                                          
         CLI   X#JSNAM#,0                                                       
         JH    JLSD076                                                          
         TM    X#JDSTAT,X#JDSTRE+X#JDSTSU+X#JDSTMA                              
         JZ    JLSD068             skip no filter or approved filter            
         MVI   X#PAST,YESQ         else use DRAPASD                             
                                                                                
         TM    SAVEIND,SAVEMST                                                  
         JZ    JLSD066                                                          
         TM    X#JDSTAT,X#JDSTAP   also approved?                               
         JZ    JLSD066                                                          
         OI    SAVEIND,SAVERL2     set to required lap 2                        
         NI    X#JDSTAT,FF-X#JDSTAP                                             
                                                                                
         USING DRAPASD,R2                                                       
JLSD066  LA    R2,IOKEY                                                         
         MVI   X#HIGH,YESQ                                                      
         XC    DRAPAS,DRAPAS                                                    
         MVI   DRAPTYP,DRAPTYPQ                                                 
         MVI   DRAPSUB,DRAPSUBQ                                                 
         MVC   DRAPCPY,CUXCPY                                                   
         MVI   DRAPAPS,DRAPDRA                                                  
         MVC   DRAPULA,SAVEKEY4+ACTKULA-ACTRECD                                 
         MVI   X#PTYP,X#PTYPDQ                                                  
                                                                                
         MVC   SAVEKEY2,IOKEY                                                   
         J     JLSD090                                                          
                                                                                
JLSD068  NI    SAVEIND,FF-SAVEXDR  extra DRAPAS lap not required                
         LA    RE,PIDKJSAQ                                                      
         OC    X#PIDAP,X#PIDAP     approver or submitter?                       
         JNZ   JLSD072                                                          
         LA    RE,PIDKJSSQ                                                      
         OC    X#PIDSU,X#PIDSU                                                  
         JZ    JLSD085                                                          
         CLI   X#JDSTAT,0          no status or none approved status            
         JE    JLSD070             set then need DRAPASD lap, too               
         TM    X#JDSTAT,X#JDSTRE+X#JDSTSU+X#JDSTMA                              
         JZ    JLSD072                                                          
                                                                                
JLSD070  OI    SAVEIND,SAVEXDR                                                  
                                                                                
JLSD072  STC   RE,X#PAST           read via PIDRECD/PIDKJOBQ                    
                                                                                
         USING PIDRECD,R2                                                       
         LA    R2,IOKEY                                                         
         MVI   X#HIGH,YESQ                                                      
         XC    PIDKEY,PIDKEY                                                    
         MVI   PIDKTYP,PIDKTYPQ                                                 
         MVI   PIDKSUB,PIDKSUBQ                                                 
         MVC   PIDKCPY,CUXCPY                                                   
         MVI   PIDKSTYP,PIDKJOBQ                                                
         MVC   PIDKJST,X#PAST                                                   
         MVC   PIDKPID,X#PIDAP                                                  
         MVC   PIDKACC,SAVEKEY4+ACTKACT-ACTRECD                                 
         MVI   X#PTYP,X#PTYPPQ                                                  
         CLI   X#PAST,PIDKJSAQ                                                  
         JE    JLSD074                                                          
         MVC   PIDKPID,X#PIDSU                                                  
                                                                                
JLSD074  MVC   SAVEKEY2,IOKEY                                                   
         J     JLSD090                                                          
                                                                                
JLSD076  MVI   X#PAST,0                                                         
***      LA    RE,RQ_JDNAM+L'RQ_JDNAM-1                                         
***      LA    RF,L'RQ_JDNAM                                                    
***                                                                             
***D078  CLI   0(RE),C' '                                                       
***      JH    JLSD080                                                          
***                                                                             
***      SHI   RE,1                                                             
***      JCT   RF,JLSD078                                                       
                                                                                
JLSD080  LLC   RF,X#JSNAL                                                       
         SHI   RF,1                                                             
         STC   RF,X#SRCL                                                        
         MVI   X#HIGH,YESQ                                                      
         LLC   R1,X#CLVL                                                        
         SHI   R1,ACTKACT-ACTKCPY                                               
         STC   R1,X#CLVL                                                        
                                                                                
         L     R2,AIO7             buffer table to skip dupes                   
         LHI   R0,(L'IOAREA7+L'IOAREA8)/L'ACTKACT                               
         STH   R0,0(R2)                                                         
         MVI   2(R2),0                                                          
                                                                                
         USING SRCRECD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    SRCKEY,SRCKEY                                                    
         MVI   SRCKTYP,SRCKTYPQ                                                 
         MVC   SRCKCPY,CUXCPY                                                   
         MVC   SRCKUL,PRODUL                                                    
         MVI   SRCKSUB,SRCKWDSQ                                                 
         MVC   SRCKWRD1,SPACES                                                  
***      MVC   SRCKWRD1(0),RQ_JDNAM                                             
         MVC   SRCKWRD1(0),X#JSNAM                                              
         EX    RF,*-6                                                           
                                                                                
         MVC   SAVEKEY2,IOKEY                                                   
         XC    SAVEKEY5,SAVEKEY5                                                
         MVI   X#TSAYN,YESQ                                                     
         MVI   X#PTYP,X#PTYPSQ                                                  
         J     JLSD090                                                          
                                                                                
JLSD085  TM    X#JDTPAS,X#JDTPCQ+X#JDTPOQ                                       
         JZ    JLSD090             open/close date passives                     
         LLC   R0,X#JDTPAS         (save)                                       
         MVI   X#JDTPAS,0                                                       
         CLC   RQ_JDCLC,SPACES     unless single client specified               
         JH    JLSD090                                                          
         DS    0H                  ... any other exclusions here                
         STC   R0,X#JDTPAS         (restore)                                    
                                                                                
         USING JDTPASD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    JDTPAS,JDTPAS                                                    
         MVI   JDTPTYP,JDTPTYPQ                                                 
         MVI   JDTPSUB,JDTPSUBQ                                                 
         MVC   JDTPCPY,CUXCPY                                                   
         MVI   JDTPDTYP,JDTPDTCQ                                                
         LA    R4,X#CLOX                                                        
         GOTO1 VDATCON,DMCB,(1,X#CLOD),(2,X#PASSTA)                             
         GOTO1 VDATCON,DMCB,(1,(R4)),(2,X#PASEND)                               
         TM    X#JDTPAS,X#JDTPCQ                                                
         JNZ   JLSD087                                                          
         MVI   JDTPDTYP,JDTPDTOQ                                                
         LA    R4,X#OPNX                                                        
         GOTO1 VDATCON,DMCB,(1,X#OPND),(2,X#PASSTA)                             
         GOTO1 VDATCON,DMCB,(1,(R4)),(2,X#PASEND)                               
                                                                                
JLSD087  MVC   JDTPDATE,X#PASSTA                                                
         MVC   SAVEKEY2,IOKEY                                                   
         MVI   X#TSAYN,YESQ                                                     
         MVI   X#HIGH,YESQ                                                      
         MVI   X#PTYP,X#PTYPJQ                                                  
                                                                                
JLSD090  ZAP   DUB1,PZERO          counter for internal purposes                
                                                                                
JLSD100  CLC   RQ_JDJOB,SPACES     If job code specified                        
         JH    JLSD990              exit as no more to show                     
         LHI   R1,IOHI+IODIR+IO2                                                
         CLI   X#HIGH,YESQ         check for read high required                 
         JE    JLSD102                                                          
                                                                                
         LHI   R1,IOSQ+IODIR+IO2                                                
                                                                                
JLSD102  AP    DUB1,=P'1'                                                       
                                                                                
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    JLSD103                                                          
                                                                                
         MVC   LP_ERROR,=AL2(AE$ENDOF)   FILE ERROR                             
         J     XERROR                                                           
                                                                                
JLSD103  CLI   X#PTYP,X#PTYPAQ                                                  
         JNE   JLSD104                                                          
         CLC   IOKEY+L'ACTKCULA(L'ACTKEY-L'ACTKCULA),SPACES                     
         JNH   JLSD104             Are we still at job level?                   
                                                                                
T        USING ACTRECD,IOKEY       read for next job                            
         MVI   T.ACTKACT+L'ACTKACT,FF                                           
         MVI   X#HIGH,YESQ                                                      
         J     JLSD100                                                          
         DROP  T                                                                
                                                                                
         USING SRCRECD,R2                                                       
JLSD104  LA    R2,IOKEY                                                         
         MVC   SAVEKEY3,IOKEY                                                   
                                                                                
         CLI   X#PTYP,X#PTYPSQ     Search passives take precedence              
         JE    JLSD108                                                          
                                                                                
         CLI   X#PTYP,X#PTYPJQ     JDT passives in use?                         
         JNE   JLSD112                                                          
                                                                                
         GOTOR XCHKJDT                                                          
         JE    JLSD160                                                          
         JH    JLSD990                                                          
         J     JLSD100                                                          
                                                                                
JLSD108  CLC   SAVEKEY2(SRCKWRD1-SRCRECD),SRCKEY                                
         JNE   JLSD990                                                          
                                                                                
         LLC   RF,X#SRCL                                                        
         EX    RF,JLSD109                                                       
         JNE   JLSD990                                                          
                                                                                
         TM    SRCKSTAT,ACTSABLP                                                
         JNZ   JLSD110                                                          
         MVI   X#HIGH,NOQ                                                       
         J     JLSD100                                                          
                                                                                
***D109  CLC   SRCKWRD1(0),RQ_JDNAM                                             
JLSD109  CLC   SRCKWRD1(0),X#JSNAM                                              
                                                                                
JLSD110  GOTOR CASCLI,SRCKACT      Check and set client                         
         JNE   JLSD100                                                          
         GOTOR CASPRO,SRCKACT      Check and set product                        
         JNE   JLSD100                                                          
                                                                                
         GOTOR XJOBPAS                                                          
         JNE   JLSD111                                                          
         GOTOR XMULSTA,SRCKEY      check multiple status                        
         JNE   JLSD111                                                          
         GOTOR CHKDUP,SRCKACT      check for dupes                              
         JNE   JLSD160                                                          
                                                                                
JLSD111  MVI   X#HIGH,NOQ                                                       
         J     JLSD100                                                          
                                                                                
         USING DRAPASD,R2                                                       
JLSD112  LA    R2,IOKEY                                                         
         CLI   X#PTYP,X#PTYPDQ                                                  
         JNE   JLSD114                                                          
         CLC   SAVEKEY2(DRAPACT-DRAPASD),DRAPAS                                 
         JNE   JLSD990                                                          
                                                                                
         GOTOR CASCLI,DRAPACT      Check and set client                         
         JNE   JLSD100                                                          
         GOTOR CASPRO,DRAPACT      Check and set product                        
         JNE   JLSD100                                                          
                                                                                
         GOTOR XJOBDRA                                                          
         JH    JLSD990                                                          
         JNE   JLSD113                                                          
                                                                                
         GOTOR XMULSTA,DRAPAS                     check multiple status         
         JE    JLSD160                                                          
                                                                                
JLSD113  MVI   X#HIGH,NOQ                                                       
         J     JLSD100                                                          
                                                                                
         USING PIDRECD,R2                                                       
JLSD114  CLI   X#PTYP,X#PTYPPQ                                                  
         JNE   JLSD116                                                          
         CLC   SAVEKEY2(PIDKACC-PIDRECD),PIDKEY                                 
         JNE   JLSD990                                                          
                                                                                
***      CLC   PIDKADAT,X#13MDAT   13 months backwards maximum                  
***      JL    JLSD100             (not required here)                          
                                                                                
         GOTOR CASCLI,PIDKACC      Check and set client                         
         JNE   JLSD100                                                          
         GOTOR CASPRO,PIDKACC      Check and set product                        
         JNE   JLSD100                                                          
                                                                                
         GOTOR XJOBPID                                                          
         JH    JLSD990                                                          
         JNE   JLSD115                                                          
                                                                                
         GOTOR XMULSTA,PIDKEY      check multiple status                        
         JE    JLSD160                                                          
                                                                                
JLSD115  MVI   X#HIGH,NOQ                                                       
         J     JLSD100                                                          
                                                                                
         USING ACTRECD,R2                                                       
JLSD116  CLC   ACTKCPY,CUXCPY      exit if past CUL                             
         JNE   JLSD990                                                          
         CLC   ACTKUNT(2),PRODUL                                                
         JNE   JLSD990                                                          
                                                                                
         GOTOR CASCLI,ACTKACT      Check and set client                         
         JNE   JLSD100                                                          
***      GOTOR CASPRO,ACTKACT      Check and set product                        
***      JNE   JLSD100                                                          
                                                                                
         CLC   RQ_JDCLC,SPACES                                                  
         JNH   JLSD125                                                          
                                                                                
         LLC   RE,X#CLVL                                                        
         EX    RE,JLSD120                                                       
         JE    JLSD125                                                          
         J     JLSD990                                                          
                                                                                
JLSD120  CLC   SAVEKEY4(0),ACTKEY                                               
                                                                                
JLSD125  TM    ACTKSTAT,ACTSABLP   is it a job?                                 
         JNZ   JLSD150                                                          
                                                                                
         CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    JLSD135                                                          
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    JLSD135                                                          
         CLI   RQ_JDLST,YESQ       include locked jobs?                         
         JE    JLSD135                                                          
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    JLSD135                                                          
                                                                                
         TM    ACTKSTAT,ACTSLOCK   product locked?                              
         JZ    JLSD135                                                          
                                                                                
JLSD130  LLC   RE,PPROLEN          then read for next product                   
         LA    RE,ACTKACT(RE)                                                   
         MVI   0(RE),FF                                                         
         MVI   X#HIGH,YESQ                                                      
         J     JLSD100                                                          
                                                                                
JLSD135  CLI   RQ_JDDRA,C'O'       drafts only?                                 
         JNE   JLSD137                                                          
         TM    ACTKSTAT,ACTSDRFT                                                
         JZ    JLSD130                                                          
         J     JLSD140                                                          
                                                                                
JLSD137  CLI   RQ_JDDRA,NOQ        drafts not?                                  
         JNE   JLSD140                                                          
         TM    ACTKSTAT,ACTSDRFT                                                
         JNZ   JLSD130                                                          
                                                                                
JLSD140  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                 Bad master record                            
                                                                                
         L     R2,AIO2                                                          
         GOTOR XJOBGOF                                                          
                                                                                
         MVC   X#POFF,X#HOFF                                                    
         CLC   X#AOFF,SPACES                                                    
         JNH   JLSD141                                                          
         MVC   X#POFF,X#AOFF                                                    
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
JLSD141  XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         LHI   R1,JSBDLNQ                                                       
         STH   R1,TSB.JSBDLEN                                                   
         MVI   TSB.JSBDTYP,JSBDTPQ                                              
         MVC   TSB.JSBDCOD,ACTKACT                                              
         MVC   TSB.JSBDOFF,X#POFF                                               
         MVC   TSB.JSBDNAM,SPACES                                               
         CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    JLSD141A                                                         
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    JLSD141A                                                         
         CLI   RQ_JDLST,YESQ       include locked jobs?                         
         JE    JLSD141A                                                         
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    JLSD141A                                                         
         MVC   TSB.JSBDSTA,ACTRSTAT                                             
                                                                                
         USING NAMELD,R1                                                        
JLSD141A LA    R1,ACTRFST                                                       
JLSD142  CLI   NAMEL,NAMELQ                                                     
         JE    JLSD143                                                          
         CLI   NAMEL,0                                                          
         JE    *+2                                                              
         LLC   R0,NAMLN                                                         
         AR    R1,R0                                                            
         J     JLSD142                                                          
JLSD143  LLC   RE,NAMLN                                                         
         SHI   RE,NAMLN1Q+1                                                     
         MVC   TSB.JSBDNAM(0),NAMEREC                                           
         EX    RE,*-6                                                           
         DROP  R1                                                               
                                                                                
         GOTOR SETXDB,DMCB,TSB.JSBDXDB,ACTRECD                                  
                                                                                
         CLI   X#TSAYN,YESQ        TSAR required?                               
         JNE   JLSD145                                                          
                                                                                
         GOTOR GOTSAR,DMCB,('TSAADD',0)  add product to buffer                  
         JE    JLSD145                                                          
         TM    TSARERRS,TSEEOF     buffer full - so it is ...                   
         JNZ   JLSD145                                                          
         TM    TSARERRS,TSEDUP                                                  
         JZ    *+2                                                              
         TM    SAVEIND,SAVEML2     duplicate key OK on lap 2                    
         JZ    *+2                                                              
                                                                                
JLSD145  LLC   RF,PCLILEN          save current product details                 
         LA    RF,TSB.JSBDCOD(RF)                                               
         MVC   ELESDPRO(0),0(RF)                                                
         MVC   ELESDPST,TSB.JSBDSTA                                             
         MVC   ELESDPOF,TSB.JSBDOFF                                             
         MVC   ELESDPRN,TSB.JSBDNAM                                             
         MVC   ELESDPXD,TSB.JSBDXDB                                             
         MVC   X#POFF,ELESDPOF                                                  
         DROP  TSB                                                              
                                                                                
         MVI   X#HIGH,NOQ          read for job                                 
         J     JLSD100                                                          
                                                                                
JLSD150  DS    0H                  process job record                           
                                                                                
         MVC   SAVEKEY1,IOKEY      save current key                             
         MVC   SAVEKEY3,IOKEY                                                   
         MVI   X#HIGH,NOQ                                                       
                                                                                
         GOTOR XJOBDIR             directory filter                             
         JNE   JLSD155                                                          
                                                                                
         GOTOR XMULSTA,ACTKEY      check multiple status                        
         JE    JLSD160                                                          
                                                                                
JLSD155  CLI   X#HIGH,YESQ                                                      
         JE    JLSD100                                                          
         J     JLSD170                                                          
                                                                                
JLSD160  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                 Bad master record                            
                                                                                
         MVI   X#GAPIND,0                                                       
                                                                                
         GOTOR XNAMFLT             extra name filtering                         
         JNE   JLSD170                                                          
         GOTOR XJOBFLT             filter job record                            
         JNE   JLSD170                                                          
                                                                                
         CLI   X#PTYP,X#PTYPSQ     Search passives - buffer it                  
         JNE   JLSD165                                                          
         L     R2,AIO2             Ensure account code is passed                
         GOTOR ADDDUP,ACTKACT      add to dupe check table                      
                                                                                
JLSD165  GOTOR XJOBOUT             download job details                         
         GOTOR CHKACT              Check whether we can close this              
                                                                                
         GOTOR LP_APUTO,LP_D                                                    
                                                                                
JLSD170  MVC   IOKEY,SAVEKEY3      restore key (read high for next job)         
         MVI   X#HIGH,YESQ                                                      
         CLI   X#PTYP,X#PTYPJQ     JDT passives in use?                         
         JE    JLSD185                                                          
         CLI   X#PTYP,X#PTYPSQ     Search passives in use?                      
         JE    JLSD175                                                          
         CLI   X#PTYP,X#PTYPDQ     DRAPAS passives in use?                      
         JE    JLSD190                                                          
         CLI   X#PTYP,X#PTYPPQ     PID passive in use?                          
         JE    JLSD180                                                          
         CLI   X#PTYP,X#PTYPAQ     ACTRECD in use?                              
         JNE   *+2                                                              
                                                                                
         MVI   IOKEY+TRNKWORK-TRNRECD,FF                                        
         J     JLSD100                                                          
                                                                                
JLSD175  LLC   RF,IOKEY+L'SRCKEY-1                                              
         AHI   RF,1                                                             
         STC   RF,IOKEY+L'SRCKEY-1                                              
         J     JLSD100                                                          
                                                                                
JLSD180  MVC   IOKEY+PIDKADAT-PIDRECD(L'PIDKADAT),XFFS                          
         J     JLSD100                                                          
                                                                                
JLSD185  LLC   R1,IOKEY+L'JDTPAS-1                                              
         AHI   R1,1                                                             
         STC   R1,IOKEY+L'JDTPAS-1                                              
         J     JLSD100                                                          
                                                                                
JLSD190  LLC   R1,IOKEY+DRAPACT-DRAPAS+L'DRAPACT-1                              
         AHI   R1,1                                                             
         STC   R1,IOKEY+DRAPACT-DRAPAS+L'DRAPACT-1                              
         XC    IOKEY+DRAPPID-DRAPAS(L'DRAPPID),IOKEY+DRAPPID-DRAPAS             
         J     JLSD100                                                          
                                                                                
JLSD300  DS    0H                  New call type for Job Approvals              
         MVI   X#TSAYN,YESQ        -------------------------------              
                                                                                
         CLI   RQ_JDTYP,RQ_JDT1Q   User approved                                
         JNE   JLSD305                                                          
                                                                                
         GOTOR JLAPDL                                                           
         J     JLSD390                                                          
                                                                                
JLSD305  CLI   RQ_JDTYP,RQ_JDT2Q   User rejected                                
         JNE   JLSD310                                                          
                                                                                
         GOTOR JLREDL                                                           
         J     JLSD390                                                          
                                                                                
JLSD310  CLI   RQ_JDTYP,RQ_JDT3Q   User needs to approve                        
         JNE   JLSD315                                                          
                                                                                
         GOTOR JLNADL                                                           
         J     JLSD390                                                          
                                                                                
JLSD315  CLI   RQ_JDTYP,RQ_JDT4Q   User added (is draft)                        
         JNE   JLSD320                                                          
                                                                                
         GOTOR JLUDDL                                                           
         J     JLSD390                                                          
                                                                                
JLSD320  CLI   RQ_JDTYP,RQ_JDT5Q   User added (is rejected)                     
         JNE   JLSD325                                                          
                                                                                
         GOTOR JLUDDL                                                           
         J     JLSD390                                                          
                                                                                
JLSD325  CLI   RQ_JDTYP,RQ_JDT6Q   User added (is approved)                     
         JNE   JLSD330                                                          
                                                                                
         GOTOR JLAPDL                                                           
         J     JLSD390                                                          
                                                                                
JLSD330  CLI   RQ_JDTYP,RQ_JDT7Q   User assigned                                
         JNE   JLSD335                                                          
                                                                                
         GOTOR JLAPDL                                                           
         J     JLSD390                                                          
                                                                                
JLSD335  MVC   LP_ERROR,=AL2(AE$IVTYP)                                          
         J     XERROR                                                           
                                                                                
JLSD390  DS    0H                  Exit                                         
         JE    JLSD999             (JLSD990 if 2nd loop required)               
         CLI   RQ_JDGAO,YESQ       Skip errors in GAOV mode                     
         JE    JLSD999                                                          
         MVC   LP_ERROR,ROUERRV                                                 
         J     XERROR                                                           
                                                                                
JLSD990  DS    0H                  at the end of a code loop get here           
         DS    0H                  and determine if 2nd loop required           
                                                                                
         TM    SAVEIND,SAVEXDR     extra DRAPASD lap required?                  
         JZ    JLSD992                                                          
         NI    SAVEIND,FF-SAVEXDR                                               
         OI    SAVEIND,SAVEXDL                                                  
         J     JLSD066                                                          
                                                                                
JLSD992  TM    SAVEIND,SAVEMST     multiple status'?                            
         JZ    JLSD999                                                          
         TM    SAVEIND,SAVERL2     lap 2 required                               
         JZ    JLSD999                                                          
                                                                                
         MVI   X#JDSTAT,X#JDSTAP   set to approved for lap 2                    
         OI    SAVEIND,SAVEML2                                                  
         NI    SAVEIND,FF-(SAVEMST+SAVERL2)                                     
         J     JLSD030                                                          
                                                                                
JLSD999  DS    0H                  common end of processing for JLSD            
                                                                                
         GOTOR TRACEIT,1           tracing IOs                                  
                                                                                
         J     EXITY                                                            
         DROP  R2                                                               
                                                                                
**********************************************************************          
* GENERAL EXIT AND DECLARATIONS                                      *          
**********************************************************************          
                                                                                
EXITN    TM    TWAMODE,TWAMUWD                                                  
         JZ    EXITNX                                                           
         NI    TWAMODE,FF-TWAMUWD                                               
         DC    H'0'                Unwind here|                                 
EXITNX   LTR   RB,RB                                                            
         J     EXIT                                                             
EXITY    TM    TWAMODE,TWAMUWD                                                  
         JZ    EXITYX                                                           
         NI    TWAMODE,FF-TWAMUWD                                               
         DC    H'0'                Unwind here|                                 
EXITYX   CR    RE,RE                                                            
EXIT     XIT1  ,                                                                
                                                                                
***********************************************************************         
* General ERROR Exit                                                  *         
***********************************************************************         
                                                                                
XERROR   DS    0H                                                               
         MVI   LP_RMODE,LP_RERRR                                                
         MVI   LP_EMSYS,6                                                       
         J     EXITN                                                            
                                                                                
***********************************************************************         
* LITERAL POOL                                                        *         
***********************************************************************         
                                                                                
         LTORG                                                                  
* A#UFDL equates                                                                
MAXUFS   EQU  10                   Maximum no. user fields for display          
MAXLUF   EQU  (L'GENAREA)/ELMLNG   Maximum no. user fields for list             
                                                                                
LVALUES  DS    0D                                                               
         DC    CL8'DMKEY'                                                       
         DC    CL8'ACCDIR'                                                      
         DC    CL8'ACCMST'                                                      
         DC    CL8'ACCARC'                                                      
         DC    PL1'0'                                                           
         DC    4X'FF'                                                           
         DC    CL2'**'                                                          
         DC    CL2'99'                                                          
*&&US*&& DC    AL2(AC#CE,0,0,0,0)                                               
*&&UK*&& DC    AL2(AC#CE,AC#CEC,AC#CEB,AC#CECB,0)                               
         DC    AL1(8+5),4X'00',AL1(5),AL2(0),CL5'OE,CE'                         
LVALUESL EQU   *-LVALUES                                                        
*                                                                               
EXPTYTAB DS    0X                                                               
         DC    AL1(EXJPCLI1)                                                    
         DC    AL1(EXJPCBL1)                                                    
         DC    AL1(EXJPCNB1)                                                    
         DC    X'FF'                                                            
EXPTYTBL EQU   *-EXPTYTAB                                                       
*                                                                               
DCDICTL  DS    0X                                                               
         DCDDL AC#TIME,L'AC@TIME                                                
         DCDDL AC#MAT,L'AC@MAT                                                  
         DCDDL AC#EST,L'AC@EST                                                  
DCDICTLX DC    X'FF'                                                            
                                                                                
***********************************************************************         
* LOCAL ROUTINES                                                      *         
***********************************************************************         
                                                                                
* Process JLSD arrays                                                           
PROCARRY NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'**PARRY*'                                                      
                                                                                
         LARL  R1,UINGER                                                        
         LARL  RE,TRTSPEC                                                       
         CLI   CUCTRY,CTRYGER                                                   
         JE    PARRY00                                                          
         LARL  R1,UINUKUS                                                       
         LARL  RE,TRTSGER                                                       
                                                                                
PARRY00  ST    R1,AUINTAB                                                       
         ST    RE,ASRCTAB                                                       
                                                                                
         MVI   X#JDSTAT,0          job status array                             
         NI    SAVEIND,FF-SAVEMST                                               
         OC    RQ_JDSAD,RQ_JDSAD                                                
         JZ    PARRY14                                                          
                                                                                
         USING LW_D,R1                                                          
         XR    R1,R1               point to list in WMP                         
         ICM   R1,7,RQ_JDSAD                                                    
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN        number of entries                            
         CHI   R0,1                                                             
         JNH   PARRY02                                                          
         OI    SAVEIND,SAVEMST     indicate multiple status                     
         TM    SAVEIND,SAVEAUR     (only valid for Aura)                        
         JNZ   PARRY02                                                          
         MVC   LP_ERROR,=AL2(AE$TMINF)                                          
         J     PARRYN                                                           
                                                                                
PARRY02  LA    RF,LW_DATA2         start of list                                
                                                                                
PARRY04  CLI   0(RF),C'S'                                                       
         JNE   PARRY06                                                          
         OI    X#JDSTAT,X#JDSTSU                                                
         J     PARRY12                                                          
                                                                                
PARRY06  CLI   0(RF),C'R'                                                       
         JNE   PARRY08                                                          
         OI    X#JDSTAT,X#JDSTRE                                                
         J     PARRY12                                                          
                                                                                
PARRY08  CLI   0(RF),C'A'                                                       
         JNE   PARRY10                                                          
         OI    X#JDSTAT,X#JDSTAP                                                
         J     PARRY12                                                          
                                                                                
PARRY10  CLI   0(RF),C'M'                                                       
         JNE   PARRY12                                                          
         OI    X#JDSTAT,X#JDSTMA                                                
                                                                                
PARRY12  AHI   RF,L'X#JDSTAT                                                    
         JCT   R0,PARRY04                                                       
         DROP  R1                                                               
                                                                                
PARRY14  XC    X#MEDNO,X#MEDNO     check media list                             
         XC    X#MEDLS,X#MEDLS                                                  
         XC    ELEMENT,ELEMENT                                                  
         OC    RQ_JDMAD,RQ_JDMAD                                                
         JZ    PARRY18                                                          
                                                                                
         USING LW_D,R1                                                          
         XR    R1,R1               point to list in WMP                         
         ICM   R1,7,RQ_JDMAD                                                    
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN        number of entries                            
         STC   R0,X#MEDNO                                                       
         LA    RF,LW_DATA2         start of list                                
         LA    RE,X#MEDLS                                                       
                                                                                
PARRY16  MVC   0(L'PMDKMED,RE),0(RF)                                            
         AHI   RF,L'PMDKMED                                                     
         AHI   RE,L'PMDKMED                                                     
         JCT   R0,PARRY16                                                       
                                                                                
         CLI   X#MEDNO,1                                                        
         JE    PARRY18                                                          
         LHI   R0,L'PMDKMED                                                     
         XR    RF,RF                                                            
         ICM   RF,3,LW_NUMN                                                     
         DROP  R1                                                               
         GOTO1 VXSORT,DMCB,X#MEDLS,(RF),(R0),(R0),0                             
                                                                                
PARRY18  XC    X#JSNAMS,X#JSNAMS   check name search list                       
         OC    RQ_JDNAD,RQ_JDNAD                                                
         JZ    PARRY26                                                          
                                                                                
         USING LW_D,R1                                                          
         XR    R1,R1               point to list in WMP                         
         ICM   R1,7,RQ_JDNAD                                                    
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN        number of entries                            
         STC   R0,X#JSNAM#                                                      
         LA    R5,LW_DATA2         start of list                                
         LA    R4,X#JSNAL1                                                      
         DROP  R1                                                               
                                                                                
PARRY20  MVC   L'X#JSNAL1(L'X#JSNAM1,R4),0(R5)                                  
         L     R1,AUINTAB          translate to upper case                      
         TR    L'X#JSNAL1(L'X#JSNAM1,R4),0(R1)                                  
                                                                                
         LA    R1,L'X#JSNAL1+L'X#JSNAM1-1(R4)                                   
         LHI   R2,L'X#JSNAM1       save name and its length                     
PARRY22  CLI   0(R1),C' '                                                       
         JH    PARRY24                                                          
         SHI   R1,1                                                             
         JCT   R2,PARRY22                                                       
         DC    H'0'                                                             
PARRY24  STC   R2,0(R4)                                                         
         AHI   R5,L'X#JSNAM1                                                    
         AHI   R4,L'X#JSNAL1+L'X#JSNAM1                                         
         JCT   R0,PARRY20                                                       
                                                                                
         GOTOR TRANS4S             translate for search                         
         CLI   X#JSNAL,0                                                        
         JH    PARRY26                                                          
         MVC   LP_ERROR,=AL2(AE$RQNPC)                                          
         J     PARRYN                                                           
                                                                                
PARRY26  TM    SAVEIND,SAVEAUR     User fields - Aura vs. BrandOcean            
         JNZ   PARRY30                                                          
         OC    RQ_JDUAD,RQ_JDUAD                                                
         JZ    PARRY50                                                          
                                                                                
PARRY28  MVC   LP_ERROR,=AL2(AE$IVUFD)                                          
         J     PARRYN                                                           
                                                                                
PARRY30  CLC   RQ_JDUF1,SPACES                                                  
         JH    PARRY28                                                          
         CLC   RQ_JDUF2,SPACES                                                  
         JH    PARRY28                                                          
         CLC   RQ_JDUF3,SPACES                                                  
         JH    PARRY28                                                          
         CLC   RQ_JDUF4,SPACES                                                  
         JH    PARRY28                                                          
         CLC   RQ_JDUF5,SPACES                                                  
         JH    PARRY28                                                          
         CLC   RQ_JDUF6,SPACES                                                  
         JH    PARRY28                                                          
         CLC   RQ_JDUF7,SPACES                                                  
         JH    PARRY28                                                          
         CLC   RQ_JDUF8,SPACES                                                  
         JH    PARRY28                                                          
         CLC   RQ_JDUF9,SPACES                                                  
         JH    PARRY28                                                          
         CLC   RQ_JDUF0,SPACES                                                  
         JH    PARRY28                                                          
                                                                                
         XC    X#UFLD,X#UFLD                                                    
                                                                                
         OC    RQ_JDUAD,RQ_JDUAD   any user field array?                        
         JZ    PARRY50                                                          
                                                                                
         USING LW_D,R3                                                          
         XR    R3,R3               point to list in WMP                         
         XR    R4,R4                                                            
         ICM   R3,7,RQ_JDUAD                                                    
         XR    R0,R0                                                            
         ICM   R0,3,LW_NUMN        number of entries                            
         CHI   R0,RQ_JDUMX         current maximum                              
         JNH   PARRY32                                                          
         MVC   LP_ERROR,=AL2(AE$TMINF)                                          
         J     PARRYN                                                           
                                                                                
PARRY32  AHI   R3,LW_LN2Q          R3=A(first array line data)                  
         LA    R2,X#UFLDH1                                                      
                                                                                
PARRY34  CLC   0(L'UFSDESC,R3),SPACES                                           
         JNH   PARRY44                                                          
                                                                                
         L     RF,AUINTAB          translate to upper case                      
         TR    0(L'UFSDESC,R3),0(RF)                                            
                                                                                
         LA    R1,L'UFSDESC-1(R3)                                               
         LHI   RF,L'UFSDESC                                                     
PARRY36  CLI   0(R1),C' '                                                       
         JH    PARRY38                                                          
         SHI   R1,1                                                             
         JCT   RF,PARRY36                                                       
         DC    H'0'                                                             
                                                                                
PARRY38  STC   RF,0(R2)                                                         
                                                                                
         CLC   L'UFSDESC(UFSDATMX,R3),SPACES                                    
         JNH   PARRY44                                                          
                                                                                
         L     RF,AUINTAB          translate to upper case                      
         TR    L'UFSDESC(UFSDATMX,R3),0(RF)                                     
                                                                                
         LA    R1,UFSDATMX-1+L'UFSDESC(R3)                                      
         LHI   RF,UFSDATMX                                                      
PARRY40  CLI   0(R1),C' '                                                       
         JH    PARRY42                                                          
         SHI   R1,1                                                             
         JCT   RF,PARRY40                                                       
         DC    H'0'                                                             
                                                                                
PARRY42  STC   RF,1(R2)                                                         
                                                                                
PARRY44  AHI   R3,L'UFSDESC                                                     
         XR    RF,RF               For Aura check data type and convert         
         ICM   RF,B'0011',CUXPNUM                                               
         CHI   RF,XPRODIKQ                                                      
         JNE   PARRY48                                                          
         LA    RF,UFSDATMX(R3)                                                  
         CLI   0(RF),RQ_USFDA      Date field convert                           
         JNE   PARRY48                                                          
         MVC   X#DATD,0(R3)                                                     
         MVC   0(UFSDATMX,R3),SPACES                                            
         GOTO1 VDATCON,DMCB,(9,X#DATD),(8,0(R3))                                
*&&UK*&& OI    0(R3),X'F0'                                                      
         LR    RE,R4               any data filter?                             
         MHI   RE,X#UFLDD2-X#UFLDD1                                             
         LA    RE,X#UFLDD1(RE)                                                  
         LHI   R1,8                                                             
         CLI   CUCTRY,CTRYGBR                                                   
         JNE   *+8                                                              
         LHI   R1,7                                                             
         STC   R1,0(RE)            update length of data filter                 
         J     PARRY48                                                          
*                                                                               
PARRY48  AHI   R4,1                                                             
         AHI   R3,UFSDATMX+UFSTYPEL                                             
         AHI   R2,X#UFLDH2-X#UFLDH1                                             
         JCT   R0,PARRY34                                                       
         DROP  R3                                                               
                                                                                
PARRY50  DS    0H                                                               
                                                                                
PARRYY   LHI   R1,1                                                             
         J     PARRYX                                                           
PARRYN   LHI   R1,0                                                             
PARRYX   CHI   R1,1                                                             
PARRYXX  XIT1                                                                   
                                                                                
* Apply GESRCHPARS.TRTSPEC and .TRTSGER character handling                      
TRANS4S  NTR1                                                                   
                                                                                
         MVC   ELEMENT(L'X#JSNAM1),X#JSNAM1                                     
         L     R3,ASRCTAB                                                       
         TR    ELEMENT(L'X#JSNAM),0(R3)                                         
                                                                                
         LHI   R0,L'X#JSNAM        now squash out any unknowns (X'00')          
         LA    RE,ELEMENT                                                       
         LA    R1,X#JSNAM                                                       
         MVC   X#JSNAM,SPACES                                                   
                                                                                
TRANS4S1 CLI   0(RE),X'40'                                                      
         JE    TRANS4S3            exit on first space                          
         JL    TRANS4S2            skip zeroes                                  
         MVC   0(1,R1),0(RE)                                                    
         AHI   R1,1                                                             
                                                                                
TRANS4S2 AHI   RE,1                                                             
         JCT   R0,TRANS4S1                                                      
                                                                                
TRANS4S3 LA    R1,X#JSNAM+L'X#JSNAM-1                                           
         LHI   R0,L'X#JSNAM                                                     
                                                                                
TRANS4S4 CLI   0(R1),X'40'                                                      
         JH    TRANS4S5                                                         
         SHI   R1,1                                                             
         JCT   R0,TRANS4S4                                                      
                                                                                
TRANS4S5 STC   R0,X#JSNAL          length + name value for SRCKWRD1 set         
         J     PARRYXX                                                          
                                                                                
         LTORG                                                                  
                                                                                
         DS    0H                                                               
       ++INCLUDE FACTRYXLAT                                                     
                                                                                
         DS    0H                                                               
TRTSPEC  DC    256AL1(0)           TRANSLATED VALUE IS X'00', EXCEPT            
*                                                                               
         ORG   TRTSPEC+C'A'        UPPER CASE LETTERS                           
         DC    C'ABCDEFGHI'                                                     
         ORG   TRTSPEC+C'J'                                                     
         DC    C'JKLMNOPQR'                                                     
         ORG   TRTSPEC+C'S'                                                     
         DC    C'STUVWXYZ'                                                      
*                                                                               
         ORG   TRTSPEC+C'0'        UPPER CASE NUMBERS                           
         DC    C'0123456789'                                                    
*                                                                               
         ORG   TRTSPEC+C' '        SPACES STAY SAME                             
         DC    X'40'                                                            
*                                                                               
         ORG   TRTSPEC+C'*'        '*' STAYS SAME, IN CASE PARTIAL FLAG         
         DC    C'*'                                                             
*                                                                               
         ORG   TRTSPEC+C'.'        THESE SPECIAL CHARS BECOME SPACES            
         DC    X'40'               AND ARE TREATED AS WORD SEPARATORS           
         ORG   TRTSPEC+C'<'        ALL OTHERS BECOME NULLS AND ARE              
         DC    X'40'               IGNORED AS IF COMPRESSED OUT.                
         ORG   TRTSPEC+C'('                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C'+'                                                     
         DC    C'+'                                                             
         ORG   TRTSPEC+C'&&'                                                    
         DC    X'40'                                                            
         ORG   TRTSPEC+C')'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C';'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C'-'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C'/'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C','                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C'_'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C'>'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C':'                                                     
         DC    X'40'                                                            
         ORG   TRTSPEC+C'='                                                     
         DC    X'40'                                                            
*                                                                               
         ORG   ,                                                                
*                                                                               
TRTSGER  DC    256AL1(0)           TRANSLATED VALUE IS X'00', EXCEPT            
*                                                                               
         ORG   TRTSGER+C'A'        UPPER CASE LETTERS                           
         DC    C'ABCDEFGHI'                                                     
         ORG   TRTSGER+C'J'                                                     
         DC    C'JKLMNOPQR'                                                     
         ORG   TRTSGER+C'S'                                                     
         DC    C'STUVWXYZ'                                                      
*                                                                               
         ORG   TRTSGER+X'4A'       4A=U/C A UMLAUT                              
         DC    X'4A'                                                            
         ORG   TRTSGER+X'5A'       5A=U/C U UMLAUT (! IN ENGLISH)               
         DC    X'5A'                                                            
         ORG   TRTSGER+X'A1'       A1=SS                                        
         DC    X'A1'                                                            
         ORG   TRTSGER+X'E0'       E0=U/C O UMLAUT                              
         DC    X'E0'                                                            
*                                                                               
         ORG   TRTSGER+C'0'        UPPER CASE NUMBERS                           
         DC    C'0123456789'                                                    
*                                                                               
         ORG   TRTSGER+C' '        SPACES STAY SAME                             
         DC    X'40'                                                            
*                                                                               
         ORG   TRTSGER+C'*'        '*' STAYS SAME, IN CASE PARTIAL FLAG         
         DC    C'*'                                                             
*                                                                               
         ORG   TRTSGER+C'.'        THESE SPECIAL CHARS BECOME SPACES            
         DC    X'40'               AND ARE TREATED AS WORD SEPARATORS           
         ORG   TRTSGER+C'<'        ALL OTHERS BECOME NULLS AND ARE              
         DC    X'40'               IGNORED AS IF COMPRESSED OUT.                
         ORG   TRTSGER+C'('                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'+'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'&&'                                                    
         DC    X'40'                                                            
         ORG   TRTSGER+C')'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C';'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'-'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'/'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C','                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'_'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'>'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C':'                                                     
         DC    X'40'                                                            
         ORG   TRTSGER+C'='                                                     
         DC    X'40'                                                            
*                                                                               
         ORG   ,                                                                
                                                                                
* Trace in SYSPRINT                                                             
TRACEIT  NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'**TRACE*'                                                      
                                                                                
         TM    LP_FLAG,LP_FOFFL    Test offline                                 
         JZ    TRACEITX                                                         
                                                                                
         L     RF,ARUNFACS         Get A(RUNFACS)                               
         L     R3,RCPRINT-RUNFACSD(RF)                                          
         AHI   R3,P_P-P_DPRINT                                                  
         USING PTRACED,R3                                                       
                                                                                
         XR    R2,R2                                                            
         ICM   R2,3,LP_QMAPN                                                    
                                                                                
         CHI   R1,0                                                             
         JNE   TRACEITA                                                         
                                                                                
         L     RF,ARUNFACS         Get A(RUNFACS)                               
         MVC   LIOTRACE,RTOTSIO-RUNFACSD(RF)                                    
                                                                                
         MVC   PTTWHO,=CL6'A#JAUD'                                              
         CHI   R2,A#JAUD                                                        
         JE    TRACEIT1                                                         
         MVC   PTTWHO,=CL6'A#UFDL'                                              
         CHI   R2,A#UFDL                                                        
         JE    TRACEIT1                                                         
         MVC   PTTWHO,=CL6'A#JLSD'                                              
         CHI   R2,A#JLSD                                                        
         JE    TRACEIT1                                                         
         MVC   PTTWHO,=CL6'A#JBAG'                                              
         CHI   R2,A#JBAG                                                        
         JE    TRACEIT1                                                         
         MVC   PTTWHO,=CL6'A#JAPP'                                              
         CHI   R2,A#JAPP                                                        
         JE    TRACEIT1                                                         
         MVC   PTTWHO,=CL6'UNKNOW'                                              
                                                                                
TRACEIT1 MVC   PTTTIME,TTIMED                                                   
         THMS                                                                   
         ST    R1,FULL1                                                         
         UNPK  WORK(6),FULL1                                                    
         MVC   PTHH,WORK           Set HH:MM:SS                                 
         MVI   PTCO1,C':'                                                       
         MVC   PTMM,WORK+2                                                      
         MVI   PTCO2,C':'                                                       
         OI    WORK+5,X'F0'                                                     
         MVC   PTSS,WORK+4                                                      
                                                                                
         MVC   PTTALPH,TALPHAID                                                 
         MVC   PTALPH,CUAALF                                                    
         MVC   PTTUSER,TUSERPID                                                 
         XOUT  CCTPID,PTUSER,2     CUPASS may be empty                          
                                                                                
         CHI   R2,A#JLSD                                                        
         JNE   TRACEIT2                                                         
                                                                                
         MVC   PTFIELD(L'TJDTYP),TJDTYP                                         
         MVC   PFIELD(L'RQ_JDTYP),RQ_JDTYP                                      
                                                                                
         MVC   PTAURA,TAURANO                                                   
         TM    SAVEIND,SAVEAUR                                                  
         JZ    TRACEIT2                                                         
         MVC   PTAURA,TAURAYES                                                  
                                                                                
TRACEIT2 GOTO1 APRINTER                                                         
                                                                                
         CHI   R2,A#JLSD           More details if Job Search                   
         JNE   TRACEITX                                                         
         LA    R4,PTEXTRA                                                       
         LHI   R0,L'PTEXTRA-10                                                  
                                                                                
         CLC   RQ_JDCLC,SPACES                                                  
         JNH   TRACEIT3                                                         
         MVC   0(L'TCLIENT,R3),TCLIENT                                          
         AHI   R3,L'TCLIENT+1                                                   
         SHI   R0,L'TCLIENT+1                                                   
         LTR   R0,R0                                                            
         JNP   TRACEIT9                                                         
                                                                                
         CLC   RQ_JDPRO,SPACES                                                  
         JNH   TRACEIT3                                                         
         MVC   0(L'TPRODUCT,R3),TPRODUCT                                        
         AHI   R3,L'TPRODUCT+1                                                  
         SHI   R0,L'TPRODUCT+1                                                  
         LTR   R0,R0                                                            
         JNP   TRACEIT9                                                         
                                                                                
TRACEIT3 OC    RQ_JDMAD,RQ_JDMAD                                                
         JZ    TRACEIT4                                                         
         MVC   0(L'TMEDIA,R3),TMEDIA                                            
         AHI   R3,L'TMEDIA+1                                                    
         SHI   R0,L'TMEDIA+1                                                    
         LTR   R0,R0                                                            
         JNP   TRACEIT9                                                         
                                                                                
TRACEIT4 CLC   RQ_JDOPN,SPACES                                                  
         JNH   TRACEIT5                                                         
         MVC   0(L'TOPEND,R3),TOPEND                                            
         AHI   R3,L'TOPEND+1                                                    
         SHI   R0,L'TOPEND+1                                                    
         LTR   R0,R0                                                            
         JNP   TRACEIT9                                                         
                                                                                
TRACEIT5 CLC   RQ_JDCLO,SPACES                                                  
         JNH   TRACEIT6                                                         
         MVC   0(L'TCLOSD,R3),TCLOSD                                            
         AHI   R3,L'TCLOSD+1                                                    
         SHI   R0,L'TCLOSD+1                                                    
         LTR   R0,R0                                                            
         JNP   TRACEIT9                                                         
                                                                                
TRACEIT6 OC    RQ_JDNAD,RQ_JDNAD                                                
         JZ    TRACEIT7                                                         
         MVC   0(L'TNAMSR,R3),TNAMSR                                            
         AHI   R3,L'TNAMSR+1                                                    
         SHI   R0,L'TNAMSR+1                                                    
         LTR   R0,R0                                                            
         JNP   TRACEIT9                                                         
                                                                                
TRACEIT7 OC    RQ_JDUAD,RQ_JDUAD                                                
         JZ    TRACEIT8                                                         
         MVC   0(L'TUFLDSR,R3),TUFLDSR                                          
         AHI   R3,L'TUFLDSR+1                                                   
         SHI   R0,L'TUFLDSR+1                                                   
         LTR   R0,R0                                                            
         JNP   TRACEIT9                                                         
                                                                                
TRACEIT8 DS    0H                                                               
                                                                                
TRACEIT9 CLC   PTEXTRA,SPACES                                                   
         JNH   TRACEITX                                                         
         GOTO1 APRINTER                                                         
         J     TRACEITX                                                         
                                                                                
TRACEITA CHI   R1,1                                                             
         JNE   TRACEITX                                                         
                                                                                
         MVC   PTRACED(L'P_P),SPACES                                            
         MVC   PTTIO(L'TIOTRACE),TIOTRACE                                       
         L     R0,LIOTRACE                                                      
         EDITR (R0),(8,PTTIO+12),0,ZERO=NOBLANK                                 
         MVC   PTTIO+12+8+2(2),TFROMTO                                          
         L     RF,ARUNFACS         Get A(RUNFACS)                               
         L     R0,RTOTSIO-RUNFACSD(RF)                                          
         EDITR (R0),(8,PTTIO+12+8+2+2+2),0,ZERO=NOBLANK                         
         GOTO1 APRINTER                                                         
                                                                                
TRACEITX XIT1                                                                   
                                                                                
TWHO     DC    C'A#JLSD'                                                        
TTIMED   DC    C'Time:'                                                         
TALPHAID DC    C'AlphaID:'                                                      
TJDTYP   DC    C'RQ_JDTYP:'                                                     
TAURAYES DC    C'Aura=Yes'                                                      
TAURANO  DC    C'Aura=No '                                                      
TUSERPID DC    C'PID:'                                                          
TCLIENT  DC    C'Client'                                                        
TPRODUCT DC    C'Product'                                                       
TMEDIA   DC    C'Media'                                                         
TOPEND   DC    C'OpenDate'                                                      
TCLOSD   DC    C'CloseDate'                                                     
TNAMSR   DC    C'NameSearch'                                                    
TUFLDSR  DC    C'UsrFSearch'                                                    
TIOTRACE DC    C'I/O Trace:'                                                    
TFROMTO  DC    C'=>'                                                            
                                                                                
         LTORG                                                                  
         DROP  R3                                                               
                                                                                
* Directory filter for multiple status scenario                                 
XMULSTA  NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'**MULSTA'                                                      
                                                                                
         NI    SAVEIND,FF-SAVEPMA                                               
         LR    R2,R1               point to key                                 
                                                                                
         USING ACTRECD,R2                                                       
         TM    SAVEIND,SAVEMST                                                  
         JZ    XMULSTA3                                                         
         CLI   X#PTYP,X#PTYPSQ                                                  
         JE    XMULSTA5                                                         
XMULSTA1 TM    X#JDSTAT,X#JDSTRE+X#JDSTMA+X#JDSTSU                              
         JZ    XMULSTA2                                                         
         CLI   X#PTYP,X#PTYPDQ                                                  
         JE    XMULSTA2                                                         
         TM    ACTKSTAT,ACTSDRFT                                                
         JZ    XMULSTAN                                                         
                                                                                
XMULSTA2 TM    X#JDSTAT,X#JDSTAP                                                
         JZ    XMULSTA3                                                         
         CLI   X#PTYP,X#PTYPDQ                                                  
         JE    XMULSTAN                                                         
         TM    ACTKSTAT,ACTSDRFT                                                
         JNZ   XMULSTAN                                                         
         DROP  R2                                                               
                                                                                
XMULSTA3 TM    X#JDSTAT,X#JDSTMA                                                
         JZ    XMULSTA4                                                         
         CLI   X#PTYP,X#PTYPDQ                                                  
         JNE   XMULSTA4                                                         
                                                                                
         USING DRAPASD,R2                                                       
         CLC   DRAPPID,CCTPID      cannot approve your own jobs                 
         JNE   XMULSTA4                                                         
         TM    X#JDSTAT,X#JDSTSU+X#JDSTRE                                       
         JZ    XMULSTAN                                                         
         OI    SAVEIND,SAVEPMA                                                  
         DROP  R2                                                               
                                                                                
         USING ACTRECD,R2                                                       
XMULSTA4 CLI   X#JDSTAT,X#JDSTAP                                                
         JNE   XMULSTAY                                                         
         TM    ACTKSTAT,ACTSDRFT                                                
         JNZ   XMULSTAN                                                         
         J     XMULSTAY                                                         
         DROP  R2                                                               
                                                                                
XMULSTA5 CLI   X#JDSTAT,0          any status?                                  
         JE    XMULSTAY                                                         
         TM    X#JDSTAT,X#JDSTRE+X#JDSTMA+X#JDSTSU                              
         JZ    XMULSTA2            must be approved                             
         TM    X#JDSTAT,X#JDSTAP   mixture?                                     
         JZ    XMULSTA1            no                                           
         DS    0H                  then let through                             
                                                                                
XMULSTAY LHI   R1,1                                                             
         J     XMULSTAX                                                         
XMULSTAN LHI   R1,0                                                             
XMULSTAX DS    0H                                                               
         CHI   R1,1                                                             
         XIT1                                                                   
         LTORG                                                                  
                                                                                
* Check dupe  jobs due to duplicate search passives                             
CHKDUP   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'**CHKDUP'                                                      
                                                                                
         LR    R2,R1                                                            
         L     R3,AIO7                                                          
         AHI   R3,2                                                             
                                                                                
CHKDUPL  CLI   0(R3),0                                                          
         JE    CHKDUPN                                                          
         CLC   0(L'ACTKACT,R3),0(R2)                                            
         JE    CHKDUPY                                                          
         AHI   R3,L'ACTKACT                                                     
         J     CHKDUPL                                                          
                                                                                
CHKDUPY  LHI   R1,1                                                             
         J     CHKDUPX                                                          
CHKDUPN  LHI   R1,0                                                             
CHKDUPX  DS    0H                                                               
         CHI   R1,1                                                             
         XIT1                                                                   
         LTORG                                                                  
                                                                                
* Add to 'check for dupes' table                                                
ADDDUP   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'**ADDDUP'                                                      
                                                                                
         LR    R2,R1                                                            
         L     R3,AIO7                                                          
         LH    R0,0(R3)                                                         
         LTR   R0,R0                                                            
         JP    ADDDUP2                                                          
         LHI   R0,(L'IOAREA7+L'IOAREA8)/L'ACTKACT                               
         STH   R0,0(R3)                                                         
         AHI   R3,2                                                             
         J     ADDDUPA             tabel full - restart                         
                                                                                
ADDDUP2  AHI   R3,2                                                             
                                                                                
ADDDUPL  CLI   0(R3),0                                                          
         JE    ADDDUPA                                                          
         AHI   R3,L'ACTKACT                                                     
         J     ADDDUPL                                                          
                                                                                
ADDDUPA  MVC   0(L'ACTKACT,R3),0(R2)                                            
         AHI   R3,L'ACTKACT                                                     
         MVI   0(R3),0                                                          
         L     R3,AIO7                                                          
         LH    R0,0(R3)                                                         
         SHI   R0,1                                                             
         STH   R0,0(R3)                                                         
                                                                                
ADDDUPX  DS    0H                                                               
         XIT1                                                                   
         LTORG                                                                  
                                                                                
* retrieve, set and download job details (job record in AIO2)                   
* X#COFF contains current office code, see XJOBFLT                              
         USING ACTRECD,R2                                                       
XJOBOUT  NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*XJOBOUT'                                                      
                                                                                
         LA    R0,JD_VALS          clear values                                 
         LHI   R1,JD_LNQ                                                        
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         ZAP   JD_FEE,PZERO        FEES                                         
                                                                                
LAST     USING JD_VALS,R4                                                       
         LA    R4,OLDJDTL                                                       
                                                                                
         L     R2,AIO2             point to SJ job record                       
                                                                                
         L     R0,AIO6             Copy SJ job to AIO6                          
         LA    R1,IOLENQ                                                        
         L     RE,AIO2                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         L     R2,AIO2                                                          
                                                                                
         MVC   JD_F15,ACTRSAF1     pass filters 1 to 5                          
                                                                                
         MVC   JD_CLI,SPACES       extract client code                          
         LLC   RE,PCLILEN                                                       
         SHI   RE,1                                                             
         BASR  R1,0                                                             
         MVC   JD_CLI(0),ACTKACT                                                
         EX    RE,0(R1)                                                         
                                                                                
         LLC   R1,PPROLEN                                                       
         LR    RF,R1                                                            
         LA    RE,L'ACTKACT                                                     
         SR    RE,R1                                                            
         SHI   RE,1                                                             
         LA    R1,ACTKACT(R1)                                                   
         MVC   JD_JOB,SPACES                                                    
         MVC   JD_JOB(0),0(R1)                                                  
         EX    RE,*-6                                                           
                                                                                
         MVC   JD_MED,JD_JOB                                                    
                                                                                
         LLC   R1,PCLILEN                                                       
         SR    RF,R1                                                            
         SHI   RF,1                                                             
         LA    R1,ACTKACT(R1)                                                   
         MVC   JD_PRO,SPACES                                                    
         MVC   JD_PRO(0),0(R1)                                                  
         EX    RF,*-6                                                           
                                                                                
         MVI   JD_JOBL,NOQ                                                      
         TM    ACTKSTAT,ACTSLOCK                                                
         JZ    *+8                                                              
         MVI   JD_JOBL,YESQ                                                     
                                                                                
         CLC   LAST.JD_CLI,JD_CLI  same client?                                 
         JNE   XJOBO02                                                          
***      TM    SAVEIND,SAVEAUR     Aura running?                                
***      JNZ   XJOBO01                                                          
***      MVC   JD_CLN,UNIQUEQ                                                   
***      J     XJOBO06                                                          
                                                                                
XJOBO01  MVC   JD_CLN,LAST.JD_CLN                                               
         J     XJOBO06                                                          
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
XJOBO02  CLC   ELESDCLI,JD_CLI     buffered?                                    
         JE    XJOBO05                                                          
         XC    LAST.JD_PRO,LAST.JD_PRO                                          
         CLI   X#TSAYN,YESQ        TSAR required?                               
         JNE   XJOBO04                                                          
         XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         MVI   TSB.JSBDTYP,JSBDTCQ                                              
         MVC   TSB.JSBDCOD,SPACES                                               
         MVC   TSB.JSBDCOD(L'JD_CLI),JD_CLI                                     
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         JE    XJOBO03                                                          
         TM    TSARERRS,TSERNF     Test record not found                        
         JNZ   XJOBO04                                                          
         DC    H'0'                Other error                                  
                                                                                
XJOBO03  MVC   ELESDCST,TSB.JSBDSTA Save values                                 
         MVC   ELESDCOF,TSB.JSBDOFF                                             
         MVC   ELESDCLN,TSB.JSBDNAM                                             
         MVC   ELESDCXD,TSB.JSBDXDB                                             
         XC    ELESDPRO(ELESPLNQ),ELESDPRO                                      
         MVC   X#HOFF,ELESDCOF                                                  
         MVC   X#POFF,ELESDCOF                                                  
         MVC   JD_CLN,ELESDCLN                                                  
         J     XJOBO08                                                          
         DROP  TSB                                                              
                                                                                
XJOBO04  DS    0H                                                               
         L     R0,AIO1             copy AIO2 into AIO1                          
         LA    R1,IOLENQ                                                        
         L     RE,AIO2                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         GOTOR CASCLI,0            Check and set client                         
         MVC   JD_CLN,ELESDCLN                                                  
         L     R0,AIO2             copy AIO1 into AIO2                          
         LA    R1,IOLENQ                                                        
         L     RE,AIO1                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         J     XJOBO08                                                          
                                                                                
XJOBO05  MVC   JD_CLN,ELESDCLN                                                  
                                                                                
XJOBO06  CLC   LAST.JD_PRO,JD_PRO  same product?                                
         JNE   XJOBO08                                                          
***      TM    SAVEIND,SAVEAUR     Aura running?                                
***      JNZ   XJOBO07                                                          
***      MVC   JD_PRN,UNIQUEQ                                                   
***      J     XJOBO15                                                          
                                                                                
XJOBO07  MVC   JD_PRN,LAST.JD_PRN  pass name not placeholder                    
         J     XJOBO15                                                          
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
XJOBO08  CLC   ELESDPRO,JD_PRO     buffered?                                    
         JE    XJOBO10                                                          
         CLI   X#TSAYN,YESQ        TSAR required?                               
         JNE   XJOBO12                                                          
         XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         MVI   TSB.JSBDTYP,JSBDTCQ                                              
         MVC   TSB.JSBDCOD,SPACES                                               
         LLC   R1,PPROLEN                                                       
         SHI   R1,1                                                             
         MVC   TSB.JSBDCOD(0),ACTKACT                                           
         EX    R1,*-6                                                           
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         JE    XJOBO09                                                          
         TM    TSARERRS,TSERNF     Test record not found                        
         JNZ   XJOBO12                                                          
         DC    H'0'                Other error                                  
                                                                                
XJOBO09  MVC   ELESDPST,TSB.JSBDSTA Save values                                 
         MVC   ELESDPOF,TSB.JSBDOFF                                             
         MVC   ELESDPRN,TSB.JSBDNAM                                             
         MVC   ELESDPXD,TSB.JSBDXDB                                             
         MVC   X#POFF,ELESDPOF                                                  
                                                                                
XJOBO10  MVC   JD_PRN,ELESDPRN                                                  
         J     XJOBO15                                                          
         DROP  TSB                                                              
                                                                                
XJOBO12  DS    0H                                                               
         L     R0,AIO1             copy AIO2 into AIO1                          
         LA    R1,IOLENQ                                                        
         L     RE,AIO2                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         GOTOR CASPRO,0            Check and set product                        
         MVC   JD_PRN,ELESDPRN                                                  
         L     R0,AIO2             copy AIO1 into AIO2                          
         LA    R1,IOLENQ                                                        
         L     RE,AIO1                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
XJOBO15  CLC   LAST.JD_MED,JD_MED  same media code?                             
         JNE   XJOBO20                                                          
***      TM    SAVEIND,SAVEAUR     Aura running?                                
***      JNZ   XJOBO17                                                          
***      MVC   JD_MEN,UNIQUEQ                                                   
***      J     XJOBO26                                                          
                                                                                
XJOBO17  MVC   JD_MEN,LAST.JD_MEN  pass name not placeholder                    
         J     XJOBO26                                                          
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
XJOBO20  XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         MVI   TSB.JSBDTYP,JSBDTMQ                                              
         MVC   TSB.JSBDCOD,SPACES                                               
         MVC   TSB.JSBDCOD(L'JD_MED),JD_MED                                     
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         JE    XJOBO21                                                          
         TM    TSARERRS,TSERNF     Test record not found                        
         JNZ   XJOBO22                                                          
         DC    H'0'                Other error                                  
                                                                                
XJOBO21  MVC   JD_MEN,TSB.JSBDNAM                                               
         MVC   X#MEDGRP,TSB.JSBDMGR                                             
         J     XJOBO26                                                          
                                                                                
         USING PMDRECD,RE                                                       
XJOBO22  LA    RE,IOKEY            read media code record                       
         MVC   PMDKEY,SPACES                                                    
         MVI   PMDKTYP,PMDKTYPQ                                                 
         MVC   PMDKCPY,CUXCPY                                                   
         MVC   PMDKMED,JD_MED                                                   
         MVI   X#HIGH,YESQ                                                      
         MVI   X#MEDGRP,0                                                       
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JNE   XJOBO26                                                          
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JNE   *+2                                                              
                                                                                
         L     RE,AIO3                                                          
         LA    RE,PMDRFST                                                       
         USING PMDELD,RE                                                        
                                                                                
XJOBO23  CLI   PMDEL,PMDELQ                                                     
         JE    XJOBO24                                                          
         CLI   PMDEL,0                                                          
         JE    XJOBO26                                                          
         LLC   R0,PMDLN                                                         
         AR    RE,R0                                                            
         J     XJOBO23                                                          
                                                                                
XJOBO24  MVC   JD_MEN,PMDDESC                                                   
         MVC   X#MEDGRP,PMDGRP                                                  
         DROP  RE                                                               
                                                                                
         XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         LHI   R1,JSBDLNQ                                                       
         STH   R1,TSB.JSBDLEN                                                   
         MVI   TSB.JSBDTYP,JSBDTMQ                                              
         MVC   TSB.JSBDCOD,SPACES                                               
         MVC   TSB.JSBDCOD(L'JD_MED),JD_MED                                     
         MVC   TSB.JSBDNAM,JD_MEN                                               
         MVC   TSB.JSBDOGR,X#MEDGRP                                             
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         JE    XJOBO26                                                          
         TM    TSARERRS,TSERNF     Test record not found                        
         JNZ   XJOBO26                                                          
         DC    H'0'                Other error                                  
         DROP  TSB                                                              
                                                                                
XJOBO26  MVC   JD_OFF,X#COFF       pass office (skip if empty)                  
         CLC   X#COFF,SPACES                                                    
         JH    *+10                                                             
         MVC   JD_OFF,X#POFF                                                    
         CLC   JD_OFF,SPACES                                                    
         JNH   XJOBO35                                                          
***      MVC   JD_OFN,UNIQUEQ                                                   
                                                                                
         CLC   LAST.JD_OFF,JD_OFF                                               
         JNE   XJOBO27                                                          
***      TM    SAVEIND,SAVEAUR     Aura running?                                
***      JZ    XJOBO35                                                          
         MVC   JD_OFN,LAST.JD_OFN  pass name not placeholder                    
         J     XJOBO35                                                          
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
XJOBO27  XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         MVI   TSB.JSBDTYP,JSBDTOQ                                              
         MVC   TSB.JSBDCOD,SPACES                                               
         MVC   TSB.JSBDCOD(L'JD_OFF),JD_OFF                                     
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         JE    XJOBO28                                                          
         TM    TSARERRS,TSERNF     Test record not found                        
         JNZ   XJOBO30                                                          
         DC    H'0'                Other error                                  
                                                                                
XJOBO28  MVC   JD_OFN,TSB.JSBDNAM                                               
         MVC   X#OFFGRP,TSB.JSBDOGR                                             
         J     XJOBO35                                                          
                                                                                
XJOBO30  MVC   TEMP2(2),JD_OFF     get office name via 2D or OFFREC             
         GOTOR (#GETOFN,AGETOFN)                                                
         MVC   JD_OFN,TEMP2                                                     
         MVI   X#HIGH,YESQ                                                      
         MVI   X#OFFGRP,0                                                       
                                                                                
         USING OGRRECD,RE          BUILD KEY OF OFFICE RECORD                   
         LA    RE,IOKEY                                                         
         MVI   X#OFFGRP,0                                                       
         XC    OGRKEY,OGRKEY                                                    
         MVI   OGRKTYP,OGRKTYPQ                                                 
         MVI   OGRKSUB,OGRKOFFQ                                                 
         MVC   OGRKCPY,CUXCPY                                                   
         MVC   OGRKUNT(2),PRODUL                                                
         MVC   OGRKOFC,X#COFF                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JNE   XJOBO33                                                          
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JNE   *+2                                                              
                                                                                
         L     RE,AIO3                                                          
         LA    RE,OGRRFST                                                       
         USING PGRELD,RE                                                        
         XR    R0,R0                                                            
XJOBO31  CLI   PGREL,0                                                          
         JE    XJOBO33                                                          
         CLI   PGREL,PGRELQ                                                     
         JE    XJOBO32                                                          
         IC    R0,PGRLN                                                         
         AR    RE,R0                                                            
         J     XJOBO31                                                          
                                                                                
XJOBO32  MVC   X#OFFGRP,PGRCODE    set office group                             
         DROP  RE                                                               
                                                                                
XJOBO33  XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         LHI   R1,JSBDLNQ                                                       
         STH   R1,TSB.JSBDLEN                                                   
         MVI   TSB.JSBDTYP,JSBDTOQ                                              
         MVC   TSB.JSBDCOD,SPACES                                               
         MVC   TSB.JSBDCOD(L'JD_OFF),JD_OFF                                     
         MVC   TSB.JSBDNAM,JD_OFN                                               
         MVC   TSB.JSBDOGR,X#OFFGRP                                             
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         JE    XJOBO35                                                          
         TM    TSARERRS,TSERNF     Test record not found                        
         JNZ   XJOBO35                                                          
         DC    H'0'                Other error                                  
         DROP  TSB                                                              
                                                                                
         USING GOBLOCKD,R3                                                      
XJOBO35  L     R3,AGOBLOCB                                                      
                                                                                
         XC    GOADM(GOABUFF-GOADM),GOADM                                       
         XC    GOADETS(GOACOVL-GOADETS),GOADETS                                 
                                                                                
         MVC   GOADM,VDATAMGR                                                   
         MVC   GOAEXT,AGOXBLCK                                                  
         MVC   GOABEXT,AGOBBLCK                                                 
         L     RE,ATWA                                                          
         LA    RE,2304+FALINKDL(RE)                                             
         ST    RE,GOABUFF          A(AFTER FALINK BLOCK)                        
         L     RE,=AL4(TWAMAXRL-(FALINKDL+2304))   MAX L'TWA                    
         ST    RE,GOLBUFF                                                       
         TM    LP_FLAG,LP_FOFFL                                                 
         JNZ   XJOB037              OFFLINE                                     
*                                                                               
         MVC   GOABUFF,ATIA         USE TIA ONLINE                              
         MVC   GOLBUFF,=AL4(TWAMAXRL)   SHOULD BE OK, TIA IS 14K?               
*                                                                               
XJOB037  DS    0H                                                               
         MVC   GOSELCUL,ACTKEY                                                  
         MVI   GOSELLEV,0                                                       
         MVC   GOSELCLI,SPACES                                                  
         LLC   RE,PCLILEN                                                       
         SHI   RE,1                                                             
         BASR  R1,0                                                             
         MVC   GOSELCLI(0),JD_CLI                                               
         EX    RE,0(R1)                                                         
         MVC   GOSELPRO,SPACES                                                  
         CLC   JD_PRO,SPACES                                                    
         JNH   XJOB038                                                          
         LLC   RF,PPROLEN                                                       
         LLC   RE,PCLILEN                                                       
         SR    RF,RE                                                            
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   GOSELPRO(0),JD_PRO                                               
         EX    RF,0(RE)                                                         
         CLC   JD_JOB,SPACES                                                    
         JNH   XJOB038                                                          
         MVC   GOSELJOB,SPACES                                                  
         LLC   RF,PJOBLEN                                                       
         LLC   RE,PPROLEN                                                       
         SR    RF,RE                                                            
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   GOSELJOB(0),JD_JOB                                               
         EX    RF,0(RE)                                                         
         MVC   GOSELMED,JD_JOB                                                  
                                                                                
*        MVC   GOACLI,AIO4                                                      
*        MVC   GOAPRO,AIO5                                                      
*        MVC   GOAJOB,AIO6                                                      
*        MVC   GOACOMP,AIO8                                                     
*        MVC   GOALEDG,AIO7                                                     
XJOB038  DS    0H                                                               
*&&UK*&& LA    R1,TEMP             none emulated IOs + skip w/c level +         
*&&UK*&& ST    R1,GOADETS          TEMP+TEMP2 for extra details block           
                                                                                
         GOTOR SETXDB,DMCB,TEMP,0                                               
                                                                                
         OI    GOSPEC3,GOSPNERQ+GOSPSWLQ                                        
*&&UK*&& OI    GOSPEC3,GOSPXDPQ                                                 
***      OI    GOSPEC3,GOSPNERQ+GOSPSWLQ+GOSPXDPQ                               
*&&UK*&& MVC   GOSELOFC,X#COFF                                                  
*&&UK*&& MVC   GOSELOG,X#OFFGRP                                                 
         CLC   JD_MED,SPACES                                                    
         JNH   *+10                                                             
         MVC   GOSELMED,JD_MED                                                  
         CLC   X#MEDGRP,SPACES                                                  
         JNH   *+10                                                             
         MVC   GOSELMG,X#MEDGRP                                                 
                                                                                
         LA    R1,SAVEKEY3         X#HIGH not set as GETOPT will reread         
         ST    R1,GOAKEY                                                        
***      LA    R1,ES_BUFF          GETOPT.PUTVAL8 can corrupt storage           
***      ST    R1,GOAFROM                                                       
                                                                                
         MVC   GOCTRY,CUCTRY                                                    
         L     R1,ACOMFACS                                                      
                                                                                
         XC    GOACOVL,GOACOVL                                                  
         TM    LP_FLAG,LP_FOFFL    TEST OFFLINE                                 
         JZ    XJOBO39                                                          
         MVC   GOACOVL,VCOVAIL                                                  
                                                                                
XJOBO39  MVC   GOABINSR,CBINSRCH-COMFACSD(R1)                                   
                                                                                
         GOTO1 VGETOPT,DMCB,GOBLOCKD                                            
*&&UK                                                                           
         ZAP   JD_AMBR,GOCEAMBR                                                 
         ZAP   JD_RED,GOCERED                                                   
*&&                                                                             
                                                                                
         USING GOBBLKD,RF                                                       
         L     RF,AGOBBLCK         A(NEW BILLING EXTENSION)                     
*&&UK                                                                           
         CLC   GOBILCUR,AGYCURR                                                 
         JE    XJOBO40                                                          
         MVC   JD_CUR,GOBILCUR                                                  
*&&                                                                             
         USING GOXBLKD,RF                                                       
XJOBO40  L     RF,AGOXBLCK                                                      
         MVC   JD_DRFT,GODRFT                                                   
         MVC   JD_ESDR,GOAEDT                                                   
         MVC   JD_AUTO,GOAUTNUM                                                 
*&&US                                                                           
         ZAP   JD_AMBR,GOCEAMBR                                                 
         ZAP   JD_RED,GOCERED                                                   
*&&                                                                             
         DROP  RF,R3                                                            
                                                                                
         USING NAMELD,R3                                                        
         LA    R3,ACTRFST          process job record data                      
         MVI   X#JREJ,NOQ                                                       
         MVI   X#JSRC,0                                                         
         XC    X#JCRE,X#JCRE                                                    
                                                                                
XJOBO45  CLI   NAMEL,0                                                          
         JE    XJOBO75                                                          
         CLI   NAMEL,NAMELQ                                                     
         JE    XJOBO55                                                          
         CLI   NAMEL,ASTELQ                                                     
         JE    XJOBO57                                                          
         CLI   NAMEL,XNMELQ                                                     
         JE    XJOBO60                                                          
         CLI   NAMEL,RSTELQ                                                     
         JE    XJOBO62                                                          
         CLI   NAMEL,JOBELQ                                                     
         JE    XJOBO65                                                          
         CLI   NAMEL,FFTELQ                                                     
         JE    XJOBO69                                                          
         CLI   NAMEL,PACELQ                                                     
         JE    XJOBO70                                                          
         CLI   NAMEL,RACELQ                                                     
         JE    XJOBO71                                                          
         CLI   NAMEL,SPAELQ                                                     
         JE    XJOBO73                                                          
         CLI   NAMEL,SCIELQ                                                     
         JE    XJOBO74                                                          
                                                                                
XJOBO50  LLC   R0,NAMLN                                                         
         AR    R3,R0                                                            
         J     XJOBO45                                                          
                                                                                
XJOBO55  LLC   R1,NAMLN                                                         
         CHI   R1,NAMLN1Q                                                       
         JNH   XJOBO50                                                          
         SHI   R1,NAMLN1Q+1                                                     
         MVC   JD_JON(0),NAMEREC                                                
         EX    R1,*-6                                                           
         J     XJOBO50                                                          
                                                                                
         USING ASTELD,R3                                                        
XJOBO57  MVI   JD_IFU,NOQ                                                       
         TM    ASTSTAT1,ASTISFOR   Is foreign language user                     
         JZ    XJOBO50                                                          
         MVI   JD_IFU,YESQ                                                      
         J     XJOBO50                                                          
                                                                                
         USING XNMELD,R3                                                        
XJOBO60  LLC   R1,XNMLN                                                         
         CHI   R1,XNMLN1Q                                                       
         JNH   XJOBO50                                                          
         SHI   R1,XNMLN1Q+1                                                     
         MVC   JD_JOF(0),XNMSUBN                                                
         EX    R1,*-6                                                           
         J     XJOBO50                                                          
                                                                                
         USING RSTELD,R3                                                        
XJOBO62  MVI   JD_LOCES,NOQ                                                     
         MVI   JD_LOCOR,NOQ                                                     
         MVI   JD_LOCEX,NOQ                                                     
         MVI   JD_LOCBI,NOQ                                                     
         MVI   JD_LOCAD,NOQ                                                     
         MVI   JD_LOCTI,NOQ                                                     
         MVI   JD_BEST,NOQ                                                      
         CLI   RSTLN,RSTLN3Q                                                    
         JL    XJOBO50                                                          
         TM    RSTSTAT6,RSTSMCSE       Brandocean estimates on job?             
         JZ    *+8                                                              
         MVI   JD_BEST,YESQ                                                     
         TM    SAVEIND,SAVEAUR         Aura - merge t/s lock status             
         JZ    XJOBO63                                                          
         TM    RSTSTAT5,RSTSNOTS                                                
         JZ    XJOBO63                                                          
         MVI   JD_LOCTI,YESQ                                                    
                                                                                
XJOBO63  TM    RSTLSTAT,RSTLSESQ       LOCKED FROM ESTIMATES                    
         JZ    *+8                                                              
         MVI   JD_LOCES,YESQ                                                    
         TM    RSTLSTAT,RSTLSORQ       LOCKED FROM ORDERS                       
         JZ    *+8                                                              
         MVI   JD_LOCOR,YESQ                                                    
         TM    RSTLSTAT,RSTLSBIQ       LOCKED FROM BILLING                      
         JZ    *+8                                                              
         MVI   JD_LOCBI,YESQ                                                    
         TM    RSTLSTAT,RSTLSTIQ       LOCKED FROM TIMESHEETS                   
         JZ    *+8                                                              
         MVI   JD_LOCTI,YESQ                                                    
         TM    RSTLSTAT,RSTLSADQ       LOCKED FROM ADJUSTMENTS                  
         JZ    *+8                                                              
         MVI   JD_LOCAD,YESQ                                                    
         TM    RSTLSTAT,RSTLSEXQ       LOCKED FROM EXPENSES                     
         JZ    *+8                                                              
         MVI   JD_LOCEX,YESQ                                                    
         J     XJOBO50                                                          
                                                                                
         USING JOBELD,R3                                                        
XJOBO65  MVC   JD_CDT,JOBCDATE                                                  
         MVC   JD_ODT,JOBADATE                                                  
         MVC   JD_IDN,SPACES                                                    
         MVI   JD_MAST,NOQ                                                      
         TM    JOBSTA2,JOBSMST         JOB IS A MASTER JOB                      
         JZ    *+8                                                              
         MVI   JD_MAST,YESQ                                                     
         CLI   JOBLN,JOBLN2Q                                                    
         JL    XJOBO50                                                          
         XOUT  JOBREVNO,JD_IDN,2                                                
*&&US                                                                           
         MVI   JD_EXJB,NOQ                                                      
         TM    JOBSTA1,JOBSXJOB        JOB IS AN EXPENSE JOB                    
         JZ    *+8                                                              
         MVI   JD_EXJB,YESQ                                                     
*&&                                                                             
         OC    JOBODATE,JOBODATE                                                
         JZ    XJOBO67                                                          
         MVC   JD_ODT,JOBODATE                                                  
                                                                                
XJOBO67  CLI   JOBLN,JOBLN3Q                                                    
         JL    XJOBO50                                                          
         MVC   X#JSRC,JOBSRCES                                                  
         TM    JOBSTA2,JOBSREJ                                                  
         JZ    XJOBO50                                                          
         MVI   X#JREJ,YESQ                                                      
         J     XJOBO50                                                          
                                                                                
         USING FFTELD,R3                                                        
XJOBO69  CLI   FFTTYPE,FFTTCAMP                                                 
         JNE   XJOBO50                                                          
         MVC   JD_CAM,FFTDATA                                                   
         J     XJOBO50                                                          
                                                                                
         USING PACELD,R3                                                        
XJOBO70  OC    JD_LAX,JD_LAX                                                    
         JNZ   XJOBO50                                                          
         CLC   PACDATE,JD_LAD                                                   
         JNH   XJOBO50                                                          
         MVC   JD_LAD,PACDATE                                                   
         MVC   JD_LAC,PACPERS                                                   
         J     XJOBO50                                                          
                                                                                
         USING RACELD,R3                                                        
XJOBO71  LA    RE,JD_APX                                                        
         CLI   RACTYPE,RACTAPP                                                  
         JE    XJOBO72                                                          
         LA    RE,JD_LAX                                                        
         CLI   RACTYPE,RACTCHA                                                  
         JE    XJOBO71A                                                         
         LA    RE,JD_CPX                                                        
         CLI   RACTYPE,RACTADD                                                  
         JNE   XJOBO50                                                          
         MVC   X#JCRE,RACPERS                                                   
         J     XJOBO72                                                          
                                                                                
XJOBO71A CLC   RACDATE,JD_LAD                                                   
         JNH   XJOBO50                                                          
         MVC   JD_LAD,RACDATE                                                   
                                                                                
XJOBO72  MVC   0(2,RE),RACPERS                                                  
         J     XJOBO50                                                          
*                                                                               
         USING SPAELD,R3                                                        
XJOBO73  CLI   SPATYPE,SPATMJOB    master job element                           
         JNE   XJOBO50                                                          
         MVC   JD_MACC,SPAAULA                                                  
         J     XJOBO50                                                          
*                                                                               
         USING SCIELD,R3                                                        
XJOBO74  CLI   SCITYPE,SCITFEEB    FEES/BUDGETS                                 
         JNE   XJOBO74A                                                         
         ZAP   JD_FEE,SCIAMNT                                                   
         J     XJOBO50                                                          
*                                                                               
XJOBO74A CLI   SCITYPE,SCITCPAT    Payment total amount                         
         JNE   XJOBO50                                                          
         CLI   RQ_JDPAY,YESQ                                                    
         JNE   XJOBO50                                                          
         ZAP   JD_PAYTA,SCIAMNT                                                 
         J     XJOBO50                                                          
*                                                                               
XJOBO75  MVC   JD_STA,=C'**A  N'   job status                                   
         TM    ACTRSTA,ACTSCLOS                                                 
         JZ    *+8                                                              
         MVI   JD_STA+0,C'C'                                                    
         TM    ACTRSTA,ACTSLOCK                                                 
         JZ    *+8                                                              
         MVI   JD_STA+1,C'L'                                                    
         TM    ACTRSTA,ACTSDRFT                                                 
         JZ    *+8                                                              
         MVI   JD_STA+2,C'D'       (draft)                                      
         CLI   X#JREJ,YESQ                                                      
         JNE   *+8                                                              
         MVI   JD_STA+2,C'R'       (or rejected)                                
         XOUT  X#JSRC,JD_STA+3,1   xout job source                              
                                                                                
XJOBO80  TM    ACTRSTA,ACTSDRFT                                                 
         JZ    XJOBO82                                                          
         MVC   X#MEDC,JD_MED                                                    
         TM    X#GAPIND,X#GAPIDQ   done already?                                
         JZ    XJOBO81                                                          
         TM    X#GAPIND,X#GAPIYQ   good return?                                 
         JZ    XJOBO82                                                          
         MVI   JD_STA+5,YESQ                                                    
         J     XJOBO82                                                          
                                                                                
XJOBO81  GOTOR GETAPP,DMCB,(2,ACTKACT),JD_OFF                                   
         JNE   XJOBO82                                                          
         MVI   JD_STA+5,YESQ                                                    
                                                                                
XJOBO82  OC    JD_CAM,JD_CAM                                                    
         JZ    XJOBO88                                                          
         CLC   LAST.JD_CAM,JD_CAM                                               
         JNE   XJOBO86                                                          
***      TM    SAVEIND,SAVEAUR     Aura running?                                
***      JNZ   XJOBO84                                                          
***      MVC   JD_CNA,UNIQUEQ                                                   
***      J     XJOBO88                                                          
                                                                                
XJOBO84  MVC   JD_CNA,LAST.JD_CNA  pass name not placeholder                    
         J     XJOBO88                                                          
                                                                                
XJOBO86  GOTOR GETCAM,JD_CAM                                                    
         MVC   JD_CNA,TEMP2                                                     
         MVI   X#HIGH,YESQ                                                      
                                                                                
XJOBO88  TM    SAVEIND,SAVEAUR     Aura user field filter call?                 
         JNZ   XJOBO91             (if required for Aura needs XJOBF20          
         DS    0H                   checks as saving empty ones, too)           
                                                                                
         LA    R3,JD_UF1           finally pass user fields                     
         LA    R4,X#UFLS                                                        
         LA    R2,X#UFCMQ                                                       
                                                                                
XJOBO89  CLC   0(L'X#UFLS,R4),SPACES                                            
         JNH   XJOBO90                                                          
                                                                                
         MVC   0(L'JD_UF1,R3),0(R4)                                             
                                                                                
XJOBO90  AHI   R4,L'X#UFLS                                                      
         AHI   R3,L'JD_UF1                                                      
         JCT   R2,XJOBO89                                                       
         J     XJOBO92                                                          
                                                                                
XJOBO91  CLI   X#UFLDH1,0          any Aura user field filters?                 
         JE    XJOBO92                                                          
         LA    R2,X#UFLDH1                                                      
         LA    R3,X#UFRET1                                                      
         LA    R4,JD_AUFH1                                                      
         LHI   R0,RQ_JDUMX                                                      
                                                                                
XJOBO91A CLI   0(R2),0             active/required entry?                       
         JE    XJOBO91B                                                         
                                                                                
         LLC   R1,0(R3)            in which BLOCK slot is the data?             
         MHI   R1,L'UFSDESC                                                     
         L     RE,ABLOCK                                                        
         AR    R1,RE               pass down data                               
         MVC   0(L'JD_AUFH1,R4),0(R1)                                           
                                                                                
         LLC   R1,0(R3)            in which X#UFLS is the data?                 
         MHI   R1,L'X#UFLS                                                      
         LA    R1,X#UFLS(R1)       pass down data                               
         MVC   L'JD_AUFH1(L'JD_AUFD1,R4),0(R1)                                  
                                                                                
XJOBO91B AHI   R2,X#UFLDH2-X#UFLDH1                                             
         AHI   R3,X#UFRET2-X#UFRET1                                             
         AHI   R4,JD_AUFH2-JD_AUFH1                                             
         JCT   R0,XJOBO91A                                                      
                                                                                
XJOBO92  CLC   LAST.JD_CPX,JD_CPX  same creator?                                
         JNE   XJOBO94                                                          
         OC    JD_CPX,JD_CPX                                                    
         JZ    XJOBO96                                                          
***      TM    SAVEIND,SAVEAUR     Aura running?                                
***      JNZ   XJOBO93                                                          
***      MVC   JD_CPC,UNIQUEQ                                                   
***      MVC   JD_CPF,UNIQUEQ                                                   
***      MVC   JD_CPL,UNIQUEQ                                                   
***      MVC   JD_CPM,UNIQUEQ                                                   
***      J     XJOBO96                                                          
                                                                                
XJOBO93  MVC   JD_CPC,LAST.JD_CPC                                               
         MVC   JD_CPF,LAST.JD_CPF                                               
         MVC   JD_CPL,LAST.JD_CPL                                               
         MVC   JD_CPM,LAST.JD_CPM                                               
         J     XJOBO96                                                          
                                                                                
XJOBO94  GOTOR SOGPER,JD_CPX       Set or get person details                    
                                                                                
XJOBO96  CLC   LAST.JD_APX,JD_APX  same approver?                               
         JNE   XJOBO98                                                          
         OC    JD_APX,JD_APX                                                    
         JZ    XJOBO98A                                                         
***      TM    SAVEIND,SAVEAUR     Aura running?                                
***      JNZ   XJOBO97                                                          
***      MVC   JD_APC,UNIQUEQ                                                   
***      MVC   JD_APF,UNIQUEQ                                                   
***      MVC   JD_APL,UNIQUEQ                                                   
***      MVC   JD_APM,UNIQUEQ                                                   
***      J     XJOBO98A                                                         
                                                                                
XJOBO97  MVC   JD_APC,LAST.JD_APC                                               
         MVC   JD_APF,LAST.JD_APF                                               
         MVC   JD_APL,LAST.JD_APL                                               
         MVC   JD_APM,LAST.JD_APM                                               
         J     XJOBO98A                                                         
                                                                                
XJOBO98  GOTOR SOGPER,JD_APX       Set or get person details                    
                                                                                
XJOBO98A OC    JD_LAX,JD_LAX                                                    
         JNZ   XJOBO98D                                                         
         CLC   JD_LAC,SPACES                                                    
         JNH   XJOBO99                                                          
         CLC   JD_LAC,LAST.JD_LAC                                               
         JNE   XJOBO98C                                                         
***      TM    SAVEIND,SAVEAUR     Aura running?                                
***      JNZ   XJOBO98B                                                         
***      MVC   JD_LAF,UNIQUEQ                                                   
***      MVC   JD_LAL,UNIQUEQ                                                   
***      MVC   JD_LAM,UNIQUEQ                                                   
***      J     XJOBO99                                                          
                                                                                
XJOBO98B MVC   JD_LAF,LAST.JD_LAF                                               
         MVC   JD_LAL,LAST.JD_LAL                                               
         MVC   JD_LAM,LAST.JD_LAM                                               
         J     XJOBO99                                                          
                                                                                
XJOBO98C GOTOR SOGPCO,JD_LAX       Set or get person details from code          
         J     XJOBO99                                                          
                                                                                
XJOBO98D CLC   JD_LAX,LAST.JD_LAX                                               
         JNE   XJOBO98E                                                         
         MVC   JD_LAC,LAST.JD_LAC                                               
         MVC   JD_LAF,LAST.JD_LAF                                               
         MVC   JD_LAL,LAST.JD_LAL                                               
         MVC   JD_LAM,LAST.JD_LAM                                               
         J     XJOBO99                                                          
                                                                                
XJOBO98E GOTOR SOGPER,JD_LAX       Set or get person details                    
                                                                                
XJOBO99  DS    0H                                                               
         GOTOR ESTPCC,0                                                         
                                                                                
         LA    R0,OLDJDTL          save current values for next time            
         LA    R1,JD_LNQ                                                        
         LA    RE,JD_VALS                                                       
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         XIT1                                                                   
         LTORG                                                                  
         DROP  R2,R3                                                            
         DROP  LAST                                                             
                                                                                
***********************************************************************         
* Set or get person details via hex PID                               *         
***********************************************************************         
                                                                                
SOGPER   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*SOGPER*'                                                      
                                                                                
         USING JD_CPX,R2                                                        
         LR    R2,R1                                                            
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
         XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         MVI   TSB.JSBDTYP,JSBDTXQ                                              
         MVC   TSB.JSBDCOD(L'JD_CPX),JD_CPX                                     
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         JE    SOGPER2                                                          
         TM    TSARERRS,TSERNF     Test record not found                        
         JNZ   SOGPER4                                                          
         DC    H'0'                Other error                                  
                                                                                
SOGPER2  MVC   JD_CPC,TSB.JSBDPID                                               
         MVC   JD_CPF,TSB.JSBDPFN                                               
         MVC   JD_CPL,TSB.JSBDPMN                                               
         MVC   JD_CPM,TSB.JSBDPLN                                               
         J     SOGPERX                                                          
                                                                                
SOGPER4  MVI   X#HIGH,YESQ                                                      
         MVC   TEMP2(2),JD_CPX                                                  
         GOTOR (#GETPID,AGETPID)                                                
         JNE   SOGPER6                                                          
         MVC   JD_CPC,TEMP2                                                     
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   SOGPER6                                                          
         MVC   JD_CPF,TEMP2                                                     
         MVC   JD_CPL,WORK2                                                     
         MVC   JD_CPM,TEMP2+32                                                  
                                                                                
SOGPER6  XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         LHI   R1,JSBDLNQ                                                       
         STH   R1,TSB.JSBDLEN                                                   
         MVI   TSB.JSBDTYP,JSBDTXQ                                              
         MVC   TSB.JSBDCOD(L'JD_CPX),JD_CPX                                     
         MVC   TSB.JSBDPID,JD_CPC                                               
         MVC   TSB.JSBDPFN,JD_CPF                                               
         MVC   TSB.JSBDPMN,JD_CPL                                               
         MVC   TSB.JSBDPLN,JD_CPM                                               
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         JE    SOGPERX                                                          
         TM    TSARERRS,TSERNF     Test record not found                        
         JNZ   SOGPERX                                                          
         DC    H'0'                Other error                                  
                                                                                
SOGPERX  XIT1                                                                   
         LTORG                                                                  
         DROP  TSB,R2                                                           
                                                                                
***********************************************************************         
* Set or get person details via person character code                 *         
***********************************************************************         
                                                                                
SOGPCO   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*SOGPCO*'                                                      
                                                                                
         USING JD_CPX,R2                                                        
         LR    R2,R1                                                            
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
         XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         MVI   TSB.JSBDTYP,JSBDTSQ                                              
         MVC   TSB.JSBDCOD(L'JD_CPC),JD_CPC                                     
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         JE    SOGPCO2                                                          
         TM    TSARERRS,TSERNF     Test record not found                        
         JNZ   SOGPCO4                                                          
         DC    H'0'                Other error                                  
                                                                                
SOGPCO2  MVC   JD_CPX,TSB.JSBDPIX                                               
         MVC   JD_CPF,TSB.JSBDPFN                                               
         MVC   JD_CPL,TSB.JSBDPMN                                               
         MVC   JD_CPM,TSB.JSBDPLN                                               
         J     SOGPCOX                                                          
                                                                                
SOGPCO4  MVI   X#HIGH,YESQ                                                      
         MVC   TEMP2(8),JD_CPC                                                  
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   SOGPCO6                                                          
         MVC   JD_CPF,TEMP2                                                     
         MVC   JD_CPL,WORK2                                                     
         MVC   JD_CPM,TEMP2+32                                                  
                                                                                
SOGPCO6  XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         LHI   R1,JSBDLNQ                                                       
         STH   R1,TSB.JSBDLEN                                                   
         MVI   TSB.JSBDTYP,JSBDTSQ                                              
         MVC   TSB.JSBDCOD(L'JD_CPC),JD_CPC                                     
         MVC   TSB.JSBDPIX,JD_CPX                                               
         MVC   TSB.JSBDPFN,JD_CPF                                               
         MVC   TSB.JSBDPMN,JD_CPL                                               
         MVC   TSB.JSBDPLN,JD_CPM                                               
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         JE    SOGPCOX                                                          
         TM    TSARERRS,TSERNF     Test record not found                        
         JNZ   SOGPCOX                                                          
         DC    H'0'                Other error                                  
                                                                                
SOGPCOX  XIT1                                                                   
         LTORG                                                                  
         DROP  TSB,R2                                                           
                                                                                
***********************************************************************         
* Set extra details block for GETOPT                                  *         
***********************************************************************         
                                                                                
SETXDB   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*SETXDB*'                                                      
                                                                                
         L     R2,0(R1)                                                         
         L     R3,4(R1)                                                         
         LTR   R3,R3               single record passed - else full set         
         JZ    SETXDB00                                                         
         XC    0(GOXDBCLQ,R2),0(R2)                                             
         LHI   R0,4                                                             
         J     SETXDB04                                                         
                                                                                
         USING GOXDBD,R2                                                        
SETXDB00 XC    0(GOXDBLNQ,R2),0(R2)                                             
                                                                                
         MVC   GOXDBAS1,SCPYEL+CPYSTAT1-CPYELD                                  
         MVC   GOXDBAS4,SCPYEL+CPYSTAT4-CPYELD                                  
         MVC   GOXDBL1L,PCLILEN                                                 
         MVC   GOXDBL2L,PPROLEN                                                 
         MVC   GOXDBL3L,PJOBLEN                                                 
         MVC   GOXDBCBT(GOXDBCLQ),ELESDCXD                                      
         MVC   GOXDBPBT(GOXDBCLQ),ELESDPXD                                      
         LA    R2,GOXDBJBT                                                      
         LHI   R0,3                                                             
         J     SETXDB02                                                         
                                                                                
         LA    R2,GOXDBCBT                                                      
         DROP  R2                                                               
         LHI   R0,1                                                             
                                                                                
         USING GOXDBCBT,R2                                                      
SETXDB02 L     R3,AIO4             Client                                       
         CHI   R0,1                                                             
         JE    SETXDB04                                                         
         L     R3,AIO5             Product                                      
         CHI   R0,2                                                             
         JE    SETXDB04                                                         
         L     R3,AIO6             Job                                          
         CHI   R0,3                                                             
         JNE   *+2                                                              
                                                                                
         USING ACTRECD,R3                                                       
         USING PPRELD,R4                                                        
SETXDB04 LA    R4,ACTRFST                                                       
                                                                                
SETXDB06 CLI   PPREL,PPRELQ                                                     
         JE    SETXDB10                                                         
         CLI   PPREL,XPRELQ                                                     
         JE    SETXDB20                                                         
         CLI   PPREL,PRUELQ                                                     
         JE    SETXDB30                                                         
         CLI   PPREL,XXPELQ                                                     
         JE    SETXDB40                                                         
         CLI   PPREL,SCMELQ                                                     
         JE    SETXDB50                                                         
         CLI   PPREL,0                                                          
         JE    SETXDB60                                                         
                                                                                
SETXDB08 LLC   R1,PPRLN                                                         
         AR    R4,R1                                                            
         J     SETXDB06                                                         
                                                                                
SETXDB10 MVC   GOXDBCBT,PPRBTYPE                                                
         MVC   GOXDBCSA,PPRBLAMT                                                
         MVC   GOXDBCUW,PPRUWRK                                                 
         J     SETXDB08                                                         
                                                                                
         USING XPRELD,R4                                                        
SETXDB20 MVC   GOXDBCDU,XPRDUE                                                  
         MVC   GOXDBCPO,XPROVER                                                 
         MVC   GOXDBCPL,XPRLOW                                                  
         MVC   GOXDBCSU,XPRSUM                                                  
         MVC   GOXDBCNT,XPRNET                                                  
         MVC   GOXDBCDT,XPRDET                                                  
         MVC   GOXDBCDE,XPREDET                                                 
         MVC   GOXDBCCD,XPRCD                                                   
         CLI   XPRLN,XPRLN2Q                                                    
         JL    SETXDB08                                                         
         MVC   GOXDBCES,XPREST                                                  
         MVC   GOXDBCS1,XPRSTAT1                                                
         MVC   GOXDBCS2,XPRSTAT2                                                
         MVC   GOXDBCRE,XPRREP                                                  
         MVC   GOXDBCNB,XPRBILL                                                 
         MVC   GOXDBCIW,XPRINTC                                                 
         J     SETXDB08                                                         
                                                                                
         USING PRUELD,R4                                                        
SETXDB30 MVC   GOXDBCMD,PRUMED                                                  
         MVC   GOXDBCWR,PRUWORK                                                 
         MVC   GOXDBCCR,PRUCOMM                                                 
         MVC   GOXDBCST,PRUSTAT                                                 
         MVC   GOXDBCTX,PRUTAX                                                  
         J     SETXDB08                                                         
                                                                                
         USING XXPELD,R4                                                        
SETXDB40 MVC   GOXDBCDS,XXPDSCHM                                                
         J     SETXDB08                                                         
                                                                                
         USING SCMELD,R4                                                        
SETXDB50 TM    SCMTYPE,SCMTPRBI                                                 
         JZ    SETXDB08                                                         
         MVC   GOXDBCSC,SPACES                                                  
         LLC   RE,SCMLN                                                         
         SHI   RE,SCMLN1Q+1                                                     
         JM    *+2                                                              
         MVC   GOXDBCSC(0),SCMCODE                                              
         EX    RE,*-6                                                           
         J     SETXDB08                                                         
                                                                                
SETXDB60 AHI   R0,1                next record into next block                  
         AHI   R2,GOXDBCLQ                                                      
         CHI   R0,3                                                             
         JNH   SETXDB02                                                         
         DROP  R2,R3,R4                                                         
                                                                                
SETXDBX  XIT1                                                                   
         LTORG                                                                  
                                                                                
***********************************************************************         
* Check you can close job                                             *         
***********************************************************************         
         SPACE 1                                                                
CHKACT   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*CHKACT*'                                                      
         L     R4,AIO2                                                          
         USING ACTRECD,R4                                                       
         CLC   PRODUL,ACTKULA                                                   
         JNE   CHKACTX                                                          
         MVI   JD_CCLSE,YESQ                                                    
         MVI   JD_CDELT,YESQ                                                    
***                                                                             
         TM    SAVEIND,SAVEAUR     Temporarily taken out for efficiency         
         JNZ   CHKACTX             (see level comments) under AURA              
***                                                                             
         MVI   X#HIGH,YESQ                                                      
         LA    R2,IOKEY            Read for time passives                       
         USING TSJPASD,R2                                                       
         XC    TSJPAS,TSJPAS                                                    
         MVC   TSJPCPY,CUXCPY                                                   
         MVI   TSJPTYP,TSJPTYPQ                                                 
         MVI   TSJPSUB,TSJPSUBQ                                                 
         MVI   TSJPVIEW,TSJPSJAQ                                                
         MVC   TSJPCOFF,X#POFF                                                  
         MVC   TSJPACT,ACTKACT                                                  
         LLC   RE,PPROLEN                                                       
         LA    R1,ACTKACT                                                       
         AR    R1,RE                                                            
         MVC   TSJPMED,0(R1)                                                    
         MVC   CSVKEY1,IOKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         J     CHKACT04                                                         
*                                                                               
CHKACT02 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
*                                                                               
CHKACT04 CLC   TSJPAS(TSJPPEDT-TSJPAS),CSVKEY1                                  
         JNE   CHKACT06                                                         
         TM    TSJPSTAT,TIMSDELT   Is time deleted                              
         JNZ   CHKACT02            Yes - ignore this                            
         MVI   JD_CDELT,NOQ                                                     
         TM    TSJPSTAT,TIMSFAPP   Is time fully approved                       
         JNZ   CHKACT02            Yes - ignore this                            
         MVI   JD_CCLSE,NOQ                                                     
         J     CHKACTX                                                          
*                                                                               
         USING OSJPASD,R2                                                       
CHKACT06 LA    R2,IOKEY            Read for unapproved orders                   
         XC    IOKEY,IOKEY                                                      
         MVC   OSJPCPY,CUXCPY                                                   
         MVI   OSJPTYP,OSJPTYPQ                                                 
         MVI   OSJPSUB,OSJPSUBQ                                                 
         MVC   OSJPACT,ACTKACT                                                  
         MVC   CSVKEY1,IOKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         J     CHKACT10                                                         
*                                                                               
CHKACT08 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
*                                                                               
CHKACT10 CLC   OSJPAS(OSJPMEM-OSJPAS),CSVKEY1                                   
         JNE   CHKACT12                                                         
         TM    OSJPSTAT,ORDSDEL+ORDSFMCH+ORDSLDEL+ORDCLOSE+ORDGDRCV             
*&&US*&& TM    OSJPSTAT,ORDSDEL+ORDSFMCH+ORDSLDEL+ORDCLOSE                      
         JNZ   CHKACT08            Get next record                              
         MVI   JD_CDELT,NOQ                                                     
         TM    OSJPSTA2,ORDSAPPR   Is it fully approved                         
         JNZ   CHKACT08            Ignore this                                  
         MVI   JD_CCLSE,NOQ                                                     
         J     CHKACTX                                                          
                                                                                
         USING EXJPASD,R2                                                       
CHKACT12 LA    R2,IOKEY            Read for unapproved expense claims           
         XC    IOKEY,IOKEY                                                      
         MVC   EXJPCPY,CUXCPY                                                   
         MVI   EXJPTYP,EXJPTYPQ                                                 
         MVI   EXJPSUB,EXJPSUBQ                                                 
         MVI   EXJPVIEW,EXJPCLI1                                                
         TM    CPXSTAT6,CPX2LAEI   WPP workflow                                 
         JZ    *+8                 No                                           
         MVI   EXJPVIEW,EXJPCBL1                                                
         MVC   EXJPCOFF,JD_OFF                                                  
         MVC   EXJPCPJ,ACTKACT                                                  
         MVC   CSVKEY1,IOKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         J     CHKACT16                                                         
*                                                                               
CHKACT14 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
*                                                                               
CHKACT16 CLC   EXJPAS(EXJPMED-EXJPAS),CSVKEY1                                   
         JNE   CHKACT18                                                         
         TM    EXJPSTAT,EXCSDELT+EXCSLOGD Is expense claim deleted              
         JNZ   CHKACT14            Yes - Get next record                        
         MVI   JD_CDELT,NOQ                                                     
         TM    EXJPSTAT,EXCSCOMP                                                
         JNZ   CHKACT14                                                         
         MVI   JD_CCLSE,NOQ                                                     
         J     CHKACTX                                                          
                                                                                
CHKACT18 TM    CPXSTAT6,CPX2LAEI   WPP workflow                                 
         JZ    CHKACT34            No                                           
         MVC   IOKEY,CSVKEY1                                                    
         MVI   EXJPVIEW,EXJPCNB1                                                
         MVC   CSVKEY1,IOKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         J     CHKACT22                                                         
*                                                                               
CHKACT20 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
*                                                                               
CHKACT22 CLC   EXJPAS(EXJPMED-EXJPAS),CSVKEY1                                   
         JNE   CHKACT34                                                         
         TM    EXJPSTAT,EXCSDELT+EXCSLOGD Is expense claim deleted              
         JNZ   CHKACT20            Yes - Get next record                        
         MVI   JD_CDELT,NOQ                                                     
         TM    EXJPSTAT,EXCSCOMP                                                
         JNZ   CHKACT20                                                         
         MVI   JD_CCLSE,NOQ                                                     
         J     CHKACTX                                                          
                                                                                
CHKACT34 GOTO1 VHELLO,DMCB,(C'G',ACCMST),('ABLELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,12(R1)                                                        
         USING ABLELD,R2                                                        
         CP    ABLCR,ABLDR         Does account balance                         
         JE    CHKACT36            Yes                                          
         MVI   JD_CCLSE,NOQ                                                     
         MVI   JD_CDELT,NOQ                                                     
         J     CHKACTX                                                          
*                                                                               
CHKACT36 GOTO1 VHELLO,DMCB,(C'G',ACCMST),('ASTELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   CHKACT40                                                         
         L     R2,12(R1)                                                        
         USING ASTELD,R2                                                        
         OC    ASTDRAFT,ASTDRAFT                                                
         JZ    CHKACT40                                                         
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('JCBELQ',ACTRECD),0                   
         CLI   12(R1),0                                                         
         JNE   CHKACT38                                                         
         L     R3,12(R1)                                                        
         USING JCBELD,R3                                                        
         SR    RF,RF                                                            
         ICM   RF,7,ASTDRAFT       SET RF=#DRAFT TRANSACTIONS                   
         SR    R1,R1               SET R6=#ADVANCE BILLS                        
         ICM   R1,3,JCBADV                                                      
         CR    RF,R1                                                            
         JNH   CHKACT40            ALL DRAFTS ARE ADVANCES                      
CHKACT38 MVI   JD_CCLSE,NOQ                                                     
         J     CHKACTX                                                          
*                                                                               
         USING TRNRECD,R2                                                       
CHKACT40 LA    R2,IOKEY                                                         
         MVC   TRNKEY,ACTKEY                                                    
         MVC   CSVKEY1,IOKEY                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         J     CHKACT44                                                         
*                                                                               
CHKACT42 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
         LA    R2,IOKEY                                                         
*                                                                               
CHKACT44 CLC   TRNKEY(TRNKWORK-TRNKEY),CSVKEY1                                  
         JNE   CHKACTX             End of transactions                          
         CLC   TRNKCULC,SPACES                                                  
         JNH   CHKACT42                                                         
         CLC   TRNKDATE,SPACES                                                  
         JNH   CHKACT42                                                         
         CLC   TRNKREF,SPACES                                                   
         JNH   CHKACT42                                                         
         MVI   JD_CDELT,NOQ                                                     
*&&UK                                                                           
         CLC   TRNKWORK,=C'99'                                                  
         JE    CHKACT42                                                         
*&&                                                                             
         LHI   R1,IOGET+IOMST+IO3                                               
         TM    TRNKSTAT,TRNSARCH                                                
         JZ    *+8                                                              
         LHI   R1,IOGET+IOARC+IO3                                               
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO3                                                          
         L     R3,AIO1                                                          
         USING PRORATAD,R3                                                      
         XC    PG$GEN(PA$VALS-PG$GEN),PG$GEN                                    
         GOTO1 VPRORATA,DMCB,(X'00',TRNRECD),0,ACOMFACS,0,PRORATAD,0            
         CLC   TRNKWORK,=C'**'                                                  
         JNE   CHKACT52                                                         
         TM    SCPYEL+CPYSTAT7-CPYELD,CPYSNCOB                                  
         JNZ   CHKACT48                                                         
                                                                                
* Check the status first because a zero amount could be fully billed            
                                                                                
         TM    PG$STAT,PG$FULLB    Test order is fully billed                   
         JNZ   CHKACT42                                                         
         CP    PA$NET,=P'0'        Zero amount can't be fully billed            
         JE    CHKACT48                                                         
         DROP  R3                                                               
*                                                                               
         LA    RE,TRNRFST                                                       
         USING PTAELD,RE           Test if order is billed - that's ok          
CHKACT46 LLC   R0,1(RE)                                                         
         AR    RE,R0                                                            
         CLI   0(RE),0                                                          
         JE    CHKACT48            No billing on this order                     
         CLI   0(RE),PTAELQ                                                     
         JNE   CHKACT46                                                         
         CLI   PTATYPE,PTATRAL                                                  
         JNE   CHKACT46                                                         
         TM    PTASTAT1,PTASPEND                                                
         JNZ   CHKACT42                                                         
*                                                                               
CHKACT48 MVC   CSVKEY2,TRNKEY                                                   
*                                                                               
NEW      USING ORDRECD,R3                                                       
         LA    R3,IOKEY                                                         
         XC    NEW.ORDKEY,NEW.ORDKEY                                            
         MVI   NEW.ORDKTYP,ORDKTYPQ                                             
         MVC   NEW.ORDKCPY,CUXCPY                                               
         MVC   NEW.ORDKORD,TRNKREF                                              
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JE    CHKACT50                                                         
         MVC   IOKEY,CSVKEY2                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         J     CHKACT42                                                         
         DROP  NEW                                                              
*                                                                               
CHKACT50 MVI   JD_CCLSE,NOQ                                                     
         J     CHKACTX                                                          
*                                                                               
CHKACT52 L     R3,AGOBLOCB                                                      
         USING GOBLOCKD,R3                                                      
         CLI   GOBILTYP,C'C'         Is this client billing?                    
         JE    CHKACT56              Yes, use different logic                   
                                                                                
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('TRNELQ',TRNRECD),0                   
         CLI   12(R1),0                                                         
         JNE   CHKACT42                                                         
         L     R3,12(R1)                                                        
         USING TRNELD,R3                                                        
         TM    TRNSTAT,TRNSHOLD                                                 
         JNO   *+12                                                             
         MVI   JD_CCLSE,NOQ                                                     
         J     CHKACTX                                                          
                                                                                
         GOTO1 VHELLO,DMCB,(C'G',ACCMST),('TRSELQ',TRNRECD),0                   
         CLI   12(R1),0                                                         
         JE    *+6                                                              
         DC    H'0'                                                             
         L     R3,12(R1)                                                        
         USING TRSELD,R3                                                        
         OC    TRSUDAT,TRSUDAT       No, is it billed ?                         
         JNZ   CHKACT42              Yes                                        
*                                                                               
         TM    TRNRSTAT,X'20'        Is it a reversal ?                         
         JO    CHKACT42              Yes - skip transactions                    
*                                                                               
         CLC   TRNKULC(2),=C'SK'     Is the contra SK                           
         JNE   CHKACT54              No                                         
         MVI   JD_CCLSE,NOQ                                                     
         J     CHKACTX                                                          
CHKACT54 GOTO1 VHELLO,DMCB,(C'G',ACCMST),('SPDELQ',TRNRECD),0                   
         CLI   12(R1),0                                                         
         JNE   CHKACT42                                                         
         L     R3,12(R1)                                                        
         USING SPDELD,R3                                                        
         CLC   SPDACCS(2),=C'SK'                                                
         JNE   CHKACT42                                                         
         MVI   JD_CCLSE,NOQ                                                     
         J     CHKACTX                                                          
*                                                                               
CHKACT56 LA    R3,TRNRFST                                                       
         USING BNDELD,R3                                                        
         ZAP   AC_AMT,=P'0'                                                     
         LR    R4,R3                                                            
CHKACT58 LLC   R0,BNDLN                                                         
         AR    R3,R0                                                            
         CLI   0(R3),0                                                          
         JE    CHKACT62            No billing on this order                     
         CLI   0(R3),TRNELQ                                                     
         JNE   CHKACT60                                                         
         LR    R4,R3                                                            
CHKACT60 CLI   0(R3),BNDELQ                                                     
         JNE   CHKACT58                                                         
*                                                                               
         CLC   BNDBNO,SPACES       Is this billed ?                             
         JNH   CHKACT58            No, get next                                 
         ICM   RF,15,BNDAMNT                                                    
         CVD   RF,DUB                                                           
         AP    AC_AMT,DUB                                                       
         J     CHKACT58                                                         
*                                                                               
         USING TRNELD,R4                                                        
CHKACT62 CP    AC_AMT,TRNAMNT                                                   
         JNE   CHKACT64                                                         
*                                                                               
         L     R6,AIO1                                                          
         USING PRORATAD,R6                                                      
         TM    PG$STAT3,PG$FULUT   FULLY UTILIZED?                              
         JO    CHKACT42            YES                                          
         TM    TRNSTAT,X'20'         NO, IS IT A REVERSAL ?                     
         JO    CHKACT42              YES, SKIP IT                               
*                                                                               
CHKACT64 MVI   JD_CCLSE,NOQ                                                     
CHKACTX  XIT1                                                                   
                                                                                
         DROP  R2,R3,R4,R6                                                      
         LTORG                                                                  
                                                                                
* Check SJ code (at R1) against approval list of user                           
* Note: no distinction between SJ defaults or regular approver list             
*       entries, also no GAPLST like checking - only matching this              
*       list here                                                               
CHKJAL   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*CHKJAL*'                                                      
                                                                                
         XC    X#JAPP,X#JAPP       Init Approver Pid                            
         MVC   CSVKEY2,IOKEY                                                    
         USING DRAPASD,R2                                                       
         LA    R2,CSVKEY2                                                       
         LLC   R1,PPROLEN                                                       
         LA    RF,DRAPACT(R1)                                                   
         MVC   X#MEDC,0(RF)                                                     
         OI    X#GAPIND,X#GAPIDQ                                                
         GOTOR GETAPP,DMCB,(2,DRAPACT),DRAPSOFF                                 
         JNE   CHKJALN                                                          
         OI    X#GAPIND,X#GAPIYQ                                                
                                                                                
         MVC   IOKEY,CSVKEY2                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
                                                                                
CHKJALY  CR    RB,RB                                                            
         XIT1                                                                   
CHKJALN  MVC   IOKEY,CSVKEY2                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         LTR   RB,RB                                                            
         XIT1                                                                   
         DROP  R2                                                               
         LTORG                                                                  
                                                                                
* Check for Client requested, if not check for client change, if so             
* set client details and carry on                                               
CASCLI   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*CASCLI*'                                                      
                                                                                
         LTR   R1,R1               XJOBOUT special call to get client           
         JNZ   CASCLI00                                                         
         MVC   X#ACT,SPACES                                                     
         MVC   X#ACT(L'JD_CLI),JD_CLI                                           
CR       USING ACTRECD,R1                                                       
         L     R1,AIO4             current client in IO area?                   
         CLC   JD_CLI,CR.ACTKACT                                                
         JNE   CASCLI08                                                         
         L     R0,AIO2             copy AIO4 into AIO2                          
         LA    R1,IOLENQ                                                        
         L     RE,AIO4                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         L     R3,AIO2                                                          
         J     CASCLI10                                                         
         DROP  CR                                                               
                                                                                
CASCLI00 MVC   X#ACT,0(R1)                                                      
         LA    R4,X#ACT                                                         
                                                                                
         CLC   RQ_JDCLC,SPACES     client passed then skip                      
         JH    CASCLIY                                                          
                                                                                
         MVI   X#HIGH,NOQ                                                       
         LLC   RE,PCLILEN                                                       
         SHI   RE,1                                                             
                                                                                
         OC    ELESDCLI,ELESDCLI   change in client (first time?)?              
         JZ    CASCLI02                                                         
         EX    RE,CASCLIC                                                       
         JNE   CASCLI02                                                         
         TM    ELESDCST,ACTSLOCK                                                
         JZ    CASCLIY                                                          
         J     CASCLIN                                                          
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
CASCLI02 CLI   X#TSAYN,YESQ        TSAR required?                               
         JNE   CASCLI08                                                         
         XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         MVI   TSB.JSBDTYP,JSBDTCQ                                              
         MVC   TSB.JSBDCOD,SPACES                                               
         MVC   TSB.JSBDCOD(0),0(R4)                                             
         EX    RE,*-6                                                           
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         JE    CASCLI04                                                         
         TM    TSARERRS,TSERNF     Test record not found                        
         JNZ   CASCLI08                                                         
         DC    H'0'                Other error                                  
                                                                                
CASCLI04 MVC   X#AOFF,TSB.JSBDOFF  save current client details                  
         MVC   ELESDCLI,TSB.JSBDCOD                                             
         MVC   ELESDCST,TSB.JSBDSTA                                             
         MVC   ELESDCOF,TSB.JSBDOFF                                             
         MVC   ELESDCLN,TSB.JSBDNAM                                             
         MVC   ELESDCXD,TSB.JSBDXDB                                             
         XC    ELESDPRO(ELESPLNQ),ELESDPRO                                      
         MVC   X#HOFF,ELESDCOF                                                  
         MVC   X#POFF,ELESDCOF                                                  
                                                                                
         TM    ELESDCST,ACTSLOCK   client locked?                               
         JZ    CASCLIY                                                          
         J     CASCLIN                                                          
                                                                                
CASCLI08 MVC   CSVKEY1,IOKEY                                                    
                                                                                
         USING ACTRECD,R3                                                       
         LA    R3,IOKEY            read for client account record               
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(2),PRODUL                                                
         LLC   R1,PCLILEN                                                       
         SHI   R1,1                                                             
         MVC   ACTKACT(0),X#ACT                                                 
         EX    R1,*-6                                                           
         MVI   X#HIGH,YESQ                                                      
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   *+2                                                              
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
         L     R0,AIO4             Copy SJ client to AIO4                       
         LA    R1,IOLENQ                                                        
         L     RE,AIO2                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         L     R3,AIO2                                                          
                                                                                
CASCLI10 LLC   RE,PPROLEN                                                       
         AHI   RE,ACTKACT-ACTKCPY-1                                             
         STC   RE,X#CLVL                                                        
                                                                                
         GOTOR XJOBGOF                                                          
                                                                                
         XC    X#HOFF,X#HOFF                                                    
         CLC   X#AOFF,SPACES                                                    
         JNH   CASCLI12                                                         
                                                                                
         MVC   X#HOFF,X#AOFF                                                    
         MVC   X#POFF,X#AOFF                                                    
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
CASCLI12 XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         LHI   R1,JSBDLNQ                                                       
         STH   R1,TSB.JSBDLEN                                                   
         MVI   TSB.JSBDTYP,JSBDTCQ                                              
         MVC   TSB.JSBDCOD,ACTKACT                                              
         MVC   TSB.JSBDOFF,X#POFF                                               
         MVC   TSB.JSBDNAM,SPACES                                               
         CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    CASCLI13                                                         
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    CASCLI13                                                         
         CLI   RQ_JDLST,YESQ       include locked jobs?                         
         JE    CASCLI13                                                         
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    CASCLI13                                                         
         MVC   TSB.JSBDSTA,ACTRSTAT                                             
                                                                                
         USING NAMELD,R1                                                        
CASCLI13 LA    R1,ACTRFST                                                       
CASCLI14 CLI   NAMEL,NAMELQ                                                     
         JE    CASCLI16                                                         
         CLI   NAMEL,0                                                          
         JE    *+2                                                              
         LLC   R0,NAMLN                                                         
         AR    R1,R0                                                            
         J     CASCLI14                                                         
CASCLI16 LLC   RE,NAMLN                                                         
         SHI   RE,NAMLN1Q+1                                                     
         MVC   TSB.JSBDNAM(0),NAMEREC                                           
         EX    RE,*-6                                                           
         DROP  R1                                                               
                                                                                
         GOTOR SETXDB,DMCB,TSB.JSBDXDB,ACTRECD                                  
                                                                                
         CLI   X#TSAYN,YESQ        TSAR required?                               
         JNE   CASCLI18                                                         
                                                                                
         GOTOR GOTSAR,DMCB,('TSAADD',0)  add client to buffer                   
         JE    CASCLI18                                                         
         TM    TSARERRS,TSEEOF     buffer full - so it is ...                   
         JNZ   CASCLI18                                                         
         DC    H'0'                duplicate key                                
                                                                                
CASCLI18 MVC   ELESDCLI,TSB.JSBDCOD save current client details                 
         MVC   ELESDCST,TSB.JSBDSTA                                             
         MVC   ELESDCOF,TSB.JSBDOFF                                             
         MVC   ELESDCLN,TSB.JSBDNAM                                             
         MVC   ELESDCXD,TSB.JSBDXDB                                             
         XC    ELESDPRO(ELESPLNQ),ELESDPRO                                      
         MVC   X#HOFF,ELESDCOF                                                  
         MVC   X#POFF,ELESDCOF                                                  
         DROP  TSB                                                              
                                                                                
         TM    ELESDCST,ACTSLOCK   do we want it?                               
         JZ    CASCLI20                                                         
         MVC   SAVEKEY4,IOKEY      save SJ(/client/product) key                 
                                                                                
CASCLI20 MVC   IOKEY,CSVKEY1                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   *+2                                                              
                                                                                
         TM    ELESDCST,ACTSLOCK                                                
         JNZ   CASCLIN                                                          
         J     CASCLIY                                                          
                                                                                
CASCLIC  CLC   ELESDCLI(0),0(R4)                                                
                                                                                
CASCLIN  LHI   R1,1                                                             
         J     CASCLIX                                                          
CASCLIY  LHI   R1,0                                                             
CASCLIX  DS    0H                                                               
         CHI   R1,0                                                             
         XIT1                                                                   
         DROP  R3                                                               
         LTORG                                                                  
         EJECT                                                                  
                                                                                
* Check for Product requested, if not check for product change, if so           
* set product details and carry on                                              
CASPRO   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*CASPRO*'                                                      
                                                                                
         LTR   R1,R1               XJOBOUT special call to get product          
         JNZ   CASPRO00                                                         
         MVC   X#ACT,SPACES                                                     
         L     RE,AIO2                                                          
         LLC   RF,PPROLEN                                                       
         SHI   RF,1                                                             
         MVC   X#ACT(0),ACTKACT-ACTRECD(RE)                                     
         EX    RF,*-6                                                           
                                                                                
CR       USING ACTRECD,R1                                                       
         L     R1,AIO5             current product in IO area?                  
         LLC   RF,PPROLEN                                                       
         SHI   RF,1                                                             
         LA    R4,X#ACT                                                         
         CLC   X#ACT(0),CR.ACTKACT                                              
         EX    RF,*-6                                                           
         JNE   CASPRO08                                                         
         L     R0,AIO2             copy AIO5 into AIO2                          
         LA    R1,IOLENQ                                                        
         L     RE,AIO5                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         L     R3,AIO2                                                          
         J     CASPRO12                                                         
         DROP  CR                                                               
                                                                                
CASPRO00 MVC   X#ACT,0(R1)                                                      
         LA    R4,X#ACT                                                         
                                                                                
         CLC   RQ_JDCLC,SPACES     client passed then skip                      
         JH    CASPROY                                                          
                                                                                
         LLC   RE,PCLILEN                                                       
         LA    R1,X#ACT                                                         
         AR    R1,RE               point to product                             
         LLC   RF,PPROLEN                                                       
         SR    RF,RE                                                            
         SHI   RF,1                length of it                                 
                                                                                
         OC    ELESDPRO,ELESDPRO   change in product (first time?)?             
         JZ    CASPRO02                                                         
         CLC   ELESDPRO,0(R1)                                                   
         JNE   CASPRO02                                                         
         TM    ELESDPST,ACTSLOCK                                                
         JZ    CASPROY                                                          
         J     CASPRON                                                          
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
CASPRO02 CLI   X#TSAYN,YESQ        TSAR required?                               
         JNE   CASPRO08                                                         
         XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         MVI   TSB.JSBDTYP,JSBDTPQ                                              
         MVC   TSB.JSBDCOD,SPACES                                               
         LLC   RE,PPROLEN                                                       
         SHI   RE,1                                                             
         MVC   TSB.JSBDCOD(0),X#ACT                                             
         EX    RE,*-6                                                           
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         JE    CASPRO04                                                         
         TM    TSARERRS,TSERNF     Test record not found                        
         JNZ   CASPRO08                                                         
         DC    H'0'                Other error                                  
                                                                                
CASPRO04 LLC   RF,PCLILEN                                                       
         LA    RF,TSB.JSBDCOD(RF)                                               
         MVC   ELESDPRO,0(RF)                                                   
         MVC   ELESDPST,TSB.JSBDSTA                                             
         MVC   ELESDPOF,TSB.JSBDOFF                                             
         MVC   ELESDPRN,TSB.JSBDNAM                                             
         MVC   ELESDPXD,TSB.JSBDXDB                                             
         MVC   X#AOFF,ELESDPOF                                                  
         MVC   X#POFF,ELESDPOF                                                  
                                                                                
         TM    ELESDPST,ACTSLOCK                                                
         JZ    CASPROY                                                          
         J     CASPRON                                                          
                                                                                
CASPRO08 MVC   CSVKEY1,IOKEY                                                    
                                                                                
         USING ACTRECD,R3                                                       
         LA    R3,IOKEY            read for product account record              
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKUNT(2),PRODUL                                                
         LLC   R1,PPROLEN                                                       
         SHI   R1,1                                                             
         MVC   ACTKACT(0),0(R4)                                                 
         EX    R1,*-6                                                           
         MVI   X#HIGH,YESQ                                                      
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   *+2                                                              
                                                                                
*&&UK*&& CLI   ACTKSUFA,C' '                                                    
*&&US*&& CLI   ACTKSOFF,C' '                                                    
         JNH   CASPRO10                                                         
*&&UK*&& CLC   ACTKSUFA,X#HOFF                                                  
*&&US*&& CLC   ACTKSOFF,X#HOFF                                                  
         JNE   *+2                                                              
                                                                                
CASPRO10 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
         L     R0,AIO5             Copy SJ product to AIO5                      
         LA    R1,IOLENQ                                                        
         L     RE,AIO2                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         L     R3,AIO2                                                          
                                                                                
CASPRO12 GOTOR XJOBGOF                                                          
                                                                                
         CLC   X#AOFF,SPACES                                                    
         JNH   CASPRO14                                                         
         MVC   X#POFF,X#AOFF                                                    
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
CASPRO14 XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         LHI   R1,JSBDLNQ                                                       
         STH   R1,TSB.JSBDLEN                                                   
         MVI   TSB.JSBDTYP,JSBDTPQ                                              
         LLC   RF,PPROLEN                                                       
         SHI   RF,1                                                             
         MVC   TSB.JSBDCOD,SPACES                                               
         MVC   TSB.JSBDCOD(0),ACTKACT                                           
         EX    RF,*-6                                                           
         MVC   TSB.JSBDOFF,X#POFF                                               
         MVC   TSB.JSBDNAM,SPACES                                               
         CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    CASPRO15                                                         
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    CASPRO15                                                         
         CLI   RQ_JDLST,YESQ       include locked jobs?                         
         JE    CASPRO15                                                         
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    CASPRO15                                                         
         MVC   TSB.JSBDSTA,ACTRSTAT                                             
                                                                                
         USING NAMELD,R1                                                        
CASPRO15 LA    R1,ACTRFST                                                       
CASPRO16 CLI   NAMEL,NAMELQ                                                     
         JE    CASPRO18                                                         
         CLI   NAMEL,0                                                          
         JE    *+2                                                              
         LLC   R0,NAMLN                                                         
         AR    R1,R0                                                            
         J     CASPRO16                                                         
CASPRO18 LLC   RE,NAMLN                                                         
         SHI   RE,NAMLN1Q+1                                                     
         MVC   TSB.JSBDNAM(0),NAMEREC                                           
         EX    RE,*-6                                                           
         DROP  R1                                                               
                                                                                
         GOTOR SETXDB,DMCB,TSB.JSBDXDB,ACTRECD                                  
                                                                                
         CLI   X#TSAYN,YESQ        TSAR required?                               
         JNE   CASPRO20                                                         
                                                                                
         GOTOR GOTSAR,DMCB,('TSAADD',0)  add client to buffer                   
         JE    CASPRO20                                                         
         TM    TSARERRS,TSEEOF     buffer full - so it is ...                   
         JNZ   CASPRO20                                                         
         TM    TSARERRS,TSEDUP     (this may happen if AIO5 has this            
         JNZ   CASPRO20             product saved)                              
         DC    H'0'                duplicate key                                
                                                                                
CASPRO20 LLC   RF,PCLILEN          save current product details                 
         LA    RF,TSB.JSBDCOD(RF)                                               
         MVC   ELESDPRO,0(RF)                                                   
         MVC   ELESDPST,TSB.JSBDSTA                                             
         MVC   ELESDPOF,TSB.JSBDOFF                                             
         MVC   ELESDPRN,TSB.JSBDNAM                                             
         MVC   ELESDPXD,TSB.JSBDXDB                                             
         MVC   X#POFF,ELESDPOF                                                  
         DROP  TSB                                                              
                                                                                
         MVC   IOKEY,CSVKEY1                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JNE   *+2                                                              
                                                                                
         TM    ELESDPST,ACTSLOCK                                                
         JNZ   CASPRON                                                          
         J     CASPROY                                                          
                                                                                
CASPRON  LHI   R1,1                                                             
         J     CASPROX                                                          
CASPROY  LHI   R1,0                                                             
CASPROX  DS    0H                                                               
         CHI   R1,0                                                             
         XIT1                                                                   
         DROP  R3                                                               
         LTORG                                                                  
         EJECT                                                                  
                                                                                
* Get media and product/job limit list for user                                 
GETLIM   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*GETLIM*'                                                      
                                                                                
         MVI   X#MLLIU,NOQ         media limit list in use = no                 
         MVI   X#JLLIU,NOQ         job limit list in use = no                   
         GOTOR ACCRUL                                                           
                                                                                
         XC    X#MLLST,X#MLLST     set media list to empty                      
         L     R4,AGENAXTN         set job list to empty                        
         XC    0(12,R4),0(R4)                                                   
                                                                                
         USING LLSRECD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    LLSKEY,LLSKEY                                                    
         MVI   LLSKTYP,LLSKTYPQ                                                 
         MVI   LLSKSUB,LLSKSUBQ                                                 
         MVC   LLSKCPY,CUXCPY                                                   
         MVC   LLSKPIDB,CCTPID                                                  
         MVC   SAVEKEY3,LLSKEY                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         CLC   LLSKEY(LLSKGRP-LLSKEY),SAVEKEY3                                  
         JNE   GETLIMY                                                          
         MVI   X#LLTABS,X#LLALLQ   Default to unlimited access if               
         MVC   X#LLTABS+1(X#LLTLNQ-1),X#LLTABS we have limit list rec           
         MVI   BYTE4,LLSKSUBQ                                                   
         OC    LLSKGRP,LLSKGRP     prime or passive?                            
         JZ    GETLIM04                                                         
         MVI   BYTE4,GLSKSUBQ                                                   
         J     GETLIM04                                                         
GETLIM02 LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'                               
         CLI   SAVEKEY3+GLSKSUB-GLSRECD,GLSKSUBQ                                
         JE    GETLIM03            check depends on type                        
         CLC   LLSKEY(LLSKGRP-LLSKEY),SAVEKEY3                                  
         JNE   GETLIMY                                                          
         J     GETLIM04                                                         
GETLIM03 CLC   LLSKEY(GLSKSEQ-GLSKEY),SAVEKEY3                                  
         JNE   GETLIMY                                                          
                                                                                
GETLIM04 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JE    GETLIM06                                                         
         DC    H'0'                Bad master record                            
                                                                                
GETLIM06 L     R2,AIO1                                                          
         CLI   BYTE4,GLSKSUBQ      if passive reset IO sequence                 
         JNE   GETLIM08                                                         
         CLI   SAVEKEY3+GLSKSUB-GLSRECD,GLSKSUBQ                                
         JE    GETLIM08            (unless done before)                         
         MVC   SAVEKEY3,0(R2)                                                   
         MVC   IOKEY(L'LLSKEY),0(R2)                                            
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
                                                                                
GETLIM08 LA    R3,LLSRFST                                                       
         USING LIDELD,R3                                                        
GETLIM10 CLI   LIDEL,0                                                          
         JE    GETLIM02                                                         
         CLI   LIDEL,RSTELQ                                                     
         JE    GETLIM42                                                         
         CLI   LIDEL,LIDELQ                                                     
         JNE   GETLIM15                                                         
         CLI   LIDTYPE,LIDTMEDL                                                 
         JE    GETLIM20                                                         
         CLI   LIDTYPE,LIDTCPJL                                                 
         JE    GETLIM30                                                         
                                                                                
GETLIM15 LLC   RE,LIDLN                                                         
         AR    R3,RE                                                            
         J     GETLIM10            Get next                                     
                                                                                
GETLIM20 LLC   RE,LIDLN            save media codes                             
         AR    RE,R3                                                            
         LA    R1,X#MLLST                                                       
         LA    R2,LIDDATA                                                       
*&&UK*&& MVI   X#MLLIU,YESQ                                                     
MED      USING LIDDATA,R2                                                       
GETLIM22 CR    R2,RE                                                            
         JNL   GETLIM15                                                         
         TM    MED.LIDLAPPL,LIDLJOBS                                            
         JZ    GETLIM24                                                         
*&&US*&& MVI   X#MLLIU,YESQ                                                     
         MVC   0(L'LIDLMED,R1),MED.LIDLMED save media data                      
         AHI   R1,L'LIDLMED                                                     
GETLIM24 AHI   R2,LIDLLN3Q                                                      
         J     GETLIM22                                                         
         DROP  MED                                                              
                                                                                
GETLIM30 LLC   RE,LIDLN            filter and save jobs                         
         CLI   LIDLN,LIDDATA-LIDELD                                             
         JNH   GETLIM15            no contents                                  
         AR    RE,R3                                                            
         LLC   R1,PCLILEN                                                       
         SHI   R1,1                                                             
         LA    R2,LIDDATA                                                       
SJ       USING LIDDATA,R2                                                       
                                                                                
GETLIM32 CR    R2,RE               end of element?                              
         JNL   GETLIM15                                                         
*&&UK*&& MVI   X#JLLIU,YESQ                                                     
         TM    SJ.LIDLAPPL,LIDLJOBS                                             
         JZ    GETLIM40                                                         
*&&US*&& MVI   X#JLLIU,YESQ                                                     
         CLI   SJ.LIDLACT,C' '     Any account                                  
         JNH   GETLIM34            No                                           
         CLC   RQ_JDCLC,SPACES                                                  
         JNH   GETLIM34                                                         
         BASR  RF,0                Yes                                          
         CLC   RQ_JDCLC(0),SJ.LIDLACT Match on client?                          
         EX    R1,0(RF)                                                         
         JNE   GETLIM40            No - ignore                                  
GETLIM34 MVC   0(L'LIDLACT+L'LIDLOFF,R4),SJ.LIDLACT Extract data                
         AHI   R4,L'LIDLACT+L'LIDLOFF                                           
         XC    0(12,R4),0(R4)                                                   
                                                                                
GETLIM40 AHI   R2,LIDLLN9Q                                                      
         J     GETLIM32                                                         
                                                                                
         USING RSTELD,R3                                                        
GETLIM42 CLI   RSTLN,RSTLN3Q                                                    
         JL    GETLIM15                                                         
         TM    RSTACST1,RSTAJOBS                                                
         JZ    *+8                                                              
         MVI   X#LLTCPJ,X#LLNONQ                                                
         TM    RSTACST1,RSTAMED    Media code limit list                        
         JZ    *+8                                                              
         MVI   X#LLTMED,X#LLNONQ                                                
         J     GETLIM15                                                         
                                                                                
GETLIMY  CR    RB,RB                                                            
         J     *+6                                                              
GETLIMN  LTR   RB,RB                                                            
         XIT1                                                                   
         LTORG                                                                  
         DROP  SJ,R2,R3                                                         
         EJECT                                                                  
                                                                                
* Filter on media and product/job limit lists                                   
FLTLIM   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*FLTLIM*'                                                      
                                                                                
         LR    R2,R1               point to SJ account code                     
         LLC   R3,PPROLEN                                                       
         AR    R3,R2               point to media code                          
         CLI   RQ_JDOVR,YESQ       Do we have override on                       
         JE    FLTLIMY             Yes - let all through                        
                                                                                
         CLI   X#MLLIU,YESQ        media limit list in use?                     
         JE    FLTLIM02            Yes                                          
         CLI   X#LLTMED,X#LLALLQ   No - what is access rule                     
         JE    FLTLIM20            Allow all                                    
         J     FLTLIMN             Don't allow anything                         
                                                                                
FLTLIM02 LA    RE,X#MLLST                                                       
                                                                                
FLTLIM10 CLI   0(RE),0             end of list?                                 
         JE    FLTLIMN                                                          
         CLC   0(1,RE),0(R3)       match on media?                              
         JE    FLTLIM20                                                         
         AHI   RE,1                                                             
         J     FLTLIM10                                                         
                                                                                
FLTLIM20 DS    0H                                                               
         CLI   X#JLLIU,YESQ        job limit list in use?                       
         JE    FLTLIM22            Yes                                          
         CLI   X#LLTCPJ,X#LLALLQ   No - what is access rule                     
         JE    FLTLIMY             Allow all                                    
         J     FLTLIMN             Don't allow anything                         
                                                                                
FLTLIM22 L     R4,AGENAXTN         set job list to empty                        
                                                                                
FLTLIM30 OC    0(L'LIDLACT+L'LIDLOFF,R4),0(R4) end of list?                     
         JZ    FLTLIMN                                                          
                                                                                
         CLC   0(L'LIDLACT,R4),SPACES Any account code?                         
         JH    *+14                                                             
         CLC   L'LIDLACT(L'LIDLOFF,R4),SPACES                                   
         JH    FLTLIM42                                                         
         LLC   R1,PCLILEN          Determine limlist entry level                
         LR    RF,R1                                                            
         AR    RF,R4                                                            
         CLI   0(RF),C' '                                                       
         JE    FLTLIM40                                                         
         LLC   R1,PPROLEN                                                       
         LR    RF,R1                                                            
         AR    RF,R4                                                            
         CLI   0(RF),C' '                                                       
         JE    FLTLIM40                                                         
         LLC   R1,PJOBLEN                                                       
                                                                                
FLTLIM40 SHI   R1,1                                                             
         BASR  RF,0                                                             
         CLC   0(0,R4),0(R2)                                                    
         EX    R1,0(RF)                                                         
         JNE   FLTLIM44                                                         
FLTLIM42 CLI   L'LIDLACT(R4),C' '                                               
         JNH   FLTLIMY                                                          
         CLC   L'LIDLACT(L'LIDLOFF,R4),X#POFF                                   
         JE    FLTLIMY                                                          
                                                                                
FLTLIM44 AHI   R4,L'LIDLACT+L'LIDLOFF                                           
         J     FLTLIM30                                                         
                                                                                
FLTLIMY  LHI   R1,1                                                             
         J     FLTLIMX                                                          
FLTLIMN  LHI   R1,0                                                             
FLTLIMX  DS    0H                                                               
         CHI   R1,1                                                             
         XIT1                                                                   
         LTORG                                                                  
                                                                                
* Find out access rules *                                                       
                                                                                
ACCRUL   NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*ACCRUL*'                                                      
*                                                                               
         MVI   X#LLTABS,X#LLALLQ   Default to unlimited access                  
         MVC   X#LLTABS+1(X#LLTLNQ-1),X#LLTABS                                  
                                                                                
         LA    RF,SCPXEL                                                        
         JAS   RE,SETLAV           Set limit access values at company           
         JAS   RE,CHKLAV                                                        
         JE    ACCRULX             All values now set                           
                                                                                
         CLI   CUACCS,C'$'         List access single character                 
         JE    ACCRUL40            Yes - don't read for offices                 
         USING OFLPASD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    OFLPAS,OFLPAS                                                    
         MVI   OFLPTYP,OFLPTYPQ                                                 
         MVI   OFLPSUB,OFLPSUBQ                                                 
         MVC   OFLPREM,CUXCPY                                                   
         MVC   OFLPOFF,CUACCS+1                                                 
         TM    SCPYEL+(CPYSTAT4-CPYELD),CPYSOFF2                                
         JZ    *+10                                                             
         MVC   OFLPOFF,CUACCS+2                                                 
         MVC   CSVKEY1,OFLPAS                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         JE    ACCRUL20                                                         
         J     ACCRUL40                                                         
                                                                                
ACCRUL10 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
         JNE   ACCRUL40                                                         
                                                                                
ACCRUL20 CLC   OFLPAS(OFLPOFL-OFLPASD),CSVKEY1                                  
         JNE   ACCRUL40                                                         
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JNE   *+2                                                              
                                                                                
         L     RF,AIO3                                                          
         LA    RF,OFFRFST-OFFRECD(RF)                                           
         XR    R0,R0                                                            
N        USING CPXELD,RF                                                        
ACCRUL30 CLI   N.CPXEL,0                                                        
         JE    ACCRUL10                                                         
         CLI   N.CPXEL,CPXELQ                                                   
         JE    ACCRUL35                                                         
         IC    R0,N.CPXLN                                                       
         AR    RF,R0                                                            
         J     ACCRUL30                                                         
*                                                                               
ACCRUL35 JAS   RE,SETLAV           SET LIMIT ACCESS VALUES AT OFL LVL           
         J     ACCRUL10                                                         
         DROP  N                                                                
                                                                                
ACCRUL40 JAS   RE,CHKLAV                                                        
         JE    ACCRULX             OK - ALL VALUES NOW SET                      
                                                                                
         LA    R2,IOKEY            ELSE TRY OFFICE FOR SETTINGS                 
         USING OFFRECD,R2                                                       
         XC    OFFKEY,OFFKEY                                                    
         MVI   OFFKTYP,OFFKTYPQ                                                 
         MVC   OFFKCPY,CUXCPY                                                   
         MVC   OFFKOFF,CUACCS+1    *** THIS PROBABLY WON'T DO...                
         TM    SCPYEL+(CPYSTAT4-CPYELD),CPYSOFF2                                
         JZ    *+10                                                             
         MVC   OFFKOFF,CUACCS+2                                                 
         MVC   CSVKEY1,OFFKEY                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JNE   ACCRULX             NO OFFICE RECORD                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JNE   *+2                                                              
                                                                                
         L     RF,AIO3                                                          
         LA    RF,OFFRFST-OFFRECD(RF)                                           
         XR    R0,R0                                                            
N        USING CPXELD,RF                                                        
ACCRUL50 CLI   N.CPXEL,0                                                        
         JE    ACCRULX                                                          
         CLI   N.CPXEL,CPXELQ                                                   
         JE    ACCRUL55                                                         
         IC    R0,N.CPXLN                                                       
         AR    RF,R0                                                            
         J     ACCRUL50                                                         
                                                                                
ACCRUL55 JAS   RE,SETLAV          SET LIMIT ACCESS VALUES AT OFF LVL            
         DROP  R2,N                                                             
                                                                                
ACCRULX  XIT1                                                                   
                                                                                
N        USING CPXELD,RF                                                        
SETLAV   CLI   X#LLTMED,X#LLALLQ   TEST 'ALL' (= DEFAULT)                       
         JNE   *+16                                                             
         TM    N.CPXSTAT3,CPXAMED                                               
         JZ    *+8                                                              
         MVI   X#LLTMED,X#LLNONQ                                                
                                                                                
         CLI   X#LLTCPJ,X#LLALLQ                                                
         JNE   *+16                                                             
         TM    N.CPXSTAT3,CPXAJOBS                                              
         JZ    *+8                                                              
         MVI   X#LLTCPJ,X#LLNONQ                                                
                                                                                
         BR    RE                                                               
         DROP  N                                                                
                                                                                
* TEST ALL LIMIT ACCESS VALUES ARE SET                                          
                                                                                
CHKLAV   LA    RF,X#LLTABS                                                      
         LHI   R0,X#LLTLNQ                                                      
         CLI   0(RF),X#LLALLQ      'ALL' = DEFAULT                              
         JE    CHKLAVN             SO TRY ANOTHER LEVEL                         
         LA    RF,1(RF)                                                         
         JCT   R0,*-12                                                          
CHKLAVY  CR    RB,RB                                                            
         BR    RE                                                               
CHKLAVN  LTR   RB,RB                                                            
         BR    RE                                                               
                                                                                
                                                                                
* filter job on directory record                                                
         USING ACTRECD,R2                                                       
XJOBDIR  NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*XJOBDIR'                                                      
                                                                                
         LA    R2,IOKEY                                                         
                                                                                
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,X#POFF     validate current office                      
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JNE   XJOBD01                                                          
         DROP  R1                                                               
         CLC   RQ_JDOFF,SPACES     apply office filter if passed                
         JNH   XJOBD02                                                          
         CLC   RQ_JDOFF,X#POFF                                                  
         JE    XJOBD02                                                          
                                                                                
XJOBD01  LLC   RE,PCLILEN          skip current client office                   
         LA    RE,ACTKACT-1(RE)                                                 
         LLC   R1,0(RE)                                                         
         AHI   R1,1                                                             
         STC   R1,0(RE)                                                         
         MVI   1(RE),C' '                                                       
         MVI   X#HIGH,YESQ                                                      
         J     XJOBDN                                                           
                                                                                
XJOBD02  LLC   RE,PPROLEN          filter on media code                         
         LR    RF,RE                                                            
         LA    RE,ACTKACT(RE)                                                   
*        CLI   RQ_JDMED,C' '                                                    
*        JNH   XJOBD10                                                          
         CLI   X#MEDNO,1                                                        
         JL    XJOBD10                                                          
         JE    XJOBD04                                                          
                                                                                
         LA    RF,X#MEDLS          loop through list                            
         LLC   R0,X#MEDNO                                                       
XJOBD03  CLC   0(L'PMDKMED,RF),0(RE)                                            
         JE    XJOBD10                                                          
         AHI   RF,L'PMDKMED                                                     
         JCT   R0,XJOBD03                                                       
         LLC   RF,PPROLEN                                                       
         LA    RF,ACTKACT(RF)                                                   
         LLC   R1,0(RF)                                                         
         AHI   R1,1                                                             
         STC   R1,0(RF)                                                         
         MVI   1(RF),C' '                                                       
         MVI   X#HIGH,YESQ                                                      
         J     XJOBDN                                                           
                                                                                
XJOBD04  CLC   X#MEDLS(L'PMDKMED),0(RE)                                         
         JE    XJOBD10                                                          
         JH    XJOBD05                                                          
                                                                                
         LA    R1,L'ACTKACT        if past then set to next product             
         LLC   RF,PPROLEN                                                       
         SR    R1,RF                                                            
         SHI   R1,1                                                             
         MVC   0(0,RE),SPACES                                                   
         EX    R1,*-6                                                           
         MVI   0(RE),FF                                                         
         MVI   X#HIGH,YESQ                                                      
         J     XJOBDN                                                           
                                                                                
XJOBD05  LA    R1,L'ACTKACT        set to media code filter                     
         LLC   RF,PPROLEN                                                       
         SR    R1,RF                                                            
         SHI   R1,1                                                             
         MVC   0(0,RE),SPACES                                                   
         EX    R1,*-6                                                           
         MVC   0(1,RE),X#MEDLS                                                  
         MVI   X#HIGH,YESQ                                                      
         J     XJOBDN                                                           
                                                                                
XJOBD10  GOTOR FLTLIM,ACTKACT      filter on limit lists                        
         JNE   XJOBDN                                                           
                                                                                
***      CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
***      JE    XJOBD12                                                          
***      CLI   RQ_JDCST,RQ_BOTHQ                                                
***      JE    XJOBD12                                                          
***      close status see XJOBD25                                               
         CLI   RQ_JDLST,YESQ       include locked?                              
         JE    XJOBD12                                                          
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    XJOBD11                                                          
                                                                                
         TM    ACTKSTAT,ACTSLOCK   job locked?                                  
         JNZ   XJOBDN                                                           
         J     XJOBD12                                                          
                                                                                
XJOBD11  TM    ACTKSTAT,ACTSLOCK   job locked?                                  
         JZ    XJOBDN                                                           
                                                                                
XJOBD12  CLI   RQ_JDDRA,C'O'       drafts only?                                 
         JNE   XJOBD13                                                          
         TM    ACTKSTAT,ACTSDRFT                                                
         JZ    XJOBDN                                                           
         J     XJOBD15                                                          
                                                                                
XJOBD13  CLI   RQ_JDDRA,NOQ        drafts not?                                  
         JNE   XJOBD15                                                          
         TM    ACTKSTAT,ACTSDRFT                                                
         JNZ   XJOBDN                                                           
                                                                                
XJOBD15  LA    RE,RQ_JDF1V         filter on filters                            
         LA    RF,ACTKSAF1                                                      
         LHI   R1,5                                                             
                                                                                
XJOBD20  CLI   0(RE),C' '                                                       
         JNH   XJOBD25                                                          
                                                                                
         CLC   0(1,RF),0(RE)                                                    
         JNE   XJOBDN                                                           
                                                                                
XJOBD25  AHI   RE,1                                                             
         AHI   RF,1                                                             
         JCT   R1,XJOBD20                                                       
                                                                                
         CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    XJOBD30                                                          
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    XJOBD35                                                          
                                                                                
         TM    ACTKSTAT,ACTSCLOS   job closed no                                
         JNZ   XJOBDN                                                           
         J     XJOBD35                                                          
                                                                                
XJOBD30  TM    ACTKSTAT,ACTSCLOS   job closed yes (only)                        
         JZ    XJOBDN                                                           
         J     XJOBD35                                                          
                                                                                
XJOBD35  DS    0H                  both                                         
                                                                                
XJOBDY   LHI   R1,1                                                             
         J     XJOBDX                                                           
XJOBDN   LHI   R1,0                                                             
XJOBDX   DS    0H                                                               
         CHI   R1,1                                                             
         XIT1                                                                   
         LTORG                                                                  
         DROP  R2                                                               
         EJECT                                                                  
                                                                                
* filter job on directory PID passive                                           
         USING PIDRECD,R2                                                       
XJOBPID  NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*XJOBPID'                                                      
                                                                                
         CLC   RQ_JDCLC,SPACES                                                  
         JNH   XJPID10                                                          
                                                                                
         LLC   RE,PCLILEN                                                       
         CLC   RQ_JDPRO,SPACES                                                  
         JNH   XJPID05                                                          
         LLC   RE,PPROLEN                                                       
         CLC   RQ_JDJOB,SPACES                                                  
         JNH   XJPID05                                                          
         LLC   RE,PJOBLEN                                                       
         LA    RF,RQ_JDJOB+L'RQ_JDJOB-1                                         
         CLI   0(RF),C' '          Find end of job                              
         JH    XJPID05                                                          
         BCTR  RF,0                                                             
         JCT   RE,*-10                                                          
                                                                                
XJPID05  SHI   RE,1                                                             
         EX    RE,XJPID90                                                       
         JH    XJPIDH                                                           
         JL    XJPIDL                                                           
                                                                                
*        CLI   RQ_JDMED,C' '                                                    
*        JNH   XJPID20                                                          
*        LLC   RE,PPROLEN                                                       
*        LA    RE,PIDKACC(RE)                                                   
*        CLC   RQ_JDMED,0(RE)                                                   
*        JNE   XJPIDL                                                           
                                                                                
XJPID10  LLC   RE,PPROLEN                                                       
         LA    RE,PIDKACC(RE)                                                   
                                                                                
         CLI   X#MEDNO,1                                                        
         JL    XJPID20                                                          
         JE    XJPID14                                                          
                                                                                
         LA    RF,X#MEDLS          loop through list                            
         LLC   R0,X#MEDNO                                                       
XJPID12  CLC   0(L'PMDKMED,RF),0(RE)                                            
         JE    XJPID20                                                          
         AHI   RF,L'PMDKMED                                                     
         JCT   R0,XJPID12                                                       
         J     XJPIDL                                                           
                                                                                
XJPID14  CLC   X#MEDLS(L'PMDKMED),0(RE)                                         
         JNE   XJPIDL                                                           
XJPID20  CLI   RQ_JDTYP,RQ_JDT7Q   User assigned list call                      
         JE    XJPID21             filtering done later                         
         GOTOR FLTLIM,PIDKACC      filter on limit lists                        
         JNE   XJPIDL                                                           
                                                                                
* Note: that the close/lock checks here differ from other JLSD places           
XJPID21  CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    XJPID22                                                          
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    XJPID24                                                          
         TM    PIDKSTAT,ACTSCLOS   job closed?                                  
         JNZ   XJPIDL                                                           
         J     XJPID24                                                          
                                                                                
XJPID22  TM    PIDKSTAT,ACTSCLOS   job closed?                                  
         JZ    XJPIDL                                                           
                                                                                
XJPID24  CLI   RQ_JDLST,YESQ       include locked jobs?                         
         JE    XJPID30                                                          
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    XJPID26                                                          
         TM    PIDKSTAT,ACTSLOCK   job locked?                                  
         JNZ   XJPIDL                                                           
         J     XJPID30                                                          
                                                                                
XJPID26  TM    PIDKSTAT,ACTSLOCK   job locked?                                  
         JZ    XJPIDL                                                           
                                                                                
XJPID30  LA    RE,RQ_JDF1V         filter on filters                            
         LA    RF,PIDKSTAT+ACTKSAF1-ACTKSTAT                                    
         LHI   R1,5                                                             
                                                                                
XJPID32  CLI   0(RE),C' '                                                       
         JNH   XJPID34                                                          
                                                                                
         CLC   0(1,RF),0(RE)                                                    
         JNE   XJPIDL                                                           
                                                                                
XJPID34  AHI   RE,1                                                             
         AHI   RF,1                                                             
         JCT   R1,XJPID32                                                       
                                                                                
XJPID40  DS    0H                                                               
         J     XJPIDE              no more checking here                        
                                                                                
XJPID90  CLC   PIDKACC(0),SAVEKEY4+ACTKACT-ACTKEY                               
                                                                                
XJPIDE   LA    RE,1                                                             
         J     XJPIDX                                                           
XJPIDL   LA    RE,0                                                             
         J     XJPIDX                                                           
XJPIDH   LA    RE,2                                                             
         J     XJPIDX                                                           
XJPIDX   CHI   RE,1                                                             
         XIT1                                                                   
         LTORG                                                                  
         DROP  R2                                                               
         EJECT                                                                  
                                                                                
* filter job on directory DRAPAS passive                                        
         USING DRAPASD,R2                                                       
XJOBDRA  NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*XJOBDRA'                                                      
                                                                                
         CLC   RQ_JDCLC,SPACES                                                  
         JE    XJDRA30                                                          
                                                                                
         LLC   RE,PCLILEN                                                       
         CLC   RQ_JDPRO,SPACES                                                  
         JE    XJDRA10                                                          
         LLC   RE,PPROLEN                                                       
                                                                                
XJDRA10  SHI   RE,1                                                             
         EX    RE,XJDRA20                                                       
         JH    XJDRAH                                                           
         JL    XJDRAL                                                           
         J     XJDRA30                                                          
                                                                                
XJDRA20  CLC   DRAPACT(0),SAVEKEY4+ACTKACT-ACTKEY                               
                                                                                
XJDRA30  OC    X#PIDSU,X#PIDSU                                                  
         JZ    XJDRA40                                                          
         CLC   DRAPPID,X#PIDSU                                                  
         JNE   XJDRAL                                                           
                                                                                
         CLC   X#COFF,SPACES                                                    
         JNH   XJDRA40                                                          
         CLC   DRAPSOFF,X#COFF                                                  
         JNE   XJDRAL                                                           
                                                                                
*JDRA40  CLI   RQ_JDMED,C' '       media code filter                            
*        JNH   XJDRA50                                                          
*                                                                               
*        LLC   RE,PPROLEN                                                       
*        LA    RE,DRAPACT(RE)                                                   
*        CLC   RQ_JDMED,0(RE)                                                   
*        JNE   XJDRAL                                                           
                                                                                
XJDRA40  LLC   RE,PPROLEN          media code filter                            
         LA    RE,DRAPACT(RE)                                                   
                                                                                
         CLI   X#MEDNO,1                                                        
         JL    XJDRA50                                                          
         JE    XJDRA44                                                          
                                                                                
         LA    RF,X#MEDLS          loop through list                            
         LLC   R0,X#MEDNO                                                       
XJDRA42  CLC   0(L'PMDKMED,RF),0(RE)                                            
         JE    XJDRA50                                                          
         AHI   RF,L'PMDKMED                                                     
         JCT   R0,XJDRA42                                                       
         J     XJDRAL                                                           
                                                                                
XJDRA44  CLC   X#MEDLS(L'PMDKMED),0(RE)                                         
         JNE   XJDRAL                                                           
                                                                                
XJDRA50  GOTOR FLTLIM,DRAPACT      filter on limit lists                        
         JNE   XJDRAL                                                           
                                                                                
***      CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
***      JE    XJDRA60                                                          
***      CLI   RQ_JDCST,RQ_BOTHQ                                                
***      JE    XJDRA60                                                          
***      close status see XJDRA54                                               
         CLI   RQ_JDLST,YESQ       include locked?                              
         JE    XJDRA54                                                          
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    XJDRA52                                                          
                                                                                
         TM    DRAPSTAT,ACTSLOCK   job locked?                                  
         JNZ   XJDRAL                                                           
         J     XJDRA54                                                          
                                                                                
XJDRA52  TM    DRAPSTAT,ACTSLOCK   job locked?                                  
         JZ    XJDRAL                                                           
                                                                                
XJDRA54  CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    XJDRA56                                                          
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    XJOBP60                                                          
                                                                                
         TM    DRAPSTAT,ACTSCLOS   job closed yes                               
         JNZ   XJDRAL                                                           
         J     XJDRA60                                                          
                                                                                
XJDRA56  TM    DRAPSTAT,ACTSCLOS   job closed no                                
         JZ    XJDRAL                                                           
                                                                                
XJDRA60  LA    RE,RQ_JDF1V         filter on filters                            
         LA    RF,DRAPSTAT+ACTKSAF1-ACTKSTAT                                    
         LHI   R1,5                                                             
                                                                                
XJDRA62  CLI   0(RE),C' '                                                       
         JNH   XJDRA64                                                          
                                                                                
         CLC   0(1,RF),0(RE)                                                    
         JNE   XJDRAL                                                           
                                                                                
XJDRA64  AHI   RE,1                                                             
         AHI   RF,1                                                             
         JCT   R1,XJDRA62                                                       
                                                                                
XJDRA66  DS    0H                  no more checking here                        
                                                                                
XJDRAE   LA    RE,1                                                             
         J     XJDRAX                                                           
XJDRAL   LA    RE,0                                                             
         J     XJDRAX                                                           
XJDRAH   LA    RE,2                                                             
         J     XJDRAX                                                           
XJDRAX   DS    0H                                                               
         CHI   RE,1                                                             
         XIT1                                                                   
         LTORG                                                                  
         DROP  R2                                                               
         EJECT                                                                  
                                                                                
* filter job on directory passive                                               
         USING SRCRECD,R2                                                       
XJOBPAS  NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*XJOBPAS'                                                      
                                                                                
         CLC   RQ_JDCLC,SPACES     skip if no client set                        
         JNH   XJOBP25                                                          
                                                                                
         LLC   RE,X#CLVL          then read for next product                    
         EX    RE,XJOBP10                                                       
         J     XJOBP20                                                          
                                                                                
XJOBP10  CLC   SAVEKEY4+ACTKACT-ACTRECD(0),SRCKACT                              
                                                                                
XJOBP20  JNE   XJOBPN                                                           
                                                                                
XJOBP25  LA    R2,IOKEY                                                         
         MVC   X#POFF,SRCKSOFF                                                  
         GOTOR FLTLIM,SRCKACT      filter on limit lists                        
         JNE   XJOBPN                                                           
                                                                                
         LLC   RE,PPROLEN          filter on media code                         
         LR    RF,RE                                                            
         LA    RE,SRCKACT(RE)                                                   
                                                                                
*        CLI   RQ_JDMED,C' '                                                    
*        JNH   XJOBP30                                                          
*        CLC   RQ_JDMED,0(RE)                                                   
*        JNE   XJOBPN                                                           
                                                                                
         CLI   X#MEDNO,1                                                        
         JL    XJOBP30                                                          
         JE    XJOBP29                                                          
                                                                                
         LA    RF,X#MEDLS          loop through list                            
         LLC   R0,X#MEDNO                                                       
XJOBP27  CLC   0(L'PMDKMED,RF),0(RE)                                            
         JE    XJOBP30                                                          
         AHI   RF,L'PMDKMED                                                     
         JCT   R0,XJOBP27                                                       
         J     XJOBPN                                                           
                                                                                
XJOBP29  CLC   X#MEDLS(L'PMDKMED),0(RE)                                         
         JNE   XJOBPN                                                           
                                                                                
XJOBP30  DS    0H                                                               
***      CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
***      JE    XJOBP50                                                          
***      CLI   RQ_JDCST,RQ_BOTHQ                                                
***      JE    XJOBP50                                                          
***      close status see XJOBP40                                               
         CLI   RQ_JDLST,YESQ       include locked?                              
         JE    XJOBP40                                                          
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    XJOBP35                                                          
                                                                                
         TM    SRCKSTAT,ACTSLOCK   job locked?                                  
         JNZ   XJOBPN                                                           
         J     XJOBP40                                                          
                                                                                
XJOBP35  TM    SRCKSTAT,ACTSLOCK   job locked?                                  
         JZ    XJOBPN                                                           
                                                                                
XJOBP40  CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    XJOBP50                                                          
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    XJOBP60                                                          
                                                                                
         TM    SRCKSTAT,ACTSCLOS   job closed yes                               
         JNZ   XJOBPN                                                           
         J     XJOBP60                                                          
                                                                                
XJOBP50  TM    SRCKSTAT,ACTSCLOS   job closed no                                
         JZ    XJOBPN                                                           
                                                                                
XJOBP60  MVC   X#COFF,SRCKSOFF     both                                         
                                                                                
XJOBPY   LHI   R1,0                                                             
         J     XJOBPX                                                           
XJOBPN   LHI   R1,1                                                             
XJOBPX   DS    0H                                                               
***      CLC   SAVEKEY3+ACTKDA-ACTRECD(4),=X'04FAD007'                          
***      JE    *+2                                                              
         CHI   R1,0                                                             
         XIT1                                                                   
         LTORG                                                                  
         DROP  R2                                                               
                                                                                
* Filter on current JDT passive                                                 
         USING JDTPASD,R2                                                       
XCHKJDT  NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*XCHKJDT'                                                      
                                                                                
         CLC   JDTPAS(JDTPDATE-JDTPASD),SAVEKEY2                                
         JNE   XCHKJDTH            all done                                     
                                                                                
         CLC   JDTPDATE,X#PASSTA                                                
         JNL   XCHKJ04                                                          
         MVC   JDTPDATE,X#PASSTA                                                
         XC    JDTPOFFC,JDTPOFFC                                                
         MVI   X#HIGH,YESQ                                                      
         J     XCHKJDTL            read high for next set                       
                                                                                
XCHKJ04  CLC   JDTPDATE,X#PASEND                                                
         JH    XCHKJDTH            all done                                     
                                                                                
         USING OFFALD,R1                                                        
         L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,JDTPOFFC   validate 'job office'                        
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JNE   XCHKJ06                                                          
         DROP  R1                                                               
                                                                                
         CLC   RQ_JDOFF,SPACES     apply office filter if passed                
         JNH   XCHKJ08                                                          
         CLC   RQ_JDOFF,JDTPOFFC                                                
         JE    XCHKJ08                                                          
                                                                                
XCHKJ06  MVI   JDTPJACT,FF         next office                                  
         MVI   X#HIGH,YESQ                                                      
         J     XCHKJDTL            read high for next set                       
                                                                                
XCHKJ08  GOTOR CASCLI,JDTPJACT     Check and set client                         
         JE    XCHKJ10                                                          
         LLC   RE,PCLILEN                                                       
         LA    RE,JDTPJACT(RE)                                                  
         MVI   0(RE),FF            skip this client                             
         MVI   X#HIGH,YESQ                                                      
         J     XCHKJDTL            read high for next set                       
                                                                                
XCHKJ10  GOTOR CASPRO,JDTPJACT     Check and set product                        
         JE    XCHKJ12                                                          
         LLC   RE,PPROLEN                                                       
         LA    RE,JDTPJACT(RE)                                                  
         MVI   0(RE),FF            skip this product                            
         MVI   X#HIGH,YESQ                                                      
         J     XCHKJDTL            read high for next set                       
                                                                                
XCHKJ12  LLC   RE,PPROLEN          filter on media code                         
         LR    RF,RE                                                            
         LA    RE,JDTPJACT(RE)                                                  
                                                                                
         CLI   X#MEDNO,1                                                        
         JL    XCHKJ18                                                          
         JE    XCHKJ16                                                          
                                                                                
         LA    RF,X#MEDLS          loop through list                            
         LLC   R0,X#MEDNO                                                       
XCHKJ14  CLC   0(L'PMDKMED,RF),0(RE)                                            
         JE    XJOBP30                                                          
         AHI   RF,L'PMDKMED                                                     
         JCT   R0,XCHKJ14                                                       
         J     XJOBPN                                                           
                                                                                
XCHKJ16  CLC   X#MEDLS(L'PMDKMED),0(RE)                                         
         JE    XCHKJ18                                                          
         MVI   0(RE),FF            set to next product                          
         MVI   X#HIGH,YESQ                                                      
         J     XCHKJDTL            read high for next set                       
                                                                                
XCHKJ18  MVC   X#POFF,JDTPOFFC                                                  
         GOTOR FLTLIM,JDTPJACT     filter on limit lists                        
         JE    XCHKJ20                                                          
         MVI   X#HIGH,NOQ                                                       
         J     XCHKJDTL            read for next job                            
                                                                                
XCHKJ20  DS    0H                                                               
***      CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
***      JE    XCHKJ30                                                          
***      CLI   RQ_JDCST,RQ_BOTHQ                                                
***      JE    XCHKJ26                                                          
***      close status see XCHKJ24                                               
         CLI   RQ_JDLST,YESQ       include locked?                              
         JE    XCHKJ24                                                          
         CLI   RQ_JDLST,RQ_ONLYQ                                                
         JE    XCHKJ22                                                          
                                                                                
         TM    JDTPSTA,ACTSLOCK    job locked?                                  
         JNZ   XCHKJ28                                                          
         J     XCHKJ24                                                          
                                                                                
XCHKJ22  TM    JDTPSTA,ACTSLOCK    job locked?                                  
         JZ    XCHKJ28                                                          
                                                                                
XCHKJ24  CLI   RQ_JDCST,YESQ       closed jobs yes/both?                        
         JE    XCHKJ26                                                          
         CLI   RQ_JDCST,RQ_BOTHQ                                                
         JE    XCHKJ30                                                          
                                                                                
         TM    JDTPSTA,ACTSCLOS    job closed yes                               
         JNZ   XCHKJ28                                                          
         J     XCHKJ30                                                          
                                                                                
XCHKJ26  TM    JDTPSTA,ACTSCLOS    job closed no                                
         JNZ   XCHKJ30                                                          
                                                                                
XCHKJ28  MVI   X#HIGH,NOQ                                                       
         J     XCHKJDTL            read for next job                            
                                                                                
XCHKJ30  MVC   X#COFF,JDTPOFFC     both                                         
                                                                                
XCHKJDTE LHI   R1,1                OK                                           
         J     XCHKJDTX                                                         
XCHKJDTL LHI   R1,0                next                                         
         J     XCHKJDTX                                                         
XCHKJDTH LHI   R1,2                end                                          
XCHKJDTX DS    0H                                                               
         CHI   R1,1                                                             
         XIT1                                                                   
         LTORG                                                                  
         DROP  R2                                                               
                                                                                
* get produtcion office from AIO2 record                                        
         USING ACTRECD,R2                                                       
         USING PPRELD,R3                                                        
XJOBGOF  NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*XJOBGOF'                                                      
                                                                                
         L     R2,AIO2                                                          
         LA    R3,ACTRFST                                                       
         MVC   X#AOFF,SPACES                                                    
                                                                                
XJOBG10  CLI   PPREL,PPRELQ                                                     
         JE    XJOBG20                                                          
         CLI   PPREL,0                                                          
         JE    XJOBGX                                                           
                                                                                
         LLC   R1,PPRLN                                                         
         AR    R3,R1                                                            
         J     XJOBG10                                                          
                                                                                
XJOBG20  MVC   X#AOFF,PPRGAOFF                                                  
         OC    X#AOFF,SPACES                                                    
                                                                                
XJOBGX   DS    0H                                                               
         XIT1                                                                   
         LTORG                                                                  
         DROP  R2,R3                                                            
         EJECT                                                                  
                                                                                
* filter job record (record in AIO2)                                            
         USING ACTRECD,R2                                                       
XJOBFLT  NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*XJOBFLT'                                                      
                                                                                
         L     R2,AIO2             point to SJ job record                       
         XC    X#ACTAP,X#ACTAP                                                  
         XC    X#ACTRJ,X#ACTRJ                                                  
         XC    X#ACTSU,X#ACTSU                                                  
                                                                                
         CLI   X#JDSTAT,0          no filter                                    
         JE    XJOBF04                                                          
         TM    X#JDSTAT,X#JDSTSU+X#JDSTRE+X#JDSTMA  approved jobs only?         
         JNZ   XJOBF02                                                          
         TM    ACTRSTAT,ACTSDRFT   skip draft jobs                              
         JNZ   XJOBFN                                                           
         J     XJOBF04                                                          
                                                                                
XJOBF02  TM    X#JDSTAT,X#JDSTAP   approved jobs, too?                          
         JNZ   XJOBF04                                                          
         TM    ACTRSTAT,ACTSDRFT   else skip live jobs                          
         JZ    XJOBFN                                                           
                                                                                
XJOBF04  OC    X#PIDAP,X#PIDAP     approver search?                             
         JZ    XJOBF06                                                          
         TM    ACTRSTAT,ACTSDRFT   skip draft jobs, too                         
         JNZ   XJOBFN                                                           
                                                                                
XJOBF06  LA    R3,ACTRFST                                                       
         USING UFSELD,R3                                                        
                                                                                
XJOBF08  MVI   BYTE1,0                                                          
         MVI   X#JBIR,NOQ                                                       
         XC    X#RUFI,X#RUFI                                                    
         LA    R0,X#UFLS           clear user field value area                  
         LA    R1,X#UFLQ                                                        
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         L     RE,ABLOCK                                                        
         LHI   RF,L'BLOCK                                                       
         XCEF                                                                   
         MVI   BYTE2,0                                                          
                                                                                
XJOBF10  CLI   UFSEL,0                                                          
         JE    XJOBF50                                                          
         CLI   UFSEL,UFSELQ                                                     
         JE    XJOBF20                                                          
         CLI   UFSEL,JOBELQ                                                     
         JE    XJOBF30                                                          
         CLI   UFSEL,RACELQ                                                     
         JE    XJOBF35                                                          
         CLI   UFSEL,STCELQ        STCELs held in AUDRECD, too                  
         JE    XJOBF40                                                          
         CLI   UFSEL,PPRELQ                                                     
         JE    XJOBF45                                                          
         CLI   UFSEL,RSTELQ                                                     
         JE    XJOBF47                                                          
                                                                                
XJOBF15  LLC   R0,UFSLN                                                         
         AR    R3,R0                                                            
         J     XJOBF10                                                          
                                                                                
XJOBF20  LLC   R1,BYTE1            process user field element                   
         CHI   R1,X#UFCMQ                                                       
         JNL   XJOBF15                                                          
         LLC   RE,BYTE2            save off header/description                  
         LR    RF,RE                                                            
         MHI   RE,L'UFSDESC                                                     
         L     R0,ABLOCK                                                        
         AR    RE,R0                                                            
         AHI   RF,1                                                             
         STC   RF,BYTE2                                                         
         MVC   0(L'UFSDESC,RE),UFSDESC                                          
         L     RF,AUINTAB          translate to upper case                      
         TR    0(L'UFSDESC,RE),0(RF)                                            
         LR    RF,R1               (save off user field data)                   
         MHI   RF,L'X#UFLS                                                      
         LA    RF,X#UFLS(RF)                                                    
         LLC   RE,UFSLN                                                         
         SHI   RE,UFSLN1Q+1                                                     
         LTR   RE,RE                                                            
         JNM   XJOBF21                                                          
         TM    SAVEIND,SAVEAUR                                                  
         JZ    XJOBF15                                                          
         MVC   0(UFSDATMX,RF),SPACES                                            
         AHI   R1,1                                                             
         STC   R1,BYTE1                                                         
         J     XJOBF15                                                          
XJOBF21  CHI   RE,UFSDATMX-1                                                    
         JL    XJOBF22                                                          
         LA    RE,UFSDATMX-1                                                    
XJOBF22  MVC   0(0,RF),UFSDATA                                                  
         EX    RE,*-6                                                           
         AHI   R1,1                                                             
         STC   R1,BYTE1                                                         
         L     RE,AUINTAB          translate to upper case                      
         TR    0(UFSDATMX,RF),0(RE)                                             
         LR    RF,R1                                                            
         LA    R1,X#RUFI-1(R1)     point to indicator                           
         MVI   0(R1),FF            set to found                                 
         TM    SAVEIND,SAVEAUR     Aura has different filtering                 
         JNZ   XJOBF15                                                          
         LA    R1,X#UFLD-1(RF)     point to filters                             
         CLI   0(R1),0             apply filter?                                
         JE    XJOBF15                                                          
         LLC   RE,0(R1)                                                         
         SHI   RE,1                get exec length for compare                  
         SHI   RF,1                                                             
         MHI   RF,L'RQ_JDUF1                                                    
         LA    RF,RQ_JDUF1(RF)                                                  
         EX    RE,XJOBF25                                                       
         JNE   XJOBFN                                                           
         J     XJOBF15                                                          
                                                                                
XJOBF25  CLC   0(0,RF),UFSDATA                                                  
                                                                                
         USING JOBELD,R3                                                        
XJOBF30  CLC   JOBCDATE,X#CLOD                                                  
         JL    XJOBFN                                                           
                                                                                
         CLC   JOBCDATE,X#CLOX                                                  
         JH    XJOBFN                                                           
                                                                                
         MVC   X#SVDT,JOBADATE                                                  
         CLI   JOBLN,JOBLN2Q                                                    
         JL    XJOBF32                                                          
                                                                                
         OC    JOBODATE,JOBODATE                                                
         JZ    XJOBF32                                                          
                                                                                
         MVC   X#SVDT,JOBODATE                                                  
                                                                                
XJOBF32  CLC   X#SVDT,X#OPND                                                    
         JL    XJOBFN                                                           
                                                                                
         CLC   X#SVDT,X#OPNX                                                    
         JH    XJOBFN                                                           
                                                                                
         CLI   JOBLN,JOBLN3Q                                                    
         JL    XJOBF15                                                          
         TM    JOBSTA2,JOBSREJ                                                  
         JZ    XJOBF15                                                          
         TM    SAVEIND,SAVEAUR     Skipped for Aura as per DSRD-10476           
         JNZ   XJOBF33                                                          
         CLI   X#JDSTAT,0          If no status filter, skip rejected           
         JE    XJOBFN                                                           
XJOBF33  MVI   X#JBIR,YESQ                                                      
         J     XJOBF15                                                          
                                                                                
         USING RACELD,R3                                                        
XJOBF35  CLI   RACTYPE,RACTADD     added=submitted?                             
         JNE   XJOBF37                                                          
         MVC   X#ACTSU,RACPERS                                                  
         J     XJOBF15                                                          
                                                                                
XJOBF37  CLI   RACTYPE,RACTAPP     approved?                                    
         JNE   XJOBF15                                                          
         CLI   RACVRVN,RACTAPP     approved in BrandOcean?                      
         JNE   XJOBF15                                                          
         MVC   X#ACTAP,RACPERS                                                  
         J     XJOBF15                                                          
                                                                                
         USING STCELD,R3                                                        
XJOBF40  CLI   STCIND,STCIJOB      STCELs held in AUDRECD now                   
         JNE   XJOBF15             - see REJECTER (note: REJECT08               
         CLI   STCDTO,C'R'           STCIND,STCIACT not applied here)           
         JNE   XJOBF15                                                          
         MVC   X#ACTRJ,STCPERS     rejection person                             
         J     XJOBF15                                                          
                                                                                
         USING PPRELD,R3                                                        
XJOBF45  MVC   X#COFF,PPRGAOFF                                                  
         OC    X#COFF,SPACES                                                    
         J     XJOBF15                                                          
                                                                                
         USING RSTELD,R3                                                        
XJOBF47  CLI   RQ_OPENS,C' '       OPEN FOR ESTIMATES                           
         JNH   XJOBF47B                                                         
         CLI   RQ_OPENS,C'A'       ANY STATUS ALLOWED                           
         JE    XJOBF47B                                                         
         CLI   RQ_OPENS,YESQ       OPEN FOR ESTIMATES                           
         JNE   XJOBF47A                                                         
         TM    RSTLSTAT,RSTLSESQ   LOCKED?                                      
         JNZ   XJOBFN              THEN REJECT                                  
         J     XJOBF47B                                                         
*                                                                               
XJOBF47A TM    RSTLSTAT,RSTLSESQ   CLOSED TO ESTIMATES THEN FILTER              
         JZ    XJOBFN              ANYTHING NOT LOCKED                          
         J     XJOBF47B                                                         
*                                                                               
XJOBF47B CLI   RQ_OPENO,C' '       LOCKED FROM ORDERS                           
         JNH   XJOBF47D                                                         
         CLI   RQ_OPENO,C'A'       ANY STATUS ALLOWED                           
         JE    XJOBF47D                                                         
         CLI   RQ_OPENO,YESQ       OPEN FOR ORDERS                              
         JNE   XJOBF47C                                                         
         TM    RSTLSTAT,RSTLSORQ   LOCKED?                                      
         JNZ   XJOBFN              THEN REJECT                                  
         J     XJOBF47D                                                         
*                                                                               
XJOBF47C TM    RSTLSTAT,RSTLSORQ   CLOSED TO ORDERS THEN FILTER                 
         JZ    XJOBFN              ANYTHING NOT LOCKED                          
         J     XJOBF47D                                                         
*                                                                               
XJOBF47D CLI   RQ_OPENX,C' '       LOCKED FROM EXTERNAL POSTINGS                
         JNH   XJOBF47F                                                         
         CLI   RQ_OPENX,C'A'       ANY STATUS ALLOWED                           
         JE    XJOBF47F                                                         
         CLI   RQ_OPENX,YESQ       OPEN FOR EXTERNAL POSTINGS                   
         JNE   XJOBF47E                                                         
         TM    RSTLSTAT,RSTLSEXQ   LOCKED?                                      
         JNZ   XJOBFN              THEN REJECT                                  
         J     XJOBF47F                                                         
*                                                                               
XJOBF47E TM    RSTLSTAT,RSTLSEXQ   CLOSED TO EXTERNAL POSTINGS THEN L           
         JZ    XJOBFN              FILTER ANYTHING NOT LOCKED                   
         J     XJOBF47F                                                         
*                                                                               
XJOBF47F CLI   RQ_OPENB,C' '       LOCKED FROM BILLING                          
         JNH   XJOBF47H                                                         
         CLI   RQ_OPENB,C'A'       ANY STATUS ALLOWED                           
         JE    XJOBF47H                                                         
         CLI   RQ_OPENB,YESQ       OPEN FOR BILLING                             
         JNE   XJOBF47G                                                         
         TM    RSTLSTAT,RSTLSBIQ   LOCKED?                                      
         JNZ   XJOBFN              THEN REJECT                                  
         J     XJOBF47H                                                         
*                                                                               
XJOBF47G TM    RSTLSTAT,RSTLSBIQ   CLOSED TO BILLING                            
         JZ    XJOBFN              FILTER ANYTHING NOT LOCKED                   
         J     XJOBF47H                                                         
*                                                                               
XJOBF47H CLI   RQ_OPENA,C' '       LOCKED FROM ADJUSTMENTS                      
         JNH   XJOBF47J                                                         
         CLI   RQ_OPENA,C'A'       ANY STATUS ALLOWED                           
         JE    XJOBF47J                                                         
         CLI   RQ_OPENA,YESQ       OPEN FOR ADJUSTMENTS                         
         JNE   XJOBF47I                                                         
         TM    RSTLSTAT,RSTLSADQ   LOCKED?                                      
         JNZ   XJOBFN              THEN REJECT                                  
         J     XJOBF47J                                                         
*                                                                               
XJOBF47I TM    RSTLSTAT,RSTLSADQ   CLOSED TO ADJUSTMENTS                        
         JZ    XJOBFN              FILTER ANYTHING NOT LOCKED                   
         J     XJOBF47J                                                         
*                                                                               
XJOBF47J CLI   RQ_OPENT,C' '       LOCKED FROM TIMESHEETS                       
         JNH   XJOBF15                                                          
         CLI   RQ_OPENT,C'A'       ANY STATUS ALLOWED                           
         JE    XJOBF15                                                          
         CLI   RQ_OPENT,YESQ                                                    
         JNE   XJOBF47L                                                         
         TM    SAVEIND,SAVEAUR     Aura - merge t/s lock status                 
         JZ    XJOBF47K                                                         
         TM    RSTSTAT5,RSTSNOTS                                                
         JNZ   XJOBFN                                                           
                                                                                
XJOBF47K TM    RSTLSTAT,RSTLSTIQ   LOCKED?                                      
         JNZ   XJOBFN              THEN REJECT                                  
         J     XJOBF15                                                          
                                                                                
XJOBF47L TM    SAVEIND,SAVEAUR     Aura - merge t/s lock status                 
         JZ    XJOBF47M                                                         
         TM    RSTSTAT5,RSTSNOTS                                                
         JZ    XJOBFN                                                           
                                                                                
XJOBF47M TM    RSTLSTAT,RSTLSTIQ   CLOSED TO TIMESHEETS                         
         JZ    XJOBFN              FILTER ANYTHING NOT LOCKED                   
         J     XJOBF15                                                          
                                                                                
XJOBF50  OC    X#PIDRJ,X#PIDRJ     see XJOBF66 - required at all?               
         JZ    XJOBF51                                                          
         OC    X#ACTRJ,X#ACTRJ     any rejecter found on job?                   
         JNZ   XJOBF51                                                          
         GOTOR REJECTER,ACTKULA                                                 
         MVC   X#ACTRJ,X#JOBREJ    no need to reestablsih IO sequence           
                                                                                
XJOBF51  TM    SAVEIND,SAVEAUR     Aura has different filtering                 
         JNZ   XJOBF54                                                          
                                                                                
         OC    X#UFLD,X#UFLD       final check on user fields                   
         JZ    XJOBF60                                                          
                                                                                
         LA    R1,X#UFLD                                                        
         LA    RE,X#UFCMQ                                                       
         LA    RF,X#RUFI                                                        
                                                                                
XJOBF52  CLI   0(R1),0             user field filter required?                  
         JE    XJOBF53                                                          
                                                                                
         CLI   0(RF),FF            processed                                    
         JNE   XJOBFN                                                           
                                                                                
XJOBF53  AHI   RF,1                                                             
         AHI   R1,1                                                             
         JCT   RE,XJOBF52                                                       
         J     XJOBF60                                                          
                                                                                
XJOBF54  CLI   X#UFLDH1,0          Aura user fields filtering                   
         JE    XJOBF60             (any filter passed?                          
                                                                                
         XR    R3,R3               main loop count                              
                                                                                
XJOBF55  LHI   R0,X#UFCMQ                                                       
         L     R4,ABLOCK           saved headers                                
                                                                                
         USING LW_D,RF                                                          
         XR    RF,RF               point to list in WMP                         
         ICM   RF,7,RQ_JDUAD                                                    
         AHI   RF,LW_LN2Q          RF=A(first array line data)                  
         LR    RE,R3                                                            
         MHI   RE,L'UFSDESC+UFSDATMX+UFSTYPEL                                   
         AR    RF,RE               get header filter entry                      
         DROP  RF                                                               
                                                                                
XFOBF56  LR    RE,R3                                                            
         MHI   RE,X#UFLDH2-X#UFLDH1                                             
         LA    RE,X#UFLDH1(RE)                                                  
         LLC   R1,0(RE)            length of header filter                      
         LTR   R1,R1                                                            
         JZ    XJOBF58                                                          
         SHI   R1,1                                                             
         EX    R1,XJOBF59          match on header?                             
         JE    XJOBF57                                                          
         AHI   R4,L'UFSDESC                                                     
         JCT   R0,XFOBF56                                                       
         J     XJOBFN              reject job                                   
                                                                                
XJOBF57  LHI   R1,X#UFCMQ          save position                                
         SR    R1,R0                                                            
         LR    RE,R3                                                            
         MHI   RE,X#UFRET2-X#UFRET1                                             
         LA    RE,X#UFRET1(RE)                                                  
         STC   R1,0(RE)                                                         
         LR    R4,R1                                                            
         MHI   R4,L'X#UFLS                                                      
         LA    R4,X#UFLS(R4)       entry in saved data values                   
                                                                                
         LR    RE,R3               any data filter?                             
         MHI   RE,X#UFLDD2-X#UFLDD1                                             
         LA    RE,X#UFLDD1(RE)                                                  
         LLC   R1,0(RE)            length of data filter (skip if none)         
         LTR   R1,R1                                                            
         JZ    XJOBF58                                                          
         SHI   R1,1                                                             
                                                                                
         USING LW_D,RF                                                          
         XR    RF,RF               point to list in WMP                         
         ICM   RF,7,RQ_JDUAD                                                    
         AHI   RF,LW_LN2Q          RF=A(first array line data)                  
         AHI   RF,L'UFSDESC        point to data in array entry                 
         LR    RE,R3                                                            
         MHI   RE,L'UFSDESC+UFSDATMX+UFSTYPEL                                   
         AR    RF,RE                                                            
         DROP  RF                                                               
         EX    R1,XJOBF59          match on header?                             
         JE    XJOBF58                                                          
         J     XJOBFN                                                           
                                                                                
XJOBF58  AHI   R3,1                                                             
         CHI   R3,RQ_JDUMX                                                      
         JL    XJOBF55                                                          
         J     XJOBF60                                                          
                                                                                
XJOBF59  CLC   0(0,RF),0(R4)                                                    
                                                                                
XJOBF60  CLI   X#JDSTAT,0          status filter?                               
         JE    XJOBF64                                                          
         TM    SAVEIND,SAVEMST     Aura multipe status?                         
         JNZ   XJOBF62                                                          
         TM    X#JDSTAT,X#JDSTAP   approved? (done upfront)                     
         JNZ   XJOBF64                                                          
         TM    X#JDSTAT,X#JDSTRE   rejected?                                    
         JZ    XJOBF61                                                          
         CLI   X#JBIR,YESQ                                                      
         JNE   XJOBFN                                                           
         J     XJOBF64                                                          
                                                                                
XJOBF61  CLI   X#JBIR,YESQ         submitted                                    
         JE    XJOBFN                                                           
         J     XJOBF64                                                          
                                                                                
XJOBF62  CLI   X#JBIR,YESQ         Job rejected?                                
         JNE   XJOBF64                                                          
         TM    X#JDSTAT,X#JDSTRE   then must have asked for rejected            
         JZ    XJOBFN                                                           
                                                                                
XJOBF64  OC    X#PIDAP,X#PIDAP     check for subm/rej/appr PIDs                 
         JZ    XJOBF66                                                          
         CLC   X#ACTAP,X#PIDAP                                                  
         JNE   XJOBFN                                                           
                                                                                
XJOBF66  OC    X#PIDRJ,X#PIDRJ                                                  
         JZ    XJOBF68                                                          
         CLC   X#ACTRJ,X#PIDRJ                                                  
         JNE   XJOBFN                                                           
                                                                                
XJOBF68  OC    X#PIDSU,X#PIDSU                                                  
         JZ    XJOBF70                                                          
         CLC   X#ACTSU,X#PIDSU                                                  
         JNE   XJOBFN                                                           
                                                                                
XJOBF70  CLC   X#COFF,SPACES       Was office set at job                        
         JH    XJOBF72             Yes                                          
         MVC   X#COFF,X#POFF       No - set it from client/product              
                                                                                
         USING OFFALD,R1                                                        
XJOBF72  L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,X#COFF     Validate current office                      
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL                                                           
         JNE   XJOBFN                                                           
         DROP  R1                                                               
                                                                                
         CLC   RQ_JDOFF,SPACES     apply office filter if passed                
         JNH   XJOBF74                                                          
         CLC   RQ_JDOFF,X#COFF                                                  
         JNE   XJOBFN                                                           
                                                                                
XJOBF74  LA    RE,RQ_JDF1V         Filter on filters                            
         LA    RF,ACTRSAF1                                                      
         LHI   R1,5                                                             
                                                                                
XJOBF80  CLI   0(RE),C' '                                                       
         JNH   XJOBF85                                                          
                                                                                
         CLC   0(1,RF),0(RE)                                                    
         JNE   XJOBFN                                                           
                                                                                
XJOBF85  AHI   RE,1                                                             
         AHI   RF,1                                                             
         JCT   R1,XJOBF80                                                       
                                                                                
XJOBF90  TM    X#JDSTAT,X#JDSTMA   only for 'await my appr' or                  
         JNZ   XJOBF92             multiple status                              
         TM    SAVEIND,SAVEMST                                                  
         JZ    XJOBFY                                                           
         J     XJOBF93                                                          
                                                                                
XJOBF92  TM    X#JDSTAT,X#JDSTRE   also rejected?                               
         JZ    XJOBF93                                                          
         CLI   X#JBIR,YESQ         rejected job?                                
         JE    XJOBF93                                                          
         TM    X#JDSTAT,X#JDSTSU   also submitted?                              
         JNZ   XJOBF93                                                          
         TM    SAVEIND,SAVEPMA     if not exclude if 'my job'                   
         JNZ   XJOBFN                                                           
                                                                                
XJOBF93  TM    ACTRSTAT,ACTSDELT   global checks first                          
         JNZ   XJOBFN                                                           
                                                                                
         DS    0H                  go through each X#JDSTAT and once            
         DS    0H                  OK set flag and take job                     
         TM    X#JDSTAT,X#JDSTMA   > awaiting my approvals                      
         JZ    XJOBF94                                                          
         CLI   X#JBIR,YESQ         skip rejected jobs (see JLNADL50             
         JE    XJOBF94             for 'own' - not implemented)                 
         CLC   X#ACTSU,CCTPID      cannot approve your own jobs                 
         JE    XJOBF94                                                          
         XC    X#JAPP,X#JAPP       (see code at CHKJAL)                         
         LA    RF,ACTKACT                                                       
         LLC   R0,PPROLEN                                                       
         AR    RF,R0                                                            
         MVC   X#MEDC,0(RF)                                                     
         OI    X#GAPIND,X#GAPIDQ+X#GAPIYQ                                       
         GOTOR GETAPP,DMCB,(2,ACTKACT),X#POFF                                   
         JE    XJOBF98                                                          
         NI    X#GAPIND,FF-X#GAPIYQ                                             
                                                                                
XJOBF94  TM    X#JDSTAT,X#JDSTRE   > rejected                                   
         JZ    XJOBF95                                                          
         TM    ACTRSTAT,ACTSDRFT                                                
         JZ    XJOBF95                                                          
         CLI   X#JBIR,YESQ                                                      
         JE    XJOBF98                                                          
                                                                                
XJOBF95  TM    X#JDSTAT,X#JDSTSU   > submitted                                  
         JZ    XJOBF96                                                          
         TM    ACTRSTAT,ACTSDRFT                                                
         JZ    XJOBF96                                                          
         CLI   X#JBIR,YESQ                                                      
         JNE   XJOBF98                                                          
                                                                                
XJOBF96  TM    X#JDSTAT,X#JDSTAP   > approved                                   
         JZ    XJOBF97                                                          
         TM    ACTRSTAT,ACTSDRFT                                                
         JZ    XJOBF98                                                          
                                                                                
XJOBF97  DS    0H                  if failed all checks - skip it               
         J     XJOBFN                                                           
                                                                                
XJOBF98  DS    0H                  end of logic started at XJOBF92              
                                                                                
XJOBFY   LHI   R1,1                                                             
         J     XJOBFX                                                           
XJOBFN   LHI   R1,0                                                             
XJOBFX   DS    0H                                                               
         CHI   R1,1                                                             
         XIT1                                                                   
         LTORG                                                                  
         DROP  R2,R3                                                            
                                                                                
* filter job record for extra names                                             
XNAMFLT  NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*XNAMFLT'                                                      
                                                                                
         CLI   X#JSNAM#,0          skip if no name                              
         JE    XNAMFY                                                           
                                                                                
         L     R2,AIO2             point to SJ job record                       
         AHI   R2,ACTRFST-ACTRECD                                               
         MVC   TEMP,SPACES                                                      
         USING NAMELD,R2                                                        
XNAMF02  CLI   NAMEL,NAMELQ                                                     
         JE    XNAMF04                                                          
         CLI   NAMEL,0                                                          
         JE    XNAMFY              - or die?                                    
         LLC   R0,NAMLN                                                         
         AR    R2,R0                                                            
         J     XNAMF02                                                          
                                                                                
XNAMF04  LA    R3,X#JSNAL1         point to names                               
         LLC   R4,X#JSNAM#                                                      
         LLC   RE,NAMLN                                                         
         SHI   RE,NAMLN1Q                                                       
         MVC   TEMP(0),NAMEREC     Copy name to temp to ensure we keep          
         EX    RE,*-6               name as entered                             
         L     R1,AUINTAB                                                       
XNAMF06  TR    TEMP(0),0(R1)                                                    
         EX    RE,XNAMF06                                                       
                                                                                
XNAMF08  LLC   R0,NAMLN            disregard L'NAMEREC as 99,99% OK             
         SHI   R0,NAMLN1Q                                                       
         LA    RE,TEMP                                                          
         LLC   RF,0(R3)                                                         
         SHI   RF,1                                                             
XNAMF10  EX    RF,XNAMFC                                                        
         JE    XNAMF12                                                          
         AHI   RE,1                                                             
         JCT   R0,XNAMF10                                                       
                                                                                
         USING ACTRECD,R1                                                       
         LLC   RE,PPROLEN                                                       
         LLC   R6,PJOBLEN                                                       
         SR    R6,RE                                                            
         L     R1,AIO2                                                          
         LA    RE,ACTKACT(RE)                                                   
         BASR  R7,0                                                             
         CLC   0(0,RE),L'X#JSNAL2(R3)                                           
         EX    R6,0(R7)                                                         
         JNE   XNAMFN              extra name (filter) not on record            
         DROP  R1                                                               
                                                                                
XNAMF12  AHI   R3,L'X#JSNAL1+L'X#JSNAM1  extra name (filter) matches            
         JCT   R4,XNAMF08                                                       
         J     XNAMFY              all OK                                       
                                                                                
XNAMFC   CLC   0(0,RE),L'X#JSNAL2(R3)                                           
                                                                                
XNAMFY   CR    RB,RB                                                            
         J     *+6                                                              
XNAMFN   LTR   RB,RB                                                            
         XIT1                                                                   
         LTORG                                                                  
         DROP  R2                                                               
                                                                                
* JobList - Job Approvals - User added - status=draft or rejected               
         USING DRAPASD,R2                                                       
JLUDDL   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*JLUDDL*'                                                      
                                                                                
         LA    R2,IOKEY                                                         
         XC    DRAPAS,DRAPAS                                                    
         MVI   DRAPTYP,DRAPTYPQ                                                 
         MVI   DRAPSUB,DRAPSUBQ                                                 
         MVC   DRAPCPY,CUXCPY                                                   
         MVI   DRAPAPS,DRAPDRA                                                  
         MVC   DRAPUAL,PRODUL                                                   
                                                                                
         MVC   SAVEKEY1,DRAPAS                                                  
                                                                                
JLUDDL10 GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         J     JLUDDL20                                                         
                                                                                
JLUDDL15 LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
                                                                                
JLUDDL20 DS    0H                                                               
         JNE   JLUDDLY                                                          
         CLC   DRAPAS(DRAPACT-DRAPAS),SAVEKEY1                                  
         JNE   JLUDDLY                                                          
         CLC   DRAPPID,CCTPID                                                   
         JNE   JLUDDL15                                                         
                                                                                
         CLC   RQ_JDOFF,SPACES     apply office filter if passed                
         JNH   JLUDDL25                                                         
         CLC   RQ_JDOFF,DRAPSOFF                                                
         JNE   JLUDDL15                                                         
                                                                                
         USING OFFALD,R1                                                        
JLUDDL25 L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,DRAPSOFF                                                
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL              validate office                              
         JNE   JLUDDL15                                                         
         MVC   X#POFF,DRAPSOFF                                                  
         DROP  R1                                                               
                                                                                
         MVC   SAVEKEY2,DRAPAS                                                  
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
         MVI   X#GAPIND,0                                                       
                                                                                
         USING ACTRECD,R2                                                       
         L     R2,AIO2                                                          
                                                                                
         TM    ACTRSTAT,ACTSDELT   skip deleted jobs                            
         JNZ   JLUDDL15                                                         
         TM    ACTRSTAT,ACTSCLOS   skip closed jobs                             
         JNZ   JLUDDL15                                                         
                                                                                
         USING JOBELD,R3                                                        
         LA    R3,ACTRFST                                                       
         MVI   BYTE1,NOQ                                                        
                                                                                
JLUDDL30 CLI   JOBEL,JOBELQ                                                     
         JE    JLUDDL40                                                         
         CLI   JOBEL,0                                                          
         JE    JLUDDL50                                                         
                                                                                
JLUDDL35 LLC   R0,JOBLN                                                         
         AR    R3,R0                                                            
         J     JLUDDL30                                                         
                                                                                
JLUDDL40 CLI   JOBLN,JOBLN3Q                                                    
         JL    JLUDDL35                                                         
         MVI   BYTE1,YESQ                                                       
         MVI   BYTE2,RQ_JDT4Q                                                   
         TM    JOBSTA2,JOBSREJ                                                  
         JZ    *+8                                                              
         MVI   BYTE2,RQ_JDT5Q                                                   
         CLC   BYTE2,RQ_JDTYP      if wrong draft/reject status skip            
         JNE   JLUDDL15                                                         
         J     JLUDDL35                                                         
                                                                                
JLUDDL50 CLI   BYTE1,YESQ          skip if no job element found                 
         JNE   JLUDDL15                                                         
                                                                                
         GOTOR GETSVV              get status view values for job               
         GOTOR CHKACT              Check whether we can close this              
                                                                                
         GOTOR LP_APUTO,LP_D       pass out values                              
                                                                                
         CLI   X#HIGH,YESQ         can read sequential?                         
         JNE   JLUDDL15                                                         
                                                                                
         USING DRAPASD,R2                                                       
         LA    R2,IOKEY                                                         
         MVC   DRAPAS,SAVEKEY2     restore passive key                          
         CLC   DRAPPID,XFFS                                                     
         JE    JLUDDL55                                                         
         XR    RE,RE                                                            
         ICM   RE,3,DRAPPID                                                     
         AHI   RE,1                                                             
         STCM  RE,3,DRAPPID                                                     
         J     JLUDDL10                                                         
                                                                                
JLUDDL55 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         J     JLUDDL15                                                         
                                                                                
JLUDDLY  CR    RB,RB                                                            
         XIT1                                                                   
                                                                                
JLUDDLN  LTR   RB,RB                                                            
         XIT1                                                                   
         LTORG                                                                  
         DROP  R2,R3                                                            
                                                                                
* JobList - Job Approvals - Approver rejected                                   
         USING DRAPASD,R2                                                       
JLREDL   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*JLREDL*'                                                      
                                                                                
         LA    R2,IOKEY                                                         
         XC    DRAPAS,DRAPAS                                                    
         MVI   DRAPTYP,DRAPTYPQ                                                 
         MVI   DRAPSUB,DRAPSUBQ                                                 
         MVC   DRAPCPY,CUXCPY                                                   
         MVI   DRAPAPS,DRAPDRA                                                  
         MVC   DRAPUAL,PRODUL                                                   
                                                                                
         MVC   SAVEKEY1,DRAPAS                                                  
                                                                                
JLREDL10 GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         J     JLREDL20                                                         
                                                                                
JLREDL15 LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
                                                                                
JLREDL20 DS    0H                                                               
         JNE   JLREDLY                                                          
         CLC   DRAPAS(DRAPACT-DRAPAS),SAVEKEY1                                  
         JNE   JLREDLY                                                          
                                                                                
         CLC   RQ_JDOFF,SPACES     apply office filter if passed                
         JNH   JLREDL25                                                         
         CLC   RQ_JDOFF,DRAPSOFF                                                
         JNE   JLREDL15                                                         
                                                                                
         USING OFFALD,R1                                                        
JLREDL25 L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,DRAPSOFF                                                
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL              validate office                              
         JNE   JLREDL15                                                         
         MVC   X#POFF,DRAPSOFF                                                  
         DROP  R1                                                               
                                                                                
         MVC   SAVEKEY2,DRAPAS                                                  
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
         MVI   X#GAPIND,0                                                       
                                                                                
         USING ACTRECD,R2                                                       
         L     R2,AIO2                                                          
                                                                                
         TM    ACTRSTAT,ACTSDELT   skip deleted jobs                            
         JNZ   JLREDL15                                                         
         TM    ACTRSTAT,ACTSCLOS   skip closed jobs                             
         JNZ   JLREDL15                                                         
                                                                                
         USING STCELD,R3                                                        
         LA    R3,ACTRFST                                                       
         XR    R0,R0                                                            
         MVI   BYTE1,NOQ                                                        
         MVI   BYTE2,NOQ                                                        
                                                                                
JLREDL30 CLI   STCEL,0                                                          
         JE    JLREDL50                                                         
         CLI   STCEL,JOBELQ                                                     
         JE    JLREDL40                                                         
         CLI   STCEL,STCELQ        STCELs held in AUDRECD, too                  
         JNE   JLREDL35            - see REJECTER (note: REJECT08               
         CLI   STCIND,STCIJOB        STCIND,STCIACT not applied here)           
         JNE   JLREDL35                                                         
         CLI   STCDTO,C'R'         rejection?                                   
         JNE   JLREDL35                                                         
         CLC   STCPERS,CCTPID                                                   
         JNE   JLREDL35                                                         
         MVI   BYTE2,YESQ                                                       
                                                                                
JLREDL35 IC    R0,STCLN                                                         
         AR    R3,R0                                                            
         J     JLREDL30                                                         
                                                                                
         USING JOBELD,R3                                                        
JLREDL40 CLI   JOBLN,JOBLN3Q                                                    
         JL    JLREDL35                                                         
         TM    JOBSTA2,JOBSREJ                                                  
         JZ    JLREDL35                                                         
         MVI   BYTE1,YESQ                                                       
         J     JLREDL35                                                         
                                                                                
JLREDL50 CLI   BYTE1,YESQ          skip if no rejection found                   
         JNE   JLREDL15                                                         
                                                                                
         CLI   BYTE2,YESQ          if user did reject then no need for          
         JE    JLREDL55            REJECTER                                     
                                                                                
         GOTOR REJECTER,ACTKULA                                                 
         MVC   IOKEY,SAVEKEY2      reestablish IO sequence                      
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         MVC   BYTE2,X#CONREJ                                                   
         CLI   X#CONREJ,YESQ                                                    
         JNE   JLREDL15                                                         
                                                                                
JLREDL55 GOTOR GETSVV              get status view values for job               
         GOTOR CHKACT              Check whether we can close this              
                                                                                
         GOTOR LP_APUTO,LP_D       pass out values                              
                                                                                
         CLI   X#HIGH,YESQ         can read sequential?                         
         JNE   JLREDL15                                                         
                                                                                
         USING DRAPASD,R2                                                       
         LA    R2,IOKEY                                                         
         MVC   DRAPAS,SAVEKEY2     restore passive key                          
         CLC   DRAPPID,XFFS                                                     
         JE    JLREDL60                                                         
         XR    RE,RE                                                            
         ICM   RE,3,DRAPPID                                                     
         AHI   RE,1                                                             
         STCM  RE,3,DRAPPID                                                     
         J     JLREDL10                                                         
                                                                                
JLREDL60 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         J     JLREDL15                                                         
                                                                                
JLREDLY  CR    RB,RB                                                            
         XIT1                                                                   
                                                                                
JLREDLN  LTR   RB,RB                                                            
         XIT1                                                                   
         LTORG                                                                  
         DROP  R2                                                               
                                                                                
* JobList - Job Approvals - User added - status=approved                        
         USING PIDRECD,R2                                                       
JLAPDL   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*JLAPDL*'                                                      
                                                                                
         LA    R2,IOKEY                                                         
         XC    PIDKEY,PIDKEY                                                    
         MVI   PIDKTYP,PIDKTYPQ                                                 
         MVI   PIDKSUB,PIDKSUBQ                                                 
         MVC   PIDKCPY,CUXCPY                                                   
         MVC   PIDKPID,CCTPID                                                   
         MVI   PIDKSTYP,PIDKJOBQ                                                
         MVI   PIDKJST,PIDKJSAQ    approver's approvals                         
                                                                                
         CLI   RQ_JDTYP,RQ_JDT1Q                                                
         JE    JLAPDL05                                                         
         MVI   PIDKJST,PIDKJSSQ    user added records                           
         CLI   RQ_JDTYP,RQ_JDT7Q   User assigned                                
         JNE   JLAPDL05                                                         
         MVI   PIDKJST,PIDKJSTQ    user assigned records                        
*                                  Build key for filtering                      
         MVC   SAVEKEY4,SPACES                                                  
         CLC   RQ_JDCLC,SPACES     Any client code?                             
         JNH   JLAPDL05                                                         
         LA    R1,SAVEKEY4+ACTKACT-ACTRECD                                      
         LLC   RF,PCLILEN                                                       
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   0(0,R1),RQ_JDCLC                                                 
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         AR    R1,RF                                                            
*                                                                               
         CLC   RQ_JDPRO,SPACES     Any product code?                            
         JNH   JLAPDL05                                                         
         LLC   RF,PPROLEN                                                       
         LLC   RE,PCLILEN                                                       
         SR    RF,RE                                                            
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   0(0,R1),RQ_JDPRO                                                 
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         AR    R1,RF                                                            
*                                                                               
         CLC   RQ_JDJOB,SPACES     Any job code?                                
         JNH   JLAPDL05                                                         
         LLC   RF,PJOBLEN                                                       
         LLC   RE,PPROLEN                                                       
         SR    RF,RE                                                            
         BCTR  RF,0                                                             
         BASR  RE,0                                                             
         MVC   0(0,R1),RQ_JDJOB                                                 
         EX    RF,0(RE)                                                         
*                                                                               
JLAPDL05 MVC   SAVEKEY1,PIDKEY                                                  
                                                                                
JLAPDL10 GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         J     JLAPDL20                                                         
                                                                                
JLAPDL15 LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
                                                                                
JLAPDL20 DS    0H                                                               
         JNE   JLAPDLY                                                          
         CLC   PIDKEY(PIDKACC-PIDKEY),SAVEKEY1                                  
         JNE   JLAPDLY                                                          
         CLI   RQ_JDTYP,RQ_JDT7Q   User assigned skip backdate max              
         JE    *+14                                                             
         CLC   PIDKADAT,X#13MDAT   13 months backwards maximum                  
         JL    JLAPDL15                                                         
         CLI   RQ_JDTYP,RQ_JDT7Q   User assigned list call                      
         JNE   JLAPDL22                                                         
         GOTOR XJOBPID             Filter job directory                         
         JNE   JLAPDL15                                                         
         J     JLAPDL24                                                         
*                                                                               
JLAPDL22 TM    PIDKSTAT,ACTSCLOS+ACTSLOCK                                       
         JNZ   JLAPDL15                                                         
*                                                                               
JLAPDL24 CLC   RQ_JDOFF,SPACES     apply office filter if passed                
         JNH   JLAPDL25                                                         
*&&UK*&& CLC   RQ_JDOFF,PIDKEY+ACTKSUFA-ACTRECD                                 
*&&US*&& CLC   RQ_JDOFF,PIDKEY+ACTKSOFF-ACTRECD                                 
         JNE   JLAPDL15                                                         
*                                                                               
         USING OFFALD,R1                                                        
JLAPDL25 L     R1,AOFFAREA                                                      
*&&UK*&& MVC   OFFAOFFC,PIDKEY+ACTKSUFA-ACTRECD                                 
*&&US*&& MVC   OFFAOFFC,PIDKEY+ACTKSOFF-ACTRECD                                 
         MVC   X#POFF,OFFAOFFC                                                  
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL              validate office                              
         JNE   JLAPDL15                                                         
         DROP  R1                                                               
                                                                                
JLAPDL30 MVC   SAVEKEY2,PIDKEY                                                  
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
         MVI   X#GAPIND,0                                                       
                                                                                
         USING ACTRECD,R2                                                       
         L     R2,AIO2                                                          
         TM    ACTRSTAT,ACTSDELT   skip deleted jobs                            
         JNZ   JLAPDL15                                                         
         GOTOR XNAMFLT             extra name filtering                         
         JNE   JLAPDL15                                                         
         GOTOR XJOBFLT             filter job record                            
         JNE   JLAPDL15                                                         
*                                                                               
         GOTOR GETSVV              get status view values for job               
         CLI   RQ_JDTYP,RQ_JDT7Q   User assigned                                
         JNE   JLAPDL32                                                         
         GOTOR FLTLIM,ACTKACT      filter on limit lists                        
         JNE   JLAPDL34                                                         
JLAPDL32 GOTOR CHKACT              Check whether we can close this              
                                                                                
         GOTOR LP_APUTO,LP_D       pass out values                              
                                                                                
JLAPDL34 CLI   X#HIGH,YESQ         can read sequential?                         
         JNE   JLAPDL15                                                         
                                                                                
         USING PIDRECD,R2                                                       
         LA    R2,IOKEY                                                         
         MVC   PIDKEY,SAVEKEY2     restore passive key                          
         MVI   PIDKACC+L'PIDKACC,FF                                             
         J     JLAPDL10                                                         
                                                                                
JLAPDLY  CR    RB,RB                                                            
         XIT1                                                                   
                                                                                
JLAPDLN  LTR   RB,RB                                                            
         XIT1                                                                   
         LTORG                                                                  
         DROP  R2                                                               
                                                                                
* JobList - Get job values in status view                                       
         USING ACTRECD,R2                                                       
GETSVV   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*GETSVV*'                                                      
                                                                                
         MVI   X#HIGH,NOQ          default to read sequential                   
                                                                                
         L     R2,AIO2             point to job record                          
         L     R0,AIO6             Copy SJ job to AIO6                          
         LA    R1,IOLENQ                                                        
         LR    RE,R2                                                            
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         LA    R0,JD_VALS          clear output values                          
         LHI   R1,JD_LNQ                                                        
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         LLC   RE,PPROLEN          extract job code                             
         LA    RE,ACTKACT(RE)                                                   
         MVC   JD_JOB,0(RE)                                                     
         MVC   JD_OFF,X#POFF       get office from passive                      
         MVC   JD_MED,JD_JOB       get media code                               
         ZAP   JD_FEE,PZERO        FEES                                         
                                                                                
         CLI   RQ_JDGAO,YESQ                                                    
         JE    GETSVV05                                                         
         MVC   JD_F15,ACTRSAF1     pass filters 1 to 5                          
                                                                                
GETSVV05 MVC   JD_CLI,SPACES       extract client and product codes             
         LLC   RE,PCLILEN                                                       
         LR    RF,RE                                                            
         SHI   RE,1                                                             
         MVC   JD_CLI(0),ACTKACT                                                
         EX    RE,*-6                                                           
         LA    RE,ACTKACT+1(RE)                                                 
         LLC   R1,PPROLEN                                                       
         SR    R1,RF                                                            
         SHI   R1,1                                                             
         MVC   JD_PRO,0(RE)                                                     
         EX    R1,*-6                                                           
                                                                                
         USING NAMELD,R3                                                        
         LA    R3,ACTRFST          get job details                              
                                                                                
         MVC   JD_STA,=C'**A  N'   job status (def=approved)                    
         TM    ACTRSTA,ACTSCLOS                                                 
         JZ    *+8                                                              
         MVI   JD_STA+0,C'C'                                                    
         TM    ACTRSTA,ACTSLOCK                                                 
         JZ    *+8                                                              
         MVI   JD_STA+1,C'L'                                                    
         TM    ACTRSTA,ACTSDRFT                                                 
         JZ    *+8                                                              
         MVI   JD_STA+2,C'D'       (draft, see below for rejected)              
                                                                                
         XC    X#JCRE,X#JCRE                                                    
                                                                                
GETSVV10 CLI   NAMEL,NAMELQ                                                     
         JE    GETSVV20                                                         
         CLI   NAMEL,ASTELQ                                                     
         JE    GETSVV21                                                         
         CLI   NAMEL,RSTELQ                                                     
         JE    GETSVV22                                                         
         CLI   NAMEL,JOBELQ                                                     
         JE    GETSVV25                                                         
         CLI   NAMEL,FFTELQ                                                     
         JE    GETSVV33                                                         
         CLI   NAMEL,PACELQ                                                     
         JE    GETSVV35                                                         
         CLI   NAMEL,SCIELQ                                                     
         JE    GETSVV37                                                         
         CLI   NAMEL,RACELQ                                                     
         JE    GETSVV40                                                         
         CLI   NAMEL,0                                                          
         JE    GETSVV48                                                         
                                                                                
GETSVV15 LLC   R0,NAMLN                                                         
         AR    R3,R0                                                            
         J     GETSVV10                                                         
                                                                                
GETSVV20 LLC   RE,NAMLN                                                         
         SHI   RE,NAMLN1Q+1                                                     
         LTR   RE,RE                                                            
         JM    GETSVV15                                                         
         MVC   JD_JON(0),NAMEREC                                                
         EX    RE,*-6                                                           
         J     GETSVV15                                                         
                                                                                
         USING ASTELD,R3                                                        
GETSVV21 MVI   JD_IFU,NOQ                                                       
         TM    ASTSTAT1,ASTISFOR   Is foreign language user                     
         JZ    GETSVV15                                                         
         MVI   JD_IFU,YESQ                                                      
         J     GETSVV15                                                         
                                                                                
         USING RSTELD,R3                                                        
GETSVV22 MVI   JD_LOCES,NOQ                                                     
         MVI   JD_LOCOR,NOQ                                                     
         MVI   JD_LOCEX,NOQ                                                     
         MVI   JD_LOCBI,NOQ                                                     
         MVI   JD_LOCAD,NOQ                                                     
         MVI   JD_LOCTI,NOQ                                                     
         MVI   JD_BEST,NOQ                                                      
         CLI   RSTLN,RSTLN3Q                                                    
         JL    GETSVV15                                                         
         TM    RSTSTAT6,RSTSMCSE       Brandocean estimates on job?             
         JZ    *+8                                                              
         MVI   JD_BEST,YESQ                                                     
         TM    SAVEIND,SAVEAUR         Aura - merge t/s lock status             
         JZ    GETSVV23                                                         
         TM    RSTSTAT5,RSTSNOTS                                                
         JZ    GETSVV23                                                         
         MVI   JD_LOCTI,YESQ                                                    
                                                                                
GETSVV23 TM    RSTLSTAT,RSTLSESQ       LOCKED FROM ESTIMATES                    
         JZ    *+8                                                              
         MVI   JD_LOCES,YESQ                                                    
         TM    RSTLSTAT,RSTLSORQ       LOCKED FROM ORDERS                       
         JZ    *+8                                                              
         MVI   JD_LOCOR,YESQ                                                    
         TM    RSTLSTAT,RSTLSBIQ       LOCKED FROM BILLING                      
         JZ    *+8                                                              
         MVI   JD_LOCBI,YESQ                                                    
         TM    RSTLSTAT,RSTLSTIQ       LOCKED FROM TIMESHEETS                   
         JZ    *+8                                                              
         MVI   JD_LOCTI,YESQ                                                    
         TM    RSTLSTAT,RSTLSADQ       LOCKED FROM ADJUSTMENTS                  
         JZ    *+8                                                              
         MVI   JD_LOCAD,YESQ                                                    
         TM    RSTLSTAT,RSTLSEXQ       LOCKED FROM EXPENSES                     
         JZ    *+8                                                              
         MVI   JD_LOCEX,YESQ                                                    
         J     GETSVV15                                                         
                                                                                
         USING JOBELD,R3                                                        
GETSVV25 CLI   RQ_JDGAO,YESQ                                                    
         JE    *+10                                                             
         MVC   JD_CDT,JOBCDATE                                                  
         MVC   JD_ODT,JOBADATE                                                  
         MVI   JD_MAST,NOQ                                                      
         TM    JOBSTA2,JOBSMST     JOB IS A MASTER JOB                          
         JZ    *+8                                                              
         MVI   JD_MAST,YESQ                                                     
         MVC   JD_IDN,SPACES                                                    
         CLI   JOBLN,JOBLN2Q                                                    
         JL    GETSVV15                                                         
         XOUT  JOBREVNO,JD_IDN,2                                                
         OC    JOBODATE,JOBODATE                                                
         JZ    GETSVV30                                                         
         MVC   JD_ODT,JOBODATE                                                  
                                                                                
GETSVV30 CLI   JOBLN,JOBLN3Q                                                    
         JL    GETSVV15                                                         
         XOUT  JOBSRCES,JD_STA+3,1 xout job source                              
         TM    JOBSTA2,JOBSREJ                                                  
         JZ    GETSVV15                                                         
         MVI   JD_STA+2,C'R'       (set status to rejected)                     
         J     GETSVV15                                                         
                                                                                
         USING FFTELD,R3                                                        
GETSVV33 CLI   RQ_JDGAO,YESQ                                                    
         JE    GETSVV15                                                         
         CLI   FFTTYPE,FFTTCAMP                                                 
         JNE   GETSVV15                                                         
         MVC   JD_CAM,FFTDATA                                                   
         J     GETSVV15                                                         
                                                                                
         USING PACELD,R3                                                        
GETSVV35 CLI   RQ_JDGAO,YESQ                                                    
         JE    GETSVV15                                                         
         CLC   PACDATE,JD_LAD                                                   
         JNH   GETSVV15                                                         
         MVC   JD_LAD,PACDATE                                                   
         MVC   JD_LAC,PACPERS                                                   
         J     GETSVV15                                                         
                                                                                
         USING SCIELD,R3                                                        
GETSVV37 CLI   SCITYPE,SCITFEEB    FEES/BUDGETS                                 
         JNE   GETSVV38                                                         
         ZAP   JD_FEE,SCIAMNT                                                   
         J     GETSVV15                                                         
                                                                                
GETSVV38 CLI   SCITYPE,SCITCPAT    Payment Total Amount                         
         JNE   GETSVV15                                                         
         CLI   RQ_JDPAY,YESQ                                                    
         JNE   GETSVV15                                                         
         ZAP   JD_PAYTA,SCIAMNT                                                 
         J     GETSVV15                                                         
                                                                                
         USING RACELD,R3                                                        
GETSVV40 LA    RE,JD_APX                                                        
         CLI   RACTYPE,RACTAPP                                                  
         JE    GETSVV46                                                         
         LA    RE,JD_LAX                                                        
         CLI   RACTYPE,RACTCHA                                                  
         JE    GETSVV44                                                         
         LA    RE,JD_CPX                                                        
         CLI   RACTYPE,RACTADD                                                  
         JNE   GETSVV15                                                         
         MVC   X#JCRE,RACPERS                                                   
         J     GETSVV46                                                         
                                                                                
GETSVV44 CLC   RACDATE,JD_LAD                                                   
         JNH   GETSVV15                                                         
         MVC   JD_LAD,RACDATE                                                   
                                                                                
GETSVV46 MVC   0(2,RE),RACPERS                                                  
         J     GETSVV15                                                         
                                                                                
GETSVV48 CLI   RQ_JDTYP,RQ_JDT1Q                                                
         JE    GETSVV50                                                         
         TM    ACTRSTA,ACTSDRFT                                                 
         JZ    GETSVV50                                                         
         MVI   JD_STA+5,YESQ                                                    
         CLI   RQ_JDTYP,RQ_JDT3Q                                                
         JE    GETSVV50                                                         
         MVC   X#MEDC,JD_MED                                                    
         MVI   X#HIGH,YESQ                                                      
         TM    X#GAPIND,X#GAPIDQ   done already?                                
         JZ    GETSVV49                                                         
         TM    X#GAPIND,X#GAPIYQ   good return?                                 
         JNZ   GETSVV50                                                         
         MVI   JD_STA+5,NOQ                                                     
         J     GETSVV50                                                         
                                                                                
GETSVV49 GOTOR GETAPP,DMCB,(2,ACTKACT),JD_OFF                                   
         JE    GETSVV50                                                         
         MVI   JD_STA+5,NOQ                                                     
                                                                                
LAST     USING JD_VALS,R4                                                       
GETSVV50 LA    R4,OLDJDTL          resolve names                                
                                                                                
         CLI   RQ_JDGAO,YESQ                                                    
         JE    GETSVV70                                                         
                                                                                
         CLC   LAST.JD_MED,JD_MED  same media code?                             
         JNE   GETSVV52                                                         
***      TM    SAVEIND,SAVEAUR     Aura running?                                
***      JNZ   GETSVV51                                                         
***      MVC   JD_MEN,UNIQUEQ                                                   
***      J     GETSVV58                                                         
                                                                                
GETSVV51 MVC   JD_MEN,LAST.JD_MEN                                               
         J     GETSVV58                                                         
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
GETSVV52 XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         MVI   TSB.JSBDTYP,JSBDTMQ                                              
         MVC   TSB.JSBDCOD,SPACES                                               
         MVC   TSB.JSBDCOD(L'JD_MED),JD_MED                                     
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         JE    GETSVV53                                                         
         TM    TSARERRS,TSERNF     Test record not found                        
         JNZ   GETSVV54                                                         
         DC    H'0'                Other error                                  
                                                                                
GETSVV53 MVC   JD_MEN,TSB.JSBDNAM                                               
         MVC   X#MEDGRP,TSB.JSBDMGR                                             
         J     GETSVV58                                                         
                                                                                
         USING PMDRECD,RE                                                       
GETSVV54 LA    RE,IOKEY            read media code record                       
         MVC   PMDKEY,SPACES                                                    
         MVI   PMDKTYP,PMDKTYPQ                                                 
         MVC   PMDKCPY,CUXCPY                                                   
         MVC   PMDKMED,JD_MED                                                   
         MVI   X#HIGH,YESQ                                                      
         MVI   X#MEDGRP,0                                                       
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JNE   GETSVV57                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JNE   *+2                                                              
                                                                                
         L     RE,AIO3                                                          
         LA    RE,PMDRFST                                                       
         USING PMDELD,RE                                                        
         XR    R0,R0                                                            
                                                                                
GETSVV55 CLI   PMDEL,PMDELQ                                                     
         JE    GETSVV56                                                         
         CLI   PMDEL,0                                                          
         JE    GETSVV57                                                         
         IC    R0,PMDLN                                                         
         AR    RE,R0                                                            
         J     GETSVV55                                                         
                                                                                
GETSVV56 MVC   JD_MEN,PMDDESC                                                   
         MVC   X#MEDGRP,PMDGRP                                                  
         DROP  RE                                                               
                                                                                
GETSVV57 XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         LHI   R1,JSBDLNQ                                                       
         STH   R1,TSB.JSBDLEN                                                   
         MVI   TSB.JSBDTYP,JSBDTMQ                                              
         MVC   TSB.JSBDCOD,SPACES                                               
         MVC   TSB.JSBDCOD(L'JD_MED),JD_MED                                     
         MVC   TSB.JSBDNAM,JD_MEN                                               
         MVC   TSB.JSBDOGR,X#MEDGRP                                             
         GOTOR GOTSAR,DMCB,('TSAADD',0)  add media to buffer                    
         JE    GETSVV58                                                         
         TM    TSARERRS,TSEEOF     buffer full - so it is ...                   
         JNZ   GETSVV58                                                         
         DC    H'0'                duplicate key                                
         DROP  TSB                                                              
                                                                                
GETSVV58 CLC   JD_OFF,SPACES       skip if empty                                
         JNH   GETSVV70                                                         
         CLC   LAST.JD_OFF,JD_OFF                                               
         JNE   GETSVV62                                                         
***      TM    SAVEIND,SAVEAUR     Aura running?                                
***      JNZ   GETSVV60                                                         
***      MVC   JD_OFN,UNIQUEQ                                                   
***      J     GETSVV70                                                         
                                                                                
GETSVV60 MVC   JD_OFN,LAST.JD_OFN                                               
         J     GETSVV70                                                         
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
GETSVV62 XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         MVI   TSB.JSBDTYP,JSBDTOQ                                              
         MVC   TSB.JSBDCOD,SPACES                                               
         MVC   TSB.JSBDCOD(L'JD_OFF),JD_OFF                                     
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         JE    GETSVV64                                                         
         TM    TSARERRS,TSERNF     Test record not found                        
         JNZ   GETSVV65                                                         
         DC    H'0'                Other error                                  
                                                                                
GETSVV64 MVC   JD_OFN,TSB.JSBDNAM                                               
         MVC   X#OFFGRP,TSB.JSBDOGR                                             
         J     GETSVV70                                                         
                                                                                
GETSVV65 MVC   TEMP2(2),JD_OFF     get office name via 2D or OFFREC             
         GOTOR (#GETOFN,AGETOFN)                                                
         MVI   X#HIGH,YESQ                                                      
         MVC   JD_OFN,TEMP2                                                     
         MVI   X#OFFGRP,0                                                       
                                                                                
         USING OGRRECD,RE          BUILD KEY OF OFFICE RECORD                   
         LA    RE,IOKEY                                                         
         MVI   X#OFFGRP,0                                                       
         XC    OGRKEY,OGRKEY                                                    
         MVI   OGRKTYP,OGRKTYPQ                                                 
         MVI   OGRKSUB,OGRKOFFQ                                                 
         MVC   OGRKCPY,CUXCPY                                                   
         MVC   OGRKUNT(2),PRODUL                                                
         MVC   OGRKOFC,X#COFF                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         JNE   GETSVV69                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         JNE   *+2                                                              
                                                                                
         L     RE,AIO3                                                          
         LA    RE,OGRRFST                                                       
         USING PGRELD,RE                                                        
         XR    R0,R0                                                            
GETSVV66 CLI   PGREL,0                                                          
         JE    GETSVV69                                                         
         CLI   PGREL,PGRELQ                                                     
         JE    GETSVV67                                                         
         IC    R0,PGRLN                                                         
         AR    RE,R0                                                            
         J     GETSVV66                                                         
                                                                                
GETSVV67 MVC   X#OFFGRP,PGRCODE    set office group                             
         DROP  RE                                                               
                                                                                
GETSVV69 XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         LHI   R1,JSBDLNQ                                                       
         STH   R1,TSB.JSBDLEN                                                   
         MVI   TSB.JSBDTYP,JSBDTOQ                                              
         MVC   TSB.JSBDCOD,SPACES                                               
         MVC   TSB.JSBDCOD(L'JD_OFF),JD_OFF                                     
         MVC   TSB.JSBDNAM,JD_OFN                                               
         MVC   TSB.JSBDOGR,X#OFFGRP                                             
         GOTOR GOTSAR,DMCB,('TSAADD',0)  add media to buffer                    
         JE    GETSVV70                                                         
         TM    TSARERRS,TSEEOF     buffer full - so it is ...                   
         JNZ   GETSVV70                                                         
         DC    H'0'                duplicate key                                
         DROP  TSB                                                              
                                                                                
GETSVV70 CLC   LAST.JD_CLI,JD_CLI  same client?                                 
         JNE   GETSVV72                                                         
***      TM    SAVEIND,SAVEAUR     Aura running?                                
***      JNZ   GETSVV71                                                         
***      MVC   JD_CLN,UNIQUEQ                                                   
***      J     GETSVV76                                                         
                                                                                
GETSVV71 MVC   JD_CLN,LAST.JD_CLN                                               
         J     GETSVV76                                                         
                                                                                
* > could buffer client and product for GETOPT                                  
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
GETSVV72 XC    LAST.JD_PRO,LAST.JD_PRO                                          
         CLC   ELESDCLI,JD_CLI     buffered?                                    
         JE    GETSVV75                                                         
         XC    LAST.JD_PRO,LAST.JD_PRO                                          
         CLI   X#TSAYN,YESQ        TSAR required?                               
         JNE   GETSVV74                                                         
         XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         MVI   TSB.JSBDTYP,JSBDTCQ                                              
         MVC   TSB.JSBDCOD,SPACES                                               
         MVC   TSB.JSBDCOD(L'JD_CLI),JD_CLI                                     
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         JE    GETSVV73                                                         
         TM    TSARERRS,TSERNF     Test record not found                        
         JNZ   GETSVV74                                                         
         DC    H'0'                Other error                                  
                                                                                
GETSVV73 MVC   ELESDCST,TSB.JSBDSTA Save values                                 
         MVC   ELESDCOF,TSB.JSBDOFF                                             
         MVC   ELESDCLN,TSB.JSBDNAM                                             
         MVC   ELESDCXD,TSB.JSBDXDB                                             
         XC    ELESDPRO(ELESPLNQ),ELESDPRO                                      
         MVC   X#HOFF,ELESDCOF                                                  
         MVC   X#POFF,ELESDCOF                                                  
         MVC   JD_CLN,ELESDCLN                                                  
         J     GETSVV76                                                         
         DROP  TSB                                                              
                                                                                
GETSVV74 DS    0H                                                               
         L     R0,AIO1             copy AIO2 into AIO1                          
         LA    R1,IOLENQ                                                        
         L     RE,AIO2                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         GOTOR CASCLI,0            Check and set client                         
         MVC   JD_CLN,ELESDCLN                                                  
         L     R0,AIO2             copy AIO1 into AIO2                          
         LA    R1,IOLENQ                                                        
         L     RE,AIO1                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         J     GETSVV76                                                         
                                                                                
GETSVV75 MVC   JD_CLN,ELESDCLN                                                  
                                                                                
GETSVV76 CLC   LAST.JD_PRO,JD_PRO  same product and client?                     
         JNE   GETSVV78                                                         
***      TM    SAVEIND,SAVEAUR     Aura running?                                
***      JNZ   GETSVV77                                                         
***      MVC   JD_PRN,UNIQUEQ                                                   
***      J     GETSVV82                                                         
                                                                                
GETSVV77 MVC   JD_PRN,LAST.JD_PRN                                               
         J     GETSVV82                                                         
                                                                                
TSB      USING JSBD_D,CSVKEY3                                                   
GETSVV78 CLC   ELESDPRO,JD_PRO     buffered?                                    
         JE    GETSVV80                                                         
         CLI   X#TSAYN,YESQ        TSAR required?                               
         JNE   GETSVV81                                                         
         XC    CSVKEY3,CSVKEY3     (CSVKEY3/CSVKEY4)                            
         MVI   TSB.JSBDTYP,JSBDTCQ                                              
         MVC   TSB.JSBDCOD,SPACES                                               
         LLC   R1,PPROLEN                                                       
         SHI   R1,1                                                             
         MVC   TSB.JSBDCOD(0),ACTKACT                                           
         EX    R1,*-6                                                           
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         JE    GETSVV79                                                         
         TM    TSARERRS,TSERNF     Test record not found                        
         JNZ   GETSVV81                                                         
         DC    H'0'                Other error                                  
                                                                                
GETSVV79 MVC   ELESDPST,TSB.JSBDSTA Save values                                 
         MVC   ELESDPOF,TSB.JSBDOFF                                             
         MVC   ELESDPRN,TSB.JSBDNAM                                             
         MVC   ELESDPXD,TSB.JSBDXDB                                             
         MVC   X#POFF,ELESDPOF                                                  
                                                                                
GETSVV80 MVC   JD_PRN,ELESDPRN                                                  
         J     GETSVV82                                                         
         DROP  TSB                                                              
                                                                                
GETSVV81 DS    0H                                                               
         L     R0,AIO1             copy AIO2 into AIO1                          
         LA    R1,IOLENQ                                                        
         L     RE,AIO2                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
         GOTOR CASPRO,0            Check and set product                        
         MVC   JD_PRN,ELESDPRN                                                  
         L     R0,AIO2             copy AIO1 into AIO2                          
         LA    R1,IOLENQ                                                        
         L     RE,AIO1                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
GETSVV82 CLC   LAST.JD_CPX,JD_CPX  same creator?                                
         JNE   GETSVV84                                                         
         OC    JD_CPX,JD_CPX                                                    
         JZ    GETSVV85                                                         
***      TM    SAVEIND,SAVEAUR     Aura running?                                
***      JNZ   GETSVV83                                                         
***      MVC   JD_CPC,UNIQUEQ                                                   
***      MVC   JD_CPF,UNIQUEQ                                                   
***      MVC   JD_CPL,UNIQUEQ                                                   
***      MVC   JD_CPM,UNIQUEQ                                                   
***      J     GETSVV85                                                         
                                                                                
GETSVV83 MVC   JD_CPC,LAST.JD_CPC                                               
         MVC   JD_CPF,LAST.JD_CPF                                               
         MVC   JD_CPL,LAST.JD_CPL                                               
         MVC   JD_CPM,LAST.JD_CPM                                               
         J     GETSVV85                                                         
                                                                                
GETSVV84 GOTOR SOGPER,JD_CPX       Set or get person details                    
                                                                                
GETSVV85 CLI   RQ_JDGAO,YESQ                                                    
         JE    GETSVVX                                                          
                                                                                
         CLC   LAST.JD_APX,JD_APX  same approver?                               
         JNE   GETSVV87                                                         
         OC    JD_APX,JD_APX                                                    
         JZ    GETSVV88                                                         
***      TM    SAVEIND,SAVEAUR     Aura running?                                
***      JNZ   GETSVV86                                                         
***      MVC   JD_APC,UNIQUEQ                                                   
***      MVC   JD_APF,UNIQUEQ                                                   
***      MVC   JD_APL,UNIQUEQ                                                   
***      MVC   JD_APM,UNIQUEQ                                                   
***      J     GETSVV88                                                         
                                                                                
GETSVV86 MVC   JD_APC,LAST.JD_APC                                               
         MVC   JD_APF,LAST.JD_APF                                               
         MVC   JD_APL,LAST.JD_APL                                               
         MVC   JD_APM,LAST.JD_APM                                               
         J     GETSVV88                                                         
                                                                                
GETSVV87 GOTOR SOGPER,JD_APX       Set or get person details                    
                                                                                
GETSVV88 OC    JD_LAX,JD_LAX                                                    
         JNZ   GETSVV91                                                         
         CLC   JD_LAC,SPACES                                                    
         JNH   GETSVV94                                                         
         CLC   JD_LAC,LAST.JD_LAC                                               
         JNE   GETSVV90                                                         
***      TM    SAVEIND,SAVEAUR     Aura running?                                
***      JNZ   GETSVV89                                                         
***      MVC   JD_LAF,UNIQUEQ                                                   
***      MVC   JD_LAL,UNIQUEQ                                                   
***      MVC   JD_LAM,UNIQUEQ                                                   
***      J     GETSVV94                                                         
                                                                                
GETSVV89 MVC   JD_LAF,LAST.JD_LAF                                               
         MVC   JD_LAL,LAST.JD_LAL                                               
         MVC   JD_LAM,LAST.JD_LAM                                               
         J     GETSVV94                                                         
                                                                                
GETSVV90 GOTOR SOGPCO,JD_LAX       Set or get person details from code          
         J     GETSVV94                                                         
                                                                                
GETSVV91 CLC   JD_LAX,LAST.JD_LAX                                               
         JNE   GETSVV92                                                         
         MVC   JD_LAC,LAST.JD_LAC                                               
         MVC   JD_LAF,LAST.JD_LAF                                               
         MVC   JD_LAL,LAST.JD_LAL                                               
         MVC   JD_LAM,LAST.JD_LAM                                               
         J     GETSVV94                                                         
                                                                                
GETSVV92 GOTOR SOGPER,JD_LAX       Set or get person details                    
                                                                                
         USING GOBLOCKD,RF                                                      
GETSVV94 MVI   X#HIGH,YESQ                                                      
         L     RF,AGOBLOCB                                                      
                                                                                
         XC    GOADM(GOABUFF-GOADM),GOADM                                       
         XC    GOADETS(GOACOVL-GOADETS),GOADETS                                 
                                                                                
         MVC   GOADM,VDATAMGR                                                   
         MVC   GOAEXT,AGOXBLCK                                                  
         MVC   GOABEXT,AGOBBLCK                                                 
         L     RE,ATWA                                                          
         LA    RE,2304+FALINKDL(RE)                                             
         ST    RE,GOABUFF          A(AFTER FALINK BLOCK)                        
         L     RE,=AL4(TWAMAXRL-(FALINKDL+2304))   MAX L'TWA                    
         ST    RE,GOLBUFF                                                       
         TM    LP_FLAG,LP_FOFFL                                                 
         JNZ   GETSVV97             OFFLINE                                     
*                                                                               
         MVC   GOABUFF,ATIA         USE TIA ONLINE                              
         MVC   GOLBUFF,=AL4(TWAMAXRL)   SHOULD BE OK, TIA IS 14K?               
*                                                                               
*        MVC   GOABUFF,ATWA                                                     
*        MVC   GOLBUFF,=AL4(TWAMAXRL)                                           
GETSVV97 DS    0H                                                               
         MVC   GOSELCUL,ACTKEY                                                  
         MVI   GOSELLEV,0                                                       
         MVC   GOSELCLI,SPACES                                                  
         MVC   GOSELCLI(5),JD_CLI                                               
         MVC   GOSELPRO,SPACES                                                  
*&&UK*&& MVC   GOSELPRO(2),JD_PRO                                               
*&&US*&& MVC   GOSELPRO(L'JD_PRO),JD_PRO                                        
         MVC   GOSELJOB,JD_JOB                                                  
                                                                                
*        MVC   GOACLI,AIO4                                                      
*        MVC   GOAPRO,AIO5                                                      
*        MVC   GOAJOB,AIO6                                                      
*        MVC   GOACOMP,AIO8                                                     
*        MVC   GOALEDG,AIO7                                                     
                                                                                
***      LA    R1,ES_BUFF          GETOPT.PUTVAL8 can corrupt storage           
***      ST    R1,GOAFROM                                                       
                                                                                
*&&UK*&& LA    R1,TEMP             none emulated IOs + skip w/c level +         
*&&UK*&& ST    R1,GOADETS          TEMP+TEMP2 for extra details block           
                                                                                
         GOTOR SETXDB,DMCB,TEMP,0                                               
                                                                                
         OI    GOSPEC3,GOSPNERQ+GOSPSWLQ                                        
*&&UK*&& OI    GOSPEC3,GOSPXDPQ                                                 
***      OI    GOSPEC3,GOSPNERQ+GOSPSWLQ+GOSPXDPQ                               
*&&UK*&& MVC   GOSELOFC,X#COFF                                                  
*&&UK*&& MVC   GOSELOG,X#OFFGRP                                                 
         MVC   GOSELMED,JD_MED                                                  
         MVC   GOSELMG,X#MEDGRP                                                 
                                                                                
         MVC   GOCTRY,CUCTRY                                                    
                                                                                
         L     R1,ACOMFACS                                                      
         XC    GOACOVL,GOACOVL                                                  
         TM    LP_FLAG,LP_FOFFL    TEST OFFLINE                                 
         JZ    GETSVV98                                                         
         MVC   GOACOVL,VCOVAIL                                                  
                                                                                
GETSVV98 MVC   GOABINSR,CBINSRCH-COMFACSD(R1)                                   
         GOTO1 VGETOPT,DMCB,GOBLOCKD                                            
                                                                                
         USING GOBBLKD,RF                                                       
         L     RF,AGOBBLCK         A(NEW BILLING EXTENSION)                     
*&&UK                                                                           
         CLC   GOBILCUR,AGYCURR                                                 
         JE    *+10                                                             
         MVC   JD_CUR,GOBILCUR                                                  
*&&                                                                             
         USING GOXBLKD,RF                                                       
         L     RF,AGOXBLCK         A(NEW BILLING EXTENSION)                     
         MVC   JD_DRFT,GODRFT                                                   
         MVC   JD_ESDR,GOAEDT                                                   
*&&US                                                                           
         ZAP   JD_AMBR,GOCEAMBR                                                 
         ZAP   JD_RED,GOCERED                                                   
*&&                                                                             
         USING GOBLOCKD,RF                                                      
         L     RF,AGOBLOCB                                                      
         MVC   JD_AUTO,GOAUTNUM                                                 
*&&UK                                                                           
         ZAP   JD_AMBR,GOCEAMBR                                                 
         ZAP   JD_RED,GOCERED                                                   
*&&                                                                             
         DROP  RF                                                               
                                                                                
         GOTOR ESTPCC,1                                                         
         DROP  LAST                                                             
                                                                                
GETSVVX  LA    R0,OLDJDTL          save current values for next time            
         LA    R1,JD_LNQ                                                        
         LA    RE,JD_VALS                                                       
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         XIT1                                                                   
         LTORG                                                                  
         DROP  R2,R3                                                            
                                                                                
* JobList - Job Approvals - Approver - approval needed                          
         USING DRAPASD,R2                                                       
JLNADL   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*JLNADL*'                                                      
                                                                                
         LA    R2,IOKEY                                                         
         XC    DRAPAS,DRAPAS                                                    
         MVI   DRAPTYP,DRAPTYPQ                                                 
         MVI   DRAPSUB,DRAPSUBQ                                                 
         MVC   DRAPCPY,CUXCPY                                                   
         MVI   DRAPAPS,DRAPDRA                                                  
         MVC   DRAPUAL,PRODUL                                                   
                                                                                
         MVC   SAVEKEY1,DRAPAS                                                  
                                                                                
JLNADL10 GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         J     JLNADL20                                                         
                                                                                
JLNADL15 LA    R2,IOKEY                                                         
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
                                                                                
JLNADL20 DS    0H                                                               
         JNE   JLNADLY                                                          
         CLC   DRAPAS(DRAPACT-DRAPAS),SAVEKEY1                                  
         JNE   JLNADLY                                                          
         TM    DRAPSTAT,ACTSDELT   Ignore deleted accounts                      
         JNZ   JLNADL15                                                         
         CLC   DRAPPID,CCTPID      cannot approve your own jobs                 
         JE    JLNADL15                                                         
                                                                                
         CLC   RQ_JDOFF,SPACES     apply office filter if passed                
         JNH   JLNADL25                                                         
         CLC   RQ_JDOFF,DRAPSOFF                                                
         JNE   JLNADL15                                                         
                                                                                
         USING OFFALD,R1                                                        
JLNADL25 L     R1,AOFFAREA                                                      
         MVC   OFFAOFFC,DRAPSOFF                                                
         MVI   OFFAACT,OFFAVAL                                                  
         GOTO1 VOFFAL              validate office                              
         JNE   JLNADL15                                                         
         MVC   X#POFF,DRAPSOFF                                                  
         DROP  R1                                                               
                                                                                
         MVI   X#GAPIND,0                                                       
                                                                                
         GOTOR CHKJAL              check against list of user's rights          
         JNE   JLNADL15                                                         
                                                                                
         MVC   SAVEKEY2,DRAPAS                                                  
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                                                              
                                                                                
         USING ACTRECD,R2                                                       
         L     R2,AIO2                                                          
         TM    ACTRSTAT,ACTSDRFT   Is account really draft                      
         JZ    JLNADL15            No - get next record                         
         TM    ACTRSTAT,ACTSDELT   Ignore deleted accounts                      
         JNZ   JLNADL15                                                         
                                                                                
         USING JOBELD,R3                                                        
         LA    R3,ACTRFST                                                       
         XR    R0,R0                                                            
         MVI   BYTE1,NOQ                                                        
         MVI   BYTE2,0                                                          
                                                                                
JLNADL30 CLI   JOBEL,JOBELQ                                                     
         JE    JLNADL40                                                         
         CLI   JOBEL,STCELQ                                                     
         JE    JLNADL45                                                         
         CLI   JOBEL,0                                                          
         JE    JLNADL50                                                         
                                                                                
JLNADL35 IC    R0,JOBLN                                                         
         AR    R3,R0                                                            
         J     JLNADL30                                                         
                                                                                
JLNADL40 CLI   JOBLN,JOBLN3Q                                                    
         JL    JLNADL35                                                         
         MVI   BYTE1,YESQ                                                       
         TM    JOBSTA2,JOBSREJ     take all non rejected ones                   
         JNZ   JLNADL15                                                         
         OI    BYTE2,X'08'                                                      
         J     JLNADL35                                                         
                                                                                
         USING STCELD,R3                                                        
JLNADL45 CLI   STCIND,STCIJOB      STCELs held in AUDRECD, too                  
         JNE   JLNADL35            - see REJECTER (note: REJECT08               
         CLI   STCDTO,C'R'           STCIND,STCIACT not applied here)           
         JNE   JLNADL35                                                         
         OI    BYTE2,X'80'                                                      
         CLC   STCPERS,CCTPID      own rejection?                               
         JNE   JLNADL35                                                         
         OI    BYTE2,X'01'                                                      
         J     JLNADL35                                                         
                                                                                
JLNADL50 CLI   BYTE1,YESQ          skip if no job element found                 
         JNE   JLNADL15                                                         
         TM    BYTE2,X'08'         take non rejected ones                       
         JNZ   JLNADL55                                                         
         DS    0H                  ### decide whether taking other              
         DS    0H                  or own rejections? ###                       
         J     JLNADL15            ### NO for now ###                           
                                                                                
JLNADL55 DS    0H                  see JLNADL50 - REJECTER not required         
*        GOTOR REJECTER,ACTKULA    but code kept if that ever changes           
*        MVC   IOKEY,SAVEKEY2      reestablish IO sequence                      
*        GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
*        OC    X#JOBREJ,X#JOBREJ                                                
*        JZ    JLNADL60                                                         
*        OI    BYTE2,X'80'                                                      
*                                                                               
*LNADL60 CLI   X#CONREJ,NOQ                                                     
*        JNE   JLNADL65                                                         
*        OI    BYTE2,X'01'                                                      
                                                                                
JLNADL65 GOTOR GETSVV              get status view values for job               
         GOTOR CHKACT              Check whether we can close this              
                                                                                
         GOTOR LP_APUTO,LP_D       pass out values                              
                                                                                
         CLI   X#HIGH,YESQ         can read sequential?                         
         JNE   JLNADL15                                                         
                                                                                
         USING DRAPASD,R2                                                       
         LA    R2,IOKEY                                                         
         MVC   DRAPAS,SAVEKEY2     restore passive key                          
         CLC   DRAPPID,XFFS                                                     
         JE    JLNADL70                                                         
         XR    RE,RE                                                            
         ICM   RE,3,DRAPPID                                                     
         AHI   RE,1                                                             
         STCM  RE,3,DRAPPID                                                     
         J     JLNADL10                                                         
                                                                                
JLNADL70 GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         J     JLNADL15                                                         
                                                                                
JLNADLY  CR    RB,RB                                                            
         XIT1                                                                   
                                                                                
JLNADLN  LTR   RB,RB                                                            
         XIT1                                                                   
         LTORG                                                                  
         DROP  R2                                                               
                                                                                
* Validate SJ account for JobBag module                                         
         USING ACTRECD,R2                                                       
JBVALSJ  NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*JBVALSJ'                                                      
                                                                                
         OC    RQ_JBACT,SPACES                                                  
                                                                                
JBVAL02  OC    RQ_JBOFF,SPACES                                                  
         CLC   RQ_JBOFF,SPACES     if office missng get from cli/pro            
         JH    JBVAL20                                                          
         CLI   OFFIND,NONEQ        skip for non office agencies                 
         JE    JBVAL20                                                          
                                                                                
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(2),PRODUL                                                
         LLC   RE,PCLILEN                                                       
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   ACTKACT(0),RQ_JBACT                                              
         EX    RE,0(RF)                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    JBVAL04                                                          
         DC    H'0'                                                             
                                                                                
JBVAL04  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                 Bad master record                            
                                                                                
         L     R2,AIO2                                                          
         LA    R2,ACTRFST                                                       
         USING PPRELD,R2                                                        
         XR    R0,R0                                                            
                                                                                
JBVAL06  CLI   PPREL,0                                                          
         JE    JBVAL10                                                          
         CLI   PPREL,PPRELQ                                                     
         JE    JBVAL08                                                          
         IC    R0,PPRLN                                                         
         AR    R2,R0                                                            
         J     JBVAL06                                                          
                                                                                
JBVAL08  MVC   RQ_JBOFF,PPRGAOFF                                                
         OC    RQ_JBOFF,SPACES                                                  
                                                                                
         USING ACTRECD,R2                                                       
JBVAL10  LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(2),PRODUL                                                
         LLC   RE,PPROLEN                                                       
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   ACTKACT(0),RQ_JBACT                                              
         EX    RE,0(RF)                                                         
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         JE    JBVAL12                                                          
         DC    H'0'                should exist                                 
                                                                                
JBVAL12  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                 Bad master record                            
                                                                                
         L     R2,AIO2                                                          
         LA    R2,ACTRFST                                                       
         USING PPRELD,R2                                                        
         XR    R0,R0                                                            
                                                                                
JBVAL14  CLI   PPREL,0                                                          
         JE    JBVAL20                                                          
         CLI   PPREL,PPRELQ                                                     
         JE    JBVAL16                                                          
         IC    R0,PPRLN                                                         
         AR    R2,R0                                                            
         J     JBVAL14                                                          
                                                                                
JBVAL16  CLC   PPRGAOFF,SPACES                                                  
         JNH   JBVAL20                                                          
         MVC   RQ_JBOFF,PPRGAOFF                                                
         OC    RQ_JBOFF,SPACES                                                  
                                                                                
         USING ACTRECD,R2                                                       
JBVAL20  MVC   X#CLIC,SPACES       split cli/pro/job                            
         MVC   X#PROC,SPACES                                                    
         MVC   X#JOBC,SPACES                                                    
         LLC   RE,PCLILEN                                                       
         LR    R1,RE                                                            
         SHI   RE,1                                                             
         MVC   X#CLIC(0),RQ_JBACT                                               
         EX    RE,*-6                                                           
         LA    RE,RQ_JBACT(R1)                                                  
         LLC   RF,PPROLEN                                                       
         SR    RF,R1                                                            
         IC    R1,PPROLEN                                                       
         SHI   RF,1                                                             
         MVC   X#PROC(0),0(RE)                                                  
         EX    RF,*-6                                                           
         LA    RE,RQ_JBACT(R1)                                                  
         LA    RF,L'ACTKACT                                                     
         SR    RF,R1                                                            
         CHI   RF,6                                                             
         JNH   *+8                                                              
         LA    RF,6                                                             
         SHI   RF,1                                                             
         MVC   X#JOBC(0),0(RE)                                                  
         EX    RF,*-6                                                           
                                                                                
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(2),PRODUL                                                
         MVC   ACTKACT,RQ_JBACT                                                 
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO6'                               
         JE    JBVAL22                                                          
         MVC   ROUERRV,=AL2(AE$INACC)                                           
         J     JBVALSJN                                                         
                                                                                
JBVAL22  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO6'                              
         JNE   *+2                                                              
                                                                                
JBVALSJY CR    RB,RB                                                            
         XIT1                                                                   
                                                                                
JBVALSJN LTR   RB,RB                                                            
         XIT1                                                                   
         LTORG                                                                  
         DROP  R2                                                               
                                                                                
* JobBag - get Job values                                                       
         USING ACTRECD,R2                                                       
         USING JOBELD,R3                                                        
JBGETJV  NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*JBGETJV'                                                      
                                                                                
         MVI   X#JOBBO,NOQ                                                      
         L     R2,AIO6                                                          
         LA    R3,ACTRFST          get JOB element                              
         XR    R0,R0                                                            
                                                                                
JBGETJV2 CLI   JOBEL,0                                                          
         JE    JBGETJVX                                                         
         CLI   JOBEL,JOBELQ                                                     
         JE    JBGETJV4                                                         
         IC    R0,JOBLN            general purpose xtra data el                 
         AR    R3,R0                                                            
         J     JBGETJV2                                                         
                                                                                
JBGETJV4 CLI   JOBLN,JOBLN3Q                                                    
         JL    JBGETJVX                                                         
         TM    JOBSTA1,JOBSMCSE                                                 
         JZ    JBGETJVX                                                         
         MVI   X#JOBBO,YESQ                                                     
                                                                                
JBGETJVX XIT1                                                                   
         LTORG                                                                  
         DROP  R2,R3                                                            
                                                                                
* download module 'JobBag' for w/c details and Accounting view                  
PROJBWD  NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*PROJBWD'                                                      
                                                                                
         CLI   RQ_JBTYP,RQ_JBBIL   Billing view                                 
         JNE   PJBWD002                                                         
         MVC   RQ_JBWRK,BILWC      set w/c=99 and go to 'transactions'          
         J     PJBWD040                                                         
                                                                                
PJBWD002 CLI   RQ_JBTYP,RQ_JBACC   No w/c for Accounting view                   
         JE    PJBWD010                                                         
                                                                                
         OC    RQ_JBWRK,SPACES     ensure work code set                         
         CLC   RQ_JBWRK,SPACES                                                  
         BH    PJBWD004                                                         
                                                                                
         MVC   ROUERRV,=AL2(AE$INWRK)                                           
         J     PROJBWDN                                                         
                                                                                
PJBWD004 GOTOR GETWCT                                                           
         JE    PJBWD010                                                         
                                                                                
         MVC   ROUERRV,=AL2(AE$INWRK)                                           
         J     PROJBWDN                                                         
                                                                                
PJBWD010 CLI   RQ_JBTYP,RQ_JBWCD   Skip expens if not extended/acc view         
         JE    PJBWD012                                                         
         GOTOR GETEXPC             Get expense claim items                      
         JNE   PROJBWDN                                                         
PJBWD012 CLI   RQ_JBTYP,RQ_JBWCD   Skip time sheet if not extended/             
         JE    PJBWD020            Account view                                 
         LA    R1,X#RTTRX                                                       
         USING TMSTTABD,R1                                                      
         LA    R0,TMSTNUM                                                       
PJBWD014 CLI   TMSTMPTY,YESQ       Are interested in in progress TS             
         JE    PJBWD018            Yes                                          
         OC    TMSTSTAT,TMSTSTAT   Are we interested in other statuses          
         JNZ   PJBWD018            Yes                                          
         LA    R1,TMSTTABL(R1)     No - look at next entry                      
         JCT   R0,PJBWD014                                                      
         J     PJBWD020                                                         
         DROP  R1                                                               
                                                                                
PJBWD018 GOTOR GETIML              Get timesheets from passive                  
         JNE   PROJBWDN                                                         
PJBWD020 CLI   RQ_JBTYP,RQ_JBWCD   skip orders if not extended/acc view         
         JE    PJBWD030                                                         
         GOTOR GETORD              Get order details                            
         JNE   PROJBWDN                                                         
PJBWD030 CLI   RQ_JBTYP,RQ_JBWCD                                                
         JE    PJBWD040                                                         
         GOTOR ORDTRXS             Get order transaction details                
         JNE   PROJBWDN                                                         
PJBWD040 GOTOR GETTRN              Get transaction details                      
         JNE   PROJBWDN                                                         
         CLI   RQ_JBTYP,RQ_JBBIL   Billing view then exit                       
         JE    PROJBWDY                                                         
         CLI   X#JOBBO,YESQ        BrandOcean estimates?                        
         JNE   PROJBWDY                                                         
         GOTOR GETEST              Get estimate details                         
                                                                                
PROJBWDY CR    RB,RB                                                            
         XIT1                                                                   
                                                                                
PROJBWDN LTR   RB,RB                                                            
         XIT1                                                                   
         LTORG                                                                  
***********************************************************************         
* GET EXPENSE CLAIM ITEMS                                             *         
***********************************************************************         
         USING EXJPASD,R2                                                       
GETEXPC  NTR1  BASE=*,LABEL=NO     *** EXPENSE CLAIM ITEMS ***                  
         J     *+12                                                             
         DC    C'*GETEXPC'                                                      
         LA    R6,EXPTTAB                                                       
                                                                                
GETEXP02 LA    R2,IOKEY                                                         
         XC    EXJPAS,EXJPAS                                                    
         MVI   EXJPTYP,EXJPTYPQ                                                 
         MVI   EXJPSUB,EXJPSUBQ                                                 
         MVC   EXJPCPY,CUXCPY                                                   
         MVC   EXJPVIEW,0(R6)                                                   
         MVC   EXJPCOFF,RQ_JBOFF                                                
         MVC   EXJPCPJ,RQ_JBACT                                                 
                                                                                
         MVC   CSVKEY1,EXJPAS                                                   
         L     RF,AGOXBLCK                                                      
         USING GOXBLKD,RF                                                       
         LA    RE,GODIEB                                                        
         TM    SAVEIND,SAVESTC                                                  
         JZ    *+8                                                              
         LA    RE,GOEXPB                                                        
         CLI   0(RE),C'N'          do we want any expenses?                     
         JNE   GETEXP04                                                         
*                                                                               
         LA    RE,GODIEN                                                        
         TM    SAVEIND,SAVESTC                                                  
         JZ    *+8                                                              
         LA    RE,GOEXPN                                                        
         CLI   0(RE),C'N'                                                       
         JE    GETEXPY                                                          
                                                                                
GETEXP04 GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    GETEXP08                                                         
         J     GETEXPN                                                          
                                                                                
GETEXP06 LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JNE   GETEXPN                                                          
                                                                                
GETEXP08 CLC   EXJPAS(EXJPMED-EXJPASD),CSVKEY1    Match on key?                 
         JNE   GETEXP32                                                         
         GOTOR FLTEXK,DMCB,EXJPAS  filter expense status                        
         JNE   GETEXP06                                                         
                                                                                
GETEXP10 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         USING EXCRECD,R2                                                       
         L     R2,AIO2                                                          
         USING CIDELD,R3                                                        
         LA    R3,EXCRFST                                                       
         J     GETEXP14                                                         
                                                                                
GETEXP12 LLC   R0,CIDLN            find appropriate CIDEL cluster(s)            
         AR    R3,R0                                                            
                                                                                
GETEXP14 CLI   CIDEL,0                                                          
         JE    GETEXP06                                                         
         CLI   CIDEL,CIDELQ                                                     
         JNE   GETEXP12                                                         
         CLI   CIDTYPE,CIDTYMQ                                                  
         JNE   GETEXP12                                                         
                                                                                
CUR      USING CIDELD,R4                                                        
         LA    R4,CIDELD           filter CIDEL and its cluster                 
         CLC   CIDMWCD,SPACES      Have we got a workcode                       
         JNH   GETEXP12                                                         
         GOTOR FLTEXL,DMCB,0(R4),EXCRECD filter expense status                  
         JNE   GETEXP12                                                         
                                                                                
GETEXP16 LLC   R0,CUR.CIDLN                                                     
         AR    R4,R0                                                            
         CLI   CUR.CIDEL,CIDELQ                                                 
         JNE   GETEXP12                                                         
         CLC   CUR.CIDSEQ,CIDSEQ                                                
         JNE   GETEXP12                                                         
         CLI   CUR.CIDTYPE,CIDTYCQ                                              
         JNE   GETEXP16                                                         
                                                                                
         CLC   CUR.CIDCCPJ,RQ_JBACT                                             
         JNE   GETEXP12            look for this job's items                    
                                                                                
         CLI   RQ_JBTYP,RQ_JBACC   skip for Accounting view                     
         JE    GETEXP18                                                         
         CLC   CIDMWCD,RQ_JBWRK                                                 
         JNE   GETEXP12                                                         
                                                                                
GETEXP18 GOTOR CLRJBV              build return values                          
         MVC   JB_CACC,CUR.CIDCSUP                                              
         CLI   CUR.CIDLN,CIDCLXQ                                                
         JL    GETEXP20                                                         
         MVC   JB_ESTN,CUR.CIDCEGN                                              
GETEXP20 LLC   R0,CUR.CIDLN                                                     
         AR    R4,R0                                                            
         CLI   CUR.CIDEL,0                                                      
         JE    GETEXP22                                                         
         CLI   CUR.CIDEL,CIDELQ                                                 
         JNE   GETEXP22                                                         
         CLC   CUR.CIDSEQ,CIDSEQ                                                
         JNE   GETEXP22                                                         
         CLI   CUR.CIDTYPE,CIDTYOQ                                              
         JNE   GETEXP20                                                         
         CLI   CUR.CIDLN,CIDDATA-CIDELD                                         
         JNH   GETEXP20                                                         
         LLC   RE,CUR.CIDLN                                                     
         SHI   RE,CIDDATA-CIDELD                                                
         CHI   RE,L'JB_NARR                                                     
         JL    *+8                                                              
         LA    RE,L'JB_NARR                                                     
         SHI   RE,1                                                             
         MVC   JB_NARR(0),CUR.CIDNARR                                           
         EX    RE,*-6                                                           
                                                                                
GETEXP22 MVI   JB_TAST,JB_TAPAQ    set trx status from expense record           
         TM    EXCRSTAT,EXCSPAPP+EXCSFNTA                                       
         JNZ   GETEXP24                                                         
         MVI   JB_TAST,JB_TASUQ                                                 
         TM    EXCRSTAT,EXCSSUBM                                                
         JNZ   GETEXP24                                                         
         MVI   JB_TAST,JB_TARJQ                                                 
         TM    EXCRSTAT,EXCSREJE                                                
         JNZ   GETEXP24                                                         
         MVI   JB_TAST,JB_TAIPQ                                                 
         OC    EXCRSTAT,EXCRSTAT                                                
         JZ    GETEXP24                                                         
         MVI   JB_TAST,C'?'        what is this?                                
                                                                                
GETEXP24 MVI   JB_TYPE,RQ_JBWCD                                                 
         MVI   JB_DTYP,C'X'                                                     
                                                                                
         MVC   JB_EORI,X#WCTIE                                                  
         ZAP   JB_TDEB,CIDMAMT                                                  
         CLI   RQ_JBTYP,RQ_JBACC   w/c for Accounting view                      
         JNE   GETEXP26                                                         
         MVC   JB_WCOD,CIDMWCD                                                  
         GOTOR SETCWP,2                                                         
                                                                                
GETEXP26 MVC   JB_REFN(L'CIDMREF),CIDMREF                                       
         MVC   JB_INTR(L'CIDMINT),CIDMINT                                       
         GOTO1 VDATCON,DMCB,(2,CIDMDAT),(1,JB_DATE)                             
         MVC   JB_ETYP,CIDMEXP                                                  
         CLC   CIDMCUR,AGYCURR                                                  
         JE    GETEXP28                                                         
         MVC   JB_TFCC,CIDMCUR                                                  
         ZAP   JB_TFCA,CIDMFCA                                                  
                                                                                
GETEXP28 CLC   JB_CACC+2(L'JB_CACN-2),SPACES                                    
         JNH   GETEXP30                                                         
         XC    X#PIDAP,X#PIDAP                                                  
         GOTOR SETCWP,0            set c/a and w/c names if required            
                                                                                
GETEXP30 GOTOR LP_APUTO,LP_D                                                    
         J     GETEXP12                                                         
                                                                                
GETEXP32 LA    R6,1(R6)                                                         
         CLI   0(R6),X'FF'                                                      
         JNE   GETEXP02                                                         
GETEXPY  CR    RB,RB                                                            
         XIT1                                                                   
                                                                                
GETEXPN  LTR   RB,RB                                                            
         XIT1                                                                   
         DROP  R2,R3,CUR,RF                                                     
         LTORG                                                                  
***********************************************************************         
* GET TIMESHEET LINES                                                 *         
***********************************************************************         
GETIML   NTR1  BASE=*,LABEL=NO     *** TIME SHEET LINES ***                     
         J     *+12                                                             
         DC    C'*GETIML*'                                                      
TP       USING TSJPASD,IOKEY                                                    
         XC    TP.TSJPAS,TP.TSJPAS                                              
         MVI   TP.TSJPTYP,TSJPTYPQ                                              
         MVI   TP.TSJPSUB,TSJPSUBQ                                              
         MVI   TP.TSJPVIEW,TSJPSJAQ                                             
         MVC   TP.TSJPCPY,CUXCPY                                                
         MVC   TP.TSJPCOFF,RQ_JBOFF                                             
         MVC   TP.TSJPACT,RQ_JBACT                                              
         LLC   RE,PPROLEN                                                       
         LA    R1,RQ_JBACT                                                      
         AR    R1,RE                                                            
         MVC   TP.TSJPMED,0(R1)                                                 
                                                                                
         MVC   CSVKEY1,TP.TSJPAS                                                
                                                                                
GETIML2  GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    GETIML6                                                          
         J     GETIMLN                                                          
                                                                                
GETIML4  GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JNE   GETIMLN                                                          
                                                                                
GETIML6  CLC   TP.TSJPAS(TSJPPEDT-TSJPASD),CSVKEY1    Match on key?             
         JNE   GETIMLY                                                          
         GOTOR FLTTMK,DMCB,TP.TSJPASD  filter time status                       
         JNE   GETIML4                                                          
                                                                                
GETIML8  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         USING TIMRECD,R2                                                       
         L     R2,AIO2                                                          
         USING TIMELD,R3                                                        
         LA    R3,TIMRFST                                                       
         J     GETIML12                                                         
                                                                                
GETIML10 LLC   R0,TIMLN            find appropriate TIMEL cluster(s)            
         AR    R3,R0                                                            
                                                                                
GETIML12 CLI   TIMEL,0                                                          
         JE    GETIML4                                                          
         CLI   TIMEL,TIMELQ                                                     
         JNE   GETIML10                                                         
         CLI   TIMETYP,TIMEITMS                                                 
         JE    GETIML18                                                         
         CLI   TIMETYP,TIMEINP                                                  
         JNE   GETIML10                                                         
         ST    R3,FULL1            Save address of input timel                  
         CLC   TIMACC(2),PRODUL                                                 
         JNE   GETIML10                                                         
         CLC   TIMACC+2(12),RQ_JBACT                                            
         JNE   GETIML10            look for this job's items only               
                                                                                
         CLC   TIMTSK,SPACES       Have we got a workcode                       
         JNH   GETIML10                                                         
                                                                                
         CLI   RQ_JBTYP,RQ_JBACC   skip for Accounting view                     
         JE    GETIML14                                                         
         CLC   TIMTSK,RQ_JBWRK                                                  
         JNE   GETIML10                                                         
                                                                                
GETIML14 GOTOR FLTTMP,DMCB,TIMELD,TP.TSJPAS                                     
         JNE   GETIML10                                                         
         GOTOR CLRJBV              build return values                          
                                                                                
         ZAP   DUB1,PZERO                                                       
         ZAP   DUB2,PZERO                                                       
         CLI   TIMTTYP,TIMTCN                                                   
         JE    GETIML16                                                         
         AP    DUB1,TIMRATE        Amount = Rate * Hours                        
         MP    DUB1,TIMHRS                                                      
         SRP   DUB1,64-2,5         / 100 (hours is 2 dec places)                
*&&UK                                                                           
         AP    DUB2,TIMCRATE       Amount = Rate * Hours                        
         MP    DUB2,TIMHRS                                                      
         SRP   DUB2,64-2,5         / 100 (hours is 2 dec places)                
*&&                                                                             
GETIML16 MVI   JB_TYPE,RQ_JBWCD                                                 
         MVI   JB_DTYP,C'S'                                                     
                                                                                
         MVC   JB_EORI,X#WCTIE                                                  
         ZAP   JB_CACR,DUB2                                                     
         ZAP   JB_CASR,DUB1                                                     
         CLI   RQ_JBHRS,NOQ        filter out hours                             
         JE    GETIML17                                                         
         ZAP   JB_THRS,TIMHRS                                                   
         CLI   TIMTTYP,TIMTCR                                                   
         JNE   GETIML17                                                         
         ZAP   JB_MHRS,DUB1                                                     
         L     RF,AGOXBLCK                                                      
         CLI   GOINCR-GOXBLOCK(RF),YESQ R time to be treated as actual          
         JNE   GETIML17                                                         
         LA    R1,DUB1                                                          
*&&UK                                                                           
         CLI   GOCSAT-GOXBLOCK(RF),GOCSCOST Want cost amount?                   
         JNE   *+8                                                              
         LA    R1,DUB2                                                          
*&&                                                                             
         ZAP   JB_TDEB,0(L'DUB1,R1)                                             
                                                                                
GETIML17 CLI   TIMTTYP,TIMTCB                                                   
         JNE   *+10                                                             
         ZAP   JB_TDEB,TIMAMNT                                                  
         CLI   RQ_JBTYP,RQ_JBACC   w/c for Accounting view                      
         JNE   GETIML26                                                         
         MVC   JB_WCOD,TIMTSK                                                   
         GOTOR SETCWP,2                                                         
         J     GETIML26                                                         
                                                                                
GETIML18 CLC   TIMIUNT(2),PRODUL                                                
         JNE   GETIML10                                                         
         CLC   TIMIACC,RQ_JBACT                                                 
         JNE   GETIML10            Look for this job's items only               
                                                                                
         CLC   TIMITSK,SPACES      Have we got a workcode                       
         JNH   GETIML10                                                         
         CLI   RQ_JBTYP,RQ_JBACC   Skip for Accounting view                     
         JE    GETIML20                                                         
         CLC   TIMITSK,RQ_JBWRK                                                 
         JNE   GETIML10                                                         
                                                                                
GETIML20 L     R2,FULL1            R2=A(Input timel)                            
         GOTOR FLTTMP,DMCB,(R2),TP.TSJPAS                                       
         JNE   GETIML10                                                         
         L     R2,AIO2                                                          
         DROP  TP                                                               
         GOTOR CLRJBV              build return values                          
                                                                                
         MVI   JB_TYPE,RQ_JBWCD                                                 
         MVI   JB_DTYP,C'S'                                                     
         MVC   JB_EORI,X#WCTIE                                                  
         ZAP   JB_TDEB,TIMITOT                                                  
         CLI   TIMLN,TIMITLNQ                                                   
         BNH   GETIML24                                                         
         LLC   RE,TIMLN                                                         
         SHI   RE,TIMITLNQ                                                      
         CHI   RE,L'JB_NARR                                                     
         JL    *+8                                                              
         LA    RE,L'JB_NARR                                                     
         SHI   RE,1                                                             
         MVC   JB_NARR(0),TIMITEXT                                              
         EX    RE,*-6                                                           
                                                                                
GETIML24 CLI   RQ_JBTYP,RQ_JBACC   w/c for Accounting view                      
         JNE   GETIML26                                                         
         MVC   JB_WCOD,TIMITSK                                                  
         GOTOR SETCWP,2                                                         
                                                                                
GETIML26 MVC   JB_CACC,TIMKULA                                                  
         MVI   JB_TAST,JB_TAAPQ                                                 
         TM    TIMRSTAT,TIMSFAPP                                                
         JNZ   GETIML30                                                         
         MVI   JB_TAST,JB_TAPAQ                                                 
         TM    TIMRSTAT,TIMSPAPP                                                
         JNZ   GETIML30                                                         
         MVI   JB_TAST,JB_TASUQ                                                 
         TM    TIMRSTAT,TIMSSUBM                                                
         JNZ   GETIML30                                                         
         MVI   JB_TAST,JB_TARJQ                                                 
         TM    TIMRSTAT,TIMSREJE                                                
         JNZ   GETIML30                                                         
         MVI   JB_TAST,JB_TAIPQ                                                 
         OC    TIMRSTAT,TIMRSTAT                                                
         JZ    GETIML30                                                         
         MVI   JB_TAST,C'?'        what is this?                                
                                                                                
GETIML30 CLI   TIMETYP,TIMEITMS                                                 
         JE    *+14                                                             
         MVC   JB_REFN,AC@TIME                                                  
         J     *+10                                                             
         MVC   JB_REFN,AC@MAT                                                   
         MVC   JB_DATE,TIMKPEDT                                                 
CUR      USING TIMELD,RF                                                        
         LA    RF,TIMRFST                                                       
GETIML32 LLC   R0,CUR.TIMLN                                                     
         AR    RF,R0                                                            
         CLI   CUR.TIMEL,0                                                      
         JE    GETIML38                                                         
         CLI   CUR.TIMEL,TIMELQ                                                 
         JNE   GETIML32                                                         
         CLC   CUR.TIMSEQ,TIMSEQ                                                
         JNE   GETIML32                                                         
         CLI   TIMETYP,TIMEITMS                                                 
         BE    *+12                                                             
         CLI   CUR.TIMETYP,TIMENAR                                              
         JE    GETIML36                                                         
         CLI   CUR.TIMETYP,TIMEORDR                                             
         JE    GETIML34                                                         
         CLI   CUR.TIMETYP,TIMEEST                                              
         JNE   GETIML32                                                         
         MVC   JB_ESTN,CUR.TIMSESNM                                             
         J     GETIML32                                                         
GETIML34 MVC   JB_ORDN,CUR.TIMOORDR                                             
         J     GETIML32                                                         
GETIML36 LLC   RE,CUR.TIMLN                                                     
         SHI   RE,TIMHLNQ                                                       
         CHI   RE,L'JB_NARR                                                     
         JL    *+8                                                              
         LA    RE,L'JB_NARR                                                     
         SHI   RE,1                                                             
         MVC   JB_NARR(0),CUR.TIMNARR                                           
         EX    RE,*-6                                                           
         J     GETIML32                                                         
                                                                                
GETIML38 CLC   JB_CACC+2(L'JB_CACN-2),SPACES                                    
         JNH   GETIML40                                                         
                                                                                
         XC    X#PIDAP,X#PIDAP                                                  
         GOTOR SETCWP,0            set c/a and w/c names if required            
                                                                                
GETIML40 GOTOR LP_APUTO,LP_D                                                    
         J     GETIML10                                                         
         DROP  R2,R3,CUR                                                        
                                                                                
                                                                                
GETIMLY  CR    RB,RB                                                            
         XIT1                                                                   
                                                                                
GETIMLN  LTR   RB,RB                                                            
         XIT1                                                                   
         LTORG                                                                  
***********************************************************************         
* ORDER DETAILS                                                       *         
***********************************************************************         
GETORD   NTR1  BASE=*,LABEL=NO     *** ORDERS ***                               
         J     *+12                                                             
         DC    C'*GETORD*'                                                      
                                                                                
         GOTOR PJOCLR                                                           
                                                                                
         USING OSJPASD,R2                                                       
         LA    R2,IOKEY            Read order passives                          
         XC    OSJPAS,OSJPAS                                                    
         MVI   OSJPTYP,OSJPTYPQ                                                 
         MVI   OSJPSUB,OSJPSUBQ                                                 
         MVC   OSJPCPY,CUXCPY                                                   
         MVC   OSJPACT,RQ_JBACT                                                 
         MVI   OSJPMEM,0           (no memo, see RQ_JBMEM)                      
                                                                                
         MVC   SAVEKEY1,OSJPAS                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    GETORD4                                                          
         J     GETORDN                                                          
                                                                                
GETORD2  LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JNE   GETORDN                                                          
                                                                                
GETORD4  CLC   OSJPAS(OSJPMEM-OSJPASD),SAVEKEY1    Match on key?                
         JNE   GETORDY                                                          
                                                                                
                                                                                
         CLI   OSJPMEM,0   skip for memo                                        
         JNE   GETORD6                                                          
         TM    OSJPSTA2,ORDSAPPR   Ignore approved orders                       
         JNZ   GETORD2                                                          
GETORD6  GOTOR FLTORD,DMCB,OSJPAS  Filter orders                                
         JNE   GETORD2                                                          
*                                                                               
GETORD10 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R2,AIO2                                                          
         USING ORDRECD,R2                                                       
         XC    X#MWCIND,X#MWCIND                                                
         USING OAMELD,R4                                                        
         LA    R4,ORDRFST                                                       
         XR    R0,R0                                                            
                                                                                
GETORD12 IC    R0,OAMLN            check match on work code                     
         AR    R4,R0                                                            
         CLI   OAMEL,0                                                          
         JE    GETORD2                                                          
         CLI   OAMEL,OAMELQ                                                     
         JNE   GETORD12                                                         
         CLI   IOKEY+OSJPMEM-OSJPASD,0   skip for memo                          
         JNE   GETORD14                                                         
         CLI   RQ_JBTYP,RQ_JBACC         and skip for Accounting view           
         JE    GETORD14                                                         
         CLC   OAMWORK,RQ_JBWRK                                                 
         JNE   GETORD12                                                         
                                                                                
GETORD14 GOTOR CLRJBV              build return values                          
                                                                                
         MVI   JB_TAST,JB_TAPAQ          set trx status from order              
         TM    ORDRSTA2,ORDSPAPP                                                
         JNZ   GETORD16                                                         
         MVI   JB_TAST,JB_TASUQ                                                 
         TM    ORDRSTA2,ORDSSUBM                                                
         JNZ   GETORD16                                                         
         MVI   JB_TAST,JB_TAAPQ                                                 
         TM    ORDRSTA2,ORDSAPPR                                                
         JNZ   GETORD16                                                         
         MVI   JB_TAST,JB_TAIPQ                                                 
         TM    ORDRSTA2,ORDSDRFT                                                
         JNZ   GETORD16                                                         
         MVI   JB_TAST,C'?'              what is this?                          
                                                                                
GETORD16 MVI   JB_TYPE,RQ_JBWCD                                                 
         MVI   JB_DTYP,C'R'                                                     
         CLI   IOKEY+OSJPMEM-OSJPASD,0   memo?                                  
         JE    *+8                                                              
         MVI   JB_DTYP,C'M'                                                     
         MVC   JB_EORI,X#WCTIE                                                  
         ZAP   JB_OAMT,OAMAMNT                                                  
         SP    JB_OAMT,OAMIVAL                                                  
         ZAP   JB_OINV,OAMIVAL                                                  
         MVC   JB_ORDN,ORDKORD                                                  
         CLI   RQ_JBTYP,RQ_JBACC   w/c for Accounting view                      
         JNE   GETORD20                                                         
         MVC   JB_WCOD,OAMWORK                                                  
         GOTOR SETCWP,2                                                         
                                                                                
GETORD18 LLC   R0,OAMLN            multiple w/cs?                               
         AR    R4,R0                                                            
         CLI   OAMEL,0                                                          
         JE    GETORD20                                                         
         CLI   OAMEL,OAMELQ                                                     
         JNE   GETORD18                                                         
         MVI   JB_WCMI,YESQ                                                     
         ST    R4,X#MWCIND                                                      
                                                                                
         USING ORDELD,R4                                                        
GETORD20 LA    R4,ORDRFST                                                       
         XR    R0,R0                                                            
                                                                                
GETORD22 CLI   ORDEL,0                                                          
         JE    GETORD60                                                         
         CLI   ORDEL,ORDELQ                                                     
         JE    GETORD26                                                         
         CLI   ORDEL,FFTELQ                                                     
         JE    GETORD28                                                         
         CLI   ORDEL,AFCELQ                                                     
         JE    GETORD58                                                         
                                                                                
GETORD24 IC    R0,ORDLN                                                         
         AR    R4,R0                                                            
         J     GETORD22                                                         
                                                                                
GETORD26 MVC   JB_CACC,ORDSUPU     contra account = supplier                    
         MVC   JB_DATE,ORDDATE                                                  
         J     GETORD24                                                         
                                                                                
         USING FFTELD,R4                                                        
GETORD28 CLI   FFTTYPE,FFTTESTN                                                 
         JNE   GETORD30                                                         
         MVC   JB_ESTN,FFTOESTN                                                 
         J     GETORD24                                                         
                                                                                
GETORD30 CLI   FFTTYPE,FFTTEXTY                                                 
         JNE   GETORD32                                                         
         MVC   JB_ETYP,FFTDATA                                                  
         J     GETORD24                                                         
                                                                                
GETORD32 CLI   FFTTYPE,FFTTORNO                                                 
         JNE   GETORD54                                                         
         TM    IOKEY+OSJPSTA2-OSJPASD,ORDSPAPP+ORDSSUBM+ORDSDRFT                
         JZ    GETORD50                                                         
         MVC   JB_ORDN,SPACES      clear order number on requisitions           
                                                                                
GETORD50 LA    RE,JB_REQN          set prefix and suffix if given               
         CLI   X#RPRE,C' '                                                      
         JNH   GETORD52                                                         
         MVC   0(1,RE),X#RPRE                                                   
         AHI   RE,1                                                             
                                                                                
GETORD52 MVC   0(6,RE),FFTDATA                                                  
         AHI   RE,6                                                             
         CLI   X#RSUF,C' '                                                      
         JNH   GETORD24                                                         
         MVC   0(1,RE),X#RSUF                                                   
         J     GETORD24                                                         
                                                                                
GETORD54 CLI   FFTTYPE,FFTTWRKC    match on memo work code                      
         JNE   GETORD24                                                         
         CLI   RQ_JBTYP,RQ_JBACC   skip for Accounting view                     
         JE    GETORD56                                                         
         CLC   FFTWORK,RQ_JBWRK                                                 
         JNE   GETORD2                                                          
         J     GETORD24                                                         
                                                                                
GETORD56 MVC   JB_WCOD,FFTWORK                                                  
         J     GETORD24                                                         
         DROP  R4                                                               
                                                                                
         USING AFCELD,R4                                                        
GETORD58 MVC   JB_TFCC,AFCCURR     Foreign currrency                            
         ZAP   JB_TFCA,AFCAMNT                                                  
         MVC   JB_TFCR,AFCX                                                     
         J     GETORD24                                                         
                                                                                
GETORD60 CLC   JB_CACC+2(L'JB_CACN-2),SPACES                                    
         JNH   GETORD70                                                         
                                                                                
         XC    X#PIDAP,X#PIDAP                                                  
         GOTOR SETCWP,0            set c/a and w/c names if required            
                                                                                
GETORD70 GOTOR LP_APUTO,LP_D                                                    
                                                                                
         OC    X#MWCIND,X#MWCIND   Repeat for multiple w/cs                     
         JZ    GETORD2                                                          
         USING OAMELD,R4                                                        
         L     R4,X#MWCIND                                                      
                                                                                
GETORD72 MVC   JB_WCOD,OAMWORK     loop through order and add one               
         ZAP   JB_OAMT,OAMAMNT                                                  
         SP    JB_OAMT,OAMIVAL                                                  
         ZAP   JB_OINV,OAMIVAL                                                  
         GOTOR SETCWP,2            record per w/c based on main w/c             
         GOTOR LP_APUTO,LP_D                                                    
         LLC   R0,OAMLN                                                         
         AR    R4,R0                                                            
         CLI   OAMEL,OAMELQ                                                     
         JNE   GETORD2                                                          
         J     GETORD72                                                         
                                                                                
GETORDY  CR    RB,RB                                                            
         XIT1                                                                   
                                                                                
GETORDN  LTR   RB,RB                                                            
         XIT1                                                                   
         LTORG                                                                  
         DROP  R2,R4                                                            
***********************************************************************         
* GET ORDER TRANSACTIONS                                              *         
***********************************************************************         
ORDTRXS  NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*ORDTRXS'         *** ORDER TRXS ***                           
         USING TRNRECD,R2                                                       
         LA    R2,IOKEY                                                         
         L     RF,AGOXBLCK                                                      
         TM    SAVEIND,SAVESTC     do we want to do estimate check?             
         JNZ   *+12                                                             
         LA    RF,GODIOS-GOXBLKD(RF)                                            
         J     *+8                                                              
         LA    RF,GOEORN-GOXBLKD(RF)                                            
*                                                                               
         CLI   0(RF),C'N'          don't want any orders                        
         JE    ORDTRXY                                                          
*                                                                               
         MVC   TRNKEY,SPACES                                                    
         MVC   TRNKCPY,CUXCPY                                                   
         MVC   TRNKULA(2),PRODUL                                                
         MVC   TRNKACT,RQ_JBACT                                                 
         MVC   TRNKWORK,ORDWC                                                   
                                                                                
         MVC   SAVEKEY1,TRNKEY                                                  
         MVC   TEMP2,SPACES                                                     
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    ORDTRX4                                                          
         J     ORDTRXN                                                          
                                                                                
ORDTRX2  LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JNE   ORDTRXN                                                          
                                                                                
ORDTRX4  CLC   TRNKCULA,SAVEKEY1   Match on key?                                
         JNE   ORDTRXY                                                          
         CLC   TRNKWORK,ORDWC                                                   
         JNE   ORDTRXY                                                          
*                                                                               
                                                                                
         OC    TRNKEY+36(6),TRNKEY+36    C/A header record?                     
         JNZ   ORDTRX6                                                          
                                                                                
         GOTOR PROCAC              Process contra account                       
                                                                                
         J     ORDTRX2                                                          
                                                                                
ORDTRX6  CLC   TRNKREF,SPACES      Skip other records                           
         JE    ORDTRX2                                                          
                                                                                
         TM    TRNKSTAT,TRNSREVS+TRNSDRFT                                       
         JNZ   ORDTRX2                                                          
                                                                                
         LHI   R1,IOGET+IOMST+IO2                                               
         TM    TRNKSTAT,TRNSARCH                                                
         JZ    *+8                                                              
         LHI   R1,IOGET+IOARC+IO2                                               
                                                                                
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         USING TRNELD,R3                                                        
         USING OAMELD,R4                                                        
         L     R2,AIO2             Process order transaction                    
         LA    R3,TRNRFST                                                       
         CLI   TRNEL,TRNELQ                                                     
         JNE   ORDTRX2                                                          
         XC    X#MWCIND,X#MWCIND                                                
                                                                                
         LR    R4,R3                                                            
         XR    R0,R0                                                            
                                                                                
         CLI   TRNLN,TRNLN1Q                                                    
         JNH   ORDTRX8                                                          
         LLC   RE,TRNLN                                                         
         SHI   RE,TRNLN1Q                                                       
         CHI   RE,L'JB_NARR                                                     
         JL    *+8                                                              
         LA    RE,L'JB_NARR                                                     
         SHI   RE,1                                                             
         MVC   JB_NARR(0),TRNNARR                                               
         EX    RE,*-6                                                           
                                                                                
ORDTRX8  IC    R0,OAMLN            look for matching w/c entries                
         AR    R4,R0                                                            
         CLI   OAMEL,0                                                          
         JE    ORDTRX2                                                          
         CLI   OAMEL,OAMELQ                                                     
         JNE   ORDTRX8                                                          
         CLI   RQ_JBTYP,RQ_JBACC   skip for Accounting view                     
         JE    ORDTRX10                                                         
         CLC   OAMWORK,RQ_JBWRK                                                 
         JNE   ORDTRX8                                                          
                                                                                
ORDTRX10 GOTOR CLRJBV                                                           
                                                                                
         CP    OAMAMNT,OAMIVAL     Has full amount been invoiced?               
         BE    ORDTRX8             Yes - Skip display                           
*&&UK                                                                           
         CLI   OAMLN,OAMLN3Q                                                    
         BNE   ORDTRX11                                                         
         ZAP   JB_TFCA,OAMFCAMT                                                 
         SP    JB_TFCA,OAMFCIVL                                                 
*&&                                                                             
ORDTRX11 MVI   JB_TYPE,RQ_JBWCD                                                 
         MVI   JB_TAST,JB_TAAPQ    if ord trx exists then fully appr            
         MVI   JB_DTYP,C'O'                                                     
         MVC   JB_EORI,X#WCTIE                                                  
         ZAP   JB_OAMT,OAMAMNT                                                  
         SP    JB_OAMT,OAMIVAL                                                  
         ZAP   JB_OINV,OAMIVAL                                                  
         MVC   JB_CACC,TRNKULC                                                  
         MVC   JB_CACN,X#CANAME                                                 
         MVC   JB_DATE,TRNKDATE                                                 
         ZAP   JB_TALL,PZERO                                                    
         ZAP   JB_COMB,PZERO                                                    
                                                                                
         MVC   JB_REFN(L'TRNREF),TRNREF                                         
         MVC   JB_INTR,SPACES                                                   
         MVC   JB_ORDN,TRNREF                                                   
                                                                                
         CLI   RQ_JBTYP,RQ_JBACC   w/c for Accounting view                      
         JNE   ORDTRX14                                                         
         MVC   JB_WCOD,OAMWORK                                                  
                                                                                
ORDTRX12 LLC   R0,OAMLN            multiple w/cs?                               
         AR    R4,R0                                                            
         CLI   OAMEL,0                                                          
         JE    ORDTRX14                                                         
         CLI   OAMEL,OAMELQ                                                     
         JNE   ORDTRX12                                                         
         MVI   JB_WCMI,YESQ                                                     
         ST    R4,X#MWCIND                                                      
                                                                                
         USING FFTELD,R4                                                        
ORDTRX14 LA    R4,TRNRFST                                                       
         XR    R0,R0                                                            
                                                                                
ORDTRX16 CLI   FFTEL,0                                                          
         JE    ORDTRX24                                                         
         CLI   FFTEL,FFTELQ                                                     
         JE    ORDTRX20                                                         
         CLI   FFTEL,AFCELQ                                                     
         JE    ORDTRX23                                                         
ORDTRX18 IC    R0,FFTLN                                                         
         AR    R4,R0                                                            
         J     ORDTRX16                                                         
*                                                                               
ORDTRX20 CLI   FFTTYPE,FFTTESTN                                                 
         JNE   ORDTRX22                                                         
         MVC   JB_ESTN,FFTDATA                                                  
         J     ORDTRX18                                                         
                                                                                
ORDTRX22 CLI   FFTTYPE,FFTTEXTY                                                 
         JNE   ORDTRX18                                                         
         MVC   JB_ETYP,FFTDATA                                                  
         J     ORDTRX18                                                         
*                                                                               
         USING AFCELD,R4                                                        
ORDTRX23 MVC   JB_TFCC,AFCCURR     Foreign currrency code                       
         MVC   JB_TFCR,AFCX        rate                                         
         J     ORDTRX18                                                         
*                                                                               
ORDTRX24 CLC   JB_ORDN,SPACES      for order trxs show no ref number            
         JNH   ORDTRX26                                                         
         MVC   JB_REFN,SPACES                                                   
                                                                                
ORDTRX26 XC    X#PIDAP,X#PIDAP                                                  
                                                                                
         GOTOR SETALL,0                                                         
                                                                                
         GOTOR SETCWP,2                                                         
                                                                                
         MVC   JB_BILNO,SPACES                                                  
*&&US                                                                           
         CLC   TRNKWORK,BILWC      Are we doing a bill?                         
         JNE   *+10                                                             
         MVC   JB_BILNO,TRNKREF                                                 
*&&                                                                             
         GOTOR PROBIL              process bill number(s) and download          
                                                                                
         OC    X#MWCIND,X#MWCIND   Repeat for multiple w/cs                     
         JZ    ORDTRX2             next record                                  
         USING OAMELD,R4                                                        
         L     R4,X#MWCIND                                                      
                                                                                
ORDTRX28 CP    OAMAMNT,OAMIVAL     Has full amount been invoiced?               
         JE    ORDTRX30            Yes - Skip display                           
*&&UK                                                                           
         CLI   OAMLN,OAMLN1Q                                                    
         BNH   ORDTRX29                                                         
         ZAP   JB_TFCA,OAMFCAMT                                                 
         SP    JB_TFCA,OAMFCIVL                                                 
*&&                                                                             
ORDTRX29 MVC   JB_WCOD,OAMWORK     loop through order and add one               
         ZAP   JB_OAMT,OAMAMNT                                                  
         SP    JB_OAMT,OAMIVAL                                                  
         ZAP   JB_OINV,OAMIVAL                                                  
*        MVC   JB_BILNO,SPACES                                                  
         GOTOR SETCWP,2            record per w/c based on main w/c             
         GOTOR LP_APUTO,LP_D                                                    
ORDTRX30 LLC   R0,OAMLN                                                         
         AR    R4,R0                                                            
         CLI   OAMEL,OAMELQ                                                     
         JNE   ORDTRX2             next record                                  
         J     ORDTRX28                                                         
                                                                                
ORDTRXY  CR    RB,RB                                                            
         XIT1                                                                   
                                                                                
ORDTRXN  LTR   RB,RB                                                            
         XIT1                                                                   
         LTORG                                                                  
         DROP  R3,R4                                                            
***********************************************************************         
* GET TRANSACTION DETAILS                                             *         
***********************************************************************         
GETTRN   NTR1  BASE=*,LABEL=NO     *** TRANSACTIONS ***                         
         J     *+12                                                             
         DC    C'*GETTRN*'                                                      
*                                                                               
         USING TRNRECD,R2                                                       
         LA    R2,IOKEY                                                         
         MVC   TRNKEY,SPACES                                                    
         MVC   TRNKCPY,CUXCPY                                                   
         MVC   TRNKULA(2),PRODUL                                                
         MVC   TRNKACT,RQ_JBACT                                                 
         CLI   RQ_JBTYP,RQ_JBACC   no w/c for Accounting view                   
         JE    GETTRN2                                                          
         MVC   TRNKWORK,RQ_JBWRK                                                
                                                                                
GETTRN2  MVC   SAVEKEY1,TRNKEY                                                  
         MVC   TEMP2,SPACES                                                     
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    GETTRN6                                                          
         J     GETTRNN                                                          
                                                                                
GETTRN4  LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JNE   GETTRNN                                                          
                                                                                
GETTRN6  CLC   TRNKCULA,SAVEKEY1                                                
         JNE   GETTRNY                                                          
                                                                                
         CLI   RQ_JBTYP,RQ_JBACC   no w/c for Accounting view                   
         JE    GETTRN8                                                          
         CLC   TRNKWORK,RQ_JBWRK                                                
         JNE   GETTRNY                                                          
         J     GETTRN10                                                         
                                                                                
GETTRN8  CLC   TRNKWORK,ORDWC      skip order trxs here                         
         JE    GETTRN4                                                          
                                                                                
GETTRN10 OC    TRNKEY+36(6),TRNKEY+36    C/A header record?                     
         JNZ   GETTRN12                                                         
                                                                                
         GOTOR PROCAC              Process contra account                       
                                                                                
         J     GETTRN4                                                          
                                                                                
GETTRN12 CLC   TRNKREF,SPACES      Skip other records                           
         JE    GETTRN4                                                          
                                                                                
         TM    TRNKSTAT,TRNSREVS                                                
         JNZ   GETTRN4                                                          
                                                                                
         LHI   R1,IOGET+IOMST+IO2                                               
         TM    TRNKSTAT,TRNSARCH                                                
         JZ    *+8                                                              
         LHI   R1,IOGET+IOARC+IO2                                               
                                                                                
         GOTOR (#IOEXEC,AIOEXEC)                                                
         JE    *+6                                                              
         DC    H'0'                                                             
         CLC   TRNKULC(L'TRNKCUNT+L'TRNKCLDG),=C'1R'  IS IT TIMESHEETS?         
         JNE   GETTRN13                                                         
         CLC   TRNKDATE,SPACES                                                  
         JNH   GETTRN13                                                         
         GOTOR FLTTIM,DMCB,AIO2    FILTER TRANSACTIONS                          
         JNE   GETTRN4                                                          
                                                                                
GETTRN13 GOTOR CLRJBV              clear output values                          
                                                                                
         USING TRNELD,R3                                                        
         L     R2,AIO2                                                          
         LA    R3,TRNRFST                                                       
         CLI   TRNEL,TRNELQ                                                     
         JNE   GETTRN4                                                          
                                                                                
         CLI   RQ_JBTYP,RQ_JBBIL   Billing view                                 
         JE    GETTRN62                                                         
                                                                                
         MVI   X#FBADV,NOQ                                                      
         TM    TRNRSTAT,TRNSDRFT   FlexiBill advance?                           
         BZ    GETTRN14                                                         
         CLI   TRNTYPE,99                                                       
         BNE   GETTRN4                                                          
         MVI   X#FBADV,YESQ                                                     
                                                                                
GETTRN14 MVC   JB_REFN,SPACES                                                   
         MVC   JB_REFN(L'TRNREF),TRNREF                                         
         MVC   JB_INTR,SPACES                                                   
         MVC   JB_WCOD,TRNKWORK                                                 
         ZAP   JB_TALL,PZERO                                                    
         ZAP   JB_COMB,PZERO                                                    
         ZAP   JB_TCRE,PZERO                                                    
         ZAP   JB_TDEB,PZERO                                                    
         CLC   TRNKWORK,BILWC                                                   
         JNE   GETTRN15                                                         
*&&US                                                                           
         CLI   TRNLN,TRNLN1Q                                                    
         JNH   GETTRN16                                                         
         ZAP   JB_COMB,TRNBLCOM                                                 
*&&                                                                             
         J     GETTRN16                                                         
                                                                                
GETTRN15 CLI   TRNLN,TRNLN1Q                                                    
         JNH   GETTRN16                                                         
         LLC   RE,TRNLN                                                         
         SHI   RE,TRNLN1Q                                                       
         CHI   RE,L'JB_NARR                                                     
         JL    *+8                                                              
         LA    RE,L'JB_NARR                                                     
         SHI   RE,1                                                             
         MVC   JB_NARR(0),TRNNARR                                               
         EX    RE,*-6                                                           
                                                                                
         USING FFTELD,R4                                                        
GETTRN16 LR    R4,R3                                                            
         XR    R0,R0                                                            
         MVI   BYTE1,NOQ                                                        
         ZAP   DUB1,PZERO                                                       
         ZAP   DUB2,PZERO                                                       
         ZAP   DUB,PZERO                                                        
                                                                                
GETTRN18 IC    R0,FFTLN            read for real reference number               
         AR    R4,R0               and long invoice number                      
         CLI   FFTEL,0                                                          
         JE    GETTRN56                                                         
         CLI   FFTEL,SCIELQ                                                     
         JE    GETTRN30                                                         
*&&UK*&& CLI   FFTEL,GPXELQ                                                     
*&&UK*&& JE    GETTRN42                                                         
*&&US*&& CLI   FFTEL,PRTELQ                                                     
*&&US*&& JE    GETTRN44                                                         
         CLI   FFTEL,TRSELQ                                                     
         JE    GETTRN26                                                         
         CLI   FFTEL,FFNELQ                                                     
         JE    GETTRN48                                                         
         CLI   FFTEL,OTHELQ                                                     
         JE    GETTRN46                                                         
         CLI   FFTEL,TIMELQ                                                     
         JE    GETTRN52                                                         
         CLI   FFTEL,AFCELQ                                                     
         JE    GETTRN25                                                         
         CLI   FFTEL,FFTELQ                                                     
         JNE   GETTRN18                                                         
         CLI   FFTTYPE,FFTTKREF                                                 
         JNE   GETTRN20                                                         
         CLI   BYTE1,YESQ                                                       
         JE    GETTRN18                                                         
         MVC   JB_REFN(L'TRNREF),FFTDATA                                        
         J     GETTRN18                                                         
                                                                                
GETTRN20 CLI   FFTTYPE,FFTTEXTY                                                 
         JNE   GETTRN22                                                         
         MVC   JB_ETYP,FFTDATA                                                  
         J     GETTRN18                                                         
                                                                                
GETTRN22 CLI   FFTTYPE,FFTTESTN                                                 
         JNE   GETTRN24                                                         
         MVC   JB_ESTN,FFTDATA                                                  
         J     GETTRN18                                                         
                                                                                
GETTRN24 CLI   FFTTYPE,FFTTINVN                                                 
         JNE   GETTRN18                                                         
         MVI   BYTE1,YESQ                                                       
         MVC   JB_REFN,SPACES                                                   
         LLC   RE,FFTDLEN                                                       
         SHI   RE,1                                                             
         JNP   GETTRN18                                                         
         MVC   JB_REFN(0),FFTDATA                                               
         EX    RE,*-6                                                           
         J     GETTRN18                                                         
                                                                                
         USING AFCELD,R4                                                        
GETTRN25 MVC   JB_TFCC,AFCCURR     Foreign currrency                            
         ZAP   JB_TFCA,AFCAMNT                                                  
         MVC   JB_TFCR,AFCX                                                     
         J     GETTRN18                                                         
                                                                                
         USING TRSELD,R4                                                        
GETTRN26 MVC   JB_USRID,TRSUSER    Save the user id number                      
         MVI   JB_TAST,JB_TAAPQ    trx appr status - def=approved               
                                                                                
         CLI   X#FBADV,YESQ        FlexiBill advance                            
         JE    GETTRN28                                                         
                                                                                
         OC    TRSSTAT4,TRSSTAT4   set trx status                               
         JZ    GETTRN28                                                         
         MVI   JB_TAST,JB_TAIPQ                                                 
         TM    TRSSTAT4,TRSSSAVT                                                
         JNZ   GETTRN28                                                         
         MVI   JB_TAST,JB_TARJQ                                                 
         TM    TRSSTAT4,TRSSREJT                                                
         JNZ   GETTRN28                                                         
         MVI   JB_TAST,JB_TASUQ                                                 
         TM    TRSSTAT4,TRSSSUBT                                                
         JNZ   GETTRN28                                                         
         MVI   JB_TAST,JB_TAPAQ                                                 
         TM    TRSSTAT4,TRSSSJAT                                                
         JNZ   GETTRN28                                                         
         TM    TRSSTAT4,TRSSMAAP                                                
         JNZ   GETTRN28                                                         
         MVI   JB_TAST,C'?'        what is this?                                
                                                                                
GETTRN28 DS    0H                                                               
         J     GETTRN18                                                         
                                                                                
         USING SCIELD,R4                                                        
GETTRN30 DS    0H                                                               
*&&UK                                                                           
         CLI   SCITYPE,SCITSJHR    real hours                                   
         JNE   GETTRN32                                                         
         CLI   RQ_JBHRS,NOQ        filter out hours                             
         JE    GETTRN4                                                          
         ZAP   DUB1,SCIAMNT                                                     
         ZAP   DUB,SCIAMNT                                                      
         J     GETTRN18                                                         
                                                                                
GETTRN32 CLI   SCITYPE,SCITCRAT    memo hours                                   
         JNE   GETTRN36                                                         
         CLC   TRNKWORK,BILWC      drop for w/c=99 as it will be                
         JE    GETTRN34            SCITCOMM                                     
         CLI   X#FBADV,YESQ                                                     
         JE    GETTRN18            SCITCOMM                                     
         CP    TRNAMNT,PZERO       skip if billable time                        
         JNE   GETTRN18                                                         
         CLI   RQ_JBHRS,NOQ        filter out hours                             
         JE    GETTRN4                                                          
         ZAP   DUB2,SCIAMNT                                                     
         J     GETTRN18                                                         
                                                                                
GETTRN34 ZAP   JB_COMB,SCIAMNT                                                  
         J     GETTRN18                                                         
                                                                                
GETTRN36 CLI   SCITYPE,SCITMCRT    COST AMOUNT                                  
         JE    GETTRN38                                                         
         CLI   SCITYPE,SCITMSRT    SALES AMOUNT                                 
         JE    GETTRN40                                                         
                                                                                
         CLI   SCITYPE,SCITMEXP    MEMO EXPENSES (EXPENSE INVOICES)             
*&&                                                                             
*&&US*&& CLI   SCITYPE,SCITSJXP    MEMO EXPENSES (EXPENSE INVOICES)             
         JNE   GETTRN18                                                         
         CP    TRNAMNT,PZERO       ZERO?                                        
         JNE   GETTRN18                                                         
         L     RF,AGOXBLCK                                                      
         TM    SAVEIND,SAVESTC     doing estimate checking instead?             
         JNZ   GETTRN37                                                         
         CLI   GODEIS-GOXBLOCK(RF),GODEIN no                                    
         JE    GETTRN4                                                          
*                                                                               
         CLI   GODEIS-GOXBLOCK(RF),GODAMT amount                                
         JNE   GETTRN18                                                         
         J     GETTRN3A                                                         
*                                                                               
GETTRN37 CLI   GOEMIN-GOXBLOCK(RF),GONO  include them?                          
         JE    GETTRN4                                                          
*                                                                               
GETTRN3A LA    RE,JB_TDEB                                                       
         TM    TRNSTAT,TRNSDR                                                   
         JNZ   *+8                                                              
         LA    RE,JB_TCRE                                                       
         ZAP   0(L'JB_TCRE,RE),SCIAMNT                                          
         J     GETTRN18                                                         
*                                                                               
GETTRN38 ZAP   JB_CACR,SCIAMNT     TIME COST AMOUNT                             
         CP    TRNAMNT,PZERO       R-time has zero amount                       
         JNE   GETTRN18                                                         
         L     RF,AGOXBLCK                                                      
         CLI   GOINCR-GOXBLOCK(RF),YESQ R time to be treated as actual          
         JE    *+12                                                             
         TM    SAVEIND,SAVESTC     estimate check instead?                      
         JZ    GETTRN18                                                         
         CLI   GOCSAT-GOXBLOCK(RF),GOCSCOST Want cost amount?                   
         JNE   GETTRN18                                                         
         LA    RE,JB_TDEB                                                       
         TM    TRNSTAT,TRNSDR                                                   
         JNZ   *+8                                                              
         LA    RE,JB_TCRE                                                       
         ZAP   0(L'JB_TCRE,RE),SCIAMNT                                          
         J     GETTRN18                                                         
*                                                                               
GETTRN40 ZAP   JB_CASR,SCIAMNT     TIME SALES AMOUNT                            
         CP    TRNAMNT,PZERO       R-time has zero amount                       
         JNE   GETTRN18                                                         
         L     RF,AGOXBLCK                                                      
         CLI   GOINCR-GOXBLOCK(RF),YESQ R time to be treated as actual          
         JE    *+12                                                             
         TM    SAVEIND,SAVESTC     estimate check instead?                      
         JZ    GETTRN18                                                         
         CLI   GOCSAT-GOXBLOCK(RF),GOCSSALE Want sale amount?                   
         JNE   GETTRN18                                                         
         LA    RE,JB_TDEB                                                       
         TM    TRNSTAT,TRNSDR                                                   
         JNZ   *+8                                                              
         LA    RE,JB_TCRE                                                       
         ZAP   0(L'JB_TCRE,RE),SCIAMNT                                          
         J     GETTRN18                                                         
*                                                                               
*&&UK                                                                           
         USING GPXELD,R4                                                        
GETTRN42 CLI   GPXTYP,GPXNVLQ      ONLY FOR DETAILS AND EXTENDED DETAIL         
         JNE   GETTRN18                                                         
         LLC   RF,GPXLN                                                         
         SHI   RF,GPXLN1Q+1                                                     
         MVC   JB_INVN(0),GPXDATA  INVOICE NUMBER                               
         EX    RF,*-6                                                           
         J     GETTRN18                                                         
*                                                                               
*&&                                                                             
*&&US                                                                           
         USING PRTELD,R4                                                        
GETTRN44 TM    PRTSTAT,PRTSBILQ    Is this B-Time?                              
         JNO   GETTRN45                                                         
         CLI   RQ_JBHRS,NOQ        filter out hours                             
         JE    GETTRN4                                                          
         ZAP   DUB,PRTHOUR                                                      
         ZAP   DUB1,PRTHOUR                                                     
         J     GETTRN18                                                         
GETTRN45 CLI   RQ_JBHRS,NOQ        filter out hours                             
         JE    GETTRN4                                                          
         ZAP   DUB1,PRTHOUR        add Non-B-Time hours                         
         TM    PRTSTAT,PRTSRTEQ    Is this R-Time?                              
         JNO   GETTRN18                                                         
         ZAP   DUB,PRTRATE                                                      
         MP    DUB,PRTHOUR                                                      
         DP    DUB,=P'100'                                                      
         ZAP   DUB2,DUB(6)                                                      
         ZAP   DUB,=P'0'                                                        
*        ZAP   DUB,PRTRATE         MBLAU keeps making me change this            
         ZAP   DUB,DUB2            MBLAU keeps making me change this            
         J     GETTRN18                                                         
         DROP  R4                                                               
*&&                                                                             
         USING OTHELD,R4                                                        
GETTRN46 MVC   JB_INTR,OTHNUM      internal reference                           
         J     GETTRN18                                                         
                                                                                
         USING FFNELD,R4                                                        
GETTRN48 MVC   JB_ORDN,FFNONUM     set order number from matching               
         J     GETTRN18                                                         
                                                                                
         USING TIMELD,R4                                                        
GETTRN52 CLI   TIMETYP,TIMEEST                                                  
         BNE   GETTRN54                                                         
         MVC   JB_ESTN,TIMSESNM                                                 
         J     GETTRN18                                                         
                                                                                
GETTRN54 CLI   TIMETYP,TIMEORDR                                                 
         BNE   GETTRN18                                                         
         MVC   JB_ORDN,TIMOORDR                                                 
         J     GETTRN18                                                         
                                                                                
GETTRN56 MVI   JB_TYPE,RQ_JBWCD                                                 
         MVI   JB_DTYP,C'T'                                                     
         MVC   JB_EORI,X#WCTIE                                                  
         MVC   JB_CACC,TRNKULC                                                  
         MVC   JB_CACN,X#CANAME                                                 
         CLI   X#FBADV,YESQ        FlexiBill advance                            
         JE    *+10                                                             
         MVC   JB_DATE,TRNKDATE                                                 
         ZAP   JB_THRS,DUB1                                                     
         ZAP   JB_MHRS,DUB2                                                     
         ZAP   JB_CHTI,DUB                                                      
         CP    TRNAMNT,PZERO                                                    
         JE    GETTRN57                                                         
         LA    RE,JB_TDEB                                                       
         TM    TRNSTAT,TRNSDR                                                   
         JNZ   *+8                                                              
         LA    RE,JB_TCRE                                                       
         ZAP   0(L'JB_TCRE,RE),TRNAMNT                                          
                                                                                
GETTRN57 GOTOR SETALL,0                                                         
                                                                                
         ZAP   JB_CORA,PZERO                                                    
         OC    X#CURCR,X#CURCR                                                  
         JZ    GETTRN58                                                         
         ZAP   JB_CORA,X#CURCR                                                  
                                                                                
GETTRN58 MVI   JB_BSTA,C'U'                                                     
         TM    X#PGSTAT,PG$FULLB+PG$PARTB                                       
         JZ    GETTRN60                                                         
         MVI   JB_BSTA,C'F'                                                     
         TM    X#PGSTAT,PG$FULLB                                                
         JNZ   GETTRN60                                                         
         MVI   JB_BSTA,C'P'                                                     
                                                                                
GETTRN60 XC    X#PIDAP,X#PIDAP                                                  
         GOTOR SETCWP,2                                                         
                                                                                
         MVC   JB_BILNO,SPACES                                                  
*&&US                                                                           
         CLC   TRNKWORK,BILWC      Are we doing a bill?                         
         JNE   *+10                                                             
         MVC   JB_BILNO,TRNKREF                                                 
*&&                                                                             
         GOTOR PROBIL              process bill number(s) and download          
                                                                                
         J     GETTRN4                                                          
         DROP  R3,R4                                                            
                                                                                
         USING TRNELD,R3                                                        
GETTRN62 DS    0H                  BILLING VIEW PROCESSING                      
                                                                                
         TM    TRNRSTAT,TRNSDRFT   skip drafts                                  
         BNZ   GETTRN4                                                          
                                                                                
         MVI   JB_TYPE,RQ_JBWCD                                                 
         MVI   JB_DTYP,RQ_JBBIL                                                 
         MVI   JB_EORI,C'E'                                                     
                                                                                
         MVC   JB_REFN(L'TRNREF),TRNREF                                         
         MVC   JB_WCOD,TRNKWORK                                                 
         MVC   JB_CACC,TRNKULC                                                  
         MVC   JB_CACN,X#CANAME                                                 
         MVC   JB_DATE,TRNKDATE                                                 
         ZAP   JB_TCRE,TRNAMNT                                                  
         MVI   JB_TAST,JB_TAAPQ    if bill then fully approved                  
*&&US                                                                           
         CLI   TRNLN,TRNLN1Q                                                    
         JNH   GETTRN64                                                         
         ZAP   JB_TCOM,TRNBLCOM                                                 
         ZAP   JB_TGRS,TRNBLPAY                                                 
GETTRN64 DS    0H                                                               
         ZAP   JB_TALL,PZERO                                                    
         GOTOR SETALL,2                                                         
                                                                                
         ZAP   JB_CORA,PZERO                                                    
         OC    X#CURCR,X#CURCR                                                  
         JZ    *+10                                                             
         ZAP   JB_CORA,X#CURCR                                                  
*&&                                                                             
                                                                                
                                                                                
         XC    X#PIDAP,X#PIDAP                                                  
         ZAP   DUB1,PZERO                                                       
         ZAP   DUB2,PZERO                                                       
         ZAP   X#DUB,PZERO                                                      
                                                                                
         USING FFTELD,R4                                                        
         LR    R4,R3                                                            
         XR    R0,R0                                                            
         MVI   BYTE1,NOQ                                                        
                                                                                
GETTRN66 IC    R0,FFTLN            read for real reference number               
         AR    R4,R0               and long invoice number                      
         CLI   FFTEL,0                                                          
         JE    GETTRN88                                                         
         CLI   FFTEL,TRSELQ                                                     
         JE    GETTRN74                                                         
         CLI   FFTEL,PIDELQ                                                     
         JE    GETTRN76                                                         
         CLI   FFTEL,OTHELQ                                                     
         JE    GETTRN78                                                         
         CLI   FFTEL,FFNELQ                                                     
         JE    GETTRN80                                                         
         CLI   FFTEL,AFCELQ                                                     
         JE    GETTRN82                                                         
*&&UK*&& CLI   FFTEL,SCIELQ                                                     
*&&UK*&& JE    GETTRN84                                                         
         CLI   FFTEL,FFTELQ                                                     
         JNE   GETTRN66                                                         
                                                                                
         CLI   FFTTYPE,FFTTKREF                                                 
         JNE   GETTRN68                                                         
         CLI   BYTE1,YESQ                                                       
         JE    GETTRN66                                                         
         MVC   JB_REFN(L'TRNREF),FFTDATA                                        
         J     GETTRN66                                                         
                                                                                
GETTRN68 CLI   FFTTYPE,FFTTEXTY                                                 
         JNE   GETTRN70                                                         
         MVC   JB_ETYP,FFTDATA                                                  
         J     GETTRN66                                                         
                                                                                
GETTRN70 CLI   FFTTYPE,FFTTESTN                                                 
         JNE   GETTRN72                                                         
         MVC   JB_ESTN,FFTDATA                                                  
         J     GETTRN66                                                         
                                                                                
GETTRN72 CLI   FFTTYPE,FFTTINVN                                                 
         JNE   GETTRN66                                                         
         MVI   BYTE1,YESQ                                                       
*&&US*&& CLC   JB_REFN,SPACES      Do we have a Bill #?                         
*&&US*&& BH    GETTRN66                                                         
         MVC   JB_REFN,SPACES                                                   
         LLC   RE,FFTDLEN                                                       
         SHI   RE,1                                                             
         JNP   GETTRN66                                                         
         MVC   JB_REFN(0),FFTDATA                                               
         EX    RE,*-6                                                           
         J     GETTRN66                                                         
                                                                                
         USING TRSELD,R4                                                        
GETTRN74 DS    0H                                                               
         MVC   JB_USRID,TRSUSER                                                 
         J     GETTRN66                                                         
                                                                                
         USING PIDELD,R4                                                        
GETTRN76 MVC   X#PIDAP,PIDNO                                                    
         J     GETTRN66                                                         
                                                                                
         USING OTHELD,R4                                                        
GETTRN78 MVC   JB_INTR,OTHNUM      internal reference                           
         J     GETTRN66                                                         
                                                                                
         USING FFNELD,R4                                                        
GETTRN80 MVC   JB_ORDN,FFNONUM     set order number from matching               
         J     GETTRN66                                                         
                                                                                
         USING AFCELD,R4                                                        
GETTRN82 MVC   JB_TFCC,AFCCURR     Foreign currrency                            
         ZAP   JB_TFCA,AFCAMNT                                                  
         MVC   JB_TFCR,AFCX                                                     
         J     GETTRN66                                                         
                                                                                
*&&UK                                                                           
         USING SCIELD,R4                                                        
GETTRN84 CLI   SCITYPE,SCITCOMM    Commission billed                            
         JNE   GETTRN86                                                         
         CLC   TRNKWORK,BILWC                                                   
         JNE   GETTRN66                                                         
         AP    X#DUB,SCIAMNT                                                    
         J     GETTRN66                                                         
                                                                                
GETTRN86 TM    SCITYPE,X'40'      VAT type?                                     
         JNZ   GETTRN66                                                         
         MVC   BYTE1,SCITYPE                                                    
         NI    BYTE1,X'F0'                                                      
         CLI   BYTE1,X'B0'        Test billing type?                            
         JE    GETTRN66           Yes - get next                                
                                                                                
         AP    DUB1,SCIVBIL                                                     
         AP    DUB2,SCIGBIL                                                     
                                                                                
* If VAT rate(s) required then see ACENQ06 (PREVB53B)                           
                                                                                
         J     GETTRN66                                                         
                                                                                
GETTRN88 ZAP   JB_TVAT,DUB1        Set VAT                                      
         ZAP   JB_TGRS,DUB1        Set gross billed amount                      
         AP    JB_TGRS,DUB2                                                     
         ZAP   JB_TCOM,X#DUB                                                    
                                                                                
         CLI   TRNLN,TRNLNBQ       Billing narrative (AC21/ACDB)                
         JNE   GETTRN90                                                         
                                                                                
         ZAP   DUB1,TRNGRSXR       Add up payables + commission                 
         AP    DUB1,TRNGRSZR                                                    
         AP    DUB1,TRNGRSR1                                                    
         AP    DUB1,TRNGRSR2                                                    
         AP    DUB1,TRNGRSR3                                                    
         AP    DUB1,TRNGRSR4                                                    
         AP    DUB1,TRNGRSR5                                                    
         AP    DUB1,TRNCOMM                                                     
                                                                                
         ZAP   X#DUB,TRNCOMM                                                    
                                                                                
         ZAP   DUB2,TRNVATR1       Add up VAT                                   
         AP    DUB2,TRNVATR2                                                    
         AP    DUB2,TRNVATR3                                                    
         AP    DUB2,TRNVATR4                                                    
         AP    DUB2,TRNVATR5                                                    
                                                                                
         ZAP   JB_TVAT,DUB2        Set VAT                                      
         ZAP   JB_TGRS,DUB2        Set gross billed amount                      
         AP    JB_TGRS,DUB1                                                     
         ZAP   JB_TCOM,X#DUB       Set commission                               
                                                                                
* If VAT rate(s) required then see ACENQ06 (PREVB26)                            
*&&                                                                             
                                                                                
*&&US                                                                           
GETTRN88 DS    0H                                                               
*&&                                                                             
GETTRN90 CLI   RQ_JBTYP,RQ_JBBIL   Billing view then get comm rate              
         JNE   GETTRN92                                                         
                                                                                
         GOTOR SETALL,2                                                         
         ZAP   JB_CORA,PZERO                                                    
         OC    X#CURCR,X#CURCR                                                  
         BZ    GETTRN92                                                         
         ZAP   JB_CORA,X#CURCR                                                  
                                                                                
GETTRN92 GOTOR GETDDET             GET DEBTOR DETAILS                           
         MVC   IOKEY,SAVEKEY3                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2' RESTORE READ SEQUENCE         
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
GETTRN94 DS    0H                  put out values                               
                                                                                
         GOTOR SETCWP,2                                                         
                                                                                
         GOTOR LP_APUTO,LP_D                                                    
                                                                                
         J     GETTRN4                                                          
                                                                                
GETTRNY  CR    RB,RB                                                            
         XIT1                                                                   
                                                                                
GETTRNN  LTR   RB,RB                                                            
         DROP  R3,R4                                                            
         XIT1                                                                   
         LTORG                                                                  
***********************************************************************         
* GET ESTIMATE DETAILS                                                *         
***********************************************************************         
         USING ESTRECD,R2                                                       
GETEST   NTR1  BASE=*,LABEL=NO     *** ESTIMATES ***                            
         J     *+12                                                             
         DC    C'*GETEST*'                                                      
                                                                                
         MVI   TSARTYPE,TSARTESQ                                                
         GOTOR GOTSAR,DMCB,('TSAINI',0)                                         
         LA    R2,IOKEY                                                         
         XC    ESTKEY,ESTKEY                                                    
         MVI   ESTKTYP,ESTKTYPQ                                                 
         MVI   ESTKSUB,ESTKSUBQ                                                 
         MVC   ESTKCPY,CUXCPY                                                   
         MVC   ESTKCLI,X#CLIC                                                   
         MVC   ESTKPRO,X#PROC                                                   
         MVC   ESTKJOB,X#JOBC                                                   
                                                                                
         MVC   SAVEKEY1,ESTKEY                                                  
         XC    X#PIDAP,X#PIDAP                                                  
         MVI   BYTE2,0                                                          
                                                                                
GETEST2  GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JNE   GETEST12                                                         
                                                                                
GETEST4  CLC   SAVEKEY1(ESTKLNO-ESTRECD),ESTKEY                                 
         JNE   GETEST10                                                         
                                                                                
         CLI   BYTE2,0                                                          
         JE    GETEST6                                                          
         CLC   BYTE2,ESTKLNO                                                    
         JE    GETEST6                                                          
                                                                                
         GOTOR OUTEST              put out current entry                        
         MVI   TSARTYPE,TSARTESQ                                                
         GOTOR GOTSAR,DMCB,('TSAINI',0)                                         
                                                                                
GETEST6  CLI   ESTKSEQ,ESTKSMQ     sequentials need to be passed here           
         JNE   GETEST8                                                          
                                                                                
         MVC   BYTE2,ESTKLNO                                                    
                                                                                
         TM    ESTKSTA1,ESTKCAPP+ESTKSUBM                                       
         JNZ   GETEST8                                                          
                                                                                
         MVI   ESTKSEQ,FF          get next if neither appr nor subm            
         J     GETEST2                                                          
                                                                                
GETEST8  GOTOR ADDEST              add estimate                                 
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JE    GETEST4                                                          
         J     GETEST12                                                         
                                                                                
GETEST10 GOTOR OUTEST              put out last entry                           
                                                                                
         J     PROJBWDY                                                         
         DROP  R2                                                               
                                                                                
GETEST12 MVC   ROUERRV,=AL2(AE$TMTRN)                                           
         J     GETESTN                                                          
                                                                                
GETESTY  CR    RB,RB                                                            
         XIT1                                                                   
                                                                                
GETESTN  LTR   RB,RB                                                            
         XIT1                                                                   
         LTORG                                                                  
*                                                                               
***********************************************************************         
* Interface to TSAR                                                   *         
*                                                                     *         
***********************************************************************         
                                                                                
GOTSAR   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*GOTSAR*'                                                      
                                                                                
         LR    R2,R1               R2=A(Caller's parameter list)                
TB       USING TSARD,TSARRECS      R3=A(TSAR block)                             
         LA    R1,ES_BUFF                                                       
         ST    R1,TB.TSAREC        Address of record buffer area                
         CLI   TSARTYPE,TSARTESQ                                                
         JE    GOTSAR00                                                         
         LA    R1,CSVKEY3          (CSVKEY3/CSVKEY4)                            
         ST    R1,TB.TSAREC                                                     
         CLI   TSARTYPE,TSARTJSQ                                                
         JE    GOTSAR00                                                         
         DC    H'0'                                                             
GOTSAR00 CLI   0(R2),TSAINI        Test initialisation call                     
         JNE   GOTSAR02                                                         
         XC    TB.TSARD(TSPNEWL),TB.TSARD                                       
         MVC   TB.TSACTN,0(R2)                                                  
         MVC   TB.TSACOM,ACOMFACS                                               
         LHI   R0,1024                                                          
         OC    TB.TSBUFFL,TB.TSBUFFL                                            
         JNZ   *+8                                                              
         STCM  R0,3,TB.TSBUFFL      Set require 1MB off-line                    
         MVI   TB.TSRECI,TSRXTN+TSRMINB1+TSRVAR                                 
         MVI   TB.TSKEYL,ESTTKYL    Set key length - estimates                  
         LHI   R0,500                                                           
         CLI   TSARTYPE,TSARTESQ                                                
         JE    GOTSAR01                                                         
         MVI   TB.TSKEYL,JSBDKYL                   - job search                 
         LHI   R0,JSBDLNQ                                                       
         CLI   TSARTYPE,TSARTJSQ                                                
         JE    GOTSAR01                                                         
         DC    H'0'                                - unknown                    
GOTSAR01 MVI   TB.TSINDS,TSINODSK   Set no disk writes (save/restore)           
         MVI   TB.TSIND2,TSI2MANY                                               
         STCM  R0,3,TB.TSRECL       Set maximum record length                   
         GOTOR VTSAR,TB.TSARD                                                   
         TM    TB.TSINDS,TSIINIOK                                               
         JNZ   GOTSARY                                                          
         DC    H'0'                 Initialisation failure                      
                                                                                
GOTSAR02 TM    TB.TSINDS,TSIINIOK   Test initialised                            
         JZ    GOTSAR06                                                         
                                                                                
         MVC   TB.TSACTN,0(R2)      Set action                                  
                                                                                
         CLI   TB.TSACTN,TSASRT     Test sorting                                
         JNE   GOTSAR04                                                         
         L     R1,4(R2)                                                         
         MVC   TB.TSRTPARM,0(R1)    Yes - set sort parameters                   
                                                                                
GOTSAR04 GOTOR VTSAR,TB.TSARD       Call TSAR                                   
         MVC   TSARERRS,TB.TSERRS   Return TSARERRS                             
         J     GOTSARX                                                          
                                                                                
GOTSAR06 MVI   TSARERRS,TSEEOF                                                  
                                                                                
GOTSARX  CLI   TSARERRS,0          Set condition code for caller                
         JNE   GOTSARN                                                          
GOTSARY  CR    RB,RB                                                            
         XIT1                                                                   
                                                                                
GOTSARN  LTR   RB,RB                                                            
         XIT1                                                                   
         DROP  TB                                                               
         LTORG                                                                  
         EJECT                                                                  
                                                                                
* JobList/Search - Estimate % Committed                                         
ESTPCC   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*ESTPCC*'                                                      
                                                                                
         ZAP   JD_EPC,PZERO                                                     
         MVI   JD_COL,JD_COLWQ                                                  
         CLI   RQ_JDEPC,YESQ                                                    
         BNE   ESTPCCX                                                          
                                                                                
         STC   R1,X#CALLER         (0=XJOBOUT, 1=GETSVV)                        
         MVI   X#HIGH,YESQ         there will be IOs ...                        
                                                                                
         ZAP   X#TEST,PZERO                                                     
         ZAP   X#TUOR,PZERO                                                     
         ZAP   X#TCRE,PZERO                                                     
         ZAP   X#TDEB,PZERO                                                     
                                                                                
         L     R0,AIO6             Copy SJ job to AIO6 and emulate it           
         LA    R1,IOLENQ                                                        
         L     RE,AIO2                                                          
         LR    RF,R1                                                            
         MVCL  R0,RE                                                            
                                                                                
         LA    R2,DMCB                                                          
         GOTO1 VACCEMU,DMCB,=C'NEWO',,AIO6,AIO6                                 
                                                                                
         USING GOBLOCKD,R3                                                      
         L     R3,AGOBLOCB                                                      
                                                                                
*&&UK                                                                           
ESTPCC04 ZAP   X#CEAMBR,GOCEAMBR   CURRENT ESTIMATE AMBER WARNING               
         ZAP   X#CERED,GOCERED     CURRENT ESTIMATE RED WARNING                 
         DROP  R3                                                               
*&&                                                                             
*&&US                                                                           
         USING GOXBLKD,RE                                                       
ESTPCC04 L     RE,AGOXBLCK                                                      
         ZAP   X#CEAMBR,GOCEAMBR   CURRENT ESTIMATE AMBER WARNING               
         ZAP   X#CERED,GOCERED     CURRENT ESTIMATE RED WARNING                 
         DROP  R3,RE                                                            
*&&                                                                             
                                                                                
*&&UK*&& GOTO1 VJOBCOL,DMCB,(X'FF',JOBFLDS),ACOLIST,ACOMFACS                    
*&&US*&& GOTO1 VJOBCOL,DMCB,LOOKFLDH,ACOLIST,ACOMFACS                           
         CLI   4(R1),0                                                          
*&&UK*&& BE    ESTPCC06                                                         
*&&US*&& BNE   ESTPCC06                                                         
         DC    H'0'                                                             
                                                                                
         USING JBLOCKD,R3                                                       
ESTPCC06 GOTOR GETTUP              read in and validate TUP profile             
         L     R3,AJOBLOCK                                                      
         LR    RE,R3                                                            
         LHI   RF,JBLOCKL                                                       
         XCEF                                                                   
         MVC   JBAJOB,AIO6                                                      
         MVC   JBACOLS,ACOLIST                                                  
         MVC   JBACOM,ACOMFACS                                                  
*&&UK*&& MVC   JBCSHVAL,VCASHVAL                                                
*&&UK*&& MVC   JBTOBACO,VTOBACCO                                                
         MVC   JBAGOBLK,AGOBLOCB                                                
         MVC   JBAIO,AIO3                                                       
         MVC   JBGETOPT,VGETOPT                                                 
         MVC   JBAOPVTB,AELEAREA   Use ELEAREA here                             
         LHI   RE,L'ELEAREA                                                     
         ST    RE,JBLOPVTB                                                      
*        MVC   JBACOLTB,ACOLTAB                                                 
                                                                                
                                                                                
         MVC   JBACOLTB,AFREEST    Uses FREESTOR+GENAETXN                       
                                                                                
         LHI   RE,L'FREESTOR+L'GENAEXTN                                         
         ST    RE,JBLCOLTB                                                      
         MVI   JBSELFUN,JBGETDE     MCS: GET DETAILS AND SET ORIGINAL           
*&&UK*&& LA    RE,JOBFLDS               COLUMN LIST  ADDRESS (OE/CE)            
*&&US*&& LA    RE,LOOKFLDH              COLUMN LIST  ADDRESS (OE/CE)            
         ST    RE,JBORICLI                                                      
                                                                                
         GOTO1 VJOBBER,DMCB,AJOBLOCK                                            
         CLI   JBERROR,0                                                        
         BE    ESTPCC10                                                         
         DC    H'0'                                                             
                                                                                
ESTPCC10 CLI   JBNEWEST,JBMCSQ     FOR MCS ESTIMATES                            
         BE    ESTPCC16                                                         
                                                                                
         USING JBCOLD,R4                                                        
         L     R4,JBACOLTB         R4=A(COLUMN TABLE)                           
         XR    R2,R2                                                            
         ICM   R2,3,JBNROWS        R2=(LOOP COUNTER)                            
         BZ    ESTPCC20                                                         
                                                                                
ESTPCC12 CLI   JBCOLTYP,JBCOLTWC   TEST FOR WORK CODE ENTRY                     
         BNE   ESTPCC14                                                         
                                                                                
*&&UK*&& AP    X#TEST,JBCOLVAL(L'JBCOLVAL)                                      
*&&US*&& AP    X#TEST,JBCOLVAL+6(L'JBCOLVAL)                                    
                                                                                
ESTPCC14 AH    R4,JBLCOL           NEXT TABLE ENTRY                             
         BCT   R2,ESTPCC12                                                      
         B     ESTPCC20                                                         
         DROP  R4                                                               
                                                                                
         USING MJETABD,R4                                                       
ESTPCC16 L     R4,JBACOLTB         1ST ENTRY IS TOTAL (MJETTYP=MJETTTQ)         
*&&UK*&& AP    X#TEST,MJETVAL                                                   
*&&US*&& AP    X#TEST,MJETVAL+6(L'MJETVAL)                                      
         DROP  R3,R4                                                            
                                                                                
*                                                                               
ESTPCC20 LA    R1,X#RTTRX                                                       
         USING TMSTTABD,R1                                                      
         LA    R0,TMSTNUM                                                       
ESTPCC22 CLI   TMSTMPTY,YESQ       Are interested in in progress TS             
         JE    ESTPCC24            Yes                                          
         OC    TMSTSTAT,TMSTSTAT   Are we interested in other statuses          
         JNZ   ESTPCC24            Yes                                          
         LA    R1,TMSTTABL(R1)     No - look at next entry                      
         JCT   R0,ESTPCC22                                                      
         J     ESTPCC58                                                         
         DROP  R1                                                               
                                                                                
TP       USING TSJPASD,IOKEY                                                    
ESTPCC24 XC    TP.TSJPAS,TP.TSJPAS                                              
         MVI   TP.TSJPTYP,TSJPTYPQ                                              
         MVI   TP.TSJPSUB,TSJPSUBQ                                              
         MVI   TP.TSJPVIEW,TSJPSJAQ                                             
         MVC   TP.TSJPCPY,CUXCPY                                                
         L     R1,AIO2                                                          
         MVC   TP.TSJPACT,ACTKACT-ACTKEY(R1)                                    
         MVC   TP.TSJPMED,JD_MED                                                
         MVC   TP.TSJPCOFF,JD_OFF                                               
         MVC   SAVEKEY5,TP.TSJPAS                                               
*                                                                               
ESTPCC26 GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         BE    ESTPCC30                                                         
         DC    H'0'                                                             
*                                                                               
ESTPCC28 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
         BE    ESTPCC30                                                         
         DC    H'0'                                                             
*                                                                               
ESTPCC30 CLC   TP.TSJPAS(TSJPPEDT-TSJPASD),SAVEKEY5    Match on key?            
         BNE   ESTPCC58                                                         
         GOTOR FLTTMK,DMCB,TP.TSJPASD filter time status                        
         BNE   ESTPCC28                                                         
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R3,AIO3                                                          
         AHI   R3,TIMRFST-TIMRECD                                               
*                                                                               
         USING TIMELD,R3                                                        
ESTPCC32 CLI   TIMEL,0                                                          
         BE    ESTPCC28                                                         
         CLI   TIMEL,TIMELQ                                                     
         BE    ESTPCC36                                                         
ESTPCC34 LLC   R0,TIMLN                                                         
         AR    R3,R0                                                            
         B     ESTPCC32                                                         
*                                                                               
ESTPCC36 CLI   TIMETYP,TIMEITMS                                                 
         JE    ESTPCC40                                                         
         CLI   TIMETYP,TIMEINP                                                  
         JNE   ESTPCC34                                                         
         ST    R3,FULL1            Save address of input timel                  
         L     R1,AIO2                                                          
         CLC   TIMACC,ACTKULA-ACTKEY(R1)                                        
         JNE   ESTPCC34            look for this job's items only               
                                                                                
         CLC   TIMTSK,SPACES       Have we got a workcode                       
         JNH   ESTPCC34                                                         
         CLI   TIMTTYP,TIMTCN                                                   
         JE    ESTPCC34                                                         
         GOTOR FLTTMP,DMCB,TIMELD,TP.TSJPAS                                     
         JNE   ESTPCC34                                                         
                                                                                
         ZAP   DUB1,TIMRATE        Amount = Rate * Hours                        
         MP    DUB1,TIMHRS                                                      
         SRP   DUB1,64-2,5         / 100 (hours is 2 dec places)                
*&&US*&& ZAP   DUB2,PZERO                                                       
*&&UK                                                                           
         ZAP   DUB2,TIMCRATE       Amount = Rate * Hours                        
         MP    DUB2,TIMHRS                                                      
         SRP   DUB2,64-2,5         / 100 (hours is 2 dec places)                
*&&                                                                             
         CLI   TIMTTYP,TIMTCR                                                   
         JNE   ESTPCC38                                                         
         L     RF,AGOXBLCK                                                      
         CLI   GOINCR-GOXBLOCK(RF),YESQ                                         
         JNE   ESTPCC38                                                         
         LA    R1,DUB1                                                          
*&&UK                                                                           
         CLI   GOCSAT-GOXBLOCK(RF),GOCSCOST Want cost amount?                   
         JNE   *+8                                                              
         LA    R1,DUB2                                                          
*&&                                                                             
         AP    X#TDEB,0(L'DUB2,R1)                                              
                                                                                
ESTPCC38 CLI   TIMTTYP,TIMTCB                                                   
         JNE   ESTPCC34                                                         
         AP    X#TDEB,TIMAMNT                                                   
         J     ESTPCC34                                                         
                                                                                
ESTPCC40 L     R1,AIO2                                                          
         CLC   TIMIULA,ACTKULA-ACTKEY(R1)                                       
         JNE   ESTPCC34            Look for this job's items only               
         CLC   TIMITSK,SPACES      Have we got a workcode                       
         JNH   ESTPCC34                                                         
         L     R2,FULL1            R2=A(Input timel)                            
         GOTOR FLTTMP,DMCB,(R2),TP.TSJPAS                                       
         JNE   ESTPCC34                                                         
         AP    X#TDEB,TIMITOT                                                   
         J     ESTPCC34                                                         
         DROP  TP                                                               
*                                                                               
         USING EXJPASD,R2                                                       
ESTPCC58 LA    R6,EXPTTAB                                                       
*                                                                               
ESTPCC60 LA    R2,IOKEY                                                         
         XC    EXJPAS,EXJPAS       EXPENSES                                     
         MVI   EXJPTYP,EXJPTYPQ                                                 
         MVI   EXJPSUB,EXJPSUBQ                                                 
         MVC   EXJPCPY,CUXCPY                                                   
         MVC   EXJPVIEW,0(R6)                                                   
         MVC   EXJPCOFF,JD_OFF                                                  
         L     R1,AIO2                                                          
         MVC   EXJPCPJ,ACTKACT-ACTKEY(R1)                                       
         MVC   SAVEKEY5,EXJPAS                                                  
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         BE    ESTPCC64                                                         
         DC    H'0'                                                             
                                                                                
ESTPCC62 LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
         BE    ESTPCC64                                                         
         DC    H'0'                                                             
                                                                                
ESTPCC64 CLC   EXJPAS(EXJPMED-EXJPASD),SAVEKEY5    Match on key?                
         BNE   ESTPCC70                                                         
         GOTOR FLTEXK,DMCB,EXJPAS                 filter expense claims         
         BNE   ESTPCC62                                                         
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         USING EXCRECD,R2                                                       
         L     R2,AIO3                                                          
         USING CIDELD,R3                                                        
         LA    R3,EXCRFST                                                       
         B     ESTPCC68                                                         
*                                                                               
ESTPCC66 LLC   R0,CIDLN            find appropriate CIDEL cluster(s)            
         AR    R3,R0                                                            
*                                                                               
ESTPCC68 CLI   CIDEL,0                                                          
         BE    ESTPCC62                                                         
         CLI   CIDEL,CIDELQ                                                     
         BNE   ESTPCC66                                                         
         CLI   CIDTYPE,CIDTYMQ                                                  
         BNE   ESTPCC66                                                         
*                                                                               
CUR      USING CIDELD,RF                                                        
         LA    RF,CIDELD           filter CIDEL and its cluster                 
         CLC   CIDMWCD,SPACES      Have we got a workcode                       
         BNH   ESTPCC66                                                         
         GOTOR FLTEXL,DMCB,0(RF),EXCRECD filter expense claims                  
         BNE   ESTPCC66                                                         
         LA    RF,CIDELD                                                        
                                                                                
ESTPCC69 LLC   R0,CUR.CIDLN                                                     
         AR    RF,R0                                                            
         CLI   CUR.CIDEL,CIDELQ                                                 
         BNE   ESTPCC66                                                         
         CLC   CUR.CIDSEQ,CIDSEQ                                                
         BNE   ESTPCC66                                                         
         CLI   CUR.CIDTYPE,CIDTYCQ                                              
         BNE   ESTPCC69                                                         
                                                                                
         L     R1,AIO2                                                          
         CLC   CUR.CIDCCPJ,ACTKACT-ACTKEY(R1)                                   
         BNE   ESTPCC66                                                         
         AP    X#TDEB,CIDMAMT      total up amount                              
         B     ESTPCC66                                                         
*                                                                               
ESTPCC70 LA    R6,1(R6)                                                         
         CLI   0(R6),X'FF'                                                      
         BNE   ESTPCC60                                                         
*                                                                               
         USING OSJPASD,R2                                                       
ESTPCC72 LA    R2,IOKEY            orders passives                              
         XC    OSJPAS,OSJPAS                                                    
         MVI   OSJPTYP,OSJPTYPQ                                                 
         MVI   OSJPSUB,OSJPSUBQ                                                 
         MVC   OSJPCPY,CUXCPY                                                   
         L     R1,AIO2                                                          
         MVC   OSJPACT,ACTKACT-ACTKEY(R1)                                       
         MVI   OSJPMEM,0                                                        
*                                                                               
         MVC   SAVEKEY5,OSJPAS                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         BE    ESTPCC76                                                         
         DC    H'0'                                                             
*                                                                               
ESTPCC74 LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
         BE    ESTPCC76                                                         
         DC    H'0'                                                             
*                                                                               
ESTPCC76 CLC   OSJPAS(OSJPMEM-OSJPASD),SAVEKEY5     Match on key?               
         BNE   ESTPCC84                                                         
*                                                                               
ESTPCC78 GOTOR FLTORD,DMCB,OSJPAS  filter orders                                
         BNE   ESTPCC74                                                         
*                                                                               
ESTPCC80 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLI   IOKEY+OSJPMEM-OSJPASD,0   skip looking for workcode              
         JE    ESTPCC8B                   for expense orders                    
         USING ORDRECD,R2                                                       
         L     R2,AIO3                                                          
         USING FFTELD,R3                                                        
         LA    R3,ORDRFST                                                       
ESTPCC8A LLC   R0,FFTLN            Look to see whether there                    
         AR    R3,R0                is work code on memo orders                 
         CLI   FFTEL,0                                                          
         BE    ESTPCC74                                                         
         CLI   FFTEL,FFTELQ                                                     
         BNE   ESTPCC8A                                                         
         CLI   FFTTYPE,FFTTWRKC                                                 
         JNE   ESTPCC8A                                                         
         CLC   FFTWORK,SPACES                                                   
         JNH   ESTPCC8A                                                         
                                                                                
         USING ORDRECD,R2                                                       
ESTPCC8B L     R2,AIO3                                                          
         USING OAMELD,R3                                                        
         LA    R3,ORDRFST                                                       
*                                                                               
ESTPCC82 LLC   R0,OAMLN            extract order amounts                        
         AR    R3,R0                                                            
         CLI   OAMEL,0                                                          
         BE    ESTPCC74                                                         
         CLI   OAMEL,OAMELQ                                                     
         BNE   ESTPCC82                                                         
         AP    X#TUOR,OAMAMNT      Order amount                                 
         SP    X#TUOR,OAMIVAL      Amount invoiced to date                      
         B     ESTPCC82                                                         
         DROP  R2,R3                                                            
*                                                                               
         USING ABLELD,R3                                                        
ESTPCC84 L     R3,AIO2             BALANCE ELEMENT                              
         AHI   R3,ACTRFST-ACTRECD                                               
                                                                                
ESTPCC86 CLI   ABLEL,0                                                          
         BE    ESTPCC96                                                         
         CLI   ABLEL,ABLELQ                                                     
         BE    ESTPCC90                                                         
         CLI   ABLEL,SCIELQ                                                     
         BE    ESTPCC92                                                         
ESTPCC88 LLC   R0,ABLLN                                                         
         AR    R3,R0                                                            
         B     ESTPCC86                                                         
                                                                                
                                                                                
ESTPCC90 AP    X#TDEB,ABLDR        ACTUAL CHARGES                               
         AP    X#TCRE,ABLCR        BILLED AMOUNT                                
         B     ESTPCC88                                                         
                                                                                
         USING SCIELD,R3                                                        
ESTPCC92 L     RF,AGOXBLCK                                                      
         CLI   GODITSR-GOXBLOCK(RF),GONONE                                      
         JE    ESTPCC93                                                         
         CLI   GOINCR-GOXBLOCK(RF),YESQ Are we including R-time                 
         JNE   ESTPCC93            No                                           
*&&UK                                                                           
         CLI   GOCSAT-GOXBLOCK(RF),GOCSCOST Want cost amount?                   
         JNE   *+12                No                                           
         CLI   SCITYPE,SCITMCRT    Cost amount                                  
         BE    ESTPCC94                                                         
         CLI   GOCSAT-GOXBLOCK(RF),GOCSSALE Want sales amount?                  
         BNE   *+12                No                                           
*&&                                                                             
         CLI   SCITYPE,SCITMSRT    Sales amount                                 
         BE    ESTPCC94                                                         
*&&UK                                                                           
ESTPCC93 CLI   SCITYPE,SCITMEXP    Memo expenses (EXPENSE INVOICES)             
*&&                                                                             
*&&US                                                                           
ESTPCC93 CLI   SCITYPE,SCITSJXP    Memo expenses (EXPENSE INVOICES)             
*&&                                                                             
         BNE   ESTPCC88                                                         
         CLI   GODEIS-GOXBLOCK(RF),GODAMT Include memo invoices?                
         JNE   ESTPCC88            No                                           
*                                                                               
ESTPCC94 AP    X#TDEB,SCIAMNT                                                   
         B     ESTPCC88                                                         
*                                                                               
ESTPCC96 ZAP   JD_ORDRS,X#TUOR                                                  
         ZAP   JD_NETBL,X#TCRE                                                  
         ZAP   JD_ACTLS,X#TDEB                                                  
         ZAP   JD_ESTMD,X#TEST                                                  
                                                                                
         CP    X#TEST,PZERO        ANY ESTIMATE FIGURE?                         
         BE    ESTPCCX             CALCULATE:                                   
         ZAP   X#PL16,X#TUOR       ACTUALS = ORDERS + DEBITS                    
         AP    X#PL16,X#TDEB                                                    
*        SP    X#PL16,X#TCRE                                                    
         MP    X#PL16,=P'100000'   * 100 * 100 * 10                             
                                                                                
         ZAP   X#PL06,X#TEST       CURRENT ESTIMATE                             
                                                                                
         DP    X#PL16,X#PL06       EST % COMM = ACTUALS / CURRENT EST           
         ZAP   DUB,X#PL16(L'X#PL16-L'X#PL06)                                    
         SRP   DUB,63,5                                                         
                                                                                
         ZAP   JD_EPC,DUB                                                       
         MVI   JD_COL,JD_COLWQ     SET COLOUR = WHITE                           
         CP    X#CEAMBR,PZERO                                                   
         BNE   ESTPCC98                                                         
         CP    X#CERED,PZERO                                                    
         BE    ESTPCCX                                                          
                                                                                
ESTPCC98 MVI   JD_COL,JD_COLGQ     SET COLOUR = GREEN                           
         CP    DUB,X#CEAMBR                                                     
         BL    ESTPCCX                                                          
         MVI   JD_COL,JD_COLAQ     SET COLOUR = AMBER                           
         CP    DUB,X#CERED                                                      
         BL    ESTPCCX                                                          
         MVI   JD_COL,JD_COLRQ     SET COLOUR = RED                             
                                                                                
ESTPCCX  XIT1                                                                   
         LTORG                                                                  
         DROP  R3                                                               
                                                                                
* JobBag - details - add estimate values to buffer                              
         USING EMDELD,R2                                                        
         USING ESTRECD,R3                                                       
ADDEST   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*ADDEST*'                                                      
                                                                                
                                                                                
ES       USING EST_D,ES_BUFF                                                    
         LA    R0,ES_BUFF                                                       
         LHI   R1,L'ES_BUFF                                                     
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R3,AIO2                                                          
         LR    R2,R3                                                            
         AHI   R2,ESTRFST-ESTRECD                                               
                                                                                
ADDEST05 CLI   EMDEL,0                                                          
         BE    ADDESTX                                                          
         CLI   EMDEL,EMDELQ                                                     
         BE    ADDEST20                                                         
         CLI   EMDEL,ENMELQ                                                     
         BE    ADDEST30                                                         
         CLI   EMDEL,ERDELQ                                                     
         BE    ADDEST40                                                         
*&&UK                                                                           
         CLI   EMDEL,PTAELQ                                                     
         BE    ADDEST60                                                         
*&&                                                                             
                                                                                
ADDEST10 LLC   R0,EMDLN                                                         
         AR    R2,R0                                                            
         LA    R0,ES_BUFF                                                       
         LHI   R1,L'ES_BUFF                                                     
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         B     ADDEST05                                                         
                                                                                
ADDEST20 MVC   X#ESGLO,EMDGNO                                                   
         MVC   X#ESLOC,ESTKLNO                                                  
         MVC   X#ESDES,SPACES                                                   
         MVC   X#ESCUR,SPACES                                                   
         XC    X#ESXRT,X#ESXRT                                                  
*&&UK                                                                           
         CLC   EMDCUR,SPACES                                                    
         BNH   ADDEST25                                                         
         CLC   EMDCUR,AGYCURR                                                   
         BE    ADDEST25                                                         
         MVC   X#ESCUR,EMDCUR      Yes - extract currency code                  
         MVC   X#ESXRT,EMDRAT      and exchange rate                            
*&&                                                                             
ADDEST25 MVI   X#ESSTA,JB_ECLIA    client approved                              
         TM    ESTRSTA1,ESTKCAPP                                                
         BNZ   ADDEST10                                                         
         MVI   X#ESSTA,JB_ESUBM    submitted                                    
         B     ADDEST10                                                         
                                                                                
         USING ENMELD,R2                                                        
ADDEST30 LLC   RE,ENMLN                                                         
         SHI   RE,ENMLNQ+1                                                      
         LTR   RE,RE                                                            
         BM    ADDEST10                                                         
         MVC   X#ESDES(0),ENMNAME                                               
         EX    RE,*-6                                                           
         B     ADDEST10                                                         
                                                                                
         USING ERDELD,R2                                                        
ADDEST40 CLI   ERDTYP,ERDTWDQ      look for w/c amounts only                    
         BNE   ADDEST10                                                         
                                                                                
         CLI   RQ_JBTYP,RQ_JBACC   no w/c for Accounting view                   
         BE    ADDEST42                                                         
         CLC   ERDWCOD,RQ_JBWRK    Check workcode matches                       
         BNE   ADDEST10                                                         
                                                                                
ADDEST42 MVC   ES.ESTTWCD,ERDWCOD                                               
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         BE    ADDEST44                                                         
         TM    TSARERRS,TSERNF     Test record not found                        
         BNZ   ADDEST46                                                         
         DC    H'0'                Duplicate key                                
                                                                                
ADDEST44 AP    ES.ESTTAMT,ERDWAMT  Yes - Add to overall amount                  
         AP    ES.ESTTCOM,ERDWCAM                                               
         AP    ES.ESTTFCA,ERDWFCA                                               
         GOTOR GOTSAR,DMCB,('TSAWRT',0)                                         
         BE    ADDEST10                                                         
         DC    H'0'                                                             
                                                                                
ADDEST46 MVC   ES.ESTTGLO(X#ESLNQ),X#ESGLO Add details of estimate              
         MVC   ES.ESTTWCD,ERDWCOD                                               
         ZAP   ES.ESTTAMT,ERDWAMT                                               
         ZAP   ES.ESTTCOM,ERDWCAM                                               
         ZAP   ES.ESTTFCA,ERDWFCA                                               
         ZAP   ES.ESTTCOB,PZERO                                                 
         ZAP   ES.ESTTALA,PZERO                                                 
         LA    R1,ES.ESTTBLN                                                    
         LA    RE,ES_BUFF                                                       
         SR    R1,RE                                                            
         STH   R1,ES.ESTTLEN                                                    
         GOTOR GOTSAR,DMCB,('TSAADD',0)                                         
         BE    ADDEST10                                                         
         TM    TSARERRS,TSEEOF     Test end of buffer                           
         BNZ   ADDEST48                                                         
         DC    H'0'                Duplicate key                                
ADDEST48 MVC   LP_ERROR,=AL2(AE$MAX#)                                           
         J     XERROR                                                           
*&&UK                                                                           
         USING PTAELD,R2                                                        
ADDEST60 CLI   PTATYPE,PTATRAL                                                  
         BNE   ADDEST10                                                         
         OC    PTADATE,PTADATE     No date means no in use                      
         BZ    ADDEST10                                                         
         TM    PTASTAT1,PTASPEND   Pending is draft - ignore these              
         BNZ   ADDEST10                                                         
         CLI   RQ_JBTYP,RQ_JBACC   no w/c for Accounting view                   
         BE    ADDEST62                                                         
         CLC   PTAEWRK,RQ_JBWRK    Check workcode matches                       
         BNE   ADDEST10                                                         
ADDEST62 MVC   ES.ESTTWCD,PTAEWRK                                               
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         BE    ADDEST64                                                         
         TM    TSARERRS,TSERNF     Test record not found                        
         BNZ   ADDEST72                                                         
         DC    H'0'                Duplicate key                                
ADDEST64 DS    0H                                                               
*&&US*&& AP    ES.ESTTALA,PTANET      Yes - Add to overall amount               
*&&US*&& AP    ES.ESTTCOB,PTARCOM                                               
         LA    RF,ES.ESTTBLN                                                    
ADDEST66 OC    0(L'ESTTBLN,RF),0(RF)                                            
         BZ    ADDEST68                                                         
         CLC   PTARBLNO,0(RF)                                                   
         BE    ADDEST70                                                         
         LA    RF,L'ESTTBLN(RF)                                                 
         B     ADDEST66                                                         
*                                                                               
ADDEST68 MVC   0(L'ESTTBLN,RF),PTARBLNO                                         
         LA    RF,L'ESTTBLN(RF)                                                 
         LA    RE,ES_BUFF                                                       
         SR    RF,RE                                                            
         STH   RF,ES.ESTTLEN                                                    
ADDEST70 GOTOR GOTSAR,DMCB,('TSAWRT',0)                                         
         BE    ADDEST10                                                         
         DC    H'0'                                                             
                                                                                
ADDEST72 MVC   ES.ESTTGLO(X#ESLNQ),X#ESGLO Add details of estimate              
         MVC   ES.ESTTWCD,PTAEWRK                                               
         ZAP   ES.ESTTAMT,PZERO                                                 
         ZAP   ES.ESTTCOM,PZERO                                                 
         ZAP   ES.ESTTFCA,PZERO                                                 
*&&US*&& ZAP   ES.ESTTCOB,PTARCOM                                               
*&&US*&& ZAP   ES.ESTTALA,PTANET                                                
         MVC   ES.ESTTBLN,PTARBLNO                                              
         LA    R1,ES.ESTTBLN+L'ESTTBLN                                          
         LA    RE,ES_BUFF                                                       
         SR    R1,RE                                                            
         STH   R1,ES.ESTTLEN                                                    
         GOTOR GOTSAR,DMCB,('TSAADD',0)                                         
         BE    ADDEST10                                                         
         TM    TSARERRS,TSEEOF     Test end of buffer                           
         BNZ   ADDEST74                                                         
         DC    H'0'                Duplicate key                                
ADDEST74 MVC   LP_ERROR,=AL2(AE$MAX#)                                           
         J     XERROR                                                           
         B     ADDEST10                                                         
*&&                                                                             
                                                                                
ADDESTX  XIT1                                                                   
         LTORG                                                                  
         DROP  R2,R3                                                            
                                                                                
* JobBag - details - put out estiamte values from buffer                        
OUTEST   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*OUTEST*'                                                      
         LA    R0,ES_BUFF                                                       
         LHI   R1,L'ES_BUFF                                                     
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         GOTOR GOTSAR,DMCB,('TSARDH',0)                                         
         B     OUTEST04                                                         
                                                                                
OUTEST02 LA    R0,ES_BUFF                                                       
         LHI   R1,L'ES_BUFF                                                     
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         GOTOR GOTSAR,DMCB,('TSANXT',0)                                         
ES       USING EST_D,ES_BUFF                                                    
                                                                                
OUTEST04 TM    TSARERRS,TSEEOF                                                  
         BNZ   OUTESTX                                                          
                                                                                
         GOTOR CLRJBV                                                           
                                                                                
         CLI   RQ_JBTYP,RQ_JBACC   w/c for Accounting view                      
*&&UK*&& JE    OUTEST06                                                         
*&&US*&& JE    OUTEST12                                                         
         MVI   JB_TYPE,RQ_JBWCD                                                 
         MVI   JB_DTYP,C'E'                                                     
         MVC   JB_EORI,X#WCTIE                                                  
         MVC   JB_ESTN,ES.ESTTGLO                                               
         EDIT  (B1,ES.ESTTLOC),(L'JB_ESTL,JB_ESTL),ALIGN=LEFT                   
         ZAP   JB_ESTA,ES.ESTTAMT                                               
         MVC   JB_ESTS,ES.ESTTSTA                                               
         MVC   JB_ESTD,ES.ESTTDES                                               
         MVI   JB_TAST,0           no status for estimates                      
                                                                                
         GOTOR LP_APUTO,LP_D                                                    
                                                                                
         GOTOR CLRJBV                                                           
*                                                                               
*&&UK                                                                           
OUTEST06 CP    ES.ESTTALA,PZERO                                                 
         BE    OUTEST12                                                         
                                                                                
         MVI   JB_TYPE,RQ_JBWCD                                                 
         MVI   JB_DTYP,C'T'                                                     
         MVC   JB_EORI,X#WCTIE                                                  
         MVI   JB_TAST,JB_TAAPQ                                                 
         CLI   ES.ESTTSTA,C'C'                                                  
         BE    *+8                                                              
         MVI   JB_TAST,JB_TASUQ                                                 
         MVC   JB_ESTN,ES.ESTTGLO                                               
         MVC   JB_TFCC,ES.ESTTCUR     Foreign currrency                         
         ZAP   JB_TFCA,ES.ESTTFCA                                               
         MVC   JB_TFCR,ES.ESTTXRT                                               
         MVC   JB_INTR,SPACES                                                   
         MVC   JB_WCOD,ES.ESTTWCD                                               
         CLI   RQ_JBTYP,RQ_JBACC   w/c for Accounting view                      
         JNE   OUTEST08            No                                           
         GOTOR SETCWP,2                                                         
OUTEST08 ZAP   JB_TALL,ES.ESTTALA                                               
         ZAP   JB_COMB,ES.ESTTCOB                                               
         ZAP   JB_COMM,ES.ESTTCOM                                               
         MVC   JB_BILNO,ES.ESTTBLN                                              
         MVC   JB_NARR(L'ESTTDES),ES.ESTTDES                                    
         MVC   JB_REFN,AC@EST                                                   
         GOTOR LP_APUTO,LP_D                                                    
*                                                                               
         LA    R2,ES.ESTTBLN                                                    
OUTEST10 AHI   R2,L'ESTTBLN                                                     
         OC    0(L'ESTTBLN,R2),0(R2)                                            
         BZ    OUTEST12                                                         
         GOTOR CLRJBV                                                           
         MVI   JB_TYPE,C'X'        indicate array                               
         MVC   JB_BILNO,0(R2)                                                   
         GOTOR LP_APUTO,LP_D                                                    
         B     OUTEST10                                                         
*&&                                                                             
                                                                                
OUTEST12 B     OUTEST02                                                         
                                                                                
OUTESTX  XIT1                                                                   
         LTORG                                                                  
         DROP  ES                                                               
                                                                                
* JobBag - set contra account name + w/c description + person details           
* Note: could use BINSRCH on GENAREA e.g. to optimise name reads                
SETCWP   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*SETCAN*'                                                      
                                                                                
         STC   R1,BYTE4                                                         
         MVC   SAVEKEY2,IOKEY                                                   
         MVI   BYTE3,NOQ                                                        
                                                                                
         CLI   BYTE4,2                                                          
         BE    SETCWP2                                                          
         CLC   JB_CACC,X#CACODE                                                 
         BNE   SETCWP1                                                          
         MVC   JB_CACN,X#CANAME                                                 
         B     SETCWP2                                                          
                                                                                
SETCWP1  MVC   SAVEKEY2,IOKEY                                                   
                                                                                
         MVC   X#CACODE,JB_CACC                                                 
         MVC   TEMP2(14),X#CACODE                                               
         MVI   BYTE3,YESQ                                                       
         GOTOR (#GETACN,AGETACN)                                                
         MVC   X#CANAME,TEMP2                                                   
         MVC   JB_CACN,X#CANAME                                                 
                                                                                
SETCWP2  CLI   BYTE4,1                                                          
         BE    SETCWP4                                                          
         CLC   JB_WCOD,SPACES                                                   
         BNH   SETCWP4                                                          
                                                                                
         CLC   JB_WCOD,X#WCCODE                                                 
         BNE   SETCWP3                                                          
         MVC   JB_WDES,X#WCDESC                                                 
         MVC   JB_EORI,X#WCTYPE                                                 
         B     SETCWP8                                                          
                                                                                
SETCWP3  MVC   X#WCCODE,JB_WCOD                                                 
         MVC   TEMP2(14),X#WCCODE                                               
         MVI   BYTE3,YESQ                                                       
         GOTOR (#GETWCD,AGETWCD)                                                
         MVC   X#WCDESC,TEMP2                                                   
         MVC   JB_WDES,X#WCDESC                                                 
         MVI   X#WCTYPE,C'E'                                                    
         CLI   CUCTRY,CTRYGER                                                   
         BNE   SETCWP4                                                          
         CLI   X#WCCODE,C'0'                                                    
         BNL   SETCWP7                                                          
         MVI   X#WCTYPE,C'I'                                                    
         B     SETCWP7                                                          
                                                                                
SETCWP4  L     R1,AIO3                                                          
         AHI   R1,WCORFST-WCORECD                                               
         USING WCOELD,R1                                                        
         XR    R0,R0                                                            
                                                                                
SETCWP5  CLI   WCOEL,WCOELQ                                                     
         BE    SETCWP6                                                          
         CLI   WCOEL,0                                                          
         BE    SETCWP7                                                          
         IC    R0,WCOLN                                                         
         AR    R1,R0                                                            
         B     SETCWP5                                                          
                                                                                
SETCWP6  TM    WCOSTAT,WCOSHCOE                                                 
         BZ    SETCWP7                                                          
         MVI   X#WCTYPE,C'I'                                                    
         DROP  R1                                                               
                                                                                
SETCWP7  MVC   JB_EORI,X#WCTYPE                                                 
                                                                                
SETCWP8  OC    X#PIDAP,X#PIDAP                                                  
         BZ    SETCWPR                                                          
                                                                                
         CLC   X#PIDAP,X#BILPX                                                  
         BNE   SETCWP9                                                          
         MVC   JB_BPCD,X#BILPC                                                  
         MVC   JB_BPFN,X#BILPF                                                  
         MVC   JB_BPLN,X#BILPL                                                  
         B     SETCWPR                                                          
                                                                                
SETCWP9  MVC   X#BILPX,X#PIDAP                                                  
         MVC   TEMP2(2),X#BILPX                                                 
         MVI   BYTE3,YESQ                                                       
         GOTOR (#GETPID,AGETPID)                                                
         MVC   JB_BPCD,TEMP2                                                    
         GOTOR (#GETPIN,AGETPIN)                                                
         MVC   JB_BPFN,TEMP2+00                                                 
         MVC   JB_BPLN,TEMP2+16                                                 
         MVC   X#BILPC,JB_BPCD                                                  
         MVC   X#BILPF,JB_BPFN                                                  
         MVC   X#BILPL,JB_BPLN                                                  
                                                                                
SETCWPR  CLI   BYTE3,NOQ                                                        
         BE    SETCWPX                                                          
                                                                                
         MVC   IOKEY,SAVEKEY2                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         BE    SETCWPX                                                          
         DC    H'0'                                                             
                                                                                
SETCWPX  XIT1                                                                   
         LTORG                                                                  
                                                                                
* JobBag - process bill numbers on a transaction and download                   
PROBIL   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*PROBIL*'                                                      
                                                                                
         USING PTAELD,R3                                                        
         L     R3,AIO2                                                          
         AHI   R3,TRNRFST-TRNRECD                                               
         MVI   BYTE2,0                                                          
                                                                                
PROBIL02 LLC   R0,PTALN            find PTA elements on transaction             
         AR    R3,R0                                                            
         CLI   PTAEL,0                                                          
         BNE   PROBIL04                                                         
         CLI   BYTE2,0             on exit either download or skip              
         BNE   PROBILX                                                          
         GOTOR LP_APUTO,LP_D                                                    
         B     PROBILX                                                          
                                                                                
PROBIL04 CLI   PTAEL,PTAELQ        filter PTA element (may need fixes)          
         BNE   PROBIL02                                                         
         CLI   PTATYPE,PTATRAL                                                  
         BNE   PROBIL02                                                         
         TM    PTASTAT1,PTASPEND+PTASREVD                                       
         BNZ   PROBIL02                                                         
                                                                                
         CLI   BYTE2,0             clear values 2nd time onwards                
         BE    PROBIL06                                                         
         GOTOR CLRJBV                                                           
         MVI   JB_TYPE,C'X'        indicate array                               
PROBIL06 MVI   BYTE2,1             download bill number                         
         MVC   JB_BILNO,PTARBLNO                                                
                                                                                
         GOTOR LP_APUTO,LP_D                                                    
         B     PROBIL02                                                         
                                                                                
PROBILX  XIT1                                                                   
         LTORG                                                                  
         DROP  R3                                                               
                                                                                
* download module 'JobBag' for w/c summary                                      
         USING WCSTABD,R4                                                       
PROSUM   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*PROSUM*'                                                      
                                                                                
         L     R4,AESTWRKA         use ATWA for table                           
         MVI   WCSTWCD,WCSTEOT                                                  
                                                                                
PRSUM02  DS    0H                  *** ESTIMATES ***                            
         LA    R2,DMCB                                                          
         GOTO1 VACCEMU,DMCB,=C'NEWO',,AIO6,AIO6                                 
                                                                                
*&&UK*&& GOTO1 VJOBCOL,DMCB,(X'FF',JOBFLDS),ACOLIST,ACOMFACS                    
*&&US*&& GOTO1 VJOBCOL,DMCB,LOOKFLDH,ACOLIST,ACOMFACS                           
         CLI   4(R1),0                                                          
*&&UK*&& BE    *+6                                                              
*&&US*&& BNE   *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R3,AJOBLOCK         clear out joblock                            
         LR    R0,R3                                                            
         LA    R1,JBLOCKL                                                       
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         USING JBLOCKD,R3                                                       
         MVC   JBAJOB,AIO6                                                      
         MVC   JBACOLS,ACOLIST                                                  
         MVC   JBACOM,ACOMFACS                                                  
*&&UK*&& MVC   JBCSHVAL,VCASHVAL                                                
*&&UK*&& MVC   JBTOBACO,VTOBACCO                                                
         MVC   JBAGOBLK,AGOBLOCB                                                
         MVC   JBAIO,AIO3                                                       
         MVC   JBGETOPT,VGETOPT                                                 
         MVC   JBAOPVTB,AELEAREA   Use ELEAREA here                             
         LHI   RE,L'ELEAREA                                                     
         ST    RE,JBLOPVTB                                                      
                                                                                
*        MVC   JBACOLTB,ACOLTAB                                                 
                                                                                
                                                                                
         MVC   JBACOLTB,AGENAXTN                                                
         LHI   RE,L'GENAEXTN                                                    
         ST    RE,JBLCOLTB                                                      
         MVI   JBSELFUN,JBGETDE     MCS: GET DETAILS AND SET ORIGINAL           
*&&UK*&& LA    RE,JOBFLDS                COLUMN LIST  ADDRESS (OE/CE)           
*&&US*&& LA    RE,LOOKFLDH               COLUMN LIST  ADDRESS (OE/CE)           
         ST    RE,JBORICLI                                                      
                                                                                
         GOTO1 VJOBBER,DMCB,AJOBLOCK                                            
         CLI   JBERROR,0                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R2,JBACOLTB                                                      
         L     R4,AESTWRKA                                                      
                                                                                
         CLI   JBNEWEST,JBMCSQ     FOR MCS ESTIMATES                            
         BE    PRSUM14                                                          
                                                                                
         USING JBCOLD,R2                                                        
         XR    RE,RE                                                            
         ICM   RE,3,JBNROWS        R2=(LOOP COUNTER)                            
         BZ    PRSUM16                                                          
                                                                                
PRSUM04  CLI   JBCOLTYP,JBCOLTWC   TEST FOR WORK CODE ENTRY                     
         BNE   PRSUM12                                                          
*&&UK*&& CP    JBCOLVAL,PZERO                                                   
*&&US*&& CP    JBCOLVAL+6(L'JBCOLVAL),PZERO                                     
         BE    PRSUM12                                                          
                                                                                
         L     R4,AESTWRKA                                                      
PRSUM06  CLI   WCSTWCD,WCSTEOT                                                  
         BE    PRSUM10                                                          
         CLC   WCSTWCD,JBCOLWC                                                  
         BNE   PRSUM08                                                          
*&&UK*&& AP    WCSTCEA,JBCOLVAL                                                 
*&&US*&& AP    WCSTCEA,JBCOLVAL+6(L'JBCOLVAL)                                   
         B     PRSUM12                                                          
                                                                                
PRSUM08  AHI   R4,WCSTLNQ                                                       
         B     PRSUM06                                                          
                                                                                
PRSUM10  MVC   WCSTWCD,JBCOLWC                                                  
         CLC   WCSTWCD,SPACES                                                   
         BH    *+6                                                              
         DC    H'0'                                                             
*&&UK*&& ZAP   WCSTCEA,JBCOLVAL                                                 
*&&US*&& ZAP   WCSTCEA,JBCOLVAL+6(L'JBCOLVAL)                                   
         ZAP   WCSTDBA,PZERO                                                    
         ZAP   WCSTCRA,PZERO                                                    
         ZAP   WCSTALA,PZERO                                                    
         ZAP   WCSTORA,PZERO                                                    
         ZAP   WCSTHRS,PZERO                                                    
         ZAP   WCSTCCR,PZERO                                                    
         ZAP   WCSTCPR,PZERO                                                    
         ZAP   WCSTCHT,PZERO                                                    
         ZAP   WCSTCOM,PZERO                                                    
         ZAP   WCSTCOB,PZERO                                                    
         MVI   WCSTSTA,0                                                        
         MVI   WCSTWCD+WCSTLNQ,WCSTEOT                                          
                                                                                
PRSUM12  AH    R2,JBLCOL           NEXT TABLE ENTRY                             
         BCT   RE,PRSUM04                                                       
         B     PRSUM16                                                          
         DROP  R2,R3                                                            
                                                                                
         USING MJETABD,R2                                                       
PRSUM14  LLC   R0,MJETLEN          first entry is totals                        
         AR    R2,R0                                                            
         CLI   MJETTYP,MJETTEQ     end of table?                                
         BE    PRSUM16                                                          
         CLI   MJETTYP,MJETTWQ     look for work code entries                   
         BNE   PRSUM14                                                          
         OC    MJET1RA,MJET1RA     ...but not 1R-lvl entries                    
         BNZ   PRSUM14                                                          
*&&UK*&& CP    MJETVAL,PZERO       ignore zero entries                          
*&&US*&& CP    MJETVAL+6(L'MJETVAL),PZERO     ignore zero entries               
         BE    PRSUM14                                                          
*&&DO                                                                           
         LR    R1,R4                                                            
         AHI   R1,WCSTLNQ                                                       
         LAY   R0,GENAREAX         dont overshoot the end                       
         CR    R1,R0                                                            
         BL    *+6                                                              
         DC    H'0'                                                             
*&&                                                                             
         MVC   WCSTWCD,MJETWCD                                                  
         CLC   WCSTWCD,SPACES                                                   
         BH    *+6                                                              
         DC    H'0'                                                             
*&&UK                                                                           
         ZAP   WCSTCEA,MJETVAL                                                  
         ZAP   WCSTCOM,MJETVAL+6(L'MJETVAL)                                     
         ZAP   WCSTALA,MJETVAL+12(L'MJETVAL)                                    
         ZAP   WCSTCOB,MJETVAL+18(L'MJETVAL)                                    
*&&                                                                             
*                                                                               
*&&US                                                                           
         ZAP   WCSTCEA,MJETVAL+6(L'MJETVAL)                                     
         ZAP   WCSTCOM,PZERO                                                    
         ZAP   WCSTCOB,PZERO                                                    
         ZAP   WCSTALA,PZERO                                                    
*&&                                                                             
         ZAP   WCSTDBA,PZERO                                                    
         ZAP   WCSTCRA,PZERO                                                    
         ZAP   WCSTORA,PZERO                                                    
         ZAP   WCSTHRS,PZERO                                                    
         ZAP   WCSTCCR,PZERO                                                    
         ZAP   WCSTCPR,PZERO                                                    
         ZAP   WCSTCHT,PZERO                                                    
         MVI   WCSTSTA,0                                                        
         AHI   R4,WCSTLNQ                                                       
         MVI   WCSTWCD,WCSTEOT                                                  
         B     PRSUM14                                                          
                                                                                
         USING TRNRECD,R2                                                       
PRSUM16  DS    0H                  *** ORDERS ***                               
                                                                                
         L     RF,AGOXBLCK                                                      
         TM    SAVEIND,SAVESTC     want to do est check instead?                
         JZ    *+12                                                             
         LA    RF,GODIOS-GOXBLKD(RF)                                            
         J     *+8                                                              
         LA    RF,GOEORN-GOXBLKD(RF)                                            
         CLI   0(RF),C'N' don't want any orders                                 
         JE    PRSUM30                                                          
                                                                                
         LA    R2,IOKEY                                                         
         MVC   TRNKEY,SPACES                                                    
         MVC   TRNKCPY,CUXCPY                                                   
         MVC   TRNKULA(2),PRODUL                                                
         MVC   TRNKACT,RQ_JBACT                                                 
         MVC   TRNKWORK,ORDWC                                                   
                                                                                
         MVC   SAVEKEY1,TRNKEY                                                  
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         BE    PRSUM20                                                          
         B     PRSUMN                                                           
                                                                                
PRSUM18  LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         BNE   PRSUMN                                                           
                                                                                
PRSUM20  CLC   TRNKCULA,SAVEKEY1   Match on key?                                
         BNE   PRSUM30                                                          
         CLC   TRNKWORK,ORDWC                                                   
         BNE   PRSUM30                                                          
                                                                                
         CLC   TRNKREF,SPACES      Skip other records                           
         BNH   PRSUM18                                                          
                                                                                
         LHI   R1,IOGET+IOMST+IO2                                               
         TM    TRNKSTAT,TRNSARCH                                                
         BZ    *+8                                                              
         LHI   R1,IOGET+IOARC+IO2                                               
                                                                                
         GOTOR (#IOEXEC,AIOEXEC)                                                
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         USING OAMELD,R3                                                        
         L     R2,AIO2             Process order transaction                    
         LA    R3,TRNRFST                                                       
         CLI   OAMEL,TRNELQ                                                     
         BNE   PRSUM18                                                          
         XR    R0,R0                                                            
*                                                                               
PRSUM22  IC    R0,OAMLN            read for real reference number               
         AR    R3,R0               and long invoice number                      
         CLI   OAMEL,0                                              t           
         BE    PRSUM18                                                          
         CLI   OAMEL,OAMELQ                                                     
         BNE   PRSUM22                                                          
                                                                                
         L     R4,AESTWRKA                                                      
PRSUM24  CLI   WCSTWCD,WCSTEOT                                                  
         BE    PRSUM28                                                          
         CLC   WCSTWCD,OAMWORK                                                  
         BNE   PRSUM26                                                          
         AP    WCSTORA,OAMAMNT                                                  
         SP    WCSTORA,OAMIVAL                                                  
*        ZAP   X#CURTA,WCSTORA                                                  
         ZAP   X#CURTA,PZERO                                                    
         GOTOR SETALL,1            need to set WCSTALA                          
         B     PRSUM22                                                          
                                                                                
PRSUM26  AHI   R4,WCSTLNQ                                                       
         B     PRSUM24                                                          
                                                                                
PRSUM28  MVC   WCSTWCD,OAMWORK                                                  
         CLC   WCSTWCD,SPACES                                                   
         BH    *+6                                                              
         DC    H'0'                                                             
         ZAP   WCSTHRS,PZERO                                                    
         ZAP   WCSTCCR,PZERO                                                    
         ZAP   WCSTCPR,PZERO                                                    
         ZAP   WCSTCHT,PZERO                                                    
         ZAP   WCSTORA,OAMAMNT                                                  
         SP    WCSTORA,OAMIVAL                                                  
         ZAP   WCSTDBA,PZERO                                                    
         ZAP   WCSTCRA,PZERO                                                    
         ZAP   WCSTALA,PZERO                                                    
         ZAP   WCSTCEA,PZERO                                                    
         ZAP   WCSTCOM,PZERO                                                    
         ZAP   WCSTCOB,PZERO                                                    
*        ZAP   X#CURTA,WCSTORA                                                  
         ZAP   X#CURTA,PZERO                                                    
         GOTOR SETALL,1            need to set WCSTALA                          
         MVI   WCSTSTA,0                                                        
         MVI   WCSTWCD+WCSTLNQ,WCSTEOT                                          
         B     PRSUM22                                                          
         DROP  R3                                                               
                                                                                
PRSUM30  DS    0H                  *** DEBITS/CREDITS ***                       
                                                                                
         LA    R2,IOKEY                                                         
         MVC   TRNKEY,SPACES                                                    
         MVC   TRNKCPY,CUXCPY                                                   
         MVC   TRNKULA(2),PRODUL                                                
         MVC   TRNKACT,RQ_JBACT                                                 
         MVC   TRNKWORK,ORDWC                                                   
         MVI   TRNKCCPY,FF                                                      
                                                                                
         MVC   SAVEKEY1,TRNKEY                                                  
                                                                                
         XC    X#CURWC,X#CURWC                                                  
         XC    X#CURCR,X#CURCR                                                  
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         BE    PRSUM34                                                          
         B     PRSUMN                                                           
                                                                                
PRSUM32  LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         BNE   PRSUMN                                                           
                                                                                
PRSUM34  CLC   TRNKCULA,SAVEKEY1                                                
         BNE   PRSUM58                                                          
                                                                                
         CLC   TRNKREF,SPACES      Skip other records                           
         BNH   PRSUM32                                                          
                                                                                
         TM    TRNKSTAT,TRNSREVS                                                
         BNZ   PRSUM32                                                          
                                                                                
         LHI   R1,IOGET+IOMST+IO2                                               
         TM    TRNKSTAT,TRNSARCH                                                
         BZ    *+8                                                              
         LHI   R1,IOGET+IOARC+IO2                                               
                                                                                
         GOTOR (#IOEXEC,AIOEXEC)                                                
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R2,AIO2                                                          
         CLC   TRNKULC(L'TRNKCUNT+L'TRNKCLDG),=C'1R'  IS IT TIMESHEETS?         
         JNE   PRSUM35                                                          
         CLC   TRNKDATE,SPACES                                                  
         JNH   PRSUM35                                                          
         GOTOR FLTTIM,DMCB,AIO2    filter time transactions                     
         JNE   PRSUM32                                                          
                                                                                
         USING TRNELD,R3                                                        
PRSUM35  LA    R3,TRNRFST                                                       
         CLI   TRNEL,TRNELQ                                                     
         BNE   PRSUM32                                                          
                                                                                
         ZAP   DUB,PZERO                                                        
         ZAP   DUB1,PZERO                                                       
         ZAP   DUB2,PZERO                                                       
         ZAP   X#CAMT,PZERO                                                     
         ZAP   X#SAMT,PZERO                                                     
         ZAP   X#MAMT,PZERO                                                     
         ZAP   X#COMAMT,PZERO                                                   
         MVI   X#FBADV,NOQ                                                      
                                                                                
         TM    TRNRSTAT,TRNSDRFT   FlexiBill advance?                           
         BZ    PRSUM36                                                          
         CLI   TRNTYPE,99                                                       
         BNE   PRSUM32                                                          
         MVI   X#FBADV,YESQ                                                     
         B     PRSUM50                                                          
                                                                                
         USING SCIELD,RE                                                        
PRSUM36  LR    RE,R3                                                            
         XR    R0,R0                                                            
                                                                                
PRSUM38  IC    R0,SCILN                                                         
         AR    RE,R0                                                            
         CLI   SCIEL,0                                                          
         BE    PRSUM50                                                          
*&&US*&& CLI   SCIEL,PRTELQ                                                     
*&&US*&& BE    PRSUM46                                                          
         CLI   SCIEL,SCIELQ                                                     
         BNE   PRSUM38                                                          
*&&UK                                                                           
         CLI   SCITYPE,SCITSJHR                                                 
         BNE   PRSUM40                                                          
         CLI   RQ_JBHRS,NOQ        filter out hours                             
         BE    PRSUM32                                                          
         ZAP   DUB1,SCIAMNT                                                     
         B     PRSUM38                                                          
                                                                                
PRSUM40  CLI   SCITYPE,SCITCRAT    memo hours                                   
         BNE   PRSUM44                                                          
         CLC   TRNKWORK,BILWC      drop for w/c=99 as it will be                
         BE    PRSUM42             SCITCOMM                                     
         CLI   X#FBADV,YESQ                                                     
         BE    PRSUM42             SCITCOMM                                     
         CP    TRNAMNT,PZERO       skip if billable time                        
         BNE   PRSUM38                                                          
         CLI   RQ_JBHRS,NOQ        filter out hours                             
         BE    PRSUM38                                                          
         ZAP   DUB2,SCIAMNT                                                     
         ZAP   DUB,SCIAMNT                                                      
         B     PRSUM38                                                          
                                                                                
PRSUM42  ZAP   X#COMAMT,SCIAMNT                                                 
         B     PRSUM38                                                          
PRSUM44  CLI   SCITYPE,SCITMEXP    MEMO EXPENSES (EXPENSE INVOICES)             
*&&                                                                             
*&&US                                                                           
PRSUM44  CLI   SCITYPE,SCITSJXP    MEMO EXPENSES (EXPENSE INVOICES)             
*&&                                                                             
*&&US*&& JNE   PRSUM38                                                          
*&&UK*&& JNE   PRSUM46                                                          
         CP    TRNAMNT,PZERO       ZERO?                                        
         JNE   PRSUM38                                                          
         L     RF,AGOXBLCK                                                      
         TM    SAVEIND,SAVESTC     estimate check instead?                      
         BZ    *+16                                                             
         CLI   GOEMIN-GOXBLOCK(RF),GOYES                                        
         JNE   PRSUM32                                                          
         J     PRSUM45                                                          
*                                                                               
         CLI   GODEIS-GOXBLOCK(RF),GOYES                                        
         JE    PRSUM38                                                          
         CLI   GODEIS-GOXBLOCK(RF),GODAMT include exp invoice amount            
         JNE   PRSUM32                                                          
PRSUM45  ZAP   X#MAMT,SCIAMNT                                                   
         B     PRSUM38                                                          
*                                                                               
*&&UK                                                                           
PRSUM46  CLI   SCITYPE,SCITMSRT    SALES AMOUNT                                 
         BE    PRSUM48                                                          
         CLI   SCITYPE,SCITMCRT    COST AMOUNT                                  
         BNE   PRSUM38                                                          
                                                                                
         ZAP   X#CAMT,SCIAMNT      Time cost amount                             
         CP    TRNAMNT,PZERO       R-time has zero amount                       
         JNE   PRSUM38                                                          
         L     RF,AGOXBLCK                                                      
         CLI   GOINCR-GOXBLOCK(RF),YESQ R time to be treated as actual          
         JE    *+12                                                             
         TM    SAVEIND,SAVESTC     estimate check instead?                      
         BZ    PRSUM38                                                          
         CLI   GOCSAT-GOXBLOCK(RF),GOCSCOST Want cost amount?                   
         JNE   PRSUM38                                                          
         ZAP   X#MAMT,SCIAMNT                                                   
         B     PRSUM38                                                          
*                                                                               
PRSUM48  ZAP   X#SAMT,SCIAMNT     Time sales amount                             
         CP    TRNAMNT,PZERO       ZERO?                                        
         JNE   PRSUM38                                                          
         L     RF,AGOXBLCK                                                      
         CLI   GOINCR-GOXBLOCK(RF),YESQ R time to be treated as actual          
         JE    *+12                                                             
         TM    SAVEIND,SAVESTC     estimate check instead?                      
         BZ    PRSUM38                                                          
         CLI   GOCSAT-GOXBLOCK(RF),GOCSSALE Want sale amount?                   
         JNE   PRSUM38                                                          
         ZAP   X#MAMT,SCIAMNT                                                   
         B     PRSUM38                                                          
*&&                                                                             
*&&US                                                                           
         USING PRTELD,RE                                                        
PRSUM46  TM    PRTSTAT,PRTSBILQ    Is this B-Time?                              
         BNO   PRSUM48                                                          
         CLI   RQ_JBHRS,NOQ        filter out hours                             
         BE    PRSUM38                                                          
         ZAP   DUB1,PRTHOUR                                                     
         B     PRSUM38                                                          
PRSUM48  CLI   RQ_JBHRS,NOQ        filter out hours                             
         BE    PRSUM38                                                          
         ZAP   DUB1,PRTHOUR                                                     
         TM    PRTSTAT,PRTSRTEQ    Is this R-Time?                              
         BNO   PRSUM38                                                          
         ZAP   DUB,PRTRATE                                                      
         MP    DUB,PRTHOUR                                                      
         DP    DUB,=P'100'                                                      
         ZAP   DUB2,DUB(6)                                                      
         ZAP   DUB,DUB2                                                         
         L     RF,AGOXBLCK                                                      
         CLI   GOINCR-GOXBLOCK(RF),YESQ R time to be treated as actual          
         JNE   PRSUM38                                                          
         ZAP   X#MAMT,DUB                                                       
         B     PRSUM38                                                          
         DROP  RE                                                               
*&&                                                                             
                                                                                
PRSUM50  L     R4,AESTWRKA                                                      
PRSUM52  CLI   WCSTWCD,WCSTEOT                                                  
         BE    PRSUM56                                                          
         CLC   WCSTWCD,TRNKWORK                                                 
         BNE   PRSUM54                                                          
         AP    WCSTHRS,DUB1                                                     
         AP    WCSTCHT,DUB                                                      
         AP    WCSTCPR,X#SAMT      TIME SALES AMOUNT                            
         AP    WCSTCCR,X#CAMT      TIME COST AMOUNT                             
         AP    WCSTCOB,X#COMAMT                                                 
         LA    RE,WCSTDBA                                                       
         TM    TRNSTAT,TRNSDR                                                   
         BNZ   *+8                                                              
         LA    RE,WCSTCRA                                                       
         AP    0(L'WCSTCRA,RE),TRNAMNT                                          
         AP    WCSTDBA,X#MAMT                                                   
         ZAP   X#CURTA,PZERO                                                    
         TM    TRNSTAT,TRNSDR                                                   
         BZ    *+10                                                             
         ZAP   X#CURTA,TRNAMNT                                                  
         GOTOR SETALL,1            need to set WCSTALA                          
         B     PRSUM32                                                          
                                                                                
PRSUM54  AHI   R4,WCSTLNQ                                                       
         B     PRSUM52                                                          
                                                                                
PRSUM56  MVC   WCSTWCD,TRNKWORK                                                 
         CLC   WCSTWCD,SPACES                                                   
         BH    *+6                                                              
         DC    H'0'                                                             
         ZAP   WCSTORA,PZERO                                                    
         ZAP   WCSTHRS,DUB1                                                     
         ZAP   WCSTCHT,DUB                                                      
         ZAP   WCSTCPR,X#SAMT      TIME SALES AMOUNT                            
         ZAP   WCSTCCR,X#CAMT      TIME COST AMOUNT                             
         ZAP   WCSTDBA,PZERO                                                    
         ZAP   WCSTCRA,PZERO                                                    
         ZAP   WCSTALA,PZERO                                                    
         ZAP   WCSTCOM,PZERO                                                    
         ZAP   WCSTCOB,X#COMAMT                                                 
         LA    RE,WCSTDBA                                                       
         TM    TRNSTAT,TRNSDR                                                   
         BNZ   *+8                                                              
         LA    RE,WCSTCRA                                                       
         AP    0(L'WCSTCRA,RE),TRNAMNT                                          
         AP    WCSTDBA,X#MAMT                                                   
         ZAP   WCSTCEA,PZERO                                                    
         MVI   WCSTWCD+WCSTLNQ,WCSTEOT                                          
         ZAP   X#CURTA,PZERO                                                    
         TM    TRNSTAT,TRNSDR                                                   
         BZ    *+10                                                             
         ZAP   X#CURTA,TRNAMNT                                                  
         GOTOR SETALL,1            need to set WCSTALA                          
         B     PRSUM32                                                          
         DROP  R2,R3                                                            
                                                                                
*                                                                               
PRSUM58  CLI   RQ_JBTYP,RQ_JBWCX   *** TIMESHEETS ***                           
         BNE   PRSUM92             (Extended summary view only)                 
                                                                                
         LA    R1,X#RTTRX                                                       
         USING TMSTTABD,R1                                                      
         LA    R0,TMSTNUM                                                       
PRSUM60  CLI   TMSTMPTY,YESQ       Are interested in in progress TS             
         JE    PRSUM62             Yes                                          
         OC    TMSTSTAT,TMSTSTAT   Are we interested in other statuses          
         JNZ   PRSUM62             Yes                                          
         LA    R1,TMSTTABL(R1)     No - look at next entry                      
         JCT   R0,PRSUM60                                                       
         J     PRSUM92                                                          
         DROP  R1                                                               
                                                                                
TP       USING TSJPASD,IOKEY                                                    
PRSUM62  XC    TP.TSJPAS,TP.TSJPAS                                              
         MVI   TP.TSJPTYP,TSJPTYPQ                                              
         MVI   TP.TSJPSUB,TSJPSUBQ                                              
         MVI   TP.TSJPVIEW,TSJPSJAQ                                             
         MVC   TP.TSJPCPY,CUXCPY                                                
         MVC   TP.TSJPCOFF,RQ_JBOFF                                             
         MVC   TP.TSJPACT,RQ_JBACT                                              
         LLC   RE,PPROLEN                                                       
         LA    R1,RQ_JBACT                                                      
         AR    R1,RE                                                            
         MVC   TP.TSJPMED,0(R1)                                                 
                                                                                
         MVC   CSVKEY1,TP.TSJPAS                                                
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         BE    PRSUM70                                                          
         B     PRSUM92                                                          
                                                                                
PRSUM68  GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         BNE   PRSUM92                                                          
                                                                                
PRSUM70  CLC   TP.TSJPAS(TSJPPEDT-TSJPASD),CSVKEY1    Match on key?             
         BNE   PRSUM92                                                          
                                                                                
         DS    0H                  no filtering on TSJPKSTA                     
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         USING TIMRECD,R2                                                       
         L     R2,AIO2                                                          
                                                                                
         USING TIMELD,R3                                                        
         LA    R3,TIMRFST                                                       
         B     PRSUM74                                                          
                                                                                
PRSUM72  LLC   R0,TIMLN            find appropriate TIMEL cluster(s)            
         AR    R3,R0                                                            
                                                                                
PRSUM74  CLI   TIMEL,0                                                          
         BE    PRSUM68                                                          
         CLI   TIMEL,TIMELQ                                                     
         BNE   PRSUM72                                                          
         CLI   TIMETYP,TIMEITMS                                                 
         BE    PRSUM84                                                          
         CLI   TIMETYP,TIMEINP                                                  
         BNE   PRSUM72                                                          
         ST    R3,FULL1            Save address of input timel                  
         CLC   TIMACC(2),PRODUL                                                 
         BNE   PRSUM72                                                          
         CLC   TIMACC+2(12),RQ_JBACT                                            
         BNE   PRSUM72             look for this joB's items only               
         CLC   TIMTSK,SPACES       Have we got a workcode                       
         JNH   PRSUM72                                                          
         GOTOR FLTTMP,DMCB,TIMELD,TP.TSJPASD                                    
         JNE   PRSUM72                                                          
                                                                                
         L     R4,AESTWRKA                                                      
         ZAP   DUB1,PZERO                                                       
         ZAP   DUB2,PZERO                                                       
         CLI   TIMTTYP,TIMTCN                                                   
         JE    PRSUM76                                                          
         AP    DUB1,TIMRATE        Amount = Rate * Hours                        
         MP    DUB1,TIMHRS                                                      
         SRP   DUB1,64-2,5         / 100 (hours is 2 dec places)                
*&&UK                                                                           
         AP    DUB2,TIMCRATE       Amount = Rate * Hours                        
         MP    DUB2,TIMHRS                                                      
         SRP   DUB2,64-2,5         / 100 (hours is 2 dec places)                
*&&                                                                             
                                                                                
PRSUM76  CLI   WCSTWCD,WCSTEOT                                                  
         BE    PRSUM80                                                          
         CLC   WCSTWCD,TIMTSK                                                   
         BNE   PRSUM78                                                          
         CLI   RQ_JBHRS,NOQ        filter out hours                             
         BE    *+10                                                             
         AP    WCSTHRS,TIMHRS                                                   
         AP    WCSTCCR,DUB2        Cost                                         
         AP    WCSTCPR,DUB1        Sales                                        
         CLI   TIMTTYP,TIMTCB                                                   
         JNE   *+10                                                             
         AP    WCSTDBA,TIMAMNT                                                  
         CLI   TIMTTYP,TIMTCR                                                   
         JNE   PRSUM72                                                          
         AP    WCSTCHT,DUB1                                                     
                                                                                
         L     RF,AGOXBLCK                                                      
         CLI   GOINCR-GOXBLOCK(RF),YESQ R time to be treated as actual          
         JE    *+12                                                             
         TM    SAVEIND,SAVESTC     estimate check instead?                      
         BZ    PRSUM72                                                          
*&&UK                                                                           
         LA    R1,DUB2                                                          
         L     RF,AGOXBLCK                                                      
         CLI   GOCSAT-GOXBLOCK(RF),GOCSSALE Want sale amount?                   
         JNE   *+8                                                              
*&&                                                                             
         LA    R1,DUB1                                                          
         AP    WCSTDBA,0(L'DUB1,R1)                                             
         B     PRSUM72                                                          
                                                                                
PRSUM78  AHI   R4,WCSTLNQ                                                       
         B     PRSUM76                                                          
                                                                                
PRSUM80  MVC   WCSTWCD,TIMTSK      save values to buffer                        
         CLC   WCSTWCD,SPACES                                                   
         BH    *+6                                                              
         DC    H'0'                                                             
         ZAP   WCSTHRS,PZERO                                                    
         ZAP   WCSTCHT,PZERO                                                    
         CLI   RQ_JBHRS,NOQ        filter out hours                             
         BE    *+10                                                             
         ZAP   WCSTHRS,TIMHRS                                                   
         ZAP   WCSTCCR,DUB2                                                     
         ZAP   WCSTCPR,DUB1                                                     
         ZAP   WCSTDBA,PZERO                                                    
         CLI   TIMTTYP,TIMTCB                                                   
         BNE   *+10                                                             
         ZAP   WCSTDBA,TIMAMNT                                                  
         CLI   TIMTTYP,TIMTCR                                                   
         BNE   PRSUM82                                                          
         ZAP   WCSTCHT,DUB1                                                     
         L     RF,AGOXBLCK                                                      
         CLI   GOINCR-GOXBLOCK(RF),YESQ R time to be treated as actual          
         JE    *+12                                                             
         TM    SAVEIND,SAVESTC     estimate check instead?                      
         BZ    PRSUM82                                                          
*&&UK                                                                           
         LA    R1,DUB2                                                          
         CLI   GOCSAT-GOXBLOCK(RF),GOCSSALE Want sale amount?                   
         BNE   *+8                                                              
*&&                                                                             
         LA    R1,DUB1                                                          
         ZAP   WCSTDBA,0(L'DUB2,R1)                                             
                                                                                
PRSUM82  ZAP   WCSTORA,PZERO                                                    
         ZAP   WCSTCRA,PZERO                                                    
         ZAP   WCSTALA,PZERO                                                    
         ZAP   WCSTCEA,PZERO                                                    
         ZAP   WCSTCOM,PZERO                                                    
         ZAP   WCSTCOB,PZERO                                                    
         MVI   WCSTWCD+WCSTLNQ,WCSTEOT                                          
         B     PRSUM72                                                          
                                                                                
PRSUM84  CLC   TIMIUNT(2),PRODUL                                                
         BNE   PRSUM72                                                          
         CLC   TIMIACC,RQ_JBACT                                                 
         BNE   PRSUM72             look for this joB's items only               
         CLC   TIMITSK,SPACES      Have we got a workcode                       
         JNH   PRSUM72                                                          
         L     R2,FULL1                                                         
         GOTOR FLTTMP,DMCB,(R2),TP.TSJPASD                                      
         JNE   PRSUM72                                                          
                                                                                
         L     R4,AESTWRKA                                                      
PRSUM86  CLI   WCSTWCD,WCSTEOT                                                  
         BE    PRSUM90                                                          
         CLC   WCSTWCD,TIMITSK                                                  
         BNE   PRSUM88                                                          
         AP    WCSTDBA,TIMITOT                                                  
         B     PRSUM72                                                          
                                                                                
PRSUM88  AHI   R4,WCSTLNQ                                                       
         B     PRSUM86                                                          
                                                                                
PRSUM90  MVC   WCSTWCD,TIMTSK      save values to buffer                        
         CLC   WCSTWCD,SPACES                                                   
         BH    *+6                                                              
         DC    H'0'                                                             
         ZAP   WCSTHRS,PZERO                                                    
         ZAP   WCSTCCR,PZERO                                                    
         ZAP   WCSTCPR,PZERO                                                    
         ZAP   WCSTDBA,TIMITOT                                                  
         ZAP   WCSTCHT,PZERO                                                    
         ZAP   WCSTORA,PZERO                                                    
         ZAP   WCSTCRA,PZERO                                                    
         ZAP   WCSTALA,PZERO                                                    
         ZAP   WCSTCEA,PZERO                                                    
         ZAP   WCSTCOM,PZERO                                                    
         ZAP   WCSTCOB,PZERO                                                    
         MVI   WCSTWCD+WCSTLNQ,WCSTEOT                                          
         B     PRSUM72                                                          
         DROP  TP,R2,R3                                                         
                                                                                
PRSUM92  CLI   RQ_JBTYP,RQ_JBWCX   *** EXPENSE CLAIMS ***                       
         BNE   PRSUM114            (Extended summary view only)                 
                                                                                
         LA    R6,EXPTTAB                                                       
         USING EXJPASD,R2                                                       
PRSUM94  LA    R2,IOKEY                                                         
         XC    EXJPAS,EXJPAS                                                    
         MVI   EXJPTYP,EXJPTYPQ                                                 
         MVI   EXJPSUB,EXJPSUBQ                                                 
         MVC   EXJPCPY,CUXCPY                                                   
         MVC   EXJPVIEW,0(R6)                                                   
         MVC   EXJPCOFF,RQ_JBOFF                                                
         MVC   EXJPCPJ,RQ_JBACT                                                 
                                                                                
         MVC   CSVKEY1,EXJPAS                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         BE    PRSUM98                                                          
         B     PRSUM114                                                         
                                                                                
PRSUM96  LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         BNE   PRSUM114                                                         
                                                                                
PRSUM98  CLC   EXJPAS(EXJPMED-EXJPASD),CSVKEY1    Match on key?                 
         BNE   PRSUM112                                                         
         GOTOR FLTEXK,DMCB,EXJPAS                 filter expense claims         
         BNE   PRSUM96                                                          
*                                                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         USING EXCRECD,R2                                                       
         L     R2,AIO2                                                          
         USING CIDELD,R3                                                        
         LA    R3,EXCRFST                                                       
         B     PRSUM102                                                         
                                                                                
PRSUM100 LLC   R0,CIDLN            find appropriate CIDEL cluster(s)            
         AR    R3,R0                                                            
                                                                                
PRSUM102 CLI   CIDEL,0                                                          
         BE    PRSUM96                                                          
         CLI   CIDEL,CIDELQ                                                     
         BNE   PRSUM100                                                         
         CLI   CIDTYPE,CIDTYMQ                                                  
         BNE   PRSUM100                                                         
                                                                                
CUR      USING CIDELD,RF                                                        
         LA    RF,CIDELD           filter CIDEL and its cluster                 
         CLC   CIDMWCD,SPACES      Have we got a workcode                       
         JNH   PRSUM100                                                         
         GOTOR FLTEXL,DMCB,0(RF),EXCRECD filter expense claims                  
         JNE   PRSUM100                                                         
                                                                                
PRSUM104 LLC   R0,CUR.CIDLN                                                     
         AR    RF,R0                                                            
         CLI   CUR.CIDEL,CIDELQ                                                 
         BNE   PRSUM100                                                         
         CLC   CUR.CIDSEQ,CIDSEQ                                                
         BNE   PRSUM100                                                         
         CLI   CUR.CIDTYPE,CIDTYCQ                                              
         BNE   PRSUM104                                                         
                                                                                
         CLC   CUR.CIDCCPJ,RQ_JBACT                                             
         BNE   PRSUM100            look for this job's items                    
                                                                                
         L     R4,AESTWRKA                                                      
PRSUM106 CLI   WCSTWCD,WCSTEOT                                                  
         BE    PRSUM110                                                         
         CLC   WCSTWCD,CIDMWCD                                                  
         BNE   PRSUM108                                                         
         AP    WCSTDBA,CIDMAMT                                                  
         B     PRSUM100                                                         
                                                                                
PRSUM108 AHI   R4,WCSTLNQ                                                       
         B     PRSUM106                                                         
                                                                                
PRSUM110 MVC   WCSTWCD,CIDMWCD     save values to buffer                        
         CLC   WCSTWCD,SPACES                                                   
         BH    *+6                                                              
         DC    H'0'                                                             
         ZAP   WCSTHRS,PZERO                                                    
         ZAP   WCSTCCR,PZERO                                                    
         ZAP   WCSTCPR,PZERO                                                    
         ZAP   WCSTCHT,PZERO                                                    
         ZAP   WCSTORA,PZERO                                                    
         ZAP   WCSTDBA,CIDMAMT                                                  
         ZAP   WCSTCRA,PZERO                                                    
         ZAP   WCSTALA,PZERO                                                    
         ZAP   WCSTCEA,PZERO                                                    
         ZAP   WCSTCOM,PZERO                                                    
         ZAP   WCSTCOB,PZERO                                                    
         MVI   WCSTWCD+WCSTLNQ,WCSTEOT                                          
         B     PRSUM100                                                         
                                                                                
PRSUM112 LA    R6,1(R6)                                                         
         CLI   0(R6),X'FF'                                                      
         BNE   PRSUM94                                                          
         DROP  R2,R3,CUR                                                        
                                                                                
PRSUM114 CLI   RQ_JBTYP,RQ_JBWCX   *** UNAPPROVED ORDERS ***                    
         BNE   PRSUM142            (Extended summary view only)                 
                                                                                
         USING OSJPASD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    OSJPAS,OSJPAS                                                    
         MVI   OSJPTYP,OSJPTYPQ                                                 
         MVI   OSJPSUB,OSJPSUBQ                                                 
         MVC   OSJPCPY,CUXCPY                                                   
         MVC   OSJPACT,RQ_JBACT                                                 
         MVI   OSJPMEM,0           (no memo, see RQ_JBMEM)                      
                                                                                
         MVC   CSVKEY1,OSJPAS                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         BE    PRSUM118                                                         
         B     PRSUM142                                                         
                                                                                
PRSUM116 LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         BNE   PRSUM142                                                         
                                                                                
PRSUM118 CLC   OSJPAS(OSJPMEM-OSJPASD),CSVKEY1     Match on key?                
         BNE   PRSUM142                                                         
*                                                                               
PRSUM120 CLI   OSJPMEM,0           Test memo order                              
         BNE   PRSUM122            Yes                                          
         TM    OSJPSTA2,ORDSAPPR   Don't want approved orders                   
         BNZ   PRSUM116                                                         
                                                                                
PRSUM122 GOTOR FLTORD,DMCB,OSJPAS  filter orders                                
         JNE   PRSUM116                                                         
                                                                                
PRSUM124 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         USING ORDRECD,R2                                                       
         L     R2,AIO2                                                          
         XC    X#MWCIND,X#MWCIND                                                
         USING OAMELD,R3                                                        
         LA    R3,ORDRFST                                                       
                                                                                
PRSUM126 LLC   R0,OAMLN            check match on work code                     
         AR    R3,R0                                                            
         CLI   OAMEL,0                                                          
         BE    PRSUM116                                                         
         CLI   OAMEL,OAMELQ                                                     
         BNE   PRSUM126                                                         
         CLC   OAMWORK,SPACES                                                   
         BH    PRSUM134                                                         
                                                                                
         L     R4,AESTWRKA                                                      
         GOTOR GETMWC                                                           
         OC    HALF1,HALF1                                                      
         BZ    PRSUM116                                                         
                                                                                
PRSUM128 CLI   WCSTWCD,WCSTEOT                                                  
         BE    PRSUM132                                                         
         CLC   WCSTWCD,HALF1                                                    
         BNE   PRSUM130                                                         
         AP    WCSTORA,OAMAMNT                                                  
         SP    WCSTORA,OAMIVAL                                                  
         B     PRSUM116                                                         
                                                                                
PRSUM130 AHI   R4,WCSTLNQ                                                       
         B     PRSUM128                                                         
                                                                                
PRSUM132 MVC   WCSTWCD,HALF1       save values to buffer                        
         CLC   WCSTWCD,SPACES                                                   
         BH    *+6                                                              
         DC    H'0'                                                             
         ZAP   WCSTHRS,PZERO                                                    
         ZAP   WCSTCCR,PZERO                                                    
         ZAP   WCSTCPR,PZERO                                                    
         ZAP   WCSTCHT,PZERO                                                    
         ZAP   WCSTORA,OAMAMNT                                                  
         SP    WCSTORA,OAMIVAL                                                  
         ZAP   WCSTDBA,PZERO                                                    
         ZAP   WCSTCRA,PZERO                                                    
         ZAP   WCSTALA,PZERO                                                    
         ZAP   WCSTCEA,PZERO                                                    
         ZAP   WCSTCOM,PZERO                                                    
         ZAP   WCSTCOB,PZERO                                                    
         MVI   WCSTWCD+WCSTLNQ,WCSTEOT                                          
         B     PRSUM116                                                         
                                                                                
PRSUM134 L     R4,AESTWRKA         add w/c entry                                
                                                                                
PRSUM136 CLI   WCSTWCD,WCSTEOT                                                  
         BE    PRSUM140                                                         
         CLC   WCSTWCD,OAMWORK                                                  
         BNE   PRSUM138                                                         
         AP    WCSTORA,OAMAMNT                                                  
         SP    WCSTORA,OAMIVAL                                                  
         B     PRSUM126                                                         
                                                                                
PRSUM138 AHI   R4,WCSTLNQ                                                       
         B     PRSUM136                                                         
                                                                                
PRSUM140 MVC   WCSTWCD,OAMWORK     save values to buffer                        
         CLC   WCSTWCD,SPACES                                                   
         BH    *+6                                                              
         DC    H'0'                                                             
         ZAP   WCSTHRS,PZERO                                                    
         ZAP   WCSTCCR,PZERO                                                    
         ZAP   WCSTCPR,PZERO                                                    
         ZAP   WCSTCHT,PZERO                                                    
         ZAP   WCSTORA,OAMAMNT                                                  
         SP    WCSTORA,OAMIVAL                                                  
         ZAP   WCSTDBA,PZERO                                                    
         ZAP   WCSTCRA,PZERO                                                    
         ZAP   WCSTALA,PZERO                                                    
         ZAP   WCSTCEA,PZERO                                                    
         ZAP   WCSTCOM,PZERO                                                    
         ZAP   WCSTCOB,PZERO                                                    
         MVI   WCSTWCD+WCSTLNQ,WCSTEOT                                          
         B     PRSUM126                                                         
         DROP  R2,R3                                                            
                                                                                
PRSUM142 L     R4,AESTWRKA         ===> PROCESS TABLE NOW                       
         XR    R2,R2                                                            
                                                                                
PRSUM144 CLI   WCSTWCD,WCSTEOT     Count for SORT                               
         BE    PRSUM146                                                         
         AHI   R2,1                                                             
         AHI   R4,WCSTLNQ                                                       
         B     PRSUM144                                                         
                                                                                
PRSUM146 CHI   R2,1                                                             
         BL    PRSUMY                                                           
         BE    PRSUM148                                                         
         GOTO1 VXSORT,DMCB,AESTWRKA,(R2),WCSTLNQ,WCSTLNQ,0                      
                                                                                
PRSUM148 L     R4,AESTWRKA         and put out data                             
                                                                                
PRSUM150 CLI   WCSTWCD,WCSTEOT                                                  
         BE    PRSUMY                                                           
                                                                                
         GOTOR CLRJBV                                                           
                                                                                
         MVI   JB_TYPE,RQ_JBWCS                                                 
         MVC   JB_WCOD,WCSTWCD                                                  
         GOTOR PROWCD              sets JB_WDES from JB_WCOD                    
         CLI   RQ_CONTI,YESQ       include contingency?                         
         BNE   PRSUM160                                                         
         ZAP   X#PL16,WCSTCEA                                                   
         L     RF,AGOBLOCB                                                      
         MP    X#PL16,GOOVRPER-GOBLOCKD(L'GOOVRPER,RF)                          
         SRP   X#PL16,64-4,5       Calculate current est*maxper                 
         ZAP   WCSTCEA,X#PL16                                                   
*                                                                               
PRSUM160 ZAP   JB_ESTA,WCSTCEA                                                  
         ZAP   JB_DEBA,WCSTDBA                                                  
         ZAP   JB_CREA,WCSTCRA                                                  
         ZAP   JB_ALLA,WCSTALA                                                  
         ZAP   JB_ORDA,WCSTORA                                                  
         ZAP   JB_HOUR,WCSTHRS                                                  
         ZAP   JB_CASR,WCSTCPR                                                  
         ZAP   JB_CACR,WCSTCCR                                                  
         ZAP   JB_GROS,WCSTCOM                                                  
         AP    JB_GROS,WCSTDBA                                                  
         ZAP   JB_COMM,WCSTCOM                                                  
         ZAP   JB_COMB,WCSTCOB                                                  
         ZAP   JB_CHTI,WCSTCHT                                                  
                                                                                
         GOTOR LP_APUTO,LP_D                                                    
                                                                                
         AHI   R4,WCSTLNQ                                                       
         B     PRSUM150                                                         
                                                                                
PRSUMY   CR    RB,RB                                                            
         XIT1                                                                   
                                                                                
PRSUMN   MVC   ROUERRV,=AL2(AE$TMTRN)                                           
         LTR   RB,RB                                                            
         XIT1                                                                   
         LTORG                                                                  
                                                                                
                                                                                
                                                                                
         DROP  R4                                                               
                                                                                
* Process Contra Account Record                                                 
         USING CACRECD,R2                                                       
         USING CACELD,R3                                                        
PROCAC   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*PROCAC*'                                                      
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         L     R2,AIO2                                                          
         LA    R3,CACRFST                                                       
                                                                                
         MVC   X#CANAME,SPACES                                                  
         CLI   CACEL,CACELQ                                                     
         BNE   PROCACX                                                          
         CLI   CACLN,CACLN1Q                                                    
         BE    PROCACX                                                          
         LLC   R1,CACLN                                                         
         SHI   R1,CACLN1Q+1                                                     
         MVC   X#CANAME(0),CACNAME                                              
         EX    R1,*-6                                                           
                                                                                
PROCACX  XIT1                                                                   
         LTORG                                                                  
         DROP  R2,R3                                                            
***********************************************************************         
* Job approver download                                               *         
***********************************************************************         
JAPPGET  NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*JAPPGET'                                                      
                                                                                
         OC    RQ_JAACT,SPACES     validate job input                           
         CLC   RQ_JAACT,SPACES                                                  
         JH    JAPPG02                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$MSJOB)                                           
         B     JAPPGETN                                                         
                                                                                
         USING GOBLOCKD,R3                                                      
JAPPG02  L     R3,AGOBLOCB                                                      
                                                                                
         XC    GOADM(GOABUFF-GOADM),GOADM                                       
         XC    GOADETS(GOACOVL-GOADETS),GOADETS                                 
                                                                                
         MVC   GOADM,VDATAMGR                                                   
         MVC   GOABEXT,AGOBBLCK                                                 
         MVC   GOAEXT,AGOXBLCK                                                  
         MVC   GOSELCUL(1),CUXCPY                                               
         MVC   GOSELCUL+1(2),PRODUL                                             
                                                                                
         MVC   GOSELCLI,SPACES                                                  
         LLC   RE,PCLILEN                                                       
         SHI   RE,1                                                             
         MVC   GOSELCLI(0),RQ_JAACT                                             
         EX    RE,*-6                                                           
         MVC   GOSELPRO,SPACES                                                  
         LLC   R1,PCLILEN                                                       
         LLC   RF,PPROLEN                                                       
         SR    RF,R1                                                            
         SHI   RF,1                                                             
         LA    RE,RQ_JAACT(R1)                                                  
         MVC   GOSELPRO(0),0(RE)                                                
         EX    RF,*-6                                                           
         MVC   GOSELJOB,SPACES                                                  
         LLC   R1,PPROLEN                                                       
         LLC   RF,PJOBLEN                                                       
         SR    RF,R1                                                            
         CHI   RF,L'GOSELJOB                                                    
         BNH   *+8                                                              
         LA    RF,L'GOSELJOB                                                    
         SHI   RF,1                                                             
         LA    RE,RQ_JAACT(R1)                                                  
         MVC   GOSELJOB(0),0(RE)                                                
         EX    RF,*-6                                                           
         MVC   GOCTRY,CUCTRY                                                    
         OI    GOSPEC3,GOSPNERQ    USE NONE EMULATED IOS                        
                                                                                
         GOTO1 VGETOPT,DMCB,GOBLOCKD                                            
                                                                                
         USING GOXBLKD,R3                                                       
         L     R3,AGOXBLCK                                                      
         CLI   GODRFT,NOQ                                                       
         BNE   JAPPG50                                                          
         DROP  R3                                                               
                                                                                
JAPPG04  XC    LDGAREA(LDGALNQ),LDGAREA                                         
         MVC   LDGAUL,PRODUL                                                    
         GOTOR (#SETLDG,ASETLDG)                                                
         BE    JAPPG06                                                          
         MVC   ROUERRV,=AL2(AE$INLDG)                                           
         B     JAPPGETN                                                         
*                                                                               
JAPPG06  L     R1,AIO1                                                          
         LA    R1,LDGRFST-LDGRECD(R1)                                           
         USING LDGELD,R1                                                        
JAPPG08  CLI   LDGEL,0                                                          
         JE    JAPPGETY                                                         
         CLI   LDGEL,LDGELQ                                                     
         JE    JAPPG10                                                          
         LLC   RE,LDGLN                                                         
         AR    R1,RE                                                            
         J     JAPPG08                                                          
                                                                                
JAPPG10  TM    LDGSTAT2,LDGSDRFT                                                
         JZ    JAPPGETY                                                         
         DROP  R1                                                               
                                                                                
JAPPG50  OC    RQ_JAOFF,SPACES                                                  
         CLC   RQ_JAOFF,SPACES     if office missng get from cli/pro            
         BH    JAPPG66                                                          
         CLI   OFFIND,NONEQ        skip for non office agencies                 
         BE    JAPPG66                                                          
                                                                                
         USING ACTRECD,R2                                                       
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(2),PRODUL                                                
         LLC   RE,PCLILEN                                                       
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   ACTKACT(0),RQ_JAACT                                              
         EX    RE,0(RF)                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         BE    JAPPG52                                                          
         DC    H'0'                                                             
                                                                                
JAPPG52  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         BE    *+6                                                              
         DC    H'0'                Bad master record                            
                                                                                
         L     R2,AIO2                                                          
         LA    R2,ACTRFST                                                       
         USING PPRELD,R2                                                        
         XR    R0,R0                                                            
                                                                                
JAPPG54  CLI   PPREL,0                                                          
         BE    JAPPG58                                                          
         CLI   PPREL,PPRELQ                                                     
         BE    JAPPG56                                                          
         IC    R0,PPRLN                                                         
         AR    R2,R0                                                            
         B     JAPPG54                                                          
                                                                                
JAPPG56  MVC   RQ_JAOFF,PPRGAOFF                                                
         OC    RQ_JAOFF,SPACES                                                  
                                                                                
         USING ACTRECD,R2                                                       
JAPPG58  LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(2),PRODUL                                                
         LLC   RE,PPROLEN                                                       
         SHI   RE,1                                                             
         BASR  RF,0                                                             
         MVC   ACTKACT(0),RQ_JAACT                                              
         EX    RE,0(RF)                                                         
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         BE    JAPPG60                                                          
         DC    H'0'                should exist                                 
                                                                                
JAPPG60  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         BE    *+6                                                              
         DC    H'0'                Bad master record                            
                                                                                
         L     R2,AIO2                                                          
         LA    R2,ACTRFST                                                       
         USING PPRELD,R2                                                        
         XR    R0,R0                                                            
                                                                                
JAPPG62  CLI   PPREL,0                                                          
         BE    JAPPG66                                                          
         CLI   PPREL,PPRELQ                                                     
         BE    JAPPG64                                                          
         IC    R0,PPRLN                                                         
         AR    R2,R0                                                            
         B     JAPPG62                                                          
                                                                                
JAPPG64  CLC   PPRGAOFF,SPACES                                                  
         BNH   JAPPG66                                                          
         MVC   RQ_JAOFF,PPRGAOFF                                                
         OC    RQ_JAOFF,SPACES                                                  
                                                                                
         USING ACTRECD,R2                                                       
JAPPG66  LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(2),PRODUL                                                
         MVC   ACTKACT,RQ_JAACT                                                 
         LLC   RE,PPROLEN                                                       
         LA    RE,RQ_JAACT(RE)                                                  
         MVC   X#MEDC,0(RE)                                                     
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         BE    JAPPG68                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$INJOB)                                           
         B     JAPPGETN                                                         
                                                                                
JAPPG68  XC    X#JAMD,X#JAMD       clear creator and approver                   
         XC    X#JAPP,X#JAPP                                                    
                                                                                
         MVI   BYTE1,YESQ          set draft yes/no                             
         TM    ACTKSTAT,ACTSDRFT                                                
         BZ    JAPPG70                                                          
         MVI   BYTE1,NOQ                                                        
                                                                                
JAPPG70  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         USING RACELD,R3                                                        
         L     R2,AIO2             look for creator and approver                
         LA    R3,ACTRFST                                                       
         XR    R0,R0                                                            
         XC    X#JCRE,X#JCRE                                                    
                                                                                
JAPPG72  CLI   RACEL,0                                                          
         BE    JAPPG78                                                          
         CLI   RACEL,RACELQ                                                     
         BNE   JAPPG76                                                          
         LA    RE,X#JAPP                                                        
         CLI   RACTYPE,RACTAPP                                                  
         BE    JAPPG74                                                          
         LA    RE,X#JAMD                                                        
         CLI   RACTYPE,RACTADD                                                  
         BNE   JAPPG76                                                          
         MVC   X#JCRE,RACPERS                                                   
                                                                                
JAPPG74  MVC   0(2,RE),RACPERS                                                  
                                                                                
JAPPG76  IC    R0,RACLN                                                         
         AR    R3,R0                                                            
         B     JAPPG72                                                          
         DROP  R2,R3                                                            
                                                                                
JAPPG78  XC    JP_VALS(JP_LNQ),JP_VALS                                          
         LA    R0,ACCBLK                                                        
         LHI   R1,ONEK                                                          
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         OC    X#JAPP,X#JAPP       Have we got approver                         
         JNZ   JAPPG80                                                          
         GOTOR GETAPP,DMCB,(1,RQ_JAACT),RQ_JAOFF                                
         BE    JAPPG80                                                          
         CLI   BYTE1,YESQ          If job is approved put out else              
         BE    JAPPG80             look for approver                            
         MVC   ROUERRV,=AL2(AE$NEAPF)                                           
         J     JAPPGETN            Error                                        
                                                                                
JAPPG80  OC    X#JCRE,X#JCRE                                                    
         BZ    JAPPG82                                                          
         MVC   TEMP2(2),X#JCRE                                                  
         GOTOR (#GETPID,AGETPID)                                                
         BNE   JAPPG82                                                          
         MVC   JP_CPC,TEMP2                                                     
         GOTOR (#GETPIN,AGETPIN)                                                
         BNE   JAPPG82                                                          
         MVC   JP_CPF,TEMP2                                                     
         MVC   JP_CPL,TEMP2+16                                                  
         MVI   BYTE4,SE#JOBS                                                    
         GOTOR (#SEMAIL,ASEMAIL),DMCB,RQ_JAOFF,BYTE4                            
         JNE   *+10                CHECK WHETHER TO SEND EMAILS                 
         MVC   JP_CEM,APPEMAIL                                                  
                                                                                
JAPPG82  OC    X#JAPP,X#JAPP                                                    
         JZ    JAPPG98                                                          
         CLI   BYTE1,YESQ          If job is not approved put out all           
         BNE   JAPPG90             approvers                                    
         LA    R3,ACCBLK                                                        
JAPPG84  OC    0(L'JOBPPIDB,R3),0(R3)                                           
         JZ    JAPPG92                                                          
         CLC   X#JAPP,0(R3)                                                     
         JE    JAPPG94                                                          
         LA    R3,L'JOBPPIDB+L'JP_LVL(R3)                                       
         J     JAPPG84                                                          
                                                                                
JAPPG90  LA    R3,ACCBLK                                                        
         OC    0(L'JOBPPIDB,R3),0(R3)                                           
         JNZ   JAPPG94                                                          
                                                                                
JAPPG92  MVC   TEMP2(2),X#JAPP                                                  
         MVC   HALF1,X#JAPP                                                     
         J     JAPPG96                                                          
                                                                                
JAPPG94  MVC   TEMP2(2),0(R3)                                                   
         MVC   HALF1,0(R3)                                                      
         MVC   JP_LVL,L'JOBPPIDB(R3)                                            
                                                                                
JAPPG96  GOTOR (#GETPID,AGETPID)                                                
         BNE   JAPPG98                                                          
         MVC   JP_APC,TEMP2                                                     
         GOTOR (#GETPIN,AGETPIN)                                                
         BNE   JAPPG98                                                          
         MVC   JP_APF,TEMP2                                                     
         MVC   JP_APM,TEMP2+32                                                  
         MVC   JP_APL,WORK2                                                     
         XC    JP_AEM,JP_AEM                                                    
         CLC   HALF1,X#JAPP        Only send email address on default           
         BNE   JAPPG98              or actual approver                          
         MVI   BYTE4,SE#JOBS                                                    
         GOTOR (#SEMAIL,ASEMAIL),DMCB,RQ_JAOFF,BYTE4                            
         JNE   *+10                Check whether to send emails                 
         MVC   JP_AEM,APPEMAIL                                                  
                                                                                
JAPPG98  DS    0H                                                               
                                                                                
         GOTOR LP_APUTO,LP_D                                                    
         CLI   BYTE1,YESQ          If job is approved put out only who          
         BE    JAPPGETY            approved                                     
         LA    R3,L'JOBPPIDB+L'JP_LVL(R3)                                       
         OC    0(L'JOBPPIDB,R3),0(R3)                                           
         JNZ   JAPPG94                                                          
                                                                                
JAPPGETY CR    RB,RB                                                            
         B     *+6                                                              
JAPPGETN LTR   RB,RB                                                            
         XIT1                                                                   
                                                                                
         LTORG                                                                  
                                                                                
* Get approvers for job                                                         
GETAPP   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*GETAPP*'                                                      
                                                                                
         LM    R3,R4,0(R1)                                                      
         MVC   BYTE3,0(R1)                                                      
         LA    R5,ACCBLK                                                        
GETAPP01 MVI   BYTE2,NOQ                                                        
P        USING ACTKACT,R3                                                       
                                                                                
         LA    R2,APRTAB                                                        
         USING APRTABD,R2                                                       
SJ       USING JOBPASD,IOKEY                                                    
GETAPP02 XC    SJ.JOBPAS,SJ.JOBPAS Look for Cli/Pro job appr passive            
         MVI   SJ.JOBPTYP,JOBPTYPQ                                              
         MVI   SJ.JOBPSUB,JOBPSUBQ                                              
         MVC   SJ.JOBPCPY,CUXCPY                                                
         MVI   SJ.JOBPAPPL,JOBPAJOB                                             
         MVI   SJ.JOBPVIEW,JOBPVOFF                                             
         MVC   SJ.JOBPCPJ,SPACES                                                
         MVC   SJ.JOBPCOFF,SPACES                                               
         MVC   SJ.JOBPCMED,SPACES                                               
         OC    APRSTAT,APRSTAT                                                  
         JNZ   GETAPP04                                                         
         MVI   SJ.JOBPCODE,X'FF'                                                
         MVC   SJ.JOBPCODE+1(L'JOBPCODE-1),SJ.JOBPCODE                          
         J     GETAPP12                                                         
                                                                                
GETAPP04 TM    APRSTAT,APRPRO                                                   
         JZ    GETAPP06                                                         
         LLC   RF,PCLILEN                                                       
         LA    RF,P.ACTKACT(RF)                                                 
         CLI   0(RF),X'40'         Have we got a product                        
         JNH   GETAPP20            No                                           
         LLC   RF,PPROLEN                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   SJ.JOBPCPJ(0),P.ACTKACT                                          
         EX    RF,0(RE)                                                         
         J     GETAPP08                                                         
GETAPP06 TM    APRSTAT,APRCLI                                                   
         JZ    GETAPP08                                                         
         LLC   RF,PCLILEN                                                       
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   SJ.JOBPCPJ(0),P.ACTKACT                                          
         EX    RF,0(RE)                                                         
                                                                                
GETAPP08 TM    APRSTAT,APRMED                                                   
         JZ    GETAPP10                                                         
         CLC   X#MEDC,SPACES                                                    
         JNH   GETAPP20                                                         
         MVC   SJ.JOBPCMED,X#MEDC                                               
                                                                                
GETAPP10 TM    APRSTAT,APROFF                                                   
         JZ    GETAPP12                                                         
         CLC   0(L'TRNOFFC,R4),SPACES                                           
         JNH   GETAPP20                                                         
         MVC   SJ.JOBPCOFF,0(R4)                                                
                                                                                
GETAPP12 OC    SJ.JOBPCODE,SPACES                                               
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         J     GETAPP16                                                         
                                                                                
GETAPP14 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
                                                                                
GETAPP16 CLC   SJ.JOBPAS(JOBPPIDB-JOBPASD),IOKEYSAV                             
         JE    GETAPP22                                                         
         CLI   BYTE2,YESQ          Did we find an approver                      
         JNE   GETAPP20            No                                           
         OC    X#JAPP,X#JAPP       Yes - did we find default                    
         JNZ   GETAPPY             Yes                                          
         J     GETAPPN             No - error as there should be one            
GETAPP20 LA    R2,APRTABL(R2)                                                   
         CLI   0(R2),X'FF'                                                      
         JNE   GETAPP02                                                         
         J     GETAPPN                                                          
                                                                                
GETAPP22 MVI   BYTE2,YESQ                                                       
         CLI   BYTE3,1             Are we looking for default only              
         BNE   GETAPP24            No                                           
         MVC   0(L'JOBPPIDB,R5),SJ.JOBPPIDB                                     
         MVC   L'JOBPPIDB(L'JP_LVL,R5),APRLVL                                   
         LA    R5,L'JOBPPIDB+L'JP_LVL(R5)                                       
         TM    SJ.JOBPSTAT,JOBPDFLT Is it default approver                      
         JZ    GETAPP14                                                         
         OC    X#JAPP,X#JAPP       Did we already find default                  
         JNZ   GETAPP14            Yes                                          
         MVC   X#JAPP,SJ.JOBPPIDB                                               
         MVC   JP_LVL,APRLVL       approver level                               
         B     GETAPP14                                                         
                                                                                
GETAPP24 CLC   SJ.JOBPPIDB,CCTPID  Is this approver the correct one             
         BNE   GETAPP14                                                         
                                                                                
GETAPPY  CR    RB,RB                                                            
         B     *+6                                                              
GETAPPN  LTR   RB,RB                                                            
         XIT1                                                                   
         DROP  P,SJ,R2                                                          
                                                                                
APRTAB   DS    0XL1                                                             
         DC    B'11011000'         Office/client/product/media                  
         DC    C'1'                                                             
         DC    B'10011000'         Office/client/media                          
         DC    C'2'                                                             
         DC    B'10010000'         Client/media                                 
         DC    C'4'                                                             
         DC    B'00011000'         Office/media                                 
         DC    C'3'                                                             
         DC    B'00010000'         Media                                        
         DC    C'M'                                                             
         DC    B'11001000'         Office/client/product                        
         DC    C'P'                                                             
         DC    B'10001000'         Office/client                                
         DC    C'C'                                                             
         DC    B'10000000'         Client                                       
         DC    C'C'                                                             
         DC    B'00001000'         Office                                       
         DC    C'O'                                                             
         DC    B'00000000'         Agency                                       
         DC    C'A'                                                             
         DC    X'FF'                                                            
                                                                                
         LTORG                                                                  
                                                                                
* Set allocated amount for current record                                       
         USING TRNRECD,R2                                                       
         USING WCSTABD,R4                                                       
SETALL   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*SETALL*'                                                      
                                                                                
         STC   R1,X#CURFL                                                       
         MVI   X#PGSTAT,0                                                       
                                                                                
         CLI   X#CURFL,2           special BILL commission call                 
         BE    SETALL2                                                          
         CLI   X#CURFL,0                                                        
         BE    SETALL0                                                          
         CLI   X#FBADV,YESQ        FlexiBill advances - skip if summary         
         BE    SETALL8                                                          
                                                                                
SETALL0  DS    0H                                                               
*&&US                                                                           
         CLI   X#CURFL,2           Bill View? then get rate                     
         BNE   *+14                                                             
         MVC   SAVEKEY2,IOKEY                                                   
         B     SETALL2                                                          
*&&                                                                             
         CLC   TRNKWORK,BILWC      no allocation/commission for bills           
         BE    SETALLX                                                          
                                                                                
         CLI   X#CURFL,1           summary - then handle commission             
         BNE   SETALL8                                                          
         CP    X#CURTA,PZERO       but skip for zero                            
         BE    SETALL8                                                          
                                                                                
SETALL2  CLC   TRNKWORK,X#CURWC    same w/c as before?                          
         BE    SETALL6                                                          
                                                                                
         USING GOBLOCKD,R3                                                      
         MVC   X#CURWC,TRNKWORK    get commission                               
         MVC   SAVEKEY2,TRNKEY                                                  
         L     R3,AGOBLOCB                                                      
                                                                                
         XC    GOADM(GOABUFF-GOADM),GOADM                                       
         XC    GOADETS(GOACOVL-GOADETS),GOADETS                                 
                                                                                
         MVC   GOADM,VDATAMGR                                                   
         MVC   GOSELCUL,TRNKEY                                                  
         MVC   GOSELCLI,SPACES                                                  
         LLC   RE,PCLILEN                                                       
         SHI   RE,1                                                             
         MVC   GOSELCLI(0),TRNKACT                                              
         EX    RE,*-6                                                           
         MVC   GOSELPRO,SPACES                                                  
         LLC   R1,PCLILEN                                                       
         LLC   RF,PPROLEN                                                       
         SR    RF,R1                                                            
         SHI   RF,1                                                             
         LA    RE,TRNKACT(R1)                                                   
         MVC   GOSELPRO(0),0(RE)                                                
         EX    RF,*-6                                                           
         MVC   GOSELJOB,SPACES                                                  
         LLC   R1,PPROLEN                                                       
         LLC   RF,PJOBLEN                                                       
         SR    RF,R1                                                            
         CHI   RF,L'GOSELJOB                                                    
         BNH   *+8                                                              
         LA    RF,L'GOSELJOB                                                    
         SHI   RF,1                                                             
         LA    RE,TRNKACT(R1)                                                   
         MVC   GOSELJOB(0),0(RE)                                                
         EX    RF,*-6                                                           
         MVI   GOANYWC,YESQ                                                     
         MVC   GOSELWC,TRNKWORK                                                 
         MVC   GOAEXT,AGOXBLCK                                                  
         MVC   GOABEXT,AGOBBLCK                                                 
         MVC   GOCTRY,CUCTRY                                                    
         L     RF,ACOMFACS                                                      
         XC    GOACOVL,GOACOVL                                                  
         TM    LP_FLAG,LP_FOFFL    TEST OFFLINE                                 
         JZ    *+10                                                             
         MVC   GOACOVL,VCOVAIL                                                  
         MVC   GOABINSR,CBINSRCH-COMFACSD(RF)                                   
         OI    GOSPEC3,GOSPNERQ    USE NONE EMULATED IOS                        
                                                                                
         GOTO1 VGETOPT,DMCB,GOBLOCKD                                            
                                                                                
         MVC   X#CURCR,GOAGYCOM                                                 
*&&US                                                                           
         CLI   X#CURFL,2           Bill View? then get rate                     
         BNE   SETALL3                                                          
         MVC   IOKEY,SAVEKEY2                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         BE    SETALLX                                                          
         DC    H'0'                                                             
SETALL3  DS    0H                                                               
*&&                                                                             
*&&UK                                                                           
         CLI   CUCTRY,CTRYGER                                                   
         BNE   SETALL4                                                          
         CLI   GOSELWC,C'Z'                                                     
         BH    SETALL4                                                          
         OC    GOPROVPC,GOPROVPC                                                
         BZ    SETALL4                                                          
         ZAP   X#CURCR,GOPROVPC                                                 
*&&                                                                             
SETALL4  LA    R2,IOKEY            reread transaction record                    
         MVC   TRNKEY,SAVEKEY2                                                  
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         BE    *+6                                                              
         DC    H'0'                                                             
         LHI   R1,IOGET+IOMST+IO2                                               
         TM    TRNKSTAT,TRNSARCH                                                
         BZ    *+8                                                              
         LHI   R1,IOGET+IOARC+IO2                                               
         GOTOR (#IOEXEC,AIOEXEC)                                                
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO2                                                          
                                                                                
SETALL6  CLI   X#CURFL,2           Calculate commission but not if Bill         
         BE    SETALLX                                                          
         MP    X#CURTA,X#CURCR                                                  
         SRP   X#CURTA,64-6,5      Rate is 4 decimal places                     
         ZAP   DUB,X#CURTA         Commission                                   
         AP    WCSTCOM,DUB                                                      
                                                                                
         USING PRORATAD,R3                                                      
SETALL8  DS    0H                                                               
                                                                                
         USING GOBLOCKD,RE                                                      
         L     RE,AGOBLOCB                                                      
         ZAP   GOAGYCOM,PZERO                                                   
         DROP  RE                                                               
                                                                                
         L     R3,AJOBLOCK         point to cleared PRORATAD area               
         LR    R0,R3                                                            
         LA    R1,JBLOCKL                                                       
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         GOTO1 VPRORATA,DMCB,AIO2,AGOBLOCB,ACOMFACS,0,PRORATAD,0                
                                                                                
         MVC   X#PGSTAT,PG$STAT                                                 
         TM    PG$STAT,PG$FULLB+PG$PARTB      billed?                           
         BZ    SETALLX                                                          
                                                                                
         LA    RE,JB_TALL          Put to Detail output                         
         LA    RF,JB_COMB                                                       
         CLI   X#CURFL,1                                                        
         BNE   SETALL9                                                          
         LA    RE,WCSTALA          or summary table entry                       
         LA    RF,WCSTCOB                                                       
                                                                                
SETALL9  AP    0(6,RE),PA$NETBL    Net billed (billed allocation)               
         AP    0(6,RF),PA$COMBL    Commission billed                            
                                                                                
SETALLX  XIT1                                                                   
         DROP  R2,R3,R4                                                         
         LTORG                                                                  
                                                                                
* Process for work code description                                             
PROWCD   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*PROWCD*'                                                      
                                                                                
         MVC   JB_WDES,SPACES                                                   
         MVI   JB_EORI,C'E'                                                     
         CLI   CUCTRY,CTRYGER                                                   
         BNE   PROWCD10                                                         
         CLI   JB_WCOD,C'0'                                                     
         BNL   PROWCD10                                                         
         MVI   JB_EORI,C'I'                                                     
                                                                                
         USING WCORECD,R3                                                       
PROWCD10 LA    R3,IOKEY                                                         
         MVC   WCOKEY,SPACES                                                    
         MVI   WCOKTYP,WCOKTYPQ                                                 
         MVC   WCOKCPY,CUXCPY                                                   
         MVC   WCOKUNT(2),PRODUL                                                
         MVC   WCOKWRK,JB_WCOD                                                  
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         BNE   PROWCDX                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         BNE   PROWCDX                                                          
                                                                                
         L     R3,AIO1                                                          
         LA    R3,WCORFST                                                       
         USING WCOELD,R3                                                        
         XR    R0,R0                                                            
                                                                                
PROWCD20 CLI   WCOEL,WCOELQ                                                     
         BE    PROWCD30                                                         
         CLI   WCOEL,0                                                          
         BE    PROWCDX                                                          
         IC    R0,WCOLN                                                         
         AR    R3,R0                                                            
         B     PROWCD20                                                         
                                                                                
PROWCD30 MVC   JB_WDES,WCODESC                                                  
         CLI   CUCTRY,CTRYGER                                                   
         BE    PROWCDX                                                          
         TM    WCOSTAT,WCOSHCOE                                                 
         BZ    PROWCDX                                                          
         MVI   JB_EORI,C'I'                                                     
                                                                                
PROWCDX  XIT1                                                                   
         LTORG                                                                  
         DROP  R3                                                               
                                                                                
* Get memo work code                                                            
GETMWC   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*GETMWC*'                                                      
                                                                                
         USING FFTELD,R2                                                        
         L     R2,AIO2                                                          
         AHI   R2,ORDRFST-ORDRECD                                               
         XR    R0,R0                                                            
         XC    HALF1,HALF1                                                      
                                                                                
GETMWC2  CLI   FFTEL,0                                                          
         JE    GETMWCX                                                          
         CLI   FFTEL,FFTELQ                                                     
         JNE   GETMWC4                                                          
         CLI   FFTTYPE,FFTTWRKC                                                 
         JNE   GETMWC4                                                          
         MVC   HALF1,FFTDATA                                                    
         J     GETMWCX                                                          
                                                                                
GETMWC4  IC    R0,FFTLN                                                         
         AR    R2,R0                                                            
         J     GETMWC2                                                          
                                                                                
GETMWCX  XIT1                                                                   
         LTORG                                                                  
         DROP  R2                                                               
                                                                                
***********************************************************************         
* Get TUP profile and 'translate' filter out based on GODITSB and     *         
* GODITSN and GODITSR (must be called after getopt call)              *         
***********************************************************************         
GETTUP   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*GETTUP*'                                                      
         USING COBLOCKD,R2                                                      
         USING GOXBLKD,R4                                                       
         L     R2,ACOBLOCK         Get cost allocation profiles                 
         L     R4,AGOXBLCK                                                      
         MVC   ORACCNT,SPACES                                                   
         GOTOR (#CSTPRF,ACSTPRF),DMCB,ORACCNT                                   
*                                                                               
         LA    R3,GODITSR                                                       
         TM    SAVEIND,SAVESTC    are we doing estimate checking?               
         JZ    *+8                                                              
         LA    R3,GOETMR                                                        
         LA    R1,X#RTTRX                                                       
         LA    R0,TMSTNUM          Number of settings                           
         TM    SAVEIND,SAVESTC    are we doing estimate checking?               
         JZ    *+8                                                              
         LA    R0,TMSTNU2                                                       
         USING COGOTABD,R4                                                      
GETTUP2  LA    R4,COGOTAB                                                       
*                                                                               
GETTUP4  CLC   COGOCAP,COTUP       Find match on COTUP                          
         BNE   GETTUP6             Get next entry in table if no match          
         CLC   COGOGOPT,0(R3)      Find match on getopt setting                 
         BE    GETTUP8                                                          
GETTUP6  LA    R4,COGOTABL(R4)                                                  
         B     GETTUP4                                                          
*                                                                               
GETTUP8  MVC   0(TMSTTABL,R1),COGOMPTY Set whether to read passives             
         LA    R3,1(R3)                                                         
         LA    R1,TMSTTABL(R1)     Point R1 to next type of time                
         BCT   R0,GETTUP2                                                       
*                                                                               
GETTUPX  XIT1                                                                   
         DROP  R2,R4                                                            
COGOTAB  DS    0X                                                               
         DC    AL1(COSAVED,GONONE,NOQ,0,0,0)                                    
         DC    AL1(COSAVED,GOAPPR,NOQ,0,0,0)                                    
         DC    AL1(COSAVED,GOINPR,NOQ,0,0,0)                                    
         DC    AL1(COSAVED,GOSUB,NOQ,0,0,0)                                     
         DC    AL1(COSAVED,GOMANPAP,NOQ,0,0,0)                                  
         DC    AL1(COSAVED,GOCLIPAP,NOQ,0,0,0)                                  
         DC    AL1(COSUBMD,GONONE,NOQ,0,0,0)                                    
         DC    AL1(COSUBMD,GOAPPR,NOQ,0,0,0)                                    
         DC    AL1(COSUBMD,GOINPR,YESQ,0,0,0)                                   
         DC    AL1(COSUBMD,GOSUB,NOQ,0,0,0)                                     
         DC    AL1(COSUBMD,GOCLIPAP,NOQ,0,0,0)                                  
         DC    AL1(COSUBMD,GOMANPAP,NOQ,0,0,0)                                  
         DC    AL1(COCLAPR,GONONE,NOQ,0,0,0)                                    
         DC    AL1(COCLAPR,GOAPPR,NOQ,0,0,0)                                    
         DC    AL1(COCLAPR,GOINPR,YESQ,TIMSSUBM+TIMSREJE+TIMSPAPP)              
         DC    AL1(0,TIMSAWAP)                                                  
         DC    AL1(COCLAPR,GOSUB,NOQ,TIMSSUBM+TIMSPAPP,0,TIMSAWAP)              
         DC    AL1(COCLAPR,GOMANPAP,NOQ,TIMSMAAP,0,TIMSAWAP)                    
         DC    AL1(COCLAPR,GOCLIPAP,NOQ,0,0,0)                                  
         DC    AL1(COLMAPR,GONONE,NOQ,0,0,0)                                    
         DC    AL1(COLMAPR,GOAPPR,NOQ,0,0,0)                                    
         DC    AL1(COLMAPR,GOINPR,YESQ,TIMSSUBM+TIMSREJE+TIMSPAPP)              
         DC    AL1(TIMSMAAP,0)                                                  
         DC    AL1(COLMAPR,GOSUB,NOQ,TIMSSUBM+TIMSPAPP,TIMSMAAP,0)              
         DC    AL1(COLMAPR,GOMANPAP,NOQ,0,0,0)                                  
         DC    AL1(COLMAPR,GOCLIPAP,NOQ,TIMSPAPP,0,TIMSAWAP)                    
         DC    AL1(COFUAPR,GONONE,NOQ,0,0,0)                                    
         DC    AL1(COFUAPR,GOAPPR,NOQ,0,0,0)                                    
         DC    AL1(COFUAPR,GOINPR,YESQ,TIMSSUBM+TIMSREJE+TIMSPAPP,0,0)          
         DC    AL1(COFUAPR,GOSUB,NOQ,TIMSSUBM+TIMSPAPP,0,0)                     
         DC    AL1(COFUAPR,GOMANPAP,NOQ,TIMSMAAP,0,0)                           
         DC    AL1(COFUAPR,GOCLIPAP,NOQ,TIMSPAPP,0,TIMSFAPP)                    
         DC    X'FF'                                                            
         LTORG                                                                  
                                                                                
                                                                                
* Clear values for PJW/Orders                                                   
PJOCLR   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*PJOCLR*'                                                      
                                                                                
         USING CPYELD,RF                                                        
         XC    X#CANAME,X#CANAME                                                
         XC    X#CACODE,X#CACODE                                                
         XC    X#WCCODE,X#WCCODE                                                
         XC    X#WCTYPE,X#WCTYPE                                                
         XC    X#WCDESC,X#WCDESC                                                
         XC    X#BILPID,X#BILPID                                                
         XC    X#RPAS,X#RPAS                                                    
         LA    RF,SCPYEL                                                        
         CLI   CPYLN,CPYLN4Q                                                    
         JL    PJOCLRX                                                          
         MVC   X#RPRE,CPYREQPF                                                  
         MVC   X#RSUF,CPYREQSF                                                  
         DROP  RF                                                               
                                                                                
PJOCLRX  XIT1                                                                   
         LTORG                                                                  
                                                                                
* Clear JB_VALS                                                                 
CLRJBV   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*CLRJBV*'                                                      
                                                                                
         LA    R0,JB_VALS                                                       
         LA    R1,JB_LNQ                                                        
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
CLRJBVX  XIT1                                                                   
         LTORG                                                                  
                                                                                
* Process for work code description                                             
GETWCT   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*GETWCT*'                                                      
                                                                                
         MVI   X#WCTIE,C'E'                                                     
         CLI   CUCTRY,CTRYGER                                                   
         BNE   GETWCT10                                                         
         CLI   RQ_JBWRK,C'0'                                                    
         BNL   GETWCT10                                                         
         MVI   X#WCTIE,C'I'                                                     
         B     GETWCTY                                                          
                                                                                
         USING WCORECD,R3                                                       
GETWCT10 LA    R3,IOKEY                                                         
         MVC   WCOKEY,SPACES                                                    
         MVI   WCOKTYP,WCOKTYPQ                                                 
         MVC   WCOKCPY,CUXCPY                                                   
         MVC   WCOKUNT(2),PRODUL                                                
         MVC   WCOKWRK,RQ_JBWRK                                                 
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         BNE   GETWCTN                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         BNE   GETWCTN                                                          
                                                                                
         L     R3,AIO1                                                          
         LA    R3,WCORFST                                                       
         USING WCOELD,R3                                                        
         XR    R0,R0                                                            
                                                                                
GETWCT20 CLI   WCOEL,WCOELQ                                                     
         BE    GETWCT30                                                         
         CLI   WCOEL,0                                                          
         BE    GETWCTN                                                          
         IC    R0,WCOLN                                                         
         AR    R3,R0                                                            
         B     GETWCT20                                                         
                                                                                
GETWCT30 TM    WCOSTAT,WCOSHCOE                                                 
         BZ    GETWCTY                                                          
         MVI   X#WCTIE,C'I'                                                     
                                                                                
GETWCTY  CR    RB,RB                                                            
         B     *+6                                                              
GETWCTN  LTR   RB,RB                                                            
         XIT1                                                                   
         LTORG                                                                  
         DROP  R3                                                               
                                                                                
* Get campaign name                                                             
GETCAM   NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*GETCAM*'                                                      
                                                                                
         MVC   TEMP2,SPACES                                                     
         USING CPNPASD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    CPNPAS,CPNPAS                                                    
         MVI   CPNPTYP,CPNPTYPQ                                                 
         MVI   CPNPSUB,CPNPSUBQ                                                 
         MVC   CPNPCPY,CUXCPY                                                   
         MVC   CPNPCODE,0(R1)                                                   
         XC    CPNPCODE,=X'FFFFFFFF'                                            
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO1'                               
         BNE   GETCAMX                                                          
                                                                                
         CLC   CPNPAS(CPNPACT-CPNPASD),IOKEYSAV                                 
         BNE   GETCAMX                                                          
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         BE    *+6                                                              
         DC    H'0'                FATAL ERROR                                  
                                                                                
         USING NAMELD,R3                                                        
         L     R2,AIO1                                                          
         LA    R3,RWKRFST-RWKRECD(R2)                                           
         XR    R0,R0                                                            
                                                                                
GETCAM2  CLI   NAMEL,NAMELQ                                                     
         BE    GETCAM4                                                          
         CLI   NAMEL,0                                                          
         BE    GETCAMX                                                          
         IC    R0,NAMLN                                                         
         AR    R3,R0                                                            
         B     GETCAM2                                                          
                                                                                
GETCAM4  LLC   R1,NAMLN                                                         
         SHI   R1,3                                                             
         MVC   TEMP2(0),NAMEREC                                                 
         EX    R1,*-6                                                           
                                                                                
GETCAMX  DS    0H                                                               
         XIT1                                                                   
         DROP  R2,R3                                                            
         LTORG                                                                  
                                                                                
* Get job audit 'rejection' values                                              
REJECTER NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*19REJ**'                                                      
                                                                                
         LR    R4,R1                                                            
         XC    X#JOBREJ,X#JOBREJ   rejecter PID                                 
         MVI   X#CONREJ,NOQ        connetced PID rejected Y/N                   
                                                                                
         USING AUDRECD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    AUDKEY,AUDKEY                                                    
         MVI   AUDKTYP,AUDKTYPQ                                                 
         MVI   AUDKSUB,AUDKSUBQ                                                 
         MVC   AUDKCPY,CUXCPY                                                   
         MVI   AUDKAUDT,AUDKACC                                                 
         MVC   AUDKULA,0(R4)                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO1'                               
         JNE   REJECTX                                                          
         J     REJECT04                                                         
                                                                                
REJECT02 GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO1'                               
         CLC   AUDKEY(AUDKSEQ-AUDRECD),IOKEYSAV                                 
         JNE   REJECTX                                                          
                                                                                
REJECT04 GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO1'                              
         JNE   *+2                                                              
                                                                                
         USING STCELD,R3                                                        
         L     R3,AIO1             look for STC elements                        
         AHI   R3,AUDRFST-AUDRECD                                               
                                                                                
REJECT06 CLI   STCEL,0                                                          
         JE    REJECT02                                                         
         CLI   STCEL,STCELQ                                                     
         JNE   REJECT08                                                         
         CLI   STCIND,STCIJOB                                                   
         JNE   REJECT08                                                         
         CLI   STCDTO,C'R'                                                      
         JNE   REJECT10                                                         
         MVC   X#JOBREJ,STCPERS    rejecter                                     
         CLC   STCPERS,CCTPID                                                   
         JNE   REJECT10                                                         
         MVI   X#CONREJ,YESQ                                                    
         J     REJECT10                                                         
                                                                                
REJECT08 CLI   STCIND,STCIACT                                                   
         JNE   REJECT10                                                         
         CLI   STCATYP,STCAAPST                                                 
         JNE   REJECT10                                                         
         CLI   STCASTA,AB29REJQ                                                 
         JNE   REJECT10                                                         
         MVC   X#JOBREJ,STCPERS                                                 
         CLC   STCPERS,CCTPID                                                   
         JNE   REJECT10                                                         
         MVI   X#CONREJ,YESQ                                                    
         J     REJECT10                                                         
                                                                                
REJECT10 LLC   R0,STCLN                                                         
         AR    R3,R0                                                            
         J     REJECT06                                                         
                                                                                
REJECTX  DS    0H                                                               
*        CLC   =CL14'SJAMI03P00353',0(R4)                                       
*        JE    *+2                                                              
         XIT1                                                                   
                                                                                
AB29REJQ EQU   C'2'                ACBRA29.QA_AREJT 'reject'                    
         DROP  R2,R3                                                            
         LTORG                                                                  
                                                                                
* Get job audit values and download                                             
XJAUD    NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*XJAUD**'                                                      
                                                                                
         XC    BYTE1,BYTE1                                                      
         OC    RQ_JAACT,SPACES                                                  
         CLC   RQ_JAACT,SPACES                                                  
         BH    XJAUD02                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$MSJOB)                                           
         B     XJAUDN                                                           
         USING ACTRECD,R2                                                       
XJAUD02  LA    R2,IOKEY            Check account is present                     
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(2),PRODUL                                                
         MVC   ACTKACT,RQ_JAACT                                                 
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         BE    XJAUD04                                                          
         MVC   ROUERRV,=AL2(AE$INJOB)  Error if not                             
         B     XJAUDN                                                           
         USING AUDRECD,R2                                                       
XJAUD04  LA    R2,IOKEY                                                         
         XC    AUDKEY,AUDKEY                                                    
         MVI   AUDKTYP,AUDKTYPQ                                                 
         MVI   AUDKSUB,AUDKSUBQ                                                 
         MVC   AUDKCPY,CUXCPY                                                   
         MVI   AUDKAUDT,AUDKACC                                                 
         MVC   AUDKULA(2),PRODUL                                                
         MVC   AUDKACTC,RQ_JAACT                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         BNE   XJAUD14                                                          
         B     XJAUD05                                                          
XJAUD04A LA    R2,IOKEY                                                         
         MVC   IOKEY,CSVKEY1                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         CLC   AUDKEY(AUDKSEQ-AUDRECD),IOKEYSAV                                 
         BE    XJAUD05                                                          
         CLI   BYTE1,1             Is all audit info here                       
         BE    XJAUDY              Yes                                          
         B     XJAUD14             No - look on account record                  
                                                                                
XJAUD05  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R2,AIO2             look for all STC elements                    
         MVC   CSVKEY1,AUDKEY                                                   
         USING STCELD,R3                                                        
         LA    R3,AUDRFST                                                       
                                                                                
XJAUD06  CLI   STCEL,0                                                          
         BE    XJAUD04A                                                         
         CLI   STCEL,STCELQ                                                     
         BE    XJAUD07B                                                         
XJAUD07A LLC   RF,STCLN                                                         
         AR    R3,RF                                                            
         J     XJAUD06                                                          
                                                                                
XJAUD07B CLI   STCIND,STCIACT      Check accounting STCELs                      
         JNE   XJAUD07A                                                         
         CLI   STCATYP,STCACADD                                                 
         JNE   *+8                                                              
         MVI   BYTE1,1             Account add means all on new audit           
         LA    R0,JA_VALS          Clear output area                            
         LHI   R1,JA_LNQ                                                        
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         MVC   JA_TYP,STCATYP                                                   
         CLI   JA_TYP,STCACLIT   Temporary code to convert                      
         JE    *+12              client and product teams to job level          
         CLI   JA_TYP,STCAPROT                                                  
         JNE   *+8                                                              
         MVI   JA_TYP,STCAJOBT                                                  
         MVC   JA_ACT,STCASTAT                                                  
         MVC   JA_APPL,STCASTAT                                                 
         NI    JA_ACT,X'0F'                                                     
         NI    JA_APPL,X'F0'                                                    
                                                                                
         MVC   TEMP2(2),STCPERS                                                 
         GOTOR (#GETPID,AGETPID)                                                
         BNE   XJAUD08                                                          
         MVC   JA_PID,TEMP2                                                     
         GOTOR (#GETPIN,AGETPIN)                                                
         BNE   XJAUD08                                                          
         MVC   JA_PER,TEMP2                                                     
         MVC   JA_PEL,TEMP2+16                                                  
         MVC   JA_PEM,TEMP2+32                                                  
                                                                                
XJAUD08  MVC   JA_DTE,STCDATE                                                   
         UNPK  DUB2,STCTIME                                                     
         OI    DUB2+7,C'0'                                                      
         MVC   JA_TIM,DUB2+2                                                    
         MVC   TEMP2(2),STCUSER                                                 
         GOTOR (#GETUSR,AGETUSR)                                                
         BE    XJAUD10                                                          
         MVI   JA_USR,C'<'         pass <user> if no name found                 
         MVI   JA_USR+5,C'>'                                                    
         XOUT  STCPERS,JA_USR+1,2                                               
         B     XJAUD12                                                          
*                                                                               
XJAUD10  MVC   JA_USR,TEMP2                                                     
*                                                                               
XJAUD12  LA    R1,STCTAB                                                        
         USING STCTABD,R1                                                       
XJAUD12A CLI   STCTBTYP,X'FF'                                                   
         JE    XJAUD07A                                                         
*        JNE   *+6                                                              
*        DC    H'0'                                                             
         CLC   STCTBTYP,STCATYP                                                 
         JE    XJAUD12B                                                         
         LA    R1,STCTABL(R1)                                                   
         J     XJAUD12A                                                         
*                                                                               
XJAUD12B OC    STCTBRT,STCTBRT     Any routine                                  
         JZ    XJAUD13             No - skip                                    
         LLH   RF,STCTBRT                                                       
         AR    RF,RB                                                            
         BASR  RE,RF                                                            
         TM    STCTIND,STCTOUTP                                                 
         BNZ   XJAUD07A                                                         
*                                                                               
XJAUD13  GOTOR LP_APUTO,LP_D       send data for this status change             
         B     XJAUD07A                                                         
*                                                                               
         USING ACTRECD,R2                                                       
XJAUD14  LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(2),PRODUL                                                
         MVC   ACTKACT,RQ_JAACT                                                 
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         BE    XJAUD16                                                          
         DC    H'0'                                                             
XJAUD16  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         BE    *+6                                                              
         DC    H'0'                                                             
                                                                                
         USING RACELD,R3                                                        
         L     R2,AIO2             look for all STC elements                    
         LA    R3,ACTRFST                                                       
         MVI   BYTE1,NOQ                                                        
         TM    ACTRSTAT,ACTSDRFT                                                
         BZ    *+8                                                              
         MVI   BYTE1,YESQ                                                       
         XR    R0,R0               but determine history first                  
                                                                                
XJAUD18  CLI   RACEL,0                                                          
         BE    XJAUD25                                                          
         CLI   RACEL,RACELQ                                                     
         BNE   XJAUD20                                                          
         CLI   RACTYPE,RACTAPP      wrong, base it on other things              
         BNE   XJAUD20                                                          
         MVI   BYTE1,YESQ                                                       
         B     XJAUD25                                                          
                                                                                
XJAUD20  IC    R0,RACLN                                                         
         AR    R3,R0                                                            
         B     XJAUD18                                                          
                                                                                
         USING STCELD,R3                                                        
XJAUD25  LA    R3,ACTRFST                                                       
                                                                                
XJAUD30  CLI   STCEL,0                                                          
         BE    XJAUDY                                                           
         CLI   STCEL,STCELQ                                                     
         BNE   XJAUD60                                                          
                                                                                
         LA    R0,JA_VALS          Clear output area                            
         LHI   R1,JA_LNQ                                                        
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
                                                                                
         MVC   TEMP2(2),STCPERS                                                 
         GOTOR (#GETPID,AGETPID)                                                
         BNE   XJAUD35                                                          
         MVC   JA_PID,TEMP2                                                     
         GOTOR (#GETPIN,AGETPIN)                                                
         BNE   XJAUD35                                                          
         MVC   JA_PER,TEMP2                                                     
         MVC   JA_PEL,TEMP2+16                                                  
         MVC   JA_PEM,TEMP2+32                                                  
                                                                                
XJAUD35  MVC   JA_DTE,STCDATE                                                   
         UNPK  DUB2,STCTIME                                                     
         OI    DUB2+7,C'0'                                                      
         MVC   JA_TIM,DUB2+2                                                    
         MVC   TEMP2(2),STCUSER                                                 
         GOTOR (#GETUSR,AGETUSR)                                                
         BE    XJAUD40                                                          
         MVI   JA_USR,C'<'         pass <user> if no name found                 
         MVI   JA_USR+5,C'>'                                                    
         XOUT  STCPERS,JA_USR+1,2                                               
         B     XJAUD45                                                          
                                                                                
XJAUD40  MVC   JA_USR,TEMP2                                                     
                                                                                
XJAUD45  MVC   JA_FRS,STCDFR                                                    
         MVC   JA_TOS,STCDTO                                                    
         LLC   RE,STCLN                                                         
         SHI   RE,STCLN1Q                                                       
         LTR   RE,RE                                                            
         BNP   XJAUD50                                                          
         SHI   RE,1                                                             
         MVC   JA_COM(0),STCCOMM                                                
         EX    RE,*-6                                                           
                                                                                
XJAUD50  GOTOR LP_APUTO,LP_D       send data for this status change             
         B     XJAUD90                                                          
                                                                                
         USING RACELD,R3                                                        
XJAUD60  CLI   RACEL,RACELQ                                                     
         BNE   XJAUD90                                                          
         CLI   RACTYPE,RACTADD                                                  
         BE    XJAUD65                                                          
         CLI   RACTYPE,RACTCHA                                                  
         BNE   XJAUD90                                                          
                                                                                
XJAUD65  LA    R0,JA_VALS          Clear output area                            
         LHI   R1,JA_LNQ                                                        
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         MVC   TEMP2(2),RACPERS                                                 
         GOTOR (#GETPID,AGETPID)                                                
         BNE   XJAUD70                                                          
         MVC   JA_PID,TEMP2                                                     
         GOTOR (#GETPIN,AGETPIN)                                                
         BNE   XJAUD70                                                          
         MVC   JA_PER,TEMP2                                                     
         MVC   JA_PEL,TEMP2+16                                                  
         MVC   JA_PEM,TEMP2+32                                                  
                                                                                
XJAUD70  MVC   JA_DTE,RACDATE                                                   
         UNPK  DUB2,RACTIME                                                     
         OI    DUB2+7,C'0'                                                      
         MVC   JA_TIM,DUB2+2                                                    
         MVC   TEMP2(2),RACUSER                                                 
         GOTOR (#GETUSR,AGETUSR)                                                
         BE    XJAUD75                                                          
         MVI   JA_USR,C'<'         pass <user> if no name found                 
         MVI   JA_USR+5,C'>'                                                    
         XOUT  RACUSER,JA_USR+1,2                                               
         B     XJAUD80                                                          
                                                                                
XJAUD75  MVC   JA_USR,TEMP2                                                     
                                                                                
XJAUD80  MVI   JA_FRS,C'X'                                                      
         MVI   JA_TOS,C'X'                                                      
         MVI   JA_APPL,STCAAURA                                                 
         CLI   RACAPPL,RACAURAQ    Completed in Aura                            
         JE    XJAUD82                                                          
         MVI   JA_APPL,STCABRON                                                 
         CLI   RACAPPL,RACBRONQ    Completed in BrandOcean                      
         JE    XJAUD82                                                          
         MVI   JA_APPL,STCADSSP    Set to DS Spectra                            
XJAUD82  CLI   RACTYPE,RACTCHA     change?                                      
         BE    XJAUD85                                                          
         MVI   JA_ACT,STCACADD                                                  
         NI    JA_ACT,X'0F'                                                     
         MVI   JA_FRS,C' '                                                      
         MVI   JA_TOS,C'A'         added as approved                            
         CLI   BYTE1,YESQ                                                       
         BNE   XJAUD85                                                          
         MVI   JA_TOS,C'D'         added as draft                               
                                                                                
XJAUD85  GOTOR LP_APUTO,LP_D       send data for this status change             
                                                                                
XJAUD90  LLC   R0,RACLN                                                         
         AR    R3,R0                                                            
         J     XJAUD30                                                          
                                                                                
XJAUDY   CR    RB,RB                                                            
         J     XJAUDX                                                           
                                                                                
XJAUDN   LTR   RB,RB                                                            
         J     XJAUDX                                                           
                                                                                
XJAUDX   XIT1                                                                   
                                                                                
XJAACT   ST    RE,SAVERE                                                        
         USING STCELD,R3                                                        
         CLI   STCLN,STCLN7Q                                                    
         JNH   XJAACT4                                                          
         MVC   JA_DATA(L'STCAACT),STCAACT                                       
         CLI   STCATYP,STCACADD                                                 
         JE    XJAACT4                                                          
         MVC   TEMP2(L'STCAULA),STCAULA                                         
         GOTOR (#GETACN,AGETACN)                                                
         MVC   JA_DATA+L'STCAACT+1(L'NAMEREC),TEMP2                             
XJAACT4  L     RE,SAVERE                                                        
         BR    RE                                                               
*                                                                               
XJASTAT  ST    RE,SAVERE                                                        
         USING STCELD,R3                                                        
         MVC   JA_STA(L'STCASTA),STCASTA                                        
         CLI   STCLN,STCLN8Q                                                    
         JNH   XJASTAT2                                                         
         LLC   RF,STCADATL                                                      
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   JA_COM(0),STCADATA                                               
         EX    RF,0(RE)                                                         
XJASTAT2 L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
XJASTA2  ST    RE,SAVERE                                                        
         USING STCELD,R3                                                        
         MVC   JA_DATA(L'STCASTA),STCASTA                                       
         L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
XJADFWC  ST    RE,SAVERE                                                        
         USING STCELD,R3                                                        
         MVC   JA_DATA(L'STCADWC),STCADWC                                       
         L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
XJAOFF   ST    RE,SAVERE                                                        
         USING STCELD,R3                                                        
         MVC   JA_DATA(L'STCAOFF),STCAOFF                                       
         L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
XJASECY  ST    RE,SAVERE                                                        
         USING STCELD,R3                                                        
         MVC   JA_DATA(L'STCASECY),STCASECY                                     
         L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
XJAMED   ST    RE,SAVERE                                                        
         USING STCELD,R3                                                        
         MVC   JA_DATA(L'STCAMED),STCAMED                                       
         L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
XJAPRO   ST    RE,SAVERE                                                        
         USING STCELD,R3                                                        
         MVC   JA_DATA(L'STCAPRO),STCAPRO                                       
         L     RE,SAVERE                                                        
         BR    RE                                                               
*&&US                                                                           
XJASTUC  ST    RE,SAVERE                                                        
         USING STCELD,R3                                                        
         MVC   JA_DATA(L'STCASTUC),STCASTUC                                     
         L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
XJASTUL  ST    RE,SAVERE                                                        
         USING STCELD,R3                                                        
         MVC   JA_DATA(L'STCASTUL),STCASTUL                                     
         L     RE,SAVERE                                                        
         BR    RE                                                               
*&&                                                                             
                                                                                
XJADATE  NTR1  ,                                                                
         USING STCELD,R3                                                        
         GOTOR VDATCON,DMCB,(1,STCADTE),(21,JA_DATA)                            
         L     RE,SAVERE                                                        
         XIT1  ,                                                                
                                                                                
XJADAMT  ST    RE,SAVERE                                                        
         USING STCELD,R3                                                        
         CURED (P6,STCAAMNT),(10,JA_DATA),2,ZERO=YES,ALIGN=LEFT                 
         L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
XJADATA  NTR1  ,                                                                
         USING STCELD,R3                                                        
         CLI   STCATYP,STCADESC                                                 
         JNE   XJADATA8                                                         
         MVC   X#TIME,STCTIME                                                   
         MVC   X#DATE,STCDATE                                                   
         L     R2,AIO1                                                          
         GOTOR (#CLRIO,ACLRIO),DMCB,AIO1                                        
         XC    BYTE2,BYTE2                                                      
XJADATA2 CLI   STCEL,STCELQ                                                     
         JNE   XJADATA4                                                         
         CLI   STCATYP,STCADESC                                                 
         JNE   XJADATA4                                                         
         CLC   STCTIME,X#TIME                                                   
         JNE   XJADATA4                                                         
         CLC   STCDATE,X#DATE                                                   
         JNE   XJADATA4                                                         
         LLC   RF,STCADATL                                                      
         BASR  RE,0                                                             
         MVC   0(0,R2),STCADATL                                                 
         EX    RF,0(RE)                                                         
         AHI   RF,1                                                             
         AR    R2,RF                                                            
         MVI   STCEL,X'FF'                                                      
         LLC   RF,STCLN                                                         
         AR    R3,RF                                                            
         J     XJADATA2                                                         
                                                                                
XJADATA4 XC    JA_DATA,JA_DATA                                                  
         L     R2,AIO1                                                          
XJADATA6 XR    RF,RF                                                            
         ICM   RF,1,0(R2)                                                       
         JZ    XJADATAX                                                         
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   JA_DATA(0),1(R2)                                                 
         EX    RF,0(RE)                                                         
         AHI   RF,2                                                             
         AR    R2,RF                                                            
         GOTOR LP_APUTO,LP_D       send data for this status change             
         LA    R0,JA_VALS          Clear output area                            
         LHI   R1,JA_LNQ                                                        
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         XR    RF,RF                                                            
         J     XJADATA6                                                         
                                                                                
XJADATA8 XC    JA_DATA,JA_DATA                                                  
         CLI   STCLN,STCLN7Q                                                    
         JNH   XJADATA9                                                         
         LLC   RF,STCADATL                                                      
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   JA_DATA(0),STCADATA                                              
         EX    RF,0(RE)                                                         
XJADATA9 GOTOR LP_APUTO,LP_D                                                    
XJADATAX XIT1  ,                                                                
                                                                                
XJACLPO  NTR1  ,                                                                
         USING STCELD,R3                                                        
         LLC   R4,STCANUM                                                       
         LA    R2,STCACPO                                                       
         LA    R6,JA_DATA                                                       
         MVI   BYTE2,200                                                        
         XC    BYTE3,BYTE3                                                      
ORD      USING STCACPO,R2                                                       
XJACPO2  MVI   0(R6),C'('                                                       
         MVC   1(L'STCACPO,R6),ORD.STCACPO                                      
         LHI   RF,1+L'STCACPO                                                   
XJACPO4  CLI   L'STCACPO(R6),C' '                                               
         JH    XJACPO6                                                          
         SHI   R6,1                                                             
         JCT   RF,XJACPO4                                                       
                                                                                
XJACPO6  OC    ORD.STCACPOA,ORD.STCACPOA  Do we have a order amount             
         JZ    XJACPO7              No                                          
         MVI   L'STCACPO+1(R6),C':'                                             
         AHI   RF,1                                                             
         STC   RF,BYTE3                                                         
         CURED (P6,ORD.STCACPOA),(12,L'STCACPO+2(R6)),2,ZERO=YES,      +        
               ALIGN=LEFT                                                       
         LLC   RF,BYTE3                                                         
XJACPO7  LA    R2,L'STCACPO+L'STCACPOA(R2)                                      
         AHI   RF,12                                                            
XJACPO8  CLI   L'STCACPO+13(R6),C' '                                            
         JH    XJACPO10                                                         
         SHI   R6,1                                                             
         JCT   RF,XJACPO8                                                       
                                                                                
XJACPO10 MVI   L'STCACPO+14(R6),C')'                                            
         LA    R6,L'STCACPO+15(R6)                                              
         LLC   RE,BYTE2                                                         
         SR    RE,RF                                                            
         STC   RE,BYTE2                                                         
         CHI   RE,34                                                            
         JH    XJACPO14                                                         
         GOTOR LP_APUTO,LP_D       send data for this status change             
         MVI   BYTE2,200                                                        
         LA    R6,JA_DATA                                                       
         LA    R0,JA_VALS          Clear output area                            
         LHI   R1,JA_LNQ                                                        
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         XR    RF,RF                                                            
XJACPO14 JCT   R4,XJACPO2                                                       
         XIT1  ,                                                                
         DROP  ORD                                                              
                                                                                
XJACLIT  NTR1  ,                                                                
         USING STCELD,R3                                                        
         LLC   R4,STCANUM                                                       
         LA    R2,STCAROL                                                       
         LA    R6,JA_DATA                                                       
         MVI   BYTE2,200                                                        
         MVC   TEMP2,SPACES                                                     
         XC    BYTE3,BYTE3                                                      
TEA      USING STCAROL,R2                                                       
XJACLT2  MVI   0(R6),C'('                                                       
         GOTOR (#GETROL,AGETROL),DMCB,TEA.STCAROL,RQ_JAOFF                      
         MVC   1(L'NAMEREC,R6),TEMP2                                            
         LHI   RF,1+L'NAMEREC                                                   
XJACLT4  CLI   1+L'NAMEREC(R6),C' '                                             
         JH    XJACLT6                                                          
         SHI   R6,1                                                             
         JCT   RF,XJACLT4                                                       
                                                                                
XJACLT6  LA    R6,L'NAMEREC+2(R6)                                               
         MVI   0(R6),C':'                                                       
         AHI   R6,1                                                             
         AHI   RF,1                                                             
         STC   RF,BYTE3                                                         
         MVC   TEMP2(2),TEA.STCARPID                                            
         GOTOR (#GETPID,AGETPID)                                                
         JNE   XJACLT20                                                         
         GOTOR (#GETPIN,AGETPIN)                                                
         JNE   XJACLT20                                                         
         LA    R2,L'STCAROL+L'STCARPID(R2)                                      
         LLC   RF,BYTE3                                                         
         MVC   0(16,R6),TEMP2                                                   
         AHI   RF,16                                                            
XJACLT8  CLI   15(R6),C' '                                                      
         JH    XJACLT10                                                         
         SHI   R6,1                                                             
         JCT   RF,XJACLT8                                                       
                                                                                
XJACLT10 LA    R6,17(R6)                                                        
         MVC   0(16,R6),TEMP2+32                                                
         AHI   RF,16                                                            
XJACLT12 CLI   15(R6),C' '                                                      
         JH    XJACLT14                                                         
         SHI   R6,1                                                             
         JCT   RF,XJACLT12                                                      
                                                                                
XJACLT14 LA    R6,17(R6)                                                        
         MVC   0(16,R6),TEMP2+16                                                
         AHI   RF,16                                                            
XJACLT16 CLI   15(R6),C' '                                                      
         JH    XJACLT18                                                         
         SHI   R6,1                                                             
         JCT   RF,XJACLT16                                                      
                                                                                
XJACLT18 LA    R6,16(R6)                                                        
XJACLT20 MVI   0(R6),C')'                                                       
         LA    R6,1(R6)                                                         
         LLC   RE,BYTE2                                                         
         SR    RE,RF                                                            
         STC   RE,BYTE2                                                         
         CHI   RE,88                                                            
         JH    XJACLT22                                                         
         GOTOR LP_APUTO,LP_D       send data for this status change             
         MVI   BYTE2,200                                                        
         LA    R6,JA_DATA                                                       
         LA    R0,JA_VALS          Clear output area                            
         LHI   R1,JA_LNQ                                                        
         XR    RE,RE                                                            
         XR    RF,RF                                                            
         MVCL  R0,RE                                                            
         XR    RF,RF                                                            
XJACLT22 JCT   R4,XJACLT2                                                       
         XIT1  ,                                                                
         DROP  TEA                                                              
                                                                                
XJAPRTB  ST    RE,SAVERE                                                        
         USING STCELD,R3                                                        
         MVC   JA_DATA(L'STCAPRB),STCAPRB                                       
         L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
XJALKJB  ST    RE,SAVERE                                                        
         USING STCELD,R3                                                        
         LLC   RF,STCANUM                                                       
         MHI   RF,L'ACTKACT                                                     
         SHI   RF,1                                                             
         BASR  RE,0                                                             
         MVC   JA_DATA(0),STCAJOB                                               
         EX    RF,0(RE)                                                         
         L     RE,SAVERE                                                        
         BR    RE                                                               
                                                                                
STCTAB   DS    0F                                                               
         DC    AL1(STCACADD,0)                                                  
         DC    AL2(XJAACT-XJAUD)                                                
         DC    AL1(STCACDEL,0)                                                  
         DC    AL2(0)                                                           
         DC    AL1(STCAAPST,0)                                                  
         DC    AL2(XJASTAT-XJAUD)                                               
         DC    AL1(STCALOCK,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAJOBT,0)                                                  
         DC    AL2(XJACLIT-XJAUD)                                               
         DC    AL1(STCACLPO,0)                                                  
         DC    AL2(XJACLPO-XJAUD)                                               
         DC    AL1(STCALKJB,0)                                                  
         DC    AL2(XJALKJB-XJAUD)                                               
         DC    AL1(STCAMSTR,0)                                                  
         DC    AL2(XJAACT-XJAUD)                                                
         DC    AL1(STCACSTG,0)                                                  
         DC    AL2(XJAACT-XJAUD)                                                
         DC    AL1(STCARECV,0)                                                  
         DC    AL2(XJAACT-XJAUD)                                                
         DC    AL1(STCADESC,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCACOMT,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAUFS,STCTOUTP)                                            
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAPTEL,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAPFAX,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAPCON,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAPEML,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAOMEM,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAICRL,0)                                                  
         DC    AL2(XJADAMT-XJAUD)                                               
         DC    AL1(STCACRLM,0)                                                  
         DC    AL2(XJADAMT-XJAUD)                                               
         DC    AL1(STCAJFEE,0)                                                  
         DC    AL2(XJADAMT-XJAUD)                                               
         DC    AL1(STCAMSHN,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAALNM,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAFRNM,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCANAME,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCALNNM,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAADR,STCTOUTP)                                            
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAFLT1,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCADEPT,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAMILE,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCASTAF,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCACLIA,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAPERX,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCABAL,0)                                                   
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAPNL,0)                                                   
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAJOBA,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAPROV,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAMRGI,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAPAYL,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAPCRS,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAPDRS,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCASEC,0)                                                   
         DC    AL2(XJASECY-XJAUD)                                               
         DC    AL1(STCACLIC,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAJLES,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAJLOR,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAJLBL,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAJLTM,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAJLAD,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAJLEX,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAEXCL,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCADSKP,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAINVT,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCASUND,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAINVR,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAFPRO,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAFJOB,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCADFWC,0)                                                  
         DC    AL2(XJADFWC-XJAUD)                                               
         DC    AL1(STCAGLOF,0)                                                  
         DC    AL2(XJAOFF-XJAUD)                                                
         DC    AL1(STCAGLAC,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCABOES,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAMAST,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCATHRP,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAVATN,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCANIC,STCTOUTP)                                            
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAFUSR,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCACURR,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCALOCL,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAKSV,STCTOUTP)                                            
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCA13VT,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAVATC,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCATAX,STCTOUTP)                                            
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAREFN,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAAUTH,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAENTY,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCABSRL,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCACRCD,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCADSRT,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAVTRT,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCADUED,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAEXCM,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAOTHR,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAOFFC,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCABLGP,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAPRTB,0)                                                  
         DC    AL2(XJAPRTB-XJAUD)                                               
         DC    AL1(STCABCHG,0)                                                  
         DC    AL2(XJAACT-XJAUD)                                                
         DC    AL1(STCAEXDF,0)                                                  
         DC    AL2(XJAACT-XJAUD)                                                
         DC    AL1(STCAANA,0)                                                   
         DC    AL2(XJAACT-XJAUD)                                                
         DC    AL1(STCADISC,0)                                                  
         DC    AL2(XJAACT-XJAUD)                                                
         DC    AL1(STCAFACC,0)                                                  
         DC    AL2(XJAACT-XJAUD)                                                
         DC    AL1(STCA2PAC,0)                                                  
         DC    AL2(XJAACT-XJAUD)                                                
         DC    AL1(STCA2DAC,0)                                                  
         DC    AL2(XJAACT-XJAUD)                                                
         DC    AL1(STCAPID,STCTOUTP)                                            
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAEXAC,0)                                                  
         DC    AL2(XJAACT-XJAUD)                                                
         DC    AL1(STCABSRT,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCABACT,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCABANM,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCABNAM,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAPMTH,STCTOUTP)                                           
         DC    AL2(XJADATA-XJAUD)                                               
         DC    AL1(STCAOPDT,0)                                                  
         DC    AL2(XJADATE-XJAUD)                                               
         DC    AL1(STCACLDT,0)                                                  
         DC    AL2(XJADATE-XJAUD)                                               
         DC    AL1(STCACLOS,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAPRJC,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCACLIN,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCACLIH,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAFLT2,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAFLT3,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAFLT4,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAFLT5,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAOINC,0)                                                  
         DC    AL2(XJAACT-XJAUD)                                                
         DC    AL1(STCAOWRT,0)                                                  
         DC    AL2(XJAACT-XJAUD)                                                
         DC    AL1(STCACLIT,0)                                                  
         DC    AL2(XJACLIT-XJAUD)                                               
         DC    AL1(STCAPROT,0)                                                  
         DC    AL2(XJACLIT-XJAUD)                                               
         DC    AL1(STCAXJOB,0)                                                  
         DC    AL2(XJASTA2-XJAUD)                                               
         DC    AL1(STCAMEDC,0)                                                  
         DC    AL2(XJAMED-XJAUD)                                                
         DC    AL1(STCAPROC,0)                                                  
         DC    AL2(XJAPRO-XJAUD)                                                
         DC    AL1(STCAJOBC,0)                                                  
         DC    AL2(XJAPRO-XJAUD)                                                
*&&US*&& DC    AL1(STCASTUT,0)                                                  
*&&US*&& DC    AL2(XJASTUC-XJAUD)                                               
*&&US*&& DC    AL1(STCASTUK,0)                                                  
*&&US*&& DC    AL2(XJASTUL-XJAUD)                                               
STCTABX  DC    X'FF'                                                            
         LTORG                                                                  
         DROP  R2,R3                                                            
                                                                                
* download =Production user fields                                              
XUFDL    NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*XUFDL**'                                                      
                                                                                
         OC    RQ_UFCLI,SPACES                                                  
         OC    RQ_UFPRO,SPACES                                                  
         OC    RQ_UFJOB,SPACES                                                  
         OC    RQ_UFOFF,SPACES                                                  
         MVC   X#POFF,SPACES                                                    
*                                  List or display request?                     
         CLC   RQ_UFCLI(RQ_UFOFF-RQ_UFOFF),SPACES                               
         BNH   XUFDL35                                                          
         CLC   RQ_UFOFF,SPACES     if office missng get from cli/pro            
         BH    XUFDL16                                                          
         CLI   OFFIND,NONEQ        skip for non office agencies                 
         BE    XUFDL16                                                          
                                                                                
         USING ACTRECD,R2                                                       
         LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(2),PRODUL                                                
         MVC   ACTKACT(5),RQ_UFCLI                                              
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         BE    XUFDL02                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$INCLI)                                           
         B     XUFDLN                                                           
                                                                                
XUFDL02  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         BE    *+6                                                              
         DC    H'0'                Bad master record                            
                                                                                
         L     R2,AIO2                                                          
         LA    R2,ACTRFST                                                       
         USING PPRELD,R2                                                        
         XR    R0,R0                                                            
                                                                                
XUFDL04  CLI   PPREL,0                                                          
         BE    XUFDL08                                                          
         CLI   PPREL,PPRELQ                                                     
         BE    XUFDL06                                                          
         IC    R0,PPRLN                                                         
         AR    R2,R0                                                            
         B     XUFDL04                                                          
                                                                                
XUFDL06  MVC   X#POFF,PPRGAOFF                                                  
         OC    X#POFF,X#POFF                                                    
                                                                                
         USING ACTRECD,R2                                                       
XUFDL08  LA    R2,IOKEY                                                         
         MVC   ACTKEY,SPACES                                                    
         MVC   ACTKCPY,CUXCPY                                                   
         MVC   ACTKULA(2),PRODUL                                                
         MVC   ACTKACT(5),RQ_UFCLI                                              
         LLC   RE,PCLILEN                                                       
         LA    RE,ACTKACT(RE)                                                   
*&&UK*&& MVC   0(2,RE),RQ_UFPRO                                                 
*&&US*&& MVC   0(L'RQ_UFPRO,RE),RQ_UFPRO                                        
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         BE    XUFDL10                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$INPRO)                                           
         B     XUFDLN                                                           
                                                                                
XUFDL10  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         BE    *+6                                                              
         DC    H'0'                Bad master record                            
                                                                                
         L     R2,AIO2                                                          
         LA    R2,ACTRFST                                                       
         USING PPRELD,R2                                                        
         XR    R0,R0                                                            
                                                                                
XUFDL12  CLI   PPREL,0                                                          
         BE    XUFDL16                                                          
         CLI   PPREL,PPRELQ                                                     
         BE    XUFDL14                                                          
         IC    R0,PPRLN                                                         
         AR    R2,R0                                                            
         B     XUFDL12                                                          
                                                                                
XUFDL14  CLC   PPRGAOFF,SPACES                                                  
         BNH   XUFDL16                                                          
         MVC   X#POFF,PPRGAOFF                                                  
         OC    X#POFF,X#POFF                                                    
                                                                                
XUFDL16  CLC   RQ_UFOFF,SPACES                                                  
         BH    XUFDL18                                                          
                                                                                
         MVC   RQ_UFOFF,X#POFF     set from retrieved office                    
                                                                                
XUFDL18  GOTOR VDATCON,DMCB,(0,RQ_UFODT+2),(1,X#CLOX)                           
                                                                                
         MVC   X#MEDC,RQ_UFJOB     get media code/group and off group           
                                                                                
         USING PMDRECD,R2                                                       
         LA    R2,IOKEY                                                         
         MVC   PMDKEY,SPACES                                                    
         MVI   PMDKTYP,PMDKTYPQ                                                 
         MVC   PMDKCPY,CUXCPY                                                   
         MVC   PMDKMED,X#MEDC                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         BE    XUFDL20                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$MCINV)                                           
         B     XUFDLN                                                           
                                                                                
XUFDL20  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         BE    *+6                                                              
         DC    H'0'                Bad master record                            
                                                                                
         L     R2,AIO2                                                          
         LA    R3,PMDRFST                                                       
         USING PMDELD,R3                                                        
         XR    R0,R0                                                            
                                                                                
XUFDL22  CLI   PMDEL,PMDELQ                                                     
         BE    XUFDL24                                                          
         CLI   PMDEL,0                                                          
         BNE   *+6                                                              
         DC    H'0'                                                             
                                                                                
         IC    R0,PMDLN                                                         
         AR    R3,R0                                                            
         B     XUFDL22                                                          
                                                                                
XUFDL24  MVC   X#MEDG,PMDGRP                                                    
                                                                                
         CLI   OFFIND,NONEQ        skip for non office agencies                 
         BE    XUFDL35                                                          
                                                                                
         USING OGRRECD,R2                                                       
         LA    R2,IOKEY                                                         
         XC    OGRKEY,OGRKEY                                                    
         MVI   OGRKTYP,OGRKTYPQ                                                 
         MVI   OGRKSUB,OGRKOFFQ                                                 
         MVC   OGRKCPY,CUXCPY                                                   
         MVC   OGRKUNT(2),PRODUL                                                
         MVC   OGRKOFC,RQ_UFOFF                                                 
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2'                               
         BE    XUFDL26                                                          
                                                                                
         MVC   ROUERRV,=AL2(AE$IVOFF)                                           
         B     XUFDLN                                                           
                                                                                
XUFDL26  GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         BE    *+6                                                              
         DC    H'0'                Bad master record                            
                                                                                
         L     R2,AIO2                                                          
         LA    R3,OGRRFST                                                       
         USING PGRELD,R3                                                        
         XR    R0,R0                                                            
                                                                                
XUFDL28  CLI   PGREL,PGRELQ                                                     
         BE    XUFDL30                                                          
         CLI   PGREL,0                                                          
         BE    XUFDL35                                                          
                                                                                
         IC    R0,PGRLN                                                         
         AR    R3,R0                                                            
         B     XUFDL28                                                          
                                                                                
XUFDL30  MVC   X#OFFG,PGRCODE                                                   
                                                                                
XUFDL35  L     R4,AGENAREA         clear table                                  
         LR    RE,R4                                                            
         LHI   RF,L'GENAREA                                                     
         XR    R1,R1                                                            
         XR    R0,R0                                                            
         MVCL  RE,R0                                                            
                                                                                
         ZAP   X#ELCNT,PZERO       read for various levels                      
*                                                                               
XUFDL36  CLC   RQ_UFCLI(RQ_UFOFF-RQ_UFOFF),SPACES                               
         JH    XUFDL38             Any c/p/j passed?                            
         CLC   RQ_UFCLI(RQ_UFOFF-RQ_UFOFF),SPACES                               
         JH    *+2                 Invalid request all passed or none           
         OC    RQ_UFODT,RQ_UFODT                                                
         JZ    XUFDL37                                                          
         GOTOR VDATCON,DMCB,(0,RQ_UFODT+2),(1,X#CLOX)                           
XUFDL37  GOTOR XUALL                                                            
         LHI   R3,MAXLUF                                                        
         J     XUFDL128                                                         
*                                                                               
XUFDL38  LA    R2,X#URKEY          Company level                                
         XC    X#URKEY,X#URKEY                                                  
         BAS   RE,XUREAD                                                        
         CLC   SAVEKEY1(UFSKOFG-UFSKEY),IOKEY                                   
         BNE   XUFDLY              exit if no records at all                    
         CLC   SAVEKEY1(L'UFSKEY),IOKEY                                         
         BNE   XUFDL40                                                          
         BAS   RE,XUTBL                                                         
                                                                                
XUFDL40  CLI   X#MEDG,C' '         Company/Media group level                    
         BNH   XUFDL45                                                          
         XC    X#URKEY,X#URKEY                                                  
         MVC   X#URKEY+UFSKMGR-UFSRECD(L'UFSKMGR),X#MEDG                        
         BAS   RE,XUREAD                                                        
         BNE   XUFDL45                                                          
         BAS   RE,XUTBL                                                         
                                                                                
XUFDL45  CLI   X#MEDC,C' '         Company/Media level                          
         BNH   XUFDL50                                                          
         XC    X#URKEY,X#URKEY                                                  
         MVC   X#URKEY+UFSKMED-UFSRECD(L'UFSKMED),X#MEDC                        
         BAS   RE,XUREAD                                                        
         BNE   XUFDL50                                                          
         BAS   RE,XUTBL                                                         
                                                                                
XUFDL50  CLI   X#OFFG,C' '         Company/office group level                   
         BNH   XUFDL65                                                          
         XC    X#URKEY,X#URKEY                                                  
         MVC   X#URKEY+UFSKOFG-UFSRECD(L'UFSKOFG),X#OFFG                        
         BAS   RE,XUREAD                                                        
         CLC   SAVEKEY1(UFSKOFC-UFSKEY),IOKEY      skip if no records           
         BNE   XUFDL65                                                          
         CLC   SAVEKEY1(L'UFSKEY),IOKEY                                         
         BNE   XUFDL55                                                          
         BAS   RE,XUTBL                                                         
                                                                                
XUFDL55  CLI   X#MEDG,C' '         Company/off group/media group level          
         BNH   XUFDL60                                                          
         MVC   X#URKEY+UFSKMGR-UFSRECD(L'UFSKMGR),X#MEDG                        
         BAS   RE,XUREAD                                                        
         BNE   XUFDL60                                                          
         BAS   RE,XUTBL                                                         
                                                                                
XUFDL60  CLI   X#MEDC,C' '         Company/off group /media level               
         BNH   XUFDL65                                                          
    XC    X#URKEY+UFSKMGR-UFSRECD(L'UFSKMGR),X#URKEY+UFSKMGR-UFSRECD            
         MVC   X#URKEY+UFSKMED-UFSRECD(L'UFSKMED),X#MEDC                        
         BAS   RE,XUREAD                                                        
         BNE   XUFDL65                                                          
         BAS   RE,XUTBL                                                         
                                                                                
XUFDL65  CLC   RQ_UFOFF,SPACES     Company/Office level                         
         BNH   XUFDL80                                                          
         XC    X#URKEY,X#URKEY                                                  
         MVC   X#URKEY+UFSKOFC-UFSRECD(L'UFSKOFC),RQ_UFOFF                      
         BAS   RE,XUREAD                                                        
         CLC   SAVEKEY1(UFSKCLI-UFSKEY),IOKEY                                   
         BNE   XUFDL80             skip if no office records                    
         CLC   SAVEKEY1(L'UFSKEY),IOKEY                                         
         BNE   XUFDL70                                                          
         BAS   RE,XUTBL                                                         
                                                                                
XUFDL70  CLI   X#MEDG,C' '         Company/Office/Media group level             
         BNH   XUFDL75                                                          
         MVC   X#URKEY+UFSKMGR-UFSRECD(L'UFSKMGR),X#MEDG                        
         BAS   RE,XUREAD                                                        
         BNE   *+8                                                              
         BAS   RE,XUTBL                                                         
    XC    X#URKEY+UFSKMGR-UFSRECD(L'UFSKMGR),X#URKEY+UFSKMGR-UFSRECD            
                                                                                
XUFDL75  CLI   X#MEDC,C' '         Company/Office/Media level                   
         BNH   XUFDL80                                                          
         MVC   X#URKEY+UFSKMED-UFSRECD(L'UFSKMED),X#MEDC                        
         BAS   RE,XUREAD                                                        
         CLC   SAVEKEY1(L'UFSKEY),IOKEY                                         
         BNE   XUFDL80                                                          
         BAS   RE,XUTBL                                                         
                                                                                
XUFDL80  XC    X#URKEY,X#URKEY     Company/Client level                         
         MVC   X#URKEY+UFSKCLI-UFSRECD(L'UFSKCLI),SPACES                        
         MVC   X#URKEY+UFSKCLI-UFSRECD(L'RQ_UFCLI),RQ_UFCLI                     
         BAS   RE,XUREAD                                                        
         CLC   SAVEKEY1(UFSKPRO-UFSKEY),IOKEY                                   
         BNE   XUFDL120            skip if no client records                    
         CLC   SAVEKEY1(L'UFSKEY),IOKEY                                         
         BNE   XUFDL85                                                          
         BAS   RE,XUTBL                                                         
                                                                                
XUFDL85  CLI   X#MEDG,C' '         Company/Client/Media group level             
         BNH   XUFDL90                                                          
         MVC   X#URKEY+UFSKMGR-UFSRECD(L'UFSKMGR),X#MEDG                        
         BAS   RE,XUREAD                                                        
         BNE   *+8                                                              
         BAS   RE,XUTBL                                                         
    XC    X#URKEY+UFSKMGR-UFSRECD(L'UFSKMGR),X#URKEY+UFSKMGR-UFSRECD            
                                                                                
XUFDL90  CLI   X#MEDC,C' '         Company/Client/Media level                   
         BNH   XUFDL95                                                          
         MVC   X#URKEY+UFSKMED-UFSRECD(L'UFSKMED),X#MEDC                        
         BAS   RE,XUREAD                                                        
         BNE   *+8                                                              
         BAS   RE,XUTBL                                                         
      XC    X#URKEY+UFSKMED-UFSRECD(L'UFSKMED),X#URKEY+UFSKMED-UFSRECD          
                                                                                
XUFDL95  DS    0H                  Company/Client/Product level                 
         MVC   X#URKEY+UFSKPRO-UFSRECD(L'UFSKPRO),SPACES                        
         MVC   X#URKEY+UFSKPRO-UFSRECD(L'RQ_UFPRO),RQ_UFPRO                     
         BAS   RE,XUREAD                                                        
         BNE   *+8                                                              
         BAS   RE,XUTBL                                                         
         CLI   X#MEDG,C' '         Company/Client/Prod/Media gr level           
         BNH   XUFDL100                                                         
         MVC   X#URKEY+UFSKMGR-UFSRECD(L'UFSKMGR),X#MEDG                        
         BAS   RE,XUREAD                                                        
         BNE   *+8                                                              
         BAS   RE,XUTBL                                                         
    XC    X#URKEY+UFSKMGR-UFSRECD(L'UFSKMGR),X#URKEY+UFSKMGR-UFSRECD            
                                                                                
XUFDL100 CLI   X#MEDC,C' '         Company/Client/Product/Media level           
         BNH   XUFDL105                                                         
         MVC   X#URKEY+UFSKMED-UFSRECD(L'UFSKMED),X#MEDC                        
         BAS   RE,XUREAD                                                        
         BNE   *+8                                                              
         BAS   RE,XUTBL                                                         
    XC    X#URKEY+UFSKMED-UFSRECD(L'UFSKMED),X#URKEY+UFSKMED-UFSRECD            
                                                                                
XUFDL105 DS    0H                  Company/Client/product/Job level             
         MVC   X#URKEY+UFSKJOB-UFSRECD(L'UFSKJOB),RQ_UFJOB                      
         BAS   RE,XUREAD                                                        
         BNE   *+8                                                              
         BAS   RE,XUTBL                                                         
                                                                                
         USING ELMTABD,R4                                                       
XUFDL120 XC    UF_VALS(UF_LNQ),UF_VALS                                          
         MVC   UF_OFF,RQ_UFOFF     return office code                           
                                                                                
         GOTOR LP_APUTO,LP_D                                                    
                                                                                
         LA    R3,MAXUFS           put out table entries                        
*                                                                               
XUFDL128 L     R4,AGENAREA                                                      
                                                                                
XUFDL130 OC    ELMDATA,ELMDATA                                                  
         BZ    XUFDL135                                                         
                                                                                
         XC    UF_VALS(UF_LNQ),UF_VALS                                          
         MVC   UF_TYP,ELMEDIT                                                   
         MVC   UF_COD,ELMCODE                                                   
         MVC   UF_HDR,ELMDESC                                                   
         EDIT  (B1,ELMMAXL),(2,UF_MAX),ALIGN=LEFT                               
         MVI   UF_COM,YESQ                                                      
         TM    ELMSTAT,UFSSREQD    required?                                    
         BNZ   *+8                                                              
         MVI   UF_COM,NOQ                                                       
                                                                                
         GOTOR LP_APUTO,LP_D                                                    
                                                                                
XUFDL135 AHI   R4,ELMLNG                                                        
         BCT   R3,XUFDL130                                                      
                                                                                
XUFDLY   CR    RB,RB                                                            
         B     *+6                                                              
XUFDLN   LTR   RB,RB                                                            
         XIT1                                                                   
         DROP  R4                                                               
                                                                                
         USING UFSRECD,R2                                                       
XUREAD   NTR1                                                                   
         LA    R2,IOKEY                                                         
         MVC   UFSKEY,X#URKEY                                                   
         MVI   UFSKTYP,UFSKTYPQ                                                 
         MVI   UFSKSUB,UFSKSUBQ                                                 
         MVC   UFSKCPY,CUXCPY                                                   
         MVC   UFSKUNT(2),PRODUL                                                
         MVC   SAVEKEY1,UFSKEY                                                  
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
                                                                                
         CLC   UFSKEY,SAVEKEY1     set cc and exit                              
         XIT1                                                                   
                                                                                
         USING ELMTABD,R3                                                       
         USING UFSELD,R2                                                        
XUTBL    NTR1                                                                   
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         BE    *+6                                                              
         DC    H'0'                Bad master record                            
                                                                                
         L     R2,AIO2                                                          
         AHI   R2,ACTRFST-ACTKEY                                                
                                                                                
XUTBL05  CLI   UFSEL,0                                                          
         BE    XUTBLY                                                           
         CLI   UFSEL,UFSELQ                                                     
         BE    XUTBL15                                                          
                                                                                
XUTBL10  LLC   R0,UFSLN                                                         
         AR    R2,R0                                                            
         B     XUTBL05                                                          
                                                                                
XUTBL15  DS    0H                                                               
*&&US                                                                           
         TM    UFSSTAT,UFSSAUTH    Show on Authorization REC Only?              
         BO    XUTBL10             YES - Skip                                   
*&&                                                                             
         CLC   UFSDESC,SPACES                                                   
         BE    XUTBL10                                                          
                                                                                
         L     R3,AGENAREA                                                      
         LA    R0,MAXUFS                                                        
                                                                                
XUTBL20  OC    ELMDATA,ELMDATA     free spot?                                   
         BZ    XUTBL30             no - go for next                             
         CLC   UFSCODE,ELMCODE     yes- code match?                             
         BNE   XUTBL30             no                                           
         MVC   ELMDESC(ELMSTAT-ELMDESC+1),UFSDESC                               
         OC    UFSCUT,UFSCUT       cut off date?                                
         BZ    XUTBL25             no - replace element                         
         CLC   UFSCUT,X#CLOX       yes - take it?                               
         BH    XUTBL25             yes                                          
                                                                                
         BCTR  R0,0                                                             
         MVC   ELMDATA,ELMLNG(R3)                                               
         LA    R3,ELMLNG(R3)                                                    
         BCT   R0,*-10                                                          
         XC    ELMDATA,ELMDATA     clear last spot                              
         SP    X#ELCNT,=P'1'       descrease count                              
         B     XUTBL10             get next element                             
                                                                                
XUTBL25  MVC   ELMDATA,UFSEL       repalve element                              
         B     XUTBL10             get next one                                 
                                                                                
XUTBL30  AHI   R3,ELMLNG           get next                                     
         BCT   R0,XUTBL20                                                       
                                                                                
         L     R3,AGENAREA         no match - look for free spot                
         LA    R0,MAXUFS                                                        
                                                                                
XUTBL50  OC    ELMDATA,ELMDATA     free spot?                                   
         BNZ   XUTBL60             no - keep looping                            
         OC    UFSCUT,UFSCUT       yes - cutoff date                            
         BZ    XUTBL55             no - add element                             
         CLC   UFSCUT,X#CLOX       yes - take it?                               
         BNH   XUTBL10             no                                           
                                                                                
XUTBL55  MVC   ELMDATA,UFSEL       add element                                  
         AP    X#ELCNT,=P'1'       increment count                              
         B     XUTBL10             get next element                             
                                                                                
XUTBL60  LA    R3,ELMLNG(R3)       GET NEXT                                     
         BCT   R0,XUTBL50                                                       
                                                                                
XUTBLY   CR    RB,RB                                                            
         B     *+6                                                              
XUTBLN   LTR   RB,RB                                                            
         XIT1                                                                   
         DROP  R2                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
* Read all user field entries                                         *         
***********************************************************************         
         SPACE 1                                                                
         USING UFSRECD,R2                                                       
XUALL    NTR1                                                                   
         LA    R2,IOKEY                                                         
         XC    IOKEY,IOKEY                                                      
         MVI   UFSKTYP,UFSKTYPQ                                                 
         MVI   UFSKSUB,UFSKSUBQ                                                 
         MVC   UFSKCPY,CUXCPY                                                   
         MVC   UFSKUNT(2),PRODUL                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO2'                               
         JE    XUALL04                                                          
         DC    H'0'                                                             
                                                                                
XUALL02  LA    R2,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO2'                               
         JE    XUALL04                                                          
         DC    H'0'                                                             
                                                                                
XUALL04  CLI   UFSKTYP,UFSKTYPQ    Still reading user fields?                   
         JNE   XUALLY                                                           
         CLI   UFSKSUB,UFSKSUBQ                                                 
         JNE   XUALLY                                                           
         CLC   UFSKCPY,CUXCPY                                                   
         JNE   XUALLY                                                           
         CLC   UFSKUNT(2),PRODUL                                                
         JNE   XUALLY                                                           
                                                                                
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO2'                              
         JNE   *+2                 Bad master record                            
                                                                                
         L     R2,AIO2                                                          
         AHI   R2,ACTRFST-ACTKEY                                                
                                                                                
         USING UFSELD,R2                                                        
XUALL05  CLI   UFSEL,0                                                          
         JE    XUALL02                                                          
         CLI   UFSEL,UFSELQ                                                     
         JE    XUALL15                                                          
                                                                                
XUALL10  LLC   R0,UFSLN                                                         
         AR    R2,R0                                                            
         J     XUALL05                                                          
                                                                                
XUALL15  DS    0H                                                               
*&&US                                                                           
         TM    UFSSTAT,UFSSAUTH    Show on Authorization REC Only?              
         JO    XUALL10             YES - Skip                                   
*&&                                                                             
         CLC   UFSDESC,SPACES                                                   
         JNH   XUALL10                                                          
                                                                                
         L     R3,AGENAREA                                                      
         LA    R0,MAXLUF                                                        
*                              **  Excl entries with the same name **           
XUALL20  OC    ELMDATA,ELMDATA     free spot?                                   
         JZ    XUALL40             no - go for next                             
         CLC   UFSDESC,ELMDESC     Don't include codes with same name           
         JE    XUALL10                                                          
         AHI   R3,ELMLNG           get next                                     
         JCT   R0,XUALL20                                                       
                                                                                
XUALL40  L     R3,AGENAREA         no match - look for free spot                
         LA    R0,MAXLUF                                                        
                                                                                
XUALL50  OC    ELMDATA,ELMDATA     free spot?                                   
         JNZ   XUALL60             no - keep looping                            
         OC    UFSCUT,UFSCUT       yes - cutoff date                            
         JZ    XUALL55             no - add element                             
         OC    X#CLOX,X#CLOX                                                    
         JZ    XUALL55                                                          
         CLC   UFSCUT,X#CLOX       yes - take it?                               
         JNH   XUALL10             no                                           
                                                                                
XUALL55  MVC   ELMDATA,UFSEL       add element                                  
         J     XUALL10             get next element                             
                                                                                
XUALL60  LA    R3,ELMLNG(R3)       GET NEXT                                     
         JCT   R0,XUALL50                                                       
         DC    H'0'                ACCBLK FULL                                  
                                                                                
XUALLY   CR    RB,RB                                                            
         J     *+6                                                              
XUALLN   LTR   RB,RB                                                            
         XIT1                                                                   
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* GET DEBTOR PAYMENT DETAILS AND SEE WHETHER FULLY PAID, PART PAID OR *         
* UNPAID                                                              *         
* ON NTRY AIO2 CONTAINS TRANSACTION RECORD                            *         
***********************************************************************         
GETDDET  NTR1  BASE=*,LABEL=NO                                                  
         J     *+12                                                             
         DC    C'*GETDT**'                                                      
         MVC   MEDDESC,SPACES                                                   
         ZAP   SAVAMT,PZERO                                                     
         ZAP   PAIDTOT,PZERO                                                    
         ZAP   WRITTOT,PZERO                                                    
         XC    JB_LPAYD,JB_LPAYD                                                
         MVC   SAVEKEY3,IOKEY           SAVE KEY TO RESTORE LATER               
*                                                                               
         L     R2,AIO2                                                          
SJ       USING TRNRECD,R2                                                       
         LA    R3,SJ.TRNRFST                                                    
*                                                                               
GETDDT12 LLC   RF,PPROLEN                                                       
         LA    RF,SJ.TRNKACT(RF)                                                
*                                                                               
         USING PMDRECD,R3                                                       
         LA    R3,IOKEY                                                         
         MVC   IOKEY,SPACES             READ MEDIA RECORD TO GET                
         MVI   PMDKTYP,PMDKTYPQ         MEDIA DESCRIPTION                       
         MVC   PMDKCPY,CUXCPY                                                   
         MVC   PMDKMED,0(RF)                                                    
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO3'                               
         BE    *+6                                                              
         DC    H'0'                                                             
         GOTOR (#IOEXEC,AIOEXEC),'IOGET+IOMST+IO3'                              
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R3,AIO3                                                          
         LA    R3,PMDRFST                                                       
*                                                                               
         USING PMDELD,R3                                                        
GETDDT14 CLI   PMDEL,0                                                          
         BNE   *+6                                                              
         DC    H'0'                                                             
         CLI   PMDEL,PMDELQ                                                     
         BE    GETDDT16                                                         
         LLC   R0,PMDLN                                                         
         AR    R3,R0                                                            
         B     GETDDT14                                                         
*                                                                               
GETDDT16 MVC   MEDDESC(L'PMDDESC),PMDDESC SAVE MEDIA CODE DESCRIPTION           
*                                                                               
SR       USING TRNRECD,R3                                                       
         LA    R3,IOKEY                                                         
         MVC   IOKEY,SPACES             READ THE SR POSTING                     
         MVC   SR.TRNKCPY,CUXCPY                                                
         MVC   SR.TRNKULA(L'TRNKUNT+L'TRNKLDG),=C'SR'                           
         MVC   SR.TRNKACT,SJ.TRNKCACT                                           
         TM    SCPYEL+(CPYSTAT4-CPYELD),CPYSOFF2                                
         BZ    *+10                                                             
         MVC   SR.TRNKOFF,RQ_JBOFF                                              
         MVC   SR.TRNKCACT,MEDDESC                                              
         MVC   SR.TRNKDATE,SJ.TRNKDATE                                          
         MVC   SR.TRNKREF,SJ.TRNKREF                                            
         XC    SR.TRNKSBR,SR.TRNKSBR                                            
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         B     GETDDT20                                                         
*                                                                               
GETDDT18 LA    R3,IOKEY                                                         
         GOTOR (#IOEXEC,AIOEXEC),'IOSQ+IODIR+IO3'                               
*                                                                               
GETDDT20 CLC   IOKEYSAV(TRNKSBR-TRNRECD),SR.TRNKEY                              
         BNE   GETDDT36                                                         
         TM    SR.TRNKSTAT,TRNSREVS                                             
         BNZ   GETDDT18                                                         
         LHI   R1,IOGET+IOMST+IO3                                               
         TM    SR.TRNKSTAT,TRNSARCH                                             
         JZ    *+8                                                              
         LHI   R1,IOGET+IOARC+IO3                                               
         GOTOR (#IOEXEC,AIOEXEC)                                                
         BE    *+6                                                              
         DC    H'0'                                                             
         L     R3,AIO3                                                          
         LA    RF,SR.TRNRFST                                                    
                                                                                
*                                                                               
         USING TRNELD,RF                                                        
GETDDT22 CLI   TRNEL,0                  GET DEBTOR PAYMENT DETAILS              
         BE    GETDDT18                                                         
         CLI   TRNEL,TRNELQ                                                     
         BE    GETDDT26                                                         
         CLI   TRNEL,RALELQ                                                     
         BE    GETDDT28                                                         
GETDDT24 LLC   R0,TRNLN                                                         
         AR    RF,R0                                                            
         B     GETDDT22                                                         
*                                                                               
GETDDT26 ZAP   SAVAMT,TRNAMNT           PAYMENT AMOUNT                          
         B     GETDDT24                                                         
*                                                                               
         USING RALELD,RF                                                        
GETDDT28 CLI   RALTYPE,RALTWOF          CHECK WHAT TYPE OF DEBTOR               
         BNE   GETDDT30                 ALLOCATION                              
         AP    WRITTOT,SAVAMT           WRITE-OFF?                              
*        CLC   JB_LPAYD,RALWDEP                                                 
*        BH    GETDDT24                                                         
*        MVC   JB_LPAYD,RALWDEP         MAKE SURE LATEST DATE STORED            
         B     GETDDT24                                                         
*                                                                               
GETDDT30 CLI   RALTYPE,RALTALC          REGULAR ALLOCATION                      
         BNE   GETDDT32                                                         
         AP    PAIDTOT,SAVAMT                                                   
         CLC   JB_LPAYD,RALADEP                                                 
         BH    GETDDT24                                                         
         MVC   JB_LPAYD,RALADEP         MAKE SURE LATEST DATE STORED            
         B     GETDDT24                                                         
*                                                                               
GETDDT32 CLI   RALTYPE,RALTOFS          OFFSET                                  
         BNE   GETDDT34                                                         
         AP    PAIDTOT,SAVAMT                                                   
         CLC   JB_LPAYD,RALODAT                                                 
         BH    GETDDT24                                                         
         MVC   JB_LPAYD,RALODAT         MAKE SURE LATEST DATE STORED            
         B     GETDDT24                                                         
*                                                                               
GETDDT34 CLI   RALTYPE,RALTTFR          TRANSFER FROM                           
         BE    GETDDT24                                                         
         CLI   RALTYPE,RALTTTO          TRANSFER TO                             
         BE    *+6                                                              
         DC    H'0'                     BAD RALELD!                             
         LA    R3,IOKEY                                                         
         MVC   IOKEY,SPACES             READ THE SR POSTING                     
         MVC   SR.TRNKCPY,CUXCPY                                                
         MVC   SR.TRNKULA,RALTULA       TRANSFER/FROM/TO ACCOUNT                
         TM    SCPYEL+(CPYSTAT4-CPYELD),CPYSOFF2                                
         BZ    *+10                                                             
         MVC   SR.TRNKOFF,RQ_JBOFF                                              
         MVC   SR.TRNKCACT,MEDDESC      MEDIA REFERENCE                         
         MVC   SR.TRNKDATE,SJ.TRNKDATE  TRANSACTION DATE                        
         MVC   SR.TRNKREF,SJ.TRNKREF    TRANSACTION REFERENCE                   
         XC    SR.TRNKSBR,SR.TRNKSBR                                            
         GOTOR (#IOEXEC,AIOEXEC),'IOHI+IODIR+IO3'                               
         B     GETDDT20                                                         
*                                                                               
GETDDT36 ZAP   JB_WRIOF,WRITTOT                                                 
         ZAP   JB_PAYD,PAIDTOT                                                  
         AP    PAIDTOT,WRITTOT                                                  
         CP    PAIDTOT,PZERO            ANYTHING PAID?                          
         BNE   GETDDT38                                                         
         MVI   JB_DSTAT,DTOUST          OUTSTANDING                             
         B     GETDDTY                                                          
*                                                                               
GETDDT38 CP    PAIDTOT,JB_TGRS                                                  
         BNL   GETDDT40                                                         
         MVI   JB_DSTAT,DTPPAYD         PART PAID                               
         B     GETDDTY                                                          
*                                                                               
GETDDT40 MVI   JB_DSTAT,DTFUPAD         FULLY PAID                              
         B     GETDDTY                                                          
*                                                                               
GETDDTY  MVC   IOKEY,SAVEKEY3                                                   
         GOTOR (#IOEXEC,AIOEXEC),'IORD+IODIR+IO2' RESTORE READ SEQUENCE         
         BE    *+6                                                              
         DC    H'0'                                                             
         XIT1                                                                   
         DROP  SJ,SR,RF                                                         
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
***********************************************************************         
* Filter time records according to lowest Getopt setting              *         
* ON NTRY P1=TSJPASD                                                  *         
***********************************************************************         
                                                                                
FLTTMK   NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*FLTTMK*'                                                      
*                                                                               
         USING TSJPASD,R3                                                       
         L     R3,0(R1)            R3=A(Time passive key)                       
         USING TMSTTABD,R2                                                      
         LA    R2,X#RTTRX                                                       
         LA    R1,TMSTNUM                                                       
FLTTMK02 CLI   TMSTMPTY,YESQ       Are we interested in saved timesheet         
         JNE   FLTTMK04            No                                           
         OC    TSJPSTAT,TSJPSTAT   Yes - have we got one                        
         JZ    EXITY               Yes - want this time record                  
FLTTMK04 OC    TMSTSTAT,TMSTSTAT   Are we interested in other statuses          
         JZ    FLTTMK10            No - get next time type                      
         MVC   BYTE1,TMSTSTAT      Yes - do we have a match                     
         NC    BYTE1,TSJPSTAT                                                   
         OC    BYTE1,BYTE1         Any match on the statuses                    
         JZ    FLTTMK10            No                                           
         OC    TMSTXSTA,TMSTXSTA   Yes - do we have an exception status         
         JZ    FLTTMK06            No                                           
         MVC   BYTE1,TMSTXSTA      Yes - check for a match                      
         NC    BYTE1,TSJPSTAT                                                   
         OC    BYTE1,BYTE1         Any match                                    
         JNZ   FLTTMK10            Yes - get next time type                     
FLTTMK06 OC    TMSTCLST,TMSTCLST   Are we interested in client approval         
         JZ    EXITY               No - we want time record                     
         MVC   BYTE1,TMSTCLST      Yes - check it matches                       
         NC    BYTE1,TSJPKSTA                                                   
         OC    BYTE1,BYTE1                                                      
         JNZ   EXITY               Match found accept timel                     
                                                                                
FLTTMK10 LA    R2,TMSTTABL(R2)                                                  
         JCT   R1,FLTTMK02                                                      
         J     EXITN                                                            
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* FILTER TIME RECORDS ACCORDING TO COTUP AND GODITSB, GODITSR,GODITSN *         
* ROUTINE #1-FILTER TSJPASD                                           *         
* ON NTRY P1=A(TIMELD)                                                *         
*         P2=A(TSJPASD)                                               *         
***********************************************************************         
                                                                                
FLTTMP   NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*FLTTMP*'                                                      
                                                                                
         LM    R3,R4,0(R1)         R4=A(TIMELD),R5=A(TSJPAS)                    
                                                                                
         USING TSJPASD,R4                                                       
         USING TIMELD,R3                                                        
*                                                                               
         USING TMSTTABD,R1                                                      
         CLI   TIMTTYP,TIMTCB      Billable time?                               
         JNE   FLTTMP02                                                         
         LA    R1,X#BTTRX                                                       
         J     FLTTMP06                                                         
                                                                                
FLTTMP02 CLI   TIMTTYP,TIMTCR      R type time?                                 
         JNE   FLTTMP04                                                         
         LA    R1,X#RTTRX                                                       
         J     FLTTMP06                                                         
                                                                                
FLTTMP04 CLI   TIMTTYP,TIMTCN      non billable time?                           
         JE    *+6                                                              
         DC    H'0'                                                             
         LA    R1,X#NTTRX                                                       
                                                                                
FLTTMP06 OC    TMSTSTAT,TMSTSTAT   Are we interested in any statuses            
         JNZ   FLTTMP08            Yes                                          
         CLI   TMSTMPTY,NOQ        Are we interested in saved TS                
         JE    EXITN                                                            
*                                                                               
FLTTMP08 CLI   TMSTMPTY,YESQ       Are we interested in saved TS                
         JNE   FLTTMP10            No                                           
         OC    TSJPSTAT,TSJPSTAT   Yes - do we have a saved timesheet           
         JZ    EXITY               Yes - accept time line                       
         OC    TMSTSTAT,TMSTSTAT   No - are we interested in any other          
         JZ    EXITN                            statuses                        
FLTTMP10 MVC   BYTE1,TMSTSTAT                                                   
         NC    BYTE1,TSJPSTAT                                                   
         OC    BYTE1,BYTE1         Any match on the statuses                    
         JZ    EXITN               No - don't want this timel                   
         OC    TMSTXSTA,TMSTXSTA   Yes - do we have an exception status         
         JZ    FLTTMP12            No                                           
         MVC   BYTE1,TMSTXSTA      Yes - check for a match                      
         NC    BYTE1,TSJPSTAT                                                   
         OC    BYTE1,BYTE1                                                      
         JNZ   EXITN               Reject timel if found                        
FLTTMP12 OC    TMSTCLST,TMSTCLST   Are we interested in client approval         
         JZ    EXITY               No                                           
         MVC   BYTE1,TMSTCLST      Yes - check it matches                       
         NC    BYTE1,TSJPKSTA                                                   
         OC    BYTE1,BYTE1                                                      
         JNZ   EXITY               Match found accept timel                     
         J     EXITN               Reject timel                                 
                                                                                
         DROP  R1,R3,R4                                                         
         EJECT                                                                  
***********************************************************************         
* FILTER TIME RECORDS ACCORDING TO  GODITSB AND GODITSR               *         
* ROUTINE #2-FILTER TRNRECD                                           *         
* ON NTRY P1=A(TRNRECD)                                               *         
***********************************************************************         
FLTTIM   NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*FLTTIM*'                                                      
                                                                                
         L     R2,0(R1)                                                         
         USING TRNRECD,R2                                                       
         LA    R4,TRNRFST                                                       
         USING GOXBLKD,R3                                                       
         L     R3,AGOXBLCK                                                      
*                                                                               
         XR    RF,RF                                                            
         USING TRNELD,R4                                                        
FLTTIM02 CLI   TRNEL,0                                                          
         JE    FLTTIM10                                                         
         CLI   TRNEL,TRNELQ        find time type                               
         JE    FLTTIM06                                                         
         CLI   TRNEL,PRTELQ        check time type                              
         JE    FLTTIM08                                                         
         CLI   TRNEL,TRSELQ                                                     
         JNE   FLTTIM04                                                         
         ST    R4,FULL1                                                         
FLTTIM04 LLC   R0,TRNLN                                                         
         AR    R4,R0                                                            
         J     FLTTIM02                                                         
*                                                                               
FLTTIM06 CP    TRNAMNT,PZERO       Is it billable                               
         JE    FLTTIM04            No                                           
         LA    RF,GODITSB          Billable                                     
         TM    SAVEIND,SAVESTC     doing est checking instead?                  
         JZ    *+8                                                              
         LA    RF,GOETMB                                                        
         J     FLTTIM04                                                         
*                                                                               
         USING PRTELD,R4                                                        
FLTTIM08 OR    RF,RF                                                            
         JNZ   FLTTIM04                                                         
         LA    RF,GODITSR                                                       
         TM    SAVEIND,SAVESTC     doing est checking instead?                  
         JZ    *+8                                                              
         LA    RF,GOETMR                                                        
         CP    PRTRATE,PZERO       R type has a rate                            
         JNE   FLTTIM04            Must be R type                               
         OC    PRTSTRT,PRTSTRT                                                  
         JNZ   FLTTIM04            non-bill doesn't                             
         LA    RF,GODITSN                                                       
         J     FLTTIM04                                                         
*                                                                               
         USING TRSELD,R4                                                        
FLTTIM10 L     R4,FULL1                                                         
         CLI   0(RF),GONONE                 want none included?                 
         JE    EXITN                                                            
         CLI   0(RF),GOINPR                 in progress or higher               
         JE    EXITY                                                            
         TM    TRSSTAT4,TRSSSAVT            ignore in progress                  
         JNZ   EXITN                                                            
         TM    TRSSTAT4,TRSSREJT            and rejected                        
         JNZ   EXITN                                                            
         CLI   0(RF),GOSUB                  submitted or higher                 
         JE    EXITY                                                            
         TM    TRSSTAT4,TRSSSUBT            ignore submitted                    
         JNZ   EXITN                                                            
         CLI   0(RF),GOMANPAP               line manager approved               
         JNE   FLTTIM12                                                         
         TM    TRSSTAT4,TRSSMAAP            ignore part approved                
         JNZ   EXITY                                                            
         OC    TRSSTAT4,TRSSTAT4                                                
         JZ    EXITY                                                            
         J     EXITN                                                            
*                                                                               
FLTTIM12 CLI   0(RF),GOCLIPAP      Client approved                              
         JNE   FLTTIM14            No                                           
         TM    TRSSTAT4,TRSSSJAT   Is the time client approved                  
         JNZ   EXITY               Yes                                          
         OC    TRSSTAT4,TRSSTAT4   Or fully approved                            
         JZ    EXITY                                                            
         J     EXITN                                                            
                                                                                
FLTTIM14 TM    TRSSTAT4,TRSSSJAT+TRSSMAAP   ignore part approved                
         JNZ   EXITN                                                            
         CLI   0(RF),GOAPPR                 approved                            
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* Filter order passives according to GODIOS and GODIEO                *         
* ON NTRY P1=A(ORDER PASSIVE)                                         *         
***********************************************************************         
FLTORD   NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*FLTORD*'                                                      
*                                                                               
         L     R2,0(R1)                                                         
         USING OSJPASD,R2                                                       
         TM    OSJPSTAT,ORDCLOSE+ORDSFMCH+ORDSLDEL                              
         JNZ   EXITN                                                            
         TM    OSJPSTA2,ORDSOREJ   Ignore rejected orders                       
         JNZ   EXITN                                                            
*                                                                               
FLTORD06 L     R3,AGOXBLCK                                                      
         USING GOXBLKD,R3                                                       
         TM    SAVEIND,SAVESTC                                                  
         JZ    FLTORD08                                                         
         LA    RF,GOEORN           non memo orders                              
         CLI   OSJPMEM,0           is it memo?                                  
         JE    FLTORD10                                                         
         LA    RF,GOEORM           yes-use memo order option                    
         J     FLTORD10                                                         
*                                                                               
FLTORD08 LA    RF,GODIOS           order option                                 
         CLI   OSJPMEM,0           is it memo?                                  
         JE    FLTORD10                                                         
         LA    RF,GODIEO           yes-use memo order option                    
*                                                                               
FLTORD10 CLI   0(RF),GONONE        none                                         
         JE    EXITN                                                            
         CLI   0(RF),GOINPR        in progress                                  
         JE    EXITY                                                            
         TM    OSJPSTA2,ORDSDRFT   ignore in progress                           
         JNZ   EXITN                                                            
         CLI   0(RF),GOSUB         submitted                                    
         JE    EXITY                                                            
         TM    OSJPSTA2,ORDSSUBM   ignore submitted                             
         JNZ   EXITN                                                            
         CLI   0(RF),GOPAP         part approved                                
         JE    EXITY                                                            
         TM    OSJPSTA2,ORDSPAPP   ignore part approved                         
         JNZ   EXITN                                                            
         CLI   0(RF),GOAPPR        approved                                     
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* Filter expenses according to GODIEN and GODIEB                      *         
* ON NTRY P1=EXJPASD                                                  *         
***********************************************************************         
FLTEXK   NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*FLTEXK*'                                                      
         L     R2,0(R1)                                                         
         L     R3,AGOXBLCK                                                      
         USING EXJPASD,R2                                                       
         USING GOXBLKD,R3                                                       
*                                                                               
         TM    EXJPSTAT,EXCSLOGD   ignore logically deleted                     
         JNZ   EXITN                                                            
                                                                                
         LA    RF,GODIEN                                                        
         LA    RE,GODIEB                                                        
         TM    SAVEIND,SAVESTC     doing est check instead?                     
         JZ    *+12                                                             
         LA    RF,GOEXPN                                                        
         LA    RE,GOEXPB                                                        
*        TM    EXJPSTAT,EXCSCOMP   ignore fully approved to avoid               
*        JNZ   EXITN               double counting                              
         CLI   0(RF),GOINPR        find lowest level of both settings           
         JE    EXITY                                                            
         CLI   0(RE),GOINPR                                                     
         JE    EXITY                                                            
         OC    EXJPSTAT,EXJPSTAT   ignore in progress                           
         JZ    EXITN                                                            
         TM    EXJPSTAT,EXCSREJE   ignore and rejected                          
         JNZ   EXITN                                                            
         CLI   0(RF),GOSUB         submitted?                                   
         JE    EXITY                                                            
         CLI   0(RE),GOSUB                                                      
         JE    EXITY                                                            
         TM    EXJPSTAT,EXCSSUBM   ignore submitted                             
         JNZ   EXITN                                                            
         CLI   0(RF),GOPAP         part approved                                
         JE    EXITY                                                            
         CLI   0(RE),GOPAP                                                      
         JE    EXITY                                                            
         TM    EXJPSTAT,EXCSPAPP+EXCSFNTA                                       
         JNZ   EXITN                                                            
         TM    EXJPSTAT,EXCSCOMP                                                
         JZ    EXITN                                                            
         CLI   0(RF),GOAPPR        approved                                     
         JE    EXITY                                                            
         CLI   0(RE),GOAPPR                                                     
         JE    EXITY                                                            
         DC    H'0'                                                             
         DROP  R2,R3                                                            
         EJECT                                                                  
***********************************************************************         
* Filter expenses according to GODIEN and GODIEB                      *         
* Filter CIDELDS                                                      *         
* ON NTRY P1=A(CIDELD)                                                *         
*         P2=A(EXCRECD)                                               *         
***********************************************************************         
FLTEXL   NTR1  BASE=*,LABEL=*                                                   
         J     *+12                                                             
         DC    C'*FLTEXL*'                                                      
         LM    R2,R3,0(R1)         R2=A(CIDELD),R3=A(EXCRECD)                   
*                                                                               
         L     R4,AGOXBLCK                                                      
         USING CIDELD,R2                                                        
         USING GOXBLKD,R4                                                       
         USING EXCRECD,R3                                                       
*                                                                               
         CLI   CIDMTYP,C'B'        billable                                     
         JNE   FLTEXL02                                                         
         LA    RF,GODIEB                                                        
         TM    EXCRSTAT,EXCSCOMP   ignore fully approved - double count         
         JNZ   EXITN                                                            
         TM    SAVEIND,SAVESTC                                                  
         JZ    FLTEXL04                                                         
         LA    RF,GOEXPB                                                        
         J     FLTEXL04                                                         
*                                                                               
FLTEXL02 CLI   CIDMTYP,C'N'        non-billable                                 
         JE    *+6                                                              
         DC    H'0'                this cideld is bad                           
         LA    RF,GODIEN                                                        
         LA    RE,GODEIS                                                        
         TM    SAVEIND,SAVESTC                                                  
         JZ    *+12                                                             
         LA    RF,GOEXPN                                                        
         LA    RE,GOEMIN                                                        
         CLI   0(RE),NOQ           Have we already got memo invoice             
         JE    FLTEXL04            No                                           
         TM    EXCRSTAT,EXCSCOMP   Yes ignore fully approved to avoid           
         JNZ   EXITN                               double counting              
         J     FLTEXL04                                                         
*                                                                               
FLTEXL04 CLI   0(RF),GONONE        none?                                        
         JE    EXITN                                                            
         CLI   0(RF),GOINPR        in progress?                                 
         JE    EXITY                                                            
         OC    EXCRSTAT,EXCRSTAT   ignore in progress                           
         JZ    EXITN                                                            
         TM    EXCRSTAT,EXCSREJE   ignore rejected                              
         JNZ   EXITN                                                            
         CLI   0(RF),GOSUB         submitted?                                   
         JE    EXITY                                                            
         TM    EXCRSTAT,EXCSSUBM   ignore submitted                             
         JNZ   EXITN                                                            
         CLI   0(RF),GOPAP         part approved                                
         JE    EXITY                                                            
         TM    EXCRSTAT,EXCSPAPP+EXCSFNTA  ignore part appr                     
         JNZ   EXITN                                                            
         TM    EXCRSTAT,EXCSCOMP                                                
         JZ    EXITN                                                            
         CLI   0(RF),GOAPPR        approved                                     
         JE    EXITY                                                            
         DC    H'0'                bad getopt setting                           
         DROP  R2,R3,R4                                                         
         EJECT                                                                  
***********************************************************************         
* LIST OF ACCOUNT FILES TO OPEN IN ALL SYSTEMS                        *         
***********************************************************************         
                                                                                
FILES    DS    0X                  ** FILE INFO **                              
         DC    C'ACCOUNT'          SYSTEM NAME FOR OPEN                         
                                                                                
         DC    C'NCTFILE '         FILE LIST                                    
         DC    C'NGENFIL '                                                      
         DC    C'NGENDIR '                                                      
         DC    C'NACCDIR '                                                      
         DC    C'NACCMST '                                                      
         DC    C'NACCARC '                                                      
         DC    C'X'                                                             
         EJECT                                                                  
***********************************************************************         
* LIST OF CORE RESIDENT FACILITIES (MAPS TO SYSADDR IN WORKD)         *         
***********************************************************************         
                                                                                
FACS     DS    0X                                                               
                                                                                
***********************************************************************         
* REQUEST DEFINITIONS (REQUEST AND OUTPUT)                            *         
***********************************************************************         
*** JOB AUDIT DOWNLOAD ************************************************         
                                                                                
REQJAUD  LKREQ H,A#JAUD,OUTJAUD                                                 
                                                                                
JOBC     LKREQ F,01,(D,B#SAVED,RQ_JAACT),CHAR,OLEN=L'RQ_JAACT,         X        
               MAXLEN=L'RQ_JAACT,TEXT=AC#JOBC,COL=*                             
UL       LKREQ F,02,(D,B#SAVED,RQ_JAUL),CHAR,OLEN=L'RQ_JAUL,           X        
               MAXLEN=L'RQ_JAUL,TEXT=AC#UNTLD,COL=*                             
OFFC     LKREQ F,03,(D,B#SAVED,RQ_JAOFF),CHAR,OLEN=L'RQ_JAOFF,         X        
               MAXLEN=L'RQ_JAOFF,TEXT=AC#OFFC,COL=*                             
                                                                                
         LKREQ E                                                                
                                                                                
*** JOB APPROVER DOWNLOAD *********************************************         
                                                                                
REQJAPP  LKREQ H,A#JAPP,OUTJAPP                                                 
                                                                                
JOBC     LKREQ F,01,(D,B#SAVED,RQ_JAACT),CHAR,OLEN=L'RQ_JAACT,         X        
               MAXLEN=L'RQ_JAACT,TEXT=AC#JOBC,COL=*                             
OFFC     LKREQ F,02,(D,B#SAVED,RQ_JAOFF),CHAR,OLEN=L'RQ_JAOFF,         X        
               MAXLEN=L'RQ_JAOFF,TEXT=AC#OFFC,COL=*                             
                                                                                
         LKREQ E                                                                
                                                                                
*** JOBBAG DOWNLOAD ***************************************************         
                                                                                
REQJBAG  LKREQ H,A#JBAG,OUTJBAG                                                 
                                                                                
TYPE     LKREQ F,01,(D,B#SAVED,RQ_JBTYP),CHAR,OLEN=L'RQ_JBTYP,         X        
               MAXLEN=L'RQ_JBTYP,TEXT=AC#TYPE,COL=*                             
ACCT     LKREQ F,02,(D,B#SAVED,RQ_JBACT),CHAR,OLEN=L'RQ_JBACT,         X        
               MAXLEN=L'RQ_JBACT,TEXT=AC#ACC,COL=*                              
WRKC     LKREQ F,03,(D,B#SAVED,RQ_JBWRK),CHAR,OLEN=L'RQ_JBWRK,         X        
               MAXLEN=L'RQ_JBWRK,TEXT=AC#WC,COL=*                               
HRSN     LKREQ F,04,(D,B#SAVED,RQ_JBHRS),CHAR,OLEN=L'RQ_JBHRS,         X        
               MAXLEN=L'RQ_JBHRS,TEXT=AC#HOURS,COL=*                            
MEMO     LKREQ F,05,(D,B#SAVED,RQ_JBMEM),CHAR,OLEN=L'RQ_JBMEM,         X        
               MAXLEN=L'RQ_JBMEM,TEXT=AC#MEMO,COL=*                             
OFFICE   LKREQ F,06,(D,B#SAVED,RQ_JBOFF),CHAR,OLEN=L'RQ_JBOFF,         X        
               MAXLEN=L'RQ_JBOFF,TEXT=AC#OFFC,COL=*                             
ESTCHK   LKREQ F,07,(D,B#SAVED,RQ_ESTCH),CHAR,OLEN=L'RQ_ESTCH,         X        
               MAXLEN=L'RQ_ESTCH,TEXT=AC#ESCHK,COL=*                            
INCLCT   LKREQ F,08,(D,B#SAVED,RQ_CONTI),CHAR,OLEN=L'RQ_CONTI,         X        
               MAXLEN=L'RQ_CONTI,TEXT=AC#CTY,COL=*                              
                                                                                
         LKREQ E                                                                
                                                                                
*** USER FIELDS DOWNLOAD **********************************************         
                                                                                
REQUFDL  LKREQ H,A#UFDL,OUTUFDL                                                 
                                                                                
CLIC     LKREQ F,01,(D,B#SAVED,RQ_UFCLI),CHAR,OLEN=L'RQ_UFCLI,         X        
               MAXLEN=L'RQ_UFCLI,TEXT=AC#CLIC,COL=*                             
PROC     LKREQ F,02,(D,B#SAVED,RQ_UFPRO),CHAR,OLEN=L'RQ_UFPRO,         X        
               MAXLEN=L'RQ_UFPRO,TEXT=AC#PROC,COL=*                             
JOBC     LKREQ F,03,(D,B#SAVED,RQ_UFJOB),CHAR,OLEN=L'RQ_UFJOB,         X        
               MAXLEN=L'RQ_UFJOB,TEXT=AC#JOBC,COL=*                             
OFFC     LKREQ F,04,(D,B#SAVED,RQ_UFOFF),CHAR,OLEN=L'RQ_UFOFF,         X        
               MAXLEN=L'RQ_UFOFF,TEXT=AC#OFFC,COL=*                             
OPND     LKREQ F,05,(D,B#SAVED,RQ_UFODT),CHAR,OLEN=L'RQ_UFODT,         X        
               MAXLEN=L'RQ_UFODT,TEXT=AC#OPND,COL=*                             
                                                                                
         LKREQ E                                                                
                                                                                
*** JOB LIST AND SEARCH DOWNLOAD **************************************         
                                                                                
REQJLSD  LKREQ H,A#JLSD,OUTJLSD                                                 
                                                                                
CLIC     LKREQ F,01,(D,B#SAVED,RQ_JDCLC),CHAR,OLEN=L'RQ_JDCLC,         X        
               MAXLEN=L'RQ_JDCLC,TEXT=AC#CLIC,COL=*                             
LOCK     LKREQ F,02,(D,B#SAVED,RQ_JDLST),CHAR,OLEN=L'RQ_JDLST,         X        
               MAXLEN=L'RQ_JDLST,TEXT=AC#LCKED,COL=*                            
CLOS     LKREQ F,03,(D,B#SAVED,RQ_JDCST),CHAR,OLEN=L'RQ_JDCST,         X        
               MAXLEN=L'RQ_JDCST,TEXT=AC#CLSD,COL=*                             
FLT1     LKREQ F,04,(D,B#SAVED,RQ_JDF1V),CHAR,OLEN=L'RQ_JDF1V,         X        
               MAXLEN=L'RQ_JDF1V,TEXT=AC#FLT1,COL=*                             
FLT2     LKREQ F,05,(D,B#SAVED,RQ_JDF2V),CHAR,OLEN=L'RQ_JDF2V,         X        
               MAXLEN=L'RQ_JDF2V,TEXT=AC#FLT2,COL=*                             
FLT3     LKREQ F,06,(D,B#SAVED,RQ_JDF3V),CHAR,OLEN=L'RQ_JDF3V,         X        
               MAXLEN=L'RQ_JDF3V,TEXT=AC#FLT3,COL=*                             
FLT4     LKREQ F,07,(D,B#SAVED,RQ_JDF4V),CHAR,OLEN=L'RQ_JDF4V,         X        
               MAXLEN=L'RQ_JDF4V,TEXT=AC#FLT4,COL=*                             
FLT5     LKREQ F,08,(D,B#SAVED,RQ_JDF5V),CHAR,OLEN=L'RQ_JDF5V,         X        
               MAXLEN=L'RQ_JDF5V,TEXT=AC#FLT5,COL=*                             
*EDC     LKREQ F,09,(D,B#SAVED,RQ_JDMED),CHAR,OLEN=L'RQ_JDMED,         X        
               MAXLEN=L'RQ_JDMED,TEXT=AC#MEDC,COL=*                             
MediaC   LKREQ F,09,(I,B#SAVED,RQ_JDMIN),CHAR,OLEN=L'PMDKMED,          X        
               LIST=(F,NOSORT),TEXT=AC#MEDC,COL=*                               
PROC     LKREQ F,10,(D,B#SAVED,RQ_JDPRO),CHAR,OLEN=L'RQ_JDPRO,         X        
               MAXLEN=L'RQ_JDPRO,TEXT=AC#PROC,COL=*                             
OPDS     LKREQ F,11,(D,B#SAVED,RQ_JDOPN),CHAR,OLEN=L'RQ_JDOPN,         X        
               MAXLEN=L'RQ_JDOPN,TEXT=AC#OPNDT,COL=*                            
OPDE     LKREQ F,12,(D,B#SAVED,RQ_JDOPX),CHAR,OLEN=L'RQ_JDOPX,         X        
               MAXLEN=L'RQ_JDOPX,TEXT=AC#OPNDT,COL=*                            
CLDS     LKREQ F,13,(D,B#SAVED,RQ_JDCLO),CHAR,OLEN=L'RQ_JDCLO,         X        
               MAXLEN=L'RQ_JDCLO,TEXT=AC#CLSDT,COL=*                            
CLDE     LKREQ F,14,(D,B#SAVED,RQ_JDCLX),CHAR,OLEN=L'RQ_JDCLX,         X        
               MAXLEN=L'RQ_JDCLX,TEXT=AC#CLSDT,COL=*                            
*AME     LKREQ F,15,(D,B#SAVED,RQ_JDNAM),CHAR,OLEN=L'RQ_JDNAM,         X        
               MAXLEN=L'RQ_JDNAM,TEXT=AC#NAME,COL=*                             
Name     LKREQ F,15,(I,B#SAVED,RQ_JDNIN),CHAR,OLEN=L'SRCKWRD1,         X        
               LIST=(F,NOSORT),LOWERCASE=Y,TEXT=AC#NAME,COL=*                   
USR1     LKREQ F,16,(D,B#SAVED,RQ_JDUF1),CHAR,OLEN=L'RQ_JDUF1,         X        
               MAXLEN=L'RQ_JDUF1,TEXT=AC#RSUSF,COL=*                            
USR2     LKREQ F,17,(D,B#SAVED,RQ_JDUF2),CHAR,OLEN=L'RQ_JDUF2,         X        
               MAXLEN=L'RQ_JDUF2,TEXT=AC#RSUSF,COL=*                            
USR3     LKREQ F,18,(D,B#SAVED,RQ_JDUF3),CHAR,OLEN=L'RQ_JDUF3,         X        
               MAXLEN=L'RQ_JDUF3,TEXT=AC#RSUSF,COL=*                            
USR4     LKREQ F,19,(D,B#SAVED,RQ_JDUF4),CHAR,OLEN=L'RQ_JDUF4,         X        
               MAXLEN=L'RQ_JDUF4,TEXT=AC#RSUSF,COL=*                            
USR5     LKREQ F,20,(D,B#SAVED,RQ_JDUF5),CHAR,OLEN=L'RQ_JDUF5,         X        
               MAXLEN=L'RQ_JDUF5,TEXT=AC#RSUSF,COL=*                            
USR6     LKREQ F,21,(D,B#SAVED,RQ_JDUF6),CHAR,OLEN=L'RQ_JDUF6,         X        
               MAXLEN=L'RQ_JDUF6,TEXT=AC#RSUSF,COL=*                            
USR7     LKREQ F,22,(D,B#SAVED,RQ_JDUF7),CHAR,OLEN=L'RQ_JDUF7,         X        
               MAXLEN=L'RQ_JDUF7,TEXT=AC#RSUSF,COL=*                            
USR8     LKREQ F,23,(D,B#SAVED,RQ_JDUF8),CHAR,OLEN=L'RQ_JDUF8,         X        
               MAXLEN=L'RQ_JDUF8,TEXT=AC#RSUSF,COL=*                            
USR9     LKREQ F,24,(D,B#SAVED,RQ_JDUF9),CHAR,OLEN=L'RQ_JDUF9,         X        
               MAXLEN=L'RQ_JDUF9,TEXT=AC#RSUSF,COL=*                            
USR0     LKREQ F,25,(D,B#SAVED,RQ_JDUF0),CHAR,OLEN=L'RQ_JDUF0,         X        
               MAXLEN=L'RQ_JDUF0,TEXT=AC#RSUSF,COL=*                            
*&&UK                                                                           
DRFT     LKREQ F,26,(D,B#SAVED,RQ_JDDRA),CHAR,OLEN=L'RQ_JDDRA,         X        
               MAXLEN=L'RQ_JDDRA,TEXT=AC#UNAPP,COL=*                            
*&&                                                                             
*&&US                                                                           
DRFT     LKREQ F,26,(D,B#SAVED,RQ_JDDRA),CHAR,OLEN=L'RQ_JDDRA,         X        
               MAXLEN=L'RQ_JDDRA,TEXT=AC#UAPR,COL=*                             
*&&                                                                             
ESTPC    LKREQ F,27,(D,B#SAVED,RQ_JDEPC),CHAR,OLEN=L'RQ_JDEPC,         X        
               MAXLEN=L'RQ_JDEPC,TEXT=AC#JOBES,COL=*                            
TYPE     LKREQ F,40,(D,B#SAVED,RQ_JDTYP),CHAR,OLEN=L'RQ_JDTYP,         X        
               MAXLEN=L'RQ_JDTYP,TEXT=AC#TYPE,COL=*                             
GAOV     LKREQ F,41,(D,B#SAVED,RQ_JDGAO),CHAR,OLEN=L'RQ_JDGAO,         X        
               MAXLEN=L'RQ_JDGAO,TEXT=AC#GAOV,COL=*                             
Status   LKREQ F,42,(I,B#SAVED,RQ_JDSIN),CHAR,OLEN=L'X#JDSTAT,         X        
               LIST=(F,NOSORT),TEXT=AC#STT,COL=*                                
*&&UK                                                                           
SUBM     LKREQ F,43,(D,B#SAVED,RQ_JDSPC),CHAR,OLEN=L'RQ_JDSPC,         X        
               MAXLEN=L'RQ_JDSPC,TEXT=AC#ESSUB,COL=*                            
*&&                                                                             
*&&US                                                                           
SUBM     LKREQ F,43,(D,B#SAVED,RQ_JDSPC),CHAR,OLEN=L'RQ_JDSPC,         X        
               MAXLEN=L'RQ_JDSPC,TEXT=AC#SUBMT,COL=*                            
*&&                                                                             
APPR     LKREQ F,44,(D,B#SAVED,RQ_JDAPC),CHAR,OLEN=L'RQ_JDAPC,         X        
               MAXLEN=L'RQ_JDAPC,TEXT=AC#APRVR,COL=*                            
*&&UK                                                                           
REJE     LKREQ F,45,(D,B#SAVED,RQ_JDRPC),CHAR,OLEN=L'RQ_JDRPC,         X        
               MAXLEN=L'RQ_JDRPC,TEXT=AC#ESREJ,COL=*                            
*&&                                                                             
*&&US                                                                           
REJE     LKREQ F,45,(D,B#SAVED,RQ_JDRPC),CHAR,OLEN=L'RQ_JDRPC,         X        
               MAXLEN=L'RQ_JDRPC,TEXT=AC#REJEC,COL=*                            
*&&                                                                             
LOCE     LKREQ F,46,(D,B#SAVED,RQ_OPENS),CHAR,OLEN=L'RQ_OPENS,         X        
               MAXLEN=L'RQ_OPENS,TEXT=(*,OPESTLIT),COL=*                        
                                                                                
LOCO     LKREQ F,47,(D,B#SAVED,RQ_OPENO),CHAR,OLEN=L'RQ_OPENO,         X        
               MAXLEN=L'RQ_OPENO,TEXT=(*,OPORDLIT),COL=*                        
                                                                                
LOCX     LKREQ F,48,(D,B#SAVED,RQ_OPENX),CHAR,OLEN=L'RQ_OPENX,         X        
               MAXLEN=L'RQ_OPENX,TEXT=(*,OPEXTLIT),COL=*                        
                                                                                
LOCB     LKREQ F,49,(D,B#SAVED,RQ_OPENB),CHAR,OLEN=L'RQ_OPENB,         X        
               MAXLEN=L'RQ_OPENB,TEXT=(*,OPBILLIT),COL=*                        
                                                                                
LOCA     LKREQ F,50,(D,B#SAVED,RQ_OPENA),CHAR,OLEN=L'RQ_OPENA,         X        
               MAXLEN=L'RQ_OPENA,TEXT=(*,OPADJLIT),COL=*                        
                                                                                
LOCT     LKREQ F,51,(D,B#SAVED,RQ_OPENT),CHAR,OLEN=L'RQ_OPENT,         X        
               MAXLEN=L'RQ_OPENT,TEXT=(*,OPTIMLIT),COL=*                        
                                                                                
OVER     LKREQ F,52,(D,B#SAVED,RQ_JDOVR),CHAR,OLEN=L'RQ_JDOVR,         X        
               MAXLEN=L'RQ_JDOVR,TEXT=AC#TYPE,COL=*                             
                                                                                
OFFICE   LKREQ F,53,(D,B#SAVED,RQ_JDOFF),CHAR,OLEN=L'RQ_JDOFF,         X        
               MAXLEN=L'RQ_JDOFF,TEXT=AC#OFFC,COL=*                             
                                                                                
UFHEADER LKREQ F,54,(I,B#SAVED,RQ_JDUIN),CHAR,LIST=NOSORT,             X        
               TEXT=AC#HEADR,LOWERCASE=Y,OLEN=L'UFSDESC,ARRAY=S                 
                                                                                
UFDATA   LKREQ F,55,(I,B#SAVED,RQ_JDUIN),CHAR,LIST=NOSORT,             X        
               TEXT=AC#RSUSF,LOWERCASE=Y,OLEN=UFSDATMX                          
                                                                                
Usft     LKREQ F,57,(D,B#SAVED,RQ_JDUIN),CHAR,LIST=NOSORT,             X        
               TEXT=AC#TYPE,LOWERCASE=Y,OLEN=UFSTYPEL,ARRAY=E                   
                                                                                
JOBC     LKREQ F,56,(D,B#SAVED,RQ_JDJOB),CHAR,OLEN=L'RQ_JDJOB,         X        
               MAXLEN=L'RQ_JDJOB,TEXT=AC#JOBC,COL=*                             
                                                                                
ShowPay  LKREQ F,58,(D,B#SAVED,RQ_JDPAY),CHAR,OLEN=L'RQ_JDPAY,         +        
               MAXLEN=L'RQ_JDPAY,TEXT=(*,JBPAYLIT),COL=*                        
                                                                                
         LKREQ E                                                                
                                                                                
         LKREQ X                                                                
                                                                                
***********************************************************************         
* REQUEST LITERALS                                                    *         
***********************************************************************         
         SPACE 1                                                                
OPESTLIT DC    C'Open for estimates'                                            
OPORDLIT DC    C'Open for orders'                                               
OPEXTLIT DC    C'Open for external postings'                                    
OPBILLIT DC    C'Open for billing'                                              
OPADJLIT DC    C'Open for adjustments'                                          
OPTIMLIT DC    C'Open for timesheets'                                           
JBPAYLIT DC    C'Show Payments totals'                                          
                                                                                
***********************************************************************         
* OUTPUT MAPS                                                         *         
***********************************************************************         
                                                                                
*** JOB AUDIT DOWNLOAD ************************************************         
                                                                                
OUTJAUD  LKOUT H                                                                
OUTJAUDS LKOUT R,R#JAUD                                                         
                                                                                
FRST     LKOUT C,01,(D,B#SAVED,JA_FRS),CHAR,ND=Y                                
TOST     LKOUT C,02,(D,B#SAVED,JA_TOS),CHAR,ND=Y                                
DATE     LKOUT C,03,(D,B#SAVED,JA_DTE),PDAT,ND=Y                                
TIME     LKOUT C,04,(D,B#SAVED,JA_TIM),CHAR,ND=Y                                
USID     LKOUT C,05,(D,B#SAVED,JA_USR),CHAR,ND=Y                                
PCOD     LKOUT C,06,(D,B#SAVED,JA_PID),CHAR,ND=Y                                
PFNA     LKOUT C,07,(D,B#SAVED,JA_PER),CHAR,ND=Y                                
PLNA     LKOUT C,08,(D,B#SAVED,JA_PEL),CHAR,ND=Y                                
COMM     LKOUT C,09,(D,B#SAVED,JA_COM),CHAR,ND=Y                                
PMNA     LKOUT C,10,(D,B#SAVED,JA_PEM),CHAR,ND=Y                                
TYPE     LKOUT C,11,(D,B#SAVED,JA_TYP),LBIN,ND=Y                                
STAT     LKOUT C,12,(D,B#SAVED,JA_STA),CHAR,ND=Y                                
ACTN     LKOUT C,13,(D,B#SAVED,JA_ACT),LBIN,ND=Y                                
DATA     LKOUT C,14,(D,B#SAVED,JA_DATA),CHAR,ND=Y                               
APPL     LKOUT C,15,(D,B#SAVED,JA_APPL),HEXD,ND=Y                               
                                                                                
         LKOUT E                                                                
         LKOUT X                                                                
                                                                                
*** JOB APPROVER DOWNLOAD *********************************************         
                                                                                
OUTJAPP  LKOUT H                                                                
OUTJAPPS LKOUT R,R#JAPP                                                         
                                                                                
CRPC     LKOUT C,01,(D,B#SAVED,JP_CPC),CHAR,ND=Y                                
CRPF     LKOUT C,02,(D,B#SAVED,JP_CPF),CHAR,ND=Y                                
CRPL     LKOUT C,03,(D,B#SAVED,JP_CPL),CHAR,ND=Y                                
CREM     LKOUT C,04,(D,B#SAVED,JP_CEM),CHAR,ND=Y                                
APPC     LKOUT C,05,(D,B#SAVED,JP_APC),CHAR,ND=Y                                
APPF     LKOUT C,06,(D,B#SAVED,JP_APF),CHAR,ND=Y                                
APPL     LKOUT C,07,(D,B#SAVED,JP_APL),CHAR,ND=Y                                
APEM     LKOUT C,08,(D,B#SAVED,JP_AEM),CHAR,ND=Y                                
ALVL     LKOUT C,09,(D,B#SAVED,JP_LVL),CHAR,ND=Y                                
APPM     LKOUT C,10,(D,B#SAVED,JP_APM),CHAR,ND=Y                                
                                                                                
         LKOUT E                                                                
         LKOUT X                                                                
                                                                                
*** JOBBAG DOWNLOAD ***************************************************         
                                                                                
OUTJBAG  LKOUT H                                                                
OUTJBAGS LKOUT R,R#JBAG                                                         
                                                                                
TYPE     LKOUT C,01,(D,B#SAVED,JB_TYPE),CHAR,ND=Y                               
INEX     LKOUT C,02,(D,B#SAVED,JB_EORI),CHAR,ND=Y                               
WCOD     LKOUT C,03,(D,B#SAVED,JB_WCOD),CHAR,ND=Y                               
WDES     LKOUT C,04,(D,B#SAVED,JB_WDES),CHAR,ND=Y                               
WEST     LKOUT C,05,(D,B#SAVED,JB_ESTA),SPAK,ND=Y,PZERO=S                       
WDEB     LKOUT C,06,(D,B#SAVED,JB_DEBA),SPAK,ND=Y,PZERO=S                       
WCRE     LKOUT C,07,(D,B#SAVED,JB_CREA),SPAK,ND=Y,PZERO=S                       
WORD     LKOUT C,08,(D,B#SAVED,JB_ORDA),SPAK,ND=Y,PZERO=S                       
WHRS     LKOUT C,09,(D,B#SAVED,JB_HOUR),SPAK,ND=Y,PZERO=S                       
DTYP     LKOUT C,10,(D,B#SAVED,JB_DTYP),CHAR,ND=Y                               
CACO     LKOUT C,11,(D,B#SAVED,JB_CACC),CHAR,ND=Y                               
CANA     LKOUT C,12,(D,B#SAVED,JB_CACN),CHAR,ND=Y                               
DATE     LKOUT C,13,(D,B#SAVED,JB_DATE),PDAT,ND=Y                               
REFN     LKOUT C,14,(D,B#SAVED,JB_REFN),CHAR,ND=Y                               
TRXD     LKOUT C,15,(D,B#SAVED,JB_TDEB),SPAK,ND=Y,PZERO=S                       
TRXC     LKOUT C,16,(D,B#SAVED,JB_TCRE),SPAK,ND=Y,PZERO=S                       
TRXH     LKOUT C,17,(D,B#SAVED,JB_THRS),SPAK,ND=Y,PZERO=S                       
MEMH     LKOUT C,18,(D,B#SAVED,JB_MHRS),SPAK,ND=Y,PZERO=S                       
ORDS     LKOUT C,19,(D,B#SAVED,JB_OAMT),SPAK,ND=Y,PZERO=S                       
INVS     LKOUT C,20,(D,B#SAVED,JB_OINV),SPAK,ND=Y,PZERO=S                       
ESTN     LKOUT C,21,(D,B#SAVED,JB_ESTN),CHAR,ND=Y                               
ESTL     LKOUT C,22,(D,B#SAVED,JB_ESTL),CHAR,ND=Y                               
ESTS     LKOUT C,23,(D,B#SAVED,JB_ESTS),CHAR,ND=Y                               
ETYP     LKOUT C,24,(D,B#SAVED,JB_ETYP),CHAR,ND=Y                               
NARR     LKOUT C,25,(D,B#SAVED,JB_NARR),CHAR,ND=Y                               
WALL     LKOUT C,26,(D,B#SAVED,JB_ALLA),SPAK,ND=Y,PZERO=S                       
TRXA     LKOUT C,27,(D,B#SAVED,JB_TALL),SPAK,ND=Y,PZERO=S                       
ORDN     LKOUT C,28,(D,B#SAVED,JB_ORDN),CHAR,ND=Y                               
ESTD     LKOUT C,29,(D,B#SAVED,JB_ESTD),CHAR,ND=Y                               
INTR     LKOUT C,30,(D,B#SAVED,JB_INTR),CHAR,ND=Y                               
WGRO     LKOUT C,31,(D,B#SAVED,JB_GROS),SPAK,ND=Y,PZERO=S                       
WCOM     LKOUT C,32,(D,B#SAVED,JB_COMM),SPAK,ND=Y,PZERO=S                       
WCHT     LKOUT C,33,(D,B#SAVED,JB_CHTI),SPAK,ND=Y,PZERO=S                       
REQN     LKOUT C,34,(D,B#SAVED,JB_REQN),CHAR,ND=Y                               
TAST     LKOUT C,35,(D,B#SAVED,JB_TAST),CHAR,ND=Y                               
MWCF     LKOUT C,36,(D,B#SAVED,JB_WCMI),CHAR,ND=Y                               
FCCD     LKOUT C,37,(D,B#SAVED,JB_TFCC),CHAR,ND=Y                               
FCNA     LKOUT C,38,(D,B#SAVED,JB_TFCA),SPAK,ND=Y,PZERO=S                       
BVAT     LKOUT C,39,(D,B#SAVED,JB_TVAT),SPAK,ND=Y,PZERO=S                       
BGRS     LKOUT C,40,(D,B#SAVED,JB_TGRS),SPAK,ND=Y,PZERO=S                       
BPCD     LKOUT C,41,(D,B#SAVED,JB_BPCD),CHAR,ND=Y                               
BPFN     LKOUT C,42,(D,B#SAVED,JB_BPFN),CHAR,ND=Y                               
BPLN     LKOUT C,43,(D,B#SAVED,JB_BPLN),CHAR,ND=Y                               
BSTA     LKOUT C,44,(D,B#SAVED,JB_BSTA),CHAR,ND=Y                               
BCOR     LKOUT C,45,(D,B#SAVED,JB_CORA),SPAK,ND=Y,PZERO=S                       
BCOM     LKOUT C,46,(D,B#SAVED,JB_TCOM),SPAK,ND=Y,PZERO=S                       
BEXR     LKOUT C,47,(D,B#SAVED,JB_TFCR),HEXD,ND=Y                               
ChSR     LKOUT C,48,(D,B#SAVED,JB_CASR),SPAK,ND=Y,PZERO=S                       
ChCR     LKOUT C,49,(D,B#SAVED,JB_CACR),SPAK,ND=Y,PZERO=S                       
WCoB     LKOUT C,50,(D,B#SAVED,JB_COMB),SPAK,ND=Y,PZERO=S                       
INVN     LKOUT C,51,(D,B#SAVED,JB_INVN),CHAR,ND=Y                               
Dsta     LKOUT C,52,(D,B#SAVED,JB_DSTAT),CHAR,ND=Y                              
Amrd     LKOUT C,53,(D,B#SAVED,JB_PAYD),SPAK,ND=Y,PZERO=S                       
Amwr     LKOUT C,54,(D,B#SAVED,JB_WRIOF),SPAK,ND=Y,PZERO=S                      
Dlas     LKOUT C,55,(D,B#SAVED,JB_LPAYD),PDAT,ND=Y                              
Bil#     LKOUT C,56,(D,B#SAVED,JB_BILNO),CHAR,ND=Y           (multiple)         
UsrId#   LKOUT C,57,(D,B#SAVED,JB_USRID),LBIN,ND=Y                              
                                                                                
         LKOUT E                                                                
         LKOUT X                                                                
                                                                                
*** USER FIELDS DOWNLOAD **********************************************         
                                                                                
OUTUFDL  LKOUT H                                                                
OUTUFDLS LKOUT R,R#UFDL                                                         
                                                                                
TYPE     LKOUT C,01,(D,B#SAVED,UF_TYP),CHAR,ND=Y                                
CODE     LKOUT C,02,(D,B#SAVED,UF_COD),CHAR,ND=Y                                
HEAD     LKOUT C,03,(D,B#SAVED,UF_HDR),CHAR,ND=Y                                
MAXC     LKOUT C,04,(D,B#SAVED,UF_MAX),CHAR,ND=Y                                
COMP     LKOUT C,05,(D,B#SAVED,UF_COM),CHAR,ND=Y                                
OFFI     LKOUT C,06,(D,B#SAVED,UF_OFF),CHAR,ND=Y                                
                                                                                
         LKOUT E                                                                
         LKOUT X                                                                
                                                                                
*** JOB LIST AND SEARCH DOWNLOAD **************************************         
                                                                                
OUTJLSD  LKOUT H                                                                
OUTJLSDS LKOUT R,R#JLSD                                                         
                                                                                
PROC     LKOUT C,01,(D,B#SAVED,JD_PRO),CHAR,ND=Y                                
PRON     LKOUT C,02,(D,B#SAVED,JD_PRN),CHAR,ND=Y                                
MEDC     LKOUT C,03,(D,B#SAVED,JD_MED),CHAR,ND=Y                                
MEDN     LKOUT C,04,(D,B#SAVED,JD_MEN),CHAR,ND=Y                                
JOBC     LKOUT C,05,(D,B#SAVED,JD_JOB),CHAR,ND=Y                                
JOBN     LKOUT C,06,(D,B#SAVED,JD_JON),CHAR,ND=Y                                
JOBF     LKOUT C,07,(D,B#SAVED,JD_JOF),CHAR,ND=Y                                
JOBL     LKOUT C,08,(D,B#SAVED,JD_JOBL),CHAR,ND=Y                               
OFFC     LKOUT C,09,(D,B#SAVED,JD_OFF),CHAR,ND=Y                                
OFFN     LKOUT C,10,(D,B#SAVED,JD_OFN),CHAR,ND=Y                                
OPEN     LKOUT C,11,(D,B#SAVED,JD_ODT),PDAT,ND=Y                                
CLOS     LKOUT C,12,(D,B#SAVED,JD_CDT),PDAT,ND=Y                                
CURR     LKOUT C,13,(D,B#SAVED,JD_CUR),CHAR,ND=Y                                
STAT     LKOUT C,14,(D,B#SAVED,JD_STA),CHAR,ND=Y                                
FLTS     LKOUT C,15,(D,B#SAVED,JD_F15),CHAR,ND=Y                                
USR1     LKOUT C,16,(D,B#SAVED,JD_UF1),CHAR,ND=Y                                
USR2     LKOUT C,17,(D,B#SAVED,JD_UF2),CHAR,ND=Y                                
USR3     LKOUT C,18,(D,B#SAVED,JD_UF3),CHAR,ND=Y                                
USR4     LKOUT C,19,(D,B#SAVED,JD_UF4),CHAR,ND=Y                                
USR5     LKOUT C,20,(D,B#SAVED,JD_UF5),CHAR,ND=Y                                
USR6     LKOUT C,21,(D,B#SAVED,JD_UF6),CHAR,ND=Y                                
USR7     LKOUT C,22,(D,B#SAVED,JD_UF7),CHAR,ND=Y                                
USR8     LKOUT C,23,(D,B#SAVED,JD_UF8),CHAR,ND=Y                                
USR9     LKOUT C,24,(D,B#SAVED,JD_UF9),CHAR,ND=Y                                
USR0     LKOUT C,25,(D,B#SAVED,JD_UF0),CHAR,ND=Y                                
LADT     LKOUT C,26,(D,B#SAVED,JD_LAD),PDAT,ND=Y                                
LAPE     LKOUT C,27,(D,B#SAVED,JD_LAC),CHAR,ND=Y                                
CLIC     LKOUT C,28,(D,B#SAVED,JD_CLI),CHAR,ND=Y                                
CLIN     LKOUT C,29,(D,B#SAVED,JD_CLN),CHAR,ND=Y                                
IDNO     LKOUT C,30,(D,B#SAVED,JD_IDN),CHAR,ND=Y                                
CRPC     LKOUT C,31,(D,B#SAVED,JD_CPC),CHAR,ND=Y                                
CRPF     LKOUT C,32,(D,B#SAVED,JD_CPF),CHAR,ND=Y                                
CRPL     LKOUT C,33,(D,B#SAVED,JD_CPL),CHAR,ND=Y                                
APPC     LKOUT C,34,(D,B#SAVED,JD_APC),CHAR,ND=Y                                
APPF     LKOUT C,35,(D,B#SAVED,JD_APF),CHAR,ND=Y                                
APPL     LKOUT C,36,(D,B#SAVED,JD_APL),CHAR,ND=Y                                
CAMC     LKOUT C,37,(D,B#SAVED,JD_CAM),LBIN,ND=Y                                
CAMN     LKOUT C,38,(D,B#SAVED,JD_CNA),CHAR,ND=Y                                
LAPF     LKOUT C,39,(D,B#SAVED,JD_LAF),CHAR,ND=Y                                
LAPL     LKOUT C,40,(D,B#SAVED,JD_LAL),CHAR,ND=Y                                
EPCP     LKOUT C,41,(D,B#SAVED,JD_EPC),SPAK,ND=Y,PZERO=S                        
EPCC     LKOUT C,42,(D,B#SAVED,JD_COL),CHAR,ND=Y                                
JCLOS    LKOUT C,43,(D,B#SAVED,JD_CCLSE),CHAR,ND=Y                              
JLOS     LKOUT C,44,(D,B#SAVED,JD_LOCES),CHAR,ND=Y                              
JLOR     LKOUT C,45,(D,B#SAVED,JD_LOCOR),CHAR,ND=Y                              
JLOE     LKOUT C,46,(D,B#SAVED,JD_LOCEX),CHAR,ND=Y                              
JLOB     LKOUT C,47,(D,B#SAVED,JD_LOCBI),CHAR,ND=Y                              
JLOA     LKOUT C,48,(D,B#SAVED,JD_LOCAD),CHAR,ND=Y                              
JLOT     LKOUT C,49,(D,B#SAVED,JD_LOCTI),CHAR,ND=Y                              
JFEE     LKOUT C,50,(D,B#SAVED,JD_FEE),SPAK,ND=Y,PZERO=S                        
JMAS     LKOUT C,51,(D,B#SAVED,JD_MAST),CHAR,ND=Y                               
JMCL     LKOUT C,52,(D,B#SAVED,JD_MACC),(U,#EDTCLI,$EDTCLI),ND=Y                
JMCN     LKOUT C,53,(D,B#SAVED,JD_MACC),(U,#EDTCLN,$EDTCLN),ND=Y                
JMPR     LKOUT C,54,(D,B#SAVED,JD_MACC),(U,#EDTPRD,$EDTPRD),ND=Y                
JMPN     LKOUT C,55,(D,B#SAVED,JD_MACC),(U,#EDTPRN,$EDTPRN),ND=Y                
JMJB     LKOUT C,56,(D,B#SAVED,JD_MACC),(U,#EDTJOB,$EDTJOB),ND=Y                
JMJN     LKOUT C,57,(D,B#SAVED,JD_MACC),(U,#EDTJBN,$EDTJBN),ND=Y                
LAPM     LKOUT C,58,(D,B#SAVED,JD_LAM),CHAR,ND=Y                                
APPM     LKOUT C,59,(D,B#SAVED,JD_APM),CHAR,ND=Y                                
CRPM     LKOUT C,60,(D,B#SAVED,JD_CPM),CHAR,ND=Y                                
CanDel   LKOUT C,61,(D,B#SAVED,JD_CDELT),CHAR,ND=Y                              
Auto     LKOUT C,62,(D,B#SAVED,JD_AUTO),CHAR,ND=Y                               
Draft    LKOUT C,63,(D,B#SAVED,JD_DRFT),CHAR,ND=Y                               
EsDrf    LKOUT C,64,(D,B#SAVED,JD_ESDR),CHAR,ND=Y                               
*&&US                                                                           
ExpJb    LKOUT C,65,(D,B#SAVED,JD_EXJB),CHAR,ND=Y                               
*&&                                                                             
AuraUFH1 LKOUT C,66,(D,B#SAVED,JD_AUFH1),CHAR,ND=Y                              
AuraUFD1 LKOUT C,67,(D,B#SAVED,JD_AUFD1),CHAR,ND=Y                              
AuraUFH2 LKOUT C,68,(D,B#SAVED,JD_AUFH2),CHAR,ND=Y                              
AuraUFD2 LKOUT C,69,(D,B#SAVED,JD_AUFD2),CHAR,ND=Y                              
AuraUFH3 LKOUT C,70,(D,B#SAVED,JD_AUFH3),CHAR,ND=Y                              
AuraUFD3 LKOUT C,71,(D,B#SAVED,JD_AUFD3),CHAR,ND=Y                              
IsForUsr LKOUT C,72,(D,B#SAVED,JD_IFU),CHAR,ND=Y                                
BraEstEx LKOUT C,73,(D,B#SAVED,JD_BEST),CHAR,ND=Y                               
NetBill  LKOUT C,74,(D,B#SAVED,JD_NETBL),SPAK,ND=Y,PZERO=S                      
Actuals  LKOUT C,75,(D,B#SAVED,JD_ACTLS),SPAK,ND=Y,PZERO=S                      
Orders   LKOUT C,76,(D,B#SAVED,JD_ORDRS),SPAK,ND=Y,PZERO=S                      
Estimate LKOUT C,77,(D,B#SAVED,JD_ESTMD),SPAK,ND=Y,PZERO=S                      
PayTotal LKOUT C,78,(D,B#SAVED,JD_PAYTA),SPAK,ND=Y,PZERO=S                      
Amber    LKOUT C,79,(D,B#SAVED,JD_AMBR),SPAK,PZERO=S                            
Red      LKOUT C,80,(D,B#SAVED,JD_RED),SPAK,PZERO=S                             
                                                                                
         LKOUT E                                                                
         LKOUT X                                                                
                                                                                
***********************************************************************         
                                                                                
PTRACED  DSECT                                                                  
PTTWHO   DS    CL(L'TWHO)                                                       
         DS    CL2                                                              
PTEXTRA  DS    0CL90                                                            
PTTIO    DS    0C                                                               
PTTTIME  DS    CL(L'TTIMED)                                                     
         DS    CL1                                                              
PTHH     DS    CL2                                                              
PTCO1    DS    CL1                                                              
PTMM     DS    CL2                                                              
PTCO2    DS    CL1                                                              
PTSS     DS    CL2                                                              
         DS    CL2                                                              
PTTALPH  DS    CL(L'TALPHAID)                                                   
         DS    CL1                                                              
PTALPH   DS    CL(L'CUAALF)                                                     
         DS    CL2                                                              
PTTUSER  DS    CL(L'TUSERPID)                                                   
         DS    CL1                                                              
PTUSER   DS    CL(2*L'CUPASS)                                                   
         DS    CL2                                                              
PTFIELD  DS    CL10                                                             
         DS    CL1                                                              
PFIELD   DS    CL30                                                             
         DS    CL2                                                              
PTAURA   DS    CL8                                                              
                                                                                
SAVED    DSECT                                                                  
                                                                                
AESTWRKA DS    A                   ADDRESS OF ESTIMATE WORK AREA                
APRINTER DS    A                                                                
ARUNFACS DS    A                                                                
VMASTC   DS    V                                                                
VACCEMU  DS    A                                                                
*                                                                               
AUINTAB  DS    A                   A(upper case translate table)                
ASRCTAB  DS    A                   A(search translate table)                    
*                                                                               
LIOTRACE DS    F                                                                
*                                                                               
TSARTYPE DS    CL1                                                              
TSARTESQ EQU   C'E'                                                             
TSARTJSQ EQU   C'J'                                                             
TSARRECS DS    XL(TSPXTNL)         TSAR block for record buffer                 
*                                                                               
OVALUES  DS    0D                                                               
DMKEY    DS    CL8                                                              
ACCDIR   DS    CL8                                                              
ACCMST   DS    CL8                                                              
ACCARC   DS    CL8                                                              
PZERO    DS    PL1                                                              
XFFS     DS    XL4                                                              
ORDWC    DS    CL2                                                              
BILWC    DS    CL2                                                              
JOBFLDS  DS    XL10                                                             
LOOKFLDH DS    XL13                                                             
OVALUESL EQU   *-OVALUES                                                        
*                                  (see exptytab)                               
EXPTTAB  DS    0D                  table for EXJPVIEW                           
         DS    CL1                 EXJPCLI1                                     
         DS    CL1                 EXJPCBL1                                     
         DS    CL1                 EXJPCNB1                                     
         DS    CL1                                                              
EXPTTABL EQU   *-EXPTTAB                                                        
*                                                                               
DSDICTL  DS    0C                                                               
AC@TIME  DS    CL20                                                             
AC@MAT   DS    CL20                                                             
AC@EST   DS    CL20                                                             
*                                                                               
*                                                                               
XLOCAL   DS    0X                  LOCAL STORAGE                                
REQVALS  DS    0A                  REQUEST VALUES                               
REQIND   DS    XL1                                                              
REQAREQ  DS    AL3                                                              
REQVALLQ EQU   *-REQVALS                                                        
                                                                                
X#DUB    DS    D                                                                
X#MWCIND DS    A                                                                
                                                                                
SAVEKEY1 DS    XL(L'IOKEY)                                                      
SAVEKEY2 DS    XL(L'IOKEY)                                                      
SAVEKEY3 DS    XL(L'IOKEY)                                                      
SAVEKEY4 DS    XL(L'IOKEY)                                                      
SAVEKEY5 DS    XL(L'IOKEY)                                                      
*                                                                     i         
X#MAMT   DS    PL6                 MEMO EXPENSE AMOUNT                          
X#CAMT   DS    PL6                 COST AMOUNT                                  
X#SAMT   DS    PL6                 SALES AMOUNT                                 
X#COMAMT DS    PL6                 COMISSION BILLED AMOUNT                      
AC_AMT   DS    PL6                 ADD UP BILLED AMOUNT                         
X#13MDAT DS    XL2                 13 months cut off date                       
X#PTYP   DS    XL1                 JLSD passive type                            
X#PTYPAQ EQU   C'A'                - ACTRECD                                    
X#PTYPSQ EQU   C'S'                - SRCRECD                                    
X#PTYPPQ EQU   C'P'                - PIDRECD                                    
X#PTYPJQ EQU   C'J'                - JDTRECD                                    
X#PTYPDQ EQU   C'D'                - DRAPASD                                    
                                                                                
X#UFLD   DS    0XL10               Brandocean or ...                            
X#UFLDAU DS    0XL10               ... Aura                                     
X#UFLDH1 DS    XL1                                                              
X#UFLDD1 DS    XL1                                                              
X#UFLDH2 DS    XL1                                                              
X#UFLDD2 DS    XL1                                                              
X#UFLDH3 DS    XL1                                                              
X#UFLDD3 DS    XL1                                                              
X#UFRET1 DS    XL1                                                              
X#UFRET2 DS    XL1                                                              
X#UFRET3 DS    XL1                                                              
         DS    XL1                                                              
                                                                                
X#TIME   DS    XL(L'STCTIME)                                                    
X#DATE   DS    XL(L'STCDATE)                                                    
X#DATD   DS    CL10                                                             
X#OFFGRP DS    CL1                                                              
X#MEDGRP DS    CL1                                                              
X#JBIR   DS    CL1                                                              
X#JDSTAT DS    XL1                 Job status filter                            
X#JDSTSU EQU   X'80'                                                            
X#JDSTAP EQU   X'40'                                                            
X#JDSTRE EQU   X'20'                                                            
X#JDSTMA EQU   X'10'                                                            
X#JOBREJ DS    XL2                 Job rejecter                                 
X#CONREJ DS    CL1                 Connected person rejected?                   
*                                                                               
SAVEIND  DS    XL1                 INDICAT THAT IS NOT CLEARED BETWEEN          
*                                  REQUESTS                                     
SAVESTC  EQU   X'80'               DO EXSTIMATE CHKING INST OF JOB DASH         
SAVEAUR  EQU   X'40'               AURA (NOT BRANDOCEAN)                        
SAVEMST  EQU   X'20'               MULTIPLE X#JDSTAT STATUS'                    
SAVEML2  EQU   X'10'               SAVEMST - LAP 2 running                      
SAVERL2  EQU   X'01'               SAVEMST - LAP 2 required                     
SAVEPMA  EQU   X'02'               SAVEMST - PID match: cannot approve          
SAVEXDR  EQU   X'04'               SAVEMST - extra DRAPASD lap required         
SAVEXDL  EQU   X'08'               SAVEMST - extra DRAPASD lap running          
*                                                                               
X#RTTRX  DS    XL(TMSTTABL)        R TIME SETTINGS FROM GETOPT/GETCAP           
X#BTTRX  DS    XL(TMSTTABL)        B TIME SETTINGS FROM GETOPT/GETCAP           
TMSTNU2  EQU   (*-X#RTTRX)/TMSTTABL WHEN DOING ESTIMATE CHECKING                
X#NTTRX  DS    XL(TMSTTABL)        N TIME SETTINGS FROM GETOPT/GETCAP           
TMSTNUM  EQU   (*-X#RTTRX)/TMSTTABL                                             
*                                                                               
X#PGSTAT DS    XL1                                                              
X#JCRE   DS    XL2                                                              
X#JAMD   DS    XL2                                                              
X#JAPP   DS    XL2                                                              
X#PAST   DS    CL1                                                              
X#JDTPAS DS    XL1                                                              
X#JDTPOQ EQU   X'80'                                                            
X#JDTPCQ EQU   X'08'                                                            
X#GAPIND DS    XL1                                                              
X#GAPIDQ EQU   X'80'                                                            
X#GAPIYQ EQU   X'40'                                                            
X#CLVL   DS    XL1                                                              
X#HOFF   DS    CL2                                                              
X#AOFF   DS    CL2                                                              
X#POFF   DS    CL2                                                              
X#OPND   DS    XL3                                                              
X#CLOD   DS    XL3                                                              
X#OPNX   DS    XL3                                                              
X#CLOX   DS    XL3                                                              
X#SRCL   DS    XL1                                                              
X#HIGH   DS    CL1                                                              
X#TSAYN  DS    CL1                                                              
X#COFF   DS    CL2                                                              
X#RUFI   DS    XL10                                                             
X#SVDT   DS    XL3                                                              
X#JREJ   DS    CL1                                                              
X#JSRC   DS    XL1                                                              
X#MEDC   DS    CL1                                                              
X#MEDG   DS    CL1                                                              
X#OFFG   DS    CL1                                                              
X#ELCNT  DS    PL2                                                              
X#URKEY  DS    0XL42                                                            
X#MEDNO  DS    XL1                                                              
X#MEDLS  DS    CL41                                                             
X#MLLST  DS    XL37                                                             
X#CLIC   DS    CL6                                                              
X#PROC   DS    CL6                                                              
X#JOBC   DS    CL6                                                              
X#JOBBO  DS    CL1                                                              
X#MLLIU  DS    CL1                                                              
X#JLLIU  DS    CL1                                                              
X#WCTIE  DS    CL1                                                              
X#PIDAP  DS    XL2                                                              
X#PIDRJ  DS    XL2                                                              
X#PIDSU  DS    XL2                                                              
X#ACTAP  DS    XL2                                                              
X#ACTRJ  DS    XL2                                                              
X#ACTSU  DS    XL2                                                              
X#RPAS   DS    0XL2                                                             
X#RPRE   DS    CL1                                                              
X#RSUF   DS    CL1                                                              
X#CALLER DS    XL1                                                              
X#PL16   DS    PL16                                                             
X#PL06   DS    PL6                                                              
X#TEST   DS    PL6                                                              
X#TUOR   DS    PL6                                                              
X#TCRE   DS    PL6                                                              
X#TDEB   DS    PL6                                                              
X#CEAMBR DS    PL3                                                              
X#CERED  DS    PL3                                                              
                                                                                
X#CURWC  DS    CL2                                                              
X#CURCR  DS    PL4                                                              
X#CURFL  DS    CL1                                                              
X#FBADV  DS    CL1                                                              
X#CURTA  DS    0PL16                                                            
X#PASSTA DS    XL2                                                              
X#PASEND DS    XL2                                                              
X#ACT    DS    CL12                                                             
                                                                                
X#LLTABS DS    0C                                                               
X#LLTCPJ DS    CL1                                                              
X#LLTMED DS    CL1                                                              
X#LLTLNQ EQU   *-X#LLTABS                                                       
X#LLALLQ EQU   C'A'                                                             
X#LLNONQ EQU   C'N'                                                             
                                                                                
X#JSNAMS DS    0XL((5*(10+1))+1)   ORG up to X#ESTINF                           
X#JSNAL  DS    XL1                                                              
X#JSNAM  DS    CL10                                                             
X#JSNAM# DS    XL1                                                              
X#JSNAL1 DS    XL1                                                              
X#JSNAM1 DS    CL10                                                             
X#JSNAL2 DS    XL1                                                              
X#JSNAM2 DS    CL10                                                             
X#JSNAL3 DS    XL1                                                              
X#JSNAM3 DS    CL10                                                             
X#JSNAL4 DS    XL1                                                              
X#JSNAM4 DS    CL10                                                             
         ORG   X#JSNAMS                                                         
X#CACODE DS    CL14                                                             
X#CANAME DS    CL36                                                             
X#WCCODE DS    CL2                                                              
X#WCTYPE DS    CL1                                                              
X#WCDESC DS    CL15                                                             
X#BILPID DS    0XL(2+8+16+16)                                                   
X#BILPX  DS    XL2                                                              
X#BILPC  DS    CL8                                                              
X#BILPF  DS    CL16                                                             
X#BILPL  DS    CL16                                                             
*                                                                               
X#ESTINF DS    0X                                                               
X#ESGLO  DS    CL6                 GLOBAL ESTIMATE NUMBER                       
X#ESLOC  DS    XL1                 LOCAL ESTIMATE NUMBER                        
X#ESCUR  DS    CL3                 ESTIMATE CURRENCY                            
X#ESXRT  DS    XL7                 ESTIMATE CURRENCY RATE                       
X#ESSTA  DS    XL1                 STATUS                                       
X#ESDES  DS    CL50                ESTIMATE DESCRIPTION                         
X#ESLNQ  EQU   *-X#ESTINF                                                       
*                                                                               
X#UFCMQ  EQU   10                                                               
X#UFLS   DS    (X#UFCMQ)CL(UFSDATMX)                                            
X#UFLQ   EQU   *-X#UFLS                                                         
*                                                                               
**GETDDT SAVE VALUES                                                            
MEDDESC  DS    CL(L'PMDDESC)       MEDIA DESCRIPTION (SR CONTRA)                
*                                                                               
SAVAMT   DS    PL(L'TRNAMNT)       SAVED PAYMENT AMOUNT                         
PAIDTOT  DS    PL(L'TRNAMNT)       TOTAL PAID SO FAR                            
WRITTOT  DS    PL(L'TRNAMNT)       WRITE OFF TOTAL                              
                                                                                
***********************************************************************         
* REQUEST IN/OUT DEFINITION IN STORAGE                                *         
***********************************************************************         
                                                                                
RQ_VALS  DS    0X                  ** REQUEST VALUES                            
RQ_TYPE  DS    XL1                 - REQUEST TYPE                               
RQ_DATA  DS    0XL1                - REQUEST DATA                               
                                                                                
* JOB AUDIT AND APPROVER VALUES                                                 
RQ_JAACT DS    CL12                                                             
RQ_JAOFF DS    CL2                                                              
RQ_JAUL  DS    CL2                                                              
         ORG   RQ_DATA                                                          
                                                                                
* JOBBAG VALUES                                                                 
RQ_JBTYP DS    CL1                 REQUEST TYPE                                 
RQ_JBWCS EQU   C'S'                - work code summary                          
RQ_JBWCX EQU   C'X'                - work code summary extended                 
RQ_JBWCD EQU   C'D'                - work code details                          
RQ_JBWCW EQU   C'W'                - work code details extended                 
RQ_JBACC EQU   C'A'                - accounting details                         
RQ_JBBIL EQU   C'B'                - billing view                               
RQ_JBACT DS    CL12                SJ ACCOUNT CODE                              
RQ_JBWRK DS    CL2                 WORK CODE                                    
RQ_JBHRS DS    CL1                 HOURS Y/N                                    
RQ_JBMEM DS    CL1                 MEMO ORDERS Y/N                              
RQ_JBOFF DS    CL2                 OFFICE CODE OF JOB                           
RQ_ESTCH DS    CL1                 PERFORM ESTIMATE CHECK                       
RQ_CONTI DS    CL1                 INCLUDE CONTINGENCY                          
         ORG   RQ_DATA                                                          
                                                                                
* USER FIELD VALUES                                                             
RQ_UFCLI DS    CL5                 CLIENT                                       
*&&UK                                                                           
RQ_UFPRO DS    CL2                 PRODUCT                                      
*&&                                                                             
*&&US                                                                           
RQ_UFPRO DS    CL3                 PRODUCT                                      
*&&                                                                             
RQ_UFJOB DS    CL7                 JOB                                          
RQ_UFOFF DS    CL2                 OFFICE                                       
RQ_UFODT DS    CL8                 JOB OPEN DATE                                
         ORG   RQ_DATA                                                          
                                                                                
* JOB LIST AND SEARCH VALUES                                                    
RQ_JDCLC DS    CL5                 - JOB LIST/SEARCH: CLIENT CODE               
RQ_JDLST DS    CL1                 - JOB LIST/SEARCH: INCL LOCKED Y/N/O         
RQ_ONLYQ EQU   C'O'                                                             
RQ_JDCST DS    CL1                 - JOB LIST/SEARCH: SHOW CLOSED Y/N/B         
RQ_BOTHQ EQU   C'B'                                                             
RQ_JDF1V DS    CL1                 - JOB LIST/SEARCH: FILTER 1 VALUE            
RQ_JDF2V DS    CL1                 - JOB LIST/SEARCH: FILTER 2 VALUE            
RQ_JDF3V DS    CL1                 - JOB LIST/SEARCH: FILTER 3 VALUE            
RQ_JDF4V DS    CL1                 - JOB LIST/SEARCH: FILTER 4 VALUE            
RQ_JDF5V DS    CL1                 - JOB LIST/SEARCH: FILTER 5 VALUE            
*Q_JDMED DS    CL1                 - JOB LIST/SEARCH: MEDIA CODE FILTER         
RQ_JDMIN DS    X                   - JOB LIST/SEARCH: MEDIA CODE ARRAY          
RQ_JDMAD DS    AL3                                                              
*&&UK                                                                           
RQ_JDPRO DS    CL2                 - JOB LIST/SEARCH: PRODUCT FILTER            
*&&                                                                             
*&&US                                                                           
RQ_JDPRO DS    CL5                 - JOB LIST/SEARCH: PRODUCT FILTER            
*&&                                                                             
RQ_JDOPN DS    CL8                 - JOB LIST/SEARCH: OPEN DATE START           
RQ_JDOPX DS    CL8                 - JOB LIST/SEARCH: OPEN DATE END             
RQ_JDCLO DS    CL8                 - JOB LIST/SEARCH: CLOSE DATE START          
RQ_JDCLX DS    CL8                 - JOB LIST/SEARCH: CLOSE DATE END            
*Q_JDNAM DS    CL10                - JOB LIST/SEARCH: NAME SEARCH               
RQ_JDNIN DS    X                   - JOB LIST/SEARCH: NAME ARRAY                
RQ_JDNAD DS    AL3                                                              
RQ_JDUF1 DS    CL30                - JOB LIST/SEARCH: USER FIELD 1              
RQ_JDUF2 DS    CL30                - JOB LIST/SEARCH: USER FIELD 2              
RQ_JDUF3 DS    CL30                - JOB LIST/SEARCH: USER FIELD 3              
RQ_JDUF4 DS    CL30                - JOB LIST/SEARCH: USER FIELD 4              
RQ_JDUF5 DS    CL30                - JOB LIST/SEARCH: USER FIELD 5              
RQ_JDUF6 DS    CL30                - JOB LIST/SEARCH: USER FIELD 6              
RQ_JDUF7 DS    CL30                - JOB LIST/SEARCH: USER FIELD 7              
RQ_JDUF8 DS    CL30                - JOB LIST/SEARCH: USER FIELD 8              
RQ_JDUF9 DS    CL30                - JOB LIST/SEARCH: USER FIELD 9              
RQ_JDUF0 DS    CL30                - JOB LIST/SEARCH: USER FIELD 10             
RQ_JDDRA DS    CL1                 - JOB LIST/SEARCH: DRAFT ACCOUNTS            
RQ_JDUIN DS    X                   - JOB LIST/SEARCH: Aura user fields          
RQ_JDUAD DS    AL3                                    headers and data          
RQ_JDUMX EQU   3                                                                
UFSDATMX EQU   30                                                               
UFSTYPEL EQU   1                                                                
RQ_USFDA EQU   C'D'                  - DATE TYPE                                
RQ_USFAL EQU   C'L'                  - ALPHANUMERIC CHARACTERS                  
RQ_USFNM EQU   C'N'                  - NUMERIC CHARACTERS                       
                                                                                
RQ_JDSIN DS    X                   - JOB LIST/SEARCH: STATUS ARRAY              
RQ_JDSAD DS    AL3                                                              
RQ_JDSPC DS    CL8                 - JOB LIST/SEARCH: SUBMITTER CODE            
RQ_JDAPC DS    CL8                 - JOB LIST/SEARCH: APPROVER CODE             
RQ_JDRPC DS    CL8                 - JOB LIST/SEARCH: REJECTER CODE             
                                                                                
RQ_JDEPC DS    CL1                 CHARGES/ORDERS/ESTIMATES: Y/N                
                                                                                
RQ_JDTYP DS    CL1                 - JOB LIST/SEARCH: NEW TYPE                  
RQ_JDTNQ EQU   X'40'                 - OLD REQUEST                              
RQ_JDT1Q EQU   C'1'                  - USER APPROVED (BY STATUS)                
RQ_JDT2Q EQU   C'2'                  - USER REJECTED (BY STATUS)                
RQ_JDT3Q EQU   C'3'                  - USER NEEDS TO APPROVE (STATUS)           
RQ_JDT4Q EQU   C'4'                  - USER ADDED/=DRAFT (BY STATUS)            
RQ_JDT5Q EQU   C'5'                  - USER ADDED/=REJECTED (BY STATUS)         
RQ_JDT6Q EQU   C'6'                  - USER ADDED/=APPROVED (BY STATUS)         
RQ_JDT7Q EQU   C'7'                  - USER ASSIGNED TO JOB                     
RQ_JDGAO DS    CL1                 - GAOV CALL Y/N                              
RQ_OPENS DS    CL1                 - JOB LIST/SEARCH: OPEN FOR ESTIMAT          
RQ_OPENO DS    CL1                 - JOB LIST/SEARCH: OPEN FOR ORDERS           
RQ_OPENX DS    CL1                 - JOB LIST/SEARCH: OPEN FOR EXTERN           
RQ_OPENB DS    CL1                 - JOB LIST/SEARCH: OPEN FOR BILLING          
RQ_OPENA DS    CL1                 - JOB LIST/SEARCH: OPEN FOR ADJUST           
RQ_OPENT DS    CL1                 - JOB LIST/SEARCH: OPEN FOR TIMEST           
RQ_JDOVR DS    CL1                 - OVERRIDE LIMIT LIST                        
                                                                                
RQ_JDOFF DS    CL2                 - Office filter                              
RQ_JDJOB DS    CL7                 - JOB LIST/SEARCH: JOB CODE                  
RQ_JDPAY DS    CL1                 - Show Payments totals                       
                                                                                
RQMAXQ   EQU   *-RQ_DATA+64        <--- ADJUST FOR BIG RQ ENTRIES               
                                                                                
         ORG   RQ_DATA+RQMAXQ                                                   
                                                                                
         EJECT                                                                  
SAVEVALS DS    0X                                                               
                                                                                
JA_VALS  DS    0X                  JOB AUDIT CALL                               
JA_FRS   DS    CL1                 FROM STATUS                                  
JA_TOS   DS    CL1                 TO STATUS                                    
JA_DTE   DS    XL3                 DATE                                         
JA_TIM   DS    CL6                 TIME                                         
JA_USR   DS    CL10                USER ID                                      
JA_PID   DS    CL8                 PERSON CODE                                  
JA_PER   DS    CL16                PERSON FIRST NAME                            
JA_PEL   DS    CL16                PERSON LAST NAME                             
JA_COM   DS    CL50                COMMENT                                      
JA_PEM   DS    CL16                PERSON MIDDLE NAME                           
JA_TYP   DS    XL1                 TYPE - SEE STCATYP                           
JA_STA   DS    CL1                 STATUS CHANGE - ACBRA29 QA_ASTAT             
JA_ACT   DS    XL1                 ACTION - SEE STCASTAT                        
JA_APPL  DS    XL1                 APPLICATION - SEE STCASTAT                   
JA_DATA  DS    CL200               DATA                                         
JA_LNQ   EQU   *-JA_VALS                                                        
         ORG   SAVEVALS                                                         
                                                                                
JP_VALS  DS    0X                  JOB APPROVER CALL                            
JP_CPC   DS    CL8                 CREATOR PERSON CODE, FIRST NAME,             
JP_CPF   DS    CL16                LAST NAME AND EMAIL ADDRESS                  
JP_CPL   DS    CL16                                                             
JP_CEM   DS    CL44                                                             
JP_APC   DS    CL8                 APPROVER PERSON CODE, FIRST NAME,            
JP_APF   DS    CL16                LAST NAME AND EMAIL ADDRESS                  
JP_APL   DS    CL58                                                             
JP_AEM   DS    CL44                                                             
JP_LVL   DS    CL1                 APPROVER LEVEL                               
JP_APM   DS    CL16                                                             
JP_LNQ   EQU   *-JP_VALS                                                        
         ORG   SAVEVALS                                                         
                                                                                
JB_VALS  DS    0X                  JOB BAG CALL                                 
JB_TYPE  DS    CL1                 TYPE                                         
JB_EORI  DS    CL1                 INTERNAL OR EXTERNAL                         
JB_WCOD  DS    CL2                 WORK CODE                                    
JB_WDES  DS    CL15                WORK CODE DESCRIPTION                        
JB_WCMI  DS    CL1                 MULTIPLE W/C INDICATOR                       
JB_ESTA  DS    PL6                 ESTIMATE AMOUNT                              
JB_DEBA  DS    PL6                 DEBIT AMOUNT                                 
JB_CREA  DS    PL6                 CREDIT AMOUNT                                
JB_ALLA  DS    PL6                 ALLOCATED AMOUNT                             
JB_GROS  DS    PL6                 GROSS AMOUNT                                 
JB_CHTI  DS    PL6                 CHARGEABLE TIME                              
JB_COMM  DS    PL6                 COMMISSION AMOUNT                            
JB_ORDA  DS    PL6                 ORDER AMOUNT                                 
JB_HOUR  DS    PL6                 HOURS                                        
JB_DTYP  DS    CL1                 DETAILS TYPE                                 
JB_CACC  DS    CL14                CONTRA ACCOUNT CODE                          
JB_CACN  DS    CL36                CONTRA ACCOUNT NAME                          
JB_DATE  DS    XL3                 DATE                                         
JB_REFN  DS    CL20                REFERENCE NUMBER                             
JB_INTR  DS    CL9                 INTERNAL REFERENCE                           
JB_TDEB  DS    PL6                 TRANSACTION DEBIT                            
JB_TCRE  DS    PL6                 TRANSACTION CREDIT                           
JB_TALL  DS    PL6                 transaction allocation                       
JB_THRS  DS    PL6                 transaction hours                            
JB_MHRS  DS    PL6                 memo hours                                   
JB_OAMT  DS    PL6                 order amount                                 
JB_OINV  DS    PL6                 order invoiced                               
JB_ESTN  DS    CL6                 estimate number                              
JB_ESTD  DS    CL50                estimate description                         
JB_ESTL  DS    CL3                 local estimate number                        
JB_ESTS  DS    CL1                 status (C or S)                              
JB_ECLIA EQU   C'C'                Client approved                              
JB_ESUBM EQU   C'S'                Submitted                                    
JB_ETYP  DS    CL3                 expenditure type                             
JB_ORDN  DS    CL6                 order number                                 
JB_REQN  DS    CL8                 requisition number                           
JB_TAST  DS    CL1                 transaction approval status                  
JB_TAIPQ EQU   C'1'                1 = in progress                              
JB_TASUQ EQU   C'2'                2 = submitted                                
JB_TAPAQ EQU   C'3'                3 = part approved                            
JB_TAAPQ EQU   C'4'                4 = fully approved                           
JB_TARJQ EQU   C'5'                5 = rejected                                 
JB_TFCC  DS    CL3                 transaction FC code                          
JB_TFCA  DS    PL6                 transaction FC amount (net)                  
JB_TVAT  DS    PL6                 transaction bill VAT                         
JB_TGRS  DS    PL6                 transaction bill gross                       
JB_BPCD  DS    CL8                 transaction biller person code               
JB_BPFN  DS    CL16                and                                          
JB_BPLN  DS    CL16                names                                        
JB_NARR  DS    CL101               narrative                                    
JB_BSTA  DS    CL1                 Billing status                               
JB_CORA  DS    PL6                 Commission rate                              
JB_TCOM  DS    PL6                 transaction commission amount                
JB_TFCR  DS    XL7                 transaction FC exchange rate                 
JB_CASR  DS    PL6                 charges amount sales rate                    
JB_CACR  DS    PL6                 charges amount cost rate                     
JB_COMB  DS    PL6                 Commission billed                            
JB_INVN  DS    CL(L'REBKNUM)       Invoice number (7 bytes)                     
JB_DSTAT DS    CL1                 DEBTOR STATUS OF BILL                        
DTFUPAD  EQU   C'1'                -FULLY PAID                                  
DTPPAYD  EQU   C'2'                -PART PAID                                   
DTOUST   EQU   C'3'                -OUTSTANDING                                 
JB_PAYD  DS    PL(L'SCIAMNT)       AMOUNT PAID SO FAR(6 BYTES)                  
JB_WRIOF DS    PL(L'SCIAMNT)       WRITE OFF AMOUNT                             
JB_LPAYD DS    CL3                 LAST PAY DATE                                
JB_BILNO DS    CL6                 Bill number (multiple)                       
JB_USRID DS    XL2                 User id number                               
JB_LNQ   EQU   *-JB_VALS                                                        
         ORG   SAVEVALS                                                         
                                                                                
UF_VALS  DS    0X                  USER FIELDS                                  
UF_TYP   DS    CL1                 type (D/L/N)                                 
UF_COD   DS    CL2                 code                                         
UF_HDR   DS    CL12                header                                       
UF_MAX   DS    CL2                 max. length                                  
UF_COM   DS    CL1                 compulsory (Y/N)                             
UF_OFF   DS    CL2                 office for return                            
UF_LNQ   EQU   *-UF_VALS                                                        
         ORG   SAVEVALS                                                         
                                                                                
JD_VALS  DS    0X                  JOB LIST/SEARCH RETURN DATA                  
JD_CLI   DS    CL5                 client code                                  
*&&UK                                                                           
JD_PRO   DS    CL2                 product code                                 
*&&                                                                             
*&&US                                                                           
JD_PRO   DS    CL3                 product code                                 
*&&                                                                             
JD_JOB   DS    CL7                 job code                                     
JD_CLN   DS    CL36                client name                                  
JD_PRN   DS    CL36                product name                                 
JD_JON   DS    CL36                job name                                     
JD_JOF   DS    CL36                job foreign name                             
JD_JOBL  DS    CL1                 job locked status                            
JD_MED   DS    CL1                 media code                                   
JD_MEN   DS    CL12                media name                                   
JD_OFF   DS    CL2                 office code                                  
JD_OFN   DS    CL36                office name                                  
JD_ODT   DS    PL3                 open date                                    
JD_CDT   DS    PL3                 close date                                   
JD_CUR   DS    CL3                 currency                                     
JD_IFU   DS    CL1                 IsForeignUser                                
JD_STA   DS    CL6                 status                                       
JD_F15   DS    CL5                 filters 1-5                                  
JD_UF1   DS    CL30                user field #1                                
JD_UF2   DS    CL30                user field #2                                
JD_UF3   DS    CL30                user field #3                                
JD_UF4   DS    CL30                user field #4                                
JD_UF5   DS    CL30                user field #5                                
JD_UF6   DS    CL30                user field #6                                
JD_UF7   DS    CL30                user field #7                                
JD_UF8   DS    CL30                user field #8                                
JD_UF9   DS    CL30                user field #9                                
JD_UF0   DS    CL30                user field #10                               
JD_LAD   DS    XL3                 last activity date                           
JD_LAX   DS    XL2                 last activity binary pid code                
JD_LAC   DS    CL8                 last activity person code                    
JD_LAF   DS    CL16                                                             
JD_LAM   DS    CL16                                                             
JD_LAL   DS    CL58                                                             
JD_IDN   DS    CL4                 job ID number                                
JD_CPX   DS    XL2                 job created by person code                   
JD_CPC   DS    CL8                                                              
JD_CPF   DS    CL16                                                             
JD_CPM   DS    CL16                                                             
JD_CPL   DS    CL58                                                             
JD_APX   DS    XL2                 job approved by person code                  
JD_APC   DS    CL8                                                              
JD_APF   DS    CL16                                                             
JD_APM   DS    CL16                                                             
JD_APL   DS    CL58                                                             
JD_CAM   DS    XL4                 campaign code                                
JD_CNA   DS    CL36                campaign name                                
JD_EPC   DS    PL6                 estimate % committed (%)                     
JD_COL   DS    CL1                 colour code                                  
JD_COLWQ EQU   C'1'                (1=white, 2=green, 3=amber, 4=red)           
JD_COLGQ EQU   C'2'                                                             
JD_COLAQ EQU   C'3'                                                             
JD_COLRQ EQU   C'4'                                                             
JD_CCLSE DS    CL1                 Job can be closed Y/N?                       
JD_LOCES DS    CL1                 locked from estimates                        
JD_LOCOR DS    CL1                 locked from orders                           
JD_LOCEX DS    CL1                 locked from expenses                         
JD_LOCBI DS    CL1                 locked from billing                          
JD_LOCAD DS    CL1                 locked from adjustments                      
JD_LOCTI DS    CL1                 locked from timesheets                       
JD_FEE   DS    PL6                 amount                                       
JD_MAST  DS    CL1                 job is master                                
JD_MACC  DS    CL14                master job account                           
JD_CDELT DS    CL1                 Job can be deleted Y/N?                      
JD_AUTO  DS    CL1                 Auto number is use Y/N?                      
JD_DRFT  DS    CL1                 Draft jobs Y/N/D?                            
JD_ESDR  DS    CL1                 Estimates allowed to use draft jobs?         
JD_BEST  DS    CL1                 BrandOcean estimates exist on job            
*&&US                                                                           
JD_EXJB  DS    CL1                 Expense job                                  
*&&                                                                             
JD_AUFH1 DS    CL12                UserField Header (1, Aura)                   
JD_AUFD1 DS    CL30                UserField Data (1, Aura)                     
JD_AUFH2 DS    CL12                UserField Header (2, Aura)                   
JD_AUFD2 DS    CL30                UserField Data (2, Aura)                     
JD_AUFH3 DS    CL12                UserField Header (3, Aura)                   
JD_AUFD3 DS    CL30                UserField Data (3, Aura)                     
JD_NETBL DS    PL6                 Net billed                                   
JD_ACTLS DS    PL6                 Actuals                                      
JD_ORDRS DS    PL6                 Orders                                       
JD_ESTMD DS    PL6                 Estimated                                    
JD_PAYTA DS    PL6                 Payments total amount                        
JD_AMBR  DS    PL3                 Amber percentage warning                     
JD_RED   DS    PL3                 Red percentage warning                       
JD_LNQ   EQU   *-JD_VALS                                                        
                                                                                
OLDJDTL  DS    XL(ONEK)            Area to hold last time job details           
ES_BUFF  DS    XL500               Buffer area for estimates                    
XLOCALNQ EQU   *-XLOCAL                                                         
                                                                                
SAVEDLNQ EQU   *-SAVED                                                          
                                                                                
***********************************************************************         
* included books and DSECTS                                           *         
***********************************************************************         
                                                                                
***********************************************************************         
* Approval hierarchy search table DSECT                               *         
***********************************************************************         
APRTABD  DSECT                                                                  
APRSTAT  DS    XL1                 Levels to include                            
APRCLI   EQU   X'80'               Client                                       
APRPRO   EQU   X'40'               Product                                      
APRJOB   EQU   X'20'               Job                                          
APRMED   EQU   X'10'               Media                                        
APROFF   EQU   X'08'               Office                                       
APRLVL   DS    CL1                 Level of approver                            
APRTABL  EQU   *-APRTABD                                                        
                                                                                
ELMTABD  DSECT                                                                  
ELMDATA  DS    0CL32                                                            
         DS    CL4                                                              
ELMCODE  DS    CL2                                                              
ELMDESC  DS    CL12                                                             
ELMEDIT  DS    CL8                                                              
ELMMAXL  DS    XL1                                                              
ELMSTAT  DS    XL1                                                              
         DS    CL4                                                              
ELMLNG   EQU   *-ELMDATA                                                        
                                                                                
WCSTABD  DSECT                                                                  
WCSTWCD  DS    CL2                                                              
WCSTEOT  EQU   FF                                                               
WCSTCEA  DS    PL6                                                              
WCSTDBA  DS    PL6                                                              
WCSTCRA  DS    PL6                                                              
WCSTALA  DS    PL6                                                              
WCSTORA  DS    PL6                                                              
WCSTHRS  DS    PL6                                                              
WCSTCCR  DS    PL6                                                              
WCSTCPR  DS    PL6                                                              
WCSTCHT  DS    PL6                                                              
WCSTCOM  DS    PL6                                                              
WCSTCOB  DS    PL6                                                              
WCSTSTA  DS    XL1                                                              
WCSTLNQ  EQU   *-WCSTABD                                                        
*                                                                               
EST_D    DSECT                                                                  
ESTTLEN  DS    XL2                 WORKCODE FOR ESTIMATE                        
ESTTKEY  DS    0X                                                               
ESTTWCD  DS    CL2                 WORKCODE FOR ESTIMATE                        
ESTTKYL  EQU   *-ESTTKEY                                                        
ESTTGLO  DS    CL6                 GLOBAL ESTIMATE NUMBER                       
ESTTLOC  DS    XL1                 LOCAL ESTIMATE NUMBER                        
ESTTCUR  DS    CL3                 ESTIMATE CURRENCY                            
ESTTXRT  DS    XL7                 ESTIMATE CURRENCY RATE                       
ESTTSTA  DS    XL1                 STATUS                                       
ESTTDES  DS    CL50                ESTIMATE DESCRIPTION                         
ESTTAMT  DS    PL6                 AMOUNT OF ESTIMATE                           
ESTTFCA  DS    PL6                 AMOUNT OF ESTIMATE FOREIGN CURRENCY          
ESTTALA  DS    PL6                 BILLED ALLOCATION                            
ESTTCOM  DS    PL6                 COMMISSION INCLUDED                          
ESTTCOB  DS    PL6                 COMMISSION BILLED                            
ESTTLN1Q EQU   *-EST_D             LENGTH OF ESTIMATE ENTRY MINUS BILLS         
ESTTBLN  DS    CL6                 REPEATING BILL NUMBER ENTRY                  
*                                                                               
JSBD_D   DSECT                                                                  
JSBDLEN  DS    XL2                 Job Search Buffered Details                  
JSBDKEY  DS    0X                                                               
JSBDTYP  DS    CL1                 Type                                         
JSBDTCQ  EQU   C'C'                - Client                                     
JSBDTPQ  EQU   C'P'                - Product                                    
JSBDTOQ  EQU   C'O'                - Office                                     
JSBDTMQ  EQU   C'M'                - Media                                      
JSBDTXQ  EQU   C'X'                - Security person hex                        
JSBDTSQ  EQU   C'S'                - Security person char                       
JSBDCOD  DS    CL12                Client/Product/Office/Media/PID              
JSBDKYL  EQU   *-JSBDKEY                                                        
JSBDATA  DS    0X                                                               
JSBDMGR  DS    0CL1                Status - or office resp. media group         
JSBDOGR  DS    0CL1                                                             
JSBDSTA  DS    XL1                                                              
JSBDOFF  DS    CL2                 Office                                       
JSBDNAM  DS    CL36                Name                                         
JSBDXDB  DS    XL(GOXDBCLQ)        GETOPT extra data block                      
JSBDLNQ  EQU   *-JSBD_D                                                         
         ORG   JSBDATA                                                          
JSBDPIX  DS    0XL2                Hex PID                                      
JSBDPID  DS    CL8                 Character PID                                
JSBDPFN  DS    CL16                First name                                   
JSBDPMN  DS    CL16                Middle name                                  
JSBDPLN  DS    CL58                Last name                                    
*                                                                               
STCTABD  DSECT                                                                  
STCTBTYP DS    XL1                 STCELD TYPE FOR ACCOUNTS                     
STCTIND  DS    XL1                 INDICATOR                                    
STCTOUTP EQU   X'80'               OUTPUT IN ROUTINE                            
STCTBRT  DS    XL2                 ROUTINE DISPLACEMENT TO GET DATA             
STCTABL  EQU   *-STCTABD                                                        
*                                                                               
ELES_DS  DSECT                                                                  
ELESDCLI DS    CL5                 Saved client code                            
ELESDCST DS    XL1                 and its name/office/saved details            
ELESDCOF DS    CL2                                                              
ELESDCLN DS    CL36                                                             
ELESDCXD DS    XL(GOXDBCLQ)                                                     
*&&UK                                                                           
ELESDPRO DS    CL2                 Saved product code                           
*&&                                                                             
*&&US                                                                           
ELESDPRO DS    CL3                                                              
*&&                                                                             
ELESDPST DS    XL1                                                              
ELESDPOF DS    CL2                 and its name/office/saved details            
ELESDPRN DS    CL36                                                             
ELESDPXD DS    XL(GOXDBCLQ)                                                     
ELESPLNQ EQU   *-ELESDPRO                                                       
*                                                                               
* ACBRAWRKD and ACGOXDBLK                                                       
*                                                                               
         PRINT OFF                                                              
       ++INCLUDE ACBRAWRKD                                                      
       ++INCLUDE ACGOXDBLK                                                      
*PREFIX=P_                                                                      
       ++INCLUDE DDDPRINTL         For request details logging/trace            
*PREFIX=                                                                        
         PRINT ON                                                               
*                                                                               
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'102ACBRA19   11/20/17'                                      
         END                                                                    
