*          DATA SET SPREPB102  AT LEVEL 177 AS OF 01/19/21                      
*PHASE SPB102M                                                                  
*INCLUDE COVAIL                                                                 
*INCLUDE DDUCOM                                                                 
*INCLUDE FINDOUT                                                                
*INCLUDE GETUSER                                                                
*INCLUDE PRTREC                                                                 
*INCLUDE SPB1WI                                                                 
*INCLUDE SPFMTINO                                                               
*INCLUDE XSORTL                                                                 
*                                                                               
***********************************************************************         
* USER    JIRA       DATE                  CHANGE LOG                 *         
* ---- ----------  -------- ----------------------------------------- *         
* SMUR SPEC-47099  21.1     ADD OFFICES WB, RH, XW FOR AGY OO         *         
* YKVA SPEC-34078  20.3     UCOMM BILL CONTROL EST FILTER BUG         *         
* SMUR SPEC-42248  20.3     SHOW TOTAL CREDIT AMOUNT IN PARENTH B8PR6 *         
* SMUR SPEC-43756  20.3     RELAX UCOMM RULES                         *         
* YKVA SPEC-42549  20.1     ADD CLT WNO TO WB LIST FOR AGY OO         *         
* YKVA SPEC-43353  20.1     ADD CLT WHO TO WB LIST FOR AGY OO         *         
* MZEI SPEC-42186  20.1     WRITE OUT COPY RECORD IN RECOVERY         *         
* SMUR SPEC-37312  10/29/19 UCOMM BILL CONTROL NUMBER 1-4 (20.1)      *         
* SMUR SPEC-31828  06/20/19 EST OR PROD UDEF ON CLT LEVEL BILLING 19.3*         
* SMUR SPEC-33777  05/03/19 ALIGN AMOUNT DUE: FORMAT FOR BILL 8 (19.3)*         
* MZEI SPEC-27371  2/19 INT INCREASE PRODUCT SPLIT MAX TO 20          *         
* SMUR SPEC-32198  02/15/19 REMOVE 2 LEADING SPACES IN EXT CLT NAME   *         
* YKVA SPEC-29021  1/19 INT ADD CLT WBN AND WH9 TO WB LIST FOR AGY OO *         
* SMUR SPEC-16649  02/05/18 READ NEW BILLADR REC B8 PROFILE 3 (18.2)  *         
* YKVA SPEC-12853  18.1     PRNT COMMISSION, NOT BFORM ON COMM ADJ BIL*         
* YKVA SPEC-19585  1/18 INT ADD CLT WB8 TO WB LIST FOR AGY OO         *         
* SMUR SPEC-7723   01/09/17 PRINT EXPANDED CLIENT NAME IF IT EXISTS   *         
* AKAT SPEC-5428   09/20/16 FIX CANADIAN TAX REPORTING BUG FOR ALL PRD*         
* AKAT DSSUP-6785  01/25/16 ADD CLT WB6 TO WB FLIGHT LIST FOR AGY OO  *         
*                                                                     *         
* BPLA    MAR/15  CHANGES TO REQUIRE EST UDEF'S FOR BILLING                     
*                 CONTROLLED BY CLTUDEF INFO                                    
*                                                                               
*  BPLA 12/14  NEW WARNER BROS. CLIENTS FOR OMD (OO)                            
*                                                                               
*  BPLA 10/14  CHANGE TO CALCULATE CANADIAN TAXES ON COST2 $                    
*                                                                               
*  BPLA - QST CHANGES FOR JAN/13                                                
*         SOME OLD ENTRIES IN VCTAB11,12,AND 13 FOR NOVA SCOTIA                 
*         NO-OPED TO ADDRESS AND ISSUE WITH B2A PROFILE OPTION                  
*         PRD/EST/MTH LIST ON AOR BILLS? VALUE C                                
*                                                                               
         TITLE 'SPREPB102 - SPOTPAK BILLING'                                    
SPB102   CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 0,SPB102,R9                                                      
         SPACE 2                                                                
***********************************************************************         
*                                                                               
*   QOPT1 - E=EST PERIOD IS MOS                                                 
*   QOPT2 - BILLING TYPE (1-4)                                                  
*   QOPT3 - N=NON-RETAIL                                                        
*   QOPT4 - RETAIL DRAFT BILLING CONTROL (E=PRINT ERRORS ONLY)                  
*   QOPT5+1 - TYPE OF BILLING IF TRUE SEPARATE COMMISSION OPT                   
*            C=COMMISSION, N=NET, R=REG                                         
*                                                                               
***********************************************************************         
         SPACE 2                                                                
         B     PROC                                                             
PATCH    DC    32X'00'                                                          
*              BYTE  1  - X'80'=TRACE BILL HEADER RECORDS                       
*                       - X'20'=TRACE 0E01 RECS                                 
*                       - X'10'=PRINT USER PROFILES                             
*                       - X'04' SHOW MONTHS OF RETAIL 100% ERRORS               
*                       - X'01'=TRACE GETNUM READS                              
*              BYTE  2  - X'80'=TRACE INPUT RECORDS TO TSAROFF                  
*                                                                               
TRCE     DC    C'N'                PATCH TO Y FOR SORT TRACE                    
         SPACE 2                                                                
PROC     DS    0H                                                               
         L     RA,0(R1)                                                         
         LR    R8,RA                                                            
         AHI   R8,4096                                                          
         USING SPWORKD,RA,R8                                                    
         LA    RC,SPACEND                                                       
         USING BILWRKD,RC                                                       
*                                  SAVE BASE REGS FOR HEADHOOK                  
         L     RF,=A(SAVER8)                                                    
         ST    R8,0(RF)                                                         
         L     RF,=A(SAVERA)                                                    
         ST    RA,0(RF)                                                         
*                                                                               
         BRAS  RE,INISSB           INITIALIZE SSB VALUES                        
*                                                                               
         CLI   MODE,PROCBUY                                                     
         BE    PRBUY                                                            
         BH    *+8                                                              
         MVI   DONESW,C'N'         RESET ON PROCBUY AND 'FRSTS'                 
         CLI   MODE,MKTFRST                                                     
         BE    MKTF                                                             
         CLI   MODE,MKTLAST                                                     
         BE    MKTL                                                             
         CLI   MODE,MGR1FRST                                                    
         BE    MGR1F                                                            
         CLI   MODE,MGR1LAST                                                    
         BE    MGR1L                                                            
         CLI   MODE,MGR2LAST                                                    
         BE    MGR2L                                                            
         CLI   MODE,MGR3LAST                                                    
         BE    MGR3L                                                            
         CLI   MODE,ESTFRST                                                     
         BE    ESTF                                                             
         CLI   MODE,ESTTEST                                                     
         BE    ESTTST                                                           
         CLI   MODE,ESTLAST                                                     
         BE    ESTL                                                             
         CLI   MODE,PGR1FRST                                                    
         BE    PGR1F                                                            
         CLI   MODE,PRDFRST                                                     
         BE    PRDF                                                             
         CLI   MODE,PGR1LAST                                                    
         BE    PGR1L                                                            
         CLI   MODE,PGR2LAST                                                    
         BE    PGR2L                                                            
         CLI   MODE,PGR3LAST                                                    
         BE    PGR3L                                                            
         CLI   MODE,PRDLAST                                                     
         BE    PRDL                                                             
         CLI   MODE,CLTLAST                                                     
         BE    CLTL                                                             
         CLI   MODE,RUNFRST                                                     
         BE    RUNF                                                             
         CLI   MODE,CLTFRST                                                     
         BE    CLTF                                                             
         CLI   MODE,REQFRST                                                     
         BE    REQF                                                             
         CLI   MODE,REQLAST                                                     
         BE    REQL                                                             
         CLI   MODE,RUNLAST                                                     
         BE    RUNL                                                             
         SPACE 2                                                                
EXIT     DS    0H                                                               
         XIT1                                                                   
*                                                                               
*        RUNFRST                                                                
*                                                                               
RUNF     DS    0H                                                               
*                                                                               
* SKIPPED = DATASET FOR UCOM-REJECTED RECORDS                                   
*        OPEN  (SKIPPED,(OUTPUT))                                               
*                                                                               
*                                  SET ADCONS IN COMMON STORAGE                 
         MVC   APATCH,=A(PATCH)                                                 
         MVC   AGDAREA,=A(GDAREAWK)                                             
         MVC   ABUFFC,=A(BUFFALOC)                                              
         MVC   ABFMOD,=A(BFMOD)                                                 
         MVC   ABILLEDI,=A(BILLEDI)                                             
         MVC   ABRKTAB,=A(BRKTAB)                                               
         MVC   AGETNUM,=A(GETNUM)                                               
         L     RF,ADCONLST                                                      
         USING SPADCONS,RF                                                      
         MVC   ASPGTBFR,VSPGTBFR                                                
         MVC   ATSAROFF,TSAROFF                                                 
         DROP  RF                                                               
*                                                                               
         MVI   DASHES,C'-'                                                      
         MVC   DASHES+1(L'DASHES-1),DASHES                                      
         MVC   XXMKT,=H'9998'      SPECIAL BILLING MKT - 9998                   
         MVC   XXSTA,=X'D6B5A4'    SPECIAL STATION - ZZZZ                       
*                                                                               
         MVI   RQMGOPT,C'Y'        MAKEGOODS TO BE IN MISSED MONTH              
*                                  (ALSO CONTROLLED BY CLIENT OPTION)           
         L     RF,=A(LINTAB)                                                    
         LHI   R0,LINTABN                                                       
         MVC   0(132,RF),SPACES                                                 
         LA    RF,132(RF)                                                       
         BCT   R0,*-10                                                          
         MVC   ANXTLIN,=A(LINTAB)                                               
         MVI   PRSW,C'N'                                                        
*                                  GET MEMORY FOR FOTAB AND PEPTAB              
         GOTO1 =V(COVAIL),DMCB,C'GET',800000,800000                             
         OC    4(4,R1),4(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,4(R1)                                                         
         MVC   0(8,RF),=C'*FOTAB**'                                             
         LA    RF,8(RF)                                                         
         ST    RF,AFOTABS                                                       
*                                                                               
         GOTO1 =V(COVAIL),DMCB,C'GET',4000,4000                                 
         OC    4(4,R1),4(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,4(R1)                                                         
         MVC   0(8,RF),=C'*SPBIL**'                                             
         LA    RF,8(RF)                                                         
         ST    RF,ASPBIL                                                        
*                                                    GM % BILLING TAB           
         L     R0,=A(BPCTRLQ*BPCTTBN+8)                                         
         GOTO1 =V(COVAIL),DMCB,C'GET',(R0),(R0)                                 
         OC    4(4,R1),4(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,4(R1)                                                         
         MVC   0(8,RF),=C'*BPCTTB*'                                             
         LA    RF,8(RF)                                                         
         ST    RF,ABPCTTAB                                                      
*                                                                               
         L     R0,=A(PEPTABRL*PEPTBN+8)                                         
         GOTO1 =V(COVAIL),DMCB,C'GET',(R0),(R0)                                 
         OC    4(4,R1),4(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                                                             
         L     RF,4(R1)            START OF CORE                                
         LR    RE,RF                                                            
         A     RE,8(R1)            PLUS LENGTH                                  
*                                                                               
         L     R2,VMASTC           SET END AS NEW DUMP LIMIT                    
         USING MASTD,R2                                                         
         CLI   MCRECOVR,C'W'                                                    
         BNE   *+8                                                              
         MVI   UPDTSOON,C'Y'       UPDATIVE SOON FLAG                           
*                                                                               
         ST    RE,MCDMPEND                                                      
         DROP  R2                                                               
         MVC   0(8,RF),=C'*PEPTAB*'                                             
         LA    RF,8(RF)                                                         
         ST    RF,APEPTAB                                                       
*                                                                               
*                                  SET BINSRCH PARS FOR PEPTAB                  
         SR    R0,R0                                                            
         L     R1,APEPTAB                                                       
         SR    R2,R2                                                            
         LHI   R3,PEPTABRL                                                      
         LHI   R4,PEPTABKL                                                      
         LHI   R5,PEPTBN                                                        
         STM   R0,R5,PEPPARS                                                    
*                                  SET BINSRCH PARS FOR PRD SPLIT TAB           
         SR    R0,R0                                                            
         L     R1,=A(SPLTAB)                                                    
         SR    R2,R2                                                            
         LHI   R3,SPLTABRL                                                      
         LHI   R4,2                KEY LENGTH                                   
         LHI   R5,SPLTPMAX                                                      
         STM   R0,R5,SPLPARS                                                    
*                                  SET BINSRCH PARS FOR A2 RQST TABLE           
         SR    R0,R0                                                            
         L     R1,=A(A2REQTAB)                                                  
         SR    R2,R2                                                            
         LHI   R3,A2REQTBL                                                      
         LHI   R4,A2REQKYL         KEY LENGTH                                   
         LHI   R5,A2REQMAX                                                      
         STM   R0,R5,A2RQPARS                                                   
*                                  SET BINSRCH PARS FOR SKIP TABLE              
         SR    R0,R0                                                            
         L     R1,=A(SKIPTAB)                                                   
         SR    R2,R2                                                            
         LHI   R3,SKIPTABL                                                      
         LHI   R4,SKIPKEYL         KEY LENGTH                                   
         LHI   R5,SKIPMAX                                                       
         STM   R0,R5,SKPPARS                                                    
*                                  SET BINSRCH PARS FOR INVTAB                  
         L     R1,=A(INVTAB)                                                    
         LHI   R3,INVTABRL                                                      
         LHI   R4,INVTABKL                                                      
         LHI   R5,INVTBN                                                        
         STM   R0,R5,INVPARS                                                    
*                                                                               
         SR    R0,R0               SET BINSRCH PARS FOR BHOLDTAB                
         L     R1,=A(BHOLDTAB)                                                  
         SR    R2,R2                                                            
         LHI   R3,BHOLDTRL                                                      
         LHI   R4,BHOLDTKL                                                      
         LHI   R5,BHLTBN                                                        
         STM   R0,R5,BHLPARS                                                    
*                                                                               
         SR    R0,R0               SET BINSRCH PARS FOR BPCTTAB                 
         L     R1,ABPCTTAB                                                      
         SR    R2,R2                                                            
         LHI   R3,BPCTRLQ                                                       
         LHI   R4,BPCTKLQ                                                       
         LHI   R5,BPCTTBN                                                       
         STM   R0,R5,BPCTPARS                                                   
*                                                                               
*                                                                               
         SR    R0,R0               SET BINSRCH PARS FOR BFRTAB                  
         L     R1,=A(BFRTAB)                                                    
         SR    R2,R2                                                            
         LHI   R3,BFRTABL                                                       
         LHI   R4,BFRKLQ                                                        
         LHI   R5,BFRMAX                                                        
         STM   R0,R5,BFRPARS                                                    
*                                                                               
*                                                                               
         SR    R0,R0               SET CLIENT LIST BINSRCH PARS                 
         L     R1,=A(CLTTAB)                                                    
         SR    R2,R2                                                            
         LHI   R3,3                                                             
         LHI   R4,3                                                             
         L     R5,0(R1)            MAX                                          
         LA    R1,4(R1)            START OF TABLE                               
         STM   R0,R5,CLTPARS                                                    
*                                                                               
         SR    R0,R0               SET BINSRCH PARS FOR RETAIL                  
         L     R1,=A(PBLTAB)       PARTIAL BILLING TABLE                        
         SR    R2,R2                                                            
         LHI   R3,8                MGR(4),MKT(2),PRD(1),EST(1)                  
         LHI   R4,8                                                             
         L     R5,0(R1)            MAX                                          
         LA    R1,4(R1)            START OF TABLE                               
         STM   R0,R5,PBLPARS                                                    
*                                                                               
         SR    R0,R0               SET BINSRCH PARS FOR PRD/EST/SCHM            
         L     R1,=A(PESTAB)       (FOR PARTIAL BILLING)                        
         SR    R2,R2                                                            
         LHI   R3,4                PRD(1),EST(1),SCHEME(2)                      
         LHI   R4,2                                                             
         L     R5,0(R1)            MAX                                          
         LA    R1,4(R1)            START OF TABLE                               
         STM   R0,R5,PESPARS                                                    
*                                                                               
         XC    NBUFFADR,NBUFFADR                                                
         XC    NBUFFLN,NBUFFLN                                                  
*                                                                               
         GOTO1 DYNALLOC,DMCB,(C'A',=C'OUT     ')                                
         CLI   DMCB+4,0                                                         
         BE    RUNFX                                                            
         MVI   OUTDDFLG,C'Y'       "OUT" DD STATEMENT IS PRESENT                
         OPEN  (OUT,OUTPUT)        OPEN BILL HEADER BUFFER FILE                 
*                                                                               
RUNFX    DS    0H                                                               
         B     EXIT                                                             
*                                                                               
*        REQFRST                                                                
*                                                                               
REQF     DS    0H                                                               
         MVI   WPPOPT,C'N'                                                      
         CLC   =C'FR',QAGY                                                      
         BE    REQF01                                                           
         CLC   =C'H7',QAGY                                                      
         BE    REQF01                                                           
         CLC   =C'JW',QAGY                                                      
         BE    REQF01                                                           
         CLC   =C'M2',QAGY                                                      
         BE    REQF01                                                           
         CLC   =C'WW',QAGY                                                      
         BE    REQF01                                                           
         CLC   =C'YN',QAGY                                                      
         BE    REQF01                                                           
*                                                                               
         B     *+8                                                              
*                                                                               
REQF01   DS    0H                                                               
         MVI   WPPOPT,C'Y'                                                      
         L     R2,=A(DICSECT)                                                   
         USING DICSECT,R2                                                       
*                                                                               
         XC    DMCB,DMCB                                                        
         LA    R1,DMCB                                                          
         USING DICTATED,R1                                                      
         MVI   DDACTN,DDACTNL      TRANSLATE LIST                               
         MVI   DDRETN,DDCASEU                                                   
         MVI   DDSYS,2                                                          
         MVC   DDLANG,RCLANG                                                    
         LA    RF,DCLIST                                                        
         STCM  RF,7,DDIADR                                                      
         LA    RF,DSLIST                                                        
         STCM  RF,7,DDOADR                                                      
         GOTO1 DICTATE                                                          
         DROP  R1,R2                                                            
*                                                                               
         CLI   INV#ERR,C'Y'        DID ANY PRIOR REQUEST CAUSE...               
         BNE   *+12                ...A GETNUM ERROR?                           
         MVI   ERR,INVNERR         YES: SKIP ALL SUBSEQUENT REQUESTS            
         BRAS  RE,ERRPROC                                                       
*                                                                               
         CLC   QUESTOR(4),=C'*RC*' SPECIAL CR/DB RETAIL?                        
         BE    *+14                                                             
         CLC   QUESTOR(4),=C'*RD*'                                              
         BNE   *+16                                                             
         MVC   QRETCD,QUESTOR+2                                                 
         MVC   QRETOUT,QUESTOR+4                                                
*                                                                               
         MVI   MOLSON,C'N'         SET OFF MOLSON OPTION                        
         MVI   NOCOMOPT,C'N'       SET OFF NO COMMISSION OPTION                 
         XC    PBLPARS+8(4),PBLPARS+8  CLEAR PARTIAL BILLING TABLE              
         MVI   CURTAB+3,2          DEFAULT IS 2 DECIMALS FOR CURED              
         MVI   RQESTTST,C'Y'       SET TO TEST FOR ESTLST INCLUSION             
         XC    INVTABN,INVTABN     CLEAR INVOICE TABLE                          
         XC    BFRTABN,BFRTABN     CLEAR BILFORM TABLE                          
         MVI   BFMIX,C'N'          CLEAR MIXED BF OPTION                        
*                                                                               
*&&DO                                                                           
         CLI   QSTART,X'FA'        FOR Y2K                                      
         BL    REQF1H                                                           
         GOTO1 DATCON,DMCB,(0,QSTART),(X'20',QSTART)                            
         CLC   QSTART+4(2),=C'00'  IF DATCON APPENDED A ZERO DAY                
         BNE   *+10                (BECAUSE ONLY HAVE YYMM)                     
         MVC   QSTART+4(2),SPACES  RESET IT TO SPACES                           
*                                                                               
REQF1H   DS    0H                                                               
         CLI   QEND,X'FA'                                                       
         BL    REQF1J                                                           
         GOTO1 DATCON,DMCB,(0,QEND),(X'20',QEND)                                
*                                                                               
REQF1J   DS    0H                                                               
*&&                                                                             
         MVC   SVQSTART,QSTART     SAVE QSTART/END                              
         MVC   SVQEND,QEND                                                      
         MVC   PAGE,=H'1'                                                       
         MVI   FCRDBUYS,C'Y'       ACTIVATE READING OF BUYS                     
*                                                                               
         CLI   QRETCD,C' '         FOR SPECIAL RETAIL CREDIT/DEBIT              
         BNH   *+8                                                              
         MVI   FCRDBUYS,C'N'       SKIP BUY REC READS                           
*                                                                               
         MVI   FCRDGOAL,C'B'       SET SPONSOR TO RD BILLS FOR MKTLIST          
         MVI   ACTSW,C'N'                                                       
         L     RF,=A(MOSLIST)                                                   
         MVI   0(RF),X'FF'         CLEAR MOS LIST                               
         XC    NBTOTG,NBTOTG       CLEAR REQ CHECKING TOTALS                    
         XC    NBTOTN,NBTOTN                                                    
         XC    NBTOTNC,NBTOTNC                                                  
         XC    OBTOTG,OBTOTG                                                    
         XC    OBTOTN,OBTOTN                                                    
         XC    OBTOTNC,OBTOTNC                                                  
         MVC   SORTTRCE,TRCE                                                    
         MVI   RETDRAFT,C'N'                                                    
         CLC   QPROG,=C'BD'        RETAIL DRAFT RUN                             
         BNE   *+8                                                              
         MVI   RETDRAFT,C'Y'                                                    
         MVC   MOSOPT,QOPT1        SPECIAL MONTH OF SERVICE OPTION              
         CLI   MOSOPT,C' '                                                      
         BH    *+8                                                              
         MVI   MOSOPT,0                                                         
*                                                                               
         MVI   PROOFSW,C'N'                                                     
         CLC   QPROG,=C'D1'        BILLING PROOF RUN                            
         BNE   *+8                                                              
         MVI   PROOFSW,C'Y'                                                     
*                                                                               
         CLI   QINVREG,C'R'        INVOICE REGISTER REQUESTED?                  
         BNE   *+8                                                              
         MVI   DOINVREG,C'Y'       YES                                          
*                                                                               
         MVC   TYPE,QOPT2          BILLING TYPE IS QOPT2                        
         CLI   TYPE,C' '                                                        
         BNE   *+8                                                              
         MVI   TYPE,C'4'                                                        
         CLI   RETDRAFT,C'Y'       SPECIAL TYPE FOR RETAIL DRAFT                
         BNE   *+8                                                              
         MVI   TYPE,C'D'                                                        
*                                                                               
         MVC   SAVTRACE,RCTRACE                                                 
*                                                                               
         CLC   =C'OO',QAGY         OMD                                          
         BE    REQF1J6             YES, THE WB SWITCH IS SET IN CLTF            
*                                                                               
         MVI   SVWBSW,C'N'         CLEAR                                        
         CLC   =C'*B',QAGY                                                      
         BNE   REQF1J2                                                          
         CLC   =C'WB1',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'WB5',QCLT                                                     
         BE    REQF1J5                                                          
*                                                                               
REQF1J2  DS    0H                                                               
*&&DO                                                                           
REQF1J2  CLC   =C'OO',QAGY         OMD                                          
         BNE   REQF1J3                                                          
         CLC   =C'WB2',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'WB3',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'WB4',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'WBD',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'WR2',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'WR3',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'WC2',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'WBN',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'WBV',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'WB6',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'WB8',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'WBJ',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'WNO',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'WHO',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'WH7',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'WH9',QCLT                                                     
         BE    REQF1J5                                                          
*&&                                                                             
*                                                                               
REQF1J3  CLC   =C'M2',QAGY                                                      
         BE    REQF1J4                                                          
         CLC   =C'FR',QAGY                                                      
         BE    REQF1J4                                                          
         CLC   =C'H7',QAGY                                                      
         BE    REQF1J4                                                          
         CLC   =C'W+',QAGY                                                      
         BNE   REQF1J6                                                          
*                                                                               
REQF1J4  CLC   =C'WB8',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'HW8',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'WA9',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'WB9',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'WP9',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'WC9',QCLT                                                     
         BE    REQF1J5                                                          
         CLC   =C'HW9',QCLT                                                     
         BNE   REQF1J6                                                          
*                                                                               
REQF1J5  MVI   SVWBSW,C'Y'         POSSIBLE WB FLIGHT BILLING                   
*                                                                               
REQF1J6  DS    0H                                                               
*                                                                               
         MVI   MSSW,C'N'                                                        
         CLC   =C'H7',QAGY          FOR H7 (MINDSHARE), PC (ZENITH)             
         BNE   REQF1K                                                           
         CLC   =C'BMS',QCLT         PRINT UDEF NEXT TO EST NAME                 
         BE    REQF1L                                                           
         CLC   =C'NV ',QCLT                                                     
         BE    REQF1L                                                           
         CLC   =C'KK ',QCLT                                                     
         BE    REQF1L                                                           
         CLC   =C'NXN',QCLT                                                     
         BE    REQF1L                                                           
         CLC   =C'NXS',QCLT                                                     
         BE    REQF1L                                                           
         CLC   =C'NXW',QCLT                                                     
         BE    REQF1L                                                           
         CLI   QMED,C'T'                                                        
         BNE   REQF1N                                                           
         CLC   =C'NVD',QCLT                                                     
         BE    REQF1L                                                           
*                                                                               
REQF1K   CLC   =C'PC',QAGY                                                      
         BNE   REQF1N                                                           
         CLC   =C'SPA',QCLT                                                     
         BE    REQF1L                                                           
         CLC   =C'SPC',QCLT                                                     
         BE    REQF1L                                                           
         CLC   =C'SPM',QCLT                                                     
         BE    REQF1L                                                           
         CLC   =C'SPN',QCLT                                                     
         BE    REQF1L                                                           
         CLC   =C'SPO',QCLT                                                     
         BE    REQF1L                                                           
         CLC   =C'SPS',QCLT                                                     
         BE    REQF1L                                                           
         CLC   =C'SPV',QCLT                                                     
         BE    REQF1L                                                           
         CLC   =C'SPW',QCLT                                                     
         BE    REQF1L                                                           
         CLC   =C'SPZ',QCLT                                                     
         BNE   REQF1N                                                           
REQF1L   MVI   MSSW,C'Y'                                                        
*                                                                               
REQF1N   MVI   PGSW,C'N'                                                        
         CLC   =C'H9',QAGY          ONLY FOR H9, PG1, PGG  AND PGB              
         BNE   REQF1R                                                           
         CLC   =C'PG1',QCLT         PRINT UDEF NEXT TO PRD NAME                 
         BE    REQF1P                                                           
         CLC   =C'PG6',QCLT         AND PG6                                     
         BE    REQF1P                                                           
         CLC   =C'PG ',QCLT                                                     
         BE    REQF1P                                                           
         CLC   =C'PGB',QCLT                                                     
         BE    REQF1P                                                           
         CLC   =C'PGG',QCLT                                                     
         BNE   REQF1R                                                           
REQF1P   MVI   PGSW,C'Y'                                                        
*                                                                               
REQF1R   MVI   PGSW2,C'N'           SPECIAL P&G FISCAL PERIOD                   
         CLC   =C'H9',QAGY                                                      
         BNE   REQF1T                                                           
*                                                                               
         CLC   =C'BBV',QCLT         BURGER KING CLIENTS TOO                     
         BE    REQF1S                                                           
         CLC   =C'BBI',QCLT                                                     
         BE    REQF1S                                                           
         CLC   =C'BBF',QCLT                                                     
         BE    REQF1S                                                           
         CLC   =C'BBN',QCLT                                                     
         BE    REQF1S                                                           
*                                                                               
         CLC   =C'HPG',QCLT                                                     
         BE    REQF1S                                                           
         CLC   =C'PG ',QCLT                                                     
         BE    REQF1S                                                           
         CLC   =C'PGB',QCLT                                                     
         BE    REQF1S                                                           
         CLC   =C'PGG',QCLT                                                     
         BE    REQF1S                                                           
         CLC   =C'PGP',QCLT                                                     
         BE    REQF1S                                                           
         CLC   =C'PG1',QCLT                                                     
         BE    REQF1S                                                           
         CLC   =C'PG2',QCLT                                                     
         BE    REQF1S                                                           
         CLC   =C'PG3',QCLT                                                     
         BE    REQF1S                                                           
         CLC   =C'PG4',QCLT                                                     
         BE    REQF1S                                                           
         CLC   =C'PG6',QCLT                                                     
         BNE   REQF1T                                                           
*                                                                               
REQF1S   MVI   PGSW2,C'Y'                                                       
*                                                                               
REQF1T   DS    0H                                                               
         MVI   WMTSW,C'N'                                                       
         CLC   =C'H9',QAGY                                                      
         BNE   REQF1U                                                           
*                                                                               
         CLC   =C'WMT',QCLT                                                     
         BNE   REQF1U                                                           
         MVI   WMTSW,C'Y'                                                       
*                                                                               
REQF1U   DS    0H                                                               
         MVI   MMMSW,C'N'          H9 SPECIAL FISCAL CALENDAR                   
         CLC   =C'H9',QAGY                                                      
         BNE   REQF1V              FOR MMM AND MMH                              
         CLC   =C'MMM',QCLT                                                     
         BE    *+14                                                             
         CLC   =C'MMH',QCLT                                                     
         BNE   *+8                                                              
*                                                                               
         MVI   MMMSW,C'Y'                                                       
*                                                                               
REQF1V   CLC   QPRD,=C'POL'        STANDARDIZE QPRD (POL = ALL)                 
         BNE   *+10                                                             
         MVC   QPRD,=C'ALL'                                                     
*                                  STANDARDIZE QEST (ALL + BLANK = NO)          
         CLC   QEST,=C'ALL'        (MAY BE CHANGED AT CLTF FOR PW)              
         BE    *+12                                                             
         CLI   QEST,C' '                                                        
         BNE   REQF4                                                            
*                                                                               
         MVC   QEST,=C'NO '                                                     
         CLI   MOSOPT,C'E'         BUT IF DOING MOS TYPE ESTS                   
         BNE   *+10                                                             
         MVC   QEST,=C'ALL'        DO 'ALL'                                     
         B     REQF8                                                            
*                                                                               
REQF4    DS    0H                                                               
         CLI   MOSOPT,C'E'         IF DOING MOS TYPE ESTS                       
         BNE   REQF8                                                            
         CLC   QEST,=C'NO '        CHANGE EST=NO TO EST=ALL                     
         BNE   *+10                                                             
         MVC   QEST,=C'ALL'                                                     
         CLI   QEST,C'0'           DONT ALLOW ESTIMATE RANGE                    
         BL    REQF8               BECAUSE SPONSOR DOESNT HAVE A WAY            
         CLI   QESTEND,C'0'        OF TREATING IT AS A LIMITED                  
         BL    REQF8               'ALL' ESTIMATE REQUEST                       
         MVI   ERR,ESTERR                                                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
REQF8    DS    0H                                                               
*                                  SET VALUES FOR RUN-DATE FILTERING            
         ZIC   R1,TODAYB                                                        
         SR    R0,R0                                                            
         D     R0,=F'10'                                                        
         M     R0,=F'10'                                                        
         STC   R1,DECADE           80,90,00,ETC.                                
         MVC   YEARDIG,TODAY+1     GET YEAR WITHIN DECADE                       
         NI    YEARDIG,X'FF'-X'F0' ISOLATE YEAR DIGIT                           
*                                                                               
         XC    MKT,MKT             IN CASE WE GET SAME MKT ACROSS MEDIA         
*                                                                               
         B     EXIT                                                             
         EJECT                                                                  
*        CLTFRST                                                                
CLTF     DS    0H                                                               
*****************************************************                           
         CLC   =C'OO',QAGY         OMD                                          
         BNE   CLTF00                                                           
         MVI   SVWBSW,C'N'                                                      
*                                                                               
         XC    WK,WK                                                            
         XC    WORK,WORK                                                        
OFF      USING OFFICED,WORK                                                     
         MVI   OFF.OFCSYS,C'S'                NEED SYSTEM                       
         MVC   OFF.OFCAGY,AGY                 AGENCY                            
         L     R2,ADCLT                                                         
         MVC   OFF.OFCOFC,COFFICE-CLTHDR(R2)  ANY OFFICE                        
         MVC   OFF.OFCCLT,CKEYCLT-CLTHDR(R2)  AND THE CLIENT                    
         DROP  OFF                                                              
*                                                                               
         L     RF,ADCONLST                    CALL OFFICER AND ASK FOR          
         L     RF,VOFFICER-SPADCONS(RF)       OFFICE LIST BACK (X'D0')          
         GOTO1 (RF),DMCB,(C'2',WORK),(X'01',ACOMFACS),(C'S',WK)                 
*                                                                               
         CLC   =C'WB',WK                                                        
         BE    *+24                                                             
         CLC   =C'RH',WK                                                        
         BE    *+14                                                             
         CLC   =C'XW',WK                                                        
         BNE   CLTF00                                                           
*                                                                               
         MVI   SVWBSW,C'Y'         POSSIBLE WB FLIGHT BILLING                   
*                                                                               
**********************************************                                  
*                                                                               
CLTF00   BRAS  RE,CFIRST                                                        
         B     EXIT                                                             
         SPACE 2                                                                
PGR1F    DS    0H                                                               
         MVI   MOLSON,C'N'         SET MOLSON SWITCH                            
         CLC   QAGY,=C'TH'         ONLY FOR ZENITH                              
         BNE   PGR1F4                                                           
         CLI   RETPROF,0           MUST BE RETAIL                               
         BE    PGR1F4                                                           
         CLC   PGR1,=C'V02  '      AND PGR V02                                  
         BNE   PGR1F4                                                           
         CLC   PGR1NM(6),=C'MOLSON'  THIS SHOULD CLINCH IT                      
         BNE   PGR1F4                                                           
         MVI   MOLSON,C'Y'                                                      
*                                                                               
PGR1F4   DS    0H                                                               
         MVI   WBSW,C'N'           SET IT OFF                                   
         CLI   SVWBSW,C'Y'         IF WB CLIENT                                 
         BNE   PGR1F20                                                          
*        MVC   HALF,=X'0100'                                                    
*        CLC   PGR1,=C'T01  '      AND PGR T01                                  
*        BE    *+20                                                             
*        CLC   PGR1,=C'T02  '      AND PGR T02                                  
*        BNE   PGR1F8                                                           
*        MVC   HALF,=X'0200'                                                    
*                                                                               
*        MVI   WBSW,C'Y'           SET IT ON                                    
*                                  CHK THAT ALL PRDS IN GRP ARE THEATR          
         MVC   KEY1,KEY                                                         
         L     R2,ADCLT                                                         
         MVC   KEY(13),0(R2)                                                    
         L     R2,PRDLIST                                                       
         CLC   0(2,R2),BPGR+1                                                   
         BE    *+12                PGRP DOESN'T HAVE PRODS??                    
         MVI   ERR,PGRERR                                                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
         MVC   KEY+4(3),2(R2)      ALPHA PRODUCT CODE                           
         LA    R2,6(R2)            NEXT ENTRY IN PRDLIST                        
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   AREC,=A(STABUCKC)   READ INTO STABUC                             
         GOTO1 GET                                                              
         L     RF,AREC                                                          
         USING PRDHDR,RF                                                        
         TM    POPT1,POPT1_THTR+POPT1_THNT  PROD HAS THEATRICAL FLAG?           
         BZ    PGR1F10             NO, CHECK THAT OTHER PRDS DON'T              
         MVI   WBSW,C'Y'           OTHERWISE SET FLAG AND CHK                   
*                                                                               
PGR1F6   CLC   0(2,R2),BPGR+1                                                   
         BNE   PGR1F15             DONE, ALL GOOD                               
         MVC   KEY+4(3),2(R2)      ALPHA PRODUCT CODE                           
*                                                                               
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   AREC,=A(STABUCKC)   READ INTO STABUC                             
         GOTO1 GET                                                              
         L     RF,AREC                                                          
         USING PRDHDR,RF                                                        
         TM    POPT1,POPT1_THTR+POPT1_THNT  AND WB PRODUCT                      
         BNZ    *+12                                                            
         MVI   ERR,WBGRPERR        MIXED THEATR/NON-THEATR                      
         BRAS  RE,ERRPROC                                                       
*                                                                               
         LA    R2,6(R2)                                                         
         B     PGR1F6                                                           
         DROP  RF                                                               
*                                                                               
PGR1F10  CLC   0(2,R2),BPGR+1                                                   
         BNE   PGR1F15             DONE, ALL GOOD                               
         MVC   KEY+4(3),2(R2)      ALPHA PRODUCT CODE                           
*                                                                               
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   AREC,=A(STABUCKC)   READ INTO STABUC                             
         GOTO1 GET                                                              
         L     RF,AREC                                                          
         USING PRDHDR,RF                                                        
         TM    POPT1,POPT1_THTR+POPT1_THNT  AND WB PRODUCT                      
         BZ    *+12                                                             
         MVI   ERR,WBGRPERR        MIXED THEATR/NON-THEATR                      
         BRAS  RE,ERRPROC                                                       
*                                                                               
         LA    R2,6(R2)                                                         
         B     PGR1F10                                                          
         DROP  RF                                                               
*                                                                               
PGR1F15  MVC   KEY,KEY1                                                         
         GOTO1 HIGH                RESTORE SEQ                                  
*                                                                               
PGR1F20  DS    0H                                                               
         XC    HALF,HALF                                                        
         L     RF,ABRKTAB                                                       
         OC    0(L'BRKTAB,RF),0(RF)                                             
***      OC    BRKTAB,BRKTAB       TEST HAVE BUILT ALREADY                      
         BNZ   EXIT                                                             
         CLI   QMGR,C' '                                                        
         BNE   EXIT                                                             
         BRAS  RE,BLDTAB           IF NO MGR'S BUILD KEY TAB NOW                
         B     EXIT                                                             
         SPACE 2                                                                
*        PRDFRST                                                                
PRDF     DS    0H                                                               
         L     R2,ADPRD                                                         
         USING PRDHDR,R2                                                        
         TM    POPT1,POPT1_NOBILL                                               
         BZ    *+12                                                             
         MVI   MODE,PRDLAST        DON'T BILL THIS PRODUCT                      
         B     EXIT                                                             
*                                                                               
         CLI   QPGR,C' '           IF PGROUP DON'T CHECK                        
         BH    PRDF00C                                                          
         MVI   WBSW,C'N'           SET IT OFF                                   
         CLI   SVWBSW,C'Y'         IF WB CLIENT                                 
         BNE   PRDF00C                                                          
         TM    POPT1,POPT1_THTR+POPT1_THNT     AND WB PRODUCT                   
         BZ    *+8                                                              
         MVI   WBSW,C'Y'           SET IT ON                                    
*                                                                               
PRDF00C  MVI   GMIPPRD,C'N'                                                     
         CLI   GMISW,C'Y'          GMI BILLING?                                 
         BNE   PRDF06                                                           
         CLC   =X'BE60',BCLT       TEST CLIENT PTA                              
         BE    PRDF02                                                           
* NOT PTA                                                                       
         CLI   BPRD,X'3F'          IS IT A "PARTICIPATING PRD"                  
         BNH   *+8                 (EG. RED LOBSTER)                            
PRDF01   MVI   GMIPPRD,C'Y'        SET NON-GMI TRADE PRODUCT                    
         B     PRDF04                                                           
*                                                                               
PRDF02   CLI   BPRD,95             >96 IS TRADE                                 
         BH    PRDF01                                                           
         CLI   BPRD,X'40'          AND PRODUCT RL                               
         BE    PRDF01                                                           
         CLI   BPRD,X'41'          AND PRODUCT FL                               
         BE    PRDF01                                                           
*                                                                               
PRDF04   CLC   QPRD,=C'ALL'        IF ALL-PRODUCT REQ                           
         BE    *+12                                                             
         CLI   QPRD,C'0'           OR SPECIFIC PRODUCT GROUP                    
         BL    PRDF06                                                           
*>>>>>>>>      NOP EXIT BELOW  <<<<<<<<<<<<<<<                                  
*>>>>>>>>      NOP EXIT BELOW  <<<<<<<<<<<<<<<                                  
         B     PRDF06                                                           
*                                                                               
         CLI   GMIPPRD,C'Y'        SKIP THESE PRDS (DONE SEPARATELY)            
         BNE   PRDF06                                                           
         MVI   MODE,PRDLAST                                                     
         B     EXIT                                                             
*                                                                               
PRDF06   DS    0H                                                               
*                                  SET BILL FORMULA EFF DATE                    
         XC    EFFDTE,EFFDTE                                                    
         XC    PRDFORM,PRDFORM     CLEAR PRODUCT FORMULA                        
         XC    ESTFORM,ESTFORM     CLEAR ESTIMATE FORMULA                       
         CLI   BFROPT,C'N'         DONE IF DOING NEW BFR'S                      
         BNE   PRDF3               (IGNORE OLD)                                 
*                                                                               
         OC    PBILLBAS(5),PBILLBAS                                             
         BNZ   *+14                                                             
         MVC   EFFDTE,AAABILDT                                                  
         B     PRDF3                                                            
         MVC   EFFDTE,PBILLDT                                                   
         MVC   PRDFORM,PBILLBAS    HOLD FORMULA                                 
*                                                                               
PRDF3    DS    0H                                                               
         B     EXIT                                                             
         DROP  R2                                                               
         EJECT                                                                  
*        ESTFRST                                                                
ESTF     DS    0H                                                               
         L     R2,ADEST            TEST ESTIMATE HEADER                         
         USING ESTHDR,R2                                                        
*                                                                               
         CLI   QFLT,C' '           SPECIFIC WB FLIGHT?                          
         BNH   ESTF1D                                                           
         CLI   PRDQ,C'1'           IF SINGLE PRD REQ...                         
         BNE   ESTF1D                                                           
         CLI   ESTQ,C'1'           AND SINGLE EST REQ...                        
         BNE   ESTF1D                                                           
         MVC   WORD,EKEYPRD        THIS MOVES PROD AND EST                      
         L     RF,=A(CHKWBFLT)     CHECK FLIGHT                                 
         BASR  RE,RF                                                            
         BE    ESTF1D                                                           
         MVI   ERR,FLTERR          NOT FOUND, ERROR                             
         BRAS  RE,ERRPROC                                                       
*                                                                               
ESTF1D   CLI   ETYPE,C'S'          DON'T BILL STEWARDSHIP ESTIMATES             
         BE    *+12                                                             
         CLI   ETYPE,C'B'          DON'T BILL BARTER ESTIMATES                  
         BNE   ESTF01A                                                          
         CLI   ESTQ,C'1'           IF SINGLE EST REQ...                         
         BNE   *+12                                                             
         MVI   ERR,ESTERR          ...GENERATE ERROR MESSAGE                    
         BRAS  RE,ERRPROC                                                       
         MVI   MODE,ESTLAST                                                     
         B     EXIT                                                             
*                                                                               
ESTF01A  DS    0H                                                               
         MVI   WIOPT,C'N'                                                       
         CLI   WIOPTC,C'Y'         IF WI OPT AT CLIENT LEVEL                    
         BNE   ESTF01C                                                          
         OC    EPWPCT,EPWPCT       (EST WILL BE 1 OR ALL, NOT NO)               
         BZ    ESTF01J                                                          
         MVI   WIOPT,C'Y'                                                       
         B     ESTF01J                                                          
*                                                                               
ESTF01C  DS    0H                                                               
         MVI   CLTCURR,0           SET CLIENT CURRENCY CONTROL                  
         MVI   CURR2,0                                                          
*                                                                               
         CLC   QAGY(2),=C'WI'                                                   
         BNE   *+14                                                             
         CLC   QUESTOR(2),=C'PW'   REQUESTOR NAME MUST BE PW                    
         BNE   ESTF01H                                                          
         L     RF,ADCLT                                                         
         TM    COPT2-CLTHDR(RF),COP2NPWB    PW SUPPRESSED?                      
         BO    ESTF01H                                                          
         OC    EPWPCT,EPWPCT       (EST WILL BE 1 OR ALL, NOT NO)               
         BZ    ESTF01H                                                          
*                                                                               
         MVI   WIOPT,C'Y'                                                       
         CLC   QEST,=C'NO '       FOR PW                                        
         BNE   *+10                                                             
         MVC   QEST,=C'ALL'        EST=NO ==> EST=ALL                           
*                                                                               
         MVI   CLTCURR,1           SPECIAL CURRENCY CODE                        
         MVI   CURR2,1                                                          
         MVI   RQALLMKT,C'Y'       NEED ALL MKTS                                
         B     ESTF01J                                                          
*                                                                               
ESTF01H  DS    0H                  SET COST2 OPTION                             
*              SET COST2 OPTION                                                 
*              NOTE- SET AGAIN AT FEST (LABEL SEST5)                            
*                                                                               
         MVI   COST2SW,C'N'        ASSUME NO COS2 FACTOR                        
         CLC   ECOST2,=X'80000000' IN CASE THERE ARE ANY OUT THERE...           
         BE    *+18                 ... LIKE THIS LEFT OVER                     
         OC    ECOST2,ECOST2       COST2 ACTIVE FOR ESTIMATE?                   
         BZ    *+8                                                              
         MVI   COST2SW,C'Y'        YES                                          
*                                                                               
         MVI   CLTCURR,0           SET CLIENT CURRENCY CONTROL                  
         MVI   CURR2,0                                                          
         CLI   MIDAS,C'Y'          MIDAS SAME AS COS2                           
         BE    *+12                                                             
         CLI   COST2SW,C'Y'        ARE WE DOING COST2?                          
         BNE   ESTF01J                                                          
         MVI   CLTCURR,1           YES                                          
         MVI   CURR2,1                                                          
*                                                                               
ESTF01J  DS    0H                                                               
         BAS   RE,ESTTSTN          TEST EST OK (SPONSOR ONLY DOES FOR           
         CLI   MODE,ESTLAST        EST= ALL/NO)                                 
         BNE   ESTF02                                                           
         CLI   ESTQ,C'1'           IF NOT SINGLE EST REQ                        
         BNE   ESTF02              OK                                           
         CLC   QPRD,=C'POL'        IF POL THEN ERROR                            
         BE    *+12                                                             
         CLI   PRDQ,C'1'           ELSE IF NOT SINGLE PRD REQ                   
         BNE   ESTF01K             OK                                           
         MVI   ERR,ESTERR          ELSE ERROR                                   
         BRAS  RE,ERRPROC                                                       
*                                                                               
ESTF01K  DS    0H                                                               
         MVI   MODE,PRDLAST        HERE IF SINGLE EST AND                       
         B     EXIT                AND NON-SINGLE PRD                           
*                                  SKIP THIS PRODUCT                            
*                                                                               
ESTF02   DS    0H                                                               
         MVI   FCRDBUYS,C'Y'       SET FCRDBUYS                                 
         CLI   PREVSW,C'P'         IF PREVIOUS ONLY                             
         BE    ESTF02C                                                          
         CLI   WIOPT,C'Y'          OR WI PW OPTION                              
         BE    ESTF02C                                                          
         CLI   QRETCD,C' '         OR SPECIAL RETAIL CREDIT/DEBIT               
         BH    ESTF02C                                                          
         OC    MANRVDTP,MANRVDTP   OR REVERSAL                                  
         BNZ   ESTF02C                                                          
         OC    MANGRS,MANGRS       OR MANUAL BILL                               
         BZ    ESTF02E                                                          
ESTF02C  DS    0H                                                               
         MVI   FCRDBUYS,C'N'       SET NOT TO READ BUYS                         
*                                                                               
ESTF02E  DS    0H                                                               
         MVI   MODE,ESTFRST        RESTORE MODE                                 
         CLI   ESTQ,C'1'           ONLY IF SINGLE EST                           
         BE    *+14                                                             
         CLC   =C'ALL',QEST        OR ALL                                       
         BNE   EXIT                                                             
*                                                                               
         MVC   ESTFORM,EBILLBAS    HOLD FORMULA                                 
*                                                                               
         CLI   MOSOPT,C'E'         FOR ES DATES                                 
         BNE   ESTF05                                                           
         TM    ECONTROL,EBILESTQ                                                
         BZ    ESTF03              MUST BE MOS TYPE EST                         
         CLI   ESTCTL,C'S'         EST MUST BE SEPARATE                         
         BNE   ESTF04                                                           
         CLI   PRDCTL,C'S'         AND PRD                                      
         BNE   ESTF04                                                           
         BAS   RE,ESTMOS           MUST DEAL WITH DATES                         
         BRAS  RE,SETDATE          AND DO MEDPRDRD, MEDDATE, ETC.               
         B     ESTF08                                                           
*                                                                               
ESTF03   DS    0H                  BAD ESTIMATE TYPE                            
         CLC   =C'ALL',QEST        IF SINGLE EST REQ THEN ERROR                 
         BNE   ESTF04                                                           
         MVI   MODE,ESTLAST        EST JUST SKIP EST                            
         B     EXIT                                                             
*                                                                               
ESTF04   DS    0H                                                               
         MVI   ERR,ESTERR                                                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
ESTF05   DS    0H                  NOT A ESTMOS REQUEST                         
         TM    ECONTROL,EBILESTQ                                                
         BNZ   ESTF03              SKIP ESTMOS ESTIMATES                        
*                                                                               
ESTF08   DS    0H                                                               
         CLI   ESTQ,C'1'           IF SINGLE EST                                
         BNE   ESTF10                                                           
         CLI   ERTLSCHM,C'*'       IF NO RETAIL SCHEME                          
         BE    ESTF08C             SET OFF RETAIL                               
         CLC   ERTLSCHM,SPACES                                                  
         BH    ESTF09                                                           
         CLC   EPROF+1(2),SPACES                                                
         BH    ESTF09                                                           
ESTF08C  DS    0H                                                               
         MVI   NONRET,C'Y'         THEN SET OFF RETAIL                          
         MVI   RETPROF,0                                                        
         MVI   SUMOPT,C'N'                                                      
*                                                                               
ESTF09   DS    0H                  FOR SINGLE EST REQS                          
         CLI   SCBOPT,C'Y'         IF SEP COMM BILLING OPTION                   
         BNE   ESTF10                                                           
         CLI   PROFB2B+1,0                                                      
         BE    ESTF10                                                           
         ZIC   RF,PROFB2B+1        FILTER POSITION                              
         LA    RF,EPROF-1(RF)                                                   
*                                                                               
         CLI   SCBNCSW,C'R'        FOR REGULAR EST RUNS (R)                     
         BNE   ESTF09G                                                          
         CLC   0(1,RF),PROFB2B+2   IS VALUE EQUAL                               
         BE    ESTF10              YES, OK                                      
         B     ESTF09J             NO, REJECT                                   
*                                                                               
ESTF09G  DS    0H                  SEP COMM RUNS (S OR C)                       
         CLC   0(1,RF),PROFB2B+2   IS VALUE EQUAL                               
         BNE   ESTF10              NO, OK - ELSE REJECT                         
*                                                                               
ESTF09J  DS    0H                                                               
         MVI   ERR,ESTERR                                                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
ESTF10   DS    0H                                                               
         B     EXIT                                                             
         DROP  R2                                                               
         SPACE 2                                                                
*        ESTTEST - EXAMINE EST FOR ESTLST INCLUSION                             
*                                                                               
ESTTSTN  NTR1                                                                   
*                                                                               
ESTTST   DS    0H                                                               
         L     R2,ADEST                                                         
         USING ESTHDR,R2                                                        
*                                                                               
         OC    MANRVDTP,MANRVDTP   SKIP IF REVERSAL BILL                        
         BNZ   ESTT10                                                           
         CLI   LMGSW,C'L'         LMG?  DON'T CHECK UCOM OPTION                 
         BE    ESTT10                                                           
*                                                                               
         L     RF,ADCLT                                                         
         TM    COPT4-CLTHDR(RF),COP4UCOM                                        
         BZ    ESTT05                                                           
         L     RF,=A(CHKUCOM)                                                   
         BASR  RE,RF                                                            
         BNE   ESTTNO                                                           
*                                                                               
*&&DO                                                                           
* WRITE REJECTED RECORDS TO SKIPPED DATASET                                     
         BE    ESTT05                                                           
         GOTO1 HEXOUT,DMCB,0(R2),P,13,=C'N'                                     
         GOTO1 CLUNPK,DMCB,2(R2),P+30                                           
         MVC   P+34(3),4(R2)                                                    
         EDIT  (B1,7(R2)),(3,P+39)                                              
         L     R2,=A(SKIPPED)                                                   
         LA    R0,P                                                             
         PUT   (R2),(0)                                                         
         B     ESTTNO                                                           
*&&                                                                             
ESTT05   DS    0H              NOW CHECK EST UDEF REQUIRED                      
         L     RF,ADCLT                                                         
         MVI   UDEFESW,0                                                        
         TM    CEU1FLG2-CLTHDR(RF),CFLGREQB                                     
         BNO   *+8                                                              
         OI    UDEFESW,X'01'   FIRST EST UDEF REQUIRED                          
         TM    CEU2FLG2-CLTHDR(RF),CFLGREQB                                     
         BNO   *+8                                                              
         OI    UDEFESW,X'02'   2ND EST UDEF REQUIRED                            
         CLI   UDEFESW,0                                                        
         BE    ESTT10                                                           
         L     RF,=A(CHKUDEF)                                                   
         BASR  RE,RF                                                            
         BNE   ESTTNO                                                           
*                                                                               
*                                                                               
ESTT10   DS    0H                                                               
         CLI   ETYPE,C'S'          DON'T BILL STEWARDSHIP ESTIMATES             
         BE    ESTTNO                                                           
         CLI   ETYPE,C'B'          DON'T BILL BARTER ESTIMATES                  
         BE    ESTTNO                                                           
*                                                                               
         CLI   MOSOPT,C'E'         IF NOT E TYPE REQ                            
         BE    *+16                                                             
         TM    ECONTROL,EBILESTQ                                                
         BNZ   ESTTNO              MUST NOT BE MOS TYPE EST                     
         B     ESTTYES                                                          
*                                                                               
         TM    ECONTROL,EBILESTQ   E TYPE EST?                                  
         BNZ   ESTTYES                                                          
*                                                                               
ESTTNO   DS    0H                                                               
         MVI   MODE,ESTLAST                                                     
*                                                                               
ESTTYES  DS    0H                                                               
         B     EXIT                                                             
         DROP  R2                                                               
         SPACE 2                                                                
*        ESTLAST - LAST FOR ESTIMATE                                            
ESTL     DS    0H                                                               
         CLI   WIOPT,C'Y'          FOR WI OPT, MUST DO WIPROC                   
         BNE   *+8                 NO LATER THAN PRDLAST                        
         BAS   RE,WIPROC           BECAUSE NEED BPRD AS FILTER                  
         CLC   =C'ALL',QEST        IF ESTIMATE=ALL                              
         BNE   EXIT                (CAN ONLY BE FOR MOSOPT=E REQUEST)           
*                                  (OR PW BILLING)                              
         MVC   KPRD,BPRD           DO BILLS NOW                                 
         B     DOBILLS             (WHILE BEST HAS RIGHT VALUE)                 
         SPACE 2                                                                
*        MGR1FRST                                                               
MGR1F    DS    0H                                                               
         L     RF,ABRKTAB                                                       
         OC    0(L'BRKTAB,RF),0(RF)                                             
****     OC    BRKTAB,BRKTAB       TEST HAVE BUILT KEY TAB                      
         BNZ   EXIT                                                             
         BRAS  RE,BLDTAB                                                        
         B     EXIT                                                             
         SPACE 2                                                                
*        MKTFRST                                                                
MKTF     DS    0H                                                               
         B     EXIT                                                             
         EJECT                                                                  
*        PGR1LAST                                                               
PGR1L    DS    0H                                                               
         L     R3,APGR1BRK                                                      
         B     PGRXL                                                            
         SPACE 2                                                                
*        PGR2LAST                                                               
PGR2L    DS    0H                                                               
         L     R3,APGR2BRK                                                      
         B     PGRXL                                                            
         SPACE 2                                                                
*        PGR3LAST                                                               
PGR3L    DS    0H                                                               
         L     R3,APGR3BRK                                                      
         B     PGRXL                                                            
         SPACE 2                                                                
PGRXL    DS    0H                                                               
         LTR   R3,R3                                                            
         BZ    EXIT                LEVEL NOT USED                               
         C     R3,AINVBRK                                                       
         BH    EXIT                LEVEL 'BELOW' INV BREAK                      
         B     DOBILLS                                                          
         SPACE 2                                                                
*        PRDLAST                                                                
PRDL     DS    0H                                                               
         CLI   SPLITOPT,C'Y'       IF DOING PRODUCT SPLITS MUST READ            
         BE    PRDL2               ALL PRDS BEFORE DOING BILL                   
         CLC   APRDBRK,AINVBRK                                                  
         BH    PRDL2               PRD 'BELOW' INV BREAK                        
         MVC   KPRD,BPRD           IF PRDS SEPARATE, DO BILLS NOW               
         B     DOBILLS                                                          
PRDL2    DS    0H                                                               
*                                  READ PREVIOUS BILLS HERE                     
*                                  (NO LATER THAN PRD LAST BECAUSE              
*                                  MKTLIST IS LOST)                             
         CLI   PREVSW,C'N'         NO PREVIOUS                                  
         BE    EXIT                                                             
         MVC   KPRD,BPRD                                                        
         BRAS  RE,RNBILL                                                        
         B     EXIT                                                             
         SPACE 2                                                                
*        MGR1LAST                                                               
MGR1L    DS    0H                                                               
         L     R3,AMGR1BRK                                                      
         B     MGRXL                                                            
         SPACE 2                                                                
*        MGR2LAST                                                               
MGR2L    DS    0H                                                               
         L     R3,AMGR2BRK                                                      
         B     MGRXL                                                            
         SPACE 2                                                                
*        MGR3LAST                                                               
MGR3L    DS    0H                                                               
         L     R3,AMGR3BRK                                                      
         B     MGRXL                                                            
         SPACE 2                                                                
MGRXL    DS    0H                                                               
         LTR   R3,R3                                                            
         BZ    EXIT                LEVEL NOT USED                               
         CLI   SUMOPT,C'Y'         IF DOING RETAIL CORP SUMMARY                 
         BE    EXIT                DONT DO 1 MGR AT A TIME                      
         CLI   MGRBKTS,C'Y'        OR IF MGR BUCKETS                            
         BE    EXIT                                                             
         CLI   WIOPT,C'Y'          FOR WI OPT                                   
         BE    EXIT                WAIT UNTIL PRDLAST                           
         CLI   SPLITOPT,C'Y'       IF DOING PRODUCT SPLITS MUST READ            
         BE    EXIT                ALL PRDS BEFORE DOING BILL                   
         C     R3,AINVBRK          IF MGR                                       
         BH    EXIT                                                             
         CLC   APRDBRK,AINVBRK     AND PRODUCT                                  
         BH    EXIT                BOTH SEPARATE                                
         MVC   KPRD,BPRD           DO BILL NOW                                  
         B     DOBILLS                                                          
         SPACE 2                                                                
*        MKTLAST                                                                
MKTL     DS    0H                                                               
         XC    KMKT,KMKT                                                        
         CLI   SUMOPT,C'Y'         IF DOING RETAIL CORP SUMMARY                 
         BE    EXIT                DONT DO ONE MKT AT A TIME                    
         CLI   MKTQ,C'1'           IF A SINGLE MKT REQ                          
         BNE   *+10                                                             
         MVC   KMKT,BMKT           SET KMKT                                     
         CLI   WIOPT,C'Y'          FOR WI OPTION                                
         BE    EXIT                WAIT UNTIL PRDLAST                           
         CLI   SPLITOPT,C'Y'       IF DOING PRODUCT SPLITS MUST READ            
         BE    EXIT                ALL PRDS BEFORE DOING BILL                   
         CLC   AMKTBRK,AINVBRK     IF MARKET                                    
         BH    EXIT                                                             
         CLC   APRDBRK,AINVBRK     AND PRODUCT                                  
         BH    EXIT                BOTH SEPARATE                                
         MVC   KMKT,BMKT           DO BILL NOW                                  
         MVC   KPRD,BPRD                                                        
         B     DOBILLS                                                          
         SPACE 2                                                                
*        PRBUY                                                                  
*                                                                               
PRBUY    DS    0H                                                               
         BRAS  RE,PRBUYP                                                        
*                                                                               
         B     EXIT                                                             
         EJECT                                                                  
*        CLTLAST (AND COMMON CODE FOR FINISHING UP BILLS)                       
         SPACE 2                                                                
CLTL     DS    0H                                                               
DOBILLS  DS    0H                                                               
         CLI   DONESW,C'D'                                                      
         BE    CLTL2                                                            
         MVI   DONESW,C'D'                                                      
         OC    MANGRS,MANGRS       TEST MANUAL BILLING                          
         BZ    CLTL1D              NO                                           
*                                  YES - SET UP DUMMY BUY AND POST IT           
         L     R7,ADBUY                                                         
         USING BUYREC,R7                                                        
*                                                                               
         XC    BUYREC(256),BUYREC                                               
         MVC   KEY+9(1),BEST                                                    
         MVC   BUYMSTA,XXMKT       SET SPECIAL MKT/STA                          
         BRAS  RE,PRBUYP                                                        
CLTL1D   DS    0H                                                               
         L     RF,ABRKTAB                                                       
         OC    0(L'BRKTAB,RF),0(RF)                                             
****     OC    BRKTAB,BRKTAB       TEST HAVE SET KEY TABLE                      
         BZ    CLTL1H              NO- NO PROCESSING                            
         CLI   MODE,PGR3LAST       DONT READ PREV BILLS AT PGRLAST              
         BNL   *+16                OR CLTLAST BE                                
         CLI   PREVSW,C'N'         IF NO PREV BILL OPT                          
         BE    *+8                 BYPASS READ OF BILLS                         
         BRAS  RE,RNBILL                                                        
*                                                                               
         L     RF,ABUFFC                                                        
         L     RF,BUFFSOFA-BUFFALOD(RF)                                         
         LTR   RF,RF                                                            
         BZ    CLTL1H              NO DATA                                      
         BRAS  RE,RDBUFF                                                        
*                                                                               
CLTL1H   DS    0H                                                               
         GOTO1 BUFFALO,DMCB,=C'RESET',ABUFFC                                    
         OC    NBUFFADR,NBUFFADR   MAY NOT HAVE DONE                            
         BZ    CLTL2               PREVIOUS COVAIL                              
         GOTO1 =V(COVAIL),DMCB,C'RESB',NBUFFADR,NBUFFLN,ABUFFC                  
*                                                                               
CLTL2    DS    0H                                                               
         XC    SKPTABN,SKPTABN     CLEAR SKIP TABLE                             
         CLI   MODE,CLTLAST                                                     
         BNE   EXIT                                                             
*                                  TRULY AT CLIENT LAST                         
         CLI   AORLOPT,C'C'        AOR RECAP AT CLIENT LEVEL?                   
         BNE   *+12                                                             
         MVI   AORLCTL,C'P'        SET TO PRINT AOR                             
         BRAS  RE,AORINV1                                                       
*                                                                               
         MVI   QMGR,C' '           AT CLTLAST CLEAR QMGR AND QPGR               
         MVI   QPGR,C' '           (SO CLIENT=ALL REQUEST WILL WORK)            
*                                                                               
         CLI   RETDRAFT,C'Y'       SKIP IF RETAIL DRAFT                         
         BE    EXIT                                                             
         CLI   QRETCD,C' '         SKIP IF RETAIL CREDIT/DEBIT                  
         BH    EXIT                                                             
*                                                                               
         CLI   MIDAS,C'Y'                                                       
         BE    EXIT                                                             
         CLC   OBTOTG,NBTOTG                                                    
         BNE   *+24                                                             
         CLC   OBTOTN,NBTOTN                                                    
         BNE   *+14                                                             
         CLC   OBTOTNC,NBTOTNC                                                  
         BE    EXIT                                                             
*                                                                               
         MVC   P(8),=C'HEADERS:'                                                
         MVC   P+10(6),=C'GROSS='                                               
         EDIT  OBTOTG,(17,P+16),2,CR=YES                                        
         MVC   P+40(4),=C'NET='                                                 
         EDIT  OBTOTN,(17,P+44),2,CR=YES                                        
         MVC   P+70(9),=C'CALC NET='                                            
         EDIT  OBTOTNC,(17,P+79),2,CR=YES                                       
         MVC   P2(8),=C'DETAILS:'                                               
         MVC   P2+10(6),=C'GROSS='                                              
         EDIT  NBTOTG,(17,P2+16),2,CR=YES                                       
         MVC   P2+40(4),=C'NET='                                                
         EDIT  NBTOTN,(17,P2+44),2,CR=YES                                       
         MVC   P+70(9),=C'CALC NET='                                            
         EDIT  NBTOTNC,(17,P+79),2,CR=YES                                       
         BRAS  RE,PRNT                                                          
*                                                                               
         DC    H'0'                                                             
         DROP  R7                                                               
         SPACE 2                                                                
*        REQUEST LAST                                                           
         SPACE 2                                                                
REQL     DS    0H                                                               
         BRAS  RE,UNLOCK           ALLOW THE NEXT UPDATIVE SOON                 
*                                                                               
         CLI   ACTSW,C'Y'                                                       
         BE    *+16                                                             
         MVI   ERR,NOBILERR        NO BILLING GENERATED                         
         BRAS  RE,ERRPROC                                                       
         B     EXIT                                                             
*                                                                               
         CLI   UPDTSOON,C'Y'       UPDATIVE SOON?                               
         BNE   EXIT                                                             
*                                                                               
         CLI   QINVREG,C'B'                                                     
         BNE   EXIT                                                             
         XC    REQHDR,REQHDR       YES: GENERATE BT TURNAROUND                  
         L     RF,VMASTC                                                        
         USING MASTD,RF                                                         
         CLC   MCORIGID,MCREMPQK   IF ORIGIN AND DESTINATION IDS DIFFER         
         BE    *+10                                                             
         MVC   REQDEST,MCREMPQK    THEN PUT BT TO DESTINATION ID                
         DROP  RF                                                               
         MVC   REQUEST,SPACES                                                   
         MVC   QPROG-QAREA+REQUEST,=C'BT'                                       
         MVC   QAGY-QAREA+REQUEST,QAGY                                          
         MVC   QMED-QAREA+REQUEST,QMED                                          
         MVC   QCLT-QAREA+REQUEST,=C'ALL'                                       
         MVC   QPRD-QAREA+REQUEST,=C'ALL'                                       
         MVC   QEST-QAREA+REQUEST,=C'ALL'                                       
         MVC   QSTART-QAREA+REQUEST,TODAY                                       
         MVC   QEND-QAREA+REQUEST,TODAY                                         
         MVI   QOPT1-QAREA+REQUEST,C'N'                                         
         MVC   QUESTOR-QAREA+REQUEST(5),=C'*SOON'                               
         GOTO1 DATAMGR,DMCB,=C'DMADD',=C'REQUEST',WORK,REQHDR                   
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         B     EXIT                                                             
*                                                                               
*        RUN LAST                                                               
*                                                                               
RUNL     DS    0H                                                               
*                                                                               
* SKIPPED = DATASET FOR UCOM-REJECTED RECORDS                                   
*        CLOSE SKIPPED                                                          
*                                                                               
         BRAS  RE,INVREG                                                        
         BRAS  RE,PUTA2REQ         CREATE A2 REQUEST FILE                       
*                                                                               
         CLI   OUTMODE,C'D'        FOR DATASET OUTPUT MODE                      
         BNE   EXIT                                                             
         GOTO1 =A(BILLEDI),DMCB,('EDMCLS',0)   CLOSE EDI NOW                    
*                                  ELSE CLOSE FOR EACH INVOICE                  
         B     EXIT                                                             
         SPACE 2                                                                
         EJECT                                                                  
**********************************************************************          
*                                                                               
*        WI OPTION PROC                                                         
*                                                                               
**********************************************************************          
WIPROC   NTR1                                                                   
         OC    MANRVDTP,MANRVDTP   SKIP IF REVERSAL BILL                        
         BNZ   WIEXIT                                                           
         OC    MANGRS,MANGRS       OR MANUAL BILL                               
         BNZ   WIEXIT                                                           
         L     RF,ABRKTAB                                                       
         OC    0(L'BRKTAB,RF),0(RF)                                             
***      OC    BRKTAB,BRKTAB       IF HAVE NOT BUILT KEY TABLE                  
         BNZ   *+8                                                              
         BRAS  RE,BLDTAB           DO IT NOW                                    
*                                                                               
         LA    R6,WIBLOCK                                                       
         USING SPWID,R6                                                         
         XC    WIBLOCK,WIBLOCK                                                  
         LA    RF,WIHOOK                                                        
         ST    RF,SPWHOOK                                                       
         MVC   SPWAIO,=A(STABUCKC) IO AOREA                                     
         MVC   SPWQPRD,BPRD                                                     
         MVC   SPWQEST,BEST        NOTE, WILL BE 0 UNLESS SINGLE EST RQ         
*                                        (QEST=ALL IS SET TO NO)                
         MVC   SPWQMKT,KMKT       SET MARKET AND STATION FOR SPB1WI             
         MVC   SPWQSTA,KSTA                                                     
*                                                                               
         CLI   QSTART+4,C' '                                                    
         BH    *+10                                                             
         MVC   QSTART+4(2),=C'01'                                               
         GOTO1 GETDAY,DMCB,QSTART,WORK     DAY OF WEEK                          
         LHI   R5,7                (FOLLOWING SUNDAY IS IN RIGHT                
         ZIC   RE,DMCB             BROADCAST AND CALENDAR MONTH)                
         SR    R5,RE                                                            
         GOTO1 ADDAY,DMCB,QSTART,WORK,(R5)                                      
         GOTO1 DATCON,DMCB,WORK,(3,WORK)                                        
         MVC   SPWQSYM,WORK                 START MOS                           
*                                                                               
         MVC   SPWQEYM,WORK        END MOS = START IF NOT GIVEN                 
         CLI   QEND,C' '                                                        
         BNH   WIP04                                                            
*                                                                               
         CLI   QEND+4,C' '                                                      
         BH    *+10                                                             
         MVC   QEND+4(2),=C'01'                                                 
         GOTO1 GETDAY,DMCB,QEND,WORK       DAY OF WEEK                          
         LHI   R5,7                (FOLLOWING SUNDAY IS IN RIGHT                
         ZIC   RE,DMCB             BROADCAST AND CALENDAR MONTH)                
         SR    R5,RE                                                            
         GOTO1 ADDAY,DMCB,QEND,WORK,(R5)                                        
         GOTO1 DATCON,DMCB,WORK,(3,WORK)                                        
         MVC   SPWQEYM,WORK                 END MOS                             
*                                                                               
WIP04    DS    0H                                                               
         MVI   SPWINDS,0                                                        
*                                                                               
         MVI   SPWQBTYP,C'E'       GET ESTIMATED                                
         CLI   PAYOPT,C'N'         UNLESS DOING PAID ONLY                       
         BE    *+8                 (CONVENTION FOR DETAIL OR 'FINAL')           
         MVI   SPWQBTYP,C'D'       THEN GET DETAIL                              
*                                                                               
         GOTO1 =V(SPB1WI),DMCB,SPWORKD,SPWID                                    
*                                                                               
WIEXIT   DS    0H                                                               
         B     EXIT                                                             
*                                                                               
WIHOOK   NTR1                      PROCESSING HOOK ROUTINE                      
         MVI   WIPASS,1            TWO CALLS TO PRBUYP                          
         BRAS  RE,PRBUYP                                                        
         MVI   WIPASS,2                                                         
         BRAS  RE,PRBUYP                                                        
         B     WIEXIT                                                           
         DROP  R6                                                               
         EJECT                                                                  
***********************************************************************         
*        ESTMOS- SET EST START-END AS BILLING PERIOD                            
*                OVERWRITE ALL SETDATE RESULTS                                  
*                SET QSTART/QEND                                                
***********************************************************************         
         SPACE 1                                                                
ESTMOS   NTR1                                                                   
         XC    PERLIST(PERLSTLQ),PERLIST                                        
         L     R6,ADEST                                                         
         USING ESTHDR,R6                                                        
         MVC   QSTART,ESTART                                                    
         MVC   QEND,EEND                                                        
         GOTO1 DATCON,DMCB,QSTART,(2,BQSTARTP)                                  
         GOTO1 DATCON,DMCB,QSTART,(3,DUB)                                       
         GOTO1 DATCON,DMCB,QEND,(2,BQENDP)                                      
*                                                                               
PERLST   USING PERLISTD,PERLIST                                                 
         MVC   PERLST.PERLMOS,DUB        SET YM OF START DATE                   
         MVC   PERLST.PERLSTRT,BQSTARTP  AND START/END DATES                    
         MVC   PERLST.PERLEND,BQENDP                                            
         MVI   PERLIST+PERLISTL,X'FF'  SET EOL                                  
         MVC   CURPER,PERLST.PERLMOS                                            
*                                                                               
* IF THERE'S ANY PREVIOUS BILLING FOR THIS E-ESTIMATE, USE THAT MOS             
* (IN CASE THE ESTIMATE START DATE CHANGED SINCE PREVIOUS BILLING)              
*                                                                               
         MVC   KEY(13),0(R6)       PULL OUT KEY FROM ESTIMATE HEADER            
         GOTO1 READ                READ ESTIMATE KEY                            
         GOTO1 SEQ                 BILL HEADERS FOLLOW (IF PRESENT)             
         CLC   KEY(8),0(R6)        IF AGY/MED/CLT/PRD/EST DIFFERS...            
         BNE   *+16                ...THERE ARE NO BILLS FOR THIS EST           
         MVC   PERLST.PERLMOS,KEY+(BKEYYSRV-BKEY)  USE EXISTING MOS             
         MVC   CURPER,KEY+(BKEYYSRV-BKEY)          USE EXISTING MOS             
         DROP  PERLST                                                           
*                                                                               
         MVI   PRIOR,C'N'                                                       
         MVI   PARTIAL,C'N'                                                     
         MVI   NMOS,1                                                           
*                                                                               
         B     EXIT                                                             
         DROP  R6                                                               
         DROP  RB,R9                                                            
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*        INITIALIZE SSB VALUES                                                  
*                                                                               
INISSB   NTR1  BASE=*,LABEL=*                                                   
         LA    R6,SSBCPYTB         POINT TO AGENCY ALPHA TABLE                  
*                                                                               
INISSB3  CLI   0(R6),X'FF'         END OF TABLE?                                
         JE    INISSBX                                                          
         CLC   AGENCY,0(R6)        NEED TO ENABLE COPY RECORD?                  
         JE    INISSB9                                                          
         LA    R6,2(R6)            NEXT ENTRY IN TABLE                          
         J     INISSB3                                                          
*                                                                               
INISSB9  L     R6,SSB                                                           
         USING SSBD,R6                                                          
         OI    SSOSTAT2,SSOSROLC                                                
         DROP  R6                                                               
INISSBX  XIT1                                                                   
*                                                                               
SSBCPYTB DS    0H                                                               
         DC    CL2'SJ'                                                          
         DC    CL2'HD'                                                          
         DC    CL2'*B'                                                          
         DC    CL2'H7'                                                          
         DC    CL2'FR'                                                          
         DC    CL2'JE'                                                          
         DC    CL2'JM'                                                          
         DC    CL2'JP'                                                          
         DC    X'FF'                                                            
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*        UNLOCK UPDATIVE SOON REQUESTS                                          
         SPACE 2                                                                
UNLOCK   NMOD1 0,UNLOCK                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   UPDTSOON,C'Y'       UPDATIVE SOON?                               
         BNE   UNLOCKX                                                          
*                                                                               
         XC    LKUPKEY,LKUPKEY     YES -- UNLOCK UPDATIVE SOONS                 
L        USING LKKEYD,LKUPKEY                                                   
         L     R1,UTL                                                           
         MVC   L.LOCKSE,4(R1)                                                   
         MVC   L.LOCKAGY,AGENCY                                                 
         MVC   L.LOCKRTY,=C'B1'                                                 
         DROP  L                                                                
*                                                                               
         XC    DMCB(4),DMCB                                                     
         MVC   DMCB+4(3),=X'D9000A'                                             
         MVI   DMCB+7,QLOCKET                                                   
         L     RF,ACOMFACS                                                      
         L     RF,(CCALLOV-COMFACSD)(RF)                                        
         GOTO1 (RF),DMCB                                                        
         CLI   4(R1),X'FF'                                                      
         BNE   *+6                                                              
         DC    H'0'                                                             
         L     RF,DMCB                                                          
*                                                                               
UNLOCK10 GOTO1 (RF),DMCB,('LKUNLKQ',LKUPKEY),ACOMFACS                           
         CLI   4(R1),2             TEST TABLE BUSY                              
         BE    UNLOCK10                                                         
*                                                                               
UNLOCKX  DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*        PROCESS BUY                                                            
         SPACE 2                                                                
PRBUYP   NMOD1 0,PRBUY                                                          
         LA    RC,SPACEND                                                       
*                                                                               
         OC    MANRVDTP,MANRVDTP   SKIP IF REVERSAL BILL                        
         BNZ   PBEXIT                                                           
         OC    REBDATP,REBDATP     SKIP IF REBILL                               
         BNZ   PBEXIT                                                           
*                                                                               
         L     R7,ADBUY                                                         
         USING BUYREC,R7                                                        
         MVI   RECSW,0                                                          
*                                                                               
         CLI   WIOPT,C'Y'          PW BILLING?                                  
         BNE   *+10                                                             
         XC    0(256,R7),0(R7)     YES -- BUY RECORD SHOULDN'T BE THERE         
*                                                                               
         CLI   QFRATE,C' '         ANYTHING IN FRATE FIELD?                     
         BNH   PRBUY4C                                                          
         CLI   QFRATE,C'F'         ONLY DOING FRATE BUYS?                       
         BNE   PRBUY4                                                           
         TM    BDCIND,BDCFEEQ      YES, MAKE SURE BUY IS FRATE TYPE             
         BZ    PBEXIT                                                           
         B     PRBUY4C                                                          
PRBUY4   CLI   QFRATE,X'86'        LOWER CASE 'F' ?                             
         BE    *+6                                                              
         DC    H'0'                REQUEST PROG SCREWED UP                      
         TM    BDCIND,BDCFEEQ      SKIP FRATE BUYS                              
         BO    PBEXIT                                                           
*                                                                               
PRBUY4C  CLI   QGMITVC,C' '        GMI CASH/TRADE FILTER ACTIVE?                
         BNH   PRBY6J              NO                                           
         MVI   BYTE,C'C'           YES, IS BUY CASH OR TRADE                    
         TM    BDCIND2,X'04'       IS BDCIND A CHARACTER?                       
         BZ    PRBY6                                                            
         CLI   BDCIND,BDCNTP                                                    
         BNE   PRBY6G                                                           
         MVI   BYTE,C'T'           IS TRADE                                     
         B     PRBY6G                                                           
*                                                                               
PRBY6    DS    0H                                                               
         TM    BDCIND,X'FE'        ALTERNATE NTP TEST                           
         BNZ   *+8                                                              
         MVI   BYTE,C'T'                                                        
*                                                                               
PRBY6G   DS    0H                                                               
         CLC   BYTE,QGMITVC        IS BUY OF RIGHT TYPE?                        
         BNE   PBEXIT              NO, SKIP                                     
*                                                                               
PRBY6J   DS    0H                                                               
         CLI   QTRADE,C' '         GROUP M CASH/TRADE FILTER ACTIVE?            
         BNH   PRBY6P              NO                                           
         XC    X(3),X              UNPACK REP CODE                              
         GOTO1 VRCPACK,DMCB,(C'U',BDREP),X                                      
         CLI   QTRADE,C'T'         DOING TRADE REQUEST?                         
         BNE   PRBY6L                                                           
         CLC   DARREP,X            HAS TO BE ONLY SPECIAL REP                   
         BNE   PBEXIT                                                           
         TM    BDCIND2,BDCCOMOQ                                                 
         BNO   PBEXIT              YES, SKIP THE BUY                            
         NI    BDCIND2,X'FF'-BDCCOMOQ   TURN OFF C-RATE                         
         MVC   TEMPTAX,BDNTAX      TRADE BUYS SHOULD NOT TAX                    
         XC    BDNTAX,BDNTAX                                                    
         B     PRBY6P                                                           
*                                                                               
PRBY6L   CLI   QTRADE,C'C'         DOING CASH REQUEST?                          
         BE    *+6                                                              
         DC    H'0'                                                             
         CLC   DARREP,X            SPECIAL REP?                                 
         BE    PBEXIT              YES, SKIP BUY                                
*                                                                               
PRBY6P   DS    0H                                                               
         XC    NETWFLDS,NETWFLDS   NETWORK WITHIN SPOTPAK IS DEFUNCT            
*                                  GET BUY ID NUM                               
         MVC   HOLDID,SPACES                                                    
         LA    R2,BUYREC                                                        
         MVI   ELCODE,X'70'                                                     
         BRAS  RE,GETEL                                                         
         BNE   *+10                                                             
         MVC   HOLDID,3(R2)                                                     
*                                  SET MKT/STA                                  
         MVI   ELCODE,X'68'        GET NETWORK                                  
         LA    R2,BUYREC                                                        
         BRAS  RE,GETEL                                                         
         B     *+8                                                              
PRBUY2C  DS    0H                                                               
         BRAS  RE,NEXTEL                                                        
         BNE   PRBUY2D                                                          
         CLI   1(R2),6             ?? WHY IS THIS TEST HERE??                   
         BNE   PRBUY2C                                                          
         MVC   DUB(4),2(R2)                                                     
         MVI   DUB+4,C'T'                                                       
         GOTO1 MSPACK,DMCB,=C'0000',DUB,X                                       
         MVC   HOLDNET,X+2                                                      
PRBUY2D  DS    0H                                                               
*                                  SEARCH COMMENTS FOR BILL=NO                  
         MVI   NOBILL,C'N'                                                      
         MVI   ELCODE,X'66'                                                     
         LA    R2,BUYREC                                                        
         BRAS  RE,GETEL                                                         
         B     *+8                                                              
PRBUY2E  DS    0H                                                               
         BRAS  RE,NEXTEL                                                        
         BNE   PRBUY2F                                                          
         CLC   =C'BILL=NO',3(R2)                                                
         BNE   PRBUY2E                                                          
         MVI   NOBILL,C'Y'                                                      
PRBUY2F  DS    0H                                                               
*                                                                               
         MVI   RQCOST2,C'N'        DO AGENCY COST FIRST (FOR COST2)             
*                                                                               
         LA    R2,X                                                             
         XC    X,X                                                              
         L     R9,MEDBUFF                                                       
         USING MEDBLOCK,R9                                                      
         MVC   X(1),BPRD        DUMMY PRD/SLN LIST                              
         MVI   X+2,0                                                            
         CLI   BPRD,X'FF'                                                       
         BNE   PRBUY5B                                                          
*                                  BUILD LIST OF PRD/SLN'S IF POL               
         GOTO1 MEDPSL,DMCB,SPWORKD,X                                            
*                                                                               
PRBUY5   DS    0H                                                               
         CLC   0(1,R2),2(R2)                                                    
         BE    PRBUY9              USE ONLY LAST ENTRY FOR PRD                  
         CLI   0(R2),X'FF'                                                      
         BE    PRBUY9                                                           
         CLI   0(R2),X'DB'         BYPASS UNALLOCATED                           
         BE    PRBUY9                                                           
PRBUY5B  DS    0H                                                               
         XC    SAVPGR,SAVPGR                                                    
         CLI   QPGR,C' '           TEST DOING PRDGRPS                           
         BE    PRBUY10                                                          
*                                  YES - FIND PGR                               
         L     RF,PRDLIST                                                       
PRBUY7   DS    0H                                                               
         CLC   5(1,RF),0(R2)                                                    
         BE    *+12                                                             
         LA    RF,6(RF)                                                         
         B     PRBUY7                                                           
*                                                                               
         CLI   PGRQ,C'A'                                                        
         BE    *+14                                                             
         CLC   0(2,RF),=X'9999'                                                 
         BE    PRBUY9              BYPASS IF NOT FOR RIGHT PGR                  
         MVC   SAVPGR,0(RF)                                                     
         UNPK  WORK(5),SAVPGR(3)                                                
         MVC   SAVPGRU,WORK                                                     
         B     PRBUY10                                                          
*                                                                               
PRBUY9   DS    0H                                                               
         LA    R2,2(R2)            NEXT PRD/SLN                                 
         CLI   0(R2),0                                                          
         BNE   PRBUY5                                                           
         B     PRBUY20             EOL                                          
*                                                                               
PRBUY10  DS    0H                                                               
         MVC   MEDBRAND,0(R2)                                                   
         MVI   MEDSPTLN,0                                                       
         TM    BDSTAT,X'01'        TEST NETPAK                                  
         BZ    *+14                                                             
         CLI   NETOPT,C'O'         SKIP NETPAK BUY IF 'OLD' REQ                 
         BE    PRBUY20                                                          
         DC    H'0'                NO NETPAK IN THIS PROGRAM ANY MORE           
*                                                                               
         CLI   NETOPT,C'N'         SKIP NON-NETPAK BUY IF NETPAK RUN            
         BE    PRBUY20                                                          
         XC    SPOTHOOK,SPOTHOOK                                                
         OC    MANGRS,MANGRS       FOR MANUAL                                   
         BNZ   *+12                                                             
         CLI   WIOPT,C'Y'          AND WI OPTION                                
         BNE   PRBUY10D                                                         
*                                                                               
         XC    MEDAFRST,MEDAFRST   FUDGE FIRST/LAST PERIODS                     
         XC    MEDALAST,MEDALAST                                                
         B     PRBUY11                AND BYPASS MEDGETBY                       
*                                                                               
PRBUY10D DS    0H                                                               
         CLI   MIDAS,C'Y'          FOR MIDAS DON'T TAX COS2                     
         BNE   PRBUY10F                                                         
         CLI   RQCOST2,C'Y'        ALREADY ON 2ND PASS?                         
         BNE   PRBUY10F                                                         
         MVC   TEMPTAX,BDNTAX                                                   
         XC    BDNTAX,BDNTAX                                                    
PRBUY10F GOTO1 MEDGETBY,DMCB,SPWORKD,0                                          
*                                                                               
PRBUY11  DS    0H                                                               
*                                                                               
         BAS   RE,BUYBK            BUILD BUY SORT KEYS AND                      
*                                  PASS TO SORT                                 
         B     PRBUY9                                                           
*                                                                               
PRBUY20  DS    0H                                                               
         CLI   MIDAS,C'Y'                                                       
         BE    *+12                                                             
         CLI   COST2SW,C'Y'        IF COST2                                     
         BNE   PRBUY22                                                          
         CLI   RQCOST2,C'Y'        ALREADY ON 2ND PASS?                         
         BNE   *+14                                                             
         MVC   BDNTAX,TEMPTAX      RESTORE TAX                                  
         B     PRBUY22                                                          
*                                                                               
         MVI   RQCOST2,C'Y'        NO, DO IT NOW                                
         LA    R2,X                START OF PRODUCT LIST                        
         B     PRBUY5                                                           
*                                                                               
PRBUY22  DS    0H                                                               
         CLI   NETOPT,C'N'                                                      
         BE    PRBUY32                                                          
         B     PBEXIT                                                           
         SPACE 2                                                                
*                             SPOT DETAILS                                      
*                                                                               
PRBUY32  DS    0H                                                               
         CLI   RECSW,0                                                          
         BE    PBEXIT                                                           
*                                                                               
         CLI   RCTRACE,C'Y'                                                     
         BNE   PRBUY34                                                          
         GOTO1 =V(PRTREC),DMCB,ADBUY,(24,13),PRINT,HEXOUT,C'DOME',     +        
               =C'PUT STATION BUCKET RECORD'                                    
*                                                                               
PRBUY34  DS    0H                                                               
         CLI   TESTFLAG,C'T'                                                    
         BE    PBEXIT                                                           
         CLI   RCWRITE,C'Y'                                                     
         BNE   PBEXIT                                                           
         MVC   AREC,ADBUY                                                       
         GOTO1 PUT                                                              
         B     PBEXIT                                                           
*                                                                               
PBEXIT   DS    0H                                                               
         CLI   QTRADE,C'T'         DOING TRADE REQUEST?                         
         BNE   *+14                                                             
         OI    BDCIND2,BDCCOMOQ    YES, TURN C-RATE BACK ON                     
         MVC   BDNTAX,TEMPTAX      RESTORE TAX                                  
         XIT1                                                                   
         SPACE 3                                                                
         GETEL R2,24,ELCODE                                                     
         EJECT                                                                  
*        BUILD BUYREC SORT KEYS AND PASS TO SORT                                
         SPACE 2                                                                
BUYBK    NTR1                                                                   
         SPACE 2                                                                
*                                                                               
         CLI   FCRDBUYS,C'I'                                                    
         BNE   *+8                                                              
         BRAS  RE,NOTEOUT                                                       
*                                                                               
         L     R4,MEDAFRST                                                      
*                                                                               
BUYBK100 DS    0H                                                               
         L     R5,4(R4)                                                         
         USING MEDDATA,R5                                                       
         XC    SORTREC,SORTREC                                                  
         L     R3,ASORTDTA                                                      
         OC    MANGRS,MANGRS       MANUAL BILL?                                 
         BZ    BUYBK120            NO                                           
*                                                                               
         CLI   MIDAS,C'Y'                                                       
         BE    *+12                                                             
         CLI   COST2SW,C'Y'        COST2 ESTIMATE?                              
         BNE   *+12                NO: ONLY STATION $ NEEDED                    
         CLI   RQCOST2,C'Y'        WHICH PASS?                                  
         BE    BUYBK110                                                         
*                                                                               
         MVC   RGRSD(4,R3),MANGRS  REGULAR                                      
         MVC   RNETD(4,R3),MANNET                                               
         B     BUYBK340                                                         
*                                                                               
BUYBK110 DS    0H                                                               
         MVC   RGRS2D(4,R3),MANGRS COST2 AMOUNTS AT +4                          
         MVC   RNET2D(4,R3),MANNET                                              
         B     BUYBK340                                                         
*                                                                               
BUYBK120 DS    0H                                                               
         CLI   WIOPT,C'Y'                                                       
         BNE   BUYBK170                                                         
*                                  WESTERN PW CODE                              
*                                  ---------------                              
         LA    R6,WIBLOCK                                                       
         L     R6,SPWAIO-SPWID(R6)                                              
         USING WIRECD,R6                                                        
         OC    KMKT,KMKT           TEST RIGHT MARKET                            
         BZ    *+14                (UNTIL SPB1WI FIXED TO FILTER)               
         CLC   WIKMKT,KMKT                                                      
         BNE   BUYBKX                                                           
         OC    KSTA,KSTA           AND RIGHT STATION                            
         BZ    *+14                                                             
         CLC   WIKSTA,KSTA                                                      
         BNE   BUYBKX                                                           
         MVC   KEY+9(1),WIKEST     RETURNED ESTIMATE                            
         MVC   BUYMSTA,WIKMKT      MKT/STA                                      
         MVC   WORK(2),WIKYM       MOS                                          
         MVI   WORK+2,1                                                         
         GOTO1 DATCON,DMCB,(3,WORK),(2,DUB)                                     
         MVC   SPOTDTE,DUB                                                      
         MVC   THISPER,WIKYM                                                    
*                                                                               
         OC    WIKSTA,WIKSTA       FOR MARKET TOTAL RECS (STA=NULLS)            
         BNZ   BUYBK140                                                         
         CLI   WIPASS,1   FOR PASS 1 SET CLIENT OVERRIDE DIFFERENCE             
         BNE   BUYBK130               ($0 BUY CALCULATIONS)                     
*                                                                               
*                     GROSS ONLY -NETS, ETC ARE FROM STATION RECS               
         L     R0,WICLOVDG                                                      
         ST    R0,RGRS2D(R3)                                                    
*                                  BUT WILA HAS ASKED THAT THE NET BE           
*                                  SET AT 85% RATHER THAN 0, AS IT WAS.         
         L     R1,RGRS2D(R3)                                                    
         M     R0,=F'85'                                                        
         LHI   RF,100                                                           
         DRNDR (R0),(RF)                                                        
         ST    R1,RNET2D(R3)                                                    
*                                                                               
         MVC   BUYMSTA+2(3),=X'FFFFFE'  DUMMY STATION CODE (8191)               
         B     BUYBK150                                                         
*                                                                               
BUYBK130 DS    0H      PASS 2 - ADJUSTMENTS -INCLUDES CLIENT                    
*                      AND WIM (AS OF DEC97) CURRENT - LOCKED                   
         CLI   SPWQBTYP-SPWID+WIBLOCK,C'D'   ONLY FOR DETAIL                    
         BNE   BUYBK360                                                         
         TM    WISTATUS,WISADJQ    ANY ADJUSTMENT PRESENT?                      
         BNZ   *+8                                                              
         BAS   RE,SETSKIP          NO, SKIP THE MKT/MOS                         
         MVC   RGRS2D(4,R3),WICLADJG    IF DETAIL USE ADJ'S (NOTE-              
*                                       +4 FOR 'CLIENT CURRENCY'                
         MVC   RGRSD(4,R3),WIWIMGD    WIM GROSS DIFFERENCE                      
         MVC   RNETD(4,R3),WIWIMND    WIM NET DIFFERENCE                        
         MVC   RNET2D(4,R3),WICLADJN                                            
         MVC   RSPT2D(4,R3),WICLADJS    SPOTS                                   
         MVC   RSPTD(4,R3),WICLADJS     (FOR GOOD MEASURE?)                     
*                                                                               
         L     R1,RGRS2D(R3)     ROUND GROSS TO WHOLE DOLLARS                   
         M     R0,=F'1'          NOTE- ADJUSTMENT ROUND STILL IN PLACE          
         LHI   RF,100                                                           
         DRNDR (R0),(RF)                                                        
         M     R0,=F'100'                                                       
         ST    R1,RGRS2D(R3)                                                    
*                                                                               
         MVC   BUYMSTA+2(3),=X'FFFFFF'  DUMMY STATION CODE (8191)               
         B     BUYBK160                                                         
*                                                                               
*              STATION LEVEL RECS                                               
*                                                                               
BUYBK140 DS    0H          'PW GROSS, ETC AT +4 (LIKE CLT CURRENCY)             
         CLI   WIPASS,1     ONLY 1 PASS FOR STATION LEVEL RECS                  
         BNE   BUYBK360                                                         
*                                                                               
         L     R0,WICLTG                                                        
         ST    R0,RGRS2D(R3)                                                    
*                                                                               
         MVC   RNET2D(4,R3),WICLTN                                              
         MVC   RTAX2D(4,R3),WITAX                                               
*                        'TRUE' GROSS, ETC AT +0 (LIKE AGY CURRENCY)            
         MVC   RGRSD(4,R3),WIWIMG                                               
         MVC   RNETD(4,R3),WIWIMN                                               
         MVC   RTAXD(4,R3),WIWIMX                                               
*                                                                               
BUYBK150 DS    0H                                                               
         MVC   RSPTD(4,R3),WISPTS                                               
         MVC   RSPT2D(4,R3),WISPTS       IN 2ND SLOT AS WELL                    
BUYBK160 DS    0H                                                               
         OC    0(ROWHL,R3),0(R3)         TEST ANY DATA                          
         BZ    BUYBK360                                                         
*                                                                               
         B     BUYBK300                                                         
         DROP  R6                                                               
*                                                                               
BUYBK170 DS    0H                                                               
*                                                                               
*        CLI   MIDAS,C'Y'          FOR MIDAS DON'T DO COS2 CHECK                
*        BE    BUYBK173                                                         
**** PATCH                                                                      
         CLC   =C'FM',QAGY         FOR AGY FM, MED R, CLT CRC SKIP COS2         
         BNE   *+22                                                             
         CLI   QMED,C'R'                                                        
         BNE   *+14                                                             
         CLC   =C'CRC',QCLT                                                     
         BE    BUYBK173                                                         
**** PATCH                                                                      
         MVI   COST2SW,C'N'        ASSUME THIS ISN'T A COST2 BUY                
         MVI   CLTCURR,0                                                        
         MVI   CURR2,0                                                          
         LA    R2,BUYREC                                                        
         MVI   ELCODE,X'73'        IF X'73' ELEMENT IS PRESENT...               
         BRAS  RE,GETEL                                                         
         BNE   BUYBK173                                                         
*===  TEMPORARY                                                                 
         OC    2(4,R2),2(R2)       IF COS2 FACTOR IS NULLS...                   
         BZ    BUYBK173            ...IT'S A BOGUS ELEMENT                      
         CLC   2(4,R2),=X'80000000'  ZERO SOMETIMES LOOKS LIKE THIS!            
         BZ    BUYBK173            ...IT'S A BOGUS ELEMENT                      
*===                                                                            
         L     RF,=X'40000000'     LOOK FOR BAD ELEM AND SKIP IT                
BUYBK172 C     RF,2(R2)                                                         
         BE    BUYBK173            BAD ELEM, NOT COS2                           
         SRL   RF,1                                                             
         LTR   RF,RF                                                            
         BNZ   BUYBK172                                                         
*                                                                               
         MVI   COST2SW,C'Y'        ... THEN IT'S COST2                          
         MVI   CLTCURR,1                                                        
         MVI   CURR2,1                                                          
*                                                                               
BUYBK173 CLI   MIDAS,C'Y'                                                       
         BE    *+12                                                             
         CLI   COST2SW,C'Y'                                                     
         BNE   BUYBK220                                                         
*                                                                               
*                        COST2 OPTION                                           
*                        ------------                                           
         CLI   RQCOST2,C'Y'        WHICH PASS?                                  
         BE    BUYBK210                                                         
*                                  FIRST PASS                                   
         MVC   RGRSD(4,R3),MEDBYGRS                                             
         MVC   RNETD(4,R3),MEDBYNET                                             
         MVC   RTAXD(4,R3),MEDBYTAX                                             
         MVC   RSPTD(4,R3),MEDBYSPT                                             
*                                                                               
         CLI   PAYOPT,C'N'         PAID ONLY?                                   
         BE    BUYBK180                                                         
         MVC   RGRSD(4,R3),MEDBYPAY                                             
         MVC   RNETD(4,R3),MEDBYNPY                                             
         MVC   RTAXD(4,R3),MEDBYTXP                                             
         MVC   RSPTD(4,R3),MEDBYPSP                                             
*                                                                               
BUYBK180 DS    0H                                                               
         CLI   PAYOPT,C'M'         TEST WHOLE MARKET PAID OPTION                
         BNE   BUYBK200                                                         
         CLC   MEDBYGRS,MEDBYPAY                                                
         BNE   BUYBK190                                                         
         CLC   MEDBYNET,MEDBYNPY                                                
         BNE   BUYBK190                                                         
         CLC   MEDBYTAX,MEDBYTXP                                                
         BNE   BUYBK190                                                         
         CLC   MEDBYSPT,MEDBYPSP                                                
         BNE   BUYBK190                                                         
         B     BUYBK200                                                         
*                                                                               
BUYBK190 DS    0H                                                               
         BAS   RE,SETSKIP         SET TO SKIP THIS PRD/EST/MKT/MOS              
*                                                                               
BUYBK200 DS    0H                                                               
         B     BUYBK290                                                         
*                                                                               
BUYBK210 DS    0H                  2ND COST2 PASS                               
         MVC   RGRS2D(4,R3),MEDBYGRS    COST2 AMOUNTS AT +4                     
         MVC   RNET2D(4,R3),MEDBYNET                                            
         MVC   RTAX2D(4,R3),MEDBYTAX                                            
         MVC   RSPT2D(4,R3),MEDBYSPT                                            
*                                                                               
         CLI   PAYOPT,C'N'         PAID ONLY?                                   
         BE    BUYBK290                                                         
         MVC   RGRS2D(4,R3),MEDBYPAY                                            
         MVC   RNET2D(4,R3),MEDBYNPY                                            
         MVC   RTAX2D(4,R3),MEDBYTXP                                            
         MVC   RSPT2D(4,R3),MEDBYPSP                                            
         B     BUYBK290                                                         
*                                                                               
*                        REGULAR BILLING CODE                                   
*                        --------------------                                   
BUYBK220 DS    0H                                                               
         MVC   RGRSD(4,R3),MEDBYGRS                                             
         MVC   RNETD(4,R3),MEDBYNET                                             
         MVC   RTAXD(4,R3),MEDBYTAX                                             
         MVC   RSPTD(4,R3),MEDBYSPT                                             
         CLI   CLTCURR,0           IF DOING CLIENT CURR                         
         BNE   BUYBK230                                                         
         CLI   STNCOPT,C'Y'        OR STATION CURR                              
         BNE   BUYBK240                                                         
         L     RE,ADSTAT                                                        
         CLI   SCOUNTRY-STAREC(RE),C'U'    IF US STATION                        
         BNE   BUYBK240                                                         
*                                                                               
BUYBK230 DS    0H                                                               
         MVC   RGRS2D(4,R3),MEDXCHG    2ND CURRENCY                             
         MVC   RNET2D(4,R3),MEDXCHN                                             
         MVC   RTAX2D(4,R3),MEDXCHT                                             
         MVC   RSPT2D(4,R3),MEDBYSPT   (SPOTS REPEATED)                         
*                                                                               
BUYBK240 DS    0H                                                               
         CLI   PAYOPT,C'N'                                                      
         BE    BUYBK280                                                         
         MVC   RGRSD(4,R3),MEDBYPAY                                             
         MVC   RNETD(4,R3),MEDBYNPY                                             
         MVC   RTAXD(4,R3),MEDBYTXP                                             
         MVC   RSPTD(4,R3),MEDBYPSP                                             
         CLI   CLTCURR,0           IF DOING CLIENT CURR                         
         BNE   BUYBK250                                                         
         CLI   STNCOPT,C'Y'        OR STATION CURR                              
         BNE   BUYBK260                                                         
         L     RE,ADSTAT                                                        
         CLI   SCOUNTRY-STAREC(RE),C'U'    IF US STATION                        
         BNE   BUYBK260                                                         
*                                                                               
BUYBK250 DS    0H                                                               
         MVC   RGRS2D(4,R3),MEDXCHGP   2ND CURRENCY                             
         MVC   RNET2D(4,R3),MEDXCHNP                                            
         MVC   RTAX2D(4,R3),MEDXCHTP                                            
         MVC   RSPT2D(4,R3),MEDBYSPT   (SPOTS REPEATED)                         
*                                                                               
BUYBK260 DS    0H                                                               
         CLI   PAYOPT,C'M'         TEST WHOLE MARKET PAID OPTION                
         BNE   BUYBK280                                                         
         CLC   MEDBYGRS,MEDBYPAY                                                
         BNE   BUYBK270                                                         
         CLC   MEDBYNET,MEDBYNPY                                                
         BNE   BUYBK270                                                         
         CLC   MEDBYTAX,MEDBYTXP                                                
         BNE   BUYBK270                                                         
         CLC   MEDBYSPT,MEDBYPSP                                                
         BNE   BUYBK270                                                         
         CLC   MEDXCHG,MEDXCHGP                                                 
         BNE   BUYBK270                                                         
         CLC   MEDXCHN,MEDXCHNP                                                 
         BNE   BUYBK270                                                         
         CLC   MEDXCHT,MEDXCHTP                                                 
         BE    BUYBK280                                                         
*                                                                               
BUYBK270 DS    0H                                                               
         BAS   RE,SETSKIP         SET TO SKIP THIS PRD/EST/MKT/MOS              
*                                                                               
BUYBK280 DS    0H                                                               
         CLI   CLTCURR,0           IF DOING CLIENT CURRENCY                     
         BE    BUYBK290                                                         
         L     R0,RGRSD(R3)        REVERSE NORMAL AND EXHANGE                   
         L     R1,RGRS2D(R3)                                                    
         ST    R0,RGRS2D(R3)       TO GET AGENCY FIRST THEN CLIENT              
         ST    R1,RGRSD(R3)                                                     
         L     R0,RNETD(R3)                                                     
         L     R1,RNET2D(R3)                                                    
         ST    R0,RNET2D(R3)                                                    
         ST    R1,RNETD(R3)                                                     
         L     R0,RTAXD(R3)                                                     
         L     R1,RTAX2D(R3)                                                    
         ST    R0,RTAX2D(R3)                                                    
         ST    R1,RTAXD(R3)                                                     
         L     R0,RSPTD(R3)                                                     
         L     R1,RSPT2D(R3)                                                    
         ST    R0,RSPT2D(R3)                                                    
         ST    R1,RSPTD(R3)                                                     
*                                                                               
BUYBK290 DS    0H                                                               
         OC    0(ROWHL,R3),0(R3)         TEST ANY DATA                          
         BZ    BUYBK360                                                         
         OC    RGRSD(4,R3),RGRSD(R3)    TEST ANY $                              
         BNZ   BUYBK295                                                         
         OC    RGRS2D(4,R3),RGRS2D(R3)                                          
         BNZ   BUYBK295                                                         
         OC    RNETD(4,R3),RNETD(R3)                                            
         BNZ   BUYBK295                                                         
         OC    RNET2D(4,R3),RNET2D(R3)                                          
         BNZ   BUYBK295                                                         
         CLI   NOBILL,C'Y'         TEST TO SKIP THIS 0$ BUY                     
         BE    BUYBK360                                                         
*                                                                               
BUYBK295 DS    0H                                                               
         LR    RF,R4                                                            
         S     RF,MEDAFRST                                                      
         SRL   RF,1                                                             
         LA    RF,PERLIST(RF)                                                   
         MVC   THISPER,PERLMOS-PERLISTD(RF)       SAVE THIS YM                  
*                                                                               
BUYBK300 DS    0H                                                               
         CLI   PERCTL,C'T'         IF MULTI MONTH                               
         BNE   BUYBK310                                                         
*                                                                               
         CLC   CURPER,EFFDTE       AND CURRENT MO NOT LOWER THA                 
         BL    BUYBK310            FORMULA EFF DATE                             
         CLC   THISPER,EFFDTE                                                   
         BL    BUYBK360            BYPASS ALL MONTHS BEFORE EFF DATE            
BUYBK310 DS    0H                                                               
*              WHAT NETWORK 'MODE' DOES MONTH FALL IN                           
*              NOTE- DATES BEFORE CNETSTRT ARE ALSO BY STATION                  
         MVC   DUB(2),CNETSTRT     START FOR FEATURE 1 (BY NET)                 
         MVC   DUB+2(2),CNETSTR2   START OF FEATURE 2 (BY STATION)              
         CLI   DUB,0               IF NO DATE                                   
         BNE   *+8                                                              
         MVI   DUB,X'FF'           SET TO FF                                    
         CLI   DUB+2,0             IF NO DATE                                   
         BNE   *+8                                                              
         MVI   DUB+2,X'FF'         SET TO FF                                    
*                                  WHAT PERIOD DOES CURPER FALL IN              
         MVI   DUB+4,3                                                          
         CLC   CURPER,DUB+2        START 2 OR LATER                             
         BNL   BUYBK320                                                         
         MVI   DUB+4,1                                                          
         CLC   CURPER,DUB          LOWER THAN  START 1                          
         BL    BUYBK320                                                         
         MVI   DUB+4,2             ELSE GROUP 2 (BY NET)                        
*                                                                               
BUYBK320 DS    0H                                                               
*                                  WHAT PERIOD DOES THISPER FALL IN             
         MVI   DUB+5,3                                                          
         CLC   THISPER,DUB+2       START 2 OR LATER                             
         BNL   BUYBK330                                                         
         MVI   DUB+5,1                                                          
         CLC   THISPER,DUB         LOWER THAN  START 1                          
         BL    BUYBK330                                                         
         MVI   DUB+5,2             ELSE GROUP 2 (BY NET)                        
*                                                                               
BUYBK330 DS    0H                                                               
         CLC   DUB+4(1),DUB+5      CURPER AND THISPER THE SAME GROUP            
         BNE   BUYBK360            NO, SKIP                                     
*                                                                               
         CLI   PERCTL,C'T'         IF MULTI MONTH                               
         BNE   BUYBK340                                                         
         CLI   CVATCOD,0           AND IF CANADIAN  VAT                         
         BE    BUYBK340                                                         
         CLC   CURPER,CVATSTRT     AND CURR MO NO LOWER THAN                    
         BL    BUYBK340            VAT START DATE                               
         CLC   THISPER,CVATSTRT    BYPASS EARLIER MONTHS                        
         BL    BUYBK360                                                         
*                                                                               
BUYBK340 DS    0H                                                               
         L     R3,ABRKTAB                                                       
         USING BRKTABD,R3                                                       
BUYBK350 DS    0H                                                               
         L     RF,BRKCODE                                                       
         LTR   RF,RF                                                            
         BZ    *+16                                                             
         BAS   RE,BUYBRKS-4(RF)                                                 
         LA    R3,BRKL(R3)                                                      
         B     BUYBK350                                                         
*                                                                               
         CLI   WBSW,C'Y'                                                        
         BNE   BUYBK355                                                         
         L     R1,APRD             PRODUCT CODE (ALPHA SEQ)                     
         ZIC   RF,0(R1)                                                         
         MHI   RF,4                CLIST ENTRY SIZE IS 4                        
         L     RE,ADCLT                                                         
         LA    RE,CLIST-CLTHDR(RE,RF)                                           
         MVC   WORD(3),0(RE)       ALPHA PRODUCT CODE                           
         L     R1,AEST                                                          
         MVC   WORD+3(1),0(R1)     BINARY ESTIMATE NUMBER                       
         L     RF,=A(CHKWBFLT)                                                  
         BASR  RE,RF                                                            
         BNE   BUYBK360            NOT FOUND, BUYPASS THIS BUY                  
*                                                                               
BUYBK355 L     R2,ASORTDTA                                                      
         XC    HALF2,HALF2                                                      
         BRAS  RE,TOSORT                                                        
*        BRAS  RE,HOLDCK                                                        
*                                                                               
BUYBK360 DS    0H                                                               
         LA    R4,L'MEDDATES(R4)                                                
         C     R4,MEDALAST                                                      
         BNH   BUYBK100                                                         
*                                                                               
BUYBKX   DS    0H                                                               
         B     PBEXIT                                                           
         DROP  R5                                                               
         SPACE 2                                                                
BUYBRKS  DS    0F                                                               
         B     BKPGR1                                                           
         B     BKPGR2                                                           
         B     BKPGR3                                                           
         B     BKPRD                                                            
         B     BKEST                                                            
         B     BKMGR                                                            
         B     BKMGR                                                            
         B     BKMGR                                                            
         B     BKMKT                                                            
         B     BKNET                                                            
         B     BKSTA                                                            
         B     BKPKG                                                            
         B     BKPGM                                                            
         B     BKDESC                                                           
         B     BKPER                                                            
         B     BKPERG                                                           
         B     BKCTYP                                                           
         B     BKFLT                                                            
         SPACE 2                                                                
BKPGR1   DS    0H                                                               
         LA    R2,SAVPGRU                                                       
         B     BKALL                                                            
         SPACE 2                                                                
BKPGR2   DS    0H                                                               
         LA    R2,SAVPGRU                                                       
         ZIC   RF,PGR1LEN                                                       
         AR    R2,RF               POINT TO PGR2                                
         B     BKALL                                                            
         SPACE 2                                                                
BKPGR3   DS    0H                                                               
         LA    R2,SAVPGRU                                                       
         ZIC   RF,PGR2LEN                                                       
         AR    R2,RF               POINT TO PGR3                                
         B     BKALL                                                            
         SPACE 2                                                                
BKPRD    DS    0H                  PRD                                          
*                                  GET PROD SEQ NO FROM PROD CODE               
         L     RF,ADCLT                                                         
         LA    RF,CLIST-CLTHDR(RF)                                              
         LR    R0,RF                                                            
         CLC   MEDBRAND,3(RF)                                                   
         BE    *+12                                                             
         LA    RF,4(RF)                                                         
         B     *-14                                                             
*                                                                               
         SR    RF,R0                                                            
         SRL   RF,2                                                             
         STC   RF,BYTE                                                          
         LA    R2,BYTE                                                          
         B     BKALL                                                            
         SPACE 2                                                                
BKEST    DS    0H                  EST                                          
         LA    R2,KEY+9            TAKE EST FROM KEY                            
*                                  (NECESSARY FOR PIG PASSIVES)                 
         CLI   FCRDBUYS,C'I'       IF BY ID'S                                   
         BNE   *+8                                                              
         LA    R2,BUYREC+9         USE BUYREC EST                               
         B     BKALL                                                            
         SPACE 2                                                                
BKPER    DS    0H                  PERIOD                                       
         OC    MANGRS,MANGRS       FOR MANUALS, USE 1ST PERIOD                  
         BNZ   BKPER4                                                           
         CLI   NETOPT,C'N'         TEST DOING SPOT DETAILS                      
         BE    BKPER1                                                           
         CLI   WIOPT,C'Y'          OR WI OPTION                                 
         BNE   BKPER4                                                           
*                                  FIND PERIOD THAT CONTAINS SPOT DATE          
BKPER1   DS    0H                                                               
         LA    R2,PERLIST                                                       
         USING PERLISTD,R2                                                      
BKPER2   DS    0H                                                               
         CLC   SPOTDTE,PERLEND                                                  
         BNH   *+12                                                             
         LA    R2,PERLISTL(R2)                                                  
         B     BKPER2                                                           
         DROP  R2                                                               
*                                                                               
         LA    R0,PERLIST                                                       
         SR    R2,R0                                                            
         STC   R2,BYTE             DISP = CODE FOR PERIOD                       
         LA    R2,BYTE                                                          
         B     BKALL                                                            
*                                                                               
BKPER4   DS    0H                                                               
         LR    RF,R4                                                            
         S     RF,MEDAFRST                                                      
         SRL   RF,1                FROM 12X TO 6X                               
         STC   RF,BYTE                                                          
         LA    R2,BYTE             DISP OF DATE INTO PERLIST                    
         B     BKALL                                                            
         SPACE 2                                                                
BKPERG   DS    0H                                                               
         OC    MANGRS,MANGRS       FOR MANUALS, USE 1ST PERIOD                  
         BNZ   BKPERG4                                                          
         CLI   NETOPT,C'N'         TEST DOING SPOT DETAILS                      
         BE    *+12                                                             
         CLI   WIOPT,C'Y'          OR WI OPTION                                 
         BNE   BKPERG4                                                          
*                                                                               
         LA    RF,PERLIST                                                       
         USING PERLISTD,RF                                                      
BKPERG2  DS    0H                                                               
         CLC   SPOTDTE,PERLEND                                                  
         BNH   BKPERG5                                                          
         LA    RF,PERLISTL(RF)                                                  
         B     BKPERG2                                                          
*                                                                               
BKPERG4  DS    0H                                                               
         LR    RF,R4                                                            
         S     RF,MEDAFRST                                                      
         SRL   RF,1                INDEX INTO PERLIST                           
         LA    RF,PERLIST(RF)                                                   
*                                                                               
BKPERG5  DS    0H                                                               
         LA    R2,=C'1'            OLD MONTHS                                   
         CLC   PERLMOS,CURPER                                                   
         BNE   BKALL                                                            
         CLI   PRIOR,C'W'          W = CURRENT MONTH SEPARATE                   
         BE    *+12                                                             
         CLI   PRIOR,C'M'          M = CURRENT MONTH SEPARATE                   
         BNE   BKALL                                                            
         LA    R2,=C'5'                                                         
         B     BKALL                                                            
         DROP  RF                                                               
         SPACE 2                                                                
BKMGR    DS    0H                                                               
         CLI   MGRBKTS,C'Y'        IF MGR BUCKETS                               
         BNE   *+16                                                             
         LA    R2,HOLDID+1           USE ID AS MGR                              
         CLI   0(R2),C' '                                                       
         BH    BKMGRD                                                           
*                                                                               
         CLC   BUYMSTA(2),SAVMKT                                                
         BE    BKMGRC              SAME AS LAST MKT                             
         MVC   SAVMKT,BUYMSTA                                                   
         L     RF,MKTLIST                                                       
BKMGRA   DS    0H                                                               
         OC    2(2,RF),2(RF)       EOL                                          
         BNZ   *+12                                                             
         LA    RF,=X'9999'         IN NO MGR                                    
         B     BKMGRB                                                           
         CLC   2(2,RF),SAVMKT                                                   
         BE    BKMGRB                                                           
         LA    RF,5(RF)                                                         
         B     BKMGRA                                                           
BKMGRB   DS    0H                                                               
         MVC   SAVMGR,0(RF)                                                     
BKMGRC   DS    0H                                                               
         CLI   MGRQ,C'A'                                                        
         BNE   *+20                NOT 'A' CHK FOR 9999                         
         CLI   QSTA+1,C'*'         IF 'A' SEE IF FILTERING                      
         BE    *+12                IF YES, ALSO CHECK FOR 9999                  
         CLI   QSTA+2,C'*'                                                      
         BNE   *+14                                                             
*                                                                               
         CLC   SAVMGR,=X'9999'                                                  
         BE    PBEXIT              BYPASS IF NOT FOR THIS MGR                   
*                                                                               
         UNPK  WORK(5),SAVMGR(3)                                                
         MVC   SAVMGRU,WORK                                                     
         LA    R2,SAVMGRU                                                       
*                                                                               
BKMGRD   DS    0H                                                               
         CLI   BRKCODE+3,MGR1EQ*4                                               
         BE    BKALL                                                            
         LR    R0,R2                                                            
         ZIC   RF,MGR1LEN                                                       
         AR    R2,RF               POINT TO MGR2                                
         CLI   BRKCODE+3,MGR2EQ*4                                               
         BE    BKALL                                                            
         LR    R2,R0                                                            
         ZIC   RF,MGR2LEN                                                       
         AR    R2,RF               POINT TO MGR3                                
         B     BKALL                                                            
*                                                                               
         SPACE 2                                                                
BKMKT    DS    0H                  MARKET                                       
         LA    R2,BUYMSTA          USE NORMAL MARKET                            
         OC    CNETSTRT,CNETSTRT   IF CANADIAN NETWORK OPT OFF                  
         BZ    BKALL                                                            
         CLC   THISPER,CNETSTRT    ELSE IS THIS MONTH BEFORE                    
         BL    BKALL               AGAIN, USE NORMAL MARKET                     
         OC    CNETSTR2,CNETSTR2   IF 2ND FEATURE ACTIVE                        
         BZ    *+14                MARKET 0000                                  
         CLC   THISPER,CNETSTR2    IF AFTER 2ND FEATURE START                   
         BNL   BKALL               AGAIN, USE NORMAL MARKET                     
*                                                                               
         LA    R2,=X'0000'         MARKET 0000                                  
         B     BKALL                                                            
         SPACE 2                                                                
BKSTA    DS    0H                  STATION                                      
         CLI   RETPROF+13,C'Y'     TEST BACKER SPECIAL                          
         BNE   *+18                STATION PRINT                                
         L     R5,ASORTCOM                                                      
         L     RF,ADSTAT                                                        
         MVC   0(4,R5),SCHNL-STAREC(RF)                                         
*                                                                               
         LA    R2,BUYMSTA+2        USE STA                                      
         OC    CNETSTRT,CNETSTRT   UNLESS CANADIAN NETWORK OPT                  
         BZ    BKALL                                                            
         CLC   THISPER,CNETSTRT                                                 
         BL    BKALL                                                            
         OC    CNETSTR2,CNETSTR2   IF 2ND FEATURE ACTIVVE                       
         BZ    *+14                                                             
         CLC   THISPER,CNETSTR2    AND THIS MONTH AFTER                         
         BNL   BKALL                                                            
*                                                                               
         LA    R2,HOLDNET          THEN USE NETWORK AS STATION                  
         B     BKALL                                                            
         SPACE 2                                                                
BKNET    DS    0H                  CANADIAN NETWORK                             
         LA    R2,HOLDNET                                                       
         B     BKALL                                                            
         SPACE 2                                                                
BKPGM    DS    0H                  PROGRAM                                      
         CLI   ZLSW,C'Y'           TEST ALREADY BILLED                          
         BER   RE                  YES - SKIP SPOT DETAILS                      
         LA    R2,BDPROGRM                                                      
         B     BKALL                                                            
         SPACE 2                                                                
BKDESC   DS    0H                  DESC - DATE, LEN, LINE                       
         CLI   ZLSW,C'Y'           TEST ALREADY BILLED                          
         BER   RE                  YES - SKIP SPOT DETAILS                      
         BRAS  RE,NOTEOUT2                                                      
         XC    WORK,WORK                                                        
         MVC   WORK(2),SPOTDTE                                                  
         MVC   WORK+2(1),BDSEC                                                  
         MVC   WORK+4(1),BUYKBUY   1 BYTE BUYLINE                               
         TM    BUYREC+15,BUYRLN2   TEST 2-BYTE LINE                             
         BZ    *+10                                                             
         MVC   WORK+3(2),BUYKBUY   2-BYTE LINE                                  
         MVC   WORK+5(1),SPOTNO    SPOT NO. (FOR UNIQUENESS)                    
         LA    R2,WORK                                                          
         B     BKALL                                                            
         SPACE 2                                                                
BKPKG    DS    0H                  PACKAGE (NETWORK)                            
         LA    R2,NETWPKG                                                       
         B     BKALL                                                            
         SPACE 2                                                                
BKCTYP   DS    0H                  TYPE OF CHARGE (TIME OR INT)                 
         LA    R2,CTYPSW                                                        
         B     BKALL                                                            
         SPACE 2                                                                
BKFLT    DS    0H                  WB FLIGHT FROM 1ST EST UCOM                  
         LA    R2,WBFLT                                                         
         B     BKALL                                                            
         SPACE 2                                                                
BKALL    DS    0H                                                               
         LA    R5,SORTKEY                                                       
         A     R5,BRKDISP                                                       
         L     RF,BRKLENM1                                                      
         EX    RF,*+6                                                           
         BR    RE                                                               
         MVC   0(0,R5),0(R2)                                                    
         SPACE 2                                                                
         DROP  R3                                                               
         EJECT                                                                  
*                   SETSKIP  - SET TO SKIP PRD/EST/MKT/MOS                      
*                              (R4 HAS A(MED SLOT))                             
         SPACE 2                                                                
SETSKIP  NTR1                                                                   
         XC    WORK,WORK                                                        
         LA    R5,WORK                                                          
         USING SKPTABD,R5                                                       
*                                                                               
         MVI   SKPPRD,X'FF'        NO PRODUCT                                   
         CLC   APRDBRK,AINVBRK     IF PRD NOT SEPARATE                          
         BH    SETSK04                                                          
*                                  GET PROD SEQ NO FROM PROD CODE               
         L     RF,ADCLT                                                         
         LA    RF,CLIST-CLTHDR(RF)                                              
         LR    R0,RF                                                            
         CLC   MEDBRAND,3(RF)                                                   
         BE    *+12                                                             
         LA    RF,4(RF)                                                         
         B     *-14                                                             
*                                                                               
         SR    RF,R0                                                            
         SRL   RF,2                                                             
         STC   RF,SKPPRD                                                        
*                                                                               
SETSK04  DS    0H                                                               
         MVI   SKPEST,X'FF'        NO EST                                       
         CLC   AESTBRK,AINVBRK     IF EST NOT SEPARATE                          
         BH    SETSK06                                                          
         LA    R2,KEY+9            TAKE EST FROM KEY                            
*                                  (NECESSARY FOR PIG PASSIVES)                 
         CLI   FCRDBUYS,C'I'       IF BY ID'S                                   
         BNE   *+8                                                              
         LA    R2,BUYREC+9         USE BUYREC EST                               
         MVC   SKPEST,0(R2)                                                     
*                                                                               
SETSK06  DS    0H                                                               
         MVC   SKPMKT,BUYMSTA      ALWAYS SET MARKET                            
         LR    RF,R4               ADDRESS OF THIS MED SLOT                     
         S     RF,MEDAFRST         NOW HAVE DISP                                
         SRL   RF,1                FROM 12 TO 6 PER SLOT                        
         STC   RF,SKPMOS           GIVES PERIOD NUMBER (PERLIST DISP)           
*                                                                               
         GOTO1 BINSRCH,SKPPARS,(1,WORK)   ADD TO TABLE                          
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         XIT1                                                                   
         DROP  R5                                                               
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
TEMPTAX  DS    CL2                                                              
*                                                                               
NOTEOUT  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R6,ADCONLST                                                      
         USING SPADCONS,R6                                                      
         GOTOR VSMTP,DMCB,('SMTPAINI',JESMAIL)                                  
         GOTOR VSMTP,DMCB,('SMTPAPRS',TOWHO),(L'SUBJECT,SUBJECT)                
***                                                                             
* GET JOB/STEP NAMES                                                            
***                                                                             
         LA    R4,FULL                                                          
         EXTRACT (R4),FIELDS=TIOT                                               
*                                                                               
         L     R4,FULL                                                          
         USING TIOTD,R4                                                         
         MVC   P(8),TIOCNJOB                                                    
         MVC   P+9(8),TIOCPSTN     PROC STEP NAME                               
         DROP  R4                                                               
*                                                                               
         MVC   P+18(80),QAREA                                                   
         GOTOR VSMTP,DMCB,('SMTPAPTL',P)                                        
         GOTOR VSMTP,DMCB,('SMTPASND',0)                                        
         GOTOR VSMTP,DMCB,('SMTPAEND',0) DETACH SMTP                            
         DROP  R6                                                               
*                                                                               
         J     EXIT                                                             
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
JESMAIL  DC    CL8'JESMAIL '                                                    
TOWHO    DC    C'MHER,EJOR,YKVA,TZIH:'                                          
SUBJECT  DC    C'SB1 RUNNING IN ID SEQUENCE'                                    
         EJECT                                                                  
NOTEOUT2 NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         MVC   OPMSG+54(2),QAGY    DISPLAY AGENCY                               
         MVC   OPMSG+64(1),QMED    MEDIA                                        
         MVC   OPMSG+71(3),CLT     CLIENT                                       
         GOTO1 DATAMGR,DMCB,=C'OPMSG',(L'OPMSG,OPMSG)                           
         J     EXIT                                                             
         LTORG                                                                  
*                                                                               
OPMSG    DC    C'AUTONOTE*ERATDDNY:SB1 HIT 2-BYTE BUYLINE CODE. AGENCY=X        
               XX, MEDIA=X, CLT=XXX'                                            
         EJECT                                                                  
*                                                                               
BLDBHLDT NMOD1 DMWORKQ,BLDBHLD    BUILD TABLE OF BHOLD RECS FOR CLT             
         LR    R7,RC                                                            
         USING DMWORKD,R7                                                       
         LA    RC,SPACEND                                                       
         CLI   BYTE,C'P'                                                        
         BNE   *+12                                                             
         BRAS  RE,BLDBPCT                                                       
         B     BLDBHX                                                           
*                                                                               
         XC    XSPKEY,XSPKEY                                                    
         LA    R3,XSPKEY           BUILD BHOLD RECORD KEY                       
         USING BHLDRECD,R3                                                      
         MVI   BHLDKSYS,BHLDKSYQ   X'0E07' RECORDS                              
         MVI   BHLDKSTP,BHLDKSTQ                                                
         MVC   BHLDKAM,BAGYMD      AGENCY/MEDIA                                 
         MVC   BHLDKCLI,BCLT       CLIENT                                       
         MVC   XSPKEYSV,XSPKEY                                                  
*                                                                               
         GOTO1 DATAMGR,DMCB,DMRDHI,=C'XSPDIR',XSPKEYSV,XSPKEY                   
         B     BLDHL15                                                          
*                                                                               
BLDHL10  GOTO1 DATAMGR,DMCB,DMRSEQ,=C'XSPDIR',,XSPKEY                           
*                                                                               
BLDHL15  CLI   DMCB+8,0                                                         
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   BHLDKEY(BHLDKPRD-BHLDKEY),XSPKEYSV   COMP INCL CLIENT            
         BNE   BLDBHX              NOTHING ELSE FOR THIS CLIENT                 
*                                                                               
         GOTO1 DATAMGR,DMCB,GETREC,=C'XSPFIL',BHLDDA,A(XSPIO),DMWORKX           
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,=A(XSPIO)                                                     
         USING HLDELD,R6                                                        
*                                                                               
         LA    R6,BHLDELDQ(R6)     POINT TO 1ST ELEM                            
         CLI   0(R6),HLDELCDQ      SHOULD BE X'10' ELEM                         
         BE    *+6                                                              
         DC    H'0'                                                             
         CLC   TODAYP,HLDELDAT     PAST EFFECTIVE DATE ?                        
         BH    BLDHL10             YES, SKIP                                    
*                                                                               
         XC    WK,WK               USE TO BUILD A REC FOR MY TABLE              
         LA    R2,WK                                                            
         USING BHOLDTD,R2                                                       
         MVC   BHLDAM,BHLDKAM                                                   
         MVC   BHLDCLT,BHLDKCLI                                                 
         MVC   BHLDPRD,BHLDKPRD                                                 
         MVC   BHLDEST,BHLDKEST                                                 
         MVC   BHLDMKS,BHLDKMKS                                                 
         MVC   BHLDMOS,BHLDKMOS                                                 
         MVC   BHLDGRS,HLDELGRS                                                 
         MVC   BHLDNET,HLDELNET                                                 
         XC    BHLDTAX,BHLDTAX                                                  
*                                           READ MASTER REC FOR TAX             
         GOTO1 MSUNPK,DMCB,BHLDMKS,FULL,DUB                                     
         XC    KEY,KEY                                                          
         MVI   KEY,C'0'                                                         
         MVC   KEY+1(L'STAKEY-1),KEY                                            
         LA    R4,KEY                                                           
         USING STARECD,R4                                                       
         MVI   STAKTYPE,STAKTYPQ                                                
         MVC   STAKMED,QMED                                                     
         MVC   STAKCALL,DUB                                                     
         CLI   QMED,C'T'                                                        
         BNE   *+8                                                              
         MVI   STAKCALL+4,C'T'     FOR TV MOVE IN BAND                          
         MVC   STAKAGY,QAGY                                                     
         MVC   STAKCLT,QCLT                                                     
         MVC   KEYSAVE,KEY                                                      
         MVC   AREC,=A(STABUCKC)   READ INTO STABUC                             
         GOTO1 DATAMGR,DMCB,DMREAD,=C'STATION',KEY,AREC                         
         CLI   DMCB+8,0                                                         
         BZ    *+6                                                              
         DC    H'0'                                                             
         CLC   KEY(STAKCLT-STAKEY),KEYSAVE   FOUND THE RECORD ?                 
         BE    *+6                                                              
         DC    H'0'                SHOULD BE THERE                              
         L     R4,=A(STABUCKC)                                                  
         ICM   R1,15,HLDELNET      GET NET                                      
         SR    R0,R0                                                            
         ICM   R0,3,SNEWTAX                                                     
         BZ    BLDHL30                                                          
         MR    R0,R0                                                            
         A     R1,=F'50000'        ROUNDING                                     
         D     R0,=F'100000'       TAX IN R1                                    
         ST    R1,BHLDTAX                                                       
         L     R0,BHLDGRS                                                       
         A     R0,BHLDTAX                                                       
         ST    R0,BHLDGRS                                                       
         L     R0,BHLDNET                                                       
         A     R0,BHLDTAX                                                       
         ST    R0,BHLDNET                                                       
*                                                                               
BLDHL30  GOTO1 BINSRCH,BHLPARS,(1,WK)                                           
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
         CLI   0(R1),1             IF REC WAS NOT FOUND,IT GOT INSERTD          
         BE    BLDHL10                                                          
*                                  ADD TOTALS IN                                
         L     R2,0(R1)            R2 -> TO EXISTING BHOLDTAB REC               
*                                  WK HAS REC PASSED TO BINSRCH WITH            
K@       USING BHOLDTD,WK          SAME KEY                                     
         L     R0,K@.BHLDGRS                                                    
         A     R0,BHLDGRS                                                       
         L     R0,K@.BHLDNET                                                    
         A     R0,BHLDNET                                                       
         L     R0,K@.BHLDTAX                                                    
         A     R0,BHLDTAX                                                       
         DROP  K@                                                               
         B     BLDHL10             READ NXT BHOLD REC                           
         DROP  R2,R6,R4                                                         
*                                                                               
BLDBHX   XIT1                                                                   
         EJECT                                                                  
BLDBPCT  NTR1                     BUILD TABLE OF BPCT RECS FOR CLT              
         XC    XSPKEY,XSPKEY                                                    
         LA    R3,XSPKEY           BUILD BPCT RECORD KEY                        
         USING BPCRECD,R3                                                       
         MVI   BPCKTYP,BPCKTYQQ    X'0E0D' RECORDS                              
         MVI   BPCKSUB,BPCKSUBQ                                                 
         MVC   BPCKAM,BAGYMD       AGENCY/MEDIA                                 
         MVC   BPCKCLT,BCLT        CLIENT                                       
         MVC   XSPKEYSV,XSPKEY                                                  
*                                                                               
         GOTO1 DATAMGR,DMCB,DMRDHI,=C'XSPDIR',XSPKEYSV,XSPKEY                   
         B     BLDBP15                                                          
*                                                                               
BLDBP10  GOTO1 DATAMGR,DMCB,DMRSEQ,=C'XSPDIR',,XSPKEY                           
*                                                                               
BLDBP15  CLI   DMCB+8,0                                                         
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   BPCKEY(BPCKPRD-BPCKEY),XSPKEYSV   COMP INCL CLIENT               
         BNE   BLDBPX              NOTHING ELSE FOR THIS CLIENT                 
*                                                                               
         GOTO1 DATAMGR,DMCB,GETREC,=C'XSPFIL',BPCKDA,A(XSPIO),DMWORKX           
         CLI   DMCB+8,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,=A(XSPIO)                                                     
         USING PCTELEM,R6                                                       
*                                                                               
         LA    R6,BPCEL-BPCRECD(R6)     POINT TO 1ST ELEM                       
BLDBP30  CLI   0(R6),0                  EOR ?                                   
         BE    BLDBP10                  YES, NXT REC                            
*                                                                               
         CLI   0(R6),PCTELQ             SHOULD BE X'10' ELEM                    
         BNE   BLDBP50                                                          
*                                                                               
         XC    WK,WK               USE TO BUILD A REC FOR MY TABLE              
         LA    R2,WK                                                            
         USING BPCTD,R2                                                         
         MVC   BPCTAM,BPCKAM                                                    
         MVC   BPCTCLT,BPCKCLT                                                  
         MVC   BPCTPRD,BPCKPRD                                                  
         MVC   BPCTEST,BPCKEST                                                  
         MVC   BPCTMOS,PCTMONTH                                                 
         MVC   BPCTPCT,PCTPCT                                                   
         NI    BPCTPCT,X'7F'                                                    
*                                                                               
         GOTO1 BINSRCH,BPCTPARS,(1,WK)                                          
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
*                                                                               
         CLI   0(R1),1             IF REC WAS NOT FOUND,IT GOT INSERTD          
         BE    *+6                                                              
         DC    H'0'                DUPLICATE REC? -- DIE                        
*                                                                               
BLDBP50  ZIC   R0,1(R6)            NEXT ELEM                                    
         AR    R6,R0                                                            
         B     BLDBP30             NXT BPCT ELEM                                
*                                                                               
         DROP  R2,R6,R7                                                         
*                                                                               
BLDBPX   XIT1                                                                   
         EJECT                                                                  
         LTORG                                                                  
DMWORKD  DSECT                                                                  
DMWORKX  DS    12D                                                              
XSPKEY   DS    XL40                                                             
XSPKEYSV DS    XL40                                                             
DMWORKQ  EQU   *-DMWORKX                                                        
         EJECT                                                                  
         TITLE 'SPREPB102 - CLTFRST, FIRST FOR CLIENT'                          
         SPACE 2                                                                
SPB102   CSECT                                                                  
CFIRST   NMOD1 0,CFIRST                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   FCRDBUYS,C'I'       READ MARKET GROUP ID POINTERS?               
         BNE   *+6                                                              
         DC    H'0'                MEL SAYS WE SHOULD NEVER GET THIS!           
*                                                                               
         GOTO1 =A(VBADD),DMCB,(C'C',0)  CLEAR VBTAB                             
*                                                                               
         XC    GMICTLS,GMICTLS     SET GMI CONTROLS                             
         XC    LMGSW,LMGSW                                                      
         MVI   TCFSW,C'N'          CLEAR                                        
         L     R3,ADCLT                                                         
         USING CLTHDR,R3                                                        
         TM    COPT1,COP1GMI       CLIENT HDR OPTION                            
         BZ    *+8                                                              
         MVI   GMISW,C'Y'                                                       
*                                                                               
         MVI   MIDAS,C'N'                                                       
         TM    COPT4,COP4MIDS      IS IT MIDAS?                                 
         BZ    *+12                                                             
         MVI   MIDAS,C'Y'                                                       
         MVI   QTRADE,C'C'         MIDAS ONLY BILLS CASH, IGNORES TRADE         
*                                                                               
         CLC   =C'TH',QAGY         FOR ZENY PRINT PRD AND EST...                
         BNE   *+16                ...UDEFS NEXT TO PRD NAME                    
         CLI   COFFICE,C'U'        FOR MEDIA OFFICE 'U'                         
         BNE   *+8                                                              
         MVI   TCFSW,C'Y'          SET TCF FLAG TO PRINT UDEFS                  
*                                                                               
         CLI   QLMG,C' '           LMG/REGIONAL ?                               
         BH    *+20                                                             
         TM    COPT4,COP4BPCT                                                   
         BZ    CLTF1C                                                           
         MVI   MODE,CLTLAST                                                     
         B     CLTF60                                                           
*                                                                               
         TM    COPT4,COP4BPCT                                                   
         BNZ   *+12                                                             
         MVI   MODE,CLTLAST                                                     
         B     CLTF60                                                           
*                                                                               
         MVC   LMGSW,QLMG                                                       
*                                                                               
CLTF1C   CLI   ENDRQSW,C'Y'        IF PREV REQ CAUSED AN ERROR ENDREQ           
         BNE   *+14                                                             
         MVC   QSAVE,SPACES        FORCE A/M/C BREAK                            
         MVI   ENDRQSW,C'N'                                                     
*                                                                               
         MVC   PROFCLT,CLT         SET CLIENT CODE FOR PROFILES                 
         CLI   QPROFCLT,C' '       OVERRIDE ON REQUEST?                         
         BNH   *+10                                                             
         MVC   PROFCLT,QPROFCLT                                                 
*                                                                               
         MVC   QSTART,SVQSTART     RESTORE ORIGINAL QSTART AND QEND             
         MVC   QEND,SVQEND                                                      
         CLC   =C'ALL',QCLT        IF DOING 'ALL' CLIENTS                       
         BE    *+12                                                             
         CLI   QCLT,C'*'           OR ALL FOR OFFICE                            
         BNE   *+16                                                             
*                                                                               
         MVI   QSAVE+QCLT-QRECORD,0  FORCE CLIENT CHANGE                        
         MVI   QPGR,C' '           AND CLEAR QPGR AND QMGR                      
         MVI   QMGR,C' '           TO BE SET FROM PROFILES                      
*                                                                               
         L     RF,ABRKTAB                                                       
         XC    0(L'BRKTAB,RF),0(RF)                                             
****     XC    BRKTAB,BRKTAB                                                    
         XC    SPLTABN,SPLTABN     CLEAR PROD SPLIT TABLE                       
         XC    PEPTABN,PEPTABN     CLEAR PEPTAB                                 
         XC    BPCTTABN,BPCTTABN   CLEAR BPCTTAB                                
         XC    BHLTABN,BHLTABN                                                  
         L     RE,=A(BHOLDTAB)     CLEAR BHOLD TABLE                            
         LHI   RF,BHOLDTBL                                                      
         XCEF                                                                   
*                                                                               
         OC    MANRVDTP,MANRVDTP   SKIP IF REVERSAL BILL                        
         BNZ   CLTF1K                                                           
*                                                                               
         XC    BYTE,BYTE                                                        
         BRAS  RE,BLDBHLDT         BUILD TABLE OF BHOLD RECS                    
*                                                                               
         OC    LMGSW,LMGSW                                                      
         BZ    *+12                                                             
         MVI   BYTE,C'P'                                                        
         BRAS  RE,BLDBHLDT         BUILD TABLE OF BPCT RECS                     
*                                                                               
CLTF1K   CLC   QAGY(6),QSAVE+2     ON AGY/MED/CLT BREAK                         
         BE    *+8                                                              
         BRAS  RE,AGMPROC          GET AGM BILLING PROFILE                      
*                                  GET STARTING INVNO                           
         CLC   SVAGMINV,AGMSTANO   TEST CHANGE OF INVNO CTLS                    
         BE    *+14                                                             
         MVC   SVAGMINV,AGMSTANO                                                
         B     CLTF3D                                                           
*                                                                               
         CLC   SVAGMOCT,AGMOCTL    IF AGMOCTL HAS CHANGED                       
         BNE   CLTF3D                                                           
         CLI   AGMOCTL,0           IF DOING BY OFFICE                           
         BE    CLTF2V                                                           
         CLC   SVOFF,COFFICE       AND OFFICE HAS CHANGED                       
         BNE   CLTF3D              GET NEW STARTING INVNO                       
*                                                                               
CLTF2V   DS    0H                                                               
         CLC   QAGY(6),QSAVE+2     TEST CLIENT BREAK                            
         BE    CLTF3F                                                           
         CLC   QSAVE(2),QPROG      TEST FIRST TIME                              
         BNE   CLTF3D              YES                                          
         CLI   AGMSEQ,C'C'         TEST SEQ BY CLIENT                           
         BE    CLTF3D                                                           
         CLI   AGMSEQ,C'D'         ALSO BY CLIENT                               
         BE    CLTF3D                                                           
         CLC   QMED,QSAVE+4                                                     
         BE    *+12                                                             
         CLI   AGMSEQ,C'M'                                                      
         BE    CLTF3D                                                           
*                                  REDO INV NO TO GET RIGHT MEDIA               
*                                  AND INVOICE NUMBER FORMAT AND MTH            
         MVC   W(1),TODAYB+1       SET MONTH FOR GETNUM                         
         GOTO1 AGETNUM,DMCB,(1,INVNO),PINVNO                                    
         B     CLTF3F                                                           
CLTF3D   DS    0H                  GET FIRST INVOICE NO.                        
         XC    INVNO,INVNO                                                      
         GOTO1 AGETNUM,DMCB,INVNO,PINVNO                                        
*                                                                               
CLTF3F   DS    0H                                                               
         OC    INVNO,INVNO         IF NO INVOICE NUMBER                         
         BNZ   CLTF3H              (DUE TO ERROR)                               
         GOTO1 AGETNUM,DMCB,INVNO,PINVNO   GET STARTING ONE NOW                 
*                                                                               
CLTF3H   DS    0H                                                               
         LA    RF,SVAADDRS         RESTORE SAVED CORP ADDRESS                   
         L     RE,=A(AADDRS)                                                    
         MVC   0(L'SVAADDRS/2,RE),0(RF)                                         
         MVC   L'SVAADDRS/2(L'SVAADDRS/2,RE),L'SVAADDRS/2(RF)                   
*                                                                               
         MVI   WIOPTC,C'N'         WESTERN CLIENT PROFIT WITHIN OPTION          
         CLC   QAGY(2),=C'WI'                                                   
         BNE   *+14                                                             
         CLC   QUESTOR(2),=C'PW'   REQUESTOR NAME MUST BE PW                    
         BNE   CLTF3J                                                           
         TM    COPT2,COP2NPWB      PW SUPPRESSED?                               
         BNZ   CLTF3J                                                           
*                                                                               
         OC    CPWPCT,CPWPCT                                                    
         BZ    CLTF3J                                                           
         MVI   WIOPTC,C'Y'                                                      
*                                                                               
         CLC   QEST,=C'NO '       FOR PW                                        
         BNE   *+10                                                             
         MVC   QEST,=C'ALL'        EST=NO ==> EST=ALL                           
*                                                                               
CLTF3J   DS    0H                                                               
         MVI   COST2SW,C'N'        ESTIMATE LEVEL COST2 OPTION                  
*                                                                               
         BAS   RE,QMANSET          LOOK AT QMANUAL OPTIONS                      
         BRAS  RE,SETDATE          READ PROFILES ETC. (WAS AT CLTF60)           
*                                                                               
         CLI   BFROPT,C'Y'        IF USING BFORM                                
         BNE   CLTF3K                                                           
         MVC   KEY1,KEY           CHECK THAT CLIENT HAS ANYTHING SETUP          
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0D4C'                                                  
         MVC   KEY+2(3),CKEY+1                                                  
         GOTO1 HIGH                                                             
         CLC   KEY(5),KEYSAVE                                                   
         BE    *+12                                                             
         MVI   ERR,BFMLERR         IF NO BFORM FOR THIS CLT                     
         BRAS  RE,ERRPROC          STOP THE REQUEST                             
*                                                                               
         MVC   KEY,KEY1                                                         
         GOTO1 HIGH                                                             
*                                                                               
CLTF3K   CLC   CURPER,=X'6009'     FOR REQS FOR MOS < SEP96 **Y2K**             
         BNL   CLTF3M                                                           
         XC    GMICTLS,GMICTLS     FORGET GMI STUFF                             
         CLI   QGMITVC,C'C'        SKIP CASH REQUEST                            
         BNE   *+12                (SO DON'T DO BOTH)                           
         MVI   MODE,CLTLAST                                                     
         B     CLTF60                                                           
*                                                                               
         MVI   QGMITVC,C' '        AND CLEAR CASH/TRADE FILTER                  
*                                                                               
CLTF3M   DS    0H                                                               
         CLC   QAGY(6),QSAVE+2       CLIENT BREAK                               
         BE    CLTF8                                                            
*                                  READ AAA PRDHDR                              
*                                  FOR ADDRESS AND FORMULA                      
         L     R0,=A(AADDRS)                                                    
         LHI   R1,ADDRLEN                                                       
         SR    RE,RE                                                            
         LA    RF,X'40'                 FILL WITH SPACES                        
         SLL   RF,24                                                            
         MVCL  (R0),(RE)                                                        
*                                                                               
         XC    AAAFORM,AAAFORM                                                  
         L     RF,=A(AAAELIST)                                                  
         MVC   0(AAAELSTL,RF),=X'FFFFFFFFFFFF'                                  
         MVC   KEY1,KEY                                                         
*                                                                               
         CLI   PROFB4A+4,C'Y'      OPTION TO USE AAA                            
         BNE   *+22                                                             
         MVC   THREE,=C'AAA'                                                    
         CLI   BILLADR,C'Y'        B8 PR3 READ BILL ADDRESS REC?                
         BNE   *+8                                                              
         BRAS  RE,RBILADDR         READ BILL ADDRESS REC                        
*                                                                               
         MVC   KEY(13),CKEY                                                     
         MVC   KEY+4(3),=C'AAA'                                                 
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   CLTF5                                                            
         MVC   AREC,=A(STABUCKC)   READ INTO STABUC                             
         GOTO1 GET                                                              
         L     RF,AREC                                                          
         USING PRDHDR,RF                                                        
         CLC   =C'NONE',PADDR1                                                  
         BE    CLTF4A                                                           
         CLC   =C'XX',PADDR1                                                    
         BE    CLTF4A                                                           
         CLC   =C'X ',PADDR1                                                    
         BE    CLTF4A                                                           
         CLI   PADDR1,C'A'                                                      
         BL    CLTF4A                                                           
         L     RE,=A(AADDRS)                                                    
         TM    FLAG1,AADDRSW       AAA BILL ADDRESS REC FOUND?                  
         BO    CLTF4A                                                           
*                                                                               
         USING AADDRS,RE                                                        
         MVC   AADDR1(L'PADDR1),PADDR1                                          
         MVC   AADDR2(L'PADDR2),PADDR2                                          
         MVC   AADDR3(L'PADDR3),PADDR3                                          
         MVC   AADDR4(L'PADDR4),PADDR4                                          
         DROP  RE,RF                                                            
*                                                                               
CLTF4A   DS    0H                                                               
         L     RF,AREC                                                          
         MVC   AAAFORM,PBILLDT-PRDHDR(RF)    DATE, BASE + COMMISSION            
*                                                                               
*                                  BUILD LIST OF ANY AAA EST FORMULAS           
         CLI   BFROPT,C'N'         SKIP IF USING NEW BFR RECS                   
         BNE   CLTF5                                                            
*                                                                               
         L     R6,=A(AAAELIST)     START                                        
         USING AAAELSTD,R6                                                      
         L     RF,AREC                                                          
         MVC   KEY,0(RF)                                                        
CLTF4B   DS    0H                                                               
         GOTO1 SEQ                                                              
         CLC   KEY(7),KEYSAVE                                                   
         BNE   CLTF5               DONE                                         
*                                                                               
         OC    KEY+8(5),KEY+8                                                   
         BNZ   CLTF4B              NOT AN EST                                   
*                                                                               
         GOTO1 GET                                                              
         L     RF,AREC                                                          
         MVC   AAAELEST,7(RF)      EST NO.                                      
         MVC   AAAELFOR,EBILLBAS-ESTHDR(RF)    FORMULA                          
         LA    R6,AAAELSTL(R6)                                                  
         MVC   0(AAAELSTL,R6),=X'FFFFFFFFFFFF' SET EOL                          
         C     R6,=A(AAAELSTX)                                                  
         BL    CLTF4B                                                           
         DC    H'0'                TABLE FULL                                   
         DROP  R6                                                               
*                                                                               
CLTF5    DS    0H                                                               
         LA    RF,SVAADDRS         SAVE CORP ADDRESSES                          
         L     RE,=A(AADDRS)                                                    
         MVC   0(L'SVAADDRS/2,RF),0(RE)                                         
         MVC   L'SVAADDRS/2(L'SVAADDRS/2,RF),L'SVAADDRS/2(RE)                   
*                                                                               
         CLI   QPGR,C' '                                                        
         BNE   CLTF5D                                                           
*                             MUST BUILD OWN PRDLIST IF NO PRD GRP              
         L     R4,PRDLIST                                                       
         LA    R5,CLIST                                                         
*                                                                               
CLTF5B   DS    0H                                                               
         CLI   0(R5),0             EOL                                          
         BE    CLTF5D                                                           
         XC    0(2,R4),0(R4)                                                    
         MVC   2(4,R4),0(R5)       MNEUMONIC AND CODE                           
         LA    R5,4(R5)                                                         
         LA    R4,6(R4)                                                         
         B     CLTF5B                                                           
*                                                                               
CLTF5D   DS    0H                                                               
         MVC   KEY,KEY1                                                         
         GOTO1 HIGH                RESTORE SEQ                                  
*                                                                               
CLTF8    DS    0H                                                               
         CLI   SCBOPT,C'Y'         IF SEP COMMISSION OPTION                     
         BNE   CLTF50D                                                          
*                                                                               
         CLI   PROFB2B+1,0         HAVE EST FILTER PROFILE?                     
         BNH   CLTF50D                                                          
         CLC   =C'NO ',QEST        AND QEST = NO                                
         BE    *+14                                                             
         CLC   =C'ALL',QEST        OR ALL                                       
         BNE   CLTF50C                                                          
*                                                                               
*                                  SET FILTERS IN REQ CARD                      
         CLI   QESTEND,C' '        INITIALIZE IF BLANK                          
         BH    *+10                                                             
         MVC   QESTEND(3),=C'***'                                               
*                                                                               
         ZIC   RF,PROFB2B+1                                                     
         LA    RF,QESTEND-1(RF)                                                 
         MVC   0(1,RF),PROFB2B+2   SET VALUE IN REQUEST CARD                    
         CLI   SCBNCSW,C'R'        FOR 'REGULAR' RUN IS OK AS IS                
         BE    *+8                 OK AS IS, ELSE MAKE LOWER CASE               
         NI    0(RF),X'FF'-X'40'   FOR 'ALL EXCEPT'                             
         B     CLTF50D                                                          
*                                                                               
CLTF50C  DS    0H                                                               
         CLI   QESTEND,C'0'        NO EST RANGE REQS ALLOWED                    
         BL    CLTF50D                                                          
         MVI   ERR,ESTERR                                                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
CLTF50D  DS    0H                                                               
         CLI   WIOPTC,C'Y'         WESTERN PW MODE                              
         BNE   *+16                USES EXCHANGE SPACE                          
         MVI   CLTCURR,1           SPECIAL CURRENCY CODE                        
         MVI   CURR2,1                                                          
         B     CLTF51D                                                          
*                                                                               
         MVI   CLTCURR,0           SET CLIENT CURRENCY CONTROL                  
         MVI   CURR2,0                                                          
         L     RF,ADAGY                                                         
         CLI   AGYPROF+7-AGYHDR(RF),C'C'  ONLY FOR CANADIAN AGY                 
         BE    *+12                                                             
         MVI   RQCRRNCY,C'U'                                                    
         B     CLTF51                                                           
         MVI   RQCRRNCY,C'C'                                                    
         CLI   CEXTRA+9,C'U'       AND US CLIENT                                
         BNE   CLTF51                                                           
         OC    CCSTRT,CCSTRT       AND START DATE SET                           
         BZ    CLTF51                                                           
         CLC   CURPER,CCSTRT       AND AFTER REQUEST MONTH                      
         BL    CLTF51                                                           
         MVI   CLTCURR,C'U'                                                     
         MVI   CURR2,C'U'                                                       
         MVI   RQCRRNCY,C'U'                                                    
         B     CLTF51D                                                          
*                                                                               
CLTF51   DS    0H                                                               
         MVI   FCGETSTA,C'N'       NORMALLY DONT NEED STATION RECS              
         MVI   STNCOPT,C'N'        AND NOT DOING STATION CURR                   
         CLI   CCDETOPT,C'Y'       BUT IF NEED 2ND CURR                         
         BNE   CLTF51D                                                          
         L     RF,ADAGY                                                         
         CLI   AGYPROF+7-AGYHDR(RF),C'C'  FOR CANADIAN AGY                      
         BNE   CLTF51D                                                          
         CLI   CEXTRA+9,C'C'       AND CLIENT                                   
         BNE   CLTF51D                                                          
         MVI   FCGETSTA,C'Y'       THEN MUST GET THEM                           
         MVI   STNCOPT,C'Y'        SET DOING STATION CURR                       
         MVI   CURR2,C'U'                                                       
         XC    CCSTRT,CCSTRT       DO NEED START DATE                           
*                                                                               
CLTF51D  DS    0H                  CANADIAN VAT TEST                            
*                            NOTE- CODES FOR PSTS ARE SET IN SETCPVC            
*                                  IF CVATCOD IS SET TO NULL HERE               
*                                  IT STAYS NULL AND ALL VATS ARE OFF           
*                                                                               
         MVC   CVATSTRT,=X'5B01'   CANADIAN VAT STARTS JAN91  **Y2K**           
         MVI   CVATCOD,0                                                        
         L     RF,ADAGY                                                         
         CLI   AGYPROF+7-AGYHDR(RF),C'C'  IF CANADIAN AGY                       
         BNE   CLTF51F                                                          
         CLC   CURPER,CVATSTRT     AND CURPER NOT BEFORE VAT START              
         BL    CLTF51F                                                          
         MVI   CVATCOD,C'S'        DEFAULT TO S                                 
         CLI   CEXTRA+11,C' '                                                   
         BNH   CLTF51F                                                          
         CLI   CEXTRA+11,C'0'                                                   
         BE    CLTF51F                                                          
         MVC   CVATCOD,CEXTRA+11   SET VAT CODE                                 
*                                                                               
CLTF51F  DS    0H                                                               
         CLC   QAGY(6),QSAVE+2     TEST CLIENT BREAK                            
         BE    CLTF52                                                           
         L     RF,ADAGY                                                         
         CLI   AGYPROF+7-AGYHDR(RF),C'C'   FOR CANADIAN                         
         BNE   CLTF52                                                           
         CLI   QMED,C'N'           NETWORK                                      
         BNE   CLTF52                                                           
         BAS   RE,BLDNET           BUILD LIST OF NETWORKS                       
*                                                                               
CLTF52   DS    0H                                                               
         CLI   WIOPTC,C'Y'          FOR WI OPT                                  
         BNE   *+8                                                              
         MVI   RQALLMKT,C'Y'       NEED ALL MKTS                                
*                             SET PRD AND EST Q'S                               
         MVI   ESTQ,C'A'           ALL                                          
         CLC   =C'NO',QEST                                                      
         BE    CLXF6                                                            
         CLC   =C'ALL',QEST                                                     
         BE    CLXF6                                                            
         CLI   MSSW,C'Y'                                                        
         BE    CLXF6                                                            
         CLI   EPUDEF,C'Y'                                                      
         BE    CLXF6                                                            
         CLI   EPUDEF,C'E'                                                      
         BE    CLXF6                                                            
         CLC   QESTEND,SPACES                                                   
         BNE   CLXF6                                                            
         MVI   ESTQ,C'1'           ONE EST                                      
*                                                                               
CLXF6    DS    0H                                                               
         MVI   PRDQ,C'A'           ALL                                          
         CLI   QPRD,C'0'                                                        
         BNL   CLXF7                                                            
         CLI   QPRD,C' '                                                        
         BNH   CLXF7                                                            
         CLC   QPRD,=C'ALL'                                                     
         BE    CLXF7                                                            
         CLC   QPRD,=C'POL'                                                     
         BE    CLXF7                                                            
         CLI   PGSW,C'Y'           FOR P&G LEAVE AS IF ALL, SO IT DOES          
         BE    CLXF7               NOT GET INTO HEADLINES                       
         CLI   WMTSW,C'Y'          FOR WMT LEAVE AS IF ALL, SO IT DOES          
         BE    CLXF7               NOT GET INTO HEADLINES                       
         CLI   TCFSW,C'Y'          SAME FOR TCF                                 
         BE    CLXF7                                                            
         CLI   EPUDEF,C'Y'                                                      
         BE    CLXF7                                                            
         CLI   EPUDEF,C'P'                                                      
         BE    CLXF7                                                            
         MVI   PRDQ,C'1'           ONE PRD                                      
*                                                                               
CLXF7    DS    0H                                                               
         MVI   PGRQ,C'N'           NO PGRS                                      
         CLI   QPGR,C' '                                                        
         BE    CLXF8                                                            
         MVI   PGRQ,C'A'           MORE THAN 1 PGR                              
         CLC   QPRD,=C'ALL'                                                     
         BE    CLXF8                                                            
         CLI   QPRD,C' '                                                        
         BE    CLXF8                                                            
         CLI   QPRD+1,C'*'                                                      
         BE    CLXF8                                                            
         CLI   QPRD+2,C'*'                                                      
         BE    CLXF8                                                            
         MVI   PGRQ,C'1'           1 PGR                                        
*                                                                               
CLXF8    DS    0H                                                               
         MVI   WBSW,C'N'           SET IT OFF                                   
         CLI   SVWBSW,C'Y'         IF WB CLIENT                                 
         BNE   CLXF8K                                                           
         CLI   PRDQ,C'1'           AND SINGLE PROD REQUEST                      
         BNE   CLXF8K                                                           
*                                                                               
         MVC   KEY1,KEY            CHECK THE THEATRICAL FLAG HERE               
         MVC   KEY(13),CKEY                                                     
         MVC   KEY+4(3),QPRD                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   AREC,=A(STABUCKC)   READ INTO STABUC                             
         GOTO1 GET                                                              
         L     RF,AREC                                                          
         USING PRDHDR,RF                                                        
         TM    POPT1,POPT1_THTR+POPT1_THNT     AND WB PRODUCT                   
         BZ    *+8                                                              
         MVI   WBSW,C'Y'           SET IT ON                                    
*                                                                               
         MVC   KEY,KEY1                                                         
         GOTO1 HIGH                RESTORE SEQ                                  
*                                                                               
*                                                                               
CLXF8K   DS    0H                                                               
         MVI   MGRQ,C'N'           NO MGRS                                      
         CLI   QMGR,C' '                                                        
         BE    CLXF9                                                            
         MVI   MGRQ,C'A'           MORE THAN 1 MGR                              
         CLC   =C'ALL',QSTA                                                     
         BE    CLXF9                                                            
         CLI   QSTA,C'0'                                                        
         BL    CLXF9                                                            
         CLI   QSTA+1,C'*'                                                      
         BE    CLXF9                                                            
         CLI   QSTA+2,C'*'                                                      
         BE    CLXF9                                                            
         MVI   MGRQ,C'1'           1 MGR                                        
*                                                                               
CLXF9    DS    0H                                                               
         MVI   MKTQ,C'A'           ALL MKTS                                     
         CLI   QMGR,C' '                                                        
         BNE   *+16                                                             
         CLI   QMKT,C'0'                                                        
         BL    *+8                                                              
         MVI   MKTQ,C'1'           1 MKT                                        
*                                                                               
         CLI   AORLOPT,C'C'        CHECK FOR AOR 'CLIENT LIST' MODE...          
         BNE   CLXF11              ...PROFILE INCOMPATIBILITIES                 
*                                                                               
         CLI   PROFB4+3,C'S'       SEPARATE INVOICES BY MARKET GROUP...         
         BNE   *+12                                                             
         CLI   MGRQ,C'A'           ...DISALLOWED FOR 'ALL' MKTGRPS              
         BE    CLXF10                                                           
*                                                                               
         CLI   PROFB4+4,C'S'       SEPARATE INVOICES BY MARKET...               
         BNE   CLXF11                                                           
         CLI   MGRQ,C'N'           ...DISALLOWED FOR ANY MKTGRP...              
         BNE   CLXF10                                                           
         CLI   MKTQ,C'A'           ...AS WELL AS 'ALL' MARKET REQUESTS          
         BNE   CLXF11                                                           
*                                                                               
CLXF10   DS    0H                                                               
         MVI   ERR,AORPERR         GENERATE ERROR MESSAGE                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
CLXF11   DS    0H                                                               
         OC    MANGRS,MANGRS                                                    
         BZ    CLXF12                                                           
         CLI   PRDQ,C'1'                                                        
         BNE   CLTF39                                                           
         CLI   ESTQ,C'1'                                                        
         BNE   CLTF39                                                           
*                                                                               
CLXF12   DS    0H                                                               
         XC    KMKT,KMKT                                                        
         XC    KSTA,KSTA                                                        
         MVI   STAQ,C'A'           SET 'ALL' STATIONS                           
         CLI   QSTA,C'A'                                                        
         BL    CLXF12D                                                          
         MVC   DUB,SPACES                                                       
         MVC   DUB(5),QSTA                                                      
*                                                                               
         CLI   QSTA+4,C'/'         LOCAL CABLE?                                 
         BNE   CLXF12C                                                          
         MVC   DUB+5(3),QCBLNET                                                 
         CLC   =C'ALL',QSTA                                                     
         BNE   *+10                                                             
         MVC   DUB(4),=C'0000'                                                  
         B     CLXF12C4                                                         
         CLI   QCBLNET,C' '        SINLGE NET                                   
         BNH   CLXF12C4            NO                                           
         B     CLXF12C3            YES, SET DOING SINGLE STATION                
*                                                                               
CLXF12C  DS    0H                                                               
         CLI   QSTA,C'0'                                                        
         BNL   CLXF12D                                                          
         CLC   =C'ALL',QSTA                                                     
         BE    CLXF12D                                                          
*                                                                               
CLXF12C3 DS    0H                                                               
         MVI   STAQ,C'1'                                                        
         CLI   MGRQ,C'N'                                                        
         BE    CLXF12C4                                                         
         MVI   ERR,MGRERR          MGR NO GOOD WITH SINGLE STATION              
         BRAS  RE,ERRPROC                                                       
*                                                                               
CLXF12C4 DS    0H                                                               
         GOTO1 MSPACK,DMCB,=C'0000',DUB,X                                       
         MVC   KSTA,X+2                                                         
*                                                                               
CLXF12D  DS    0H                                                               
         CLI   QPGR,C' '           IF NO PGR'S OR MGR'S                         
         BNE   *+12                BUILD KEY TABLE NOW                          
         CLI   QMGR,C' '                                                        
         BE    *+14                                                             
         OC    MANGRS,MANGRS       OR IF MANUAL BILL                            
         BZ    *+8                                                              
         BRAS  RE,BLDTAB                                                        
*                                                                               
         MVC   SVOFF,COFFICE       SAVE OFFICE CODE                             
         MVC   SVAGMOCT,AGMOCTL    SAVE AGMOCTL                                 
*                                                                               
*                                  EDI ACTIVATION                               
         MVI   OUTMODE,C'D'        ASSUME DATASET OUTPUT                        
         CLC   QUESTOR(4),=C'*EDI'  UNLESS QUESTOR IS *EDI                      
         BE    CLXF14E                                                          
         MVI   OUTMODE,C'W'        ELSE WORKER FILE OUTPUT                      
         CLI   PROOFSW,C'Y'        SKIP IF DRAFT BILLING                        
         BE    CLXF14D4                                                         
*                                                                               
         CLI   PROFB1A+5,C'Y'      EDI CLIENT?                                  
         BE    CLXF14E                                                          
         CLI   PROFB1A+5,C'F'                                                   
         BE    CLXF14E                                                          
*                                                                               
CLXF14D4 DS    0H                                                               
         LA    RF,=X'07FE'         DUMMY EDI ROUTINE                            
         B     CLXF14F                                                          
*                                                                               
CLXF14E  DS    0H                                                               
         CLI   OUTMODE,C'D'        IF WRITING TO DATASET...                     
         BNE   CLXF14E3                                                         
*                                                                               
         BC    0,CLXF14E3          ONLY PRIME THE DATSET ONCE                   
         MVI   *-3,X'F0'                                                        
         OPEN  (EDIOUT,OUTPUT)     OPEN AND CLOSE DATASET, TO PRIME FOR         
         CLOSE EDIOUT               READING EVEN IF IT'S EMPTY                  
*                                                                               
CLXF14E3 DS    0H                                                               
         L     RF,=A(BILLEDI)       USE REAL EDI ROUTINE                        
*                                                                               
CLXF14F  DS    0H                                                               
         ST    RF,ABILLEDI                                                      
******** MVI   OUTMODE,C'W'        WKR FILE MODE (PATCH TO D                    
*                                  FOR DIRECT DATASET MODE)                     
         XIT1                                                                   
         SPACE 2                                                                
QMANSET  NTR1                      LOOK AT QMANUAL ENTRY                        
         XC    MANUALS(MANUALLQ),MANUALS                                        
*                                                                               
         L     RF,VMASTC           RERUN=MM/DD/YY CONTROL CARD IS...            
         MVC   IGNDATE,MCRERUND-MASTD(RF) ...THE DEFAULT IGNORE DATE            
*                                                                               
         XC    REBDATP,REBDATP                                                  
         XC    REBINV,REBINV                                                    
         MVI   NONRET,C'N'         SET NON-RETAIL OFF                           
         CLI   QOPT3,C'N'          BUT QOPT3=N                                  
         BNE   *+8                                                              
         MVI   NONRET,C'Y'         FORCES IT ON                                 
         MVC   RD1OPT,QOPT4        RETAIL DRAFT BILLING CONTROL                 
         MVI   PREVSW,0                                                         
         MVI   PKGREQ,0                                                         
         MVI   NETOPT,0                                                         
         MVI   CTYPQ,C'N'                                                       
         CLI   QMED,C'N'                                                        
         BNE   *+8                                                              
         MVI   CTYPQ,C'B'                                                       
         CLC   =C'ONLY PREV',QMANUAL    ONLY PREV BILLS                         
         BNE   *+12                                                             
         MVI   PREVSW,C'P'                                                      
         B     CLTF60                                                           
*                                                                               
         CLC   =C'PREV',QMANUAL                                                 
         BNE   *+12                                                             
         MVI   PREVSW,C'Y'                                                      
         B     CLTF60                                                           
*                                                                               
         CLC   =C'NO PREV',QMANUAL NO PREVIOUS BILLS                            
         BNE   *+12                                                             
         MVI   PREVSW,C'N'                                                      
         B     CLTF60                                                           
*                                                                               
         CLC   =C'NO PRIOR',QMANUAL                                             
         BE    CLTF60                                                           
*                                                                               
         CLC   =C'PKG=',QMANUAL     PACKAGE REQUEST                             
         BNE   CLTF10G                                                          
*                                                                               
         PACK  DUB,QMANUAL+4(3)                                                 
         CVB   R0,DUB                                                           
         STC   R0,PKGREQ                                                        
         B     CLTF60                                                           
CLTF10G  DS    0H                                                               
         CLC   =C'OLD',QMANUAL                                                  
         BNE   *+12                                                             
         MVI   NETOPT,C'O'                                                      
         B     CLTF60                                                           
*                                                                               
         CLC   =C'TIME',QMANUAL                                                 
         BNE   *+12                                                             
         MVI   CTYPQ,C'T'                                                       
         B     CLTF60                                                           
*                                                                               
         CLC   =C'INT',QMANUAL                                                  
         BNE   *+12                                                             
         MVI   CTYPQ,C'I'                                                       
         B     CLTF60                                                           
*                                                                               
         CLC   =C'NON-RETAIL',QMANUAL    SUPPRESS RETAIL                        
         BNE   *+12                                                             
         MVI   NONRET,C'Y'                                                      
         B     CLTF60                                                           
*                                                                               
         CLC   QMANUAL,SPACES                                                   
         BE    CLTF60                                                           
         CLC   QMANUAL(2),=C'P='        PCT                                     
         BE    CLTF20                                                           
         CLC   QMANUAL(2),=C'R='        REVERSAL                                
         BE    CLTF30                                                           
         CLC   QMANUAL(2),=C'B='        REBILL                                  
         BE    CLTF32                                                           
         CLC   QMANUAL(2),=C'I='        IGNORE DATE                             
         BE    CLTF34                                                           
         CLI   QMANUAL,C'G'                                                     
         BNE   CLTF39                   ERROR                                   
*                                                                               
         PACK  DUB,QMANUAL+2(10)        GROSS                                   
         CVB   R1,DUB                                                           
         LTR   R1,R1                                                            
         BZ    CLTF39                                                           
         CLI   QMANUAL+2,C'-'      TEST NEGATIVE                                
         BNE   *+6                                                              
         LCR   R1,R1                                                            
         ST    R1,MANGRS                                                        
         ST    R1,MANNET                                                        
         CLI   QMANUAL+1,C'F'      FEE BASIS - GROSS = NET                      
         BE    CLTF14                                                           
*                                                                               
         LHI   RF,100              NORMAL 85 NET                                
         LHI   RE,85                                                            
         CLI   CPROF+14,C'0'       NO SPECIAL RATE                              
         BE    CLTF12                                                           
         CLI   CPROF+14,C'3'       N RATE  85/100                               
         BE    CLTF12                                                           
         LHI   RE,100                                                           
         CLI   CPROF+14,C'1'       S RATE  100/100                              
         BE    CLTF12                                                           
         CLI   CPROF+14,C'2'       F RATE  100/100                              
         BE    CLTF12                                                           
         LHI   RF,105                                                           
         CLI   CPROF+14,C'4'       Q RATE  100/105                              
         BE    CLTF12                                                           
         LHI   RF,115                                                           
         CLI   CPROF+14,C'5'       V RATE  100/115                              
         BE    CLTF12                                                           
         LHI   RE,85                                                            
         LHI   RF,90                                                            
         CLI   CPROF+14,C'6'       X RATE  90/85                                
         BE    CLTF12                                                           
*                                                                               
         LHI   RF,100              DEFAULT TO 85/100                            
CLTF12   DS    0H                                                               
         MR    R0,RE                                                            
         DR    R0,RF                                                            
         ST    R1,MANNET                                                        
*                                                                               
CLTF14   DS    0H                                                               
         B     CLTF60                                                           
         SPACE 2                                                                
*                                  PCT                                          
CLTF20   DS    0H                                                               
         PACK  DUB,QMANUAL+2(5)         2 DECIMALS                              
         CVB   R0,DUB                                                           
         ST    R0,MANPCT                                                        
         LTR   R0,R0                                                            
         BZ    CLTF39                                                           
         B     CLTF60                                                           
         SPACE 2                                                                
*                                  REVERSAL INVOICE NUMBER                      
CLTF30   DS    0H                                                               
         LA    R2,QMANUAL+2                                                     
         GOTO1 DATCON,DMCB,(R2),(2,MANRVDTP)                                    
*                                                                               
         XC    DMCB,DMCB                                                        
         GOTO1 =V(SPFMTINO),DMCB,,(C'P',QMANUAL+8)                              
         L     RF,DMCB+4                                                        
         OC    0(2,RF),0(RF)       IF NULLS -> INVALID                          
         BZ    CLTF39                                                           
         MVC   MANRVNO,0(RF)                                                    
*                                                                               
         MVI   FCRDBUYS,C'N'       SUPPRESS READING OF BUYS                     
         MVI   PREVSW,C'Y'                                                      
*                                                                               
         B     CLTF60                                                           
         SPACE 2                                                                
*                                  REVERSAL INVOICE NUMBER                      
CLTF32   DS    0H                                                               
         LA    R2,QMANUAL+2                                                     
         GOTO1 DATCON,DMCB,(R2),(2,REBDATP)                                     
*                                                                               
         XC    DMCB,DMCB                                                        
         GOTO1 =V(SPFMTINO),DMCB,,(C'P',QMANUAL+8)                              
         L     RF,DMCB+4                                                        
         OC    0(2,RF),0(RF)       IF NULLS -> INVALID                          
         BZ    CLTF39                                                           
         MVC   REBINV,0(RF)                                                     
         LH    RF,REBINV                                                        
         BCTR  RF,0                DROP BY 1, GETNUM WILL BUMP                  
         STH   RF,REBINV                                                        
*                                  START WITH GIVEN INVOICE NUMBER              
         GOTO1 AGETNUM,DMCB,REBINV,PINVNO                                       
         MVC   INVNO,REBINV                                                     
*                                                                               
         CLI   QMGR,C' '           IF MGR'S DONT SUPPRESS BUY READ              
         BNE   *+8                                                              
         MVI   FCRDBUYS,C'N'       SUPPRESS READING OF BUYS                     
         MVI   PREVSW,C'Y'                                                      
*                                                                               
         B     CLTF60                                                           
         SPACE 2                                                                
*                                  IGNORE DATE                                  
CLTF34   DS    0H                                                               
         LA    R2,QMANUAL+2                                                     
         GOTO1 DATCON,DMCB,(R2),(2,IGNDATE)                                     
*                                                                               
         B     CLTF60                                                           
         SPACE 2                                                                
CLTF39   DS    0H                                                               
         MVI   ERR,MANERR                                                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
CLTF60   DS    0H                                                               
         XIT1                                                                   
         DROP  R3                                                               
         EJECT                                                                  
*        BUILD LIST OF CANADIAN NETWORKS                                        
         SPACE 2                                                                
BLDNET   NTR1                                                                   
         L     RF,=A(NETTAB)                                                    
*                                                                               
         LR    R0,RF               CLEAR NETWORK TABLE AREA                     
         LHI   R1,MAXNETS*NETTABL                                               
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         MVC   KEY1,KEY            SAVE CURRENT KEY                             
         XC    KEY,KEY                                                          
         LA    R2,KEY                                                           
         USING NDEFRECD,R2                                                      
         MVC   NDEFKTYP,=X'0D11'   RECORD TYPE                                  
         MVC   NDEFKAGY,QAGY       AGENCY                                       
         GOTO1 HIGH                                                             
         B     BLDN04B                                                          
*                                                                               
BLDN04   DS    0H                                                               
         GOTO1 SEQ                                                              
BLDN04B  DS    0H                                                               
         CLC   KEY(4),KEYSAVE                                                   
         BNE   BLDN20                                                           
         OC    NDEFKNET,NDEFKNET   AGENCY-LEVEL NETDEF?                         
         BZ    BLDN04              YES -- SKIP                                  
         CLC   NDEFKCLT,BCLT       THIS CLIENT OK                               
         BE    *+14                                                             
         OC    NDEFKCLT,NDEFKCLT   OR AGENCY DEFAULT                            
         BNZ   BLDN04                                                           
*                                                                               
         MVC   AREC,=A(STABUCKC)   READ INTO STABUC                             
         GOTO1 GET                                                              
         L     R3,AREC                                                          
         LA    R3,NDEFEL-NDEFRECD(R3)                                           
*                                                                               
BLDN08   DS    0H                                                               
         CLI   0(R3),0             EOR                                          
         BE    BLDN04              NEXT RECORD                                  
         CLI   0(R3),X'02'         02 ELEM HAS NETWORK NUMBER                   
         BE    BLDN09                                                           
         ZIC   R0,1(R3)                                                         
         AR    R3,R0                                                            
         B     BLDN08                                                           
*                                                                               
BLDN09   DS    0H                                                               
         USING NDEFEL02,R3                                                      
         CLI   NDEFNET,MAXNETS     TOO MANY NETWORKS?                           
         BNH   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVC   DUB(4),NDEFKNET                                                  
         MVI   DUB+4,C'T'                                                       
         GOTO1 MSPACK,DMCB,=C'0000',DUB,X                                       
         ZIC   R4,NDEFNET          NETWORK NUMBER                               
         MHI   R4,NETTABL                                                       
         A     R4,=A(NETTAB)                                                    
         DROP  R3                                                               
*                                                                               
         OC    0(NETTABL,R4),0(R4)  IF WE ALREADY HAVE AN ENTRY FOR             
         BNZ   BLDN04               THIS NET #, USE IT.                         
*                                                                               
         USING NETTABD,R4                                                       
         MVC   NTBCALL,NDEFKNET    SET NETWORK CODE                             
         MVC   NTBPCKD,X+2         PACKED CODE TOO                              
         B     BLDN04              NEXT RECORD                                  
         DROP  R4                                                               
*                                                                               
BLDN20   DS    0H                  GET NETWORK LEVEL PSTS                       
         L     R4,=A(NETTAB)                                                    
         LHI   R0,MAXNETS                                                       
*                                                                               
BLDN22   DS    0H                                                               
         CLI   0(R4),C' '          ANY NETWORK IN THIS SLOT                     
         BNH   BLDN24                                                           
         MVC   NTBPSTS-NETTABD(NPROVS,R4),SPACES                                
*                                                                               
KEY@     USING STAKEY,KEY                                                       
         MVI   KEY@.STAKTYPE,STAKTYPQ                                           
         MVI   KEY@.STAKMED,C'T'                                                
         MVC   KEY@.STAKCALL(4),0(R4)                                           
         MVI   KEY@.STAKCALL+4,C'T'                                             
         MVC   KEY@.STAKAGY,AGY                                                 
         MVC   KEY@.STAKCLT,CLT                                                 
         MVC   KEY@.STAKFILL,=C'000'                                            
         DROP  KEY@                                                             
*                                                                               
         GOTO1 HIGHSTA                                                          
         L     R3,ADSTAT                                                        
         USING STAREC,R3                                                        
         CLC   STAKEY,KEYSAVE                                                   
         BE    BLDN23                                                           
         CLC   STAKEY(STAKCLT-STAKEY),KEYSAVE                                   
         BNE   BLDN24                                                           
         CLC   STAKCLT,=C'000'                                                  
         BE    BLDN23                                                           
         MVC   (STAKCLT-STAKEY)+KEY,=C'000'                                     
         GOTO1 HIGHSTA                                                          
         L     R3,ADSTAT                                                        
         CLC   STAKEY,KEYSAVE                                                   
         BNE   BLDN24                                                           
*                                                                               
BLDN23   DS    0H                                                               
         MVC   NTBPSTS-NETTABD(NPROVS,R4),SPST                                  
         DROP  R3                                                               
*                                                                               
BLDN24   DS    0H                                                               
         LA    R4,NETTABL(R4)      NEXT TABLE ENTRY                             
         BCT   R0,BLDN22                                                        
*                                                                               
         MVC   KEY,KEY1                                                         
         GOTO1 HIGH                RESTORE SEQ                                  
*                                                                               
         XIT1                                                                   
         DROP  R2                                                               
*                                                                               
SVAADDRS DS    CL(ADDRLEN)         SAVE AREA FOR CORP ADDRESSES                 
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'BLDTAB - BUILD SORT/BREAK CONTROL TABLE'                        
BLDTAB   NMOD1 0,BLDTAB                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
*                                  READ B5 PROFILE                              
*                                  MOVE PROFILE INTO BRKEQV                     
         CLI   NETOPT,C'N'                                                      
         BNE   *+8                                                              
         OI    BRKTYP+2,X'04'      SET COST TYPE REQ FOR NETWORK                
         XC    X,X                                                              
         MVC   X(6),PROFB4         HOLD PROF IN X                               
*                                                                               
         CLI   RETPROF,0           IF RETAIL                                    
         BE    BT008                                                            
         CLI   X+1,C'T'            PRODUCT MUST BE TOGETHER                     
         BE    BT008                                                            
         CLI   X+1,C'S'            OR SEPARATE                                  
         BE    BT008                                                            
         MVI   ERR,RETPERR         RETAIL/PROFILE ERROR                         
         BRAS  RE,ERRPROC                                                       
*                                                                               
BT008    DS    0H                                                               
         MVI   PRDMKT,C'P'         PRD HIGHER THAN MKT                          
         CLI   X+4,C'R'            UNLESS MKT OPT = R                           
         BNE   BT01                                                             
         MVI   X+4,C'T'            THEN RESET TO T                              
         CLI   X+1,C'T'            PRD MUST ALSO BE T                           
         BNE   BT01                                                             
         MVI   PRDMKT,C'M'         AND SET MKT HIGHER THAN PRD                  
BT01     DS    0H                                                               
*                                                                               
*              IF REQ FOR SINGLE SET PROF TO SEPARATE                           
         CLI   X+0,C'T'            BUT FOR PGR LEAVE T ALONE                    
         BE    *+16                (SHOULD PROBABLY DO FOR OTHERS TOO)          
         CLI   PGRQ,C'1'                                                        
         BNE   *+8                                                              
         MVI   X+0,C'S'                                                         
*                                                                               
         CLI   PRDQ,C'1'                                                        
         BNE   *+8                                                              
         MVI   X+1,C'S'                                                         
         CLI   ESTQ,C'1'                                                        
         BNE   *+8                                                              
         MVI   X+2,C'S'                                                         
         CLI   MGRQ,C'1'                                                        
         BNE   *+8                                                              
         MVI   X+3,C'S'                                                         
*                                                                               
         CLI   STAQ,C'1'           IF ONE STATION REQ                           
         BNE   BT01E                                                            
         CLI   ZLOPT,C'A'          . . . AND NO 0-LINE SUPPRESSION. . .         
         BE    BT01E                                                            
         CLC   TYPE,ZLOPT                                                       
         BE    BT01E                                                            
         MVI   X+4,C'S'            SET MARKET SEPARATE                          
         MVI   X+5,C'S'            AND STATION                                  
*                                                                               
BT01E    CLI   MKTQ,C'1'                                                        
         BNE   *+16                                                             
         CLI   QMED,C'N'                                                        
         BE    *+8                                                              
         MVI   X+4,C'S'                                                         
*                                                                               
         CLI   X+5,C'T'            IF STATION TOGETHER THEN                     
         BNE   BT101                                                            
         CLI   QMED,C'N'           EXCEPT FOR NETWORK                           
         BE    BT101                                                            
         CLI   X+4,C'S'                                                         
         BE    *+8                                                              
         MVI   X+4,C'T'            THEN MKT MUST BE TOG OR SEP                  
BT101    DS    0H                                                               
         MVC   X+6(2),=C'NN'       NO SPOT DETAILS                              
         MVI   SPOTSW,C'N'                                                      
         OC    PROFBN,PROFBN       UNLESS HAVE SPECIAL PROF                     
         BZ    BT100                                                            
         CLI   PROFBN+2,C'N'                                                    
         BE    BT100                                                            
         MVI   SPOTSW,C'Y'                                                      
         BRAS  RE,NOTEOUT2                                                      
         MVC   X+6(1),PROFBN       PKG CTL                                      
         MVI   X+7,C'T'            SPOT CTL                                     
         MVC   PROGSW,PROFBN+2     SPOT SEQ.                                    
         CLI   PKGREQ,0            IF PACKAGE REQ                               
         BE    *+8                                                              
         MVI   X+6,C'S'            SET PKG TO SEPARATE                          
*                                                                               
BT100    DS    0H                                                               
         MVI   X+8,C'N'                                                         
         CLI   NETOPT,C'O'                                                      
         BE    BT100B                                                           
         CLI   QMED,C'N'                                                        
         BNE   BT100B                                                           
         MVC   X+8(1),PROFB2+9       TIME/INTEG CONTROL                         
         CLI   X+8,0                                                            
         BNE   *+8                                                              
         MVI   X+8,C'N'                                                         
BT100B   DS    0H                                                               
*                                                                               
*                                                                               
         CLI   CTYPQ,C'N'          IF TIME AND INTEGRATION                      
         BE    *+16                                                             
         CLI   CTYPQ,C'B'          REQUESTED SEPARATELY                         
         BE    *+8                 NO                                           
         MVI   X+8,C'S'            TREAT AS SEPARATES                           
*                                                                               
         MVI   X+9,C'N'            CANADIAN NETWORK                             
         CLI   CNETOPT,C' '        SET FROM B4A PROFILE                         
         BNH   *+10                                                             
         MVC   X+9(1),CNETOPT                                                   
*                                  NETOTP O = OLD ONLY, N = NEW ONLY            
         CLI   QMED,C'N'           FOR NETWORK                                  
         BNE   BT100D                                                           
*                                                                               
         OC    CNETSTR2,CNETSTR2   IF 2ND CANNET FEATURE USED                   
         BZ    BT100B2                                                          
         OC    CNETSTRT,CNETSTRT   AND 1ST IS ALSO                              
         BZ    BT100B2                                                          
         CLC   CURPER,CNETSTRT     AND CURRENTLY IN 1ST FEATURE MODE            
         BL    BT100B2                                                          
         CLC   CURPER,CNETSTR2                                                  
         BNL   BT100B2                                                          
*                                                                               
         MVC   X+5(1),X+9          SET STATION TO NETWORK OPT                   
         MVI   X+9,C'N'            AND SET NETWORK TO N                         
*                                                                               
BT100B2  DS    0H                                                               
         CLI   NETOPT,C'O'                                                      
         BE    BT100D                                                           
         MVI   NETOPT,C'N'                                                      
         CLI   PROFB2+9,0                                                       
         BNE   BT100D                                                           
         CLI   SPOTSW,C'Y'                                                      
         BE    BT100D                                                           
         MVI   NETOPT,C'O'                                                      
BT100D   DS    0H                                                               
*                                                                               
         MVI   X+10,C'N'           WB FLIGHT                                    
         CLI   WBSW,C'Y'                                                        
         BNE   *+8                                                              
         MVI   X+10,C'S'           WB FLIGHT                                    
*                                                                               
         OC    MANGRS,MANGRS       IF MANUAL                                    
         BZ    *+10                                                             
         MVC   X+3(5),=C'NNNNNN'   SUPPRESS MGR,MKT,STA + SPOT DETS             
         XC    WORK,WORK                                                        
         MVC   WORK(BRKEQVL),BRKEQV                                             
         LA    R2,WORK                                                          
         MVC   PGR1DQ(1,R2),X+0    PGR1                                         
         MVC   PGR2DQ(1,R2),X+0    PGR2                                         
         MVC   PGR3DQ(1,R2),X+0    PGR3                                         
         MVC   PRDDQ(1,R2),X+1     PRD                                          
         MVC   ESTDQ(1,R2),X+2     EST                                          
         MVC   MGR1DQ(1,R2),X+3    MGR1                                         
         MVC   MGR2DQ(1,R2),X+3    MGR2                                         
         MVC   MGR3DQ(1,R2),X+3    MGR3                                         
         MVC   MKTDQ(1,R2),X+4     MKT                                          
         MVC   NETDQ(1,R2),X+9     CANADIAN NETWORK                             
         MVC   STADQ(1,R2),X+5     STA                                          
         MVC   PKGDQ(1,R2),X+6     PKG                                          
         MVC   PGMDQ(1,R2),X+7     PGM                                          
         MVC   DESCDQ(1,R2),X+7    DESC                                         
*                                         (PERIOD)                              
*                                         (PERIOD GROUP)                        
         MVC   CTYPDQ(1,R2),X+8    TYPE - TIME, INT, ETC                        
         MVC   FLTDQ(1,R2),X+10    WB FLIGHT                                    
*                                                                               
         CLI   STADQ(R2),C'N'      STAT CAN'T BE N IF HAVE SPOT DETAIL          
         BNE   *+16                                                             
         CLI   DESCDQ(R2),C'N'                                                  
         BE    *+8                                                              
         MVI   STADQ(R2),C'T'                                                   
*                                                                               
         CLI   STADQ(R2),C'S'      STATION MUST BE S IF PACKAGE IS S            
         BE    *+16                                                             
         CLI   PKGDQ(R2),C'S'                                                   
         BNE   *+8                                                              
         MVI   STADQ(R2),C'S'                                                   
*                                                                               
         CLI   PROGSW,C'P'                                                      
         BE    BT1AA                                                            
*                                  SWAP PROG AND DESC TO CHANGE SORT            
         XC    PGMDQ(L'BRKEQV,R2),DESCDQ(R2)                                    
         XC    DESCDQ(L'BRKEQV,R2),PGMDQ(R2)                                    
         XC    PGMDQ(L'BRKEQV,R2),DESCDQ(R2)                                    
*                                                                               
BT1AA    DS    0H                                                               
         MVI   PERDQ(R2),C'S'      PRIOR SEPARATE                               
         CLI   PRIOR,C'1'          IF 1 - 3                                     
         BNL   BT1A                                                             
         MVI   PERDQ(R2),C'T'      PRIOR TOGETHER                               
         CLI   PRIOR,X'CB'         IF A - C (OR FUDGED: X'C4' - X'CB')          
         BNH   BT1A                                                             
*                                                                               
         MVC   PERDQ(1,R2),PRIOR   PERIOD                                       
*                                                                               
BT1A     DS    0H                                                               
         CLI   PRIOR,C'N'          IF NO PRIOR                                  
         BNE   *+8                                                              
         MVI   PERDQ(R2),C'S'      TREAT AS SEPARATE                            
         CLI   PRIOR,C'U'          25 MOS SEP                                   
         BNE   *+8                                                              
         MVI   PERDQ(R2),C'S'                                                   
         CLI   PRIOR,C'V'          25 MOS TOG                                   
         BNE   *+8                                                              
         MVI   PERDQ(R2),C'T'                                                   
         CLI   XPERSW,C'Y'         IF CROSS PERIOD                              
         BNE   *+8                                                              
         MVI   PERDQ(R2),C'N'      SET DATE AS 'NO'                             
         MVI   PERGDQ(R2),C'N'     NO PERIOD GROUP                              
         CLI   PRIOR,C'W'          UNLESS CUR MO SEPARATE (M OR W)              
         BE    *+12                                                             
         CLI   PRIOR,C'M'                                                       
         BNE   *+12                                                             
         MVI   PERDQ(R2),C'T'                                                   
         MVI   PERGDQ(R2),C'S'                                                  
*                                                                               
         CLI   SUMOPT,C'Y'         IF DOING RETAIL SUMMARY                      
         BNE   *+8                                                              
         MVI   PERGDQ(R2),C'R'     USE PER GRP AS DUMMY 'SEPARATE'              
*                                  (USE 'R' TO CAUSE TO SORT FIRST)             
*                                                                               
*                                  IF NO 'SEPARATE' SET PERIOD GROUP            
*                                  TO SEP AND USE AS DUMMY INV BRK              
         LR    RF,R2                                                            
         LHI   R0,11                                                            
BT1B     DS    0H                                                               
         CLI   0(RF),C'S'                                                       
         BE    *+16                                                             
         LA    RF,L'BRKEQV(RF)                                                  
         BCT   R0,BT1B                                                          
         MVI   PERGDQ(R2),C'S'     PERIOD GROUP TO S                            
*                                                                               
*                                  SET PAGE BREAK                               
         ZIC   RF,PROFB4+7                                                      
         LTR   RF,RF                                                            
         BZ    BT3                                                              
         LA    RF,2(RF)            ADJUST FOR PGR AND MGR LUMPING               
         CLI   PROFB4+7,4                                                       
         BL    *+8                                                              
         LA    RF,2(RF)                                                         
         MHI   RF,L'BRKEQV                                                      
         LA    RF,WORK-L'BRKEQV(RF)                                             
         LA    RE,WORK                                                          
BT2B     DS    0H                                                               
         CLI   0(RE),C'T'                                                       
         BNE   *+8                                                              
         OI    2(RE),X'80'         PAGE BREAK                                   
         LA    RE,L'BRKEQV(RE)                                                  
         CR    RE,RF                                                            
         BNH   BT2B                                                             
*                                                                               
BT3      DS    0H                                                               
*                                  SET RECAP LEVEL                              
         ZIC   RF,PROFB4+6                                                      
         LTR   RF,RF                                                            
         BZ    BT3B                                                             
         LA    RF,2(RF)            ADJUST FOR PGR AND MGR LUMPING               
         CLI   PROFB4+6,4                                                       
         BL    *+8                                                              
         LA    RF,2(RF)                                                         
         MHI   RF,L'BRKEQV                                                      
         LA    RF,WORK-L'BRKEQV(RF)                                             
         LA    RE,WORK                                                          
BT3A     DS    0H                                                               
         OI    2(RE),X'40'         RECAP LEVEL                                  
         LA    RE,L'BRKEQV(RE)                                                  
         CR    RE,RF                                                            
         BNH   BT3A                                                             
BT3B     DS    0H                                                               
*                                                                               
         MVC   BFORMAT,PROFB4+11       2 FORMATS                                
         MVC   DFORMAT,PROFB4+12                                                
         CLI   DFORMAT,0           IF NO RECAP FORMAT STATED                    
         BNE   *+18                                                             
         CLI   PROFB4+6,0         BUT RECAP ASKED FOR                           
         BE    *+10                                                             
         MVC   DFORMAT,BFORMAT     ASSUME THE SAME A NORMAL BILL                
*                                                                               
         CLI   RETDRAFT,C'Y'       FOR RETAIL DRAFT REPORT                      
         BNE   *+14                                                             
         MVC   RDRFCORP,PROFB4+12      SET CORPORATE OPTION                     
         MVI   DFORMAT,0           AND IGNORE DETAIL BACK UP FORMAT             
*                                  SET GROSS/NET CONTROL                        
         MVC   GNSW,PROFB4+13      GROSS/NET                                    
         MVI   COMMSW,C'N'         NO COMMISSION                                
         CLI   GNSW,C'1'           IF G OR N                                    
         BL    BT3E                                                             
         MVI   GNSW,C'G'           1 = G WITH COMM                              
         BE    *+8                                                              
         MVI   GNSW,C'N'           2 = N WITH COMM                              
         MVI   COMMSW,C'Y'                                                      
*                                                                               
BT3E     DS    0H                                                               
         MVC   BYTE,DFORMAT                                                     
         CLI   BYTE,0                                                           
         BNE   *+10                                                             
         MVC   BYTE,BFORMAT                                                     
*                                                                               
         CLI   BYTE,13             13 = GROSS AND NET                           
         BNE   BT3F                                                             
         MVC   CLMCTLS,=C'NGN'                                                  
         CLI   GNSW,C'G'                                                        
         BE    *+10                                                             
         MVC   CLMCTLS,=C'GNG'     REVERSE G AND NET                            
         B     BT3H                                                             
*                                                                               
BT3F     DS    0H                  ANYTHING ELSE = GROSS ALONE                  
         MVC   CLMCTLS,=C'*GN'                                                  
         CLI   GNSW,C'G'                                                        
         BE    *+10                                                             
         MVC   CLMCTLS,=C'*NG'     REVERSE G AND N                              
*                                                                               
BT3H     DS    0H                                                               
         CLI   BYTE,12                                                          
         BNE   *+8                                                              
         MVI   CLMCTLS,C'S'        SPOTS                                        
*                                                                               
         CLI   COMMSW,C'Y'                                                      
         BNE   *+8                                                              
         MVI   CLMCTLS+2,C'C'      COMMISSION IN STRIP OFF                      
*                                                                               
         CLI   RETDRAFT,C'Y'       FOR RETAIL DRAFT                             
         BNE   *+18                                                             
         MVI   LSTOPT,C'N'           NO PREV INVOICE LIST                       
         MVC   PREVSW,PROFB4+14      AND SET PREVSW                             
         B     BT3H6                                                            
*                                                                               
         MVC   LSTOPT,PROFB4+14                                                 
         CLI   WORK+30,C'S'        IF STATIONS SEPARATE (USED TO                
         BNE   *+8                 CHECK PROFB4+5)                              
         MVI   LSTOPT,C'N'         NO PREVIOUS LIST                             
         CLI   PROFBN+0,C'S'       OR IF PACKAGES SEP                           
         BNE   *+8                                                              
         MVI   LSTOPT,C'N'                                                      
*                                                                               
         LA    RF,LSTOTAB          SEE IF KEEPING REVERSED & REVERSALS          
         MVI   SHOWREV,C'N'                                                     
BT3H4    CLC   LSTOPT,0(RF)                                                     
         BNE   *+18                                                             
         MVC   LSTOPT,1(RF)                                                     
         MVI   SHOWREV,C'Y'                                                     
         B     BT3H6                                                            
*                                                                               
         LA    RF,L'LSTOTAB(RF)    NXT ENTRY                                    
         CLI   0(RF),X'FF'                                                      
         BNE   BT3H4                                                            
*                                  SWAP MKT AND PRD CLTS                        
BT3H6    DS    0H                                                               
         CLI   PRDMKT,C'M'         TEST MKT TO BE HIGHER THAN PRD               
         BNE   BT3J                                                             
*                                  SWAP MKT AND PRD CLTS                        
         MVC   X(15),WORK                                                       
         MVC   WORK(12),WORK+15                                                 
         MVC   WORK+12(15),X                                                    
*                                                                               
BT3J     DS    0H                                                               
*                                                                               
*                                  S=SEPARATE                                   
*                                  T=TOGETHER                                   
*                                  N=NO                                         
         LHI   R0,BRKEQVL/L'BRKEQV                                              
BT4      DS    0H                                                               
         CLI   0(R2),C'N'                                                       
         BNE   *+8                                                              
         MVI   0(R2),X'FF'         SET N'S LAST                                 
         LA    R2,L'BRKEQV(R2)                                                  
         BCT   R0,BT4                                                           
*                                  SORT ON PROFILE BYTE (POSITION)              
         LHI   R0,BRKEQVL/L'BRKEQV                                              
         GOTO1 XSORT,DMCB,WORK,(R0),L'BRKEQV,1,0                                
*                                  BUILD BRKTAB                                 
         LA    R2,WORK                                                          
         L     R3,ABRKTAB                                                       
         USING BRKTABD,R3                                                       
         XC    0(L'BRKTAB,R3),0(R3)                                             
*****    XC    BRKTAB,BRKTAB                                                    
         SR    R7,R7                                                            
         XC    ABRKS(ABRKSL),ABRKS CLEAR CONTROL ADDRESSES                      
         XC    ATOTS,ATOTS                                                      
         XC    ATOTSV,ATOTSV                                                    
         XC    ALEVS,ALEVS                                                      
         XC    LEVCTLS,LEVCTLS                                                  
BT6      DS    0H                                                               
         ZIC   RF,1(R2)            CODE                                         
         LTR   RF,RF                                                            
         BZ    *+16                                                             
         BAS   RE,BTTAB-4(RF)                                                   
         LA    R2,L'BRKEQV(R2)                                                  
         B     BT6                                                              
*                                                                               
         CLI   SORTTRCE,C'Y'       IF TRACING, PRINT A TABLE OF KEY             
         BNE   BT6K                FIELDS AND THEIR SEQUENCE                    
*                                                                               
         MVC   P,SPACES                                                         
         MVC   P(55),=C'FIELDS IN THE SORTKEY APPEAR IN THE FOLLOWING SE        
               EQUENCE:'                                                        
         GOTO1 REPORT                                                           
         L     R3,ABRKTAB                                                       
         LA    R2,BRKNAME          TABLE OF BREAK NAMES                         
         USING BRKNAMD,R2                                                       
         LA    RF,BRKNAML(R2)      POINT TO THE END                             
*                                                                               
BT6C     CLC   BRKNCOD,BRKCODE+3     FIND ENTRY IN BRKNAME TABLE                
         BE    *+16                                                             
         LA    R2,BRKNL(R2)        NXT ENTRY                                    
         CR    R2,RF               PAST THE END OF TAB ?                        
         BL    BT6C                                                             
         DC    H'0'                                                             
*                                                                               
         MVC   P(L'BRKNNAM),BRKNNAM                                             
         MVC   P+L'BRKNNAM+1(17),=C'FOR THE LENGTH OF'                          
         L     R4,BRKLENM1         GET LENGTH-1                                 
         AHI   R4,1                                                             
         EDIT  (R4),(2,P+L'BRKNNAM+19)                                          
         GOTO1 REPORT                                                           
*                                                                               
         LA    R2,BRKNAME          TABLE OF BREAK NAMES                         
         LA    RF,BRKNAML(R2)      POINT TO THE END                             
         LA    R3,BRKL(R3)         NXT BRAKE CODE                               
         OC    BRKCODE,BRKCODE     EOT ?                                        
         BNZ   BT6C                                                             
         DROP  R2                                                               
*                                                                               
BT6K     L     R9,ABUFFC                                                        
         L     R9,ABUFFC                                                        
         USING BUFFALOD,R9                                                      
*                                                                               
         ST    R7,SORTKLEN         ACCUMED KEY LEN                              
         A     R7,BUFFLCOM                                                      
         A     R7,BUFFLDTA                                                      
         ST    R7,SORTRLEN                                                      
         LA    R7,SORTREC                                                       
         A     R7,SORTKLEN                                                      
         ST    R7,ASORTCOM                                                      
         A     R7,BUFFLCOM                                                      
         ST    R7,ASORTDTA                                                      
*                                                                               
*                                  RECALCULATE MAX LINES                        
         L     RF,BUFFCRMX                                                      
         M     RE,BUFFLALL                                                      
         D     RE,SORTRLEN                                                      
         ST    RF,BUFFCRMX                                                      
*                                                                               
         MVC   BUFFLIST(1),SORTKLEN+3     SET LENGTH OF KEY                     
         MVC   BUFFLKEY,SORTKLEN                                                
         MVC   BUFFLALL,SORTRLEN   SET LENGTH OF REC                            
         MVI   BUFFDOPT,C'Y'                                                    
         MVI   BUFFXOPT,BUFFXBIG          DON'T COMPRESS LARGE NUMBERS          
*                                                                               
         GOTO1 BUFFALO,DMCB,=C'SET',ABUFFC                                      
         OC    NBUFFADR,NBUFFADR   HAVE WE ALREADY DONE A COVAIL?               
         BNZ   BT9                                                              
         GOTO1 =V(COVAIL),DMCB,C'SETB',150000,100000,ABUFFC                     
         OC    4(4,R1),4(R1)       TEST COVAIL ERROR                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   ABUFFC,12(R1)       NEW BUFFALOC                                 
         MVC   NBUFFADR,4(R1)      SAVE NEW BUFFER ADDRESS                      
         MVC   NBUFFLN,8(R1)       AND LENGTH                                   
         B     BT9B                                                             
*                                                                               
BT9      DS    0H                                                               
         GOTO1 =V(COVAIL),DMCB,C'RESB',NBUFFADR,NBUFFLN,ABUFFC                  
*                                                                               
BT9B     DS    0H                                                               
         DROP  R9                                                               
*                                                                               
*                                  SET A(TOTALS)                                
         L     R3,ALOWBRK          START AT END OF BRKTAB AND BACK UP           
         L     R0,ABRKTAB                                                       
         L     R4,=A(LEVTOTS)                                                   
         L     R5,=A(VBTAB)                                                     
BT10     DS    0H                                                               
         L     RF,BRKCODE                                                       
         LA    RF,ATOTS(RF)                                                     
         ST    R4,0(RF)                                                         
         L     RF,BRKCODE                                                       
         LA    RF,ATOTSV(RF)                                                    
         ST    R5,0(RF)                                                         
         AHI   R4,TOTSIZE                                                       
         AHI   R5,VTOTSIZE                                                      
         SHI   R3,BRKL                                                          
         CR    R3,R0                                                            
         BNL   BT10                                                             
*                                                                               
         OC    AINVBRK,AINVBRK     IF NO INVOICE LEVEL BREAK                    
         BNZ   *+12                ESTABLISHED                                  
         MVI   ERR,PLEVERR         RETURN ERROR                                 
         BRAS  RE,ERRPROC                                                       
*                                                                               
         CLC   AINVBRK,APMSELO                                                  
         BNH   *+10                                                             
         MVC   APMSELO,AINVBRK                                                  
         CLI   RETPROF,0           IF RETAIL                                    
         BE    *+10                                                             
         XC    ARECAP,ARECAP       THEN NO RECAPS                               
         OC    MANGRS,MANGRS       IF MANUAL                                    
         BZ    *+10                                                             
         XC    ARECAP,ARECAP       THEN NO RECAPS                               
         CLC   APAGBRK,AINVBRK                                                  
         BNL   *+10                                                             
         MVC   APAGBRK,AINVBRK                                                  
         OC    ARECAP,ARECAP                                                    
         BZ    BT10B                                                            
         CLC   ARECAP,AINVBRK      IF RECAP OPT IS NOT LOGICAL                  
         BNL   *+10                                                             
         MVC   ARECAP,AINVBRK      SET TO INVOICE BRK                           
         CLI   STACTL,C'S'         IF STATION SEPARATE. . .                     
         BNE   *+10                                                             
         XC    ARECAP,ARECAP       . . . NEVER DO RECAP                         
BT10B    DS    0H                                                               
         MVC   SVPAGBRK,APAGBRK    SAVE PAGE LEVEL                              
         MVC   SVLOWTOG,ALOWTOG    AND LOWEST TOGETHER                          
*                                  CHANGE CTL FROM T TO P                       
*                                  FOR TOGETHERS ON SEP PAGE                    
         L     R3,ABRKTAB                                                       
         XC    AHITOG,AHITOG                                                    
BT11     DS    0H                                                               
         OC    BRKCODE,BRKCODE                                                  
         BZ    BT11D                                                            
         CLI   BRKCTL1,C'T'                                                     
         BNE   BT11B                                                            
         C     R3,APAGBRK                                                       
         BH    BT11A                                                            
         MVI   BRKCTL1,C'P'                                                     
         LA    RF,LEVCTLS                                                       
         A     RF,BRKCODE                                                       
         MVI   0(RF),C'P'                                                       
         B     BT11B                                                            
*                                                                               
BT11A    DS    0H                                                               
         OC    AHITOG,AHITOG       SAVE HIGHEST TOGETHER BRK                    
         BNZ   *+8                                                              
         ST    R3,AHITOG                                                        
*                                                                               
BT11B    DS    0H                                                               
         LA    R3,BRKL(R3)                                                      
         B     BT11                                                             
*                                                                               
BT11D    DS    0H                                                               
         CLI   PBLOPT,C'Y'         IF RETAIL PARTIAL BILLING ON                 
         BNE   BT13                                                             
         CLI   MGR1CTL,C'S'        MGR MUST BE SEP                              
         BNE   BT11G                                                            
         CLI   MKTCTL,C'S'         AND MKT TOG OR NO                            
         BE    BT11G               (NOT PART OF RETAIL)                         
         CLI   ESTCTL,C'T'         AND EST TOG                                  
         BE    BT13                                                             
*                                                                               
BT11G    DS    0H                                                               
         MVI   PBLOPT,C'N'         SET OFF PARTIAL SWITCH                       
*                                                                               
BT13     DS    0H                                                               
*                                                                               
         XIT1                                                                   
         SPACE 3                                                                
BTTAB    DS    0F                                                               
         B     BTPGR1                                                           
         B     BTPGR2                                                           
         B     BTPGR3                                                           
         B     BTPRD                                                            
         B     BTEST                                                            
         B     BTMGR1                                                           
         B     BTMGR2                                                           
         B     BTMGR3                                                           
         B     BTMKT                                                            
         B     BTNET                                                            
         B     BTSTA                                                            
         B     BTPKG                                                            
         B     BTPGM                                                            
         B     BTDESC                                                           
         B     BTPER                                                            
         B     BTPERG                                                           
         B     BTCTYP                                                           
         B     BTFLT                                                            
*                                                                               
         SPACE 2                                                                
BTPGR1   DS    0H                                                               
         ZIC   R4,PGR1LEN                                                       
         B     BTALL                                                            
         SPACE 2                                                                
BTPGR2   DS    0H                                                               
         ZIC   R4,PGR2LEN                                                       
         ZIC   R0,PGR1LEN                                                       
         SR    R4,R0                                                            
         B     BTALL                                                            
         SPACE 2                                                                
BTPGR3   DS    0H                                                               
         ZIC   R4,PGR3LEN                                                       
         ZIC   R0,PGR2LEN                                                       
         SR    R4,R0                                                            
         B     BTALL                                                            
         SPACE 2                                                                
BTPRD    DS    0H                                                               
         LHI   R4,1                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTMGR1   DS    0H                                                               
         ZIC   R4,MGR1LEN                                                       
         B     BTALL                                                            
         SPACE 2                                                                
BTMGR2   DS    0H                                                               
         ZIC   R4,MGR2LEN                                                       
         ZIC   R0,MGR1LEN                                                       
         SR    R4,R0                                                            
         B     BTALL                                                            
         SPACE 2                                                                
BTMGR3   DS    0H                                                               
         ZIC   R4,MGR3LEN                                                       
         ZIC   R0,MGR2LEN                                                       
         SR    R4,R0                                                            
         B     BTALL                                                            
         SPACE 2                                                                
BTMKT    DS    0H                                                               
         LHI   R4,2                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTEST    EQU   BTPRD                                                            
BTPER    EQU   BTPRD                                                            
BTPERG   EQU   BTPRD                                                            
         SPACE 2                                                                
BTPGM    DS    0H                                                               
         LHI   R4,18                                                            
         B     BTALL                                                            
         SPACE 2                                                                
BTDESC   DS    0H                                                               
         LHI   R4,6                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTPKG    EQU   BTPRD                                                            
BTCTYP   EQU   BTPRD                                                            
         SPACE 2                                                                
BTSTA    DS    0H                                                               
         LHI   R4,3                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTNET    DS    0H                                                               
         LHI   R4,3                                                             
         B     BTALL                                                            
         SPACE 2                                                                
BTFLT    DS    0H                                                               
         LHI   R4,10                                                            
         B     BTALL                                                            
         SPACE 2                                                                
BTALL    DS    0H                                                               
         LTR   R4,R4               BYPASS = LEN = 0                             
         BNE   BTALL1                                                           
         MVI   0(R2),C'N'                                                       
         BR    RE                                                               
BTALL1   DS    0H                                                               
         CLI   0(R2),X'FF'         TEST BYPASSED                                
         BNE   BTALL2                                                           
         MVI   0(R2),C'N'          RESET FF TO N                                
         TM    2(R2),X'0F'         TEST OK TO BYPASS                            
         BZR   RE                  YES                                          
BTALL2   DS    0H                                                               
         CLI   0(R2),C'R'          CHAGE R TO S                                 
         BNE   *+8                 (PER GRP FOR RETAIL SUMMARY)                 
         MVI   0(R2),C'S'                                                       
         TM    2(R2),X'01'                                                      
         BZ    BTALL4                                                           
         ST    R3,APMSELO         SAVE 'LOWEST' (HIGH IN CORE)                  
*                                  OF PRD,MKT,STA,EST                           
BTALL4   DS    0H                                                               
         TM    2(R2),X'02'                                                      
         BZ    BTALL6                                                           
         ST    R3,APEPLO           SAVE 'LOWEST' OF PRD-EST-PER                 
         OC    APEPHI,APEPHI                                                    
         BNZ   *+8                                                              
         ST    R3,APEPHI           SAVE 'HIGHEST'                               
BTALL6   DS    0H                                                               
         ZIC   RF,1(R2)                                                         
         ST    RF,BRKCODE          CODE                                         
         ST    R7,BRKDISP          DISP = CUMED LENGTH                          
         AR    R7,R4                                                            
         BCTR  R4,0                                                             
         ST    R4,BRKLENM1         LENGTH OF FIELD - 1                          
*                                                                               
         MVC   BRKCTL1,0(R2)       CONTROL BYTE                                 
*                                                                               
         ST    R3,ALOWBRK          SAVE ADDR OF LOWEST BRK                      
         LA    RF,ABRKS-4                                                       
         A     RF,BRKCODE                                                       
         ST    R3,0(RF)            SET ADDR OF THIS LEV BRK                     
*                                                                               
         CLI   BRKCTL1,C'T'                                                     
         BNE   BTALL7                                                           
         C     R3,APERBRK                                                       
         BE    BTALL7                                                           
         C     R3,ACTYPBRK                                                      
         BE    BTALL7                                                           
         C     R3,APGMBRK                                                       
         BE    BTALL7                                                           
         ST    R3,ALOWTOG     LOWEST 'TOGETHER' (EXC PER AND CTYP)              
*                                      (AND PGM (DESC USED INSTEAD))            
BTALL7   DS    0H                                                               
         LA    RF,ALEVS                                                         
         A     RF,BRKCODE                                                       
         LA    R0,SORTREC                                                       
         A     R0,BRKDISP                                                       
         ST    R0,0(RF)            SET ADDR OF FIELD                            
         LA    RF,LEVCTLS                                                       
         A     RF,BRKCODE                                                       
         MVC   0(4,RF),BRKCTL1                                                  
         CLI   0(R2),C'S'                                                       
         BNE   *+8                                                              
         ST    R3,AINVBRK          A(LEVEL FOR NEW INVOICE)                     
         CLI   0(R2),C'N'                                                       
         BE    BTALL8                                                           
         TM    2(R2),X'80'                                                      
         BZ    *+8                                                              
         ST    R3,APAGBRK          A(PAGE BREAK LEVEL)                          
         TM    2(R2),X'40'                                                      
         BZ    *+8                                                              
         ST    R3,ARECAP           A(RECAP LEVEL)                               
BTALL8   DS    0H                                                               
         LA    R3,BRKL(R3)                                                      
         BR    RE                                                               
         DROP  R3                                                               
         SPACE 3                                                                
*                                  TABLE OF BRK CODES AND LENGTHS               
*                                  BYTE 1 - TO BE FILLED IN FROM PROF           
*                                  BYTE 2 - CODE                                
*                                  BYTE 3 - CONTROL GROUP                       
*                                  X'01' = PRD,EST,MKT,STA                      
*                                  X'02' = PRD,EST,PER                          
*                                  X'04' = NECESSARY FOR OTHER REASON           
*                                         (COST TYPE FOR NETWORK)               
BRKEQV   DS    0CL3                                                             
         DC    X'00',AL1(4*PGR1EQ),X'00'    PGR1                                
         DC    X'00',AL1(4*PGR2EQ),X'00'    PGR2                                
         DC    X'00',AL1(4*PGR3EQ),X'00'    PGR3                                
         DC    X'00',AL1(4*PRDEQ),X'03'     PRD                                 
         DC    X'00',AL1(4*ESTEQ),X'03'     EST                                 
         DC    X'00',AL1(4*MGR1EQ),X'00'    MGR1                                
         DC    X'00',AL1(4*MGR2EQ),X'00'    MGR2                                
         DC    X'00',AL1(4*MGR3EQ),X'00'    MGR3                                
         DC    X'00',AL1(4*MKTEQ),X'01'     MKT                                 
         DC    X'00',AL1(4*NETEQ),X'00'     CANADIAN NETWORK                    
         DC    X'00',AL1(4*STAEQ),X'01'     STA                                 
         DC    X'00',AL1(4*PKGEQ),X'00'     PACKAGE                             
         DC    X'00',AL1(4*PGMEQ),X'00'     PROGRAM                             
         DC    X'00',AL1(4*DESCEQ),X'00'    SPOT DESC                           
         DC    X'00',AL1(4*PEREQ),X'02'     PERIOD                              
         DC    X'00',AL1(4*PERGEQ),X'00'    PERIOD GROUP                        
BRKTYP   DC    X'00',AL1(4*CTYPEQ),X'00'    TYPE - TIME, INT, ETC.              
         DC    X'00',AL1(4*FLTEQ),X'00'     WB FLIGHT                           
BRKEQVL  EQU   *-BRKEQV                                                         
         SPACE 3                                                                
BRKNAME  DS    0C                                                               
         DC    AL1(4*PGR1EQ),CL10'PGR1'                                         
         DC    AL1(4*PGR2EQ),CL10'PGR2'                                         
         DC    AL1(4*PGR3EQ),CL10'PGR3'                                         
         DC    AL1(4*PRDEQ),CL10'PRODUCT'                                       
         DC    AL1(4*ESTEQ),CL10'ESTIMATE'                                      
         DC    AL1(4*MGR1EQ),CL10'MGR1'                                         
         DC    AL1(4*MGR2EQ),CL10'MGR2'                                         
         DC    AL1(4*MGR3EQ),CL10'MGR3'                                         
         DC    AL1(4*MKTEQ),CL10'MARKET'                                        
         DC    AL1(4*NETEQ),CL10'CANAD NETW'                                    
         DC    AL1(4*STAEQ),CL10'STATION'                                       
         DC    AL1(4*PKGEQ),CL10'PACKAGE'                                       
         DC    AL1(4*PGMEQ),CL10'PROGRAM'                                       
         DC    AL1(4*DESCEQ),CL10'SPOT DESC'                                    
         DC    AL1(4*PEREQ),CL10'PERIOD'                                        
         DC    AL1(4*PERGEQ),CL10'PERIOD GRP'                                   
         DC    AL1(4*CTYPEQ),CL10'COST TYPE'                                    
         DC    AL1(4*FLTEQ),CL10'FLIGHT'                                        
BRKNAML  EQU   *-BRKNAME                                                        
         SPACE 2                                                                
LSTOTAB  DS    0XL2                                                             
         DC    C'WY'                                                            
         DC    C'SR'                                                            
         DC    C'CA'                                                            
         DC    X'FF'                                                            
LSTOTBL  EQU   *-LSTOTAB                                                        
         LTORG                                                                  
         EJECT                                                                  
         TITLE 'GETNUM - GET AND FORMAT INVOICE NUMBER'                         
GETNUM   NMOD1 0,GETNUM                                                         
         LA    RC,SPACEND                                                       
*                                                                               
*              PARM1  A(CURRENT INVNO) - IF NULLS READ FOR IT                   
*              PARM2  A(DISPLAY INVOICE NUMBER)                                 
*                                                                               
         MVI   RCTRACE,C'N'        SUPPRESS TRACE                               
         ST    R1,SAVR1                                                         
         LM    R2,R3,0(R1)                                                      
         CLI   0(R1),0                                                          
         BNE   GN31                                                             
         UNPK  W(1),TODAY+1(1)     PUT YM IN ONE BYTE                           
         NI    W,X'FF'-X'0F'                                                    
         OC    W(1),TODAYB+1                                                    
         OC    0(2,R2),0(R2)                                                    
         BNZ   GN22                DONT SEARCH FILE                             
*                                                                               
         OC    REBINV,REBINV       IF HAVE REBILL START INVOICE                 
         BZ    *+14                                                             
         MVC   0(2,R2),REBINV      USE IT NOW                                   
         B     GN20                                                             
*                                                                               
         OI    DMINBTS,X'08'       PASS DELETES, SO WE DON'T REUSE NUMS         
         MVI   DMOUTBTS,X'FF'-X'02' DELETED RECORDS ARE OK                      
*                                                                               
         XC    HALF,HALF                                                        
*                                                                               
         CLC   QUESTOR(7),=C'*INVNUM' FORCE INVOICE NUMBER SET?                 
         BE    *+12                                                             
         CLI   PROOFSW,C'Y'        ELSE, FOR PROOF RUN (D1)                     
         BE    GN20                SKIP INVOICE # SEARCH                        
*                                                                               
         BAS   RE,GNOFFSET         SET TABLE FOR OFFICE CHECKING                
*                                                                               
         MVC   KEY1,KEY            PRESERVE KEY                                 
         XC    KEY,KEY                                                          
         MVC   KEY+1(1),BAGYMD     USE REQ MEDIA                                
         CLI   AGMSEQ,C'A'         UNLESS BY AGY                                
         BE    *+12                                                             
         CLI   AGMSEQ,C'D'         OR BY CLIENT ACROSS MEDIA                    
         BNE   *+12                                                             
*                                                                               
         NI    KEY+1,X'FF'-X'0F'                                                
         OI    KEY+1,X'01'         ELSE, SET FIRST MEDIA                        
*                                                                               
         CLI   AGMSEQ,C'C'                                                      
         BE    GN3D                                                             
         CLI   AGMSEQ,C'D'                                                      
         BNE   GN3E                                                             
GN3D     DS    0H                                                               
         MVC   KEY+2(2),BCLT       SET CLIENT                                   
GN3E     DS    0H                                                               
         GOTO1 HIGH                                                             
         B     GN4B                                                             
GN4      DS    0H                                                               
         L     RF,APATCH           TEST TO DUMP AFTER GIVEN KEY                 
         CLC   0(3,RF),=C'DKY'                                                  
         BNE   *+16                                                             
         CLC   KEY(13),3(RF)                                                    
         BNE   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         GOTO1 SEQ                                                              
GN4B     DS    0H                                                               
         CLC   KEY(2),KEYSAVE      AGENCY/MEDIA                                 
         BNE   GN6                                                              
         CLI   AGMSEQ,C'C'                                                      
         BE    *+12                                                             
         CLI   AGMSEQ,C'D'                                                      
         BNE   GN4D                                                             
*                                                                               
         CLC   KEY+2(2),KEYSAVE+2  CLIENT                                       
         BNE   GN6D                                                             
         B     GN4E                                                             
*                                                                               
GN4D     DS    0H                  AGMSEQ NOT CLIENT BASED (C OR D)             
         CLI   AGMOCTL,0           DOING OFFICES?                               
         BE    GN4E                NO, OK                                       
         GOTO1 BINSRCH,CLTPARS,KEY+1   BAGYMD + CLIENT                          
         CLI   0(R1),1             IF IN LIST, OK                               
         BNE   GN4E                                                             
         MVI   KEY+4,X'FF'         ELSE SKIP TO NEXT CLIENT                     
         B     GN3E                                                             
*                                                                               
GN4E     DS    0H                                                               
         OC    INRSQYM,INRSQYM     TEST HAVE RESEQUENCE DATE                    
         BZ    GN5                 NO- RESEQUENCE WITHIN MONTH                  
*                                                                               
         ZIC   R4,KEY+10                                                        
         SRL   R4,4                YEAR DIGIT OF BILL                           
         ZIC   RE,DECADE                                                        
         CLM   R4,1,YEARDIG        COMPARE TO YEAR OF TODAY                     
         BNH   *+8                 IF NOT HIGH, OK                              
         SHI   RE,10               ELSE BACK UP TO PREV DECADE                  
         AR    RE,R4                                                            
         STC   RE,FULL             CALCULATED YEAR OF BILL                      
*                                                                               
         MVC   FULL+1(1),KEY+10                                                 
         NI    FULL+1,X'FF'-X'F0'  ISOLATE MONTH                                
*                                                                               
         CLC   FULL(2),INRSQYM     TEST KEY VS RESEQUENCE DATE                  
         BL    GN4                 SKIP BILLS BEFORE RESEQUENCE YM              
*                                                                               
*&&DO                                                                           
         CLI   PROFB1X+8,C'Y'      DO WE NEED DECADE TEST                       
         BE    GN4F                YES                                          
         CLC   FULL(2),INRSQYM     NO, RETEST KEY YM                            
         BL    GN4                                                              
         BH    GN5B                                                             
         BE    GN4H                                                             
*                                                                               
GN4F     DS    0H                  DO DECADE TEST                               
*&&                                                                             
         GOTO1 GETBILL                                                          
         L     R7,ADBILL                                                        
         USING BILLREC,R7                                                       
         CLC   BDATE,INRSQDAT      TEST FULL BILL DATE                          
         BL    GN4                                                              
         B     GN5B                                                             
*                                                                               
GN4H     DS    0H                                                               
         CLC   INRSQDA,=C'01'      IF WITHIN MONTH MUST READ BILL               
         BE    GN5B                UNLESS START DATE IS 01                      
         CLC   KEY(13),BKEY        ALREADY HAVE BILL REC?                       
         BE    GN4J                                                             
         GOTO1 GETBILL                                                          
         L     R7,ADBILL                                                        
GN4J     DS    0H                                                               
         CLC   BDATE+4(2),INRSQDA  SKIP IF BEFORE RSQ DAY                       
         BL    GN4                                                              
         B     GN5B                                                             
*                                                                               
GN5      DS    0H                  NO SPECIAL SEQUENCING                        
         CLC   KEY+10(1),W              YM                                      
         BNE   GN4                                                              
*&&DO                                                                           
         CLI   PROFB1X+8,C'Y'      DO WE NEED DECADE TEST                       
         BNE   GN5B                FOR UNCLOSED-OUT 10 YEAR OLD BILLS?          
*&&                                                                             
         GOTO1 GETBILL                                                          
         L     R7,ADBILL                                                        
         CLC   BDATE(2),TODAY      COUNT ONLY THIS YEAR'S BILLS                 
         BNE   GN4                                                              
*                                                                               
GN5B     DS    0H                                                               
         L     RF,APATCH           TEST TO TRACE PASSING BILLS                  
         TM    0(RF),X'01'                                                      
         BZ    GN5F                NO                                           
         GOTO1 PRNTBL,DMCB,0,KEY,C'DUMP',18,=C'1D'                              
         DROP  R7                                                               
*                                                                               
GN5F     DS    0H                                                               
         CLC   HALF,KEY+11              INVOICE NO.                             
         BNL   GN4                                                              
         MVC   HALF,KEY+11                                                      
         B     GN4                                                              
*                                                                               
GN6      DS    0H                  END OF AGY/MED                               
         CLI   AGMSEQ,C'A'         TEST BY AGENCY                               
         BE    GN7                                                              
GN6D     CLI   AGMSEQ,C'D'         OR BY CLIENT ACROSS MEDIA                    
         BNE   GN20                                                             
GN7      DS    0H                  TRY NEXT MEDIA                               
         CLI   KEY,0               START OF BUYS                                
         BNE   GN20                                                             
         MVC   BYTE,KEY+1                                                       
         NI    BYTE,X'FF'-X'0F'                                                 
         CLC   BYTE,BAGYMD                                                      
         BH    GN20                END OF AGY                                   
         CLI   AGMSEQ,C'D'         IF BY CLIENT WITHIN MEDIA                    
         BE    *+14                YES                                          
         MVC   KEYSAVE,KEY         ELSE JUST CONTINUE                           
         B     GN4B                                                             
*                                                                               
*                                  BY CLIENT WITHIN MEDIA                       
         CLC   KEY+2(2),BCLT       IF HAVENT REACHED CLIENT                     
         BL    GN3D                TRY WITHIN THIS MEIDA                        
         TM    KEY+1,X'0F'         ELSE, BUMP TO NEXT MEDIA                     
         BO    GN20                                                             
         ZIC   RF,KEY+1                                                         
         AHI   RF,1                                                             
         STC   RF,KEY+1                                                         
         B     GN3D                                                             
*                                  HAVE HIGHEST NO.                             
GN20     DS    0H                                                               
         LH    RF,HALF                                                          
         AHI   RF,1                                                             
         STH   RF,0(R2)                                                         
         CLC   0(2,R2),AGMSTANO                                                 
         BNL   *+10                                                             
         MVC   0(2,R2),AGMSTANO                                                 
         B     GN23                                                             
*                                  BUMP TO NEXT NO.                             
GN22     DS    0H                                                               
         LH    RF,0(R2)                                                         
         AHI   RF,1                                                             
         STH   RF,0(R2)                                                         
*                                  CHECK INV. NO. AGAINST SKIP RANGES           
GN23     DS    0H                                                               
         LA    R4,AGMSKP1S                                                      
         OC    0(4,R4),0(R4)                                                    
         BZ    GN26                                                             
         CLC   0(2,R2),0(R4)                                                    
         BL    GN26                                                             
         CLC   0(2,R2),2(R4)                                                    
         BNL   GN26                                                             
         MVC   0(2,R2),2(R4)                                                    
         LH    RF,0(R2)                                                         
         AHI   RF,1                                                             
         STH   RF,0(R2)                                                         
*                                                                               
GN26     DS    0H                                                               
         CLC   0(2,R2),=H'9999'    NO BILL OVER 9999                            
         BNH   GN31                                                             
         CLI   PROFB1X+10,C'Y'     UNLESS ALLOW ALPHANUMERIC INVOICES           
         BNE   *+14                                                             
         CLC   0(2,R2),=H'16000'   THEN NO BILL OVER 16,000                     
         BNH   *+10                                                             
*                                                                               
         MVI   INV#ERR,C'Y'        REMEMBER THAT WE DIED HERE                   
         DC    H'0'                                                             
*                                                                               
*                                  FORMAT INVOICE NUMBER                        
GN31     DS    0H                                                               
*        NOTE- SPFMTINO REPLACES OLD INVOICE FORMATTING CODE                    
*                                                                               
         MVC   GNWORK,TODAYB       SET BY CALLER, NOT ALWAYS TODAY              
         NI    W,X'FF'-X'F0'       ISOLATE MONTH IN W                           
         MVC   GNWORK+1(1),W                                                    
         MVI   GNWORK+2,X'01'      DAY=01 FOR GOOD MEASURE                      
         GOTO1 DATCON,DMCB,(3,GNWORK),W                                         
*                                                                               
         GOTO1 =V(SPFMTINO),DMCB,W,(2,(R2)),(QMED,PROFB1),PROFB1X               
         L     RF,DMCB             A(FULL INVOICE NUMBER)                       
         MVC   0(10,R3),0(RF)                                                   
         L     RF,DMCB+4           A(INV NUMBER) MN-NNNN                        
         MVC   SVINVMO(2),0(RF)    DON'T NEED THE DASH                          
         MVC   SVINVMO+2(4),3(RF)                                               
         L     RF,DMCB+12                                                       
         MVC   SVINVMED,0(RF)      SAVE MEDIA                                   
*                                                                               
         NI    DMINBTS,X'FF'-X'08' NO LONGER PASS DELETES                       
         MVI   DMOUTBTS,X'FF'      NO DATAMGR ERRORS ARE ACCEPTABLE             
         MVC   RCTRACE,SAVTRACE                                                 
*                                                                               
         XIT1                                                                   
         SPACE 2                                                                
***********************************************************************         
*                                                                               
*        GNOFFSET - SET FOR OFFICE CHECKING                                     
*                                                                               
***********************************************************************         
         SPACE 2                                                                
GNOFFSET NTR1                                                                   
         XC    CLTPARS+8(4),CLTPARS+8    CLEAR CLIENT TABLE                     
         CLI   AGMOCTL,0           ANY OFFICE CHECKING                          
         BE    GNOSX               NO, DONE                                     
         XC    WK,WK               CLEAR LIST OF OFFICES                        
         LA    R4,DUB              MEDIA LIST                                   
*                                                                               
         MVC   DUB,BAGYMD          DO JUST THIS MEDIA                           
         MVI   DUB+1,X'FF'                                                      
         CLI   AGMSEQ,C'A'         IF NOT SEQUENCING BY AGENCY                  
         BNE   GNOS2                                                            
         MVC   DUB,GNMEDLST        ELSE DO ALL MEDIA                            
         LA    RF,L'GNMEDLST-1     BUILD LIST OF BAGYMD'S                       
         LA    R1,DUB                                                           
         MVC   BYTE,BAGYMD                                                      
         NI    BYTE,X'FF'-X'0F'    ISOLATE AGENCY                               
         OC    0(1,R1),BYTE                                                     
         LA    R1,1(R1)                                                         
         BCT   RF,*-10                                                          
*                                                                               
GNOS2    DS    0H                                                               
         LHI   R3,16               BCT COUNTER FOR OFFICE LIST                  
         CLI   AGMOCTL,C'*'        TEST OFFICE SEQUENCING                       
         BNE   GNOS4                                                            
         L     R2,ADCLT                                                         
         MVC   WK(1),COFFICE-CLTHDR(R2)  SET THIS OFFICE IN LIST                
         B     GNOS6                                                            
*                                                                               
GNOS4    XC    WK,WK                                                            
         XC    WORK,WORK                                                        
OFF      USING OFFICED,WORK                                                     
         MVI   OFF.OFCSYS,C'S'                NEED SYSTEM                       
         MVC   OFF.OFCAGY,AGY                 AGENCY                            
         L     R2,ADCLT                                                         
         MVC   OFF.OFCOFC,COFFICE-CLTHDR(R2)  ANY OFFICE                        
         MVC   OFF.OFCCLT,CKEYCLT-CLTHDR(R2)  AND THE CLIENT                    
         MVI   OFF.OFCLMT,C'$'                OFFICE LIST                       
         MVC   OFF.OFCLMT+1(1),AGMOCTL        OFFICE LIST CODE                  
         DROP  OFF                                                              
*                                                                               
         L     RF,ADCONLST                    CALL OFFICER AND ASK FOR          
         L     RF,VOFFICER-SPADCONS(RF)       OFFICE LIST BACK (X'D0')          
         GOTO1 (RF),DMCB,(C'2',WORK),(X'D0',ACOMFACS),WK                        
         LHI   R3,128              # OF POSSIBLE OFFICES IN THE LIST            
*                                                                               
GNOS6    DS    0H                  READ OFF/CLT PASSIVES FOR EACH OFF           
         LA    R2,WK               LIST OF OFFICES                              
         MVI   BYTE2,0             CLIENT OFFICE NOT YET SEEN IN LIST           
*                                                                               
GNOS8    DS    0H                                                               
         CLI   0(R2),0             NOT AN OFFICE                                
         BE    GNOS12                                                           
         CLI   0(R2),C'0'          NOT AN OFFICE                                
         BE    GNOS12                                                           
*                                                                               
         L     RF,ADCLT                                                         
         CLC   COFFICE-CLTHDR(,RF),0(R2) IS THIS THE CLIENT OFFICE?             
         BNE   *+8                                                              
         MVI   BYTE2,1             YES: IT'S IN THE LIST                        
*                                                                               
         XC    KEY,KEY                                                          
KEY@     USING CLTPHDR,KEY                                                      
         MVI   KEY@.CPKEYTYP,CPKEYTYQ   OFFICE/CLIENT PASSIVES                  
         MVI   KEY@.CPKEYSUB,CPKEYSBQ                                           
         MVC   KEY@.CPKEYAM,0(R4)       AGENCY/MEDIA                            
         MVC   KEY@.CPKEYOFF,0(R2)      OFFICE CODE                             
         GOTO1 HIGH                                                             
         B     GNOS10B                                                          
*                                                                               
GNOS10   DS    0H                                                               
         GOTO1 SEQ                                                              
GNOS10B  DS    0H                                                               
         CLC   KEY(10),KEYSAVE                                                  
         BNE   GNOS12                                                           
         MVC   FULL(1),KEY@.CPKEYAM     AGENCY/MEDIA                            
         MVC   FULL+1(2),KEY@.CPKEYCLT  CLIENT                                  
         GOTO1 BINSRCH,CLTPARS,(1,FULL)                                         
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                CLIENT TABLE FULL                            
         B     GNOS10              NEXT POINTER                                 
*                                                                               
GNOS12   DS    0H                                                               
         LA    R2,1(R2)            NEXT OFFICE                                  
         BCT   R3,GNOS8                                                         
*                                                                               
         CLI   BYTE2,1             IS CLIENT OFFICE IN OFFICE LIST?             
         BE    *+12                YES                                          
         MVI   ERR,OFFCERR         NO: INVALID PROFILE SETUP                    
         BRAS  RE,ERRPROC                                                       
*                                                                               
         LA    R4,1(R4)            NEXT MEDIA                                   
         CLI   0(R4),X'FF'                                                      
         BNE   GNOS2                                                            
         DROP  KEY@                                                             
*                                                                               
GNOSX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
GNMEDLST DC    XL6'0102030408FF'    MEDIA LIST                                  
         SPACE 2                                                                
         LTORG                                                                  
*                                                                               
         TITLE 'AGMPROC - HANDLE AGENCY/MEDIA PROFILE'                          
AGMPROC  NMOD1 0,AGMPROC                                                        
         LA    RC,SPACEND                                                       
*                                                                               
         XC    PROFB1X,PROFB1X     FIRST GET EXTENSION PROFILE                  
         XC    WORK,WORK                                                        
         LA    R5,WORK                                                          
         USING PROFKD,R5                                                        
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM,=C'B1X'                                                 
         MVC   PROFKAGN,AGY                                                     
         MVC   PROFKMED,MED                                                     
         MVC   PROFKCLI,PROFCLT                                                 
         L     R4,ADCLT                                                         
         USING CLTHDR,R4                                                        
         MVI   PROFKOI2,C'*'       SET OFFICE CODE                              
         MVC   PROFKOCD,COFFICE                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB1X,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,PROFB1X,WORK+16                               
*                                                                               
         XC    W,W                 GET SB1S PROF (SYSTEMS ONLY)                 
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM,=C'B1S'                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),W,DATAMGR,,WORK+16                     
         GOTOR PRNTPROF,DMCB,WORK,W,WORK+16                                     
         MVC   PROFB1S3,W+2                                                     
*                                                                               
******** CLI   PROFB1X+10,0           NOT USED ANYMORE                          
******** BNH   *+10                   REUSING THIS PROFILE                      
******** MVC   MAXLINES,PROFB1X+10    OVERRIDE OF MAXLINES?                     
*                                                                               
         MVC   AGMINBY,PROFB1X+4      SET INVOICE NUMBER BASE YEAR              
         XC    INRSQYM,INRSQYM        CLEAR INVOICE NO. RESEQUENCE DATE         
         XC    INRSQDA,INRSQDA                                                  
         OC    PROFB1X(3),PROFB1X                                               
         BZ    AGMP3                                                            
         GOTO1 DATCON,DMCB,(3,PROFB1X),INRSQDAT   FULL DATE                     
         GOTO1 DATCON,DMCB,INRSQDAT,INRSQDAT                                    
         GOTO1 DATCON,DMCB,INRSQDAT,(3,PROFB1X)                                 
         MVC   INRSQYM,PROFB1X                                                  
*                                                                               
         OC    INRSQYM,INRSQYM                                                  
         BZ    AGMP3                                                            
*                                                                               
         ZIC   R0,PROFB1X+2              DAY                                    
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  INRSQDA,DUB                                                      
*                                                                               
AGMP3    DS    0H                                                               
*                                  READ B1 PROFILE                              
         XC    WORK,WORK                                                        
         MVI   PROFKSYS,C'S'                                                    
         MVC   PROFKPGM,=C'OB1'                                                 
         MVC   PROFKAGN,AGY                                                     
         MVC   PROFKMED,MED                                                     
         MVC   PROFKCLI,PROFCLT                                                 
         MVI   PROFKOI2,C'*'       SET OFFICE CODE                              
         MVC   PROFKOCD,COFFICE                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB1,DATAMGR,,WORK+16                
         GOTOR PRNTPROF,DMCB,WORK,PROFB1,WORK+16                                
         MVC   W(16),PROFB1                                                     
         DROP  R5                                                               
*                                                                               
*                                  MEDIA EXP                                    
*                                  *=BLANK, **=USE MEDIA CODE                   
         CLI   W+2,C'*'                                                         
         BNE   *+8                                                              
         MVI   W+2,C' '                                                         
         CLI   W+3,C'*'                                                         
         BNE   *+8                                                              
         MVI   W+3,C' '                                                         
         CLC   W+2(2),SPACES                                                    
         BNE   *+10                                                             
         MVC   W+2(1),MED                                                       
*                                                                               
         MVC   AGMEXP,W+2          MEDIA EXP                                    
         MVC   AGMFMT,W+4          FORMAT                                       
         MVC   AGMSEQ,W+5          SEQ CONTROL                                  
         MVC   AGMOCTL,W+9         OFFICE CONTROL                               
         CLI   AGMOCTL,C'0'        ZERO IS NO OFFICE CHECK                      
         BNE   *+8                                                              
         MVI   AGMOCTL,0           SET 0 TO NULL                                
         CLI   AGMOCTL,C'*'        * IS OK                                      
         BE    AGMP3D                                                           
         CLI   AGMOCTL,C'A'        LOWER THAN A MAY BE LEFT                     
         BNL   *+8                 OVER FROM EARLIER USE                        
         MVI   AGMOCTL,0           SET TO NULL                                  
*                                                                               
AGMP3D   DS    0H                                                               
         MVC   AGMCLOPT,W+12       OPT FOR 1 CLT/PAGE ON REGISTER               
         MVC   AGMFORMS,W+13       PAPER TYPE (D=DDS)                           
         MVC   AGMCLNO,W+14        CLT INTERFACE NO. OPT                        
         MVC   AGMTITL,W+10                                                     
*                                  START NO. AND SKIPS                          
         LA    R2,W+6                                                           
         LA    R3,AGMSTANO                                                      
         LHI   R0,3                                                             
AGMP4    DS    0H                                                               
         ZIC   RF,0(R2)                                                         
         MHI   RF,100                                                           
         STH   RF,0(R3)                                                         
         LA    R2,1(R2)                                                         
         LA    R3,2(R3)                                                         
         BCT   R0,AGMP4                                                         
*                                                                               
         OC    AGMSTANO,AGMSTANO                                                
         BNZ   *+8                                                              
         MVI   AGMSTANO+1,1        START AT 1 NOT ZERO                          
         LH    RF,AGMSKP1E         ADJUST END OF RANGES                         
         LTR   RF,RF                                                            
         BZ    *+12                                                             
         AHI   RF,99                                                            
         STH   RF,AGMSKP1E                                                      
*                                                                               
*                                 TRY FOR SPECIAL BILLING FORM MODULE           
         L     R2,ABFMOD                                                        
         OC    2(4,R2),2(R2)      TEST ALREADY LOADED OR LOOKED FOR             
         BNZ   AGMP6              YES                                           
         MVC   2(4,R2),=X'FFFFFFFF'                                             
         MVC   DUB,=C'SPB1BF  '                                                 
         MVC   DUB+6(2),AGY                                                     
         MVC   DMCB+8(4),ABFMOD    SET P3 FOR MVS LOADER                        
         MVI   DMCB+8,C'M'                                                      
         GOTO1 LOADER,DMCB,DUB,ABFMOD                                           
         CLC   DMCB(4),=F'4096'                                                 
         BNH   *+6                                                              
         DC    H'0'                PHASE TOO BIG                                
AGMP6    DS    0H                                                               
*                                                                               
         XIT1                                                                   
         DROP  R4                                                               
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'SETDATE - READ PROFILES AND MASSAGE QSTART + QEND'              
SETDATE  NMOD1 0,SETDATE,R7                                                     
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   MODE,ESTFRST        IF AT ESTF (ONLY IF MOSOPT=E)                
         BE    SETD23              SKIP TO MED ROUTINE CALLS                    
*                                                                               
         XC    WORK,WORK           READ B2 PROFILE                              
         LA    R6,WORK                                                          
         USING PROFKD,R6                                                        
         MVI   PROFKSYS,C'S'                                                    
         MVC   PROFKPGM,=C'OB2'                                                 
         MVC   PROFKAGN,AGY                                                     
         MVC   PROFKMED,MED                                                     
         MVC   PROFKCLI,PROFCLT                                                 
         L     RF,ADCLT                                                         
         LA    RF,COFFICE-CLTHDR(RF)                                            
         MVI   PROFKOI2,C'*'       SET OFFICE CODE                              
         MVC   PROFKOCD,0(RF)                                                   
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB2,DATAMGR,,WORK+16                
         GOTOR PRNTPROF,DMCB,WORK,PROFB2,WORK+16                                
*                                                                               
*                                  READ TYPE PROF INTO PROFB4                   
         MVC   PROFKPGM+2(L'TYPE),TYPE                                          
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB4,DATAMGR,,WORK+16                
         GOTOR PRNTPROF,DMCB,WORK,PROFB4,WORK+16                                
         OC    PROFB4,PROFB4                                                    
         BNZ   SETD01                                                           
         MVI   ERR,TYPERR          NO PROFILE                                   
         BRAS  RE,ERRPROC          ERRPROC WILL SET TO                          
         B     SETDATEX            GO TO NEXT CLIENT                            
*                                  READ TYPE PROF EXT IN PROFB4A                
SETD01   DS    0H                                                               
         XC    PROFB4A,PROFB4A                                                  
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM,=C'B A'                                                 
         MVC   PROFKPGM+1(L'TYPE),TYPE                                          
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB4A,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,PROFB4A,WORK+16                               
*                                                                               
         MVC   PCTCTL,PROFB4A+0    PERCENTAGE BILLING CONTROL OPTION            
         CLI   PCTCTL,C' '                                                      
         BH    *+8                                                              
         MVI   PCTCTL,C'P'         DEFAULT IS TAKE % OF PREV                    
*                                                                               
         ZIC   R0,PROFB4A+6        BILL MINIMUM                                 
         MHI   R0,100              $ X 100                                      
         ZIC   R2,PROFB4A+7        PLUS CENTS                                   
         AR    R0,R2                                                            
         ST    R0,BILMIN           EQUALS MINIMUM AMOUNT                        
*                                                                               
         MVC   NOGRSWD,PROFB4A+15  OPTION TO SUPPRESS GROSS CLM HEAD            
*                                                                               
         CLI   PROFB4A+12,C'Y'     COMM FREE AMOUNT ON F-RATED BUYS             
         BNE   *+16                                                             
         CLI   QFRATE,C'F'         IS THIS F-RATE REQUEST ?                     
         BNE   *+8                                                              
         MVI   NOCOMOPT,C'Y'       YES, TURN THIS OPTION ON                     
*                                                                               
         MVI   CNETOPT,C'N'        NO CANADIAN NETWORK                          
         XC    CNETSTR2,CNETSTR2                                                
         CLI   QMED,C'N'           UNLESS MEDIA = N                             
         BNE   SETD02                                                           
         MVC   CNETOPT,PROFB4A+1    2ND CANADIAN NET FEATURE                    
         MVC   CNETSTR2,PROFB4A+2   START MOS                                   
*                                                                               
         MVC   FULL(2),CNETSTR2    Y2K STUFF                                    
         MVI   FULL+2,1                                                         
         LR    R4,RF               SAVE RF                                      
         GOTO1 DATCON,DMCB,(3,FULL),(0,DUB)                                     
         GOTO1 DATCON,DMCB,(0,DUB),(3,FULL)                                     
         LR    RF,R4               RESTORE RF                                   
         MVC   CNETSTR2,FULL                                                    
*                                                                               
         CLI   CNETOPT,C'A'                                                     
         BNL   *+8                                                              
         MVI   CNETOPT,C'N'        N IS DEFAULT                                 
*                                                                               
SETD02   DS    0H                                                               
         CLI   PROFB2+9,C'0'                                                    
         BNE   *+8                                                              
         MVI   PROFB2+9,0                                                       
         CLI   QMED,C'N'                                                        
         BNE   SETD04                                                           
         CLI   NETOPT,C'O'                                                      
         BE    SETD04                                                           
         CLI   PROFB2+9,0          IF T/I = 0, IGNORE BN PROF                   
         BE    SETD04                                                           
         MVI   PROFKSYS,C'S'       TRY FOR NETWORK PROFILE                      
         MVC   PROFKPGM,=C'OBN'                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),X,DATAMGR,,WORK+16                     
         GOTOR PRNTPROF,DMCB,WORK,X,WORK+16                                     
         MVC   PROFBN,X            MOVE FIRST 3 FIELDS                          
*                                                                               
*                                                                               
SETD04   DS    0H                                                               
         MVI   DATEOPT,C'N'                                                     
         MVI   DOLSOPT,C'N'                                                     
         MVI   BILLADR,C'N'                                                     
         MVI   EPUDEF,C'N'                                                      
         MVI   CREDPRN,C'N'                                                     
         MVI   PROFKSYS,C'S'       B8 PROF                                      
         MVC   PROFKPGM,=C'OB8'                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),X,DATAMGR,,WORK+16                     
         GOTOR PRNTPROF,DMCB,WORK,X,WORK+16                                     
         OC    X(16),X             TEST ANY PROFILE                             
         BZ    SETD05              NO                                           
         MVC   DATEOPT,X                                                        
         MVC   DOLSOPT,X+1                                                      
         MVC   BILLADR,X+2         READ BILLADR REC FOR EXTENDED ADDR           
         MVC   EPUDEF,X+4          EST/PRD UDEFS ON CONSOLIDATED BILL           
         MVC   CREDPRN,X+5         PRINT CREDIT AMOUNT IN PARENTHESIS           
*                                                                               
** CODE FOR EPUDEF                                                              
         CLI   EPUDEF,C'N'                                                      
         BE    SETD05                                                           
         CLI   EPUDEF,0           IS THE OPTION ON?                             
         BE    SETD05              NO                                           
         MVI   BYTE2,0                                                          
         CLI   PROFB4+1,C'T'      PRODUCTS TOGETHER?                            
         BNE   *+8                                                              
         OI    BYTE2,PUDEFON                                                    
*                                                                               
         CLI   PROFB4+2,C'T'      ESTIMATES TOGETHER?                           
         BNE   *+8                                                              
         OI    BYTE2,EUDEFON                                                    
*                                                                               
         CLI   EPUDEF,C'Y'        BOTH PRODS AND EST                            
         BNE   SETD4K                                                           
         TM    BYTE2,PUDEFON+EUDEFON   TEST BOTH FLAGS ON                       
         BO    SETD05                  YES, KEEP EPUDEF AS 'Y'                  
         BZ    SETD4NO                 NO, SET TO 'N'                           
         MVI   EPUDEF,C'P'                                                      
         TM    BYTE2,PUDEFON                                                    
         BO    SETD05                                                           
         MVI   EPUDEF,C'E'                                                      
         B     SETD05                                                           
*                                                                               
SETD4K   CLI   EPUDEF,C'E'        EST ?                                         
         BNE   SETD4M                                                           
         TM    BYTE2,EUDEFON                                                    
         BO    SETD05           YES, KEEP ON                                    
         B     SETD4NO                NO, SET TO 'N'                            
*                                                                               
SETD4M   CLI   EPUDEF,C'P'        PROD?                                         
         BE    *+6                                                              
         DC    H'0'            SHOULD NOT HAPPEN                                
*                                                                               
         TM    BYTE2,PUDEFON                                                    
         BO    SETD05           YES, KEEP ON                                    
*                                                                               
SETD4NO  MVI   EPUDEF,C'N'     TURN OFF THE FLAG                                
*                                                                               
SETD05   MVI   PROFKSYS,C'S'       READ B3 PROF FOR DATE CONTROLS               
         MVC   PROFKPGM,=C'OB3'                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),X,DATAMGR,,WORK+16                     
         GOTOR PRNTPROF,DMCB,WORK,X,WORK+16                                     
         OC    X(16),X             TEST ANY PROFILE                             
         BZ    *+16                NO                                           
         MVC   SPOTPROF+2(1),X     REPLACE CALENDAR VALUES                      
         MVC   SPOTPROF+6(3),X+1                                                
*                                  TRY FOR RETAIL PROFILE - B9                  
         MVI   SUMOPT,C'N'                                                      
         MVI   FCGETSTA,C'N'       DONT GET STATIONS IF NOT RETAIL              
         XC    RETPROF,RETPROF                                                  
*                                                                               
         MVI   PROFKSYS,C'S'                                                    
         MVC   PROFKPGM,=C'OB9'                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),RETPROF,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,RETPROF,WORK+16                               
*                                                                               
         CLI   RETPROF+13,C'Y'     FOR BACKER STATION SPECIAL                   
         BNE   *+8                                                              
         MVI   FCGETSTA,C'Y'       NEED STATIONS                                
*                                                                               
         MVC   PBLOPT,RETPROF+9    PARTIAL BILLING OPTION                       
         CLI   PBLOPT,C'Y'                                                      
         BE    *+8                                                              
         MVI   PBLOPT,C'N'                                                      
*                                                                               
         CLI   NONRET,C'Y'         SUPPRESS RETAIL                              
         BNE   *+12                                                             
         MVI   RETPROF,0                                                        
         MVI   PBLOPT,C'N'         NO PARTIAL BILLING                           
         CLI   RETPROF,0                                                        
         BE    SETD06                                                           
         MVC   SUMOPT,RETPROF+6    CORP SUMMARY                                 
         CLI   RETDRAFT,C'Y'       FOR DRAFT                                    
         BNE   *+12                                                             
         MVI   SUMOPT,C'N'         NO SUMMARY                                   
         MVI   RETPROF+11,C'Y'     ACTIVATE PCT PRINT                           
*                                                                               
*                                  SET UP GDAREA FOR FINDOUT                    
*                                                                               
         XC    WORK,WORK           FIRST FIND ANY B9A PROFILE                   
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM,=C'B9A'                                                 
         MVC   PROFKAGN,AGY                                                     
         MVC   PROFKMED,MED                                                     
         MVC   PROFKCLI,PROFCLT                                                 
         L     RF,ADCLT                                                         
         LA    RF,COFFICE-CLTHDR(RF)                                            
         MVI   PROFKOI2,C'*'       SET OFFICE CODE                              
         MVC   PROFKOCD,0(RF)                                                   
         GOTO1 GETPROF,DMCB,(X'A0',WORK),X,DATAMGR,,WORK+16                     
         GOTOR PRNTPROF,DMCB,WORK,X,WORK+16                                     
         MVC   ACCSYSOV,X+8        SAVE ACC SYS OVERRIDE                        
         L     R4,AGDAREA                                                       
         USING GDSECT,R4                                                        
*                                                                               
         LA    R0,GDSECT           CLEAR GDAREA                                 
         LHI   R1,GDSECTL                                                       
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         XC    PESPARS+8(4),PESPARS+8    PRD/EST/SCH TAB (PRTL BILLG)           
         LA    R1,PERLIST                                                       
         ST    R1,GDAPERL          A(PERLIST)                                   
         MVC   GDCOMP,RETPROF      COMPANY                                      
         MVC   GDUNIT,RETPROF+1    UNIT                                         
         MVC   GDLEDG,RETPROF+2    LEDGER                                       
         MVC   GDMED,QMED          SET MEDIA CODE                               
         MVC   GDMGRLEN,RETPROF+3                                               
         CLI   RETPROF+14,C'*'     TEST PSEUDO MGR (ACCT PREFIX)                
         BNH   *+8                                                              
         MVI   GDMGRLEN,1                                                       
         MVI   GDMKTLEN,0                                                       
         CLI   RETPROF+4,C'Y'                                                   
         BNE   *+8                                                              
         MVI   GDMKTLEN,4                                                       
         MVC   GDOUTLEN,RETPROF+5                                               
*                                                                               
         MVC   GDACOMS,ACOMFACS                                                 
         MVC   GDAUTL,UTL                                                       
         MVC   GDACCSYS,ACCTSE                                                  
         CLI   ACCSYSOV,0          IF NAY ACC SYS OVERRIDE                      
         BE    *+10                                                             
         MVC   GDACCSYS,ACCSYSOV   USE IT                                       
         MVC   GDATABS,AFOTABS                                                  
         MVI   GDOUTNO,0                                                        
         DROP  R4                                                               
         CLI   ACCTSE,0            MUST HAVE VALID ACCOUNT SE                   
         BNE   SETD06                                                           
         MVI   ERR,IDERR                                                        
         BRAS  RE,ERRPROC                                                       
         B     SETDATEX                                                         
*                                                                               
SETD06   DS    0H                                                               
         XC    WORK,WORK           DAR PROFILE                                  
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM,=C'DAR'                                                 
         MVC   PROFKAGN,AGY                                                     
         MVC   PROFKMED,MED                                                     
         MVC   PROFKCLI,PROFCLT                                                 
         L     RF,ADCLT                                                         
         LA    RF,COFFICE-CLTHDR(RF)                                            
         MVI   PROFKOI2,C'*'       SET OFFICE CODE                              
         MVC   PROFKOCD,0(RF)                                                   
         GOTO1 GETPROF,DMCB,(X'A0',WORK),X,DATAMGR,,WORK+16                     
         GOTOR PRNTPROF,DMCB,WORK,X,WORK+16                                     
         MVC   DARREP,X+6                                                       
*                                                                               
         L     R4,=A(VATACCS)      VAT ACCOUNT TABLE                            
         SR    R5,R5                                                            
         MVI   PROFKSYS,C'S'                                                    
         MVC   PROFKPGM,=C'0VA'                                                 
*                                                                               
SETD08   DS    0H                                                               
         GOTO1 GETPROF,DMCB,(X'A0',WORK),X,DATAMGR,,WORK+16                     
         GOTOR PRNTPROF,DMCB,WORK,X,WORK+16                                     
         BAS   RE,FIXVACC          *'S TO SPACES                                
         MVC   0(16,R4),X                                                       
         LA    R5,1(R5)                                                         
         CHI   R5,NPROVS                                                        
         BH    SETD010                                                          
         LA    R4,16(R4)                                                        
         MVI   PROFKPGM+2,C'A'     MUST USE A (NOT 10) FOR NEWF                 
         CHI   R5,10                                                            
         BE    *+12                                                             
         LA    RF,X'F0'(R5)                                                     
         STC   RF,PROFKPGM+2       PROVINCE NUMBER                              
*                                                                               
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM(2),=C'VA'                                               
         B     SETD08                                                           
*                                                                               
SETD010  DS    0H                                                               
         XC    PROFB1X,PROFB1X     GET SB1X PROFILE                             
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM,=C'B1X'                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB1X,DATAMGR,,WORK+16               
*                                                                               
         OC    PROFB1X+14(2),PROFB1X+14                                         
         BZ    SETD012                                                          
         MVC   FULL(2),PROFB1X+14  Y2K STUFF FOR INVNO YM                       
         MVI   FULL+2,1                                                         
         GOTO1 DATCON,DMCB,(3,FULL),(0,DUB)                                     
         GOTO1 DATCON,DMCB,(0,DUB),(3,FULL)                                     
         MVC   PROFB1X+14(2),FULL                                               
*                                                                               
SETD012  DS    0H                                                               
         XC    PROFB1A,PROFB1A     GET SB1A PROF                                
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM,=C'B1A'                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB1A,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,PROFB1A,WORK+16                               
*                                                                               
         XC    PROFB2A,PROFB2A     GET B2 EXT PROF (AOR)                        
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM,=C'B2A'                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB2A,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,PROFB2A,WORK+16                               
         MVI   AORLOPT,C'N'                                                     
         MVC   AORSW,PROFB2A+0     NB- ALSO SET FROM B2PROFILE                  
         CLI   RETPROF,0           TEST RETAIL                                  
         BE    *+8                                                              
         MVI   AORSW,C'N'          NO AOR FOR RETAIL                            
*                                                                               
         CLI   AORSW,C'Y'                                                       
         BNE   *+10                                                             
         MVC   AORLOPT,PROFB2A+1   AOR LIST OPTION                              
*                                                                               
         CLI   AORLOPT,C' '                                                     
         BH    *+8                                                              
         MVI   AORLOPT,C'N'                                                     
*                                                                               
         MVC   AORTXOPT,PROFB2A+3   AOR TAX OPTION                              
         CLI   AORTXOPT,C' '                                                    
         BH    *+8                                                              
         MVI   AORTXOPT,C'Y'                                                    
*                                                                               
         MVC   AORNOPT,PROFB2A+7    SHOW NET WHEN LISTING                       
         CLI   AORNOPT,C' '                                                     
         BH    *+8                                                              
         MVI   AORNOPT,C'N'             DEFAULT TO N                            
*                                                                               
         XC    PROFB2B,PROFB2B     GET B2 EXT PROF (B2B)                        
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM,=C'B2B'                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB2B,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,PROFB2B,WORK+16                               
*                                                                               
         CLI   PROFB2B+5,C'%'      OVERRIDING  MGROUP?                          
         BNH   SETD016             NO, DONE                                     
         CLI   PROFB2B+6,C'%'                                                   
         BNH   SETD016                                                          
*                                                                               
         LARL  RF,SPMGRTAB                                                      
         LHI   RE,(SPMGRTBX-SPMGRTAB)/L'SPMGRTAB                                
         CLC   PROFB2B+5(2),0(RF)                                               
         BE    SETD014                                                          
         AHI   RF,L'SPMGRTAB                                                    
         BCT   RE,*-14                                                          
*                                                                               
         MVI   ERR,MGRERR                                                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
SETD014  MVC   PROFB2+2(1),2(RF)                                                
*                                                                               
*                                                                               
SETD016  MVC   SCBOPT,PROFB2B+0    'TRUE' (SCB) SEP COMMISSION OPT              
         MVI   SCBNCSW,0                                                        
         CLI   SCBOPT,C'Y'         IF ON                                        
         BNE   SETD25B4                                                         
         MVC   SCBNCSW,QOPT5+1                                                  
         CLI   QOPT5+1,C'C'        MUST HAVE BILL TYPE (C=COMM)                 
         BE    SETD25B4                                                         
         CLI   QOPT5+1,C'N'        (N=NET)                                      
         BE    SETD25B4                                                         
         CLI   QOPT5+1,C'R'        (R=REGULAR, NO SEP COMM)                     
         BE    SETD25B4                                                         
*                                                                               
         MVI   ERR,SCBERR                                                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
SETD25B4 DS    0H                                                               
         XC    PROFB2C,PROFB2C     GET B2 EXT PROF (CURRENCY)                   
         MVI   PROFKSYS,C'S'-X'40' LOWER-CASE 'S'                               
         MVC   PROFKPGM,=C'B2C'                                                 
         GOTO1 GETPROF,DMCB,(X'A0',WORK),PROFB2C,DATAMGR,,WORK+16               
         GOTOR PRNTPROF,DMCB,WORK,PROFB2C,WORK+16                               
         DROP  R6                                                               
*                                                                               
         MVC   CCSTRT,PROFB2C+0    START YM FOR CLT CURRENCY                    
         MVC   CCIDOPT,PROFB2C+2    IDENTIFY CURRENCY?                          
         MVC   CCDETOPT,PROFB2C+3   BOTH CURRENCY DETAIL?                       
         MVC   CCTOTOPT,PROFB2C+4   BOTH CURRENCY TOTALS?                       
*                                                                               
         MVC   XPEROPT,PROFB1X+7   CROSS PERIOD BILLING OPTION                  
*                                                                               
         MVC   BFROPT,PROFB1X+11   OPTION TO READ NEW FORMULA RECS              
         CLI   BFROPT,C' '                                                      
         BH    *+8                                                              
         MVI   BFROPT,C'N'                                                      
*                                                                               
         MVC   BFRMOS,PROFB1X+12   MOS OPTION FOR NEW FORMULA RECS              
         CLI   BFRMOS,C' '                                                      
         BH    *+8                                                              
         MVI   BFRMOS,C'N'                                                      
*                                                                               
         MVC   MCOMOPT,PROFB1A+0   MARKET COMMENT OPTION                        
         CLI   MCOMOPT,0                                                        
         BNE   *+8                                                              
         MVI   MCOMOPT,C'N'                                                     
         MVC   ECOMOPT,PROFB1A+1   ESTIMATE COMMENT OPTION                      
         CLI   ECOMOPT,0                                                        
         BNE   *+8                                                              
         MVI   ECOMOPT,C'N'                                                     
         MVC   AFFOPT,PROFB1A+2    STATION AFFIL OPT                            
         MVC   SPLITOPT,PROFB1X+5 PRODUCT SPLIT OPTION                          
         CLI   SPLITOPT,C'Y'       FOR SPLIT PRDS                               
         BNE   SETD25C                                                          
         CLC   =C'ALL',QPRD        QPRD MUST BE ALL                             
         BE    SETD25C                                                          
         MVI   ERR,SPLTERR       SPLIT PRD REQ ERR                              
         BRAS  RE,ERRPROC                                                       
*                                                                               
SETD25C  DS    0H                                                               
*                                  INVOICE DATE                                 
         LA    R4,QINVDATE         FROM 2ND REQ CARD                            
         CLI   QINVDATE,C' '                                                    
         BH    *+8                                                              
         LA    R4,TODAY            ELSE USE TODAY                               
*                                                                               
         MVC   EINVDTE,0(R4)                                                    
         GOTO1 DATCON,DMCB,(R4),(5,PINVDTE)                                     
         GOTO1 DATCON,DMCB,(R4),(3,BINVDTE)                                     
         GOTO1 DATCON,DMCB,(R4),(2,BINVDTEP)                                    
         CLI   DATEOPT,C'Y'        SEE IF SHOWING CENTURY                       
         BNE   SETD25D                                                          
         GOTO1 DATCON,DMCB,(R4),(20,WORK)                                       
         MVC   PINVDTE+6(4),WORK   MMMDD/YYYY                                   
*                                  DUE DATE CALC                                
SETD25D  CLI   PROFB2,101          SPECIAL LCI FEATURE?                         
         BNE   SETD25P                                                          
         MVC   BDUEDTE,BINVDTE     PUT INVOICE DATE TO MODIFY                   
         MVI   BDUEDTE+2,2         DATE IS ALWAYS 2ND OF THE MONTH              
         ZIC   R0,BDUEDTE+1        GET MONTH                                    
         AHI   R0,2                ADD 2 MONTHS                                 
         CHI   R0,12                                                            
         BNH   SETD25F                                                          
         AHI   R0,-12                                                           
         ZIC   R1,BDUEDTE          INCREMENT YEAR                               
         AHI   R1,1                                                             
         STC   R1,BDUEDTE                                                       
SETD25F  STC   R0,BDUEDTE+1                                                     
         GOTO1 DATCON,DMCB,(3,BDUEDTE),EDUEDTE                                  
         B     SETD25S                                                          
*                                                                               
SETD25P  CLI   QDUEDAYS,C' '                                                    
         BNH   SETD26                                                           
         PACK  DUB,QDUEDAYS                                                     
         CVB   R0,DUB                                                           
         STC   R0,BYTE                                                          
         B     SETD28                                                           
*                                                                               
SETD26   DS    0H                                                               
         MVC   BYTE,PROFB2                                                      
SETD28   DS    0H                                                               
         MVC   PDUEDTE,SPACES                                                   
         MVC   EDUEDTE,SPACES                                                   
         XC    BDUEDTE,BDUEDTE                                                  
         XC    BDUEDTEP,BDUEDTEP                                                
         MVC   PSHPDTE,SPACES                                                   
         CLI   BYTE,0                                                           
         BE    SETD30          IF NO DUE DATE, NO SHIP DATE                     
         ZIC   R0,BYTE                                                          
         GOTO1 ADDAY,DMCB,EINVDTE,EDUEDTE,(R0)                                  
         GOTO1 DATCON,DMCB,EDUEDTE,(3,BDUEDTE)                                  
SETD25S  GOTO1 DATCON,DMCB,EDUEDTE,(5,PDUEDTE)                                  
         GOTO1 DATCON,DMCB,EDUEDTE,(2,BDUEDTEP)                                 
         CLI   DATEOPT,C'Y'        SEE IF SHOWING CENTURY                       
         BNE   SETD29                                                           
         GOTO1 DATCON,DMCB,EDUEDTE,(20,WORK)                                    
         MVC   PDUEDTE+6(4),WORK   MMMDD/YYYY                                   
*                                                                               
SETD29   MVC   BYTE,PROFB2B+3      SHIPPING DATE CONTROL                        
         CLI   BYTE,0                                                           
         BE    SETD30                                                           
         ZIC   R0,BYTE                                                          
         LCR   R0,R0               BACK UP N DAYS                               
         GOTO1 ADDAY,DMCB,EDUEDTE,WORK,(R0)                                     
         GOTO1 DATCON,DMCB,WORK,(5,PSHPDTE)                                     
*                                                                               
SETD30   DS    0H                                                               
         CLI   PROFB2+8,C'4'                                                    
         BL    SETD30A                                                          
         CLC   TYPE,PROFB2+8       TEST VALID BILLING TYPE                      
         BNH   SETD30A                                                          
         MVI   ERR,TYPERR                                                       
         BRAS  RE,ERRPROC          ERRPROC WILL SET TO                          
         B     SETDATEX            GO TO NEXT CLIENT                            
*                                                                               
SETD30A  DS    0H                                                               
         MVC   TESTFLAG,PROFB2+7   USE TEST OPT ONLY IF NOT SET IN REQ          
         CLI   RETDRAFT,C'Y'       RETAIL DRAFT IS ALWAYS TEST                  
         BNE   *+8                                                              
         MVI   TESTFLAG,C'T'                                                    
         CLI   PROOFSW,C'Y'        SO IS PROOF BILLING                          
         BNE   *+8                                                              
         MVI   TESTFLAG,C'T'                                                    
         CLI   QB2OVRD,C' '        OVERRIDING ADJSEP?                           
         BNH   *+10                                                             
         MVC   PROFB2+3(1),QB2OVRD                                              
         MVC   ADJSEP,PROFB2+3                                                  
         CLI   RETPROF,0           TEST RETAIL                                  
         BE    *+8                                                              
         MVI   ADJSEP,C'N'         NO ADJ SEP FOR RETAIL                        
*                                                                               
         CLI   ADJSEP,C'Y'         SEP ADJ INV                                  
         BNE   SETD30A4                                                         
         CLI   AORLOPT,C'C'        INCOMPATIBLE WITH AOR                        
         BNE   SETD30A4            'CLIENT LIST' MODE                           
         MVI   ERR,AORPERR         **??  GPLA: IS THIS NECESSARY ?? **          
         BRAS  RE,ERRPROC                                                       
*                                                                               
SETD30A4 DS    0H                                                               
         CLI   PROFB2+3,C'A'       NB- ALSO SET FROM AOR PROFILE                
         BNE   *+8                                                              
         MVI   AORSW,C'Y'          AOR CLIENT                                   
*                                                                               
         MVI   STRIPOPT,C'Y'       SET TO DO STRIP COLUMN                       
         CLI   RETDRAFT,C'Y'       BUT IF RETAIL DRAFT                          
         BNE   *+14                                                             
         MVC   STRIPOPT,PROFB4+15  SET FROM BD PROF                             
         B     *+16                                                             
         CLI   PROFB4A+8,C'N'      ELSE Y OR N FROM B4-7A PROFILE               
         BNE   *+8                                                              
         MVI   STRIPOPT,C'N'                                                    
*                                                                               
         MVC   BOXNO,PROFB2+4                                                   
         MVC   PAYOPT,PROFB4+10                                                 
         CLI   PAYOPT,0                                                         
         BNE   *+8                                                              
         MVI   PAYOPT,C'N'                                                      
         MVC   TAXOPT,PROFB2+12                                                 
         CLI   TAXOPT,0                                                         
         BNE   *+8                                                              
         MVI   TAXOPT,C'N'                                                      
         CLI   QTRADE,C'T'         DOING TRADE REQUEST?                         
         BNE   *+8                                                              
         MVI   TAXOPT,C'N'         NO TAX!                                      
         MVC   STACMOPT,PROFB2+13  STATION COMMENT OPT                          
*                                                                               
***      CLI   QPRIORMD,C'T'       PRIOR MONTHS SPECIFIED IN REQUEST?           
***      BNE   SETD30A9            NO, CHECK B4 PROFILE                         
         CLI   QPRIORMD,C' '       PRIOR MONTHS SPECIFIED IN REQUEST?           
         BNH   SETD30A9            NO, CHECK B4 PROFILE                         
         PACK  DUB,QPRIORMO        GET NUMBER OF PRIOR MONTHS...                
         CVB   R0,DUB                                                           
         STC   R0,PRIOR                                                         
         OI    PRIOR,X'C0'         PRIOR = X'C4'..X'CB'                         
         CLI   QPRIORMD,C'T'       PRIOR MONTHS TOGETHER ?                      
         BE    SETD30B                                                          
         OI    PRIOR,X'F0'         ELSE MAKE THEM 1,2,3... (SEPARATE)           
         B     SETD30B                                                          
*                                                                               
SETD30A9 DS    0H                                                               
         MVC   PRIOR,PROFB4+9                                                   
         CLC   =C'NO PRIOR',QMANUAL                                             
         BNE   *+8                                                              
         MVI   PRIOR,C'N'                                                       
         CLI   MOSOPT,C'E'         NO PRIOR IF SPECIAL MOS REQUEST              
         BNE   *+8                                                              
         MVI   PRIOR,C'N'                                                       
         MVI   NMOS,1              NO PRIOR MONTHS                              
         CLI   PRIOR,C'N'                                                       
         BE    SETD31                                                           
         MVI   NMOS,X'0D'          13 MONTHS BY DEFAULT                         
         CLI   RETDRAFT,C'Y'       DIFFERENT FOR RETAIL DRAFT                   
         BNE   *+8                                                              
         MVI   NMOS,RDMAXMOS                                                    
         CLI   PRIOR,C'C'          A-C = 1-3 PRIOR MOS SEPARATE                 
         BNH   SETD30B                                                          
         CLI   PRIOR,C'1'          AND 1-3 = 1-3 PRIORS TOGETHER                
         BNL   SETD30B                                                          
         CLI   PRIOR,C'U'          IF U,V OR W -> 25 MONTHS                     
         BL    SETD31                                                           
         MVI   NMOS,MAXMOS                                                      
         B     SETD31                                                           
SETD30B  DS    0H                                                               
         ZIC   RF,PRIOR                                                         
         AHI   RF,1                                                             
         STC   RF,NMOS                                                          
         NI    NMOS,X'FF'-X'F0'                                                 
*                                                                               
SETD31   DS    0H                                                               
         CLI   QRETCD,C' '     FOR SPECIAL RETAIL CREDIT/DEBIT                  
         BNH   *+8             DO EACH MONTH SEPARATE DESPITE PROFILE           
         MVI   NMOS,1          (BEST TO HAVE CONTROL AT MONTH LEVEL)            
*                                                                               
         CLI   BFRMOS,C'Y'      IF MOS ALLOWED ON NEW BILL FORMULA RECS         
         BNE   SETD31A9                                                         
         CLI   PRIOR,C'S'       THEN MUST HAVE SEP BILLS PER MOS                
         BE    SETD31A9                                                         
         CLI   PRIOR,C'U'                                                       
         BE    SETD31A9                                                         
         CLI   PRIOR,C'N'                                                       
         BE    SETD31A9                                                         
         CLI   PRIOR,C'1'       CHECK FOR 1 - 3 ...                             
         BL    *+12                                                             
         CLI   PRIOR,C'3'       ... NOTHING ELSE IS ALLOWED                     
         BNH   SETD31A9                                                         
         MVI   ERR,MOSERR                                                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
SETD31A9 DS    0H                                                               
         MVC   ZBOPT,PROFB2+5      ZERO BILL OPTION                             
         CLI   PROFB2+9,0          IF NETPAK SET IN PROFILE                     
         BE    *+16                                                             
         CLI   QMED,C'N'           AND NETWORK REQ                              
         BNE   *+8                                                              
         MVI   ZBOPT,C'N'          NO-OP ZERO BILL OPTION                       
*                                                                               
         MVC   ZLOPT,PROFB2+10     ZERO LINE OPTION                             
         CLI   RETDRAFT,C'Y'       FOR RETAIL DRAFT                             
         BNE   *+8                                                              
         MVI   ZLOPT,C'0'          NO SL SUPPRESS                               
         MVC   ORIGTYPE,PROFB2+6   TYPE NOT TO MARK DETAILS                     
         OC    MANGRS,MANGRS                                                    
         BZ    *+12                                                             
         MVI   NMOS,1                                                           
         MVI   PRIOR,C'N'          NO PRIOR IF MANUAL                           
         CLI   PROFB2+1,C'*'       DONT CHECK PGR                               
         BE    SETD32                                                           
         CLI   PROFB4+0,C'N'       PGRS NOT USED FOR THIS TYPE                  
         BE    SETD32                                                           
         CLI   QPGR,C' '           IF NO REQ PGR                                
         BH    *+10                                                             
         MVC   QPGR,PROFB2+1       SET FROM PROFILE                             
         CLC   QPGR,PROFB2+1                                                    
         BE    SETD32                                                           
         MVI   ERR,PGRERR                                                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
SETD32   DS    0H                                                               
*                                  SET MGR BUCKETS OPT                          
         MVI   MGRBKTS,C'N'                                                     
         CLI   PROFB1X+3,0                                                      
         BE    SETD32A                                                          
         CLI   PROFB1X+3,C'*'                                                   
         BE    SETD32A                                                          
         MVI   MGRBKTS,C'Y'                                                     
         CLC   PROFB2+2(1),PROFB1X+3       PROFS MUST AGREE                     
         BNE   SETD32C                                                          
         B     SETD32B                                                          
SETD32A  DS    0H                                                               
         CLI   PROFB2+2,C'*'       DONT CHECK MGR                               
         BE    SETD34                                                           
         CLI   PROFB4+3,C'N'       MGRS NOT USED FOR THIS TYPE                  
         BE    SETD34                                                           
SETD32B  DS    0H                                                               
         CLI   QMGR,C' '           ANY REQ MGR?                                 
         BH    *+10                                                             
         MVC   QMGR,PROFB2+2       NO, SET FROM PROFILE                         
         CLC   QMGR,PROFB2+2                                                    
         BNE   SETD32C             ERROR                                        
         MVC   WK(L'KEY),KEY       SAVE KEY JUST IN CASE                        
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0D02'                                                  
         MVC   KEY+2(1),SVAGYMD                                                 
         CLI   QMGR,C'F'           TEST ID A-F                                  
         BH    *+10                                                             
         MVC   KEY+3(2),SVCLT      A-F REQUIRE CLT                              
         MVC   KEY+8(1),QMGR       MKTGRP ID                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   SETD32C             ERROR, MGR DOESN'T EXIST                     
         MVC   KEY,WK              RESTORE KEY                                  
         B     SETD34                                                           
*                                                                               
SETD32C  DS    0H                                                               
         MVI   ERR,MGRERR                                                       
         BRAS  RE,ERRPROC                                                       
*                                                                               
SETD34   DS    0H                                                               
*                                  SET CANADIAN NETWORK OPT                     
         XC    CNETSTRT,CNETSTRT                                                
         CLI   QMED,C'N'           MUST BE NET                                  
         BNE   SETD34D                                                          
         L     RF,ADAGY                                                         
         CLI   AGYPROF+7-AGYHDR(RF),C'C'    MUST BE CANADA                      
         BNE   SETD34D                                                          
*                                                                               
*        NOTE- THIS SETTING OF AN EFFECTIVE DATE FOR THE FIRST                  
*              CANADIAN NETWORK OPT IS PRETTY MUCH IRRELEVANT.                  
*              NO ONE SEEMS TO USE THE PROFILE BYTE. NOTE THAT                  
*              1988 AND 1989 CANNOT BE SPECIFIED.                               
*                                                                               
*                                  CHANGE X'YM' TO X'YYMM'                      
         MVC   BYTE,PROFB2+11                                                   
         CLI   BYTE,0                                                           
         BE    SETD34D                                                          
         NI    BYTE,X'FF'-X'0F'                                                 
         ZIC   RE,BYTE                                                          
         SRL   RE,4                                                             
         LA    RE,80(RE)                                                        
         CLI   BYTE,X'80'          1-7 = 81-87                                  
         BL    *+16                                                             
         CLI   BYTE,X'A0'          A-F = 90-95                                  
         BNL   *+8                                                              
         SHI   RE,10               8-9 = 78-79                                  
*                                                                               
         STC   RE,CNETSTRT                                                      
*                                                                               
         MVC   CNETSTRT+1(1),PROFB2+11                                          
         NI    CNETSTRT+1,X'FF'-X'F0'                                           
         B     SETD34F                                                          
*                                                                               
SETD34D  DS    0H                  IF NO CNETSTRT ACTIVATE 2ND                  
*                                  CANNET FEATURE, WHICH IS PRETTY MUCH         
*                                  THE SAME AS PRE 1ST FEATURE                  
         CLI   CNETOPT,C' '                                                     
         BH    *+8                                                              
         MVI   CNETOPT,C'N'        SET CNETOPT TO N                             
**Y2K**                                                                         
         MVC   CNETSTR2,=X'4601'   AND START 2 TO 'YEAR 1' (1970 0K?)           
*                                                                               
SETD34F  DS    0H                                                               
         OC    MANUALS(MANUALLQ),MANUALS  IF ANY MANUAL ENTRY                   
         BNZ   SETD35              IGNORE PROF PERCENTAGE                       
         CLI   RETDRAFT,C'Y'       NO PCT FROM PROFILE                          
         BE    SETD35              IF RETAIL DRAFT                              
         ZIC   RF,PROFB4+15        ELSE TAKE FROM PROFILE                       
         MHI   RF,100                                                           
         ST    RF,MANPCT                                                        
SETD35   DS    0H                                                               
         MVI   PCTNET,C'Y'         PCT ON BOTH GROSS + NET                      
         CLC   MANPCT,=F'14900'    BUT, IF OVER 149 PCT                         
         BNH   SETD36                                                           
         L     RF,MANPCT                                                        
         SHI   RF,10000            SUBTRACT 100 PCT AND TAKE                    
         ST    RF,MANPCT                                                        
         MVI   PCTNET,C'N'         PCT OF GROSS ONLY                            
*                                                                               
SETD36   DS    0H                                                               
         CLI   MOSOPT,C'E'         IF MOS = ES DATE                             
         BE    SETDATEX            SKIP DATE LOGIC UNTIL ESTF                   
*                                                                               
         MVC   NEWSTART,PROFB2+14  STARTING YM FOR NEW BILLING                  
         CLI   QFRATE,C' '         IN CASE OF F-RATES                           
         BNH   SETD36D                                                          
         CLC   =C'MC',QAGY         FOR MCCANN RE-DEFINE NEWSTART                
         BNE   SETD36D                                                          
         CLI   QCLGID,C'Y'         ONLY FOR CGROUP SCHEEME Y & Z                
         BE    *+12                                                             
         CLI   QCLGID,C'Z'                                                      
         BNE   SETD36D                                                          
         MVC   NEWSTART,=X'6801'   PUT THEIR EFFECTIVE DATE (JAN/04)            
SETD36D  OC    NEWSTART,NEWSTART                                                
         BNZ   *+10                                                             
         MVC   NEWSTART,=X'FFFF'   NOT USING NEW BILLING                        
*                                                                               
         CLI   QGMITVC,C' '        BUT IF DOING DF-GMI                          
         BNH   SETD37C             CASH/TRADE FILTERING                         
**Y2K**                                                                         
         MVC   NEWSTART,=X'600A'   START WITH OCT96 (EASIEST WAY TO             
         B     SETD37D             ESTABLISH START MONTH OF SERV)               
*                                                                               
SETD37C  DS    0H                                                               
         MVC   FULL(2),NEWSTART    Y2K STUFF                                    
         MVI   FULL+2,1                                                         
         GOTO1 DATCON,DMCB,(3,FULL),(0,DUB)                                     
         GOTO1 DATCON,DMCB,(0,DUB),(3,FULL)                                     
         MVC   NEWSTART,FULL                                                    
*                                                                               
SETD37D  DS    0H                                                               
         XC    REQYM,REQYM                                                      
         CLI   QSTART+4,C' '       IF FULL DATE GIVEN                           
         BE    SETD3                                                            
*                                  SET BQSTARTP + BQENDP NOW                    
         GOTO1 DATCON,DMCB,QSTART,(2,BQSTARTP)                                  
         GOTO1 DATCON,DMCB,QEND,(2,BQENDP)                                      
SETD3    DS    0H                                                               
*                                  IN WORK SET QSTART - 2YRS                    
*                                          AND QEND +  1 YR                     
         MVC   WORK(6),QSTART                                                   
         MVC   WORK+4(2),=C'01'                                                 
         GOTO1 DATCON,DMCB,(0,WORK),(0,WORK)                                    
         CLI   QSTART+4,C' '       IF ONLY MOS GIVEN                            
         BH    SETD3D                                                           
         GOTO1 DATCON,DMCB,(0,WORK),(3,DUB)  ALSO SET REQYM                     
         MVC   REQYM,DUB                                                        
*                                                                               
SETD3D   DS    0H                                                               
         MVC   WORK+6(6),WORK                                                   
*                                                                               
         LHI   R0,3                SUBTRACT 3 YEARS                             
         LCR   R0,R0                                                            
         GOTO1 ADDAY,DMCB,(C'Y',WORK),WORK,(R0)                                 
*                                                                               
         LHI   R0,1                ADD 1 YEAR                                   
         GOTO1 ADDAY,DMCB,(C'Y',WORK+6),WORK+6,(R0)                             
*                                                                               
         CLC   WORK+2(2),=C'12'    IF MONTH HIGHER THAN 12                      
         BNH   *+16                                                             
         MVC   WORK+2(2),=C'12'    SET IT TO 12 TO GIVE MOBILE                  
         MVC   WORK+8(2),=C'12'    REAL DATES TO WORK WITH                      
*                                                                               
         ZIC   R0,SPOTPROF+2       DATE CONTROL                                 
*                                  BUILD LONG LIST OF DATE PAIRS                
         CLI   PGSW2,C'Y'          IS IT P&G?                                   
         BNE   *+12                                                             
         IC    R0,=C'P'            CALL TO GET SPECIAL FISCAL CALENDAR          
         B     *+16                                                             
*                                                                               
         CLI   MMMSW,C'Y'          IS IT MMM/MMH?                               
         BNE   *+8                                                              
         IC    R0,=C'M'            CALL TO GET SPECIAL FISCAL CALENDAR          
*                                  BUILD LONG LIST OF DATE PAIRS                
         GOTO1 MOBILE,DMCB,(50,WORK),((R0),X)                                   
*                                  FIND FIRST PERIOD OF A NEW YEAR              
         LA    R2,X                                                             
SETD4    DS    0H                                                               
         BAS   RE,CKNEWYR          TEST NEW YEAR                                
         BZ    *+12                YES                                          
         LA    R2,4(R2)                                                         
         B     SETD4                                                            
*                                  BUILD  A LIST OF YM, START-END               
         L     R3,=A(STABUCKC)                                                  
SETD7    DS    0H                                                               
         ZIC   R0,2(R2)                                                         
         SRL   R0,1                                                             
         STC   R0,BYTE             YEAR                                         
         SR    R4,R4               FOR PER SEQUENCE WITHIN YR                   
SETD8    DS    0H                                                               
         LA    R4,1(R4)                                                         
         MVC   0(1,R3),BYTE        YEAR                                         
         STC   R4,1(R3)            MONTH                                        
         MVC   2(4,R3),0(R2)       START-END OF PER                             
         LA    R3,6(R3)                                                         
         LA    R2,4(R2)                                                         
         CLI   0(R2),X'FF'                                                      
         BE    SETD12              EOL                                          
         BAS   RE,CKNEWYR          TEST NEW YEAR                                
         BZ    SETD7               YES                                          
         B     SETD8                                                            
*                                                                               
         SPACE 3                                                                
*                                  FIND START OF NEW YEAR                       
*                                  1) A PERIOD THAT SPANS YEAR CHANGE           
*                                     AND BEGINS NO FURTHER AWAY                
*                                     FROM 12/31 THAN IT ENDS                   
*                             OR   2) A PERIOD THAT STARTS BEFORE 1/14          
*                                                                               
CKNEWYR  DS    0H                                                               
         MVC   DUB(4),0(R2)                                                     
         NI    DUB,X'FF'-X'FE'     STRIP YEAR                                   
         CLC   DUB(2),NEWYRLO                                                   
         BL    CKNYYES                                                          
*                                                                               
         CLC   DUB(2),PDDEC                                                     
         BNH   CKNYNO                                                           
*                                                                               
         NI    DUB+2,X'FF'-X'FE'                                                
         CLC   DUB+2(2),PDDEC                                                   
         BH    CKNYNO                                                           
*                                                                               
         NI    DUB+1,X'FF'-X'E0'   ISOLATE DAY                                  
         ZIC   RF,DUB+1                                                         
         LHI   R0,30                                                            
         SR    R0,RF                                                            
         BNP   CKNYYES             STARTS ON 30TH OR 31ST                       
         STC   R0,DUB+4                                                         
*                                                                               
         ST    RE,FULL                                                          
         GOTO1 DATCON,DMCB,(2,2(R2)),(15,WORK)                                  
         L     RE,FULL                                                          
         ZAP   DOUBLE,WORK+2(2)                                                 
         CVB   R0,DOUBLE                                                        
         CLM   R0,1,DUB+4                                                       
         BNL   CKNYYES                                                          
*                                                                               
*        NI    DUB+3,X'FF'-X'E0'   ISOLATE DAY                                  
*        CLC   DUB+4(1),DUB+3                                                   
*        BNH   CKNYYES                                                          
*                                                                               
CKNYNO   DS    0H                                                               
         LTR   RE,RE                                                            
         BR    RE                                                               
CKNYYES  DS    0H                                                               
         SR    R0,R0                                                            
         BR    RE                                                               
*                                                                               
*                                                                               
NEWYRLO  DC    X'002E'             JAN14                                        
PDDEC    DC    X'0180'             DEC00                                        
*                                                                               
*              NOW FIND PER THAT MATCHES REQ                                    
*                                                                               
SETD12   DS    0H                                                               
         L     R3,=A(STABUCKC)                                                  
SETD13   DS    0H                                                               
         MVI   PARTIAL,C'N'                                                     
         MVI   XPERSW,C'N'                                                      
         OC    REQYM,REQYM          IF YM REQ                                   
         BZ    SETD14                                                           
         CLC   REQYM,0(R3)          MATCH PERIOD                                
         BH    SETD16                                                           
         MVC   BQSTARTP(4),2(R3)   SET START-END                                
         BE    SETD20                                                           
SETD13B  DS    0H                                                               
         MVI   ERR,DATERR2                                                      
         BRAS  RE,ERRPROC                                                       
SETD14   DS    0H                                                               
*                                  START-END REQ                                
         MVI   PRIOR,C'N'                                                       
         MVI   PARTIAL,C'N'                                                     
         MVI   XPERSW,C'N'                                                      
         CLC   BQSTARTP(4),2(R3)                                                
         BE    SETD20              WHOLE PERIOD REQ                             
         CLC   BQSTARTP,4(R3)                                                   
         BH    SETD16                                                           
         CLC   BQSTARTP,2(R3)                                                   
         BL    SETD13B             NOT WITHIN A PERIOD                          
SETD14B  DS    0H                                                               
         CLC   BQENDP,4(R3)                                                     
         BNH   SETD14D                                                          
         CLI   XPEROPT,C'Y'        IS CROSS PERIOD BILLING ALLOWED              
         BNE   SETD13B             NO, BAD  REQ                                 
         CLI   XPERSW,C'Y'         FIRST TIME                                   
         BE    *+8                                                              
         MVI   NMOS,1              CLEAR MONTH COUNT                            
         MVI   XPERSW,C'Y'         SET HAVE CROSS PERIOD REQ                    
         ZIC   RF,NMOS             BUMP MONTH COUNT                             
         AHI   RF,1                                                             
         STC   RF,NMOS                                                          
         LA    R3,6(R3)            NEXT PERIOD                                  
         B     SETD14B                                                          
*                                                                               
SETD14D  DS    0H                                                               
         CLI   XPERSW,C'Y'         CROSS PERIOD MODE                            
         BE    SETD20                                                           
*                                                                               
         MVI   PARTIAL,C'Y'        PARTIAL PERIOD BILLING                       
         CLI   PREVSW,C'Y'         TEST NEED PREV EVEN IF PARTIAL               
         BE    *+12                                                             
         MVI   PREVSW,C'N'         FOR PARTIAL NO PREV BILLING                  
         MVI   NMOS,1                                                           
         B     SETD20                                                           
SETD16   DS    0H                                                               
         LA    R3,6(R3)            FIND LAST PERIOD                             
         B     SETD13                                                           
*                                                                               
SETD20   DS    0H                  HAVE MATCHING PERIOD                         
         MVC   CURPER,0(R3)        SAVE CURRENT PERIOD                          
         LHI   R2,5                                                             
         CLI   PRIOR,C'N'          IF PRIOR MONTHS                              
         BNE   *+12                                                             
         CLI   XPERSW,C'Y'         OR CROSS PERIOD                              
         BNE   SETD22                                                           
*                                  BACK UP NMOS PERIODS                         
*                                  OR UNTIL REACH NEWSTART                      
*                                  OR UNTIL REACH N MONTHS BACK                 
         SR    R2,R2                                                            
         ZIC   R0,NMOS                                                          
         B     SETD21A                                                          
SETD21   DS    0H                                                               
         CLI   1(R3),13            CHECK MOS =< THEN 13                         
         BNH   *+6                 IF HIGHER DIE, SHOULD NOT HAPPEN             
         DC    H'0'                                                             
*                                                                               
         CLC   0(2,R3),NEWSTART                                                 
         BL    SETD21B                                                          
         BE    SETD21D                                                          
         SHI   R3,6                                                             
         LA    R2,6(R2)                                                         
SETD21A  DS    0H                                                               
         BCT   R0,SETD21                                                        
         B     SETD21D                                                          
SETD21B  DS    0H                                                               
         LTR   R2,R2                                                            
         BNZ   SETD21D                                                          
SETD21C  DS    0H                                                               
         MVI   ERR,DATERR                                                       
         BRAS  RE,ERRPROC                                                       
SETD21D  DS    0H                                                               
         LA    R2,5(R2)                                                         
*                               ***SET PERLIST                                  
SETD22   DS    0H                                                               
         XC    PERLIST(PERLSTLQ),PERLIST                                        
*                                  PERLMOS, PERLSTRT, PERLEND FOR EACH          
*                                  MOS GET BUILT HERE IN ONE SHOT               
         EX    R2,*+8                                                           
         B     *+10                                                             
         MVC   PERLIST(0),0(R3)                                                 
         LA    RF,PERLIST+1(R2)                                                 
         MVI   0(RF),X'FF'         SET END OF LIST MARKER                       
*                                                                               
PERLST   USING PERLISTD,PERLIST                                                 
         CLC   PERLST.PERLMOS,NEWSTART                                          
         BL    SETD21C             DATE ERROR                                   
         OC    REQYM,REQYM          TEST START-END REQUESTED                    
         BZ    SETD23            YES                                            
*                                                                               
         MVC   BQSTARTP,PERLST.PERLSTRT                                         
         DROP  PERLST                                                           
*                                  SET DERIVED START-END DATES IN REQ           
         GOTO1 DATCON,DMCB,(2,BQSTARTP),QSTART                                  
         GOTO1 DATCON,DMCB,(2,BQENDP),QEND                                      
*                                                                               
SETD23   DS    0H                  MEDPRDRD, MEDDATE, ETC.                      
         L     R9,MEDBUFF                                                       
         USING MEDBLOCK,R9                                                      
         XC    MEDNUMWK(8),MEDNUMWK                                             
         MVC   MEDNUMMO+3(1),NMOS                                               
         XC    MEDNUMQT,MEDNUMQT                                                
         MVC   MEDNUMPE,=F'1'                                                   
         MVC   MEDLCHNK,=F'320'    **ENOUGH FOR 2ND CURRENCY???                 
         MVI   MEDEXTDM,0                                                       
         MVI   MEDEXTAC,C'Y'                                                    
*                                                                               
         GOTO1 MEDPRDRD,DMCB,SPWORKD                                            
*                                                                               
         MVC   SVSTAP,BQSTARTP       SAVE START AND END                         
         MVC   SVENDP,BQENDP                                                    
         MVC   SAVSTRT,QSTART                                                   
         MVC   SAVEND,QEND                                                      
         CLI   XPERSW,C'Y'         IF CROSS-PERIOD BILLING                      
         BE    *+16                DON'T FUDGE MEDDATE PERIOD                   
         CLI   PARTIAL,C'Y'        PARTIAL PERIOD BILLING                       
         BNE   *+8                                                              
         MVI   MEDDAILY,C'Y'       FUDGE NOT TO CALL MOBILE                     
*                                                                               
         GOTO1 MEDDATE,DMCB,SPWORKD                                             
         CLI   XPERSW,C'Y'         IF CROSS-PERIOD BILLING                      
         BE    SETD23B             SKIP DATE RESET                              
         OC    REQYM,REQYM         TEST REQ'D START AND END                     
         BNZ   SETD23B             NO, SKIP DATE RESET                          
*                                                                               
         MVC   BQSTARTP,SVSTAP     YES - RESTORE DATES                          
         MVC   BQENDP,SVENDP       (IMPORTANT ONLY                              
         MVC   QSTART,SAVSTRT       WHEN DATES DO NOT                           
         MVC   QEND,SAVEND          COINCIDE WITH                               
*                                  'WEEK' START AND END                         
         L     RF,MEDAFRST         AND ADJUST MED PERIOD                        
         MVC   0(4,RF),BQSTARTP    (THERE WILL ONLY BE 1 PERIOD)                
*                                                                               
SETD23B  DS    0H                                                               
*                                                                               
         CLI   MOSOPT,C'E'         IF DOING MOS TYPE ESTS                       
         BNE   SETDATEX                                                         
         MVC   QSTART,SVQSTART     RESTORE ORIGINAL QSTART/END                  
         MVC   QEND,SVQEND                                                      
         L     RF,MEDAFRST           AND ADJUST MED PERIOD                      
         MVC   0(4,RF),BQSTARTP      (THERE WILL ONLY BE 1 PERIOD)              
*                                                                               
SETDATEX DS    0H                                                               
         XIT1                                                                   
         DROP  R9                                                               
         SPACE 2                                                                
*              FIXVACC - FIX VAT ACCOUNT CODES                                  
*                                                                               
FIXVACC  DS    0H                                                               
         LA    RF,X                CHANGE * TO SPACE                            
         LHI   R0,16                                                            
         CLI   0(RF),C'*'                                                       
         BNE   *+8                                                              
         MVI   0(RF),C' '                                                       
         LA    RF,1(RF)                                                         
         BCT   R0,*-16                                                          
         BR    RE                                                               
*                                                                               
         DROP  R7                                                               
         SPACE 3                                                                
         LTORG                                                                  
*                                                                               
         TITLE 'TOSORT - PASS RECORDS TO SORT/BUFFALO'                          
TOSORT   NMOD1 SPLWRKL,TOSORT                                                   
         LR    R9,RC                                                            
         USING SPLWRKD,R9                                                       
         LA    RC,SPACEND                                                       
         CLI   SPLITOPT,C'Y'       TEST DOING SPLITS                            
         BE    *+12                                                             
         BAS   RE,TSSEND                                                        
         B     TSX                                                              
*                                                                               
         OC    MANRVDTP,MANRVDTP   IS THIS A REVERSAL BILL                      
         BZ    *+12                                                             
         BAS   RE,TSSEND           YES, DON'T DO SPLITS                         
         B     TSX                                                              
*                                  PRODUCT SPLITS                               
         XC    WORK,WORK                                                        
         L     RF,APRD             PRODUCT CODE (ALPHA SEQ CODE)                
         MVC   WORK(1),0(RF)                                                    
         L     RF,AEST             ESTIMATE                                     
         MVC   WORK+1(1),0(RF)                                                  
         GOTO1 BINSRCH,SPLPARS,(1,WORK)                                         
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                TOO MANY SPLIT PRODUCTS                      
*                                                                               
         MVC   SPLAENT,0(R1)       SAVE A(TABLE ENTRY)                          
         MVI   SPLAENT,0           CLEAR HOB                                    
         CLI   0(R1),1             TEST ALREADY ON FILE                         
         BNE   TS42                YES                                          
*                                  NO, READ FOR SPLIT RECORD                    
         MVC   WORK,KEY            SAVE KEY                                     
         XC    KEY,KEY                                                          
         LA    R5,KEY                                                           
         USING SPBRECD,R5                                                       
         MVI   SPBKTYP,SPBKTYPQ                                                 
         MVI   SPBKSUB,SPBKSUBQ                                                 
         MVC   SPBKAGMD,BAGYMD                                                  
         MVC   SPBKCLT,BCLT                                                     
         L     R1,APRD             PRODUCT CODE (ALPHA SEQ)                     
         ZIC   RF,0(R1)                                                         
         MHI   RF,4                CLIST ENTRY SIZE IS 4                        
         L     RE,ADCLT                                                         
         LA    RE,CLIST-CLTHDR(RE,RF)                                           
         MVC   SPBKPRD,0(RE)                                                    
         L     RF,AEST             ESTIMATE                                     
         MVC   SPBKEST,0(RF)                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE     IF NO RECORD THEN DONE                       
         BNE   TS40                (TABLE WILL HAVE NULL ENTRY)                 
*                                                                               
*        L     R5,APEPTAB          USE PEPTAB AS IO AREA                        
         L     R5,ASPBIL           USE DEDICATED IO AREA                        
         ST    R5,AREC                                                          
         GOTO1 GET                                                              
*                                                                               
         LA    R5,SPBFSTEL                                                      
         L     R6,SPLAENT          A(TABLE ENTRY)                               
         LA    R6,2(R6)            POINT TO FIRST SHARE ENTRY                   
         SR    R7,R7                                                            
*                                                                               
TS36     DS    0H                                                               
         CLI   0(R5),0             EOR                                          
         BE    TS40                                                             
         CLI   0(R5),PPCELCDQ      TEST RIGHT ELEM                              
         BE    TS37                                                             
*                                                                               
TS36D    DS    0H                                                               
         ZIC   R0,1(R5)                                                         
         AR    R5,R0                                                            
         B     TS36                                                             
         DROP  R5                                                               
*                                                                               
TS37     DS    0H                                                               
         AHI   R7,1                COUNT ELEMS                                  
         CHI   R7,SPLTSMAX         TEST VS MAX SHARES                           
         BNH   *+6                                                              
         DC    H'0'                TOO MANY SHARES                              
         USING PPCEL,R5                                                         
         L     RF,ADCLT            GET PRD ALPHA SEQ                            
         LA    RF,CLIST-CLTHDR(RF)                                              
         LR    R0,RF                                                            
*                                                                               
TS38D    DS    0H                                                               
         CLI   0(RF),0                                                          
         BNE   *+6                                                              
         DC    H'0'                BAD PRODUCT                                  
         CLC   0(3,RF),PPCPRD                                                   
         BE    *+12                                                             
         LA    RF,4(RF)                                                         
         B     TS38D                                                            
*                                                                               
         SR    RF,R0                                                            
         SRL   RF,2                                                             
         STC   RF,0(R6)            SET PRD ALPHA SEQ                            
         MVC   1(2,R6),PPCPCT                                                   
         LA    R6,SPLTSLEN(R6)                                                  
         B     TS36D               NEXT ELEMENT                                 
         DROP  R5                                                               
*                                                                               
TS40     DS    0H                                                               
         MVC   KEY,WORK            RESTORE SEQ                                  
         GOTO1 HIGH                                                             
*                                                                               
TS42     DS    0H                                                               
         L     R2,SPLAENT          A(TABLE ENTRY)                               
         OC    2(3,R2),2(R2)       IF FIRST SPLIT IS NULL NO SPLIT              
         BNZ   *+12                                                             
         BAS   RE,TSSEND                                                        
         B     TSX                                                              
*                                                                               
         LA    R2,2(R2)            POINT TO FIRST SHARE ENTRY                   
         LHI   R3,SPLTSMAX         MAX SHARES                                   
         XC    SPLWRKA(SPLWRKL),SPLWRKA     CLEAR WORK AREA                     
*                                                                               
         L     R4,ASORTDTA         START OF ORDERED/BILLED DATA                 
         LA    R5,SPLWRK                                                        
         MVC   SPLORIGD(ROW$L,R5),0(R4)   SKIP NUMBER OF SPOTS                  
         MVC   SPLORIGD+ROW$L(ROW$L,R5),ROWHL(R4)                               
*                                                                               
TS46     DS    0H                                                               
         OC    0(3,R2),0(R2)       NULL IS EOL                                  
         BZ    TSX                                                              
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,1(R2)          PCT FOR THIS PRD                             
         A     RF,SPLPCUME         CUME PCT                                     
         ST    RF,SPLPCUME                                                      
*                                                                               
         LA    R5,SPLWRK                                                        
         LHI   R6,SPLWLEN/4        NUMBER OF AMOUNTS                            
*                                                                               
TS48     DS    0H                                                               
         L     R1,SPLORIGD(R5)     ORIGINAL AMOUNT                              
         M     R0,SPLPCUME         TIMES CUMED PCT                              
         LHI   RF,10000                                                         
         DRNDR (R0),(RF)                                                        
         LR    RF,R1                                                            
         S     R1,SPLACUMD(R5)     LESS PREVIOUS AMOUNT CUME                    
         ST    R1,SPLAMTD(R5)      = THIS PRD SHARE                             
         ST    RF,SPLACUMD(R5)     SET NEW CUME AMOUNT                          
*                                                                               
         LA    R5,4(R5)            NEXT AMOUNT                                  
         BCT   R6,TS48                                                          
*                                                                               
         L     RF,ASORTDTA         SET SPLIT RESULTS IN RECORD                  
         LA    R5,SPLWRK+SPLAMTD                                                
         MVC   0(ROW$L,RF),0(R5)      BYPASS NO. OF SPOTS                       
         MVC   ROWHL(ROW$L,RF),ROW$L(R5)                                        
         L     RF,APRD                                                          
         MVC   0(1,RF),0(R2)                                                    
*                                                                               
         CLI   QPGR,C' '           TEST PGRS                                    
         BE    TS60                NO                                           
*                                  YES                                          
         L     RF,APGR1                                                         
         LTR   RF,RF               SEE IF HAVE PGROUP IN SORTKEY                
         BZ    TS60                                                             
         L     RE,APRD                                                          
         L     RF,ADCLT                                                         
         ZIC   R1,0(RE)                                                         
         MHI   R1,4                                                             
         LA    RF,CLIST-CLTHDR(RF,R1)     GET ALPHA PRD                         
*                                                                               
         L     RE,PRDLIST                                                       
TS55     DS    0H                                                               
         CLC   3(1,RF),5(RE)                                                    
         BE    *+12                                                             
         LA    RE,6(RE)                                                         
         B     TS55                                                             
*                                                                               
         MVC   FULL(2),0(RE)                                                    
         UNPK  DUB(5),FULL(3)                                                   
         L     RF,APGR1                                                         
         ZIC   RE,PGR3LEN                                                       
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),DUB                                                      
*                                                                               
TS60     BAS   RE,TSSEND           SEND TO SORT                                 
*                                                                               
         LA    R2,SPLTSLEN(R2)      NEXT PRODUCT SHARE                          
         BCT   R3,TS46                                                          
*                                                                               
TSX      XIT1                                                                   
         SPACE 2                                                                
TSSEND   DS    0H                                                               
         LR    R0,RE                                                            
*                                                                               
         CLI   HALF2,C'P'          ARE WE SENDING PREV BILLING?                 
         BE    TSS3                YES, NO BPCT AND HOLD CHECKS                 
         OC    LMGSW,LMGSW         IS THIS GM REQUEST                           
         BZ    TSS2                                                             
         BRAS  RE,SETBPCT                                                       
         BE    TSSXX               NO BILLPCT WAS FOUND                         
*                                                                               
TSS2     BRAS  RE,HOLDCK     CHECK IF BUY AMT = HOLD AMT                        
         BNE   TSSXX         IF YES, DON'T SEND BUY TO SORT                     
*                                                                               
*        CLI   QTRADE,C'T'         DOING TRADE REQUEST?                         
*        BNE   TSS3                                                             
*        L     RF,ADBUY            HAVE TO CHECK FOR C-RATE ON BUY              
*        USING BUYREC,RF                                                        
*        TM    BDCIND2,BDCCOMOQ    HAS TO BE C-RATE                             
*        BO    TSS3                                                             
*        DROP  RF                                                               
*        CLI   RCWRITE,C'Y'        CHECK IF UPDATING THE FILE                   
*        BE    TSSXX               YES, SKIP THE BUY                            
*        MVI   ERR,TRDERR          IF DRAFT GIVE ERROR                          
*        BRAS  RE,ERRPROC                                                       
*                                                                               
*        OC    NBTOTG(16),OBTOTG   CHK NBTOTG-OBTOTN FOR ANY DOLLARS            
*        BZ    *+6                 YES, ALREADY UPDATED, DIE                    
*        DC    H'0'                                                             
*                                                                               
*        MVI   ERR,TRDERR          IF NOTHING WAS WRITTEN OUT, ERROR            
*        BRAS  RE,ERRPROC                                                       
*                                                                               
TSS3     CLI   SORTTRCE,C'Y'                                                    
         BNE   TSS4                                                             
         GOTO1 PRNTBL,DMCB,=C'SORT IN',SORTREC,C'DUMP',SORTRLEN,=C'1D'          
*                                                                               
TSS4     DS    0H                                                               
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFFC,SORTREC                              
*                                                                               
TSSXX    XC    HALF2,HALF2                                                      
         LR    RE,R0                                                            
         BR    RE                                                               
         DROP  R9                                                               
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
HOLDCK   NTR1       CHECK IF THERE'S BILLING HOLD REC FOR THIS BUY              
         L     R7,ADBUY                                                         
         USING BUYREC,R7                                                        
         XC    WORK,WORK                                                        
KEY@     USING BHOLDTD,WORK                                                     
         MVC   KEY@.BHLDAM,BUYKAM                                               
         MVC   KEY@.BHLDCLT,BUYKCLT                                             
         L     R1,APRD             PRODUCT CODE (ALPHA SEQ)                     
         ZIC   RF,0(R1)                                                         
         MHI   RF,4                CLIST ENTRY SIZE IS 4                        
         L     RE,ADCLT                                                         
         LA    RE,CLIST-CLTHDR(RE,RF)                                           
         MVC   KEY@.BHLDPRD,3(RE)                                               
         MVC   KEY@.BHLDEST,BUYKEST                                             
         MVC   KEY@.BHLDMKS,BUYMSTA                                             
         MVC   KEY@.BHLDMOS,THISPER                                             
         DROP  KEY@                                                             
         GOTO1 BINSRCH,BHLPARS,WORK                                             
         CLI   0(R1),1                                                          
         BNE   *+12                                                             
         MVI   HALF2,C'Y'          NOT IN BHOLDTAB, SEND THE BUY                
         B     HOLDCKX                                                          
*                                                                               
         L     R5,0(R1)            BHOLD REC                                    
         TM    BHLDSTA1-BHOLDTD(R5),BHLDDONE                                    
         BZ    *+12                                                             
         MVI   HALF2,C'Y'          IF USED THIS BEHOLD BEFORE - SKIP            
         B     HOLDCKX                                                          
*                                                                               
         L     R3,ASORTDTA         DOLLAR FIELDS IN SORTREC                     
*                                                                               
         CLC   BHLDGRS-BHOLDTD(,R5),RGRSD(R3)                                   
         BNE   HLDCK30                                                          
         CLC   BHLDNET-BHOLDTD(,R5),RNETD(R3)                                   
         BNE   *+12                                                             
         MVI   HALF2,C'N'          IF $$ EQ, DON'T PUT IN BUY                   
         B     HLDCK80                                                          
*                                                                               
HLDCK30  L     R1,RGRSD(R3)        IF NEQ SUBTRACT HOLD $$ FROM BUY $$          
         L     RF,BHLDGRS-BHOLDTD(R5)                                           
         SR    R1,RF                                                            
         ST    R1,RGRSD(R3)                                                     
         L     R1,RNETD(R3)                                                     
         L     RF,BHLDNET-BHOLDTD(R5)                                           
         SR    R1,RF                                                            
         ST    R1,RNETD(R3)                                                     
         MVI   HALF2,C'Y'          PUT BUY WITH ADJUSTED $$                     
*                                  NOW MARK THIS BHOLD AS PROCESSED             
HLDCK80  OI    BHLDSTA1-BHOLDTD(R5),BHLDDONE                                    
*                                                                               
HOLDCKX  CLI   HALF2,C'Y'          SET CC                                       
         XIT1                                                                   
         DROP  R7                                                               
         EJECT                                                                  
SETBPCT  NTR1       APPLY BILLING PERCENT                                       
         L     R7,ADBUY                                                         
         USING BUYREC,R7                                                        
         XC    WORK,WORK                                                        
KEY@     USING BPCTD,WORK                                                       
         MVC   KEY@.BPCTAM,BUYKAM                                               
         MVC   KEY@.BPCTCLT,BUYKCLT                                             
         L     R1,APRD             PRODUCT CODE (ALPHA SEQ)                     
         ZIC   RF,0(R1)                                                         
         MHI   RF,4                CLIST ENTRY SIZE IS 4                        
         L     RE,ADCLT                                                         
         LA    RE,CLIST-CLTHDR(RE,RF)                                           
         MVC   KEY@.BPCTPRD,0(RE)                                               
         MVC   KEY@.BPCTEST,BUYKEST                                             
         MVC   KEY@.BPCTMOS,THISPER                                             
         DROP  KEY@                                                             
         GOTO1 BINSRCH,BPCTPARS,WORK                                            
         CLI   0(R1),1                                                          
         BNE   SETBP25             IN BPCTTAB -- PROCESS IT                     
         CLI   LMGSW,C'L'          LMG?                                         
         BE    SETBPX              NOT IN BPCTTAB, DON'T SEND THE BUY           
         CLC   THISPER,=X'6D01'    REG, IF 2009 & AFTER DON'T APPLY %           
         BL    *+10                                                             
         LTR   RB,RB               SET CC NEQ, TO PROC THE WHOLE BUY            
         B     SETBPX                                                           
*                                                                               
         CR    RB,RB               IF BEFORE 2009                               
         B     SETBPX              DON'T PROC THE BUY                           
*                                                                               
SETBP25  L     R5,0(R1)            BPCT REC                                     
         L     R3,ASORTDTA         DOLLAR FIELDS IN SORTREC                     
         LHI   R4,6                6 ORDERED DOLLAR FIELDS                      
*                                                                               
SETBP30  ICM   R1,15,0(R3)                                                      
         BZ    SETBP40                                                          
         SR    R0,R0                                                            
         ICM   R0,3,BPCTPCT-BPCTD(R5)                                           
         MR    R0,R0              APPLY BILLING %                               
         D     R0,=F'1000'                                                      
         CLI   LMGSW,C'L'         LMG?                                          
         BE    *+12                                                             
         L     R0,0(R3)                                                         
         SR    R0,R1                                                            
         LR    R1,R0                                                            
*                                                                               
         ST    R1,0(R3)                                                         
*                                                                               
SETBP40  LA    R3,4(R3)            NEXT AMOUNT                                  
         BCT   R4,SETBP30                                                       
         LTR   RB,RB               PUT BUY WITH ADJUSTED $$                     
*                                                                               
*                                                                               
SETBPX   XIT1                                                                   
         DROP  R7                                                               
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
SPLWRKD  DSECT                                                                  
SPLWRKA  DS    0D                                                               
SPLPCUME DS    XL4                 PCT CUME                                     
SPLAENT  DS    XL4                 A(TABLE ENTRY)                               
SPLWRK   DS    (ROW$L*8)X                                                       
SPLWLEN  EQU   ROW$L*2                                                          
SPLORIGD EQU   0                   ORIGINAL AMOUNTS                             
SPLACUMD EQU   SPLWLEN             AMOUNT CUMES                                 
SPLAMTD  EQU   SPLWLEN*2           SHARE AMOUNTS                                
SPLWRKL  EQU   *-SPLWRKA                                                        
         TITLE 'BILLBOX - READ AND PRINT REMITTANCE ADDRESS'                    
SPB102   CSECT                                                                  
BILLBOX  NMOD1 0,BILLBOX                                                        
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         L     R5,=A(DICSECT)                                                   
         USING DICSECT,R5                                                       
*                                                                               
         CLI   RETDRAFT,C'Y'                                                    
         BE    BOXX                                                             
         CLI   TESTFLAG,C'T'                                                    
         BNE   BOX2                                                             
         MVC   P+20(L'SP@TSTBL),SP@TSTBL    **** TEST BILLING ****              
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
BOX2     DS    0H                                                               
         CLI   PREVSW,C'P'                                                      
         BNE   BOX4                                                             
*              **NOTE- THIS IS DEFUNCT AND DOESN'T NEED FRENCH**                
         MVC   P1+20(37),=C'* THIS IS A MEMO INVOICE TO REVERSE *'              
         MVC   P2+20(37),=C'*         PREVIOUS BILLING          *'              
         MVC   P3+20(37),=C'*     DO NOT FORWARD TO CLIENT      *'              
         BRAS  RE,PRNT                                                          
*                                                                               
BOX4     DS    0H                                                               
         CLI   BOXNO,C'*'                                                       
         BNH   BOXX                                                             
*                                                                               
         LA    R4,WORK                                                          
         USING ADDRREC,R4                                                       
         MVI   ADDKTYPE,ADDKTYPQ                                                
         MVI   ADDKMED,C'T'                                                     
         MVC   ADDKCALL(3),=C'BOX'                                              
         MVC   ADDKCALL+3(1),BOXNO                                              
         MVI   ADDKCALL+4,C'T'                                                  
         MVC   ADDKAGY,AGY                                                      
         MVC   ADDKFILL,=C'000000'                                              
         CLC   ADDRKEY,BOXADDR                                                  
         BE    BOX8                                                             
*                                                                               
         MVC   KEY(L'ADDRKEY),ADDRKEY                                           
         GOTO1 HIGHSTAD                                                         
         L     R4,ADSTATAD                                                      
         CLC   WORK(L'ADDRKEY),ADDRKEY    DID WE FIND ADDRESS?                  
         BNE   BOXX                                                             
         MVC   BOXADDR,ADDRKEY                                                  
*                                                                               
BOX8     DS    0H                                                               
         MVC   P(L'SP@RMTAD),SP@RMTAD       ** REMITTANCE ADDRESS **            
         DROP  R5                                                               
*                                                                               
         LA    R1,P+25                                                          
         LA    R4,BOXADDR                                                       
         MVC   0(L'ANAME,R1),ANAME                                              
         LA    R1,132(R1)                                                       
         MVC   0(L'A1LINE,R1),A1LINE                                            
         LA    R1,132(R1)                                                       
         MVC   0(L'A2LINE,R1),A2LINE                                            
         LA    R1,24(R1)                                                        
         CLI   0(R1),C' '                                                       
         BH    *+8                                                              
         BCT   R1,*-8                                                           
*                                                                               
         MVI   1(R1),C','                                                       
         MVC   3(2,R1),A3LINE                                                   
         MVC   7(L'ABIGZIP,R1),ABIGZIP                                          
         DROP  R4                                                               
*                                                                               
         GOTO1 ABILLEDI,DMCB,('EDMRMA',0)   EDI                                 
         BRAS  RE,PRNT                                                          
*                                                                               
BOXX     DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
BOXADDR  DS    CL117                                                            
*                                                                               
         LTORG                                                                  
         TITLE 'BILHEAD - HEADLINE ROUTINES  (HEADHOOK)'                        
BILHEAD  NMOD1 0,BILHEAD,R9                                                     
         L     R8,SAVER8                                                        
         L     RA,SAVERA                                                        
         LA    RC,SPACEND                                                       
         B     BH1                                                              
*                                                                               
BH1      DS    0H                                                               
         L     R7,=A(DICSECT)      DICTIONARY CSECT                             
         USING DICSECT,R7                                                       
*                                                                               
         CLI   RCSUBPRG,100        SPECIAL TO SAVE HEADS                        
         BE    BH50                                                             
         CLI   RCSUBPRG,20         INVOICE REGISTER                             
         BE    BH80                                                             
         CLI   RCSUBPRG,21         AOR INVOICE REGISTER                         
         BE    BH80                                                             
         CLI   RCSUBPRG,30         DRAFT                                        
         BE    BH5D                                                             
*                                  NORMAL HEADLINE ROUTINE                      
         CLI   AGMFORMS,C'D'       DDS+ PAPER                                   
         BE    BH1F                                                             
         CLI   AGMFORMS,C'A'       AGY ADDR ON AGY PAPER (HEAD 1)               
         BNE   *+14                                                             
         MVC   HEAD1+27(33),AGYADR                                              
         B     BH1G                                                             
*                                                                               
         CLI   AGMFORMS,C'B'       AGY ADDR ON AGY PAPER (HEAD 3)               
         BNE   BH2                                                              
         MVC   HEAD3+27(33),AGYADR                                              
         OC    HEAD3+27(33),SPACES                                              
         GOTO1 CENTER,DMCB,HEAD3+27,33                                          
         B     BH2                                                              
*                                                                               
BH1F     DS    0H                                                               
         MVC   HEAD1+27(33),AGYNM                                               
         MVC   HEAD2+27(33),AGYADR                                              
         OC    HEAD2,SPACES                                                     
         GOTO1 CENTER,DMCB,HEAD2+27,33                                          
*                                                                               
BH1G     DS    0H                                                               
         OC    HEAD1,SPACES                                                     
         GOTO1 CENTER,DMCB,HEAD1+27,33                                          
*                                                                               
BH2      DS    0H                                                               
         CLI   SKIPSPEC,C'Y'                                                    
         BE    BHX                                                              
*                                                                               
         MVC   SPWD,SPACES                                                      
         MVC   SPWD+10(L'SP@SPOTS),SP@SPOTS  SPOTS (FOR NON-NETWORK)            
         CLI   QMED,C'N'                                                        
         BNE   *+10                                                             
         MVC   SPWD+10(L'SP@UNITS),SP@UNITS  UNITS (FOR NETWORK)                
*                                                                               
         LA    R4,HEAD5            START WITH HEAD5                             
         CLI   AGMFORMS,C'L'       IF 'LONG LOGO' FORMS                         
         BE    *+16                                                             
         CLI   AGMFORMS,C'B'       'LONG LOGO' FORMS (ADDR IN HEAD3)            
         BE    *+8                                                              
         LA    R4,HEAD4            ELSE USE HEAD 4                              
*                                                                               
         MVC   0(L'SP1INVDT,R4),SP1INVDT                                        
         MVC   14(L'PINVDTE,R4),PINVDTE        INVOICE DATE                     
         CLI   PDUEDTE,C' '                                                     
         BE    *+16                                                             
         MVC   132(L'SP@DUEDT,R4),SP@DUEDT                                      
         MVC   132+14(L'PDUEDTE,R4),PDUEDTE    DUE DATE                         
*                                                                               
         CLI   PSHPDTE,C' '        SHIPPING DATE                                
         BNH   *+16                                                             
         MVC   264(9,R4),=C'SHIP DATE'                                          
         MVC   264+14(8,R4),PSHPDTE                                             
*                                                                               
         MVC   66(L'SP@INV,R4),SP@INV   INVOICE                                 
         CLI   CORPZ,C'Y'          TEST CORP RETAIL NOT AN INVOICE              
         BNE   *+10                                                             
         MVC   62(L'SP@CTRLN,R4),SP@CTRLN    CONTROL NO.                        
         MVC   132+75(L'SP@PAGE,R4),SP@PAGE                                     
         LA    R6,132+80(R4)                                                    
         EDIT  PAGE,(3,0(R6))                                                   
*                                                                               
         LR    R5,R4                                                            
*******  CLC   =C'BD',QAGY         FOR BBDO                                     
*******  BNE   *+8                                                              
*******  LA    R5,132(R4)          PUT MEDIA DOWN ONE LINE                      
*                                                                               
         L     RF,ADCLT            SEE IF MEDIA NAME IN CLIENT HEADER           
         LA    RF,CMEDNAME-CLTHDR(RF)                                           
         CLI   0(RF),C' '                                                       
         BNH   *+16                                                             
         CLI   RCLANG,4            FRENCH                                       
         BE    BH4B                                                             
         B     BH4C                                                             
*                                                                               
         LA    RF,MEDNM            USE AGYREC MEDIA NAMES                       
         CLI   RCLANG,4            BUT IF FRENCH                                
         BNE   BH4C                GET FROM DICTIONARY                          
         LA    RF,SP@STV           SPOT TV                                      
         LHI   RE,L'SP@STV-1                                                    
         CLI   QMED,C'T'                                                        
         BE    BH4B                                                             
         LA    RF,SP@SRAD          SPOT RADIO                                   
         LHI   RE,L'SP@SRAD-1                                                   
         CLI   QMED,C'R'                                                        
         BE    BH4B                                                             
         LA    RF,SP@NRAD          NET RADIO                                    
         LHI   RE,L'SP@NRAD-1                                                   
         CLI   QMED,C'X'                                                        
         BE    BH4B                                                             
         LA    RF,SP@NTV           NET TV                                       
         LHI   RE,L'SP@NTV-1                                                    
*                                                                               
BH4B     DS    0H     FRENCH- FACTURATION MEDIA TV SELECTIVE, ETC               
         MVC   29(L'SP@MEDBL,R5),SP@MEDBL                                       
         EX    RE,*+8                                                           
         B     BH4C4                                                            
         MVC   29+L'SP@MEDBL+1(0,R5),0(RF)                                      
*                                                                               
BH4C     DS    0H                  ENGLISH                                      
         MVC   32(10,R5),0(RF)                                                  
         LA    RF,42(R5)                                                        
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   2(L'SP@MEDBL,RF),SP@MEDBL     MEDIA BILLING                      
*                                                                               
BH4C4    DS    0H                                                               
         CLI   PASSNO,2            DETAIL BAKUP                                 
         BNE   BH5                                                              
         CLI   DUESW,C'R'          SKIP SUB-HEAD FOR AOR                        
         BE    BH5                                                              
         CLI   DUESW,C'A'          OR COMM ADJ INV                              
         BE    BH5                                                              
         LA    R0,32-14(R5)                                                     
         SR    RF,R0               RF = LENGTH OF TITLE                         
         LA    RE,132+32(R5)                                                    
         SHI   RF,20                                                            
         BNP   *+10                                                             
         SRL   RF,1                                                             
         AR    RE,RF                                                            
*                                                                               
         MVC   0(L'SP@DTLBK,RE),SP@DTLBK   ** DETAIL BACK-UP **                 
         CLI   AGMTITL,C'I'                                                     
         BNE   *+10                                                             
         MVC   0(L'SP@INVBK,RE),SP@INVBK   ** INVOICE BACK-UP **                
BH5      DS    0H                                                               
         MVC   74(10,R4),PINVNO                                                 
         CLI   DUESW,C'R'      AOR BILL                                         
         BNE   *+14                                                             
         MVC   132+58(L'SP@AOR,R4),SP@AOR  ** AOR **                            
         LA    R4,132(R4)                                                       
         CLI   TESTFLAG,C'T'                                                    
         BNE   *+10                                                             
         MVC   132+54(L'SP@TSTBL,R4),SP@TSTBL  **TEST BILLING**                 
*                                                                               
*                                  BILLING ADDR                                 
BH5D     DS    0H                                                               
         L     RF,=A(AORADDR)      USE AOR ADDRESSES                            
         CLI   DUESW,C'R'          FOR AOR BILL                                 
         BE    BH5D4                                                            
*                                  (NB- FOR MULTI-PROD BILL AOR ADDR            
*                                  WILL BE FROM LAST PRD - UNLESS               
*                                  DOING PRD/EST/MOS LIST)                      
         L     RF,=A(BADDRS)                                                    
         BAS   RE,MKGACHK          CHECK IF HAVE MGR ADDR                       
         BE    BH5D6               IF SO, MKGACHK WILL HAVE SET THEM            
         CLI   PROFB4A+13,C'Y'     USE PGROUP ADDRESS REGARDLESS?               
         BE    *+18                                                             
         CLC   APRDBRK,AINVBRK     IF MULTI-PROD BILL                           
         BNH   BH5D3                                                            
         L     RF,=A(AADDRS)       USE AAA ADDRESS                              
*                                                                               
         BAS   RE,PRGACHK          BUT CHECK IF HAVE PGR ADDR                   
         BE    BH5D6               IF SO, PGRACHK WILL HAVE SET THEM            
         B     BH5D4                                                            
*                                                                               
BH5D3    DS    0H                  NOT MULTI-PROD BILL                          
         L     RF,=A(BADDRS)                                                    
         CLI   0(RF),C' '          IF NO PRD ADDRESS                            
         BH    BH5D4                                                            
         CLI   PROFB4A+4,C'Y'      OPTION TO USE AAA                            
         BNE   *+8                                                              
         L     RF,=A(AADDRS)                                                    
*                                                                               
BH5D4    DS    0H                                                               
         MVC   HEAD7+46(60),00(RF)                                              
         MVC   HEAD8+46(60),60(RF)                                              
         MVC   HEAD9+46(60),120(RF)                                             
         MVC   HEAD10+46(60),180(RF)                                            
         MVC   HEAD11+46(60),240(RF)                                            
*                                                                               
BH5D6    DS    0H                                                               
         GOTO1 ABILLEDI,DMCB,('EDMADD',0)   EDI CALL                            
*                                                                               
*                                       PUT CATEGORY HEADS SAVED                
*                                       INTO REAL HEADLINES                     
         LA    R5,MYHEAD1                                                       
         LA    R4,HEAD8                                                         
         LHI   R0,6                                                             
         CLI   AGMFORMS,C'L'       'LONG LOGO' FORMS                            
         BE    BH5F                                                             
         CLI   AGMFORMS,C'B'       'LONG LOGO' FORMS (ADDR IN HEAD 3)           
         BE    BH5F                                                             
         LA    R4,HEAD7                                                         
         LHI   R0,7                                                             
*                                                                               
BH5F     DS    0H                                                               
         MVC   HALF2(1),MYHEAD1+L'MYHEAD1 SAVE FIRST BYTE OF 2ND MYHEAD         
*                                                                               
         CLI   DUESW,C'R'          IF AOR                                       
         BNE   BH6                                                              
         CLI   AORLOPT,C'N'        AND DOING PEP LIST                           
         BE    BH6                                                              
         LHI   R0,1                THEN ONLY CLIENT HEADLINE                    
         MVI   MYHEAD1+L'MYHEAD1,C' '                                           
*                                                                               
BH6      DS    0H                                                               
         L     R3,ADCLT                                                         
         USING CLTHDR,R3                                                        
         OC    CEXTNAME,CEXTNAME   ANY CLIENT EXTENDED NAME?                    
         BZ    BH6F                                                             
         CLC   =C'CLIENT ',0(R5)   CLIENT LABEL?                                
         BNE   BH6F                                                             
         MVC   0(132,R4),SPACES    CLEAR                                        
         MVC   0(13,R4),0(R5)      CLIENT LABEL AND CLT CODE                    
         MVC   13(L'CEXTNAME,R4),CEXTNAME PRINT EXTENDED NAME                   
         B     *+10                                                             
BH6F     MVC   0(L'MYHEAD1,R4),0(R5)                                            
*                                                                               
         LA    R4,132(R4)                                                       
         LA    R5,L'MYHEAD1(R5)                                                 
         BCT   R0,BH6F                                                          
         CLI   0(R5),C' '                                                       
         BNH   *+6                                                              
         DC    H'0'                TOO MANY HEADLINES                           
*                                                                               
         MVC   MYHEAD1+L'MYHEAD1(1),HALF2   RESTORE 1ST BYTE OF 2ND             
*                                            MYHEAD IN CASE IT GOT              
*                                            BLOWN AWAY ABOVE                   
*                                                                               
         CLI   HEAD13,C' '                                                      
         BNE   *+8                                                              
         MVI   HEAD13,0            ENSURE 13 HEADS                              
*                                                                               
         SPACE 3                                                                
         LA    R2,MID1             USE MID LINES FOR COL HEADS                  
         USING ALINED,R2                                                        
         MVI   MID1+131,0          NO COL HEADS ON ADJ BILL                     
         MVI   MID2+131,0                                                       
         CLI   DUESW,C'A'                                                       
*        BE    BH60D                                                            
         BE    BH40                                                             
         CLI   DUESW,C'R'          SPECIAL HEADS ON AOR BILLS                   
         BE    BH36                                                             
         CLI   UPASS,C'S'                                                       
         BNE   BH7                                                              
*                                  RETAIL SUMMARY FORMAT                        
*                                                                               
         MVC   ALCOL3,INVWD1                                                    
         MVC   ALCOL3+132,INVWD2                                                
         MVC   ALCOL4+132,BAMTWD                                                
*                                                                               
         B     BH20                                                             
*                                                                               
BH7      DS    0H                                                               
*                                                                               
* TRANSLATE THE TABLE OF HEADINGS BY THE DICTIONARY ENTRIES.                    
*                                                                               
         MVC   NETWD(L'SP2NET),SP2NET       NET                                 
         MVC   GRSWD,SPACES                                                     
         MVC   GRSWD(L'SP2GROSS),SP2GROSS   GROSS                               
         MVC   ORDWD(L'SP@ONORD),SP@ONORD   ON ORDER                            
         MVC   BDWD(L'SP@BALDU),SP@BALDU    BALANCE DUE                         
         MVC   LPWD(L'SP@LSPRV),SP@LSPRV    LESS PREVIOUS                       
         MVC   BLWD(L'SP@BLNGP),SP@BLNGP    BILLING                             
         MVC   PREVWD(L'SP@PREV),SP@PREV    PREVIOUS                            
         MVC   BNWD(L'SP@BILN),SP@BILN      BILL NUMBER                         
         MVC   BLBLWD(L'SP@BILLA),SP@BILLA  BILLABLE                            
         MVC   PROGWD(L'SP2PRG),SP2PRG      PROGRAM                             
         MVC   DESCWD1(L'SP@ANNC),SP@ANNC   ANNOUNCEMENT                        
         MVC   DESCWD2(L'SP@DTLEN),SP@DTLEN DATE  LENGTH                        
         MVC   COMMWD1(L'SP@AGY),SP@AGY     AGENCY                              
         MVC   COMMWD2(L'SP@COMMS),SP@COMMS COMMISSION                          
         MVC   GAMTWD(L'SPRGRSAM),SPRGRSAM  GROSS AMOUNT                        
         MVC   NAMTWD(L'SPRNETAM),SPRNETAM  NET AMOUNT                          
         MVC   INVWD1(L'SP@CTRL),SP@CTRL    CONTROL                             
         MVC   INVWD2(L'SP@NUM),SP@NUM      NUMBER                              
         MVC   BAMTWD(L'SP@BILAM),SP@BILAM  BILL AMOUNT                         
*                                                                               
         CLI   NOGRSWD,C'Y'        TEST TO SUPPRESS GROSS HEADER                
         BNE   *+16                (NOTE- NOT LANGUAGE SOFT)                    
         MVC   GRSWD,SPACES                                                     
         MVC   GAMTWD,=CL16'        AMOUNT  '                                   
*                                                                               
         CLI   COST2SW,C'Y'        FOR COST2 MAKE SOME ADJUSTMENTS              
         BNE   BH7F                                                             
         MVC   GRSWD,=CL16'       COST TO  '                                    
         MVC   BLBLWD,=CL16'       CLIENT   '                                   
         MVC   ORDWD,=CL16'       CLIENT   '                                    
*                                                                               
BH7F     DS    0H                                                               
         CLI   FORMAT,0                                                         
         BNE   BH8                                                              
*                                  FORMAT 0 - SPOT DETAILS                      
         LA    R3,ALCOL1                                                        
         LA    R4,ALCOL2                                                        
*                                                                               
         MVC   132(16,R3),PROGWD                                                
         MVC   0(16,R4),DESCWD1                                                 
         MVC   132(16,R4),DESCWD2                                               
*                                                                               
         LA    R3,ALCOL3                                                        
         LA    R4,CLMCTLS                                                       
         BAS   RE,BH7MV                                                         
*                                                                               
         LA    R3,ALCOL4                                                        
         LA    R4,1(R4)                                                         
         BAS   RE,BH7MV                                                         
*                                                                               
         LA    R3,ALSTRIP                                                       
         LA    R4,1(R4)                                                         
         BAS   RE,BH7MV                                                         
*                                                                               
         B     BH20                                                             
*                                                                               
BH7MV    DS    0H                                                               
         CLI   0(R4),C'*'          NOTHING                                      
         BER   RE                                                               
         MVC   132(16,R3),GAMTWD   GROSS                                        
         CLI   0(R4),C'G'                                                       
         BER   RE                                                               
         MVC   132(16,R3),NAMTWD   NET                                          
         CLI   0(R4),C'N'                                                       
         BER   RE                                                               
         MVC   132(16,R3),SPWD                                                  
         CLI   0(R4),C'S'                                                       
         BER   RE                                                               
         MVC   0(16,R3),COMMWD1    COMM                                         
         MVC   132(16,R3),COMMWD2                                               
         BR    RE                                                               
*                                                                               
*                                                                               
BH8      DS    0H                                                               
         CLI   FORMAT,1                                                         
         BE    *+16                                                             
         CLI   FORMAT,2            FORMAT 2 - JUST LIKE FORMAT 1...             
         BNE   BH10                ... BUT SUPPRESS 'NET' OR 'GROSS'            
         B     BH8E                ... ON COLUMN 1                              
*                                  FORMAT 1 - ORDERED,PREVIOUS, ETC             
         MVC   ALCOL1,NETWD                                                     
         CLI   GNSW,C'N'                                                        
         BE    *+10                                                             
         MVC   ALCOL1,GRSWD                                                     
*                                                                               
BH8E     MVC   ALCOL1+132,ORDWD                                                 
*                                                                               
         MVC   ALCOL2,PREVWD                                                    
         MVC   ALCOL2+132,BNWD                                                  
*                                                                               
BH9      DS    0H                                                               
         MVC   ALCOL3,LPWD                                                      
         MVC   ALCOL3+132,BLWD                                                  
*                                                                               
         MVC   ALCOL4+132,BDWD                                                  
         B     BH19                                                             
*                                                                               
BH10     DS    0H                                                               
         CLI   FORMAT,5                                                         
         BNE   BH11                                                             
*                                  FORMAT 5 - SPOTS, ORD, ETC                   
         MVC   ALCOL1+132,SPWD                                                  
         MVC   ALCOL2,NETWD                                                     
         CLI   GNSW,C'N'                                                        
         BE    *+10                                                             
         MVC   ALCOL2,GRSWD                                                     
         MVC   ALCOL2+132,ORDWD                                                 
         B     BH9                                                              
*                                                                               
BH11     DS    0H                                                               
         CLI   FORMAT,7                                                         
         BNE   BH11A                                                            
*                                  FORMAT 7 - SPOTS, BALANCE                    
         MVC   ALCOL3+132,SPWD                                                  
         CLI   TAXOPT,C'E'         TAX DETAILS (OPT A-E)                        
         BH    *+16                                                             
         MVC   ALCOL2+132,SPWD                                                  
         MVC   ALCOL3+132,TAXWD                                                 
         MVC   ALCOL4,NETWD                                                     
         CLI   GNSW,C'N'                                                        
         BE    *+10                                                             
         MVC   ALCOL4,GRSWD                                                     
         MVC   ALCOL4+132,BLBLWD                                                
         B     BH19                                                             
*                                                                               
BH11A    DS    0H                                                               
         CLI   FORMAT,8                                                         
         BNE   BH11B                                                            
*                                  FORMAT 8 - BALANCE                           
         CLI   TAXOPT,C'E'         TAX DETAILS (OPT A-E)                        
         BH    *+10                                                             
         MVC   ALCOL2+132,TAXWD                                                 
         MVC   ALCOL3,NETWD                                                     
         CLI   GNSW,C'N'                                                        
         BE    *+10                                                             
         MVC   ALCOL3,GRSWD                                                     
         MVC   ALCOL3+132,BLBLWD                                                
         B     BH19                                                             
*                                                                               
BH11B    DS    0H                                                               
         CLI   FORMAT,9                                                         
         BNE   BH12                                                             
*                                  FORMAT 9 - NET AND GROSS BALANCE             
         CLI   TAXOPT,C'E'         TAX DETAILS (OPT A-E)                        
         BH    *+10                                                             
         MVC   ALCOL2+132,TAXWD                                                 
         MVC   ALCOL3,GRSWD                                                     
         MVC   ALCOL4,NETWD                                                     
         CLI   GNSW,C'N'                                                        
         BE    *+16                                                             
         MVC   ALCOL3,NETWD                                                     
         MVC   ALCOL4,GRSWD                                                     
         MVC   ALCOL3+132,BLBLWD                                                
         MVC   ALCOL4+132,BLBLWD                                                
         B     BH19                                                             
*                                                                               
*                                                                               
BH12     DS    0H                                                               
         CLI   FORMAT,12                                                        
         BH    BH13                                                             
*                                  FORMAT 11 - ORDERED                          
         CLI   TAXOPT,C'E'         TAX DETAILS (OPT A-E)                        
         BH    BH12D                                                            
         LA    RF,ALCOL2+132                                                    
         CLI   FORMAT,11                                                        
         BE    *+8                                                              
         LA    RF,ALCOL3+132                                                    
         MVC   0(16,RF),TAXWD                                                   
*                                                                               
BH12D    DS    0H                                                               
         LA    RF,ALCOL4                                                        
         CLI   FORMAT,11                                                        
         BNE   *+8                                                              
         LA    RF,ALCOL3                                                        
         MVC   0(16,RF),NETWD                                                   
         CLI   GNSW,C'N'                                                        
         BE    *+10                                                             
         MVC   0(16,RF),GRSWD                                                   
         MVC   132(16,RF),ORDWD                                                 
*                                                                               
         CLI   FORMAT,11                                                        
         BE    BH19                                                             
         LA    RF,ALCOL3+132       FORMAT 12 GETS SPOTS                         
         CLI   TAXOPT,C'E'         TAX DETAILS (OPT A-E)                        
         BH    *+8                                                              
         LA    RF,ALCOL2+132                                                    
         MVC   0(16,RF),SPWD                                                    
         B     BH19                                                             
*                                                                               
BH13     DS    0H                                                               
*                                  FORMAT 13 GROSS AND NET                      
         MVC   ALCOL4,NETWD                                                     
         MVC   ALCOL3,GRSWD                                                     
         CLI   GNSW,C'N'                                                        
         BE    *+16                                                             
         MVC   ALCOL4,GRSWD                                                     
         MVC   ALCOL3,NETWD                                                     
         MVC   ALCOL4+132,ORDWD                                                 
         MVC   ALCOL3+132,ORDWD                                                 
*                                                                               
         CLI   TAXOPT,C'E'         TAX DETAILS (OPT A-E)                        
         BH    *+10                                                             
         MVC   ALCOL2+132,TAXWD                                                 
*                                                                               
         CLI   FORMAT,13                                                        
         BE    BH19                                                             
         LA    RF,ALCOL2+132       FORMAT 14 GETS SPOTS                         
         CLI   TAXOPT,C'E'         TAX DETAILS (A-E)                            
         BH    *+8                                                              
         LA    RF,ALCOL1+132                                                    
         MVC   0(16,RF),SPWD                                                    
*                                                                               
BH19     DS    0H                  STRIP                                        
         CLI   STRIPOPT,C'N'       SUPPRESS                                     
         BE    BH20                                                             
*                                                                               
         MVC   96(L'SP@NET,R2),SP@NET                                           
         CLI   GNSW,C'N'                                                        
         BNE   *+10                                                             
         MVC   95(L'SP@GROSS,R2),SP@GROSS                                       
         MVC   132+92(L'SP2BLNG,R2),SP2BLNG   BILLING                           
*                                                                               
         CLI   COMMSW,C'N'                                                      
         BE    BH20                                                             
         MVC   ALSTRIP,COMMWD1     COMMISSION                                   
         MVC   ALSTRIP+132,COMMWD2                                              
         DROP  R2                                                               
*                                                                               
*                                  MONTH OF SERVICE                             
BH20     DS    0H                                                               
         CLI   PERCTL,C'T'                                                      
         BNE   BH22                                                             
         CLI   FORMAT,0            NO BILL PER HEADLINE FOR                     
         BE    BH22                SPOT DETAIL FORMAT                           
         LA    R4,MID1+22                                                       
         CLI   FORMAT,5                                                         
         BNL   *+8                                                              
         LA    R4,MID1+11                                                       
         MVC   0(L'SP@BLNG,R4),SP@BLNG   BILLING                                
         MVC   132(L'SP@PERD,R4),SP@PERD PERIOD                                 
         CLI   MOSOPT,0                                                         
         BNE   BH22                                                             
         CLI   SPOTPROF+2,2        TEST CALENDAR MONTH                          
         BNE   BH22                                                             
         MVC   0(8,R4),=C'CALENDAR'                                             
         MVC   0(L'SP@CALEN,R4),SP@CALEN                                        
         MVC   132(6,R4),=C' MONTH'                                             
         MVC   132(L'SP@MONTH,R4),SP@MONTH                                      
*                                  STATION                                      
BH22     DS    0H                                                               
         CLI   STACTL,C'T'                                                      
         BNE   BH24                                                             
         CLC   ASTABRK,ALOWTOG                                                  
         BH    BH24                                                             
         CLI   PERCTL,C'T'                                                      
         BE    BH22B                                                            
*                                  SINGLE MOS                                   
         LA    R4,MID2+21                                                       
         CLI   FORMAT,5                                                         
         BNL   *+8                                                              
         LA    R4,MID2+10                                                       
         B     BH22D                                                            
*                                  MULTI MOS                                    
BH22B    DS    0H                                                               
         LA    R4,MID2+10                                                       
         CLI   FORMAT,0                                                         
         BE    BH22D                                                            
         CLI   FORMAT,5                                                         
         BNL   *+8                                                              
         LA    R4,MID2+2                                                        
*                                                                               
BH22D    DS    0H                                                               
         MVC   0(L'SP@STATN,R4),SP@STATN  STATION                               
         CLI   QMED,C'N'                                                        
         BNE   *+10                                                             
         MVC   0(L'SP@NTWRK,R4),SP@NTWRK  NETWORK                               
*                                  MARKET                                       
BH24     DS    0H                                                               
         CLI   PRDMKT,C'M'         SKIP IF MKT HIGHER THAN PRD                  
         BE    BH26                                                             
         CLC   AMKTBRK,APAGBRK     ONLY IF TOGETHER ON PAGE                     
         BNH   BH26                                                             
         CLC   AMKTBRK,ALOWTOG                                                  
         BH    BH26                                                             
         CLC   MID2(6),SPACES                                                   
         BE    BH24B                                                            
         MVC   MID1(L'SPAMKT),SPAMKT   MARKET/                                  
         MVI   MID1+L'SPAMKT,C'/'                                               
         B     BH26                                                             
BH24B    DS    0H                                                               
         MVC   MID2(L'SPAMKT),SPAMKT   MARKET                                   
*                                  ESTIMATE                                     
BH26     DS    0H                                                               
         CLC   ALOWTOG,AHITOG      TEST ONLY ONE TOGETHER                       
         BNE   BH40                                                             
*                                  YES - PRINT DESC HERE                        
         MVC   WORK,SPACES                                                      
         L     R0,ALOWTOG                                                       
         C     R0,AESTBRK                                                       
         BNE   *+18                                                             
         MVC   WORK(L'SP@EST),SP@EST                                            
         LA    R6,WORK                                                          
         B     BH28                                                             
*                                                                               
         C     R0,APRDBRK                                                       
         BNE   *+18                                                             
         MVC   WORK(L'SP@PRO),SP@PRO                                            
         LA    R6,WORK                                                          
         B     BH28                                                             
*                                                                               
         LA    R6,MGR1BK                                                        
         C     R0,AMGR1BRK                                                      
         BE    BH28                                                             
         LA    R6,MGR2BK                                                        
         C     R0,AMGR2BRK                                                      
         BE    BH28                                                             
         LA    R6,MGR3BK                                                        
         C     R0,AMGR3BRK                                                      
         BE    BH28                                                             
         LA    R6,PGR1BK                                                        
         C     R0,APGR1BRK                                                      
         BE    BH28                                                             
         LA    R6,PGR2BK                                                        
         C     R0,APGR2BRK                                                      
         BE    BH28                                                             
         LA    R6,PGR3BK                                                        
         C     R0,APGR3BRK                                                      
         BE    BH28                                                             
         B     BH40                                                             
*                                                                               
BH28     DS    0H                                                               
         CLC   MID2(14),SPACES                                                  
         BNE   *+14                                                             
         MVC   MID2(12),0(R6)                                                   
         B     BH40                                                             
*                                                                               
         CLC   10(2,R6),SPACES                                                  
         BNE   *+14                                                             
         MVC   MID2(10),0(R6)                                                   
         B     BH40                                                             
*                                                                               
         GOTO1 CHOPPER,DMCB,(12,0(R6)),(10,MID1),(C'P',2)                       
         B     BH40                                                             
*                                                                               
BH36     DS    0H                  AOR BILLS                                    
         CLI   AORLOPT,C'N'        IF DOING AOR PRD/EST/MOS LIST                
         BE    BH40                NEED SPECIAL HEADS                           
*                                                                               
*        NOTE- UNRELATED WORDS ARE STUPIDLY COMBINED                            
*              HERE IN SINGLE DICTIONARY ENTRIES                                
*                                                                               
         LA    R2,MID1             USE MID LINES FOR COL HEADS                  
         USING ALINED,R2                                                        
         MVC   ALCOL1(L'SP@MTHOF),SP@MTHOF    MONTH OF                          
         MVC   ALCOL3(L'SP1BRAND),SP1BRAND    BRAND                             
         MVC   ALCOL4(L'SP2BRAND),SP2BRAND    BRAND                             
         LA    R2,132(R2)                                                       
         MVC   ALDESC(L'SP@PRO),SP@PRO        PRODUCT                           
         MVC   ALCOL1(L'SP@ESTSV),SP@ESTSV    EST   SERVICE                     
         MVC   ALCOL2+2(L'SP@GRSAM),SP@GRSAM  GROSS AMOUNT                      
         MVC   ALCOL3(L'SP@AGYBS),SP@AGYBS    AGENCY%  BASIS                    
         MVC   ALCOL4(L'SP@AGYAM),SP@AGYAM    AGENCY AMOUNT                     
         MVC   ALSTRIP(L'SP@BASAM),SP@BASAM   BASIS AMOUNT                      
         CLI   AORNOPT,C'Y'                 SHOWING NET INSTEAD?                
         BNE   *+16                                                             
         MVC   ALCOL2+2(L'SP@GRSAM),SPACES    CLEAR GROSS                       
         MVC   ALCOL2+3(L'SP@NETAM),SP@NETAM                                    
         B     BHX                 FOR AOR LIST, SKIP BILLING PERIOD            
         DROP  R2                                                               
*                                                                               
BH40     DS    0H                                                               
         CLI   PERCTL,C'S'                                                      
         BE    BH42                                                             
         CLI   PERCTL,C'N'                                                      
         BE    BH42                                                             
         CLI   DUESW,C'A'                                                       
         BNE   BHX                                                              
         B     BH60D                                                            
*                                                                               
BH42     LA    R5,BQSTARTP-2                                                    
         CLI   PARTIAL,C'Y'        PARTIAL MONTH                                
         BE    BH46                                                             
         CLI   XPERSW,C'Y'         OR CROSS PERIOD BILLS                        
         BE    BH46                SHOW START-END                               
         L     RF,APER                                                          
         ZIC   R5,0(RF)                                                         
         LA    R5,PERLIST(R5)                                                   
         USING PERLISTD,R5                                                      
         CLI   SPOTPROF+2,0        FOR OTHER THAN BROADCAST MONTHS              
         BNE   BH46                DISPLAY START - END                          
         CLI   MOSOPT,0            SPECIAL PERIODS                              
         BNE   BH46                                                             
*                                                                               
         LA    R4,HEAD13                                                        
         MVC   46(L'SP@MTHSV,R4),SP@MTHSV  MONTH OF SERVICE                     
         GOTO1 DATCON,DMCB,(3,PERLMOS),(6,64(R4))   MMM/YY                      
         CLI   DUESW,C'A'                                                       
         BNE   BHX                                                              
         B     BH60D                                                            
BH46     DS    0H                                                               
         LA    R4,HEAD12                                                        
         LA    R6,132+46(R4)                                                    
         CLI   HEAD11+46,C' '      TEST LAST ADDRESS LINE USED                  
         BNH   *+8                                                              
         LA    R4,HEAD12           WAS HEAD13                                   
         MVC   46(L'SP@BILPR,R4),SP@BILPR                                       
         CLI   XPERSW,C'Y'         FOR CROSS PERIOD REQUESTS                    
         BNE   *+16                                                             
         LA    R0,SVQSTART         SHOW REQUESTED START                         
         ST    R0,DMCB             (TYPE 0 DATE)                                
         B     *+16                                                             
         LA    R0,PERLSTRT         ELSE USE PERLST DATE                         
         ST    R0,DMCB                                                          
         MVI   DMCB,2                                                           
*                                                                               
         GOTO1 DATCON,DMCB,,(5,0(R6))                                           
         MVC   9(L'SP@THRU,R6),SP@THRU                                          
         LA    R6,9+L'SP@THRU(R6)                                               
         CLI   0(R6),C' '                                                       
         BH    *+8                                                              
         BCT   R6,*-8                                                           
*                                                                               
         CLI   XPERSW,C'Y'         FOR CROSS PERIOD REQUESTS                    
         BNE   *+16                                                             
         LA    R0,SVQEND           SHOW REQUESTED END                           
         ST    R0,DMCB             (TYPE 0 DATE)                                
         B     *+16                                                             
         LA    R0,PERLEND          ELSE USE PERLST DATE                         
         ST    R0,DMCB                                                          
         MVI   DMCB,2                                                           
*                                                                               
         GOTO1 DATCON,DMCB,,(5,2(R6))                                           
         CLI   DUESW,C'A'                                                       
         BNE   BHX                                                              
         B     BH60D                                                            
         DROP  R5                                                               
         EJECT                                                                  
         SPACE 2                                                                
*                             HERE FROM DUMMY NON-PRINTING HEADLINE             
*                             SETTING REPORT CALL                               
*                             SAVE NEEDED LINES                                 
BH50     DS    0H                                                               
*                                        ADJUST EST LINE IF NECESSARY           
         CLC   AESTBRK,APAGBRK     TEST EST TO BE IN MY HEADLINES               
         BH    BH51B                NO                                          
         CLC   =C'NO',QEST         FOR NO                                       
         BE    *+12                                                             
         CLI   QESTEND,C' '        AND RANGE                                    
         BE    BH51B                                                            
*                                  STATE ESTIMATE                               
         MVC   HEAD6,SPACES                                                     
         MVC   HEAD6(L'SP@EST),SP@EST ESTIMATE                                  
         MVC   HEAD6+9(3),EST                                                   
         MVC   HEAD6+13(24),ESTNM                                               
*                                                                               
BH51B    DS    0H                                                               
         CLI   QMED,C'N'           FOR NETWORK                                  
         BNE   BH52                                                             
         MVC   HEAD11(L'SP@NTWRK),SP@NTWRK  STATION=>NETWORK                    
         ICM   RE,15,ANET          ARE WE DOING NETWORKS                        
         BZ    BH52                                                             
         SHI   RE,2                                                             
         GOTO1 MSUNPK,DMCB,(RE),FULL,DUB  YES, SHOW NETWORK                     
         MVC   HEAD11+8(4),DUB            INSTEAD OF STATION                    
         MVC   HEAD11+12(6),SPACES        CLEAR OUT POSSIBLE JUNK               
         DROP  R7                                                               
*                                                                               
BH52     DS    0H                                                               
*                                  ADD CLT INTERFACE NO AFTER CLT NME           
         CLI   AGMCLNO,C'Y'        Y OR C MEANS YES                             
         BE    *+12                                                             
         CLI   AGMCLNO,C'C'                                                     
         BNE   BH52D                                                            
*                                                                               
         L     R7,ADCLT                                                         
         LA    R7,CCLTIFC-CLTHDR(R7)                                            
         CLI   0(R7),C' '          TEST NUMBER USED                             
         BNH   BH52D                                                            
*                                                                               
         LA    RF,HEAD1+45                                                      
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVI   3(RF),C'('                                                       
         MVC   4(8,RF),0(R7)                                                    
         LA    RF,8+4(RF)                                                       
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVI   1(RF),C')'                                                       
*                                                                               
BH52D    DS    0H                                                               
*                                  ADD ACCT NO AFTER PRD NAME                   
         CLI   AGMCLNO,C'C'        C OR X MEANS NO                              
         BE    BH53                                                             
         CLI   AGMCLNO,C'X'                                                     
         BE    BH53                                                             
*                                                                               
         L     R7,ADPRD                                                         
         MVC   FULL,PACCT-PRDHDR(R7)                                            
         CLI   FULL,C' '                                                        
         BNH   BH53                                                             
         CLC   FULL,=C'0000'                                                    
         BE    BH53                                                             
         OC    FULL+1(3),FULL+1                                                 
         BZ    BH53                                                             
         LA    R7,HEAD5+45                                                      
         CLI   0(R7),C' '                                                       
         BH    *+8                                                              
         BCT   R7,*-8                                                           
         MVI   3(R7),C'('                                                       
         MVC   4(4,R7),FULL                                                     
         MVI   8(R7),C')'                                                       
         CLI   FULL,X'FF'                                                       
         BNE   *+14                                                             
         UNPK  4(5,R7),FULL+1(3)                                                
         MVI   9(R7),C')'                                                       
*                                                                               
BH53     DS    0H                                                               
         MVI   BYTE,0                                                           
         OC    AMGR1BRK,AMGR1BRK        TEST MGR'S IN HEADLINE                  
         BZ    *+18                     NO                                      
         CLC   AMGR1BRK,APAGBRK                                                 
         BH    *+8                      NO                                      
         OI    BYTE,X'40'               YES                                     
*                                                                               
         OC    APGR1BRK,APGR1BRK        TEST PGR'S IN HEADLINE                  
         BZ    *+18                     NO                                      
         CLC   APGR1BRK,APAGBRK                                                 
         BH    *+8                      NO                                      
         OI    BYTE,X'80'               YES                                     
*                                                                               
         CLI   BYTE,0              NO MGRS AND NO PGRS                          
         BNE   *+14                                                             
         CLC   AMKTBRK,APAGBRK     AND NO MKT                                   
         BH    BH53Z               NO NEED FOR ALIGNING                         
*                                                                               
*                                  FIRST ALIGN ALL FIELDS LIKE PGRS             
*                                  AND MGRS- DESC(12),CODE(5)                   
         MVC   X(45),HEAD6         SAVE EST MEADLINE                            
         LA    R6,HEAD1            CLT                                          
         BAS   RE,BHMVR                                                         
         LA    R6,HEAD5            PRD                                          
         BAS   RE,BHMVR                                                         
         CLC   AESTBRK,APAGBRK                                                  
         BH    *+12                                                             
         LA    R6,HEAD6            DONT REALIGN EST                             
         BAS   RE,BHMVR                                                         
*                                                                               
         MVC   WORK,HEAD10         MKT                                          
         MVC   HEAD10+7(40),SPACES                                              
         MVC   HEAD10+13(4),WORK+7                                              
         MVC   HEAD10+20(24),WORK+12                                            
*                                  FIND MAXIMUM CODE LENGTH                     
         LHI   R6,3                AT LEAST 3                                   
         CLC   AMKTBRK,APAGBRK                                                  
         BH    *+8                                                              
         LHI   R6,4                4 FOR MARKET                                 
         TM    BYTE,X'80'          TEST HAVE PGRS                               
         BZ    BH53F               NO                                           
         ZIC   RF,PGR3LEN                                                       
         LA    RF,1(RF)                                                         
         CR    RF,R6                                                            
         BNH   *+6                                                              
         LR    R6,RF                                                            
*                                                                               
BH53F    DS    0H                                                               
         TM    BYTE,X'40'          TEST HAVE MGRS                               
         BZ    BH53H               NO                                           
         ZIC   RF,MGR3LEN                                                       
         LA    RF,1(RF)                                                         
         CR    RF,R6                                                            
         BNH   *+6                                                              
         LR    R6,RF                                                            
*                                                                               
BH53H    DS    0H                                                               
         LA    R7,HEAD1+20                                                      
         LA    R5,HEAD1+15(R6)     TO ADDR                                      
*                                                                               
         LHI   R0,10                                                            
BH53J    DS    0H                                                               
         MVC   0(40,R5),0(R7)                                                   
         LA    R5,132(R5)                                                       
         LA    R7,132(R7)                                                       
         BCT   R0,BH53J                                                         
*                                                                               
*                                  FIND MAX DESC LEN                            
         LHI   R6,8                AT LEAST 8                                   
         TM    BYTE,X'80'          TBST HAVE PGRS                               
         BZ    BH53N               NO                                           
         LA    R7,PGR1BK                                                        
         BAS   RE,BHGETLEN                                                      
         LA    R7,PGR2BK                                                        
         BAS   RE,BHGETLEN                                                      
         LA    R7,PGR3BK                                                        
         BAS   RE,BHGETLEN                                                      
*                                                                               
BH53N    DS    0H                                                               
         TM    BYTE,X'40'          TEST HAVE MGRS                               
         BZ    BH53P               NO                                           
         LA    R7,MGR1BK                                                        
         BAS   RE,BHGETLEN                                                      
         LA    R7,MGR2BK                                                        
         BAS   RE,BHGETLEN                                                      
         LA    R7,MGR3BK                                                        
         BAS   RE,BHGETLEN                                                      
*                                                                               
BH53P    DS    0H                                                               
         CHI   R6,12               IF MAX LEN 12                                
         BE    BH53T               NO ALIGNING NEEDED                           
*                                                                               
         LA    R7,HEAD1+13         FROM ADDR                                    
         LA    R5,HEAD1+1(R6)      TO ADDR                                      
         LHI   R0,10                                                            
BH53R    DS    0H                                                               
         MVC   0(50,R5),0(R7)                                                   
         LA    R5,132(R5)                                                       
         LA    R7,132(R7)                                                       
         BCT   R0,BH53R                                                         
*                                                                               
BH53T    DS    0H                                                               
*                                  RESTORE ESTIMATE LINE                        
         CLC   AESTBRK,APAGBRK     NOT IF SEP EST PER PAGE                      
         BNH   BH53Z                                                            
         CLC   QESTEND,SPACES      ONLY IF RANGE OR FILTERS                     
         BE    BH53Z                                                            
         MVC   HEAD6(45),X                                                      
         B     BH53Z                                                            
         SPACE 2                                                                
BHGETLEN DS    0H                  GET LENGTH OF DESC                           
*                                  AND SAVE HIGHEST IN R6                       
         SR    R0,R0                                                            
         CLI   0(R7),C' '                                                       
         BNHR  RE                                                               
         LA    RF,11(R7)                                                        
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         SR    RF,R7                                                            
         LA    RF,1(RF)                                                         
         CR    RF,R6                                                            
         BNHR  RE                                                               
         LR    R6,RF                                                            
         BR    RE                                                               
         SPACE 2                                                                
BHMVR    DS    0H                  ALIGN AS DESC(12),CODE(5)                    
         MVC   WORK,0(R6)                                                       
         MVC   9(40,R6),SPACES                                                  
         MVC   13(3,R6),WORK+9                                                  
         MVC   20(30,R6),WORK+13                                                
         BR    RE                                                               
         SPACE 2                                                                
BH53Z    DS    0H                                                               
*                                                                               
*                                  CLEAR MYHEADS                                
         LA    R4,MYHEADS                                                       
         LA    R0,(MYHEADSX-MYHEADS)/L'MYHEAD1                                  
         MVC   0(L'MYHEAD1,R4),SPACES                                           
         LA    R4,L'MYHEAD1(R4)                                                 
         BCT   R0,*-10                                                          
*                                                                               
         LA    R4,MYHEADS                                                       
         MVC   MYHEAD1,HEAD1       CLIENT                                       
*                                                                               
         LA    R4,L'MYHEAD1(R4)                                                 
         L     R3,ABRKTAB                                                       
         USING BRKTABD,R3                                                       
*                                                                               
BH54     DS    0H                                                               
         OC    BRKCODE,BRKCODE                                                  
         BZ    BH60                                                             
         CLI   BRKCODE+3,STAEQ*4   BYPASS BREAKS 'BELOW' STA                    
         BH    BH55                                                             
*                                                                               
         CLI   UPASS,C'S'          TEST RETAIL SUMMARY PASS                     
         BE    *+16                                                             
         C     R3,APAGBRK          FOR REG BULL PAGBRK IS LIMIT                 
         BH    BH56                                                             
         B     BH54B                                                            
*                                  FOR SUMMARY PASS - USE LEVCTLS               
         LA    RF,LEVCTLS                                                       
         A     RF,BRKCODE                                                       
         CLI   0(RF),C'S'          SEPARATE                                     
         BE    BH54B                                                            
         CLI   0(RF),C'P'          OR PAGE BREAK                                
         BNE   BH56                                                             
BH54B    DS    0H                                                               
         L     RF,BRKCODE          INDEX INTO HEADLINES                         
         CLI   BRKCODE+3,STAEQ*4   BUT STRAIGHTEN OUT                           
         BNE   *+8                 NETWORK AND STATION                          
         LHI   RF,NETEQ*4                                                       
         MHI   RF,33               132/4 = INDEX INTO HEADS                     
         LA    RF,HEAD1(RF)         POINT TO PROPER HEADLINES                   
         MVC   0(L'MYHEAD1,R4),0(RF)                                            
         LA    R4,L'MYHEAD1(R4)    NEXT LINE                                    
BH55     DS    0H                                                               
         LA    R3,BRKL(R3)         NEXT LEVEL                                   
         B     BH54                                                             
BH56     DS    0H                                                               
         C     R3,AESTBRK                                                       
         BNE   BH55                                                             
*                                  EVEN IF EST NOT ON BILL                      
*                                  PUT IT IN HEADS                              
         MVC   0(L'MYHEAD1,R4),HEAD6                                            
         B     BH55                                                             
*                                                                               
BH60     DS    0H                  WB FLIGHT                                    
         ICM   RE,15,AFLT          SHOULD BE SEPARATE                           
         BZ    BH60D                                                            
         CLI   0(R4),C' '          IS THIS LINE USED?                           
         BNH   *+8                                                              
         LA    R4,L'MYHEAD1(R4)                                                 
         MVC   0(9,R4),=C'WB FLIGHT'                                            
         MVC   15(10,R4),0(RE)                                                  
         LA    R4,L'MYHEAD1(R4)                                                 
*                                                                               
*        PRINT USER FIELDS IN HEADLINES (IF THERE'S ROOM)                       
*                                                                               
BH60D    CLI   ESTCTL,C'S'     MUST BE SEPARATE                                 
         BNE   BH70                                                             
*                                                                               
         CLI   PRDCTL,C'S'     AND PRD TOO (NOT READING POL HERE)               
         BNE   BH70                                                             
*                                                                               
         CLI   DUESW,C'A'      IF ADJ INVOICE OVERRIDE UDEFS                    
         BNE   BH60D3                                                           
         OC    SAVREG,SAVREG   WAS THERE SPACE FOR UDEFS ON MAIN BILL?          
         BZ    BH70            NO, DONE                                         
*                                  CLEAR MYHEADS                                
         ICM   R4,15,SAVREG                                                     
         C     R4,=A(MYHEADSX)                                                  
         BNL   *+18                                                             
         MVC   0(L'MYHEAD1,R4),SPACES                                           
         LA    R4,L'MYHEAD1(R4)                                                 
         B     *-18                                                             
*                                                                               
         ICM   R4,15,SAVREG           RE-POINT R4 TO HEADLINE                   
         B     BH60D5                                                           
*                                                                               
BH60D3   XC    SAVREG,SAVREG                                                    
         C     R4,=A(MYHEADSX)                                                  
         BNL   BH70                                                             
         CLC   0(L'MYHEAD1,R4),SPACES                                           
         BNE   BH70                                                             
         STCM  R4,15,SAVREG       SAVE ADDRESS OF 1ST AVAIL LINE                
BH60D5   MVC   WORK,SPACES                                                      
         GOTO1 =V(GETUSER),DMCB,(C'B',ADCLT),(C'P',ADPRD),(C':',WORK),0         
         TM    DMCB+4,X'11'          PRINT ON BILLING IN HEADLINES?             
         BNO   BH60F                                                            
         CLI   ADJSEP,C'Y'           BELOW APLLIES TO SEP ADJ INVOICES          
         BNE   BH60D7                                                           
         CLI   DMCB+8,C'R'           MAIN BILL COMMENT?                         
         BNE   *+16                                                             
         CLI   DUESW,C'A'            THEN MAKE SURE NOT COMM INVOICE            
         BE    BH60F                                                            
         B     *+20                                                             
*                                                                               
         CLI   DMCB+8,C'F'           COMM BILL COMMENT?                         
         BNE   *+12                                                             
         CLI   DUESW,C'A'            THEN MAKE SURE NOT REG INVOICE             
         BNE   BH60F                                                            
*                                                                               
BH60D7   MVC   0(L'MYHEAD1,R4),WORK  USER1 PRODUCT                              
         LA    R4,L'MYHEAD1(R4)      BUMP TO NEXT LINE                          
*                                                                               
BH60F    C     R4,=A(MYHEADSX)                                                  
         BNL   BH70                                                             
         CLC   0(L'MYHEAD1,R4),SPACES                                           
         BNE   BH70                                                             
         MVC   WORK,SPACES                                                      
         GOTO1 =V(GETUSER),DMCB,(C'B',ADCLT),(C'P',ADPRD),0,(C':',WORK)         
         TM    DMCB+6,X'11'          PRINT ON BILLING IN HEADLINES?             
         BNO   BH60H                                                            
         CLI   ADJSEP,C'Y'           BELOW APLLIES TO SEP ADJ INVOICES          
         BNE   BH60F5                                                           
         CLI   DMCB+9,C'R'           MAIN BILL COMMENT?                         
         BNE   *+16                                                             
         CLI   DUESW,C'A'            THEN MAKE SURE NOT COMM INVOICE            
         BE    BH60H                                                            
         B     *+20                                                             
*                                                                               
         CLI   DMCB+9,C'F'           COMM BILL COMMENT?                         
         BNE   *+12                                                             
         CLI   DUESW,C'A'            THEN MAKE SURE NOT REG INVOICE             
         BNE   BH60H                                                            
*                                                                               
BH60F5   MVC   0(L'MYHEAD1,R4),WORK  USER2 PRODUCT                              
         LA    R4,L'MYHEAD1(R4)      BUMP TO NEXT LINE                          
*                                                                               
BH60H    C     R4,=A(MYHEADSX)                                                  
         BNL   BH70                                                             
         CLC   0(L'MYHEAD1,R4),SPACES                                           
         BNE   BH70                                                             
         MVC   WORK,SPACES                                                      
         GOTO1 =V(GETUSER),DMCB,(C'B',ADCLT),(C'E',ADEST),(C':',WORK),0         
         TM    DMCB+4,X'11'          PRINT ON BILLING IN HEADLINES?             
         BNO   BH60J                                                            
         CLI   ADJSEP,C'Y'           BELOW APPLIES TO SEP ADJ INVOICES          
         BNE   BH60H5                                                           
         CLI   DMCB+8,C'R'           MAIN BILL COMMENT?                         
         BNE   *+16                                                             
         CLI   DUESW,C'A'            THEN MAKE SURE NOT COMM INVOICE            
         BE    BH60J                                                            
         B     *+20                                                             
*                                                                               
         CLI   DMCB+8,C'F'           COMM BILL COMMENT?                         
         BNE   *+12                                                             
         CLI   DUESW,C'A'            THEN MAKE SURE NOT REG INVOICE             
         BNE   BH60J                                                            
*                                                                               
BH60H5   MVC   0(L'MYHEAD1,R4),WORK  USER1 ESTIMATE                             
         LA    R4,L'MYHEAD1(R4)      BUMP TO NEXT LINE                          
*                                                                               
BH60J    C     R4,=A(MYHEADSX)                                                  
         BNL   BH70                                                             
         CLC   0(L'MYHEAD1,R4),SPACES                                           
         BNE   BH70                                                             
         MVC   WORK,SPACES                                                      
         GOTO1 =V(GETUSER),DMCB,(C'B',ADCLT),(C'E',ADEST),0,(C':',WORK)         
         TM    DMCB+6,X'11'          PRINT ON BILLING IN HEADLINES?             
         BNO   BH70                                                             
         CLI   ADJSEP,C'Y'           BELOW APLLIES TO SEP ADJ INVOICES          
         BNE   BH60J5                                                           
         CLI   DMCB+9,C'R'           MAIN BILL COMMENT?                         
         BNE   *+16                                                             
         CLI   DUESW,C'A'            THEN MAKE SURE NOT COMM INVOICE            
         BE    BH70                                                             
         B     *+20                                                             
*                                                                               
         CLI   DMCB+9,C'F'           COMM BILL COMMENT?                         
         BNE   *+12                                                             
         CLI   DUESW,C'A'            THEN MAKE SURE NOT REG INVOICE             
         BNE   BH70                                                             
BH60J5   MVC   0(L'MYHEAD1,R4),WORK  USER2 ESTIMATE                             
*                                                                               
BH70     DS    0H                                                               
         CLI   DUESW,C'A'      IF ADJ INVOICE OVERRIDE UDEFS                    
         BNE   BHX                                                              
         LA    R5,MYHEAD1                                                       
         LA    R4,HEAD8                                                         
         LHI   R0,6                                                             
         CLI   AGMFORMS,C'L'       'LONG LOGO' FORMS                            
         BE    BH70C                                                            
         CLI   AGMFORMS,C'B'       'LONG LOGO' FORMS (ADDR IN HEAD 3)           
         BE    BH70C                                                            
         LA    R4,HEAD7                                                         
         LHI   R0,7                                                             
*                                                                               
BH70C    DS    0H                                                               
         MVC   0(L'MYHEAD1,R4),0(R5)                                            
         LA    R4,132(R4)                                                       
         LA    R5,L'MYHEAD1(R5)                                                 
         BCT   R0,BH70C                                                         
         CLI   0(R5),C' '                                                       
         BNH   *+6                                                              
         DC    H'0'                TOO MANY HEADLINES                           
*                                                                               
         B     BHX                                                              
         DROP  R3                                                               
         SPACE 2                                                                
*                             INVOICE REGISTER HEADLINES                        
         SPACE 2                                                                
BH80     DS    0H                                                               
         CLI   TESTFLAG,C'T'                                                    
         BNE   *+14                                                             
         L     RF,=A(DICSECT)      DICTIONARY CSECT                             
         USING DICSECT,RF                                                       
         MVC   HEAD9+40(L'SP@TSTBL),SP@TSTBL    **** TEST BILLING ****          
*                                                                               
         CLI   MIDAS,C'Y'         FOR MIDAS OVERRIDE SOME FLDS ON IREG          
         BNE   BHX                                                              
         MVC   MID1+94(5),=C'MIDAS'                                             
         MVC   MID2+89(31),=C'  COMMISSION       TRADE CREDIT'                  
****     MVC   MID2+89(40),=C'  COMMISSION       TRADE CREDIT    GROSS'         
         DROP  RF                                                               
         SPACE 2                                                                
BHX      DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
*        PGRACHK - TRY FOR PRODUCT GROUP ADDRESS                                
*                                                                               
PRGACHK  NTR1                                                                   
         CLI   PGR1CTL,C'S'        ONLY IF PGR SEP                              
         BNE   PRGANO                                                           
         L     R2,ADPRDGRP                                                      
         LA    R2,PRGEL-PRGRECD(R2)                                             
*                                                                               
PRGA2    DS    0H                                                               
         CLI   0(R2),0             EOR                                          
         BE    PRGANO                                                           
         CLI   0(R2),X'20'         ADDRESS ELEM                                 
         BNE   PRGA4                                                            
         USING PRGEL20,R2                                                       
*                                                                               
         CLC   PRGADDR1,SPACES                                                  
         BNH   PRGANO                                                           
         MVC   HEAD7+46(L'PRGADDR1),PRGADDR1                                    
         MVC   HEAD8+46(L'PRGADDR2),PRGADDR2                                    
         MVC   HEAD9+46(L'PRGADDR3),PRGADDR3                                    
         MVC   HEAD10+46(L'PRGADDR4),PRGADDR4                                   
         B     PRGAYES                                                          
*                                                                               
PRGA4    DS    0H                                                               
         ZIC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     PRGA2                                                            
         DROP  R2                                                               
*                                                                               
PRGAYES  CR    RE,RE               SET CC = IF FOUND ADDRESS                    
         B     PRGAX                                                            
PRGANO   LTR   RD,RD               SET CC NOT = IF NO ADDRESS                   
PRGAX    DS    0H                                                               
         XIT1                                                                   
*        MGRACHK - TRY FOR MARKET GROUP ADDRESS                                 
*                                                                               
MKGACHK  NTR1                                                                   
         CLI   MGR1CTL,C'S'        ONLY IF MGR SEP                              
         BNE   MKGANO                                                           
         L     R2,ADMKTGRP                                                      
         LA    R2,MKGEL-MKGRECD(R2)                                             
*                                                                               
MKGA2    DS    0H                                                               
         CLI   0(R2),0             EOR                                          
         BE    MKGANO                                                           
         CLI   0(R2),X'30'         ADDRESS ELEM                                 
         BNE   MKGA4                                                            
         USING MKGEL30,R2                                                       
*                                                                               
         CLC   MKGADDR1,SPACES                                                  
         BNH   MKGANO                                                           
         MVC   HEAD7+46(L'MKGADDR1),MKGADDR1                                    
         MVC   HEAD8+46(L'MKGADDR2),MKGADDR2                                    
         MVC   HEAD9+46(L'MKGADDR3),MKGADDR3                                    
         MVC   HEAD10+46(L'MKGADDR4),MKGADDR4                                   
         B     MKGAYES                                                          
*                                                                               
MKGA4    DS    0H                                                               
         ZIC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     MKGA2                                                            
         DROP  R2                                                               
*                                                                               
MKGAYES  CR    RE,RE               SET CC = IF FOUND ADDRESS                    
         B     MKGAX                                                            
MKGANO   LTR   RD,RD               SET CC NOT = IF NO ADDRESS                   
MKGAX    DS    0H                                                               
         XIT1                                                                   
*                                  WORDS FOR HEADLINES                          
NETWD    DC    C'         NET    '                                              
GRSWD    DC    C'        GROSS   '                                              
ORDWD    DC    C'      ON ORDER  '                                              
BDWD     DC    C'   BALANCE DUE  '                                              
LPWD     DC    C' LESS PREVIOUS  '                                              
BLWD     DC    C'    BILLING     '                                              
PREVWD   DC    C'     PREVIOUS   '                                              
BNWD     DC    C'   BILL NUMBER  '                                              
BLBLWD   DC    C'      BILLABLE  '                                              
PROGWD   DC    C' PROGRAM        '                                              
DESCWD1  DC    C'   ANNOUNCEMENT '                                              
DESCWD2  DC    C'   DATE  LENGTH '                                              
COMMWD1  DC    C'      AGENCY    '                                              
COMMWD2  DC    C'    COMMISSION  '                                              
GAMTWD   DC    C'  GROSS AMOUNT  '                                              
NAMTWD   DC    C'    NET AMOUNT  '                                              
INVWD1   DC    C'       CONTROL  '                                              
INVWD2   DC    C'        NUMBER  '                                              
BAMTWD   DC    C'   BILL AMOUNT  '                                              
TAXWD    DC    C'                '    **NO-OP TAX AS COLUMN HEAD**              
*                                                                               
SPWD     DS    CL16                                                             
*                                                                               
SAVER8   DS    F                                                                
SAVERA   DS    F                                                                
*                                                                               
MYHEAD1  DS    0CL45                                                            
MYHEADS  DS    CL405                                                            
MYHEADSX EQU   *                                                                
         SPACE 3                                                                
         LTORG                                                                  
         SPACE 2                                                                
         DROP  R9                                                               
         TITLE 'PRNT - PRINT CONTROL MODULE'                                    
PRNT     NMOD1 0,BILLPRNT                                                       
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         MVC   SAVMODE,MODE                                                     
         MVI   MODE,0              LET REPORT DO ALL LEVELS OF HEADS            
         CLI   RCSUBPRG,100        SPECIAL TO GET CATEGORY HEADS                
         BNE   PRNT4               AND NOT PRINT ANYTHING                       
         CLI   RD1OPT,C'E'         SKIP IF RETAIL DRAFT ERROR MODE              
         BE    PRNT4                                                            
*                                                                               
         MVC   MIDHOOK,=A(BILHEAD)                                              
         XC    HEADHOOK,HEADHOOK                                                
         MVI   FORCEHED,C'N'                                                    
         MVI   LINE,0                                                           
         MVI   FORCEMID,C'Y'                                                    
*                                  CLEAR ALL P'S                                
         LA    R1,P                                                             
         LHI   R0,14                                                            
         MVC   0(132,R1),SPACES                                                 
         LA    R1,132(R1)                                                       
         BCT   R0,*-10                                                          
*                                                                               
         GOTO1 REPORT                                                           
         MVI   RCSUBPRG,0                                                       
         XC    MIDHOOK,MIDHOOK                                                  
         B     PRNTX                                                            
         SPACE 2                                                                
PRNT4    DS    0H                                                               
         CLI   SAVMODE,RUNLAST                                                  
         BE    PRNT4B                                                           
         MVI   RCSUBPRG,10                                                      
         CLI   RETDRAFT,C'Y'       RETAIL DRAFT                                 
         BNE   PRNT4B                                                           
         MVI   RCSUBPRG,30                                                      
*                                                                               
PRNT4B   DS    0H                                                               
         MVC   HEADHOOK,=A(BILHEAD)                                             
         CLI   PRSW,C'C'           CLEAR LINES                                  
         BE    PRNT24                                                           
         CLI   SORTTRCE,C'Y'                                                    
         BE    PRNT6                                                            
         CLI   SORTTRCE,C'O'                                                    
         BE    PRNT6                                                            
         CLI   PRSW,C'N'                                                        
         BNE   PRNT8                                                            
*                                                                               
         CLI   RD1OPT,C'E'         IF RETAIL DRAFT ERROR ONLY MODE              
         BNE   PRNT6                                                            
         CLI   UPASS,C'T'          MUST BE TEST PASS TO PRINT                   
         BNE   PRNTX                                                            
         MVI   SPACING,0           NO SPACING                                   
         MVI   FORCEHED,C'N'       OR NEW PAGES                                 
PRNT6    DS    0H                                                               
         GOTO1 REPORT                                                           
         B     PRNTX                                                            
*                                                                               
PRNT8    DS    0H                                                               
         CLI   RD1OPT,C'E'         IF RETAIL DRAFT ERROR MODE                   
         BE    PRNT25              DONE                                         
*                                                                               
         CLI   PRSW,C'F'                                                        
         BE    PRNT20                                                           
*                                  HOLD PRINT LINES                             
*                                  ----------------                             
*                                                                               
         CLI   PRSW,C'M'           TEST 'MERGE UP'                              
         BNE   PRNT8W                                                           
*                                                                               
         CLC   P2,SPACES           MUST BE SINGLE LINE                          
         BNE   PRNT8W                                                           
         CLC   P(21),SPACES        BLANK IN DESC                                
         BNE   PRNT8W                                                           
         CLC   P,SPACES            NON-SPACES                                   
         BE    PRNT8W                                                           
*                                                                               
         SR    R4,R4                                                            
         L     R2,ANXTLIN                                                       
PRNT8F   DS    0H                                                               
         SHI   R2,132                                                           
         C     R2,=A(LINTAB)       BEFORE START                                 
         BL    PRNT8M                                                           
         CLC   21(111,R2),SPACES   COLUMNS CLEAR                                
         BNE   PRNT8M                                                           
         CLC   0(21,R2),SPACES     DESC NOT CLEAR                               
         BE    PRNT8M                                                           
*                                                                               
         LR    R4,R2               SAVE A(LINE)                                 
         B     PRNT8F                                                           
PRNT8M   DS    0H                                                               
         LTR   R4,R4               NO LINE IS OK FOR MERGE                      
         BZ    PRNT8W                                                           
*                                                                               
         MVC   21(111,R4),P+21     MERGE LINES                                  
         MVC   P,SPACES                                                         
         CLI   SPACING,1                                                        
         BNH   PRNTX                                                            
         L     R2,ANXTLIN          MULT SPACING AFTER MERGE                     
         B     PRNT10                                                           
         B     PRNTX                                                            
*                                  NORMAL - ADD TO LINE BUFFER                  
*                                  ---------------------------                  
PRNT8W   DS    0H                                                               
         LHI   R0,14                                                            
         L     R1,=A(LINTABX)      END OF LINTAB                                
         L     R2,ANXTLIN                                                       
         LA    R4,P                                                             
PRNT9    DS    0H                                                               
         CLC   0(132,R4),SPACES                                                 
         BE    PRNT10                                                           
         MVC   0(132,R2),0(R4)                                                  
         MVC   0(132,R4),SPACES    CLEAR LINE                                   
         LA    R2,132(R2)                                                       
         CR    R2,R1               PAST THE END ?                               
         BL    *+6                                                              
         DC    H'0'                                                             
         LA    R4,132(R4)                                                       
         BCT   R0,PRNT9                                                         
PRNT10   DS    0H                  ADJUST FOR SPACING                           
         CLI   SPACING,2                                                        
         BL    PRNT11                                                           
         ZIC   R0,SPACING                                                       
         BCTR  R0,0                                                             
         MVI   0(R2),0                                                          
         MVC   1(131,R2),SPACES                                                 
         LA    R2,132(R2)                                                       
         BCT   R0,*-14                                                          
PRNT11   DS    0H                                                               
         ST    R2,ANXTLIN                                                       
         MVI   SPACING,1                                                        
         B     PRNTX                                                            
*                                                                               
*                                  FLUSH PRINT LINES                            
*                                  -----------------                            
PRNT20   DS    0H                                                               
         MVI   PRSW,C'N'                                                        
         CLC   ANXTLIN,=A(LINTAB)                                               
         BE    PRNTX                                                            
*                                  FIRST COUNT LINES                            
         L     R5,ANXTLIN                                                       
         S     R5,=A(LINTAB)                                                    
         SR    R4,R4                                                            
         D     R4,=F'132'                                                       
         CHI   R5,25               NOT MUCH POINT IN REQUIRING                  
         BNH   *+8                 MORE THAN 25 LINES                           
         LHI   R5,25                                                            
         STC   R5,ALLOWLIN         NUMBER OF LINES                              
*                                                                               
         L     R2,=A(LINTAB)                                                    
PRNT22   DS    0H                                                               
         MVC   P,0(R2)                                                          
         GOTO1 REPORT                                                           
         LA    R2,132(R2)                                                       
         C     R2,ANXTLIN                                                       
         BL    PRNT22                                                           
*                                  CLEAR                                        
*                                  -----                                        
PRNT24   DS    0H                                                               
         MVC   ANXTLIN,=A(LINTAB)                                               
         L     RF,=A(LINTAB)                                                    
         LHI   R0,LINTABN                                                       
         MVC   0(132,RF),SPACES                                                 
         LA    RF,132(RF)                                                       
         BCT   R0,*-10                                                          
*                                                                               
PRNT25   DS    0H                                                               
         LA    RF,P                                                             
         LHI   R0,14                                                            
*                                                                               
         MVC   0(132,RF),SPACES                                                 
         LA    RF,132(RF)                                                       
         BCT   R0,*-10                                                          
*                                                                               
PRNTX    DS    0H                                                               
         MVC   MODE,SAVMODE                                                     
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'PRNTPROF - TRACE USER PROFILE'                                  
PRNTPROF NMOD1 0,PRNTPROF                                                       
         LA    RC,SPACEND                                                       
*                                                                               
* P1: KEY PASSED TO GETPROF                                                     
* P2: RETURNED PROFILE VALUES FROM GETPROF                                      
* P3: ADDITIONAL RETURNED INFO FROM GETPROF                                     
*                                                                               
         L     RF,APATCH                                                        
         TM    0(RF),X'10'         PRINT USER PROFILES?                         
         BZ    PRNTPRFX            NO                                           
*                                                                               
         LM    R2,R4,0(R1)                                                      
*                                                                               
         USING PROFKD,R2                                                        
         USING PROFINFD,R4                                                      
*                                                                               
         OC    PROFIDAT,PROFIDAT   ANY ACTIVITY DATE PRESENT?                   
         BZ    PRNTPRFX            NO -- NO PROFILE WAS RETURNED                
*                                                                               
         MVC   P(PROFMSLQ),PROFMSG PREPARE TO PRINT PROFILE INFO                
         MVC   P(3),PROFKPGM                                                    
         TM    PROFKSYS,X'40'      SYSTEM IS LOWER CASE?                        
         BZ    *+14                                                             
         MVC   P(2),P+1            YES - PROGRAM IS 3 CHARS. LONG               
         MVI   P+2,C' '                                                         
         MVC   P+38(5),SPACES                                                   
         MVC   P+38(L'PROFIAGY),PROFIAGY                                        
         CLC   PROFIAGY,SPACES     NUMERIC USERID IN KEY?                       
         BNL   PRNTPRF5            NO                                           
         EDIT  PROFIAGY,(5,P+38),ALIGN=LEFT                                     
PRNTPRF5 MVC   P+51(3),SPACES                                                   
         MVC   P+51(L'PROFIMED),PROFIMED                                        
         CLI   PROFIMED,0                                                       
         BNE   *+10                                                             
         MVC   P+51(3),=C'ALL'                                                  
         MVC   P+63(3),SPACES                                                   
         MVC   P+63(L'PROFICLT),PROFICLT                                        
         OC    PROFICLT,PROFICLT                                                
         BNZ   *+10                                                             
         MVC   P+63(3),=C'ALL'                                                  
         GOTO1 DATCON,DMCB,(3,PROFIDAT),(8,P+21)                                
         GOTO1 REPORT                                                           
*                                                                               
         GOTO1 HEXOUT,DMCB,0(R3),P+1,16,=C'N'                                   
         MVC   P+40(16),0(R3)                                                   
         GOTO1 REPORT                                                           
         GOTO1 REPORT                                                           
*                                                                               
PRNTPRFX DS    0H                                                               
         XIT1                                                                   
         DROP  R2,R4                                                            
         SPACE 2                                                                
PROFMSG  DC    C'XXX PROFILE, UPDATED MMMDD/YY, AGENCY=XXXXX, MEDIA=XXX+        
               , CLIENT=CCC'                                                    
PROFMSLQ EQU   *-PROFMSG                                                        
         SPACE 2                                                                
         LTORG                                                                  
         TITLE 'ERRPROC - HANDLE RRRORS'                                        
ERRPROC  NMOD1 0,ERRPROC                                                        
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         MVC   P(80),QAREA                                                      
*                                                                               
         LA    R1,P                                                             
         LHI   R0,80                                                            
         SR    RE,RE                                                            
*                                                                               
ERRP2    CLI   0(R1),X'FA'                                                      
         BL    *+16                                                             
         IC    RE,0(R1)                                                         
         SHI   RE,10                                                            
         STC   RE,0(R1)                                                         
*                                                                               
         LA    R1,1(R1)                                                         
         BCT   R0,ERRP2                                                         
*                                                                               
         IC    RE,ERR                                                           
         MHI   RE,40                                                            
         LA    RE,ERRLIST-40(RE)                                                
         MVC   P2(2),=C'**'                                                     
         MVC   P2+3(40),0(RE)                                                   
         MVI   SKIPSPEC,C'Y'                                                    
         MVI   FORCEHED,C'Y'                                                    
         MVI   PRSW,C'N'                                                        
         BRAS  RE,PRNT                                                          
         CLI   ERR,TYPERR          FOR BILLING TYPE ERROR                       
         BNE   ERRP6                                                            
         MVI   MODE,CLTLAST        SET TO GO TO NEXT CLIENT                     
         XIT1                      AND RETURN                                   
*                                                                               
ERRP6    DS    0H                                                               
         CLI   ERR,NOBILERR        UNLESS 'NO BILLING GENERATED'                
         BE    *+12                                                             
         MVI   ENDRQSW,C'Y'        SET HAVE DONE AN ERROR ENDREQ                
         BRAS  RE,UNLOCK           ALLOW THE NEXT UPDATIVE SOON                 
*                                                                               
         GOTO1 AENDREQ             (FORCES CLT BREAK TO ENSURE PROPER           
*                                  INVOICE NUMBER, ETC. LOOKUP)                 
         SPACE 3                                                                
ERRLIST  DS    0C                                                               
         DC    CL40'INVALID PRODUCT GROUP'                       1              
         DC    CL40'INVALID MARKET GROUP'                        2              
         DC    CL40'NEW BILLING NOT EFFECTIVE FOR THIS DATE'     3              
         DC    CL40'NO BILLING GENERATED'                        4              
         DC    CL40'MANUAL AMOUNT ERROR'                         5              
         DC    CL40'INVALID BILLING PERIOD'                      6              
         DC    CL40'INVALID BILLING TYPE'                        7              
         DC    CL40'PROFILE INCOMPATIBILITY - RETAIL'            8              
         DC    CL40'PRD MUST BE ''ALL'' FOR SPLIT PRD BILLING'   9              
         DC    CL40'INVALID ESTIMATE OPTION'                    10              
         DC    CL40'PROFILE INCOMPATIBILITY - AOR'              11              
         DC    CL40'COMMISSION/NET/REG OPTION INVALID'          12              
         DC    CL40'INVALID REQUESTING ID'                      13              
         DC    CL40'PROFILE ERROR - ALL LEVELS "N"'             14              
         DC    CL40'MONTH OF SERVICE PROFILE ERROR'             15              
         DC    CL40'PRIOR INVOICE NUMBER EXCEEDED MAX ALLOWED'  16              
         DC    CL40'CLIENT OFFICE NOT PRESENT IN OFFICE LIST'   17              
         DC    CL40'REVERSAL INVOICE NUMBER IS NOT FOUND'       18              
         DC    CL40'** INVALID BILLING PROFILE      B1X  12'    19              
         DC    CL40'INVALID FLIGHT'                             20              
         DC    CL40'GROUP HAS THEATR AND NON-THEATR PRODS'      21              
         DC    CL40'TRADE BUY SHOULD BE COMMISSION ONLY'        22              
         SPACE 3                                                                
PGRERR   EQU   1                                                                
MGRERR   EQU   2                                                                
DATERR   EQU   3                                                                
NOBILERR EQU   4                                                                
MANERR   EQU   5                                                                
DATERR2  EQU   6                                                                
TYPERR   EQU   7                                                                
RETPERR  EQU   8                                                                
SPLTERR  EQU   9                                                                
ESTERR   EQU   10                                                               
AORPERR  EQU   11                                                               
SCBERR   EQU   12                                                               
IDERR    EQU   13                                                               
PLEVERR  EQU   14                                                               
MOSERR   EQU   15                                                               
INVNERR  EQU   16                                                               
OFFCERR  EQU   17                                                               
REVERR   EQU   18                                                               
BFMLERR  EQU   19                                                               
FLTERR   EQU   20                                                               
WBGRPERR EQU   21                                                               
TRDERR   EQU   22                                                               
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'SPB12B - SPOTPAK BILLING - BOOK B'                              
RNBILL   NMOD1 0,RNBILL            READ NEW BILL RECORDS                        
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         OC    MANGRS,MANGRS       TEST MANUAL BILL                             
         BNZ   RNBX                YES - NO PREVIOUS                            
         CLI   NETOPT,C'N'         OR IF NETPAK                                 
         BE    RNBX                                                             
         CLI   PREVSW,C'N'         OR IF 'NO PREVIOUS'                          
         BE    RNBX                                                             
         CLI   PCTCTL,C'N'         OR IF % BILLING CONTROL                      
         BE    RNBX                SAYS NO PREVIOUS                             
*                                                                               
         CLI   QMKT,C'0'                                                        
         BL    *+10                                                             
         MVC   KMKT,BMKT           ONE MARKET REQ                               
*                                                                               
         XC    SAVSTA,SAVSTA                                                    
         CLI   KPRD,X'FF'          IF POL                                       
         BNE   *+8                                                              
         MVI   KPRD,0              GET ALL PRDS                                 
         XC    SAVPRDC(18),SAVPRDC    PRD AND MKT SAVES                         
         XC    SORTREC,SORTREC                                                  
         MVC   KEY1,KEY                 SAVE KEY                                
         XC    KEY,KEY                                                          
*                                                                               
KEY@     USING STABUCKD,KEY                                                     
         MVC   KEY@.STABKCOD,=X'0E01' RECORD TYPE                               
         MVC   KEY@.STABKAM,BAGYMD                                              
         MVC   KEY@.STABKCLT,BCLT                                               
         CLI   KPRD,0                                                           
         BE    RNB3                SKIP REST OF KEY NOW IF MULTI-PRD            
         MVC   KEY@.STABKPRD,KPRD                                               
*                                                                               
RNB2EST  DS    0H                                                               
         MVC   KEY@.STABKEST,BEST                                               
         XC    KEY@.STABKMKT,KEY@.STABKMKT                                      
         XC    KEY@.STABKSTA,KEY@.STABKSTA                                      
         MVI   KEY@.STABKCUR,0                                                  
*                                                                               
         CLI   BEST,0                                                           
         BE    RNB3                SKIP REST OF KEY NOW IF MULTI-EST            
*                                                                               
RNB2MKT  DS    0H                                                               
         MVC   KEY@.STABKMKT,KMKT                                               
         XC    KEY@.STABKSTA,KEY@.STABKSTA                                      
         MVI   KEY@.STABKCUR,0                                                  
         OC    KMKT,KMKT                                                        
         BZ    RNB3                SKIP STA NOW IF MULTI-MKT                    
*                                                                               
RNB2STA  DS    0H                                                               
         MVC   KEY@.STABKSTA,KSTA                                               
RNB3     DS    0H                                                               
         GOTO1 HIGH                                                             
         B     RNB4B                                                            
*                                                                               
RNB4     DS    0H                                                               
         GOTO1 SEQ                                                              
*                                                                               
RNB4B    DS    0H                                                               
         CLC   KEY(5),KEYSAVE      AGM/CLT                                      
         BNE   RNB40                                                            
         CLI   KPRD,0                                                           
         BE    *+14                                                             
         CLC   KPRD,KEY@.STABKPRD  ONE PRODUCT MUST BE EQUAL                    
         BNE   RNB40                                                            
*                                                                               
*                                                                               
         CLI   WBSW,C'Y'                                                        
         BNE   RNB5                                                             
         L     RF,ADCLT                                                         
         LA    RF,CLIST-CLTHDR(RF)                                              
         CLC   KEY@.STABKPRD,3(RF)                                              
         BE    *+12                                                             
         LA    RF,4(RF)                                                         
         B     *-14                                                             
*                                                                               
         MVC   WORD(3),0(RF)                                                    
         MVC   WORD+3(1),KEY@.STABKEST                                          
         L     RF,=A(CHKWBFLT)                                                  
         BASR  RE,RF                                                            
         BNE   RNB4                NOT FOUND, BUYPASS THIS BUCKET               
*                                                                               
*                                                                               
*&&DO                                                                           
         CLI   WIOPT,C'Y'          IF WESTERN PW                                
         BE    RNB5A                                                            
         CLI   COST2SW,C'Y'        OR COST2                                     
         BE    RNB5A                                                            
         CLI   KEY@.STABKCUR,1     OK, ELSE SKIP COST2 STABUCKS                 
         BE    RNB4                                                             
RNB5A    DS    0H                                                               
*&&                                                                             
*                                  MULTI-PRD STIUATION                          
RNB5     CLC   KEY@.STABKPRD,SAVPRD                                             
         BE    RNB5D                                                            
         MVC   SAVPRD,KEY@.STABKPRD                                             
*                                  GET PROD ALPHA SEQ NO.                       
         L     RF,ADCLT                                                         
         LA    RF,CLIST-CLTHDR(RF)                                              
         LR    R0,RF                                                            
         CLC   SAVPRD,3(RF)                                                     
         BE    *+12                                                             
         LA    RF,4(RF)                                                         
         B     *-14                                                             
*                                                                               
         SR    RF,R0                                                            
         SRL   RF,2                                                             
         STC   RF,BYTE2            SAVE PROD SEQ NO.                            
*                                                                               
         CLI   QPGR,C' '           TEST PGRS                                    
         BE    RNB6                NO                                           
*                                  YES                                          
         L     R2,PRDLIST                                                       
RNB5B    DS    0H                                                               
         CLC   KEY@.STABKPRD,5(R2)                                              
         BE    *+12                                                             
         LA    R2,6(R2)                                                         
         B     RNB5B                                                            
*                                                                               
         MVC   SAVPRDC,2(R2)                                                    
         MVC   SAVPGR,0(R2)                                                     
         UNPK  WORK(5),SAVPGR(3)                                                
         MVC   SAVPGRU,WORK                                                     
RNB5D    DS    0H                                                               
         CLI   PGRQ,C'A'                                                        
         BE    *+14                                                             
         CLC   SAVPGR,=X'9999'     NOT PGR OK                                   
         BE    RNB5F                                                            
         CLC   APGR1BRK,AINVBRK    IF PGR 'HIGHER' THAN INVBRK                  
         BH    RNB6                                                             
         OC    APGR1BRK,APGR1BRK                                                
         BZ    RNB6                                                             
         CLC   SAVPGR,BPGR+1       THEN CHECK RIGHT PGR                         
         BE    RNB6                YES                                          
RNB5F    DS    0H                                                               
         ZIC   RF,KEY@.STABKPRD    BUMP TO NEXT PRODUCT                         
         AHI   RF,1                                                             
         STC   RF,KEY@.STABKPRD                                                 
         B     RNB2EST             SET KEY FROM EST DOWN                        
*                                                                               
RNB6     DS    0H                  EST                                          
         CLI   BEST,0                                                           
         BE    RNB6F                                                            
*                                  ONE EST OR SERIES                            
         CLC   KEY@.STABKEST,BEST                                               
         BL    RNB2EST                                                          
         BE    RNB7                                                             
         CLI   BESTEND,0                                                        
         BE    RNB6D                                                            
         CLC   KEY@.STABKEST,BESTEND                                            
         BNH   RNB7                                                             
*                                                                               
RNB6D    DS    0H                  EST NOT OK                                   
         CLI   KPRD,0                                                           
         BE    RNB5F               NEXT PRD IF MULTI-PRD                        
         B     RNB40               ELSE DONE                                    
*                                                                               
RNB6F    DS    0H                  MULT-EST                                     
         CLI   BPRD,X'FF'                                                       
         BE    *+12                                                             
         CLI   KPRD,0              IF MULTI-PROD                                
         BE    RNB7                SKIP EST ACTIVE TEST                         
*                                                                               
         ZIC   RF,KEY@.STABKEST                                                 
         LA    RF,ESTLST(RF)                                                    
         CLI   0(RF),0             TEST EST ACTIVE                              
         BNE   RNB7                YES                                          
*                                                                               
RNB6H    DS    0H                  BUMP TO NEXT EST                             
         CLI   KEY@.STABKEST,X'FF' AFTER LAST ESTIMATE                          
         BE    RNB6D               NEXT PRD                                     
         ZIC   RF,KEY@.STABKEST                                                 
         LA    RF,1(RF)                                                         
         STC   RF,KEY@.STABKEST                                                 
         B     RNB2MKT                                                          
*                                                                               
RNB7     DS    0H                  MARKET                                       
         CLC   QMKT,=C'0000'                                                    
         BE    *+14                                                             
         OC    KMKT,KMKT                                                        
         BZ    RNB8                                                             
         MVC   SAVMGRU,MGR3+1                                                   
         CLC   KEY@.STABKMKT,KMKT  ONE MKT                                      
         BE    RNB9                                                             
         BL    RNB2MKT                                                          
*                                  MKT HIGH                                     
*                                  IF MULT-EST BUMP TO NEXT EST                 
RNB7B    DS    0H                                                               
         CLI   BEST,0                                                           
         BE    RNB6H                                                            
         CLI   BESTEND,0                                                        
         BNE   RNB6H                                                            
         B     RNB6D               NEXT PRD (IF MULTI-PRD)                      
*                                                                               
RNB8     DS    0H                  MULTI-MKT                                    
         CLI   QMGR,C' '           TEST MGR'S                                   
         BE    RNB9                NO                                           
         CLI   MGRBKTS,C'Y'        IF MGR BUCKETS                               
         BNE   RNB8A                                                            
*                                  READ STATION REC FOR MKT                     
         CLC   SAVSTA,KEY@.STABKSTA                                             
         BE    RNB82                                                            
         MVC   SAVSTA,KEY@.STABKSTA                                             
         DROP  KEY@                                                             
*                                                                               
         MVC   WORK(64),KEY        SAVE STATION BUCKET KEY                      
KEY@     USING STAKEY,KEY                                                       
         MVI   KEY@.STAKTYPE,STAKTYPQ                                           
         MVC   KEY@.STAKMED,QMED                                                
         GOTO1 MSUNPK,DMCB,WORK+7,FULL,DUB                                      
         MVC   KEY@.STAKCALL,DUB                                                
         CLI   QMED,C'R'                                                        
         BE    *+10                                                             
         MVC   KEY@.STAKCALL+4(1),QMED                                          
         MVC   KEY@.STAKAGY,AGY                                                 
         MVC   KEY@.STAKCLT,CLIENT                                              
         MVC   KEY@.STAKFILL,=C'000'                                            
         DROP  KEY@                                                             
         GOTO1 READSTA                                                          
         L     RF,ADSTAT                                                        
         MVC   FULL,SMKT-STAREC(RF)                                             
         PACK  DUB,FULL                                                         
         CVB   R0,DUB                                                           
         STH   R0,SAVMKT                                                        
*                                                                               
         MVC   KEY(64),WORK        RESTORE STATION BUCKET KEY                   
KEY@     USING STABUCKD,KEY                                                     
*                                                                               
RNB82    DS    0H                                                               
         MVC   SAVMGR,KEY@.STABKMKT 'MKT' IS MGR                                
*                                  FROM PWOS TO UNPACKED                        
         ZIC   RF,MGR3LEN                                                       
         MHI   RF,16                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         UNPK  WORK(0),SAVMGR(3)                                                
         MVC   SAVMGRU,WORK                                                     
         B     RNB8F                                                            
RNB8A    DS    0H                                                               
         CLC   SAVMKT,KEY@.STABKMKT                                             
         BE    RNB8F                                                            
         L     R2,MKTLIST                                                       
RNB8B    DS    0H                                                               
         CLC   KEY@.STABKMKT,2(R2)                                              
         BE    RNB8D                                                            
         OC    2(2,R2),2(R2)       EOL                                          
         BZ    *+12                                                             
         LA    R2,5(R2)                                                         
         B     RNB8B                                                            
*                                                                               
         MVC   SAVMGR,=X'9999'                                                  
         B     *+10                                                             
RNB8D    MVC   SAVMGR,0(R2)                                                     
*                                                                               
         UNPK  WORK(5),SAVMGR(3)                                                
         MVC   SAVMGRU,WORK                                                     
*                                                                               
RNB8F    DS    0H                                                               
         CLI   MGRQ,C'A'                                                        
         BNE   *+20                NOT 'A' CHK FOR 9999                         
         CLI   QSTA+1,C'*'         IF 'A' SEE IF FILTERING                      
         BE    *+12                IF YES, ALSO CHECK FOR 9999                  
         CLI   QSTA+2,C'*'                                                      
         BNE   *+14                                                             
*                                                                               
         CLC   SAVMGR,=X'9999'     TEST MGR OK                                  
         BE    RNB8H               NO                                           
*                                                                               
         CLC   AMGR1BRK,AINVBRK    IF MGR                                       
         BH    RNB9                                                             
         OC    AMGR1BRK,AMGR1BRK                                                
         BZ    RNB9                                                             
         CLC   APRDBRK,AINVBRK     AND PRD 'HIGHER' THAN INVBRK                 
         BH    RNB9                                                             
         CLI   MGRQ,C'1'           ONE MGR REQ                                  
         BE    RNB8G                                                            
         CLI   SPLITOPT,C'Y'       FOR SPLIT PRODUCT BILLING                    
         BE    RNB9                DONT TEST MGR HERE                           
         CLI   MGRBKTS,C'Y'        UNLESS MGR BUCKETS                           
         BE    RNB9                                                             
         CLI   SUMOPT,C'Y'         UNLESS DOING RETAIL SUMMARY                  
         BE    RNB9                                                             
RNB8G    DS    0H                                                               
         CLC   SAVMGR,BMGR+1       THEN TEST MGR                                
         BE    RNB9                                                             
RNB8H    DS    0H                                                               
         MVC   HALF,KEY@.STABKMKT  BUMP TO NEXT MKT                             
         LH    RF,HALF                                                          
         AHI   RF,1                                                             
         STH   RF,HALF                                                          
         MVC   KEY@.STABKMKT,HALF                                               
         B     RNB2STA                                                          
*                                                                               
RNB9     DS    0H                  STATION                                      
         CLC   KEY@.STABKSTA,=X'FFFFFF' WILA PW ADJUSTMENT                      
         BE    RNB9C               OK FOR TV AND CABLE                          
         CLI   QSTA+4,C'-'         TEST TV ONLY                                 
         BNE   *+16                                                             
         CLI   KEY@.STABKSTA,X'E8' YES, IS THIS A LOCAL CABLE                   
         BNL   RNB9M               YES, SKIP                                    
         B     RNB9C                                                            
*                                                                               
         CLI   QSTA+4,C'/'         LOCAL CABLE ONLY                             
         BNE   RNB9C                                                            
         CLI   KEY@.STABKSTA,X'E8' YES, IS THIS A LOCAL CABLE                   
         BL    RNB4                NO, READ NEXT                                
*                                                                               
RNB9C    DS    0H                                                               
         OC    KSTA,KSTA                                                        
         BZ    RNB10                                                            
         CLC   KEY@.STABKSTA,KSTA  ONE STA                                      
         BL    RNB2STA                                                          
*                                                                               
         CLI   QSTA+4,C'/'         LOCAL CABLE?                                 
         BNE   RNB9F                                                            
         MVC   FULL(1),KSTA+2      NETWORK CHECK                                
         NI    FULL,X'FF'-X'80'    LOOK AT NET BITS                             
         BZ    RNB9D                                                            
         MVC   DUB(1),KEY@.STABKSTA+2 NET IN KEY                                
         NI    DUB,X'FF'-X'80'                                                  
         CLC   DUB(1),FULL         IS IT REQ'S NETWORK?                         
         BNE   RNB4                                                             
*                                                                               
RNB9D    DS    0H                                                               
         MVC   FULL(3),KSTA        NOW CHECK OPERATOR                           
         NC    FULL(3),=X'0FFF80'  ISOLATE OPERATOR                             
         BZ    RNB10               NONE, REC IS OK                              
         MVC   DUB(3),KEY@.STABKSTA  TEST RIGHT OPERATOR                        
         NC    DUB(3),=X'0FFF80'                                                
         CLC   DUB(3),FULL                                                      
         BE    RNB10                                                            
         BL    RNB4                                                             
         B     RNB9M                                                            
*                                                                               
RNB9F    DS    0H                                                               
         CLC   KEY@.STABKSTA,KSTA  REPEAT STATION KEY CHECK                     
         BE    RNB10               NEXT EST -PRD (IF MULTI)                     
         DROP  KEY@                                                             
*                                                                               
RNB9M    DS    0H                                                               
         B     RNB7B                                                            
         SPACE 3                                                                
*                                  HAVE GOOD KEY                                
*                                  PASS EACH APPROPRIATE ELEM TO SORT           
RNB10    DS    0H                                                               
         L     R7,=A(STABUCKC)                                                  
         ST    R7,AREC                                                          
         USING STABUCK,R7                                                       
         GOTO1 GET                                                              
*                                                                               
         MVI   ELCODE,X'0E'                                                     
         LA    R2,STABELEM                                                      
         USING STABELEM,R2                                                      
         CLC   ELCODE,0(R2)                                                     
         BE    RNB13                                                            
*                                                                               
RNB12    DS    0H                                                               
         BRAS  RE,NEXTEL                                                        
         BNE   RNB30                                                            
*                                                                               
RNB13    DS    0H                                                               
         MVI   BYTE,0              SET STATUS BYTE FROM ELEM                    
         CLI   STABELEM+1,18       NONE IF ELEM 18 LONG                         
         BE    *+18                                                             
         CLI   STABELEM+1,21       OR 21                                        
         BE    *+10                                                             
         MVC   BYTE,STABSTAT       ELSE HAVE STATUS BYTE                        
*                                                                               
         CLI   SCBNCSW,C'C'        DOING COMMISSION BILLING?                    
         BNE   *+16                                                             
         TM    BYTE,STABSSCQ       YES, ONLY COMM ELEMS                         
         BZ    RNB12                                                            
         B     *+12                                                             
*                                                                               
         TM    BYTE,STABSSCQ       ELSE SKIP COMMISSION ELEM                    
         BNZ   RNB12                                                            
*                                                                               
         CLI   QFRATE,C'F'         ARE WE DOING F-RATES?                        
         BNE   *+16                                                             
         TM    BYTE,STABSFRT       YES, THEN ONLY FRATE BUYS                    
         BZ    RNB12                                                            
         B     *+12                                                             
*                                                                               
         TM    BYTE,STABSFRT                                                    
         BNZ   RNB12               ELSE SKIP F-RATES                            
*                                                                               
         CLI   QTRADE,C'T'         ARE WE DOING GROUP M TRADE?                  
         BNE   *+16                                                             
         TM    BYTE,STABSTRD       THEN ONLY TRADE BUYS                         
         BZ    RNB12                                                            
         B     *+12                                                             
*                                                                               
         TM    BYTE,STABSTRD       ELSE SKIP TRADE BUYS                         
         BNZ   RNB12                                                            
*                                                                               
*                                                                               
*                                                                               
         OC    LMGSW,LMGSW         GM LMG/REGIONAL REQUEST ?                    
         BZ    RNB13AC                                                          
         CLI   LMGSW,C'L'          LMG?                                         
         BNE   *+16                                                             
         TM    BYTE,STABSLMG                                                    
         BZ    RNB12                                                            
         B     RNB13AD                                                          
*                                                                               
         TM    BYTE,STABSREG                                                    
         BZ    RNB12                                                            
         B     RNB13AD                                                          
*                                                                               
RNB13AC  TM    BYTE,STABSLMG+STABSREG                                           
         BNZ   RNB12                                                            
*                                                                               
RNB13AD  CLI   QGMITVC,C' '        GMI TRADE/CASH FILTERING?                    
         BNH   RNB13AH                                                          
         CLI   QGMITVC,C'T'        TRADE?                                       
         BNE   *+16                                                             
         TM    BYTE,STABSGTQ       YES, ONLY TRADE PREVIOUS                     
         BZ    RNB12                                                            
         B     RNB13AH                                                          
*                                                                               
*                                  MUST BE CASH ONLY                            
         TM    BYTE,STABSGTQ       SO ONLY NON-TRADE PREVIOUS                   
         BNZ   RNB12                                                            
*                                                                               
RNB13AH  DS    0H                                                               
         OC    MANRVDTP,MANRVDTP   TEST ' MANUAL' REVERSAL OF INVOICE           
         BZ    RNB13B              NO                                           
         CLC   STABBDT,MANRVDTP                                                 
         BNE   RNB12                                                            
*********TM    STABINV,STABINV_REVERSED  **TEST ALREADY REVERSED**              
*********BNZ   RNB12               **NO-OP**                                    
         MVC   HALF,STABINV                                                     
         NI    HALF,X'FF'-(STABINV_REVERSAL+STABINV_REVERSED)                   
         CLC   HALF,MANRVNO                                                     
         BNE   RNB12                                                            
*                                                                               
RNB13B   DS    0H                                                               
         OC    REBDATP,REBDATP     TEST 'REBILL' DATE                           
         BZ    RNB13B2             NO                                           
         MVC   HALF,STABINV        YES, TEST INVOICE NUMBER                     
         NI    HALF,X'FF'-(STABINV_REVERSAL+STABINV_REVERSED)                   
         CLC   HALF,REBINV                                                      
         BNE   RNB12                                                            
*                                                                               
         CLC   STABBDT,REBDATP     YES, DROP ALL AFTER                          
         BH    RNB12                                                            
*                                                                               
RNB13B2  DS    0H                                                               
         OC    IGNDATE,IGNDATE     TEST 'IGNORE' DATE                           
         BZ    *+14                NO                                           
         CLC   STABBDT,IGNDATE     DROP ALL PREVIOUS ON OR AFTER                
         BNL   RNB12                                                            
*                                                                               
         CLI   PERCTL,C'T'         IF MULTI-MONTH                               
         BNE   RNB13D                                                           
*                                                                               
         CLC   CURPER,EFFDTE       AND CURRENT AND NOT LOWER THAN               
         BL    RNB13D              FORMULA EFF DATE                             
         CLC   STABPER,EFFDTE                                                   
         BL    RNB12               BYPASS ALL MONTHS BEFORE EFF DATE            
*                                                                               
RNB13D   DS    0H                                                               
*              WHAT NETWORK 'MODE' DOES MONTH FALL IN                           
*              NOTE- DATES BEFORE CNETSTRT ARE ALSO BY STATION                  
         MVC   DUB(2),CNETSTRT     START FOR FEATURE 1 (BY NET)                 
         MVC   DUB+2(2),CNETSTR2   START OF FEATURE 2 (BY STATION)              
         CLI   DUB,0               IF NO DATE                                   
         BNE   *+8                                                              
         MVI   DUB,X'FF'           SET TO FF                                    
         CLI   DUB+2,0             IF NO DATE                                   
         BNE   *+8                                                              
         MVI   DUB+2,X'FF'         SET TO FF                                    
*                                  WHAT PERIOD DOES CURPER FALL IN              
         MVI   DUB+4,3                                                          
         CLC   CURPER,DUB+2        START 2 OR LATER                             
         BNL   RNB13D2                                                          
         MVI   DUB+4,1                                                          
         CLC   CURPER,DUB          LOWER THAN  START 1                          
         BL    RNB13D2                                                          
         MVI   DUB+4,2             ELSE GROUP 2 (BY NET)                        
*                                                                               
RNB13D2  DS    0H                                                               
*                                  WHAT PERIOD DOES STABPER FALL IN             
         MVI   DUB+5,3                                                          
         CLC   STABPER,DUB+2       START 2 OR LATER                             
         BNL   RNB13D4                                                          
         MVI   DUB+5,1                                                          
         CLC   STABPER,DUB         LOWER THAN  START 1                          
         BL    RNB13D4                                                          
         MVI   DUB+5,2             ELSE GROUP 2 (BY NET)                        
*                                                                               
RNB13D4  DS    0H                                                               
         CLC   DUB+4(1),DUB+5      CURPER AND THISPER THE SAME GROUP            
         BNE   RNB12               NO, SKIP                                     
*                                                                               
         CLI   PERCTL,C'T'         IF MULTI-MONTH                               
         BNE   RNB13H                                                           
         CLI   CVATCOD,0           ALSO IN CANADIAN VAT ON                      
         BE    RNB13H                                                           
         CLC   CURPER,CVATSTRT     AND CURPER NOT                               
         BL    RNB13H              LOWER THAN VAT START                         
         CLC   STABPER,CVATSTRT                                                 
         BL    RNB12               BYPASS EARLIER MONTHS                        
*                                                                               
RNB13H   DS    0H                                                               
         LA    R3,PERLIST                                                       
         USING PERLISTD,R3                                                      
RNB14    DS    0H                                                               
         CLC   STABPER,PERLMOS     TEST DATE                                    
         BE    *+16                OK                                           
         BL    RNB12               NEXT ELEM                                    
         LA    R3,PERLISTL(R3)                                                  
         B     RNB14                                                            
*                                  BUILD SORT KEY USING BRKTAB                  
         LA    R0,PERLIST                                                       
         SR    R3,R0                                                            
         STC   R3,PERDISP          DISP OF DATE INTO PERLIST                    
         DROP  R3                                                               
*                                                                               
*                                                                               
         XC    CALCNET,CALCNET                                                  
         CLI   QTRADE,C'T'         TRADE? LOOK FOR CALC NET ELEM                
         BNE   RNB16                                                            
         LR    R3,R2               START LOOKING FROM WHERE LEFT OFF            
         USING STABTRDE,R3                                                      
RNB15    CLI   0(R3),0             EOR                                          
         BE    RNB15K                                                           
         CLI   0(R3),X'E0'         CALC NET ELEM ?                              
         BNE   RNB15D                                                           
         CLC   2(6,R3),STABELEM+2  COMP MOS+BILL DT+INV# WITH 0E ELEM           
         BNE   RNB15D                                                           
         MVC   CALCNET,STABTNET    GOT CALCULATED NET                           
         B     RNB16                                                            
RNB15D   ZIC   R0,1(R3)            NEXT ELEM                                    
         AR    R3,R0                                                            
         B     RNB15                                                            
         DROP  R3                                                               
*                                                                               
RNB15K   DS    0H                  DERIVE NET FROM GROSS                        
         OC    STABGRS,STABGRS                                                  
         BZ    RNB16                                                            
         LHI   RF,100              NORMAL 85 NET                                
         LHI   RE,85                                                            
         L     R1,STABGRS                                                       
         MR    R0,RE                                                            
         DR    R0,RF                                                            
         LR    R0,R1                                                            
         ST    R0,CALCNET                                                       
*                                                                               
RNB16    L     R3,ABRKTAB                                                       
         USING BRKTABD,R3                                                       
RNB18    DS    0H                                                               
         L     RF,BRKCODE                                                       
         LTR   RF,RF                                                            
         BZ    RNB20                                                            
         BAS   RE,RNBBRKS-4(RF)                                                 
         LA    R3,BRKL(R3)                                                      
         B     RNB18                                                            
*                                                                               
RNB20    DS    0H                                                               
         L     R5,ASORTDTA         ORDERED                                      
         OC    REBDATP,REBDATP     FOR REBILL                                   
         BNZ   *+16                                                             
         CLI   QRETCD,C'D'         AND FOR SPECIAL RETAIL DEBIT                 
         BE    *+8                 AMOUNTS TO GO ON ORDERED SIDE                
         LA    R5,ROWHL(R5)        ELSE POINT TO BILLED DATA                    
*                                                                               
         XC    0(ROWHL,R5),0(R5)                                                
         CLI   STABKCUR,0          TEST AGENCY NATIVE CURRENCY                  
         BE    *+8                                                              
         LA    R5,4(R5)            NO USE FIELDS AT +4 (CLT CURR)               
*                                                                               
         MVC   RGRSD(4,R5),STABGRS          GROSS                               
         MVC   RNETD(4,R5),STABNET          NET                                 
         CLI   QTRADE,C'T'                  IF TRADE, USED CALCULATED           
         BNE   *+10                                                             
         MVC   RNETD(4,R5),CALCNET          CALC NET                            
         LH    RF,STABSPTS         SPOTS                                        
         ST    RF,RSPTD(R5)                                                     
*                                                                               
*                                                                               
*                                                                               
*                                  INV NO.                                      
         CLI   STABELEM+1,19       TEST ELEM HAS TAX                            
         BNH   RNB20A8             NO                                           
         MVC   FULL(3),STABTAX                                                  
         CLI   STABELEM+1,22       IF LEN=22 TAX AT STABTAX+1                   
         BNE   *+10                NO                                           
         MVC   FULL(3),STABTAX+1                                                
         L     RF,FULL                                                          
         SRA   RF,8                                                             
         ST    RF,RTAXD(R5)                                                     
*                                                                               
RNB20A8  DS    0H                                                               
         OC    REBDATP,REBDATP     IF REBILL                                    
         BZ    RNB20A9                                                          
         CLC   STABBDT,REBDATP     FOR REBILL ALL BEFORE DATE GO                
         BE    RNB20A9             INTO PREVIOUS AS WELL AS ORDERED             
*                                                                               
         LA    R6,ROWHL(R5)        POINT TO PREVIOUS BILLING                    
         L     R0,RGRSD(R6)        GROSS                                        
         A     R0,RGRSD(R5)                                                     
         ST    R0,RGRSD(R6)                                                     
         L     R0,RNETD(R6)        NET                                          
         A     R0,RNETD(R5)                                                     
         ST    R0,RNETD(R6)                                                     
         L     R0,RTAXD(R6)        TAX                                          
         A     R0,RTAXD(R5)                                                     
         ST    R0,RTAXD(R6)                                                     
         L     R0,RSPTD(R6)        SPOTS                                        
         A     R0,RSPTD(R5)                                                     
         ST    R0,RSPTD(R6)                                                     
                                                                                
RNB20A9  DS    0H                                                               
         L     R9,ABUFFC                                                        
         USING BUFFALOD,R9                                                      
         GOTO1 DATCON,DMCB,(2,STABBDT),(3,WORK)                                 
         MVC   SVINVD,WORK         SAVE YEAR/MONTH                              
         MVI   BUFFDOPT,C'N'                                                    
         CLI   RETPROF,0           SKIP INV NO. FOR RETAIL                      
         BNE   RNB20B                                                           
         CLI   RETPROF+13,C'Y'     OR IF STATION CITY PRINT (BACKER)            
         BE    RNB20B                                                           
         TM    STABINV,STABINV_REVERSAL+STABINV_REVERSED                        
         BNZ   RNB20B              OR IF REVERSED/REVERSAL                      
         MVI   BUFFDOPT,C'Y'                                                    
         L     R5,ASORTCOM                                                      
         MVC   0(2,R5),SVINVD      YEAR AND MONTH                               
         MVC   2(2,R5),STABINV                                                  
         NI    2(R5),X'FF'-(STABINV_REVERSAL+STABINV_REVERSED)                  
*                                                                               
RNB20B   DS    0H                                                               
         MVI   HALF2,C'P'          DON'T CHECK FOR BHOLD                        
         BRAS  RE,TOSORT                                                        
         MVI   BUFFDOPT,C'Y'                                                    
         DROP  R9                                                               
*                                                                               
*                                  ADD TO INVOICE LIST                          
         CLI   LSTOPT,C'N'                                                      
         BE    RNB12                                                            
         CLI   SHOWREV,C'Y'        KEEP REVERSALS                               
         BE    *+12                                                             
         TM    STABINV,STABINV_REVERSAL+STABINV_REVERSED                        
         BNZ   RNB12               SKIP REVERSED/REVERSALS                      
*                                                                               
         CLC   REBDATP,STABBDT     ALSO IF REBILL OF THIS DATE                  
         BE    RNB12                                                            
*********CLC   STABKCUR,CLTCURR    USE CLT CURRENCY (OR NATIVE AGY              
*********BNE   RNB12               CURR IF = CLT CURR)                          
*                                  SAVE INVOICE FOR LISTING                     
         XC    X,X                                                              
         LA    R6,X                                                             
         USING INVLD,R6                                                         
         MVC   INVLYR,SVINVYR      BILL YR/MO                                   
         MVC   INVLMO,SVINVMON                                                  
         MVC   INVLINV,STABINV     INV NO.                                      
         NI    INVLINV,X'FF'-X'C0' TURN OF REVERCE BITS                         
         MVC   INVLCURR,STABKCUR   COS2 INDICATOR                               
*                                  SET PRD,EST,MTK AND PER                      
*                                  ON SEP BILLS                                 
         CLC   APRDBRK,AINVBRK                                                  
         BNH   RNB22A                                                           
         OC    APGR1BRK,APGR1BRK                                                
         BZ    RNB22B                                                           
         CLC   APGR1BRK,AINVBRK                                                 
         BH    *+10                                                             
RNB22A   DS    0H                                                               
         MVC   INVLPRD,STABKPRD                                                 
RNB22B   DS    0H                                                               
         CLC   AESTBRK,AINVBRK                                                  
         BH    *+10                                                             
         MVC   INVLEST,STABKEST                                                 
         OC    AMGR1BRK,AMGR1BRK                                                
         BZ    RNB22D                                                           
         CLC   AMGR1BRK,AINVBRK                                                 
         BH    *+16                                                             
         MVC   INVLMGR,SAVMGR      BOTH PACKED AND UNPACKED VALUE               
         MVC   INVLMGRC,SAVMGRU    TO COMPARE WITH BILL HEADER                  
RNB22D   DS    0H                                                               
         CLC   AMKTBRK,AINVBRK                                                  
         BH    *+10                                                             
RNB22C   DS    0H                                                               
         MVC   INVLMKT,STABKMKT                                                 
         CLC   APERBRK,AINVBRK                                                  
         BH    *+10                                                             
         MVC   INVLPER,STABPER                                                  
         MVC   INVLGRS,STABGRS     GROSS                                        
         MVC   INVLNET,STABNET     NET                                          
         CLI   QTRADE,C'T'                                                      
         BNE   *+10                                                             
         MVC   INVLNET,CALCNET     CALCULATED NET                               
*                                  ADD THIS MOS TO TABLE                        
         L     RF,=A(MOSLIST)                                                   
RNB22F   CLI   0(RF),X'FF'         ANYTHING IN MOS TABLE?                       
         BE    RNB22J              NO, PUT IN MOS                               
         CLC   STABPER,0(RF)                                                    
         BE    RNB22M                                                           
         LA    RF,2(RF)            EXAMINE NXT MOS                              
         B     RNB22F                                                           
RNB22J   MVC   0(2,RF),STABPER                                                  
         MVI   2(RF),X'FF'                                                      
*                                                                               
RNB22M   GOTO1 BINSRCH,INVPARS,(1,X)                                            
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
         CLI   0(R1),1             ALREADY THERE                                
         BE    RNB12               NO - NEXT ELEM                               
*                                                                               
         L     R1,0(R1)            ADD INTO EXISTING ELEM                       
INVLTABD USING INVLD,R1                                                         
         ICM   RE,15,INVLTABD.INVLGRS                                           
         ICM   RF,15,INVLTABD.INVLNET                                           
         MVC   DUB(4),INVLGRS                                                   
         MVC   DUB+4(4),INVLNET                                                 
         A     RE,DUB                                                           
         A     RF,DUB+4                                                         
         STCM  RE,15,INVLTABD.INVLGRS                                           
         STCM  RF,15,INVLTABD.INVLNET                                           
         B     RNB12               NEXT ELEM                                    
         DROP  INVLTABD                                                         
*                                                                               
RNB30    DS    0H                                                               
         B     RNB4                NEXT RECORD                                  
         DROP  R6                                                               
         SPACE 3                                                                
RNB40    DS    0H                                                               
         MVC   KEY,KEY1            RESTORE SEQ                                  
         GOTO1 HIGH                                                             
         SPACE 2                                                                
RNBX     DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
RNBBRKS  DS    0F                                                               
         B     RNBPGR1                                                          
         B     RNBPGR2                                                          
         B     RNBPGR3                                                          
         B     RNBKPRD                                                          
         B     RNBKEST                                                          
         B     RNBMGR1                                                          
         B     RNBMGR2                                                          
         B     RNBMGR3                                                          
         B     RNBKMKT                                                          
         B     RNBKNET                                                          
         B     RNBKSTA                                                          
         B     RNBKPKG                                                          
         B     RNBKPGM                                                          
         B     RNBKDESC                                                         
         B     RNBKPER                                                          
         B     RNBPERG                                                          
         B     RNBCTYP                                                          
         B     RNBFLT                                                           
         DC    F'0'                                                             
*                                                                               
         SPACE 2                                                                
RNBPGR1  DS    0H                                                               
         LA    R4,SAVPGRU                                                       
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBPGR2  DS    0H                                                               
         LA    R4,SAVPGRU                                                       
         ZIC   RF,PGR1LEN                                                       
         AR    R4,RF               POINT TO PGR2                                
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBPGR3  DS    0H                                                               
         LA    R4,SAVPGRU                                                       
         ZIC   RF,PGR2LEN                                                       
         AR    R4,RF               POINT TO PGR3                                
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBKPRD  DS    0H                                                               
         LA    R4,BYTE2                                                         
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBMGR1  DS    0H                                                               
         LA    R4,SAVMGRU                                                       
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBMGR2  DS    0H                                                               
         LA    R4,SAVMGRU                                                       
         ZIC   RF,MGR1LEN                                                       
         AR    R4,RF               POINT TO MGR2                                
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBMGR3  DS    0H                                                               
         LA    R4,SAVMGRU                                                       
         ZIC   RF,MGR2LEN                                                       
         AR    R4,RF               POINT TO MGR3                                
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBKMKT  DS    0H                                                               
         LA    R4,SAVMKT                                                        
         CLI   MGRBKTS,C'Y'        IF MGR BUCKETS                               
         BE    RNBKALL                                                          
         LA    R4,STABKMKT                                                      
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBKEST  DS    0H                                                               
         LA    R4,STABKEST                                                      
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBKPER  DS    0H                                                               
         LA    R4,PERDISP                                                       
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBKSTA  DS    0H                                                               
         LA    R4,DUB                                                           
         MVC   DUB(3),STABKSTA                                                  
*                                                                               
         CLI   WIOPT,C'Y'          FOR WESTERN PW                               
         BNE   RNBKALL                                                          
         CLC   DUB(3),=X'FFFFFF'   BUT NOT SPECIAL CONVENTION                   
         BE    RNBKALL                                                          
         CLC   DUB(3),=X'FFFFFE'                                                
         BE    RNBKALL                                                          
         L     RF,ADAGY                                                         
         CLI   AGYPROF+7-AGYHDR(RF),C'C'                                        
         BE    RNBKALL             FOR CANADA NO CABLE CHECK                    
         CLI   DUB,X'E8'           IF CABLE HEAD                                
         BL    RNBKALL                                                          
         NI    DUB+2,X'FF'-X'7F'   GET RID OF CABLE NET                         
         B     RNBKALL             (COLLAPSE TO CABLE HEAD)                     
         SPACE 2                                                                
RNBKNET  DS    0H                  CANADIAN NETWORK                             
         MVC   BYTE,STABKSTA+2     3RD BYTE OF STATION                          
*                                                                               
         CLI   BYTE,X'B0'          IF 3RD BYTE OF STATION >= X'B0'...           
         BL    RNBKN10                                                          
         MVC   THREE,STABKSTA      ... IT'S A CABLE NETWORK                     
         MVI   THREE+2,X'03'       MEDIA IS ALWAYS 'N'                          
         LA    R4,THREE            THREE HAS REBUILT PACKED STATION...          
         B     RNBKALL             ... WHICH GOES INTO SORTKEY                  
*                                                                               
RNBKN10  DS    0H                                                               
         ZIC   R4,BYTE             USE ALL BITS                                 
         MHI   R4,NETTABL                                                       
         A     R4,=A(NETTAB)                                                    
*                                                                               
         USING NETTABD,R4                                                       
         OC    NTBPCKD,NTBPCKD                                                  
         BZ    *+12                NETWORK IS MISSING FROM TABLE                
         LA    R4,NTBPCKD          POINT TO PACKED STATION                      
         B     RNBKALL                                                          
         DROP  R4                                                               
*                                                                               
*                                  MISSING NETWORK                              
         CLI   PROFB1S3,C'D'       PRODUCE A DUMP?                              
         BNE   *+6                                                              
         DC    H'0'                YES                                          
         CLI   PROFB1S3,C'T'       PRINT A TRACE?                               
         BNE   RNBKALL             NO -- JUST PASS IT ALONG                     
*                                                                               
         LR    R5,RE               SAVE RE                                      
         GOTO1 HEXOUT,DMCB,0(R7),P,13,=C'N'  PRINT KEY IN HEX                   
         ZIC   R0,1(R2)            ELEMENT LENGTH                               
         GOTO1 HEXOUT,DMCB,0(R2),P+30,(R0),=C'N'  DUMP BUCKET ELEMENT           
         BRAS  RE,PRNT                                                          
         LR    RE,R5               RESTORE RE                                   
         B     RNBKALL                                                          
         SPACE 2                                                                
RNBPERG  DS    0H                  PERIOD GROUP                                 
         LA    R4,=C'1'            PRIOR MONTHS                                 
         CLC   STABPER,CURPER                                                   
         BNE   RNBKALL                                                          
         CLI   PRIOR,C'W'          W = CURRENT MON SEPARATE                     
         BE    *+12                                                             
         CLI   PRIOR,C'M'          M = CURRENT MON SEPARATE                     
         BNE   RNBKALL                                                          
         LA    R4,=C'5'            CURRENT MONTH                                
         B     RNBKALL                                                          
RNBFLT   DS    0H                                                               
         LA    R4,WBFLT                                                         
         B     RNBKALL                                                          
         SPACE 2                                                                
*                                                                               
         SPACE 2                                                                
RNBKPGM  DS    0H                                                               
         BR    RE                                                               
         SPACE 2                                                                
RNBKDESC EQU   RNBKPGM                                                          
RNBKPKG  EQU   RNBKPGM                                                          
RNBCTYP  EQU   RNBKPGM                                                          
         SPACE 2                                                                
RNBKALL  DS    0H                                                               
         LA    R5,SORTKEY                                                       
         A     R5,BRKDISP                                                       
         L     RF,BRKLENM1                                                      
         EX    RF,*+6                                                           
         BR    RE                                                               
         MVC   0(0,R5),0(R4)                                                    
*                                                                               
         DROP  R2                                                               
         DROP  R3                                                               
         DROP  R7                                                               
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'WNBILL - WRITE NEW BILL RECORDS'                                
WNBILL   NMOD1 0,WNBILL                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
*                                  NOTE - FOR NETPAK WNBILL ONLY ADDS           
*                                        AMOUNTS TO PRD-EST-PER TAB             
*                                                                               
         CLI   PASSNO,1            ONLY FOR PASS 1                              
         BNE   WN42                                                             
         CLI   SORTTRCE,C'Y'                                                    
         BE    *+12                                                             
         CLI   SORTTRCE,C'O'                                                    
         BNE   *+14                                                             
         MVC   P+1(14),=C'WRITE NEW BILL'                                       
         BRAS  RE,PRNT                                                          
*                                                                               
         ST    R3,SAVBRK           SAVE BREAK LEVEL                             
         MVI   CURRSW,0            DO NATIVE CURRENCY FIRST                     
         MVI   CURRHAV,C'N'       FOR 2ND CURR STATUS                           
*                                                                               
WN2      DS    0H                                                               
         OI    DMINBTS,X'08'       SET TO PASS DELETES                          
         MVI   DMOUTBTS,X'FF'-X'02' (MAY NEED TO UNDELETE)                      
         CLI   UPASS,1             SKIP FOR RETAIL UNLESS CORP ACCT             
         BH    WN6                                                              
         CLI   NETOPT,C'N'                                                      
         BE    WN6                                                              
         MVC   KEY1,KEY                                                         
         XC    KEY,KEY                                                          
KEY@     USING STABUCKD,KEY                                                     
         MVC   KEY@.STABKCOD,=X'0E01'                                           
         MVC   KEY@.STABKAM,BAGYMD                                              
         MVC   KEY@.STABKCLT,BCLT                                               
*                                                                               
         L     RF,APRD                                                          
         ZIC   R4,0(RF)            GET PROD CODE FROM PROD SEQ                  
         MHI   R4,4                                                             
         L     RF,ADCLT                                                         
         LA    RF,CLIST+3-CLTHDR(RF,R4)                                         
         MVC   KEY@.STABKPRD,0(RF) PRODUCT                                      
         L     RF,AEST                                                          
         MVC   KEY@.STABKEST,0(RF) EST                                          
         L     RF,AMKT             MKT                                          
         MVC   KEY@.STABKMKT,0(RF)                                              
         L     RF,ASTA             STA                                          
         MVC   KEY@.STABKSTA,0(RF)                                              
         CLC   ORIGTYPE,TYPE       IF NOT DETAIL MARKING                        
         BNE   *+16                                                             
         MVC   KEY@.STABKMKT,XXMKT SET MKT/STA TO DUMMY                         
         MVC   KEY@.STABKSTA,XXSTA                                              
         MVC   KEY@.STABKCUR,CURRSW CURRENCY                                    
         CLI   MGRBKTS,C'Y'        IF MGR BUCKETS USE MGR NOT MKT               
         BNE   WN4                                                              
*                                                                               
         ZIC   RF,MGR3LEN                                                       
         L     RE,AMGR1                                                         
         EX    RF,*+8                                                           
         B     *+10                                                             
         PACK  WORK(3),0(0,RE)     PWOS                                         
         MVC   KEY@.STABKMKT,WORK                                               
*                                                                               
WN4      DS    0H                                                               
         DROP  KEY@                                                             
*                                       BUILD DUMMY RECORD FOR ADD              
         L     R7,=A(STABUCKC)                                                  
         XC    0(256,R7),0(R7)                                                  
         ST    R7,AREC                                                          
         USING STABUCK,R7                                                       
         MVC   STABUCK(13),KEY                                                  
         MVC   STABLEN,=H'24'                                                   
         MVC   STABAGYA,AGY                                                     
         MVI   BYTE2,C'A'               SET FOR ADD                             
*                                       OR GET REC IF IT EXISTS                 
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   WN6                                                              
*        TM    KEY+13,X'C0'        TEST DELETED RECORD                          
*        BZ    WN5                                                              
*        NI    KEY+13,X'FF'-X'C0'  UNDELETE                                     
*                                                                               
*        CLI   RCTRACE,C'Y'                                                     
*        BNE   WN4D                                                             
*        GOTO1 PRNTBL,DMCB,=C'UNDELETE STATION BUCKET KEY',KEY,                 
*              C'DUMP',18,=C'1D'                                                
*                                                                               
*N4D     DS    0H                                                               
*        GOTO1 WRITE                                                            
*                                                                               
WN5      DS    0H                                                               
         GOTO1 GET                                                              
         MVI   BYTE2,C'P'               SET FOR PUT                             
         TM    STABCNTL,X'C0'       TEST DELETED RECORD                         
         BZ    WN6                                                              
         NI    STABCNTL,X'FF'-X'C0' MARK NOT DELETED                            
         LA    R0,STABELEM          CLEAR ELEMENTS                              
         SR    R1,R1                                                            
         ICM   R1,3,STABLEN                                                     
         AHI   R1,-24                                                           
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         MVC   STABLEN,=H'24'       UPDATE REC LEN                              
*                                                                               
WN6      DS    0H                                                               
         MVI   BYTE,0              CLEAR REC ACTIVITY SW                        
         XC    W,W                 BUILD ELEM IN W                              
         LA    R6,W                                                             
         USING STABELEM,R6                                                      
         MVI   STABELEM,X'0E'      ELEMENT CODE                                 
         MVI   STABELEM+1,X'13'    NEW ELEMENT LENGTH                           
*                                                                               
         CLI   SCBNCSW,C'C'        IF SCB COMMISSION BILL                       
         BNE   *+8                                                              
         OI    STABSTAT,STABSSCQ   MARK AS SUCH                                 
         CLI   SCBNCSW,C'N'        AND IF SCB NET BILL                          
         BNE   *+8                                                              
         OI    STABSTAT,STABSSNQ                                                
         CLI   QFRATE,C'F'         IS IT F-RATE BILL?                           
         BNE   *+8                                                              
         OI    STABSTAT,STABSFRT                                                
         CLI   WIOPT,C'Y'          PW BILL                                      
         BNE   *+8                                                              
         OI    STABSTAT,STABSPWQ                                                
         CLI   QGMITVC,C'T'        GMI TRADE BILLING?                           
         BNE   *+8                                                              
         OI    STABSTAT,STABSGTQ                                                
         CLI   QTRADE,C'T'         GROUP M TRADE BILLING?                       
         BNE   *+8                                                              
         OI    STABSTAT,STABSTRD                                                
         CLI   LMGSW,C'L'                                                       
         BNE   *+8                                                              
         OI    STABSTAT,STABSLMG                                                
         CLI   LMGSW,C'R'                                                       
         BNE   *+8                                                              
         OI    STABSTAT,STABSREG                                                
*                                                                               
         MVC   STABBDT,TODAYP                                                   
         MVC   STABINV,INVNO                                                    
*                                                                               
         L     R3,SAVBRK                                                        
         L     R4,BRKCODE-BRKTABD(R3)                                           
         L     R4,ATOTS(R4)        POINT TO ACCUM                               
         LHI   R3,MAXMOS                                                        
         LA    R5,PERLIST          DATE LIST                                    
         USING PERLISTD,R5                                                      
*                                                                               
WN8      DS    0H                                                               
         OC    PERLMOS,PERLMOS     SKIP NON-EXISTENT MONTHS                     
         BZ    WN19                                                             
         CLI   PERLMOS,X'FF'                                                    
         BE    WN20                                                             
         OC    0(ROWTL,R4),0(R4)   ANY $ (**LENGTH WAS ROWL**)                  
         BNZ   WN8A                                                             
         CLI   ZEROSW,C'Y'                                                      
         BNE   WN19                                                             
         CLC   CURPER,PERLMOS      FOR ZERO BILLS, ONLY                         
         BNE   WN19                CURRENT MONTH                                
*                                                                               
WN8A     DS    0H                                                               
         LR    RF,R4               FIRST DO TIME CHARGES                        
         OC    0(ROWTL,RF),0(RF)   NO $                                         
         BNZ   *+12                                                             
         CLI   ZEROSW,C'Y'                                                      
         BNE   WN19                                                             
*                                                                               
         LA    R2,WORK                                                          
         LHI   R0,2*4              2 CURRENCIES                                 
WN9      DS    0H                                                               
         L     R1,0(RF)                 ORD                                     
         S     R1,ROWHL(RF)        LESS BILLED                                  
         ST    R1,0(R2)                                                         
         LA    R2,4(R2)                                                         
         LA    RF,4(RF)                                                         
         BCT   R0,WN9                                                           
*                                                                               
         CLI   STABKCUR,0          TEST NATIVE CURRENCY                         
         BNE   WN9A3                                                            
         LA    RE,WORK             YES, TEST ANY 2ND CURR PRESENT               
         LHI   R0,4                                                             
*                                                                               
         OC    4(4,RE),4(RE)                                                    
         BNZ   *+16                                                             
         LA    RE,8(RE)                                                         
         BCT   R0,*-14                                                          
         B     WN9A4                                                            
*                                                                               
         MVI   CURRHAV,C'Y'        SET HAVE 2ND CURR                            
         B     WN9A4                                                            
*                                                                               
WN9A3    CLI   MIDAS,C'Y'          IF MIDAS, CLEAR CRDT STATION                 
         BNE   WN9A4                                                            
         L     R1,ASTA                                                          
         MVC   THREE,0(R1)                                                      
         NI    THREE+2,X'F0'       TURN OFF LAST NIBBLE                         
         CLC   =X'17B340',THREE                                                 
         BNE   WN9A4                                                            
         XC    0(ROWTL,R4),0(R4)   CLEAR ACCUMULATOR                            
*                                                                               
WN9A4    DS    0H                                                               
         LA    RF,WORK                                                          
         CLI   STABKCUR,0          TEST NATIVE CURRENCY                         
         BE    *+8                                                              
         LA    RF,4(RF)            2ND CURR AT +4                               
         MVC   STABGRS,RGRSD(RF)   GROSS                                        
         MVC   STABNET,RNETD(RF)   NET                                          
         MVC   STABSPTS,RSPTD+2(RF)   SPOTS                                     
*                                                                               
*     ** NOTE- IN NEW ELEMS TAX IS AT +1 **WILL FIX TAG LATER **                
*                                                                               
         XC    STABTAX+1(3),STABTAX+1  TAX(3)                                   
         MVI   STABELEM+1,19       RESET TO NO TAX LENGTH                       
         OC    RTAXD(4,RF),RTAXD(RF)   ANY TAX?                                 
         BZ    *+14                                                             
         MVC   STABTAX+1(3),RTAXD+1(RF) TAX(3)                                  
         MVI   STABELEM+1,22       NOTE NEW LENGTH                              
*                                                                               
         MVC   STABPER,PERLMOS     PERIOD                                       
         CLI   UPASS,1             SKIP FOR RETAIL UNLESS CORP ACCT             
         BH    WN16                                                             
         CLI   QRETCD,C' '         AND SPECIAL RETAIL CREDIT/DEBIT              
         BH    WN16                                                             
         CLI   NETOPT,C'N'                                                      
         BE    WN16                                                             
         OC    STABGRS,STABGRS     ZERO BILL?                                   
         BNZ   WN9B                NO                                           
         OC    STABNET,STABNET                                                  
         BNZ   WN9B                                                             
         OC    STABTAX+1(3),STABTAX+1 TEST TAX TOO                              
         BNZ   WN9B                NO                                           
         CLI   ZEROSW,C'Y'         YES - ARE WE DOING A 'ZERO' BILL NOW         
         BE    WN16                YES - POST TO PRD-EST-PER TABLE              
         CLC   ORIGTYPE,TYPE       OR IF NOT DETAIL MARKING FILE                
         BE    WN16                                                             
         B     WN19                NO - SKIP                                    
WN9B     DS    0H                                                               
*                                  FIND PLACE FOR ELEM AND ADD IT               
         LA    R2,STABUCK                                                       
         LA    R2,24(R2)                                                        
WN10     DS    0H                                                               
STABREC  USING STABELEM,R2                                                      
         CLI   0(R2),0             EOR                                          
         BE    WN12                                                             
         CLC   STABELEM(6),STABREC.STABELEM                                     
         BL    WN12                                                             
         OC    MANRVDTP,MANRVDTP   IS THIS A REVERSAL BILL                      
         BZ    WN11                NO                                           
         CLC   STABREC.STABBDT,MANRVDTP                                         
         BNE   WN11                                                             
         CLC   STABREC.STABINV,MANRVNO                                          
         BNE   WN11                                                             
         OI    STABREC.STABINV,STABINV_REVERSED  SET ELEMENT REVERSED           
WN11     DS    0H                                                               
         ZIC   R0,1(R2)            NEXT ELEM                                    
         AR    R2,R0                                                            
         B     WN10                                                             
WN12     DS    0H                                                               
         OC    MANRVDTP,MANRVDTP   IS THIS A REVERSAL BILL?                     
         BZ    *+8                                                              
         OI    STABINV,STABINV_REVERSAL   YES - SET REVERSAL ELEM               
*                                                                               
         XC    CALCNET,CALCNET     CLEAR CALCULATED NET                         
         CLI   QTRADE,C'T'         GROUP M TRADE BILL?                          
         BNE   WN13                                                             
         MVC   CALCNET,STABNET     SAVE CALCULATED NET                          
         XC    STABNET,STABNET     REAL NET IS ZERO                             
         MVI   W+100,X'E0'         ELEM CODE                                    
         MVI   W+101,14                                                         
         MVC   W+102(6),W+2        MOVE MOS, D/O BILL, INV #                    
         MVC   W+108(4),CALCNET                                                 
*                                                                               
WN13     GOTO1 RECUP,DMCB,STABUCK,STABELEM,(R2)                                 
         DROP  STABREC                                                          
         CLI   QTRADE,C'T'         GROUP M TRADE BILL?                          
         BNE   WN15                R2 POINTS WHERE STABELEM WAS ADDED           
         USING STABTRDE,R2                                                      
WN14     CLI   0(R2),0             EOR                                          
         BE    WN14D                                                            
         CLC   W+100(6),0(R2)                                                   
         BL    WN14D                                                            
         CLI   0(R2),X'E0'         ARE WE PROCESSING X'E0' ELEMS?               
         BNE   WN14C               NO                                           
         OC    MANRVDTP,MANRVDTP   IS THIS A REVERSAL BILL                      
         BZ    WN14C               NO                                           
         CLC   STABTDT,MANRVDTP                                                 
         BNE   WN14C                                                            
         CLC   STABTINV,MANRVNO                                                 
         BNE   WN14C                                                            
         OI    STABTINV,STABINV_REVERSED  SET ELEMENT REVERSED                  
*                                                                               
WN14C    ZIC   R0,1(R2)            NEXT ELEM                                    
         AR    R2,R0                                                            
         B     WN14                                                             
WN14D    GOTO1 RECUP,DMCB,STABUCK,W+100,(R2)                                    
         DROP  R2                                                               
*                                                                               
WN15     MVI   BYTE,1              SET ACTIVITY FOR THIS REC                    
*                                  ADD INTO REQ TOTALS                          
         L     RE,NBTOTG           NOTE- CLT CURR INCLUDED                      
         A     RE,STABGRS                                                       
         ST    RE,NBTOTG                                                        
         L     RE,NBTOTN                                                        
         A     RE,STABNET                                                       
         ST    RE,NBTOTN                                                        
         L     RE,NBTOTNC                                                       
         A     RE,CALCNET                                                       
         ST    RE,NBTOTNC                                                       
*                                  ADD TO PRD-EST-PER TAB                       
WN16     DS    0H                                                               
         L     R0,=A(PEPTWRK)      CLEAR PEPTAB WORK AREA                       
         LHI   R1,PEPTABRL                                                      
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         L     RF,=A(PEPTWRK)                                                   
         USING PEPTD,RF                                                         
         L     RE,APRD                                                          
         MVC   PEPTPRD,0(RE)       PRD                                          
         L     RE,AEST                                                          
         MVC   PEPTEST,0(RE)       EST                                          
         MVC   PEPTMOS,STABPER     YM                                           
*                                                                               
         CLI   MGR1CTL,C'S'        IF MGR'S SEP                                 
         BNE   WN17                                                             
         L     RE,AMGR1            SET IN PEPTAB                                
         ZIC   R1,MGR3LEN                                                       
         EX    R1,*+8                                                           
         B     *+10                                                             
         PACK  DUB,0(0,RE)                                                      
         MVC   PEPTMGR,DUB+5                                                    
         LA    RE,MGR3NM           PICK LOWEST MGR NAME                         
         CLI   0(RE),C' '                                                       
         BH    WN16D                                                            
         LA    RE,MGR2NM                                                        
         CLI   0(RE),C' '                                                       
         BH    WN16D                                                            
         LA    RE,MGR1NM                                                        
*                                                                               
WN16D    DS    0H                                                               
         MVC   PEPTMGRN,0(RE)                                                   
*                                                                               
WN17     DS    0H                                                               
         CLI   MKTCTL,C'S'         IF MKT'S SEP                                 
         BNE   *+14                                                             
         L     RE,AMKT             SET IN PEPTAB                                
         MVC   PEPTMKT,0(RE)                                                    
*                                                                               
         CLI   STACTL,C'S'         IF STA'S SEP                                 
         BNE   *+14                                                             
         L     RE,ASTA             SET IN PEPTAB                                
         MVC   PEPTSTA,0(RE)                                                    
*                                                                               
         CLI   NETCTL,C'S'         IF NET'S SEP                                 
         BNE   *+14                                                             
         L     RE,ANET             SET IN PEPTAB                                
         MVC   PEPTNTW,0(RE)                                                    
*                                                                               
         GOTO1 BINSRCH,PEPPARS,(1,(RF))                                         
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
*                                  ADD TOTALS IN                                
         L     RF,0(R1)                                                         
*                                                                               
         CLI   MIDAS,C'Y'                                                       
         BNE   WN18                                                             
         L     R1,ASTA                                                          
         MVC   THREE,0(R1)                                                      
         NI    THREE+2,X'F0'       TURN OFF LAST NIBBLE                         
         CLC   =X'17B340',THREE                                                 
         BNE   WN18                                                             
         ICM   R0,15,STABGRS                                                    
         LA    RE,PEPTTRDC                                                      
         CLI   STABKCUR,0          CURRENCY                                     
         BE    *+8                                                              
         LA    RE,4(RE)                                                         
         A     R0,0(RE)                                                         
         ST    R0,0(RE)                                                         
         B     WN19                                                             
*                                                                               
WN18     ICM   R0,15,STABGRS                                                    
         LA    RE,PEPTGRS                                                       
         CLI   STABKCUR,0          CURRENCY                                     
         BE    *+8                                                              
         LA    RE,4(RE)                                                         
         A     R0,0(RE)                                                         
         ST    R0,0(RE)                                                         
*                                                                               
         ICM   R0,15,STABNET                                                    
         LA    RE,PEPTNET                                                       
         CLI   STABKCUR,0          CURRENCY                                     
         BE    *+8                                                              
         LA    RE,4(RE)                                                         
         A     R0,0(RE)                                                         
         ST    R0,0(RE)                                                         
         ICM   R0,15,CALCNET                                                    
         LA    RE,PEPTNETC                                                      
         CLI   STABKCUR,0          CURRENCY                                     
         BE    *+8                                                              
         LA    RE,4(RE)                                                         
         A     R0,0(RE)                                                         
         ST    R0,0(RE)                                                         
         DROP  RF                                                               
*                                                                               
WN19     DS    0H                                                               
         LA    R4,ROWL(R4)         NEXT MONTH                                   
         LA    R5,PERLISTL(R5)                                                  
         BCT   R3,WN8                                                           
         DROP  R5                                                               
         DROP  R6                                                               
*                                                                               
WN20     DS    0H                                                               
         CLI   BYTE,0              TEST ACTIVITY THIS REC                       
         BE    WN41                NO                                           
*                                                                               
         TM    KEY+13,X'C0'        TEST DELETED RECORD                          
         BZ    WN23                                                             
         CLI   BYTE2,C'A'          IF ADDING, NOTHING TO UNDELETE               
         BE    WN23                KEY IS FROM NXT REC FROM THE FILE            
         NI    KEY+13,X'FF'-X'C0'  UNDELETE                                     
                                                                                
         CLI   RCTRACE,C'Y'                                                     
         BNE   WN22                                                             
         GOTO1 PRNTBL,DMCB,=C'UNDELETE STATION BUCKET KEY',KEY,        +        
               C'DUMP',18,=C'1D'                                                
                                                                                
WN22     DS    0H                                                               
         GOTO1 WRITE                                                            
*                                                                               
WN23     CLI   RCTRACE,C'Y'                                                     
         BNE   WN25                                                             
         MVC   P(25),=C'PUT STATION BUCKET RECORD'                              
         CLI   BYTE2,C'P'                                                       
         BE    *+10                                                             
         MVC   P(3),=C'ADD'                                                     
         GOTO1 =V(PRTREC),DMCB,(R7),(24,13),PRINT,HEXOUT,C'DOME',      +        
               (25,P)                                                           
*                                                                               
WN25     DS    0H                                                               
         CLI   TESTFLAG,C'T'                                                    
         BE    WN40                                                             
         L     RF,PUT                                                           
         CLI   BYTE2,C'P'                                                       
         BE    *+8                                                              
         L     RF,ADD                                                           
         GOTO1 (RF)                                                             
*                                                                               
WN40     DS    0H                                                               
         L     RF,APATCH                                                        
         TM    0(RF),X'20'         DUMP RECORDS?                                
         BZ    WN41                                                             
         GOTO1 =V(PRTREC),DMCB,AREC,(24,13),PRINT,HEXOUT,C'DOME',      +        
               =C'STABUCK'                                                      
*                                                                               
WN41     DS    0H                                                               
         CLI   CURR2,0             ANY TRUE SECOND CURRENCY POSSIBLE?           
         BE    WN42                NO                                           
         CLI   CURRSW,0            TEST HAVE DONE 2ND CURR PASS                 
         BNE   WN42                                                             
         CLI   CURRHAV,C'Y'        DO WE NEED TO                                
         BNE   WN42                NO                                           
         MVC   CURRSW,CURR2        YES, SET FOR SECOND PASS                     
         B     WN2                                                              
*                                                                               
WN42     DS    0H                                                               
         NI    DMINBTS,X'FF'-X'08' NO LONGER PASS DELETES                       
         MVI   DMOUTBTS,X'FF'                                                   
*                                                                               
         XIT1                                                                   
         DROP  R7                                                               
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'WOBILL - WRITE OLD STYLE BILL RECS'                             
********************************************************************            
*                                                                               
*        NOTE- 2ND CURRENCY AMOUNTS ARE USED FOR:                               
*               -COST2 BILLING                                                  
*               -RETAIL 'PARTIAL BILLING' FEATURE                               
*               -THEORETICALLY FOR 2ND CURRENCY IF NOT FOR ANY                  
*                OF THE ABOVE, BUT THAT FEATURE IS DEFUNCT.                     
*                                                                               
*              THE AMOUNTS ARE STORED IN THE 2ND CURRENCY                       
*              FIELDS OF THE HEADER RECS. EXCEPT FOR THE RETAIL                 
*              FEATURE, THEY ARE ALSO KEPT IN A SECOND                          
*              SET OF STATION BUCKET RECORDS, WITH STABKCUR NOT 0.              
*                                                                               
********************************************************************            
         SPACE 2                                                                
WOBILL   NMOD1 0,WOBILL                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         CLI   UPASS,C'T'          SKIP FOR TEST PASS                           
         BE    WOBILLX                                                          
         CLI   SORTTRCE,C'Y'                                                    
         BE    *+12                                                             
         CLI   SORTTRCE,C'O'                                                    
         BNE   *+14                                                             
         MVC   P+1(14),=C'WRITE OLD BILL'                                       
         BRAS  RE,PRNT                                                          
*                                                                               
         L     R7,ADBILL                                                        
         USING BILLREC,R7                                                       
*                                                                               
         XC    BILLREC,BILLREC                                                  
         MVC   BKEYAM,BAGYMD       AM                                           
         MVC   BKEYCLT,BCLT        CLT                                          
*                                  SET BILL MON IN ONE BYTE                     
         UNPK  BKEYMBIL,TODAY+1(1)                                              
         NI    BKEYMBIL,X'FF'-X'0F'                                             
         OC    BKEYMBIL,TODAYB+1                                                
*                                                                               
         MVC   BKEYINV,INVNO                                                    
         MVC   BLINKS+4(2),AGY                                                  
*                                                                               
         MVC   BINVNO,SVINVMO      SVINVMO IS SET IN GETNUM                     
         MVC   BINVMED,SVINVMED    ALSO SET IN GETNUM                           
         MVC   BINVSEQ,AGMFMT      FOR FORMATTING INV NUMBER                    
******** LH    R0,INVNO            (IS NOW PRINTED MONTHOR YM)                  
******** CVD   R0,DUB                                                           
******** OI    DUB+7,X'0F'                                                      
******** UNPK  BINVNO+2(4),DUB                                                  
*                                                                               
         MVC   BDATE,TODAY                                                      
         MVI   BTYPE,C'B'                                                       
         MVC   BTYPE+1(1),TYPE                                                  
         MVC   BRETACCT,SPACES                                                  
         MVC   BLMGR,SPACES                                                     
         MVC   BLMKT,SPACES                                                     
*                                                                               
         MVC   BCALNDR,SPOTPROF+2       TYPE OF CALENDAR                        
*                                                                               
         MVC   BMASPRD,MASPRDCD    MASTER PRODUCT CODE                          
*                                                                               
         MVC   BQDATE,EINVDTE                                                   
         MVC   BDUEDATE,BDUEDTE                                                 
*                                                                               
         MVC   BLREVDAT,MANRVDTP   DATE OF REVERSED INVOICE                     
         MVC   BLREVINO,MANRVNO    REVERSED INVOICE NO.                         
*                                                                               
         MVC   BILLUID,RCORIGID    REQUESTING USER ID                           
         CLI   UPDTSOON,C'Y'       UPDATIVE SOON?                               
         BNE   *+8                                                              
         OI    BILSTAT3,BSTSOONQ   WAS GENERATED VIA SOON                       
*                                                                               
         CLI   QTRADE,C'T'         GROUP M TRADE BILL?                          
         BNE   *+12                                                             
         OI    BILSTAT3,BSTTRDQ    YES, (OLD WAY)                               
         OI    BILSTAT3,BSTTRCNQ   NEW WAY W/ CALC NET                          
*                                                                               
         CLI   LMGSW,C'L'                                                       
         BNE   *+8                                                              
         OI    BILSTAT3,BSTLMGQ                                                 
*                                                                               
         CLI   LMGSW,C'R'                                                       
         BNE   *+8                                                              
         OI    BILSTAT3,BSTREGQ                                                 
*                                                                               
*                             CREATE BILLS FROM PRD-EST-PER TABLE               
         L     R4,APEPTAB          A(TABLE)                                     
         USING PEPTD,R4                                                         
         L     R6,PEPTABN          FOR BCT                                      
         LTR   R6,R6                                                            
         BNZ   WO4                                                              
         CLI   UPASS,C'S'          OK IF CORP SUMMARY BILL                      
         BE    WOBILLX                                                          
         DC    H'0'                NOTHING IN PEPTAB, SHOULD NOT HAPPEN         
*        POSSIBLE CAUSE OF DEATH A MISMATCH OF COS2 FACTOR ON CLT/EST           
*        RECORD AND X'73' ELEM ON THE BUY, LOOK AT SORTRECS                     
*                                                                               
WO4      DS    0H                                                               
         MVC   BLEN,=Y(BILFRLEN)   RECORD LENGTH (FIXED PORTION)                
         CLI   DUESW,C'R'          UNLESS AOR BILL                              
         BE    WO4B                TEST ENTRY ALREADY DONE                      
         CLI   DUESW,C'A'          SEPERATE ADJ INVOICE                         
         BE    WO4A                REGULAR INVS USE 40 BIT                      
         TM    PEPTSTAT,X'40'      TEST ALREADY DONE                            
         BNZ   WO8B                YES, SKIP                                    
         OI    PEPTSTAT,X'40'      ELSE SET DONE                                
         B     WO4B                                                             
*                                                                               
WO4A     DS    0H                  ADJ INVS USE 20 BIT                          
         TM    PEPTSTAT,X'20'      TEST ALREADY DONE                            
         BNZ   WO8B                YES, SKIP                                    
         OI    PEPTSTAT,X'20'      ELSE SET DONE                                
*                                                                               
WO4B     DS    0H                  PRODUCT CODE                                 
         ZIC   R2,PEPTPRD          GET PROD CODE FROM PROD SEQ                  
         MHI   R2,4                                                             
         L     RF,ADCLT                                                         
         LA    RF,CLIST-CLTHDR(RF,R2)                                           
*                                                                               
         MVC   BKEYPRD,0(RF)                                                    
*                                                                               
         MVC   BKEYEST,PEPTEST     EST                                          
         MVC   BKEYYSRV(2),PEPTMOS MOS                                          
         GOTO1 DATCON,DMCB,(3,PEPTMOS),DUB                                      
         MVC   BMONSERV,DUB                                                     
         LA    R2,PERLIST                                                       
         LA    R1,PERLISTX                                                      
         USING PERLISTD,R2                                                      
WO5      DS    0H                                                               
         CLC   PEPTMOS,PERLMOS                                                  
         BE    *+16                                                             
         LA    R2,PERLISTL(R2)                                                  
         CR    R2,R1               PAST EOT ?                                   
         BL    WO5                                                              
         DC    H'0'                SHOULD NEVER HAPPEN                          
******** B     WO5                                                              
         MVC   BILSTADT,PERLSTRT   ACTUAL START DATE                            
         DROP  R2                                                               
*                                                                               
         CLI   MIDAS,C'Y'          FOR MIDAS                                    
         BNE   WO5D                                                             
         L     R0,PEPTGRS+4        ADJUST GROS2 AND NET2 TO REFLECT             
         A     R0,PEPTTRDC+4       TRADE CREDIT                                 
         ST    R0,PEPTGRS+4                                                     
         L     R0,PEPTNET+4                                                     
         A     R0,PEPTTRDC+4                                                    
         ST    R0,PEPTNET+4                                                     
*                                                                               
WO5D     MVI   BILSTAT,0                                                        
         OC    MANGRS,MANGRS       IF MANUAL BILL                               
         BZ    *+8                                                              
         OI    BILSTAT,BSTMANQ     SAY SO                                       
*                                                                               
         MVI   BILSTAT2,0                                                       
         OI    BILSTAT2,BSTVATBQ   VAT (GST) BASIS IN BVATBAS                   
         CLI   PAYOPT,C'N'         CLEARED ITEMS ONLY?                          
         BE    *+8                                                              
         OI    BILSTAT2,BSTCLRDQ                                                
         OC    MANRVDTP,MANRVDTP   REVERSAL?                                    
         BZ    *+8                                                              
         OI    BILSTAT2,BSTRVSLQ                                                
         CLI   WIOPT,C'Y'          PW?                                          
         BNE   *+8                                                              
         OI    BILSTAT2,BSTC2Q     SET COST2                                    
         CLI   COST2SW,C'Y'        COST2 CLIENT COST?                           
         BNE   *+8                                                              
         OI    BILSTAT2,BSTC2Q     COST2                                        
         CLI   MIDAS,C'Y'          MIDAS ?                                      
         BNE   *+8                                                              
         OI    BILSTAT3,BSTMBARQ   MARK BILL AS GRP M MIDAS                     
         CLI   QGMITVC,C'T'        GMI TRADE BILL?                              
         BNE   *+8                                                              
         OI    BILSTAT2,BSTGMITQ                                                
         CLI   QRETCD,C'C'         SPECIAL RETAIL CREDIT BILL                   
         BNE   *+8                                                              
         OI    BILSTAT2,BSTRETCR                                                
         CLI   QRETCD,C'D'         SPECIAL RETAIL DEBIT BILL                    
         BNE   *+8                                                              
         OI    BILSTAT2,BSTRETDB                                                
*                                                                               
         CLI   DUESW,C'R'          IF THIS IS NOT AN AOR BILL                   
         BE    *+18                                                             
         OC    PEPTAORA,PEPTAORA   AND THERE IS AN AOR ACCOUNT                  
         BZ    *+8                                                              
         OI    BILSTAT,BSTCAORQ    THIS MUST BE AN AOR CLIENT BILL              
*                                                                               
         TM    PEPTSTAT,X'80'      TEST COMM ONLY BILL (NOT ADJ INV)            
         BZ    *+8                                                              
         OI    BILSTAT,BSTCMONQ                                                 
*                                                                               
         CLI   SCBNCSW,C'N'        NET BILL IN SEP COMM SITUATION               
         BNE   *+8                                                              
         OI    BILSTAT,BSTSNETQ                                                 
*                                                                               
         CLI   SCBNCSW,C'C'        SCB TYPE COMMISSION BILL?                    
         BNE   WO5H                                                             
         CLI   DUESW,C'R'          AND NOT AOR                                  
         BE    WO6B                                                             
*                                                                               
         OI    BILSTAT,BSTSCOMQ    SEP COMM (SCB)                               
         MVI   BAMT,C'0'                                                        
         MVC   BAMT+1(9),BAMT                                                   
         XC    BNET,BNET                                                        
         XC    BTAXAMT,BTAXAMT     AND TAX                                      
         L     R0,PEPTDUE          DUE                                          
         S     R0,PEPTNET          LESS NET                                     
         STCM  R0,15,BACTUAL       =COMMISSION                                  
         MVI   BVATCOD,0                                                        
         XC    BVATAMT,BVATAMT                                                  
         CLI   PEPTVSW,0          TEST BILL VATABLE                             
         BE    WO5F4                                                            
         MVC   BVATAMT,PEPTVAT     VAT                                          
         MVC   BVATCOD,PEPTVCD     VAT CODE                                     
         BAS   RE,SETPVAT          DO PROVINCIAL VATS                           
*                                                                               
WO5F4    DS    0H                                                               
         XC    BCCGRS,BCCGRS       ZERO 2ND CURR FIELDS                         
         XC    BCCNET,BCCNET                                                    
         XC    BCCTAX,BCCTAX                                                    
         L     R0,PEPTDUE+4        DUE                                          
         S     R0,PEPTNET+4        LESS NET                                     
         STCM  R0,15,BCCACT        =ACTUAL                                      
*                                                                               
*        NOTE- PUTTING GROSS AND NET IN SCB TYPE COMMISSION BILLS               
*              TO PROVIDE A CROSS CHECK WITH BUCKET RECORDS.                    
*                                                                               
         L     R0,PEPTGRS          GROSS                                        
         CVD   R0,DUB                                                           
         UNPK  BAMT,DUB                                                         
         MVC   BNET,PEPTNET        NET                                          
         MVC   BCLDNET,PEPTNETC    CALC NET                                     
         CLI   MIDAS,C'Y'                                                       
         BNE   *+10                                                             
         MVC   BCLDNET,PEPTTRDC+4  TRADE CREDIT                                 
         MVC   BCCGRS,PEPTGRS+4    2ND CURR GROSS                               
         MVC   BCCNET,PEPTNET+4    AND NET                                      
*                                                                               
         B     WO7                                                              
*                                                                               
WO5H     DS    0H                                                               
         CLI   DUESW,C'A'          FOR ADJ INV ZERO GROSS AND NET               
         BNE   WO6B                                                             
*                                                                               
         MVI   BAMT,C'0'                                                        
         MVC   BAMT+1(9),BAMT                                                   
         XC    BNET,BNET                                                        
         XC    BTAXAMT,BTAXAMT     AND TAX                                      
         MVC   BACTUAL,PEPTADJ     ADJ                                          
         OC    BACTUAL,BACTUAL  ***SKIP IF NO ADJUSTMENT AMOUNT (AT             
         BZ    WO8B             ***LEAST ONE ENTRY WILL BE NON-ZERO)            
         MVI   BVATCOD,0                                                        
         XC    BVATAMT,BVATAMT                                                  
         CLI   PEPTVSW,0          TEST BILL VATABLE                             
         BE    WO6A                                                             
         MVC   BVATAMT,PEPTVATC    VAT FOR COMM ADJ INV                         
         MVC   BVATCOD,PEPTVCD     VAT CODE                                     
         BAS   RE,SETPVAT          DO PROVINCIAL VATS                           
*                                                                               
WO6A     DS    0H                                                               
         XC    BCCGRS,BCCGRS       ZERO 2ND CURR FIELDS                         
         XC    BCCNET,BCCNET                                                    
         XC    BCCTAX,BCCTAX                                                    
         MVC   BCCACT,PEPTADJ+4    2ND CURR ADJ                                 
         OI    BILSTAT,BSTSADJQ    SEP ADJUSTMENT                               
         CLI   MIDAS,C'Y'          MIDAS IS LIKE COS2                           
         BE    *+12                                                             
         CLI   COST2SW,C'Y'        FOR COST2 BACTUAL = BCCACT                   
         BNE   *+10                = COS2 ACTUAL                                
         MVC   BACTUAL,BCCACT                                                   
         B     WO7                                                              
*                                                                               
WO6B     DS    0H                                                               
         MVI   BVATCOD,0                                                        
         XC    BVATAMT,BVATAMT                                                  
         CLI   DUESW,C'R'          IF AOR BILL                                  
         BNE   WO6B1                                                            
         MVC   BVATCOD,PEPTAORV    VAT CODE                                     
         MVC   BVATAMT,PEPTVATA    VAT ON AOR AMOUNT                            
*                                                                               
         CLI   COST2SW,C'Y'                                                     
         BNE   WO6BA                                                            
         CLI   PROFB2A+5,C'Y'       AOR ON COST2?                               
         BNE   WO6BA                                                            
         MVC   BVATAMT,PEPTVATA+4  VAT ON COST2 AOR AMOUNT                      
*                                                                               
WO6BA    BAS   RE,SETPVAT          DO PROVINCIAL VATS                           
         B     WO6B2                                                            
*                                                                               
WO6B1    DS    0H                                                               
         CLI   PEPTVSW,C'Y'       TEST BILL VATABLE                             
         BNE   WO6B2                                                            
         MVC   BVATCOD,PEPTVCD     VAT CODE                                     
         MVC   BVATAMT,PEPTVAT     VAT (EXCEPT FOR COMM ADJ BILLS)              
         CLI   UPASS,0             RETAIL?                                      
         BNE   *+8                 YES, PROV VATS LATER                         
         BAS   RE,SETPVAT          ELSE DO THEM NOW                             
*                                                                               
WO6B2    DS    0H                                                               
         CLI   DUESW,C'R'          FOR AOR INV                                  
         BNE   WO6C                                                             
         MVI   BAMT,C'0'           CLEAR GROSS                                  
         MVC   BAMT+1(9),BAMT                                                   
         XC    BNET,BNET           AND NET                                      
         XC    BTAXAMT,BTAXAMT     AND TAX                                      
         XC    BCCGRS,BCCGRS       AND CLT CURR FIELDS                          
         XC    BCCNET,BCCNET                                                    
         XC    BCCTAX,BCCTAX                                                    
*                                  SET ORIGINAL COMMISSION                      
         L     RF,PEPTDUE          DUE                                          
         S     RF,PEPTNET          LESS NET                                     
         STCM  RF,15,BAORCOM       = AC (NB-OVERLAYS NET IN BILLREC)            
         STCM  RF,15,BAORCOMN      ALSO SET IN NEW FIELD                        
         L     RF,PEPTDUE+4        DUE                                          
         S     RF,PEPTNET+4        LESS NET                                     
         STCM  RF,15,BCCAORCM      = AC (CLT CURR)                              
*                                                                               
         MVC   BACTUAL,PEPTAOR     AOR AMOUNT                                   
         MVC   BCCACT,PEPTAOR+4    CLT CURR                                     
         CLI   PROFB2A+5,C'Y'      USE COST2 BASIS?                             
         BNE   *+16                NO                                           
         MVC   BACTUAL,PEPTAOR+4   AOR AMOUNT                                   
         MVC   BCCACT,PEPTAOR+4    CLT CURR                                     
*                                                                               
         CLI   PEPTAORA,C' '       SKIP IF NO AOR ACCOUNT                       
         BNH   WO8B                                                             
         OI    BILSTAT,BSTTAORQ    SET TRUE AOR BILL                            
         CLI   AORLOPT,C'N'        IF AOR PRD/EST/MOS LIST                      
         BE    WO7                                                              
         MVC   BKEYINV,PEPTAORI    SET INVOICE NUMBER FROM PEPTAB               
         XC    DMCB,DMCB                                                        
         GOTO1 =V(SPFMTINO),DMCB,,(C'U',PEPTAORI)                               
         L     RF,DMCB+4                                                        
         OC    0(4,RF),0(RF)       IF NULLS -> INVALID                          
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   BINVNO+2(4),0(RF)                                                
******   SR    R0,R0                                                            
******   ICM   R0,3,PEPTAORI                                                    
******   CVD   R0,DUB                                                           
******   OI    DUB+7,X'0F'                                                      
******   UNPK  BINVNO+2(4),DUB     SET IN RECORD ALSO                           
         B     WO7                                                              
*                                                                               
WO6C     DS    0H                                                               
         CLI   UPASS,0             IS IT RETAIL                                 
         BH    WO6D                YES                                          
*                                  NO                                           
         L     R0,PEPTGRS          GROSS                                        
         CVD   R0,DUB                                                           
         UNPK  BAMT,DUB                                                         
         MVC   BCCGRS,PEPTGRS+4    CLT CURR                                     
         MVC   BNET,PEPTNET        NET                                          
         MVC   BCLDNET,PEPTNETC    CALC NET                                     
         CLI   MIDAS,C'Y'                                                       
         BNE   *+10                                                             
         MVC   BCLDNET,PEPTTRDC+4  TRADE CREDIT                                 
         MVC   BCCNET,PEPTNET+4    CLT CURR                                     
         L     R0,PEPTDUE          ACTUAL                                       
         CLI   ADJSEP,C'Y'         IF THIS IS NORMAL BILL                       
         BNE   *+8                 BUT ADJ IS SEP                               
         S     R0,PEPTADJ          THEN SUBTRACT ADJ FORM THIS BILL             
         STCM  R0,15,BACTUAL                                                    
         L     R0,PEPTDUE+4        ACTUAL (CLT CURR)                            
         CLI   ADJSEP,C'Y'         IF THIS IS NORMAL BILL                       
         BNE   *+8                 BUT ADJ IS SEP                               
         S     R0,PEPTADJ+4        THEN SUBTRACT ADJ FORM THIS BILL             
         STCM  R0,15,BCCACT                                                     
*                                                                               
         CLI   MIDAS,C'Y'                                                       
         BE    *+12                                                             
         CLI   COST2SW,C'Y'        FOR COST2 BACTUAL = BCCACT                   
         BNE   *+8                 = COS2 ACTUAL                                
         STCM  R0,15,BACTUAL                                                    
*                                                                               
         MVC   BTAXAMT,PEPTTAX     TAX AMOUNT                                   
         MVC   BCCTAX,PEPTTAX+4    CLT CURR                                     
         B     WO7                                                              
*                                  RETAIL                                       
WO6D     DS    0H                                                               
         CLI   UPASS,C'S'          IF SUMMARY PASS OK                           
         BE    WO6D2                                                            
         TM    PEPTSTAT,X'10'      ELSE TEST MONTH 'RETAIL ACTIVE'              
         BNZ   WO6D2               YES, OK                                      
         OC    PEPTRETG(8),PEPTRETG    ELSE, SKIP IF NO $                       
         BNZ   WO6D2                                                            
         OC    PEPTRETN(8),PEPTRETN                                             
         BNZ   WO6D2                                                            
         OC    PEPTRETA(8),PEPTRETA                                             
         BNZ   WO6D2                                                            
         B     WO8B                                                             
*                                                                               
WO6D2    DS    0H                                                               
         MVC   BRETAIL,UPASS       1 = CORP 'OUTLET',2+ = DISTRIB               
         CLI   CORPZ,C'Y'          IF CORP NOT AN INVOICE                       
         BNE   *+8                                                              
         OI    BRETAIL,X'80'       CORPORATE CONTROL                            
*                                                                               
         CLI   UPASS,2                                                          
         BL    *+8                                                              
         MVI   BRETAIL,2           ALL DISTRIBS = 2                             
         CLI   UPASS,C'S'          SUMMARY PASS                                 
         BNE   *+8                                                              
         MVI   BRETAIL,X'41'       SUMMARY                                      
*                                                                               
         L     R0,PEPTRETG         GROSS                                        
         CVD   R0,DUB                                                           
         UNPK  BAMT,DUB                                                         
         MVC   BCCGRS,PEPTRETG+4   CLT CURR                                     
         MVC   BNET,PEPTRETN       NET                                          
         MVC   BCCNET,PEPTRETN+4   CLT CURR                                     
         MVC   BACTUAL,PEPTRETA    ACTUAL                                       
         MVC   BCCACT,PEPTRETA+4   CLT CURR                                     
         MVC   BTAXAMT,PEPTRETT    TAX                                          
         MVC   BCCTAX,PEPTRETT+4   CLT CURR                                     
*                                                                               
         XC    BVATAMT,BVATAMT                                                  
         CLI   PEPTVSW,C'Y'       TEST BILL VATABLE                             
         BNE   *+14                                                             
         MVC   BVATAMT,PEPTRETV    SET RETAIL VAT                               
         BAS   RE,SETPVAT          DO PROVINCIAL VATS                           
*                                                                               
         L     R5,AGDAREA                                                       
         USING GDSECT,R5                                                        
         CLI   UPASS,C'S'          FOR SUMMARY                                  
         BNE   *+10                                                             
         MVC   GDMGR(8),SPACES     NO MGR OR MKT                                
         MVC   W,SPACES                                                         
         MVC   W(4),GDMGR                                                       
         ZIC   RF,GDMGRLEN                                                      
         LA    RF,W(RF)                                                         
         CLI   GDMKTLEN,0                                                       
         BE    *+14                                                             
         MVC   0(4,RF),GDMKT                                                    
         LA    RF,4(RF)                                                         
         ICM   RE,15,GDOUTAD                                                    
         BNZ   WO6H                                                             
         CLI   UPASS,C'S'          IF NOT SUMMARY PASS                          
         BE    *+6                                                              
         DC    H'0'                SOMETHING IS WRONG                           
*                                                                               
*        NOTE-  FOR SUMMARY PASS, IF NO OUTLET, SET TO CORPORATE                
*               (COMPENSATES FOR A PROBLEM IN BILCALC WHEN THERE IS A           
*               CLUSTER/DISTRIBUTOR ERROR)                                      
*                                                                               
         LHI   R0,L'GDOCODE                                                     
         ZIC   R1,GDOUTLEN                                                      
         SR    R0,R1                                                            
         DROP  R5                                                               
*                                                                               
         MVC   WORK(7),=C'0000001'   NORMALLY 1                                 
         LA    RE,WORK                                                          
         CLI   RETPROF+12,C'1'       BUT MAYBE FROM PROFILE                     
         BL    *+10                                                             
         MVC   WORK+6(1),RETPROF+12                                             
*                                                                               
         AR    RE,R0               RE= WHERE TO MOVE FROM                       
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),0(RE)                                                    
         B     WO6H2                                                            
*                                                                               
WO6H     DS    0H                                                               
         MVC   0(L'GDOCODE,RF),0(RE)                                            
*                                                                               
WO6H2    DS    0H                                                               
         CLI   MOLSON,C'Y'         IF MOLSON SPECIAL                            
         BNE   *+18                                                             
         CLC   0(6,RF),=C'000001'  GIVE CORPORATE A DIFFERENT                   
         BNE   *+8                                                              
         MVI   5(RF),C'5'          OUTLET CODE (FOR RCVBLS)                     
*                                                                               
         MVC   BRETACCT,W                                                       
*                                                                               
WO7      DS    0H                  SET MGR AND MKT                              
         CLC   AMGR1BRK,AINVBRK    TEST MGR SEP                                 
         BH    *+10                                                             
         MVC   BLMGR,MGR3                                                       
         CLC   AMKTBRK,AINVBRK     TEST MARKET SEP                              
         BH    *+10                                                             
         MVC   BLMKT,MKT                                                        
*                                                                               
         CLI   FLTCTL,C'S'         IF DOING WB FLIGHTS                          
         BNE   *+10                                                             
         MVC   BLFLT,PEPTFLT       SET FLIGHT                                   
*                                                                               
         CLI   BFMIX,C'Y'          IF MIXED FORMULA, DON'T WRITE OUT            
         BNE   *+12                COULD BE MULT MKTS BILL FORMULAS             
         MVI   BILBFB,X'FF'        IN THAT CASE WON'T BE ABLE TO GET            
         B     WO7C                FOR AN INDIVIDUAL MKT                        
*                                                                               
         MVC   BILBFP,PEPTBFP      BILL FORMULA PCT                             
         MVC   BILBFB,PEPTBFB      AND BASIS                                    
         MVC   BILSTABF,PEPTBFFL   AND BASIS FLAGS                              
*                                  ADD INTO REQ TOTALS                          
WO7C     CLI   BRETAIL,X'41'       SKIP CORP SUMMARY                            
         BE    WO7F                                                             
         PACK  DUB,BAMT                                                         
         CVB   R0,DUB                                                           
         A     R0,OBTOTG                                                        
*                                                                               
         CLI   CURR2,0             IF NOT REALLY DOING 2ND CURR                 
         BE    *+10                SKIP (IGNORING IF FOR OTHER USES)            
         ICM   RF,15,BCCGRS        CLT CURR ALSO                                
         AR    R0,RF                                                            
*                                                                               
         ST    R0,OBTOTG                                                        
         CLI   DUESW,C'R'          FOR AOR SKIP NET                             
         BE    WO7F                (IT IS REALLY AC FROM ORIG BILL)             
*                                                                               
         ICM   R0,15,BNET                                                       
         A     R0,OBTOTN                                                        
*                                                                               
         CLI   CURR2,0             IF NOT REALLY DOING 2ND CURR                 
         BE    *+10                SKIP (IGNORING IF FOR OTHER USES)            
         ICM   RF,15,BCCNET        CLT CURR ALSO                                
         AR    R0,RF                                                            
*                                                                               
         ST    R0,OBTOTN                                                        
*                                                                               
         ICM   R0,15,BCLDNET                                                    
         A     R0,OBTOTNC                                                       
         ST    R0,OBTOTNC                                                       
*                                                                               
WO7F     DS    0H                  SET BVATBAS (GST BASIS)                      
         L     RF,PEPTAOR                                                       
         CLI   COST2SW,C'Y'                                                     
         BNE   WO7F1                                                            
         CLI   PROFB2A+5,C'Y'       AOR ON COST2?                               
         BNE   WO7F1                                                            
         L     RF,PEPTAOR+4        COST2 AOR                                    
*                                                                               
WO7F1    CLI   DUESW,C'R'          AOR BILLS                                    
         BE    WO7F2                                                            
*                                                                               
         L     RF,PEPTCVTB                                                      
         CLI   DUESW,C'A'          SEP ADJUSTMENT BILLS                         
         BE    WO7F2                                                            
*                                                                               
         L     RF,PEPTRVTB                                                      
         CLI   UPASS,0             RETAIL BILLS                                 
         BNE   WO7F2                                                            
*                                                                               
         L     RF,PEPTVTB           'NORMAL' BILL                               
*                                                                               
WO7F2    DS    0H                                                               
         STCM  RF,15,BVATBAS                                                    
*                                                                               
* CONVERT THE GROSS, NET, AND ACTUAL ACCUMULATORS TO PACKED DECIMAL,            
* AND STORE THEM IN THE BILL HEADER. THIS METHOD IS TEMPORARY.                  
* EVENTUALLY, THE PROGRAM MUST MAINTAIN THE INTERNAL ACCUMULATORS IN            
* PACKED DECIMAL (A LA NET BILLING).                                            
*                                                                               
         MVC   WORK(10),BAMT       GROSS IS IN EBCDIC                           
         TM    WORK+9,X'F0'        IF SIGN NIBBLE IS X'F'...                    
         BNO   *+8                                                              
         NI    WORK+9,X'CF'        ... CHANGE IT TO X'C'                        
         PACK  BGRSP,WORK(10)      GROSS                                        
*                                                                               
         ICM   RE,15,BNET          NET                                          
         CVD   RE,DUB                                                           
         MVC   BNETP,DUB+2                                                      
*                                                                               
         ICM   RE,15,BACTUAL       ACTUAL                                       
         CVD   RE,DUB                                                           
         MVC   BACTP,DUB+2                                                      
*                                                                               
         ICM   RE,15,BCCGRS        GROSS (COS2)                                 
         CVD   RE,DUB                                                           
         MVC   BGRS2P,DUB+2                                                     
*                                                                               
         ICM   RE,15,BCCNET        NET (COS2)                                   
         CVD   RE,DUB                                                           
         MVC   BNET2P,DUB+2                                                     
*                                                                               
         ICM   RE,15,BCCACT        ACTUAL (COS2)                                
         CVD   RE,DUB                                                           
         MVC   BACT2P,DUB+2                                                     
*                                                                               
         OI    BILSTAT3,BSTCNV1Q   FLAG RECORD AS HAVING PACKED ACCUMS          
*                                                                               
* ONCE ALL PROGRAMS HAVE BEEN CONVERTED TO USE THE PACKED ACCUMULATORS,         
* THE ORIGINAL ACCUMULATORS CAN BE CLEARED HERE TO PROVIDE MORE SPARE.          
*                                                                               
         LA    RE,WORK                                                          
         USING A2REQTBD,RE                                                      
         MVC   A2MEDIA,MED         MEDIA                                        
         MVC   A2CLT,CLT           CLIENT                                       
         MVC   A2PRD,BKEYPRD       PRODUCT                                      
         ZIC   RF,BKEYEST                                                       
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  A2EST,DUB           ESTIMATE                                     
         MVC   A2QUESTR,QUESTOR    REQUESTOR                                    
         DROP  RE                                                               
*                                                                               
         GOTO1 BINSRCH,A2RQPARS,(1,WORK) ADD TO A2 REQUEST TABLE                
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                MUST INCREASE A2REQMAX                       
*                                                                               
         CLI   TESTFLAG,C'T'                                                    
         BE    WO8                                                              
*                                                                               
         OI    DMINBTS,X'08'       PASS DELETES                                 
         MVI   DMOUTBTS,X'FF'-X'02' DELETED RECORDS ARE OK                      
         MVC   KEY,BKEY            SEE IF KEY ALREADY ON FILE                   
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   *+6                                                              
         DC    H'0'                INVOICE NUMBER ALREADY USED!!!               
*                                                                               
         NI    DMINBTS,X'FF'-X'08' NO LONGER PASS DELETES                       
         MVI   DMOUTBTS,X'FF'      NO DATAMGR ERRORS ARE ACCEPTABLE             
*                                                                               
         CLI   RCTRACE,C'Y'                                                     
         BNE   WO7J                                                             
         SR    R0,R0                                                            
         ICM   R0,3,BLEN           RECORD LENGTH                                
         GOTO1 PRNTBL,DMCB,=C'ADD BILL HEADER RECORD',(R7),            +        
               C'DUMP',(R0),=C'1D'                                              
*                                                                               
WO7J     CLI   RCWRITE,C'Y'                                                     
         BNE   WO8                                                              
         GOTO1 ADDBILL                                                          
         MVC   SVPACCT,PEPTPACT    SET PRD ACCT NO FOR INTERFACE                
*                                                                               
WO8      DS    0H                                                               
         GOTO1 ABILLEDI,DMCB,('EDMHDR',0) EDI CALL                              
*                                                                               
         CLI   QINVREG,C'B'        WANT BT IN STEAD OF INV REGISTER ?           
         BE    WO8A                YES, DON'T ADD THIS TO DATASET               
*                                                                               
         CLI   OUTDDFLG,C'Y'       IS "OUT" DD STATEMENT PRESENT?               
         BNE   WO8A                NO                                           
         L     RE,=A(STABUCKC)     PREPARE TO PUT HEADER TO SEQ FILE            
         SR    RF,RF                                                            
         ICM   RF,3,BLEN           L'RECORD                                     
         LR    R0,RF                                                            
         AHI   R0,4                L'RECORD +4(FOR RDW)                         
         STH   R0,0(RE)            PUT L'RECORD IN FIRST 2 BYTES OF RDW         
         XC    2(2,RE),2(RE)       CLEAR 2ND HALFWORD OF RDW                    
         LR    R1,RF               L'RECORD                                     
         LR    R0,R7               R0 = A(RECORD)                               
         LA    RE,4(RE)            COPY HEADER RECORD INTO I/O AREA+4           
         MVCL  RE,R0               VARIABLE LENGTH RECORD IS NOW BUILT          
         L     R3,=A(STABUCKC)     A(RECORD)                                    
         L     R2,=A(OUT)                                                       
         PUT   (R2),(R3)           WRITE TO SYSDA FILE                          
         MVI   HAVEBILL,C'Y'       WE CAN PRINT AN INVOICE REGISTER             
*                                                                               
WO8A     DS    0H                                                               
         L     RF,APATCH           TEST TO TRACE BILL HDR RECS                  
         TM    0(RF),X'80'                                                      
         BZ    WO8B                                                             
         SR    R0,R0                                                            
         ICM   R0,3,BLEN                                                        
         GOTO1 PRNTBL,DMCB,=C'ADDING BILL HEADER',BILLREC,C'DUMP',     +        
               (R0),=C'1D'                                                      
*                                                                               
WO8B     DS    0H                                                               
         A     R4,PEPTABL          NEXT PEPTAB ENTRY                            
         BCT   R6,WO4                                                           
*                                                                               
WOBILLX  DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
**********************************************************************          
*                                                                               
*        SETPVAT - SET PROVINCIAL VAT AMOUNTS                                   
*                                                                               
*         NOTE- +1'S AND +8'S ARE TO BYPASS NATIONAL VAT                        
**********************************************************************          
         SPACE 1                                                                
SETPVAT  NTR1                                                                   
         MVC   BYTE,0(R1)          MODE                                         
         LA    R2,PEPTVCDS+1       VAT CODES                                    
         LA    R3,PEPTVSWS+1       VAT SWITCHES                                 
*                                                                               
         CLI   DUESW,C'R'          AOR BILLS                                    
         BNE   SPV5                                                             
         LA    R2,PEPTAOVS+1       USE AOR VAT CODES                            
         LA    R3,PEPTAOVS+1       ALSO USE AS SWITCHES                         
         LA    R5,PEPTVTAS+8       VAT AMOUNTS                                  
         L     R6,PEPTAOR          AOR AMOUNT IS VAT BASIS                      
         A     R6,PEPTVTAS         ADD GST FOR PROV VAT BASES                   
         CLI   COST2SW,C'Y'                                                     
         BNE   SPV3                                                             
         CLI   PROFB2A+5,C'Y'       AOR ON COST2?                               
         BNE   SPV3                                                             
*                                                                               
         LA    R5,PEPTVTAS+12      VAT AMOUNTS                                  
         L     R6,PEPTAOR+4        AOR AMOUNT IS VAT BASIS                      
         A     R6,PEPTVTAS+4       ADD GST FOR PROV VAT BASES                   
*                                                                               
SPV3     ST    R6,FULL                                                          
         LA    R6,FULL                                                          
         B     SPV10                                                            
*                                                                               
SPV5     DS    0H                                                               
         CLI   DUESW,C'A'          COMM ADJ BILLS                               
         BNE   *+16                                                             
         LA    R5,PEPTVTCS+8       VAT AMOUNTS                                  
         LA    R6,PEPTCVTB+8       VAT BASES                                    
         B     SPV10                                                            
*                                                                               
         CLI   UPASS,0             RETAIL                                       
         BE    *+16                                                             
         LA    R5,PEPTRTVS+8       VAT AMOUNTS                                  
         LA    R6,PEPTRVTB+8       VAT BASES                                    
         B     SPV10                                                            
*                                                                               
*                                  'NORMAL' BILL                                
         LA    R5,PEPTVTS+8        VAT AMOUNTS                                  
         LA    R6,PEPTVTB+8        VAT BASES                                    
*                                                                               
SPV10    DS    0H                                                               
         LHI   R0,NPROVS                                                        
         LA    RE,BILPVELD         START OF PROV VAT 'ELEMENTS'                 
         SR    RF,RF                                                            
         B     SPV14                                                            
*                                                                               
SPV12    DS    0H                                                               
         LA    R2,1(R2)            NEXT CODE                                    
         LA    R3,1(R3)            SWITCH                                       
         LA    R5,8(R5)            NEXT AMOUNT                                  
         CLI   DUESW,C'R'          FOR AOR BASIS IS CONSTANT                    
         BE    *+8                                                              
         LA    R6,8(R6)            NEXT BASIS AMOUNT                            
*                                                                               
SPV14    DS    0H                                                               
         CLI   0(R3),C' '          TEST VAT SWITCH                              
         BNH   SPV50                                                            
*                                                                               
         USING BILPVELD,RE                                                      
         XC    0(BILPVLEN,RE),0(RE)  CLEAR "ELEMENT"                            
         MVC   BILPVCOD,0(R2)      VAT CODE                                     
         CLI   0(R2),X'FF'         IF MIXED                                     
         BNE   *+8                                                              
         MVI   BILPVCOD,C'?'                                                    
         MVC   BILPVBAS,0(R6)      VAT BASIS                                    
         MVC   BILPVAMT,0(R5)      VAT AMOUNT                                   
         LHI   R1,NPROVS+1         PROVINCE = NO. PROVINCES MINUS BCT           
         SR    R1,R0                                                            
         STC   R1,BILPVPRV                                                      
         AHI   RE,BILPVLEN         NEXT SLOT                                    
         AHI   RF,1                COUNT OF ELEMS                               
         DROP  RE                                                               
*                                                                               
SPV50    DS    0H                                                               
         BCT   R0,SPV12                                                         
*                                                                               
         STC   RF,BILNPVTS         COUNT OF VAT ELEMS                           
         MHI   RF,BILPVLEN         TOTAL LENGTH OF ELEM SET                     
         SR    R0,R0                                                            
         ICM   R0,3,BLEN           CURRENT REC LEN                              
         AR    RF,R0                                                            
         STCM  RF,3,BLEN                                                        
*                                                                               
         XIT1                                                                   
         DROP  R4                                                               
         DROP  R7                                                               
         SPACE 1                                                                
         LTORG                                                                  
         TITLE 'INVREG - INVOICE REGISTER MODULE'                               
INVREG   NMOD1 INVREGL,INVREG                                                   
         LR    R9,RC                                                            
         USING INVREGD,R9                                                       
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   DOINVREG,C'Y'       GENERATE INVOICE REGISTER?                   
         BNE   INVRX               NO                                           
         CLI   HAVEBILL,C'Y'       ANY BILL HEADERS GENERATED?                  
         BNE   INVRX               NO                                           
*                                                                               
         MVI   AORSW,0             AOR PASS CONTROL                             
*                                                                               
INVR04   DS    0H                                                               
         CLOSE OUT                 CLOSE AND RE-OPEN BILL HEADER FILE           
         OPEN  (OUT,INPUT)                                                      
*                                                                               
         MVC   QUESTOR,=C'INVOICE REG.' PRINT SMTH TO INDICATE INV REG          
         GOTO1 REQREP,DMCB         FORCE GENERATION OF REQUEST HEADER           
*                                                                               
         LA    R2,P                                                             
         USING ILINED,R2                                                        
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         MVI   RCSUBPRG,20                                                      
         CLI   AORSW,2             AOR PASS                                     
         BNE   *+8                                                              
         MVI   RCSUBPRG,21                                                      
*                                                                               
         MVC   IRTOTS(6),=PL6'0'            CLEAR IRTOTS                        
         MVC   IRTOTS+6(L'IRTOTS-6),IRTOTS                                      
         XC    KEY1,KEY1                                                        
         XC    NBTOTG,NBTOTG                                                    
         XC    NBTOTN,NBTOTN                                                    
*                                                                               
INVR2    DS    0H                                                               
         L     R6,=A(STABUCKC)                                                  
         LA    R7,4(R6)            R7 = A(BILL HEADER)                          
         USING BILLREC,R7                                                       
         L     R1,=A(OUT)          GET 1ST BILL HEADER RECORD (IF ANY)          
         GET   (R1),(R6)                                                        
*                                                                               
         TM    BILSTAT,BSTTAORQ    FOR TRUE AOR BILLS                           
         BZ    INVR3F                                                           
         CLI   AORSW,2             MUST BE AOR PASS                             
         BE    INVR3H                                                           
         MVI   AORSW,1             ELSE SET HAVE AOR BILL                       
         B     INVR2               AND GET NEXT BILL                            
*                                                                               
INVR3F   DS    0H                  NOT AN AOR BILL                              
         CLI   AORSW,2             MUST NOT BE AOR PASS                         
         BE    INVR2                                                            
*                                                                               
INVR3H   DS    0H                  TEST FOR INVOICE BREAK                       
         CLC   BKEY(4),KEY1                                                     
         BNE   *+14                                                             
         CLC   BKEYINV,KEY1+11                                                  
         BE    INVR16                                                           
*                                                                               
         OC    KEY1,KEY1                                                        
         BZ    INVR12                                                           
*                                                                               
         CLC   NBTOTG,=F'1'        IF ONLY 1 INV FOR THIS NUMBER                
         BNH   INVR6               DONT PRINT A TOTAL                           
*                                                                               
         MVC   X(L'IRITOTS),IRITOTS                                             
         BAS   RE,IRFMTL                                                        
         MVC   ILINV,W                                                          
         L     RE,=A(DICSECT)                                                   
         MVC   ILPRD(L'SP5TOTAL),SP5TOTAL-DICSECT(RE)                           
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
INVR6    DS    0H                                                               
         MVC   IRITOTS(6),=PL6'0'            CLEAR IRITOTS                      
         MVC   IRITOTS+6(L'IRITOTS-6),IRITOTS                                   
         XC    NBTOTG,NBTOTG                                                    
         XC    NBTOTN,NBTOTN                                                    
*                                                                               
         CLC   BKEY(4),KEY1        TEST CLIENT BRK                              
         BE    INVR16                                                           
         OC    KEY1,KEY1                                                        
         BZ    INVR12                                                           
*                                  FINSIH UP LAST CLIENT                        
         MVC   X(L'IRCTOTS),IRCTOTS                                             
         MVC   TOTSTAR,=C'* '                                                   
         BAS   RE,IRFMTL                                                        
         L     RE,=A(DICSECT)                                                   
         MVC   P(L'SP7CLI),SP7CLI-DICSECT(RE)  *CLIENT                          
         MVC   P+8(3),SVCLUN                                                    
         L     RE,=A(DICSECT)                                                   
         MVC   P+12(L'SP7TOTAL),SP7TOTAL-DICSECT(RE) TOTALS*                    
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         LA    R4,IRMTOTS          ROLL TO MEDIA TOTALS                         
         LA    R3,IRCTOTS                                                       
         BAS   RE,IRROLL                                                        
*                                                                               
         MVC   IRCTOTS(6),=PL6'0'            CLEAR IRCTOTS                      
         MVC   IRCTOTS+6(L'IRCTOTS-6),IRCTOTS                                   
*                                                                               
         CLC   BKEY(2),KEY1        TEST MEDIA BRK                               
         BE    INVR14                                                           
*                                                                               
         MVC   X(L'IRMTOTS),IRMTOTS                                             
         MVC   TOTSTAR,=C'**'                                                   
         BAS   RE,IRFMTL                                                        
         L     RE,=A(DICSECT)                                                   
         MVC   P(L'SP@MEDTL),SP@MEDTL-DICSECT(RE)  **MEDIA TOTALS**             
         BRAS  RE,PRNT                                                          
         CLI   BKEY,X'FF'                                                       
         BE    INVR30                                                           
         MVC   IRMTOTS(6),=PL6'0'            CLEAR IRMTOTS                      
         MVC   IRMTOTS+6(L'IRMTOTS-6),IRMTOTS                                   
*                                                                               
*                             NEW MEDIA                                         
INVR12   DS    0H                                                               
         CLI   BKEY,X'FF'                                                       
         BE    INVR30                                                           
         MVC   BYTE,BKEYAM                                                      
         NI    BYTE,X'FF'-X'F0'                                                 
         ZIC   R3,BYTE                                                          
         BCTR  R3,0                                                             
         MHI   R3,L'MEDLIST                                                     
         LA    R3,MEDLIST(R3)                                                   
         MVC   MED,0(R3)                                                        
         MVC   MEDNM,1(R3)                                                      
*                                                                               
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
*                             NEW CLIENT                                        
INVR14   DS    0H                                                               
         CLI   AGMCLOPT,C'N'                                                    
         BE    *+8                                                              
         MVI   FORCEHED,C'Y'                                                    
         L     RE,=A(DICSECT)                                                   
         MVC   P(L'SP6CLI),SP6CLI-DICSECT(RE)  CLIENT                           
         XC    KEY,KEY             READ CLIENT                                  
         MVC   KEY(4),BKEY         TO SEE HOW TO UNPACK                         
         GOTO1 READ                                                             
         GOTO1 GETCLT                                                           
         L     RF,ADCLT                                                         
         ZIC   R0,CPROF+6-CLTHDR(RF)                                            
         GOTO1 CLUNPK,DMCB,((R0),BKEYCLT),SVCLUN                                
         MVC   P+7(3),SVCLUN                                                    
         MVC   P2(9),DASHES                                                     
         CLI   P+9,C' '                                                         
         BE    *+8                                                              
         MVI   P2+9,C'-'                                                        
         MVI   ALLOWLIN,6                                                       
         BRAS  RE,PRNT                                                          
         XC    EINVDTE,EINVDTE                                                  
*                                                                               
INVR16   DS    0H                                                               
         CLC   BQDATE,EINVDTE                                                   
         BE    INVR18                                                           
         GOTO1 DATCON,DMCB,BQDATE,(5,P+35)                                      
         L     RE,=A(DICSECT)                                                   
         MVC   P+21(L'SP2INVDT),SP2INVDT-DICSECT(RE) INVOICE DATE =             
         MVI   ALLOWLIN,3                                                       
         BRAS  RE,PRNT                                                          
*                                                                               
*                                                                               
INVR18   DS    0H                                                               
         MVC   ILINV(2),BINVNO          INVOICE NO.                             
         MVI   ILINV+2,C'-'                                                     
         MVC   ILINV+3(4),BINVNO+2                                              
         MVI   ILINV+7,C' '                                                     
         LA    RF,ILINV+7                                                       
         CLI   BRETAIL,X'41'       SUMMARY BILL                                 
         BNE   *+8                                                              
         MVI   0(RF),C'S'                                                       
         CLI   BRETAIL,X'81'       CORP CONTROL                                 
         BNE   *+8                                                              
         MVI   0(RF),C'C'                                                       
         MVC   W(9),ILINV                                                       
*                                                                               
         MVC   ILPRD,BKEYPRD            PRODUCT                                 
*                                                                               
         ZIC   RF,BKEYEST               EST                                     
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  ILEST,DUB                                                        
*                                                                               
         CLI   BCALNDR,10                                                       
         BNE   INVR20                                                           
*                                  SPECIAL CALENDAR PERIODS                     
*                                  SHOW AS MM/YY  MM= 01-13                     
         ZIC   RF,BKEYMSRV                                                      
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  ILPER(2),DUB                                                     
         MVI   ILPER+2,C'/'                                                     
         ZIC   RF,BKEYYSRV                                                      
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  ILPER+3(2),DUB                                                   
         B     INVR22                                                           
*                                                                               
INVR20   DS    0H                                                               
         GOTO1 DATCON,DMCB,(3,BKEYYSRV),(6,ILPER)                               
*                                                                               
INVR22   DS    0H                                                               
*                                                                               
         MVC   ILTYPE(2),BTYPE                                                  
         TM    BILSTAT3,BSTTRCNQ   DO WE HAVE CALCULATED NET?                   
         BZ    *+8                                                              
         MVI   ILTYPE,C'X'         MARK CALC NET BILL WITH X                    
*                                                                               
         TM    BILSTAT3,BSTMBARQ   MARK MIDAS BILL WITH T                       
         BZ    *+8                                                              
         MVI   ILTYPE,C'T'         (FOR TRADE)                                  
*                                                                               
         TM    BILSTAT,BSTSCOMQ    IF SEP COMM BILLING (SCB)                    
         BZ    *+8                                                              
         MVI   ILTYPE,C'C'                                                      
*                                                                               
         MVC   ILMKT(4),BLMKT                                                   
         CLI   BLMKT,C' '                                                       
         BH    *+10                                                             
         MVC   ILMKT(5),BLMGR                                                   
*                                                                               
         CLI   BRETAIL,0                                                        
         BE    *+16                                                             
         MVC   ILMKT(6),BRETACCT   RETAIL ACCT NO.                              
         MVC   ILMKT+132(6),BRETACCT+6                                          
*                                                                               
         CLI   BLFLT,C' '          WB FLIGHT PRESENT?                           
         BNH   *+16                                                             
         MVC   ILINV+133(2),=C'F='                                              
         MVC   ILINV+135(10),BLFLT    FLIGHT CODE                               
*                                                                               
         MVC   X(6),=PL6'0'        CLEAR X                                      
         MVC   X+6(L'IRITOTS-6),X                                               
*                                                                               
         LA    R5,WORK                                                          
         USING SPBVALD,R5                                                       
         GOTO1 SPBVAL,DMCB,(C'B',BILLREC),SPBVALD,0                             
         MVC   X+00(6),SPBVGRSP    EFFECTIVE GROSS                              
*                                                                               
         TM    BILSTAT,BSTTAORQ    FOR TRUE AOR BILLS                           
         BZ    INVR23D                                                          
         ICM   R0,15,BVATAMT       GST                                          
         BAS   RE,PLUSPVAT         PLUS PROV VATS (ADDED TO R0)                 
         CVD   R0,DUB                                                           
         AP    DUB,BACTP           PLUS ACTUAL                                  
         MVC   X+12(6),DUB+2                                                    
         MVC   X+18(6),BACTP       COMMISSION = ACTUAL                          
         B     INVR24                                                           
*                                                                               
INVR23D  DS    0H                                                               
         MVC   X+6(6),SPBVNETP     EFFECTIVE NET                                
         MVC   X+12(6),BACTP       ACTUAL                                       
*                                                                               
         TM    BILSTAT3,BSTTRCNQ   DO WE HAVE CALCULATED NET?                   
         BZ    INVR23F                                                          
         ICM   R0,15,BCLDNET       USE IT IN STEAD OF REGULAR                   
         CVD   R0,DUB                                                           
         MVC   X+6(6),DUB+2                                                     
*                                                                               
         DROP  R5                                                               
*                                                                               
INVR23F  TM    BILSTAT,BSTCMONQ    TEST COMM ONLY BILL                          
         BZ    *+10                                                             
         ZAP   X+6(6),=P'0'        IF SO SET NET=0 (COMM = ACTUAL)              
*                                                                               
         ZAP   DUB,X+12(6)         ACT                                          
         SP    DUB,X+6(6)          -NET                                         
         ZAP   X+18(6),DUB         =AGYCOM                                      
*                                                                               
         ICM   R0,15,BVATAMT       ADD VAT AMOUNT TO ACTUAL                     
         CVD   R0,DUB                                                           
         AP    DUB,X+12(6)                                                      
         CVB   R0,DUB                                                           
         BAS   RE,PLUSPVAT         PLUS PROV VATS (ADDED TO R0)                 
         CVD   R0,DUB                                                           
         MVC   X+12(6),DUB+2                                                    
*                                                                               
         CLI   MIDAS,C'Y'          FOR MIDAS BREAK OUT COMM AND CREDIT          
         BNE   INVR24                                                           
         TM    BILSTAT3,BSTMBARQ   IS THIS MIDAS BILL?                          
         BZ    INVR24                                                           
         ZAP   DOUBLE,BNET2P               MIDAS COMM=NET2-NET                  
         SP    DOUBLE,BNETP                                                     
         ZAP   X+30(6),X(6)                STORE GRS FOR LATER                  
         ZAP   X(6),DOUBLE                 MIDAS COMM INSTED OF GROSS           
         ZAP   DUB,X+18(6)                 COMMISSION MINUS MIDAS               
         SP    DUB,DOUBLE                  EQUAL AGENCY COMM                    
         ZAP   X+18(6),DUB                                                      
         ICM   RE,15,BCLDNET                                                    
         CVD   RE,DUB                                                           
         ZAP   X+24(6),DUB                 TRADE CREDIT                         
*                                                                               
INVR24   DS    0H                                                               
         BAS   RE,IRFMTL                                                        
         CLI   BRETAIL,X'81'       TEST CORP CONTROL                            
         BNE   INVR24D                                                          
         LA    R4,ILCOL2-1         YES-* BEFORE ACT                             
         CLI   1(R4),C' '                                                       
         BNE   *+12                                                             
         LA    R4,1(R4)                                                         
         B     *-12                                                             
         MVI   0(R4),C'*'                                                       
INVR24D  DS    0H                                                               
         LA    R4,IRITOTS          ROLL TO INVOICE TOTALS                       
         LA    R3,X                                                             
         BAS   RE,IRROLL                                                        
*                                                                               
         L     R4,NBTOTG           INCREMENT BILL COUNTER                       
         AHI   R4,1                                                             
         ST    R4,NBTOTG                                                        
*                                                                               
         CLI   BRETAIL,X'81'       DONT ADD FOR CORP CONTROL                    
         BE    *+16                                                             
         LA    R4,IRCTOTS          ROLL TO CLIENT TOTALS                        
         LA    R3,X                                                             
         BAS   RE,IRROLL                                                        
*                                                                               
         MVI   ALLOWLIN,3                                                       
         MVC   KEY1,BKEY                                                        
         MVC   EINVDTE,BQDATE                                                   
         BRAS  RE,PRNT                                                          
         B     INVR2                                                            
*                                                                               
INVR29   DS    0H                  EOF ON DATASET                               
         MVI   BKEY,X'FF'                                                       
         MVC   BKEY+1(12),BKEY                                                  
         B     INVR3H                                                           
*                                                                               
INVR30   DS    0H                  DONE WITH A PASS                             
         CLI   AORSW,2             ALREADY DONE AOR PASS?                       
         BE    INVRX               YES, DONE                                    
         CLI   AORSW,1             NEED TO DO?                                  
         BNE   INVRX                                                            
         MVI   AORSW,2             YES                                          
         B     INVR04              RE-READ THE DATASET                          
*                                  FORMAT AMOUNTS                               
         SPACE 3                                                                
IRFMTL   NTR1                                                                   
         SPACE 2                                                                
         LA    R3,X+12             ACTUAL                                       
         LA    R5,ILCOL2                                                        
         BAS   RE,IRFEDT                                                        
         LA    R3,X+6              NET                                          
         LA    R5,ILCOL3                                                        
         BAS   RE,IRFEDT                                                        
         LA    R3,X+18             COMMISSION                                   
         LA    R5,ILCOL4                                                        
         BAS   RE,IRFEDT                                                        
         LA    R3,X                GROSS                                        
         LA    R5,ILSTRIP                                                       
         BAS   RE,IRFEDT                                                        
         CLI   MIDAS,C'Y'                                                       
         BNE   IRFMTLX                                                          
         LA    R3,X+24             TRADE CREDIT                                 
         LA    R5,ILMISC                                                        
         BAS   RE,IRFEDT                                                        
*        LA    R3,X+30             TEMP CODE FOR GROSS                          
*        LA    R5,ILMISC+16                                                     
*        CURED (P6,0(R3)),(12,0(R5)),CURTAB,COMMAS=YES,CR=YES                   
IRFMTLX  B     INVRX                                                            
         DROP  R2                                                               
         SPACE 2                                                                
IRFEDT   DS    0H                                                               
         ST    RE,DUB                                                           
         CURED (P6,0(R3)),(16,0(R5)),CURTAB,COMMAS=YES,CR=YES                   
         L     RE,DUB                                                           
         CLI   14(R5),C' '                                                      
         BNE   *+10                                                             
         MVC   14(2,R5),TOTSTAR                                                 
         MVC   TOTSTAR,SPACES                                                   
         BR    RE                                                               
         SPACE 2                                                                
INVRX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
*        IRROLL - ROLL UP TOTAL                                                 
IRROLL   DS    0H                                                               
         LHI   R0,5                5 AMOUNTS                                    
*                                                                               
IRROLL2  DS    0H                                                               
         AP    0(6,R4),0(6,R3)                                                  
         LA    R4,6(R4)                                                         
         LA    R3,6(R3)                                                         
         BCT   R0,IRROLL2                                                       
                                                                                
         BR    RE                                                               
         SPACE 2                                                                
*                                                                               
PLUSPVAT DS    0H                  ADD PROVINCIAL VATS TO R0                    
         SR    R6,R6                                                            
         ICM   R6,1,BILNPVTS       NUMBER OF VAT ELEMS                          
         BZR   RE                                                               
         LA    R4,BILPVELD                                                      
*                                                                               
PLUSV4   DS    0H                                                               
         ICM   RF,15,BILPVAMT-BILPVELD(R4)                                      
         AR    R0,RF               ADD TO R0                                    
         LA    R4,BILPVLEN(R4)     NEXT ELEM                                    
         BCT   R6,PLUSV4                                                        
         BR    RE                                                               
         DROP  R7,R9                                                            
         SPACE 2                                                                
MEDLIST  DS    0CL11                                                            
         DC    C'TSPOT TV   '                                                   
         DC    C'RSPOT RADIO'                                                   
         DC    C'NNETWORK TV'                                                   
         DC    C'XNTWK RADIO'                                                   
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
INVREGD  DS    0F                                                               
IRTOTS   DS    0XL90               5 AMOUNTS * PL6                              
IRITOTS  DS    XL30                                                             
IRCTOTS  DS    XL30                                                             
IRMTOTS  DS    XL30                                                             
INVREGL  EQU   *-INVREGD                                                        
         EJECT                                                                  
         TITLE 'PUTA2REQ - CREATE FILE OF A2 REQUESTS'                          
PUTA2REQ NMOD1 0,PUTA2R                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         ICM   R4,15,A2NUMREQ      ANY A2 REQUESTS TO PUT?                      
         BZ    PUTA2X              NO                                           
*                                                                               
         GOTO1 DYNALLOC,DMCB,(C'A',=C'A2REQS  ')                                
         CLI   DMCB+4,0            DD CARD FOR A2REQS IS PRESENT?               
         BE    PUTA2X              NO: DON'T TRY TO OPEN THE DATASET!           
*                                                                               
         OPEN  (A2REQS,OUTPUT)     OPEN A2 REQUEST FILE                         
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         L     R6,=A(A2REQS)       A(DCB) FOR A2REQS DATASET                    
         L     R3,=A(A2REQTAB)     A(A2 REQUEST TABLE)                          
         USING A2REQTBD,R3                                                      
         MVC   REQUEST,SPACES                                                   
         MVC   QPROG-QAREA+REQUEST,=C'A2'                                       
         L     RF,VMASTC                                                        
         MVC   QAGY-QAREA+REQUEST,MCUSER-MASTD(RF)                              
         MVC   QSTAUTO-QAREA+REQUEST(2),=C'ES'                                  
*                                                                               
PUTA210  DS    0H                                                               
         MVC   QMED-QAREA+REQUEST,A2MEDIA                                       
         MVC   QCLT-QAREA+REQUEST,A2CLT                                         
         MVC   QPRD-QAREA+REQUEST,A2PRD                                         
         MVC   QEST-QAREA+REQUEST,A2EST                                         
         MVC   QUESTOR-QAREA+REQUEST,A2QUESTR                                   
         PUT   (R6),REQUEST                                                     
*                                                                               
         LA    R3,A2REQTBL(R3)     BUMP TO NEXT TABLE ENTRY                     
         BCT   R4,PUTA210          PROCESS NEXT                                 
         DROP  R3                                                               
*                                                                               
         CLOSE A2REQS                                                           
         LTR   RF,RF                                                            
         BZ    *+6                                                              
         DC    H'0'                                                             
*                                                                               
PUTA2X   DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
         TITLE 'SPB12C - SPOTPAK BILLING - BOOK C'                              
***********************************************************************         
*                                                                               
*        NOTE- EFFECTIVE DATES FOR RETAIL WORKS RIGHT ONLY WHEN                 
*              ALL THE MONTHS FOR THE REQUEST ARE ON THE SAME BILL.             
*              OTHERWISE SOMETIMES ZERO$ RETAIL BILLS APPEAR AND/OR             
*              SPURIOUS % SHARES (BUT AMOUNTS ARE OK)                           
*                                                                               
***********************************************************************         
         SPACE 3                                                                
*                                  READ BUFFER                                  
         SPACE 2                                                                
RDBUFF   NMOD1 0,RDBUFF,R9,R2                                                   
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         MVI   UPASS,0                                                          
         MVC   SVMKTCTL,MKTCTL                                                  
         MVI   TOTACT,0                                                         
*                                  SET LENGTH OF INV BRK                        
         L     R3,AINVBRK                                                       
         USING BRKTABD,R3                                                       
         L     RF,BRKDISP                                                       
         A     RF,BRKLENM1                                                      
         ST    RF,INVBKLEN                                                      
*                                                                               
         CLI   SORTTRCE,C'Y'       TRACE CONTROL                                
         BE    *+12                                                             
         CLI   SORTTRCE,C'O'       'OUTS' ONLY                                  
         BNE   *+8                                                              
         MVI   RCTRACE,C'Y'                                                     
*                                                                               
         CLI   PBLOPT,C'Y'         PARTIAL BILLING OPTION                       
         BNE   RB0                 IF SO DO FIRST PASS                          
         CLI   RD1OPT,C'E'         BUT NOT IF RETAIL DRAFT ERROR MODE           
         BE    RB0                                                              
         BRAS  RE,PBLCHEK          TO 'DELETE' ERROR ITEMS                      
*                                                                               
RB0      DS    0H                                                               
         XC    SORTREC,SORTREC                                                  
         XC    THISREC(200),THISREC                                             
         XC    PASSREC,PASSREC                                                  
         CLI   AORLOPT,C'C'        UNLESS CLIENT LEVEL AOR                      
         BE    *+10                                                             
         XC    PEPTABN,PEPTABN     CLEAR PRD-EST-PER TAB                        
         XC    ESTFORM,ESTFORM                                                  
         XC    AAEFORM,AAEFORM                                                  
         XC    CVATPSWS,CVATPSWS   CLEAR PRODUCT VAT MIX SWITCHES               
         XC    NVATPSWS,NVATPSWS   CLEAR PRODUCT VAT MIX SWITCHES               
         MVI   LASTPRD,X'FF'                                                    
*                                                                               
         CLC   AMKTBRK,AINVBRK                                                  
         BNH   RB1                                                              
         OC    AMGR1BRK,AMGR1BRK                                                
         BZ    RB1B                                                             
         CLC   AMGR1BRK,AINVBRK                                                 
         BH    RB1B                                                             
RB1      DS    0H                  IF MKT OR MGR ON SEP BILL                    
         MVI   ORIGTYPE,C'0'       OVERRIDE OPTION NOT TO DETAIL MARK           
RB1B     DS    0H                                                               
         MVI   BILSW,C'N'                                                       
         MVI   NDUES,0                                                          
*                                                                               
         BAS   RE,SETPASS0         ALWAYS START WITH PASS 0                     
*                                                                               
RB2      DS    0H                                                               
         GOTO1 BUFFALO,DMCB,=C'HIGH',ABUFFC,THISREC,0                           
         B     RB4B                                                             
RB4      DS    0H                                                               
         GOTO1 BUFFALO,DMCB,=C'SEQ',ABUFFC,THISREC,0                            
RB4B     DS    0H                                                               
         L     R3,ABRKTAB                                                       
         TM    DMCB+8,X'80'        EOF                                          
         BZ    RB6                                                              
         MVI   THISREC,X'FF'                                                    
         MVC   THISREC+1(L'THISREC-1),THISREC                                   
         OC    SORTREC,SORTREC                                                  
         BZ    RB20                DONE IF NO DATA                              
         B     RB8                                                              
*                                                                               
RB6      DS    0H                                                               
         BRAS  RE,CHKSKIP          TEST TO SKIP (100% BILLED                    
         BNE   RB4                     MARKETS, ETC.)                           
*                                                                               
         CLI   PBLOPT,C'Y'         IF DOING PARTIAL BILLING                     
         BNE   RB6A                SKIP LINES 'DELETED' IN FIRST PASS           
*                                                                               
         L     RF,ASORTCOM         POINT TO COMMENT IN THISREC                  
         LA    R0,SORTREC                                                       
         SR    RF,R0                                                            
         LA    RF,THISREC(RF)      TEST 'DELETED' IN EARLIER                    
         CLC   0(4,RF),=C'XXXX'    PARTIAL BILLING CHECK PASS                   
         BE    RB4                                                              
*                                                                               
RB6A     DS    0H                                                               
         L     R7,ASORTDTA         POINT TO DATA                                
         LA    R0,SORTREC                                                       
         SR    R7,R0                                                            
         LA    R7,THISREC(R7)      POINT TO DATA IN THISREC                     
*                                                                               
         CLI   UPASS,C'S'          FOR SUMMARY PASS                             
         BNE   RB6B                                                             
         MVC   SORTREC,THISREC                                                  
         L     R6,ASORTCOM         SKIP ANYTHING WITHOUT CONTROL NO.            
         OC    0(4,R6),0(R6)       (SET IN SETRET)                              
         BZ    RB5                                                              
         CLI   1(R6),X'0C'         IF MONTH HIGHER THAN 0C WILL NOT BE          
         BH    RB5                 CONTROL NO. - SO SKIP                        
         L     R6,APRD             ALSO FILTER ON PRODUCT                       
         CLC   SAVPRD,0(R6)                                                     
         BE    RB6C          NOTE- SKIP MANUAL PCT FOR SUMMARY ITEMS            
*                                                                               
RB5      DS    0H                                                               
         B     RB4                                                              
*                                                                               
RB6B     DS    0H                                                               
         CLI   NETOPT,C'N'         EXCEPT FOR NETPAK                            
         BE    *+14                                                             
         OC    0(ROWTL,R7),0(R7)   SKIP NULL ITEMS                              
         BZ    RB4                                                              
*                                                                               
         OC    MANPCT,MANPCT       TEST PCT= REQUEST                            
         BZ    RB6C                NO                                           
         BRAS  RE,PCTMULT          YES APPLY REQUESTED PERCENTS                 
*                                                                               
RB6C     DS    0H                                                               
         MVC   SORTREC,THISREC                                                  
*                                                                               
*              NOTE- FOR PW BILLING IT IS NECESSARY TO ROUND                    
*                    THE PW GROSS BEFORE COMPARING ORDERED TO BILLED            
*                    BECAUSE IT WILL ALREADY HAVE BEEN ROUNDED                  
*                    WHEN WE DO WNBILL WHICH MAY MEAN THE PEPTAB                
*                    ENTRY ISN'T CREATED WHICH CAUSES A WOBILL DUMP.            
*                    (MAYBE NOT NEEDED HERE, SEE RB18+)                         
*                                                                               
         MVC   DUB(4),4(R7)            SAVE PW GROSS - ORD                      
         MVC   DUB+4(4),ROWHL+4(R7)    SAVE PW GROSS - BILLED                   
         CLI   WIOPT,C'Y'          FOR WESTERN PW                               
         BNE   RBC4                                                             
*                                                                               
         L     R1,DUB                                                           
         M     R0,=F'1'                                                         
         LHI   RF,100                                                           
         DRNDR (R0),(RF)                                                        
         M     R0,=F'100'                                                       
         ST    R1,4(R7)                                                         
*                                                                               
         L     R1,DUB+4                                                         
         M     R0,=F'1'                                                         
         LHI   RF,100                                                           
         DRNDR (R0),(RF)                                                        
         M     R0,=F'100'                                                       
         ST    R1,ROWHL+4(R7)                                                   
*                                                                               
RBC4     DS    0H                                                               
         CLC   0(ROW$L,R7),ROWHL(R7)                                            
         MVC   4(4,R7),DUB         SEEMS BEST TO RESTORE PW GROSS               
         MVC   ROWHL+4(4,R7),DUB+4                                              
         BNE   RB7                 NOTE- CC IS SET BY CLC ABOVE                 
*                                  ZERO ITEM                                    
         CLI   PASSNO,0            CONTINUE IF PASS 0                           
         BE    RB7                                                              
*                                  TEST HERE FOR INV BREAK                      
         OC    OLDKEY,OLDKEY                                                    
         BZ    RB6D                                                             
         L     RF,INVBKLEN         LENGTH OF INV BRK                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   OLDKEY(0),THISKEY                                                
         BNE   RB7                                                              
*                                                                               
RB6D     DS    0H                                                               
         CLI   SPOTCTL,C'Y'                                                     
         BE    RB4                                                              
         CLI   BILSW,C'Y'                                                       
         BNE   RB7                                                              
         CLI   FORMAT,7            FOR FORMATS 7,8,9                            
         BE    RB4                 BYPASS ZERO ITEMS                            
         CLI   FORMAT,8                                                         
         BE    RB4                                                              
         CLI   FORMAT,9                                                         
         BE    RB4                                                              
         BH    RB7                                                              
*                                                                               
         CLC   APMSELO,ALOWTOG     NO-OP ZERO LINE SKIP FOR RECAPS              
         BE    *+14                AND HIGHER LEVEL BILLS                       
         CLC   APMSELO,AMKTBRK     BUT OK IF MKT SUPPRESSED                     
         BNE   RB7                                                              
*                                                                               
         CLI   ZLOPT,C'A'          TEST SKIPPING ZERO LINES                     
         BE    RB4                                                              
         CLC   TYPE,ZLOPT                                                       
         BE    RB4                                                              
         OC    BHLTABN,BHLTABN     DID WE HAVE ANY BHOLD RECS ?                 
         BZ    RB7                                                              
*                                                                               
         BRAS  RE,CKZBHLD                                                       
         BNE   RB4                 FOUND - SKIP THIS ZERO LINE                  
*                                                                               
RB7      DS    0H                                                               
         OC    OLDKEY,OLDKEY       IF FIRST TIME                                
         BZ    RB15                BYPASS BREAK TEST                            
         OC    BRKCODE,BRKCODE                                                  
         BNZ   *+6                                                              
         DC    H'0'                DUPE KEY                                     
         L     R6,BRKDISP                                                       
         LA    R7,OLDKEY(R6)                                                    
         LA    RE,THISKEY(R6)                                                   
         L     RF,BRKLENM1                                                      
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R7),0(RE)                                                    
         BNE   RB8                                                              
         LA    R3,BRKL(R3)                                                      
         B     RB7                                                              
*                                                                               
RB8      DS    0H                                                               
*                                  'LAST' BREAKS                                
         ST    R3,ATHISBRK         SAVE THIS BRK                                
         CLI   PASSNO,0            IF PASS 0                                    
         BNE   RB8B                                                             
         C     R3,AINVBRK          AND INV BRK                                  
         BH    RB18                                                             
         CLI   BILSW,C'Y'          IF ACTIVITY, THEN NOT A 'ZERO BILL'          
         BNE   RB8A2P                                                           
*                                                                               
         OC    BILMIN,BILMIN       IS THERE A BILL MINIMUM?                     
         BZ    RB8A2                                                            
*                                  YES, CHECK AGAINST INVOICE TOTALS            
         ICM   RF,15,BMIGRS        GROSS                                        
         BZ    *+14                                                             
         LPR   RF,RF                                                            
         C     RF,BILMIN                                                        
         BNL   RB8A2               PRODUCE BILL                                 
*                                                                               
         ICM   RF,15,BMIGRS2       GROSS - '2ND CURRENCY'                       
         BZ    *+14                                                             
         LPR   RF,RF                                                            
         C     RF,BILMIN                                                        
         BNL   RB8A2               PRODUCE BILL                                 
*                                                                               
         ICM   RF,15,BMINET        NET                                          
         BZ    *+14                                                             
         LPR   RF,RF                                                            
         C     RF,BILMIN                                                        
         BNL   RB8A2               PRODUCE BILL                                 
*                                                                               
         ICM   RF,15,BMINET2       NET - '2ND CURRENCY'                         
         BZ    RB8A2                                                            
         LPR   RF,RF                                                            
         C     RF,BILMIN                                                        
         BNL   RB8A2               PRODUCE BILL                                 
         B     RB8A4               DON'T IF ALL 4 BILLABLE'S                    
*                                  ARE 0 OR BELOW MIN                           
RB8A2    DS    0H                                                               
         LA    R1,BIGTOTS                                                       
         LHI   R0,8                                                             
*                                                                               
RB8A2C   CP    0(8,R1),=P'2147483647'   MAX POSITIVE FULLWORD VALUE             
         BH    RB8A2D              OVERFLOW                                     
         CP    0(8,R1),=P'-2147483647'  MIN NEGATIVE FULLWORD VALUE             
         BL    RB8A2D              OVERFLOW                                     
         LA    R1,8(R1)            NXT BIG AMOUNT                               
         BCT   R0,RB8A2C                                                        
         B     RB8A2K              PRODUCE BILL                                 
*                                                                               
OVERFLO  DC    P'2147483647'                                                    
*                                                                               
RB8A2D   DS    0H                  ** ARITHMETIC OVERFLOW **                    
         MVI   FORCEHED,C'Y'                                                    
         MVI   P,C'*'                                                           
         MVC   P+1(79),P                                                        
         MVC   P2(80),P1                                                        
         MVC   P3(2),=C'**'                                                     
         MVC   P4(2),=C'**'                                                     
         MVC   P5(2),=C'**'                                                     
         MVC   P6(2),=C'**'                                                     
         MVC   P7(2),=C'**'                                                     
         MVC   P8(2),=C'**'                                                     
         MVC   P9(2),=C'**'                                                     
         MVC   P10(2),=C'**'                                                    
         MVC   P11(2),=C'**'                                                    
         MVC   P3+78(2),=C'**'                                                  
         MVC   P4+78(2),=C'**'                                                  
         MVC   P5+78(2),=C'**'                                                  
         MVC   P6+78(2),=C'**'                                                  
         MVC   P7+78(2),=C'**'                                                  
         MVC   P8+78(2),=C'**'                                                  
         MVC   P9+78(2),=C'**'                                                  
         MVC   P10+78(2),=C'**'                                                 
         MVC   P11+78(2),=C'**'                                                 
         MVC   P12(80),P1                                                       
         MVC   P13(80),P1                                                       
*                                                                               
         MVC   P4+5(38),=C'***ARITHMETIC OVERFLOW- CONTACT DDS***'              
         MVC   P4+45(11),=C'(MAXIMUM IS'                                        
         EDIT  OVERFLO,(15,P4+58),2,FLOAT=$,COMMAS=YES                          
         MVI   P4+73,C')'                                                       
*                                                                               
         MVC   P6+5(19),=C'     ORDERED -GROSS'                                 
         MVC   P7+5(19),=C'PREV. BILLED -GROSS'                                 
         EDIT  BIGOGRS,(16,P6+25),2,FLOAT=$,MINUS=YES,COMMAS=YES                
         EDIT  BIGBGRS,(16,P7+25),2,FLOAT=$,MINUS=YES,COMMAS=YES                
*                                                                               
         MVC   P9+5(19),=C'     ORDERED -GROS2'                                 
         MVC   P10+5(19),=C'PREV. BILLED -GROS2'                                
         EDIT  BIGOGRS2,(16,P9+25),2,FLOAT=$,MINUS=YES,COMMAS=YES               
         EDIT  BIGBGRS2,(16,P10+25),2,FLOAT=$,MINUS=YES,COMMAS=YES              
*                                                                               
         MVC   P6+48(4),=C'-NET'                                                
         MVC   P7+48(4),=C'-NET'                                                
         EDIT  BIGONET,(16,P6+56),2,FLOAT=$,MINUS=YES,COMMAS=YES                
         EDIT  BIGBNET,(16,P7+56),2,FLOAT=$,MINUS=YES,COMMAS=YES                
*                                                                               
         MVC   P9+48(5),=C'-NET2'                                               
         MVC   P10+48(5),=C'-NET2'                                              
         EDIT  BIGONET2,(16,P9+56),2,FLOAT=$,MINUS=YES,COMMAS=YES               
         EDIT  BIGBNET2,(16,P10+56),2,FLOAT=$,MINUS=YES,COMMAS=YES              
*                                                                               
         GOTO1 REPORT                                                           
         BRAS  RE,UNLOCK           ALLOW THE NEXT UPDATIVE SOON                 
         GOTO1 AENDREQ             AFTER OVERFLOW, NEXT REQUEST                 
*                                                                               
*                                  DO NON-ZERO BILL                             
RB8A2K   DS    0H                                                               
         BAS   RE,SETPASS1                                                      
         MVC   SORTREC,OLDREC      RESTORE FOR SETRET                           
         BAS   RE,SETRET                                                        
         MVI   ZEROSW,C'N'         SET PRODUCING ZERO BILL NOW                  
         B     RB14D                                                            
*                                  ELSE END OF INVOICE ON PASS 0                
*                                  MEANS THIS IS A 'ZERO' BILL                  
*                                  SHOULD I PRODUCE IT ?                        
RB8A2P   CLI   RETDRAFT,C'Y'       YES IF RETAIL DRAFT                          
         BE    RB8A3                                                            
*                                                                               
         CLC   TYPE,ZBOPT          NOT IF NOT RIGHT TYPE                        
         BNE   RB8A4                                                            
*                                                                               
         CLI   PRIOR,C'T'          NOT IF MULTI MONTH BILLS                     
         BE    RB8A4                                                            
         CLI   PRIOR,C'V'                                                       
         BE    RB8A4                                                            
         CLI   PRIOR,C'1'                                                       
         BNL   RB8A4                                                            
*                                                                               
*                                  ONLY FOR REQUESTED MONTH                     
         L     RE,APER                                                          
         LA    RE,OLDREC-SORTREC(RE)      USE 'OLDREC' PERIOD                   
         ZIC   RF,0(RE)                                                         
         LA    RF,PERLIST(RF)                                                   
         CLC   CURPER,PERLMOS-PERLISTD(RF)                                      
         BNE   RB8A4                                                            
*                                                                               
*                                  PRODUCE ZERO BILL                            
RB8A3    DS    0H                                                               
         BAS   RE,SETPASS1                                                      
         MVC   SORTREC,OLDREC      RESTORE FOR SETRET                           
         BAS   RE,SETRET                                                        
         MVI   ZEROSW,C'Y'         SET PRODUCING ZERO BILL NOW                  
         B     RB14D                                                            
*                                                                               
RB8A4    DS    0H                  DO NOT PRODUCE BILL                          
         LA    R1,BIGOGRS                                                       
         LHI   R0,8                                                             
         ZAP   0(8,R1),=P'0'                                                    
         LA    R1,8(R1)                                                         
         BCT   R0,*-10                                                          
         MVC   PASSREC,THISREC     SET RESTART POINT                            
         B     RB18                                                             
*                                                                               
RB8B     DS    0H                  NOT PASS ZERO                                
         L     R3,ALOWBRK                                                       
         MVC   SORTREC,OLDREC                                                   
         CLI   UPASS,C'T'          SKIP 'LASTS' FOR TEST PASS                   
         BE    RB10B                                                            
         CLI   RETSKIP,C'Y'        OR IF NO SHARE FOR OUTLET/SCHEME             
         BE    RB10B                                                            
*                                                                               
         CLI   MIDAS,C'Y'          IF MIDAS, SKIP CRDT STATION                  
         B     RB8D                ***LOOKS LIKE SKIPPING ON PURPOSE!           
         L     R1,ASTA                                                          
         MVC   THREE,0(R1)                                                      
         NI    THREE+2,X'F0'       TURN OFF LAST NIBBLE                         
         CLC   =X'17B340',THREE                                                 
         BE    RB10B                                                            
*                                  AT LOWEST LEVEL PUT INTO TOTALS              
RB8D     L     R1,APER                                                          
         ZIC   RF,0(R1)                                                         
         SR    RE,RE                                                            
         D     RE,=F'6'                                                         
         MHI   RF,ROWL             RF = DISP INTO ACCUM                         
         L     RE,BRKCODE                                                       
         A     RF,ATOTS(RE)      POINT TO THIS ACCUM                            
         L     R7,ASORTDTA                                                      
         MVC   0(ROWTL,RF),0(R7)                                                
*                                                                               
         L     R7,ATOTS(RE)                                                     
         AHI   R7,MAXMOS*ROWL      POINT TO TOTAL ROW                           
*                                                                               
         CLI   MIDAS,C'Y'          IF MIDAS, SKIP CRDT STATION                  
         BNE   RB8F                                                             
         L     R1,ASTA                                                          
         MVC   THREE,0(R1)                                                      
         NI    THREE+2,X'F0'       TURN OFF LAST NIBBLE                         
         CLC   =X'17B340',THREE                                                 
         BE    RB9A                                                             
*        B     RB9                                                              
*        L     R1,TRDCDSP(R7)                                                   
*        A     R1,4(RF)                                                         
*        S     R1,ROWHL+4(RF)                                                   
*        ST    R1,TRDCDSP(R7)                                                   
*        B     RB9A                                                             
*                                                                               
RB8F     LHI   R0,16                                                            
RB9      DS    0H                                                               
         L     R1,0(R7)                                                         
         A     R1,0(RF)                                                         
         ST    R1,0(R7)                                                         
         LA    R7,4(R7)                                                         
         LA    RF,4(RF)                                                         
         BCT   R0,RB9                                                           
*                                                                               
RB9A     CLI   PASSNO,1            FOR PASS 1                                   
         BNE   RB9B                                                             
         CLI   CVATCOD,0           AND IF DOING VAT                             
         BE    RB9B                                                             
         GOTOR VBADD,DMCB,SORTREC,BRKTABD  ADD TO GST/PST BASES                 
*                                                                               
RB9B     DS    0H                                                               
         L     R5,APER             PUT INV NO. INTO INV LIST                    
         ZIC   RF,0(R5)                                                         
         LA    RF,INVLIST(RF)                                                   
         L     R5,ASORTCOM         A(INV NO)                                    
         OC    0(4,R5),0(R5)       NO INV NO.                                   
         BZ    *+10                                                             
         MVC   0(4,RF),0(R5)                                                    
*                                                                               
         B     *+8                                                              
RB10     DS    0H                                                               
         SHI   R3,BRKL             BACK UP THRU LIST                            
RB10B    DS    0H                                                               
         C     R3,ATHISBRK                                                      
         BL    RB14J                NO MORE                                     
*                                                                               
         MVC   SORTREC,OLDREC                                                   
         CLI   UPASS,C'T'          SKIP 'LASTS' FOR TEST PASS                   
         BE    RB11B                                                            
         CLI   RETSKIP,C'Y'        OR IF NO SHARE FOR OUTLET/SCHEME             
         BE    RB11B                                                            
         C     R3,APMSELO          AT LOWEST OF PRD,MKT,STA,EST                 
         BNE   RB11B                                                            
         CLC   ORIGTYPE,TYPE       OPTION NOT TO DETAIL MARK FILE               
         BE    RB11B                                                            
         BRAS  RE,WNBILL           ADD STATION BUCKETS                          
*                                                                               
RB11B    DS    0H                                                               
         C     R3,APRDBRK                                                       
         BH    *+10                                                             
         MVC   RETSKIP,PRDSKIP                                                  
*                                                                               
         C     R3,AINVBRK                                                       
         BL    RB11D               BYPASS LAST'S IF 'ABOVE' INV BRK             
         BH    *+10                                                             
*                                                                               
         MVC   RETSKIP,INVSKIP     ON INVBRK USE INVSKIP                        
         MVI   BYTE,C'L'                                                        
         BAS   RE,RBTRCE                                                        
*                                                                               
         CLI   UPASS,C'T'          SKIP 'LASTS' FOR TEST PASS                   
         BE    RB11D                                                            
*                                                                               
         CLI   BRKCTL1,C'S'        NO SEPARATES                                 
         BNE   *+12                                                             
         CLI   UPASS,C'S'          ON SUMMARY PASS                              
         BE    RB11D                                                            
*                                                                               
         CLI   RETSKIP,C'Y'        OR IF NO SHARE FOR OUTLET/SCHEME             
         BE    RB11D                                                            
         MVI   INVSKIP,C'N'        SET NOT TO SKIP INV                          
         MVI   PRDSKIP,C'N'        OR PRODUCT                                   
*                                  IF ANY EST NOT SKIPPED                       
         MVI   PRSW,C'H'           SET TO HOLD LINES                            
         L     RF,BRKCODE                                                       
         BAS   RE,LASTTAB-4(RF)                                                 
*                                                                               
RB11D    DS    0H                                                               
         C     R3,AINVBRK                                                       
         BNE   RB13B                                                            
         CLI   INVSKIP,C'Y'                                                     
         BE    RB14B                                                            
         CLI   UPASS,C'T'          SKIP 'LASTS' FOR TEST PASS                   
         BE    RB14B                                                            
         BRAS  RE,ENDINV                                                        
         L     RF,BRKCODE          CLEAR INV LEVEL ACCUM                        
         L     RE,ATOTS(RF)        (ROLLUP WOULD HAVE SAME EFFECT??)            
         LHI   RF,TOTSIZE                                                       
         XCEF                                                                   
         GOTOR VBROLL,DMCB,BRKTABD TRY VBROLL TO CLEAR INVOICE                  
*                                       LEVEL VAT TABLE ENTRIES                 
         B     RB14B                                                            
*                                                                               
RB13B    DS    0H                                                               
         BRAS  RE,ROLLUP           ROLL UP ACCUMES                              
         GOTOR VBROLL,DMCB,BRKTABD AND GST/PST TABLE                            
         B     RB10                                                             
*                                                                               
RB14B    DS    0H                                                               
         CLI   RETPROF,0           TEST RETAIL                                  
         BE    RB14B2              NO                                           
         CLI   RETERR,0            TEST RETAIL ERROR                            
         BNE   RB14H               YES - NEXT INV - BACK TO PASS 0              
*                                                                               
         CLI   UPASS,C'S'                                                       
         BE    RB14H               DONE AFTER SUMMARY PASS                      
         CLI   UPASS,1             AND QFTER CORP PASS (PASS 1)                 
         BE    RB14H                                                            
         CLI   UPASS,C'T'          IS IT TEST PASS                              
         BNE   *+8                                                              
         MVI   UPASS,1             START AT 2 (DO PASS 1 (CORP) LAST)           
*                                                                               
RB14B04  DS    0H                                                               
         ZIC   RF,UPASS            BUMP UNDERPASS                               
         AHI   RF,1                                                             
         STC   RF,UPASS                                                         
         MVI   RETSKIP,C'N'                                                     
         MVI   CORPZ,C'N'          NOT A CORP INV                               
         MVI   INVSKIP,C'Y'                                                     
         MVI   PRDSKIP,C'Y'                                                     
*                                                                               
RB14B1   DS    0H                                                               
         L     R4,AGDAREA                                                       
         USING GDSECT,R4                                                        
         MVC   GDOUTNO,UPASS                                                    
         MVC   GDSCHM,SPACES                                                    
         GOTO1 =V(FINDOUT),DMCB,AGDAREA                                         
         OC    GDOUTAD,GDOUTAD            TEST END OF OUTLES                    
         BNZ   RB14B1A                                                          
*                                                                               
         CLI   UPASS,1                                                          
         BE    RB14H                                                            
         CLI   RETDRAFT,C'Y'       NO CORP PASS IF DRAFT                        
         BNE   RB14B102                                                         
         CLC   GDNOUTS,=F'1'       UNLESS ONLY ONE OUTLET                       
         BNH   RB14B102                                                         
         CLI   RDRFCORP,C'Y'       OR OPTION TO DO CORP                         
         BNE   RB14H                                                            
*                                                                               
RB14B102 DS    0H                                                               
         MVI   UPASS,1             DO CORP PASS                                 
         CLI   SUMOPT,C'Y'         IF WILL DO SUMMARY                           
         BNE   *+8                                                              
         MVI   CORPZ,C'Y'          CORP BILL NOT AN INVOICE                     
         B     RB14B1                                                           
*                                                                               
RB14B1A  DS    0H                                                               
         L     R4,GDOUTAD                                                       
*                                  FOR SPECIAL RETAIL CREDIT/DEBIT              
         CLI   QRETCD,C' '                                                      
         BNH   RB14B1C                                                          
         CLC   QRETOUT,GDOCODE-GDOUTD(R4)                                       
         BE    RB14B1C             SKIP UNLESS DESIGNATED OUTLET                
         CLI   UPASS,1             IF NOT, AND IS PASS 1 (CORP)                 
         BE    RB14H               DONE                                         
         B     RB14B04             NEXT OUTLET                                  
*                                  SET ADDRESS                                  
RB14B1C  DS    0H                                                               
         BAS   RE,SETADDR                                                       
         CLI   UPASS,1                                                          
         BNE   *+18                                                             
         L     RF,=A(CADDRS)       SAVE ADDRESS                                 
         L     RE,=A(BADDRS)                                                    
         MVC   0(ADDRLEN/2,RF),0(RE)                                            
         MVC   ADDRLEN/2(ADDRLEN/2,RF),ADDRLEN/2(RE)                            
         B     RB14D                                                            
         DROP  R4                                                               
*                                                                               
RB14B2   DS    0H                                                               
         ZIC   RF,PASSNO           BUMP PASS NO                                 
         AHI   RF,1                                                             
         STC   RF,PASSNO                                                        
*                                                                               
         CLI   PASSNO,2                                                         
         BH    RB14H                                                            
         OC    ARECAP,ARECAP                                                    
         BZ    RB14B                                                            
         MVC   FORMAT,DFORMAT                                                   
         MVC   APAGBRK,SVPAGBRK    RESTORE BRK CONTROLS                         
         MVC   ALOWTOG,SVLOWTOG                                                 
         MVC   SPOTCTL,SPOTSW      SPOT DETAIL ON BACKUP                        
         CLI   SPOTCTL,C'Y'                                                     
         BNE   *+8                                                              
         MVI   FORMAT,0                                                         
         BAS   RE,SETCOLS                                                       
RB14D    DS    0H                                                               
         XC    OLDREC,OLDREC                                                    
         MVC   THISREC,PASSKEY                                                  
         B     RB2                                                              
*                                                                               
RB14H    DS    0H                                                               
         MVC   PASSREC,THISREC                                                  
         BAS   RE,SETPASS0         BACK TO PASS 0                               
         MVI   BILSW,C'N'                                                       
*                                                                               
RB14J    DS    0H                                                               
         L     R3,ATHISBRK         RESTORE R3                                   
*                                                                               
RB15     DS    0H                                                               
         CLC   =X'FFFFFFFFFFFF',THISKEY  AT EOF DONT DO 'FIRSTS'                
         BE    RB20                                                             
*                                  'FIRSTS'                                     
RB16     DS    0H                                                               
         MVC   SORTREC,THISREC                                                  
         L     RF,BRKCODE                                                       
         LTR   RF,RF                                                            
         BZ    RB19                                                             
         MVI   BYTE,C'F'                                                        
         BAS   RE,RBTRCE                                                        
         CLI   PASSNO,1                                                         
         BE    *+16                                                             
         BL    RB18                                                             
         C     R3,AINVBRK                                                       
         BL    RB17                                                             
*                                                                               
         CLI   UPASS,C'T'          FOR TEST PASS                                
         BNE   *+16                                                             
         C     R3,AESTBRK          DO ONLY EST FIRST                            
         BNE   RB17                                                             
         B     RB16C                                                            
*                                                                               
         CLI   RETSKIP,C'Y'        IF SKIP                                      
         BNE   RB16C                                                            
         C     R3,AESTBRK          BYPASS BRKS 'BELOW' EST                      
         BH    RB17                                                             
RB16C    DS    0H                                                               
         MVI   PRSW,C'H'           SET TO HOLD LINES                            
         L     RF,BRKCODE                                                       
         BAS   RE,FRSTTAB-4(RF)                                                 
*                                                                               
         CLI   RETSKIP,C'Y'        TEST SKIP BECAUSE OF ZERO PCT                
         BE    RB17                                                             
*                                                                               
         C     R3,APAGBRK                                                       
         BNE   RB16F                                                            
*                                        ENSURE HAVE RIGHT ESTHDR               
         L     RF,ADCLT                                                         
         CLI   CEXTRA+6-CLTHDR(RF),C'Y'  TEST EST=NO=NAME OPTION                
         BNE   RB16E6                                                           
         L     RF,ADCLT            BUILD EST KEY                                
         MVC   KEY,0(RF)                                                        
         L     RE,APRD                                                          
         ZIC   R4,0(RE)                                                         
         MHI   R4,4                                                             
         LA    R4,CLIST-CLTHDR(RF,R4)     GET ALPHA PRD                         
         MVC   KEY+4(3),0(R4)                                                   
         L     RF,AEST                                                          
         MVC   KEY+7(1),0(RF)                                                   
         L     R4,ADEST                                                         
         CLC   KEY(13),0(R4)       TEST ALREADY HAVE ESTHDR                     
         BE    RB16E6                                                           
         GOTO1 READ                                                             
         GOTO1 GETEST                                                           
*                                                                               
RB16E6   DS    0H                                                               
         MVI   RCSUBPRG,100        SET SPECIAL HEADLINES                        
         BRAS  RE,PRNT                                                          
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
RB16F    DS    0H                                                               
         C     R3,AINVBRK                                                       
         BNE   RB17                                                             
*                             SPECIAL COMMENTS FOR SPECIAL BILLS                
         CLI   MSGSW,C'Y'          ONLY ONCE PER INVOICE                        
         BE    RB17                                                             
         MVI   MSGSW,C'Y'                                                       
*                                                                               
         CLI   PAYOPT,C'N'                                                      
         BE    RB16G                                                            
* '** ORDERED AMOUNTS ARE BASED ON STATION INVOICE CLEARANCES **'               
         L     RE,=A(DICSECT)                                                   
         MVC   P(L'SP@ORD01),SP@ORD01-DICSECT(RE)                               
*                                                                               
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
RB16G    DS    0H                                                               
         OC    MANPCT,MANPCT                                                    
         BZ    RB16H                                                            
         L     RE,=A(DICSECT)                                                   
         MVC   P(L'SP@AMNT),SP@AMNT-DICSECT(RE)  ** AMOUNTS ARE                 
         LA    R4,P+L'SP@AMNT+1                                                 
         CURED (B4,MANPCT),(6,0(R4)),CURTAB,ALIGN=LEFT                          
         AR    R4,R0                                                            
         L     RE,=A(DICSECT)                                                   
         MVC   1(L'SP@PCTOC,R4),SP@PCTOC-DICSECT(RE) PERCENT OF ACTUAL          
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
RB16H    DS    0H                                                               
         OC    MANRVNO,MANRVNO                                                  
         BZ    RB16I                                                            
         L     RE,=A(DICSECT)                                                   
***      MVC   P(L'SP@RVSIN),SP@RVSIN-DICSECT(RE) ** REVERSAL INVOICE *         
         MVC   P(L'SP@REV01),SP@REV01-DICSECT(RE) ** REVERSAL INVOICE *         
         GOTO1 DATCON,DMCB,(2,MANRVDTP),(3,DUB)                                 
         MVC   W(1),DUB+1          MONTH                                        
         MVC   SVSVIMO,SVINVMO     SAVE SAVED INVNO MONTH                       
         MVC   THREE,TODAYB        SAVE TODAY, GETNUM NEEDS                     
         MVC   TODAYB(1),DUB       REVERSAL YEAR                                
         GOTO1 AGETNUM,DMCB,(1,MANRVNO),P+22                                    
         MVC   TODAYB,THREE        RESTORE TODAY                                
         MVC   SVINVMO,SVSVIMO     RESTORE SAVED INVNO MONTH                    
*                                                                               
         GOTO1 DATCON,DMCB,(2,MANRVDTP),(5,WORK)                                
         MVC   P+39(8),WORK                                                     
         MVC   P+39+9(2),=C'**'                                                 
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
RB16I    DS    0H                                                               
         MVI   PUMODE,C'F'         USER FIELDS, FRONT OF BILL                   
         BRAS  RE,PRTUSER                                                       
*                                                                               
RB17     DS    0H                                                               
         LA    R3,BRKL(R3)                                                      
         B     RB16                                                             
*                                                                               
RB18     DS    0H                                                               
*                                  PASS 0                                       
         L     R6,ASORTDTA                                                      
*                                                                               
*                                                                               
         LR    RF,R6               SORTREC                                      
         LA    RE,BIGTOTS          ADD TO BIG TOTALS                            
         LHI   R0,4                GROSS AND NET, 1ST AND 2ND CURR              
         SR    R1,R1                                                            
*                                                                               
RB18B    DS    0H                                                               
         L     R1,0(RF)            ORDERED                                      
         CVD   R1,DUB                                                           
         AP    0(8,RE),DUB                                                      
         L     R1,ROWHL(RF)        GET TO BILLED AMOUNTS                        
         CVD   R1,DUB                                                           
         AP    BILLED(8,RE),DUB       BILLED                                    
         LA    RE,8(RE)                                                         
         LA    RF,4(RF)                                                         
         BCT   R0,RB18B                                                         
*              NOTE- FOR PW BILLING IT IS NECESSARY TO ROUND                    
*                    THE PW GROSS BEFORE COMPARING ORDERED TO BILLED            
*                    BECAUSE IT WILL ALREADY HAVE BEEN ROUNDED                  
*                    WHEN WE DO WNBILL WHICH MAY MEAN THE PEPTAB                
*                    ENTRY ISN'T CREATED WHICH CAUSES A WOBILL DUMP.            
*                                                                               
         MVC   DUB(4),4(R6)            SAVE PW GROSS - ORD                      
         MVC   DUB+4(4),ROWHL+4(R6)    SAVE PW GROSS - BILLED                   
         CLI   WIOPT,C'Y'          FOR WESTERN PW                               
         BNE   RB18D                                                            
*                                                                               
         L     R1,DUB                                                           
         M     R0,=F'1'                                                         
         LHI   RF,100                                                           
         DRNDR (R0),(RF)                                                        
         M     R0,=F'100'                                                       
         ST    R1,4(R6)                                                         
*                                                                               
         L     R1,DUB+4                                                         
         M     R0,=F'1'                                                         
         LHI   RF,100                                                           
         DRNDR (R0),(RF)                                                        
         M     R0,=F'100'                                                       
         ST    R1,ROWHL+4(R6)                                                   
*                                                                               
RB18D    DS    0H                                                               
         CLC   0(ROW$L,R6),ROWHL(R6)                                            
         MVC   4(4,R6),DUB         SEEMS BEST TO RESTORE PW GROSS               
         MVC   ROWHL+4(4,R6),DUB+4                                              
         BE    RB19                NOTE- CC SET BY CLC ABOVE                    
*                                                                               
         CLI   QTRADE,C'T'         IF TRADE                                     
         BNE   RB18D7                                                           
         CLC   0(8,R6),ROWHL(R6)   COMPARE ONLY GROSS                           
         BNE   RB18D7                                                           
*        MVC   W(ROWTL),0(R6)                                                   
*        XC    W+RNETD(8),W+RNETD  CLEAR OUT ORDERED AND BILLED NET             
*        XC    W+RNETD+ROWHL(8),W+RNETD+ROWHL                                   
*        CLC   W(ROW$L),W+ROWHL    COMPARE W/OUT NET                            
         L     R0,RNETD(R6)        IF EQUAL, CHK IF DIFFR < THEN .50C           
         S     R0,ROWHL+RNETD(R6)                                               
         LPR   R0,R0                                                            
         CHI   R0,50                                                            
         BL    RB19                IF LESS TREAT AS ZERO BILL                   
*        MVC   ROWHL+RNETD(8,R6),RNETD(R6) OVERRIDE BILLED NET                  
*                                                                               
RB18D7   MVI   BILSW,C'Y'          SET ACTIVITY                                 
*                                                                               
         OC    BILMIN,BILMIN       IF HAVE BILL MINIMUM                         
         BZ    RB19                DON'T INTERRUPT PASS 0 NOW                   
*                                                                               
*                               ADD UP INVOICE TOTALS (LESS                     
*                               DISRUPTIVE THAT USING NORMAL BUFFERS)           
         LR    RF,R6               SORTREC                                      
         LA    RE,BMITOTS          BILL MINIMUM TEST TOTALS                     
         LHI   R0,4                GROSS AND NET, 1ST AND 2ND CURR              
         SR    R1,R1                                                            
*                                                                               
RB18D2   DS    0H                                                               
         L     R1,0(RE)                                                         
         A     R1,0(RF)                                                         
         S     R1,ROWHL(RF)        LESS BILLED                                  
         ST    R1,0(RE)                                                         
         LA    RE,4(RE)                                                         
         LA    RF,4(RF)                                                         
         BCT   R0,RB18D2                                                        
         B     RB19                                                             
*                        THIS CODE SHOULD BE OBSOLETE NOW                       
*                        WILL RESET PATH WHEN CHECKING BIGTOTS                  
*                        ALWAYS DO A TST PATH TO CHK BIGTOTS                    
RB18H    DS    0H                                                               
         MVI   BILSW,C'Y'          SET ACTIVITY                                 
         MVI   ZEROSW,C'N'         RESET ZERO-BILLING SWITCH                    
         BAS   RE,SETPASS1         AND DO PASS 1                                
         BAS   RE,SETRET                                                        
         B     RB14D                                                            
*                                                                               
RB19     DS    0H                                                               
         CLC   =X'FFFFFFFFFFFF',THISKEY                                         
         BE    RB20                                                             
         MVC   OLDREC,THISREC                                                   
         B     RB4                                                              
*                                                                               
RB20     DS    0H                                                               
*                                                                               
         CLI   SUMOPT,C'Y'         TEST DOING CORP SUMMARY (RETAIL)             
         BNE   RB30                NO                                           
         CLI   UPASS,C'S'          TEST ALREADY DONE                            
         BE    RB26                YES                                          
         MVI   UPASS,C'S'                                                       
         MVI   CORPZ,C'N'          CORP INV CONTROL                             
*                                                                               
         L     RF,=A(BADDRS)       RESTORE ADDRESSES                            
         L     RE,=A(CADDRS)                                                    
         MVC   0(ADDRLEN/2,RF),0(RE)                                            
         MVC   ADDRLEN/2(ADDRLEN/2,RF),ADDRLEN/2(RE)                            
         L     RF,=A(AADDRS)                                                    
         MVC   0(ADDRLEN/2,RF),0(RE)                                            
         MVC   ADDRLEN/2(ADDRLEN/2,RF),ADDRLEN/2(RE)                            
*                                                                               
*                                  CLEAR VARIOUS BREAK CLTS                     
         L     RF,ABRKTAB                                                       
         ST    RF,APAGBRK                                                       
         ST    RF,SVPAGBRK                                                      
         MVC   AINVBRK,APERGBRK                                                 
         XC    ALOWTOG,ALOWTOG                                                  
         XC    AHITOG,AHITOG                                                    
*                                  RESET BREAK CONTROLS                         
         L     R3,ABRKTAB                                                       
*                                                                               
RB21     DS    0H                                                               
         OC    BRKCODE,BRKCODE                                                  
         BZ    RB25B                                                            
         C     R3,APERGBRK         DUMMY 'SEPARATE'                             
         BE    RB25                                                             
         C     R3,APRDBRK          FORCE PRD SEPARATE                           
         BNE   *+12                                                             
         MVI   BRKCTL1,C'S'                                                     
         B     RB24                                                             
         C     R3,AESTBRK          FORCE EST TOGETHER                           
         BNE   *+8                                                              
         MVI   BRKCTL1,C'S'                                                     
         C     R3,APERBRK          FORCE PERIOD TOGETHER                        
         BNE   *+8                                                              
         MVI   BRKCTL1,C'S'                                                     
         CLI   BRKCTL1,C'S'        SEPARATE                                     
         BNE   RB22                                                             
         MVI   BRKCTL1,C'T'        TO TOGETHER                                  
*                                                                               
         C     R3,APERBRK                                                       
         BE    RB21B                                                            
         C     R3,ACTYPBRK                                                      
         BE    RB21B                                                            
         C     R3,APGMBRK                                                       
         BE    RB21B                                                            
*                                                                               
         ST    R3,ALOWTOG                                                       
         ST    R3,SVLOWTOG                                                      
*                                                                               
RB21B    DS    0H                                                               
         OC    AHITOG,AHITOG                                                    
         BNZ   *+8                                                              
         ST    R3,AHITOG                                                        
         B     RB24                                                             
*                                                                               
RB22     DS    0H                                                               
         CLI   BRKCTL1,C'T'        TOGETHER                                     
         BE    *+12                                                             
         CLI   BRKCTL1,C'P'                                                     
         BNE   RB24                                                             
*                                                                               
         MVI   BRKCTL1,C'N'        TO NO                                        
*                                                                               
RB24     DS    0H                                                               
         LA    RF,LEVCTLS                                                       
         A     RF,BRKCODE                                                       
         MVC   0(1,RF),BRKCTL1                                                  
*                                                                               
RB25     DS    0H                                                               
         LA    R3,BRKL(R3)                                                      
         B     RB21                                                             
*                                                                               
RB25B    DS    0H                                                               
         MVI   SAVPRD,0            START WITH FIRST PRODUCT                     
         SR    RF,RF                                                            
         B     RB26B                                                            
RB26     DS    0H                                                               
         ZIC   RF,SAVPRD                                                        
         LA    RF,1(RF)            NEXT PRD                                     
RB26B    DS    0H                                                               
         A     RF,AINVTAB                                                       
RB26C    DS    0H                                                               
         CLI   0(RF),0             TEST ACTIVE PRD                              
         BNE   RB26D               YES                                          
         LA    RF,1(RF)            NO - NEXT PRD                                
         LR    R0,RF                                                            
         S     R0,AINVTAB                                                       
         CHI   R0,255                                                           
         BNH   RB26C                                                            
         B     RB28                DONE                                         
*                                                                               
RB26D    DS    0H                                                               
         S     RF,AINVTAB                                                       
         STC   RF,SAVPRD                                                        
         L     RE,APRD             SET PRD HERE                                 
         STC   RF,0(RE)            SO FPRD CAN READ PRD HDR                     
         L     R3,APRDBRK                                                       
         BAS   RE,FPRD                                                          
         B     RB0                                                              
*                                                                               
RB28     DS    0H                                                               
         BRAS  RE,BLDTAB           REBUILD BREAK TABLES                         
         MVI   UPASS,0                                                          
*                                                                               
RB30     DS    0H                                                               
         MVI   PRSW,C'F'           PRINT ANY LEFTOVER LINES                     
         BRAS  RE,PRNT                                                          
         MVC   RCTRACE,SAVTRACE                                                 
         XC    INVLIST,INVLIST                                                  
         XC    INVLIST2,INVLIST2                                                
         XC    INVTABN,INVTABN                                                  
         L     RF,AINVTAB          CLEAR INVTAB                                 
         XC    0(256,RF),0(RF)     ALSO USED FOR PRD LIST FOR RETAIL            
         MVI   INVSKIP,C'N'                                                     
         MVI   PRDSKIP,C'N'                                                     
RBEXT    DS    0H                                                               
         XIT1                                                                   
SETPASS0 DS    0H                                                               
         XC    BMITOTS(BMITOTLQ),BMITOTS  CLEAR TOTS                            
         LA    R1,BIGOGRS                                                       
         LHI   R0,8                                                             
         ZAP   0(8,R1),=P'0'                                                    
         LA    R1,8(R1)                                                         
         BCT   R0,*-10                                                          
         MVI   PASSNO,0                                                         
         B     *+8                                                              
SETPASS1 DS    0H                                                               
         MVI   PASSNO,1            SET FOR PASS 1                               
         MVI   RETSKIP,C'N'        RESET SKIP SWITCHES                          
         CLI   RETPROF,0                                                        
         BE    *+12                                                             
         MVI   INVSKIP,C'Y'                                                     
         MVI   PRDSKIP,C'Y'                                                     
         MVC   FORMAT,BFORMAT                                                   
         MVC   APAGBRK,SVPAGBRK    RESTORE                                      
         MVC   ALOWTOG,SVLOWTOG                                                 
         MVC   SPOTCTL,SPOTSW                                                   
         OC    ARECAP,ARECAP                                                    
         BZ    SP1B                                                             
         MVC   APAGBRK,AINVBRK     FOR RECAP NO PAGE BRKS                       
         MVC   ALOWTOG,ARECAP                                                   
         MVI   SPOTCTL,C'N'        IF RECAP THEN NO SPOT DETAILS                
*                                  ON MAIN BILL                                 
SP1B     DS    0H                                                               
         CLI   SPOTCTL,C'Y'                                                     
         BNE   SETCOLS                                                          
         MVI   FORMAT,0            FOR SPOT DETAILS - FORMAT = 0                
*                                                                               
*                                  SET COLS USABLE FOR DESCRIPTIONS             
SETCOLS  DS    0H                                                               
         MVI   TWOCOL,C'Y'         2 COLS AVAILABLE                             
         CLI   FORMAT,1            UNLESS FORMAT 1                              
         BE    *+10                                                             
         CLI   FORMAT,2            OR FORMAT 2                                  
         BNER  RE                                                               
         CLI   PERCTL,C'T'         AND PERIODS NOT TOGETHER                     
         BER   RE                                                               
         MVI   TWOCOL,C'N'                                                      
         BR    RE                                                               
         SPACE 3                                                                
RBTRCE   DS    0H                                                               
         CLI   SORTTRCE,C'Y'                                                    
         BE    *+10                                                             
         CLI   SORTTRCE,C'O'       'OUTS' ONLY                                  
         BNER  RE                                                               
*                                                                               
         MVC   P(10),SPACES                                                     
         MVC   P+1(1),PASSNO                                                    
         OI    P+1,C'0'                                                         
         CLI   UPASS,0                                                          
         BE    RBT2                                                             
         MVC   P+2(1),UPASS                                                     
         CLI   UPASS,C'S'                                                       
         BNL   RBT2                                                             
         OI    P+2,C'0'                                                         
RBT2     DS    0H                                                               
         MVC   P+4(1),BYTE                                                      
         LA    RF,RDBUFF                                                        
         A     RF,BRKCODE                                                       
         AHI   RF,BRKLIST-RDBUFF-4                                              
         MVC   P+5(4),0(RF)                                                     
         LR    R0,RE                                                            
         GOTO1 HEXOUT,DMCB,SORTREC,P+10,SORTRLEN,=C'N'                          
         BRAS  RE,PRNT                                                          
         LR    RE,R0                                                            
         BR    RE                                                               
         EJECT                                                                  
SETRET   DS    0H                                                               
         CLI   RETPROF,0                                                        
         BER   RE                                                               
         CLI   UPASS,C'S'                                                       
         BER   RE                                                               
*                                                                               
         NTR1                                                                   
         SPACE 2                                                                
         MVI   CORPZ,C'N'          CLEAR CORP INV IND                           
         L     R4,AGDAREA                                                       
         USING GDSECT,R4                                                        
         MVC   GDCLUST,SPACES                                                   
         CLI   GDMGRLEN,0                                                       
         BE    SR4                                                              
         CLI   RETPROF+14,C'*'   ??TEST PSEUDO MGR (ACCT PREFIX)??              
         BNH   *+14                                                             
         MVC   GDMGR(1),RETPROF+14                                              
         B     SR4                                                              
*                                                                               
         ZIC   RF,GDMGRLEN                                                      
         ZIC   RE,MGR3LEN                                                       
         SR    RE,RF                                                            
         BNM   *+6                                                              
         SR    RE,RE                                                            
         A     RE,AMGR1            USE LAST 'GDMGRLEN' POSITIONS                
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   GDMGR(0),0(RE)                                                   
*                                                                               
SR4      DS    0H                                                               
         CLI   GDMKTLEN,0                                                       
         BE    SR6                                                              
         L     RF,AMKT                                                          
         LH    R0,0(RF)                                                         
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  GDMKT,DUB                                                        
*                                                                               
SR6      DS    0H                                                               
         CLI   UPASS,C'S'                                                       
         BE    SR10                                                             
         MVI   GDOUTNO,0                                                        
         MVC   GDSCHM,SPACES                                                    
         GOTO1 =V(FINDOUT),DMCB,GDSECT                                          
*                                  INITIALIZE TEST PASS                         
         MVI   UPASS,C'T'                                                       
         MVI   RETERR,0                                                         
         XC    PBLPARS+8(4),PBLPARS+8   CLEAR PARTIAL BILLING TABLE             
         OC    GDNOUTS,GDNOUTS                                                  
         BNZ   SR10                                                             
         MVI   RETERR,1                                                         
         MVI   PRSW,C'N'                                                        
         MVC   P(05),=C'** NO'                                                  
         MVC   P+6(15),GDOUTDSC                                                 
         MVC   P+22(3),=C'FOR'                                                  
         MVC   P+26(15),GDMGRDSC                                                
         CLI   GDMKTLEN,0                                                       
         BE    *+10                                                             
         MVC   P+26(15),GDMKTDSC                                                
         MVC   P+42(4),GDMGR                                                    
         MVC   P+47(4),GDMKT                                                    
*                                                                               
         MVC   P+55(19),=C'(PRD/EST = XXX/NNN)'                                 
         L     RF,AEST                                                          
         ZIC   R0,0(RF)                                                         
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  P+55+15(3),DUB                                                   
*                                                                               
         L     RF,ADCLT                                                         
         L     RE,APRD                                                          
         ZIC   R1,0(RE)                                                         
         MHI   R1,4                                                             
         LA    R1,CLIST-CLTHDR(RF,R1)     GET ALPHA PRD                         
         MVC   P+55+11(3),0(R1)                                                 
*                                                                               
         MVI   SKIPSPEC,C'Y'                                                    
         BRAS  RE,PRNT                                                          
         MVC   PAGE,=H'1'                                                       
*                                                                               
SR10     DS    0H                                                               
         J     RBEXT                                                            
         DROP  R4                                                               
         SPACE 3                                                                
SETADDR  DS    0H                                                               
         USING GDOUTD,R4                                                        
                                                                                
         ST    RE,SAVRE                                                         
                                                                                
         L     R0,=A(AADDRS)                                                    
         LHI   R1,ADDRLEN                                                       
         SR    RE,RE                                                            
         LA    RF,X'40'                 FILL WITH SPACES                        
         SLL   RF,24                                                            
         MVCL  (R0),(RE)                                                        
                                                                                
         L     RF,=A(AADDRS)                                                    
*                                                                               
         MVC   240+36-L'GDOCODE(L'GDOCODE,RF),GDOCODE  OUTLET CODE              
         LA    R1,GDONAME                                                       
         CLI   MOLSON,C'Y'            FOR MOLSON                                
         BNE   SETAD4                                                           
         CLC   GDOCODE(6),=C'000001'  CORPORATE                                 
         BNE   SETAD4                                                           
         L     R1,=A(MOLSADDR)        USE SPECIAL ADDRESS                       
         MVC   240+36-L'GDOCODE(6,RF),=C'000005'  AND DIFFERENT OUTLET          
*                                                 (FOR RECIEVABLES)             
SETAD4   DS    0H                                                               
         MVC   000(36,RF),GDONAME-GDONAME(R1)                                   
         MVC   060(26,RF),GDOAL1-GDONAME(R1)                                    
         MVC   120(26,RF),GDOAL2-GDONAME(R1)                                    
         MVC   180(26,RF),GDOAL3-GDONAME(R1)                                    
         MVC   240(26,RF),GDOAL4-GDONAME(R1)                                    
*                                                                               
*                                                                               
         L     R1,=A(BADDRS)       SET IN BADDRS ALSO                           
         MVC   0(ADDRLEN/2,R1),0(RF)                                            
         MVC   ADDRLEN/2(ADDRLEN/2,R1),ADDRLEN/2(RF)                            
                                                                                
         L     RE,SAVRE                                                         
         BR    RE                                                               
         DROP  R4                                                               
         EJECT                                                                  
*        'FIRSTS'                                                               
         SPACE 2                                                                
FRSTTAB  DS    0F                                                               
         B     FPGR1                                                            
         B     FPGR2                                                            
         B     FPGR3                                                            
         B     FPRD                                                             
         B     FEST                                                             
         B     FMGR1                                                            
         B     FMGR2                                                            
         B     FMGR3                                                            
         B     FMKT                                                             
         B     FNET                                                             
         B     FSTA                                                             
         B     FPKG                                                             
         B     FPGM                                                             
         B     FDESC                                                            
         B     FPER                                                             
         B     FPERG                                                            
         B     FCTYP                                                            
         B     FFLT                                                             
         SPACE 3                                                                
*        'LASTS'                                                                
         SPACE 2                                                                
LASTTAB  DS    0F                                                               
         B     LPGR1                                                            
         B     LPGR2                                                            
         B     LPGR3                                                            
         B     LPRD                                                             
         B     LEST                                                             
         B     LMGR1                                                            
         B     LMGR2                                                            
         B     LMGR3                                                            
         B     LMKT                                                             
         B     LNET                                                             
         B     LSTA                                                             
         B     LPKG                                                             
         B     LPGM                                                             
         B     LDESC                                                            
         B     LPER                                                             
         B     LPERG                                                            
         B     LCTYP                                                            
         B     LFLT                                                             
         EJECT                                                                  
*        FIRST FOR PRODUCT GROUP                                                
         SPACE 2                                                                
FPGR1    DS    0H                                                               
         LA    R5,PGR1             PGR1 DATA                                    
         B     FPGRA                                                            
         SPACE 2                                                                
FPGR2    DS    0H                                                               
         LA    R5,PGR2             PGR2 DATA                                    
         B     FPGRA                                                            
         SPACE 3                                                                
FPGR3    DS    0H                                                               
         LA    R5,PGR3             PGR3 DATA                                    
         SPACE 3                                                                
FPGRA    NTR1                                                                   
         SPACE 2                                                                
         OC    ALOWTOG,ALOWTOG                                                  
         BZ    *+12                                                             
         C     R3,ALOWTOG          TEST IF TO APPEAR                            
         BH    FPGRAX              NO                                           
         L     RF,APGR1            POINT TO PRG1 FIELD                          
         IC    RE,PGR3LEN                                                       
*                                                                               
         XC    WORK(5),WORK                                                     
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   WORK(0),0(RF)                                                    
         PACK  DUB(3),WORK(5)      PWOS PRG                                     
*                                  NEED TO READ PGR RECORD                      
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0D01'                                                  
         MVC   KEY+2(1),BAGYMD                                                  
         MVC   KEY+3(2),BCLT                                                    
         MVC   KEY+5(1),QPGR       PGR SCHEME                                   
         MVC   KEY+6(2),DUB        PGR NUMBER                                   
*                                                                               
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   FPGRA3                                                           
         GOTO1 GETPRDGR                                                         
         B     FPGRA3B                                                          
*                                                                               
FPGRA3   DS    0H                                                               
         MVC   PGR1+1(4),=C'999 '                                               
         MVC   PGR2+1(4),=C'999 '                                               
         MVC   PGR3+1(4),=C'999 '                                               
         L     RE,=A(DICSECT)                                                   
         MVC   PGR1NM,SPACES                                                    
         MVC   PGR2NM,SPACES                                                    
         MVC   PGR3NM,SPACES                                                    
         MVC   PGR1NM(L'SP@UNDEF),SP@UNDEF-DICSECT(RE)                          
         MVC   PGR2NM(L'SP@UNDEF),SP@UNDEF-DICSECT(RE)                          
         MVC   PGR3NM(L'SP@UNDEF),SP@UNDEF-DICSECT(RE)                          
*                                                                               
FPGRA3B  DS    0H                                                               
FPGRA4   DS    0H                                                               
         C     R3,APAGBRK          TEST PGR 'HIGHER' THAN PAGE BRK              
         BNH   FPGRA10             YES                                          
*                                  PGR 'TOGETHER'                               
         CLC   P,SPACES                                                         
         BE    *+12                                                             
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT             CLEAR P                                      
*                                                                               
         OC    18(24,R5),SPACES                                                 
         CLC   ALOWTOG,AHITOG                                                   
         BNE   FPGRA5                                                           
*                                  IS ONLY TOGETHER                             
         MVC   P(5),0(R5)                                                       
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P+6(24),18(R5)                                                   
         B     FPGRA10                                                          
         GOTO1 CHOPPER,DMCB,(24,18(R5)),(14,P+6),(C'P',2)                       
         B     FPGRA10                                                          
FPGRA5   DS    0H                                                               
         MVC   P(12),6(R5)         DESC                                         
         LA    RF,P+12                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   2(5,RF),0(R5)       NUMBER                                       
*                                                                               
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P2(24),18(R5)                                                    
         B     FPGRA6                                                           
         GOTO1 CHOPPER,DMCB,(24,18(R5)),(20,P2),(C'P',2)                        
FPGRA6   DS    0H                                                               
         BAS   RE,ULINE                                                         
         B     FPGRA10                                                          
*                                  PRG IN HEADLINES                             
FPGRA10  DS    0H                                                               
         GOTO1 ABILLEDI,DMCB,('EDMPGR',0)    EDI CALL                           
FPGRAX   DS    0H                                                               
         J     RBEXT                                                            
         EJECT                                                                  
*              FIRST FOR PRODUCT                                                
         SPACE 2                                                                
FPRD     NTR1                                                                   
         SPACE 2                                                                
*                                  NOTE - EVEN IF NOT PRINTING PRODUCT          
*                                  READ PRD REC FOR BILL FORMULA                
         L     RF,APRD                                                          
         ZIC   R4,0(RF)            GET PROD CODE FROM PROD SEQ                  
         MHI   R4,4                                                             
         L     RF,ADCLT                                                         
         LA    R4,CLIST-CLTHDR(RF,R4)                                           
         MVC   KEY(13),0(RF)                                                    
         MVC   KEY+4(3),0(R4)      3 CHAR PRD CODE                              
         L     RF,ADPRD                                                         
         CLC   KEY(13),0(RF)       TEST ALREADY HAVE PRDHDR                     
         BE    FPRD4                                                            
         GOTO1 READ                                                             
         GOTO1 GETPRD                                                           
*                                                                               
FPRD4    DS    0H                                                               
         L     RF,ADPRD                                                         
         USING PRDHDR,RF                                                        
*                                                                               
         CLI   BFROPT,C'N'         IF NOT DOING NEW BFR'S                       
         BNE   FPRD4A4                                                          
*                                                                               
         MVC   PRDFORM,PBILLBAS    HOLD FORMULA                                 
         MVC   EFFDTE,PBILLDT      HOLD EFF DATE                                
*                                                                               
         CLC   AESTBRK,APRDBRK     TEST EST 'HIGHER' THAN PROD                  
         BNL   *+8                 NO                                           
         BAS   RE,SETEST           YES- TRY FOR EST FORMULA                     
*                                                                               
FPRD4A4  DS    0H                                                               
         BRAS  RE,GETAOR           GET ANY AOR INFO                             
*                                                                               
         L     RF,ADPRD            RF USED FOR PRODUCT RECORD                   
         CLI   PRDCTL,C'N'         NOT PRINTING PRD                             
         BE    FPRDX                                                            
         CLI   RETPROF,0                                                        
         BE    *+8                                                              
         MVI   PRDSKIP,C'Y'                                                     
         CLI   UPASS,C'S'                                                       
         BE    FPRD5                                                            
         OC    ALOWTOG,ALOWTOG                                                  
         BZ    *+12                                                             
         C     R3,ALOWTOG          TEST IF TO APPEAR                            
         BH    FPRDX               NO                                           
*                                                                               
FPRD5    DS    0H                                                               
         CLI   RETPROF,0           SKIP PRD ADDR IF RETAIL                      
         BNE   FPRD6                                                            
*                                                                               
         MVC   THREE,PRD                                                        
         CLI   BILLADR,C'Y'        B8 PR3 READ BILL ADDRESS REC?                
         BNE   FPRD5C                                                           
         BRAS  RE,RBILADDR         READ BILL ADDRESS REC                        
         BNE   *+8                 PROD SPECIFIC RECORD NOT FOUND               
         B     FPRD6                                                            
         TM    FLAG1,AADDRSW       AAA BILL ADDRESS REC FOUND?                  
         BO    FPRD6                                                            
*                                                                               
FPRD5C   L     RE,=A(BADDRS)       BRAND ADDRS                                  
         USING BADDRS,RE                                                        
         MVC   BADDR1,SPACES                                                    
         MVC   BADDR2,SPACES                                                    
         MVC   BADDR3,SPACES                                                    
         MVC   BADDR4,SPACES                                                    
         MVC   BADDR5,SPACES                                                    
         CLC   =C'NONE',PADDR1                                                  
         BE    FPRD6                                                            
         CLC   =C'XX',PADDR1                                                    
         BE    FPRD6                                                            
         CLC   =C'X ',PADDR1                                                    
         BE    FPRD6                                                            
         CLI   PADDR1,C'A'                                                      
         BL    FPRD6                                                            
         MVC   BADDR1(L'PADDR1),PADDR1                                          
         MVC   BADDR2(L'PADDR2),PADDR2                                          
         MVC   BADDR3(L'PADDR3),PADDR3                                          
         MVC   BADDR4(L'PADDR4),PADDR4                                          
         DROP  RE,RF                                                            
*                                                                               
FPRD6    DS    0H                                                               
         C     R3,APAGBRK          IS PRD 'HIGHHER' THAN PAGE BRK               
         BNH   FPRD10K             YES                                          
         CLI   PRDCTL,C'S'                                                      
         BE    FPRD10K                                                          
         CLC   P,SPACES                                                         
         BE    FPRD4B                                                           
         L     RE,=A(DICSECT)      PREVENT PRINTING OF UNUSED                   
         CLC   P(L'SP@PRO),SP@PRO-DICSECT(RE)                                   
         BNE   FPRD6B              PRODUCT (CAN HAPPEN IN RETAIL)               
         MVC   P,SPACES                                                         
         MVC   P2,SPACES                                                        
         MVC   P3,SPACES                                                        
FPRD6B   DS    0H                                                               
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT             CLEAR P                                      
FPRD4B   DS    0H                                                               
*                                  PUT ACCT NO (IF ANY) IN X(7)                 
         MVC   X(7),SPACES                                                      
         CLI   AGMCLNO,C'C'        SUPPRESS IF B1 OPTION IS C                   
         BE    FPRD4D                                                           
         CLI   AGMCLNO,C'X'        OR X                                         
         BE    FPRD4D                                                           
         L     RF,ADPRD                                                         
         MVC   FULL,PACCT-PRDHDR(RF)                                            
         CLI   FULL,C' '                                                        
         BNH   FPRD4D                                                           
         CLC   FULL,=C'0000'                                                    
         BE    FPRD4D                                                           
         OC    FULL+1(3),FULL+1                                                 
         BZ    FPRD4D                                                           
         MVI   X,C'('                                                           
         MVC   X+1(4),FULL                                                      
         MVI   X+5,C')'                                                         
         CLI   FULL,X'FF'                                                       
         BNE   *+14                                                             
         UNPK  X+1(5),FULL+1(3)                                                 
         MVI   X+6,C')'                                                         
FPRD4D   DS    0H                                                               
         OC    PRDNM,SPACES                                                     
         CLC   ALOWTOG,AHITOG      IS PRD ONLY 'TOGETHER'                       
         BE    FPRD7               YES                                          
*                                  PRD NOT ONLY                                 
         L     RE,=A(DICSECT)                                                   
         MVC   P(L'SP@PRO),SP@PRO-DICSECT(RE)  PRODUCT-                         
         MVC   P+9(3),PRD                                                       
         MVC   P+14(7),X           ACCT NO.                                     
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P2(24),PRDNM                                                     
         B     FPRD4F                                                           
         GOTO1 CHOPPER,DMCB,(24,PRDNM),(20,P2),(C'P',2)                         
FPRD4F   DS    0H                                                               
         CLI   WMTSW,C'Y'                                                       
         BNE   FPRD4H                                                           
         MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'E',ADEST),(C':',W),0            
         MVC   P2+24(20),W                                                      
         BRAS  RE,PRNT                                                          
         B     FPRD4K                                                           
*                                                                               
FPRD4H   DS    0H                                                               
         CLI   PGSW,C'Y'            ONLY FOR H9, PG1, PGG AND PGB               
         BNE   FPRD4K               PRINT UDEF NEXT TO PRD NAME                 
         MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'E',ADEST),0,(C':',W)            
         MVC   P2+24(20),W                                                      
         BRAS  RE,PRNT             PRINT NOW, SO WON'T OVERFLOW LATER           
         B     FPRD4Y                                                           
*                                                                               
FPRD4K   DS    0H                                                               
         CLI   TCFSW,C'Y'           FOR FOX                                     
         BE    FPRD4M               PRINT UDEF NEXT TO PRD NAME                 
         CLI   EPUDEF,C'Y'                                                      
         BE    FPRD4M               PRINT UDEF NEXT TO PRD NAME                 
         CLI   EPUDEF,C'P'                                                      
         BNE   FPRD4Y               PRINT UDEF NEXT TO PRD NAME                 
FPRD4M   MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'P',ADPRD),(C':',W),0            
         TM    DMCB+4,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    FPRD4N                                                           
         MVC   P2+24(40),W                                                      
         BRAS  RE,PRNT                                                          
FPRD4N   MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'P',ADPRD),0,(C':',W)            
         TM    DMCB+6,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    FPRD4O                                                           
         MVC   P+24(40),W                                                       
         BRAS  RE,PRNT                                                          
FPRD4O   MVC   W,SPACES                                                         
         CLI   TCFSW,C'Y'                                                       
         BNE   FPRD4Y                                                           
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'E',ADEST),(C':',W),0            
         TM    DMCB+4,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    FPRD4P                                                           
         MVC   P+24(40),W                                                       
         BRAS  RE,PRNT                                                          
FPRD4P   MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'E',ADEST),0,(C':',W)            
         TM    DMCB+6,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    FPRD4Y                                                           
         MVC   P+24(20),W                                                       
         BRAS  RE,PRNT                                                          
*                                                                               
FPRD4Y   DS    0H                                                               
         C     R3,ALOWTOG                                                       
         BE    *+8                                                              
         BAS   RE,ULINE                                                         
         B     FPRD10K                                                          
*                                  PRD ONLY 'TOGETHER'                          
FPRD7    DS    0H                                                               
         MVC   P(3),PRD                                                         
         MVC   W,SPACES                                                         
         MVC   W(24),PRDNM                                                      
         LA    RF,W+24             FLOAT ACCT NO AFTER                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   2(7,RF),X                                                        
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P+4(33),W                                                        
         B     FPRD10                                                           
         GOTO1 CHOPPER,DMCB,(33,W),(16,P+4),(C'P',3)                            
FPRD10   DS    0H                                                               
         CLI   PGSW,C'Y'                                                        
         BNE   FPRD10C                                                          
         MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'E',ADEST),0,(C':',W)            
         MVC   P+31(20),W                                                       
         BRAS  RE,PRNT             PRINT NOW, SO WON'T OVERFLOW LATER           
*                                                                               
FPRD10C  CLI   EPUDEF,C'Y'                                                      
         BE    FPRD10F              PRINT UDEF NEXT TO PRD NAME                 
         CLI   EPUDEF,C'P'                                                      
         BNE   FPRD10K              PRINT UDEF NEXT TO PRD NAME                 
FPRD10F  MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'P',ADPRD),(C':',W),0            
         TM    DMCB+4,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    FPRD10H                                                          
         MVC   P2+24(40),W                                                      
         BRAS  RE,PRNT                                                          
FPRD10H  MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'P',ADPRD),0,(C':',W)            
         TM    DMCB+6,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    FPRD10K                                                          
         MVC   P+24(40),W                                                       
         BRAS  RE,PRNT                                                          
*                                                                               
FPRD10K  GOTO1 ABILLEDI,DMCB,('EDMPRD',0)    EDI CALL                           
FPRDX    DS    0H                                                               
         J     RBEXT                                                            
         EJECT                                                                  
*        FIRST FOR ESTIMATE                                                     
         SPACE 2                                                                
FEST     NTR1                                                                   
*                                  NOTE-EVEN IF NOT PRINTING ESTIMATES          
*                                  READ EST REC FOR BILL FORMULA                
         BRAS  RE,GETAOR           GET ANY AOR INFO                             
         BAS   RE,SETEST                                                        
*                                                                               
         BRAS  RE,TSTRET           DO RETAIL TEST                               
         BNZ   FESTX               SKIP                                         
*                                                                               
         CLI   ESTCTL,C'N'         NOT PRINTING EST                             
         BE    FESTX                                                            
         OC    ALOWTOG,ALOWTOG                                                  
         BZ    *+12                                                             
         C     R3,ALOWTOG          TEST IF TO APPEAR                            
         BH    FESTX               NO                                           
*                                                                               
         CLI   ECOMOPT,C'B'        COMMENT TO PRINT BEFORE?                     
         BNE   *+8                                                              
         BRAS  RE,COMPROC                                                       
*                                                                               
         C     R3,APAGBRK          IS EST 'HIGHER' THAN PAGE BRK                
         BNH   FEST10K             YES                                          
         CLC   P,SPACES            NO, PRINT ANY LEFTOVERS                      
         BE    *+12                                                             
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT             CLEAR P                                      
*                                                                               
         OC    ESTNM,SPACES                                                     
         CLC   ALOWTOG,AHITOG      IS EST ONLY 'TOGETHER'                       
         BE    FEST5               YES                                          
*                                  EST NOT ONLY                                 
         L     RE,=A(DICSECT)                                                   
         MVC   P(L'SP@EST),SP@EST-DICSECT(RE) ESTIMATE                          
         MVC   P+9(3),EST                                                       
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P2(24),ESTNM                                                     
         B     FEST3D                                                           
         GOTO1 CHOPPER,DMCB,(24,ESTNM),(20,P2),(C'P',2)                         
FEST3D   DS    0H                                                               
         CLI   MSSW,C'Y'         ONLY FOR MINDSHARE                             
         BE    FEST3F                                                           
         CLI   EPUDEF,C'Y'                                                      
         BE    FEST3F                                                           
         CLI   EPUDEF,C'E'                                                      
         BNE   FEST4                                                            
FEST3F   MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'E',ADEST),(C':',W),0            
         TM    DMCB+4,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    FEST3G                                                           
         MVC   P2+25(40),W                                                      
         BRAS  RE,PRNT                                                          
FEST3G   CLI   MSSW,C'Y'         ONLY FOR MINDSHARE                             
         BE    FEST4                                                            
         MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'E',ADEST),0,(C':',W)            
         TM    DMCB+6,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    FEST4                                                            
         MVC   P+25(40),W                                                       
         BRAS  RE,PRNT                                                          
*                                                                               
FEST4    C     R3,ALOWTOG                                                       
         BE    *+8                                                              
         BAS   RE,ULINE                                                         
         B     FEST10K                                                          
*                                  EST IS ONLY TOG                              
FEST5    DS    0H                                                               
         MVC   P(3),EST                                                         
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P+4(24),ESTNM                                                    
         B     FEST10                                                           
         GOTO1 CHOPPER,DMCB,(24,ESTNM),(16,P+4),(C'P',2)                        
*                                                                               
FEST10   DS    0H                                                               
         CLI   MSSW,C'Y'                                                        
         BE    FEST10C                                                          
         CLI   EPUDEF,C'Y'                                                      
         BE    FEST10C                                                          
         CLI   EPUDEF,C'E'                                                      
         BNE   FEST10K                                                          
FEST10C  MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'E',ADEST),(C':',W),0            
         TM    DMCB+4,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    FEST10D                                                          
         MVC   P+25(40),W                                                       
         BRAS  RE,PRNT                                                          
FEST10D  CLI   MSSW,C'Y'         ONLY FOR MINDSHARE                             
         BE    FEST10K                                                          
         MVC   W,SPACES                                                         
         GOTO1 =V(GETUSER),DMCB,(C'S',ADCLT),(C'E',ADEST),0,(C':',W)            
         TM    DMCB+6,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    FEST10K                                                          
         MVC   P+25(40),W                                                       
         BRAS  RE,PRNT                                                          
*                                                                               
FEST10K  GOTO1 ABILLEDI,DMCB,('EDMEST',0)    EDI CALL                           
FESTX    DS    0H                                                               
         J     RBEXT                                                            
         SPACE 2                                                                
*        GET ESTHDR AND SET FORMULA                                             
*                                                                               
SETEST   NTR1                                                                   
         L     RF,ADCLT            BUILD EST KEY                                
         MVC   KEY,0(RF)                                                        
         L     RE,APRD                                                          
         ZIC   R4,0(RE)                                                         
         MHI   R4,4                                                             
         LA    R4,CLIST-CLTHDR(RF,R4)     GET ALPHA PRD                         
         MVC   KEY+4(3),0(R4)                                                   
         L     RF,AEST                                                          
         MVC   KEY+7(1),0(RF)                                                   
         L     R4,ADEST                                                         
         CLC   KEY(13),0(R4)       TEST ALREADY HAVE ESTHDR                     
         BE    SEST2                                                            
         GOTO1 READ                                                             
         GOTO1 GETEST                                                           
*                                                                               
SEST2    DS    0H                                                               
         L     RF,ADEST                                                         
         MVC   ESTFORM,EBILLBAS-ESTHDR(RF)     HOLD FORMULA                     
*                                                                               
         XC    AAEFORM,AAEFORM                                                  
         L     RE,=A(AAAELIST)     SET AAA EST FORM IF ANY                      
         USING AAAELSTD,RE                                                      
SEST3    DS    0H                                                               
         CLC   0(AAAELSTL,RE),=X'FFFFFFFFFFFF' EOL                              
         BE    SEST5                                                            
         CLC   7(1,RF),AAAELEST    EST =                                        
         BE    *+12                                                             
         LA    RE,AAAELSTL(RE)                                                  
         B     SEST3                                                            
*                                                                               
         MVC   AAEFORM,1(RE)                                                    
         DROP  RE                                                               
*                                                                               
SEST5    DS    0H                                                               
*              SET COST2 OPTION                                                 
*              NOTE- ALSO SET AT ESTF                                           
*                                                                               
         CLI   WIOPT,C'Y'                                                       
         BE    SESTX                                                            
*                                                                               
         L     RF,ADEST            ESTIMATE HEADER                              
         USING ESTHDR,RF                                                        
*                                                                               
         MVI   COST2SW,C'N'        ASSUME NO COS2 FACTOR                        
         CLC   ECOST2,=X'80000000' IN CASE THERE ARE ANY OUT THERE...           
         BE    *+18                 ... LIKE THIS LEFT OVER                     
         OC    ECOST2,ECOST2       COST2 ACTIVE FOR ESTIMATE?                   
         BZ    *+8                                                              
         MVI   COST2SW,C'Y'        YES                                          
*                                                                               
         MVI   CLTCURR,0           SET CLIENT CURRENCY CONTROL                  
         MVI   CURR2,0                                                          
         CLI   MIDAS,C'Y'                                                       
         BE    *+12                BEHAVE AS IF COS2                            
         CLI   COST2SW,C'Y'        ARE WE DOING COST2?                          
         BNE   SESTX                                                            
         MVI   CLTCURR,1           YES                                          
         MVI   CURR2,1                                                          
         DROP  RF                                                               
*                                                                               
SESTX    DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
*        FIRST FOR MARKET GROUP                                                 
         SPACE 2                                                                
FMGR1    DS    0H                                                               
         LA    R5,MGR1                                                          
         LA    R6,MGR1N                                                         
         B     FMGRA                                                            
         SPACE 2                                                                
FMGR2    DS    0H                                                               
         LA    R5,MGR2                                                          
         LA    R6,MGR2N                                                         
         B     FMGRA                                                            
         SPACE 2                                                                
FMGR3    DS    0H                                                               
         LA    R5,MGR3                                                          
         LA    R6,MGR3N                                                         
         SPACE 2                                                                
FMGRA    DS    0H                                                               
         L     RF,=A(FMGRAPR)                                                   
         BR    RF                                                               
         SPACE 2                                                                
*&&DO                                                                           
FMGRA    NTR1                                                                   
         SPACE 2                                                                
         CLC   AESTBRK,AINVBRK     IF EST SEPARATE                              
         BH    *+12                                                             
         BRAS  RE,TSTRET           DO RETAIL TEST                               
         BNZ   FMGRAX                                                           
*                                                                               
         OC    ALOWTOG,ALOWTOG                                                  
         BZ    *+12                                                             
         C     R3,ALOWTOG          TEST IF TO APPEAR                            
         BH    FMGRAX              NO                                           
         L     RF,AMGR1            POINT TO MGR1 FIELD                          
*                                                                               
         ZIC   RE,MGR3LEN                                                       
*                                                                               
         XC    WORK(5),WORK                                                     
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   WORK(0),0(RF)                                                    
         PACK  X(3),WORK(5)      PWOS MGR                                       
         OC    WORK(5),SPACES                                                   
         MVC   X+10(5),WORK        SAVE MGR FOR PRINT                           
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0D02'                                                  
         MVC   KEY+2(1),BAGYMD                                                  
*                                                                               
         CLI   QMGR,C' '           MGR'S 01-3F ARE CROSS CLIENT                 
         BL    *+18                                                             
         CLI   QMGR,C'F'                                                        
         BH    *+10                                                             
         MVC   KEY+3(2),BCLT                                                    
*                                                                               
         MVC   KEY+8(1),QMGR       MGR CODE                                     
         MVC   KEY+9(2),X          MGR NUMBER                                   
         CLI   SVMKGPGA,0          TEST DOING MGR'S WITHIN PGR'S                
         BNE   FMGRA3A                                                          
         GOTO1 HIGH                NO, JUST GET MGR                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   FMGRA5                                                           
         B     FMGRA4                                                           
*                                  YES, NEED PGR                                
FMGRA3A  DS    0H                                                               
         L     RF,APGR1            POINT TO PRG1 FIELD                          
         ZIC   RE,PGR3LEN                                                       
*                                  READ FOR MGR RECORD                          
         XC    WORK(5),WORK                                                     
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   WORK(0),0(RF)                                                    
         PACK  X(3),WORK(5)      PWOS PRG                                       
         MVC   KEY+6(2),X                                                       
         MVC   KEY+5(1),QPGR                                                    
*                                                                               
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    FMGRA4                                                           
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         XC    KEY+6(2),KEY+6      LOOK UNDER SCHEME ONLY                       
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    FMGRA4                                                           
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         MVI   KEY+5,0             FORGET SCHEME AND NUMBER                     
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   FMGRA5                                                           
*                                                                               
FMGRA4   DS    0H                                                               
         GOTO1 GETMKTGR                                                         
         B     FMGRA6                                                           
*                                                                               
FMGRA5   DS    0H                                                               
         MVC   MGR1+1(4),X+10                                                   
         MVC   MGR2+1(4),X+10                                                   
         MVC   MGR3+1(4),X+10                                                   
         MVC   MGR1N+2(4),X+10                                                  
         MVC   MGR2N+2(4),X+10                                                  
         MVC   MGR3N+2(4),X+10                                                  
         L     RE,=A(DICSECT)                                                   
         MVC   MGR1NM,SPACES                                                    
         MVC   MGR2NM,SPACES                                                    
         MVC   MGR3NM,SPACES                                                    
         MVC   MGR1NM(L'SP@UNDEF),SP@UNDEF-DICSECT(RE)                          
         MVC   MGR2NM(L'SP@UNDEF),SP@UNDEF-DICSECT(RE)                          
         MVC   MGR3NM(L'SP@UNDEF),SP@UNDEF-DICSECT(RE)                          
*                                                                               
FMGRA6   DS    0H                                                               
         C     R3,APAGBRK          TEST MGR 'HIGHER' THAN PAGE BRK              
         BNH   FMGRA10             YES                                          
*                                  MGR 'TOGETHER'                               
         CLC   P,SPACES                                                         
         BE    *+12                                                             
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         OC    18(24,R5),SPACES                                                 
         CLC   ALOWTOG,AHITOG                                                   
         BNE   FMGRA7B                                                          
*                                  IS ONLY TOGETHER                             
         MVC   P(6),0(R6)                                                       
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P+7(24),18(R5)                                                   
         B     FMGRA10                                                          
         GOTO1 CHOPPER,DMCB,(24,18(R5)),(14,P+6),(C'P',2)                       
         B     FMGRA10                                                          
*                                                                               
FMGRA7B  DS    0H                                                               
         MVC   P(12),6(R5)         DESC                                         
         LA    RF,P+12                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   2(6,RF),0(R6)       NUMBER                                       
*                                                                               
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P2(24),18(R5)                                                    
         B     FMGR7D                                                           
         GOTO1 CHOPPER,DMCB,(24,18(R5)),(20,P2),(C'P',2)                        
FMGR7D   DS    0H                                                               
         C     R3,ALOWTOG                                                       
         BE    *+8                                                              
         BAS   RE,ULINE                                                         
         B     FMGRA10                                                          
*                                  MGR IN HEADS                                 
FMGRA10  DS    0H                                                               
         GOTO1 ABILLEDI,DMCB,('EDMMGR',0)    EDI CALL                           
FMGRAX   DS    0H                                                               
         J     RBEXT                                                            
*&&                                                                             
FMKT     DS    0H                                                               
         L     RF,=A(FMKTPR)                                                    
         BR    RF                                                               
         SPACE 2                                                                
FPERG    DS    0H                                                               
         CLI   UPASS,C'S'     IGNORE PERCTL RESET FOR SUMMARY PASS              
         BER   RE                                                               
         CLI   PRIOR,C'W'          W = CURRENT MONTH SEPARATE                   
         BE    *+10                                                             
         CLI   PRIOR,C'M'          M = CURRENT MONTH SEPARATE                   
         BNER  RE                                                               
         MVI   PERCTL,C'T'         RESET PERCTL                                 
         L     RF,APERG                                                         
         CLI   0(RF),C'5'          TEST A SEPARATE CURRENT MONTH                
         BNER  RE                  NO                                           
         MVI   PERCTL,C'S'         YES - TREAT AS SEP                           
         BR    RE                                                               
         SPACE 3                                                                
FSTA     DS    0H                                                               
         L     RF,=A(FSTAPR)                                                    
         BR    RF                                                               
         SPACE 2                                                                
         SPACE 2                                                                
FPER     DS    0H                                                               
         BR    RE                                                               
         SPACE 2                                                                
FPGM     DS    0H                                                               
         BR    RE                                                               
         SPACE 2                                                                
FDESC    DS    0H                                                               
         BR    RE                                                               
         SPACE 2                                                                
FPKG     NTR1                                                                   
         J     RBEXT               **NO-OP**                                    
         SPACE 2                                                                
FCTYP    DS    0H                                                               
         BR    RE                                                               
         SPACE 2                                                                
FFLT     DS    0H                                                               
         BR    RE                                                               
         SPACE 2                                                                
FNET     DS    0H                                                               
         L     RF,=A(FNETPR)                                                    
         BR    RF                                                               
         EJECT                                                                  
*        LAST FOR PRODUCT GROUP                                                 
         SPACE 2                                                                
LPGR1    DS    0H                                                               
         LA    R5,PGR1             PGR1 DATA                                    
         B     LPGRA                                                            
         SPACE 2                                                                
LPGR2    DS    0H                                                               
         LA    R5,PGR2             PGR2 DATA                                    
         B     LPGRA                                                            
         SPACE 2                                                                
LPGR3    DS    0H                                                               
         LA    R5,PGR3             PGR3 DATA                                    
         B     LPGRA                                                            
         SPACE 2                                                                
LPGRA    NTR1                                                                   
         SPACE 2                                                                
         C     R3,ALOWTOG          IS THIS LOWEST TOG                           
         BE    LPGRA8              YES                                          
         BH    LPGRX               BYPASS IF 'LOWER' (ON RECAPS)                
*                                  PGR NOT LOWEST                               
         MVC   P(2),=C'**'                                                      
         MVC   P+2(12),6(R5)       DESC                                         
         LA    RF,P+14                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         L     RE,=A(DICSECT)                                                   
         MVC   2(L'SP6TOTAL,RF),SP6TOTAL-DICSECT(RE) TOTALS**                   
         MVC   2+L'SP6TOTAL(2,RF),=C'**'                                        
         SPACE 2                                                                
LPGRA8   DS    0H                                                               
         MVC   TOTNAME,6(R5)       SAVE DESCRIPTION                             
         BRAS  RE,TOTOUT                                                        
         BRAS  RE,PRTADJ                                                        
LPGRX    DS    0H                                                               
         J     RBEXT                                                            
         EJECT                                                                  
*        LAST FOR PRODUCT                                                       
         SPACE 2                                                                
LPRD     NTR1                                                                   
         SPACE 2                                                                
*                                                                               
         BRAS  RE,BILCALC                                                       
         CLI   PRDCTL,C'N'                                                      
         BE    LPRDX                                                            
         C     R3,ALOWTOG          IS THIS LOWEST TOGETHER                      
         BE    LPRD8               YES                                          
         BH    LPRDX               BYPASS IF 'LOWER' (ON RECAPS)                
*                                  PRD NOT LOWEST                               
         L     RE,=A(DICSECT)                                                   
         MVC   P+2(L'SP@PROTL),SP@PROTL-DICSECT(RE) PRODUCT TOTALS              
         CLI   PRDMKT,C'M'                                                      
         BE    LPRD8                                                            
         MVC   P(2),=C'**'                                                      
         LA    RF,P+2+L'SP@PROTL                                                
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   1(2,RF),=C'**'                                                   
         SPACE 2                                                                
LPRD8    DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         MVC   TOTNAME,SPACES                                                   
         MVC   TOTNAME(L'SP@PRO),SP@PRO-DICSECT(RE)  PRODUCT                    
         BRAS  RE,TOTOUT                                                        
*                                  TEST NEED TO SAVE CORP DATA NOW              
         CLI   SUMLEV,C'P'                                                      
         BE    *+16                                                             
         CLI   SUMLEV,0                                                         
         BH    *+12                                                             
         MVI   SUMLEV,C'P'         CORP DATE SAVED AT PRD LEVEL                 
         BRAS  RE,SAVCORP                                                       
         BRAS  RE,PRTADJ                                                        
*                                                                               
         B     LPRDX                                                            
LPRDX    DS    0H                                                               
         J     RBEXT                                                            
         EJECT                                                                  
*        LAST FOR ESTIMATE                                                      
         SPACE 2                                                                
LEST     NTR1                                                                   
         SPACE 2                                                                
*                                                                               
         BRAS  RE,BILCALC                                                       
         CLI   ESTCTL,C'N'                                                      
         BE    LEST10                                                           
         C     R3,ALOWTOG          IS THIS LOWEST TOGETHER                      
         BE    LEST8               YES                                          
         BH    LEST10              BYPASS IF 'LOWER' (ON RECAPS)                
*                                  EST IS NOT LOWEST                            
         L     RE,=A(DICSECT)                                                   
         MVC   P+2(L'SP@ESTTL),SP@ESTTL-DICSECT(RE) ESTIMATE TOTALS             
         CLI   PRDMKT,C'M'                                                      
         BE    LEST8                                                            
         MVC   P(2),=C'**'                                                      
         LA    RF,P+2+L'SP@ESTTL                                                
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   1(2,RF),=C'**'                                                   
         SPACE 2                                                                
LEST8    DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         MVC   TOTNAME,SPACES                                                   
         MVC   TOTNAME(L'SP@EST),SP@EST-DICSECT(RE)  ESTIMATE                   
         BRAS  RE,TOTOUT                                                        
*                                                                               
         BRAS  RE,SAVCORP                                                       
         MVI   SUMLEV,C'E'         CORP DATA SAVED AT EST LEVEL                 
         BRAS  RE,PRTADJ           PRINT ADJUSTMENTS                            
*                                                                               
         CLI   ECOMOPT,C'A'        COMMENT TO PRINT AFTER?                      
         BNE   LEST10                                                           
         CLI   ESTCTL,C'S'         BUT SKIP IF ESTS SEPARATE                    
         BE    LEST10                                                           
         BRAS  RE,COMPROC                                                       
*                                                                               
LEST10   DS    0H                                                               
         J     RBEXT                                                            
         EJECT                                                                  
*        LAST FOR MARKET GROUP                                                  
         SPACE 2                                                                
LMGR1    DS    0H                                                               
         LA    R5,MGR1             MGR1 DATA                                    
         B     LMGRA                                                            
         SPACE 2                                                                
LMGR2    DS    0H                                                               
         LA    R5,MGR2             MGR2 DATA                                    
         B     LMGRA                                                            
         SPACE 2                                                                
LMGR3    DS    0H                                                               
         LA    R5,MGR3             MGR3 DATA                                    
         B     LMGRA                                                            
         SPACE 2                                                                
LMGRA    NTR1                                                                   
         SPACE 2                                                                
         C     R3,ALOWTOG          IS THIS LOWEST TOGETHER                      
         BE    LMGRA8              YES                                          
         BH    LMGRX               BYPASS IF 'LOWER' (ON RECAPS)                
*                                  MGR NOT LOWEST                               
         MVC   P,SPACES                                                         
         MVC   P2,SPACES                                                        
         MVC   P3,SPACES                                                        
         MVC   P(2),=C'**'                                                      
         C     R3,AINVBRK          IF END OF INV                                
         BE    *+10                SKIP DESC IN TOTAL                           
         MVC   P+3(12),6(R5)                                                    
         LA    RF,P+15                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         L     RE,=A(DICSECT)                                                   
         MVC   2(L'SP6TOTAL,RF),SP6TOTAL-DICSECT(RE)  TOTALS **                 
         MVC   2+L'SP6TOTAL(2,RF),=C'**'                                        
*                                  SPECIAL NUMBER FOR NEEDHAM-HARPER            
         LA    R0,MGR2             IF MGR2                                      
         CR    R5,R0                                                            
         BNE   LMGRA8                                                           
*                                                                               
         CLC   QAGY,=C'NE'         AND NEEDHAM                                  
         BNE   LMGRA8                                                           
         CLC   CLT,=C'AB '         AND CLIENT ANHAUSER-BUSH                     
         BNE   LMGRA8                                                           
*                                                                               
         LA    RF,132(RF)          SPECIAL NUMBER ON P2 UNDER 'TOTAL'           
         MVC   0(20,RF),ESTNM                                                   
         MVC   11(3,RF),MGR2NM                                                  
*                                                                               
LMGRA8   DS    0H                                                               
         MVC   TOTNAME,6(R5)       SAVE DESCRIPTION                             
         BRAS  RE,TOTOUT                                                        
*                                                                               
LMGRX    DS    0H                                                               
         J     RBEXT                                                            
         EJECT                                                                  
*        LAST FOR MARKET                                                        
         SPACE 2                                                                
LMKT     DS    0H                                                               
         SPACE 2                                                                
         L     RF,=A(LMKTPR)                                                    
         BR    RF                                                               
*                                                                               
         SPACE 2                                                                
*        LAST FOR STATION                                                       
         SPACE 2                                                                
LSTA     DS    0H                                                               
         L     RF,=A(LSTAPR)                                                    
         BR    RF                                                               
         SPACE 2                                                                
*        LAST FOR NETWORK                                                       
         SPACE 2                                                                
LNET     DS    0H                                                               
         L     RF,=A(LNETPR)                                                    
         BR    RF                                                               
         EJECT                                                                  
*        LAST FOR PERIOD                                                        
         SPACE 2                                                                
LPER     DS    0H                                                               
         CLI   WIOPT,C'Y'          FOR WI OPTION                                
         BNE   LPER04                                                           
*                                                                               
         LR    R0,RE                                                            
         GOTOR PWROUND,DMCB,(RC)   ROUND CLT GROSS                              
         LR    RE,R0                                                            
*                                                                               
LPER04   DS    0H                                                               
LPERG    DS    0H                                                               
LCTYP    DS    0H                                                               
         C     R3,AINVBRK          IF INVOICE BREAK                             
         BNER  RE                                                               
         CLI   PASSNO,2            AND PASS 2                                   
         BNER  RE                                                               
*                                  PRINT TOTALS                                 
         L     R1,=A(DICSECT)                                                   
         MVC   P(L'SPETOTAL),SPETOTAL-DICSECT(R1)  ** TOTALS **                 
         LR    R0,RE                                                            
         BRAS  RE,TOTOUT                                                        
         LR    RE,R0                                                            
         BR    RE                                                               
         SPACE 2                                                                
LPGM     NTR1                                                                   
         SPACE 2                                                                
         CLI   SPOTCTL,C'Y'                                                     
         BNE   LPGMX                                                            
         CLI   PROGSW,C'P'                                                      
         BNE   LPGMX                                                            
         MVC   TOTNAME,=CL12'PROGRAM'                                           
         MVC   P+22(16),=C'*PROGRAM TOTALS*'                                    
         BRAS  RE,TOTOUT                                                        
LPGMX    DS    0H                                                               
         J     RBEXT                                                            
         SPACE 2                                                                
LDESC    NTR1                                                                   
         SPACE 2                                                                
         CLI   SPOTCTL,C'Y'                                                     
         BNE   LDESCX                                                           
         LA    R7,P+21                                                          
         LA    R4,16(R7)                                                        
*                                                                               
         L     R5,APGM                                                          
         MVC   1(18,R7),0(R5)                                                   
         L     R5,ADESC                                                         
         GOTO1 DATCON,DMCB,(2,0(R5)),(7,3(R4))                                  
         EDIT  (B1,2(R5)),(3,11(R4))                                            
         BRAS  RE,TOTOUT                                                        
LDESCX   DS    0H                                                               
         J     RBEXT                                                            
         SPACE 2                                                                
LPKG     NTR1                                                                   
         J     RBEXT               NO-OP                                        
         SPACE 2                                                                
LFLT     NTR1                                                                   
         J     RBEXT               NO-OP                                        
*                                                                               
         SPACE 3                                                                
*        ULINE IN FIRST BLANK LINE                                              
ULINE    NTR1                                                                   
*                                  FIND FIRST BLANK LINE                        
         LA    R3,P                                                             
         SR    RE,RE                                                            
UL2      DS    0H                                                               
         OC    0(40,R3),SPACES                                                  
         CLC   0(40,R3),SPACES                                                  
         BE    *+16                                                             
         LA    R3,132(R3)                                                       
         LA    RE,1(RE)                                                         
         B     UL2                                                              
*                                                                               
         LTR   RE,RE                                                            
         BNP   ULX                                                              
*                                                                               
         LA    RF,P+40                                                          
UL5      DS    0H                                                               
         LR    R1,RF                                                            
         LR    R0,RE                                                            
UL6      DS    0H                                                               
         CLI   0(R1),C' '                                                       
         BH    UL8                 FIRST NON-BLACK CHAR                         
         LA    R1,132(R1)                                                       
         BCT   R0,UL6                                                           
*                                                                               
         BCT   RF,UL5                                                           
*                                                                               
UL8      DS    0H                                                               
         LA    R0,P                                                             
         SR    RF,R0                                                            
         BM    ULX                                                              
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),DASHES                                                   
*                                                                               
ULX      DS    0H                                                               
         J     RBEXT                                                            
         SPACE 3                                                                
         LTORG                                                                  
         SPACE 3                                                                
BRKLIST  DS    0C                                                               
         DC    C'PGR1'                                                          
         DC    C'PGR2'                                                          
         DC    C'PGR3'                                                          
         DC    C'PRD '                                                          
         DC    C'EST '                                                          
         DC    C'MGR1'                                                          
         DC    C'MGR2'                                                          
         DC    C'MGR3'                                                          
         DC    C'MKT '                                                          
         DC    C'NET '                                                          
         DC    C'STA '                                                          
         DC    C'PKG '                                                          
         DC    C'PGM '                                                          
         DC    C'DESC'                                                          
         DC    C'PER '                                                          
         DC    C'PERG'                                                          
         DC    C'CTYP'                                                          
         DC    C'FLT'                                                           
*                                                                               
MOLSADDR DS    0C                                                               
         DC    CL36'MOLSON BREWERIES USA, INC.'                                 
         DC    CL26'11911 FREEDOM DRIVE'                                        
         DC    CL26'RESTON, VA.  22090-5609'                                    
         DC    CL26' '                                                          
         DC    CL26' '                                                          
         EJECT                                                                  
BMITOTS  DS    0F                  INVOICE TOTALS FOR BILL MIN CHECK            
BMIGRS   DS    F                   GROSS                                        
BMIGRS2  DS    F                   GROSS - 2ND CURR                             
BMINET   DS    F                   NET                                          
BMINET2  DS    F                   NET - 2ND CURR                               
BMITOTLQ EQU   *-BMITOTS                                                        
BIGTOTS  DS    0F                  TOTALS FOR 21 MIL CHECK                      
BIGOGRS  DS    PL8                 ORDERED GROSS                                
BIGOGRS2 DS    PL8                 GROSS - 2ND CURR                             
BIGONET  DS    PL8                 NET                                          
BIGONET2 DS    PL8                 NET - 2ND CURR                               
BILLED   EQU   *-BIGOGRS                                                        
BIGBGRS  DS    PL8                 BILLED GROSS                                 
BIGBGRS2 DS    PL8                 GROSS - 2ND CURR                             
BIGBNET  DS    PL8                 NET                                          
BIGBNET2 DS    PL8                 NET - 2ND CURR                               
BIGTOTLQ EQU   *-BIGTOTS                                                        
TOTSLQ   EQU   *-BMITOTS                                                        
         EJECT                                                                  
*                                                                               
*                                                                               
* READ BILL ADDRESS RECORD FOR EXTENDED ADDRESS FIELDS                          
*                                                                               
RBILADDR NMOD1 0,RBILAD                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         CLC   THREE,=C'AAA'                                                    
         BE    RBI02                                                            
         L     R0,=A(BADDRS)       CLEAR PREV PROD ADDR                         
         LHI   R1,ADDRLEN                                                       
         SR    RE,RE                                                            
         LA    RF,X'40'            FILL WITH SPACES                             
         SLL   RF,24                                                            
         MVCL  (R0),(RE)                                                        
*                                                                               
RBI02    XC    KEY,KEY                                                          
         L     RF,ADCLT                                                         
         MVC   KEY(2),=X'0D09'                                                  
         MVC   KEY+2(3),1(RF)      A/M,CLT                                      
         MVC   KEY+5(3),THREE      PRODUCT AAA OR ACTUAL BRAND                  
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   RBILX                                                            
         MVC   AREC,=A(STABUCKC)   READ INTO STABUC                             
         GOTO1 GET                                                              
*                                                                               
         L     R2,AREC             NOW HAS PRODUCT AAA                          
         LA    R2,24(R2)           TO FIRST ELEMENT                             
         CLI   0(R2),X'10'         NAME ELEMENT?                                
         BE    *+6                                                              
         DC    H'0'                                                             
         USING ADRNAMEL,R2                                                      
*                                                                               
         L     R0,=A(BADDRS)       BRAND ADDRESS                                
         CLC   THREE,=C'AAA'                                                    
         BNE   *+12                                                             
         L     R0,=A(AADDRS)       AAA CORPORATE ADDRESS FOUND                  
         OI    FLAG1,AADDRSW                                                    
*                                                                               
         LR    R3,R0                                                            
*                                                                               
         LHI   R1,ADDRLEN                                                       
         SR    RE,RE                                                            
         LA    RF,X'40'            FILL WITH SPACES                             
         SLL   RF,24                                                            
         MVCL  (R0),(RE)                                                        
*                                                                               
         CLC   =C'NONE',ADRNAM1                                                 
         BE    RBINEQ                                                           
         CLC   =C'XX',ADRNAM1                                                   
         BE    RBINEQ                                                           
         CLC   =C'X ',ADRNAM1                                                   
         BE    RBINEQ                                                           
         CLI   ADRADDR1,C'A'                                                    
         BL    RBINEQ                                                           
*                                                                               
         MVC   0(L'ADRNAM1,R3),ADRNAM1                                          
         LA    R3,L'ADRNAM1(R3)                                                 
         CLC   ADRNAM2,SPACES      ANY  NAME 2?                                 
         BE    *+14                                                             
         MVC   0(L'ADRNAM2,R3),ADRNAM2                                          
         LA    R3,L'ADRNAM2(R3)                                                 
         DROP  R2                                                               
*                                                                               
         MVI   ELCODE,X'20'        ADDRESS ELEMENT                              
         BRAS  RE,NEXTEL                                                        
         BNE   RBI10                                                            
         USING ADRADDEL,R2                                                      
*                                                                               
         MVC   0(L'ADRADDR1,R3),ADRADDR1                                        
         LA    R3,L'ADRADDR1(R3)                                                
         CLC   ADRADDR2,SPACES     ANY ADDRESS 2?                               
         BE    *+14                                                             
         MVC   0(L'ADRADDR2,R3),ADRADDR2                                        
         LA    R3,L'ADRADDR2(R3)                                                
         DROP  R2                                                               
*                                                                               
         B     *+12                                                             
RBI10    L     R2,AREC                                                          
         LA    R2,24(R2)                                                        
         MVI   ELCODE,X'30'        ATTENTION OF ELEM                            
         BRAS  RE,NEXTEL                                                        
         BNE   RBIEQ                                                            
         USING ADRATTEL,R2                                                      
*                                                                               
         MVC   0(L'ADRATTN,R3),ADRATTN                                          
*                                                                               
RBIEQ    CR    R1,R1               SET CC EQ - RECORD FOUND                     
         B     *+6                                                              
RBINEQ   LTR   RB,RB                                                            
*                                                                               
RBILX    XIT1                                                                   
         EJECT                                                                  
*                                                                               
*                                                                               
FMGRAPR  NMOD1 0,FMGRAPR                                                        
         LA    RC,SPACEND                                                       
*                                                                               
         CLC   AESTBRK,AINVBRK     IF EST SEPARATE                              
         BH    *+12                                                             
         BRAS  RE,TSTRET           DO RETAIL TEST                               
         BNZ   FMGRAX                                                           
*                                                                               
         OC    ALOWTOG,ALOWTOG                                                  
         BZ    *+12                                                             
         C     R3,ALOWTOG          TEST IF TO APPEAR                            
         BH    FMGRAX              NO                                           
         L     RF,AMGR1            POINT TO MGR1 FIELD                          
*                                                                               
         ZIC   RE,MGR3LEN                                                       
*                                                                               
         XC    WORK(5),WORK                                                     
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   WORK(0),0(RF)                                                    
         PACK  X(3),WORK(5)      PWOS MGR                                       
         OC    WORK(5),SPACES                                                   
         MVC   X+10(5),WORK        SAVE MGR FOR PRINT                           
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0D02'                                                  
         MVC   KEY+2(1),BAGYMD                                                  
*                                                                               
         CLI   QMGR,C' '           MGR'S 01-3F ARE CROSS CLIENT                 
         BL    *+18                                                             
         CLI   QMGR,C'F'                                                        
         BH    *+10                                                             
         MVC   KEY+3(2),BCLT                                                    
*                                                                               
         MVC   KEY+8(1),QMGR       MGR CODE                                     
         MVC   KEY+9(2),X          MGR NUMBER                                   
         CLI   SVMKGPGA,0          TEST DOING MGR'S WITHIN PGR'S                
         BNE   FMGRA3A                                                          
         GOTO1 HIGH                NO, JUST GET MGR                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   FMGRA5                                                           
         B     FMGRA4                                                           
*                                  YES, NEED PGR                                
FMGRA3A  DS    0H                                                               
         L     RF,APGR1            POINT TO PRG1 FIELD                          
         ZIC   RE,PGR3LEN                                                       
*                                  READ FOR MGR RECORD                          
         XC    WORK(5),WORK                                                     
         BCTR  RE,0                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   WORK(0),0(RF)                                                    
         PACK  X(3),WORK(5)      PWOS PRG                                       
         MVC   KEY+6(2),X                                                       
         MVC   KEY+5(1),QPGR                                                    
*                                                                               
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    FMGRA4                                                           
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         XC    KEY+6(2),KEY+6      LOOK UNDER SCHEME ONLY                       
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BE    FMGRA4                                                           
*                                                                               
         MVC   KEY,KEYSAVE                                                      
         MVI   KEY+5,0             FORGET SCHEME AND NUMBER                     
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   FMGRA5                                                           
*                                                                               
FMGRA4   DS    0H                                                               
         GOTO1 GETMKTGR                                                         
         B     FMGRA6                                                           
*                                                                               
FMGRA5   DS    0H                                                               
         MVC   MGR1+1(4),X+10                                                   
         MVC   MGR2+1(4),X+10                                                   
         MVC   MGR3+1(4),X+10                                                   
         MVC   MGR1N+2(4),X+10                                                  
         MVC   MGR2N+2(4),X+10                                                  
         MVC   MGR3N+2(4),X+10                                                  
         L     RE,=A(DICSECT)                                                   
         MVC   MGR1NM,SPACES                                                    
         MVC   MGR2NM,SPACES                                                    
         MVC   MGR3NM,SPACES                                                    
         MVC   MGR1NM(L'SP@UNDEF),SP@UNDEF-DICSECT(RE)                          
         MVC   MGR2NM(L'SP@UNDEF),SP@UNDEF-DICSECT(RE)                          
         MVC   MGR3NM(L'SP@UNDEF),SP@UNDEF-DICSECT(RE)                          
*                                                                               
FMGRA6   DS    0H                                                               
         C     R3,APAGBRK          TEST MGR 'HIGHER' THAN PAGE BRK              
         BNH   FMGRA10             YES                                          
*                                  MGR 'TOGETHER'                               
         CLC   P,SPACES                                                         
         BE    *+12                                                             
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         OC    18(24,R5),SPACES                                                 
         CLC   ALOWTOG,AHITOG                                                   
         BNE   FMGRA7B                                                          
*                                  IS ONLY TOGETHER                             
         MVC   P(6),0(R6)                                                       
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P+7(24),18(R5)                                                   
         B     FMGRA10                                                          
         GOTO1 CHOPPER,DMCB,(24,18(R5)),(14,P+6),(C'P',2)                       
         B     FMGRA10                                                          
*                                                                               
FMGRA7B  DS    0H                                                               
         MVC   P(12),6(R5)         DESC                                         
         LA    RF,P+12                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   2(6,RF),0(R6)       NUMBER                                       
*                                                                               
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+14                                                             
         MVC   P2(24),18(R5)                                                    
         B     FMGR7D                                                           
         GOTO1 CHOPPER,DMCB,(24,18(R5)),(20,P2),(C'P',2)                        
FMGR7D   DS    0H                                                               
         C     R3,ALOWTOG                                                       
         BE    *+8                                                              
         BRAS  RE,ULINE                                                         
         B     FMGRA10                                                          
*                                  MGR IN HEADS                                 
FMGRA10  DS    0H                                                               
         GOTO1 ABILLEDI,DMCB,('EDMMGR',0)    EDI CALL                           
FMGRAX   DS    0H                                                               
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
*                                                                               
*                                                                               
*        FIRST FOR MARKET                                                       
         SPACE 2                                                                
FMKTPR   NMOD1 0,FMKTPR                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         CLC   AMKTBRK,AINVBRK     IF MKT SEPARATE                              
         BH    FMKT3                                                            
         CLC   AESTBRK,AINVBRK     AND EST SEPARATE                             
         BH    FMKT3                                                            
         BRAS  RE,TSTRET           DO RETAIL TEST                               
         BNZ   FMKTX               SKIP                                         
*                                                                               
FMKT3    DS    0H                                                               
         CLI   MKTCTL,C'N'                                                      
         BE    FMKTX                                                            
         OC    ALOWTOG,ALOWTOG                                                  
         BZ    *+12                                                             
         C     R3,ALOWTOG          TEST IF TO APPEAR                            
         BH    FMKTX               NO                                           
         L     RF,AMKT                                                          
         OC    0(2,RF),0(RF)       IF NO MARKET-SKIP ALL MKT CODE               
         BNZ   *+12                                                             
         MVI   MKTCTL,C'N'         (MKTCTL RESET AT ENDINV)                     
         B     FMKTX                                                            
         CLC   XXMKT,0(RF)         SKIP PREV BILL MKT                           
         BNE   FMKT3B                                                           
         MVI   SPACING,2                                                        
         CLI   FORMAT,10           FOR 'ORDERED ONLY' FORMATS                   
         BH    FMKTX                                                            
         L     RE,=A(DICSECT)                                                   
         MVC   MKTNM,SPACES                                                     
         MVC   MKTNM(L'SP@PRVBL),SP@PRVBL-DICSECT(RE) PREVIOUS BILLING          
         MVC   MKT,=C'9998'                                                     
         B     FMKT4                                                            
*                                                                               
FMKT3B   DS    0H                                                               
         LH    RF,0(RF)                                                         
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  FULL,DUB                                                         
         CLC   MKT,FULL                                                         
         BE    FMKT4                                                            
*                                                                               
         MVC   MKT,FULL                                                         
         MVI   KEY,C'0'                                                         
         MVC   KEY+1(14),KEY                                                    
         MVI   KEY,C'M'                                                         
         MVC   KEY+1(1),QMED                                                    
         MVC   KEY+2(4),MKT                                                     
         MVC   KEY+6(2),QAGY                                                    
         GOTO1 READMKT                                                          
         OC    MKTNM,SPACES                                                     
*                                                                               
FMKT4    DS    0H                                                               
         CLI   MCOMOPT,C'B'        COMMENT TO PRINT BEFORE?                     
         BNE   *+8                                                              
         BRAS  RE,COMPROC                                                       
*                                                                               
         C     R3,APAGBRK          TEST MKT 'HIGHER' THAN PAGE BREAK            
         BNH   FMKT10              YES                                          
*                                  MKT 'TOGETHER'                               
         CLC   P,SPACES                                                         
         BE    *+12                                                             
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT            =CLEAR P                                      
*                                                                               
         OC    MKTNM,SPACES                                                     
         CLI   PRDMKT,C'M'         TEST MKT HIGHER THAN PRD                     
         BNE   FMKT6                                                            
*                                                                               
         L     RE,=A(DICSECT)                                                   
         MVC   P(L'SPAMKT),SPAMKT-DICSECT(RE)   MARKET-                         
         MVI   P+L'SPAMKT+1,C'-'                                                
         MVC   P+L'SPAMKT+2(4),MKT                                              
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+18                                                             
         MVI   P3+24,0             PREVENT 'MERGE UP' OF STATIONS               
         MVC   P2(24),MKTNM                                                     
         B     FMKT5B                                                           
         GOTO1 CHOPPER,DMCB,(24,MKTNM),(20,P2),(C'P',2)                         
FMKT5B   DS    0H                                                               
         BRAS  RE,ULINE                                                         
         B     FMKT10                                                           
*                                                                               
FMKT6    DS    0H                                                               
         CLI   TWOCOL,C'Y'                                                      
         BNE   *+18                                                             
         MVI   P+50,0             PREVENT 'MERGE UP' OF STATIONS                
         MVC   P(24),MKTNM                                                      
         B     FMKT10                                                           
         GOTO1 CHOPPER,DMCB,(24,MKTNM),(20,P),(C'P',2)                          
         B     FMKT10                                                           
*                                  MKT IN HEADS                                 
FMKT10   DS    0H                                                               
         GOTO1 ABILLEDI,DMCB,('EDMMKT',0)    EDI CALL                           
FMKTX    DS    0H                                                               
         XIT1                                                                   
         LTORG                                                                  
         SPACE 3                                                                
         DROP  R9                                                               
         EJECT                                                                  
*        FIRST FOR STATION                                                      
         SPACE 2                                                                
FSTAPR   NMOD1 0,FSTAPR                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   STACTL,C'N'                                                      
         BE    FSTAX                                                            
         L     R4,ASTA                                                          
         SHI   R4,2                                                             
         GOTO1 MSUNPK,DMCB,(X'80',(R4)),DUB,WORK                                
         MVC   BIGSTA,SPACES                                                    
         MVC   BIGSTA(8),WORK                                                   
         L     RF,ADAGY                                                         
         CLI   AGYPROF+7-AGYHDR(RF),C'C'                                        
         BE    *+20                FOR CANADA SKIP LOCAL CABLE CHECK            
         CLI   BIGSTA,X'E8'        LOCAL CABLE                                  
         BL    *+12                                                             
         MVI   BIGSTA+4,C'/'       NEEDS A /                                    
         B     FSTA4                                                            
*                                                                               
         CLI   QMED,C'N'           CHECK NEW STYLE CANAD CABLE                  
         BNE   FSTA2                                                            
         L     RF,ASTA                                                          
         CLI   2(RF),X'B0'                                                      
         BL    FSTA2                                                            
         MVC   STAPRINT,BIGSTA     CAN'T HURT TO SET STAPRINT TOO               
         MVC   STACITY,SPACES                                                   
         B     FSTA4J                                                           
FSTA2    CLI   BIGSTA+4,C'D'       DIGITAL BUY?                                 
         BNE   *+14                                                             
         MVC   BIGSTA+4(3),=C'-DV' YES, HAVE TO OVERRIDE                        
         B     *+10                                                             
         MVC   BIGSTA+4(3),=C'-TV' BUT OTHERS NEED WORK                         
         CLI   QMED,C'T'                                                        
         BE    FSTA4                                                            
         MVC   BIGSTA+4(3),SPACES                                               
         CLI   QMED,C'R'                                                        
         BNE   FSTA4                                                            
         MVC   BIGSTA+4(3),=C'- M'                                              
         MVC   BIGSTA+5(1),WORK+4                                               
FSTA4    DS    0H                                                               
         MVC   STAPRINT,BIGSTA     CAN'T HURT TO SET STAPRINT TOO               
         MVC   STACITY,SPACES                                                   
         CLI   BIGSTA+4,C'/'       FOR LOCAL CABLE                              
         BNE   FSTA4J                                                           
*                                  NEED TO GET OPERATOR NAME                    
         MVI   KEY,C'0'            (WILL SUPERCEDE ANY OTHER CITY USE)          
         MVC   KEY+1(14),KEY                                                    
         MVI   KEY,C'S'                                                         
         MVC   KEY+1(1),QMED                                                    
         MVC   KEY+2(4),BIGSTA                                                  
         MVI   KEY+6,C'T'                                                       
         MVC   KEY+7(2),QAGY                                                    
         GOTO1 HIGHSTA                                                          
         L     RF,ADSTAT                                                        
         USING STAREC,RF                                                        
         CLC   STAREC(15),KEYSAVE                                               
         BNE   *+10                                                             
         MVC   STACITY,SSYSNAME      OPERATOR NAME                              
         B     FSTA4R                                                           
         DROP  RF                                                               
*                                                                               
FSTA4J   DS    0H                                                               
         CLI   RETPROF+13,C'Y'     TEST NEED STATION CITY                       
         BNE   FSTA4M                                                           
         MVI   KEY,C'0'                                                         
         MVC   KEY+1(14),KEY                                                    
         MVI   KEY,C'A'                                                         
         MVC   KEY+1(1),QMED                                                    
         MVC   KEY+2(4),BIGSTA                                                  
         MVC   KEY+6(1),BIGSTA+5                                                
         MVC   KEY+7(2),QAGY                                                    
         GOTO1 HIGHSTAD                                                         
         L     RF,ADSTATAD                                                      
         USING ADDRREC,RF                                                       
         CLC   ADDRREC(15),KEYSAVE                                              
         BNE   *+10                                                             
         MVC   STACITY,A2LINE      2ND ADDRESS LINE IS CITY                     
         B     FSTA4R                                                           
         DROP  RF                                                               
*                                                                               
FSTA4M   DS    0H                                                               
         CLI   AFFOPT,C'Y'         TEST NEED AFFILIATE                          
         BNE   FSTA4R              (NOTE-USES STACITY SPACE)                    
         L     RF,ADAGY                                                         
         CLI   AGYPROF+7-AGYHDR(RF),C'C'  FOR CANADA USE BOUGHT NETWK           
         BE    FSTA4N                                                           
         MVI   KEY,C'0'                                                         
         MVC   KEY+1(14),KEY                                                    
         MVI   KEY,C'S'                                                         
         MVC   KEY+1(1),QMED                                                    
         MVC   KEY+2(4),BIGSTA                                                  
         MVC   KEY+6(1),BIGSTA+5                                                
         CLI   QMED,C'N'                                                        
         BNE   *+8                                                              
         MVI   KEY+6,C'N'                                                       
         MVC   KEY+7(2),QAGY                                                    
         GOTO1 HIGHSTA                                                          
         L     RF,ADSTAT                                                        
         USING STAREC,RF                                                        
         CLC   STAREC(15),KEYSAVE                                               
         BNE   FSTA4R                                                           
         MVC   STACITY+1(3),SNETWRK      US NETWORK                             
         B     FSTA4O                                                           
         DROP  RF                                                               
*                                                                               
FSTA4N   DS    0H                  FOR CANADA, GET NETWORK FROM TABLE           
         CLI   QMED,C'N'           ONLY IF MEDIA NETWORK                        
         BNE   FSTA4R                                                           
         L     RF,ASTA                                                          
         MVC   BYTE,2(RF)          USE THIRD BYTE                               
*                                                                               
         CLI   BYTE,X'B0'                                                       
         BL    FSTA4N5                                                          
         MVC   THREE,0(RF)         ... IT'S A CABLE NETWORK                     
         MVI   THREE+2,X'03'       MEDIA IS ALWAYS 'N'                          
         GOTO1 MSUNPK,DMCB,THREE,FULL,DUB                                       
         MVC   STACITY+1(4),DUB                                                 
         B     FSTA4O                                                           
*                                                                               
FSTA4N5  DS    0H                                                               
         NI    BYTE,X'FF'-X'E0'    USE LOW 5 BITS                               
         ZIC   RF,BYTE                                                          
         MHI   RF,NETTABL                                                       
         A     RF,=A(NETTAB)                                                    
         MVC   STACITY+1(4),0(RF)                                               
*                                                                               
FSTA4O   DS    0H                                                               
         CLI   STACITY+1,C' '          TEST HAVE NETWROK                        
         BNH   FSTA4R                                                           
*                                                                               
         MVI   STACITY,C'('                                                     
         LA    RF,STACITY+5                                                     
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVI   1(RF),C')'                                                       
         B     FSTA4R                                                           
*                                                                               
FSTA4R   DS    0H                                                               
         C     R3,ALOWTOG                                                       
         BNL   FSTA8               SKIP IF LOWEST TOG OR NOT TO APPEAR          
*                                                                               
         C     R3,APAGBRK          TEST STA 'HIGHER' THAN PAGE BRK              
         BNH   FSTA8               YES                                          
*                                  STA TOGETHER (WITH SPOT DETAILS)             
         CLC   P,SPACES                                                         
         BE    *+12                                                             
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         MVC   P+10(9),BIGSTA                                                   
*                                                                               
FSTA8    DS    0H                                                               
         CLI   PASSNO,1            IF DOING PASS 1                              
         BNE   *+14                                                             
         OC    ARECAP,ARECAP       AND WILL DO RECAP                            
         BNZ   FSTAX            ?? DON'T DO STATION EDI NOW BECAUSE ??          
*                               ?? STATION CANT APPEAR ON MAIL BILL ??          
*                                                                               
         GOTO1 ABILLEDI,DMCB,('EDMSTA',0)   EDI CALL                            
*                                                                               
FSTAX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*        LAST FOR STATION                                                       
         SPACE 2                                                                
LSTAPR   NMOD1 LSTAQ,LSTAPR                                                     
         LR    R9,RC                                                            
         USING LSTAD,R9                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         CLI   STACTL,C'N'        NO STATION ON BILL                            
         BE    LSTAX                                                            
         C     R3,ALOWTOG                                                       
         BH    LSTAX               BYPASS IF 'LOWER' (ON RECAPS)                
         BL    LSTA8                                                            
*                                                                               
         CLI   WIOPT,C'Y'          FOR WI OPTION                                
         BNE   LSTA3               -------------                                
         L     RF,ASTA                                                          
         CLC   0(3,RF),=X'FFFFFE'  SKIP RECORD WITH GROSS                       
         BE    LSTAX               TOTALS ACROSS STATIONS                       
         CLC   0(3,RF),=X'FFFFFF'  TREAT ADJUSTMENT $ SPECIALLY                 
         BNE   LSTA3                                                            
*                                                                               
         MVC   TOTNAME(12),SPACES                                               
         LA    RF,P+22             ASSUME FORMAT 5, SINGLE MONTH                
         CLI   FORMAT,5                                                         
         BE    *+8                                                              
         LA    RF,P+11             OR FORMAT 1                                  
         MVC   0(7,RF),=C'*TOTAL*'                                              
         MVI   WIPRSW,X'E0'        PRINT ORDERED $ ONLY                         
         MVI   WISTRIP,C'N'        NO STRIP OFF AT THIS POINT                   
         SHI   R3,BRKL             AMOUNTS FROM NEXT LEVEL                      
         GOTOR PWROUND,DMCB,(RC)   ROUND CLIENT GROSS                           
         BRAS  RE,TOTOUT                                                        
         L     R3,ASTABRK          RESET TO STATION BREAK                       
*                                                                               
LSTA3    DS    0H                                                               
*                                  STATION COMMENT LOGIC                        
         MVC   STCMNT,SPACES                                                    
         CLI   STACMOPT,C'Y'       TEST OPTION                                  
         BNE   LSTA3L                                                           
         CLI   ESTCTL,C'N'         EST MUST BE ON BILL                          
         BE    LSTA3L                                                           
         XC    BCMTYPE(14),BCMTYPE                                              
         MVI   BCMTYPE,C'S'                                                     
         MVC   BCMCLT,BCLT                                                      
         CLI   PRDCTL,C'N'         TEST PRD'S ON BILL                           
         BE    LSTA3D                                                           
         L     RF,APRD                                                          
         ZIC   R4,0(RF)            GET PROD CODE FROM PROD SEQ                  
         MHI   R4,4                                                             
         L     RF,ADCLT                                                         
         LA    R4,CLIST-CLTHDR(RF,R4)                                           
         MVC   BCMPRD,3(R4)                                                     
*                                                                               
LSTA3D   DS    0H                                                               
         L     RF,AEST                                                          
         MVC   BCMEST,0(RF)                                                     
         L     RF,ASTA                                                          
         MVC   BCMSTA,0(RF)                                                     
*                                                                               
         GOTO1 GETCOM                                                           
         L     R2,ADCOMREC                                                      
         CLI   0(R2),0             TEST ANY COMMENT FOUND                       
         BE    LSTA3L              NO                                           
*                                                                               
         ST    R3,SAVBRK           USED BY BILLEDI                              
         GOTO1 ABILLEDI,DMCB,('EDMCOM',0)   EDI CALL - STATION COMENT           
         LA    R2,COMEL-COMHDR(R2)                                              
*                                                                               
LSTA3G   DS    0H                                                               
         CLI   0(R2),0             EOR                                          
         BE    LSTA3L              NO COMMENT                                   
         CLI   0(R2),X'05'                                                      
         BE    LSTA3H                                                           
         CLI   0(R2),X'15'                                                      
         BE    LSTA3H                                                           
         ZIC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     LSTA3G                                                           
*                                                                               
LSTA3H   DS    0H                                                               
         ZIC   RF,1(R2)                                                         
         SHI   RF,3                                                             
         BM    LSTA3L                                                           
         CHI   RF,L'STCMNT-1       MAX LENGTH                                   
         BNH   *+8                                                              
         LHI   RF,L'STCMNT-1                                                    
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   STCMNT(0),2(R2)                                                  
*                                                                               
LSTA3L   DS    0H                                                               
         CLI   PERCTL,C'T'                                                      
         BE    LSTA4                                                            
*                                  SINGLE MONTH                                 
         LA    R5,P+22                                                          
         CLI   FORMAT,5                                                         
         BNL   *+8                                                              
         LA    R5,P+11                                                          
         B     LSTA6                                                            
*                                                                               
LSTA4    DS    0H                  MULTI-MONTH                                  
         LA    R5,P+11                                                          
         CLI   FORMAT,5                                                         
         BNL   *+8                                                              
         LA    R5,P+2                                                           
LSTA6    DS    0H                                                               
         LR    RF,R5                                                            
         SHI   RF,2                                                             
         CLC   0(8,RF),SPACES      SEE IF CAN PRINT ON SAME LINE                
         BNE   *+14                NO                                           
         CLC   P2,SPACES                                                        
         BE    *+8                                                              
         BRAS  RE,PRNT                                                          
*                                                                               
         L     R4,ASTA                                                          
         CLC   XXSTA,0(R4)                                                      
         BNE   LSTA7A                                                           
         CLI   FORMAT,10           FOR 'ORDERED ONLY' FORMATS                   
         BH    LSTAX               SKIP PREV BILL MKT                           
         CLI   PRDMKT,C'M'         IF MKT HIGHER THAN PRD                       
         BNE   LSTA7B                                                           
         MVI   0(R5),C'.'             FORCE PRINTING                            
         B     LSTA7B                                                           
LSTA7A   DS    0H                                                               
         MVC   0(9,R5),BIGSTA                                                   
*                                                                               
         CLI   PROFB4A+5,C'Y'      SUPRESSING STATION $ ?                       
         BE    LS20C                                                            
         CLI   PROFB4A+5,C'N'      NOT                                          
         BE    LS20C4                                                           
         CLI   WIOPT,C'Y'          IF NOT SPECIFIED ASSUME PW                   
         BNE   LS21                WILL SUPPRESS                                
*                                                                               
LS20C    DS    0H                                                               
         MVI   WIPRSW,X'20'        PRINT NO $                                   
*                                                                               
LS20C4   DS    0H                                                               
         MVI   WISTRIP,C'N'        NO STRIP FOR STATIONS                        
         L     RF,ASTA                                                          
         CLC   0(3,RF),=X'FFFFFF'   FOR 'ADJUSTMENT STATION'                    
         BNE   LS21                                                             
*                                                                               
         L     RF,ASORTDTA     SKIP IF PW GROSS IS $0 (AFTER ROUND)             
         L     R1,RGRS2D(RF)                                                    
         M     R0,=F'1'                                                         
         LHI   RF,100                                                           
         DRNDR (R0),(RF)                                                        
         LTR   R1,R1                                                            
         BNZ   LS20D                                                            
*                                                                               
         MVI   TOTSW,C'N'          ENSURE PRINT INVOICE TOTALS                  
         MVI   WIPRSW,0            PRINT ALL COLUMNS                            
         MVI   WISTRIP,C'Y'        STRIP                                        
         B     LSTAX                                                            
*                                                                               
LS20D    DS    0H                                                               
         MVI   WISTRIP,C'Y'        STRIP                                        
         MVI   WIPRSW,X'E0'        PRINT ONLY ORDERED                           
         MVC   0(20,R5),=CL20'*TOTAL DEBIT/CREDIT*'                             
*                                                                               
LS21     DS    0H                                                               
         CLI   STCMNT,C' '         TEST HAVE STATION COMMENT                    
         BE    LSTA7A2R                                                         
*                                                                               
         CLI   FORMAT,5            IF LONG FORMAT                               
         BH    LSTA7A2M                                                         
         CLI   PERCTL,C'T'         AND PERIODS NOT TOGETHER                     
         BE    LSTA7A2M                                                         
         LA    RF,132(R5)          PUT COMMENT ON NEXT LINE                     
         B     LSTA7A2P                                                         
*                                                                               
LSTA7A2M DS    0H                  ELSE FLOAT CMNT AT END OF STATION            
         LA    RF,8(R5)                                                         
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    RF,2(RF)                                                         
*                                                                               
LSTA7A2P DS    0H                  COMMENT IN ()                                
         MVI   0(RF),C'('                                                       
         MVC   1(L'STCMNT,RF),STCMNT                                            
         LA    RF,L'STCMNT+1(RF)                                                
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVI   1(RF),C')'                                                       
         B     LSTA7B              SKIP STACITY LOGIC, ETC.                     
*                                                                               
LSTA7A2R DS    0H                                                               
         CLI   FORMAT,14           FOR FORMAT 14                                
         BNE   *+12                                                             
         CLI   TAXOPT,C'E'         AND TAXOPT A-E                               
         BNH   LSTA7A2S            MUST PUT CITY ON NEXT LINE                   
*                                                                               
         CLI   PERCTL,C'T'         IF PERIODS TOGETHER                          
         BE    LSTA7A2T            FLOAT CITY                                   
*                                                                               
         CLI   BIGSTA+4,C'/'       IF CABLE/NET                                 
         BE    LSTA7A2S            PUT CABLE NET ('CITY') ON NEXT LINE          
*                                                                               
         CLI   FORMAT,5            IF SHORT FORMAT                              
         BH    LSTA7A2T            FLOAT                                        
         CLI   AFFOPT,C'Y'         IF 'CITY' IS NETWORK AFFIL                   
         BE    LSTA7A2T            FLOAT                                        
*                                                                               
LSTA7A2S DS    0H                                                               
         LA    RF,132+2(R5)        PUT CITY ON NEXT LINE                        
         B     LSTA7A2V                                                         
*                                                                               
LSTA7A2T DS    0H                  ELSE FLOAT CITY AT END OF STATION            
         LA    RF,8(R5)                                                         
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    RF,2(RF)                                                         
*                                                                               
LSTA7A2V DS    0H                                                               
         LR    R5,RF                                                            
         CLI   PROFB2B+7,C'Y'      SUPPRESSING SYSCODE NAME                     
         BE    *+18                                                             
         CLI   STACITY,C' '        CITY                                         
         BNH   *+10                                                             
         MVC   0(24,R5),STACITY                                                 
*                                                                               
         CLI   RETPROF+13,C'Y'     TEST BACKER SPECIAL                          
         BNE   LSTA7B                                                           
         L     RF,ASORTCOM         CHANNEL IS IN COMMENT(4)                     
         CLI   0(RF),C' '          FLOAT AFTER CITY                             
         BNH   LSTA7B                                                           
         LA    R1,132(R5)                                                       
         LA    RE,24(R1)                                                        
*                                                                               
LSTA7A3  DS    0H                                                               
         CR    RE,R1                                                            
         BL    *+16                                                             
         CLI   0(RE),C' '                                                       
         BH    *+8                                                              
         BCT   RE,LSTA7A3                                                       
*                                                                               
         MVI   2(RE),C'('                                                       
         MVC   3(4,RE),0(RF)                                                    
         OC    3(4,RE),SPACES                                                   
         LA    RE,6(RE)                                                         
         CLI   0(RE),C' '                                                       
         BH    *+8                                                              
         BCT   RE,*-8                                                           
         MVI   1(RE),C')'                                                       
*                                                                               
LSTA7B   DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         MVC   TOTNAME,SPACES                                                   
         MVC   TOTNAME(L'SP@STATN),SP@STATN-DICSECT(RE)  STATION                
         CLI   QMED,C'N'                                                        
         BNE   *+16                                                             
         MVC   TOTNAME,SPACES                                                   
         MVC   TOTNAME(L'SP@NTWRK),SP@NTWRK-DICSECT(RE)  NETWORK                
         BRAS  RE,TOTOUT                                                        
         B     LSTAX                                                            
*                                  STATION NOT LOWEST TOG (SPOT DETS)           
LSTA8    DS    0H                                                               
         CLI   PERCTL,C'T'                                                      
         BNE   *+8                                                              
         BRAS  RE,PRNT             SKIP A LINE IF MULTI-MONTH                   
*                                                                               
         XC    WORK,WORK                                                        
         MVC   WORK+1(9),BIGSTA                                                 
         LA    RF,WORK+1+8                                                      
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         L     RE,=A(DICSECT)                                                   
         MVC   2(L'SP6TOTAL,RF),SP6TOTAL-DICSECT(RE)  TOTALS                    
         CLI   PERCTL,C'T'                                                      
         BE    *+12                                                             
         MVI   7(RF),C'*'                                                       
         MVI   WORK,C'*'                                                        
*                                                                               
         LA    R0,WORK-7                                                        
         SR    RF,R0               RF HAS LENGTH - 1                            
         LA    RE,P+17                                                          
         SR    RE,RF               RE HASE TO ADDR FOR MOVE                     
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),WORK                                                     
*                                                                               
         B     LSTA7B                                                           
*                                                                               
LSTAX    DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
         DROP  R9                                                               
         LTORG                                                                  
LSTAD    DSECT                                                                  
STCMNT   DS    CL15                                                             
LSTAQ    EQU   *-LSTAD                                                          
         EJECT                                                                  
SPB102   CSECT                                                                  
*        LAST FOR MARKET                                                        
*                                                                               
LMKTPR   NMOD1 0,LMKTPR                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
*                                                                               
         CLI   WIOPT,C'Y'          FOR WI OPTION                                
         BNE   LMKT04                                                           
*                                                                               
         GOTOR PWROUND,DMCB,(RC)   ROUND CLT GROSS                              
*                                                                               
LMKT04   DS    0H                                                               
         CLI   BFROPT,C'N'         FOR NEW BFR'S                                
         BE    *+8                 DO A BILCALC NOW                             
         BRAS  RE,BILCALC                                                       
*                                                                               
         CLI   MKTCTL,C'N'                                                      
         BE    LMKT10              NO MKT ON BILL                               
         CLI   UPASS,C'S'          FOR RETAIL SUMMARY                           
         BNE   *+16                                                             
         CLI   BFROPT,C'N'         DON'T DO BILCALCS TWICE                      
         BNE   *+8                                                              
         BRAS  RE,BILCALC          DO CALCS NOW                                 
*                                                                               
         C     R3,ALOWTOG          IS THIS LOWEST BREAK                         
         BE    LMKT6               YES                                          
         BH    LMKT10              BYPASS IF OTHERS 'LOWER' (ON RECAPS)         
*                                  MKT NOT LOWEST                               
         L     RE,AMKT                                                          
         CLC   XXMKT,0(RE)                                                      
         BE    LMKT10              BYPASS PRINTING FOR DUMMY MARKET             
         MVC   P,SPACES            CLEAR ANY TRASH IN P                         
         CLI   PERCTL,C'T'                                                      
         BNE   LMKT4                                                            
         LA    RF,P+2                                                           
         CLI   FORMAT,5                                                         
         BNL   *+8                                                              
         LA    RF,P                                                             
         L     RE,=A(DICSECT)                                                   
         MVC   0(L'SPAMKT,RF),SPAMKT-DICSECT(RE)                                
         MVC   L'SPAMKT+1(4,RF),MKT                                             
         MVC   L'SPAMKT+6(L'SP6TOTAL,RF),SP6TOTAL-DICSECT(RE)                   
         B     LMKT6                                                            
*                                                                               
LMKT4    DS    0H                                                               
         CLI   FORMAT,5                                                         
         BL    LMKT4B                                                           
         L     RE,=A(DICSECT)                                                   
         MVC   P+07(L'SPAMKT),SPAMKT-DICSECT(RE)                                
         MVC   P+L'SPAMKT+7+1(4),MKT                                            
         MVC   P+L'SPAMKT+7+6(L'SP6TOTAL),SP6TOTAL-DICSECT(RE)                  
         B     LMKT6                                                            
*                                                                               
LMKT4B   DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         MVC   P+01(L'SPBMKT),SPBMKT-DICSECT(RE)                                
         MVC   P+01+L'SPBMKT+1(4),MKT                                           
         MVC   P+01+L'SPBMKT+6(L'SP6TOTAL),SP6TOTAL-DICSECT(RE)                 
*                                                                               
LMKT6    DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         MVC   TOTNAME,SPACES                                                   
         MVC   TOTNAME(L'SPAMKT),SPAMKT-DICSECT(RE)   MARKET                    
         BRAS  RE,TOTOUT                                                        
*                                                                               
         CLI   BFROPT,C'M'         NEW BFR'S AND SHOW AMOUNT DUE                
         BNE   *+8                 AT MARKET LEVEL                              
         BRAS  RE,PRTADJ                                                        
*                                                                               
         CLI   MCOMOPT,C'A'        COMMENT TO PRINT AFTER?                      
         BNE   LMKT10                                                           
         BRAS  RE,COMPROC                                                       
*                                                                               
LMKT10   DS    0H                                                               
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*        LAST FOR NETWORK                                                       
         SPACE 2                                                                
LNETPR   NMOD1 0,LNETPR                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   NETCTL,C'N'                                                      
         BE    LNET10              NO NET ON BILL                               
*                                                                               
         C     R3,ALOWTOG          IS THIS LOWEST BREAK                         
         BE    LNET6               YES                                          
         BH    LNET10              BYPASS IF OTHERS 'LOWER' (ON RECAPS)         
*                                  NET NOT LOWEST                               
         L     RF,ANET                                                          
         MVC   WORK+2(3),0(RF)                                                  
         GOTO1 MSUNPK,DMCB,WORK,FULL,DUB                                        
*                                                                               
         CLI   PERCTL,C'T'                                                      
         BNE   LNET4                                                            
         LA    RF,P+2                                                           
         CLI   FORMAT,5                                                         
         BNL   *+8                                                              
         LA    RF,P                                                             
         L     RE,=A(DICSECT)                                                   
         MVC   0(L'SP@NTWRK,RF),SP@NTWRK-DICSECT(RE)                            
         MVC   L'SP@NTWRK+1(5,RF),DUB                                           
         MVC   L'SP@NTWRK+7(L'SP6TOTAL,RF),SP6TOTAL-DICSECT(RE)                 
         B     LNET6                                                            
*                                                                               
LNET4    DS    0H                                                               
         CLI   FORMAT,5                                                         
         BL    LNET4B                                                           
         L     RE,=A(DICSECT)                                                   
         MVC   P+07(L'SP@NTWRK),SP@NTWRK-DICSECT(RE)                            
         MVC   P+L'SP@NTWRK+7+1(5),DUB                                          
         MVC   P+L'SP@NTWRK+7+7(L'SP6TOTAL),SP6TOTAL-DICSECT(RE)                
         B     LNET6                                                            
*                                                                               
LNET4B   DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         MVC   P+01(L'SP@NTWRK),SP@NTWRK-DICSECT(RE)                            
         MVC   P+01+L'SP@NTWRK+1(5),DUB                                         
         MVC   P+01+L'SP@NTWRK+7(L'SP6TOTAL),SP6TOTAL-DICSECT(RE)               
*                                                                               
LNET6    DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         MVC   TOTNAME,SPACES                                                   
         MVC   TOTNAME(L'SP@NTWRK),SP@NTWRK-DICSECT(RE)                         
         BRAS  RE,TOTOUT                                                        
*                                                                               
LNET10   DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*        FIRST FOR NETWORK                                                      
         SPACE 2                                                                
FNETPR   NMOD1 0,FNETPR                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   NETCTL,C'N'                                                      
         BE    FNETX                                                            
         OC    ALOWTOG,ALOWTOG                                                  
         BZ    *+12                                                             
         C     R3,ALOWTOG          TEST IF TO APPEAR                            
         BH    FNETX               NO                                           
*                                                                               
         L     RF,ANET                                                          
         MVC   WORK+2(3),0(RF)                                                  
         GOTO1 MSUNPK,DMCB,WORK,FULL,DUB                                        
*                                                                               
         C     R3,APAGBRK          TEST NET 'HIGHER' THAN PAGE BREAK            
         BNH   FNETX               YES                                          
*                                  ELSE NET 'TOGETHER'                          
         CLC   P,SPACES                                                         
         BE    *+12                                                             
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT            =CLEAR P                                      
*                                                                               
**NOOP?? MVI   P+50,0      **NOOP??   PREVENT 'MERGE UP' OF STATIONS            
         L     RE,=A(DICSECT)                                                   
         MVC   P(L'SP@NTWRK),SP@NTWRK-DICSECT(RE)                               
         MVC   P+L'SP@NTWRK+1(5),DUB                                            
*                                  NET IN HEADS                                 
FNETX    DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*        CHKSKIP - TEST WHETHER TO SKIP BUFFALO BILLING RECORD                  
*                  (100% BILLED MARKET FEATURE AND WI ADJ BILLING)              
         SPACE 2                                                                
CHKSKIP  NMOD1 0,CHKDISP                                                        
         LA    RC,SPACEND                                                       
         CLI   PAYOPT,C'M'         ONLY IF 100% BILLED MKTS OPT                 
         BE    *+16                                                             
         LA    R4,WIBLOCK          OR PW DETAIL MODE                            
         CLI   SPWQBTYP-SPWID(R4),C'D'                                          
         BNE   CHKSKN                                                           
*                                                                               
         BNE   CHKSKN                                                           
         XC    WORK,WORK                                                        
         LA    R4,WORK                                                          
         USING SKPTABD,R4                                                       
         LA    R0,SORTREC                                                       
*                                                                               
         MVI   SKPPRD,X'FF'        IGNORE PRODUCT                               
         CLI   PRDCTL,C'S'         UNLESS SEPARATE                              
         BNE   CHKSK03                                                          
         L     RF,APRD             POINT TO PRD IN THISREC                      
         SR    RF,R0                                                            
         LA    RF,THISREC(RF)                                                   
         MVC   SKPPRD,0(RF)                                                     
*                                                                               
CHKSK03  DS    0H                                                               
         MVI   SKPEST,X'FF'        IGNORE EST                                   
         CLI   ESTCTL,C'S'         UNLESS SEPARATE                              
         BNE   CHKSK05                                                          
         L     RF,AEST             POINT TO EST IN THISREC                      
         SR    RF,R0                                                            
         LA    RF,THISREC(RF)                                                   
         MVC   SKPEST,0(RF)                                                     
*                                                                               
CHKSK05  DS    0H                                                               
         L     RF,AMKT             POINT TO MKT IN THISREC                      
         SR    RF,R0                                                            
         LA    RF,THISREC(RF)                                                   
         MVC   SKPMKT,0(RF)                                                     
*                                                                               
         L     RF,APER             MOS                                          
         SR    RF,R0                                                            
         LA    RF,THISREC(RF)                                                   
         MVC   SKPMOS,0(RF)                                                     
*                                                                               
         GOTO1 BINSRCH,SKPPARS,WORK                                             
         CLI   0(R1),1             DID WE FIND IT                               
         BNE   CHKSKY              YES, SET TO SKIP                             
*                                                                               
CHKSKN   CR    RE,RE               CC= MEANS DON'T SKIP                         
         B     *+6                                                              
CHKSKY   LTR   RE,RE               CC NOT = MEANS SKIP                          
         XIT1                                                                   
         DROP  R4                                                               
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*        SETCURN - SET CURRENCY NAME (POINTS R1 TO 20 BYTE DESC)                
         SPACE 2                                                                
SETCURN  NMOD1 0,SETCURN                                                        
         LA    RC,SPACEND                                                       
         LA    R1,SPACES                                                        
         CLI   CCIDOPT,C'Y'                                                     
         BNE   SETCURNX                                                         
         LA    R1,=CL20'**U.S. FUNDS**'                                         
         CLI   RQCRRNCY,C'U'                                                    
         BE    SETCURNX                                                         
         LA    R1,=CL20'**CANADIAN FUNDS**'                                     
         CLI   RQCRRNCY,C'C'                                                    
         BE    SETCURNX                                                         
         LA    R1,SPACES                                                        
*                                                                               
SETCURNX DS    0H                                                               
         XIT1  REGS=(R1)                                                        
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*        PCTMULT - MULTIPLY AMOUNTS BY REQUEST PERCENTAGE                       
         SPACE 2                                                                
PCTMULT  NMOD1 0,PCTMULT                                                        
         LA    RC,SPACEND                                                       
         OC    MANPCT,MANPCT       TEST PCT= REQUEST                            
         BZ    PCMX                NO                                           
*                                                                               
         L     RF,ASORTDTA         POINT TO DATA                                
         LA    R0,SORTREC                                                       
         SR    RF,R0                                                            
         LA    RF,THISREC(RF)      POINT TO DATA IN THISREC                     
*                                                                               
         ICM   R5,15,RGRSD(RF)        GROSS                                     
         BZ    *+16                                                             
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,RGRSD(RF)                                                     
         ICM   R5,15,RGRS2D(RF)       CLT CURR                                  
         BZ    *+16                                                             
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,RGRS2D(RF)                                                    
*                                                                               
         CLI   PCTNET,C'N'                                                      
         BE    PCM04                                                            
         ICM   R5,15,RNETD(RF)        NET                                       
         BZ    *+16                                                             
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,RNETD(RF)                                                     
         ICM   R5,15,RNET2D(RF)       CLT CURR                                  
         BZ    *+16                                                             
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,RNET2D(RF)                                                    
*                                                                               
PCM04    DS    0H                                                               
         ICM   R5,15,RTAXD(RF)        TAX                                       
         BZ    *+16                                                             
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,RTAXD(RF)                                                     
         ICM   R5,15,RTAX2D(RF)       CLT CURR                                  
         BZ    *+16                                                             
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,RTAX2D(RF)                                                    
*                                                                               
         CLI   PCTCTL,C'F'         APPLY % TO PREVIOUS BILLING?                 
         BE    PCMX                NO (NOTE- N=NO PREV,P=APPLY %)               
*                                                                               
         ICM   R5,15,RBGRSD(RF)         BILLED GRS                              
         BZ    *+16                                                             
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,RBGRSD(RF)                                                    
         ICM   R5,15,RBGRS2D(RF)        CLT CURR                                
         BZ    *+16                                                             
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,RBGRS2D(RF)                                                   
*                                                                               
         CLI   PCTNET,C'N'            SKIP NET                                  
         BE    PCM06                                                            
         ICM   R5,15,RBNETD(RF)          BILLED NET                             
         BZ    *+16                                                             
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,RBNETD(RF)                                                    
         ICM   R5,15,RBNET2D(RF)         CLT CURR                               
         BZ    *+16                                                             
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,RBNET2D(RF)                                                   
*                                                                               
PCM06    DS    0H                                                               
         ICM   R5,15,RBTAXD(RF)           BILLED TAX                            
         BZ    *+16                                                             
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,RBTAXD(RF)                                                    
         ICM   R5,15,RBTAX2D(RF)          CLT CURR                              
         BZ    *+16                                                             
         M     R4,MANPCT                                                        
         BAS   RE,PCMDIV                                                        
         ST    R5,RBTAX2D(RF)                                                   
*                                                                               
PCMX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
PCMDIV   LHI   R2,10000                                                         
         DIV   (R4),(R2)           NOTE- RETURNS VIA RE                         
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*                             ROLLUP - ADD TO NEXT ACCUM                        
         SPACE 2                                                                
ROLLUP   NMOD1 0,ROLLUP                                                         
         LA    RC,SPACEND                                                       
*                                                                               
*              NOOP THIS WI/PW CODE HERE BUT LEAVE IT FOR                       
*              POSSIBLE LATER USE                                               
*                                                                               
         B     RU04                ***NOOP***                                   
         CLI   WIOPT,C'Y'          FOR WI OPTION                                
         BNE   RU04                -------------                                
*                                                                               
         C     R3,AMKTBRK          IF AT MARKET BREAK                           
         BNE   RU04                                                             
         L     R7,BRKCODE          ROUND CLT GROSS                              
         L     R7,ATOTS(R7)                                                     
         LHI   R4,MAXMOS+1                                                      
*                                                                               
RU03     DS    0H                                                               
         L     R1,RGRS2D(R7)        ORDERED GROSS (PW IN 2ND SLOT)              
         M     R0,=F'1'                                                         
         LHI   R5,100                                                           
         DRNDR (R0),(R5)                                                        
         M     R0,=F'100'                                                       
         ST    R1,RGRS2D(R7)                                                    
*                                                                               
         L     R1,RBGRS2D(R7)        BILLED GROSS                               
         M     R0,=F'1'                                                         
         LHI   R5,100                                                           
         DRNDR (R0),(R5)                                                        
         M     R0,=F'100'                                                       
         ST    R1,RBGRS2D(R7)                                                   
*                                                                               
         AHI   R7,ROWL                                                          
         BCT   R4,RU03                                                          
*                                                                               
RU04     DS    0H                                                               
         L     RF,BRKCODE                                                       
         L     R4,ATOTS(RF)                                                     
         LHI   R5,MAXMOS+1                                                      
RU2      DS    0H                                                               
         OC    0(ROWTL,R4),0(R4)    **NOTE- LEN WAS ROWL                        
         BZ    RU6                                                              
         LHI   R0,ROWL/4                                                        
         LR    RE,R4                                                            
         LHI   R2,TOTSIZE          USED AS INDEX REG                            
         CLI   MIDAS,C'Y'          IF MIDAS, SKIP CRDT STATION                  
         B     RU4                 ***LOOKS LIKE SKIPPING ON PURPOSE!           
         L     R1,ASTA                                                          
         MVC   THREE,0(R1)                                                      
         NI    THREE+2,X'F0'       TURN OFF LAST NIBBLE                         
         CLC   =X'17B340',THREE                                                 
         BE    RU4C                                                             
RU4      DS    0H                                                               
         L     RF,0(R2,R4)                                                      
         A     RF,0(R4)                                                         
         ST    RF,0(R2,R4)                                                      
         LA    R4,4(R4)                                                         
         BCT   R0,RU4                                                           
*                                                                               
RU4C     XC    000(256,RE),000(RE)                                              
         XC    256(256,RE),256(RE)                                              
         XC    512(ROWL-512,RE),512(RE)                                         
         B     *+8                                                              
RU6      DS    0H                                                               
         LA    R4,ROWL(R4)                                                      
         BCT   R5,RU2                                                           
*                                                                               
         L     RF,BRKCODE                                                       
         L     R4,ATOTS(RF)      POINT TO ACCUM                                 
         AHI   R4,TOTSIZE-BFORML   POINT TO FORMULA INFO                        
         LR    R5,R4                                                            
         AHI   R5,TOTSIZE          R5 POINTS TO NEXT ACCUMS FORMULA             
NEXTACC  USING BFORMD,R5                                                        
         USING BFORMD,R4                                                        
*                                  ROLL UP BILL FORMULA                         
         OC    NEXTACC.BFORMD(BFORML),NEXTACC.BFORMD ANY ALREADY THERE?         
         BNZ   *+14                                                             
         MVC   NEXTACC.BFBAS(BFORML),BFBAS    NO, JUST MOVE THIS ONE UP         
         B     RU16                                                             
*                                                                               
         CLC   BFBAS,NEXTACC.BFBAS IS BASE THE SAME?                            
         BE    *+12                                                             
         MVI   NEXTACC.BFBAS,X'FF' NO, SET HAVE UNEQUAL BASES                   
         MVI   BFMIX,C'Y'                                                       
*                                                                               
         CLC   BFCOMP,NEXTACC.BFCOMP       IS COMMISSION THE SAME?              
         BE    *+14                                                             
         MVC   NEXTACC.BFCOMP,=X'FFFFFFFF' NO, SET UNEQUAL COMMSSNS             
         MVI   BFMIX,C'Y'                                                       
*                                                                               
         CLI   BFMIX,C'Y'          ONLY CARE IF BILLFORM IS MIXED               
         BNE   *+18                IF MKTS TOGETHER ON INVOICE                  
         CLC   AMKTBRK,AINVBRK     SINCE MKT IS NOT IN KEY OF BILLHDR           
         BH    *+8                                                              
         MVI   BFMIX,C'N'                                                       
*                                                                               
         CLC   BFRETSHR,NEXTACC.BFRETSHR   RETAIL SHARE =?                      
         BE    *+10                                                             
         MVC   NEXTACC.BFRETSHR,=X'FFFFFF' UNEQUAL RETAIL SHRS                  
*                                                                               
         CLC   BFAORPCT,NEXTACC.BFAORPCT                                        
         BE    *+10                                                             
         MVC   NEXTACC.BFAORPCT,=X'FFFFFF' UNEQUAL AOR PCTS                     
*                                                                               
         LA    RE,BFVATCOD         DO VAT CODES INDIVIDUALLY                    
         LA    RF,NEXTACC.BFVATCOD                                              
         LHI   R0,NPROVS+1                                                      
         B     RU8A             ?? FOR GST SKIP ALREADY THERE CHECK             
RU8      DS    0H                                                               
         CLI   0(RF),C' '          IF NOTHING ALREADY THERE                     
         BH    *+14                                                             
         MVC   0(1,RF),0(RE)       USE CURRENT VALUE                            
         B     RU8A2                                                            
RU8A     DS    0H                                                               
         CLC   0(1,RE),0(RF)                                                    
         BE    *+8                                                              
         MVI   0(RF),X'FF'         UNEQUAL                                      
RU8A2    DS    0H                                                               
         LA    RE,1(RE)                                                         
         LA    RF,1(RF)                                                         
         BCT   R0,RU8                                                           
*                                                                               
         LA    RE,BFVATSW          DO VAT SWS INDIVIDUALLY                      
         LA    RF,NEXTACC.BFVATSW                                               
         LHI   R0,NPROVS+1                                                      
RU8B     DS    0H                                                               
         CLC   0(1,RE),0(RF)                                                    
         BE    *+8                                                              
         MVI   0(RF),X'FF'         UNEQUAL                                      
         LA    RE,1(RE)                                                         
         LA    RF,1(RF)                                                         
         BCT   R0,RU8B                                                          
         DROP  NEXTACC                                                          
*                                                                               
RU16     DS    0H                                                               
         XC    BFBAS(BFORML),BFBAS      CLEAR OLD ONE                           
*                                                                               
         XIT1                                                                   
         DROP  R4                                                               
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        CKZBHLD - CHK IF ZERO LINE IS BECAUSE OF BHOLD                         
***********************************************************************         
CKZBHLD  NMOD1 0,**ZBHLD                                                        
         LA    RC,SPACEND                                                       
         XC    WORK,WORK           YES, CHECK HERE FOR ZERO LINE                
KEY@     USING BHOLDTD,WORK                                                     
         L     RE,ADCLT                                                         
         MVC   KEY@.BHLDAM,CKEYAM-CLTHDR(RE)                                    
         MVC   KEY@.BHLDCLT,CKEYCLT-CLTHDR(RE)                                  
         L     R1,APRD             PRODUCT CODE (ALPHA SEQ)                     
         ZIC   RF,0(R1)                                                         
         MHI   RF,4                CLIST ENTRY SIZE IS 4                        
         LA    RE,CLIST-CLTHDR(RE,RF)                                           
         MVC   KEY@.BHLDPRD,3(RE)                                               
         L     RF,AEST                                                          
         MVC   KEY@.BHLDEST,0(RF)                                               
         L     RF,AMKT                                                          
         MVC   KEY@.BHLDMKT,0(RF)                                               
         L     RF,ASTA                                                          
         MVC   KEY@.BHLDSTA,0(RF)                                               
         L     RE,APER                                                          
         ZIC   RF,0(RE)                                                         
         LA    RF,PERLIST(RF)                                                   
         MVC   KEY@.BHLDMOS,PERLMOS-PERLISTD(RF)                                
         DROP  KEY@                                                             
         GOTO1 BINSRCH,BHLPARS,WORK                                             
         CLI   0(R1),1             IF FOUND - SKIP THIS ZERO LINE               
         XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*        PWROUND - ROUND UP CLIENT GROSS FOR WESTERN PW                         
***********************************************************************         
         SPACE 2                                                                
PWROUND  NMOD1 0,**PWRND                                                        
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   WIOPT,C'Y'          FOR WI OPTION                                
         BNE   PWRX                                                             
*                                                                               
         L     R7,BRKCODE          ROUND CLT GROSS                              
         L     R7,ATOTS(R7)                                                     
         LHI   R4,MAXMOS+1                                                      
*                                                                               
PWR03    DS    0H                                                               
         L     R1,RGRS2D(R7)        ORDERED GROSS (PW IN 2ND SLOT)              
         M     R0,=F'1'                                                         
         LHI   R5,100                                                           
         DRNDR (R0),(R5)                                                        
         M     R0,=F'100'                                                       
         ST    R1,RGRS2D(R7)                                                    
*                                                                               
         L     R1,RBGRS2D(R7)        BILLED GROSS                               
         M     R0,=F'1'                                                         
         LHI   R5,100                                                           
         DRNDR (R0),(R5)                                                        
         M     R0,=F'100'                                                       
         ST    R1,RBGRS2D(R7)                                                   
*                                                                               
         AHI   R7,ROWL                                                          
         BCT   R4,PWR03                                                         
*                                                                               
PWRX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*                             GETAOR - GET AOR INFO                             
         SPACE 2                                                                
GETAOR   NMOD1 0,GETAOR                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         XC    SVAORS(SVAORSLQ),SVAORS                                          
                                                                                
         L     R0,=A(AORADDR)                                                   
         LHI   R1,ADDRLEN                                                       
         SR    RE,RE                                                            
         LA    RF,X'40'                 FILL WITH SPACES                        
         SLL   RF,24                                                            
         MVCL  (R0),(RE)                                                        
*                                                                               
         CLI   AORSW,C'Y'          DO WE NEED AOR?                              
         BNE   GETAORX                                                          
*                                                                               
         LA    R6,KEY                                                           
         USING AORKEY,R6                                                        
         XC    KEY,KEY                                                          
         MVC   KEY(2),=X'0D45'     AOR RECORD CODE                              
         L     RF,ADCLT                                                         
         MVC   AORKAGMD(3),1(RF)       AGY/MED/CLT                              
*                                                                               
         L     RF,APRD                                                          
         ZIC   R4,0(RF)            GET PROD CODE FROM PROD SEQ                  
         MHI   R4,4                                                             
         L     RF,ADCLT                                                         
         LA    R4,CLIST-CLTHDR(RF,R4)                                           
         MVC   AORKPRD,0(R4)       3 CHAR PRD CODE                              
         L     RF,AEST                                                          
         MVC   AORKEST+1(1),0(RF)       ESTIMATE NUMBER                         
*                                                                               
         MVI   AORKDPT,X'FF'       DEFAULT DAYPART       (NOT USED IN           
         MVI   AORKSTYP,X'FF'      DEFAULT STATION TYPE   SPOT, ONLY            
         MVI   AORKEXT+2,X'FF'     3RD EXTRA NOT USED     IN NET)               
         DROP  R6                                                               
*                                                                               
         GOTO1 HIGH                                                             
         CLC   KEY(8),KEYSAVE      TEST THRU PRD                                
         BNE   GAKS21              NOTHING FOR PRODUCT                          
         CLC   KEY(10),KEYSAVE     TEST THRU EST                                
         BE    GAKS08                                                           
         CLC   KEY+8(2),=X'FFFF'   DID WE FIND DEFAULT                          
         BE    GAKS08              YES, USE IT                                  
*                                                                               
GAKS07   DS    0H                                                               
         MVC   KEYSAVE+8(2),=X'FFFF'  TRY DEFAULT EST                           
         MVC   KEY,KEYSAVE                                                      
         GOTO1 HIGH                                                             
         CLC   KEY(10),KEYSAVE                                                  
         BNE   GAKS21              NOTHING THERE EITHER                         
*                                                                               
GAKS08   DS    0H                                                               
         CLC   KEY+10(1),KEYSAVE+10   DAYPART                                   
         BE    GAKS10                                                           
         CLI   KEY+10,X'FF'           DID WE FIND DEFAULT                       
         BE    GAKS10                                                           
         CLI   KEYSAVE+10,X'FF'       DID WE TRY FOR IT                         
         BE    GAKS19                 YES, TRY UNDER DEFAULT EST                
*                                                                               
GAKS09   DS    0H                                                               
         MVI   KEYSAVE+10,X'FF'       TRY DEFAULT DAYPART                       
         MVC   KEY,KEYSAVE                                                      
         GOTO1 HIGH                                                             
         CLC   KEY(11),KEYSAVE                                                  
         BNE   GAKS19                NOTHING, DONE                              
*                                                                               
GAKS10   DS    0H                                                               
         CLC   KEY+11(1),KEYSAVE+11    STATION TYPE                             
         BE    GAKS20                                                           
         CLI   KEY+11,X'FF'            DID WE FIND DEFAULLT                     
         BE    GAKS20                                                           
         CLI   KEYSAVE+11,X'FF'        DID WE TRY FOR IT                        
         BE    GAKS18                                                           
         MVI   KEYSAVE+11,X'FF'        TRY DEFAULT                              
         MVC   KEY,KEYSAVE                                                      
         GOTO1 HIGH                                                             
         CLC   KEY(12),KEYSAVE                                                  
         BE    GAKS20                                                           
*                                                                               
GAKS18   DS    0H                  NOTHING FOUND                                
         CLI   KEYSAVE+10,X'FF'    WERE WE LOOKING UNDER ALL DPTS               
         BE    GAKS19              YES                                          
*                                  NO, DO IT NOW                                
         MVI   KEYSAVE+11,X'FF'    RESET STATION TYPE                           
         B     GAKS09                                                           
*                                                                               
GAKS19   DS    0H                                                               
         CLC   KEYSAVE+8(2),=X'FFFF'   WERE WE LOOKING UNDER ALL ESTS           
         BE    GAKS21              YES, NOTHING MORE TO DO                      
*                                  NO, DO IT NOW                                
         MVI   KEYSAVE+10,X'FF'     RESET DAYPART                               
         MVI   KEYSAVE+11,X'FF'    RESET STATION TYPE                           
         B     GAKS07                                                           
*                                                                               
GAKS20   DS    0H                  HAVE USABLE AOR KEY                          
         B     GAO4                                                             
*                                                                               
GAKS21   DS    0H                  NO USABLE AOR KEY                            
         B     GETAORX                                                          
*                                                                               
GAO4     DS    0H                                                               
         MVC   SVAORDA,KEY+14      SAVE DISK ADDRESS                            
         L     R7,=A(STABUCKC)     USE STATION BUCKET AREA                      
         ST    R7,AREC                                                          
         USING AORREC,R7                                                        
*                                                                               
         GOTO1 GET                                                              
*                                                                               
         CLI   CVATCOD,0           IF VAT ACTIVE NEED TO SET CLT/PRD            
         BE    GA05                VAT CODES, BECAUSE MAY NOT HAVE BEEN         
         L     RF,APRD             DONE YET AT FPRD OR FEST                     
         ZIC   R4,0(RF)            GET PROD CODE FROM PROD SEQ                  
         MHI   R4,4                                                             
         L     RF,ADCLT                                                         
         LA    R4,CLIST-CLTHDR(RF,R4)                                           
         ZIC   R2,3(R4)            1 CHAR PRD CODE                              
         GOTOR SETCPVC,DMCB,((R2),0)                                            
*                                                                               
GA05     DS    0H                                                               
         LA    R2,AORELS                                                        
*                                                                               
GAO6     DS    0H                                                               
         CLI   0(R2),X'02'         ADDRESS ELEM                                 
         BE    GAO7                                                             
         CLI   0(R2),X'03'         AOR INFO ELEM                                
         BE    GAO8                                                             
         CLI   0(R2),0             EOR                                          
         BE    GETAORX                                                          
*                                                                               
GAO6D    DS    0H                                                               
         ZIC   R0,1(R2)                                                         
         AR    R2,R0                                                            
         B     GAO6                                                             
         DROP  R7                                                               
*                                                                               
GAO7     DS    0H                  AOR ADDRESS ELEM                             
         USING AORADREL,R2                                                      
         L     RF,=A(AORADDR)                                                   
         MVC   000(30,RF),AORLIN1                                               
         MVC   060(30,RF),AORLIN2                                               
         MVC   120(30,RF),AORLIN3                                               
         MVC   180(30,RF),AORLIN4                                               
         B     GAO6D                                                            
         DROP  R2                                                               
*                                                                               
GAO8     DS    0H                  AOR INFO ELEM                                
         USING AORELEM,R2                                                       
*                                                                               
         CLI   PROFB2A+4,C'Y'      IS 0% AOR OK?                                
         BE    *+14                                                             
         OC    AORPCT,AORPCT       NO, IS THERE ANY %                           
         BZ    GETAORX             NO, REJECT                                   
*                                                                               
         MVC   SVAORPCT,AORPCT     PCT                                          
         MVC   SVAORBAS,AORBAS     BASIS                                        
*                                                                               
         MVC   SVAORACT,AORRCVBL   RCVBL/PAYABLE ACCT                           
         CLI   AORRCVBL,C' '       IF NO ACCOUNT PRESENT                        
         BH    *+14                                                             
         L     RF,=A(AORADDR)                                                   
         MVC   SVAORACT,0(RF)      USE FIRST 14 OF AGENCY NAME                  
*                                                                               
         MVC   SVAOREFF,AOREFF     EFFECTIVE DATE                               
         MVC   SVAORKIL,AORKILL    KILL DATE                                    
         OC    SVAORKIL,SVAORKIL   IF NOT PRESENT                               
         BNZ   *+10                                                             
         MVC   SVAORKIL,=X'FFFF'   SET TO HIGH VALUES                           
         MVC   SVAORVCS,SPACES                                                  
         MVI   SVAORMVP,0               CLEAR MAIN PST PROV.                    
         MVI   SVAORMVC,0               CLEAR MAIN PST CODE                     
         MVC   SVAORVCD,CVATCOD    GST DEFAULTS TO CLIENT/PRD                   
         CLI   AORGSTCD,C' '                                                    
         BNH   *+10                                                             
         MVC   SVAORVCD,AORGSTCD                                                
         OC    AORPST,SPACES                                                    
         CLC   AORPST,SPACES                                                    
         BNH   *+10                                                             
         MVC   SVAORVCS+1(L'SVAORVCS-1),AORPST                                  
*                                                                               
         MVC   SVAORMVP,AORMPST          MAIN PST PROVINCE #                    
         MVC   SVAORMVC,AORMPST+1        AND CODE                               
*                                                                               
         B     GAO6D                                                            
         DROP  R2                                                               
*                                                                               
GETAORX  DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*                             GETVAT - GET VAT PERCENTAGE                       
         SPACE 2                                                                
GETVAT   NMOD1 0,GETVAT                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         L     R2,0(R1)            A(VAT CODE)                                  
         L     R3,4(R1)            A(MOS) - (MOS=0 MEANS IGNORE)                
         XC    8(4,R1),8(R1)       PERCENT WILL BE RETURNED AT 8(R1)            
         LA    RF,VATTAB                                                        
         LHI   RE,VATTABN                                                       
*                                                                               
GVAT4    DS    0H                                                               
         CLC   0(1,R2),0(RF)                                                    
         BNE   GVAT6                                                            
         LTR   R3,R3               ANY MOS                                      
         BZ    GVAT5                                                            
         CLC   0(2,R3),1(RF)       MOS VS START                                 
         BL    GVAT6                                                            
         CLC   0(2,R3),3(RF)       MOS VS END                                   
         BH    GVAT6                                                            
*                                                                               
GVAT5    DS    0H                                                               
         MVC   8(4,R1),5(RF)       SET VAT PERCENT                              
         B     GVATX                                                            
*                                                                               
GVAT6    DS    0H                                                               
         LA    RF,9(RF)            NEXT TABLE ENTRY                             
         BCT   RE,GVAT4                                                         
*                                                                               
GVATX    DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
* WATCH OUT: Y2K!                                                               
*                                                                               
VATTAB   DS    0C                                                               
         DC    C'S',X'5B01',X'FFFF',AL4(7000) EVERYTHING ELSE =0%               
         DC    C'S',X'0000',X'FFFF',AL4(7000) EVERYTHING ELSE =0%               
VATTABN  EQU   (*-VATTAB)/9                                                     
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*                                  NEED THIS FOR ADDRESSABILITY                 
AORINV1  NMOD1 0,AOR1                                                           
         BRAS  RE,AORINV                                                        
         XIT1                                                                   
*                                  ENDINV - END OF INVOICE                      
         SPACE 2                                                                
ENDINV   NMOD1 0,ENDINV                                                         
         LA    RC,SPACEND                                                       
*                                                                               
*              FOR RETAIL EFFECTIVE DATES, SKIP INVOICE IF                      
*              NO 'ACTIVE' MONTHS                                               
*                                                                               
         CLI   RETPROF,0           MUST GE RETAIL                               
         BE    EI3                                                              
         CLI   PERCTL,C'T'         AND PERIODS TOGETHER (EFFECTIVE              
         BNE   EI3                 DATES ONLY CODED FOR TOGETHER??)             
         TM    TOTACT,X'40'        AND VISITED TOTOUT                           
         BZ    EI3                                                              
         TM    TOTACT,X'20'        BUT NEVER FOUND AN ACTIVE LINE               
         BNZ   EI3                                                              
         B     EI10                SKIP BILL                                    
*                                                                               
EI3      DS    0H                                                               
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)        POINT TO ACCUM                               
         AHI   R7,MAXMOS*ROWL      POINT TO TOTAL ROW                           
         OC    ADJDSP(8,R7),ADJDSP(R7)  TEST FORMULA CALCS DONE                 
         BNZ   EI4                                                              
         OC    DUEDSP(8,R7),DUEDSP(R7)                                          
         BNZ   EI4                 YES                                          
         BRAS  RE,BILCALC          NO - DO THEM NOW                             
*                                                                               
EI4      DS    0H                                                               
         CLI   PASSNO,1            IF DOING RECAP NOW                           
         BNE   EI8                 SKIP TO ADJINV AND AORINV CALLS              
*                                                                               
         LA    RE,P                CLEAR OUT PRINT LINES                        
         LHI   R0,14                                                            
*                                                                               
         MVC   0(132,RE),SPACES                                                 
         LA    RE,132(RE)                                                       
         BCT   R0,*-10                                                          
*                                                                               
         CLI   DUESW,C'Y'          TEST AMT DUE PRINTED                         
         BE    EI6                                                              
         CLI   TOTSW,C'Y'          TEST HAVE PRINTED INV TOTS                   
         BE    EI5                                                              
         CLI   NDUES,1             BYPASS REPEAT OF TOTALS IF                   
         BE    EI5                 EXACTLY 1 DUE LEVEL PRINTED                  
         MVI   PRSW,C'H'           SET TO HOLD LINES                            
         L     R1,=A(DICSECT)                                                   
         MVC   P(L'SPETOTAL),SPETOTAL-DICSECT(R1)  ** TOTALS **                 
         BRAS  RE,TOTOUT                                                        
EI5      DS    0H                                                               
*                                  TEST NEED TO SAVE CORP DATA NOW              
         CLI   SUMLEV,C'I'                                                      
         BE    *+16                                                             
         CLI   SUMLEV,0                                                         
         BH    *+12                ALREADY SAVED AT LOWER LEVEL                 
         MVI   SUMLEV,C'I'         CORP DATA SAVED AT INVOICE LEVEL             
         BRAS  RE,SAVCORP                                                       
         BRAS  RE,PRTADJ           NO - DO IT NOW                               
*                                                                               
EI6      DS    0H                                                               
*        MVI   FORCECMT,C'I'       SET IMMEDIATE COMMENT PRINT                  
         XC    BCMTYPE(14),BCMTYPE                                              
         MVI   BCMTYPE,C'B'        BCOMS                                        
         CLI   PROFB1X+13,C'Y'     OPTION TO USE BILLING TYPE                   
         BNE   *+10                FOR COMMENT TYPE                             
         MVC   BCMTYPE,TYPE                                                     
*                                                                               
         MVC   BCMCLT,BCLT                                                      
         CLI   PGR3CTL,C'S'        TEST PGR'S SEPARATE                          
         BNE   *+10                                                             
         MVC   BCMPGR,BPGR                                                      
         CLI   PRDCTL,C'S'         TEST PRD'S SEPARATE                          
         BNE   EI6D                                                             
         L     RF,APRD                                                          
         ZIC   R4,0(RF)            GET PROD CODE FROM PROD SEQ                  
         MHI   R4,4                                                             
         L     RF,ADCLT                                                         
         LA    R4,CLIST-CLTHDR(RF,R4)                                           
         MVC   BCMPRD,3(R4)                                                     
*                                                                               
EI6D     DS    0H                                                               
         CLI   ESTCTL,C'S'         NO EST IF ESTS NOT SEPARATE                  
         BNE   EI6F                                                             
         CLI   ECOMOPT,C'B'        OR IF PRINTING ESTCOMS 'BEFORE'              
         BE    EI6F                ('AFTERS' WONT PRINT IF ESTS SEP)            
         L     RF,AEST                                                          
         MVC   BCMEST,0(RF)                                                     
*                                                                               
EI6F     DS    0H                                                               
         CLI   MKTCTL,C'S'         NO MKT IF MKTS NOT SEPARATE                  
         BNE   EI6H08                                                           
         CLI   MCOMOPT,C'B'        OR IF PRINTING MKTCOMS 'BEFORE'              
         BE    EI6H08              ('AFTERS' WONT PRING IF MKTS SEP)            
         L     RF,AMKT                                                          
         MVC   BCMSTA+1(2),0(RF)   MARKET                                       
*                                                                               
EI6H     DS    0H                                                               
         GOTO1 GETCOM                                                           
         L     RF,ADCOMREC                                                      
         OC    0(2,RF),0(RF)       DID WE FIND ANY MKT COMM                     
         BNZ   EI6H09              YES, OK                                      
         OC    BCMSTA+1(2),BCMSTA+1   NO, TRY WITHOUT MKT                       
         BZ    EI6H09                                                           
         XC    BCMSTA+1(2),BCMSTA+1                                             
         B     EI6H                                                             
*                                                                               
EI6H08   DS    0H                                                               
         GOTO1 GETCOM                                                           
         CLC   P,SPACES            IF ANYTHING NEEDS PRINTING                   
         BNE   *+8                                                              
         BRAS  RE,PRNT             PRINT LEFTOVER                               
*                                                                               
EI6H09   DS    0H                                                               
         ST    R3,SAVBRK           USED BY BILLEDI                              
         GOTO1 ABILLEDI,DMCB,('EDMCOM',0)   EDI CALL - COMMENT                  
*        CLC   P,SPACES            IF ANYTHING NEEDS PRINTING                   
*        BNE   *+18                                                             
         L     R6,ADCOMREC         CHK IF HAVE COMMENT                          
         OC    0(2,R6),0(R6)                                                    
         BZ    EI6H90                                                           
         LA    R6,24(R6)           POINT TO ELEMENT                             
         LA    R4,P                                                             
EI6H15   CLI   0(R6),5             FIND A COMMENT LINE                          
         BNE   EI6H40                                                           
*        CLI   DUESW,C'A'          IS THIS ADJSEP INVOICE?                      
*        BNE   *+18                NO, CHECK IF EXCLUDING FROM MAIN             
*        CLC   =C'/C/',2(R6)       CHECK IF SHOULD PRT ON ADJUSTMENT            
*        BE    COMPR14             IF NO, GET NXT ELEM                          
*        B     *+14                GO GET RID OF OVERHEAD                       
*                                                                               
         CLC   =C'/M/',2(R6)       CHECK IF SHOULD PRT ON MAIN BILL             
         BE    EI6H40              IF NO, GET NXT ELEM                          
*                                                                               
         ZIC   RE,1(R6)            GET ELEM LEN                                 
         SHI   RE,3                SET FOR EX                                   
         BM    EI6H40                                                           
         LA    RF,2(R6)            POINT TO ELEM DATA                           
         CLI   0(RF),C'/'          GET RID OF /C/ OR /M/                        
         BNE   EI6H25                                                           
         CLI   2(RF),C'/'                                                       
         BNE   EI6H25                                                           
         LA    RF,3(RF)            SKIP /C/ OR /M/                              
         SHI   RE,3                ADJUST LENGTH                                
         BM    EI6H40                                                           
*                                                                               
EI6H25   EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),0(RF)                                                    
         LA    R4,132(R4)                                                       
         LA    R0,P14                                                           
         CR    R4,R0               TEST USED MORE THAN 14 LINES                 
         BH    EI6H60              IF SO, STOP NOW                              
EI6H40   ZIC   R0,1(R6)                                                         
         AR    R6,R0                                                            
         CLI   0(R6),0                                                          
         BNE   EI6H15                                                           
*                                                                               
EI6H60   DS    0H                                                               
         CLC   P,SPACES                                                         
         BE    *+12                                                             
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
*                                                                               
EI6H90   MVI   PUMODE,C'E'         USER FIELDS - END OF BILL                    
         BRAS  RE,PRTUSER                                                       
*                                                                               
         BRAS  RE,BILLBOX                                                       
*                                                                               
         CLI   QTRADE,C'T'         TRADE?                                       
         BNE   *+14                                                             
         MVC   P1(8),=C'** PE **'                                               
         BRAS  RE,PRNT                                                          
*                                                                               
         CLI   WPPOPT,C'Y'                                                      
         BNE   *+8                                                              
         BRAS  RE,PRTWCOM                                                       
*                                                                               
         BRAS  RE,WOBILL           ADD OLD STYLE BILL RECS                      
         GOTO1 ABILLEDI,DMCB,('EDMEND',0)   EDI CALL                            
         CLI   OUTMODE,C'W'        FOR WORKER FILE MODE                         
         BNE   EI7                                                              
         GOTO1 ABILLEDI,DMCB,('EDMCLS',0)   CLOSE EDI FOR EACH INVOICE          
*                                                                               
EI7      DS    0H                                                               
         MVC   SPINVNO,PINVNO      SAVE INVOICE NUMBER                          
         OC    ARECAP,ARECAP       IF WILL DO RECAP PASS                        
         BNZ   EI11                SKIP AOR, INVNO BUMP, ETC                    
*                                                                               
EI8      DS    0H                                                               
         CLI   PASSNO,1                                                         
         BE    *+16                                                             
         CLI   WPPOPT,C'Y'                                                      
         BNE   *+8                                                              
         BRAS  RE,PRTWCOM                                                       
*                                                                               
         CLI   QTRADE,C'T'         FOR MTRADE ADJSEP BEFORE AOR                 
         BNE   *+16                                                             
         CLI   ADJSEP,C'Y'                                                      
         BNE   *+8                                                              
         BRAS  RE,ADJINV                                                        
*                                                                               
         CLI   AORSW,C'Y'          AOR INVOICE                                  
         BNE   EI9                                                              
         CLI   UPASS,1             IF RETAIL AND NOT 'CORPORATE' BILL           
         BH    EI9                 SKIP AOR INVOICE                             
         MVI   AORLCTL,0                                                        
         BRAS  RE,AORINV                                                        
*                                                                               
EI9      DS    0H                                                               
         CLI   QTRADE,C'T'                                                      
         BE    *+16                                                             
         CLI   ADJSEP,C'Y'                                                      
         BNE   *+8                                                              
         BRAS  RE,ADJINV                                                        
*                                                                               
         GOTO1 AGETNUM,DMCB,INVNO,PINVNO                                        
*                                                                               
EI10     DS    0H                                                               
         CLI   AORLOPT,C'C'        UNLESS CLIENT LEVEL AOR                      
         BE    *+10                                                             
         XC    PEPTABN,PEPTABN     CLEAR PEPTAB NOW                             
EI11     DS    0H                                                               
         MVI   MSGSW,C'N'                                                       
         MVI   DUESW,C'N'                                                       
         MVI   TOTSW,C'N'                                                       
         MVI   BFMIX,C'N'          CLEAR MIXED BILFORM OPTION                   
         MVI   TOTACT,0                                                         
         MVI   SUMLEV,0                                                         
         MVI   ACTSW,C'Y'          SET ACTIVITY FOR REQ                         
         MVC   PAGE,=H'1'                                                       
         MVI   NDUES,0                                                          
         MVI   FORCEHED,C'Y'                                                    
         MVC   MKTCTL,SVMKTCTL                                                  
         XC    CVATPSWS,CVATPSWS   CLEAR PRODUCT VAT MIX SWITCHES               
         XC    NVATPSWS,NVATPSWS   CLEAR PRODUCT VAT MIX SWITCHES               
         XC    BFRTABN,BFRTABN     CLEAR BILFORM TABLE                          
         MVI   LASTPRD,X'FF'                                                    
*                                                                               
         L     RF,=A(RSTATTB)      CLEAR RET STATUS TABLE                       
         LHI   R0,RSTATTBN                                                      
         XC    0(RSTATTBL,RF),0(RF)                                             
         LA    RF,RSTATTBL(RF)                                                  
         BCT   R0,*-10                                                          
*                                                                               
         XIT1                                                                   
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
**********************************************************************          
*                                                                               
*        PBLCHEK - SKIP TEST FOR RETAIL PARTIAL BILLING                         
*                  NOTE- A LITTLE BIT HARD-CODED FOR BACKER/ZENITH              
*                  ASSUMES MGR SEP (AND 4 LONG), MARKET TOG (AND NOT            
*                  PART OF RETAIL), AND EST TOG.                                
*                                                                               
**********************************************************************          
         SPACE 2                                                                
PBLCHEK  NMOD1 0,PBLCHEK                                                        
         LA    RC,SPACEND                                                       
*                                                                               
         MVI   SKIPSPEC,C'Y'       NO HEADLINES                                 
         XC    LASTMGR4,LASTMGR4     CLEAR LAST MGR                             
         XC    THISREC,THISREC                                                  
         GOTO1 BUFFALO,DMCB,=C'HIGH',ABUFFC,THISREC,0                           
         B     PBLC4B                                                           
PBLC4    DS    0H                                                               
         GOTO1 BUFFALO,DMCB,=C'SEQ',ABUFFC,THISREC,0                            
PBLC4B   DS    0H                                                               
         TM    DMCB+8,X'80'        EOF                                          
         BNZ   PBLCX                                                            
*                                                                               
         L     R4,AGDAREA          GDSECT AREA (RETAIL CONTROL)                 
         USING GDSECT,R4                                                        
         MVC   SORTREC,THISREC                                                  
*                                                                               
         L     RF,ASORTDTA                                                      
         OC    0(ROW$L,RF),0(RF)          SKIP LINES WITH ORDERED               
         BNZ   *+14                                                             
         OC    ROWHL(ROW$L,RF),ROWHL(RF)  AND BILLED $ ZERO                     
         BZ    PBLC4                                                            
*                                                                               
         L     R5,AMGR1                                                         
         MVC   GDMGR(4),0(R5)      ASSUME MGR(4)                                
         XC    GDMKT,GDMKT         AND MO MARKET                                
*                                                                               
         CLC   LASTMGR4,0(R5)       NEW MGR?                                    
         MVC   LASTMGR4,0(R5)                                                   
         BNE   *+18                YES                                          
         OC    GDNOUTS,GDNOUTS     NO, ANY OUTLETS                              
         BNZ   PBLC10              YES, OK                                      
         B     PBLC80              NO, REJECT                                   
*                                                                               
*                                  YES, CHECK OUTLETS                           
         MVI   GDOUTNO,0                                                        
         MVC   GDSCHM,SPACES                                                    
*                                                                               
         GOTO1 =V(FINDOUT),DMCB,GDSECT                                          
*                                                                               
         OC    GDNOUTS,GDNOUTS                                                  
         BNZ   PBLC10                                                           
*                                                                               
         MVI   PRSW,C'N'                                                        
         MVC   P(05),=C'** NO'                                                  
         MVC   P+6(15),GDOUTDSC                                                 
         MVC   P+22(3),=C'FOR'                                                  
         MVC   P+26(15),GDMGRDSC                                                
         CLI   GDMKTLEN,0                                                       
         BE    *+10                                                             
         MVC   P+26(15),GDMKTDSC                                                
         MVC   P+42(4),GDMGR                                                    
         MVC   P+47(4),GDMKT                                                    
*                                                                               
         MVC   P+55(22),=C'(PRD/EST = XXX/NNN) **'                              
         L     RF,AEST                                                          
         ZIC   R0,0(RF)                                                         
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  P+55+15(3),DUB                                                   
*                                                                               
         L     RF,ADCLT                                                         
         L     RE,APRD                                                          
         ZIC   R2,0(RE)                                                         
         MHI   R2,4                                                             
         LA    R2,CLIST-CLTHDR(RF,R2)     GET ALPHA PRD                         
         MVC   P+55+11(3),0(R2)                                                 
         BRAS  RE,PRNT                                                          
*                                                                               
         B     PBLC80                                                           
*                                                                               
PBLC10   DS    0H                                                               
         XC    WORK,WORK           PRD/EST/SCHEME TABLE                         
         L     RF,APRD                                                          
         MVC   WORK(1),0(RF)                                                    
         L     RF,AEST                                                          
         MVC   WORK+1(1),0(RF)                                                  
         GOTO1 BINSRCH,PESPARS,(1,WORK)                                         
         SR    R5,R5                                                            
         ICM   R5,7,1(R1)                                                       
         BNZ   *+6                                                              
         DC    H'0'                PRD/EST TABLE FULL                           
*                                                                               
         CLI   0(R1),1             TEST NEW                                     
         BNE   PBLC20                                                           
*                                                                               
*                                  IS NEW, GET SCHEME FROM EST                  
         L     RF,ADCLT            BUILD EST KEY                                
         MVC   KEY,0(RF)                                                        
         L     RE,APRD                                                          
         ZIC   R3,0(RE)                                                         
         MHI   R3,4                                                             
         LA    R3,CLIST-CLTHDR(RF,R3)     GET ALPHA PRD                         
         MVC   KEY+4(3),0(R3)                                                   
         L     RF,AEST                                                          
         MVC   KEY+7(1),0(RF)                                                   
         L     R3,ADEST                                                         
         CLC   KEY(13),0(R3)       TEST ALREADY HAVE ESTHDR                     
         BE    PBLC18                                                           
         GOTO1 READ                                                             
         GOTO1 GETEST                                                           
*                                                                               
PBLC18   DS    0H                                                               
         L     RF,ADEST                                                         
         MVC   2(2,R5),ERTLSCHM-ESTHDR(RF)   SET SCHEME IN TABLE                
*                                                                               
PBLC20   DS    0H                                                               
         XC    GDSHRP,GDSHRP                                                    
         MVI   GDOUTNO,0                                                        
         MVC   GDSCHM,2(R5)                                                     
*                                                                               
         CLI   GDSCHM,C'*'         MEANS NO SCHEME?                             
         BE    PBLC30                                                           
         CLC   GDSCHM,SPACES       NO SCHEME                                    
         BNH   PBLC30                                                           
*                                                                               
         LA    R7,PERLIST          LOOP THRU PERLIST, CALLING FINDOUT           
         SR    R6,R6               FOR EACH PERIOD                              
*                                                                               
PBLC28   DS    0H                                                               
         CLI   0(R7),X'FF'         EOL (IF GOT THIS FAR W/O ERROR               
         BE    PBLC90              THINGS MUST BE OK)                           
*                                                                               
         STC   R6,GDPER                                                         
         MVI   GDTEST,C'Y'                                                      
         GOTO1 =V(FINDOUT),DMCB,GDSECT  NOTE- NO FINDOUT IO HERE, JUST          
         MVI   GDTEST,C'N'                 LOOKING AT SCHEM TABLE               
         CLC   GDSHRP,=F'10000'    MUST BE 100%                                 
         BNE   PBLC30                                                           
*                                                                               
         CLI   GDEFFSW,C'Y'        UNLESS HAVE OUTLET EFFECTIVE DATES           
         BNE   PBLC90              NO NEED TO TEST OTHER DATES                  
         LA    R7,PERLISTL(R7)     NEXT PERLIST ENTRY                           
         LA    R6,1(R6)                                                         
         B     PBLC28                                                           
*                                                                               
PBLC30   DS    0H                                                               
         CLC   0(4,R5),LASTPES     IF SAME AS LAST P/E/SCHEME                   
         BE    PBLC80              DON'T REPEAT                                 
         MVC   LASTPES,0(R5)                                                    
*                                                                               
         MVC   P(28),=C'** SCHEME XX NOT CORRECT FOR'                           
         MVC   P+10(2),GDSCHM                                                   
         MVC   P+29(15),GDMGRDSC                                                
         CLI   GDMKTLEN,0                                                       
         BE    *+10                                                             
         MVC   P+29(15),GDMKTDSC                                                
         MVC   P+45(4),GDMGR                                                    
         MVC   P+50(4),GDMKT                                                    
         MVC   P+55(22),=C'(PRD/EST = XXX/NNN) **'                              
         ZIC   RF,1(R5)            ESTIMATE NUMBER                              
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  P+55+15(3),DUB                                                   
*                                                                               
         L     RF,ADCLT                                                         
         L     RE,APRD                                                          
         ZIC   R3,0(RE)                                                         
         MHI   R3,4                                                             
         LA    R3,CLIST-CLTHDR(RF,R3)     GET ALPHA PRD                         
         MVC   P+55+11(3),0(R3)                                                 
*                                                                               
         CLC   GDSCHM,SPACES                                                    
         BH    *+14                                                             
         MVC   P+10(2),=C'00'                                                   
         B     PBLC32                                                           
*                                                                               
         CURED (B4,GDSHRP),(7,P+79),2,ZERO=NOBLANK                              
         L     RE,=A(DICSECT)                                                   
         MVC   P+88(L'SP@PCT),SP@PCT-DICSECT(RE)                                
PBLC32   DS    0H                                                               
         MVI   PRSW,C'N'                                                        
         MVI   SKIPSPEC,C'Y'                                                    
         BRAS  RE,PRNT                                                          
         MVC   PAGE,=H'1'                                                       
*                                                                               
PBLC80   DS    0H                  'DELETE' THIS LINE                           
         L     R6,ABUFFC                                                        
         USING BUFFALOD,R6                                                      
         L     RF,ASORTCOM                                                      
         MVC   0(4,RF),=C'XXXX'                                                 
         MVI   BUFFDOPT,C'Y'       SET TO REPLACE COMMENT                       
         GOTO1 BUFFALO,DMCB,=C'PUT',ABUFFC,SORTREC                              
         MVI   BUFFDOPT,C'N'       RESET COMMENT OPTION                         
         DROP  R6                                                               
*                                                                               
PBLC90   DS    0H                                                               
         BAS   RE,PBLTRCE                                                       
         B     PBLC4                                                            
*                                                                               
PBLCX    DS    0H                                                               
         MVI   SKIPSPEC,C'N'       RESTORE HEADLINE PRINT                       
         XIT1                                                                   
         DROP  R4                                                               
         SPACE 3                                                                
PBLTRCE  DS    0H                                                               
         CLI   SORTTRCE,C'Y'                                                    
         BE    *+10                                                             
         CLI   SORTTRCE,C'O'       'OUTS' ONLY                                  
         BNER  RE                                                               
*                                                                               
         MVC   P(10),SPACES                                                     
         MVC   P+1(3),=C'PBL'                                                   
*                                                                               
         LR    R0,RE                                                            
         GOTO1 HEXOUT,DMCB,SORTREC,P+10,SORTRLEN,=C'N'                          
         BRAS  RE,PRNT                                                          
         LR    RE,R0                                                            
         BR    RE                                                               
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
*                   COMPROC - HANDLE COMMENTS WITHIN BILL                       
         SPACE 2                                                                
COMPROC  NMOD1 0,COMPROC                                                        
         LA    RC,SPACEND                                                       
*                                                                               
         XC    BCMTYPE(14),BCMTYPE                                              
         MVI   BCMTYPE,C'B'        BCOMS                                        
         CLI   PROFB1X+13,C'Y'     OPTION TO USE BILLING TYPE                   
         BNE   *+10                FOR COMMENT TYPE                             
         MVC   BCMTYPE,TYPE                                                     
         MVC   BCMCLT,BCLT                                                      
         CLI   PRDCTL,C'N'         TEST PRD IS ON BILL                          
         BE    COMPR04                                                          
         L     RF,APRD                                                          
         ZIC   R4,0(RF)            GET PROD CODE FROM PROD SEQ                  
         MHI   R4,4                                                             
         L     RF,ADCLT                                                         
         LA    R4,CLIST-CLTHDR(RF,R4)                                           
         MVC   BCMPRD,3(R4)                                                     
*                                                                               
COMPR04  DS    0H                                                               
         CLI   ESTCTL,C'N'         TEST EST IS ON BILL                          
         BE    *+14                                                             
         L     RF,AEST                                                          
         MVC   BCMEST,0(RF)                                                     
*                                                                               
         C     R3,AMKTBRK          DO MARKET IF AT MKT FIRST OR LAST            
         BNE   *+14                                                             
         L     RF,AMKT                                                          
         MVC   BCMSTA+1(2),0(RF)   (MKT OVERLAYS STATION IN CMNT KEY)           
*                                                                               
         CLI   DUESW,C'A'          IF DOING ADJUSTMENT INVOICE                  
         BNE   COMPR07             CHECK MKT SEP                                
         CLI   MKTCTL,C'S'         NO MKT IF MKTS NOT SEPARATE                  
         BNE   COMPR07                                                          
         CLI   MCOMOPT,C'B'        OR IF PRINTING MKTCOMS 'BEFORE'              
         BE    COMPR07             ('AFTERS' WONT PRING IF MKTS SEP)            
         L     RF,AMKT                                                          
         MVC   BCMSTA+1(2),0(RF)   MARKET                                       
*                                                                               
COMPR07  OI    BCMCNTL,X'80'       SET NO DEFAULTING                            
         GOTO1 GETCOM                                                           
         NI    BCMCNTL,X'FF'-X'80'                                              
*                                                                               
         CLC   P,SPACES            ANYTHING LEFTOVER TO PRINT FIRST?            
         BE    *+8                                                              
         BRAS  RE,PRNT                                                          
*                                                                               
         ST    R3,SAVBRK           SAVE BREAK LEVEL FOR BILLEDI                 
         LA    R2,P                EXTRACT COMMENTS FROM COMMENT REC            
         SR    R3,R3                                                            
         L     R6,ADCOMREC                                                      
         CLI   0(R6),0             TEST COMMENT PRESENT                         
         BE    COMPR16             NO                                           
*                                                                               
         CLI   DUESW,C'A'          IF DOING ADJUSTMENT INVOICE                  
         BE    COMPR10             SKIP AROUND SPECIFIC ROUTINES                
*                                                                               
*              BCMCNTL DOESN'T WORK TO PREVENT DEFAULTS, SO CHECK               
*              IF GOT USABLE RECORD                                             
*                                                                               
         OC    BCMEST,BCMEST       SPECIFIC ESTIMATE?                           
         BZ    *+14                                                             
         CLC   BCMEST,COMKEST-COMKEY(R6)   DID WE GET IT?                       
         BNE   COMPR16                                                          
*                                                                               
         OC    BCMSTA,BCMSTA       SPECIFIC MARKET? (MKT IS IN BCMSTA)          
         BZ    *+14                                                             
         CLC   BCMSTA+1(2),COMKMKT-COMKEY(R6)   DID WE GET IT?                  
         BNE   COMPR16             NO, SKIP                                     
*                                                                               
COMPR10  GOTO1 ABILLEDI,DMCB,('EDMCOM',0)   EDI CALL                            
         LA    R6,24(R6)           POINT TO FIRST ELEMENT                       
*                                                                               
COMPR12  CLI   0(R6),5             FIND A COMMENT LINE                          
         BNE   COMPR14                                                          
         CLI   DUESW,C'A'          IS THIS ADJSEP INVOICE?                      
         BNE   *+18                NO, CHECK IF EXCLUDING FROM MAIN             
         CLC   =C'/C/',2(R6)       CHECK IF SHOULD PRT ON ADJUSTMENT            
         BE    COMPR14             IF NO, GET NXT ELEM                          
         B     *+14                GO GET RID OF OVERHEAD                       
*                                                                               
         CLC   =C'/M/',2(R6)       CHECK IF SHOULD PRT ON MAIN BILL             
         BE    COMPR14             IF NO, GET NXT ELEM                          
*                                                                               
         ZIC   RE,1(R6)            GET ELEM LEN                                 
         SHI   RE,3                SET FOR EX                                   
         BM    COMPR14                                                          
         LA    RF,2(R6)            POINT TO ELEM DATA                           
         CLI   0(RF),C'/'          GET RID OF /C/ OR /M/                        
         BNE   COMPR13                                                          
         CLI   2(RF),C'/'                                                       
         BNE   COMPR13                                                          
         LA    RF,3(RF)            SKIP /C/ OR /M/                              
         SHI   RE,3                ADJUST LENGTH                                
         BM    COMPR14                                                          
*                                                                               
COMPR13  EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),0(RF)                                                    
         LA    R2,132(R2)                                                       
         AHI   R3,1                BUMP LINE COUNT                              
         LA    R0,P14                                                           
         CR    R2,R0               TEST USED MORE THAN 14 LINES                 
         BH    COMPR16             IF SO, STOP NOW                              
COMPR14  ZIC   R0,1(R6)                                                         
         AR    R6,R0                                                            
         CLI   0(R6),0                                                          
         BNE   COMPR12                                                          
*                                                                               
COMPR16  DS    0H                                                               
         CLC   P,SPACES                                                         
         BE    *+12                                                             
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         XIT1                                                                   
         SPACE 3                                                                
         LTORG                                                                  
         EJECT                                                                  
*                   PRTUSER - PRINT USER FIELDS                                 
         SPACE 2                                                                
PRTUSER  NMOD1 UCOMQ,PUSER                                                      
         LR    R9,RC                                                            
         USING UCOMD,R9                                                         
         LA    RC,SPACEND                                                       
         MVI   HAVUSER,C'N'                                                     
*                                                                               
         MVI   MASPRDCD,0          RESET NUMERIC MASTER PRODUCT CODE            
         CLI   TCFSW,C'Y'                                                       
         BE    PU18                                                             
*                                                                               
         CLI   EPUDEF,C'Y'                                                      
         BE    PU18                                                             
*                                                                               
         MVI   BYTE,0                                                           
         CLI   PRDCTL,C'S'       SEE IF PRODUCTS SEPERATE                       
         BE    PU4               YES, USE PRODUCT USER FIELD                    
*                                  ELSE                                         
         CLI   PGR1CTL,C'S'        IF DOING PRODUCT GROUPS                      
         BNE   *+16                                                             
         BAS   RE,PUGTMPRD         GET MASTER PRODUCT                           
         BNE   PU10                NON, SKIP                                    
         B     PU4                                                              
*                                                                               
         CLI   EPUDEF,C'P'                                                      
         BE    PU10                                                             
*                                  NO PRD GRP                                   
         BAS   RE,PUGTPOLP         GET POL PRD HEADER                           
         BNE   PU10                NOT FOUND, SKIP                              
*                                                                               
PU4      DS    0H                                                               
         MVC   X(132),SPACES                                                    
         GOTO1 =V(GETUSER),DMCB,(C'B',ADCLT),(C'P',ADPRD),(C':',X+8),0          
         TM    DMCB+4,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    PU6                                                              
*                                                                               
         TM    DMCB+4,X'01'        ALREADY IN HEADLINES?                        
         BO    PU6                 YES                                          
*                                                                               
         CLI   PUMODE,C'F'         FRONT OF BILL?                               
         BNE   *+16                                                             
         TM    DMCB+4,X'02'                                                     
         BZ    PU6                                                              
         B     *+12                                                             
*                                  NOT DOING FRONT NOW                          
         TM    DMCB+4,X'02'                                                     
         BO    PU6                                                              
*                                                                               
         CLI   ADJSEP,C'Y'         IF SEP ADJ, SKIP BELOW                       
         BNE   PU5                                                              
*                                                                               
         CLI   DMCB+8,C'R'           MAIN BILL COMMENT?                         
         BNE   *+16                                                             
         CLI   DUESW,C'A'            THEN MAKE SURE NOT COMM INVOICE            
         BE    PU6                                                              
         B     *+20                                                             
*                                                                               
         CLI   DMCB+8,C'F'           COMM BILL COMMENT?                         
         BNE   *+12                                                             
         CLI   DUESW,C'A'            THEN MAKE SURE NOT REG INVOICE             
         BNE   PU6                                                              
*                                                                               
PU5      MVI   HAVUSER,C'Y'                                                     
         MVC   P1,SPACES                                                        
         BRAS  RE,PRNT        SKIP BEFORE                                       
         MVC   P1,X                                                             
         BRAS  RE,PRNT                                                          
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'P1')   EDI CALL                       
         MVI   BYTE,1          SO I WON'T SKIP AGAIN                            
*                                                                               
PU6      DS    0H                                                               
         MVC   X(132),SPACES                                                    
         GOTO1 =V(GETUSER),DMCB,(C'B',ADCLT),(C'P',ADPRD),0,(C':',X+8)          
         TM    DMCB+6,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    PU10                                                             
*                                                                               
         TM    DMCB+6,X'01'        ALREADY IN HEADLINES?                        
         BO    PU10                                                             
*                                                                               
         CLI   PUMODE,C'F'         FRONT OF BILL?                               
         BNE   *+16                                                             
         TM    DMCB+6,X'02'                                                     
         BZ    PU10                                                             
         B     *+12                                                             
*                                  NOT DOING FRONT NOW                          
         TM    DMCB+6,X'02'                                                     
         BO    PU10                                                             
*                                                                               
         CLI   ADJSEP,C'Y'         IF SEP ADJ, SKIP BELOW                       
         BNE   PU8                                                              
*                                                                               
         CLI   DMCB+9,C'R'           MAIN BILL COMMENT?                         
         BNE   *+16                                                             
         CLI   DUESW,C'A'            THEN MAKE SURE NOT COMM INVOICE            
         BE    PU10                                                             
         B     *+20                                                             
*                                                                               
         CLI   DMCB+9,C'F'           COMM BILL COMMENT?                         
         BNE   *+12                                                             
         CLI   DUESW,C'A'            THEN MAKE SURE NOT REG INVOICE             
         BNE   PU10                                                             
*                                                                               
PU8      MVI   HAVUSER,C'Y'                                                     
         CLI   BYTE,1                                                           
         BE    *+14                                                             
         MVC   P1,SPACES                                                        
         BRAS  RE,PRNT        SKIP BEFORE                                       
*                                                                               
         MVC   P1,X                                                             
         BRAS  RE,PRNT                                                          
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'P2')   EDI CALL                       
*                                                                               
PU10     DS    0H                                                               
         MVI   BYTE,0                                                           
         MVC   P1,SPACES                                                        
         CLI   ESTCTL,C'S'       SEE IF ESTIMATES SEPARATE                      
         BNE   PU18              NO, DONE                                       
         CLI   PRDCTL,C'S'       YES, IF PROD ALSO SEPARATE                     
         BNE   *+12                                                             
         CLI   LMGSW,C'R'        IF REGIONAL GET POL                            
         BNE   PU14              ELSE USE THIS PRD/EST                          
*                                  ELSE                                         
         CLI   PGR1CTL,C'S'        IF DOING PRODUCT GROUPS                      
         BNE   *+16                                                             
         BAS   RE,PUGTMEST         GET MASTER PRD/ESTIMATE                      
         BNE   PU18                NON, SKIP                                    
         B     PU14                                                             
*                                                                               
* IF EST UDEF THEN SKIP POL                                                     
         CLI   EPUDEF,C'E'                                                      
         BE    PU18                                                             
         CLC   QPRD,=C'ALL'                                                     
         BE    *+14                                                             
         CLC   QPRD,=C'POL'                                                     
         BNE   PU14                                                             
*                                  NO PRD GRP                                   
         BAS   RE,PUGTPOLE         GET POL/EST HEADER                           
         BNE   PU18                NOT FOUND, SKIP                              
*                                                                               
PU14     DS    0H                                                               
         MVC   X(132),SPACES                                                    
         GOTO1 =V(GETUSER),DMCB,(C'B',ADCLT),(C'E',ADEST),(C':',X+8),0          
         TM    DMCB+4,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    PU15                                                             
*                                                                               
         TM    DMCB+4,X'01'        ALREADY IN HEADLINES?                        
         BO    PU15                YES                                          
*                                                                               
         CLI   PUMODE,C'F'         FRONT OF BILL?                               
         BNE   *+16                                                             
         TM    DMCB+4,X'02'                                                     
         BZ    PU15                                                             
         B     *+12                                                             
*                                  NOT DOING FRONT NOW                          
         TM    DMCB+4,X'02'                                                     
         BO    PU15                                                             
*                                                                               
         CLI   ADJSEP,C'Y'         IF SEP ADJ, SKIP BELOW                       
         BNE   PU12                                                             
*                                                                               
         CLI   DMCB+8,C'R'           MAIN BILL COMMENT?                         
         BNE   *+16                                                             
         CLI   DUESW,C'A'            THEN MAKE SURE NOT COMM INVOICE            
         BE    PU15                                                             
         B     *+20                                                             
*                                                                               
         CLI   DMCB+8,C'F'           COMM BILL COMMENT?                         
         BNE   *+12                                                             
         CLI   DUESW,C'A'            THEN MAKE SURE NOT REG INVOICE             
         BNE   PU15                                                             
*                                                                               
PU12     MVI   HAVUSER,C'Y'                                                     
         MVC   P1,SPACES                                                        
         BRAS  RE,PRNT        SKIP BEFORE                                       
         MVC   P1,X                                                             
         BRAS  RE,PRNT                                                          
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'E1')    EDI CALL                      
         MVI   BYTE,1          SO I WON'T SKIP AGAIN                            
*                                                                               
PU15     DS    0H                                                               
         MVC   X(132),SPACES                                                    
         GOTO1 =V(GETUSER),DMCB,(C'B',ADCLT),(C'E',ADEST),0,(C':',X+8)          
         TM    DMCB+6,X'10'       SEE IF TO PRINT ON BILLING                    
         BZ    PU18                                                             
*                                                                               
         TM    DMCB+6,X'01'        ALREADY IN HEADLINES?                        
         BO    PU18                YES                                          
*                                                                               
         CLI   PUMODE,C'F'         FRONT OF BILL?                               
         BNE   *+16                                                             
         TM    DMCB+6,X'02'                                                     
         BZ    PU18                                                             
         B     *+12                                                             
*                                  NOT DOING FRONT NOW                          
         TM    DMCB+6,X'02'                                                     
         BO    PU18                                                             
*                                                                               
         CLI   ADJSEP,C'Y'         IF SEP ADJ, SKIP BELOW                       
         BNE   PU17                                                             
*                                                                               
         CLI   DMCB+9,C'R'           MAIN BILL COMMENT?                         
         BNE   *+16                                                             
         CLI   DUESW,C'A'            THEN MAKE SURE NOT COMM INVOICE            
         BE    PU18                                                             
         B     *+20                                                             
*                                                                               
         CLI   DMCB+9,C'F'           COMM BILL COMMENT?                         
         BNE   *+12                                                             
         CLI   DUESW,C'A'            THEN MAKE SURE NOT REG INVOICE             
         BNE   PU18                                                             
*                                                                               
PU17     MVI   HAVUSER,C'Y'                                                     
         CLI   BYTE,1                                                           
         BE    *+14                                                             
         MVC   P1,SPACES                                                        
         BRAS  RE,PRNT        SKIP BEFORE                                       
*                                                                               
         MVC   P1,X                                                             
         BRAS  RE,PRNT                                                          
         GOTO1 ABILLEDI,DMCB,('EDMUSR',=C'E2')   EDI CALL                       
*                                                                               
PU18     DS    0H                                                               
         CLI   HAVUSER,C'Y'     IF PRINTED ANY USER FIELDS                      
         BNE   *+14                                                             
         MVC   P1,SPACES         SKIP A LINE                                    
         BRAS  RE,PRNT                                                          
*                                                                               
*                            NOW CHECK FOR UCOMM RECORDS                        
         CLI   PUMODE,C'E'   MUST BE END OF INVOICE                             
         BNE   PRTUXX        (FOR NOW)                                          
         MVC   USAVKEY,KEY   SAVE MY KEY                                        
         LA    R6,UCOMBLK     SET-UP UCOM CONTROL BLOCK                         
         XC    UCOMBLK(L'UCOMBLK),UCOMBLK                                       
         USING DDUCOMD,R6                                                       
*                                                                               
         MVC   UCACOMF,ACOMFACS     COMFACS                                     
         MVI   UCSYS,C'S'        SYSTEM TO PRINT (SPOT)                         
         MVC   UCSAM,BAGYMD      AGENCY/MEDIA                                   
         MVC   UCSCLT,BCLT       PACKED CLIENT                                  
         L     RF,ADPRD                                                         
         MVC   UCPRD,PKEYPRD-PRDHDR(RF)   3 CHAR PRD CODE                       
*                                                                               
         CLI   PRDCTL,C'S'                                                      
         BE    *+10                                                             
         MVC   UCPRD,=C'AAA'     IF PRODUCTS NOT SEPARATE                       
*                                DO UCOMM FOR PRD AAA                           
         OI    UCOPT,UCOPRD      RETURN PRODUCT UCOMMS                          
         CLI   ESTCTL,C'S'      EST ON SEPARATE INVOICES                        
         BNE   *+18                                                             
         OI    UCOPT,UCOEST     RETURN ESTIMATE UCOMMS                          
         L     RF,AEST             ESTIMATE                                     
         MVC   UCSEST,0(RF)        BINARY ESTIMATE NUMBER                       
*                                                                               
         CLI   MKTCTL,C'S'      MKT ON SEPARATE INVOICES                        
         BNE   *+14                                                             
         OI    UCOPT,UCOMKT     RETURN MARKET UCOMMS                            
         MVC   UCMKT,BMKT          BINARY MARKET                                
*        XC    W,W                 STORE UCOM BLOCK INFO                        
*        MVC   W(UCOMDLNQ),UCOMBLK                                              
*                                                                               
         GOTO1 =V(DDUCOM),UCOMBLK                                               
         CLI   UCERROR,0                                                        
         BNE   PRTUXX       ERROR RETURN - JUST EXIT DON'T DIE                  
         TM    UCDATA,UCDNOPRD+UCDNOEST+UCDNOMKT                                
         BO    PRTUX20      NO PRD,EST,OR MKT DATA                              
*                                                                               
         MVC   P1,SPACES                                                        
         MVI   P1,0           TO INSURE PRINTING                                
         LA    R2,P2+8        START AT SECOND PRINT LINE                        
         TM    UCDATA,UCDNOPRD                                                  
         BO    PRTUX10                                                          
         XC    UCTTLS(UCALL),UCTTLS                                             
         L     R4,UCPTTLS     PRD TITLES                                        
         MVC   UCTTLS,0(R4)   SAVE INFO IN MY STORAGE                           
         LA    R4,UCTTLS      AS OPPOSED TO RD CHANE                            
         L     R7,UCPDATA     PRD DATA                                          
         MVC   UCOMDATA,0(R7)                                                   
         LA    R7,UCOMDATA                                                      
         LA    R1,UCPLENS     DATA FIELD LENGTHS                                
******** L     R4,UCPTTLS     PRD TITLES                                        
******** L     R7,UCPDATA     PRD DATA                                          
*                                                                               
         LHI   RF,1           FOR EDI, LINE COUNTER                             
         LHI   R5,4           FOR BCT                                           
PRTUX6B  DS    0H                                                               
         CLI   0(R1),0        CHECK DATA LENGTH                                 
         BE    PRTUX6X                                                          
         MVC   0(20,R2),0(R4) MOVE TITLE                                        
         LA    RE,20(R2)                                                        
*                                                                               
         CLI   0(RE),C' '       SCAN BACKWARDS FOR NON-SPACE                    
         BH    *+8                                                              
         BCT   RE,*-8                                                           
*                                                                               
         MVI   1(RE),C':'                                                       
         MVC   3(32,RE),0(R7)                                                   
         MVC   X(132),SPACES                                                    
         MVC   X+8(132-8),0(R2)    MOVE VALUE IN X FOR EDI CALL                 
         MVI   HALF,C'P'                                                        
         STC   RF,HALF+1           DECIDE WHICH SEQUENCE NUMBER                 
         OI    HALF+1,X'F0'                                                     
         ST    R1,WK               SAVE R1                                      
         ST    RF,WK+4             SAVE RF                                      
         GOTO1 ABILLEDI,DMCB,('EDMUCM',HALF)    EDI CALL FOR PRODUCT            
         L     R1,WK               RESTORE R1                                   
         L     RF,WK+4             RESTORE RF                                   
         LA    R2,132(R2)        NEXT PRINT LINE                                
*                                                                               
PRTUX6X  LA    R1,1(R1)          NEXT DATA LENGTH                               
         LA    R4,20(R4)         NEXT TITLE                                     
         LA    R7,32(R7)         NEXT DATA                                      
         AHI   RF,1                                                             
         BCT   R5,PRTUX6B                                                       
*                                                                               
*                                                                               
PRTUX10  DS    0H                NOW DO ESTIMATE FIELDS                         
         XC    UCCTYP,UCCTYP     CLEAR SPECIAL DESIGNATION OPT                  
         CLI   ADJSEP,C'Y'       SEP ADJ INV                                    
         BNE   *+20              IF NOT, NOTHING SPECIAL                        
         MVI   UCCTYP,C'R'       UCOMS FOR MAIN BILL                            
         CLI   DUESW,C'A'        ADJ BILL                                       
         BNE   *+8                                                              
         MVI   UCCTYP,C'F'       UCOMS FOR COMM BILL                            
*                                                                               
*NOP     L     RF,ADCLT                                                         
*        CLI   UCOMNUM-CLTHDR(RF),4    IF 4 UCOMMS OR LESS                      
*        BNH   *+8                   BYPASS                                     
*****    OI    UCOPT,UCO8EST       RETURN ESTIMATE UCOMMS (UP TO 8)             
*                                                                               
         GOTO1 =V(DDUCOM),UCOMBLK    NEW UCOM CALL SINCE GOTO MACRO             
         CLI   UCERROR,0         TRASHED WRKING STORAGE USED BY DDUCOM          
         BNE   PRTUXX       ERROR RETURN - JUST EXIT DON'T DIE                  
         TM    UCDATA,UCDNOEST+UCDNOMKT                                         
         BO    PRTUX20      NO EST,OR MKT DATA                                  
         TM    UCDATA,UCDNOEST                                                  
         BO    PRTUX15                                                          
         XC    UCTTLS(UCALL),UCTTLS                                             
         L     R4,UCETTLS     EST TITLES                                        
         MVC   UCTTLS,0(R4)   SAVE INFO IN MY STORAGE                           
         LA    R4,UCTTLS      AS OPPOSED TO RD CHANE                            
         L     R7,UCEDATA     EST DATA                                          
         MVC   UCOMDATA,0(R7)                                                   
         LA    R7,UCOMDATA                                                      
         LA    R1,UCELENS     DATA FIELD LENGTHS                                
******** L     R4,UCETTLS     EST TITLES                                        
******** L     R7,UCEDATA     EST DATA                                          
*                                                                               
*        NOTE R2 SHOULD BE SET TO P1+8 OR                                       
*        NEXT AT +8 INTO NEXT AVAILABLE PRINT LINE                              
*                                                                               
         LHI   RF,1             FOR EDI, LINE COUNTER                           
PRTUX10A LHI   R5,4             FOR BCT                                         
PRTUX10B DS    0H                                                               
         CLI   0(R1),0          CHECK DATA LENGTH                               
         BE    PRTUX10X                                                         
         MVC   0(20,R2),0(R4)      MOVE TITLE                                   
         LA    RE,20(R2)                                                        
*                                                                               
         CLI   0(RE),C' '       SCAN BACKWARDS FOR NON-SPACE                    
         BH    *+8                                                              
         BCT   RE,*-8                                                           
*                                                                               
         MVI   1(RE),C':'                                                       
         MVC   3(32,RE),0(R7)                                                   
         MVC   X(132),SPACES                                                    
         MVC   X+8(132-8),0(R2)    MOVE VALUE IN X FOR EDI CALL                 
         MVI   HALF,C'E'                                                        
         STC   RF,HALF+1           DECIDE WHICH SEQUENCE NUMBER                 
         OI    HALF+1,X'F0'                                                     
         CLC   HALF(2),=C'E1'      FIRST EST UCOM?                              
         BNE   PRTUX10D                                                         
         CLI   SVWBSW,C'Y'         WB FLIGHT CLIENT?                            
         BNE   PRTUX10D                                                         
         CLI   WBSW,C'Y'           AM I IN WB FLIGHT MODE?                      
         BNE   PRTUX10E            NO - MEANS PRD IS NON-THEATRICAL             
*                                  SO DON'T SEND TO WORKER FILE                 
PRTUX10D ST    R1,WK               SAVE R1                                      
         ST    RF,WK+4             SAVE RF                                      
         GOTO1 ABILLEDI,DMCB,('EDMUCM',HALF)    EDI CALL FOR ESTIMATE           
         L     R1,WK               RESTORE R1                                   
         L     RF,WK+4             RESTORE RF                                   
*                                                                               
PRTUX10E CLI   WBSW,C'Y'           WB FLIGHT FEATURE?                           
         BNE   PRTUX10F                                                         
         CHI   R5,4                1ST UCOM?                                    
         BNE   PRTUX10F                                                         
         MVC   0(132,R2),SPACES   CLEAR AND DON'T PRINT                         
         B     PRTUX10X                                                         
*                                                                               
PRTUX10F LA    R2,132(R2)        NEXT PRINT LINE                                
*                                                                               
PRTUX10X LA    R1,1(R1)          NEXT DATA LENGTH                               
         LA    R4,20(R4)         NEXT TITLE                                     
         LA    R7,32(R7)         NEXT DATA                                      
         AHI   RF,1                                                             
         BCT   R5,PRTUX10B                                                      
*                                                                               
*NOP     LA    RF,UCPLENS+4      EST DATA LEN FOR FLDS 5-8                      
*        CR    RF,R1                                                            
*        BE    PRTUX15           DONE                                           
*                                                                               
*        L     RF,ADCLT                                                         
*        CLI   UCOMNUM-CLTHDR(RF),4  IF 4 UCOMMS OR LESS                        
*        BNH   PRTUX15               DONE                                       
*                                                                               
*        XC    UCTTLS(UCALL),UCTTLS                                             
*        L     R4,UCPTTLS     EST TITLES 5-8                                    
*        MVC   UCTTLS,0(R4)   SAVE INFO IN MY STORAGE                           
*        LA    R4,UCTTLS      AS OPPOSED TO RD CHANE                            
*        L     R7,UCPDATA     EST DATA 5-8                                      
*        MVC   UCOMDATA,0(R7)                                                   
*        LA    R7,UCOMDATA                                                      
*        LA    R1,UCPLENS     DATA FIELD LENGTHS                                
*******  B     PRTUX10A                                                         
*                                                                               
PRTUX15  DS    0H                  NOW DO MARKET FIELDS                         
         GOTO1 =V(DDUCOM),UCOMBLK                                               
         CLI   UCERROR,0                                                        
         BNE   PRTUXX       ERROR RETURN - JUST EXIT DON'T DIE                  
         TM    UCDATA,UCDNOMKT                                                  
         BO    PRTUX20                                                          
         XC    UCTTLS(UCALL),UCTTLS                                             
         L     R4,UCMTTLS     EST TITLES                                        
         MVC   UCTTLS,0(R4)   SAVE INFO IN MY STORAGE                           
         LA    R4,UCTTLS      AS OPPOSED TO RD CHANE                            
         L     R7,UCMDATA     EST DATA                                          
         MVC   UCOMDATA,0(R7)                                                   
         LA    R7,UCOMDATA                                                      
         LA    R1,UCMLENS          DATA FIELD LENGTHS                           
******** L     R4,UCMTTLS          MKT TITLES                                   
******** L     R7,UCMDATA          MKT DATA                                     
*                                                                               
*        NOTE R2 SHOULD BE SET TO P1+8 OR                                       
*        NEXT AT +8 INTO NEXT AVAILABLE PRINT LINE                              
*                                                                               
         LHI   R5,4                FOR BCT                                      
         LHI   RF,1                                                             
PRTUX15B DS    0H                                                               
         CLI   0(R1),0             CHECK DATA LENGTH                            
         BE    PRTUX15X                                                         
         MVC   0(20,R2),0(R4)      MOVE TITLE                                   
         LA    RE,20(R2)                                                        
*                                                                               
         CLI   0(RE),C' '          SCAN BACKWARDS FOR NON-SPACE                 
         BH    *+8                                                              
         BCT   RE,*-8                                                           
*                                                                               
         MVI   1(RE),C':'                                                       
         MVC   3(32,RE),0(R7)                                                   
         MVC   X(132),SPACES                                                    
         MVC   X+8(132-8),0(R2)    MOVE VALUE IN X FOR EDI CALL                 
         MVI   HALF,C'M'                                                        
         STC   RF,HALF+1           DECIDE WHICH SEQUENCE NUMBER                 
         OI    HALF+1,X'F0'                                                     
         ST    R1,WK               SAVE R1                                      
         ST    RF,WK+4             SAVE RF                                      
         GOTO1 ABILLEDI,DMCB,('EDMUCM',HALF)    EDI CALL FOR MARKET             
         L     R1,WK               RESTORE R1                                   
         L     RF,WK+4             RESTORE RF                                   
         LA    R2,132(R2)          NEXT PRINT LINE                              
*                                                                               
PRTUX15X LA    R1,1(R1)            NEXT DATA LENGTH                             
         LA    R4,20(R4)           NEXT TITLE                                   
         LA    R7,32(R7)           NEXT DATA                                    
         AHI   RF,1                                                             
         BCT   R5,PRTUX15B                                                      
*                                                                               
PRTUX20  DS    0H                                                               
         BRAS  RE,PRNT          FINALLY PRINT P LINES                           
         MVC   KEY,USAVKEY  SINCE SEQ READING MAY BE AFFECTED                   
         GOTO1 HIGH                                                             
*                                                                               
PRTUXX   XIT1                                                                   
**                                                                              
         DROP  R6                                                               
         SPACE 3                                                                
         EJECT                                                                  
*        PUGTMPRD - PRTUSER, GET MASTER PRODUCT FROM PGR REC                    
*                                                                               
PUGTMPRD NTR1                                                                   
         XC    FULL,FULL           CLEAR SAVED MASTER CODE                      
         L     R2,ADPRDGRP         PGR RECORD                                   
         LA    R2,PRGEL-PRGKEY(R2)                                              
*                                                                               
PUGMPR2  DS    0H                                                               
         CLI   0(R2),0             EOR                                          
         BE    NEQXIT                                                           
         CLI   0(R2),X'30'                                                      
         BE    PUGMPR4                                                          
*                                                                               
         ZIC   R0,1(R2)            NEXT ELEM                                    
         AR    R2,R0                                                            
         B     PUGMPR2                                                          
*                                                                               
PUGMPR4  DS    0H                                                               
         USING PRGEL30,R2                                                       
         CLI   PRGUSER,C' '        ANY MAST PRD PRESENT?                        
         BNH   NEQXIT              NO, DONE                                     
         MVC   FULL(3),PRGUSER     SAVE PRODUCT CODE                            
*                                                                               
         L     RF,ADCLT            EXTRACT NUMERIC PRODUCT CODE                 
         LA    RF,CLIST-CLTHDR(RF)                                              
PUGMPR6  CLC   PRGUSER,0(RF)                                                    
         BE    PUGMPR8                                                          
         LA    RF,4(RF)                                                         
         CLI   0(RF),C'A'                                                       
         BNL   PUGMPR6                                                          
         B     NEQXIT              MISSING MASTER PRODUCT CODE                  
PUGMPR8  MVC   MASPRDCD,3(RF)      SAVE NUMERIC MASTER PRODUCT CODE             
*                                                                               
*                                  READ FOR MASTER PRODUCT                      
         L     RF,ADPRD                                                         
         MVC   KEY,0(RF)                                                        
         MVC   KEY+PKEYPRD-PRDHDR(3),PRGUSER                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   NEQXIT                                                           
         GOTO1 GETPRD                                                           
         CLI   DMCB+8,0                                                         
         BNE   NEQXIT                                                           
         B     EQXIT                                                            
         DROP  R2                                                               
*                                                                               
         SPACE 2                                                                
*        PUGTMEST - PRTUSER, GET ESTIMATE FOR MASTER PROD                       
*                                                                               
PUGTMEST NTR1                                                                   
         CLI   FULL,C' '           ANY MAST PRD PRESENT?                        
         BNH   NEQXIT              NO, DONE                                     
*                                  READ FOR EST FOR PRODUCT                     
         L     RF,ADEST                                                         
         MVC   KEY,0(RF)                                                        
         MVC   KEY+EKEYPRD-ESTHDR(3),FULL    PRODUCT CODE                       
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   NEQXIT                                                           
         GOTO1 GETEST                                                           
         CLI   DMCB+8,0                                                         
         BNE   NEQXIT                                                           
         B     EQXIT                                                            
*                                                                               
         SPACE 2                                                                
*        PUGTPOLP - PRTUSER, GET POL PRODUCT HEADER                             
*                                                                               
PUGTPOLP NTR1                                                                   
         L     RF,ADPRD                                                         
         MVC   KEY,0(RF)                                                        
         MVC   KEY+PKEYPRD-PRDHDR(3),=C'POL'                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   NEQXIT                                                           
         GOTO1 GETPRD                                                           
         CLI   DMCB+8,0                                                         
         BNE   NEQXIT                                                           
         B     EQXIT                                                            
         SPACE 2                                                                
*        PUGTPOLE - PRTUSER, GET POL ESTIMATE HEADER                            
*                                                                               
PUGTPOLE NTR1                                                                   
         L     RF,ADEST                                                         
         MVC   KEY,0(RF)                                                        
         MVC   KEY+EKEYPRD-ESTHDR(3),=C'POL'                                    
         GOTO1 HIGH                                                             
         CLC   KEY(13),KEYSAVE                                                  
         BNE   NEQXIT                                                           
         GOTO1 GETEST                                                           
         CLI   DMCB+8,0                                                         
         BNE   NEQXIT                                                           
         B     EQXIT                                                            
*                                                                               
NEQXIT   LTR   RD,RD               EXIT WITH CC NOT =                           
         B     *+6                                                              
EQXIT    CR    RD,RD               EXIT WITH CC =                               
         XIT1                                                                   
         DROP  R9                                                               
         SPACE 3                                                                
         LTORG                                                                  
*                                                                               
UCOMD    DSECT                                                                  
UCOMBLK  DS    CL(UCOMDLNQ)     DDUCOM CONTROL BLOCK                            
UCTTLS   DS    CL80             LEN=20*4                                        
UCOMDATA DS    CL128            LEN=32*4                                        
UCALL    EQU   *-UCTTLS                                                         
USAVKEY  DS    XL13             TO SAVE CURRENT READ SEQUENCE                   
UCOMQ    EQU   *-UCOMD                                                          
*                                                                               
SPB102   CSECT                                                                  
TSTRET   NMOD1 0,TSTRET                                                         
         LA    RC,SPACEND                                                       
*                                  SET RETAIL STATUS TABLE ENTRY                
         L     RF,BRKCODE                                                       
         SRL   RF,2                                                             
         MHI   RF,RSTATTBL                                                      
         A     RF,=A(RSTATTB)                                                   
         XC    0(RSTATTBL,RF),0(RF)  CLEAR IT                                   
         ST    RF,ARSTATTB           AND SET A POINTER                          
*                                                                               
         MVI   RETSKIP,C'N'                                                     
         CLI   UPASS,0                                                          
         BE    TRYES               OK IF NON-RETAIL                             
         L     R4,AGDAREA                                                       
         USING GDSECT,R4                                                        
         L     RF,ADEST                                                         
         MVC   GDSCHM,SPACES                                                    
         CLI   ERTLSCHM-ESTHDR(RF),C'*'    * MEANS NO SCHEME                    
         BE    TR2A                                                             
         MVC   GDSCHM,ERTLSCHM-ESTHDR(RF)  IF ANYTHING IN RETAIL SCHEME         
         CLC   GDSCHM,SPACES               FIELD, USE IT                        
         BH    *+10                                                             
         MVC   GDSCHM,EPROF+1-ESTHDR(RF)   ELSE USE EPROF+1                     
         CLC   GDSCHM,SPACES                                                    
         BNH   TR2A                                                             
         XC    FULL,FULL                                                        
         MVI   GDOUTNO,0                                                        
         CLI   UPASS,C'T'                                                       
         BE    *+10                                                             
         MVC   GDOUTNO,UPASS                                                    
*                                                                               
         LA    R5,PERLIST          GO THRU PERLIST, CALLING FINDOUT             
         SR    R6,R6               FOR EACH PERIOD                              
*                                                                               
TR1P     DS    0H                                                               
         CLI   0(R5),X'FF'         EOL                                          
         BNE   *+16                                                             
         CLI   UPASS,C'T'                                                       
         BE    TR2B                                                             
         B     TR2D                                                             
*                                                                               
         STC   R6,GDPER                                                         
         MVI   GDTEST,C'Y'         SET TEST MODE                                
         GOTO1 =V(FINDOUT),DMCB,AGDAREA                                         
         MVI   GDTEST,C'N'                                                      
         CLI   UPASS,C'T'                                                       
         BE    TRIP4                                                            
*                                                                               
         OC    GDSHRP,GDSHRP                                                    
         BZ    TRIP2D                                                           
         L     RF,ARSTATTB             A(RSTATTB ENTRY)                         
         MVI   RSTATTBL-1(RF),X'80'    SET TOTAL ROW ACTIVE                     
         AR    RF,R6                                                            
         MVI   0(RF),X'80'             SET MONTH ACTIVE                         
*                                                                               
TRIP2D   DS    0H                                                               
         OC    FULL,GDSHRP         KEEP TRACK OF ANY SHARE %                    
*                                                                               
         CLI   GDEFFSW,C'Y'        UNLESS HAVE OUTLET EFFECTIVE DATES           
         BE    TRIP6               NO NEED TO TEST OTHER DATES                  
*                                                                               
         L     RF,ARSTATTB             A(RSTABTB ENTRY)                         
         MVI   0(RF),X'80'         AND SET ALL MONTHS ACTIVE                    
         MVC   1(RSTATTBL-1,(RF)),0(RF)                                         
         B     TR2D                                                             
*                                                                               
TRIP4    DS    0H                                                               
         CLC   GDSHRP,=F'10000'    100 PCT                                      
         BNE   TR2A                                                             
         CLI   GDEFFSW,C'Y'        UNLESS HAVE OUTLET EFFECTIVE DATES           
         BNE   TR2B                NO NEED TO TEST OTHER DATES                  
*                                                                               
TRIP6    DS    0H                                                               
         LA    R5,PERLISTL(R5)     NEXT PERLIST ENTRY                           
         LA    R6,1(R6)                                                         
         B     TR1P                                                             
*                                                                               
TR2A     DS    0H                                                               
         MVC   P(28),=C'** SCHEME XX NOT CORRECT FOR'                           
         MVC   P+10(2),GDSCHM                                                   
         MVC   P+29(15),GDMGRDSC                                                
         CLI   GDMKTLEN,0                                                       
         BE    *+10                                                             
         MVC   P+29(15),GDMKTDSC                                                
         MVC   P+45(4),GDMGR                                                    
         MVC   P+50(4),GDMKT                                                    
         MVC   P+55(19),=C'(PRD/EST = XXX/NNN)'                                 
         MVC   P+55+15(3),EST                                                   
*                                                                               
         L     RF,ADCLT                                                         
         L     RE,APRD                                                          
         ZIC   R5,0(RE)                                                         
         MHI   R5,4                                                             
         LA    R5,CLIST-CLTHDR(RF,R5)     GET ALPHA PRD                         
         MVC   P+55+11(3),0(R5)                                                 
*                                                                               
         CLC   GDSCHM,SPACES                                                    
         BH    *+14                                                             
         MVC   P+10(2),=C'00'                                                   
         B     TR2A2                                                            
*                                                                               
         OC    GDSHRP,GDSHRP                                                    
         BZ    TR2A2                                                            
         CURED (B4,GDSHRP),(7,P+79),2                                           
         L     RE,=A(DICSECT)                                                   
         MVC   P+88(L'SP@PCT),SP@PCT-DICSECT(RE)                                
*                                                                               
TR2A2    DS    0H                                                               
         MVI   PRSW,C'N'                                                        
         MVI   SKIPSPEC,C'Y'                                                    
         BRAS  RE,PRNT                                                          
         MVC   PAGE,=H'1'                                                       
*                                                                               
         MVI   RETERR,1                                                         
TR2B     DS    0H                                                               
         B     TRNO                                                             
*                                  IF HERE UPASS NOT = T                        
TR2D     DS    0H                                                               
         MVI   RETSKIP,C'N'                                                     
         CLI   UPASS,1             DONT SKIP IF CORP OUTLET                     
         BNE   *+18                                                             
         OC    FULL,FULL           IF NO NON=ZERO SHARE                         
         BNZ   TRYES                                                            
         B     *+12                SET ON ALL MONTHS                            
*                                                                               
         CLI   UPASS,C'S'          OR SUMMARY                                   
         BNE   TR2G                                                             
*                                                                               
         L     RF,ARSTATTB             ACTIVATE ALL MONTHS                      
         MVI   0(RF),X'80'             IN RSTAB ENTRY                           
         MVC   1(RSTATTBL-1,(RF)),0(RF)                                         
         B     TRYES                                                            
*                                                                               
TR2G     DS    0H                                                               
         OC    FULL,FULL           ANY SHARE %                                  
         BNZ   TRYES                                                            
*                                                                               
         MVI   RETSKIP,C'Y'        SKIP THIS EST - NO SHR PCT                   
*                                  !! NOT AN ERROR !!                           
TRNO     DS    0H                                                               
         LHI   R0,1                                                             
         B     TRX                                                              
TRYES    DS    0H                                                               
         SR    R0,R0                                                            
*                                                                               
TRX      DS    0H                                                               
         L     RF,=A(RSTATTB)      'OR UP' VALUES TO ALL OTHER                  
         LHI   R1,RSTATTBN         LEVEL ENTRIES                                
         L     R2,ARSTATTB                                                      
*                                                                               
TRX4     DS    0H                                                               
         OC    0(RSTATTBL,RF),0(R2)                                             
         LA    RF,RSTATTBL(RF)                                                  
         BCT   R1,TRX4                                                          
*                                                                               
         LTR   R0,R0               CC SET AT TRXYES OR TRXNO                    
*                                                                               
         XIT1                                                                   
         DROP  R4                                                               
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
SAVCORP  NMOD1 0,SAVCORP                                                        
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   SUMOPT,C'Y'                                                      
         BNE   SAVCX                                                            
         CLI   UPASS,1             MUST BE RETAIL AND CORP                      
         BNE   SAVCX                                                            
*                                                                               
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)        POINT TO ACCUM                               
         LHI   R4,MAXMOS                                                        
SAVC2    DS    0H                                                               
         L     R0,RETADSP(R7)                                                   
         LTR   R0,R0                                                            
         BZ    *+8                                                              
         BAS   RE,SAVCW                                                         
*                                                                               
         LA    R7,ROWL(R7)         NEXT MONTH                                   
         BCT   R4,SAVC2                                                         
*                                                                               
         GOTO1 BUFFALO,DMCB,=C'HIGH',ABUFFC,THISREC,0                           
         BRAS  RE,PCTMULT          APPLY REQUESTED PERCENT                      
*                                                                               
*                                  SET PRD LIN LIST FOR S PASS                  
         L     RE,APRD                                                          
         ZIC   RF,0(RE)                                                         
         A     RF,AINVTAB          USE INVTAB (FREE ON RETAIL RUNS)             
         MVI   0(RF),1             SET PRD ACTIVE                               
SAVCX    DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
SAVCW    NTR1                                                                   
*                                                                               
*                                                                               
*                                  THEN SAVE CURRENT INVOICE NUMBER             
*                                  IN BUFFALO TABLE                             
         L     R6,ABUFFC                                                        
         USING BUFFALOD,R6                                                      
         MVC   SORTREC,OLDREC      USE LAST RECORD                              
         LR    RF,R4                                                            
         SHI   RF,MAXMOS                                                        
         LPR   RF,RF                                                            
         MHI   RF,6                RF = BUFFALO 'MONTH'                         
         L     RE,APER                                                          
         STC   RF,0(RE)                                                         
         L     RF,AMKT             CLEAR MKT AND STA                            
         XC    0(2,RF),0(RF)                                                    
         L     RF,ASTA                                                          
*                                                                               
         L     RF,ASORTCOM                                                      
         MVC   0(2,RF),TODAYB      YEAR AND MONTH                               
         MVC   2(2,RF),INVNO       INV. NO.                                     
         L     RF,ASORTDTA                                                      
         XC    0(ROWTL,RF),0(RF)                                                
         MVC   0(24,RF),RETADSP(R7)  ACT,GROSS,NET                              
         MVI   BUFFDOPT,C'Y'       SET TO REPLACE COMMENT                       
*                                                                               
         BRAS  RE,TOSORT                                                        
         MVI   BUFFDOPT,C'N'                                                    
*                                                                               
SAVCWX   DS    0H                                                               
         B     SAVCX                                                            
         DROP  R6                                                               
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'TOTOUT - PRINT TOTALS FOR LEVEL'                                
TOTOUT   NMOD1 TOWORKQ,TOTOUT                                                   
         LR    R9,RC                                                            
         USING TOWORKD,R9                                                       
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         MVI   TOTSW,C'N'                                                       
*                                                                               
*                                  SET RETAIL STATUS TABLE ENTRY PNTR           
         L     RF,BRKCODE                                                       
         SRL   RF,2                                                             
         MHI   RF,RSTATTBL                                                      
         A     RF,=A(RSTATTB)                                                   
         ST    RF,ARSTATTB                                                      
*                                                                               
         XC    TOWORK,TOWORK                                                    
         C     R3,AINVBRK                                                       
         BNE   *+8                                                              
         MVI   TOTSW,C'Y'          SET HAVE PRINTED INV TOTS                    
         MVI   PRSW,C'M'           SET TO 'MERGE UP' LINES                      
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)      POINT TO ACCUM                                 
         CLI   PERCTL,C'T'                                                      
         BE    TOUT10                                                           
*                             SINGLE MONTH                                      
TOUT4    DS    0H                                                               
         AHI   R7,MAXMOS*ROWL      POINT TO TOTAL ROW                           
         L     RF,APER                                                          
         ZIC   R6,0(RF)                                                         
         ST    R6,PERLIND          SAVE A(PERLIST ENTRY)                        
         LA    R6,INVLIST(R6)      POINT TO INV NO FOR THIS MONTH               
         CLI   CTYPCTL,C'T'                                                     
         BE    TOUT7                                                            
*                                                                               
         BAS   RE,TSET                                                          
         LA    R7,WK                                                            
         GOTOR FMTAMT,DMCB,(R7),(R6)                                            
*                                                                               
         MVI   WIPRSW,0            CLEAR WILA SPECIAL PRINT SW                  
         MVI   WISTRIP,C'Y'        RESET WILA STRIP SWITCH                      
*                                                                               
         L     RF,=A(FMTLINS)                                                   
         OC    P,0(RF)                                                          
         OC    P2,132(RF)                                                       
         OC    P3,264(RF)                                                       
         OC    P4,396(RF)                                                       
         CLI   TAXSW,C'L'          TEST HAVE SEPARATE TAX LINE                  
         BNE   TOUT4D                                                           
         LA    RF,P2+13            FOR FOR FORMAT 1                             
         CLI   FORMAT,1                                                         
         BE    *+16                                                             
         CLI   FORMAT,2                                                         
         BE    *+8                                                              
         LA    RF,P2+24                                                         
         L     RE,=A(DICSECT)                                                   
         MVC   0(L'SP@TAX,RF),SP@TAX-DICSECT(RE)                                
         CLI   CCDETSW,C'Y'         IF DOING 2ND CURR DETAILS                   
         BNE   TOUT8                                                            
         LA    RF,P4+13            HAVE ANOTHER TAX LINE                        
         CLI   FORMAT,1                                                         
         BE    *+16                                                             
         CLI   FORMAT,2                                                         
         BE    *+8                                                              
         LA    RF,P4+24                                                         
         L     RE,=A(DICSECT)                                                   
         MVC   0(L'SP@TAX,RF),SP@TAX-DICSECT(RE)                                
*                                                                               
TOUT4D   DS    0H                                                               
         CLI   CCDETSW,C'Y'        2ND CURR DETS?                               
         BNE   TOUT8                                                            
         LA    RE,P2               WILL BE IN P2                                
         CLI   TAXSW,C'L'          IF NO TAX LINE                               
         BNE   *+8                                                              
         LA    RE,P3               ELSE IN P3                                   
         LA    RF,13(RE)                                                        
         CLI   FORMAT,1                                                         
         BE    *+16                                                             
         CLI   FORMAT,2                                                         
         BE    *+8                                                              
         LA    RF,24(RE)                                                        
         LA    R1,=CL10'U.S. FUNDS'                                             
         CLI   CURR2,C'U'                                                       
         BE    *+8                                                              
         LA    R1,=CL10'CAN. FUNDS'                                             
         MVC   0(10,RF),0(R1)                                                   
         B     TOUT8                                                            
*                                  TIME AND INTEGRATION 'TOGETHER'              
TOUT7    DS    0H   ***  NOTE- CODE FOR PRINTING TIME AND INT REMOVED**         
*                                                                               
TOUT8    DS    0H                                                               
         C     R3,AINVBRK                                                       
         BNE   *+16                                                             
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
         B     TOUTX                                                            
*                                                                               
         CLI   SPOTCTL,C'Y'                                                     
         BNE   TOUT9B                                                           
*                                                                               
         C     R3,ADESCBRK                                                      
         BE    *+8                                                              
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
         B     TOUTX                                                            
TOUT9B   DS    0H                                                               
         CLI   BRKCODE+3,STAEQ*4                                                
         BNL   *+8                                                              
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
         CLI   BRKCODE+3,STAEQ*4   AT STATION LAST                              
         BNL   TOUTXX              DONT FLUSH PRINT LINES                       
         B     TOUTX                                                            
*                                                                               
********************************************************************            
*              MULTI-MONTH                                                      
********************************************************************            
*                                                                               
TOUT10   DS    0H                                                               
         NI    TOTACT,X'FF'-X'80'  SET LOCAL TOTACT OFF                         
         OI    TOTACT,X'40'        BUT SET TOTOUT HAS BEEN CALLED               
         C     R3,ADESCBRK         TREAT SPOT DETAIL LINE AS                    
         BE    TOUT4               SINGLY MONTH FORMAT                          
         SR    R5,R5               R5 = INDEX INTO PERLIST                      
TOUT10A  DS    0H                                                               
         ST    R5,PERLIND          SAVE A(PERLIST ENTRY)                        
         LA    R6,P                                                             
         LA    R4,22(R6)           COL. FOR MONTH                               
         CLI   FORMAT,5                                                         
         BNL   *+8                                                              
         LA    R4,11(R6)                                                        
         CLI   FORMAT,0                                                         
         BNE   *+8                                                              
         LA    R4,40(R6)                                                        
         LR    RF,R4                                                            
         SHI   RF,2                                                             
         CLC   0(10,RF),SPACES     SEE IF CAN PRINT ON SAME LINE                
         BE    *+8                                                              
         BRAS  RE,PRNT                                                          
*                                                                               
         LA    R2,PERLIST(R5)      POINT TO MONTH                               
         USING PERLISTD,R2                                                      
         CLI   0(R2),X'FF'                                                      
         BNE   TOUT12                                                           
         CLI   RETPROF,0           IF RETAIL                                    
         BE    TOUT10D                                                          
         TM    TOTACT,X'80'        AND NO ACTIVE LINES                          
         BNZ   TOUT10D                                                          
*                                                                               
         BAS   RE,TFIX             MAY HAVE TO CLEAR UP SOME HIGHER             
         B     TOUTXX              LABELING PRINT LINES                         
*                                                                               
TOUT10D  DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         MVC   0(L'SP5TOTAL,R4),SP5TOTAL-DICSECT(RE)  TOTAL*                    
         MVI   L'SP5TOTAL(R4),C'*'                                              
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)                                                     
         AHI   R7,MAXMOS*ROWL      POINT TO TOTAL ROW                           
         B     TOUT14                                                           
TOUT12   DS    0H                                                               
         OC    0(ROWTL,R7),0(R7)    NO DATA                                     
         BNZ   *+14                                                             
         OC    ROWTL(ROWTL,R7),ROWTL(R7)   TRY SECOND AMOUNTS ALSO              
         BZ    TOUT15                                                           
*                                                                               
         CLI   RETPROF,0           IF RETAIL                                    
         BE    TOUT12D                                                          
         LR    RF,R5               TEST ACTIVE FOR MONTH                        
         SR    RE,RE                                                            
         D     RE,=F'6'                                                         
         A     RF,ARSTATTB                                                      
         CLI   0(RF),X'80'         ACTIVE                                       
         BNE   TOUT15                                                           
*                                                                               
         LA    RE,TOWORK           TOTAL UP ACTIVE MONTHS                       
         LR    RF,R7                                                            
         LHI   R0,ROWTL/4                                                       
*                                                                               
TOUT12C  DS    0H                                                               
         L     R1,0(RE)                                                         
         A     R1,0(RF)                                                         
         ST    R1,0(RE)                                                         
*                                                                               
         LA    RE,4(RE)                                                         
         LA    RF,4(RF)                                                         
         BCT   R0,TOUT12C                                                       
*                                                                               
TOUT12D  DS    0H                                                               
         CLI   SPOTPROF+2,0        TEST CALENDAR TYPE                           
         BNE   TOUT13                                                           
         GOTO1 DATCON,DMCB,(3,PERLMOS),(6,0(R4))    NORMAL = MMMYY              
         B     TOUT14                                                           
TOUT13   DS    0H                                                               
         GOTO1 DATCON,DMCB,(2,PERLSTRT),(5,0(R4))   OTHER = MMMDD/YY            
TOUT14   DS    0H                                                               
*                                                                               
         CLI   CTYPCTL,C'T'                                                     
         BE    TOUT14N                                                          
*                                                                               
         BAS   RE,TSET                                                          
         LA    R0,INVLIST(R5)                                                   
         GOTOR FMTAMT,DMCB,WK,(R0)                                              
         L     RF,=A(FMTLINS)                                                   
         OC    P,0(RF)                                                          
         OC    P2,132(RF)                                                       
         OC    P3,264(RF)                                                       
         OC    P4,396(RF)                                                       
         CLI   TAXSW,C'L'          TEST HAVE SEPARATE TAX LINE                  
         BNE   TOUT14D                                                          
         LA    RF,P2+13            FOR FOR FORMAT 1                             
         CLI   FORMAT,1                                                         
         BE    *+16                                                             
         CLI   FORMAT,2                                                         
         BE    *+8                                                              
         LA    RF,P2+24                                                         
         L     RE,=A(DICSECT)                                                   
         MVC   0(L'SP@TAX,RF),SP@TAX-DICSECT(RE)                                
*                                                                               
         CLI   CCDETSW,C'Y'        IF DOING 2ND CURR DETAILS                    
         BNE   TOUT14P                                                          
         LA    RF,P4+13            HAVE ANOTHER TAX LINE                        
         CLI   FORMAT,1                                                         
         BE    *+16                                                             
         CLI   FORMAT,2                                                         
         BE    *+8                                                              
         LA    RF,P4+24                                                         
         L     RE,=A(DICSECT)                                                   
         MVC   0(L'SP@TAX,RF),SP@TAX-DICSECT(RE)                                
*                                                                               
TOUT14D  DS    0H                                                               
         CLI   CCDETSW,C'Y'        2ND CURR DETS?                               
         BNE   TOUT14P                                                          
         LA    RE,P2               WILL BE IN P2                                
         CLI   TAXSW,C'L'          IF NO TAX LINE                               
         BNE   *+8                                                              
         LA    RE,P3               ELSE IN P3                                   
         LA    RF,13(RE)                                                        
         CLI   FORMAT,1                                                         
         BE    *+16                                                             
         CLI   FORMAT,2                                                         
         BE    *+8                                                              
         LA    RF,24(RE)                                                        
         LA    R1,=CL10'U.S. FUNDS'                                             
         CLI   CURR2,C'U'                                                       
         BE    *+8                                                              
         LA    R1,=CL10'CAN. FUNDS'                                             
         MVC   0(10,RF),0(R1)                                                   
         B     TOUT14P                                                          
*                                  TIME AND INTEGRATION 'TOGETHER'              
TOUT14N  DS    0H   *** NOTE- CODE FOR PRINTING TIME AND INT REMOVED**          
*                                                                               
TOUT14P  DS    0H                                                               
         MVI   SPACING,2                                                        
         CLI   0(R2),X'FF'                                                      
         BE    *+16                                                             
         CLI   CTYPCTL,C'T'                                                     
         BE    *+8                                                              
         MVI   SPACING,1                                                        
*                                                                               
         BRAS  RE,PRNT                                                          
         OI    TOTACT,X'A0'     SET SOME LINE ACTIVE (LOCAL+OVERALL)            
         CLI   0(R2),X'FF'                                                      
         BE    TOUTX                                                            
*                                                                               
TOUT15   DS    0H                                                               
         LA    R5,6(R5)            NEXT DATE                                    
         LA    R7,ROWL(R7)         NEXT DATA                                    
         B     TOUT10A                                                          
TOUTX    DS    0H                                                               
         MVI   PRSW,C'F'           SET TO FLUSH LINES                           
         BRAS  RE,PRNT                                                          
*                                                                               
TOUTXX   DS    0H                                                               
         MVI   WIPRSW,0            CLEAR WILA SPECIAL PRINT SW                  
         MVI   WISTRIP,C'Y'        RESET WILA STRIP SWITCH                      
*                                                                               
         XIT1                                                                   
*                                                                               
*********************************************************************           
*        TSET - SET COST IN WK                                                  
*********************************************************************           
*                                                                               
TSET     DS    0H                                                               
         MVC   WK(ROWTL),0(R7)    NORMALLY RETURN CUME                          
         CLI   RETPROF,0          BUT IF RETAIL                                 
         BER   RE                                                               
         CLI   0(R2),X'FF'        AND TOTAL LINE                                
         BNER  RE                                                               
         CLI   PERCTL,C'T'        AND MONTHS TOGETHER                           
         BNER  RE                                                               
         MVC   WK(ROWTL),TOWORK   RETURN ACTIVE MONTH TOTAL                     
         BR    RE                                                               
         DROP  R2                                                               
*                                                                               
*********************************************************************           
*        TFIX - CLEAR OUT SOME LABELLING PRINT LINES                            
*               IF NOT RETAIL OUTLET 'ACTIVE'                                   
*        NOTE- THIS IS A BIT SLOPPY. MAYBE HAVE TO CHECK MORE                   
*              THAN 8 POSITIONS, MAYBE THE THING I AM LOOKING                   
*              FOR GOT 'CHOPPED', THINGS MAY NOT ALWAYS BE WHERE                
*              I EXPECTED THEM, ETC...                                          
*        NOTE- R2 POINTS TO TEST SEARCHED FOR, R4 HAS LENGTH                    
*********************************************************************           
*                                                                               
TFIX     NTR1                                                                   
         L     RF,=A(LINTAB)       START OF PRINT LINE TABLE                    
*                                                                               
TFIX4    DS    0H                                                               
         C     RF,ANXTLIN          END                                          
         BNL   TFIXX                                                            
*                                                                               
         C     R3,AMKTBRK          MARKET                                       
         BE    TFIX10                                                           
         C     R3,AESTBRK          ESTIMATE                                     
         BE    TFIX20                                                           
         C     R3,APRDBRK          PRODUCT                                      
         BE    TFIX30                                                           
         B     TFIXX                                                            
*                                                                               
TFIX10   DS    0H                  MARKET LEVEL                                 
         L     RE,=A(DICSECT)                                                   
         LA    R2,SPAMKT-DICSECT(RE)  LOOK FOR WORD 'MARKET'                    
         LHI   R4,L'SPAMKT-1                                                    
         BAS   RE,TFIXLK                                                        
         BNE   TFIX90                                                           
         SHI   RF,132              THEN BACK UP TO GET MARKET NAME ALSO         
         MVC   0(132,RF),SPACES                                                 
         ST    RF,ANXTLIN      LOSE EVERYTHING AFTER                            
         B     TFIXX                                                            
*                                                                               
TFIX20   DS    0H                  ESTIMATE LEVEL                               
         L     RE,=A(DICSECT)                                                   
         LA    R2,SP@EST-DICSECT(RE)  LOOK FOR WORD 'ESTIMATE'                  
         LHI   R4,L'SP@EST-1                                                    
         BAS   RE,TFIXLK                                                        
         BNE   TFIX90                                                           
         ST    RF,ANXTLIN          LOSE EVERYTHING AFTER                        
         B     TFIXX                                                            
*                                                                               
TFIX30   DS    0H                  PRODUCT LEVEL                                
         L     RE,=A(DICSECT)                                                   
         LA    R2,SP@PRO-DICSECT(RE)  LOOK FOR WORD 'PRODUCT'                   
         LHI   R4,L'SP@PRO-1                                                    
         BAS   RE,TFIXLK                                                        
         BNE   TFIX90                                                           
         ST    RF,ANXTLIN          LOSE EVERYTHING AFTER                        
         B     TFIXX                                                            
*                                                                               
TFIX90   DS    0H                                                               
         LA    RF,132(RF)          NEXT LINE                                    
         B     TFIX4                                                            
*                                                                               
TFIXX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
*              LOOK THROUGH LINTAB FOR TEXT                                     
*        NOTE- R2 POINTS TO TEST SEARCHED FOR, R4 HAS LENGTH                    
TFIXLK   DS    0H                                                               
         LR    R5,RF               RF HAS LINE ADDRESS                          
         LHI   R0,8                LOOK OVER 8 POSITIONS                        
*                                                                               
TFIXLK4  DS    0H                                                               
         EX    R4,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R2),0(R5)       R2 HAS TEXT ADDRESS                          
         BE    TFIXLK8                                                          
         LA    R5,1(R5)                                                         
         BCT   R0,TFIXLK4                                                       
*                                                                               
         LTR   RE,RE               EXIT CC NOT =                                
         BR    RE                                                               
*                                                                               
TFIXLK8  DS    0H                  FOUND MATCH                                  
         MVC   0(132,RF),SPACES    CLEAR LINE                                   
         SR    R0,R0               AND EXIT WITH CC=                            
         BR    RE                                                               
         DROP  R9                                                               
         SPACE 2                                                                
         LTORG                                                                  
*                                                                               
TOWORKD  DSECT                                                                  
TOWORK   DS    XL(ROWTL)                                                        
TOWORKQ  EQU   *-TOWORK                                                         
         EJECT                                                                  
         TITLE 'AORINV - AOR INVOICE'                                           
SPB102   CSECT                                                                  
AORINV   NMOD1 AORQ,AORINV                                                      
         LR    R9,RC                                                            
         USING AORD,R9                                                          
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         CLI   AORSW,C'Y'          ANY AOR?                                     
         BNE   AOIX                DETAILS ON AOR INV                           
         CLI   SCBNCSW,C'N'        IF SCB SEP COMM MODE NET BILL                
         BE    AOIX                SKIP AOR                                     
         CLI   AORLOPT,C'N'        OPTION TO LIST PRD/EST/MOS                   
         BNE   AOI20               DETAILS ON AOR INV                           
*                                                                               
         L     R7,BRKCODE                 NO, CHECK ANY DATA                    
         L     R7,ATOTS(R7)               POINT TO ACCUM                        
         LR    RF,R7                                                            
         AHI   RF,TOTSIZE-BFORML                                                
         MVC   X(BFORML),0(RF)            SET FORMULA AND AOR PCT               
         AHI   R7,MAXMOS*ROWL      POINT TO TOTAL ROW                           
*                            NOTE- HAVE REPLACED SIMPLE TEST                    
*                                  FOR ANY AOR TOTAL WITH                       
*                                  PASS THROUGH PEPTAB LOOKING                  
         ICM   R6,15,PEPTABN       FOR ANY AOR ACCTS                            
         BZ    AOIX                                                             
         L     RF,APEPTAB                                                       
         USING PEPTD,RF                                                         
         MVI   BYTE,0                                                           
         XC    LASTAOVS,LASTAOVS                                                
*                                                                               
AOI3     DS    0H                                                               
         OC    PEPTAORA,PEPTAORA  TEST ANY ACCOUNT (NOT AMOUNT)                 
         BZ    AOI3P               NO, IGNORE                                   
         MVI   BYTE,1              YES, SET FOUND ONE                           
*                                  AND 'ROLL-UP' AOR VAT CODES                  
         LA    R4,LASTAOVS                                                      
         LA    R5,PEPTAOVS                                                      
         LHI   R0,NPROVS+1                                                      
*                                                                               
AOI3D    DS    0H                                                               
         CLI   0(R4),0             IF NO CODE YET                               
         BNE   *+14                                                             
         MVC   0(1,R4),0(R5)       JUST SAVE THIS ONE                           
         B     *+18                                                             
         CLC   0(1,R4),0(R5)       IS THIS ONE SAME AS SAVED?                   
         BE    *+8                 YES, OK                                      
         MVI   0(R4),X'FF'          NO SET MIXED                                
*                                                                               
         LA    R4,1(R4)            NEXT PROVINCE                                
         LA    R5,1(R5)                                                         
         BCT   R0,AOI3D                                                         
*                                                                               
AOI3P    DS    0H                                                               
         LA    RF,PEPTABRL(RF)     NEXT PEPTAB ENTRY                            
         BCT   R6,AOI3                                                          
*                                                                               
         CLI   BYTE,0              TEST ANY ACCOUNTS FOUND                      
         BE    AOIX                NO, DONE                                     
         DROP  RF                                                               
*                                                                               
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         MVI   DUESW,C'R'                                                       
*                                                                               
         LA    R2,P                                                             
         USING ALINED,R2                                                        
*                                                                               
* '**     AGENCY OF RECORD FEE FOR AMOUNT    **'                                
* '** BILLED TO CLIENT ON INVOICE NN-NN-NNNN *'                                 
         L     RE,=A(DICSECT)                                                   
         MVC   P+24(L'SP@AORF),SP@AORF-DICSECT(RE)                              
         MVC   P2+24(L'SP@BIL01),SP@BIL01-DICSECT(RE)                           
         MVC   P2+24+L'SP@BIL01+1(10),SPINVNO                                   
*                                                                               
         GOTO1 AGETNUM,DMCB,INVNO,PINVNO     GET NEXT BILL NO.                  
*                                                                               
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         L     RE,=A(DICSECT)  MEDIA GROSS FROM CLIENT INVOICE                  
         MVC   P+31(L'SP@MED01),SP@MED01-DICSECT(RE)                            
*                                                                               
         L     R0,RGRSD(R7)        GROSS                                        
         S     R0,RBGRSD(R7)                                                    
         LA    R5,ALCOL4                                                        
         CURED (R0),(16,0(R5)),CURTAB,COMMAS=YES,CR=YES                         
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         CLC   (BFAORPCT-BFORMD)+X,=X'FFFFFF'  IF MIXED PCTS, SKIP              
         BE    AOI7                                                             
         MVC   W,SPACES                                                         
         LA    R4,W                                                             
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,14,X+BFAORPCT-BFORMD                                          
         SRA   R0,8                                                             
         MVI   CURTAB+3,4          NN.NNNN                                      
         CURED (R0),(8,0(R4)),4,ALIGN=LEFT                                      
         MVI   CURTAB+3,2          RESTORE                                      
         CLC   6(2,R4),=C'00'                                                   
         BNE   *+14                                                             
         MVC   6(2,R4),=C'  '                                                   
         SHI   R0,2                                                             
         CLC   5(2,R4),=C'00'                                                   
         BNE   *+14                                                             
         MVC   5(2,R4),=C'  '                                                   
         SHI   R0,2                                                             
*                                                                               
         AR    R4,R0                                                            
         L     RE,=A(DICSECT)                                                   
         MVC   1(L'SPBPCTOA,R4),SPBPCTOA-DICSECT(RE)  PCT OF ABOVE              
         MVC   ALCOL4-25(24),W                                                  
*                                                                               
AOI7     DS    0H                                                               
         L     R0,AORDSP(R7)           AOR AMOUNT                               
         CLI   CLTCURR,0           IF DOING CLIENT CURRENCY                     
         BE    *+16                                                             
         CLI   PROFB2A+5,C'Y'      OR USING COST2 BASIS. . .                    
         BNE   *+8                                                              
         L     R0,AORDSP+4(R7)     USE IT                                       
*                                                                               
         LA    R5,ALCOL4                                                        
         CURED (R0),(16,0(R5)),CURTAB,COMMAS=YES,CR=YES                         
*                                                                               
         CLI   CVATCOD,0           IF HAVE VAT                                  
         BE    AOI17D                                                           
*                                                                               
         BRAS  RE,PRNT                                                          
         LA    R0,ALCOL4-ALINED   COLUMN FOR VAT AMOUNT                         
         GOTOR VBPRNT,DMCB,(C'A',SAVBRK),(R0),LASTAOVS,                +        
               AORDSP(R7),VATADSP(R7),0                                         
         MVC   TOTVAT,20(R1)       SAVE TOTAL OF VATS                           
*                                                                               
         LA    R2,P                                                             
         L     R0,AORDSP(R7)       AOR AMOUNT                                   
         A     R0,TOTVAT           PLUS TOTAL OF VATS                           
*                                                                               
         ST    R0,FULL                                                          
         GOTO1 ABILLEDI,DMCB,('EDMTDUE',0)                                      
         L     R0,FULL                                                          
*                                                                               
         LA    R5,ALCOL4                                                        
         CURED (R0),(16,0(R5)),CURTAB,COMMAS=YES,CR=YES                         
*                                                                               
AOI17D   DS    0H                                                               
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         BRAS  RE,SETCURN          GET CURRENCY ID                              
         CLI   0(R1),C' '          NONE RETURNED                                
         BNH   *+18                                                             
         MVC   ALCOL4-20(20),0(R1)                                              
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         BRAS  RE,BILLBOX                                                       
*                                                                               
         CLI   QTRADE,C'T'         TRADE?                                       
         BNE   *+14                                                             
         MVC   P1(8),=C'** PE **'                                               
         BRAS  RE,PRNT                                                          
*                                                                               
         CLI   WPPOPT,C'Y'                                                      
         BNE   *+8                                                              
         BRAS  RE,PRTWCOM                                                       
*                                                                               
         BRAS  RE,WOBILL                                                        
*                                                                               
         B     AOIX                                                             
         EJECT                                                                  
***********************************************************************         
*        PRD/EST/MOS LISTING ON AOR BILLS                                       
*                                                                               
*      NOTE- THIS CODE HAS SPECIAL CODE FOR THE 'LABATT'S OPTION' WHICH         
*      INCLUDES SHOWING MARKET GROUPS AND SUBSTITUTING TAX FOR BASIS.           
*      MORE MAY BE REQUIRED.                                                    
*      SIMILAR CODE COULD BE INCLUDED TO SHOW MARKET NAME IF THAT IS            
*      EVER REQUIRED. MARKET CODE IS KEPT IN THE PEPTAB                         
*                                                                               
***********************************************************************         
         SPACE 1                                                                
AOI20    DS    0H                                                               
         MVI   AORFRST,C'Y'                                                     
         CLI   AORLOPT,C'C'        IF CLIENT LEVEL AOR RECAP                    
         BNE   *+12                                                             
         CLI   AORLCTL,C'P'        AND NOT PRINT MODE                           
         BNE   AOIX                DO NOTHING NOW                               
*                                                                               
         ICM   R6,15,PEPTABN       SORT PEPTAB ON AOR ACCT                      
         BZ    AOIX                                                             
         L     R7,APEPTAB                                                       
         USING PEPTD,R7                                                         
*                     *** NOTE- USING XSORTL FOR LONG RECORDS                   
         GOTO1 =V(XSORTL),DMCB,(R7),(R6),PEPTABRL,                     +        
               L'PEPTAORA+L'PEPTAOVS,PEPTAORA-PEPTD                             
*                                                                               
         XC    LASTAORA,LASTAORA                                                
         XC    LASTAOVS,LASTAOVS                                                
         XC    LASTMGR,LASTMGR                                                  
*                                                                               
AOI30    DS    0H                                                               
         OC    PEPTAORA,PEPTAORA   SKIP IF NO AOR ACCOUNT                       
         BZ    AOI70                                                            
         CLC   PEPTAORA,LASTAORA   NEW AOR ACCT = NEW BILL                      
         BNE   AOI40                                                            
         OC    PEPTAOVS,SPACES                                                  
         CLC   PEPTAOVS,LASTAOVS   NEW GST STATUS = NEW BILL                    
         BE    AOI60                                                            
*                                  FINISH UP OLD BILL                           
*                                                                               
AOI40    DS    0H                                                               
         OC    LASTAORA,LASTAORA     NOT IF FIRST TIME                          
         BZ    AOI44                                                            
         BRAS  RE,PRNT                                                          
         LA    R2,P                RESSET TO FIRST P                            
         BRAS  RE,SETCURN          GET CURRENCY DESCRIPTION                     
         MVC   ALDESC(20),0(R1)                                                 
         L     RE,=A(DICSECT)                                                   
         MVC   ALCOL1+8(L'SP7TOTAL),SP7TOTAL-DICSECT(RE)  TOTALS*               
         L     R0,X                TOTAL GROSS (OR NET)                         
         LA    R5,ALCOL2                                                        
         CURED (R0),(16,0(R5)),CURTAB,COMMAS=YES,CR=YES                         
         L     R0,X+8              TOTAL AOR                                    
         LA    R5,ALCOL4                                                        
         CURED (R0),(16,0(R5)),CURTAB,COMMAS=YES,CR=YES                         
*                                                                               
         CLI   CVATCOD,0           TEST HAVE VAT (**?? IS THIS TEST             
         BE    AOI42               NO, SKIP      APPROPRIATE/NECESSARY)         
         CLI   LASTAORV,C' '       YES, ALSO SKIP IF NO                         
         BNH   AOI42               VAT FOR 'OTHER AGENCY'                       
*                                                                               
         BRAS  RE,PRNT                                                          
         LA    R0,ALCOL4-ALINED   COLUMN FOR VAT AMOUNT                         
         CLI   PROFB2A+5,C'Y'     AOR ON COST2?                                 
         BNE   AOI41                                                            
*                                                                               
*        X+20 TO GET TO COST2 AOR VATS                                          
*                                                                               
         GOTOR VBPRNT,DMCB,(C'A',SAVBRK),(R0),LASTAOVS,X+8,X+20,0               
         B     AOI41X                                                           
AOI41    GOTOR VBPRNT,DMCB,(C'A',SAVBRK),(R0),LASTAOVS,X+8,X+16,0               
*                                  (VAT BASIS AND PROVINCIAL AMTS)              
AOI41X   MVC   TOTVAT,20(R1)       SAVE TOTAL OF VATS                           
*                                                                               
         LA    R2,132(R2)                                                       
         L     R0,X+8              AOR                                          
*                                                                               
         A     R0,TOTVAT           PLUS TOTAL OF VATS                           
*                                                                               
         ST    R0,FULL                                                          
         GOTO1 ABILLEDI,DMCB,('EDMTDUE',0)                                      
         L     R0,FULL                                                          
*                                                                               
         LA    R5,ALCOL4                                                        
         CURED (R0),(16,0(R5)),CURTAB,COMMAS=YES,CR=YES                         
*                                                                               
AOI42    DS    0H                                                               
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
         BRAS  RE,BILLBOX                                                       
AOI44    DS    0H                                                               
         LTR   R6,R6               END OF TABLE                                 
         BNP   AOI80                                                            
*                                                                               
*                                  START NEW BILL                               
         MVC   LASTAORA,PEPTAORA                                                
         MVC   LASTAOVS,PEPTAOVS   SAVE VAT CODES                               
         OC    LASTAOVS,SPACES                                                  
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         MVI   DUESW,C'R'                                                       
         XC    X,X                 CLEAR TOTALS                                 
*                                                                               
         LA    R2,P                                                             
*                                  SET AOR ADDRESS                              
         L     RF,=A(STABUCKC)     USE STATION BUCKET AREA                      
         ST    RF,AREC                                                          
         MVC   KEY+14(4),PEPTAORD  DISK ADDRESS                                 
         CLI   KEY,X'0A'           TRY TO CATCH BUG THAT CAUSES                 
         BNE   *+8                 TRAFFIC FILE READ INSTEAD OF SPOT            
         MVI   KEY,0                                                            
*                                                                               
         GOTO1 GET                                                              
         L     RF,AREC                                                          
         USING AORREC,RF                                                        
*                                                                               
         LA    R1,AORELS                                                        
*                                                                               
AOI52    DS    0H                                                               
         CLI   0(R1),X'02'         ADDRESS ELEM                                 
         BE    AOI53                                                            
         CLI   0(R1),0             EOR                                          
         BE    AOI55                                                            
*                                                                               
         ZIC   R0,1(R1)                                                         
         AR    R1,R0                                                            
         B     AOI52                                                            
*                                                                               
AOI53    DS    0H                  AOR ADDRESS ELEM                             
         USING AORADREL,R1                                                      
         L     RE,=A(AORADDR)                                                   
         MVC   000(30,RE),AORLIN1                                               
         MVC   060(30,RE),AORLIN2                                               
         MVC   120(30,RE),AORLIN3                                               
         MVC   180(30,RE),AORLIN4                                               
         CLC   PEPTAORA,0(RE)               UNLESS ACCOUNT CODE =               
         BE    *+10                         AGENCY NAME                         
         MVC   216+60-14(14,RE),PEPTAORA    ACCT CODE AT END OF ADDR            
         DROP  RF                                                               
         DROP  R1                                                               
*                                                                               
AOI55    DS    0H                                                               
         L     RE,=A(DICSECT)  ** AGENCY OF RECORD PAYMENTS **                  
         MVC   P+2(L'SP@AORP),SP@AORP-DICSECT(RE)                               
         CLI   AORLOPT,C'C'        UNLESS CLIENT LEVEL RECAP                    
         BE    AOI55D                                                           
         LA    RF,P+2+L'SP@AORP  CLIENT INVOICE NUMBER NN-NN-NNNN **            
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   3(L'SP@CINO,RF),SP@CINO-DICSECT(RE)                              
         LA    RF,3+L'SP@CINO(RF)                                               
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   2(10,RF),SPINVNO                                                 
*                                                                               
AOI55D   DS    0H                                                               
         CLI   AORLOPT,C'C'        FOR CLIENT RECAP MODE                        
         BNE   *+12                                                             
         CLI   AORFRST,C'Y'        AND FIRST TIME                               
         BE    AOI56               ALREADY HAVE NEW INVOICE NUMBER              
*                                                                               
         GOTO1 AGETNUM,DMCB,INVNO,PINVNO     GET NEXT BILL NO.                  
*                                                                               
AOI56    DS    0H                                                               
         MVI   AORFRST,C'N'                                                     
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
AOI60    DS    0H                  CONTINUE BILL                                
         LA    R2,P                RESET TO FIRST PRINT LINE                    
         MVC   PEPTAORI,INVNO      SET INVOICE NUMBER IN PEPTAB                 
*                                                                               
         CLC   PEPTMGR,LASTMGR     MGR CHANGE (LABATT'S MODE)                   
         BE    AOI61                                                            
         MVC   LASTMGR,PEPTMGR                                                  
         MVI   0(R2),0             SKIP A LINE BEFORE                           
         LA    R2,132(R2)                                                       
         MVC   ALDESC(2),=C'**'                                                 
         MVC   ALDESC+3(24),PEPTMGRN                                            
         LA    RF,ALDESC+27                                                     
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   2(2,RF),=C'**'                                                   
         MVI   132(R2),0           SKIP A LINE                                  
         LA    R2,264(R2)                                                       
*                                                                               
AOI61    DS    0H                                                               
         ZIC   RF,PEPTPRD          PRODUCT                                      
         MHI   RF,4                                                             
         L     RE,ADCLT                                                         
         LA    R4,CLIST-CLTHDR(RE,RF)                                           
*                                                                               
         L     RF,ADCLT                                                         
         MVC   KEY(13),0(RF)                                                    
         MVC   KEY+4(3),0(R4)      3 CHAR PRD CODE                              
         L     RF,ADPRD                                                         
         CLC   KEY(13),0(RF)       TEST ALREADY HAVE PRDHDR                     
         BE    AOI62                                                            
         GOTO1 READ                                                             
         GOTO1 GETPRD                                                           
*                                                                               
AOI62    DS    0H                                                               
         MVC   ALDESC(3),PRD                                                    
         GOTO1 CHOPPER,DMCB,(24,PRDNM),(16,ALDESC+4),(C'P',2)                   
*                                                                               
         EDIT  PEPTEST,(3,ALCOL1+1),FILL=0                                      
         GOTO1 DATCON,DMCB,(3,PEPTMOS),(6,ALCOL1+8)                             
*                                                                               
         SR    R4,R4               USE R4 AS INDEXREG FOR CURRENCY              
         CLI   CLTCURR,0           0 = AGENCY CURRENCY                          
         BE    *+16                                                             
         CLI   PROFB2A+5,C'Y'      OR USING COST2 BASIS. . .                    
         BNE   *+8                                                              
         LHI   R4,4                4 = CLIENT CURRENCY                          
*                                                                               
         L     R0,PEPTGRS(R4)      TOTAL GROSS                                  
*                                                                               
         CLI   AORNOPT,C'Y'        SHOWING NET INSTEAD?                         
         BNE   *+8                                                              
         L     R0,PEPTNET(R4)      TOTAL NET                                    
*                                                                               
         CLI   AORTXOPT,C'Y'       TEST TO INCLUDE TAX                          
         BE    *+8                                                              
         S     R0,PEPTTAX          NO, REMOVE IT                                
         A     R0,X                                                             
         ST    R0,X                                                             
         L     R0,PEPTAOR(R4)      AOR AMOUNT                                   
         A     R0,X+8                                                           
         ST    R0,X+8                                                           
*                                  PROVINCIAL VAT AMOUNTS                       
         LHI   R1,NPROVS+1                                                      
         LA    RE,PEPTVATA(R4)                                                  
         LA    RF,X+16(R4)                                                      
*                                                                               
AOI63    DS    0H                                                               
         L     R0,0(RE)                                                         
         A     R0,0(RF)                                                         
         ST    R0,0(RF)                                                         
         LA    RE,8(RE)                                                         
         LA    RF,8(RF)                                                         
         BCT   R1,AOI63                                                         
*                                                                               
         L     R0,PEPTGRS(R4)      GROSS                                        
         CLI   AORNOPT,C'Y'        SHOWING NET INSTEAD?                         
         BNE   *+8                                                              
         L     R0,PEPTNET(R4)                                                   
*                                                                               
         CLI   AORTXOPT,C'Y'       TEST TO INCLUDE TAX                          
         BE    *+8                                                              
         S     R0,PEPTTAX          NO, REMOVE IT                                
         LA    R5,ALCOL2                                                        
         CURED (R0),(16,0(R5)),CURTAB,COMMAS=YES,CR=YES                         
*                                                                               
         L     R0,PEPTAOR(R4)     AOR AMOUNT                                    
         LA    R5,ALCOL4                                                        
         CURED (R0),(16,0(R5)),CURTAB,COMMAS=YES,CR=YES                         
*                                                                               
         ICM   R0,15,PEPTAORP         AOR PERCENT                               
         LA    R5,ALCOL3                                                        
         MVI   CURTAB+3,4          NN.NNNN                                      
         CURED (R0),(8,0(R5)),4                                                 
         MVI   CURTAB+3,2          RESTORE                                      
         CLC   6(2,R5),=C'00'                                                   
         BNE   *+10                                                             
         MVC   6(2,R5),SPACES                                                   
         LA    R5,9(R5)                                                         
*                                                                               
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
*                                                                               
         MVC   0(L'SP@GROSS,R5),SP@GROSS    BASIS                               
         L     R0,PEPTGRS(R4)                                                   
         TM    PEPTAORB,X'F0'      NO BITS MEANS GROSS                          
         BZ    AOI64                                                            
         MVC   0(5,R5),SPACES                                                   
         MVC   0(L'SP@NET,R5),SP@NET                                            
         L     R0,PEPTNET(R4)                                                   
         TM    PEPTAORB,X'40'                                                   
         BNZ   AOI64                                                            
         MVC   0(L'SPACOMM,R5),SPACOMM                                          
         DROP  RE                                                               
         L     R0,PEPTGRS(R4)                                                   
         S     R0,PEPTNET(R4)                                                   
         B     AOI65                                                            
*                                                                               
AOI64    DS    0H                                                               
         CLI   AORTXOPT,C'Y'       TEST TO INCLUDE TAX                          
         BE    *+8                                                              
         S     R0,PEPTTAX          NO, REMOVE IT                                
*                                                                               
AOI65    DS    0H                                                               
         LA    R5,ALSTRIP          BASIS AMOUNT IN STRIP                        
         CURED (R0),(16,0(R5)),CURTAB,COMMAS=YES,CR=YES                         
*                                                                               
         BRAS  RE,PRNT                                                          
*                                                                               
AOI70    DS    0H                  NEXT PEPTAB ENTRY                            
         LA    R7,PEPTABRL(R7)                                                  
         BCT   R6,AOI30                                                         
         B     AOI40               AT END FINISH UP                             
*                                                                               
AOI80    DS    0H                  END                                          
*                                                                               
         OC    LASTAORA,LASTAORA   NO AOR - NO COMMENT                          
         BZ    AOI90                                                            
*                                                                               
         CLI   QTRADE,C'T'         TRADE?                                       
         BNE   *+14                                                             
         MVC   P1(8),=C'** PE **'                                               
         BRAS  RE,PRNT                                                          
*                                                                               
         CLI   WPPOPT,C'Y'                                                      
         BNE   *+8                                                              
         BRAS  RE,PRTWCOM                                                       
*                                                                               
AOI90    BRAS  RE,WOBILL                                                        
         MVI   DUESW,C'N'                                                       
         CLI   AORLOPT,C'C'        IF DOING 'CLIENT' SUMMARY                    
         BNE   AOIX                                                             
         OC    LASTAORA,LASTAORA   AND ACTUALL DID SOMETHING                    
         BZ    AOIX                                                             
         GOTO1 AGETNUM,DMCB,INVNO,PINVNO  NEED TO BUMP INVOICE NO               
         B     AOIX                                                             
         SPACE 2                                                                
AOIX     DS    0H                                                               
         XIT1                                                                   
         DROP  R7                                                               
         DROP  R2                                                               
         DROP  R9                                                               
         LTORG                                                                  
AORD     DSECT                                                                  
LASTAORA DS    CL14                                                             
AORQ     EQU   *-AORD                                                           
         EJECT                                                                  
         TITLE 'PRTADJ - PRINT ADJUSTMENTS'                                     
SPB102   CSECT                                                                  
PRTADJ   NMOD1 0,PRTADJ                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         ST    R3,SAVBRK           SAVE R3 = A(BREAK)                           
         CLI   PASSNO,1            ONLY PASS 1                                  
         BNE   PAX                                                              
*                                                                               
         CLI   RETPROF,0           IF RETAIL                                    
         BE    PA03                                                             
         CLI   PERCTL,C'T'         AND MULTI-MONTH                              
         BNE   PA03                                                             
         TM    TOTACT,X'80'        IF TOTOUT CAME UP WITH NOTHING               
         BZ    PAX                 SKIP PRTADJ                                  
*                                                                               
PA03     DS    0H                                                               
         MVI   SINGCOL,C'Y'        SINGLE COLUMN FORMAT                         
         CLI   FORMAT,8            GROSS ORDERED                                
         BE    *+16                                                             
         CLI   FORMAT,11           BILLABLE                                     
         BE    *+8                                                              
         MVI   SINGCOL,C'N'                                                     
*                                                                               
         CLC   SAVBRK,AINVBRK          IF INV BRK                               
         BE    PA2                                                              
         CLI   FORMAT,10           IF ORDERED ONLY FORMAT  PRINT                
         BNH   *+12                ADJ ONLY IF END OF INV                       
         CLI   RETDRAFT,C'Y'       UNLESS RETAIL DRAFT                          
         BNE   PAX                                                              
*                                                                               
         ZIC   RF,NDUES            COUNT NO OF DUE LINES PRINTED                
         AHI   RF,1                                                             
         STC   RF,NDUES                                                         
         B     PA3                                                              
PA2      DS    0H                                                               
         MVI   DUESW,C'Y'          SET HAVE PRINTED AMOUNT DUE                  
         CLI   FORMAT,10           IF FORMAT 11+ (ORDERED ONLY)                 
         BNH   PA3                                                              
         BRAS  RE,LSTINV           NEED PREVIOUS BILLING                        
*                                                                               
PA3      DS    0H                                                               
         MVI   PRSW,C'H'           SET TO HOLD PRINT LINES                      
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)           POINT TO ACCUM                            
         LR    R4,R7                                                            
         AHI   R4,TOTSIZE-BFORML   POINT TO FORMULA                             
         AHI   R7,MAXMOS*ROWL      POINT TO TOTAL ROW                           
         MVC   WKROW+000(256),000(R7)   PUT WHOLE ROW IN WKROW                  
         MVC   WKROW+256(256),256(R7)                                           
         MVC   WKROW+512(L'WKROW-512),512(R7)                                   
         LA    R7,WKROW                                                         
*                                                                               
         SR    R6,R6             **NOTE- R6 USED AS INDEX REG FOR CURR          
         CLI   CLTCURR,0         0 = MAIN CURRENCY                              
         BE    *+8                                                              
         LHI   R6,4              4 = CLIENT CURRENCY                            
*                                                                               
         CLI   RETPROF,0         FOR RETAIL                                     
         BE    PA3A                                                             
         LHI   R6,4              USE 2ND CURR FOR 'ACTIVE MONTH TOTS'           
*                                                                               
         CLI   UPASS,C'S'        BUT FOR SUMMARY PASS GO BACK TO                
         BNE   *+6               FIRSTS (2NDS DON'T GET SET                     
         SR    R6,R6             PROPERLY IN BILCALC                            
*                                                                               
PA3A     DS    0H                                                               
         USING BFORMD,R4                                                        
         MVC   CVATSWS,BFVATSWS    VATABLE SWITCHES                             
*                                  (0=NO,Y=YES,FF=MIXED)                        
         LA    R2,P                                                             
         CLI   SINGCOL,C'Y'        FOR SINGLE COL FORMATS                       
         BNE   *+8                                                              
         SHI   R2,16               SHIFT AMOUNTS LEFT ONE COL                   
         USING ALINED,R2                                                        
         CLC   SAVBRK,AINVBRK      IF AT END OF INVOICE                         
         BNE   *+12                                                             
         CLI   NDUES,1             AND EXACTLY 1 DUE LEVEL PRINTED              
         BE    PA20                DO NOT REPEAT FORMULA                        
*                                                                               
*                                  STATE BASIS IF NOT ON BILL                   
         CLI   BFBAS,X'FF'                                                      
         BE    PA20                UNEQUAL BASES                                
         OC    BFBAS(5),BFBAS      WHOLE BILL FORMULA IS 0 ?                    
         BZ    PA20                                                             
         XC    FULL,FULL           WILL HOLD CALULATED NET FOR MTRADE           
         CLI   GNSW,C'G'           GROSS                                        
         BNE   *+16                                                             
         TM    BFBAS,X'10'         AND GROSS                                    
         BZ    PA8                 OK                                           
         B     *+12                                                             
         TM    BFBAS,X'10'                                                      
         BNZ   PA8                 NET AND NET OK                               
*                                                                               
*                                  BASIS NOT ON BILL                            
         L     RE,=A(DICSECT)                                                   
         MVC   ALCOL4-11(L'SP@NETAM),SP@NETAM-DICSECT(RE) NET AMOUNT            
         LA    R5,RNETD(R7,R6)                                                  
         TM    BFBAS,X'10'                                                      
         BNZ   *+14                                                             
         MVC   ALCOL4-13(L'SP@GRSAM),SP@GRSAM-DICSECT(RE) GROSS AMOUNT          
         LA    R5,RGRSD(R7,R6)                                                  
*&&DO                                                                           
         CLI   QTRADE,C'T'         IF MTRADE                                    
         BNE   PA4                                                              
         TM    BFBAS,X'10'         AND BASIS IS NET                             
         BZ    PA4                                                              
         LHI   RF,100              NORMAL 85 NET                                
         LHI   RE,85                                                            
         LA    R5,RGRSD(R7,R6)     DERIVE FROM GROSS                            
         L     R1,0(R5)                                                         
         S     R1,ROWHL(R5)                                                     
         MR    R0,RE                                                            
         DR    R0,RF                                                            
         LR    R0,R1                                                            
         ST    R0,FULL                                                          
         B     *+12                                                             
*&&                                                                             
PA4      L     R0,0(R5)                                                         
         S     R0,ROWHL(R5)                                                     
*                                                                               
         CURED (R0),(16,ALCOL4),CURTAB,COMMAS=YES,CR=YES                        
         MVI   148(R2),0                                                        
         LA    R2,264(R2)                                                       
*                                                                               
*                             PRINT ADJUSTMENT LINE                             
*                             LESS (PLUS) XX.XXXX PERCENT OF GROSS(NET)         
*                                                                               
PA8      DS    0H                                                               
         OC    BFCOMP,BFCOMP       NO ADJUSTMENT                                
         BZ    PA20                                                             
         CLI   UPASS,C'S'          NO FORMULA ON RETAIL SUMMARY                 
         BE    PA20                                                             
         CLI   ADJSEP,C'Y'         ADJUSTMENT ON SEP INV                        
         BE    PA20                                                             
*                                                                               
         MVC   W,SPACES                                                         
         XC    WK,WK                                                            
         MVC   BYTE,BFCOMP         USE SIGN OF FORMULA                          
*&&DO                                                                           
         CLI   QTRADE,C'T'                                                      
         BNE   PA8A                                                             
         CLC   BFCOMP,=X'FFFFFFFF' UNLESS UNEQUAL FORMULAS                      
         BE    PA8A                                                             
         MVC   WK(5),BFBAS         FIND CASH BILLFORM                           
         GOTO1 BINSRCH,BFRPARS,WK                                               
         CLI   0(R1),1                                                          
         BNE   *+6                 NOT IN BFRTAB                                
         DC    H'0'                                                             
         L     RF,0(R1)                                                         
         MVC   WK(5),5(RF)         STORE CASH FORMULA                           
         OC    WK+1(4),WK+1        NO ADJUSTMENT ?                              
         BZ    PA20                                                             
         MVC   WK+5(5),BFBAS       SAVE TRADE FORMULA                           
         MVC   BFBAS(5),WK                                                      
         MVC   BYTE,BFCOMP                                                      
*&&                                                                             
PA8A     CLC   BFCOMP,=X'FFFFFFFF' UNLESS UNEQUAL FORMULAS                      
         BNE   *+14                                                             
         LA    RF,ADJDSP(R7,R6)    THEN USE SIGN OF ADJ AMOUNT                  
         MVC   BYTE,0(RF)                                                       
*                                                                               
*                                                                               
         L     RE,=A(DICSECT)                                                   
*                                                                               
         MVC   W(L'SP@LESS),SP@LESS-DICSECT(RE)                                 
         LA    RF,W+L'SP@LESS+1                                                 
         TM    BYTE,X'80'                                                       
         BNZ   PA8B                                                             
         MVC   W,SPACES                                                         
         MVC   W(L'SP@PLUS),SP@PLUS-DICSECT(RE)                                 
         LA    RF,W+L'SP@PLUS+1                                                 
*                                                                               
PA8B     DS    0H                                                               
         CLI   PROFB2B+4,C'Y'      SEE IF TO SAY JUST 'COMMISSION'              
         BE    PA8C                                                             
         CLI   PROFB2B+4,C'J'      SAY 'COMMISSION ADJUSTMENT'?                 
         BE    PA8CA                                                            
*                                                                               
         CLC   BFCOMP,=X'FFFFFFFF'                                              
         BNE   PA8D                                                             
         MVC   0(L'SPBADJ,RF),SPBADJ-DICSECT(RE) ADJUSTMENT                     
         B     PA12                                                             
*                                                                               
PA8C     DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         MVC   W(L'SP@CMAMT),SP@CMAMT-DICSECT(RE)                               
         B     PA12                                                             
*                                                                               
PA8CA    L     RE,=A(DICSECT)                                                   
         MVC   W(L'SP@COMAJ),SP@COMAJ-DICSECT(RE)                               
         B     PA12                                                             
*                                                                               
PA8D     DS    0H                                                               
         MVI   CURTAB+3,4          NN.NNNN                                      
         CURED (B4,BFCOMP),(8,W+5),4                                            
         MVI   CURTAB+3,2          RESTORE                                      
         LA    RF,W+12                                                          
PA9      DS    0H                                                               
         CLI   0(RF),C'0'                                                       
         BNE   *+12                                                             
         MVI   0(RF),C' '                                                       
         BCT   RF,PA9                                                           
*                                                                               
         CLI   0(RF),C'.'                                                       
         BNE   *+10                                                             
         MVI   0(RF),C' '                                                       
         BCTR  RF,0                                                             
*                                                                               
         L     RE,=A(DICSECT)                                                   
         MVC   2(L'SP@PCNOF,RF),SP@PCNOF-DICSECT(RE) PERCENT OF                 
         LA    RF,L'SP@PCNOF+2(RF)                                              
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         MVC   2(L'SP@NET,RF),SP@NET-DICSECT(RE)                                
         TM    BFBAS,X'01'                                                      
         BNZ   *+10                                                             
         MVC   2(L'SP@GROSS,RF),SP@GROSS-DICSECT(RE)                            
*                                                                               
*        CLI   QTRADE,C'T'                                                      
*        BNE   *+20                                                             
*        CLC   BFCOMP,=X'FFFFFFFF'                                              
*        BE    *+10                                                             
*        MVC   BFBAS(5),WK+5       IF MTRADE AND ACT FORMULA RESTOR IT          
*                      SEE IF NEED TAX IN ADJUSTMENT EXPRESSION                 
         CLI   TAXOPT,C'N'                                                      
         BE    PA12                                                             
         CLI   UPASS,C'S'          NO TAX ON SUMMARY                            
         BE    PA12                                                             
         L     RE,RTAXD(R7,R6)                                                  
         S     RE,RBTAXD(R7,R6)                                                 
         BZ    PA12                NO TAX                                       
         LA    RF,L'SP@GROSS+2(RF)                                              
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         L     RE,=A(DICSECT)                                                   
         MVC   2(L'SP@LSTAX,RF),SP@LSTAX-DICSECT(RE)                            
*                                                                               
PA12     DS    0H                                                               
         LA    RF,W+40                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R0,W                                                             
         SR    RF,R0               RF = LENGTH - 1                              
         LA    RE,ALCOL4-2                                                      
         SR    RE,RF                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),W                                                        
*&&DO                                                                           
         CLI   QTRADE,C'T'         MTRADE?                                      
         BNE   PA14                                                             
         CLC   BFCOMP,=X'FFFFFFFF'                                              
         BE    PA14                DON'T MESS W/ COMMISSION                     
         L     R0,DUEDSP(R7,R6)    CALC COMMIS AS DUE-NET                       
         S     R0,FULL                                                          
         B     *+8                                                              
*&&                                                                             
PA14     L     R0,ADJDSP(R7,R6)                                                 
         CURED (R0),(16,ALCOL4),CURTAB,COMMAS=YES,CR=YES                        
         MVI   148(R2),0                                                        
         LA    R2,264(R2)                                                       
*                                  PRINT AMOUNT DUE                             
*                                                                               
PA20     DS    0H                                                               
         CLC   SAVBRK,AINVBRK                                                   
         BE    PA22                                                             
         CLC   SAVBRK,APRDBRK      FOR PRODUCT (MULTI PROD ON                   
         BNE   *+12                ONE BILL ONLY)                               
         CLI   CVATCOD,0           IF DOING GST                                 
         BNE   PA22                PRINT AMOUNT DUE FOR ...                     
*                                                                               
         LA    R0,P                IF NOT END OF INV                            
         CR    R2,R0               AND NO ADJ OR SPECIAL BASE                   
         BH    PA22                                                             
         CLI   SCBNCSW,C'C'        AND NOT SEP COMMISSION                       
         BNE   PA27C               SKIP DUE PRINT                               
*                                                                               
PA22     DS    0H                                                               
*                                                                               
         CLI   MIDAS,C'Y'          FOR MIDAS PRINT TRADE CREDIT                 
         BNE   PA22K                                                            
         L     R0,TRDCDSP(R7)                                                   
         LTR   R0,R0                                                            
         BZ    PA22K                                                            
         MVC   ALCOL4-20(17),=C'LESS TRADE CREDIT'                              
         CURED (R0),(16,ALCOL4),CURTAB,COMMAS=YES,CR=YES                        
         MVI   148(R2),0                                                        
         LA    R2,264(R2)                                                       
*                                                                               
PA22K    DS    0H                                                               
         L     R0,DUEDSP(R7,R6)        DUE                                      
*                                                                               
         L     R5,=A(DICSECT)                                                   
         USING DICSECT,R5                                                       
*                                                                               
         CLI   ADJSEP,C'Y'         IF ADJ ON SEP INV                            
         BNE   PA23                                                             
         L     RF,ADJDSP(R7,R6)        THEN PRINT DUE -/+ ADJ HERE              
         SR    R0,RF                                                            
*&&DO                                                                           
         CLI   QTRADE,C'T'         IF MTRADE NEED TO SHOW NET                   
         BNE   PA23                                                             
         LA    RE,RGRSD(R7,R6)     DERIVE FROM GROSS                            
         L     R1,0(RE)                                                         
         S     R1,ROWHL(RE)                                                     
         LHI   RF,100              NORMAL 85 NET                                
         LHI   RE,85                                                            
         MR    R0,RE                                                            
         DR    R0,RF                                                            
         LR    R0,R1                                                            
*&&                                                                             
PA23     CURED (R0),(16,ALCOL4),CURTAB,COMMAS=YES,CR=YES                        
         CLI   DOLSOPT,C'Y'                                                     
         BNE   PA24                                                             
*        FLOAT=$ DOES NOT SEEM TO WORK WITH CURED  (CUREDIT)                    
*                                                                               
         LA    R1,ALCOL4-1                                                      
PA23C    CLI   1(R1),C' '     FIND FIRST NON-SPACE                              
         BH    PA23F                                                            
         LA    R1,1(R1)                                                         
         B     PA23C                                                            
*                                                                               
PA23F    MVI   0(R1),C'$'     FLOAT $ BEFORE FIRST NON-SPACE                    
*                                                                               
PA24     MVC   W,SPACES                                                         
         LTR   R0,R0               TEST DUE POS OR NEG                          
         BM    PA26                                                             
         CLI   RETPROF,0           IF NOT RETAIL                                
         BE    PA24D               USE REGULAR WORDING                          
         CLI   RETPROF+11,C'X'     OR IF NOT SHOWING 'YOUR SHARE'               
         BE    PA24D                                                            
         CLI   UPASS,C'S'          ELSE SPECIAL UNLESS SUMMARY PASS             
         BNE   PA25                                                             
PA24D    DS    0H                                                               
         MVC   W(L'SP@AMTDU),SP@AMTDU   AMOUNT DUE                              
         CLI   NOCOMOPT,C'Y'            NEED TO SAY NO COMMISSION?              
         BNE   *+10                                                             
         MVC   W(L'SP@NOCOM),SP@NOCOM   COMM FREE AMOUNT                        
         CLI   CVATSW,0                 UNLESS VAT                              
         BE    PA24D5                                                           
         CLI   SCBNCSW,C'C'             OR SCB SEP COMMISSION                   
         BNE   *+14                                                             
         MVC   W(L'SP@TLAMT),SP@TLAMT   THEN 'TOTAL AMOUNT'                     
         B     PA24D5                                                           
         CLC   SAVBRK,AINVBRK         END OF INVOICE?                           
         BNE   PA24D5                                                           
         MVC   W(19),=C'AMOUNT BEFORE TAX  '                                    
         CLI   RCLANG,4                FRENCH?                                  
         BNE   *+10                                                             
         MVC   W(19),=C'MONTANT AVANT TAXES'                                    
*                                                                               
PA24D5   CLC   SAVBRK,AINVBRK           IF AT INV BRK                           
         BE    PA27                                                             
         CLI   SCBNCSW,C'C'    UNLESS SCB SEP COMMISSION                        
         BE    PA24F                                                            
         MVC   W,SPACES                                                         
         MVC   W(L'SP@AMDF),SP@AMDF         AMOUNT DUE FOR                      
         MVC   W+L'SP@AMDF+1(12),TOTNAME    LEVEL NAME                          
         B     PA27                                                             
*                                                                               
PA24F    DS    0H                  FOR SCB SEP COMMISSION                       
         MVC   W,SPACES            SAY 'TOTAL FOR'                              
         MVC   W(L'SP@TLFOR),SP@TLFOR                                           
         MVC   W+L'SP@TLFOR+1(12),TOTNAME    LEVEL NAME                         
         B     PA27                                                             
*                                                                               
PA25     DS    0H                  RETAIL TOTAL WORDS                           
         MVC   W,SPACES                                                         
         MVC   W(L'SP@TLAMT),SP@TLAMT  ** TOTAL AMOUNT **                       
         CLC   SAVBRK,AINVBRK                                                   
         BE    PA27                                                             
         MVC   W,SPACES                                                         
         MVC   W(L'SP@TLFOR),SP@TLFOR       TOTAL FOR                           
         MVC   W+L'SP@TLFOR+1(12),TOTNAME   LEVEL NAME                          
         B     PA27                                                             
*                                                                               
PA26     DS    0H                                                               
         MVC   W(L'SP@CDAMT),SP@CDAMT       ** CREDIT AMOUNT **                 
         CLI   NOCOMOPT,C'Y'                NO COMMISSION ?                     
         BNE   *+10                                                             
         MVC   W(L'SP@NOCCR),SP@NOCCR       NO COMM CREDIT AMOUNT               
*                                                                               
         CLI   CVATSW,0                    ANY TAXES?                           
         BE    PA26AX                                                           
*                                                                               
         CLC   SAVBRK,AINVBRK         END OF INVOICE?                           
         BNE   PA26AX                                                           
         MVC   W(19),=C'AMOUNT BEFORE TAX  '                                    
         CLI   RCLANG,4                FRENCH?                                  
         BNE   PA26AX                                                           
         MVC   W(19),=C'MONTANT AVANT TAXES'                                    
*                                                                               
PA26AX   CLC   SAVBRK,AINVBRK                                                   
         BE    PA27                                                             
         MVC   W(L'SP@CDAMF),SP@CDAMF       CREDIT AMOUNT FOR                   
         MVC   W+L'SP@CDAMF+1(12),TOTNAME    LEVEL NAME                         
         DROP  R5                                                               
*                                                                               
PA27     CLI   CREDPRN,C'Y'        DISPLAY CREDIT IN PARENTHESIS                
         BNE   PA27A5               NO                                          
         CLC   W(L'SP@CDAMT),=C'** CREDIT AMOUNT **'                            
         BNE   PA27A5               NO                                          
*                                                                               
         LA    R1,ALCOL4X     END OF CREDIT AMOUNT                              
         CLI   0(R1),C' '     FIND FIRST NON-SPACE                              
         BH    *+8                                                              
         BCT   R1,*-8                                                           
*                                                                               
         BCTR  R1,0           BACK UP ONE                                       
         CLC   0(2,R1),=C'CR' SHOULD BE CR                                      
         BE    *+6                                                              
         DC    H'0'                                                             
         MVI   0(R1),C')'          REPLACE WITH ")"                             
         MVI   1(R1),C' '                                                       
*                                                                               
         LA    R1,ALCOL4-1                                                      
PA27A1   CLI   1(R1),C' '     FIND FIRST NON-SPACE                              
         BH    PA27A2                                                           
         LA    R1,1(R1)                                                         
         B     PA27A1                                                           
*                                                                               
PA27A2   MVI   0(R1),C'('                                                       
*                                                                               
PA27A5   DS    0H                                                               
         LA    RF,W+32                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R0,W                                                             
         SR    RF,R0               RF = LENGTH - 1                              
         LA    RE,ALCOL4-2                                                      
         SR    RE,RF               RE = TO ADDR                                 
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),W                                                        
         LR    R0,RE               SAVE DISPLACEMENT INTO CURRENT LINE          
         SR    R0,R2                                                            
         ST    R0,WORD                                                          
         CLI   TAXOPT,C'N'                                                      
         BE    PA27A8                                                           
         CLI   UPASS,C'S'          NO TAX ON SUMMARY                            
         BE    PA27A8                                                           
         L     RF,RTAXD(R7,R6)   ORDERED TAX                                    
         S     RF,RBTAXD(R7,R6)  LESS BILLED TAX                                
         BZ    PA27A8                                                           
*                               TAX DISPLAY                                     
         SHI   RE,27                                                            
         L     R1,=A(DICSECT)                                                   
         MVC   0(L'SP@SLTAX,RE),SP@SLTAX-DICSECT(R1)  SALES TAX                 
*                                                                               
         STM   R2,R3,DUB           SAVE REGS                                    
         LR    R2,RE               CANT USE RE,RF IN CURED                      
         LR    R3,RF                                                            
         CURED (R3),(12,14(R2)),CURTAB,COMMAS=YES,CR=YES,CURSYMB=YES,  +        
               ALIGN=LEFT                                                       
         LR    RE,R2               RESTORE REGS                                 
         LR    RF,R3                                                            
         LM    R2,R3,DUB                                                        
*                                                                               
PA27A8   DS    0H                  SET CURRENCY DESCRIPTION                     
         CLI   SINGCOL,C'Y'        FOR SINGLE COL FORMATS                       
         BNE   *+12                                                             
         LA    R5,ALCOL4+18        COLUMN 4 SHOULD BE FREE                      
         B     *+10                                                             
         LR    R5,RE               ELSE PUT TO RIGHT OF TAX                     
         SHI   R5,27                                                            
*                                                                               
         BRAS  RE,SETCURN          GET CURRENCY DESCRIPTION                     
         MVC   0(20,R5),0(R1)                                                   
*                                                                               
         LA    R2,132(R2)                                                       
*                                                                               
         CLI   SCBNCSW,C'C'        FOR SCB COMMISSION BILLING                   
         BNE   PA27C                                                            
*                                  SUBTRACT NET                                 
         L     R3,WORD             POSITION IN LINE                             
         AR    R3,R2                                                            
         L     RE,=A(DICSECT)                                                   
         MVC   0(L'SP@LESS,R3),SP@LESS-DICSECT(RE)                              
         LA    R3,L'SP@LESS+1(R3)                                               
         MVC   0(L'SP@NET,R3),SP@NET-DICSECT(RE)                                
         LA    R3,L'SP@NET+1(R3)                                                
         L     R0,RNETD(R7,R6)     ORDERED NET                                  
         S     R0,RBNETD(R7,R6)    (LESS PREV BILLED NET)                       
         CURED (R0),(16,ALCOL4),CURTAB,COMMAS=YES,CR=YES                        
         LA    R2,132(R2)                                                       
*                                                                               
         L     RE,=A(DICSECT)                                                   
         USING DICSECT,RE                                                       
         MVC   W,SPACES                                                         
         CLI   CVATSW,0                 IF HAVE VAT                             
         BE    *+14                                                             
         MVC   W(L'SP@CMAMT),SP@CMAMT   SAY 'COMMISSION AMOUNT'                 
         B     PA27B4                                                           
         MVC   W(L'SP@AMTDU),SP@AMTDU   ELSE AMOUNT DUE                         
         CLI   NOCOMOPT,C'Y'            NEED TO SAY NO COMMISSION?              
         BNE   *+10                                                             
         MVC   W(L'SP@NOCOM),SP@NOCOM   COMM FREE AMOUNT                        
         CLC   SAVBRK,AINVBRK           IF AT INV BRK                           
         BE    PA27B4                                                           
         MVC   W,SPACES                                                         
         MVC   W(L'SP@AMDF),SP@AMDF-DICSECT(RE) AMOUNT DUE FOR                  
         MVC   W+L'SP@AMDF+1(12),TOTNAME    LEVEL NAME                          
         DROP  RE                                                               
*                                                                               
PA27B4   DS    0H                                                               
         L     R3,WORD                                                          
         AR    R3,R2                                                            
         MVC   0(L'W,R3),W                                                      
         L     R0,DUEDSP(R7,R6)    AMOUNT DUE                                   
         S     R0,RNETD(R7,R6)     LESS NET                                     
         A     R0,RBNETD(R7,R6)    (PLUS PREV BILLED NET)                       
*                                  = COMMISSION                                 
         CURED (R0),(16,ALCOL4),CURTAB,COMMAS=YES,CR=YES                        
         CLI   DOLSOPT,C'Y'                                                     
         BNE   PA27B8                                                           
*        FLOAT=$ DOES NOT SEEM TO WORK WITH CURED  (CUREDIT)                    
*                                                                               
         LA    R1,ALCOL4-1                                                      
PA27B6   CLI   1(R1),C' '     FIND FIRST NON-SPACE                              
         BH    PA27B7                                                           
         LA    R1,1(R1)                                                         
         B     PA27B6                                                           
*                                                                               
PA27B7   MVI   0(R1),C'$'     FLOAT $ BEFORE FIRST NON-SPACE                    
*                                                                               
PA27B8   LA    R2,132(R2)                                                       
*                                  RETAIL BILLING SHARES                        
PA27C    DS    0H                                                               
         CLI   RETPROF,0                                                        
         BE    PA27M                                                            
         CLI   UPASS,C'S'                                                       
         BE    PA27M                                                            
         CLI   RETPROF+11,C'X'     TEST TO SKIP SHARE LINE                      
         BE    PA27M                                                            
*                                                                               
         LA    R5,W                                                             
         MVC   W,SPACES                                                         
*                                                                               
         L     RE,=A(DICSECT)                                                   
         MVC   0(L'SP@YSOT,R5),SP@YSOT-DICSECT(RE) YOUR SHARE OF TOTAL          
         CLC   SAVBRK,AINVBRK                                                   
         BE    *+10                                                             
         MVC   14(12,R5),TOTNAME                                                
         LA    R5,27(R5)                                                        
         CLI   0(R5),C' '                                                       
         BH    *+8                                                              
         BCT   R5,*-8                                                           
         LA    R5,2(R5)                                                         
         CLI   BFRETSHR,X'FF'      TEST MIXTURE OF SHR PCTS                     
         BE    PA27D                                                            
         CLI   RETPROF+11,C'Y'     PRINT PCTS                                   
         BNE   PA27D                                                            
         CURED (B3,BFRETSHR),(6,0(R5)),2                                        
         L     RE,=A(DICSECT)                                                   
         MVC   7(L'SP@PCT,R5),SP@PCT-DICSECT(RE)                                
         LA    R5,7+L'SP@PCT(R5)                                                
*                                                                               
PA27D    DS    0H                                                               
         L     R0,RETADSP(R7,R6)                                                
         LTR   R0,R0               TEST POS AMOUNT                              
         BM    PA27E               NO                                           
         CLC   SAVBRK,AINVBRK      TEST INV BREAK                               
         BNE   PA27E               NO                                           
         CLI   RETDRAFT,C'Y'       NO DUE IF RETAIL DRAFT                       
         BE    PA27E                                                            
*                                                                               
         CLI   CVATSW,0            IF VAT                                       
         BNE   PA27E               DONT DESCRIBE TOTAL NOW                      
         L     RE,=A(DICSECT)                                                   
         MVC   4(L'SP@AMTDU,R5),SP@AMTDU-DICSECT(RE)                            
         CLI   NOCOMOPT,C'Y'       NEED TO SAY NO COMMISSION?                   
         BNE   *+10                                                             
         MVC   4(L'SP@NOCOM,R5),SP@NOCOM-DICSECT(RE)                            
*                                                                               
PA27E    DS    0H                                                               
         LA    R0,P                                                             
         CR    R2,R0               TEST PRINTED ANY TOTALS YET                  
         BNH   *+12                NO                                           
         MVI   16(R2),0                                                         
         LA    R2,132(R2)          2 LINES                                      
*                                                                               
         LA    RF,W+55                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R0,W                                                             
         SR    RF,R0               RF = LENGTH - 1                              
         LA    RE,ALCOL4-2                                                      
         SR    RE,RF               RE = TO ADDR                                 
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),W                                                        
         SR    RE,R2               SAVE DISPLACEMENT INTO CURRENT LINE          
         ST    RE,WORD                                                          
*                                                                               
         L     R0,RETADSP(R7,R6)                                                
         CURED (R0),(16,ALCOL4),CURTAB,COMMAS=YES,CR=YES                        
         CLI   DOLSOPT,C'Y'                                                     
         BNE   PA27H                                                            
*        FLOAT=$ DOES NOT SEEM TO WORK WITH CURED  (CUREDIT)                    
*                                                                               
         LA    R1,ALCOL4-1                                                      
PA27F    CLI   1(R1),C' '     FIND FIRST NON-SPACE                              
         BH    PA27G                                                            
         LA    R1,1(R1)                                                         
         B     PA27F                                                            
*                                                                               
PA27G    MVI   0(R1),C'$'     FLOAT $ BEFORE FIRST NON-SPACE                    
*                                                                               
PA27H    LA    R2,132(R2)                                                       
*                                                                               
PA27M    DS    0H                                                               
         LA    R0,P                                                             
         CR    R2,R0               NO, TEST ANYTHING TO PRINT                   
         BNH   PA28                NO                                           
*                                                                               
         CLI   CVATSW,0            IF VAT                                       
         BE    PA27P4                                                           
*                                                                               
         BRAS  RE,PRNT                                                          
         LA    R3,ALCOL4-ALINED    COLUMN FOR VAT                               
         CLI   SINGCOL,C'Y'        FOR SINGLE COL FORMATS                       
         BNE   *+8                                                              
         SHI   R3,16               BACK UP ONE COLUMN                           
         GOTOR VBPRNT,DMCB,(C'N',SAVBRK),(R3)      'NORMAL'                     
         MVC   TOTVAT,20(R1)       SAVE TOTAL OF VATS                           
*                                                                               
         LA    R2,P                RESET LINE POINTER                           
         CLI   SINGCOL,C'Y'        FOR SINGLE COL FORMATS                       
         BNE   *+8                                                              
         SHI   R2,16               SHIFT AMOUNTS LEFT ONE COL                   
*                                                                               
         L     RE,=A(DICSECT)                                                   
         L     R3,WORD                                                          
         AR    R3,R2                                                            
         MVC   0(L'SP@AMTDU,R3),SP@AMTDU-DICSECT(RE)                            
         CLI   NOCOMOPT,C'Y'       NEED TO SAY NO COMMISSION?                   
         BNE   *+10                                                             
         MVC   0(L'SP@NOCOM,R3),SP@NOCOM-DICSECT(RE)                            
         CLI   RETPROF,0           IF RETAIL                                    
         BE    *+12                                                             
         L     R0,RETADSP(R7,R6)                                                
         B     PA27N3D                                                          
*                                  NON-RETAIL                                   
         L     R0,DUEDSP(R7,R6)                                                 
         CLI   ADJSEP,C'Y'         IF SEP COMM ADJ                              
         BNE   *+8                                                              
         S     R0,ADJDSP(R7,R6)    REMOVE ADJUSTMENT FROM MAIN BILL             
         CLI   SCBNCSW,C'C'        IF SCB COMMISSION BILL                       
         BNE   *+12                                                             
         S     R0,RNETD(R7,R6)     THEN LESS NET                                
         A     R0,RBNETD(R7,R6)    (PLUS PREV BILLED NET)                       
*                                                                               
PA27N3D  DS    0H                                                               
         A     R0,TOTVAT           ADD TOTAL OF VATS                            
*                                                                               
         ST    R0,FULL                                                          
         GOTO1 ABILLEDI,DMCB,('EDMTDUE',0)                                      
         L     R0,FULL                                                          
*                                                                               
         L     RE,=A(DICSECT)      RESET RE AFTER GOTO1                         
         LTR   R0,R0                                                            
         BNM   PA27P3F                                                          
         MVC   0(L'SP@CDAMT,R3),SP@CDAMT-DICSECT(RE)                            
         CLI   NOCOMOPT,C'Y'       NO COMMISSON ?                               
         BNE   *+10                                                             
         MVC   0(L'SP@NOCCR,R3),SP@NOCCR-DICSECT(RE)                            
*                                                                               
PA27P3F  DS    0H                                                               
         CURED (R0),(16,ALCOL4),CURTAB,COMMAS=YES,CR=YES                        
         CLI   DOLSOPT,C'Y'                                                     
         BNE   PA27P3K                                                          
*        FLOAT=$ DOES NOT SEEM TO WORK WITH CURED  (CUREDIT)                    
*                                                                               
         LA    R1,ALCOL4-1                                                      
PA27P3H  CLI   1(R1),C' '     FIND FIRST NON-SPACE                              
         BH    PA27P3J                                                          
         LA    R1,1(R1)                                                         
         B     PA27P3H                                                          
*                                                                               
PA27P3J  MVI   0(R1),C'$'     FLOAT $ BEFORE FIRST NON-SPACE                    
*                                                                               
*                                                                               
PA27P3K  CLI   CREDPRN,C'Y'        DISPLAY CREDIT IN PARENTHESIS                
         BNE   PA27P3Q                                                          
         CLC   0(L'SP@CDAMT,R3),=C'** CREDIT AMOUNT * '                         
         BNE   PA27P3Q                                                          
*                                                                               
         LA    R1,ALCOL4X     END OF CREDIT AMOUNT                              
         CLI   0(R1),C' '     FIND FIRST NON-SPACE                              
         BH    *+8                                                              
         BCT   R1,*-8                                                           
*                                                                               
         BCTR  R1,0           BACK UP ONE                                       
         CLC   0(2,R1),=C'CR' SHOULD BE CR                                      
         BE    *+6                                                              
         DC    H'0'                                                             
         MVI   0(R1),C')'          REPLACE WITH ")"                             
         MVI   1(R1),C' '                                                       
*                                                                               
         LA    R1,ALCOL4-1                                                      
PA27P3L  CLI   1(R1),C' '     FIND FIRST NON-SPACE                              
         BH    PA27P3M                                                          
         LA    R1,1(R1)                                                         
         B     PA27P3L                                                          
*                                                                               
PA27P3M  MVI   0(R1),C'('                                                       
PA27P3Q  LA    R2,132(R2)                                                       
*                                                                               
PA27P4   DS    0H                                                               
         CLC   SAVBRK,AINVBRK      IF AT END OF INVOICE                         
         BNE   *+18                                                             
         SHI   R2,132              SAVE AMOUNT DUE PRINT LINE                   
         MVC   SVAMTDUE,0(R2)                                                   
         LA    R2,132(R2)                                                       
*                                                                               
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         GOTO1 ABILLEDI,DMCB,('EDMDUE',(R4)),(R7),(R6)   EDI CALL               
*                                  SEE IF LIST OF PREVIOUS                      
*                                  BILLS NEEDED  (FOR INFORMATION ONLY)         
         CLC   SAVBRK,AINVBRK                                                   
         BNE   PA28                                                             
         CLI   FORMAT,10                                                        
         BH    PA28                                                             
***      CLI   LSTOPT,C'Y'                                                      
***      BE    *+12                                                             
***      CLI   LSTOPT,C'R'                                                      
***      BNE   PA28                                                             
         CLI   LSTOPT,C'N'                                                      
         BE    PA28                                                             
*                                                                               
         BRAS  RE,LSTINV                                                        
*                                                                               
PA28     DS    0H                                                               
         SPACE 2                                                                
PAX      DS    0H                                                               
         MVI   PRSW,C'F'           SET TO FLUSH LINES                           
         BRAS  RE,PRNT                                                          
*                                                                               
         XIT1                                                                   
         DROP  R2                                                               
         DROP  R4                                                               
         SPACE 3                                                                
         LTORG                                                                  
         TITLE 'ADJINV - PRINT ADJUSTMENT INVOICE'                              
ADJINV   NMOD1 0,ADJINV                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   SCBNCSW,C'C'        IF SCB TYPE SEP COMMISSION                   
         BE    AIX                 NO OLD STYLE SEP ADJUSTMENT BILL             
*                                                                               
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)             POINT TO ACCUM                          
         LR    RF,R7                                                            
         AHI   RF,TOTSIZE-BFORML                                                
         MVC   X(5),0(RF)               HOLD FORMULA IN X                       
         MVC   CVATSWS,BFVATSWS-BFORMD(RF)   VATABLE SWITCHES                   
         MVC   SVVATCDS,BFVATCDS-BFORMD(RF)                                     
         AHI   R7,MAXMOS*ROWL      POINT TO TOTAL ROW                           
         OC    ADJDSP(8,R7),ADJDSP(R7)     NO ADJUSTMENT                        
         BZ    AIX                                                              
*                                                                               
         SR    R6,R6             **NOTE- R6 USED AS INDEX REG FOR CURR          
         CLI   CLTCURR,0         0 = MAIN CURRENCY                              
         BE    *+8                                                              
         LHI   R6,4              4 = CLIENT CURRENCY                            
*                                                                               
*        MVI   PRSW,C'C'                                                        
*        BRAS  RE,PRNT                                                          
*                                                                               
         MVI   FORCEHED,C'Y'                                                    
         MVC   PAGE,=H'1'                                                       
         L     R0,DUEDSP(R7,R6)        'DUE' FROM LAST INVB                     
         S     R0,ADJDSP(R7,R6)        LESS ADJ = TRUE BILLED                   
         MVI   DUESW,C'A'                                                       
*                                                                               
         LA    R2,P                                                             
         USING ALINED,R2                                                        
         L     RE,=A(DICSECT)   AMOUNT BILLED ON INVOICE                        
         MVC   P+34(L'SP@ABOI),SP@ABOI-DICSECT(RE)                              
         MVC   P+34+L'SP@ABOI+1(10),SPINVNO                                     
*                                                                               
         GOTO1 AGETNUM,DMCB,INVNO,PINVNO    GET NEXT BILL NO.                   
*&&DO                                                                           
         CLI   QTRADE,C'T'         MTRADE?                                      
         BNE   AI3                                                              
         LHI   RF,100              NORMAL 85 NET                                
         LHI   RE,85                                                            
         LA    R5,RGRSD(R7,R6)     DERIVE FROM GROSS                            
         L     R1,0(R5)                                                         
         S     R1,ROWHL(R5)                                                     
         MR    R0,RE                                                            
         DR    R0,RF                                                            
         LR    R0,R1                                                            
         ST    R0,FULL                                                          
*&&                                                                             
AI3      CURED (R0),(16,ALCOL4),CURTAB,COMMAS=YES,CR=YES                        
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         CLC   X+1(4),=X'FFFFFFFF'                                              
         BE    AI4                                                              
*&&DO                                                                           
         CLI   QTRADE,C'T'                                                      
         BNE   AI3F                                                             
         XC    WK,WK                                                            
         MVC   WK(5),X             FIND CASH BILLFORM                           
         GOTO1 BINSRCH,BFRPARS,WK                                               
         CLI   0(R1),1                                                          
         BNE   *+6                 NOT IN BFRTAB                                
         DC    H'0'                                                             
         L     RF,0(R1)                                                         
         MVC   WK(5),5(RF)         STORE CASH FORMULA                           
         MVC   WK+5(5),X           SAVE TRADE FORMULA                           
         MVC   X(5),WK                                                          
*&&                                TEST IF NEED COMMISSION BASIS                
AI3F     PACK  BYTE,X(1)                                                        
         CLC   BYTE,X                                                           
         BE    AI4                 SAME AS DUE                                  
*                                  MUST STATE COMMISSION BASIS                  
         L     RE,=A(DICSECT)                                                   
         MVC   ALCOL4-11(L'SP@NETAM),SP@NETAM-DICSECT(RE) NET AMOUNT            
         LA    R5,RNETD(R7,R6)                                                  
         TM    X,X'01'                                                          
         BNZ   AI3H                                                             
*        BZ    *+20                                                             
*        CLI   QTRADE,C'T'         IF MTRADE USE CALCULATED NET                 
*        BNE   AI3H                                                             
*        L     R0,FULL                                                          
*        B     AI3J                                                             
*                                                                               
         MVC   ALCOL4-13(L'SP@GRSAM),SP@GRSAM-DICSECT(RE) GROSS AMOUNT          
         LA    R5,RGRSD(R7,R6)                                                  
*                                                                               
AI3H     L     R0,0(R5)                                                         
         S     R0,ROWHL(R5)                                                     
AI3J     CURED (R0),(16,ALCOL4),CURTAB,COMMAS=YES,CR=YES                        
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
AI4      DS    0H                                                               
         MVC   W,SPACES                                                         
         L     RE,=A(DICSECT)                                                   
         CLI   PROFB2B+8,C'Y'      REMOVE BILL % ON COMM ADJ?                   
         BNE   AI4C                                                             
         CLI   PROFB2B+4,C'Y'      SEE IF TO SAY JUST 'COMMISSION'              
         BNE   AI4C                                                             
         MVC   W(L'SP@CMAMT),SP@CMAMT-DICSECT(RE) COMMISSION AMOUNT             
         B     AI6                                                              
*                                                                               
AI4C     MVC   W(L'SP@COMAJ),SP@COMAJ-DICSECT(RE) COMMISSION ADJUSTMENT         
         CLI   PROFB2B+8,C'Y'      REMOVE BILL % ON COMM ADJ?                   
         BNE   *+12                                                             
         CLI   PROFB2B+4,C'J'      JUST SAY 'COMMISSION ADJUSTMENT'?            
         BE    AI6                                                              
*                                                                               
         CLC   X+1(4),=X'FFFFFFFF'                                              
         BE    AI6                                                              
         LA    R9,W+L'SP@COMAJ                                                  
         CLI   0(R9),C' '                                                       
         BH    *+8                                                              
         BCT   R9,*-8                                                           
         MVI   2(R9),C'('                                                       
         LA    R9,3(R9)                                                         
         MVI   CURTAB+3,4          NN.NNNN                                      
         CURED (B4,X+1),(8,0(R9)),4,ALIGN=LEFT                                  
         MVI   CURTAB+3,2          RESTORE                                      
         AR    R9,R0                                                            
         LR    RE,R9                                                            
         SHI   RE,5                                                             
         CLC   1(4,RE),=C'0000'                                                 
         BNE   *+12                                                             
         MVC   0(5,RE),SPACES                                                   
         LR    R9,RE                                                            
*                                                                               
*        CLI   QTRADE,C'T'         IF MTRADE AND ACT FORMULA RESTOR IT          
*        BNE   *+10                                                             
*        MVC   X(5),WK+5                                                        
*                                                                               
         L     RE,=A(DICSECT)                                                   
         MVC   2(L'SPBPCTOA,R9),SPBPCTOA-DICSECT(RE)                            
         LA    R9,L'SPBPCTOA+2(R9)                                              
         CLI   0(R9),C' '                                                       
         BH    *+8                                                              
         BCT   R9,*-8                                                           
         MVI   1(R9),C')'                                                       
AI6      DS    0H                                                               
         LA    RF,W+60                                                          
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    R0,W                                                             
         SR    RF,R0               RF = LENGTH OF STRING - 1                    
         LA    RE,ALCOL4-2                                                      
         SR    RE,RF                                                            
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),W                                                        
*&&DO                                                                           
         CLI   QTRADE,C'T'         MTRADE?                                      
         BNE   AI6D                                                             
         CLC   X+1(4),=X'FFFFFFFF'                                              
         BE    AI6D                DON'T MESS W/ COMMISSION                     
         L     R0,DUEDSP(R7,R6)    CALC COMMIS AS DUE-NET                       
         S     R0,FULL                                                          
         ST    R0,FULL             SAVE COMMIS FOR AMOUNT DUE                   
         B     *+8                                                              
*&&                                                                             
AI6D     L     R0,ADJDSP(R7,R6)        ADJUSTMENT AMOUNT                        
         CURED (R0),(16,ALCOL4),CURTAB,COMMAS=YES,CR=YES                        
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         CLI   CVATSW,0            IF HAVE VAT CODE                             
         BE    AI6F                                                             
*                                                                               
         BRAS  RE,PRNT                                                          
         LA    R0,ALCOL4-ALINED   COLUMN FOR VAT AMOUNT                         
         GOTOR VBPRNT,DMCB,(C'J',SAVBRK),(R0)       ADJ MODE                    
         MVC   TOTVAT,20(R1)       SAVE TOTAL OF VATS                           
*                                                                               
AI6F     DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         MVC   ALCOL3-2(L'SP@AMTDU),SP@AMTDU-DICSECT(RE)                        
         CLI   NOCOMOPT,C'Y'        NEED TO SAY NO COMMISSION?                  
         BNE   *+10                                                             
         MVC   ALCOL3-2(L'SP@NOCOM),SP@NOCOM-DICSECT(RE)                        
*                                                                               
*        CLI   QTRADE,C'T'         MTRADE?                                      
*        BNE   *+12                                                             
*        L     R0,FULL             COMMISSION AMOUNT                            
*        B     *+8                                                              
*                                                                               
         L     R0,ADJDSP(R7,R6)       ADJUSTMENT AMOUNT                         
*                                                                               
         A     R0,TOTVAT           PLUS TOTAL OF VATS                           
*                                                                               
         CLI   CVATSW,0            IF VAT                                       
         BE    AI6H                                                             
         ST    R0,FULL             PUT IN TD RECORD                             
         GOTO1 ABILLEDI,DMCB,('EDMTDUE',0)                                      
         L     R0,FULL                                                          
*                                                                               
AI6H     L     RE,=A(DICSECT)      RESET RE AFTER GOTO1                         
         LTR   R0,R0                                                            
         BNM   AI6M                                                             
         MVC   ALCOL3-2(L'SP@CDAMT),SP@CDAMT-DICSECT(RE)                        
         CLI   NOCOMOPT,C'Y'       NO COMMISSION ?                              
         BNE   *+10                                                             
         MVC   ALCOL3-2(L'SP@NOCCR),SP@NOCCR-DICSECT(RE)                        
*                                                                               
AI6M     DS    0H                                                               
         CURED (R0),(16,ALCOL4),CURTAB,COMMAS=YES,CR=YES                        
         CLI   DOLSOPT,C'Y'                                                     
         BNE   AI7                                                              
*        FLOAT=$ DOES NOT SEEM TO WORK WITH CURED  (CUREDIT)                    
*                                                                               
         LA    R1,ALCOL4-1                                                      
AI6O     CLI   1(R1),C' '     FIND FIRST NON-SPACE                              
         BH    AI6P                                                             
         LA    R1,1(R1)                                                         
         B     AI6O                                                             
*                                                                               
AI6P     MVI   0(R1),C'$'     FLOAT $ BEFORE FIRST NON-SPACE                    
*                                                                               
AI7      MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         BRAS  RE,SETCURN          GET CURRENCY ID                              
         CLI   0(R1),C' '          NONE RETURNED                                
         BNH   *+18                                                             
         MVC   ALCOL4-20(20),0(R1)                                              
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         LA    R4,X          A(FORMULA)                                         
         GOTO1 ABILLEDI,DMCB,('EDMDUE',(R4)),(R7),(R6)  DUE                     
         DROP  R2                                                               
*                                                                               
         BRAS  RE,COMPROC                                                       
*                                                                               
*        L     RF,ADCOMREC         IF HAVE COMMENT                              
*        OC    0(2,RF),0(RF)                                                    
*        BZ    *+16                                                             
*        MVI   FORCECMT,C'I'       SET IMMEDIATE COMMENT PRINT                  
*        MVI   PRSW,C'N'           AND PRINT NOW                                
*        BRAS  RE,PRNT                                                          
*                                                                               
         MVI   PUMODE,C'E'         USER FIELDS (END OF BILL)                    
         BRAS  RE,PRTUSER                                                       
         BRAS  RE,BILLBOX                                                       
         BRAS  RE,WOBILL                                                        
*                                                                               
         CLI   QTRADE,C'T'         TRADE?                                       
         BNE   *+14                                                             
         MVC   P1(8),=C'** PE **'                                               
         BRAS  RE,PRNT                                                          
*                                                                               
         CLI   WPPOPT,C'Y'                                                      
         BNE   *+8                                                              
         BRAS  RE,PRTWCOM                                                       
*                                  EDI CALLS                                    
         GOTO1 ABILLEDI,DMCB,('EDMEND',0)   EDI CALL                            
         CLI   OUTMODE,C'W'        FOR WORKER FILE MODE                         
         BNE   AI8B                                                             
         GOTO1 ABILLEDI,DMCB,('EDMCLS',0)   CLOSE EDI FOR EACH INVOICE          
*                                                                               
AI8B     DS    0H                                                               
         SPACE 2                                                                
AIX      DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
         LTORG                                                                  
*                                                                               
*                                                                               
PRTWCOM  NTR1  BASE=*,LABEL=*                                                   
         BRAS  RE,PRNT                                                          
*                                                                               
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         MVC   P1+8(62),=C'THIS COMPANY IS PART OF THE WPP GROUP OF COMX        
               PANIES AND ADHERES'                                              
         MVC   P2+8(55),=C'TO WPP ETHICAL STANDARDS, WHICH CAN BE FOUNDX        
                IN THE WPP'                                                     
         MVC   P3+8(61),=C'CORPORATE SOCIAL RESPONSIBILITY REPORT ON THX        
               E WPP.COM WEBSITE'                                               
*                                                                               
         BRAS  RE,PRNT                                                          
*                                                                               
PRTWCX   XIT1                                                                   
         LTORG                                                                  
*                                                                               
*                                                                               
         TITLE 'BILCALC - CALCULATE AMOUNTS DUE'                                
*                                                                               
BILCALC  NMOD1 BILCQ,BILCALC                                                    
         LR    R9,RC                                                            
         USING BILCD,R9                                                         
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         CLI   PASSNO,1                                                         
         BE    BC1                                                              
*                                                                               
*              ONLY REDO ADJUSTMENTS ON PASS 2                                  
*              IF DOING ADJSEP WITH DETAIL BACK-UP                              
*           OR IF DOING AORINV WITH DETAIL BACK-UP                              
*                                                                               
         CLI   PASSNO,2                                                         
         BNE   BCX                                                              
         OC    ARECAP,ARECAP                                                    
         BZ    BCX                                                              
         CLI   AORSW,C'Y'                                                       
         BE    BC1                                                              
         CLI   ADJSEP,C'Y'                                                      
         BNE   BCX                                                              
*                                                                               
BC1      DS    0H                                                               
*                                  SET RETAIL STATUS TABLE ENTRY PNTR           
         L     RF,BRKCODE                                                       
         SRL   RF,2                                                             
         MHI   RF,RSTATTBL                                                      
         A     RF,=A(RSTATTB)                                                   
         ST    RF,ARSTATTB                                                      
*                                                                               
         XC    WKROW+000(256),WKROW+000                                         
         XC    WKROW+256(256),WKROW+256                                         
         XC    WKROW+512(L'WKROW-512),WKROW+512                                 
         L     R7,BRKCODE                                                       
         L     R7,ATOTS(R7)      POINT TO ACCUM                                 
         LR    RF,R7                                                            
         LR    RE,R7                                                            
         AHI   RE,TOTSIZE-BFORML   POINT TO 'FORMULA' INFO                      
         OC    0(BFORML,RE),0(RE)     IF ROLLED UP FROM LOWER LEVEL             
         BNZ   BCX                    DONE                                      
         LHI   R6,MAXMOS                                                        
         LA    R5,PERLIST                                                       
         USING PERLISTD,R5                                                      
         XC    DUB,DUB                                                          
*                                                                               
BC2      DS    0H                                                               
         CLC   0(ROW$L,RF),ROWHL(RF)     TEST $ ONLY                            
         BNE   *+14                                                             
         CLC   ROWTL(ROW$L,RF),ROWTL+ROWHL(RF)                                  
         BE    *+10                                                             
         MVC   DUB(2),PERLMOS      SAVE DATE FOR BILL FORM EFF DATE             
*                                  NOTE-WHOLE BILL EITHER OK OR NOT             
         LA    RF,ROWL(RF)                                                      
         LA    R5,PERLISTL(R5)     BUMP DATE                                    
         BCT   R6,BC2                                                           
*                                                                               
         OC    DUB,DUB             IF NO BILLABLES                              
         BNZ   *+18                                                             
         SHI   R5,PERLISTL                                                      
         OC    DUB(2),PERLMOS      USE LATEST DATE FOR EFF DATE CHECK           
         BZ    *-10                                                             
         DROP  R5                                                               
*                                                                               
*                                  SET BILLING FORMULA IN W                     
         XC    W,W                                                              
*                                                                               
******** OC    MANRVDTP,MANRVDTP   IS THIS A REVERSAL BILL?                     
******** BZ    BC2A5                                                            
******** CLC   AMKTBRK,AINVBRK     IF MKT TOGETHER, DON'T DO FOR NOW            
******** BH    BC2A5               COULD BE MIXED BILLFORM                      
******** BRAS  RE,GETBFBH                                                       
******** CLC   BFORMBH,=X'FFFFFFFFFF'  DID WE GET FORMULA?                      
******** BE    BC2A5               NO, GET IT NOW                               
******** MVC   W(5),BFORMBH        YES, GET FORMULA FROM BILL HEADER            
******** B     BC3A                                                             
*                                                                               
BC2A5    CLI   QFRATE,C'F'         ARE WE DOING FRATES?                         
         BE    BC3A                YES, SKIP SETTING OF BILL FORMULA            
*                                                                               
         XC    X,X                                                              
*        CLI   QTRADE,C'T'         TRADE FORMULA ON PRD/EST REC                 
*        BE    *+20                BUT STILL GET CASH FORMULA TOO               
*        CLI   QTRADE,C'C'         CASH FORMULA ON SFM BFORM                    
*        BE    *+12                                                             
         CLI   BFROPT,C'N'         TEST USING BILL FORM RECORDS                 
         BE    BC2AV                                                            
*                                                                               
         L     R4,=A(GETBFRW)      (NULLS FIRST TIME)                           
         USING SPGBFRDD,R4                                                      
*                                                                               
         MVC   SPGBAM,BAGYMD                                                    
         MVC   SPGBCLT,BCLT                                                     
         L     RF,APRD                                                          
         ZIC   R1,0(RF)            GET PROD CODE FROM PROD SEQ                  
         MHI   R1,4                                                             
         L     RF,ADCLT                                                         
         LA    R1,CLIST-CLTHDR(RF,R1)                                           
         MVC   SPGBPRD,0(R1)        3 CHAR PRD CODE                             
         L     RF,AEST                                                          
         MVC   SPGBEST,0(RF)                                                    
         L     RF,AMKT                                                          
         MVC   SPGBMKT,0(RF)       NOTE- MGRS NOT DONE YET                      
*                                                                               
*                                                                               
         MVC   SPGBMOS,CURPER      USE REQUEST MONTH                            
         CLI   PERCTL,C'S'         IF MONTHS MOT SEPARATE                       
         BNE   BC2A7                                                            
         L     RE,APER             ELSE USE PERIOD                              
         ZIC   RF,0(RE)                                                         
         LA    RF,PERLIST(RF)                                                   
         MVC   SPGBMOS,PERLMOS-PERLISTD(RF)                                     
*                                                                               
BC2A7    DS    0H                                                               
         MVC   SPGBACOM,ACOMFACS                                                
         MVC   SPGBLODR,LOADER                                                  
         GOTO1 ASPGTBFR,DMCB,SPGBFRD                                            
*                                                                               
         MVC   W(5),SPGBFORM                                                    
         B     BC3A                CODE BELOW WILL COME OUT                     
*        CLI   QTRADE,C'T'         IF TRADE GET THE OTHER FORMULA               
*        BNE   BC3A                                                             
*        MVC   X(5),W              SAVE CASH FORMULA IN X                       
*        XC    W,W                                                              
*        DROP  R4                                                               
*                                                                               
BC2AV    DS    0H                                                               
         MVI   CRFORMSW,C'Y'       SPECIAL CORP RETAIL FORMULA                  
         CLI   RETPROF+15,C'Y'     TEST OPTION TO SKIP                          
         BNE   BC2B0               TO AAA FORMULAS FOR CORP BILL                
         CLI   UPASS,1             CORP                                         
         BE    BC2B                                                             
         CLI   UPASS,C'S'          AND SUMMARY                                  
         BE    BC2B                                                             
*                                                                               
BC2B0    DS    0H                                                               
         CLI   RETPROF+15,C'0'     TEST OUTLET CODE BASED AAA OPTION            
         BNH   BC2B4               (LAST N DIGITS ARE 0)                        
         CLI   UPASS,C'S'          AAA FOR SUMMARY                              
         BE    BC2B                                                             
         L     R4,AGDAREA                                                       
         USING GDSECT,R4                                                        
         ZIC   R1,GDOUTLEN                                                      
         L     R4,GDOUTAD          A(OUTLET)                                    
         USING GDOUTD,R4                                                        
         LA    R4,GDOCODE(R1)                                                   
         DROP  R4                                                               
         ZIC   R1,RETPROF+15                                                    
         SHI   R1,240                                                           
         SR    R4,R1                                                            
         BCTR  R1,0                                                             
         EX    R1,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R4),=C'000000'                                               
         BE    BC2B                                                             
*                                                                               
BC2B4    DS    0H                                                               
         MVI   CRFORMSW,C'N'       NO SPECIAL CORP RETAIL FORMULA               
*                                                                               
         CLI   QGMITVC,C'T'        FOR GMI TRADE ONLY BILLS                     
         BE    BC3A                SKIP BILL FORMULA                            
         CLI   GMISW,C'Y'          AND FOR ALL GMI                              
         BNE   *+14                                                             
         CLC   CURPER,=X'600A'     SKIP IF MOS BEFORE OCT96  **Y2K**            
         BL    BC3A                                                             
*                                                                               
         OC    W(5),ESTBAS                                                      
         BNZ   BC3                                                              
         CLC   DUB(2),EFFDTE                                                    
         BL    BC2B                                                             
         OC    W(5),PRDBAS                                                      
         BNZ   BC3                                                              
BC2B     DS    0H                                                               
         OC    W(5),AAEBAS                                                      
         BNZ   BC3                                                              
         CLC   DUB(2),AAABILDT                                                  
         BL    BC3                                                              
         OC    W(5),AAABAS                                                      
BC3      DS    0H                                                               
         MVI   BFMODE,C'F'         SET TO GET FORMULA                           
         GOTO1 ABFMOD              SPECIAL BILLING FORMULA MODULE               
*                                  NOTE- MAY SET NEW FORMULA IN W               
BC3A     DS    0H                                                               
         CLI   SCBNCSW,C'N'        FOR NET BILLING IN SCB SITUATION             
         BNE   *+10                IGNORE FORMULA                               
         MVC   W(5),=X'1000000000' SET TO NET +0% OF NET                        
*&&DO                                                                           
         CLI   QTRADE,C'T'                                                      
         BNE   BC3B                                                             
         XC    WK,WK                                                            
         LA    RE,WK                                                            
         USING BFRTABD,RE                                                       
         MVC   BFRTRADE,W                                                       
         NI    BFRTRADE,X'FF'-X'EE'   ONLY X'11' BITS USED HERE                 
         MVC   BFRCASH,X                                                        
         GOTO1 BINSRCH,BFRPARS,(1,WK)                                           
         OC    1(3,R1),1(R1)                                                    
         BNZ   *+6                                                              
         DC    H'0'                TABLE FULL                                   
         DROP  RE                                                               
*&&                                                                             
BC3B     LR    RF,R7                                                            
         AHI   RF,TOTSIZE-BFORML                                                
         OI    BFIND-BFORMD(RF),X'80'  SET ROLLED UP IND                        
         MVC   0(5,RF),W           SET FORMULA IN ACCUM                         
         LA    RE,BFAORPCT-BFORMD(RF)                                           
         MVC   0(3,RE),SVAORPCT+1  SET AOR PCT IN ACCUM                         
         NI    0(RF),X'FF'-X'EE'   ONLY X'11' BITS USED HERE                    
*                                                                               
*           ** NOTE THAT CVATSW BY ITSELF (NOT THE PROVINCE                     
*              SWITCHES) ACTUALLY CONTROLS MOST THINGS **                       
*                                                                               
         XC    CVATSWS,CVATSWS     SET VATABLE SWITCHES OFF                     
         CLI   CVATCOD,0           NO VAT IF NO VAT CODE                        
         BE    BC3H                                                             
         CLC   DUB(2),CVATSTRT     TEST AFTER VAT START DATE                    
         BL    *+12                NOTE- EITHER ALL MONTHS VATABLE              
*                                  OR ALL NOT VATABLE. (GST ONLY?)              
         MVI   CVATSW,C'Y'                                                      
         MVI   NVATSW,C'Y'                                                      
*                                  SET VAT SWS FOR PROVS                        
*                                  **NOTE- NO EFFECTIVE DATE CHECK              
         LA    RE,CVATCDS+1                                                     
         LA    R1,CVATSWS+1                                                     
         LHI   R0,NPROVS                                                        
*                                                                               
BC3D     DS    0H                                                               
         CLI   0(RE),C' '          IF ANY VAT CODE                              
         BNH   *+8                                                              
         MVI   0(R1),C'Y'          SET SWITCH ON                                
         LA    RE,1(RE)                                                         
         LA    R1,1(R1)                                                         
         BCT   R0,BC3D                                                          
*                                                                               
         LA    RE,NVATCDS+1         NEW PSTS                                    
         LA    R1,NVATSWS+1                                                     
         LHI   R0,NPROVS                                                        
*                                                                               
BC3F     DS    0H                                                               
         CLI   0(RE),C' '          IF ANY VAT CODE                              
         BNH   *+8                                                              
         MVI   0(R1),C'Y'          SET SWITCH ON                                
         LA    RE,1(RE)                                                         
         LA    R1,1(R1)                                                         
         BCT   R0,BC3F                                                          
*                                                                               
BC3H     DS    0H                                                               
         USING BFORMD,RF                                                        
         MVC   BFVATCDS,CVATCDS    VAT DATA IN BFORMD                           
         MVC   BFVATSWS,CVATSWS                                                 
         CLC   DUB(2),=X'6E07'         MOS CHECK  - JUL/10                      
         BL    *+16                                                             
         MVC   BFVATCDS-BFORMD(,RF),NVATCDS    VAT DATA INTO BFORMD             
         MVC   BFVATSWS-BFORMD(,RF),NVATSWS                                     
         DROP  RF                                                               
*                                                                               
         LHI   R6,MAXMOS                                                        
         LA    R5,PERLIST                                                       
*                                                                               
BC4      DS    0H                                                               
         XC    BCGRS,BCGRS          CLEAR DERIVED GROSS AND NET                 
         XC    BCGRS2,BCGRS2                                                    
         XC    BCNET,BCNET                                                      
         XC    BCNET2,BCNET2                                                    
         XC    BCBAS,BCBAS                                                      
         XC    BCBAS2,BCBAS2                                                    
         CLC   0(ROW$L,R7),ROWHL(R7)      TEST ANY BALANCE                      
         BE    BC8                ** WAS BC6M **                                
*                                 ** NOW SKIPS RETAIL                           
*                                 ** MAYBE COULD BE BC20 (SKIPPING              
*                                 ** SOME OTHER STUFF TOO - AOR?)               
*                                 ** WHAT REALLY IS DONE AT                     
*                                 ** BC6M (OR BC8) IF                           
*                                 ** THERE IS NO BILLABLE FOR MONTH?            
BC4B     DS    0H                                                               
*                                                                               
         CLI   W+5,0                                                            
         BNE   BC5                                                              
         MVI   W+5,X'FF'                                                        
*                                                                               
*                                  ON FIRST TIME THRU                           
*                                  ADD BILL BUCKET RECS                         
*                                  FOR DUMMY MKT/STA IF NOT                     
*                                  DOING DETAIL MARKING                         
         CLC   ORIGTYPE,TYPE                                                    
         BNE   BC5                                                              
         BRAS  RE,WNBILL                                                        
*                                                                               
*                                                                               
BC5      DS    0H                                                               
         GOTOR VBADJ,DMCB,W,(R5),BRKTABD  GET VAT BASIS ADJUSTMENT              
*                                  AMOUNTS IN VBTAB                             
*                                  SET BCGRS,BCNET                              
         LR    RF,R5                                                            
         LA    RE,PERLIST                                                       
         SR    RF,RE                                                            
         SR    RE,RE                                                            
         D     RE,=A(PERLISTL)     RF = REL. NO. OF PERIOD                      
         STC   RF,PERNUM                                                        
*                                                                               
         MVC   BCGRS,8(R7)         GROSS + NET HERE FOR SUMMARY PASS            
         MVC   BCGRS2,12(R7)                                                    
         MVC   BCNET,16(R7)                                                     
         MVC   BCNET2,20(R7)                                                    
*                                                                               
         L     RF,0(R7)            ACTUAL FOR SUMMARY PASS                      
         CLI   UPASS,C'S'                                                       
         BE    BC6                                                              
*                                  REGULAR PASS                                 
         ZIC   RF,PERNUM                                                        
         A     RF,ARSTATTB         FOR 'ACTIVE' RETAIL MONTHS                   
         CLI   0(RF),X'80'                                                      
         BNE   BC504                                                            
         MVC   04(4,R7),00(R7)      SET GROSS AND NET ETC. IN 2ND               
         MVC   12(4,R7),08(R7)      CURRENCY SLOTS                              
         MVC   20(4,R7),16(R7)                                                  
         MVC   28(4,R7),24(R7)                                                  
         MVC   36(4,R7),32(R7)                                                  
         MVC   44(4,R7),40(R7)                                                  
         MVC   52(4,R7),48(R7)                                                  
         MVC   60(4,R7),56(R7)                                                  
*                                                                               
         L     RF,BRKCODE          AND ADD INTO TOTAL MONTH ROW                 
         L     RF,ATOTS(RF)        (NORMALLY THIS IS DONE IN RDBUFF             
         AHI   RF,MAXMOS*ROWL      BUT NOT POSSIBLE HERE BECAUSE                
*                                  VALUES JUST NOW SET)                         
         L     RE,04(RF)           GROSS ORDERED                                
         A     RE,04(R7)                                                        
         ST    RE,04(RF)                                                        
         L     RE,12(RF)           NET                                          
         A     RE,12(R7)                                                        
         ST    RE,12(RF)                                                        
         L     RE,20(RF)           TAX                                          
         A     RE,20(R7)                                                        
         ST    RE,20(RF)                                                        
         L     RE,28(RF)           SPOTS                                        
         A     RE,28(R7)                                                        
         ST    RE,28(RF)                                                        
*                                                                               
         L     RE,36(RF)           GROSS BILLED                                 
         A     RE,36(R7)                                                        
         ST    RE,36(RF)                                                        
         L     RE,44(RF)           NET                                          
         A     RE,44(R7)                                                        
         ST    RE,44(RF)                                                        
         L     RE,52(RF)           TAX                                          
         A     RE,52(R7)                                                        
         ST    RE,52(RF)                                                        
         L     RE,60(RF)           SPOTS                                        
         A     RE,60(R7)                                                        
         ST    RE,60(RF)                                                        
*                                                                               
BC504    DS    0H                                                               
         LA    R2,0(R7)                                                         
         LA    RE,BCGRS                                                         
         LHI   R0,4                                                             
BC5A     DS    0H                                                               
*                                                                               
         L     RF,0(R2)                                                         
         S     RF,ROWHL(R2)                                                     
         ST    RF,0(RE)            BASIS                                        
*                                                                               
         LA    R2,4(R2)                                                         
         LA    RE,4(RE)                                                         
         BCT   R0,BC5A                                                          
*                                                                               
BC5A2    DS    0H                                                               
*              NOTE- COST2 CALCS DONE AT BC6C                                   
*                                  GET BASIS                                    
         MVC   BCBAS,BCGRS         GROSS                                        
         MVC   BCBAS2,BCGRS2                                                    
         TM    W,X'10'                                                          
         BZ    *+16                                                             
         MVC   BCBAS,BCNET         NET                                          
         MVC   BCBAS2,BCNET2                                                    
         L     RF,BCBAS                                                         
*                                  CALCULATE ADJUSTMENT                         
         OC    W+1(4),W+1                                                       
         BZ    BC6                 NO ADJ                                       
         L     RF,BCGRS            GRS                                          
         TM    W,X'01'                                                          
         BZ    *+8                                                              
         L     RF,BCNET            NET                                          
*                                                                               
         CLI   TAXOPT,C'N'         TEST SHOWING TAX                             
         BE    BC5B                *NOTE-NO NETPAK TAX                          
         S     RF,RTAXD(R7)        LESS TAX                                     
         A     RF,RBTAXD(R7)       PLUS BILLED TAX                              
BC5B     DS    0H                                                               
         MVC   FULL,W+1                                                         
         M     RE,FULL             X ADJ PCT                                    
*                                                                               
         SLDA  RE,1                                                             
         D     RE,=F'1000000'                                                   
         LTR   RF,RF                                                            
         BNP   *+8                                                              
         AHI   RF,1                                                             
         SRA   RF,1                                                             
*                                                                               
         ST    RF,ADJDSP(R7)           ADJ                                      
         L     RE,WKROW+ADJDSP-EXTDSP                                           
         AR    RE,RF                                                            
         ST    RE,WKROW+ADJDSP-EXTDSP TOTAL ADJ                                 
         A     RF,BCBAS            ADD BASIS                                    
BC6      DS    0H                                                               
         ST    RF,DUEDSP(R7)           AMOUNT DUE                               
         A     RF,WKROW+DUEDSP-EXTDSP                                           
         ST    RF,WKROW+DUEDSP-EXTDSP  KEEP DUE TOTAL                           
*                                                                               
BC6C     DS    0H                                                               
*                                  REPEAT CALC LOGIC FOR CLT CURRENCY           
*                           **BUT NO 2ND CURRENCY VAT FOR NOW                   
         CLI   CLTCURR,0                                                        
         BNE   BC6D                                                             
         CLI   RETPROF,0      (FOR RETAIL MAY BE USED FOR                       
         BE    BC6M           'ACTIVE MONTH' TOTALS)                            
*                                                                               
BC6D     DS    0H                                                               
         L     RF,BCBAS2                                                        
*                                  CALCULATE ADJUSTMENT                         
         OC    W+1(4),W+1                                                       
         BZ    BC6H                NO ADJ                                       
         L     RF,BCGRS2           GRS                                          
         TM    W,X'01'                                                          
         BZ    *+8                                                              
         L     RF,BCNET2           NET                                          
*                                                                               
         CLI   TAXOPT,C'N'         TEST SHOWING TAX                             
         BE    BC6F                *NOTE-NO NETPAK TAX                          
         S     RF,RTAX2D(R7)       LESS TAX                                     
         A     RF,RBTAX2D(R7)      PLUS BILLED TAX                              
BC6F     DS    0H                                                               
         MVC   FULL,W+1                                                         
         M     RE,FULL             X ADJ PCT                                    
*                                                                               
         SLDA  RE,1                                                             
         D     RE,=F'1000000'                                                   
         LTR   RF,RF                                                            
         BNP   *+8                                                              
         AHI   RF,1                                                             
         SRA   RF,1                                                             
*                                                                               
         ST    RF,ADJDSP+4(R7)           ADJ                                    
         L     RE,WKROW+ADJDSP+4-EXTDSP                                         
         AR    RE,RF                                                            
         ST    RE,WKROW+ADJDSP+4-EXTDSP TOTAL ADJ                               
         A     RF,BCBAS2           ADD BASIS                                    
BC6H     DS    0H                                                               
         ST    RF,DUEDSP+4(R7)           AMOUNT DUE                             
         A     RF,WKROW+DUEDSP+4-EXTDSP                                         
         ST    RF,WKROW+DUEDSP+4-EXTDSP  KEEP DUE TOTAL                         
*                                                                               
BC6M     DS    0H                                                               
         CLI   CVATSW,0            IF ANY CANADIAN VAT                          
         BE    BC6M5                                                            
*                                                                               
         GOTOR VBCALC,DMCB,(R5),(R7),BRKTABD   VAT CALC                         
         CLI   ADJSEP,C'Y'          SEP ADJ BILL?                               
         BNE   BC6M5                                                            
         GOTOR VBCALCJ,DMCB,(R5),(R7),BRKTABD   VAT FOR SEP ADJ                 
*                                                                               
BC6M5    CLI   RETPROF,0           TEST RETAIL                                  
         BE    BC8                 NO                                           
*                                                                               
*             ***NOTE- NO CLIENT CURRENCY CODE FOR RETAIL***                    
*             ***BUT THE SLOTS ARE USED FOR "ACTIVE MONTH" TOTALS               
*                                                                               
         L     R4,AGDAREA                                                       
         USING GDSECT,R4                                                        
         MVC   GDPER,PERNUM        RELATIVE PERIOD                              
         MVC   GDTOTA,DUEDSP(R7)   DUE AMT                                      
         MVC   GDTOTG,BCGRS                                                     
         MVC   GDTOTN,BCNET                                                     
         L     RF,ADEST                                                         
         USING ESTHDR,RF                                                        
         MVC   GDSCHM,SPACES                                                    
         CLI   ERTLSCHM,C'*'       * MEANS NO SCHEME                            
         BE    BC6N                                                             
         MVC   GDSCHM,ERTLSCHM     IF ANYTHING IN RETAIL SCHEME                 
         CLC   GDSCHM,SPACES       FIELD, USE IT                                
         BH    *+10                                                             
         MVC   GDSCHM,EPROF+1      ELSE USE EPROF+1                             
         DROP  RF                                                               
BC6N     DS    0H                                                               
         L     RF,APRD                                                          
         MVC   GDPRD,0(RF)                                                      
         L     RF,AEST                                                          
         MVC   GDEST,0(RF)                                                      
*                                                                               
         NI    GDCNTL,X'FF'-GDCMKTQ                                             
         CLI   BFROPT,C'N'         IF DOING MKT LEVEL BILL FORMS                
         BE    BC6N4                                                            
         OI    GDCNTL,GDCMKTQ      TELL FINDOUT                                 
         L     RF,AMKT             AND SET MKT                                  
         LH    R0,0(RF)                                                         
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'                                                      
         UNPK  GDMKT,DUB                                                        
*                                                                               
BC6N4    DS    0H                                                               
         MVC   GDOUTNO,UPASS       OUTLET NO.                                   
         CLI   UPASS,C'S'          IF SUMMARY PASS                              
         BNE   *+8                                                              
         MVI   GDOUTNO,1           USE CORP OUTLET                              
         OI    GDCNTL,GDCNCUMQ     TELL FINDOUT NOT TO CUME PCTS                
         CLI   CRFORMSW,C'Y'       IF SPECIAL CORP BILL FORMULA ON              
         BE    BC6P                (BECAUSE BASES ARE DIFFERENT)                
         CLI   RETPROF+15,C'0'     OR IF BASED ON OUTLET NUMBER                 
         BH    BC6P                                                             
         NI    GDCNTL,X'FF'-GDCNCUMQ                                            
*                                                                               
BC6P     DS    0H                                                               
         GOTO1 =V(FINDOUT),DMCB,GDSECT                                          
         BAS   RE,FOTRACE          FINDOUT TRACE                                
*                                                                               
         OC    GDSHRP,GDSHRP       IF SHARE IS 0%                               
         BNZ   *+10                                                             
         XC    GDSHRA(12),GDSHRA   CLEAR AMOUNTS                                
*                                                                               
         OC    GDSCHMAD,GDSCHMAD                                                
         BNZ   BC7                                                              
         CLI   UPASS,C'S'                                                       
         BE    *+6                                                              
         DC    H'0'             NO SCHEME - SHOULD NOT HAPPEN HERE              
         XC    GDSHRA(12),GDSHRA       CLEAR SHARE                              
         XC    GDSHRP,GDSHRP                                                    
BC7      DS    0H                                                               
         CLI   UPASS,C'S'          FOR SUMMARY PASS                             
         BNE   BC7D                                                             
         MVC   RETADSP(8,R7),DUEDSP(R7) RET DUE=DUE                             
         MVC   RETGDSP(8,R7),BCGRS      NOTE-SET IN 2ND CURR TOO                
         MVC   RETNDSP(8,R7),BCNET                                              
         B     BC7E                                                             
BC7D     DS    0H                                                               
         MVC   RETADSP(4,R7),GDSHRA    SET SHARE DUE - ACT                      
         MVC   RETGDSP(4,R7),GDSHRG                  - GROSS                    
         MVC   RETNDSP(4,R7),GDSHRN                  - NET                      
*                                                                               
         L     RF,ARSTATTB                                                      
         ZIC   RE,PERNUM                                                        
         AR    RF,RE                                                            
         CLI   0(RF),X'80'         FOR ACTIVE MONTHS SET AMOUNTS                
         BNE   BC7E                FOR PRTADJ PRINTING                          
*                                                                               
         MVC   RETADSP+4(4,R7),GDSHRA    SET SHARE DUE - ACT                    
         MVC   RETGDSP+4(4,R7),GDSHRG                  - GROSS                  
         MVC   RETNDSP+4(4,R7),GDSHRN                  - NET                    
*                                                                               
BC7E     DS    0H                                                               
         MVC   RETPDSP(4,R7),GDSHRP    SHARE PCT                                
         L     RF,RETADSP(R7)                                                   
         A     RF,WKROW+RETADSP-EXTDSP                                          
         ST    RF,WKROW+RETADSP-EXTDSP TOTAL OF ACT SHARES                      
         L     RF,RETGDSP(R7)                                                   
         A     RF,WKROW+RETGDSP-EXTDSP                                          
         ST    RF,WKROW+RETGDSP-EXTDSP TOTAL OF GRS SHARES                      
         L     RF,RETNDSP(R7)                                                   
         A     RF,WKROW+RETNDSP-EXTDSP                                          
         ST    RF,WKROW+RETNDSP-EXTDSP TOTAL OF NET SHARES                      
         OC    GDSHRP,GDSHRP       KEEP SHARE % ONLY IF PRESENT                 
         BZ    *+10                                                             
         MVC   WKROW+RETPDSP-EXTDSP(4),GDSHRP  SAVE SHARE PCT                   
*                                                                               
         L     RF,ARSTATTB                                                      
         ZIC   RE,PERNUM                                                        
         AR    RF,RE                                                            
         CLI   0(RF),X'80'         FOR ACTIVE MONTHS SET AMOUNTS                
         BNE   BC7F                FOR PRTADJ PRINTING                          
*                                                                               
         MVC   RETPDSP+4(4,R7),GDSHRP    SHARE PCT                              
         L     RF,RETADSP+4(R7)                                                 
         A     RF,WKROW+RETADSP+4-EXTDSP                                        
         ST    RF,WKROW+RETADSP+4-EXTDSP TOTAL OF ACT SHARES                    
         L     RF,RETGDSP+4(R7)                                                 
         A     RF,WKROW+RETGDSP+4-EXTDSP                                        
         ST    RF,WKROW+RETGDSP+4-EXTDSP TOTAL OF GRS SHARES                    
         L     RF,RETNDSP+4(R7)                                                 
         A     RF,WKROW+RETNDSP+4-EXTDSP                                        
         ST    RF,WKROW+RETNDSP+4-EXTDSP TOTAL OF NET SHARES                    
         OC    GDSHRP,GDSHRP       KEEP SHARE % ONLY IF PRESENT                 
         BZ    *+10                                                             
         MVC   WKROW+RETPDSP-EXTDSP(4),GDSHRP  SAVE SHARE PCT                   
*                                                                               
BC7F     DS    0H                                                               
         CLI   CVATSW,0            TEST VAT                                     
         BE    BC7G                                                             
         GOTOR VBCALCR,DMCB,(R5),(R7),BRKTABD,GDSHRP                            
*                                                                               
BC7G     DS    0H                                                               
         DROP  R4                                                               
*                                                                               
BC8      DS    0H                                                               
         MVI   BFMODE,C'A'         SET TO GET AOR OVERRIDE                      
         GOTO1 ABFMOD              MODULE FOR SPECIAL OVERRIDES                 
*                    NOTE- BFMOD MAY SET SVAORPCT,SVAORBAS,SVAOREFF             
         ICM   R0,15,SVAORPCT      TEST ANY AOR PCT                             
         BZ    BC9T                                                             
*                                                                               
         L     RF,BCGRS            BASIS IS GROSS                               
         TM    SVAORBAS,X'F0'      IF NO BASIS BITS ON                          
         BNZ   BC8D                                                             
         CLI   AORTXOPT,C'Y'       TEST TO INCLUDE TAX IN BASE                  
         BE    BC8E                YES, OK                                      
         S     RF,RTAXD(R7)        NO, SUBTRACT ORDERED TAX                     
         A     RF,RBTAXD(R7)           AND RE-ADD BILLED TAX                    
         B     BC8E                                                             
*                                                                               
BC8D     DS    0H                                                               
         S     RF,BCNET            OR A/C (GROSS LESS NET)                      
         TM    SVAORBAS,X'80'                                                   
         BNZ   BC8E                                                             
         L     RF,BCNET            OR NET                                       
         TM    SVAORBAS,X'40'                                                   
         BZ    BC8D8                                                            
         CLI   AORTXOPT,C'Y'       TEST TO INCLUDE TAX IN BASE                  
         BE    BC8E                YES, OK                                      
         S     RF,RTAXD(R7)        NO, SUBTRACT ORDERED TAX                     
         A     RF,RBTAXD(R7)           AND RE-ADD BILLED TAX                    
         B     BC8E                                                             
*                                                                               
BC8D8    DS    0H                                                               
         DC    H'0'                INVALID AOR BASIS                            
*                                                                               
BC8E     DS    0H                                                               
         LTR   RF,RF                                                            
         BZ    BC8T                NO DUE AMOUNT                                
         CLC   0(2,R5),SVAOREFF    TEST VS AOR EFF DATE                         
         BL    BC8G                                                             
         CLC   0(2,R5),SVAORKIL    AND KILL DATE                                
         BNL   BC8G                                                             
*                                                                               
         MR    RE,R0                                                            
         SLDA  RE,1                                                             
         D     RE,=F'1000000'                                                   
         LTR   RF,RF                                                            
         BNP   *+8                                                              
         AHI   RF,1                                                             
         SRA   RF,1                                                             
         LCR   RF,RF               COMPLEMENT                                   
         ST    RF,AORDSP(R7)       AOR AMOUNT                                   
         A     RF,WKROW+AORDSP-EXTDSP TOTAL                                     
         ST    RF,WKROW+AORDSP-EXTDSP                                           
*                                                                               
         CLC   SVAORVCS,SPACES     IF VATS FOR AOR AGENCY                       
         BNH   BC8F                (PROVIDED VAT IS NOT                         
         CLI   CVATCOD,0           COMPLETELY EXCLUDED)                         
         BE    BC8F                                                             
         CLC   0(2,R5),CVATSTRT    AND NOT BEFORE VAT START UP                  
         BL    BC8F                                                             
******** CLI   PROFB2A+5,C'Y'      COST2 AOR BASIS?                             
******** BE    BC8F                NO NEED FOR NORMAL AOR?                      
         MVI   C2AORSW,C'N'        SET NOT DOING COST2 AOR                      
         GOTOR VBCALCA,DMCB,(R5),(R7),BRKTABD                                   
         BAS   RE,BCPTCH1          **** TEST PATCH ****                         
*                                                                               
BC8F     DS    0H                                                               
         L     RF,BRKCODE          LOOK FOR AOR PCT IN ACCUM                    
         L     RF,ATOTS(RF)                                                     
         AHI   RF,TOTSIZE-BFORML+BFAORPCT-BFORMD                                
         CLC   0(3,RF),SVAORPCT+1  IF NOT THERE, DID MONTHS                     
         BE    *+10                BEFORE EFFECTIVE DATE                        
         MVC   0(3,RF),=X'FFFFFF'  SET 'MIXED' AOR PCTS                         
         B     BC8T                                                             
*                                                                               
BC8G     DS    0H                  IF ACTIVE MONTH BEFORE                       
         L     RF,BRKCODE          EFFECTIVE DATE CLEAR OUT AORPCT              
         L     RF,ATOTS(RF)        FROM ACCUM                                   
         AHI   RF,TOTSIZE-BFORML+BFAORPCT-BFORMD                                
         XC    0(3,RF),0(RF)                                                    
*                                                                               
BC8T     DS    0H                                                               
         CLI   CLTCURR,0           TEST NEED TO DO CLIENT CURRENCY              
         BE    BC9T                                                             
*                                                                               
         L     RF,BCGRS2           BASIS IS GROSS (2ND CURR)                    
         TM    SVAORBAS,X'F0'      IF NO BASIS BITS ON                          
         BZ    BC9E                                                             
         S     RF,BCNET2           OR A/C (GROSS LESS NET)                      
         TM    SVAORBAS,X'80'                                                   
         BNZ   BC9E                                                             
         L     RF,BCNET2           OR NET                                       
         TM    SVAORBAS,X'40'                                                   
         BNZ   BC9E                                                             
         DC    H'0'                                                             
*                                                                               
BC9E     DS    0H                                                               
         LTR   RF,RF                                                            
         BZ    BC9T                NO DUE AMOUNT                                
         CLC   0(2,R5),SVAOREFF    TEST VS AOR EFF DATE                         
         BL    BC9T                                                             
         CLC   0(2,R5),SVAORKIL    AND KILL DATE                                
         BNL   BC9T                                                             
*                                                                               
         MR    RE,R0                                                            
         SLDA  RE,1                                                             
         D     RE,=F'1000000'                                                   
         LTR   RF,RF                                                            
         BNP   *+8                                                              
         AHI   RF,1                                                             
         SRA   RF,1                                                             
         LCR   RF,RF               COMPLEMENT                                   
         ST    RF,AORDSP+4(R7)       AOR AMOUNT                                 
         A     RF,WKROW+AORDSP+4-EXTDSP TOTAL                                   
         ST    RF,WKROW+AORDSP+4-EXTDSP                                         
*                                                                               
*        MUST GO TO VBCALCA HERE - IF COST2/CLT CURRENCY                        
*                                                                               
         CLI   PROFB2A+5,C'Y'       COST 2 AOR                                  
         BNE   BC9T                                                             
         MVI   C2AORSW,C'Y'                                                     
         GOTOR VBCALCA,DMCB,(R5),(R7),BRKTABD                                   
         BAS   RE,BCPTCH1          **** TEST PATCH ****                         
*                                                                               
*                                                                               
BC9T     DS    0H                  SET TAX                                      
         L     RF,RTAXD(R7)        ORDERED                                      
         S     RF,RBTAXD(R7)       LESS PREVIOUS                                
         ST    RF,TAXDSP(R7)                                                    
         A     RF,WKROW+TAXDSP-EXTDSP SET IN TOTAL                              
         ST    RF,WKROW+TAXDSP-EXTDSP                                           
         L     RF,RTAX2D(R7)         CLIENT CURRENCY - ORDERED                  
         S     RF,RBTAX2D(R7)        LESS PREVIOUS                              
         ST    RF,TAXDSP+4(R7)                                                  
         A     RF,WKROW+TAXDSP+4-EXTDSP SET IN TOTAL                            
         ST    RF,WKROW+TAXDSP+4-EXTDSP                                         
*                                                                               
         CLI   PASSNO,2            FOR PASS 2 SKIP BCADD                        
         BE    BC20                (ONLY IF RECAP WITH ADJ OR AOR)              
*                                                                               
BC10     DS    0H                                                               
         BAS   RE,BCADD                                                         
*                                                                               
BC20     DS    0H                                                               
         LA    R7,ROWL(R7)                                                      
         LA    R5,6(R5)            BUMP DATE                                    
         LA    R0,PERLISTX                                                      
         CR    R5,R0                                                            
         BL    BC4                                                              
*                                                                               
         MVC   ADJDSP+000(256,R7),WKROW+000   TOT OF ADJ/DUE AMOUNTS            
         MVC   ADJDSP+256(256,R7),WKROW+256                                     
         MVC   ADJDSP+512(ACMEXTL-512,R7),WKROW+512                             
*                                       AND SHARE PCT                           
*                                       NOTE - TOTAL IS SUM OF PARTS            
*                                             (NOT RECALCULATED)                
         LA    R7,ROWL(R7)                                                      
         MVC   BFRETSHR-BFORMD(,R7),WKROW+RETPDSP+1-EXTDSP SHARE PCT            
*                                                                               
BCX      DS    0H                                                               
         XIT1                                                                   
         SPACE 3                                                                
*                                  ADD INTO PRD-EST-PER TAB                     
BCADD    NTR1                                                                   
         SPACE 2                                                                
         LA    RE,PEPTW            PEPTAB WORK AREA                             
         LHI   RF,L'PEPTW                                                       
         SR    R0,R0                                                            
         SR    R1,R1                                                            
         MVCL  RE,R0                                                            
         LA    RF,PEPTW                                                         
         USING PEPTD,RF                                                         
         L     RE,APRD                                                          
         MVC   PEPTPRD,0(RE)       PRD                                          
         L     RE,AEST                                                          
         MVC   PEPTEST,0(RE)        EST                                         
         MVC   PEPTMOS,0(R5)       PERIOD                                       
*                                                                               
         CLI   MGR1CTL,C'S'        IF MGR'S SEPARATE                            
         BNE   BCA04                                                            
         L     RE,AMGR1                                                         
         ZIC   R1,MGR3LEN                                                       
         EX    R1,*+8                                                           
         B     *+10                                                             
         PACK  DUB,0(0,RE)                                                      
         MVC   PEPTMGR,DUB+5       SET MGR IN PEPTAB KEY                        
*                                                                               
BCA04    DS    0H                                                               
         CLI   MKTCTL,C'S'         IF MKT'S SEPARATE                            
         BNE   *+14                                                             
         L     RE,AMKT                                                          
         MVC   PEPTMKT,0(RE)       SET MKT IN PEPTAB KEY                        
*                                                                               
         CLI   NETCTL,C'S'         IF NET'S SEPARATE                            
         BNE   *+14                                                             
         L     RE,ANET                                                          
         MVC   PEPTNTW,0(RE)       SET NET IN PEPTAB KEY                        
*                                                                               
         CLI   STACTL,C'S'         IF STA'S SEPARATE                            
         BNE   *+14                                                             
         L     RE,ASTA                                                          
         MVC   PEPTSTA,0(RE)       SET STA IN PEPTAB KEY                        
*                                                                               
         GOTO1 BINSRCH,PEPPARS,PEPTW                                            
         CLI   0(R1),1                                                          
         BE    BCADDX              NOT IN PEPTAB                                
         L     RF,0(R1)                                                         
*                                                                               
         LM    R0,R1,PEPTADJ                                                    
         A     R0,ADJDSP(R7)           ADJ                                      
         A     R1,ADJDSP+4(R7)         CLT CURRENCY ALSO                        
         STM   R0,R1,PEPTADJ                                                    
         LM    R0,R1,PEPTDUE                                                    
         A     R0,DUEDSP(R7)           DUE                                      
         A     R1,DUEDSP+4(R7)                                                  
         CLI   MIDAS,C'Y'          FOR MIDAS SUBTRACT TRD CREDIT                
         BNE   BCA04M                                                           
         MVC   TRDCDSP(4,R7),PEPTTRDC+4                                         
         MVC   WKROW+TRDCDSP-EXTDSP(4),PEPTTRDC+4     KEEP DUE TOTAL            
         A     R1,PEPTTRDC+4                                                    
         ST    R1,DUEDSP+4(R7)     AND STORE IT BACK IN DUE                     
         L     RE,WKROW+DUEDSP+4-EXTDSP                                         
         A     RE,PEPTTRDC+4                                                    
         ST    RE,WKROW+DUEDSP+4-EXTDSP  KEEP DUE TOTAL                         
*                                                                               
BCA04M   STM   R0,R1,PEPTDUE                                                    
         LM    R0,R1,PEPTRETA                                                   
         A     R0,RETADSP(R7)      RETAIL ACT                                   
         A     R1,RETADSP+4(R7)                                                 
         STM   R0,R1,PEPTRETA                                                   
         LM    R0,R1,PEPTRETG                                                   
         A     R0,RETGDSP(R7)      RETAIL GROSS                                 
         A     R1,RETGDSP+4(R7)                                                 
         STM   R0,R1,PEPTRETG                                                   
         LM    R0,R1,PEPTRETN                                                   
         A     R0,RETNDSP(R7)      RETAIL NET                                   
         A     R1,RETNDSP+4(R7)                                                 
         STM   R0,R1,PEPTRETN                                                   
         LM    R0,R1,PEPTRETT                                                   
         A     R0,RETTDSP(R7)      RETAIL TAX                                   
         A     R1,RETTDSP+4(R7)                                                 
         STM   R0,R1,PEPTRETT                                                   
         LM    R0,R1,PEPTTAX                                                    
         A     R0,TAXDSP(R7)       TAX                                          
         A     R1,TAXDSP+4(R7)                                                  
         STM   R0,R1,PEPTTAX                                                    
*                                                                               
         CLI   CVATSW,0            TEST BILL VATABLE                            
         BE    BCA09                                                            
*                                                                               
         LA    R6,PEPTVCDS         SET VAT CODES ONE AT A TIME                  
         LA    RE,CVATCDS                                                       
         CLC   PEPTMOS(2),=X'6E07' JUL/10  - USE NEW PSTS                       
         BL    *+8                                                              
         LA    RE,NVATCDS                                                       
*                                                                               
         LHI   R0,NPROVS+1                                                      
*                                                                               
BCA05    DS    0H                                                               
         CLI   0(R6),C' '          ANYTHING ALREADY THERE?                      
         BNH   BCA05D              NO                                           
         CLI   0(RE),C' '          YES, ANYTHING NOW                            
         BNH   BCA05F              NO,OK                                        
         CLC   0(1,R6),0(RE)       IF EQUAL OK                                  
         BE    BCA05F                                                           
         MVI   0(R6),X'FF'         YES, SET MIXED (COULD THIS HAPPEN            
         B     BCA05F              AT THE PROV LEVEL IF DIFFERENT               
*                                  STATIONS HAVE DIFFERENT CODES?)              
BCA05D   DS    0H                  NOTHING ALREADY THERE                        
         MVC   0(1,R6),0(RE)       JUST SET CURRENT                             
*                                                                               
BCA05F   DS    0H                                                               
         LA    R6,1(R6)                                                         
         LA    RE,1(RE)                                                         
         BCT   R0,BCA05                                                         
*                                                                               
         OC    PEPTVSWS,CVATSWS    AND SWITCHES (NOTE THE 'OC')                 
         CLC   PEPTMOS(2),=X'6E07' JUL/10  - USE NEW PSTS                       
         BL    *+10                                                             
         OC    PEPTVSWS,NVATSWS    AND SWITCHES (NOTE THE 'OC')                 
*                                                                               
         LHI   R4,NPROVS*8         USED AS INDEX REGISTER                       
*                                                                               
BCA06    DS    0H                                                               
         L     R0,PEPTVTS+0(R4)     VAT - MAIN BILL                             
         A     R0,VATDSP+0(R7,R4)                                               
         ST    R0,PEPTVTS+0(R4)                                                 
         L     R0,PEPTVTS+4(R4)      2ND CURR AT +4                             
         A     R0,VATDSP+4(R7,R4)                                               
         ST    R0,PEPTVTS+4(R4)                                                 
*                                                                               
         L     R0,PEPTVTB+0(R4)      VAT BASIS - MAIN BILL                      
         A     R0,VATBDSP+0(R7,R4)                                              
         ST    R0,PEPTVTB+0(R4)                                                 
         L     R0,PEPTVTB+4(R4)      2ND CURR AT +4                             
         A     R0,VATBDSP+4(R7,R4)                                              
         ST    R0,PEPTVTB+4(R4)                                                 
*                                                                               
         L     R0,PEPTVTCS+0(R4)      VAT FOR SEP COMM ADJ                      
         A     R0,VATCDSP+0(R7,R4)                                              
         ST    R0,PEPTVTCS+0(R4)                                                
         L     R0,PEPTVTCS+4(R4)      2ND CURR AT +4                            
         A     R0,VATCDSP+4(R7,R4)                                              
         ST    R0,PEPTVTCS+4(R4)                                                
*                                                                               
         L     R0,PEPTCVTB+0(R4)      VAT BASIS FOR SEP COMM ADJ                
         A     R0,VATCBDSP+0(R7,R4)                                             
         ST    R0,PEPTCVTB+0(R4)                                                
         L     R0,PEPTCVTB+4(R4)      2ND CURR AT +4                            
         A     R0,VATCBDSP+4(R7,R4)                                             
         ST    R0,PEPTCVTB+4(R4)                                                
*                                                                               
         L     R0,PEPTRTVS+0(R4)      VAT FOR RETAIL                            
         A     R0,RETVDSP+0(R7,R4)                                              
         ST    R0,PEPTRTVS+0(R4)                                                
         L     R0,PEPTRTVS+4(R4)      2ND CURR AT +4                            
         A     R0,RETVDSP+4(R7,R4)                                              
         ST    R0,PEPTRTVS+4(R4)                                                
*                                                                               
         L     R0,PEPTRVTB+0(R4)      VAT BASIS FOR RETAIL                      
         A     R0,VATRBDSP+0(R7,R4)                                             
         ST    R0,PEPTRVTB+0(R4)                                                
         L     R0,PEPTRVTB+4(R4)      2ND CURR AT +4                            
         A     R0,VATRBDSP+4(R7,R4)                                             
         ST    R0,PEPTRVTB+4(R4)                                                
*                                                                               
         SHI   R4,8                DECREMENT INDEX REGISTER                     
         BNM   BCA06                                                            
*                                                                               
BCA09    DS    0H                                                               
         CLI   SVAORACT,C' '       IF AOR                                       
         BNH   BCA10                                                            
         CLC   0(2,R5),SVAOREFF    AND EFFECTIVE FOR THIS MOS                   
         BL    BCA10                                                            
         CLC   0(2,R5),SVAORKIL    AND KILL DATE                                
         BNL   BCA10                                                            
         L     R0,PEPTAOR          CUME AOR                                     
         A     R0,AORDSP(R7)                                                    
         ST    R0,PEPTAOR                                                       
         L     R0,PEPTAOR+4        CLT CURRENCY ALSO                            
         A     R0,AORDSP+4(R7)                                                  
         ST    R0,PEPTAOR+4                                                     
*                                                                               
         LHI   R4,NPROVS*8         USED AS INDEX REGISTER                       
*                                                                               
BCA09B   DS    0H                                                               
         L     R0,PEPTVTAS+0(R4)      VAT FOR AOR                               
         A     R0,VATADSP+0(R7,R4)                                              
         ST    R0,PEPTVTAS+0(R4)                                                
         L     R0,PEPTVTAS+4(R4)      2ND CURR AT +4                            
         A     R0,VATADSP+4(R7,R4)                                              
         ST    R0,PEPTVTAS+4(R4)                                                
*                                                                               
         SHI   R4,8                DECREMENT INDEX REGISTER                     
         BNM   BCA09B                                                           
*                                                                               
         MVC   PEPTAORP,SVAORPCT   SAVE PCT                                     
         MVC   PEPTAORD,SVAORDA    DISK ADDRESS                                 
         MVC   PEPTAORB,SVAORBAS   BASIS                                        
         MVC   PEPTAORA,SVAORACT   RCVBL/PYBL ACCT                              
*                                                                               
         MVC   PKAORVCS,SVAORVCS         SET WORKING AOR PSTS                   
         CLC   PEPTMOS(2),=X'6E07'          MOS VS. JUL/2010                    
         BL    BCA09D                                                           
         CLI   SVAORMVC,C' '             DO I HAVE A MAIN VAT CODE?             
         BNH   BCA09D                                                           
         ZIC   R3,SVAORMVP          MAIN PST PROVINCE #                         
         SH    R3,=H'1'                                                         
         LTR   R3,R3                                                            
         BM    BCA09D               SHOULD NOT BE NEGATIVE                      
*                                                                               
         MVC   PKAORVCS+1(10),SPACES CLEAR OLD PSTS                             
         LA    R4,PKAORVCS+1                                                    
         AR    R4,R3                                                            
         MVC   0(1,R4),SVAORMVC     STORE CODE IN LIST                          
*                                                                               
BCA09D   MVC   PEPTAOVS,PKAORVCS   AOR- OTHER AGENCY VAT CODES                  
*                                                                               
BCA10    DS    0H                                                               
         MVC   PEPTBFB,W        SET BILLFORM BASE AND PCT                       
         MVC   PEPTBFP,W+1      SET BILLFORM BASE AND PCT                       
         CLI   AORTXOPT,C'Y'    FOR AOR INCLUDE TAX IN  BASIS?                  
         BNE   *+8                                                              
         OI    PEPTBFFL,PEPTBATX                                                
*                                                                               
         L     RE,ADPRD                                                         
         MVC   PEPTPACT,PACCT-PRDHDR(RE)     SET PRD ACCT CODE                  
*                                                                               
         TM    W,X'40'             TEST COMM ONLY BILL                          
         BZ    *+8                 YES                                          
         OI    PEPTSTAT,X'80'      SET IN STATUS AREA                           
*                                                                               
         ZIC   RE,PERNUM                                                        
         A     RE,ARSTATTB         FOR 'ACTIVE' RETAIL MONTHS                   
         CLI   0(RE),X'80'                                                      
         BNE   *+8                                                              
         OI    PEPTSTAT,X'10'      SET STATUS FOR WOBILL                        
*                                                                               
         CLI   FLTCTL,C'S'         IF DOING WB FLIGHTS                          
         BNE   *+14                                                             
         L     RE,AFLT                                                          
         MVC   PEPTFLT,0(RE)       SET FLIGHT IN PEPTAB                         
*                                                                               
         DROP  RF                                                               
         BAS   RE,BCPTCH2          **** TEST PATCH ****                         
*                                                                               
BCADDX   DS    0H                                                               
         XIT1                                                                   
         SPACE 2                                                                
BCPTCH1  BR    RE                                                               
         DC    50X'0'                                                           
BCPTCH2  BR    RE                                                               
         DC    50X'0'                                                           
         SPACE 2                                                                
**********************************************************************          
*        FOTRACE - FINDOUT TRACER                                               
**********************************************************************          
*                                                                               
FOTRACE  DS    0H                                                               
         L     RF,APATCH                                                        
         TM    0(RF),X'04'                                                      
         BZR   RE                                                               
*                                                                               
         NTR1                                                                   
         L     R4,AGDAREA                                                       
         USING GDSECT,R4                                                        
         MVC   P(17),=C'**FINDOUT TRACE**'                                      
         BRAS  RE,PRNT                                                          
         GOTO1 HEXOUT,DMCB,GDPER,P+00,1,=C'N'                                   
         MVC   P+3(2),GDSCHM                                                    
         GOTO1 HEXOUT,DMCB,GDOUTNO,P+06,1                                       
         LA    R5,GDTOTG                                                        
         LA    R6,P+10                                                          
         EDIT  (B4,0(R5)),(9,0(R6)),2,ZERO=NOBLANK                              
         LA    R5,GDSHRP                                                        
         LA    R6,P+20                                                          
         EDIT  (B4,0(R5)),(9,0(R6)),2,ZERO=NOBLANK                              
         LA    R5,GDSHRG                                                        
         LA    R6,P+30                                                          
         EDIT  (B4,0(R5)),(9,0(R6)),2,ZERO=NOBLANK                              
         BRAS  RE,PRNT                                                          
*                                                                               
         GOTO1 HEXOUT,DMCB,GDSCHMAD,P+00,24,=C'N'                               
         BRAS  RE,PRNT                                                          
*                                                                               
         LHI   R3,13                                                            
         L     R5,GDSCHMAD                                                      
         LA    R5,GDSCUMP-GDSCHMD(R5)                                           
         LA    R6,P                                                             
*                                                                               
FOT4     DS    0H                                                               
         EDIT  (B4,0(R5)),(9,0(R6)),2,ZERO=NOBLANK                              
         LA    R5,4(R5)                                                         
         LA    R6,10(R6)                                                        
         BCT   R3,FOT4                                                          
         BRAS  RE,PRNT                                                          
*                                                                               
         LHI   R3,13                                                            
         L     R5,GDSCHMAD                                                      
         LA    R5,GDSCUMG-GDSCHMD(R5)                                           
         LA    R6,P                                                             
*                                                                               
FOT5     DS    0H                                                               
         EDIT  (B4,0(R5)),(9,0(R6)),2,ZERO=NOBLANK                              
         LA    R5,4(R5)                                                         
         LA    R6,10(R6)                                                        
         BCT   R3,FOT5                                                          
         BRAS  RE,PRNT                                                          
*                                                                               
         XIT1                                                                   
*                                                                               
         DROP  R4,R9                                                            
         SPACE 2                                                                
         LTORG                                                                  
*                                  GET BILL FORMULA FROM BILL HEADER,           
*&&DO                                                                           
GETBFBH  NTR1  BASE=*,LABEL=*      RESET FORMBOPT, PROFB2+5, PROFB2+6           
         LA    R6,KEY                                                           
         USING BKEY,R6                                                          
         XC    BKEY,BKEY           READ BILL HEADER KEYS                        
         MVC   BKEYAM,BAGYMD       AGY/MED                                      
         MVC   BKEYCLT,BCLT        CLIENT                                       
         L     R1,APRD             PRODUCT CODE (ALPHA SEQ)                     
         ZIC   RF,0(R1)                                                         
         MHI   RF,4                CLIST ENTRY SIZE IS 4                        
         L     RE,ADCLT                                                         
         LA    RE,CLIST-CLTHDR(RE,RF)                                           
         MVC   BKEYPRD,0(RE)                                                    
         L     RF,AEST             ESTIMATE                                     
         MVC   BKEYEST,0(RF)                                                    
*                                  SAVE MOS(2)+B/M(1)+INV NUM(2)                
         L     RE,APER                                                          
         ZIC   RF,0(RE)                                                         
         LA    RF,PERLIST(RF)                                                   
         MVC   WORK(2),PERLMOS-PERLISTD(RF)                                     
         GOTO1 DATCON,DMCB,(2,MANRVDTP),(3,FULL) CONVRT DATE TO YMD             
         ZIC   R0,FULL             TRICK TO PUT Y/M IN ONE BYTE:                
         CVD   R0,DOUBLE           DOUBLE+7 HAS ACTUAL YEAR AND SIGN            
         NI    DOUBLE+7,X'F0'      CLEAR THE SIGN NIBBLE                        
         OC    DOUBLE+7(1),FULL+1  NOW PUT IN MONTH IN LOW NIBBLE               
         MVC   WORK+2(1),DOUBLE+7                                               
         MVC   WORK+3(2),MANRVNO   INVOICE NUMBER                               
*                                                                               
         GOTO1 HIGH                                                             
         B     GETBF20                                                          
*                                                                               
GETBF10  GOTO1 SEQ                                                              
*                                                                               
GETBF20  CLC   KEY(4),KEYSAVE      SAME AGY/MED/CLT?                            
         BE    GETBF23             NO: WE'RE FINISHED....                       
         CP    NBTOTG,=P'0'        ???AND DIDN'T FIND BILL HEADER???            
         BE    *+6                 DID WE WRITE ANY RECS BACK?                  
         DC    H'0'                YES, DIE, SMTH WRONG!                        
         MVI   ERR,REVERR          NO,                                          
         BRAS  RE,ERRPROC          MUST BE INVALID INVOICE #                    
*                                                                               
GETBF23  OC    BKEYYSRV(5),BKEYYSRV   BILL HEADER?                              
         BZ    GETBF10             NO, READ NEXT RECORD                         
*                                                                               
         CLC   BKEYYSRV(5),WORK    IS IT 'OUR' INVOICE?                         
         BNE   GETBF10                                                          
*                                                                               
         GOTO1 GETBILL                                                          
         L     R6,ADBILL                                                        
         USING BILLREC,R6                                                       
         CLI   BILBFB,X'FF'        WAS BILLFORM MIXED?                          
         BNE   *+14                                                             
         MVC   BFORMBH,=X'FFFFFFFFFF'  YES, USE THE CURRENT ONE                 
         B     GETBFX                                                           
*                                                                               
         MVC   BFORMBH,BILBFB      SAVE BILL FORMULA                            
         OC    BILSTABF,BILSTABF   DOES IT HAVE BASIS FLAGS                     
         BZ    GETBFX              NO, DONE                                     
         MVI   AORTXOPT,C'N'                                                    
         TM    BILSTABF,PEPTBATX   INCLUDE TAX IN AOR BASIS ?                   
         BZ    *+8                                                              
         MVI   AORTXOPT,C'Y'                                                    
*                                                                               
         DROP  R6                                                               
GETBFX   XIT1                                                                   
         LTORG                                                                  
         EJECT                                                                  
*&&                                                                             
         SPACE 3                                                                
         DS    0D                                                               
GETBFRW  DC    XL(SPGBFRDL)'00'                                                 
*                                                                               
BILCD    DSECT                                                                  
BCGRS    DS    F                                                                
BCGRS2   DS    F                                                                
BCNET    DS    F                                                                
BCNET2   DS    F                                                                
BCBAS    DS    F                                                                
BCBAS2   DS    F                                                                
*                                                                               
PKAORVCS DS    CL11       PEPTAB WORKING AOR VATS  GST +10 PROV.                
*                                                                               
         DS    0D                                                               
PEPTW    DS    XL(PEPTABRL)                                                     
BILCQ    EQU   *-BILCD                                                          
         TITLE 'FMTAMT - FORMAT BILLING AMOUNTS'                                
*        NOTE- COST2 REQUIREMENTS HERE SEEM TO PARALLEL                         
*              EXISTING 2ND CURRENCY CODE                                       
*                                                                               
SPB102   CSECT                                                                  
FMTAMT   NMOD1 0,FMTAMT                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         MVC   HLDINO,SPACES                                                    
         ST    R3,SAVBRK           SAVE BRK LAVEL                               
         MVC   SVWIPRSW,WIPRSW     SET WORKING WI PRINT SWITCH                  
*                                  SET ZLSW TO CONTROL ZERO LINE TOTALS         
         MVI   ZLSW,C'N'           N = NO SPECIAL TREATMENT                     
         C     R3,ALOWTOG             IF AT LOWEST LEVEL                        
         BE    FA2D                                                             
         CLI   ZLOPT,C'A'             OR IF NOT FOR THIS TUPE                   
         BE    *+14                                                             
         CLC   TYPE,ZLOPT                                                       
         BNE   FA2D                                                             
         MVI   ZLSW,C'Y'                                                        
*                                                                               
FA2D     DS    0H                                                               
         LM    R2,R3,0(R1)         R2 = A(ORD AND BILLED)                       
*                                  R3 = A(PREV INV NO.)                         
         MVC   X(ROWTL),0(R2)      MOVE TOTALS TO X                             
         LA    R2,X                                                             
         LR    R9,R2               SAVE AMOUNTS POINTER                         
         MVI   CCDETSW,C'N'        SET OFF 2ND CURRENY SWITCH                   
         CLI   CURR2,0             IF NOT DOING 2ND CURRENCY                    
         BE    FA2D8                                                            
         CLI   CCDETOPT,C'Y'       OR NOT SHOWING IT                            
         BNE   FA2D8                                                            
         OC    RSPT2D(4,R9),RSPT2D(R9)    OR DONT HAVE IT                       
         BNZ   *+14                                                             
         OC    RBSPT2D(4,R9),RBSPT2D(R9)                                        
         BZ    FA2D8                                                            
*                                                                               
         CLC   RBSPT2D(4,R9),RBSPTD(R9)   BUT SKIP IF HAVE BILLED AMT           
         BNE   FA2D8                      FOR MAIN CURR BUT NOT 2ND             
*                                                                               
         CLI   CLTCURR,0           UNLESS 2ND CURRENCY CLIENT                   
         BNE   *+14                                                             
         CLC   SAVBRK,ASTABRK      DO 2ND ONLY FOR STATION LEVEL                
         BNE   FA2D8                                                            
         MVI   CCDETSW,C'Y'        SET SHOWING BOTH                             
*                                                                               
FA2D8    DS    0H                                                               
         CLI   CLTCURR,0           IF DOING CLIENT CURRENCY                     
         BE    *+16                                                             
         CLI   CCDETSW,C'Y'        UNLESS SHOWING BOTH DETAIL                   
         BE    *+8                                                              
         LA    R2,4(R2)            REPOSITION TO 2ND CURRENCY AMOUNTS           
*                                                                               
         MVI   TAXSW,C'N'          SET TAX SW OFF                               
         CLI   TAXOPT,C'E'         UNLESS DOING TAX DETAILS (A-E)               
         BH    FA2E                                                             
         OC    RTAXD(8,R9),RTAXD(R9)   AND HAVE TAX                             
         BNZ   *+14                                                             
         OC    RBTAXD(8,R9),RBTAXD(R9)                                          
         BZ    FA2E              NOTE- TAXSW ALSO USED IN TOTOUT TO             
         MVI   TAXSW,C'Y'              CONTROL PRINTING                         
         CLI   FORMAT,5                IF 'WIDE' FORMATS                        
         BH    *+8                                                              
         MVI   TAXSW,C'L'              TAX ON 2ND LINE                          
*                                                                               
         CLI   TAXOPT,C'E'         E MEANS SHOW GROSS/NET LESS TAX              
         BNE   FA2E                                                             
         L     R0,RGRSD(R9)        SO REMOVE TAX FROM GROSS/NET                 
         L     R1,RGRS2D(R9)                                                    
         S     R0,RTAXD(R9)                                                     
         S     R1,RTAX2D(R9)                                                    
         ST    R0,RGRSD(R9)                                                     
         ST    R1,RGRS2D(R9)                                                    
         L     R0,RNETD(R9)                                                     
         L     R1,RNET2D(R9)                                                    
         S     R0,RTAXD(R9)                                                     
         S     R1,RTAX2D(R9)                                                    
         ST    R0,RNETD(R9)                                                     
         ST    R1,RNET2D(R9)                                                    
         L     R0,RBGRSD(R9)                                                    
         L     R1,RBGRS2D(R9)                                                   
         S     R0,RBTAXD(R9)                                                    
         S     R1,RBTAX2D(R9)                                                   
         ST    R0,RBGRSD(R9)                                                    
         ST    R1,RBGRS2D(R9)                                                   
         L     R0,RBNETD(R9)                                                    
         L     R1,RBNET2D(R9)                                                   
         S     R0,RBTAXD(R9)                                                    
         S     R1,RBTAX2D(R9)                                                   
         ST    R0,RBNETD(R9)                                                    
         ST    R1,RBNET2D(R9)                                                   
*                                                                               
FA2E     DS    0H                                                               
         L     R5,=A(FMTLINS)                                                   
         USING ALINED,R5                                                        
         MVC   ALINE,SPACES                                                     
         MVC   ALINE+132,SPACES                                                 
         MVC   ALINE+264,SPACES                                                 
         MVC   ALINE+396,SPACES                                                 
         CLI   UPASS,C'S'          RETAIL SUMMARY PASS                          
         BE    FMT40                                                            
         CLI   FORMAT,0                                                         
         BE    FMT30               SPOT DETAIL FORMATS                          
*                             USE R4 AS 'INDEX' TO GRS OR NET                   
         LA    R4,RGRSD       GROSS                                             
         CLI   GNSW,C'G'                                                        
         BE    *+8                                                              
         LA    R4,RNETD       NET                                               
*                                                                               
         CLI   FORMAT,1                                                         
         BE    *+12                                                             
         CLI   FORMAT,2                                                         
         BNE   FA4                                                              
*                                  FORMAT 1 ORD,PREV INV, ETC                   
         CLI   ZLSW,C'Y'           IF ZERO LINE TOTALING                        
         BE    FA3H                SHOW ONLY BALANCE                            
         L     R6,0(R2,R4)         ORDERED                                      
         LA    R7,ALCOL1                                                        
         BAS   RE,FMTEDT                                                        
         CLI   TAXSW,C'N'                                                       
         BE    *+16                                                             
         LA    R7,132(R7)                                                       
         L     R6,RTAXD(R2)                                                     
         BAS   RE,FMTEDT                                                        
*                                                                               
         CLI   CCDETSW,C'Y'        2ND CURRENCY DETAIL?                         
         BNE   FA2H                                                             
         L     R6,4(R2,R4)         ORDERED                                      
         LA    R7,132(R7)                                                       
         BAS   RE,FMTEDT                                                        
         CLI   TAXSW,C'N'                                                       
         BE    FA2H                                                             
         LA    R7,132(R7)                                                       
         L     R6,RTAX2D(R2)                                                    
         BAS   RE,FMTEDT                                                        
*                                                                               
FA2H     DS    0H                                                               
         MVC   WORK,SPACES                                                      
         OC    ROWHL(ROWHL,R9),ROWHL(R9)                                        
         BZ    FA3                 NO BILLING                                   
         OC    0(4,R3),0(R3)       TEST HAVE INVOICE NUMBER                     
         BZ    FA3                                                              
*                                                                               
         MVC   W(1),1(R3)          SET YM                                       
         MVC   SVTODAYB,TODAYB     SAVE TODAYB                                  
         MVC   TODAYB(1),0(R3)     GETNUM USES TODAYB FOR YEAR                  
         MVC   SVSVIMO,SVINVMO     SAVE SAVED INV MO                            
         GOTO1 AGETNUM,DMCB,(1,2(R3)),WORK                                      
         MVC   TODAYB,SVTODAYB                                                  
         MVC   SVINVMO,SVSVIMO     RESTORE SAVED SAVED INV MO                   
         XC    0(4,R3),0(R3)       CLEAR INVLIST ENTRY                          
         MVC   ALCOL2+4(10),WORK                                                
         MVC   HLDINO,WORK         SAVE PREVIOUS INV NO                         
*                                                                               
FA3      DS    0H                                                               
         L     R6,ROWHL(R2,R4)     PREVIOUS                                     
         LA    R7,ALCOL3                                                        
         BAS   RE,FMTEDT                                                        
         CLI   TAXSW,C'N'                                                       
         BE    *+16                                                             
         LA    R7,132(R7)                                                       
         L     R6,RBTAXD(R2)                                                    
         BAS   RE,FMTEDT                                                        
*                                                                               
         CLI   CCDETSW,C'Y'        2ND CURRENCY DETAIL?                         
         BNE   FA3H                                                             
         L     R6,ROWHL+4(R2,R4)     PREVIOUS                                   
         LA    R7,132(R7)                                                       
         BAS   RE,FMTEDT                                                        
         CLI   TAXSW,C'N'                                                       
         BE    FA3H                                                             
         LA    R7,132(R7)                                                       
         L     R6,RBTAX2D(R2)                                                   
         BAS   RE,FMTEDT                                                        
*                                                                               
FA3H     DS    0H                                                               
         LA    R7,ALCOL4                                                        
         L     R6,0(R2,R4)                                                      
         S     R6,ROWHL(R2,R4)     BALANCE                                      
         BAS   RE,FMTEDT                                                        
         CLI   TAXSW,C'N'                                                       
         BE    FA3J                                                             
         LA    R7,132(R7)                                                       
         L     R6,RTAXD(R2)                                                     
         S     R6,RBTAXD(R2)                                                    
         BAS   RE,FMTEDT                                                        
*                                                                               
FA3J     DS    0H                                                               
         CLI   CCDETSW,C'Y'        2ND CURRENCY DETAILS?                        
         BNE   FA20                                                             
         LA    R7,132(R7)                                                       
         L     R6,4(R2,R4)                                                      
         S     R6,ROWHL+4(R2,R4)     BALANCE                                    
         BAS   RE,FMTEDT                                                        
         CLI   TAXSW,C'N'                                                       
         BE    FA20                                                             
         LA    R7,132(R7)                                                       
         L     R6,RTAX2D(R2)                                                    
         S     R6,RBTAX2D(R2)                                                   
         BAS   RE,FMTEDT                                                        
         B     FA20                                                             
*                                                                               
FA4      DS    0H                                                               
         CLI   FORMAT,5                                                         
         BNE   FA4D                                                             
*                                  FORMAT 5 - SPOTS, ORD, ETC                   
         CLI   ZLSW,C'Y'           IF ZERO LINE TOTALING                        
         BE    FA3H                SHOW ONLY BALANCE                            
         LA    R7,ALCOL1           SPOTS                                        
         BAS   RE,FMTEDTSP                                                      
         L     R6,0(R2,R4)         ORDERED                                      
         LA    R7,ALCOL2                                                        
         BAS   RE,FMTEDT                                                        
         CLI   TAXSW,C'N'                                                       
         BE    *+16                                                             
         LA    R7,132(R7)                                                       
         L     R6,RTAXD(R2)                                                     
         BAS   RE,FMTEDT                                                        
*                                                                               
         CLI   CCDETSW,C'Y'        2ND CURRENCY DETAIL?                         
         BNE   FA3                                                              
         L     R6,4(R2,R4)         ORDERED                                      
         LA    R7,132(R7)                                                       
         BAS   RE,FMTEDT                                                        
         CLI   TAXSW,C'N'                                                       
         BE    FA3                                                              
         LA    R7,132(R7)                                                       
         L     R6,RTAX2D(R2)                                                    
         BAS   RE,FMTEDT                                                        
         B     FA3                 DO PREV AMTS AND BALANCE                     
*                                                                               
FA4D     DS    0H                                                               
         CLI   FORMAT,7                                                         
         BNE   FA5                                                              
*                                  FORMAT 7 - SPOTS,BALANCE                     
         L     R0,RSPTD(R2)                                                     
         S     R0,RBSPTD(R2)                                                    
         LA    R7,ALCOL3           SPOTS IN COL3                                
         CLI   TAXOPT,C'E'         UNLESS TAX DETAILS (A-E)                     
         BH    *+8                                                              
         LA    R7,ALCOL2           THEN COL 2                                   
         EDIT  (R0),(5,10(R7)),ZERO=NOBLANK   BILLABLE SPOTS                    
*                                                                               
         CLI   TAXOPT,C'E'         TAX DETAIL (A-E)                             
         BH    FA4F                                                             
         LA    R7,ALCOL3                                                        
         L     R6,RTAXD(R2)                                                     
         S     R6,RBTAXD(R2)                                                    
         BAS   RE,FMTTAX                                                        
*                                                                               
FA4F     DS    0H                                                               
         LA    R7,ALCOL4            GROSS/NET BILLABLE                          
         L     R6,0(R2,R4)                                                      
         S     R6,ROWHL(R2,R4)     BALANCE                                      
         BAS   RE,FMTEDT                                                        
*                                                                               
         CLI   CCDETSW,C'Y'        2ND CURRENCY DETAIL?                         
         BNE   FA20                                                             
         L     R6,4(R2,R4)         ORDERED                                      
         S     R6,ROWHL+4(R2,R4)   BALANCE                                      
         LA    R7,ALCOL4+132                                                    
         BAS   RE,FMTEDT                                                        
         CLI   TAXSW,C'N'                                                       
         BE    FA20                                                             
         L     R6,RTAX2D(R2)                                                    
         S     R6,RBTAX2D(R2)                                                   
         LA    R7,ALCOL3+132                                                    
         BAS   RE,FMTTAX2                                                       
         B     FA20                                                             
*                                                                               
FA5      DS    0H                                                               
         CLI   FORMAT,8                                                         
         BNE   FA5B                                                             
*                                  FORMAT 8 - BALANCE                           
         CLI   TAXOPT,C'E'         TAX DETAIL (A-E)                             
         BH    FA5A                                                             
         LA    R7,ALCOL2                                                        
         L     R6,RTAXD(R2)                                                     
         S     R6,RBTAXD(R2)                                                    
         BAS   RE,FMTTAX                                                        
*                                                                               
FA5A     DS    0H                                                               
         LA    R7,ALCOL3           GROSS/NET BILLABLE                           
         L     R6,0(R2,R4)                                                      
         S     R6,ROWHL(R2,R4)     BALANCE                                      
         BAS   RE,FMTEDT                                                        
*                                                                               
         CLI   CCDETSW,C'Y'        2ND CURRENCY DETAIL?                         
         BNE   FA20                                                             
         L     R6,4(R2,R4)         ORDERED                                      
         S     R6,ROWHL+4(R2,R4)   BALANCE                                      
         LA    R7,ALCOL3+132                                                    
         BAS   RE,FMTEDT                                                        
         CLI   TAXSW,C'N'                                                       
         BE    FA20                                                             
         L     R6,RTAX2D(R2)                                                    
         S     R6,RBTAX2D(R2)                                                   
         LA    R7,ALCOL2+132                                                    
         BAS   RE,FMTTAX2                                                       
         B     FA20                                                             
*                                                                               
FA5B     DS    0H                                                               
         CLI   FORMAT,9                                                         
         BNE   FA6                                                              
*                                  FORMAT 9 NET AND GROSS BALANCE               
         LR    RF,R4                                                            
         SHI   RF,8                                                             
         LPR   RF,RF               REVERSE GROSS AND NET                        
         L     R6,0(R2,RF)                                                      
         S     R6,ROWHL(R2,RF)                                                  
         LA    R7,ALCOL3                                                        
         BAS   RE,FMTEDT                                                        
         L     R6,0(R2,R4)         THEN DO OTHER                                
         S     R6,ROWHL(R2,R4)                                                  
         LA    R7,ALCOL4                                                        
         BAS   RE,FMTEDT                                                        
         CLI   TAXOPT,C'E'         TAX DETAIL (A-E)                             
         BH    FA5D                                                             
         LA    R7,ALCOL2                                                        
         L     R6,RTAXD(R2)                                                     
         S     R6,RBTAXD(R2)                                                    
         BAS   RE,FMTTAX                                                        
*                                                                               
FA5D     DS    0H                                                               
         CLI   CCDETSW,C'Y'        2ND CURRENCY DETAIL?                         
         BNE   FA20                                                             
         LR    RF,R4                                                            
         SHI   RF,8                                                             
         LPR   RF,RF               REVERSE GROSS AND NET                        
         L     R6,4(R2,RF)                                                      
         S     R6,ROWHL+4(R2,RF)                                                
         LA    R7,ALCOL3+132                                                    
         BAS   RE,FMTEDT                                                        
         L     R6,4(R2,R4)         THEN DO OTHER                                
         S     R6,ROWHL+4(R2,R4)   BALANCE                                      
         LA    R7,ALCOL4+132                                                    
         BAS   RE,FMTEDT                                                        
         CLI   TAXSW,C'N'                                                       
         BE    FA20                                                             
         L     R6,RTAX2D(R2)                                                    
         S     R6,RBTAX2D(R2)                                                   
         LA    R7,ALCOL2+132                                                    
         BAS   RE,FMTTAX2                                                       
         B     FA20                                                             
*                                                                               
FA6      DS    0H                                                               
         CLI   FORMAT,12                                                        
         BH    FA7                                                              
*                                  FORMAT 11 - ORDERED                          
         L     R6,0(R2,R4)                                                      
         LA    R7,ALCOL4                                                        
         CLI   FORMAT,11                                                        
         BNE   *+8                                                              
         LA    R7,ALCOL3                                                        
         BAS   RE,FMTEDT                                                        
*                                                                               
         CLI   FORMAT,11                                                        
         BE    FA6D                                                             
         LA    R7,ALCOL3           SPOTS IN COL 3                               
         CLI   TAXOPT,C'E'         UNLESS TAX DETAILS (OPT A-E)                 
         BH    *+8                                                              
         LA    R7,ALCOL2                                                        
         BAS   RE,FMTEDTSP                                                      
*                                                                               
FA6D     DS    0H                                                               
         CLI   TAXOPT,C'E'         TAX DETAILS (A-E)                            
         BH    FA6E                                                             
         LA    R7,ALCOL2                                                        
         CLI   FORMAT,11                                                        
         BE    *+8                                                              
         LA    R7,ALCOL3                                                        
         L     R6,RTAXD(R2)                                                     
         BAS   RE,FMTTAX                                                        
*                                                                               
FA6E     DS    0H                                                               
         CLI   CCDETSW,C'Y'        2ND CURRENCY DETAIL?                         
         BNE   FA20                                                             
         L     R6,4(R2,R4)         ORDERED                                      
         LA    R7,ALCOL4+132                                                    
         CLI   FORMAT,11                                                        
         BNE   *+8                                                              
         LA    R7,ALCOL3+132                                                    
         BAS   RE,FMTEDT                                                        
         CLI   TAXSW,C'N'                                                       
         BE    FA20                                                             
         L     R6,RTAX2D(R2)                                                    
         LA    R7,ALCOL2+132                                                    
         CLI   FORMAT,11                                                        
         BE    *+8                                                              
         LA    R7,ALCOL3+132                                                    
         BAS   RE,FMTTAX2                                                       
         B     FA20                                                             
*                                                                               
FA7      DS    0H                                                               
*                                  FORMAT 13 - GROSS AND NET                    
         L     R6,0(R2,R4)         GROSS OR NET                                 
         LA    R7,ALCOL4                                                        
         BAS   RE,FMTEDT                                                        
*                                                                               
         LR    R6,R4                                                            
         SHI   R6,8                                                             
         LPR   R6,R6              REVERSE GROSS AND NET                         
         L     R6,0(R2,R6)                                                      
         LA    R7,ALCOL3                                                        
         BAS   RE,FMTEDT                                                        
*                                                                               
         CLI   FORMAT,13                                                        
         BE    FA7D                FOR FORMAT 14                                
         LA    R7,ALCOL2           SPOTS IN COL 2                               
         CLI   TAXOPT,C'E'         UNLESS TAX DETAILS (A-E)                     
         BH    *+8                                                              
         LA    R7,ALCOL1           THEN IN COL1                                 
         BAS   RE,FMTEDTSP                                                      
*                                                                               
FA7D     DS    0H                                                               
         CLI   TAXOPT,C'E'         TAX DETAILS (OPT A-E)                        
         BH    *+16                                                             
         LA    R7,ALCOL2                                                        
         L     R6,RTAXD(R2)                                                     
         BAS   RE,FMTTAX                                                        
*                                                                               
         CLI   CCDETSW,C'Y'        2ND CURRENCY DETAIL?                         
         BNE   FA20                                                             
         LR    R6,R4                                                            
         SHI   R6,8                                                             
         LPR   R6,R6              REVERSE GROSS AND NET                         
         L     R6,0(R2,R6)                                                      
         LA    R7,ALCOL3+132                                                    
         BAS   RE,FMTEDT                                                        
         L     R6,4(R2,R4)         ORDERED                                      
         LA    R7,ALCOL4+132                                                    
         BAS   RE,FMTEDT                                                        
         CLI   TAXSW,C'N'                                                       
         BE    FA20                                                             
         L     R6,RTAX2D(R2)                                                    
         LA    R7,ALCOL2+132                                                    
         BAS   RE,FMTTAX2                                                       
         B     FA20                                                             
*                                                                               
FA20     DS    0H                                                               
         GOTO1 ABILLEDI,DMCB,('EDMMTA',HLDINO)   EDI CALL                       
         CLI   STRIPOPT,C'N'       TEST NO STRIP COLUMN                         
         BE    FMTAMTX             (RETAIL DRAFT ONLY)                          
         CLI   WISTRIP,C'N'        TEST STRIP FOR WI/PW                         
         BE    FMTAMTX                                                          
*                                                                               
         MVI   WISTRIP,C'S'        RESET WILA STRIP                             
         CLI   TAXSW,C'N'                                                       
         BE    FA20A6                                                           
         CLI   TAXOPT,C'E'         IF SHOWED GROSS/NET LESS TAX                 
         BNE   FA20A6                                                           
         L     R0,RGRSD(R9)        MUST RE-ADD TAX FOR STRIP                    
         L     R1,RGRS2D(R9)                                                    
         A     R0,RTAXD(R9)                                                     
         A     R1,RTAX2D(R9)                                                    
         ST    R0,RGRSD(R9)                                                     
         ST    R1,RGRS2D(R9)                                                    
         L     R0,RNETD(R9)                                                     
         L     R1,RNET2D(R9)                                                    
         A     R0,RTAXD(R9)                                                     
         A     R1,RTAX2D(R9)                                                    
         ST    R0,RNETD(R9)                                                     
         ST    R1,RNET2D(R9)                                                    
         L     R0,RBGRSD(R9)                                                    
         L     R1,RBGRS2D(R9)                                                   
         A     R0,RBTAXD(R9)                                                    
         A     R1,RBTAX2D(R9)                                                   
         ST    R0,RBGRSD(R9)                                                    
         ST    R1,RBGRS2D(R9)                                                   
         L     R0,RBNETD(R9)                                                    
         L     R1,RBNET2D(R9)                                                   
         A     R0,RBTAXD(R9)                                                    
         A     R1,RBTAX2D(R9)                                                   
         ST    R0,RBNETD(R9)                                                    
         ST    R1,RBNET2D(R9)                                                   
*                                                                               
FA20A6   DS    0H                                                               
         CLI   COMMSW,C'N'         TEST COMMISSION ON STRIP OFF                 
         BE    FA20B               NO                                           
*                                  YES                                          
         L     R6,RGRSD(R2)        GROSS                                        
         S     R6,RNETD(R2)        LESS NET                                     
         CLI   FORMAT,10           IF ORDERED FMT DO NOT                        
         BNL   *+12                SUBTRACT PREV BILLS                          
         S     R6,RBGRSD(R2)       LESS BILLED GROSS                            
         A     R6,RBNETD(R2)       PLUS BILLED NET = COMMISSION                 
         LA    R7,ALSTRIP                                                       
         BAS   RE,FMTEDT                                                        
*                                                                               
         CLI   CCDETSW,C'Y'        IF DOING 2ND CURR DETAILS                    
         BNE   FA20A8                                                           
         LA    R7,132(R7)                                                       
         CLI   TAXSW,C'L'          IF HAVE TAX ON SEPARATE LINE                 
         BNE   *+8                                                              
         LA    R7,132(R7)          SKIP ANOTHER LINE                            
         L     R6,RGRS2D(R2)       GROSS                                        
         S     R6,RNET2D(R2)       LESS NET                                     
         S     R6,RBGRS2D(R2)      LESS BILLED GROSS                            
         A     R6,RBNET2D(R2)      PLUS BILLED NET = COMMISSION                 
         BAS   RE,FMTEDT                                                        
FA20A8   DS    0H                                                               
         B     FMTAMTX                                                          
*                                                                               
FA20B    DS    0H                                                               
         SHI   R4,8                REVERSE GRS-NET 'INDEX' FOR STRIP            
         LPR   R4,R4                                                            
         L     R6,0(R2,R4)                                                      
         CLI   FORMAT,10           IF ORDERED FMT DO NOT                        
         BNL   *+8                 SUBTRACT PREV BILLS                          
         S     R6,ROWHL(R2,R4)                                                  
         LA    R7,ALSTRIP                                                       
         BAS   RE,FMTEDT                                                        
         CLI   CCDETSW,C'Y'        IF DOING 2ND CURR DETAILS                    
         BNE   FA20B8                                                           
         LA    R7,132(R7)                                                       
         CLI   TAXSW,C'L'          IF HAVE TAX ON SEPARATE LINE                 
         BNE   *+8                                                              
         LA    R7,132(R7)          SKIP ANOTHER LINE                            
         L     R6,4(R2,R4)         2ND CURR GROSS/NET                           
         S     R6,ROWHL+4(R2,R4)                                                
         BAS   RE,FMTEDT                                                        
FA20B8   DS    0H                                                               
         B     FMTAMTX                                                          
         SPACE 3                                                                
*                                  SPOT DETAIL FORMATS                          
FMT30    DS    0H                                                               
         LA    R3,CLMCTLS                                                       
         LA    R7,ALCOL3                                                        
         BAS   RE,FMT36                                                         
         LA    R3,1(R3)                                                         
         LA    R7,ALCOL4                                                        
         BAS   RE,FMT36                                                         
         LA    R3,1(R3)                                                         
         LA    R7,ALSTRIP                                                       
         BAS   RE,FMT36                                                         
         B     FMTAMTX                                                          
*                                                                               
FMT36    DS    0H                                                               
         CLI   0(R3),C'*'          NOTHING                                      
         BER   RE                                                               
         LR    R4,RE                                                            
         CLI   0(R3),C'S'          SPOTS                                        
         BNE   *+12                                                             
         BAS   RE,FMTEDTSP                                                      
         B     FMT37B                                                           
*                                                                               
         L     R6,RGRSD(R2)        GROSS                                        
         CLI   0(R3),C'G'                                                       
         BE    FMT37                                                            
         L     R6,RNETD(R2)        NET                                          
         CLI   0(R3),C'N'                                                       
         BE    FMT37                                                            
         L     R6,RGRSD(R2)                                                     
         S     R6,RNETD(R2)        GROSS - NET = COMM                           
*                                                                               
FMT37    DS    0H                                                               
         BAS   RE,FMTEDT                                                        
FMT37B   DS    0H                                                               
         LR    RE,R4                                                            
         BR    RE                                                               
         SPACE 3                                                                
*              RETAIL SUMMARY PASS                                              
FMT40    DS    0H                                                               
         OC    0(4,R3),0(R3)                                                    
         BZ    FMT42               NO INV. NO.                                  
         CLC   SAVBRK,ALOWTOG                                                   
         BNE   FMT42               ONLY AT LOWEST LEVEL                         
         MVC   W(1),1(R3)                                                       
         MVC   SVTODAYB,TODAYB     SAVE TODAYB                                  
         MVC   TODAYB(1),0(R3)     SET YEAR                                     
         MVC   SVSVIMO,SVINVMO     SAVE SAVED INV MO                            
         GOTO1 AGETNUM,DMCB,(1,2(R3)),WORK                                      
         MVC   TODAYB,SVTODAYB                                                  
         MVC   SVINVMO,SVSVIMO     RESTORE SAVED SAVED INV MO                   
         MVC   ALCOL3+4(10),WORK                                                
*                                                                               
FMT42    DS    0H                                                               
         L     R6,0(R2)                                                         
         LA    R7,ALCOL4                                                        
         BAS   RE,FMTEDT                                                        
*                                                                               
FMTAMTX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
*      **NOTE- WIPRSW,X'20' MEANS THAT SOME COST SUPPRESSION IS ON              
*                                                                               
FMTEDT   DS    0H                                                               
         CLI   WISTRIP,C'S'        WILA STRIP SWITCH                            
         BE    FMTEDT2                                                          
         CLI   SVWIPRSW,0          PRINT ALL $                                  
         BE    FMTEDT2                                                          
         TM    SVWIPRSW,X'80'      PRINT ORDERED $ ONLY                         
         BZR   RE                  ELSE PRINT NONE                              
         NI    SVWIPRSW,X'FF'-X'80' LEAVE TO PRINT TAX                          
*                                                                               
FMTEDT2  DS    0H                                                               
         ST    RE,SAVRE                                                         
         CURED (R6),(15,1(R7)),CURTAB,COMMAS=YES,CR=YES                         
         L     RE,SAVRE                                                         
         CLI   14(R7),C' '                                                      
         BHR   RE                                                               
         MVC   14(2,R7),TOTSTAR                                                 
         BR    RE                                                               
         SPACE 3                                                                
FMTTAX   DS    0H                                                               
         LTR   R6,R6               SKIP IF ZERO                                 
         BZR   RE                                                               
*                                                                               
         CLI   SVWIPRSW,0          PRINT ALL $                                  
         BE    *+14                                                             
         TM    SVWIPRSW,X'40'      PRINT ORDERED $ ONLY                         
         BZR   RE                  ELSE PRINT NONE                              
         NI    SVWIPRSW,X'FF'-X'C0' LEAVE TO PRINT TAX                          
*                                                                               
         ST    RE,SAVRE                                                         
         CURED (R6),(15,1(R7)),CURTAB,CR=YES                                    
         L     RE,SAVRE                                                         
         LA    RF,3(R7)                                                         
         CLI   6(R7),C' '                                                       
         BNH   *+8                                                              
         LA    RF,2(R7)                                                         
         L     R6,=A(DICSECT)                                                   
         MVC   0(L'SPBTAX,RF),SPBTAX-DICSECT(R6)                                
         BR    RE                                                               
         SPACE 3                                                                
FMTTAX2  DS    0H                                                               
         LTR   R6,R6               SKIP IF ZERO                                 
         BZR   RE                                                               
*                                                                               
         ST    RE,SAVRE                                                         
         CURED (R6),(15,1(R7)),CURTAB,CR=YES                                    
         L     RE,SAVRE                                                         
         BR    RE                                                               
         SPACE 2                                                                
FMTEDTSP DS    0H                                                               
         CLC   SAVBRK,ADESCBRK     NO SPOTS COUNT AT SPOT LEVEL                 
         BER   RE                                                               
         L     R0,RSPTD(R2)                                                     
         CLI   QRETCD,C'C'         FOR SPECIAL RETAIL CREDIT BILL               
         BNE   *+8                                                              
         L     R0,RSPTD+ROWHL(R2)  GET SPOTS FROM PREVIOUS BILLING              
*                                                                               
         EDIT  (R0),(5,10(R7))                                                  
         BR    RE                                                               
*                                                                               
         DROP  R5                                                               
*                                                                               
         LTORG                                                                  
         TITLE 'LSTINV  - ROUTINE FOR PREVIOUS BILLING'                         
LSTINV   NMOD1 LSTQ,LSTINV                                                      
         LR    R9,RC                                                            
         USING LSTD,R9                                                          
         LA    RC,SPACEND                                                       
         SPACE 2                                                                
         L     R3,SAVBRK           RESTORE A(BREAK LEVEL)                       
         L     RF,BRKCODE                                                       
         L     RF,ATOTS(RF)             POINT TO ACCUM                          
         LR    R7,RF                                                            
         AHI   R7,MAXMOS*ROWL      POINT TO TOTAL ROW                           
*                                                                               
         CLI   LSTOPT,C'A'         NEED PREV $$ IN ACTUAL ??                    
         BNE   *+12                                                             
         BRAS  RE,CALCACT          CALCULATE ACTUAL                             
         MVI   BYTE,C'A'           HOPEFULLY WE GOT ACT FOR ALL ENTRIES         
*                                                                               
         MVI   LISTSW,0                                                         
         CLI   LSTOPT,C'N'         IF ACTUALLY LISTING INVOICES                 
         BE    LI1H                                                             
         MVI   LISTSW,C'N'                                                      
         BAS   RE,LSTLST           SEE IF ANY LIST ENTRIES                      
         CLI   LISTSW,C'N'                                                      
         BE    LSTINVX             NO, EXIT                                     
*                                                                               
LI1H     DS    0H                                                               
         MVI   PRSW,C'H'           SET TO HOLD PRINT LINES                      
         MVI   COLMNS,2                                                         
         CLI   FORMAT,13                                                        
         BH    *+16                                                             
         CLI   FORMAT,9                                                         
         BE    *+8                                                              
         MVI   COLMNS,1                                                         
*                                                                               
         LA    R2,P                                                             
         CLI   FORMAT,8                                                         
         BE    *+12                                                             
         CLI   FORMAT,11                                                        
         BNE   *+8                                                              
         SHI   R2,16          SHIFT SINGLE COL. FORMATS LEFT 1 COL.             
*                                                                               
         USING ALINED,R2                                                        
*                                                                               
         XC    LSTTOTS(LSTTOTSL),LSTTOTS                                        
*                                                                               
         CLI   FORMAT,10                                                        
         BNH   LI40                FORMATS  1 - 10                              
*                                                                               
         EJECT                                                                  
*                             SUBTRACT OUT PREVIOUS BILLS                       
*                             ON SAME INVOICE                                   
* FORMATS 11+ (ORDERED ONLY)                                                    
*                                                                               
         OC    ROWHL(16,R7),ROWHL(R7)   ANY PREVIOUS BILLING?                   
         BZ    LSTINVX                                                          
         CLI   LSTOPT,C'N'         TEST ACTUALLY LISTING INV NO'S               
         BNE   LI34                YES                                          
*                                 ELSE JUST SUBTRACTING TOTAL PREVIOUS          
         MVC   LSTGRS,ROWHL(R7)     GROSS                                       
         MVC   LSTGRS2,ROWHL+4(R7)  GROSS2                                      
         MVC   LSTNET,ROWHL+8(R7)   NET                                         
         MVC   LSTNET2,ROWHL+12(R7) NET2                                        
*                                                                               
         LA    R5,ALCOL2-8                                                      
         CLI   COLMNS,1                                                         
         BNE   *+8                                                              
         LA    R5,16(R5)                                                        
         CLI   GNSW,C'N'           IF SHOWING NET                               
         BNE   LI32                                                             
         CLI   PROFB1X+9,C'Y'      AND PROFILE OTPION SAYS TO                   
         BNE   LI32                                                             
         CLI   FORMAT,9            BUT SKIP FOR FORMATS 9,13,14                 
         BE    LI32                (GROSS AND NET ON BILL)                      
         CLI   FORMAT,13                                                        
         BE    LI32                                                             
         CLI   FORMAT,14                                                        
         BE    LI32                                                             
         SHI   R5,L'SP@NET+3       BACK UP ENOUGH FOR 'NET'                     
         LA    RF,L'SP@LPB(R5)                                                  
         MVI   1(RF),C'('                                                       
         L     RE,=A(DICSECT)                                                   
         MVC   2(L'SP@NET,RF),SP@NET-DICSECT(RE)                                
         MVI   L'SP@NET+2(RF),C')'                                              
*                                                                               
LI32     DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         MVC   0(L'SP@LPB,R5),SP@LPB-DICSECT(RE)  LESS PREVIOUS BILLING         
         MVC   X(4),LSTGRS                                                      
         MVC   X+4(4),LSTGRS2                                                   
         MVC   X+8(4),LSTNET                                                    
         MVC   X+12(4),LSTNET2                                                  
*                                                                               
         BAS   RE,LSTFMT                                                        
         BRAS  RE,PRNT                                                          
         CLI   COLMNS,1                                                         
         BE    *+10                                                             
         MVC   ALCOL3+4(10),DASHES                                              
         MVC   ALCOL4+4(10),DASHES                                              
*                                                                               
         LR    R1,R7                                                            
         LA    RF,X                                                             
         XC    X,X                                                              
         LHI   R0,4                GROSS AND NET                                
*                                                                               
LI33     DS    0H                                                               
         L     RE,0(R1)            ORDERED                                      
         S     RE,ROWHL(R1)        LESS BILLED                                  
         ST    RE,0(RF)                                                         
         LA    R1,4(R1)                                                         
         LA    RF,4(RF)                                                         
         BCT   R0,LI33                                                          
*                                                                               
         BAS   RE,LSTFMT                                                        
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
         B     LI80                                                             
*                                                                               
LI34     DS    0H                                                               
         LA    R5,ALCOL2-8                                                      
         CLI   COLMNS,1                                                         
         BNE   *+8                                                              
         LA    R5,16(R5)                                                        
         CLI   GNSW,C'N'           IF SHOWING NET                               
         BNE   LI34C                                                            
         CLI   PROFB1X+9,C'Y'      AND PROFILE OTPION SAYS TO                   
         BNE   LI34C                                                            
         CLI   FORMAT,9            BUT SKIP FOR FORMATS 9,13,14                 
         BE    LI34C               (GROSS AND NET ON BILL)                      
         CLI   FORMAT,13                                                        
         BE    LI34C                                                            
         CLI   FORMAT,14                                                        
         BE    LI34C                                                            
         SHI   R5,L'SP@NET+3       BACK UP ENOUGH FOR 'NET'                     
         LA    RF,L'SP@LPB(R5)                                                  
         MVI   1(RF),C'('                                                       
         L     RE,=A(DICSECT)                                                   
         MVC   2(L'SP@NET,RF),SP@NET-DICSECT(RE)                                
         MVI   L'SP@NET+2(RF),C')'                                              
         MVC   132(L'SP@NET+3,RF),DASHES                                        
*                                                                               
LI34C    DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         MVC   0(L'SP@LPB,R5),SP@LPB-DICSECT(RE)  LESS PREVIOUS BILLING         
         MVC   132(L'SP@LPB,R5),DASHES                                          
         BRAS  RE,PRNT                                                          
         BAS   RE,LSTLST                                                        
*                                                                               
         LR    R1,R7                                                            
         LA    RF,X                                                             
         XC    X,X                                                              
         LHI   R0,4                GROSS AND NET                                
*                                                                               
LI35     DS    0H                                                               
         L     RE,0(R1)            ORDERED                                      
         S     RE,ROWHL(R1)        LESS BILLED                                  
         ST    RE,0(RF)                                                         
         LA    R1,4(R1)                                                         
         LA    RF,4(RF)                                                         
         BCT   R0,LI35                                                          
*                                                                               
         BAS   RE,LSTFMT                                                        
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
         B     LI80                                                             
         EJECT                                                                  
*                             IF FORMAT 1 - 10 BILL IS COMPLETE                 
*                             AND PREV LIST IS JUST FOR INFO                    
LI40     DS    0H                                                               
*                                  SHIFT ALL COLUMNS LEFT 1                     
*                                  TO AVOID CONFUSION OVER AMOUNT DUE           
         SHI   R2,16                                                            
         LA    R5,ALCOL2                                                        
         CLI   COLMNS,1                                                         
         BNE   *+8                                                              
         LA    R5,16(R5)                                                        
         CLI   GNSW,C'N'           IF SHOWING NET                               
         BNE   LI42                                                             
         CLI   PROFB1X+9,C'Y'      AND PROFILE OTPION SAYS TO                   
         BNE   LI42                                                             
         CLI   FORMAT,9            BUT SKIP FOR FORMATS 9,13,14                 
         BE    LI42                (GROSS AND NET ON BILL)                      
         CLI   FORMAT,13                                                        
         BE    LI42                                                             
         CLI   FORMAT,14                                                        
         BE    LI42                                                             
         SHI   R5,L'SP@NET+3       BACK UP ENOUGH FOR 'NET'                     
         L     RE,=A(DICSECT)                                                   
         MVC   0(L'SP@PRVBL,R5),SP@PRVBL-DICSECT(RE)                            
         LA    RF,L'SP@PRVBL(R5)                                                
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         LA    RF,1(RF)                                                         
         MVI   1(RF),C'('                                                       
         L     RE,=A(DICSECT)                                                   
         MVC   2(L'SP@NET,RF),SP@NET-DICSECT(RE)                                
         MVI   L'SP@NET+2(RF),C')'                                              
         MVC   132(L'SP@NET+3,RF),DASHES                                        
         B     LI42B                                                            
*                                                                               
LI42     DS    0H                                                               
         L     RE,=A(DICSECT)                                                   
         MVC   0(L'SP@PRVBL,R5),SP@PRVBL-DICSECT(RE)  PREVIOUS BILLS            
LI42B    DS    0H                                                               
         MVC   132(L'SP@PRVBL,R5),DASHES                                        
         BRAS  RE,PRNT                                                          
*                                                                               
         BAS   RE,LSTLST                                                        
*                                                                               
LI80     DS    0H                                                               
         MVI   PRSW,C'F'           FLUSH PRINT LINES                            
         BRAS  RE,PRNT                                                          
*                                                                               
         CLI   LSTOPT,C'R'         TEST TO REPEAT AMOUNT DUE                    
         BNE   LSTINVX                                                          
         CLI   FORMAT,10           SKIP FOR ORDERED ONLY FMTS                   
         BH    LSTINVX                                                          
         MVC   P,SVAMTDUE                                                       
         BRAS  RE,PRNT                                                          
*                                                                               
         SPACE 2                                                                
LSTINVX  DS    0H                                                               
         XIT1                                                                   
         EJECT                                                                  
LSTLST   NTR1                                                                   
         SPACE 2                                                                
         L     R6,INVTABN          FOR BCT                                      
         LTR   R6,R6                                                            
         BNP   LSTINVX                                                          
         L     R4,AINVTAB          START OF TABLE                               
         XC    X,X                                                              
         USING INVLD,R4                                                         
*                                  SET TO HOLD PRINT LINES                      
LST11    DS    0H                                                               
         CLC   CLTCURR,INVLCURR    FOR COS2, ONLY TAKE COS2                     
         BNE   LST30                                                            
*                                                                               
         CLC   APRDBRK,AINVBRK     TEST PROD SEP                                
         BH    LST12               NO                                           
         L     RF,APRD             YES - MUST BE RIGHT PROD                     
         ZIC   RE,0(RF)                                                         
         MHI   RE,4                                                             
         L     RF,ADCLT                                                         
         LA    RF,CLIST-CLTHDR(RF,RE)                                           
         CLC   INVLPRD,3(RF)                                                    
         BNE   LST30                                                            
         B     LST14                                                            
*                                                                               
LST12    DS    0H                                                               
         OC    APGR1BRK,APGR1BRK                                                
         BZ    LST14                                                            
         CLC   APGR1BRK,AINVBRK    TEST PGR SEP                                 
         BH    LST14               NO                                           
*                                                                               
         L     RE,PRDLIST          YES - MUST BE RIGHT PGR                      
LST12B   DS    0H                                                               
         CLC   INVLPRD,5(RE)                                                    
         BE    *+12                                                             
         LA    RE,6(RE)                                                         
         B     LST12B                                                           
*                                                                               
         CLC   0(2,RE),BPGR+1                                                   
         BNE   LST30                                                            
*                                                                               
LST14    DS    0H                                                               
         CLC   AESTBRK,AINVBRK     TEST EST SEP                                 
         BH    LST16               NO                                           
*                                                                               
         L     RF,AEST             YES - MUST BE RIGHT EST                      
         CLC   INVLEST,0(RF)                                                    
         BNE   LST30                                                            
*                                                                               
LST16    DS    0H                                                               
         CLC   AMKTBRK,AINVBRK     TEST MKT SEP                                 
         BH    LST18               NO                                           
         L     RF,AMKT             YES - MUST BE RIGHT MKT                      
         CLC   INVLMKT,0(RF)                                                    
         BE    LST20                                                            
         B     LST30                                                            
*                                                                               
LST18    DS    0H                                                               
         OC    AMGR1BRK,AMGR1BRK                                                
         BZ    LST20                                                            
         CLC   AMGR1BRK,AINVBRK    TEST MGR SEP                                 
         BH    LST20               NO                                           
         CLC   INVLMGR,BMGR+1                                                   
         BNE   LST30                                                            
*                                                                               
LST20    DS    0H                                                               
         CLC   APERBRK,AINVBRK     TEST PERIOD SEP                              
         BH    LST22               NO                                           
         L     RE,APER                                                          
         ZIC   RF,0(RE)                                                         
         LA    RF,PERLIST(RF)                                                   
         CLC   INVLPER,PERLMOS-PERLISTD(RF)                                     
         BNE   LST30                                                            
*                                                                               
LST22    DS    0H                                                               
*                                  BILL HAS PASSED ALL TESTS                    
         CLI   LISTSW,C'Y'         IS THIS THE TEST PASS                        
         BE    *+12                                                             
         MVI   LISTSW,C'Y'         SET HAVE BILLS TO LIST                       
         B     LSTINVX                                                          
*                                                                               
         ST    R4,LASTINV          SAVE A(TABLE ENTRY)                          
         CLI   WIOPT,C'Y'          IF PW                                        
         BE    LST24               USE +4 SLOTS                                 
         CLI   CLTCURR,0           IF DOING CLT CURRENCY (YKVA)                 
         BE    *+12                                                             
         CLI   CCDETSW,C'Y'        UNLESS SHOWING BOTH DETAILS                  
         BNE   LST24               USE +4 SLOTS FOR COST2                       
*                                                                               
         CLI   BYTE,C'A'                                                        
         BNE   *+12                                                             
         ICM   RE,15,INVLACT       NON-PW                                       
         B     *+8                                                              
*                                                                               
         ICM   RE,15,INVLGRS       NON-PW                                       
         A     RE,X+RGRSD                                                       
         ST    RE,X+RGRSD                                                       
         ICM   RE,15,INVLNET                                                    
         A     RE,X+RNETD                                                       
         ST    RE,X+RNETD                                                       
         B     LST25                                                            
*                                                                               
LST24    DS    0H                                                               
         CLI   BYTE,C'A'                                                        
         BNE   *+12                                                             
         ICM   RE,15,INVLACT       NON-PW                                       
         B     *+8                                                              
*                                                                               
         ICM   RE,15,INVLGRS       PW- USE +4 SLOTS                             
         A     RE,X+RGRS2D                                                      
         ST    RE,X+RGRS2D                                                      
         ICM   RE,15,INVLNET                                                    
         A     RE,X+RNET2D                                                      
         ST    RE,X+RNET2D                                                      
*                                                                               
LST25    DS    0H                                                               
         CLC   INVLYR(INVYMIL),INVLYR+INVTABRL LAST FOR THIS DTE/INVNO?         
         BNE   LST28               TIME TO PRINT                                
         CLC   APRDBRK,AINVBRK     PRODUCT SEPARATE?                            
         BH    *+14                NO, DON'T CHECK IT                           
         CLC   INVLPRD,INVLPRD+INVTABRL  SAME PRODUCT?                          
         BNE   LST28               TIME TO PRINT                                
*                                                                               
         CLC   AESTBRK,AINVBRK     ESTIMATE SEPARATE?                           
         BH    LST30               NO                                           
         CLC   INVLEST,INVLEST+INVTABRL  SAME ESTIMATE                          
         BE    LST30               IF SAME DON'T PRINT                          
*                                                                               
*                                                                               
*                                                                               
LST28    BAS   RE,LSTOUT           YES, PRINT INVOICE LINE                      
*                                                                               
LST30    DS    0H                                                               
         A     R4,INVTABL                                                       
         BCT   R6,LST11                                                         
*                                                                               
         CLI   LISTSW,C'N'         IS THIS THE TEST PASS                        
         BE    LSTINVX             YES, DONE                                    
*                                                                               
         OC    X,X                 DO WE HAVE UNPRINTED INVOICE?                
         BZ    *+12                                                             
         L     R4,LASTINV          A(INVOICE TABLE ENTRY)                       
         BAS   RE,LSTOUT           PRINT LAST INVOICE                           
*                                                                               
         OC    LSTNUM,LSTNUM                                                    
         BZ    LST32                                                            
         CLI   COLMNS,1                                                         
         BE    *+10                                                             
         MVC   ALCOL3+4(10),DASHES                                              
         MVC   ALCOL4+4(10),DASHES                                              
         BRAS  RE,PRNT                                                          
         CLI   FORMAT,10           BYPASS TOTAL OF BILLS                        
         BH    LST32               IF ORDERED ONLY FORMAT                       
         MVC   X(4),LSTGRS         TOTAL OF BILLS                               
         MVC   X+4(4),LSTGRS2                                                   
         MVC   X+8(4),LSTNET                                                    
         MVC   X+12(4),LSTNET2                                                  
         BAS   RE,LSTFMT                                                        
         MVI   SPACING,2                                                        
         BRAS  RE,PRNT                                                          
LST32    DS    0H                                                               
         B     LSTINVX                                                          
         SPACE 3                                                                
LSTOUT   NTR1                      PRINT INVOICE LINE                           
*                                                                               
         MVC   W(1),INVLMO         SET MO FOR GETNUM                            
         MVC   SVTODAYB,TODAYB     SAVE TODAYB                                  
         MVC   TODAYB(1),INVLYR    SET YEAR                                     
         LA    R5,ALCOL2+3                                                      
         CLI   COLMNS,1                                                         
         BNE   *+8                                                              
         LA    R5,16(R5)                                                        
         MVC   SVSVIMO,SVINVMO     SAVE SAVED INV MO                            
         GOTO1 AGETNUM,DMCB,(1,INVLINV),WORK    FORMAT INV NO                   
         MVC   0(10,R5),WORK                                                    
         MVC   TODAYB,SVTODAYB     SAVE TODAYB                                  
         MVC   SVINVMO,SVSVIMO     RESTORE SAVED SAVED INV MO                   
         BAS   RE,LSTFMT                                                        
         BRAS  RE,PRNT                                                          
*                                  TOTALS                                       
         L     RF,LSTNUM           COUNT                                        
         AHI   RF,1                                                             
         ST    RF,LSTNUM                                                        
         CLI   WIOPT,C'Y'          IF PW                                        
         BE    LSTOUT4             USE +4 SLOTS                                 
         CLI   CLTCURR,0           IF DOING CLT CURRENCY (YKVA)                 
         BE    *+12                                                             
         CLI   CCDETSW,C'Y'        UNLESS SHOWING BOTH DETAILS                  
         BNE   LSTOUT4             USE +4 SLOTS FOR COST2                       
*                                                                               
         L     RF,LSTGRS           GROSS                                        
         A     RF,X+RGRSD                                                       
         ST    RF,LSTGRS                                                        
         L     RF,LSTNET           NET                                          
         A     RF,X+RNETD                                                       
         ST    RF,LSTNET                                                        
         B     LSTOUT6                                                          
*                                                                               
LSTOUT4  DS    0H                                                               
         L     RF,LSTGRS2          GROSS                                        
         A     RF,X+RGRS2D                                                      
         ST    RF,LSTGRS2                                                       
         L     RF,LSTNET2          NET                                          
         A     RF,X+RNET2D                                                      
         ST    RF,LSTNET2                                                       
*                                                                               
LSTOUT6  DS    0H                                                               
         GOTO1 ABILLEDI,DMCB,('EDMLST',WORK),X+RGRSD,X+RNETD                    
         XC    X,X                 CLEAR WORK AREA                              
*                                                                               
LSTOUTX  DS    0H                                                               
         B     LSTINVX                                                          
*                                                                               
         DROP  R4                                                               
         SPACE 3                                                                
LSTFMT   NTR1                                                                   
         CLI   WIOPT,C'Y'          FOR WESTERN PW                               
         BNE   LSTFMT3                                                          
         L     R1,X+4              ROUND GROSS                                  
         M     R0,=F'1'                                                         
         LHI   RF,100                                                           
         DRNDR (R0),(RF)                                                        
         M     R0,=F'100'                                                       
         ST    R1,X+4                                                           
*                                                                               
LSTFMT3  DS    0H                                                               
         MVC   WK(16),X            AMOUNTS IN WK                                
*                                                                               
         LA    R1,WK                                                            
         CLI   CLTCURR,0           IF DOING CLT CURRENCY                        
         BE    *+16                                                             
         CLI   CCDETSW,C'Y'        UNLESS SHOWING BOTH DETAILS                  
         BE    *+8                                                              
         LA    R1,4(R1)            POINT TO COST2 ACCUMS                        
*                                                                               
         CLI   COLMNS,1                                                         
         BNE   LSTFMT4                                                          
*                                  ONE COLUMN                                   
         L     R0,RGRSD(R1)                                                     
         CLI   GNSW,C'G'                                                        
         BE    *+16                                                             
         CLI   BYTE,C'A'           IF DOING ACTUAL, IT'S IN GROSS FIELD         
         BE    *+8                                                              
         L     R0,RNETD(R1)                                                     
*                                                                               
         LA    R6,ALCOL4                                                        
         BAS   RE,LSTEDT                                                        
         B     LSTFMTX                                                          
*                                                                               
LSTFMT4  DS    0H                  2 COLUMNS                                    
         L     R0,RGRSD(R1)                                                     
         L     R3,RNETD(R1)                                                     
         CLI   GNSW,C'N'                                                        
         BE    *+10                                                             
         XR    R0,R3                                                            
         XR    R3,R0                                                            
         XR    R0,R3                                                            
*                                                                               
         LA    R6,ALCOL3                                                        
         BAS   RE,LSTEDT                                                        
         LA    R6,16(R6)                                                        
         LR    R0,R3                                                            
         BAS   RE,LSTEDT                                                        
*                                                                               
LSTFMTX  DS    0H                                                               
         B     LSTINVX                                                          
         DROP  R2                                                               
         SPACE 3                                                                
LSTEDT   DS    0H                                                               
         ST    RE,SAVRE                                                         
         CURED (R0),(16,0(R6)),CURTAB,COMMAS=YES,CR=YES                         
         L     RE,SAVRE                                                         
         CLI   14(R6),C' '                                                      
         BNER  RE                                                               
         MVC   14(2,R6),TOTSTAR                                                 
         BR    RE                                                               
         DROP  R3,R9                                                            
         SPACE 3                                                                
         EJECT                                                                  
         LTORG                                                                  
         EJECT                                                                  
LSTD     DSECT                                                                  
LASTINV  DS    F                                                                
*                                                                               
LSTTOTS  DS    0X                                                               
LSTGRS   DS    F                                                                
LSTGRS2  DS    F                                                                
LSTNET   DS    F                                                                
LSTNET2  DS    F                                                                
LSTNUM   DS    F                                                                
LSTTOTSL EQU   *-LSTTOTS                                                        
LSTQ     EQU   *-LSTD                                                           
         TITLE 'SPB12D - SPOT BILLING/SOURCE BOOK D'                            
***********************************************************************         
*                                                                               
*        SETCPVC  SETS CLIENT/PRODUCT VAT CODES (CVATCDS)                       
*                 AND 'MIXED PROD' SWITCHES     (CVATPSWS)                      
*                                                                               
*        PARM1  BYTE  0   PRODUCT CODE                                          
*               BYTES 1-3 NOTE USED                                             
*                                                                               
*        NOTE- MAYBE SHOULD TABLE PRODUCT INFO TO SAVE RE-READS                 
*        NOTE- MAYBE IT SHOULD BE POSSIBLE TO HAVE PST WITHOUT                  
*              GST BUT THAT WOULD NEED SOME WORK. (TOO MUCH RELIANCE            
*              ON CVATSW (NOT CVATSWS) TO CONTROL VAT LOGIC?)                   
*                                                                               
***********************************************************************         
*                                                                               
*    FEB09/98 - LEV 96, GRANT. ABEND AT VB2C3 NOOP'D.                           
*                                                                               
***********************************************************************         
         SPACE 3                                                                
SPB102   CSECT                                                                  
SETCPVC  NMOD1 SPCWRKL,SETCPVC                                                  
         LR    R9,RC                                                            
         USING SPCWRKD,R9                                                       
         LA    RC,SPACEND                                                       
*                                                                               
         CLI   CVATCOD,0           IF GST CODE WAS SET TO NULLS                 
         BE    SCPVX               DONT PICK UP ANY NOW                         
*                                                                               
         LA    R2,CVATCDS          VAT CODES                                    
         XC    0(NPROVS+1,R2),0(R2)                                             
         LA    R3,CVATPSWS         'MIXED PROD' SWITCHES                        
         XC    0(NPROVS+1,R3),0(R3)                                             
*                                                                               
         LA    R6,NVATCDS          VAT CODES FOR JUL/10 MOS                     
         XC    0(NPROVS+1,R6),0(R6)                                             
         LA    R7,NVATPSWS         'MIXED PROD' SWITCHES  JUL/10 MOS            
         XC    0(NPROVS+1,R7),0(R7)                                             
*                                                                               
         L     RF,ADCLT                                                         
         MVC   1(NPROVS,R2),CPST-CLTHDR(RF)     PSTS                            
         MVC   0(1,R2),CEXTRA+11-CLTHDR(RF)      GST CODE                       
         CLI   0(R2),C'0'          ZERO                                         
         BNE   *+8                                                              
         MVI   0(R2),C'S'          GST DEFAULT IS S                             
*                                                                               
         MVC   0(1,R6),CEXTRA+11-CLTHDR(RF)      GST CODE (NEW PLACE)           
         ZIC   RE,CMPST-CLTHDR(RF)              INDEX INTO PST TABLE            
         LTR   RE,RE                            ANYTHING IN MAIN PST?           
         BZ    *+12                                                             
         AR    RE,R6                                                            
         MVC   0(1,RE),CMPST+1-CLTHDR(RF)       NEW FLD - ONLY ONE PST          
*                                                                               
         CLI   0(R6),C'0'          ZERO                                         
         BNE   *+8                                                              
         MVI   0(R6),C'S'          GST DEFAULT IS S                             
*                                                                               
         OC    0(NPROVS+1,R2),0(R2)              ANY VATS AT ALL?               
         BZ    SCPVX                             NO, DONE                       
*                                                                               
         L     RF,ADCLT                                                         
         LA    RE,CLIST-CLTHDR(RF)                                              
         LHI   R0,220                                                           
*                                                                               
SCPV4    DS    0H                                                               
         CLC   0(1,R1),3(RE)       PROD MNEMONIC                                
         BE    *+14                                                             
         LA    RE,4(RE)                                                         
         BCT   R0,SCPV4                                                         
         DC    H'0'                                                             
*                                                                               
         MVC   SPCWORK(13),0(RF)                                                
         MVC   SPCWORK+4(3),0(RE)   3 CHAR PRD CODE                             
         L     RF,ADPRD                                                         
         CLC   SPCWORK(13),0(RF)    TEST ALREADY HAVE PRDHDR                    
         BE    SCPV8                                                            
*                                                                               
         MVC   SCPSVKEY,KEY        SAVE KEY                                     
         MVC   KEY(13),SPCWORK                                                  
         GOTO1 READ                                                             
         GOTO1 GETPRD                                                           
         MVC   KEY,SCPSVKEY        RESTORE KEY                                  
         GOTO1 HIGH                AND SEQ                                      
*                                                                               
SCPV8    DS    0H                                                               
         XC    SPCWORK(22),SPCWORK   11 X 2                                     
         L     RF,ADPRD                                                         
         MVC   SPCWORK(1),PGSTCODE-PRDHDR(RF)                                   
         MVC   SPCWORK+11(1),PGSTCODE-PRDHDR(RF)                                
         MVC   SPCWORK+1(NPROVS),PPST-PRDHDR(RF)                                
         LA    R4,SPCWORK+11                                                    
         ZIC   RE,PMPST-PRDHDR(RF) INDEX INTO PROVINCE                          
         LTR   RE,RE                                                            
         BZ    *+12                                                             
         AR    RE,R4                                                            
         MVC   0(1,RE),PMPST+1-PRDHDR(RF)  NEW TAX (ONLY ONE)                   
*                                                                               
         LA    R4,SPCWORK                                                       
         LHI   R5,NPROVS+1                                                      
*                                                                               
SCPV9    DS    0H                                                               
         CLI   0(R4),C'0'          ZERO                                         
         BNE   *+8                                                              
         MVI   0(R4),0             BECOMES NULL                                 
         CLI   0(R4),C' '               SET FROM PRDHDR                         
         BNH   SCPV12                   IF PRESENT                              
         CLC   0(1,R2),0(R4)            IF PRODUCT NOT = CLIENT                 
         BE    *+14                                                             
         MVI   0(R3),C'M'          SET HAVE MIXED PRD VAT CODES                 
         MVC   0(1,R2),0(R4)       SET VALUE FROM PRODUCT                       
*                                                                               
SCPV12   DS    0H                                                               
         LA    R2,1(R2)            NEXT PROVINCE                                
         LA    R3,1(R3)                                                         
         LA    R4,1(R4)                                                         
         BCT   R5,SCPV9                                                         
*                                                                               
         LA    R4,SPCWORK+11                                                    
         LA    R5,NPROVS+1                                                      
SCPV14   DS    0H                                                               
         CLI   0(R4),C'0'          ZERO                                         
         BNE   *+8                                                              
         MVI   0(R4),0             BECOMES NULL                                 
         CLI   0(R4),C' '               SET FROM PRDHDR                         
         BNH   SCPV15                   IF PRESENT                              
         CLC   0(1,R6),0(R4)            IF PRODUCT NOT = CLIENT                 
         BE    *+14                                                             
         MVI   0(R7),C'M'          SET HAVE MIXED PRD VAT CODES                 
         MVC   0(1,R6),0(R4)       SET VALUE FROM PRODUCT                       
         B     SCPV16                                                           
*                                                                               
SCPV15   OC    SPCWORK+12(10),SPCWORK+12  DO I HAVE ANY PRD MAIN PST?           
         BZ    SCPV16                                                           
         C     R5,=F'11'            GST FIELD?                                  
         BE    *+10                 IF SO DON'T STORE                           
*                                   NEEDED IN CASE THEY DID NOT SET             
*                                   GST TO S WHEN THE PRODUCT                   
*                                   HAS A MAIN PST OF PQ=S                      
*                                   LEAVE VALUE FROM THE CLIENT                 
*                                                                               
         MVC   0(1,R6),0(R4)        IF SO THEN STORE THIS VALUE                 
*                                                                               
SCPV16   DS    0H                                                               
         LA    R6,1(R6)            NEXT PROVINCE                                
         LA    R7,1(R7)                                                         
         LA    R4,1(R4)                                                         
         BCT   R5,SCPV14                                                        
         B     SCPVX                                                            
*                                                                               
SCPVX    DS    0H                                                               
         XIT1                                                                   
         DROP  R9                                                               
*                                                                               
         LTORG                                                                  
*                                                                               
SPCWRKD  DSECT                                                                  
SPCWORK  DS    XL64                                                             
SCPSVKEY DS    XL32                                                             
SPCWRKL  EQU   *-SPCWRKD                                                        
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBADD    ADD TO VAT BASIS TABLE                                        
*                                                                               
*        PARM1  BYTE  0   C=CLEAR                                               
*               BYTES 1-3 A(RDBUFF BUFFALO RECORD)                              
*        PARM2  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(BRKTAB ENTRY)                                       
*                                                                               
*        NOTE-   PST LOGIC (SUCH AS IT IS) IS BUILT AROUND THERE                
*              BEING ONLY ONE EFFECTIVE VAT CODE FOR EACH PROVINCE              
*              (INCLUDING NATIONAL). THIS CODE IS S. OTHER CODES                
*              SHOULD HAVE 0%.                                                  
*                IF THIS IS A PROBLEM IT CAN BE AT LEAST PARTIALLY              
*              ADDRESSED BY RESTRUCTURING THE VBATAB TO INCLUDE                 
*              THE VAT CODE.                                                    
*                THE VBATAB IS NOW INDEXED BY PROVINCE NUMBER (0=GST).          
*              NOTE THAT CVATCDS IS SET FROM CLT/PRD AND NOT AFFECTED           
*              BY STATION VAT CODES, WHICH ARE USED JUST TO BUILD THE           
*              VBTAB.                                                           
*                                                                               
***********************************************************************         
         SPACE 2                                                                
SPB102   CSECT                                                                  
*                                                                               
VBADD    NMOD1 VBAWRKL,VBADD                                                    
         LR    R9,RC                                                            
         USING VBAWRKD,R9                                                       
         LA    RC,SPACEND                                                       
         L     R3,4(R1)                                                         
         ST    R3,VBABRK           SAVE A(BREAK TABLE ENTRY)                    
         MVC   VBABRKC,BRKCODE-BRKTABD(R3)                                      
         ST    R1,VBASVR1                                                       
         MVI   VBANPST,0                                                        
         SPACE 2                                                                
         CLI   0(R1),C'C'          CLEAR COMMAND                                
         BNE   VB2                                                              
*                                                                               
         L     R0,=A(VBTAB)                                                     
         L     R1,=A(VTOTSIZE*MAXLEVS)                                          
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
         B     VBADDX                                                           
*                                                                               
VB2      DS    0H                                                               
         SR    R7,R7                                                            
         ICM   R7,7,1(R1)          A(RDBUFF BUFFALO RECORD)                     
         L     RF,ASORTDTA                                                      
         LA    R0,SORTREC                                                       
         SR    RF,R0                                                            
         AR    R7,RF               R7 NOW POINTS TO DATA AREA                   
*                                                                               
         L     RE,APRD             PRODUCT CODE                                 
         CLC   LASTPRD,0(RE)       SAME AS LAST?                                
         BE    VB2C                YES, SKIP GETTING VAT CODES FOR PROD         
         MVC   LASTPRD,0(RE)                                                    
*                                  GET PROPER PRODUCT CODE                      
         ZIC   RF,0(RE)                                                         
         MHI   RF,4                PRD SEQ NO X 4                               
         L     R2,ADCLT                                                         
         LA    R2,CLIST-CLTHDR(R2,RF)                                           
         ZIC   R3,3(R2)                                                         
         GOTOR SETCPVC,VBADMCB,((R3),0)                                         
*                                                                               
VB2C     DS    0H                                                               
         XC    SVSPSTS,SVSPSTS                                                  
*                                                                               
         MVI   JUL10SW,C'Y'        SET JUL10SW TO Y IF MOS IS AFTER             
*                                  JUN/10                                       
         LA    R2,NVATCDS+1        NEW PST CODES                                
         L     RF,APER             PERIOD (MOS)                                 
         ZIC   R4,0(RF)                                                         
         LA    R4,PERLIST(R4)                                                   
         CLC   0(2,R4),=X'6E07'    CHECK IF MOS JUL/10 OR LATER                 
         BNL   *+8                 IF SO TREAT LIKE PST FOR ALL STATS           
         MVI   JUL10SW,C'N'                                                     
         CLI   JUL10SW,C'Y'                                                     
         BE    VB2C1                                                            
*                                  SELECT 1ST PST                               
         CLI   PROFB1A+3,C'Y'      TEST TO DO PST FOR ALL STATIONS              
         BNE   VB2C4                                                            
*                                  SELECT 1ST PST                               
         LA    R2,CVATCDS+1        IN CLT/PRD LIST                              
         L     RF,ADPRD           IF NOTHING IN PRODUCT REC                     
         USING PRDHDR,RF                                                        
         OC    PPST,PPST                                                        
         BZ    *+8                                                              
         LA    R2,PPST             ELSE USE PRODUCT LEVEL PSTS                  
         DROP  RF                                                               
*                                                                               
         CLI   JUL10SW,C'Y'       CHECK MOS (FROM APER) VS. JUL/10              
         BE    VB2C1              IF AFTER LEAVE CODES ALONE                    
         MVI   0(R2),C' '         NO BC HST BEFORE JUL/10                       
         MVI   4(R2),C' '         NOR ON HST                                    
*                                                                               
VB2C1    LA    R3,SVSPSTS                                                       
         LHI   R0,NPROVS                                                        
*                                                                               
VB2C2    DS    0H                                                               
         CLI   0(R2),C' '          USE FIRST PST (NOT IDEAL)                    
         BNH   VB2C3                                                            
         MVC   0(1,R3),0(R2)                                                    
         B     VB2F                SET CODE AND SKIP STATION READ               
*                                                                               
VB2C3    DS    0H                                                               
         LA    R2,1(R2)            NEXT PROVINCE                                
         LA    R3,1(R3)                                                         
         BCT   R0,VB2C2                                                         
*              **NOTE- USE TO ABEND HERE BUT THAT WAS NOT NECESSARY.            
*                      GET HERE ONLY IF DOING "PST FOR ALL STATIONS"            
*                      BUT NO PST'S SPECIFIED. BIG DEAL.                        
*                                                                               
VB2C4    DS    0H                                                               
         OC    CNETSTRT,CNETSTRT   IF CANADIAN NETWORK MARKED AT                
         BZ    VB2C8               NETWORK LEVEL, THEN NO PST'S.                
         L     RF,APER                                                          
         ZIC   R5,0(RF)                                                         
         LA    R5,PERLIST(R5)                                                   
         USING PERLISTD,R5                                                      
         CLC   PERLMOS,CNETSTRT    IS CURRENT BILL THAT WAY?                    
         BL    VB2C8               NO, OK                                       
         OC    CNETSTR2,CNETSTR2   YES, SKIP UNLESS NEW FEATURE                 
         BZ    VB2F                TO MARK AT STATION LEVEL IS ON               
         CLC   PERLMOS,CNETSTR2                                                 
         BL    VB2F                                                             
         DROP  R5                                                               
*                                                                               
VB2C8    DS    0H                                                               
         L     RF,ADAGY                                                         
         CLI   AGYPROF+7-AGYHDR(RF),C'C'   FOR CANADIAN                         
         BNE   VB2C8F                                                           
         CLI   QMED,C'N'                   NETWORK                              
         BNE   VB2C8F                                                           
         L     RF,ASTA             TRY NET LEVEL PSTS                           
         MVC   BYTE,2(RF)          3RD BYTE OF STATION                          
         CLI   BYTE,X'B0'          CABLE NETWORK?                               
         BNL   VB2C8F              YES                                          
         ZIC   RF,BYTE                                                          
         MHI   RF,NETTABL                                                       
         A     RF,=A(NETTAB)                                                    
         MVC   SVSPSTS,NTBPSTS-NETTABD(RF)   NET PSTS                           
         OC    SVSPSTS,SPACES                                                   
         OI    VBANPST,X'80'       SET DOING NET PSTS                           
*                                                                               
VB2C8F   DS    0H                                                               
         L     R4,ASTA                                                          
         CLC   0(3,R4),XXSTA       IF MANUAL BILLING STATION                    
         BNE   *+12                                                             
         MVI   SVSPSTS+5,C'S'      ACTIVATE QST  ???***                         
         B     VB2F                AND SKIP STATION READ                        
*                                                                               
         SHI   R4,2                R4 POINTS TO MARKET CODE                     
         GOTO1 MSUNPK,VBADMCB,(X'80',(R4)),DUB,VBAWRK2                          
*                                                                               
         CLI   VBAWRK2+4,C' '                                                   
         BNE   *+10                                                             
         MVC   VBAWRK2+4(1),QMED                                                
*                                                                               
         MVC   VBASAVK,KEY                                                      
         MVI   KEY,C'0'                                                         
         MVC   KEY+1(14),KEY                                                    
         MVI   KEY,C'S'                                                         
         MVC   KEY+1(1),QMED                                                    
         MVC   KEY+2(5),VBAWRK2                                                 
         CLI   QMED,C'N'           CANADIAN NETWORK?                            
         BNE   VB2C8J              NO                                           
         CLI   BYTE,X'B0'          CABLE NETWORK?                               
         BL    VB2C8J              NO                                           
         MVI   KEY+1,C'T'          ALWAYS MEDIA T                               
         MVI   KEY+6,C'T'          ALWAYS MEDIA T                               
*                                                                               
VB2C8J   DS    0H                                                               
         MVC   KEY+7(2),QAGY                                                    
         MVC   KEY+9(3),CLT                                                     
         L     R4,ADSTAT                                                        
         USING STAREC,R4                                                        
         CLC   KEY(12),0(R4)       DO WE ALREADY HAVE RECORD?                   
         BE    VB2D                                                             
         MVC   VBABYTE,MODE        SAVE MODE                                    
         MVI   MODE,0                                                           
         GOTO1 READSTA                                                          
         CLI   MODE,DISKERR                                                     
         BNE   *+6                                                              
         DC    H'0'                                                             
         MVC   MODE,VBABYTE        RESTORE                                      
         MVC   STAKCLT,CLT         SET CLIENT CODE                              
*                                                                               
VB2D     DS    0H                                                               
*                                                                               
         LA    RE,SPST             RESET CODE * TO NULL (USED FOR               
         LHI   R0,NPROVS           PAY FEATURE, IGNORE FOR BILLING)             
*                                                                               
VB2D1    DS    0H                                                               
         CLI   0(RE),C'*'                                                       
         BNE   *+8                                                              
         MVI   0(RE),0                                                          
         LA    RE,1(RE)                                                         
         BCT   R0,VB2D1                                                         
                                                                                
         MVC   KEY,VBASAVK                                                      
*                                                                               
         TM    VBANPST,X'80'       USING NETWORK PSTS?                          
         BNZ   *+14                                                             
         MVC   SVSPSTS,SPST        NO, KEEP STATION'S                           
         B     VB2F                                                             
*                                                                               
         LA    RF,SVSPSTS          CHOOSE NETWORK OR LOCAL PST                  
         LA    RE,SPST                                                          
         LHI   R0,NPROVS                                                        
*                                                                               
VB2D2    DS    0H                                                               
         CLI   0(RF),C'X'          IF NETWORK IS X                              
         BNE   *+12                                                             
         MVI   0(RF),0             NO PST                                       
         B     VB2D8                                                            
*                                                                               
         CLI   0(RF),C'Z'          IF NETWORK IS Z                              
         BNE   *+12                                                             
         MVI   0(RF),0             NO PST                                       
         B     VB2D8                                                            
*                                                                               
         CLI   0(RE),C'X'          PRESERVE LOCAL STATION  X                    
         BNE   *+12                                                             
         MVI   0(RF),C'X'                                                       
         B     VB2D8                                                            
*                                                                               
         CLI   0(RE),C'Z'          PRESERVE LOCAL STATION  Z                    
         BNE   *+12                                                             
         MVI   0(RF),C'Z'                                                       
         B     VB2D8                                                            
*                                                                               
         CLI   0(RF),C'S'          PRESERVE NET LEVEL S                         
         BE    VBR2D6                                                           
*                                                                               
         CLI   0(RE),C'H'          BUT DROP LOCAL H ???                         
         BE    VBR2D6                                                           
*                                                                               
         MVC   0(1,RF),0(RE)       ELSE USE LOCAL VALUE                         
*                                                                               
VBR2D6   DS    0H                                                               
*                                                                               
VB2D8    DS    0H                                                               
         LA    RF,1(RF)            NEXT SLOTS                                   
         LA    RE,1(RE)                                                         
         BCT   R0,VB2D2                                                         
*                                                                               
         DROP  R4                                                               
*                                                                               
VB2F     DS    0H                                                               
         MVC   VBASVCDS,CVATCDS    SAVE VAT CODES                               
         CLI   JUL10SW,C'N'                                                     
         BE    *+10                                                             
         MVC   VBASVCDS,NVATCDS    USE NEW ONES                                 
*                                                                               
         LA    R3,SVSPSTS          STATION PST CODES                            
         LA    RE,VBASVCDS+1                                                    
         LHI   R0,NPROVS                                                        
*                                                                               
VB3      DS    0H                  R3 POINTS TO STATION VAT LIST                
         CLI   0(R3),C'0'          ZERO                                         
         BNE   *+8                                                              
         MVI   0(R3),0             BECOMES NULL                                 
         CLI   0(R3),C' '          IF NO STATION PST CODE                       
         BH    *+8                                                              
         MVI   0(RE),0             THEN NO PST - (BUT IF THERE IS PST           
*                                  THE CLT/PRD CODE IS PRESERVED ??'            
*                               ** NOTE THAT CODES THEMSELVES ARE               
*                                  NOT SET FROM STATION!                        
*                                                                               
         LA    RE,1(RE)                                                         
         LA    R3,1(R3)                                                         
         BCT   R0,VB3                                                           
*                                                                               
         LA    R2,VBASVCDS                                                      
         LHI   R0,NPROVS+1                                                      
*                                                                               
VB6      DS    0H                                                               
         CLI   0(R2),C' '                                                       
         BNH   VB9                                                              
*                                                                               
         L     RF,APER             PERIOD (MOS)                                 
         ZIC   R5,0(RF)                                                         
         LA    R5,PERLIST(R5)                                                   
         USING PERLISTD,R5                                                      
*        L     R4,=A(VCTAB11)      VAT CODE TABLE                               
*        CLC   TODAYB,=X'700101'   ON OR AFTER JAN1/12?                         
*        BL    VB6X                                                             
*        L     R4,=A(VCTAB12)      USE 2012 TABLE                               
*        CLC   TODAYB,=X'710101'   ON OR AFTER JAN1/13?                         
*        BL    VB6X                                                             
*                                                                               
         L     R4,=A(VCTAB13)      USE 2013 TABLE                               
         USING VCTABD,R4                                                        
         CLI   MANRVDTP,0          AM I REVERSING?                              
         BE    *+10                                                             
         CLC   MANRVDTP,=X'E281'   BEFORE APR1/2013                             
         BL    VB6X                                                             
*                                                                               
         L     R4,=A(VCTAB13A)     USE 2013A TABLE                              
         CLI   MANRVDTP,0          AM I REVERSING?                              
         BE    *+10                                                             
         CLC   MANRVDTP,=X'E8E1'   BEFORE JUL1/2016                             
         BL    VB6X                                                             
*                                                                               
         L     R4,=A(VCTAB16)      USE 2016 JUL TABLE                           
         CLI   MANRVDTP,0          AM I REVERSING?                              
         BE    *+10                                                             
         CLC   MANRVDTP,=X'E941'   BEFORE OCT1/2016                             
         BL    VB6X                                                             
*                                                                               
         CLC   TODAYB,=X'740A01'   ON OR AFTER OCT1/16?                         
         BL    VB6X                                                             
         L     R4,=A(VCTAB16A)     USE 2016 OCT TABLE                           
VB6X     LHI   RE,NPROVS+1                                                      
         SR    RE,R0               PROVINCE NUMBER                              
*                                                                               
VB7      DS    0H                                                               
         CLM   RE,1,VCTPRV         PROVINCE                                     
         BNE   VB8                                                              
         CLC   VCTVCD,0(R2)        CODE                                         
         BNE   VB8                                                              
         CLC   PERLMOS,VCTSTRT     START MOS                                    
         BL    VB8                                                              
         CLC   PERLMOS,VCTEND      END MOS                                      
         BNH   VB8B                                                             
*                                                                               
VB8      DS    0H                                                               
         LA    R4,VCTABL(R4)       NEXT ENTRY                                   
         CLI   0(R4),X'FF'         END OF TABLE                                 
         BNE   VB7                                                              
         B     VB9                                                              
*                                                                               
VB8B     DS    0H                                                               
         MVC   VBHLDVCT,0(R4)       COPY ENTRY (IT MIGHT CHANGE)                
         LA    R4,VBHLDVCT                                                      
         OC    MANRVDTP,MANRVDTP   IF A REVERSAL USE OLD RATE                   
         BZ    VB8C                                                             
         CLI   VCTPRV,6            IF QUEBEC                                    
         BNE   VB8B2X                                                           
         L     R1,=A(OLDQST)                                                    
VB8B3    CLC   MANRVDTP,2(R1)                                                   
         BH    *+14                                                             
         MVC   VCTPCT,4(R1)                                                     
         B     VB8C                                                             
*                                                                               
         LA    R1,L'OLDQST(R1)                                                  
         CLI   0(R1),X'FF'                                                      
         BNE   VB8B3                                                            
         B     VB8C                                                             
*        CLC   MANRVDTP,=X'C422'   BEFORE 1/2/98   **Y2K**                      
*        BNL   VB8B2                                                            
*        MVC   VCTPCT,=F'6500'     USE OLD 6.5% RATE                            
*        B     VB8C                                                             
*                                                                               
*B8B2    CLC   MANRVDTP,=X'DE21'   BEFORE 1/1/11                                
*        BNL   VB8C                                                             
*        MVC   VCTPCT,=F'7500'     USE OLD 7.5% RATE                            
*        B     VB8C                                                             
*                                                                               
VB8B2X   CLI   VCTPRV,0            IF GST                                       
         BNE   VB8BHST                                                          
         CLI   VCTVCD,C'S'         AND HAS REAL TAX                             
         BNE   VB8BHST                                                          
         CLC   MANRVDTP,=X'D4E1'   BEFORE 7/1/06   **Y2K**                      
         BNL   *+14                                                             
         MVC   VCTPCT,=F'7000'     USE OLD 7.0% RATE                            
         B     VB8BHST                                                          
*                                                                               
         CLC   MANRVDTP,=X'D821'   BEFORE 1/1/08   **Y2K**                      
         BNL   *+10                                                             
         MVC   VCTPCT,=F'6000'     USE OLD 6.0% RATE                            
*                                                                               
VB8BHST  CLI   VCTVCD,C'H'         IF HST                                       
         BNE   VB8C                                                             
*                                                                               
         CLI   VCTPRV,1            IF BC                                        
         BNE   VB8BHST1                                                         
         CLC   MANRVDTP,=X'E281'   BEFORE 4/1/13                                
         BNL   *+10                                                             
         MVC   VCTPCT,=F'12000'    USE OLD 12.0% RATE                           
         B     VB8C                                                             
*                                                                               
VB8BHST1 CLI   VCTPRV,7            IF NB                                        
         BE    *+12                                                             
         CLI   VCTPRV,10           IF NF                                        
         BNE   VB8BHST2                                                         
         CLC   MANRVDTP,=X'E8E1'   BEFORE 7/1/16                                
         BNL   *+10                                                             
         MVC   VCTPCT,=F'13000'    USE OLD 13.0% RATE                           
         B     VB8C                                                             
*                                                                               
VB8BHST2 CLI   VCTPRV,9            IF PEI                                       
         BNE   VB8BHST3                                                         
         CLC   MANRVDTP,=X'E941'   BEFORE 10/1/16                               
         BNL   *+10                                                             
         MVC   VCTPCT,=F'14000'    USE OLD 14.0% RATE                           
         B     VB8C                                                             
*                                                                               
VB8BHST3 CLC   MANRVDTP,=X'D4E1'   BEFORE 7/1/06   **Y2K**                      
         BNL   *+14                                                             
         MVC   VCTPCT,=F'15000'    USE OLD 15.0% RATE                           
         B     VB8C                                                             
*                                                                               
         CLC   MANRVDTP,=X'D821'   BEFORE 1/1/08   **Y2K**                      
         BNL   *+10                                                             
         MVC   VCTPCT,=F'14000'    USE OLD 14.0% RATE                           
*                                                                               
*                                                                               
VB8C     DS    0H                                                               
         L     RE,APER             PERIOD (X 6)                                 
         ZIC   RF,0(RE)                                                         
         SR    RE,RE                                                            
         D     RE,=F'6'                                                         
         MHI   RF,NPROVS+1                                                      
*                                                                               
         LHI   RE,NPROVS+1                                                      
         SR    RE,R0                                                            
         AR    RF,RE                                                            
         MHI   RF,VBTABL                                                        
*                                                                               
         L     RE,VBABRKC          POINT TO TOTALS FOR THIS LEVEL               
         L     RE,ATOTSV(RE)                                                    
         AR    RF,RE               PLUS DISP INTO TOTALS                        
         USING VBTABD,RF            VBTAB ENTRY                                 
         MVC   VBTPCT,VCTPCT       SET PERCENT                                  
         MVC   VBTCOD,VCTVCD       AND CODE                                     
         DROP  RF                                                               
*                                                                               
*              NOTE- HST IS CALCULATED BASED ON GROSS, NOT                      
*                    GROSS + GST, SO DON'T ADD TO GST FOR THOSE                 
*                    PROVINCES. (THIS CODE ASSUMES THAT NO STATION              
*                    HAS BOTH AN HST VAT AND A NON-HST VAT.                     
*                                                                               
         LHI   RE,NPROVS+1         IS THIS THE GST PASS?                        
         CR    R0,RE               NO, OK                                       
         BNE   VB8C4               ELSE SKIP HST PROV'S                         
*                                                                               
         CLI   MANRVDTP,0                                                       
         BE    *+18                                                             
         CLC   MANRVDTP,=X'E281'                                                
         BNL   *+26                                                             
         B     *+14                                                             
         CLC   TODAYB,=X'710401'   SEE IF ON OR AFTER APR1/2013                 
         BNL   *+12                                                             
*                                                                               
         CLI   VBASVCDS+1,C' '     BRITISH COLUMBIA (#1)                        
         BH    VB8B8                                                            
         CLI   VBASVCDS+5,C' '     ONTARIO       (#5)                           
         BH    VB8B8                                                            
         CLI   VBASVCDS+7,C' '     NEW BRUNSWICK (#7)                           
         BH    VB8B8                                                            
         CLI   VBASVCDS+8,C' '     NOVA SCOTIA   (#8)                           
         BH    VB8B8                                                            
         CLI   VBASVCDS+9,C' '     P.E. ISLAND   (#9)                           
         BH    VB8B8                                                            
         CLI   VBASVCDS+10,C' '    NEWFOUNDLAND  (#10)                          
         BH    VB8B8                                                            
         B     VB8C4                                                            
*                                                                               
VB8B8    DS    0H                                                               
         CLC   PERLMOS,=X'6104'    IF HST PROV MUST CHECK DATE  **Y2K**         
         BNL   VB9                 IF BEFORE APR/97 STILL NEED GST              
         DROP  R5                                                               
*                                                                               
VB8C4    DS    0H                                                               
         CLI   UPASS,C'S'          FOR RETAIL SUMMARY PASS                      
         BE    VB8E                AMOUNTS ARE DIFFERENT                        
*                                                                               
         LHI   RE,VBTBLBN          FOR BCT                                      
         LR    R6,R7               A(ORD/BILLED $)                              
*                                                                               
VB8D     DS    0H                                                               
         L     R1,0(RF)                                                         
         A     R1,0(R6)            +ORDERED                                     
         S     R1,ROWHL(R6)        -BILLED                                      
         ST    R1,0(RF)                                                         
         LA    R6,4(R6)                                                         
         LA    RF,4(RF)                                                         
         BCT   RE,VB8D                                                          
         B     VB8F                                                             
*                                                                               
VB8E     DS    0H                  RETAIL SUMMARY PASS                          
*              **CODE WILL SURELY HAVE TO BE CHANGED                            
*              **TO BETTER HANDLE RETAIL SUMMARIES PST                          
*              **IF WE EVER HAVE TO DO THEM FOR CANADA                          
         L     R1,0(RF)            GROSS                                        
         A     R1,4(R7)                                                         
         ST    R1,0(RF)                                                         
         L     R1,8(RF)            NET                                          
         A     R1,8(R7)                                                         
         ST    R1,8(RF)                                                         
*                                                                               
VB8F     DS    0H                  NOW DO FOR 'TOTAL' MONTH                     
         LHI   RF,MAXMOS                                                        
         MHI   RF,NPROVS+1                                                      
*                                                                               
         LHI   RE,NPROVS+1                                                      
         SR    RE,R0                                                            
         AR    RF,RE                                                            
         MHI   RF,VBTABL                                                        
*                                                                               
         L     RE,VBABRKC          POINT TO TOTALS FOR THIS LEVEL               
         L     RE,ATOTSV(RE)                                                    
         AR    RF,RE               PLUS DISP INTO TOTALS                        
         USING VBTABD,RF            VBTAB ENTRY                                 
         MVC   VBTPCT,VCTPCT       SET PERCENT                                  
         MVC   VBTCOD,VCTVCD       AND CODE                                     
*                                                                               
         CLI   UPASS,C'S'          FOR RETAIL SUMMARY PASS                      
         BE    VB8I                AMOUNTS ARE DIFFERENT                        
*                                                                               
         DROP  R4                                                               
         LHI   RE,VBTBLBN          FOR BCT                                      
         LR    R6,R7               A(ORD/BILLED $)                              
*                                                                               
VB8H     DS    0H                                                               
         L     R1,0(RF)                                                         
         A     R1,0(R6)            +ORDERED                                     
         S     R1,ROWHL(R6)        -BILLED                                      
         ST    R1,0(RF)                                                         
         LA    R6,4(R6)                                                         
         LA    RF,4(RF)                                                         
         BCT   RE,VB8H                                                          
         B     VB9                                                              
*                                                                               
VB8I     DS    0H                  RETAIL SUMMARY PASS                          
*              **CODE WILL SURELY HAVE TO BE CHANGED                            
*              **TO BETTER HANDLE RETAIL SUMMARIES PST                          
*              **IF WE EVER HAVE TO DO THEM FOR CANADA                          
         L     R1,0(RF)            GROSS                                        
         A     R1,4(R7)                                                         
         ST    R1,0(RF)                                                         
         L     R1,8(RF)            NET                                          
         A     R1,8(R7)                                                         
         ST    R1,8(RF)                                                         
*                                                                               
VB9      DS    0H                                                               
         LA    R2,1(R2)                                                         
         BCT   R0,VB6                                                           
*                                                                               
         MVC   VBAMODE,=C'A '       VBADD MODE                                  
         GOTOR VBATRC,VBADMCB,(R9) TRACE                                        
         DROP  RF                                                               
*                                                                               
VBADDX   DS    0H                                                               
         XIT1                                                                   
         DROP  R9                                                               
         SPACE 2                                                                
         LTORG                                                                  
         SPACE 2                                                                
*                                                                               
JUL10SW  DS    CL1                                                              
*                                                                               
VBAWRKD  DSECT                                                                  
VBADMCB  DS    6F                                                               
VBAWORK  DS    XL76                                                             
VBAWRK2  DS    XL76                                                             
VBASAVK  DS    XL64                                                             
VBAPARMS DS    XL24                                                             
VBASVR1  DS    F                                                                
VBABRKC  DS    F                                                                
VBABRK   DS    F                                                                
VBASVGST DS    F                                                                
VBASVGSP DS    F                                                                
VBALINE  DS    A                                                                
VBADUB   DS    D                                                                
VBAFULL  DS    F                                                                
VBAHALF  DS    H                                                                
VBABYTE  DS    X                                                                
VBASVCDS DS    CL(NPROVS+1)                                                     
VBAPASS  DS    X                                                                
VBAMODE  DS    CL2                                                              
VBANPST  DS    X                                                                
VBPRMODE DS    C                                                                
VBHLDVCT DS    XL(VCTABL)          HOLD AREA FOR TABLE ENTRY                    
VBAWRKL  EQU   *-VBAWRKD                                                        
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBATRC   TRACE VBTAB                                                   
*                                                                               
***********************************************************************         
         SPACE 2                                                                
SPB102   CSECT                                                                  
*                                                                               
VBATRC   NMOD1 VBAWRKL,VBATRC                                                   
         L     R9,0(R1)            VBATRC CALLERS VBAWRKD                       
         USING VBAWRKD,R9                                                       
         LA    RC,SPACEND                                                       
         ST    R1,VBASVR1                                                       
*                                                                               
         L     RF,APATCH           TRACE?                                       
         TM    0(RF),X'40'                                                      
         BZ    VBATRCX                                                          
*                                                                               
         MVC   P,SPACES                                                         
         BRAS  RE,PRNT                                                          
*                                                                               
         CLC   VBAMODE,=C'A '        VBADD MODE                                 
         BNE   VBATR3                                                           
         MVC   P(2),=C'VB'                                                      
         MVC   P+3(5),VBAWRK2      STATION                                      
         GOTO1 HEXOUT,VBADMCB,(R5),P+9,2,=C'N'                                  
         GOTO1 HEXOUT,VBADMCB,CVATCDS,P+14,11,=C'N'                             
         GOTO1 HEXOUT,VBADMCB,SVSPSTS,P+38,10,=C'N'                             
         GOTO1 HEXOUT,VBADMCB,NVATCDS,P+14,11,=C'N'                             
         BRAS  RE,PRNT                                                          
*                                                                               
VBATR3   DS    0H                                                               
         LA    R2,P                                                             
         L     R4,VBABRKC                                                       
         L     R4,ATOTSV(R4)                                                    
         SR    R5,R5                                                            
         LHI   R3,(NPROVS+1)*(MAXMOS+1)                                         
         MVC   0(2,R2),=C'VB'                                                   
         MVC   2(2,R2),VBAMODE                                                  
         CLC   VBAMODE,=C'RU'        FOR ROLLUP SKIP IF                         
         BNE   VBATR4                                                           
         OC    VBABRKC,VBABRKC    AT FINAL ONE BECAUSE IT'S MEANINGLESS         
         BNZ   VBATR4                                                           
         MVC   11(2,R2),=C'00'                                                  
         BRAS  RE,PRNT                                                          
         B     VBATRCX                                                          
*                                                                               
VBATR4   DS    0H                                                               
         OC    0(VBTABL,R4),0(R4)                                               
         BZ    VBATR8                                                           
         LR    RF,R5                                                            
         SR    RE,RE                                                            
         D     RE,=A(NPROVS+1)                                                  
         LA    RF,1(RF)                      RF = PERIOD                        
         EDIT  (RF),(2,5(R2)),ZERO=NOBLANK                                      
         EDIT  (RE),(2,8(R2)),ZERO=NOBLANK   RE=PROVINCE                        
         GOTO1 HEXOUT,VBADMCB,VBABRKC+3,12(R2),1,=C'N' BRK CODE                 
         GOTO1 HEXOUT,VBADMCB,(R4),15(R2),48                                    
         GOTO1 HEXOUT,VBADMCB,48(R4),132+15(R2),VBTABL-48                       
         BRAS  RE,PRNT                                                          
*                                                                               
VBATR8   DS    0H                                                               
         LA    R5,1(R5)                                                         
         LA    R4,VBTABL(R4)                                                    
         BCT   R3,VBATR4                                                        
*                                                                               
VBATRCX  DS    0H                                                               
         XIT1                                                                   
         DROP  R9                                                               
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBADJ    SET COMMISSION ADJUSTMENTS AND                                
*                 AMOUNT DUE IN VBTAB                                           
*                                                                               
*        NOTE - FOR COST2 IT USES 2ND CURRENCY ACCUMULATORS                     
*                                                                               
*                                                                               
*        PARM1  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(BILL FORMULA) 5 BYTES                               
*        PARM2  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(PERLIST ENTRY)                                      
*        PARM3  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(BRKTAB ENTRY)                                       
*                                                                               
***********************************************************************         
         SPACE 2                                                                
         PRINT NOGEN                                                            
VBADJ    NMOD1 VBAWRKL,VBADJ                                                    
         LR    R9,RC                                                            
         USING VBAWRKD,R9                                                       
         L     R3,8(R1)                                                         
         ST    R3,VBABRK           SAVE A(BREAK TABLE ENTRY)                    
         MVC   VBABRKC,BRKCODE-BRKTABD(R3)                                      
         LA    RC,SPACEND                                                       
         ST    R1,VBASVR1          SAVE R1                                      
         SPACE 2                                                                
*                                                                               
         L     RF,0(R1)            A(BILL FORMULA)                              
         MVC   VBABYTE,0(RF)         BASIS                                      
         MVC   VBAFULL,1(RF)         ADJUSTMENT PERCENT                         
         L     RF,=F'1000000'                                                   
*                                                                               
         L     R1,VBASVR1                                                       
         L     R1,4(R1)            A(PERLIST ENTRY)                             
         LA    R0,PERLIST                                                       
         SR    R1,R0                                                            
         SR    R0,R0                                                            
         D     R0,=A(PERLISTL)                                                  
*                                                                               
         MHI   R1,(NPROVS+1)*VBTABL     X NO. OF PROVINCES AND NAT              
         L     R2,VBABRKC                                                       
         L     R2,ATOTSV(R2)                                                    
         AR    R2,R1               R2 POINTS TO MONTH                           
         USING VBTABD,R2                                                        
*                                                                               
         LHI   R1,MAXMOS                                                        
         MHI   R1,(NPROVS+1)*VBTABL     X NO. OF PROVINCES AND NAT              
         L     R6,VBABRKC                                                       
         L     R6,ATOTSV(R6)                                                    
         AR    R6,R1               R6 POINTS TO TOTAL MONTH ROW                 
*                                                                               
         LHI   R3,NPROVS+1                                                      
*                                                                               
VBJ4     DS    0H                                                               
         L     R4,VBTGRS           BASIS IS GROSS                               
*                                                                               
         CLI   COST2SW,C'Y'                                                     
         BNE   *+8                                                              
         L     R4,VBTGRS+4         BASIS IS GROSS                               
*                                                                               
         TM    VBABYTE,X'10'                                                    
         BZ    VBJ6                                                             
         L     R4,VBTNET           OR NET                                       
*                                                                               
         CLI   COST2SW,C'Y'                                                     
         BNE   *+8                                                              
         L     R4,VBTNET+4         BASIS IS GROSS                               
*                                                                               
VBJ6     L     R1,VBTGRS           ADJUSTMENT BASIS IS GROSS                    
*                                                                               
         CLI   COST2SW,C'Y'                                                     
         BNE   *+8                                                              
         L     R1,VBTGRS+4         ADJ BASIS IS GROSS                           
*                                                                               
         TM    VBABYTE,X'01'                                                    
         BZ    VBJ10                                                            
         L     R1,VBTNET           OR NET                                       
*                                                                               
         CLI   COST2SW,C'Y'                                                     
         BNE   *+8                                                              
         L     R1,VBTNET+4         BASIS IS GROSS                               
*                                                                               
VBJ10    CLI   TAXOPT,C'N'         OPTION TO REMOVE TAX                         
         BE    VBJ12                                                            
         S     R1,VBTTAX                                                        
*                                                                               
         CLI   COST2SW,C'Y'                                                     
         BNE   VBJ12                                                            
         A     R1,VBTTAX           RESTORE SUBTRACTED TAX                       
         S     R1,VBTTAX+4                                                      
*                                                                               
VBJ12    M     R0,VBAFULL                                                       
         DRNDR (R0),(RF)                                                        
         ST    R1,VBTADJ           CALCULATED ADJUSTMENT AMOUNT                 
         AR    R4,R1               BASIS PLUS ADJ = DUE                         
         ST    R4,VBTDUE                                                        
*                                                                               
         A     R1,VBTADJ-VBTABD(R6)  ADD TO TOTAL ROW                           
         ST    R1,VBTADJ-VBTABD(R6)                                             
         A     R4,VBTDUE-VBTABD(R6)                                             
         ST    R4,VBTDUE-VBTABD(R6)                                             
*                                                                               
         LA    R2,VBTABL(R2)       NEXT PROVINCE                                
         LA    R6,VBTABL(R6)                                                    
         BCT   R3,VBJ4                                                          
*                                                                               
         MVC   VBAMODE,=C'J '        VBADJ MODE                                 
         GOTOR VBATRC,VBADMCB,(R9)                                              
*                                                                               
         XIT1                                                                   
*                                                                               
         DROP  R2                                                               
         DROP  R9                                                               
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBCALC   CALC VAT AMOUNTS AND ADD INTO WKROW                           
*                                                                               
*        PARM1  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(PERLIST ENTRY)                                      
*        PARM2  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(MONTH CUME SLOT - ATOTS)                            
*        PARM3  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(BRKTAB ENTRY)                                       
*                                                                               
*        NOTE - VAT IS CALCULATED FOR THE GIVEN MONTH AND                       
*               TOTALED IN WKROW TO STAY COMPATIBLE WITH OLD BILCALC.           
*               IT IS ALSO SET AT VATDSP IN THE REGULAR ACCUME (AT R7).         
*                                                                               
***********************************************************************         
         SPACE 2                                                                
         PRINT NOGEN                                                            
VBCALC   NMOD1 VBAWRKL,VBCALC                                                   
         LR    R9,RC                                                            
         USING VBAWRKD,R9                                                       
         LA    RC,SPACEND                                                       
         L     R7,4(R1)            A(MONTH CUME CLOT)                           
*                                                                               
         L     R3,8(R1)                                                         
         ST    R3,VBABRK           SAVE A(BREAK TABLE ENTRY)                    
         MVC   VBABRKC,BRKCODE-BRKTABD(R3)                                      
         ST    R1,VBASVR1                                                       
         XC    VBASVGSP,VBASVGSP                                                
*                                                                               
         L     RF,0(R1)                                                         
         LA    R0,PERLIST                                                       
         SR    RE,RE                                                            
         SR    RF,R0                                                            
         D     RE,=A(PERLISTL)                                                  
         MHI   RF,(NPROVS+1)*VBTABL                                             
         L     R2,VBABRKC                                                       
         L     R2,ATOTSV(R2)                                                    
         AR    R2,RF                                                            
         USING VBTABD,R2                                                        
*                                                                               
         LHI   R3,NPROVS+1                                                      
         LA    R5,WKROW                                                         
         L     RF,=F'100000'                                                    
*                                                                               
VBC4     DS    0H                                                               
         CLI   VBTCOD,C' '         SKIP IF NO VAT CODE                          
         BE    VBC8                                                             
         L     R1,VBTDUE           DUE AMOUNT                                   
         CLI   SCBNCSW,C'C'        IF SCB COMMISSIION BILL                      
         BNE   *+12                                                             
         S     R1,VBTNET           THEN LESS NET                                
         B     *+8                 (BUT DON'T SUBTRACT TAX FROM DUE)            
         S     R1,VBTTAX           LESS TAX (SALES)                             
         CLI   ADJSEP,C'Y'         IF ADJ ON SEP INV                            
         BNE   *+8                                                              
         S     R1,VBTADJ           THEN LESS ADJ                                
*                                                                               
         CHI   R3,NPROVS+1         UNLESS DOING GST NOW                         
         BE    VBC6B                                                            
*                                  FIRST APPLY GST TO GET BASIS                 
*                                  BUT FOR HST PROV'S BASE IS                   
*                                  GROSS, NOT GROSS+GST                         
*                                                                               
         CLI   MANRVDTP,0                                                       
         BE    *+18                                                             
         CLC   MANRVDTP,=X'E281'                                                
         BNL   *+26                                                             
         B     *+14                                                             
         CLC   TODAYB,=X'710401'   SEE IF ON OR AFTER APR1/2013                 
         BNL   *+12                                                             
*                                                                               
         CHI   R3,NPROVS+1-1       BRITISH COLUMBIA (#1)                        
         BE    VBC6B                                                            
         CHI   R3,NPROVS+1-5       ONTARIO (#5)                                 
         BE    VBC6B                                                            
         CHI   R3,NPROVS+1-7       NEW BRUNSWICK (#7)                           
         BE    VBC6B                                                            
         CHI   R3,NPROVS+1-8       NOVA SCOTIA   (#8)                           
         BE    VBC6B                                                            
         CHI   R3,NPROVS+1-9       P. E. ISLAND  (#9)                           
         BE    VBC6B                                                            
         CHI   R3,NPROVS+1-10      NEWFOUNDLAND  (#10)                          
         BE    VBC6B                                                            
*                                                                               
         CHI   R3,NPROVS+1-6       QUEBEC  (#06)                                
         BNE   VBC6AQ                                                           
*                                                                               
         CLI   MANRVDTP,0           ARE WE REVERSING?                           
         BE    VBC6AR                                                           
         CLC   MANRVDTP,=X'E221'    BILL BEFORE JAN01/2013?                     
         BL    VBC6AQ               YES - APPLY GST                             
         B     VBC6B                NO - DON'T APPLY GST                        
*                                                                               
VBC6AR   CLC   TODAYB,=X'710101'   ARE WE BEFORE JAN01/2013?                    
         BL    VBC6AQ              YES - APPLY GST                              
         B     VBC6B               NO - DON'T APPLY GST                         
*                                                                               
VBC6AQ   ICM   R0,15,VBASVGSP      FIRST APPLY GST TO GET BASIS                 
         A     R0,=F'100000'                                                    
         MR    R0,R0                                                            
         DRNDR (R0),(RF)                                                        
*                                                                               
VBC6B    DS    0H                                                               
         ST    R1,VBTVATB          STORE BASIS IN VBTAB                         
         LR    RE,R1                    VAT BASIS                               
         ST    RE,VATBDSP(R7)          SET IN MONTH CUME ROW                    
         A     RE,VATBDSP-EXTDSP(R5)   AND TOTAL IN WKROW                       
         ST    RE,VATBDSP-EXTDSP(R5)                                            
*                                                                               
         ICM   R0,15,VBTPCT        TIMES VAT PCT (N.NNN)                        
         MR    R0,R0                                                            
         DRNDR (R0),(RF)                                                        
         ST    R1,VBTVAT                                                        
         CHI   R3,NPROVS+1         IF DOING GST NOW                             
         BNE   *+10                                                             
         MVC   VBASVGSP,VBTPCT     SAVE ACTUAL GST %                            
         ST    R1,VATDSP(R7)       SET IN MONTH CUME ROW                        
         A     R1,VATDSP-EXTDSP(R5)    AND TOTAL IN WKROW                       
         ST    R1,VATDSP-EXTDSP(R5)                                             
*                                                                               
VBC8     DS    0H                                                               
         LA    R2,VBTABL(R2)       NEXT PROVINCE                                
         LA    R5,8(R5)            NEXT WKROW SLOT                              
         LA    R7,8(R7)            NEXT ACCUM SLOT                              
         BCT   R3,VBC4                                                          
*                                                                               
         MVC   VBAMODE,=C'C '        VBCALC MODE                                
         GOTOR VBATRC,VBADMCB,(R9)                                              
*                                                                               
         XIT1                                                                   
*                                                                               
         DROP  R2                                                               
         DROP  R9                                                               
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBCALCJ  CALC VAT AMOUNTS FOR SEP COMM BILLS                           
*                 AND ADD INTO WKROW                                            
*                                                                               
*        PARM1  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(PERLIST ENTRY)                                      
*        PARM2  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(MONTH CUME SLOT - ATOTS)                            
*        PARM3  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(BRKTAB ENTRY)                                       
*                                                                               
*        NOTE - VAT IS CALCULATED FOR THE GIVEN MONTH AND                       
*               TOTALED IN WKROW TO STAY COMPATIBLE WITH OLD BILCALC.           
*               IT IS ALSO SET AT VATCDSP IN THE REGULAR CUME (AT R7).          
*             **IT IS NOT STORED IN THE VBTAB                                   
*                                                                               
***********************************************************************         
         SPACE 2                                                                
         PRINT NOGEN                                                            
VBCALCJ  NMOD1 VBAWRKL,VBCALCJ                                                  
         LR    R9,RC                                                            
         USING VBAWRKD,R9                                                       
         LA    RC,SPACEND                                                       
         L     R7,4(R1)            A(MONTH CUME CLOT)                           
*                                                                               
         L     R3,8(R1)                                                         
         ST    R3,VBABRK           SAVE A(BREAK TABLE ENTRY)                    
         MVC   VBABRKC,BRKCODE-BRKTABD(R3)                                      
         ST    R1,VBASVR1                                                       
         SPACE 2                                                                
*                                                                               
         L     RF,0(R1)                                                         
         LA    R0,PERLIST                                                       
         SR    RE,RE                                                            
         SR    RF,R0                                                            
         D     RE,=A(PERLISTL)                                                  
         MHI   RF,(NPROVS+1)*VBTABL                                             
         L     R2,VBABRKC                                                       
         L     R2,ATOTSV(R2)                                                    
         AR    R2,RF                                                            
         USING VBTABD,R2                                                        
*                                                                               
         LHI   R3,NPROVS+1                                                      
         LA    R5,WKROW                                                         
         L     RF,=F'100000'                                                    
*                                                                               
VBCJ4    DS    0H                                                               
         L     R1,VBTADJ           CALC VAT OF COMM ADJ                         
         CHI   R3,NPROVS+1         UNLESS DOING GST NOW                         
         BE    VBCJ4B                                                           
*                                  FIRST APPLY GST TO GET BASIS                 
*                                  BUT FOR HST PROV'S BASE IS                   
*                                  GROSS, NOT GROSS+GST                         
*                                                                               
         CLI   MANRVDTP,0                                                       
         BE    *+18                                                             
         CLC   MANRVDTP,=X'E281'                                                
         BNL   *+26                                                             
         B     *+14                                                             
         CLC   TODAYB,=X'710401'   SEE IF ON OR AFTER APR1/2013                 
         BNL   *+12                                                             
*                                                                               
         CHI   R3,NPROVS+1-1       BRITISH COLUMBIA (#1)                        
         BE    VBCJ4B                                                           
         CHI   R3,NPROVS+1-5       ONTARIO (#1)                                 
         BE    VBCJ4B                                                           
         CHI   R3,NPROVS+1-7       NEW BRUNSWICK (#7)                           
         BE    VBCJ4B                                                           
         CHI   R3,NPROVS+1-8       NOVA SCOTIA   (#8)                           
         BE    VBCJ4B                                                           
         CHI   R3,NPROVS+1-9       P. E. ISLAND  (#9)                           
         BE    VBCJ4B                                                           
         CHI   R3,NPROVS+1-10       NEWFOUNDLAND  (#10)                         
         BE    VBCJ4B                                                           
*                                                                               
         CHI   R3,NPROVS+1-6       QUEBEC  (#06)                                
         BNE   VBCJ4Q                                                           
*                                                                               
         CLI   MANRVDTP,0           ARE WE REVERSING?                           
         BE    VBCJ4R                                                           
         CLC   MANRVDTP,=X'E221'    BILL BEFORE JAN01/2013?                     
         BL    VBCJ4Q               YES - APPLY GST                             
         B     VBCJ4B               NO - DON'T APPLY GST                        
*                                                                               
VBCJ4R   CLC   TODAYB,=X'710101'   ARE WE BEFORE JAN01/2013?                    
         BL    VBCJ4Q              YES - APPLY GST                              
         B     VBCJ4B              NO - DON'T APPLY GST                         
*                                                                               
VBCJ4Q   ICM   R0,15,VBASVGSP      FIRST APPLY GST TO GET BASIS                 
         A     R0,=F'100000'                                                    
         MR    R0,R0                                                            
         DRNDR (R0),(RF)                                                        
*                                                                               
VBCJ4B   DS    0H                                                               
         LR    RE,R1                    VAT BASIS                               
         ST    RE,VATCBDSP(R7)          SET IN MONTH CUME ROW                   
         A     RE,VATCBDSP-EXTDSP(R5)   AND TOTAL IN WKROW                      
         ST    RE,VATCBDSP-EXTDSP(R5)                                           
*                                                                               
         ICM   R0,15,VBTPCT                                                     
         MR    R0,R0                                                            
         DRNDR (R0),(RF)                                                        
*                   **NOTE-SEP COMM VAT NOT IN VBTAB                            
         CHI   R3,NPROVS+1         IF DOING GST NOW                             
         BNE   *+10                                                             
         MVC   VBASVGSP,VBTPCT     SAVE GST AMOUNT                              
         ST    R1,VATCDSP(R7)      SET IN MONTH CUME ROW                        
         A     R1,VATCDSP-EXTDSP(R5)   AND TOTAL IN WKROW                       
         ST    R1,VATCDSP-EXTDSP(R5)                                            
*                                                                               
         LA    R2,VBTABL(R2)       NEXT PROVINCE                                
         LA    R5,8(R5)            NEXT WKROW SLOT                              
         LA    R7,8(R7)            NEXT ACCUM SLOT                              
         BCT   R3,VBCJ4                                                         
*                                                                               
         MVC   VBAMODE,=C'CJ'        VBCALC MODE - SEP ADJ                      
         GOTOR VBATRC,VBADMCB,(R9)                                              
*                                                                               
         XIT1                                                                   
*                                                                               
         DROP  R2                                                               
         DROP  R9                                                               
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBCALCA  CALC VAT AMOUNTS FOR AOR BILLS                                
*                 AND ADD INTO WKROW                                            
*                                                                               
*        PARM1  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(PERLIST ENTRY)                                      
*        PARM2  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(MONTH CUME SLOT - ATOTS)                            
*        PARM3  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(BRKTAB ENTRY)                                       
*                                                                               
*        NOTE - VAT IS CALCULATED FOR THE GIVEN MONTH AND                       
*               TOTALED IN WKROW TO STAY COMPATIBLE WITH OLD BILCALC.           
*               IT IS ALSO SET AT VATADSP IN THE REGULAR CUME (AT R7).          
*             **IT IS NOT STORED IN THE VBTAB                                   
*                                                                               
***********************************************************************         
         SPACE 2                                                                
         PRINT NOGEN                                                            
VBCALCA  NMOD1 VBAWRKL,VBCALCA                                                  
         LR    R9,RC                                                            
         USING VBAWRKD,R9                                                       
         LA    RC,SPACEND                                                       
         L     R7,4(R1)            A(MONTH CUME CLOT)                           
         L     R3,8(R1)                                                         
         ST    R3,VBABRK           SAVE A(BREAK TABLE ENTRY)                    
         MVC   VBABRKC,BRKCODE-BRKTABD(R3)                                      
         ST    R1,VBASVR1                                                       
         XC    VBASVGST,VBASVGST                                                
         SPACE 2                                                                
*                                                                               
         L     RF,0(R1)            A(PERLIST ENTRY)                             
         MVC   HALF,PERLMOS-PERLISTD(RF) SAVE MOS                               
*                                                                               
         MVC   WKAORVCS,SVAORVCS    SET INTO WORKING AOR VATS                   
         CLC   HALF,=X'6E07'        CHECK MOS VS JUL/10                         
         BL    VBCA2                                                            
*                                   IF JUL/2010 OR AFTER                        
*                                   ALTER AOR PSTS FOR MAIN PST                 
         CLI   SVAORMVC,C' '        DO I HAVE A MAIN VAT CODE?                  
         BNH   VBCA2                                                            
         ZIC   R3,SVAORMVP          MAIN PST PROVINCE #                         
         SH    R3,=H'1'                                                         
         LTR   R3,R3                                                            
         BM    VBCA2                SHOULD NOT BE NEGATIVE                      
*                                                                               
         MVC   WKAORVCS+1(10),SPACES      CLEAR OLD PSTS                        
         LA    R4,WKAORVCS+1                                                    
         AR    R4,R3                                                            
         MVC   0(1,R4),SVAORMVC     STORE CODE IN LIST                          
*                                                                               
VBCA2    SR    R3,R3                                                            
         LA    R5,WKROW                                                         
         LA    R4,WKAORVCS         AOR VAT CODES                                
         MVC   VBAFULL,AORDSP(R7)  ALL PROVS HAVE SAME AOR VAT BASIS            
         CLI   C2AORSW,C'Y'        DOING COST2 AOR TAXES?                       
         BNE   *+10                                                             
         MVC   VBAFULL,AORDSP+4(R7)  COST2 AOR AMOUNT                           
*                                                                               
VBCA4    DS    0H                                                               
         CLI   0(R4),C'H'          HST                                          
         BE    VBCA4H                                                           
         CLI   0(R4),C'S'          % ONLY FOR CODE S AND H                      
         BNE   VBCA8                                                            
*                                                                               
         LTR   R3,R3               SEE IF DOING GST                             
         BNZ   VBCA4H                                                           
*                                                                               
         CLC   HALF,=X'6104'       YES, SEE IF BEFORE APR/97  **Y2K**           
         BL    VBCA4H              DO GST                                       
*                                                                               
         CLI   MANRVDTP,0                                                       
         BE    *+18                                                             
         CLC   MANRVDTP,=X'E281'                                                
         BNL   *+26                                                             
         B     *+14                                                             
         CLC   TODAYB,=X'710401'   SEE IF ON OR AFTER APR1/2013                 
         BNL   *+12                                                             
*                                                                               
         CLI   WKAORVCS+1,C' '     SEE IF BRITISH COLUMBIA APPLIES              
         BH    VBCA8               THEN NO GST                                  
         CLI   WKAORVCS+5,C' '     SEE IF ONTARIO APPLIES                       
         BH    VBCA8               THEN NO GST                                  
         CLI   WKAORVCS+7,C' '     SEE IF NEW BRUNSWICK APPLIES                 
         BH    VBCA8               THEN NO GST                                  
         CLI   WKAORVCS+8,C' '     SEE IF NOVA SCOTIA APPLIES                   
         BH    VBCA8               THEN NO GST                                  
         CLI   WKAORVCS+9,C' '     SEE IF P.E. ISLAND APPLIES                   
         BH    VBCA8               THEN NO GST                                  
         CLI   WKAORVCS+10,C' '    SEE IF NEWFOUNDLAND APPLIES                  
         BH    VBCA8               THEN NO GST                                  
*                                                                               
*                                                                               
VBCA4H   DS    0H                                                               
         GOTOR VBGETPCT,VBADMCB,((R3),HALF),(R4) GET VCTAB ENTRY                
         SR    R0,R0               VAT %                                        
         ICM   RF,15,4(R1)          A(VCTAB ENTRY)                              
         BZ    VBCA8               IF NOT FOUND SKIP TO NEXT PROV               
*                                                                               
         L     R0,VCTPCT-VCTABD(RF)   VAT %                                     
         L     R1,VBAFULL          ALL PROVS HAVE SAME AOR VAT BASIS            
*                                                                               
         LTR   R3,R3               IF NOT DOING GST NOW                         
         BZ    VBCA6                                                            
*                                  ADD GST TO GET PROV BASIS                    
*                                  FIRST APPLY GST TO GET BASIS                 
*                                  BUT FOR HST PROV'S BASE IS                   
*                                  GROSS, NOT GROSS+GST                         
*                                                                               
         CLI   MANRVDTP,0                                                       
         BE    *+18                                                             
         CLC   MANRVDTP,=X'E281'                                                
         BNL   *+26                                                             
         B     *+14                                                             
         CLC   TODAYB,=X'710401'   SEE IF ON OR AFTER APR1/2013                 
         BNL   *+12                                                             
*                                                                               
         CHI   R3,1                BRITISH COLUMBIA (#1)                        
         BE    VBCA6                                                            
         CHI   R3,5                ONTARIO       (#5)                           
         BE    VBCA6                                                            
         CHI   R3,7                NEW BRUNSWICK (#7)                           
         BE    VBCA6                                                            
         CHI   R3,8                NOVA SCOTIA   (#8)                           
         BE    VBCA6                                                            
         CHI   R3,9                P.E. ISLAND   (#9)                           
         BE    VBCA6                                                            
         CHI   R3,10               NEWFOUNDLAND  (#10)                          
         BE    VBCA6                                                            
*                                                                               
         CHI   R3,6                QUEBEC  (#6)                                 
         BNE   VBCA4                                                            
         CLI   MANRVDTP,0          ARE WE REVERSING?                            
         BE    VBCA4R                                                           
         CLC   MANRVDTP,=X'E221'   A BILL BEFORE JAN01/2013                     
         BL    VBCA4X                                                           
         B     VBCA6                                                            
*                                                                               
VBCA4R   CLC   TODAYB,=X'710101'   IS IF AFTER JAN01/2013?                      
         BL    VBCA4X                                                           
         B     VBCA6                                                            
*                                                                               
VBCA4X   DS    0H                                                               
         A     R1,VBASVGST         ADD GST TO GET PROV BASIS                    
*                                                                               
VBCA6    DS    0H                                                               
         MR    R0,R0                                                            
         L     RF,=F'100000'                                                    
         DRNDR (R0),(RF)                                                        
*                   **NOTE-AOR VAT NOT IN VBTAB                                 
         LTR   R3,R3               IF DOING GST NOW                             
         BNZ   *+8                                                              
         ST    R1,VBASVGST         SAVE GST AMOUNT                              
         CLI   C2AORSW,C'Y'        SEE IF DOING COST2 AOR                       
         BNE   VBCA7                                                            
         ST    R1,VATADSP+4(R7)      SET IN MONTH CUME ROW                      
         A     R1,VATADSP+4-EXTDSP(R5)   AND TOTAL IN WKROW                     
         ST    R1,VATADSP+4-EXTDSP(R5)                                          
         B     VBCA8                                                            
*                                                                               
VBCA7    ST    R1,VATADSP(R7)      SET IN MONTH CUME ROW                        
         A     R1,VATADSP-EXTDSP(R5)   AND TOTAL IN WKROW                       
         ST    R1,VATADSP-EXTDSP(R5)                                            
*                                                                               
VBCA8    DS    0H                                                               
         CHI   R3,NPROVS                                                        
         BNL   VBCA9                                                            
         LA    R3,1(R3)                                                         
         LA    R5,8(R5)            NEXT WKROW SLOT                              
         LA    R7,8(R7)            NEXT ACCUM SLOT                              
         LA    R4,1(R4)            NEXT PROVINCE                                
         B     VBCA4                                                            
*                                                                               
VBCA9    DS    0H                                                               
         MVC   VBAMODE,=C'CA'        VBCALC MODE - AOR                          
         GOTOR VBATRC,VBADMCB,(R9)                                              
*                                                                               
         XIT1                                                                   
         DROP  R9                                                               
*                                                                               
         LTORG                                                                  
*                                                                               
WKAORVCS DS     CL11     GST + 10 PROVINCES                                     
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBCALCR  CALC VAT AMOUNTS FOR RETAIL BILLS                             
*                 AND ADD INTO WKROW                                            
*                                                                               
*        PARM1  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(PERLIST ENTRY)                                      
*        PARM2  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(MONTH CUME SLOT - ATOTS)                            
*        PARM3  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(BRKTAB ENTRY)                                       
*        PARM4  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(RETAIL SHARE PCT)                                   
*                                                                               
*        NOTE - VAT IS CALCULATED FOR THE GIVEN MONTH AND                       
*               TOTALED IN WKROW TO STAY COMPATIBLE WITH OLD BILCALC.           
*               IT IS ALSO SET AT VATRDSP IN THE REGULAR CUME (AT R7).          
*               ALSO TAX IS SET AT RETTDSP.                                     
*             **IT IS NOT STORED IN THE VBTAB                                   
*                                                                               
***********************************************************************         
         SPACE 2                                                                
         PRINT NOGEN                                                            
VBCALCR  NMOD1 VBAWRKL,VBCALCR                                                  
         LR    R9,RC                                                            
         USING VBAWRKD,R9                                                       
         LA    RC,SPACEND                                                       
         L     R7,4(R1)            A(MONTH CUME SLOT)                           
         L     R3,8(R1)                                                         
         ST    R3,VBABRK           SAVE A(BREAK TABLE ENTRY)                    
         MVC   VBABRKC,BRKCODE-BRKTABD(R3)                                      
         L     RF,12(R1)           RETAIL SHARE PCT                             
         MVC   VBAFULL,0(RF)                                                    
         ST    R1,VBASVR1                                                       
         SPACE 2                                                                
*                                                                               
         L     RF,0(R1)                                                         
         LA    R0,PERLIST                                                       
         SR    RE,RE                                                            
         SR    RF,R0                                                            
         D     RE,=A(PERLISTL)                                                  
         MHI   RF,(NPROVS+1)*VBTABL                                             
         L     R2,VBABRKC                                                       
         L     R2,ATOTSV(R2)                                                    
         AR    R2,RF                                                            
         USING VBTABD,R2                                                        
*                                                                               
         LHI   R3,NPROVS+1                                                      
         LA    R5,WKROW                                                         
*                                                                               
VBCR4    DS    0H                                                               
         L     R1,VBTTAX           TAX AMOUNT FROM VBTAB ENTRY                  
         L     R0,VBAFULL          X SHARE % (TAX WILL NOT ADD                  
         MR    R0,R0               UP TO THE PENNY LIKE OTHER RETAIL            
         LHI   RF,10000            FIELDS BUT THATS OK BECAUSE IT IS            
         DRNDR (R0),(RF)                                                        
*                                                                               
         LR    RE,R1                                                            
         ST    RE,RETTDSP(R7)      SET TAX IN ACCUM                             
         A     RE,RETTDSP-EXTDSP(R5)    AND ROW FOR TOTALS                      
         ST    RE,RETTDSP-EXTDSP(R5)                                            
*                                                                               
         L     R1,VBTVATB          VAT BASIS                                    
         L     R0,VBAFULL          X SHARE % (TOTAL MAY BE DIFFER               
         MR    R0,R0               SLIGHTLY FROM RETADSP BECAUSE                
         LHI   RF,10000            OF ROUNDING)                                 
         DRNDR (R0),(RF)                                                        
         ST    R1,VBTVATB          STORE BASIS BACK IN VBTAB                    
*                                                                               
         LR    RE,R1                    VAT BASIS                               
         ST    RE,VATRBDSP(R7)          SET IN MONTH CUME ROW                   
         A     RE,VATRBDSP-EXTDSP(R5)   AND TOTAL IN WKROW                      
         ST    RE,VATRBDSP-EXTDSP(R5)                                           
*                                                                               
         ICM   R0,15,VBTPCT                                                     
         MR    R0,R0                                                            
         L     RF,=F'100000'                                                    
         DRNDR (R0),(RF)                                                        
         ST    R1,VBTVAT                                                        
*                                                                               
         ST    R1,RETVDSP(R7)      SET IN MONTH CUME ROW                        
         A     R1,RETVDSP-EXTDSP(R5)   AND TOTAL IN WKROW                       
         ST    R1,RETVDSP-EXTDSP(R5)                                            
*                                                                               
         LA    R2,VBTABL(R2)       NEXT PROVINCE                                
         LA    R5,8(R5)            NEXT WKROW SLOT                              
         LA    R7,8(R7)            NEXT ACCUM SLOT                              
         BCT   R3,VBCR4                                                         
*                                                                               
         MVC   VBAMODE,=C'CR'        VBCALC MODE - RETAIL                       
         GOTOR VBATRC,VBADMCB,(R9)                                              
*                                                                               
         XIT1                                                                   
*                                                                               
         DROP  R2                                                               
         DROP  R9                                                               
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBGETPCT  - GET VCTAB ENTRY                                            
*                                                                               
*                    PARM1 BYTE  0     PROVINCE NUMBER                          
*                          BYTES 1-3   A(MOS)                                   
*                    PARM2 BYTE  0     NOT USED                                 
*                          BYTES 1-3   A(VAT CODE)                              
*                                      ON OUTPUT = A(TABLE ENTRY)               
*                                                                               
***********************************************************************         
         SPACE 2                                                                
         PRINT NOGEN                                                            
VBGETPCT NMOD1 VBAWRKL,VBGPC                                                    
         LR    R9,RC                                                            
         USING VBAWRKD,R9                                                       
         LA    RC,SPACEND                                                       
*                                                                               
*        L     R2,=A(VCTAB11)      VAT CODE TABLE                               
*        CLC   TODAYB,=X'700101'   ON OR AFTER JAN1/12?                         
*        BL    VBGPC4                                                           
*        L     R2,=A(VCTAB12)      USE 2012 TABLE                               
*        CLC   TODAYB,=X'710101'   ON OR AFTER JAN1/13?                         
*        BL    VBGPC4                                                           
*                                                                               
         L     R2,=A(VCTAB13)      USE 2013 TABLE                               
         USING VCTABD,R2                                                        
         CLI   MANRVDTP,0          AM I REVERSING?                              
         BE    *+10                                                             
         CLC   MANRVDTP,=X'E281'   ON OR AFTER APR1/2013                        
         BL    VBGPC4                                                           
*                                                                               
         L     R2,=A(VCTAB13A)     USE 2013A TABLE                              
         CLI   MANRVDTP,0          AM I REVERSING?                              
         BE    *+10                                                             
         CLC   MANRVDTP,=X'E8E1'   ON OR AFTER JUL1/2016                        
         BL    VBGPC4                                                           
*                                                                               
         L     R2,=A(VCTAB16)      USE 2016 JUL TABLE                           
         CLI   MANRVDTP,0          AM I REVERSING?                              
         BE    *+10                                                             
         CLC   MANRVDTP,=X'E941'   ON OR AFTER OCT1/2016                        
         BL    VBGPC4                                                           
*                                                                               
         CLC   TODAYB,=X'740A01'   ON OR AFTER OCT1/16?                         
         BL    VBGPC4                                                           
         L     R2,=A(VCTAB16A)     USE 2016 TABLE                               
*                                                                               
VBGPC4   DS    0H                                                               
         CLC   0(1,R1),VCTPRV       PROVINCE                                    
         BNE   VBGPC8                                                           
         L     RF,4(R1)                                                         
         CLC   0(1,RF),VCTVCD       CODE                                        
         BNE   VBGPC8                                                           
         SR    RF,RF                                                            
         ICM   RF,7,1(R1)          MOS                                          
         BZ    VBGPC8B             IF 0, IGNORE                                 
         OC    0(2,RF),0(RF)                                                    
         BZ    VBGPC8B                                                          
         CLC   0(2,RF),VCTSTRT        START MOS                                 
         BL    VBGPC8                                                           
         CLC   0(2,RF),VCTEND         END MOS                                   
         BNH   VBGPC8B                                                          
*                                                                               
VBGPC8   DS    0H                                                               
         LA    R2,VCTABL(R2)       NEXT ENTRY                                   
         CLI   0(R2),X'FF'         END OF TABLE                                 
         BNE   VBGPC4                                                           
         XC    4(4,R1),4(R1)       NO ENTRY                                     
         B     VBGPCX                                                           
*                                                                               
VBGPC8B  DS    0H                                                               
         MVC   VBHLDVCT,0(R2)       COPY ENTRY (IT MIGHT CHANGE)                
         LA    R2,VBHLDVCT                                                      
         OC    MANRVDTP,MANRVDTP   IF A REVERSAL USE OLD RATE                   
         BZ    VBGPC9                                                           
         CLI   VCTPRV,6            IF QUEBEC                                    
         BNE   VBGPC8B4                                                         
         L     RE,=A(OLDQST)                                                    
VBGPC8B3 CLC   MANRVDTP,2(RE)                                                   
         BH    *+14                                                             
         MVC   VCTPCT,4(RE)                                                     
         B     VBGPC8B4                                                         
*                                                                               
         LA    RE,L'OLDQST(RE)                                                  
         CLI   0(RE),X'FF'                                                      
         BNE   VBGPC8B3                                                         
         B     VBGPC8B4                                                         
*        CLC   MANRVDTP,=X'C422'   BEFORE 1/2/98   **Y2K**                      
*        BNL   VBGPC8B2                                                         
*        MVC   VCTPCT,=F'6500'     USE OLD 6.5% RATE                            
*        B     VBGPC9                                                           
*                                                                               
*BGPC8B2 CLC   MANRVDTP,=X'DE21'   BEFORE 1/1/11  **Y2K**                       
*        BNL   VBGPC9                                                           
*        MVC   VCTPCT,=F'7500'     USE OLD 7.5% RATE                            
*        B     VBGPC9                                                           
*                                                                               
VBGPC8B4 CLI   VCTPRV,0            IF GST                                       
         BNE   VBGPC8H                                                          
         CLI   VCTVCD,C'S'         AND HAS REAL TAX                             
         BNE   VBGPC8H                                                          
         CLC   MANRVDTP,=X'D4E1'   BEFORE 7/1/06   **Y2K**                      
         BNL   *+14                                                             
         MVC   VCTPCT,=F'7000'     USE OLD 7.0% RATE                            
         B     VBGPC8H                                                          
*                                                                               
         CLC   MANRVDTP,=X'D821'   BEFORE 1/1/08   **Y2K**                      
         BNL   *+10                                                             
         MVC   VCTPCT,=F'6000'     USE OLD 6.0% RATE                            
         B     VBGPC9                                                           
*                                                                               
VBGPC8H  CLI   VCTVCD,C'H'         IF HST                                       
         BNE   VBGPC9                                                           
*                                                                               
         CLI   VCTPRV,1            IF BC                                        
         BNE   VBGPC8H1                                                         
         CLC   MANRVDTP,=X'E281'   BEFORE 4/1/13                                
         BNL   *+10                                                             
         MVC   VCTPCT,=F'12000'    USE OLD 12.0% RATE                           
         B     VBGPC9                                                           
*                                                                               
VBGPC8H1 CLI   VCTPRV,7            IF NB                                        
         BE    *+12                                                             
         CLI   VCTPRV,10           OR NF                                        
         BNE   VBGPC8H2                                                         
         CLC   MANRVDTP,=X'E8E1'   BEFORE 7/1/16                                
         BNL   *+10                                                             
         MVC   VCTPCT,=F'13000'    USE OLD 13.0% RATE                           
         B     VBGPC9                                                           
*                                                                               
VBGPC8H2 CLI   VCTPRV,9            IF PE                                        
         BNE   VBGPCH4                                                          
         CLC   MANRVDTP,=X'E281'   BEFORE 4/1/13                                
         BH    *+10                                                             
         MVC   VCTPCT,=F'00000'    USE OLD 00.0% RATE                           
         B     VBGPC9                                                           
*                                                                               
         CLC   MANRVDTP,=X'E941'   BEFORE OCT1/2016                             
         BNL   *+10                                                             
         MVC   VCTPCT,=F'14000'    USE OLD 14.0% RATE                           
         B     VBGPC9                                                           
*                                                                               
*        OTHER PROVINCES                                                        
VBGPCH4  CLC   MANRVDTP,=X'D4E1'   BEFORE 7/1/06   **Y2K**                      
         BNL   *+14                                                             
         MVC   VCTPCT,=F'15000'    USE OLD 15.0% RATE                           
         B     VBGPC9                                                           
*                                                                               
         CLC   MANRVDTP,=X'D821'   BEFORE 1/1/08   **Y2K**                      
         BNL   *+14                                                             
         MVC   VCTPCT,=F'14000'    USE OLD 14.0% RATE                           
         B     VBGPC9                                                           
*                                                                               
VBGPC9   DS    0H                                                               
         ST    R2,4(R1)            RETURN A(ENTRY)                              
*                                                                               
VBGPCX   DS    0H                                                               
         XIT1                                                                   
         DROP  R2                                                               
         DROP  R9                                                               
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBPRNT   CREATE GST/PST PRINT LINES                                    
*                                                                               
*        PARM1  BYTE  0   MODE- N=NORMAL,J=SEP ADJ,A=AOR                        
*               BYTES 1-3 A(BRKTAB ENTRY)                                       
*        PARM2  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(DISP INTO LINE OF WHERE VAT$ TO PRINT)              
*        PARM3  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(VAT CODES) FOR OTHER AGY  ** AOR MODE ONLY          
*        PARM4  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(AOR VAT BASIS)    = AOR AMOUNT                      
*        PARM5  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(AOR VAT AMOUNTS)                                    
*        PARM6  BYTES 0-3 ON RETURN = SUM OF ALL VATS                           
*                                                                               
*              NOTE - 'NORMAL' MODE INCLUDES RETAIL                             
*                                                                               
***********************************************************************         
         SPACE 2                                                                
         PRINT NOGEN                                                            
VBPRNT   NMOD1 VBAWRKL,VBPRNT                                                   
         LR    R9,RC                                                            
         USING VBAWRKD,R9                                                       
         LA    RC,SPACEND                                                       
         SR    R3,R3                                                            
         ICM   R3,7,1(R1)                                                       
         ST    R3,VBABRK           SAVE A(BREAK TABLE ENTRY)                    
         MVC   VBABRKC,BRKCODE-BRKTABD(R3)                                      
         MVC   VBPRMODE,0(R1)      MODE                                         
         ST    R1,VBASVR1                                                       
         MVC   VBAPARMS,0(R1)      SAVE PARMS                                   
         XC    VBASVGSP,VBASVGSP                                                
         SPACE 2                                                                
*                                                                               
         XC    WK,WK               USE WK FOR EDI CALL                          
W@       USING ECTAXD,WK                                                        
*                                                                               
         CLI   VBPRMODE,C'N'       IF 'NORMAL' MODE                             
         BNE   *+8                                                              
         BAS   RE,VBPRMTOT         ADD UP TO 'TOTAL MONTH'                      
*                                                                               
         L     R2,VBABRKC                      RIGHT LEVEL                      
         L     R2,ATOTSV(R2)                                                    
         LHI   RF,MAXMOS*(NPROVS+1)*VBTABL  POINT TO 'TOTAL MONTH'              
         AR    R2,RF                                                            
         USING VBTABD,R2                                                        
*                                                                               
         SR    R3,R3               PROVINCE INDEX                               
         L     R4,4(R1)            A(DISPL WHERE VAT $ TO PRINT)                
         LA    R4,P(R4)                                                         
         ST    R4,VBALINE                                                       
         L     R5,8(R1)            A(AOR VAT CODES)                             
         MVC   VBASVGSP,VBTPCT     SAVE GST %                                   
         XC    VBADUB,VBADUB                                                    
*                                                                               
VBPR4    DS    0H                                                               
         CLI   VBPRMODE,C'A'       FOR AOR                                      
         BNE   VBPR4D                                                           
         CLI   0(R5),C' '          CHECK AOR VAT CODE ACTIVE                    
         BH    VBPR4E                                                           
*                                                                               
VBPR4C   DS    0H                                                               
         LTR   R3,R3               DO GST EVEN IF NO CODE??                     
         BZ    VBPR4E              (WILL ONLY BE HERE IF                        
         B     VBPR21               CVATSW NOT = 0)                             
*                                                                               
VBPR4D   DS    0H                  NOT AOR                                      
*                                                                               
*     CODE BELOW PREVENTS PRINTING OF GST IF THE GST BASIS IS ZERO              
*                                                                               
         L     RF,APER             PERIOD (MOS)                                 
         ZIC   RE,0(RF)                                                         
         LA    RE,PERLIST(RE)                                                   
         CLC   0(2,RE),=X'6E07'    CHECK IF MOS JUL/10 OR LATER                 
         BL    VBPR4D5                                                          
*                                                                               
         LTR   R3,R3               DOING GST?                                   
         BNZ   VBPR4D5                                                          
         CLI   CVATCDS,C'X'                                                     
         BE    VBPR4D5                                                          
         CLI   CVATCDS,C'Z'                                                     
         BE    VBPR4D5                                                          
         L     R1,VBTVATB          SEE IF BASIS IS ZERO                         
         LTR   R1,R1                                                            
         BZ    VBPR21              SKIP GST GO TO NEXT PROVINCE                 
*                                                                               
VBPR4D5  DS    0H                                                               
         CLI   VBTCOD,C' '         ACTIVE PROVINCE?                             
         BNH   VBPR4C                                                           
*                                                                               
VBPR4E   DS    0H                                                               
         CLI   VBPRMODE,C'A'        SEE IF AOR                                  
         BNE   VBPR4E5                                                          
         LTR   R3,R3                SEE IF DOING GST                            
         BNZ   VBPR4E1                                                          
*        BZ    VBPR4E5                                                          
*        L     RF,APER             PERIOD (MOS)                                 
*        ZIC   RE,0(RF)                                                         
*        LA    RE,PERLIST(RE)                                                   
*        CLC   0(2,RE),=X'6E07'    CHECK IF MOS JUL/10 OR LATER                 
*        BL    VBPR4E5                                                          
*                                                                               
         CLI   0(R5),C'X'         FOR THESE CODES - ALWAYS SHOW GST             
         BE    VBPR4E5                                                          
         CLI   0(R5),C'Z'                                                       
         BE    VBPR4E5                                                          
*                                                                               
         LR    RF,R3                                                            
         MHI   RF,8                                                             
         L     R1,VBAPARMS+16       A(AOR VAT AMOUNTS)                          
         L     RE,0(R1,RF)                                                      
         LTR   RE,RE                IS THERE ANY GST?                           
         BNZ   VBPR4E5              SKIP TO NEXT PROVINCE                       
         B     VBPR21                                                           
*                                                                               
*        L     R1,VBTPCT            IS % ZERO?  (CAN'T CHECK BASIS)             
*        LTR   R1,R1                                                            
*        BZ    VBPR21               SKIP TO NEXT PROVINCE                       
*                                                                               
VBPR4E1  CLI   0(R5),C'H'           HST                                         
         BE    *+12                                                             
         CLI   0(R5),C'S'       ALL NON-'S' CODES ARE NOW ZERO PCT.             
         BNE   VBPR4E5              SHOW THEM EVEN IF VAT IS ZERO               
*                                                                               
         LR    RF,R3                                                            
         MHI   RF,8                                                             
         L     R1,VBAPARMS+16        A(AOR VAT AMOUNTS)                         
         L     RE,0(R1,RF)                                                      
         LTR   RE,RE                                                            
         BZ    VBPR21                SKIP TO NEXT PROVINCE IF NO VAT            
*                                                                               
VBPR4E5  MVC   VBAWRK2,SPACES                                                   
         LA    RE,VBAWRK2                                                       
*                                                                               
         MVC   VBAWRK2,SPACES                                                   
         LA    RE,VBAWRK2                                                       
         LR    RF,R3                                                            
         MHI   RF,14                                                            
         A     RF,=A(PSTNAMS)     'NAME' OF GST/PST                             
         MVC   0(7,RE),0(RF)       ENGLISH                                      
         CLI   RCLANG,4                                                         
         BNE   *+10                                                             
         MVC   0(7,RE),7(RF)       OR FRENCH                                    
*                                                                               
         MVC   W@.ECTAXT,0(RE)     SAVE FOR EDI TRANSMISSION                    
*                                                                               
         LA    RE,8(RE)                                                         
         CLI   0(RE),C' '                                                       
         BH    *+8                                                              
         BCT   RE,*-8                                                           
         LA    RE,3(RE)                                                         
*                                                                               
         LR    RF,R3                                                            
         MHI   RF,16                                                            
         A     RF,=A(VATACCS)      ACCOUNT # TABLE                              
         MVC   W@.ECTAXA(16),SPACES                                             
         CLI   0(RF),C' '          ANY # PRESENT?                               
         BNH   VBPR4F                                                           
         MVI   0(RE),C'#'                                                       
         MVC   1(16,RE),0(RF)                                                   
         MVC   W@.ECTAXA,1(RE)     SAVE FOR EDI TRANSMISSION                    
         LA    RE,16(RE)                                                        
         CLI   0(RE),C' '                                                       
         BH    *+8                                                              
         BCT   RE,*-8                                                           
*                                                                               
VBPR4F   DS    0H                                                               
         SHI   R4,27               BACK UP 27 SPACES                            
         LA    R0,VBAWRK2                                                       
         SR    RE,R0               RE = LEN(NAME + ACCT -1)                     
         LR    RF,R4                                                            
         SR    RF,RE                                                            
         SHI   RF,3                                                             
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),VBAWRK2                                                  
*                                                                               
         MVC   VBAFULL,VBTPCT      %                                            
*                                                                               
         CLI   VBPRMODE,C'A'       FOR AOR, GET % FROM VCTAB                    
         BNE   VBPR4H                                                           
*                                                                               
         OC    VBAFULL,VBAFULL     UNLESS I HAVE ONE                            
         BNZ   VBPR4H                                                           
*                                                                               
         XC    VBAFULL,VBAFULL                                                  
         CLI   0(R5),C'H'          HST                                          
         BE    *+12                                                             
         CLI   0(R5),C'S'          % ONLY FOR CODE S/H                          
         BNE   VBPR4H                                                           
*                                                                               
         LTR   R3,R3              SEE IF DOING GST                              
         BNZ   VBPR4G                                                           
         LR    RF,R3                                                            
         MHI   RF,8                                                             
         L     R1,VBAPARMS+16        A(AOR VAT AMOUNTS)                         
         L     RE,0(R1,RF)                                                      
         LTR   RE,RE                                                            
         BNZ   VBPR4G              IS THERE ANY GST AMOUNT                      
*                                  IF NOT-SET PCT TO ZERO                       
         XC    VBAFULL,VBAFULL                                                  
         B     VBPR4H1                                                          
*                                                                               
VBPR4G   DS    0H                                                               
         GOTOR VBGETPCT,VBADMCB,((R3),0),(R5)                                   
         ICM   RF,15,4(R1)                                                      
         BNZ   *+6                                                              
         DC    H'0'                                                             
         MVC   VBAFULL,VCTPCT-VCTABD(RF)  SET %                                 
*                                                                               
VBPR4H   DS    0H                                                               
         LTR   R3,R3               IF DOING GST NOW                             
         BNZ   VBPR4H0                                                          
         MVC   VBASVGSP,VBAFULL    SAVE GST %                                   
VBPR4H0  CLC   VBAFULL,=X'FFFFFFFF'    MIXED %'S  (SHOULDN'T HAPPEN)?           
         BE    VBPR8                                                            
         LTR   R3,R3                SEE IF DOING GST                            
         BZ    VBPR4H1                                                          
*                                                                               
         CLI   VBPRMODE,C'A'        DOING AOR INV?                              
         BNE   VBPR4H0B                                                         
         CLI   0(R5),X'FF'          MIXED PROVINCIAL CODES                      
         BE    VBPR8                IF SO, DON'T SHOW % OR BASIS                
         B     VBPR4H1                                                          
*                                                                               
VBPR4H0B CLI   VBTCOD,X'FF'         MIXED HST VAT CODES                         
         BE    VBPR8                SKIP % AND BASIS                            
*                                                                               
VBPR4H1  DS    0H                                                               
         CLI   VBTCOD,X'FF'         MIXED HST VAT CODES                         
         BE    VBPR8                SKIP % AND BASIS                            
*                                                                               
         MVI   0(R4),C'('                                                       
         LA    R4,1(R4)                                                         
         OC    VBAFULL,VBAFULL     IF NO %                                      
         BNZ   *+18                                                             
         MVC   0(5,R4),=C'0.000'                                                
         LA    R4,5(R4)                                                         
         B     VBPR4H3                                                          
*                                                                               
         EDIT  VBAFULL,(7,0(R4)),3,ALIGN=LEFT   %                               
         AR    R4,R0                                                            
VBPR4H3  DS    0H                                                               
         MVC   W@.ECTAXP,VBAFULL    SAVE FOR EDI TRANSMISSION                   
         MVI   0(R4),C'%'                                                       
         MVI   1(R4),C')'                                                       
*                                                                               
*                                  GET BASIS AMOUNTS                            
*                                  -----------------                            
*                                                                               
         OC    VBAFULL,VBAFULL     SKIP IF NO %                                 
         BZ    VBPR8                                                            
*                                                                               
         CLI   VBPRMODE,C'A'       AOR MODE                                     
         BNE   VBPR4I                                                           
         L     R1,VBAPARMS+12      A(AMOUNT) IN PARM4                           
         L     R1,0(R1)                                                         
         LTR   R3,R3               IF NOT DOING GST NOW                         
         BZ    VBPR4H4                                                          
*                                                                               
         CLI   MANRVDTP,0                                                       
         BE    *+18                                                             
         CLC   MANRVDTP,=X'E281'                                                
         BNL   *+26                                                             
         B     *+14                                                             
         CLC   TODAYB,=X'710401'   SEE IF ON OR AFTER APR1/2013                 
         BNL   *+12                                                             
*                                                                               
         CHI   R3,1                OR BRITISH COLUMBIA                          
         BE    VBPR4H4                                                          
         CHI   R3,5                OR ONTARIO                                   
         BE    VBPR4H4                                                          
         CHI   R3,7                OR NEW BRUNSWICK                             
         BE    VBPR4H4                                                          
         CHI   R3,8                OR NOVA SCOTIA                               
         BE    VBPR4H4                                                          
         CHI   R3,9                OR P.E. ISLAND                               
         BE    VBPR4H4                                                          
         CHI   R3,10               OR NEWFOUNDLAND                              
         BE    VBPR4H4                                                          
*                                                                               
*                                                                               
         CHI   R3,06               QUEBEC  (#06)                                
         BNE   VBPR4Q                                                           
*                                                                               
         CLI   MANRVDTP,0           ARE WE REVERSING?                           
         BE    VBPR4R                                                           
         CLC   MANRVDTP,=X'E221'    BILL BEFORE JAN01/2013?                     
         BL    VBPR4Q               YES - APPLY GST                             
         B     VBPR4H4              NO - DON'T APPLY GST                        
*                                                                               
VBPR4R   CLC   TODAYB,=X'710101'   ARE WE BEFORE JAN01/2013?                    
         BL    VBPR4Q              YES - APPLY GST                              
         B     VBPR4H4             NO - DON'T APPLY GST                         
*                                                                               
VBPR4Q   ICM   R0,15,VBASVGSP      FIRST APPLY GST TO GET BASIS                 
         A     R0,=F'100000'                                                    
         MR    R0,R0                                                            
         L     RF,=F'100000'                                                    
         DRNDR (R0),(RF)                                                        
*                                                                               
VBPR4H4  DS    0H                                                               
         B     VBPR6B                                                           
*                                                                               
VBPR4I   DS    0H                                                               
         CLI   VBPRMODE,C'J'       SEP ADJ BILL MODE                            
         BNE   VBPR4L                                                           
         LR    RF,R3               PROVINCE INDEX                               
         MHI   RF,8                X8 FOR DISP                                  
         L     R1,VATCBDSP(R7,RF)  ADJ VAT BASIS                                
         B     VBPR6B                                                           
*                                                                               
VBPR4L   DS    0H                  'NORMAL' MODE                                
         CLI   RETPROF,0           IF RETAIL                                    
         BE    *+12                                                             
         L     R1,VBTVATB          BASIS FROM VBTAB                             
         B     VBPR6B                                                           
*                                                                               
         L     R1,VBTVATB          NON-RETAIL: BASIS FROM VBTAB                 
         STCM  R1,15,W@.ECTAXB     SAVE FOR EDI TRANSMISSION                    
*                                                                               
VBPR6B   DS    0H                                                               
         LTR   R1,R1               ANY BASIS ?                                  
         BZ    VBPR8               NO, DONT SHOW IT                             
         MVI   1(R4),C' '                                                       
         MVC   2(2,R4),=C'OF'                                                   
         CLI   RCLANG,4            FRENCH                                       
         BNE   *+10                                                             
         MVC   2(2,R4),=C'DE'                                                   
         LA    R4,5(R4)                                                         
*                                  BASIS AMOUNT                                 
         LR    R0,R1                                                            
         STCM  R0,15,W@.ECTAXB     SAVE FOR EDI TRANSMISSION                    
         CURED (R0),(14,0(R4)),CURTAB,CR=YES,COMMAS=YES,ALIGN=LEFT              
         AR    R4,R0                                                            
         MVI   0(R4),C')'                                                       
*                                                                               
*                                  ACTUAL VAT AMOUNT                            
*                                  **NOTE- COULD GET SOME FROM VBTAB            
*                                  **NOTE- 'TOTAL MONTH' CUMES                  
VBPR8    DS    0H                                                               
         L     R7,VBABRKC                                                       
         L     R7,ATOTS(R7)        POINT TO ACCUME                              
         AHI   R7,MAXMOS*ROWL      TOTAL MONTH ROW                              
         LR    RF,R3               PROVINCE INDEX                               
         MHI   RF,8                X8 FOR DISP INTO VAT AMOUNTS                 
         L     RE,RETVDSP(R7,RF)   USE RETAIL VAT                               
         CLI   RETPROF,0           IF RETAIL                                    
         BNE   *+8                                                              
         L     RE,VATDSP(R7,RF)                                                 
         CLI   VBPRMODE,C'J'       IF SEP ADJ BILL NOW                          
         BNE   *+8                                                              
         L     RE,VATCDSP(R7,RF)   USE ADJ VAT                                  
         CLI   VBPRMODE,C'A'       IF AOR                                       
         BNE   *+12                                                             
         L     R1,VBAPARMS+16      PARM5 HAS A(AMOUNTS)                         
         L     RE,0(R1,RF)         USE AOR VAT                                  
*                                                                               
         L     R4,VBALINE          WHERE TO PRINT VAT $                         
         LR    R0,RE                                                            
         STCM  R0,15,W@.ECTAX      SAVE FOR EDI TRANSMISSION                    
         CURED (R0),(16,0(R4)),CURTAB,CR=YES,COMMAS=YES                         
*                                                                               
         A     R0,VBADUB           CUME VAT AMOUNTS                             
         ST    R0,VBADUB                                                        
*                                                                               
         GOTO1 ABILLEDI,DMCB,('EDMCTX',0)                                       
         XC    WK,WK                                                            
*                                                                               
         L     R4,VBALINE          BUMP TO NEXT LINE                            
         LA    R4,132(R4)                                                       
         ST    R4,VBALINE                                                       
*                                                                               
VBPR21   DS    0H                                                               
         LA    R2,VBTABL(R2)       NEXT PROVINCE                                
         LA    R5,1(R5)                                                         
         LA    R3,1(R3)                                                         
         CHI   R3,NPROVS                                                        
         BNH   VBPR4                                                            
         BRAS  RE,PRNT                                                          
*                                                                               
         L     R1,VBASVR1          RESTORE R1                                   
         MVC   20(4,R1),VBADUB     RETURN VAT TOTAL IN PARM 6                   
         XIT1                                                                   
*                                                                               
         DROP  W@                                                               
         SPACE 2                                                                
***********************************************************************         
*   VBPRMTOT - ADD UP TO 'TOTAL MONTH'                                          
***********************************************************************         
*                                                                               
VBPRMTOT NTR1                                                                   
         L     R2,VBABRKC                      FIRST MONTH/PROV                 
         L     R2,ATOTSV(R2)                                                    
         LHI   R3,MAXMOS*(NPROVS+1)*VBTABL  POINT TO 'TOTAL MONTH'              
         AR    R3,R2                                                            
*                                                                               
         LHI   R0,NPROVS+1         FIRST CLEAR TOTAL                            
         LR    R4,R3                                                            
         XC    0(VBTABL,R4),0(R4)                                               
         LA    R4,VBTABL(R4)                                                    
         BCT   R0,*-10                                                          
*                                  NOW ROLL UP TOTALS                           
         LHI   R5,MAXMOS           PROVINCES WITHIN MONTHS                      
*                                                                               
VBMT2    DS    0H                                                               
         LHI   R0,NPROVS+1                                                      
         LR    R4,R3                                                            
*                                                                               
VBMT3    DS    0H                                                               
         LHI   R1,VBTBLTN          COUNT OF FIELDS                              
*                                                                               
VBMT4    DS    0H                  ROLL UP DOLLAR FIELDS                        
         L     RF,0(R2)                                                         
         A     RF,0(R4)                                                         
         ST    RF,0(R4)                                                         
         LA    R2,4(R2)                                                         
         LA    R4,4(R4)                                                         
         BCT   R1,VBMT4                                                         
*                                  R2 AND R4 NOW AT %,CODE,ETC                  
         OC    0(4,R4),0(R4)       DO WE ALREADY HAVE %                         
         BNZ   *+14                                                             
         MVC   0(4,R4),0(R2)       NO, JUST SET %                               
         B     VBMT7B                                                           
*                                                                               
         OC    0(4,R2),0(R2)    BUT DON'T OVERRIDE WITH NULLS (NO PST)          
         BZ    VBMT7B                                                           
         CLC   0(4,R4),0(R2)       ELSE, ARE THEY THE SAME                      
         BE    VBMT7B                                                           
         MVC   0(4,R4),=X'FFFFFFFF'  NO, SET MIXED (SHOULDNT HAPPEN??)          
*                                                                               
VBMT7B   DS    0H                                                               
         CLI   4(R4),0             DO WE ALREADY HAVE CODE                      
         BNE   *+14                                                             
         MVC   4(1,R4),4(R2)       NO, JUST SET %                               
         B     VBMT7F                                                           
*                                                                               
         CLI   4(R2),0        BUT DON'T OVERRIDE WITH NULLS (NO PST)            
         BE    VBMT7F                                                           
         CLC   4(1,R4),4(R2)       ELSE, ARE THEY THE SAME                      
         BE    VBMT7F                                                           
         MVI   4(R4),X'FF'         NO, SET MIXED (SHOULDNT HAPPEN??)            
*                                                                               
VBMT7F   DS    0H                                                               
         LA    R2,VBTABL-(VBTBLTN*4)(R2)          BUMP PAST %, ETC.             
         LA    R4,VBTABL-(VBTBLTN*4)(R4)                                        
         BCT   R0,VBMT3                                                         
*                                                                               
         BCT   R5,VBMT2            NEXT MONTH  (NOTE- R2                        
*                                  AUTOMATICALLY POSITIONED)                    
         XIT1                                                                   
         DROP  R2                                                               
         DROP  R9                                                               
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*                                                                               
*        VBROLL   ROLL-UP VBTAB                                                 
*                                                                               
*        PARM1  BYTE  0   NOT USED                                              
*               BYTES 1-3 A(BRKTAB ENTRY)                                       
*                                                                               
***********************************************************************         
         SPACE 2                                                                
         PRINT NOGEN                                                            
VBROLL   NMOD1 VBAWRKL,VBROLL                                                   
         LR    R9,RC                                                            
         USING VBAWRKD,R9                                                       
         ICM   R3,15,0(R1)                                                      
         ST    R3,VBABRK           SAVE A(BREAK TABLE ENTRY)                    
         MVC   VBABRKC,BRKCODE-BRKTABD(R3)  BRKTAB ENTRY                        
         LA    RC,SPACEND                                                       
         ST    R1,VBASVR1                                                       
         SPACE 2                                                                
*                                                                               
         L     R2,VBABRKC          R2 IS THIS LEVEL                             
         L     R2,ATOTSV(R2)                                                    
         LR    R3,R2                                                            
         AHI   R3,VTOTSIZE         R3 IS NEXT LEVEL                             
*                                                                               
         USING VBTABD,R2                                                        
         LHI   R4,(NPROVS+1)*(MAXMOS+1)                                         
*                                                                               
VBR4     DS    0H                                                               
         LHI   R5,VBTBLTN          COUNT OF FIELDS                              
*                                                                               
VBR6     DS    0H                                                               
         L     RF,0(R2)                                                         
         A     RF,0(R3)                                                         
         ST    RF,0(R3)                                                         
         XC    0(4,R2),0(R2)       CLEAR OLD                                    
         LA    R2,4(R2)                                                         
         LA    R3,4(R3)                                                         
         BCT   R5,VBR6             NEXT FIELD ENTRY                             
*                                  NOW POINTED AT % AND CODE                    
         OC    0(4,R3),0(R3)       DO WE ALREADY HAVE %                         
         BNZ   *+14                                                             
         MVC   0(4,R3),0(R2)       NO, JUST SET %                               
         B     VBR7B                                                            
*                                                                               
         OC    0(4,R2),0(R2)    BUT DON'T OVERRIDE WITH NULLS (NO PST)          
         BZ    VBR7B                                                            
         CLC   0(4,R3),0(R2)       ELSE, ARE THEY THE SAME                      
         BE    VBR7B                                                            
         MVC   0(4,R3),=X'FFFFFFFF'  NO, SET MIXED (SHOULDNT HAPPEN??)          
*                                                                               
VBR7B    DS    0H                                                               
         CLI   4(R3),0             DO WE ALREADY HAVE CODE                      
         BNE   *+14                                                             
         MVC   4(1,R3),4(R2)       NO, JUST SET %                               
         B     VBR7F                                                            
*                                                                               
         CLI   4(R2),0        BUT DON'T OVERRIDE WITH NULLS (NO PST)            
         BE    VBR7F                                                            
         CLC   4(1,R3),4(R2)       ELSE, ARE THEY THE SAME                      
         BE    VBR7F                                                            
         MVI   4(R3),X'FF'         NO, SET MIXED (SHOULDNT HAPPEN??)            
*                                                                               
VBR7F    DS    0H                                                               
         XC    0(VBTABL-(VBTBLTN*4),(R2)),0(R2)          CLEAR OLD              
         LA    R2,VBTABL-(VBTBLTN*4)(R2)          BUMP PAST %, ETC.             
         LA    R3,VBTABL-(VBTBLTN*4)(R3)                                        
         BCT   R4,VBR4             NEXT PROVINCE/MONTH                          
*                                                                               
         MVC   VBAMODE,=C'RU'       VBCALC MODE - ROLLUP                        
         L     RF,VBABRK           POINT TO NEXT LEVEL FOR TRACE DESC           
         SHI   RF,BRKL                                                          
         MVC   VBABRKC,0(RF)                                                    
         GOTOR VBATRC,VBADMCB,(R9)                                              
*                                                                               
         J     XIT                                                              
         DROP  R2                                                               
         DROP  R9                                                               
*                                                                               
         LTORG                                                                  
         TITLE 'SPB12E - SPOT BILLING/SOURCE BOOK E'                            
***********************************************************************         
*                                                                               
*        CONTAINS VARIOUS MODULES FOR BILLING EDI.                              
*                                                                               
***********************************************************************         
         SPACE 2                                                                
BILLEDI  NMOD1 0,**EDI***,R5                                                    
         LA    RC,SPACEND                                                       
         L     R9,=A(COMSUBS)      COMMON AREA                                  
         USING COMSUBS,R9                                                       
         LA    R7,BREC                                                          
         USING BILLEDID,R7                                                      
         LA    R6,TSARB                                                         
         USING TSARD,R6                                                         
*                                                                               
         MVC   EDPARMS(24),0(R1)   AND PARMS                                    
         MVC   EDMODE,0(R1)        MODE IS HOB OF PARM1                         
*                                                                               
         CLI   DUESW,C'R'          DON'T PROCESS AOR                            
         BE    XIT                                                              
         CLI   DUESW,C'A'          SEP ADJ BILLS ARE OK                         
         BE    *+12                                                             
         CLI   PASSNO,1            DON'T PROCESS DETAIL BACKUP                  
         BH    XIT                                                              
*                                                                               
         CLI   FRSTSW,0                                                         
         BNE   *+8                                                              
         BAS   RE,INIT                                                          
*                                                                               
         BAS   RE,SETGN            SET GROSS/NET CTL                            
         LA    RF,MODLIST          FIND MODE                                    
         LHI   R0,MODLISTN                                                      
*                                                                               
MP04     DS    0H                                                               
         CLC   EDMODE,0(RF)                                                     
         BE    *+14                                                             
         LA    RF,5(RF)                                                         
         BCT   R0,MP04                                                          
         DC    H'0'                                                             
*                                                                               
         ICM   RF,15,1(RF)                                                      
         BASR  RE,RF                                                            
*                                                                               
         B     XIT                                                              
         EJECT                                                                  
**********************************************************************          
*        INITIALIZATION                                                         
**********************************************************************          
*                                                                               
INIT     NTR1                                                                   
         CLI   EDMODE,EDMCLS       IF CLOSING, NO INIT                          
         BE    INITX                                                            
         MVI   FRSTSW,1                                                         
*                                                                               
*              NOTE- IF WORKER FILES USED, THEY ARE OPENED AT MMFHDR            
*                                                                               
         CLI   OUTMODE,C'D'        DATASET OUTPUT                               
         BNE   INIT4                                                            
*                                                                               
         OPEN  (EDIOUT,OUTPUT)                                                  
*                                                                               
INIT4    DS    0H                                                               
         L     R0,=A(BESIZE)                                                    
         GETMAIN RU,LV=(0),LOC=(ANY,ANY)                                        
         LTR   R1,R1                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         ST    R1,TSABUF                                                        
*                                                                               
         MVC   TSACOM,ACOMFACS                                                  
         MVI   TSKEYL,BEKLN                                                     
         OI    TSRECI,TSRVAR       SET FOR VARIABLE RECS                        
         MVC   TSRECL,=Y(BERECL)                                                
         MVI   TSOFFACT,TSAINI                                                  
         MVC   TSAREC,=A(BESIZE)                                                
         GOTO1 ATSAROFF,(R6)                                                    
         CLI   TSERRS,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LA    RF,BREC             SET ADDR'S OF REC AREAS                      
         ST    RF,ABREC                                                         
         LA    RF,ABREC+L'ABREC                                                 
         LA    RF,FREC                                                          
         ST    RF,AFREC                                                         
         LA    RF,4(RF)                                                         
         ST    RF,AFRECP4          REC+4 IS START OF DATA                       
         LA    RF,FREC+L'FREC                                                   
         ST    RF,AFRECX                                                        
*                                                                               
INITX    DS    0H                                                               
         B     XIT                                                              
         EJECT                                                                  
**********************************************************************          
*        PRODUCT GROUP                                                          
**********************************************************************          
*                                                                               
EDPGR    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEPGRLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDPGRQ       RECORD TYPE                                  
*                                                                               
         C     R3,APGR3BRK                                                      
         BNE   EDPGR4                                                           
         MVI   BEPGRL,C'3'                                                      
         MVC   BEPGRC,PGR3                                                      
         MVC   BEPGRD,PGR3BK                                                    
         MVC   BEPGRN,PGR3NM                                                    
         BAS   RE,EDPUT                                                         
         B     EDPGRX                                                           
*                                                                               
EDPGR4   DS    0H                                                               
         C     R3,APGR2BRK                                                      
         BNE   EDPGR6                                                           
         MVI   BEPGRL,C'2'                                                      
         MVC   BEPGRC,PGR2                                                      
         MVC   BEPGRD,PGR2BK                                                    
         MVC   BEPGRN,PGR2NM                                                    
         BAS   RE,EDPUT                                                         
         B     EDPGRX                                                           
*                                                                               
EDPGR6   DS    0H                                                               
         MVI   BEPGRL,C'1'                                                      
         MVC   BEPGRC,PGR1                                                      
         MVC   BEPGRD,PGR1BK                                                    
         MVC   BEPGRN,PGR1NM                                                    
         BAS   RE,EDPUT                                                         
*                                                                               
EDPGRX   DS    0H                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        PRODUCT                                                                
**********************************************************************          
*                                                                               
EDPRD    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEPRDLN)   PRODUCT RECORD                            
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDPRDQ       RECORD CODE                                  
         MVC   BEPRD,PRD                                                        
         MVC   BEPRDN,PRDNM                                                     
         OC    BEPRDN,SPACES                                                    
*                                                                               
         L     RF,ADPRD            PRD NUMBER                                   
         LA    RF,PACCT-PRDHDR(RF)                                              
         MVC   BEPRICD(4),0(RF)                                                 
         CLI   0(RF),X'FF'                                                      
         BNE   EDPRD4                                                           
         ZAP   DUB,1(3,RF)                                                      
         OI    DUB+7,X'0F'                                                      
         UNPK  BEPRICD,DUB                                                      
*                                                                               
EDPRD4   DS    0H                                                               
         OC    BEPRICD,SPACES                                                   
         BAS   RE,EDPUT                                                         
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        ESTIMATE                                                               
**********************************************************************          
*                                                                               
EDEST    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEESTLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDESTQ                                                    
         MVC   BEEST,EST                                                        
         MVC   BEESTN,ESTNM                                                     
         OC    BEESTN,SPACES                                                    
         BAS   RE,EDPUT                                                         
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        MARKET GROUP                                                           
**********************************************************************          
*                                                                               
EDMGR    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEMGRLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDMGRQ       RECORD TYPE                                  
*                                                                               
         C     R3,AMGR3BRK                                                      
         BNE   EDMGR4                                                           
         MVI   BEMGRL,C'3'                                                      
         MVC   BEMGRC,MGR3                                                      
         MVC   BEMGRD,MGR3BK                                                    
         MVC   BEMGRN,MGR3NM                                                    
         BAS   RE,EDPUT                                                         
         B     EDMGRX                                                           
*                                                                               
EDMGR4   DS    0H                                                               
         C     R3,AMGR2BRK                                                      
         BNE   EDMGR6                                                           
         MVI   BEMGRL,C'2'                                                      
         MVC   BEMGRC,MGR2                                                      
         MVC   BEMGRD,MGR2BK                                                    
         MVC   BEMGRN,MGR2NM                                                    
         BAS   RE,EDPUT                                                         
         B     EDMGRX                                                           
*                                                                               
EDMGR6   DS    0H                                                               
         MVI   BEMGRL,C'2'                                                      
         MVC   BEMGRC,MGR1                                                      
         MVC   BEMGRD,MGR1BK                                                    
         MVC   BEMGRN,MGR1NM                                                    
         BAS   RE,EDPUT                                                         
*                                                                               
EDMGRX   DS    0H                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        MARKET                                                                 
**********************************************************************          
*                                                                               
EDMKT    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEMKTLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDMKTQ       RECORD TYPE                                  
         MVC   BEMKT,MKT                                                        
         MVC   BEMKTN,MKTNM                                                     
         OC    MKTNM,SPACES                                                     
         BAS   RE,EDPUT                                                         
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        STATION                                                                
**********************************************************************          
*                                                                               
EDSTA    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BESTALN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDSTAQ       RECORD TYPE                                  
         MVC   BESTA,BIGSTA                                                     
*              NOTE- STACITY MAY CONTAIN DIFFERENT THINGS                       
         CLI   BIGSTA+4,C'/'       CABLE HEAD                                   
         BNE   *+14                                                             
         MVC   BESTCTY,STACITY                                                  
         B     EDSTA99                                                          
*                                                                               
         CLI   RETPROF+13,C'Y'   STATION CITY OPTION                            
         BNE   *+14                                                             
         MVC   BESTCTY,STACITY                                                  
         B     EDSTA99                                                          
*                                                                               
         CLI   AFFOPT,C'Y'         AFFILIATE OPTION                             
         BNE   *+14                                                             
         MVC   BESTAFF,STACITY     IN STACITY                                   
         B     EDSTA99                                                          
*                                                                               
EDSTA99  DS    0H                                                               
         BAS   RE,EDPUT                                                         
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        MONTHLY TOTAL AMOUNTS                                                  
**********************************************************************          
*                                                                               
EDMTA    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEDETLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDMTAQ                                                    
*                                                                               
         L     R3,SAVBRK           BREAK TABLE ENTRY                            
         MVC   BEDLEV,3(R3)        BREAK LEVEL CODE                             
         C     R3,AINVBRK          IF AND END OF INVOICE                        
         BNE   *+8                                                              
         MVI   BEDLEV,X'FF'        SAY SO                                       
*                                                                               
         CLI   BEDLEV,X'28'        IF CANADIAN NETWORK, SAVE IT                 
         BNE   EDMTA7                                                           
         L     RF,ANET             PUT CANADIAN NET NAME                        
         MVC   WORK+2(3),0(RF)                                                  
         GOTO1 MSUNPK,DMCB,WORK,FULL,BEDNET                                     
*                                                                               
EDMTA7   L     R3,PERLIND          PERIOD (PERLIST INDEX)                       
         LA    R3,PERLIST(R3)                                                   
         USING PERLISTD,R3                                                      
*                                                                               
         CLI   0(R3),X'FF'                                                      
         BNE   *+14                                                             
         MVC   BEDMOS(5),=C'TOTAL'                                              
         B     EDMTA14                                                          
*                                                                               
         CLI   SPOTPROF+2,0        TEST CALENDAR TYPE                           
         BNE   EDMTA13                                                          
         GOTO1 DATCON,DMCB,(3,PERLMOS),(6,BEDMOS)  NORMAL MMMYY                 
         B     EDMTA14                                                          
*                                                                               
EDMTA13  DS    0H                                                               
         GOTO1 DATCON,DMCB,(2,PERLSTRT),(5,BEDMOS) OTHER MMMDD/YY               
         DROP  R3                                                               
*                                                                               
EDMTA14  DS    0H                                                               
         MVI   BEDTYP,C'T'         T=TIME COSTS                                 
*                                                                               
         L     RF,EDPARMS                                                       
         MVC   BEDPINV,0(RF)                                                    
*                                                                               
         TM    GNCTL,X'80'         GROSS                                        
         BZ    EDMTA16                                                          
         EDIT  (B4,0(R2)),BEDOGRS,FLOAT=-,ALIGN=LEFT,ZERO=NOBLANK               
         EDIT  (B4,ROWHL+0(R2)),BEDPGRS,FLOAT=-,ALIGN=LEFT,ZERO=NOBLANK         
*                                                                               
EDMTA16  DS    0H                                                               
         TM    GNCTL,X'40'         NET                                          
         BZ    EDMTA18                                                          
         EDIT  (B4,8(R2)),BEDONET,FLOAT=-,ALIGN=LEFT,ZERO=NOBLANK               
         EDIT  (B4,ROWHL+8(R2)),BEDPNET,FLOAT=-,ALIGN=LEFT,ZERO=NOBLANK         
*                                                                               
EDMTA18  DS    0H                                                               
         EDIT  (B4,16(R2)),BEDOTAX,FLOAT=-,ALIGN=LEFT,ZERO=NOBLANK              
         EDIT  (B4,ROWHL+16(R2)),BEDPTAX,FLOAT=-,ALIGN=LEFT,           +        
               ZERO=NOBLANK                                                     
         EDIT  (B4,24(R2)),BEDOSPTS,FLOAT=-,ALIGN=LEFT,ZERO=NOBLANK             
         EDIT  (B4,ROWHL+24(R2)),BEDPSPTS,FLOAT=-,ALIGN=LEFT,          +        
               ZERO=NOBLANK                                                     
*                                                                               
         BAS   RE,EDPUT                                                         
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        COMMENTS                                                               
**********************************************************************          
*                                                                               
EDCOM    NTR1                                                                   
         L     R4,ADCOMREC                                                      
         CLI   0(R4),0             TEST COMMENT PRESENT                         
         BE    EDCMX                                                            
*                                                                               
         LA    R4,24(R4)           FIRST ELEM                                   
*                                                                               
EDCM2    DS    0H                                                               
         CLI   0(R4),0             EOR                                          
         BE    EDCMX                                                            
         CLI   0(R4),5             COMMENT ELEM                                 
         BNE   EDCM4                                                            
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BECOMLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDCOMQ                                                    
*                                                                               
         L     R3,SAVBRK                                                        
         MVC   BECOMLEV,3(R3)      BREAK LEVEL CODE                             
         C     R3,AINVBRK          IF END OF INVOICE                            
         BNE   *+8                                                              
         MVI   BECOMLEV,X'FF'      SAY SO                                       
*                                                                               
         ZIC   RE,1(R4)            ELEM LENGTH                                  
         SHI   RE,3                SET FOR EX                                   
         BM    EDCM4                                                            
         EX    RE,*+8                                                           
         B     *+10                                                             
         CLC   2(0,R4),SPACES                                                   
         BNH   EDCM4               SKIP BLANK COMMENTS                          
         EX    RE,*+8              SET COMMENT TEXT                             
         B     *+10                                                             
         MVC   BECOMTXT(0),2(R4)                                                
         BAS   RE,EDPUT                                                         
*                                                                               
EDCM4    DS    0H                                                               
         ZIC   R0,1(R4)                                                         
         AR    R4,R0                                                            
         B     EDCM2                                                            
*                                                                               
EDCMX    DS    0H                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        BILLING HEADER                                                         
**********************************************************************          
*                                                                               
EDHDR    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVI   BEKRCLS,EDRSRTHQ    HEADER CLASS                                 
         MVI   BEKRCD,EDHDRQ                                                    
         L     RE,ADBILL                                                        
         SR    RF,RF                                                            
         ICM   RF,3,13(RE)                                                      
         STH   RF,BEREC            SET RECORD LENGTH                            
*******  BCTR  RE,0                                                             
*******  EX    RE,*+8                                                           
*******  B     *+10                                                             
*******  MVC   BEHDRC(0),0(RF)                                                  
         LR    R1,RF               LENGTH                                       
         LA    R0,BEHDRC                                                        
         MVCL  R0,RE                                                            
         BAS   RE,EDPUT                                                         
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        BILLING ADDRESS                                                        
**********************************************************************          
*                                                                               
EDADD    NTR1                                                                   
         TM    EDNEWSW,X'80'       TEST HAVE ALAREADY DONE ADDRESS              
         BNZ   EDADDX                                                           
         OI    EDNEWSW,X'80'                                                    
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEADDLN)                                             
         MVI   BEKRCLS,EDRSRTAQ    ADDRESS SORT GROUP                           
         MVI   BEKRCD,EDADDQ                                                    
         MVC   BEADDL1,HEAD7+46                                                 
         MVC   BEADDL2,HEAD8+46                                                 
         MVC   BEADDL3,HEAD9+46                                                 
         MVC   BEADDL4,HEAD10+46                                                
         MVC   BEADDL5,HEAD11+46                                                
*                                                                               
         BAS   RE,EDPUT                                                         
*                                                                               
EDADDX   DS    0H                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        USER DEFINITION FIELDS                                                 
**********************************************************************          
*                                                                               
EDUSR    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEUSRLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDUSRQ                                                    
*                                                                               
         L     RF,EDPARMS                                                       
         MVC   BEUSRTXT(2),0(RF)          P1,P2,E1,E2...                        
         MVC   BEUSRTXT+2(L'BEUSRTXT-2),X   USER  STUFF IN X                    
*                                  (MFUSR ROUTINE WILL SORT IT OUT)             
         BAS   RE,EDPUT                                                         
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        USER COMMENT FIELDS                                                    
**********************************************************************          
*                                                                               
EDUCM    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEUCMLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDUCMQ                                                    
*                                                                               
         L     RF,EDPARMS                                                       
         MVC   BEUCMTXT(2),0(RF)          P1,P2,E1,E2,M1,M2...                  
         MVC   BEUCMTXT+2(L'BEUCMTXT-2),X   USER  STUFF IN X                    
*                                  (MFUCM ROUTINE WILL SORT IT OUT)             
         BAS   RE,EDPUT                                                         
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        LIST OF PREVIOUS BILLS                                                 
*        CALLED IN PRTADJ AND ADJINV                                            
**********************************************************************          
*                                                                               
EDLST    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BDLSTLN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDLSTQ                                                    
*                                                                               
         L     RF,EDPARMS                                                       
         MVC   BDLSTIN,0(RF)    INVOICE NUMBER                                  
*                                                                               
         TM    GNCTL,X'80'         GROSS NEEDED?                                
         BZ    EDLST4                                                           
         L     RF,EDPARMS+4                                                     
         EDIT  (B4,0(RF)),BDLSTG,FLOAT=-,ALIGN=LEFT   GROSS                     
*                                                                               
EDLST4   DS    0H                                                               
         TM    GNCTL,X'40'         NET                                          
         BZ    EDLST6                                                           
         L     RF,EDPARMS+8                                                     
         EDIT  (B4,0(RF)),BDLSTN,FLOAT=-,ALIGN=LEFT   NET                       
*                                                                               
EDLST6   DS    0H                                                               
         BAS   RE,EDPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        AMOUNT DUE                                                             
*          P1=A(FORMULA)                                                        
*          P2=A(TOTAL)                                                          
*          P3=INDEX TO CURRENCY (0=AGENCY, 4=CLIENT)                            
*                                                                               
*        CALLED IN PADJINV AND ADJINV                                           
**********************************************************************          
*                                                                               
EDDUE    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BDUELN)                                              
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDDUEQ                                                    
*                                                                               
         L     R3,SAVBRK                                                        
         MVC   BDULEV,3(R3)        BREAK LEVEL CODE                             
         C     R3,AINVBRK          IF END OF INVOICE                            
         BNE   *+8                                                              
         MVI   BDULEV,X'FF'        SAY SO                                       
*                                                                               
         L     R4,EDPARMS          A(BFORM)                                     
         USING BFORMD,R4                                                        
         MVI   BDUBB,C'G'          BILL BASIS - GROSS                           
         TM    BFBAS,X'10'                                                      
         BNO   EDD4                                                             
         MVI   BDUBB,C'N'          NET                                          
         CLI   BFBAS,X'FF'                                                      
         BNE   EDD4                                                             
         MVI   BDUBB,C'M'          MIXED                                        
*                                                                               
EDD4     DS    0H                  COMMISSION BASIS                             
         MVI   BDUCB,C'G'          GROSS                                        
         TM    BFBAS,X'01'                                                      
         BNO   EDD6                                                             
         MVI   BDUCB,C'N'          NET                                          
         CLI   BFBAS,X'FF'                                                      
         BNE   EDD6                                                             
         MVI   BDUCB,C'M'          MIXED                                        
*                                                                               
EDD6     DS    0H                                                               
         CLC   BFCOMP,=X'FFFFFFFF' MIXED %'S                                    
         BE    EDD8                                                             
         EDIT  BFCOMP,BDUCP,FLOAT=-,ALIGN=LEFT                                  
*                                                                               
EDD8     DS    0H                                                               
         L     R3,EDPARMS+4        A(TOTALS)                                    
         A     R3,EDPARMS+8        CURRENCY INDEX                               
*                                                                               
         CLI   ADJSEP,C'Y'         SEP ADJUSTMENT?                              
         BE    EDD10                                                            
*                                  NO, NORMAL AMOUNTS                           
         L     RE,DUEDSP(R3)       AMOUNT DUE                                   
         S     RE,ADJDSP(R3)       LESS ADJUSTMENT = BASIS AMOUNT               
         EDIT  (RE),BDUBBA,FLOAT=-,ALIGN=LEFT                                   
*                                                                               
         L     RE,ADJDSP(R3)       ADJUSTMENT                                   
         EDIT  (RE),BDUCBA,FLOAT=-,ALIGN=LEFT                                   
*                                                                               
         L     RE,DUEDSP(R3)       AMOUNT DUE (MANDATORY)                       
         EDIT  (RE),BDUAMT,FLOAT=-,ALIGN=LEFT,ZERO=NOBLANK                      
         B     EDD20                                                            
*                                                                               
EDD10    DS    0H                  SEP ADJUSTMENT                               
         CLI   DUESW,C'A'          ACTUAL ADJUSTMENT BILL?                      
         BNE   EDD12                                                            
*                                  YES, SPECIAL AMOUNTS                         
         MVI   BDUBBA,C'0'         BASE IS $0??                                 
*                                                                               
         L     RE,ADJDSP(R3)       ADJUSTMENT                                   
         EDIT  (RE),BDUCBA,FLOAT=-,ALIGN=LEFT                                   
*                                                                               
         MVC   BDUAMT,BDUCBA       ADJUSTMENT IS AMOUNT DUE                     
*                                                                               
         B     EDD20                                                            
*                                                                               
EDD12    DS    0H                  BASE BILL IN SEP ADJ SITUATION               
         L     RE,DUEDSP(R3)       AMOUNT DUE                                   
         S     RE,ADJDSP(R3)       LESS ADJUSTMENT = BASIS AMOUNT               
         EDIT  (RE),BDUBBA,FLOAT=-,ALIGN=LEFT                                   
*                                                                               
         MVI   BDUCBA,C'0'         ADJUSTMENT IS $0.                            
*                                                                               
         MVC   BDUAMT,BDUBBA       DUE IS BASE AMOUNT                           
*                                                                               
EDD20    DS    0H                                                               
         BAS   RE,EDPUT                                                         
         B     XIT                                                              
         DROP  R4                                                               
         SPACE 2                                                                
**********************************************************************          
*        CANADIAN TAXES - DATA WILL BE IN WK FIELDS                             
**********************************************************************          
EDCTAX   NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BCTXLN)                                              
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDCTAXQ                                                   
*                                                                               
W@       USING ECTAXD,WK                                                        
         MVC   BCTXT,W@.ECTAXT     TYPE                                         
         MVC   BCTXA,W@.ECTAXA     ACCOUNT NUMBER                               
         CLC   W@.ECTAXP,=X'FFFFFFFF'      MIXED %                              
         BE    EDCX8                                                            
         EDIT  (B4,W@.ECTAXP),(11,BCTXP),FLOAT=-,ALIGN=LEFT                     
*                                                                               
EDCX8    DS    0H                                                               
         EDIT  (B4,W@.ECTAXB),(11,BCTXB),FLOAT=-,ALIGN=LEFT                     
         EDIT  (B4,W@.ECTAX),(11,BCTXTAX),FLOAT=-,ALIGN=LEFT                    
*                                                                               
         BAS   RE,EDPUT                                                         
         B     XIT                                                              
         DROP  W@                                                               
         SPACE 2                                                                
**********************************************************************          
*        TOTAL AMOUNT DUE INCLUDING CANADIAN TAXES                              
*        ONLY PRESENT WHEN CANADIAN TAXES ARE                                   
**********************************************************************          
*                                                                               
EDTDUE   NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BTDUELN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDTDUEQ      RECORD TYPE                                  
         EDIT  (B4,FULL),(11,BTDUAMT),FLOAT=-,ALIGN=LEFT                        
         BAS   RE,EDPUT                                                         
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
**********************************************************************          
*        REMITTANCE ADDRESS                                                     
**********************************************************************          
*                                                                               
EDRMA    NTR1                                                                   
         MVC   BEREC(2),=Y(BERMALN)                                             
         MVI   BEKRCLS,EDRSRTMQ    MAIN SORT GROUP                              
         MVI   BEKRCD,EDRMAQ                                                    
         L     R4,ADSTATAD                                                      
         USING ADDRREC,R4                                                       
         MVC   BERMNAM,ANAME                                                    
         MVC   BERMADR,A1LINE                                                   
         MVC   BERMCTY,A2LINE                                                   
         MVC   BERMSTA,A3LINE                                                   
         MVC   BERMZIP,ABIGZIP                                                  
*                                                                               
         OC    BERMNAM,SPACES                                                   
         OC    BERMADR,SPACES                                                   
         OC    BERMCTY,SPACES                                                   
         OC    BERMSTA,SPACES                                                   
         OC    BERMZIP,SPACES                                                   
*                                                                               
         BAS   RE,EDPUT                                                         
         DROP  R4                                                               
*                                                                               
         B     XIT                                                              
         EJECT                                                                  
**********************************************************************          
*        END OF INVOICE                                                         
**********************************************************************          
*                                                                               
EDEND    NTR1                                                                   
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BECLTLN)   CLIENT RECORD                             
         MVI   BEKRCLS,EDRSRTHQ    HEADER CLASS                                 
         MVI   BEKRCD,EDADVQ                                                    
         MVC   BECLT,CLT                                                        
         MVC   BECLTN,CLTNM                                                     
         OC    BECLTN,SPACES                                                    
         L     RF,ADCLT                                                         
         MVC   BECLTICD,CCLTIFC-CLTHDR(RF)                                      
         OC    BECLTICD,SPACES                                                  
         BAS   RE,EDPUT                                                         
*                                                                               
         XC    BEKEY,BEKEY                                                      
         MVC   BEREC(2),=Y(BEAGMLN)    AGENCY/MEDIA RECORD                      
         MVI   BEKRCLS,EDRSRTHQ    HEADER CLASS                                 
         MVI   BEKRCD,EDAGMQ                                                    
         MVI   BEAGSYS,C'S'            SYSTEM                                   
         MVC   BEAGSPMD,MEDIA          MEDIA                                    
         MVC   BEAGMMN,MEDNM           MEDIA NAME                               
         MVC   BEAGMAN,AGYNM           AGENCY NAME                              
         MVC   BEAGMAD,AGYADR          AGENCY ADDRESS                           
         BAS   RE,EDPUT                                                         
*                                  AT END OF INVOICE                            
         BAS   RE,EDTRC            TRACE                                        
*                                                                               
         GOTOR MAKEFILE,DMCB,SPACEND   CREATE OUTPUT FILE                       
*                                                                               
         MVC   TSACOM,ACOMFACS                                                  
         MVI   TSKEYL,BEKLN                                                     
         OI    TSRECI,TSRVAR       SET FOR VARIABLE RECS                        
         MVC   TSRECL,=Y(BERECL)                                                
         MVI   TSOFFACT,TSAINI     RE-INITIALIZE TSAROFF                        
         MVC   TSAREC,=A(BESIZE)                                                
         GOTO1 ATSAROFF,(R6)                                                    
         CLI   TSERRS,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         MVI   EDNEWSW,X'00'       CLEAR ED ROUTINES NEWSW                      
         B     XIT                                                              
         EJECT                                                                  
**********************************************************************          
*        CLOSE                                                                  
**********************************************************************          
*                                                                               
EDCLS    NTR1                                                                   
         CLI   FRSTSW,0            TEST EDI OPEN                                
         BE    ECLX                                                             
         CLI   OUTMODE,C'D'        DATASET OUTPUT                               
         BNE   EDCLS8                                                           
*                                                                               
         CLOSE EDIOUT                                                           
*                                TRACE OUTPUT FILE                              
         L     RF,APATCH                                                        
         TM    0(RF),X'04'         TEST NEED FINAL TRACE                        
         BZ    ECLX                                                             
*                                                                               
         MVI   FORCEHED,C'Y'                                                    
*                                                                               
         OPEN  (EDITRC,INPUT)                                                   
*                                                                               
EDCLS2   DS    0H                                                               
         BAS   RE,CLRFREC                                                       
         LA    R2,EDITRC                                                        
         GET   (R2),FREC                                                        
         MVC   P(132),FREC                                                      
         MVI   SKIPSPEC,C'Y'                                                    
         BRAS  RE,PRNT                                                          
         B     EDCLS2                                                           
*                                  CLOSE FOR WORKER FILE                        
EDCLS8   DS    0H                                                               
         GOTO1 DATAMGR,DMCB,=C'CLOSE',WRKRFIL,0,FREC,AWRKBUFF                   
*                                NO TRACE OF OUTPUT FILE                        
         B     XIT                                                              
*                                                                               
EDTRCEOF DS    0H                                                               
         CLOSE EDITRC                                                           
*                                                                               
ECLX     DS    0H                                                               
         B     XIT                                                              
*                                                                               
         LTORG                                                                  
         SPACE 2                                                                
         DROP  R5                                                               
         EJECT                                                                  
**********************************************************************          
*        MAKEFILE - CREATE OUTPUT FILE FROM TSAR BUFFER                         
**********************************************************************          
*                                                                               
MAKEFILE NMOD1 0,**MKF***                                                       
         LA    RC,SPACEND                                                       
*                                  READ THRU TSAR BUFFER                        
         ST    R7,TSAREC                                                        
         XC    BREC(BEKLN+2),BREC  CLEAR KEY PLUS LENGTH                        
         MVI   TSOFFACT,TSARDH                                                  
         B     MKF4B                                                            
*                                                                               
MKF4     DS    0H                                                               
         MVI   TSOFFACT,TSANXT                                                  
*                                                                               
MKF4B    DS    0H                                                               
         GOTO1 ATSAROFF,(R6)                                                    
         TM    TSERRS,TSEEOF                                                    
         BO    MKF20                                                            
         TM    TSERRS,X'FF'-TSERNF (RECORD NOT FOUND IS OK)                     
         BZ    *+6                                                              
         DC    H'0'                NO OTHER ERROR IS ACCEPTABLE                 
*                                                                               
         L     RF,APATCH                                                        
         TM    1(RF),X'80'         TRACE RECORDS RETURNED FROM TSAROFF?         
         BZ    MKF4E                                                            
         SR    R0,R0                                                            
         ICM   R0,3,BREC           RECORD LENGTH                                
         GOTO1 PRNTBL,DMCB,=C'TSAGET',BREC,C'DUMP',(R0),=C'1D'                  
MKF4E    DS    0H                                                               
*                                                                               
*                                  FIND ROUTINE                                 
         LA    RF,MKFROUTS                                                      
         LHI   R0,MKFRTSN                                                       
*                                                                               
MKF5     DS    0H                                                               
         CLC   BREC+5(1),0(RF)                                                  
         BE    *+14                                                             
         LA    RF,5(RF)                                                         
         BCT   R0,MKF5                                                          
         DC    H'0'                                                             
*                                                                               
         ICM   RF,15,1(RF)                                                      
         BASR  RE,RF                                                            
         B     MKF4                NEXT TSAR RECORD                             
*                                                                               
MKF20    DS    0H                                                               
         MVI   MFNEWSW,0             CLEAR NEWSW BITS                           
*                                                                               
         B     XIT                                                              
         EJECT                                                                  
***********************************************************************         
*        MFHDR - INVOICE HEADER                                                 
***********************************************************************         
*                                                                               
MFHDR    NTR1                                                                   
         TM    MFNEWSW,X'80'         NEW INVOICE?                               
         BO    MFHDR4                                                           
         OI    MFNEWSW,X'80'                                                    
*                                  YES, START NEW RECORD                        
         CLI   OUTMODE,C'W'        FOR WORKER FILES DO OPEN                     
         BNE   MFHDR08                                                          
*                                                                               
         L     R0,=A(WRKRBUFF)                                                  
         ST    R0,AWRKBUFF                                                      
         L     R1,=A(WRKRBEND-WRKRBUFF)                                         
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         MVCL  R0,RE                                                            
*                                                                               
         XC    WRKRIND,WRKRIND                                                  
         LA    R4,FREC                                                          
         USING WLHDRD,R4                                                        
         XC    WLHDRD(WLSOFEND-WLHDRD),WLHDRD                                   
         MVC   WLUSRID,RCORIGID    USER ID                                      
         MVC   WLSYSPRG(1),MED     MEDIA                                        
         MVC   WLSYSPRG+1(3),CLT   CLIENT                                       
         CLI   CLT+2,C' '          SPACE TO DOT                                 
         BH    *+8                                                              
         MVI   WLSYSPRG+3,C'.'                                                  
         MVI   WLDAY,X'97'         EDI BILLING IDENTIFIER                       
         MVI   WLCLASS,C'S'        SYSTEM = SPOT                                
*                                                                               
         MVC   WLAGELD,TODAYP                                                   
         MVI   WLUDATA,X'FF'                                                    
         MVC   WLAGELT,=X'FFFF'                                                 
         MVC   WLRETNL,=H'17520'   2 YEARS                                      
*        MVC   WLRETND,=X'FFFF'                                                 
*                                                                               
         MVC   WLDESC(10),PINVNO   COMMENT                                      
         DROP  R4                                                               
*                                                                               
         GOTO1 DATAMGR,DMCB,(0,=C'GFILE'),=C'WRKFIL',                  +        
               WRKRIND,FREC,AWRKBUFF                                            
         LA    R1,WRKRIND                                                       
         USING UKRECD,R1                                                        
         MVC   WRKRFIL,UKUSRINF                                                 
         DROP  R1                                                               
*                                                                               
         GOTO1 DATAMGR,DMCB,=C'OPEN',WRKRFIL,0,FREC,AWRKBUFF                    
         CLI   DMCB+8,0                                                         
         BE    MFHDR08                                                          
         CLI   DMCB+8,X'40'                                                     
         BE    *+6                                                              
         DC    H'0'                                                             
         USING MASTD,RF                                                         
         MVI   MCDUMP,C'O'                                                      
         DROP  RF                                                               
         ESTAE 0                                                                
         ABEND 899,DUMP                                                         
*                                                                               
MFHDR08  DS    0H                                                               
         L     RF,ADCLT            FIRST PUT EDI CONTROLS                       
         MVC   FREC+4(45),SPACES                                                
         OC    PROFB1A+6(7),SPACES                                              
*                                                                               
         MVI   FREC+04,C'H'          HEADER RECORD                              
         MVC   FREC+05(03),PROFB1A+10  CLIENT FROM B1A PROFILE                  
         MVI   FREC+08,C'S'          SYSTEM=SPOT                                
         MVC   FREC+09(02),AGY       AGENCY                                     
         MVI   FREC+20,C'X'          STANDARD                                   
         MVC   FREC+21(4),PROFB1A+6  VERSION (3040,3050, ETC)                   
         MVC   FREC+25(03),=C'810'   DOCUMENT TYPE                              
         MVI   FREC+28,C'P'          PRODUCTION                                 
         CLI   PROOFSW,C'Y'                                                     
         BNE   *+8                                                              
         MVI   FREC+28,C'T'          OR TEST                                    
*                                                                               
         LA    RF,FREC+45+4        MFPUT WILL SET LENGTH                        
         ST    RF,ANXTPOS                                                       
         XC    FREC+2(2),FREC+2                                                 
*                                                                               
         BAS   RE,MFPUT                                                         
*                                  NOW DO INVOICE HEADER RECORD                 
         MVC   ANXTPOS,AFRECP4                                                  
         GOTO1 BLDREC,DMCB,(2,=C'IH')                                           
         GOTO1 BLDREC,DMCB,(10,PINVNO)                                          
         LA    R4,BEDATA                                                        
         USING BILLREC,R4                                                       
         GOTO1 DATCON,DMCB,BQDATE,(17,DUB)                                      
         GOTO1 BLDREC,DMCB,(8,DUB)                                              
         GOTO1 DATCON,DMCB,(3,BDUEDATE),(17,DUB)                                
         GOTO1 BLDREC,DMCB,(8,DUB)                                              
         MVI   WORK,C'A'           SEP ADJUSTMENT BILL                          
         TM    BILSTAT,BSTSADJQ                                                 
         BNZ   MFHDR3                                                           
         MVI   WORK,C'C'           SEP COMMISSION BILL                          
         TM    BILSTAT,BSTSCOMQ                                                 
         BNZ   MFHDR3                                                           
         MVI   WORK,C'N'           NORMAL BILL                                  
*                                                                               
MFHDR3   DS    0H                                                               
         GOTO1 BLDREC,DMCB,(1,WORK)                                             
         GOTO1 BLDREC,DMCB,(8,PSHPDTE) SHIP DATE                                
         DROP  R4                                                               
*                                                                               
         BAS   RE,MFPUT                                                         
*                                                                               
MFHDR4   DS    0H                                                               
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFAGM - AGENCY/MEDIA                                                   
***********************************************************************         
*                                                                               
MFAGM    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4          START NEW RECORD                        
         GOTO1 BLDREC,DMCB,(2,=C'AG')   AGENCY                                  
         GOTO1 BLDREC,DMCB,(33,BEAGMAN) NAME                                    
         GOTO1 BLDREC,DMCB,(33,BEAGMAD) ADDRESS                                 
         BAS   RE,MFPUT                                                         
*                                                                               
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'ME')    MEDIA                                  
         GOTO1 BLDREC,DMCB,(2,BEAGSYMD)  SYSTEM AND MEDIA CODE                  
         GOTO1 BLDREC,DMCB,(10,BEAGMMN)  MEDIA NAME                             
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFADV - ADVERTISER                                                     
***********************************************************************         
*                                                                               
MFADV    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'AV')                                           
         GOTO1 BLDREC,DMCB,(3,BECLT)    CODE                                    
         GOTO1 BLDREC,DMCB,(24,BECLTN)  NAME                                    
         GOTO1 BLDREC,DMCB,(8,BECLTICD) INTERFACE CODE                          
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFADD - BILLING ADDRESS                                                
***********************************************************************         
*                                                                               
MFADD    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'BT')                                           
         GOTO1 BLDREC,DMCB,(36,BEADDL1)                                         
         GOTO1 BLDREC,DMCB,(36,BEADDL2)                                         
         GOTO1 BLDREC,DMCB,(36,BEADDL3)                                         
         GOTO1 BLDREC,DMCB,(36,BEADDL4)                                         
         GOTO1 BLDREC,DMCB,(36,BEADDL5)                                         
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFPGR - PRODUCT GROUP                                                  
***********************************************************************         
*                                                                               
MFPGR    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         MVI   WORK,C'P'           PN IS PGR LEVEL N                            
         MVC   WORK+1(1),BEPGRL                                                 
         GOTO1 BLDREC,DMCB,(2,WORK)                                             
         GOTO1 BLDREC,DMCB,(05,BEPGRC)  CODE                                    
         GOTO1 BLDREC,DMCB,(12,BEPGRD)  DESC                                    
         GOTO1 BLDREC,DMCB,(24,BEPGRN)  NAME                                    
*                                                                               
         BAS   RE,MFPUT                                                         
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFPRD - PRODUCT                                                        
***********************************************************************         
*                                                                               
MFPRD    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'PR')                                           
         GOTO1 BLDREC,DMCB,(3,BEPRD)    CODE                                    
         GOTO1 BLDREC,DMCB,(24,BEPRDN)  NAME                                    
         GOTO1 BLDREC,DMCB,(8,BEPRICD)  INTERFACE CODE                          
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFEST - ESTIMATE                                                       
***********************************************************************         
*                                                                               
MFEST    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'ES')                                           
         GOTO1 BLDREC,DMCB,(3,BEEST)    CODE                                    
         GOTO1 BLDREC,DMCB,(24,BEESTN)  NAME                                    
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFMGR - MARKET GROUP                                                   
***********************************************************************         
*                                                                               
MFMGR    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         MVI   WORK,C'M'           MN IS MGR LEVEL N                            
         MVC   WORK+1(1),BEMGRL                                                 
         GOTO1 BLDREC,DMCB,(2,WORK)                                             
         GOTO1 BLDREC,DMCB,(05,BEMGRC)  CODE                                    
         GOTO1 BLDREC,DMCB,(12,BEMGRD)  DESC                                    
         GOTO1 BLDREC,DMCB,(24,BEMGRN)  NAME                                    
*                                                                               
         BAS   RE,MFPUT                                                         
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFMKT - MARKET                                                         
***********************************************************************         
*                                                                               
MFMKT    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'MK')                                           
         GOTO1 BLDREC,DMCB,(4,BEMKT)   CODE                                     
         GOTO1 BLDREC,DMCB,(24,BEMKTN) NAME                                     
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFSTA - STATION                                                        
***********************************************************************         
*                                                                               
MFSTA    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'ST')                                           
         GOTO1 BLDREC,DMCB,(9,BESTA)     CODE                                   
         GOTO1 BLDREC,DMCB,(24,BESTCTY)  CITY                                   
         GOTO1 BLDREC,DMCB,(9,BESTAFF)   AFFILIATE                              
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFUSR - USER DEF RECORDS                                               
***********************************************************************         
*                                                                               
MFUSR    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'UD')                                           
         GOTO1 BLDREC,DMCB,(2,BEUSRTXT)   DATA POSITION- P1,P2...               
*                                                                               
*              USER LINE IS 8 SPACES, DESC: NAME                                
*              (DESC CAN BE UP TO 20, NAME TO 32)                               
*                                                                               
         LA    R4,BEUSRTXT+10                                                   
         LHI   R0,22+1                                                          
*                                                                               
MFUSR04  DS    0H                                                               
         CLI   0(R4),C':'                                                       
         BE    *+16                                                             
         LA    R4,1(R4)                                                         
         BCT   R0,MFUSR04                                                       
         B     MFUSRX              SHOULD HAVE FOUND A :                        
*                                                                               
         LR    R2,R4               SAVE A(:)                                    
         LA    R0,BEUSRTXT+11                                                   
         SR    R4,R0             R4 = DESC LENGTH                               
*                                                                               
         MVC   X(20),SPACES                                                     
         EX    R4,*+8                                                           
         B     *+10                                                             
         MVC   X(0),BEUSRTXT+10                                                 
*                                                                               
         GOTO1 BLDREC,DMCB,(20,X)                                               
         GOTO1 BLDREC,DMCB,(32,2(R2))                                           
*                                                                               
         BAS   RE,MFPUT                                                         
*                                                                               
MFUSRX   DS    0H                                                               
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFUCM - USER COM RECORDS                                               
***********************************************************************         
*                                                                               
MFUCM    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'UC')                                           
         GOTO1 BLDREC,DMCB,(2,BEUCMTXT)   DATA POSITION- P1,P2...               
*                                                                               
*              USER LINE IS 8 SPACES, DESC: NAME                                
*              (DESC CAN BE UP TO 20, NAME TO 32)                               
*                                                                               
         LA    R4,BEUCMTXT+10                                                   
         LHI   R0,22+1                                                          
*                                                                               
MFUCM04  DS    0H                                                               
         CLI   0(R4),C':'                                                       
         BE    *+16                                                             
         LA    R4,1(R4)                                                         
         BCT   R0,MFUCM04                                                       
         B     MFUCMX              SHOULD HAVE FOUND A :                        
*                                                                               
         LR    R2,R4               SAVE A(:)                                    
         LA    R0,BEUCMTXT+11                                                   
         SR    R4,R0             R4 = DESC LENGTH                               
*                                                                               
         MVC   X(20),SPACES                                                     
         EX    R4,*+8                                                           
         B     *+10                                                             
         MVC   X(0),BEUCMTXT+10                                                 
*                                                                               
         GOTO1 BLDREC,DMCB,(20,X)                                               
         GOTO1 BLDREC,DMCB,(32,2(R2))                                           
*                                                                               
         BAS   RE,MFPUT                                                         
*                                                                               
MFUCMX   DS    0H                                                               
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFCOM - COMMENT LINE RECORD                                            
***********************************************************************         
*                                                                               
MFCOM    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'CM')                                           
*                                                                               
         LA    R2,LEVNAMS          GET LEVEL NAME                               
         LHI   R0,LEVNAMSN                                                      
*                                                                               
MFCOM4   DS    0H                                                               
         CLC   BECOMLEV,0(R2)                                                   
         BE    *+14                                                             
         LA    R2,5(R2)                                                         
         BCT   R0,MFCOM4                                                        
         DC    H'0'                                                             
*                                                                               
         GOTO1 BLDREC,DMCB,(4,1(R2)) LEVEL NAME                                 
*                                                                               
         GOTO1 BLDREC,DMCB,(132,BECOMTXT)                                       
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFDET - DETAIL                                                         
***********************************************************************         
*                                                                               
MFDET    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD MT (NT FOR CANADA)                
*                                                                               
         LA    R2,LEVNAMS          GET LEVEL NAME                               
         LHI   R0,LEVNAMSN                                                      
*                                                                               
MFDET4   DS    0H                                                               
         CLC   BEDLEV,0(R2)                                                     
         BE    *+14                                                             
         LA    R2,5(R2)                                                         
         BCT   R0,MFDET4                                                        
         DC    H'0'                                                             
*                                                                               
         CLC   =C'NET',1(R2)       IS THIS CANADIAN NETWORK ?                   
         BNE   MFDET15             IF YES, PUT IN NET NAME...                   
         GOTO1 BLDREC,DMCB,(2,=C'NT')                                           
         GOTO1 BLDREC,DMCB,(4,BEDNET)    ..IN STEAD OF  LEVEL NAME              
         B     MFDET20                                                          
MFDET15  GOTO1 BLDREC,DMCB,(2,=C'MT')                                           
         GOTO1 BLDREC,DMCB,(4,1(R2)) LEVEL NAME                                 
*                                                                               
*                                                                               
MFDET20  GOTO1 BLDREC,DMCB,(8,BEDMOS)                                           
         GOTO1 BLDREC,DMCB,(1,BEDTYP)                                           
         GOTO1 BLDREC,DMCB,(10,BEDPINV)                                         
*                                                                               
         GOTO1 BLDREC,DMCB,(11,BEDOGRS)                                         
         GOTO1 BLDREC,DMCB,(11,BEDONET)                                         
         GOTO1 BLDREC,DMCB,(11,BEDOTAX)                                         
         GOTO1 BLDREC,DMCB,(11,BEDOSPTS)                                        
         GOTO1 BLDREC,DMCB,(11,BEDPGRS)                                         
         GOTO1 BLDREC,DMCB,(11,BEDPNET)                                         
         GOTO1 BLDREC,DMCB,(11,BEDPTAX)                                         
         GOTO1 BLDREC,DMCB,(11,BEDPSPTS)                                        
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFRMA - REMITTANCE ADDRESS                                             
**********************************************************************          
*                                                                               
MFRMA    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'RA')                                           
         GOTO1 BLDREC,DMCB,(20,BERMNAM) NAME                                    
         GOTO1 BLDREC,DMCB,(24,BERMADR) ADDRESS                                 
         GOTO1 BLDREC,DMCB,(24,BERMCTY) CITY                                    
         GOTO1 BLDREC,DMCB,(03,BERMSTA) STATE                                   
         GOTO1 BLDREC,DMCB,(10,BERMZIP) ZIP                                     
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
*                                                                               
         SPACE 2                                                                
***********************************************************************         
*        MFLST - PREVIOUS BILL LIST                                             
**********************************************************************          
*                                                                               
MFLST    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'PI')                                           
         GOTO1 BLDREC,DMCB,(10,BDLSTIN) INVOICE NUMBER                          
         GOTO1 BLDREC,DMCB,(11,BDLSTG)  GROSS                                   
         GOTO1 BLDREC,DMCB,(11,BDLSTN)  NET                                     
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         SPACE 2                                                                
***********************************************************************         
*        MFDUE - FORMULA ADJUSTMENTS AND AMOUNT DUE                             
**********************************************************************          
*                                                                               
MFDUE    NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'AD')                                           
*                                                                               
         LA    R2,LEVNAMS          GET LEVEL NAME                               
         LHI   R0,LEVNAMSN                                                      
*                                                                               
MFDUE4   DS    0H                                                               
         CLC   BDULEV,0(R2)                                                     
         BE    *+14                                                             
         LA    R2,5(R2)                                                         
         BCT   R0,MFDUE4                                                        
         DC    H'0'                                                             
*                                                                               
         GOTO1 BLDREC,DMCB,(4,1(R2)) LEVEL NAME                                 
*                                                                               
         GOTO1 BLDREC,DMCB,(1,BDUBB) BILL BASIS (G,N,M)                         
         GOTO1 BLDREC,DMCB,(1,BDUCB) COMM ADJUST BASIS (G,N,M)                  
         GOTO1 BLDREC,DMCB,(7,BDUCP) COMM ADJUST % SNNVNNNN                     
         GOTO1 BLDREC,DMCB,(11,BDUBBA) BILL BASIS AMOUNT                        
         GOTO1 BLDREC,DMCB,(11,BDUCBA) COMM ADJST AMOUNT                        
         GOTO1 BLDREC,DMCB,(11,BDUAMT) AMOUNT DUE                               
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
*                                                                               
         LTORG                                                                  
         EJECT                                                                  
***********************************************************************         
*      MFCTAX - CANADIAN TAXES                                                  
**********************************************************************          
*                                                                               
MFCTAX   NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'CT')                                           
*                                                                               
         GOTO1 (RF),(R1),(7,BCTXT)   TAX TYPE                                   
         GOTO1 (RF),(R1),(16,BCTXA)  ACCOUNT NUMBER                             
         GOTO1 (RF),(R1),(11,BCTXP)  PERCENT                                    
         GOTO1 (RF),(R1),(11,BCTXB)  BASIS AMOUNT                               
         GOTO1 (RF),(R1),(11,BCTXTAX)  TAX AMOUNT                               
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
***********************************************************************         
*        MFTDUE - TOTAL AMOUNT DUE (INCLUDING CANADIAN TAXES)                   
*        ONLY PRESENT WHEN CANADIAN TAXES ARE                                   
**********************************************************************          
*                                                                               
MFTDUE   NTR1                                                                   
         MVC   ANXTPOS,AFRECP4     NEW RECORD                                   
         GOTO1 BLDREC,DMCB,(2,=C'TD')                                           
*                                                                               
         GOTO1 (RF),(R1),(11,BTDUAMT)  TOTAL AMOUNT DUE                         
         BAS   RE,MFPUT                                                         
         B     XIT                                                              
         LTORG                                                                  
*                                                                               
*                                                                               
**********************************************************************          
*        COMMON SUBROUTINES AND DATA AREAS                                      
**********************************************************************          
*                                                                               
COMSUBS  DS    0D                                                               
*                                                                               
MODLIST  DS    0X                  MODE LIST                                    
         DC    AL1(EDMPGR),AL4(EDPGR)                                           
         DC    AL1(EDMPRD),AL4(EDPRD)                                           
         DC    AL1(EDMEST),AL4(EDEST)                                           
         DC    AL1(EDMMGR),AL4(EDMGR)                                           
         DC    AL1(EDMMKT),AL4(EDMKT)                                           
         DC    AL1(EDMSTA),AL4(EDSTA)                                           
         DC    AL1(EDMMTA),AL4(EDMTA)                                           
         DC    AL1(EDMCOM),AL4(EDCOM)                                           
         DC    AL1(EDMEND),AL4(EDEND)                                           
         DC    AL1(EDMLST),AL4(EDLST)                                           
         DC    AL1(EDMDUE),AL4(EDDUE)                                           
         DC    AL1(EDMADD),AL4(EDADD)                                           
         DC    AL1(EDMHDR),AL4(EDHDR)                                           
         DC    AL1(EDMUSR),AL4(EDUSR)                                           
         DC    AL1(EDMUCM),AL4(EDUCM)                                           
         DC    AL1(EDMRMA),AL4(EDRMA)                                           
         DC    AL1(EDMCLS),AL4(EDCLS)                                           
         DC    AL1(EDMCTX),AL4(EDCTAX)   CANADIAN TAXES                         
         DC    AL1(EDMTDUE),AL4(EDTDUE)  TOTAL DUE WITH CANADIAN TAXES          
MODLISTN EQU   (*-MODLIST)/5                                                    
*                                  TSAR RECORD TYPE EQUATES                     
*                                                                               
MKFROUTS DS    0X                  MAKEFILE RECORD ROUTINE LIST                 
         DC    AL1(EDAGMQ),AL4(MFAGM)                                           
         DC    AL1(EDADVQ),AL4(MFADV)                                           
         DC    AL1(EDADDQ),AL4(MFADD)                                           
         DC    AL1(EDPGRQ),AL4(MFPGR)                                           
         DC    AL1(EDPRDQ),AL4(MFPRD)                                           
         DC    AL1(EDESTQ),AL4(MFEST)                                           
         DC    AL1(EDMGRQ),AL4(MFMGR)                                           
         DC    AL1(EDMKTQ),AL4(MFMKT)                                           
         DC    AL1(EDSTAQ),AL4(MFSTA)                                           
         DC    AL1(EDHDRQ),AL4(MFHDR)                                           
         DC    AL1(EDMTAQ),AL4(MFDET)                                           
         DC    AL1(EDUSRQ),AL4(MFUSR)                                           
         DC    AL1(EDUCMQ),AL4(MFUCM)                                           
         DC    AL1(EDCOMQ),AL4(MFCOM)                                           
         DC    AL1(EDLSTQ),AL4(MFLST)                                           
         DC    AL1(EDDUEQ),AL4(MFDUE)                                           
         DC    AL1(EDRMAQ),AL4(MFRMA)                                           
         DC    AL1(EDCTAXQ),AL4(MFCTAX)                                         
         DC    AL1(EDTDUEQ),AL4(MFTDUE)                                         
MKFRTSN  EQU   (*-MKFROUTS)/5                                                   
*                                                                               
*                                  BREAK LEVEL NAMES                            
*                                                                               
LEVNAMS  DS    0X                                                               
         DC    X'04',C'PGR1'       PGR1                                         
         DC    X'08',C'PGR2'       PGR2                                         
         DC    X'0C',C'PGR3'       PGR3                                         
         DC    X'10',C'PRD '       PRD                                          
         DC    X'14',C'EST '       EST                                          
         DC    X'18',C'MGR1'       MGR1                                         
         DC    X'1C',C'MGR2'       MGR2                                         
         DC    X'20',C'MGR3'       MGR3                                         
         DC    X'24',C'MKT '       MKT                                          
         DC    X'28',C'NET '       CANADIAN NETWORK                             
         DC    X'2C',C'STA '       STA                                          
         DC    X'30',C'PKG '       PACKAGE                                      
         DC    X'34',C'PROG'       PROGRAM                                      
         DC    X'38',C'SPOT'       SPOT DESC                                    
         DC    X'3C',C'PER '       PERIOD                                       
         DC    X'40',C'PERG'       PERIOD GROUP                                 
         DC    X'44',C'TYPE'       TYPE - TIME, INT, ETC.                       
         DC    X'FF',C'INV '       INVOICE                                      
LEVNAMSN EQU   (*-LEVNAMS)/5                                                    
*                                                                               
*                                  TSAR RECORD TYPE EQUATES                     
EDHDRQ   EQU   10                                                               
EDAGMQ   EQU   20                                                               
EDADVQ   EQU   30                                                               
EDADDQ   EQU   32                                                               
EDPGRQ   EQU   40                                                               
EDPRDQ   EQU   50                                                               
EDESTQ   EQU   60                                                               
EDSTAQ   EQU   62                                                               
EDCOMQ   EQU   64                                                               
EDUSRQ   EQU   66                                                               
EDUCMQ   EQU   68                                                               
EDMGRQ   EQU   70                                                               
EDMKTQ   EQU   80                                                               
EDDUEQ   EQU   81                                                               
EDLSTQ   EQU   83                                                               
EDRMAQ   EQU   85                                                               
EDMTAQ   EQU   90                                                               
EDCTAXQ  EQU   91                                                               
EDTDUEQ  EQU   92                                                               
*                                  SORT SEQUENCE GROUPS                         
EDRSRTHQ EQU   10                  HEADER                                       
EDRSRTAQ EQU   15                  BILLING ADDR                                 
EDRSRTMQ EQU   20                  MAIN                                         
*                                                                               
FDELIM   EQU   X'5E'               FIELD DELIMITER  (SEMI-COLON)                
*                                                                               
XIT      XIT1                                                                   
         EJECT                                                                  
*********************************************************************           
*        EDPUT - RECORD TO TSAR                                                 
*********************************************************************           
*                                                                               
EDPUT    NTR1                                                                   
         MVC   BEKSEQ,SEQNO        SET SEQUENCE NUMBER                          
         LH    RF,SEQNO            AND BUMP                                     
         AHI   RF,1                                                             
         STH   RF,SEQNO                                                         
*                                                                               
         L     RF,APATCH                                                        
         TM    1(RF),X'80'         TRACE RECORDS ADDED TO TSAROFF?              
         BZ    EDPUT10                                                          
         SR    R0,R0                                                            
         ICM   R0,3,BREC           RECORD LENGTH                                
         GOTO1 PRNTBL,DMCB,=C'TSAADD',BREC,C'DUMP',(R0),=C'1D'                  
*                                                                               
EDPUT10  LA    R1,BREC                                                          
         ST    R1,TSAREC                                                        
         MVI   TSOFFACT,TSAADD                                                  
         GOTO1 ATSAROFF,(R6)                                                    
         CLI   TSERRS,0                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         BAS   RE,CLRBREC          SET BUFFER REC TO SPACES                     
         B     XIT                                                              
*                                                                               
*********************************************************************           
*        TRACE TSAROFF BUFFER                                                   
*********************************************************************           
*                                                                               
EDTRC    NTR1                                                                   
         L     RF,APATCH                                                        
         TM    0(RF),X'08'         TEST NEED TRACE                              
         BZ    EDTRX                                                            
*                                                                               
         MVC   P(7),=C'**EDI**'                                                 
         BRASL RE,PRNT                                                          
*                                                                               
         LA    R4,BREC                                                          
         ST    R4,TSAREC                                                        
         XC    BREC(BEKLN+2),BREC  CLEAR KEY PLUS LENGTH                        
         MVI   TSOFFACT,TSARDH                                                  
         B     EDTR4B                                                           
*                                                                               
EDTR4    DS    0H                                                               
         MVI   TSOFFACT,TSANXT                                                  
*                                                                               
EDTR4B   DS    0H                                                               
         GOTO1 ATSAROFF,(R6)                                                    
         TM    TSERRS,TSEEOF                                                    
         BO    EDTRX                                                            
         TM    TSERRS,X'FF'-TSERNF (RECORD NOT FOUND IS OK)                     
         BZ    *+6                                                              
         DC    H'0'                NO OTHER ERROR IS ACCEPTABLE                 
*                                                                               
         SR    R2,R2                                                            
         ICM   R2,3,0(R4)                                                       
         CHI   R2,133                                                           
         BNH   *+8                                                              
         LHI   R2,133                                                           
         BCTR  R2,0                                                             
         EX    R2,*+8                                                           
         B     *+10                                                             
         MVC   P(0),0(R4)                                                       
*                                                                               
         LA    R2,1(R2)                                                         
         GOTO1 HEXOUT,DMCB,0(R4),P4,(R2),=C'N'                                  
*                                                                               
         LR    R0,R2                                                            
         LA    R3,P2                                                            
         LA    R2,P4                                                            
*                                                                               
EDTR5    DS    0H                                                               
         MVC   0(1,R3),0(R2)                                                    
         MVC   132(1,R3),1(R2)                                                  
         LA    R3,1(R3)                                                         
         LA    R2,2(R2)                                                         
         BCT   R0,EDTR5                                                         
*                                                                               
         MVC   P4,SPACES                                                        
         MVC   P5,SPACES                                                        
*                                                                               
         MVI   SPACING,2                                                        
         BRASL RE,PRNT                                                          
         B     EDTR4                                                            
*                                                                               
EDTRX    DS    0H                                                               
         B     XIT                                                              
         DROP  R6                                                               
*                                                                               
*********************************************************************           
*        MFPUT - RECORD TO OUTPUT FILE                                          
*********************************************************************           
*                                                                               
MFPUT    NTR1                                                                   
         L     R2,ANXTPOS          SET RECORD LENGTH                            
         S     R2,AFREC                                                         
         STCM  R2,3,FREC                                                        
*                                                                               
         CLI   OUTMODE,C'D'        DATASET OUTPUT                               
         BE    MFPUT4                                                           
*                                  ELSE WORKER OTUPUT                           
         GOTO1 DATAMGR,DMCB,=C'ADD',WRKRFIL,WRKRIND,FREC,AWRKBUFF               
         CLI   DMCB+8,0                                                         
         BE    MFPUT6                                                           
         DC    H'0'                                                             
*                                                                               
MFPUT4   DS    0H                                                               
         LA    R2,EDIOUT                                                        
         PUT   (R2),FREC                                                        
*                                                                               
MFPUT6   DS    0H                                                               
         B     XIT                                                              
**********************************************************************          
*        CLEAR RECORD AREAS                                                     
**********************************************************************          
*                                                                               
CLRBREC  NTR1                                                                   
         LA    R0,BREC             SET BUFFER REC TO SPACES                     
         LHI   R1,L'BREC                                                        
         SR    RE,RE                                                            
         IC    RF,=C' '                                                         
         SLL   RF,24                                                            
         MVCL  R0,RE                                                            
         B     XIT                                                              
*                                                                               
CLRFREC  NTR1                                                                   
         LA    R0,FREC+4           SET FILE REC TO SPACES                       
         LHI   R1,L'FREC-4                                                      
         SR    RE,RE                                                            
         IC    RF,=C' '                                                         
         SLL   RF,24                                                            
         MVCL  R0,RE                                                            
         XC    FREC(4),FREC                                                     
         B     XIT                                                              
*                                                                               
*                                                                               
**********************************************************************          
*        SETGN - SET GROSS/NET CONTROL                                          
**********************************************************************          
*                                                                               
SETGN    DS    0H                                                               
*                                                                               
         MVI   GNCTL,X'C0'      ** NOTE- ALWAYS SHOW GROSS AND NET              
         BR    RE                                                               
*                                                                               
         CLI   GNSW,C'N'           NET                                          
         BNE   *+12                                                             
         OI    GNCTL,X'40'                                                      
         B     *+8                                                              
         OI    GNCTL,X'80'         ELSE GROSS                                   
*                                  FORMATS THAT GET BOTH G AND N                
         CLI   FORMAT,9                                                         
         BE    SETGN6                                                           
         CLI   FORMAT,13                                                        
         BE    SETGN6                                                           
         CLI   FORMAT,14                                                        
         BNE   SETGNX                                                           
*                                                                               
SETGN6   DS    0H                                                               
         OI    GNCTL,X'C0'         GROSS AND NET                                
*                                                                               
SETGNX   DS    0H                                                               
         BR    RE                                                               
         EJECT                                                                  
***********************************************************************         
*        BLDREC -  ADD DATA ITEM TO RECORD                                      
*                  P1 POINTS TO ITEM, BYTE 0 = LENGTH                           
***********************************************************************         
         SPACE 2                                                                
BLDREC   NTR1                                                                   
         SR    R2,R2                                                            
         ICM   R2,7,1(R1)          A(DATA ITEM)                                 
         SR    RF,RF                                                            
         ICM   RF,1,0(R1)          LENGTH                                       
         BNZ   BR02                                                             
*                                  ZERO LENGTH GIVEN                            
         CLI   OUTMODE,C'W'        VARIABLE LENGTH FLDS FOR WKR FILES           
         BE    BR03                                                             
         CLI   PROFB1A+5,C'F'      OTHERWISE MAY BE FIXED                       
         BNE   BR03                                                             
*                                                                               
         LHI   RF,1                ASSUME 1                                     
         LA    R2,SPACES           SPACE                                        
         B     BR03                                                             
*                                                                               
BR02     DS    0H                  NON-ZERO LENGTH                              
         CLI   OUTMODE,C'W'        VARIABLE LENGTH FLDS FOR WKR FILES           
         BE    *+12                                                             
         CLI   PROFB1A+5,C'F'      OTHERWISE MAY BE FIXED                       
         BE    BR03                                                             
*                                                                               
         AR    RF,R2               STRIP ANY TRAILING BLANKS                    
         BCTR  RF,0                                                             
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
         SR    RF,R2                                                            
         BNM   *+10                                                             
         SR    RF,RF                                                            
         B     BR03                                                             
         LA    RF,1(RF)                                                         
*                                                                               
BR03     DS    0H                                                               
         L     R3,ANXTPOS          WHERE TO PUT                                 
         LA    R4,1(RF,R3)                                                      
         C     R4,AFRECX                                                        
         BL    *+6                                                              
         DC    H'0'                REC OVERFLOW                                 
*                                                                               
         LTR   RF,RF                                                            
         BNP   BR06                                                             
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),0(R2)                                                    
         LA    R3,1(R3,RF)                                                      
*                                                                               
BR06     DS    0H                                                               
         CLI   OUTMODE,C'W'        VARIABLE LENGTH FLDS FOR WKR FILES           
         BE    *+12                NO FIELD DELIMITER                           
         CLI   PROFB1A+5,C'F'      OTHERWISE MAY BE FIXED                       
         BE    *+12                                                             
         MVI   0(R3),FDELIM                                                     
         LA    R3,1(R3)                                                         
*                                                                               
         ST    R3,ANXTPOS                                                       
*                                                                               
         B     XIT                                                              
         DROP  R7                                                               
         SPACE 2                                                                
         LTORG                                                                  
         EJECT                                                                  
*********************************************************************           
*  THE SUB WILL GO THROUGH INVTAB ENTRIES AND TRY TO GET ACTUAL                 
*  AMOUNT FOR EACH ENTRY BY READING CORRESPONDING BILLHEADERS AND               
*  ADDING THEM UP.  IF THE ADJUSTMENT BILL IS BROKEN DOWN DIFFERENTLY           
*  THEN THE ORIGINAL THE WHOLE ACTUAL AMOUNT FROM THE ORIGINAL BILL             
*  WILL BE TAKEN                                                                
*********************************************************************           
CALCACT  NTR1  BASE=*,LABEL=*                                                   
         L     R6,INVTABN          FOR BCT                                      
         LTR   R6,R6                                                            
         BNP   CALCAX                                                           
         L     R4,AINVTAB          START OF TABLE                               
         USING INVLD,R4                                                         
*                                                                               
*                                                                               
CALCA5   ZAP   X(L'BACTP),=P'0'    CLEAR ACCUMULATOR FOR ACT                    
         MVI   X+L'BACTP,C'N'      FLAG TO INDICATE DERIVED ACTUAL              
         ZIC   R0,INVLYR           TRICK TO PUT Y/M IN ONE BYTE:                
         CVD   R0,DOUBLE           DOUBLE+7 HAS ACTUAL YEAR AND SIGN            
         NI    DOUBLE+7,X'F0'      CLEAR THE SIGN NIBBLE                        
         OC    DOUBLE+7(1),INVLMO  NOW PUT IN MONTH IN LOW NIBBLE               
         XC    KEY,KEY                                                          
BK@      USING BILLREC,KEY                                                      
         MVC   BK@.BKEYAM,BAGYMD                                                
         MVC   BK@.BKEYCLT,BCLT                                                 
         OC    INVLPRD,INVLPRD                                                  
         BZ    CALCA10             ALL PRODUCTS ? YES, START FILTERING          
*                                                                               
         L     RF,ADCLT            FIND PRODUCT CODE                            
         LA    RF,CLIST-CLTHDR(RF)                                              
         CLC   INVLPRD,3(RF)                                                    
         BE    *+18                                                             
         LA    RF,4(RF)                                                         
         CLI   0(RF),0                                                          
         BNE   *-18                                                             
         DC    H'0'                                                             
         MVC   BK@.BKEYPRD,0(RF)   SINGLE PRODUCT                               
*                                                                               
         OC    INVLEST,INVLEST                                                  
         BZ    CALCA10                                                          
         MVC   BK@.BKEYEST,INVLEST HAVE ESTIMATE                                
*                                                                               
         OC    INVLPER,INVLPER     DO WE HAVE MONTH OF SERV                     
         BZ    CALCA10                                                          
         MVC   BK@.BKEYYSRV(2),INVLPER                                          
*                                                                               
         MVC   BK@.BKEYMBIL,DOUBLE+7   PUT IN YEAR/MONTH                        
         MVC   BK@.BKEYINV,INVLINV     DONE BUILDING THE KEY                    
         MVI   HALF,X'FF'          FLAG THAT BUILT WHOLE REC                    
*                                                                               
CALCA10  GOTO1 HIGH                                                             
         CLI   HALF,X'FF'                                                       
         BNE   CALCA30             NEED TO FILTER                               
         MVI   HALF,0              CLEAR                                        
         CLC   KEY(13),KEYSAVE     WHOLE KEY HAS TO MATCH                       
         BE    CALCA50                                                          
         DC    H'0'                OR I'M MISSING SOMETHING                     
*                                                                               
CALCA20  GOTO1 SEQ                                                              
*                                                                               
CALCA30  DS    0H                                                               
         CLC   KEY(4),KEYSAVE      COMPARE UP TO CLIENT                         
         BNE   CALCA100            NO MATCH, DONE WITH THIS ENTRY               
         OC    INVLPRD,INVLPRD     DO WE HAVE PRODUCT?                          
         BZ    CALCA35                                                          
         L     RF,ADCLT            FIND PRODUCT CODE                            
         LA    RF,CLIST-CLTHDR(RF)                                              
         CLC   INVLPRD,3(RF)                                                    
         BE    *+18                                                             
         LA    RF,4(RF)                                                         
         CLI   0(RF),0                                                          
         BNE   *-18                                                             
         DC    H'0'                                                             
         CLC   BK@.BKEYPRD,0(RF)   HAVE PRODUCT, DOES IT MATCH?                 
         BNE   CALCA100            NO, DONE                                     
CALCA35  OC    INVLEST,INVLEST     DID WE PUT IN EST?                           
         BZ    *+14                                                             
         CLC   BK@.BKEYEST,INVLEST IF YES, DOES IT MATCH                        
         BNE   CALCA20             NO, GET NXT REC                              
         OC    INVLPER,INVLPER     DID WE PUT MOS?                              
         BZ    *+18                                                             
         CLC   INVLPER,BK@.BKEYYSRV                                             
         BNE   CALCA20                                                          
         B     CALCA40                                                          
*                                                                               
         L     RF,=A(MOSLIST)      CHECK IF RIGHT MOS                           
CALCA37  CLI   0(RF),X'FF'                                                      
         BE    CALCA20             NO MATCH, NEXT REC                           
         CLC   0(2,RF),BK@.BKEYYSRV                                             
         BE    CALCA40                                                          
         LA    RF,2(RF)            TRY NXT ENTRY                                
         B     CALCA37                                                          
*                                                                               
CALCA40  CLC   BK@.BKEYMBIL,DOUBLE+7                                            
         BNE   CALCA20                                                          
         CLC   BK@.BKEYINV,INVLINV                                              
         BNE   CALCA20                                                          
         DROP  BK@                                                              
*                                                                               
CALCA50  DS    0H                   IF GOT HERE, GOT THE RIGHT KEY !!!          
         GOTO1 GETBILL                                                          
         L     R7,ADBILL                                                        
         USING BILLREC,R7                                                       
*  CODE BELOW IS NOT NEEDED, BUT WILL LEAVE FOR NOW JUST IN CASE                
*        OC    INVLMGR,INVLMGR     SEP BY MKT GROUP ?                           
*        BZ    *+24                                                             
*        CLC   BLMGR,=CL5' '       IF NOTHING IN ORIG BILL -> HAD MGR=T         
*        BNH   *+14                WON'T BE ABLE TO MATCH, SO GET IT            
*        CLC   INVLMGRC,BLMGR+1    YES, HAS TO MATCH (NUMERIC PART)             
*        BNE   CALCA20             OTHERWISE GET NXT REC                        
*                                                                               
*        OC    INVLMKT,INVLMKT     SEP BY MKT?                                  
*        BZ    CALCA55                                                          
*        CLC   BLMKT,=CL4' '       IF ORIG BILL HAD MKTS TOGETHER,              
*        BNH   CALCA55             GET THIS BILLHEADER, DO NOT MATCH            
*        SR    R0,R0                                                            
*        ICM   R0,3,INVLMKT                                                     
*        CVD   R0,DUB                                                           
*        OI    DUB+7,X'0F'                                                      
*        UNPK  FULL,DUB                                                         
*        CLC   BLMKT,FULL                                                       
******** BNE   CALCA20                                                          
CALCA55  CLI   SCBNCSW,C'C'        DOING COMMISSION BILLING?                    
         BNE   *+16                                                             
         TM    BILSTAT,BSTSCOMQ    YES, ONLY COMM BILLS                         
         BZ    CALCA20                                                          
         B     *+12                                                             
*                                                                               
         TM    BILSTAT,BSTSCOMQ    ELSE SKIP COMMISSION BILL                    
         BNZ   CALCA20                                                          
*                                                                               
         CLI   QGMITVC,C' '        GMI CASH/TRADE FILTERING ?                   
         BNH   CALCA60                                                          
         CLI   QGMITVC,C'T'        TRADE?                                       
         BNE   *+16                                                             
         TM    BILSTAT2,BSTGMITQ   YES, ONLY TRADE BILLS                        
         BZ    CALCA20                                                          
         B     *+12                                                             
*                                                                               
         TM    BILSTAT2,BSTGMITQ   MUST BE CASH ONLY                            
         BNZ   CALCA20             SO ONLY NON-TRADE BILLS                      
*                                  GOT HERE, GOT OUR BILL WITH ACTUAL           
CALCA60  DS    0H                                                               
         CLI   QTRADE,C' '         GROUP M CASH/TRADE?                          
         BNH   CALCA63                                                          
         CLI   QTRADE,C'T'         TRADE?                                       
         BNE   *+16                                                             
         TM    BILSTAT3,BSTTRDQ    YES, ONLY TRADE BILLS                        
         BZ    CALCA20                                                          
         B     *+12                                                             
*                                                                               
         TM    BILSTAT3,BSTTRDQ    MUST BE CASH ONLY                            
         BNZ   CALCA20             SO ONLY NON-TRADE BILLS                      
*                                  GOT HERE, GOT OUR BILL WITH ACTUAL           
CALCA63  DS    0H                  ADD IN ACTUAL                                
         CLI   COST2SW,C'Y'        IS IT COS2?                                  
         BNE   CALCA65                                                          
         CLI   INVLCURR,0          ARE THESE COS2 $$ ?                          
         BE    CALCA65             NO, PUT IN REGULAR SPOTS                     
         AP    X(L'BACTP),BACT2P   ADD IN COS2 ACTUAL                           
         MVI   X+L'BACTP,C'Y'      FLAG -> DERIVED ACTUAL                       
         B     CALCA20             GET NXT BILL HEADER                          
CALCA65  AP    X(L'BACTP),BACTP    ADD IN ACTUAL                                
         MVI   X+L'BACTP,C'Y'      FLAG -> DERIVED ACTUAL                       
         B     CALCA20             GET NXT BILL HEADER                          
*                                                                               
CALCA100 DS    0H                                                               
         CLI   X+L'BACTP,C'Y'      DID WE GET ACTUAL?                           
         BE    *+6                                                              
         DC    H'0'                SMTH WRONG                                   
*                                                                               
         XC    DUB,DUB                                                          
         MVC   DUB+2(L'BACTP),X    PUT ACTUAL IN DUB                            
         CVB   R0,DUB                                                           
         STCM  R0,15,INVLACT                                                    
*                                                                               
CALCA110 A     R4,INVTABL                                                       
         BCT   R6,CALCA5                                                        
*                                                                               
*                                                                               
CALCAX   XIT1                                                                   
         DROP  R4,R7                                                            
*                                                                               
         LTORG                                                                  
*                                                                               
A2REQS   DCB   DDNAME=A2REQS,DSORG=PS,RECFM=FB,MACRF=PM,LRECL=80                
*                                                                               
EDIOUT   DCB   DDNAME=EDIOUT,DSORG=PS,RECFM=VB,MACRF=PM                         
*                                                                               
EDITRC   DCB   DDNAME=EDIOUT,DSORG=PS,RECFM=VB,MACRF=GM,EODAD=EDTRCEOF          
*                                                                               
OUT      DCB   DDNAME=OUT,DSORG=PS,RECFM=VB,MACRF=(GM,PM),LRECL=512,   +        
               EODAD=INVR29                                                     
*                                                                               
*&&DO                                                                           
* UCOM-REJECTED RECORDS WRITTEN TO THIS DATASET                                 
*                                                                               
SKIPPED  DCB   DDNAME=SKIPPED,                                         X        
               DSORG=PS,                                               X        
               RECFM=FB,                                               X        
               LRECL=80,                                               X        
               BLKSIZE=2000,                                           X        
               MACRF=PM                                                         
*&&                                                                             
*                                                                               
FRSTSW   DC    X'00'                                                            
SEQNO    DC    H'1'                                                             
MFNEWSW  DC    X'00'                                                            
EDNEWSW  DC    X'00'                                                            
GNCTL    DC    X'00'           GROSS/NET - X'80'=GROSS, X'40'=NET               
*                                                                               
EDMODE   DS    X                                                                
EDPARMS  DS    6F                                                               
TSARB    DS    XL(TSARDL)                                                       
*                                                                               
BREC     DS    XL300               TSAR BUFFER RECORD                           
FREC     DS    XL300               OUTPUT FILE RECORD                           
*                                                                               
ABREC    DS    A                                                                
AFREC    DS    A                                                                
AFRECP4  DS    A                                                                
ABRECX   DS    A                                                                
AFRECX   DS    A                                                                
ANXTPOS  DS    A                                                                
*                                                                               
AWRKBUFF DS    A                                                                
WRKRIND  DS    XL44                                                             
WRKRFIL  DS    CL8                                                              
*                                                                               
*                                                                               
* ESTIMATE RECORD EXPECTED IN ADEST                                             
CHKUCOM  NMOD1 UCOMQ,PUSER                                                      
         LR    R9,RC                                                            
         USING UCOMD,R9                                                         
         LA    RC,SPACEND                                                       
         L     R2,ADEST            TEST ESTIMATE HEADER                         
         USING ESTHDR,R2                                                        
*                                                                               
         MVC   USAVKEY,KEY         SAVE MY KEY                                  
         LA    R3,UCOMBLK          SET-UP DDUCOM CONTROL BLOCK                  
         XC    UCOMBLK(L'UCOMBLK),UCOMBLK                                       
         USING DDUCOMD,R3                                                       
*                                                                               
         MVC   UCPRD,EKEYPRD       PRODUCT CODE                                 
*                                                                               
CKUC10   MVC   UCACOMF,ACOMFACS    COMFACS                                      
         MVI   UCSYS,C'S'          SYSTEM TO PRINT (SPOT)                       
         MVC   UCSAM,EKEYAM        AGENCY/MEDIA                                 
         MVC   UCSCLT,EKEYCLT      PACKED CLIENT                                
         MVC   UCSEST,EKEYEST      BINARY ESTIMATE NUMBER                       
         OI    UCOPT,UCOEST        RETURN ESTIMATE UCOMMS                       
         XC    UCTTLS,UCTTLS                                                    
         XC    UCOMDATA,UCOMDATA                                                
*                                                                               
*NOP     L     RF,ADCLT                                                         
*        CLI   UCOMNUM-CLTHDR(RF),4  IF 4 UCOMMS OR LESS                        
*        BNH   *+8                   BYPASS                                     
*****    OI    UCOPT,UCO8EST       RETURN ESTIMATE UCOMMS (UP TO 8)             
*                                                                               
         GOTO1 =V(DDUCOM),UCOMBLK                                               
         CLI   UCERROR,0                                                        
         BNE   CHKUCNQX            ERROR RETURN - JUST EXIT DON'T DIE           
*                                                                               
         TM    UCDATA,UCDNOEST     NO ESTIMATE DATA ?                           
         BNO   CHKUC20                                                          
*                                                                               
         CLC   =C'POL',UCPRD       DID WE READ FOR POL YET?                     
         BNE   *+14                                                             
         XC    UCOMDATA,UCOMDATA                                                
         B     CHKUCNQX            YES, DONE                                    
*                                                                               
         XC    UCOMBLK(L'UCOMBLK),UCOMBLK                                       
         MVC   UCPRD,=C'POL'                                                    
         B     CKUC10                                                           
*                                                                               
* COMPARE NUMBER OF UCOMMS                                                      
* EXIT IF MINIMUM REQUIRED IS NOT MET                                           
*                                                                               
CHKUC20  L     RE,ADCLT                                                         
         CLI   UCOMNUM-CLTHDR(RE),0   MINIMUM UCOMM RESTRICTION?                
         BE    CHKUC26                NO                                        
*                                                                               
         LA    RF,0                COUNTER                                      
         LA    R0,4                4 LENGTHS                                    
         LA    R1,UCELENS          PT TO LEN OF 4 DATA FLDS THAT FOLLOW         
         BAS   RE,CHKLEN                                                        
*                                                                               
         L     RE,ADCLT                                                         
         CLI   UCOMNUM-CLTHDR(RE),4    IF 4 OR LESS DONE                        
         BNH   CHKUC24                                                          
*                                                                               
         LA    R0,4                4 LENGTHS                                    
         LA    R1,UCPLENS          PT TO LEN OF 4 DATA FLDS THAT FOLLOW         
         BAS   RE,CHKLEN                                                        
*                                                                               
CHKUC24  L     RE,ADCLT                                                         
         LLC   R0,UCOMNUM-CLTHDR(RE) NUMBER OF UCOMMS                           
         CR    RF,R0               CHECK FOR MINIMUM NUM OF UCOMMS              
         BL    CHKUCNQX                                                         
*                                                                               
CHKUC26  L     RE,UCETTLS          ESTIMATE TITLES                              
         MVC   UCTTLS,0(RE)                                                     
         L     RF,UCEDATA          ESTIMATE DATA                                
         MVC   UCOMDATA,0(RF)                                                   
*                                                                               
CHKUCQX  DS    0H                                                               
         MVC   KEY,USAVKEY         SINCE SEQ READING MAY BE AFFECTED            
         GOTO1 HIGH                                                             
         CR    RB,RB                                                            
         B     CHKUCXIT                                                         
*                                                                               
CHKUCNQX DS    0H                                                               
         MVC   KEY,USAVKEY         SINCE SEQ READING MAY BE AFFECTED            
         GOTO1 HIGH                                                             
         LTR   RB,RB                                                            
*                                                                               
CHKUCXIT DS    0H                                                               
         XIT1                                                                   
*                                                                               
CHKLEN   CLI   0(R1),0                                                          
         BE    *+8                                                              
         AHI   RF,1                INCREMENT COUNTER                            
         LA    R1,1(R1)            BUMP TO NEXT LEN                             
         BCT   R0,CHKLEN                                                        
         BR    RE                                                               
*                                                                               
         DROP  R2,R3,R9                                                         
         LTORG                                                                  
*                                                                               
*                                                                               
CHKWBFLT NMOD1 UCOMQ,CKWBFLT       CHECK IF THERE'S WB FLIGHT                   
         LR    R9,RC                                                            
         USING UCOMD,R9                                                         
         LA    RC,SPACEND                                                       
         L     R2,ADCLT                                                         
         USING CLTHDRD,R2                                                       
*                                                                               
         MVC   USAVKEY,KEY         SAVE MY KEY                                  
         LA    R3,UCOMBLK          SET-UP DDUCOM CONTROL BLOCK                  
         XC    UCOMBLK(L'UCOMBLK),UCOMBLK                                       
         USING DDUCOMD,R3                                                       
*                                                                               
         MVC   UCPRD,WORD                                                       
*                                                                               
         MVC   UCACOMF,ACOMFACS    COMFACS                                      
         MVI   UCSYS,C'S'          SYSTEM TO PRINT (SPOT)                       
         MVC   UCSAM,CKEYAM        AGENCY/MEDIA                                 
         MVC   UCSCLT,CKEYCLT      PACKED CLIENT                                
         DROP  R2                                                               
*                                                                               
         MVC   UCSEST,WORD+3       BINARY ESTIMATE NUMBER                       
*                                                                               
CHKWB30  OI    UCOPT,UCOEST        RETURN ESTIMATE UCOMMS                       
         XC    UCTTLS,UCTTLS                                                    
         XC    UCOMDATA,UCOMDATA                                                
         GOTO1 =V(DDUCOM),UCOMBLK                                               
         CLI   UCERROR,0                                                        
         BNE   CHKWBNO             ERROR RETURN - JUST EXIT DON'T DIE           
*                                                                               
         TM    UCDATA,UCDNOEST     NO ESTIMATE UCOM ?                           
         BO    CHKWBNO             NO FLIGHT, DON'T PROC THIS BUY               
*                                                                               
         L     RF,UCEDATA          ESTIMATE DATA                                
         LHI   R0,10                                                            
         LR    R1,RF                                                            
         CLI   0(R1),C'0'                                                       
         BL    CHKWBNO                                                          
         LA    R1,1(R1)                                                         
         BCT   R0,*-12                                                          
         MVC   WBFLT,0(RF)                                                      
         L     RF,AFLT                                                          
         MVC   0(10,RF),WBFLT      PUT FLIGHT INTO SORTREC                      
         CLI   QFLT,C' '           REQUEST FOR SPECIFIC FLIGHT?                 
         BNH   CHKWBYES            NO, PUT IT THROUGH                           
         CLC   WBFLT,QFLT          YES, MAKE SURE THE SAME FLIGHT               
         BNE   CHKWBNO             IF NOT, DON'T PROC THIS BUY                  
*                                                                               
CHKWBYES DS    0H                                                               
         MVC   KEY,USAVKEY         SINCE SEQ READING MAY BE AFFECTED            
         GOTO1 HIGH                                                             
         CR    RB,RB                                                            
         B     CHKWBXIT                                                         
*                                                                               
CHKWBNO  DS    0H                                                               
         MVC   KEY,USAVKEY         SINCE SEQ READING MAY BE AFFECTED            
         GOTO1 HIGH                                                             
         LTR   RB,RB                                                            
*                                                                               
CHKWBXIT DS    0H                                                               
         XIT1                                                                   
         DROP  R3,R9                                                            
         LTORG                                                                  
*                                                                               
* ESTIMATE RECORD EXPECTED IN ADEST                                             
CHKUDEF  NMOD1 0,CKUDEF                                                         
         LA    RC,SPACEND                                                       
*                                                                               
         MVI   BYTE,C'N'           SET UDEF FOUND                               
*                                  WILL BE CHANGED TO C IF MISSING              
         L     R2,ADEST                                                         
         USING ESTHDR,R2                                                        
*                                                                               
         TM    UDEFESW,X'01'  FIRST REQUIRED?                                   
         BZ    CHKUE5                                                           
         CLC   EUSER1,SPACES                                                    
         BNH   CHKUENQX       MISSING - SET TO SKIP                             
CHKUE5   TM    UDEFESW,X'02'  2ND REQUIRED?                                     
         BZ    CHKUEQX                                                          
         CLC   EUSER2,SPACES                                                    
         BNH   CHKUENQX       MISSING - SET TO SKIP                             
*                                                                               
CHKUEQX  CR    RB,RB                                                            
         B     CHKUEXIT                                                         
*                                                                               
CHKUENQX LTR   RB,RB          SET TO SKIP THIS ESTIMATE                         
*                                                                               
CHKUEXIT DS    0H                                                               
         XIT1                                                                   
         LTORG                                                                  
         DROP  R2                                                               
*                                                                               
*                                                                               
*                                  SPECIAL BILLING FORMULA MODULE               
BFMOD    DS    0D                                                               
         BR    14                  IF NO MODULE JUST RETURN                     
         DC    14X'00'                                                          
         DS    4080X                                                            
         TITLE 'TABLES'                                                         
         DS    0D                                                               
         DC    CL8'*STABUC*'                                                    
STABUCKC DS    0D                                                               
         DS    2000C                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*LEVTOT*'                                                    
LEVTOTS  DS    0D                                                               
         DC    (TOTSIZE*MAXLEVS)X'00'                                           
*                                  THIS AREA IS FOR HOLDING                     
*                                  MONTHLY ORD AND BILLED FOR                   
*                                  AS MANY LEVELS AS NECESSARY                  
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*SPLTAB*'                                                    
SPLTAB   DS    0D                                                               
         ORG   *+SPLTABRL*SPLTPMAX                                              
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*INVTAB*'                                                    
INVTAB   DS    0D                                                               
*                                  THIS TABLE IS ALSO USED TO HOLD              
*                                  PRODUCT INFO FOR RETAIL BILLING              
         DC    (INVTABRL*INVTBN)X'00'                                           
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*NETTAB*'                                                    
NETTAB   DS    0D                                                               
         DS    CL(MAXNETS*NETTABL)                                              
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*LINTAB*'                                                    
LINTAB   DS    0D                                                               
         DS    (LINTABN)CL132                                                   
LINTABX  DC    X'00'                                                            
*                                                                               
XSPIO    DS    4000X               XSPFIL RECORD I/O AREA                       
*                                                                               
         DS    0D                                                               
         DC    CL8'*FMTLINS'                                                    
FMTLINS  DS    0D                                                               
         DS    5CL132                                                           
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*AAAELST'                                                    
AAAELIST DS    0D                  AAA EST FORMULA LIST                         
         DS    (AAAESTMX)CL(AAAELSTL)                                           
AAAELSTX DC    X'00'                                                            
AAAESTMX EQU   200                 MAXIMUM NUMBER OF ESTIMATES                  
*                                                                               
         DS    0D                                                               
         DC    CL8'*AORADD*'                                                    
AORADDR  DS    0D                  AAA EST FORMULA LIST                         
         DS    CL(ADDRLEN)         5 LINES OF 60                                
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*GDAREA*'                                                    
         DS    0D                                                               
GDAREAWK DS    XL(GDSECTL)  RETAIL BILLING DSECT WORK AREA                      
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*SKIPTAB'                                                    
SKIPTAB  DS    0D                  TABLE OF PRD/EST/MKT/MOS TO SKIP             
         ORG   *+(SKIPTABL*SKIPMAX)                                             
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'A2REQTAB'                                                    
A2REQTAB DS    0D                  TABLE OF A2 REQUESTS                         
         DC    (A2REQTBL*A2REQMAX)C' '                                          
         DC    X'00'                                                            
*                                                                               
*        DS    0D                                                               
*        DC    CL8'*VCTAB**'                                                    
*CTAB    DS    0D                  TABLE OF VAT CODES - NAT AND PRV             
*                                                                               
*        NOTE1-QST CHANGED TO 7.5% EFFECTIVE WITH BILLING DATE                  
*              JAN02/97. SINCE THE CHANGE IS BASED ON BILL RUN DATE             
*              RATHER THAN MONTH OF SERVICE WE DON'T NEED 2 ENTRIES             
*              FOR QUEBEC IN THE VAT CODE TABLE.                                
*                                                                               
*        NOTE2-AS OF JULY1/06 GST WILL BE 6% AND HST 14% (WAS 7&15%)            
*              CHANGE AGAIN IS BASED ON BILL RUNDATE                            
*                                                                               
*        NOTE3-AS OF JAN01/08 GST WILL BE 5% AND HST 13% (WAS 6&14%)            
*              CHANGE AGAIN IS BASED ON BILL RUNDATE                            
*                                                                               
* *Y2K* HARD-CODED COMPRESSED DATES!                                            
*                                                                               
*        DC    AL1(00),C'S',X'5B01',X'FFFF',AL4(5000)  NAT STANDARD             
*        DC    AL1(00),C'X',X'5B01',X'FFFF',AL4(0000)  NAT STANDARD             
*        DC    AL1(00),C'Z',X'5B01',X'FFFF',AL4(0000)  NAT STANDARD             
*        DC    AL1(01),C'H',X'6E07',X'FFFF',AL4(12000) BRITISH COLUMBIA         
*        DC    AL1(01),C'X',X'6E07',X'FFFF',AL4(0000)  BRITISH COLUMBIA         
*        DC    AL1(01),C'Z',X'6E07',X'FFFF',AL4(0000)  BRITISH COLUMBIA         
*        DC    AL1(05),C'H',X'6E07',X'FFFF',AL4(13000) ONTARIO                  
*        DC    AL1(05),C'X',X'6E07',X'FFFF',AL4(0000)  ONTARIO                  
*        DC    AL1(05),C'Z',X'6E07',X'FFFF',AL4(0000)  ONTARIO                  
*        DC    AL1(06),C'S',X'5C07',X'FFFF',AL4(7500)  QUEBEC STANDARD          
*        DC    AL1(07),C'H',X'6104',X'FFFF',AL4(13000) NEW BRUNSWK              
*        DC    AL1(07),C'X',X'6104',X'FFFF',AL4(0000)  NEW BRUNSWK              
*        DC    AL1(07),C'Z',X'6104',X'FFFF',AL4(0000)  NEW BRUNSWK              
*        DC    AL1(08),C'H',X'6104',X'6E06',AL4(13000) NOVA SCOTIA              
*        DC    AL1(08),C'X',X'6104',X'6E06',AL4(0000)  NOVA SCOTIA              
*        DC    AL1(08),C'Z',X'6104',X'6E06',AL4(0000)  NOVA SCOTIA              
*        DC    AL1(08),C'H',X'6E07',X'FFFF',AL4(15000) NOVA SCOTIA              
*        DC    AL1(08),C'X',X'6E07',X'FFFF',AL4(0000)  NOVA SCOTIA              
*        DC    AL1(08),C'Z',X'6E07',X'FFFF',AL4(0000)  NOVA SCOTIA              
*        DC    AL1(10),C'H',X'6104',X'FFFF',AL4(13000) NEWFOUNDLAND             
*        DC    AL1(10),C'X',X'6104',X'FFFF',AL4(0000)  NEWFOUNDLAND             
*        DC    AL1(10),C'Z',X'6104',X'FFFF',AL4(0000)  NEWFOUNDLAND             
*        DC    X'FF'                                                            
*                                                                               
         DC    CL8'*VCTAB11'                                                    
VCTAB11  DS    0D                  TABLE OF VAT CODES - NAT AND PRV             
*                                                                               
*        NOTE1-QST CHANGED TO 7.5% EFFECTIVE WITH BILLING DATE                  
*              JAN02/97. SINCE THE CHANGE IS BASED ON BILL RUN DATE             
*              RATHER THAN MONTH OF SERVICE WE DON'T NEED 2 ENTRIES             
*              FOR QUEBEC IN THE VAT CODE TABLE.                                
*                                                                               
*        NOTE2-AS OF JULY1/06 GST WILL BE 6% AND HST 14% (WAS 7&15%)            
*              CHANGE AGAIN IS BASED ON BILL RUNDATE                            
*                                                                               
*        NOTE3-AS OF JAN01/08 GST WILL BE 5% AND HST 13% (WAS 6&14%)            
*              CHANGE AGAIN IS BASED ON BILL RUNDATE                            
*                                                                               
* *Y2K* HARD-CODED COMPRESSED DATES!                                            
*                                                                               
         DC    AL1(00),C'S',X'5B01',X'FFFF',AL4(5000)  NAT STANDARD             
         DC    AL1(00),C'X',X'5B01',X'FFFF',AL4(0000)  NAT STANDARD             
         DC    AL1(00),C'Z',X'5B01',X'FFFF',AL4(0000)  NAT STANDARD             
         DC    AL1(01),C'H',X'6E07',X'FFFF',AL4(12000) BRITISH COLUMBIA         
         DC    AL1(01),C'X',X'6E07',X'FFFF',AL4(0000)  BRITISH COLUMBIA         
         DC    AL1(01),C'Z',X'6E07',X'FFFF',AL4(0000)  BRITISH COLUMBIA         
         DC    AL1(05),C'H',X'6E07',X'FFFF',AL4(13000) ONTARIO                  
         DC    AL1(05),C'X',X'6E07',X'FFFF',AL4(0000)  ONTARIO                  
         DC    AL1(05),C'Z',X'6E07',X'FFFF',AL4(0000)  ONTARIO                  
         DC    AL1(06),C'S',X'5C07',X'FFFF',AL4(8500)  QUEBEC STANDARD          
         DC    AL1(07),C'H',X'6104',X'FFFF',AL4(13000) NEW BRUNSWK              
         DC    AL1(07),C'X',X'6104',X'FFFF',AL4(0000)  NEW BRUNSWK              
         DC    AL1(07),C'Z',X'6104',X'FFFF',AL4(0000)  NEW BRUNSWK              
*****    DC    AL1(08),C'H',X'6104',X'6E06',AL4(13000) NOVA SCOTIA              
*****    DC    AL1(08),C'X',X'6104',X'6E06',AL4(0000)  NOVA SCOTIA              
*****    DC    AL1(08),C'Z',X'6104',X'6E06',AL4(0000)  NOVA SCOTIA              
         DC    AL1(08),C'H',X'6E07',X'FFFF',AL4(15000) NOVA SCOTIA              
         DC    AL1(08),C'X',X'6E07',X'FFFF',AL4(0000)  NOVA SCOTIA              
         DC    AL1(08),C'Z',X'6E07',X'FFFF',AL4(0000)  NOVA SCOTIA              
         DC    AL1(10),C'H',X'6104',X'FFFF',AL4(13000) NEWFOUNDLAND             
         DC    AL1(10),C'X',X'6104',X'FFFF',AL4(0000)  NEWFOUNDLAND             
         DC    AL1(10),C'Z',X'6104',X'FFFF',AL4(0000)  NEWFOUNDLAND             
         DC    X'FF'                                                            
*                                                                               
*                                                                               
         DC    CL8'*VCTAB12'                                                    
VCTAB12  DS    0D                  TABLE OF VAT CODES - NAT AND PRV             
*                                                                               
*        NOTE1-QST CHANGED TO 7.5% EFFECTIVE WITH BILLING DATE                  
*              JAN02/97. SINCE THE CHANGE IS BASED ON BILL RUN DATE             
*              RATHER THAN MONTH OF SERVICE WE DON'T NEED 2 ENTRIES             
*              FOR QUEBEC IN THE VAT CODE TABLE.                                
*                                                                               
*        NOTE2-AS OF JULY1/06 GST WILL BE 6% AND HST 14% (WAS 7&15%)            
*              CHANGE AGAIN IS BASED ON BILL RUNDATE                            
*                                                                               
*        NOTE3-AS OF JAN01/08 GST WILL BE 5% AND HST 13% (WAS 6&14%)            
*              CHANGE AGAIN IS BASED ON BILL RUNDATE                            
*                                                                               
* *Y2K* HARD-CODED COMPRESSED DATES!                                            
*                                                                               
         DC    AL1(00),C'S',X'5B01',X'FFFF',AL4(5000)  NAT STANDARD             
         DC    AL1(00),C'X',X'5B01',X'FFFF',AL4(0000)  NAT STANDARD             
         DC    AL1(00),C'Z',X'5B01',X'FFFF',AL4(0000)  NAT STANDARD             
         DC    AL1(01),C'H',X'6E07',X'FFFF',AL4(12000) BRITISH COLUMBIA         
         DC    AL1(01),C'X',X'6E07',X'FFFF',AL4(0000)  BRITISH COLUMBIA         
         DC    AL1(01),C'Z',X'6E07',X'FFFF',AL4(0000)  BRITISH COLUMBIA         
         DC    AL1(05),C'H',X'6E07',X'FFFF',AL4(13000) ONTARIO                  
         DC    AL1(05),C'X',X'6E07',X'FFFF',AL4(0000)  ONTARIO                  
         DC    AL1(05),C'Z',X'6E07',X'FFFF',AL4(0000)  ONTARIO                  
         DC    AL1(06),C'S',X'5C07',X'FFFF',AL4(9500)  QUEBEC STANDARD          
         DC    AL1(07),C'H',X'6104',X'FFFF',AL4(13000) NEW BRUNSWK              
         DC    AL1(07),C'X',X'6104',X'FFFF',AL4(0000)  NEW BRUNSWK              
         DC    AL1(07),C'Z',X'6104',X'FFFF',AL4(0000)  NEW BRUNSWK              
*****    DC    AL1(08),C'H',X'6104',X'6E06',AL4(13000) NOVA SCOTIA              
*****    DC    AL1(08),C'X',X'6104',X'6E06',AL4(0000)  NOVA SCOTIA              
*****    DC    AL1(08),C'Z',X'6104',X'6E06',AL4(0000)  NOVA SCOTIA              
         DC    AL1(08),C'H',X'6E07',X'FFFF',AL4(15000) NOVA SCOTIA              
         DC    AL1(08),C'X',X'6E07',X'FFFF',AL4(0000)  NOVA SCOTIA              
         DC    AL1(08),C'Z',X'6E07',X'FFFF',AL4(0000)  NOVA SCOTIA              
         DC    AL1(10),C'H',X'6104',X'FFFF',AL4(13000) NEWFOUNDLAND             
         DC    AL1(10),C'X',X'6104',X'FFFF',AL4(0000)  NEWFOUNDLAND             
         DC    AL1(10),C'Z',X'6104',X'FFFF',AL4(0000)  NEWFOUNDLAND             
         DC    X'FF'                                                            
*                                                                               
         DC    CL8'*VCTAB13'                                                    
VCTAB13  DS    0D                  TABLE OF VAT CODES - NAT AND PRV             
*                                                                               
*        NOTE1-QST CHANGED TO 7.5% EFFECTIVE WITH BILLING DATE                  
*              JAN02/97. SINCE THE CHANGE IS BASED ON BILL RUN DATE             
*              RATHER THAN MONTH OF SERVICE WE DON'T NEED 2 ENTRIES             
*              FOR QUEBEC IN THE VAT CODE TABLE.                                
*                                                                               
*        NOTE2-AS OF JULY1/06 GST WILL BE 6% AND HST 14% (WAS 7&15%)            
*              CHANGE AGAIN IS BASED ON BILL RUNDATE                            
*                                                                               
*        NOTE3-AS OF JAN01/08 GST WILL BE 5% AND HST 13% (WAS 6&14%)            
*              CHANGE AGAIN IS BASED ON BILL RUNDATE                            
*                                                                               
*        NOTE4-AS OF JAN01/2013 QST % CHANGE TO 9.975 AND NO                    
*              LONGER CASCADING.  BASIS IS SAME AS GST                          
*              GST NO LONGER INCLUDED IN THE BASIS                              
*                                                                               
* *Y2K* HARD-CODED COMPRESSED DATES!                                            
*                                                                               
         DC    AL1(00),C'S',X'5B01',X'FFFF',AL4(5000)  NAT STANDARD             
         DC    AL1(00),C'X',X'5B01',X'FFFF',AL4(0000)  NAT STANDARD             
         DC    AL1(00),C'Z',X'5B01',X'FFFF',AL4(0000)  NAT STANDARD             
         DC    AL1(01),C'H',X'6E07',X'FFFF',AL4(12000) BRITISH COLUMBIA         
         DC    AL1(01),C'X',X'6E07',X'FFFF',AL4(0000)  BRITISH COLUMBIA         
         DC    AL1(01),C'Z',X'6E07',X'FFFF',AL4(0000)  BRITISH COLUMBIA         
         DC    AL1(05),C'H',X'6E07',X'FFFF',AL4(13000) ONTARIO                  
         DC    AL1(05),C'X',X'6E07',X'FFFF',AL4(0000)  ONTARIO                  
         DC    AL1(05),C'Z',X'6E07',X'FFFF',AL4(0000)  ONTARIO                  
         DC    AL1(06),C'S',X'5C07',X'FFFF',AL4(9975)  QUEBEC STANDARD          
         DC    AL1(07),C'H',X'6104',X'FFFF',AL4(13000) NEW BRUNSWK              
         DC    AL1(07),C'X',X'6104',X'FFFF',AL4(0000)  NEW BRUNSWK              
         DC    AL1(07),C'Z',X'6104',X'FFFF',AL4(0000)  NEW BRUNSWK              
*****    DC    AL1(08),C'H',X'6104',X'6E06',AL4(13000) NOVA SCOTIA              
*****    DC    AL1(08),C'X',X'6104',X'6E06',AL4(0000)  NOVA SCOTIA              
*****    DC    AL1(08),C'Z',X'6104',X'6E06',AL4(0000)  NOVA SCOTIA              
         DC    AL1(08),C'H',X'6E07',X'FFFF',AL4(15000) NOVA SCOTIA              
         DC    AL1(08),C'X',X'6E07',X'FFFF',AL4(0000)  NOVA SCOTIA              
         DC    AL1(08),C'Z',X'6E07',X'FFFF',AL4(0000)  NOVA SCOTIA              
         DC    AL1(10),C'H',X'6104',X'FFFF',AL4(13000) NEWFOUNDLAND             
         DC    AL1(10),C'X',X'6104',X'FFFF',AL4(0000)  NEWFOUNDLAND             
         DC    AL1(10),C'Z',X'6104',X'FFFF',AL4(0000)  NEWFOUNDLAND             
         DC    X'FF'                                                            
*                                                                               
         DC    CL8'*VCTAB13A'                                                   
VCTAB13A DS    0D                  TABLE OF VAT CODES - NAT AND PRV             
*                                                                               
*        NOTE1-QST CHANGED TO 7.5% EFFECTIVE WITH BILLING DATE                  
*              JAN02/97. SINCE THE CHANGE IS BASED ON BILL RUN DATE             
*              RATHER THAN MONTH OF SERVICE WE DON'T NEED 2 ENTRIES             
*              FOR QUEBEC IN THE VAT CODE TABLE.                                
*                                                                               
*        NOTE2-AS OF JULY1/06 GST WILL BE 6% AND HST 14% (WAS 7&15%)            
*              CHANGE AGAIN IS BASED ON BILL RUNDATE                            
*                                                                               
*        NOTE3-AS OF JAN01/08 GST WILL BE 5% AND HST 13% (WAS 6&14%)            
*              CHANGE AGAIN IS BASED ON BILL RUNDATE                            
*                                                                               
*        NOTE4-AS OF JAN01/2013 QST % CHANGE TO 9.975 AND NO                    
*              LONGER CASCADING.  BASIS IS SAME AS GST                          
*              GST NO LONGER INCLUDED IN THE BASIS                              
*        NOTE5-AS OF APR01/2013 BC NO LONGER HAS HST - ONLY GST                 
*              ALSO PE STARTS HST 14.000 %                                      
*                                                                               
* *Y2K* HARD-CODED COMPRESSED DATES!                                            
*                                                                               
         DC    AL1(00),C'S',X'5B01',X'FFFF',AL4(5000)  NAT STANDARD             
         DC    AL1(00),C'X',X'5B01',X'FFFF',AL4(0000)  NAT STANDARD             
         DC    AL1(00),C'Z',X'5B01',X'FFFF',AL4(0000)  NAT STANDARD             
*******  DC    AL1(01),C'H',X'7104',X'FFFF',AL4(00000) BRITISH COLUMBIA         
*******  DC    AL1(01),C'X',X'6E07',X'FFFF',AL4(0000)  BRITISH COLUMBIA         
*******  DC    AL1(01),C'Z',X'6E07',X'FFFF',AL4(0000)  BRITISH COLUMBIA         
         DC    AL1(05),C'H',X'6E07',X'FFFF',AL4(13000) ONTARIO                  
         DC    AL1(05),C'X',X'6E07',X'FFFF',AL4(0000)  ONTARIO                  
         DC    AL1(05),C'Z',X'6E07',X'FFFF',AL4(0000)  ONTARIO                  
         DC    AL1(06),C'S',X'5C07',X'FFFF',AL4(9975)  QUEBEC STANDARD          
         DC    AL1(07),C'H',X'6104',X'FFFF',AL4(13000) NEW BRUNSWK              
         DC    AL1(07),C'X',X'6104',X'FFFF',AL4(0000)  NEW BRUNSWK              
         DC    AL1(07),C'Z',X'6104',X'FFFF',AL4(0000)  NEW BRUNSWK              
*****    DC    AL1(08),C'H',X'6104',X'6E06',AL4(13000) NOVA SCOTIA              
*****    DC    AL1(08),C'X',X'6104',X'6E06',AL4(0000)  NOVA SCOTIA              
*****    DC    AL1(08),C'Z',X'6104',X'6E06',AL4(0000)  NOVA SCOTIA              
         DC    AL1(08),C'H',X'6E07',X'FFFF',AL4(15000) NOVA SCOTIA              
         DC    AL1(08),C'X',X'6E07',X'FFFF',AL4(0000)  NOVA SCOTIA              
         DC    AL1(08),C'Z',X'6E07',X'FFFF',AL4(0000)  NOVA SCOTIA              
         DC    AL1(09),C'H',X'6E07',X'FFFF',AL4(14000) P.E. ISLAND              
         DC    AL1(09),C'X',X'6E07',X'FFFF',AL4(0000)  P.E. ISLAND              
         DC    AL1(09),C'Z',X'6E07',X'FFFF',AL4(0000)  P.E. ISLAND              
         DC    AL1(10),C'H',X'6104',X'FFFF',AL4(13000) NEWFOUNDLAND             
         DC    AL1(10),C'X',X'6104',X'FFFF',AL4(0000)  NEWFOUNDLAND             
         DC    AL1(10),C'Z',X'6104',X'FFFF',AL4(0000)  NEWFOUNDLAND             
         DC    X'FF'                                                            
*                                                                               
         DC    CL8'*VCTAB16'                                                    
VCTAB16  DS    0D                  TABLE OF VAT CODES - NAT AND PRV             
*                                                                               
*        NOTE1-QST CHANGED TO 7.5% EFFECTIVE WITH BILLING DATE                  
*              JAN02/97. SINCE THE CHANGE IS BASED ON BILL RUN DATE             
*              RATHER THAN MONTH OF SERVICE WE DON'T NEED 2 ENTRIES             
*              FOR QUEBEC IN THE VAT CODE TABLE.                                
*                                                                               
*        NOTE2-AS OF JULY1/06 GST WILL BE 6% AND HST 14% (WAS 7&15%)            
*              CHANGE AGAIN IS BASED ON BILL RUNDATE                            
*                                                                               
*        NOTE3-AS OF JAN01/08 GST WILL BE 5% AND HST 13% (WAS 6&14%)            
*              CHANGE AGAIN IS BASED ON BILL RUNDATE                            
*                                                                               
*        NOTE4-AS OF JAN01/2013 QST % CHANGE TO 9.975 AND NO                    
*              LONGER CASCADING.  BASIS IS SAME AS GST                          
*              GST NO LONGER INCLUDED IN THE BASIS                              
*        NOTE5-AS OF APR01/2013 BC NO LONGER HAS HST - ONLY GST                 
*              ALSO PE STARTS HST 14.000 %                                      
*                                                                               
*        NOTE6-AS OF JULY1/2016 NB AND NF HST IS 15%                            
*              CHANGE AGAIN IS BASED ON BILL RUNDATE                            
*                                                                               
* *Y2K* HARD-CODED COMPRESSED DATES!                                            
*                                                                               
         DC    AL1(00),C'S',X'5B01',X'FFFF',AL4(5000)  NAT STANDARD             
         DC    AL1(00),C'X',X'5B01',X'FFFF',AL4(0000)  NAT STANDARD             
         DC    AL1(00),C'Z',X'5B01',X'FFFF',AL4(0000)  NAT STANDARD             
*******  DC    AL1(01),C'H',X'7104',X'FFFF',AL4(00000) BRITISH COLUMBIA         
*******  DC    AL1(01),C'X',X'6E07',X'FFFF',AL4(0000)  BRITISH COLUMBIA         
*******  DC    AL1(01),C'Z',X'6E07',X'FFFF',AL4(0000)  BRITISH COLUMBIA         
         DC    AL1(05),C'H',X'6E07',X'FFFF',AL4(13000) ONTARIO                  
         DC    AL1(05),C'X',X'6E07',X'FFFF',AL4(0000)  ONTARIO                  
         DC    AL1(05),C'Z',X'6E07',X'FFFF',AL4(0000)  ONTARIO                  
         DC    AL1(06),C'S',X'5C07',X'FFFF',AL4(9975)  QUEBEC STANDARD          
         DC    AL1(07),C'H',X'6104',X'FFFF',AL4(15000) NEW BRUNSWK              
         DC    AL1(07),C'X',X'6104',X'FFFF',AL4(0000)  NEW BRUNSWK              
         DC    AL1(07),C'Z',X'6104',X'FFFF',AL4(0000)  NEW BRUNSWK              
*****    DC    AL1(08),C'H',X'6104',X'6E06',AL4(13000) NOVA SCOTIA              
*****    DC    AL1(08),C'X',X'6104',X'6E06',AL4(0000)  NOVA SCOTIA              
*****    DC    AL1(08),C'Z',X'6104',X'6E06',AL4(0000)  NOVA SCOTIA              
         DC    AL1(08),C'H',X'6E07',X'FFFF',AL4(15000) NOVA SCOTIA              
         DC    AL1(08),C'X',X'6E07',X'FFFF',AL4(0000)  NOVA SCOTIA              
         DC    AL1(08),C'Z',X'6E07',X'FFFF',AL4(0000)  NOVA SCOTIA              
         DC    AL1(09),C'H',X'6E07',X'FFFF',AL4(14000) P.E. ISLAND              
         DC    AL1(09),C'X',X'6E07',X'FFFF',AL4(0000)  P.E. ISLAND              
         DC    AL1(09),C'Z',X'6E07',X'FFFF',AL4(0000)  P.E. ISLAND              
         DC    AL1(10),C'H',X'6104',X'FFFF',AL4(15000) NEWFOUNDLAND             
         DC    AL1(10),C'X',X'6104',X'FFFF',AL4(0000)  NEWFOUNDLAND             
         DC    AL1(10),C'Z',X'6104',X'FFFF',AL4(0000)  NEWFOUNDLAND             
         DC    X'FF'                                                            
*                                                                               
*                                                                               
         DC    CL8'*VCTAB16A'                                                   
VCTAB16A DS    0D                  TABLE OF VAT CODES - NAT AND PRV             
*                                                                               
*        NOTE1-QST CHANGED TO 7.5% EFFECTIVE WITH BILLING DATE                  
*              JAN02/97. SINCE THE CHANGE IS BASED ON BILL RUN DATE             
*              RATHER THAN MONTH OF SERVICE WE DON'T NEED 2 ENTRIES             
*              FOR QUEBEC IN THE VAT CODE TABLE.                                
*                                                                               
*        NOTE2-AS OF JULY1/06 GST WILL BE 6% AND HST 14% (WAS 7&15%)            
*              CHANGE AGAIN IS BASED ON BILL RUNDATE                            
*                                                                               
*        NOTE3-AS OF JAN01/08 GST WILL BE 5% AND HST 13% (WAS 6&14%)            
*              CHANGE AGAIN IS BASED ON BILL RUNDATE                            
*                                                                               
*        NOTE4-AS OF JAN01/2013 QST % CHANGE TO 9.975 AND NO                    
*              LONGER CASCADING.  BASIS IS SAME AS GST                          
*              GST NO LONGER INCLUDED IN THE BASIS                              
*        NOTE5-AS OF APR01/2013 BC NO LONGER HAS HST - ONLY GST                 
*              ALSO PE STARTS HST 14.000 %                                      
*                                                                               
*        NOTE6-AS OF JULY1/2016 NB AND NF HST IS 15%                            
*              CHANGE AGAIN IS BASED ON BILL RUNDATE                            
*                                                                               
*        NOTE7-AS OF OCT1/2016 PEI HST IS 15%                                   
*              CHANGE AGAIN IS BASED ON BILL RUNDATE                            
*                                                                               
* *Y2K* HARD-CODED COMPRESSED DATES!                                            
*                                                                               
         DC    AL1(00),C'S',X'5B01',X'FFFF',AL4(5000)  NAT STANDARD             
         DC    AL1(00),C'X',X'5B01',X'FFFF',AL4(0000)  NAT STANDARD             
         DC    AL1(00),C'Z',X'5B01',X'FFFF',AL4(0000)  NAT STANDARD             
*******  DC    AL1(01),C'H',X'7104',X'FFFF',AL4(00000) BRITISH COLUMBIA         
*******  DC    AL1(01),C'X',X'6E07',X'FFFF',AL4(0000)  BRITISH COLUMBIA         
*******  DC    AL1(01),C'Z',X'6E07',X'FFFF',AL4(0000)  BRITISH COLUMBIA         
         DC    AL1(05),C'H',X'6E07',X'FFFF',AL4(13000) ONTARIO                  
         DC    AL1(05),C'X',X'6E07',X'FFFF',AL4(0000)  ONTARIO                  
         DC    AL1(05),C'Z',X'6E07',X'FFFF',AL4(0000)  ONTARIO                  
         DC    AL1(06),C'S',X'5C07',X'FFFF',AL4(9975)  QUEBEC STANDARD          
         DC    AL1(07),C'H',X'6104',X'FFFF',AL4(15000) NEW BRUNSWK              
         DC    AL1(07),C'X',X'6104',X'FFFF',AL4(0000)  NEW BRUNSWK              
         DC    AL1(07),C'Z',X'6104',X'FFFF',AL4(0000)  NEW BRUNSWK              
*****    DC    AL1(08),C'H',X'6104',X'6E06',AL4(13000) NOVA SCOTIA              
*****    DC    AL1(08),C'X',X'6104',X'6E06',AL4(0000)  NOVA SCOTIA              
*****    DC    AL1(08),C'Z',X'6104',X'6E06',AL4(0000)  NOVA SCOTIA              
         DC    AL1(08),C'H',X'6E07',X'FFFF',AL4(15000) NOVA SCOTIA              
         DC    AL1(08),C'X',X'6E07',X'FFFF',AL4(0000)  NOVA SCOTIA              
         DC    AL1(08),C'Z',X'6E07',X'FFFF',AL4(0000)  NOVA SCOTIA              
         DC    AL1(09),C'H',X'6E07',X'FFFF',AL4(15000) P.E. ISLAND              
         DC    AL1(09),C'X',X'6E07',X'FFFF',AL4(0000)  P.E. ISLAND              
         DC    AL1(09),C'Z',X'6E07',X'FFFF',AL4(0000)  P.E. ISLAND              
         DC    AL1(10),C'H',X'6104',X'FFFF',AL4(15000) NEWFOUNDLAND             
         DC    AL1(10),C'X',X'6104',X'FFFF',AL4(0000)  NEWFOUNDLAND             
         DC    AL1(10),C'Z',X'6104',X'FFFF',AL4(0000)  NEWFOUNDLAND             
         DC    X'FF'                                                            
*                                                                               
OLDQST   DS    0CL8                                                             
         DC    X'FFFF',X'C421',AL4(6500)  BEFORE   JAN2/98  6.5%                
         DC    X'C422',X'DD9F',AL4(7500)  JAN2/98-DEC31/10  7.5%                
         DC    X'DE21',X'DF9F',AL4(8500)  JAN1/11-DEC31/11  8.5%                
         DC    X'E021',X'E19F',AL4(9500)  JAN1/12-DEC31/12  9.5%                
         DC    X'FF'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*VATACC*'                                                    
VATACCS  DS    0D                  TABLE OF VAT ACCOUNTS - NAT AND PRV          
         ORG   *+(16*(NPROVS+1))                                                
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*VBTAB**'                                                    
VBTAB    DS    0D                  TABLE OF VAT BASES (NAT AND PRV)             
         ORG   *+(VTOTSIZE*MAXLEVS)                                             
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*PSTNAMS'                                                    
PSTNAMS  DS    0D                  TABLE OF GST/PST NAMES- ENG,FRENCH           
         DC    CL14'GST    TPS    '      NATIONAL                               
         DC    CL14'HST-BC HST-BC '                                             
         DC    CL14'PST-AL PST-AL '                                             
         DC    CL14'PST-SA PST-SA '                                             
         DC    CL14'PST-MA PST-MA '                                             
         DC    CL14'HST-ON HST-ON '                                             
         DC    CL14'QST    TVQ    '                                             
         DC    CL14'HST-NB HST-NB '                                             
         DC    CL14'HST-NS HST-NS '                                             
         DC    CL14'HST-PEIHST-PEI'                                             
         DC    CL14'HST-NF HST-NF '                                             
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*AADDRS*'                                                    
AADDRS   DS    0C                  AAA ADDRESS                                  
AADDR1   DS    CL60                                                             
AADDR2   DS    CL60                                                             
AADDR3   DS    CL60                                                             
AADDR4   DS    CL60                                                             
AADDR5   DS    CL60                                                             
*                                                                               
         DS    0D                                                               
         DC    CL8'*BADDRS*'                                                    
BADDRS   DS    0C                  BRAND ADDRESS                                
BADDR1   DS    CL60                                                             
BADDR2   DS    CL60                                                             
BADDR3   DS    CL60                                                             
BADDR4   DS    CL60                                                             
BADDR5   DS    CL60                                                             
*                                                                               
         DS    0D                                                               
         DC    CL8'*CADDRS*'                                                    
CADDRS   DS    0C                  CORPORATE ADDRESS (RETAIL)                   
CADDR1   DS    CL60                                                             
CADDR2   DS    CL60                                                             
CADDR3   DS    CL60                                                             
CADDR4   DS    CL60                                                             
CADDR5   DS    CL60                                                             
*                                                                               
BRKTAB   DS    CL240               TABLE OF SORT/BREAK CONTROLS                 
*                                                                               
         DS    0D                                                               
         DC    CL8'*PEPTWRK'                                                    
PEPTWRK  DS    0D                  WORK SPACE FOR PEPTAB ENTRY                  
         ORG   *+(PEPTABRL)                                                     
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*CLTTAB*'                                                    
CLTTAB   DS    0D                  CLIENT LIST FOR OFFICE CHECK                 
         DC    AL4(CLTBMAX)        MAX                                          
         ORG   *+(CLTBMAX*3)                                                    
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*PBLTAB*'                                                    
PBLTAB   DS    0D                  LIST OF RETAIL PARTIAL BILLING               
         DC    AL4(PBLMAX)         MAX                                          
*********ORG   *+(PBLMAX*8)       **DEFUNCT**(MAY TRY AGAIN)                    
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*PESTAB*'                                                    
PESTAB   DS    0D                  PRD/EST/SCHEME TAB (PARTIAL BILLING)         
         DC    AL4(PESMAX)         MAX                                          
         ORG   *+(PESMAX*4)        PRD(1),EST(1),SCHEME(2)                      
         DC    X'00'                                                            
*                                                                               
RSTATTB  DS    0D                  RETAIL STATUS TABLE                          
         DC    CL8'*RSTATTB'                                                    
         ORG   *+(RSTATTBN*RSTATTBL)                                            
         DC    X'00'                                                            
*                                                                               
BFRTAB   DS    0D                  BILL FORMULA TABLE                           
         DC    CL8'*BFRTAB*'                                                    
         ORG   *+(BFRMAX*BFRTABL)                                               
         DC    X'00'                                                            
*                                                                               
         DS    0D                                                               
         DC    CL8'*MOSLIST'                                                    
MOSLIST  DS    (MAXMOS)XL2         USED IN CALCACT TO DETERMINE                 
         DC    X'00'               WHICH MOS'S TO KEEP                          
*                                                                               
         DS    0D                                                               
         DC    CL8'*WKRBUF*'                                                    
WRKRBUFF DS    14336X                                                           
WRKRBEND EQU   *                                                                
*                                                                               
         DS    0D                                                               
         DC    CL8'*BHOLDTA'                                                    
BHOLDTAB DS    (BHOLDTRL*BHLTBN)X                                               
BHOLDTBL EQU   *-BHOLDTAB                                                       
         SPACE 3                                                                
DICSECT  DS    0D                                                               
*                                                                               
DCLIST   DS    0C                                                               
         DCDDL SP#ABOI,24                                                       
         DCDDL SP#ADJ,10,LABEL=SPBADJ                                           
         DCDDL SP#AGY,12,R                                                      
         DCDDL SP#AGYAM,15,R                                                    
         DCDDL SP#AGYBS,14                                                      
         DCDDL SP#ALL,3                                                         
         DCDDL SP#AMDF,15                                                       
         DCDDL SP#AMNT,14                                                       
         DCDDL SP#AMTDU,16                                                      
         DCDDL SP#ANNC,15,R                                                     
         DCDDL SP#AOR,9                                                         
         DCDDL SP#AORF,44                                                       
         DCDDL SP#AORP,36                                                       
         DCDDL SP#BALDU,14,R                                                    
         DCDDL SP#BASAM,15,R                                                    
         DCDDL SP#BILAM,14,R                                                    
         DCDDL SP#BILLA,14,R                                                    
         DCDDL SP#BILN,14,C                                                     
         DCDDL SP#BILPR,24                                                      
         DCDDL SP#BIL01,44                                                      
         DCDDL SP#BLNG,11                                                       
         DCDDL SP#BLNG,11,C,LABEL=SP2BLNG                                       
         DCDDL SP#BLNGP,14,C                                                    
         DCDDL SP#BRND,16,C,LABEL=SP2BRAND                                      
         DCDDL SP#BRND,6,R,LABEL=SP1BRAND                                       
         DCDDL SP#CALEN,8                                                       
         DCDDL SP#CDAMF,19                                                      
         DCDDL SP#CDAMT,19                                                      
         DCDDL SP#CINO,21                                                       
         DCDDL SP#CLI,6,LABEL=SP6CLI                                            
         DCDDL SP#CLI,7,LABEL=SP7CLI                                            
         DCDDL SP#CMAMT,20                                                      
         DCDDL SP#COMAJ,25                                                      
         DCDDL SP#COMM,5,LABEL=SPACOMM                                          
         DCDDL SP#COMMS,14,R                                                    
         DCDDL SP#CTRL,14,R                                                     
         DCDDL SP#CTRLN,11                                                      
         DCDDL SP#DTLBK,22                                                      
         DCDDL SP#DTLEN,15,R                                                    
         DCDDL SP#DUEDT,12                                                      
         DCDDL SP#EST,8                                                         
         DCDDL SP#ESTSV,16,C                                                    
         DCDDL SP#ESTTL,15                                                      
         DCDDL SP#FOR,3                                                         
         DCDDL SP#GROSS,13,R,LABEL=SP2GROSS                                     
         DCDDL SP#GROSS,5                                                       
         DCDDL SP#GRSAM,12                                                      
         DCDDL SP#GRSAM,14,R,LABEL=SPRGRSAM                                     
         DCDDL SP#GST,6                                                         
         DCDDL SP#GSTAC,15                                                      
         DCDDL SP#INV,7                                                         
         DCDDL SP#INVBK,22                                                      
         DCDDL SP#INVDT,12,LABEL=SP1INVDT                                       
         DCDDL SP#INVDT,14,LABEL=SP2INVDT                                       
         DCDDL SP#LESS,5                                                        
         DCDDL SP#LPB,21                                                        
         DCDDL SP#LSPRV,14,C                                                    
         DCDDL SP#LSTAX,10                                                      
         DCDDL SP#MEDBL,17                                                      
         DCDDL SP#MEDTL,16,F                                                    
         DCDDL SP#MED01,31                                                      
         DCDDL SP#MONTH,6,R                                                     
         DCDDL SP#MRKT,3,LABEL=SPBMKT                                           
         DCDDL SP#MRKT,6,LABEL=SPAMKT                                           
         DCDDL SP#MTHOF,14,R                                                    
         DCDDL SP#MTHSV,16                                                      
         DCDDL SP#NET,12,R,LABEL=SP2NET                                         
         DCDDL SP#NET,3                                                         
         DCDDL SP#NETAM,11                                                      
         DCDDL SP#NETAM,14,R,LABEL=SPRNETAM                                     
         DCDDL SP#NO,3                                                          
         DCDDL SP#NOCOM,22                                                      
         DCDDL SP#NOCCR,29                                                      
         DCDDL SP#NO,5,LABEL=SP5NO                                              
         DCDDL SP#NRAD,15                                                       
         DCDDL SP#NTV,15                                                        
         DCDDL SP#NTWRK,7                                                       
         DCDDL SP#NUM,14,R                                                      
         DCDDL SP#ONLY,11                                                       
         DCDDL SP#ONORD,14,R                                                    
         DCDDL SP#ORD01,75                                                      
         DCDDL SP#PAGE,4                                                        
         DCDDL SP#PCNOF,14,LABEL=SP@PCNOF                                       
         DCDDL SP#PCT,5                                                         
         DCDDL SP#PCTOA,12,LABEL=SPAPCTOA                                       
         DCDDL SP#PCTOA,17,LABEL=SPBPCTOA                                       
         DCDDL SP#PCTOC,20                                                      
         DCDDL SP#PERD,7                                                        
         DCDDL SP#PLUS,4                                                        
         DCDDL SP#PREV,14,C                                                     
         DCDDL SP#PRG,7                                                         
         DCDDL SP#PRG,9,C,LABEL=SP2PRG                                          
         DCDDL SP#PRGTL,16,F                                                    
         DCDDL SP#PRO,7                                                         
         DCDDL SP#PROTL,18                                                      
         DCDDL SP#PRVBL,18                                                      
         DCDDL SP#RMTAD,24                                                      
         DCDDL SP#RVSIN,22,F                                                    
         DCDDL SP#REV01,38,F                                                    
         DCDDL SP#SLTAX,13                                                      
         DCDDL SP#SPOTS,5,R                                                     
         DCDDL SP#SRAD,15                                                       
         DCDDL SP#STATN,7                                                       
         DCDDL SP#STV,15                                                        
         DCDDL SP#TAX,3                                                         
         DCDDL SP#TAX,4,LABEL=SPBTAX                                            
         DCDDL SP#THRU,7                                                        
         DCDDL SP#TLAMT,19                                                      
         DCDDL SP#TLFOR,10                                                      
         DCDDL SP#TOTAL,12,F,LABEL=SPETOTAL                                     
         DCDDL SP#TOTAL,5,LABEL=SP5TOTAL                                        
         DCDDL SP#TOTAL,6,LABEL=SP6TOTAL                                        
         DCDDL SP#TOTAL,7,LABEL=SP7TOTAL                                        
         DCDDL SP#TOTAL,8,LABEL=SP8TOTAL                                        
         DCDDL SP#TSTBL,20                                                      
         DCDDL SP#UNDEF,17                                                      
         DCDDL SP#UNITS,5                                                       
         DCDDL SP#YSOT,19                                                       
DCLISTX  DC    X'00'                                                            
*                                                                               
DSLIST   DS    0C                                                               
         DSDDL                                                                  
DSLISTX  EQU   *                                                                
*                                                                               
         PRINT OFF                                                              
       ++INCLUDE SPDDEQUS                                                       
         PRINT ON                                                               
         SPACE 2                                                                
*                                  BUFFALO CSECT                                
         SPACE 2                                                                
         PRINT GEN                                                              
         BUFF  LINES=00100,ROWS=1,COLUMNS=16,COMMENT=4,FLAVOR=BINARY,  +        
               KEYLIST=(1,A)                                                    
         PRINT NOGEN                                                            
*                                                                               
         DC    50X'00'                                                          
         SPACE 3                                                                
SPB102   CSECT                                                                  
         DS    0H             ALIGN ON HALFWORD-ZERO FOR LARL                   
       ++INCLUDE SPMGRTAB                                                       
         TITLE 'GENERAL STORAGE AREAS'                                          
*          DATA SET SPB102WRK  AT LEVEL 110 AS OF 08/17/00                      
*       BILLING WORK AREA DSECT                                                 
BILWRKD  DSECT                                                                  
*                                                                               
BILWRK   DS    0C                                                               
ABUFFC   DS    A                                                                
APATCH   DS    A                                                                
ABFMOD   DS    A                                                                
AGDAREA  DS    A                                                                
ABILLEDI DS    A                                                                
AGETNUM  DS    A                                                                
ATSAROFF DS    V                                                                
ABRKTAB  DS    A                                                                
ASPGTBFR DS    V                                                                
         SPACE 2                                                                
* THESE ADCONS POINT TO THEIR RESPECTIVE ROWS WITHIN BRKTAB                     
*                                                                               
ABRKS    DS    0F                                                               
APGR1BRK DS    A                                                                
APGR2BRK DS    A                                                                
APGR3BRK DS    A                                                                
APRDBRK  DS    A                                                                
AESTBRK  DS    A                                                                
AMGR1BRK DS    A                                                                
AMGR2BRK DS    A                                                                
AMGR3BRK DS    A                                                                
AMKTBRK  DS    A                                                                
ANETBRK  DS    A                                                                
ASTABRK  DS    A                                                                
APKGBRK  DS    A                                                                
APGMBRK  DS    A                                                                
ADESCBRK DS    A                                                                
APERBRK  DS    A                                                                
APERGBRK DS    A                                                                
ACTYPBRK DS    A                                                                
AFLTBRK  DS    A                                                                
*                                                                               
ABRKS2   DS    0F                                                               
APAGBRK  DS    A         PAGE BREAK LEVEL                                       
ARECAP   DS    A         RECAP (DETAIL BACKUP) BREAK LEVEL                      
AINVBRK  DS    A         INVOICE BREAK LEVEL                                    
APMSELO  DS    A         LOWEST OF PRD/MKT/STATION/EST                          
APEPLO   DS    A         LOWEST OF PRD/EST/PER                                  
APEPHI   DS    A         HIGHEST OF PRD/EST/PER                                 
ALOWBRK  DS    A         LOWEST BREAK LEVEL                                     
ALOWTOG  DS    A         LOWEST OF ALL 'TOGETHERS'                              
AHITOG   DS    A         HIGHEST OF ALL 'TOGETHERS'                             
ATHISBRK DS    A         CURRENT BREAK LEVEL                                    
SVPAGBRK DS    A                                                                
SVLOWTOG DS    A                                                                
ABRKSL   EQU   *-ABRKS                                                          
         SPACE 2                                                                
* THESE ADCONS POINT TO THEIR RESPECTIVE ROWS WITHIN LEVTOTS                    
*                                                                               
         DS    0F                                                               
ATOTS    DS    0CL76                                                            
ACLTTOT  DS    A                                                                
APGR1TOT DS    A                                                                
APGR2TOT DS    A                                                                
APGR3TOT DS    A                                                                
APRDTOT  DS    A                                                                
AESTTOT  DS    A                                                                
AMGR1TOT DS    A                                                                
AMGR2TOT DS    A                                                                
AMGR3TOT DS    A                                                                
AMKTTOT  DS    A                                                                
ANETTOT  DS    A                                                                
ASTATOT  DS    A                                                                
APKGTOT  DS    A                                                                
APGMTOT  DS    A                                                                
ADESCTOT DS    A                                                                
APERTOT  DS    A                                                                
APERGTOT DS    A                                                                
ACTYPTOT DS    A                                                                
AFLTTOT  DS    A                                                                
*                                                                               
ATHISTOT DS    A                                                                
ANXTLIN  DS    A                                                                
         SPACE 2                                                                
* THESE ADCONS POINT TO THEIR RESPECTIVE FIELDS WITHIN THE SORT RECORD          
*                                                                               
         DS    0F                                                               
ALEVS    DS    0CL76                                                            
ACLT     DS    A                                                                
APGR1    DS    A                                                                
APGR2    DS    A                                                                
APGR3    DS    A                                                                
APRD     DS    A                                                                
AEST     DS    A                                                                
AMGR1    DS    A                                                                
AMGR2    DS    A                                                                
AMGR3    DS    A                                                                
AMKT     DS    A                                                                
ANET     DS    A                                                                
ASTA     DS    A                                                                
APKG     DS    A                                                                
APGM     DS    A                                                                
ADESC    DS    A                                                                
APER     DS    A                                                                
APERG    DS    A                                                                
ACTYP    DS    A                                                                
AFLT     DS    A                                                                
*                                                                               
         DS    0F                                                               
LEVCTLS  DS    0CL76                                                            
CLTCTL   DS    F                                                                
PGR1CTL  DS    F                                                                
PGR2CTL  DS    F                                                                
PGR3CTL  DS    F                                                                
PRDCTL   DS    F                                                                
ESTCTL   DS    F                                                                
MGR1CTL  DS    F                                                                
MGR2CTL  DS    F                                                                
MGR3CTL  DS    F                                                                
MKTCTL   DS    F                                                                
NETCTL   DS    F                                                                
STACTL   DS    F                                                                
PKGCTL   DS    F                                                                
PGMCTL   DS    F                                                                
DESCCTL  DS    F                                                                
PERCTL   DS    F                                                                
PERGCTL  DS    F                                                                
CTYPCTL  DS    F                                                                
FLTCTL   DS    F                                                                
*                                                                               
PEPPARS  DS    F                                                                
APEPTAB  DS    F                                                                
PEPTABN  DS    F                                                                
PEPTABL  DS    F                                                                
         DS    2F                                                               
*                                                                               
INVPARS  DS    F                                                                
AINVTAB  DS    F                                                                
INVTABN  DS    F                                                                
INVTABL  DS    F                                                                
         DS    2F                                                               
*                                                                               
BHLPARS  DS    F                                                                
ABHLTAB  DS    F                                                                
BHLTABN  DS    F                                                                
BHLTABL  DS    F                                                                
         DS    2F                                                               
*                                                                               
BPCTPARS DS    F                                                                
ABPCTTAB DS    F                                                                
BPCTTABN DS    F                                                                
BPCTTABL DS    F                                                                
         DS    2F                                                               
*                                                                               
INVBKLEN DS    F                                                                
*                                                                               
SAVRE    DS    F                                                                
NBUFFADR DS    A                                                                
NBUFFLN  DS    A                                                                
AFOTABS  DS    A                                                                
ASPBIL   DS    A                   A(SPLIT BILL RECORD)                         
*                                                                               
*                                  PROFILES                                     
PROFB1   DS    CL16                B1                                           
PROFB1A  DS    CL16                B1A                                          
PROFB1X  DS    CL16                B1X                                          
PROFB2   DS    CL16                B2                                           
PROFB2A  DS    CL16                B2A                                          
PROFB2B  DS    CL16                B2B                                          
PROFB2C  DS    CL16                B2C                                          
PROFB4   DS    CL16                B4                                           
PROFB4A  DS    CL16                B4A                                          
***FBN   DS    CL16                BN                                           
RETPROF  DS    CL16                RETAIL                                       
***FB1S  DS    CL16                B1S (SYSTEMS ONLY)                           
*                                                                               
PROFB1S3 DS    C                   ONLY NEED 1 FIELD                            
PROFBN   DS    CL3                 ONLY NEED 3 FIELDS                           
*                                                                               
         DS    0F                                                               
*RKTAB   DS    CL240               TABLE OF SORT/BREAK CONTROLS                 
SAVPRDC  DS    CL3                                                              
SAVPRD   DS    X                                                                
SAVPGR   DS    XL2                                                              
SAVPGRU  DS    CL4                                                              
SAVMKT   DS    XL2                                                              
SAVMGR   DS    XL2                                                              
SAVMGRU  DS    CL4                                                              
         DS    0F                                                               
X        DS    XL200                                                            
W        DS    CL132                                                            
SAVMODE  DS    X                                                                
EFFDTE   DS    XL2                                                              
*                                                                               
AAAFORM  DS    0CL7                                                             
AAABILDT DS    XL2                                                              
AAABAS   DS    X                                                                
AAACOM   DS    CL4                                                              
*                                                                               
AAEFORM  DS    0CL5                                                             
AAEBAS   DS    X                                                                
AAECOM   DS    XL4                                                              
*                                                                               
PRDFORM  DS    0CL5                                                             
PRDBAS   DS    X                                                                
PRDCOM   DS    XL4                                                              
*                                                                               
ESTFORM  DS    0CL5                                                             
ESTBAS   DS    X                                                                
ESTCOM   DS    XL4                                                              
*                                                                               
STACMOPT DS    C                                                                
SVAMTDUE DS    CL132                                                            
SVINVD   DS    0XL2                                                             
SVINVYR  DS    X                                                                
SVINVMON DS    X                                                                
*                                                                               
SPLITOPT DS    C                                                                
SCBOPT   DS    C                   SEP COMM BILLING (Y,N)                       
SCBNCSW  DS    C                   (N=NET,C=COMM)                               
PCTCTL   DS    C                   PERCENTAGE BILLING CONTROL                   
UDEFESW  DS    XL1                 X'00' - NO EST UDEF CONTROL                  
*                                  X'01' - 1ST EST UDEF REQUIRED                
*                                  X'02' - 2ND EST UDEF REQUIRED                
SPLPARS  DS    F                                                                
ASPLTAB  DS    F                                                                
SPLTABN  DS    F                                                                
         DS    3F                                                               
*                                                                               
BFRPARS  DS    F                   BILL FORMULA TABLE PARS                      
ABFRTAB  DS    F                                                                
BFRTABN  DS    F                                                                
         DS    3F                                                               
BFRMAX   EQU   100                 MAX BILL FORMULAS                            
*                                                                               
MOSOPT   DS    C                                                                
UPDTSOON DS    C                   'Y' = UPDATIVE SOON                          
NOCOMOPT DS    C                   COMMISSION FREE OPTION                       
*                                                                               
SKPPARS  DS    F                   BINSRCH PARS FOR SKIP TABLE                  
ASKPTAB  DS    F                                                                
SKPTABN  DS    F                                                                
         DS    3F                                                               
*                                                                               
A2RQPARS DS    2F                  BINSRCH PARS FOR A2 REQUEST TABLE            
A2NUMREQ DS    F                                                                
         DS    3F                                                               
*                                                                               
SVQSTART DS    CL6                                                              
SVQEND   DS    CL6                                                              
*                                                                               
AORSW    DS    C                                                                
SVAGMINV DS    XL6                                                              
*                                                                               
SVAORS   DS    0C                                                               
SVAORACT DS    CL14                AOR RCVBL/PAYABLE ACCT                       
SVAORPCT DS    XL4                 PCT                                          
SVAORBAS DS    X                   BASIS                                        
SVAOREFF DS    XL2                 EFF DATE                                     
SVAORDA  DS    XL4                 DISK ADDRESS                                 
SVAORVCD DS    0CL1                VAT CODE (OLD TAG)                           
SVAORVCS DS    CL(NPROVS+1)        NAT AND PRV VAT CODES                        
SVAORKIL DS    XL2                 KILL DATE                                    
SVAORMVP DS    XL1                 AOR MAIN PST PROVINCE #                      
SVAORMVC DS    CL1                 AOR MAIN PST CODE                            
SVAORSLQ EQU   *-SVAORS                                                         
*                                                                               
BFMODE   DS    C                                                                
NOBILL   DS    C                                                                
CLTCURR  DS    C                   CLIENT CURRENCY (0=AGENCY)                   
CCSTRT   DS    XL2                 CLIENT CURRENCY START YM                     
CCIDOPT  DS    C                   Y=IDENTIFY CURRENCY                          
CCDETOPT DS    C                   Y=BOTH CURRENCY DETAIL                       
CCTOTOPT DS    C                   Y=BOTH CURRENCY TOTALS                       
CCDETSW  DS    C                   Y=ACTUALLY HAVE 2 CURR DETS (FMTAMT)         
STNCOPT  DS    C                   STATION CURRENCY OPT                         
DARREP   DS    XL2                                                              
MSGSW    DS    C                                                                
CURR2    DS    X                                                                
SINGCOL  DS    C                                                                
RDRFCORP DS    C                                                                
SVVATCDS DS    CL(NPROVS+1)        NAT NAD PRV VAT CODES                        
XPEROPT  DS    C                   CROSS PERIOD BILLING OPTION                  
XPERSW   DS    C                   Y=ACTUALLY HAVE CROSS PERIOD REQ             
PGSW     DS    C                                                                
PGSW2    DS    C                   SPECIAL FISCAL FOR P&G                       
WMTSW    DS    C                   WMT UDEF PRINTING                            
MSSW     DS    C                                                                
WBSW     DS    C                                                                
SVWBSW   DS    C                                                                
MMMSW    DS    C                                                                
TCFSW    DS    C                                                                
BFMIX    DS    C                   MIXED BILL FORMULA                           
LMGSW    DS    C                   GM REGIONAL/LMG                              
EPUDEF   DS    C                                                                
CREDPRN  DS    C                   PRINT CREDIT AMOUNT IN ( )                   
*                                                                               
*                                  CANADIAN GST (VAT) FIELDS                    
CVATCOD  DS    0CL1                VAT CODE (FROM CLT/PRD HDR)-OLD TAG          
CVATCDS  DS    CL(NPROVS+1)        NAT AND PRV VAT CODES                        
CVATSTRT DS    XL2                 YYMM- MOS FOR START OF VAT **Y2K**           
CVATPSW  DS    0CL1                SWITCH FOR MIXED PRODUCT VAT CODES           
CVATPSWS DS    CL(NPROVS+1)        NAT AND PRV                                  
CVATSW   DS    0CL1                Y=BILL ACTUALLY ELIGIBLE FOR VAT             
CVATSWS  DS    CL(NPROVS+1)        NAT AND PRV??                                
*                                                                               
*                                  THE FIELDS BELOW SET FROM                    
*                                  MAIN PST FIELDS ON ON CLIENTS/PRDS           
*                                                                               
NVATCOD  DS    0CL1                VAT CODE                                     
NVATCDS  DS    CL11                NAT AND PRV VAT CODES                        
NVATPSW  DS    0CL1                SWITCH FOR MIXED PRD VAT CODES               
NVATPSWS DS    CL11                NAT AND PRV SWITCH                           
NVATSW   DS    0CL1                Y= IF BILL ELLIGIBLE FOR GST                 
NVATSWS  DS    CL11                NAT AND PRV SWITCHES                         
*                                                                               
HAVUSER  DS    C                                                                
LASTPRD  DS    X                                                                
BFROPT   DS    C                   OPT TO READ NEW BILL FORMULA RECS            
TOTVAT   DS    F                                                                
CNETSTR2 DS    XL2                 2ND CANADIAN NTWK FEATURE START MOS          
CNETOPT  DS    C                                                                
SVSPSTS  DS    XL(NPROVS)          SAVE STATION PSTS                            
SVINVMO  DS    CL6                 INVOICE NUMBER                               
SVINVMED DS    CL2                 MEDIA                                        
BFRMOS   DS    C                                                                
SVSVIMO  DS    CL6                 INVOICE NUMBER                               
IGNDATE  DS    XL2                 IGNORE PREVIOUS ON OR AFTER                  
NOGRSWD  DS    C                   Y=SUPPRESS GORSS COL HEADS                   
ACCSYSOV DS    X                                                                
SVOFF    DS    C                   SAVE OFFICE                                  
SVAGMOCT DS    C                   SAVE AGMOCTL                                 
RD1OPT   DS    C                   RETAIL DRAFT OPT (E=ERRORS ONLY)             
ENDRQSW  DS    C                   Y=HAVE DONE AN ERROR ENDREQ                  
MOLSON   DS    C                   Y=SPECIAL MOLSON OPTION FOR BSNY             
PBLOPT   DS    C                   PARTIAL BILLING OPTION (Y,N)                 
INV#ERR  DS    C                   Y=INVOICE NUMBER EXCEEDS MAX                 
HAVEBILL DS    C                   'Y' = WE HAVE INVOICE REGISTER DATA          
DOINVREG DS    C                   'Y' = USER WANTS INVOICE REGISTER            
OUTDDFLG DS    C                   'Y' = INVOICE REG. DATASET ALLOCATED         
*                                                                               
MANUALS  DS    0F                                                               
MANGRS   DS    F                                                                
MANNET   DS    F                                                                
MANPCT   DS    F                                                                
MANRVNO  DS    H                                                                
MANRVDTP DS    XL2                                                              
MANUALLQ EQU   *-MANUALS                                                        
*                                                                               
NBTOTG   DS    F                                                                
NBTOTN   DS    F                                                                
NBTOTNC  DS    F                                                                
OBTOTG   DS    F                                                                
OBTOTN   DS    F                                                                
OBTOTNC  DS    F                                                                
*                                                                               
CLTPARS  DS    6F                                                               
CLTBMAX  EQU   9000               CLIENT TABLE MAX (WAS 6K)                     
PBLPARS  DS    6F                                                               
PBLMAX   EQU   500                PARTIAL BILLING TABLE MAX                     
*                                                                               
KPRD     DS    X                                                                
KMKT     DS    XL2                                                              
KSTA     DS    XL3                                                              
SAVR1    DS    F                                                                
DASHES   DS    CL35'-'                                                          
ELCODE   DS    X                                                                
SORTTRCE DS    C                                                                
TESTFLAG DS    C                                                                
SAVTRACE DS    C                                                                
DONESW   DS    C                                                                
ACTSW    DS    C                                                                
DUESW    DS    C                                                                
BILSW    DS    C                                                                
LSTOPT   DS    C                                                                
SHOWREV  DS    C                                                                
ZEROSW   DS    C                                                                
ZBOPT    DS    C                                                                
PRSW     DS    C                                                                
CURRSW   DS    X                                                                
ADJSEP   DS    C                                                                
BOXNO    DS    C                                                                
PAYOPT   DS    C                                                                
PARTIAL  DS    C                                                                
PRIOR    DS    C                                                                
BYTE2    DS    X                                                                
PUDEFON  EQU   X'80'                                                            
EUDEFON  EQU   X'40'                                                            
PASSNO   DS    X                                                                
PGRQ     DS    C                                                                
PRDQ     DS    C                                                                
ESTQ     DS    C                                                                
MGRQ     DS    C                                                                
MKTQ     DS    C                                                                
ERR      DS    X                                                                
STAQ     DS    C                                                                
CURRHAV  DS    C                                                                
DATEOPT  DS    C        SET FROM B8 PROFILE - CENTURY                           
DOLSOPT  DS    C        SET FROM B8 PROFILE - $ BEFORE AMOUNT DUE               
BILLADR  DS    C        SET FROM B8 PROFILE 3 READ BILL ADDRESS REC             
*                                                                               
FLAG1    DS    C                                                                
AADDRSW  EQU   X'80'    AAA BILL ADDRESS RECORD FOUND                           
*                                                                               
*                                                                               
PERLIST  DS    (MAXMOS)XL(PERLISTL)                                             
PERLISTX DS    X                   END OF TABLE MARKER                          
PERLSTLQ EQU   *-PERLIST                                                        
*                                                                               
CURPER   DS    XL2                                                              
GNWORK   DS    CL3                                                              
*                                                                               
INVLIST  DS    XL84                14 X 6 (MONTHS X L'INV) - TIME               
INVLIST2 DS    XL84                14 X 6 (MONTHS X L'INV) - INT                
PERDISP  DS    X                                                                
GNSW     DS    C                                                                
COLMNS   DS    X                                                                
BFORMAT  DS    C                                                                
DFORMAT  DS    C                                                                
FORMAT   DS    X                                                                
*                                                                               
TOTSTAR  DS    CL2                                                              
TOTNAME  DS    CL12                                                             
INVNO    DS    H                                                                
PINVNO   DS    CL10                                                             
SINVNO   DS    H                                                                
SPINVNO  DS    CL10                                                             
*                                                                               
PINVDTE  DS    CL10                                                             
EINVDTE  DS    CL6                                                              
BINVDTE  DS    XL3                                                              
BINVDTEP DS    XL2                                                              
*                                                                               
PDUEDTE  DS    CL10                                                             
EDUEDTE  DS    CL6                                                              
BDUEDTE  DS    XL3                                                              
BDUEDTEP DS    XL2                                                              
*                                                                               
NEWSTART DS    XL2                                                              
CTYPQ    DS    C                   COST TYPE REQUESTED                          
SPOTSW   DS    C                                                                
SPOTDTE  DS    XL2                                                              
CTYPSW   DS    C                                                                
RECSW    DS    X                                                                
*                                                                               
NETWFLDS DS    0CL6                                                             
NETWINTC DS    XL4                                                              
NETWPKG  DS    X                                                                
NETWSTAT DS    X                                                                
NONRET   DS    C                                                                
RETDRAFT DS    C                                                                
*                                                                               
SPOTCTL  DS    C                                                                
PROGSW   DS    C                                                                
SPOTNO   DS    X                   ??? DEIS: NEVER GETS SET ???                 
CLMCTLS  DS    CL3                                                              
COMMSW   DS    C                                                                
ZLOPT    DS    C                                                                
ZLSW     DS    C                                                                
PKGREQ   DS    X                                                                
NETOPT   DS    C                                                                
UPASS    DS    C                                                                
LASTAORV DS    0CL1                OLD TAG                                      
LASTAOVS DS    CL(NPROVS+1)        LAST PST CODE SET                            
         DS    0F                                                               
RETERR   DS    X                                                                
RETSKIP  DS    C                                                                
SUMOPT   DS    C                                                                
INVSKIP  DS    C                                                                
*                                                                               
SVPACCT  DS    XL4                 USED FOR WHAT??? DEIS                        
*                                                                               
PRDMKT   DS    C                                                                
TWOCOL   DS    C                                                                
*                                                                               
SUMLEV   DS    C                                                                
PRDSKIP  DS    C                                                                
CORPZ    DS    C                                                                
CRFORMSW DS    C         SWITCH FOR SPECIAL CORP RETAIL BILL FORMULA            
STRIPOPT DS    C                   FOR RETAIL DRAFT-SUPPRESS STRIP              
SVCLUN   DS    CL3                                                              
PROOFSW  DS    C                                                                
MCOMOPT  DS    C                                                                
ECOMOPT  DS    C                                                                
AFFOPT   DS    C                                                                
AORLOPT  DS    C                                                                
AORLCTL  DS    C                                                                
AORTXOPT DS    C                                                                
AORNOPT  DS    C                                                                
MIDAS    DS    C                                                                
*                                                                               
         SPACE 3                                                                
AGMCLNO  DS    C                   PRINT CLIENT INTERFACE NO.                   
AGMSTADT DS    XL2                 START MOS FOR NEW BILLING                    
AGMEXP   DS    CL2                 MEDIA EXPANSION FOR INV. NO.                 
AGMFMT   DS    C                   FMT (1=EX-MM-NNNN, 2=MM-EX-NNNN)             
AGMSEQ   DS    C                   A=AGY, M=MED, C=CLT                          
AGMCLOPT DS    C                                                                
AGMFORMS DS    C                                                                
AGMSTANO DS    H                   STARTING INV NO.                             
AGMSKP1S DS    H                   SKIP FROM HERE                               
AGMSKP1E DS    H                          TO HERE                               
AGMINBY  DS    X                                                                
AGMTITL  DS    C                                                                
AGMOCTL  DS    C                   OFFICE CONTROL                               
TOTSW    DS    C                                                                
LASTMGR  DS    XL2                                                              
SORTRLEN DS    A                                                                
SORTKLEN DS    A                                                                
ASORTDTA DS    A                                                                
ASORTCOM DS    A                                                                
SORTREC  DS    CL100                                                            
SORTKEY  EQU   SORTREC                                                          
THISREC  DS    CL100                                                            
THISKEY  EQU   THISREC                                                          
OLDREC   DS    CL100                                                            
OLDKEY   EQU   OLDREC                                                           
PASSREC  DS    CL100                                                            
PASSKEY  EQU   PASSREC                                                          
*                                                                               
LKUPKEY  DS    CL(L'LOCKEY)        LOCK KEY                                     
*                                                                               
REQHDR   DS    0XL26                                                            
       ++INCLUDE DMREQHDR                                                       
REQUEST  DS    CL80                                                             
*                                                                               
PREVSW   DS    C                                                                
TYPE     DS    C                                                                
ORIGTYPE DS    C                                                                
COST2SW  DS    C                   COST2 ESTIMATE LEVEL SWITCH                  
C2AORSW  DS    C                   TELLS VBCALCA TO USE COST2                   
XXMKT    DS    XL2                                                              
XXSTA    DS    XL3                                                              
NMOS     DS    X                                                                
NDUES    DS    X                                                                
REQYM    DS    XL2                                                              
SVSTAP   DS    XL2                                                              
SVENDP   DS    XL2                                                              
SAVSTRT  DS    CL6                                                              
SAVEND   DS    CL6                                                              
AORFRST  DS    C                                                                
         DS    0F                                                               
WK       DS    XL128                                                            
SAVBRK   DS    A                                                                
DECADE   DS    X                                                                
YEARDIG  DS    X                                                                
OUTMODE  DS    C                                                                
BILMIN   DS    F                                                                
*                                                                               
MGRBKTS  DS    C                                                                
HOLDID   DS    CL12                                                             
CNETSTRT DS    XL2                                                              
HOLDNET  DS    XL3                                                              
THISPER  DS    XL2                                                              
SVMKTCTL DS    X                                                                
SAVSTA   DS    XL3                                                              
TAXSW    DS    C                                                                
TAXOPT   DS    C                                                                
PCTNET   DS    C                                                                
STACITY  DS    CL24                                                             
REBDATP  DS    XL2                 REBILL DATE                                  
BFORMBH  DS    XL5                 BILLFORM FR BILL HEADER (REVERSALS)          
WBFLT    DS    CL10                                                             
*                                                                               
SVTODAYB DS    XL3                                                              
*                                                                               
         DS    0D                                                               
WIBLOCK  DS    CL(SPWIBLKL)        WI OPTION AREA                               
WIOPT    DS    C                                                                
WIPASS   DS    X                                                                
WIOPTC   DS    C                                                                
WIPRSW   DS    X                                                                
WISTRIP  DS    C                                                                
SVWIPRSW DS    X                                                                
*                                                                               
LASTPES  DS    XL4                                                              
LASTMGR4 DS    XL4                                                              
PESPARS  DS    6F                 PRD/EST/SCHEME TABLE                          
PESMAX   EQU   500                FOR RETAIL PARTIAL BILLING                    
MYDMCB   DS    6F                                                               
*                                                                               
LISTSW   DS    C                                                                
INRSQDAT DS    CL6                 INVOICE RESEQUENCE DATE - EBCDIC             
PROFCLT  DS    CL3                 CLIENT CODE TO USE FOR READING PROFS         
INRSQYM  DS    XL2                 INVOICE RESEQUENCE YM                        
INRSQDA  DS    CL2                 AND DATE                                     
*                                                                               
GMICTLS  DS    0CL6                CONTROLS FOR DF-GMI BILLING                  
GMISW    DS    C                   Y=GMI CLIENT                                 
GMIPPRD  DS    C                   Y=PARTICIPATING PRD                          
*                                  (BPRD > X'3F' , EG RED LOBSTER)              
         DS    CL4                                                              
*                                                                               
ARSTATTB DS    A                   A(RETAIL STATUS TABLE ENTRY)                 
*        NOTE- X'80' IN SLOT MEANS OUTLET ACTIVE AT THIS                        
*              LEVEL FOR THIS MONTH                                             
RSTATTBL EQU   MAXMOS+1            ONE SLOT FOR EACH MONTH (+TOTAL)             
RSTATTBN EQU   L'ATOTS/4           ONE ENTRY FOR EACH LEVEL                     
PERNUM   DS    X                                                                
TOTACT   DS    X          TOTOUT SWITCH - USED FOR RETAIL EFF DATES             
*                         - X'80' ACTIVITY SWITCH INTERNAL TO TOTOUT            
*                         - X'40' TOTOUT HAS BEEN CALLED FOR THIS INV           
*                         - X'20' SOME MONTH 'RETAIL ACTIVE'                    
HLDINO   DS    CL10                                                             
REBINV   DS    XL2                                                              
*                                                                               
         DS    0F                                                               
ATOTSV   DS    0CL76               A(VAT TOTALS FOR LEVEL)                      
ACLTTOV  DS    A                                                                
APGR1TOV DS    A                                                                
APGR2TOV DS    A                                                                
APGR3TOV DS    A                                                                
APRDTOV  DS    A                                                                
AESTTOV  DS    A                                                                
AMGR1TOV DS    A                                                                
AMGR2TOV DS    A                                                                
AMGR3TOV DS    A                                                                
AMKTTOV  DS    A                                                                
ANETTOV  DS    A                                                                
ASTATOV  DS    A                                                                
APKGTOV  DS    A                                                                
APGMTOV  DS    A                                                                
ADESCTOV DS    A                                                                
APERTOV  DS    A                                                                
APERGTOV DS    A                                                                
ACTYPTOV DS    A                                                                
AFLTTOV  DS    A                                                                
*                                                                               
         DS    0F                                                               
WKROW    DS    XL(ROWL)                                                         
*                                                                               
PERLIND  DS    F                                                                
PSHPDTE  DS    CL8                                                              
PUMODE   DS    C                                                                
MASPRDCD DS    X                   MASTER PRODUCT CODE                          
WPPOPT   DS    C                                                                
*                                                                               
SAVREG   DS    XL4                                                              
CALCNET  DS    F                                                                
*                                                                               
LWSPARE  EQU   BILWRKD+4095-*                                                   
WSPARE   DS    XL(LWSPARE)                                                      
*                                                                               
SPBVALDD DSECT                                                                  
       ++INCLUDE SPBVALD                                                        
         EJECT                                                                  
SPGBFRDD DSECT                                                                  
       ++INCLUDE SPGETBFRD                                                      
         EJECT                                                                  
       ++INCLUDE SPB1WIBLK                                                      
         EJECT                                                                  
WIRECD   DSECT                                                                  
       ++INCLUDE SPB1WIREC                                                      
         EJECT                                                                  
*        DSECT FOR SORT CONTROL TABLE                                           
         SPACE 2                                                                
BRKTABD  DSECT                                                                  
BRKCODE  DS    F                   CODE                                         
BRKDISP  DS    F                   DISP INTO KEY                                
BRKLENM1 DS    F                   LENGTH - 1                                   
BRKCTL1  DS    X                                                                
BRKCTL2  DS    X                                                                
BRKCTL3  DS    X                                                                
BRKCTL4  DS    X                                                                
BRKCTL5  DS    X                                                                
BRKCTL6  DS    X                                                                
BRKCTL7  DS    X                                                                
BRKCTL8  DS    X                                                                
*                                                                               
BRKINV   EQU   BRKCTL1                                                          
BRKL     EQU   *-BRKTABD                                                        
         SPACE 3                                                                
BRKNAMD  DSECT                                                                  
BRKNCOD  DS    X                   CODE                                         
BRKNNAM  DS    CL10                NAME IN CHARACTER                            
BRKNL    EQU   *-BRKNAMD                                                        
         EJECT                                                                  
PERLISTD DSECT                     DSECT FOR PERLIST ENTRIES                    
PERLMOS  DS    XL2                 MONTH OF SERVICE (YM BINARY)                 
PERLSTRT DS    XL2                 START DATE (COMPRESSED)                      
PERLEND  DS    XL2                 END DATE (COMPRESSED)                        
PERLISTL EQU   *-PERLISTD                                                       
         SPACE 3                                                                
BHOLDTD  DSECT                     TO COVER BILLING HOLD RECS TABLE             
BHLDAM   DS    X                                                                
BHLDCLT  DS    XL2                                                              
BHLDPRD  DS    X                                                                
BHLDEST  DS    X                                                                
BHLDMKS  DS    0XL5                                                             
BHLDMKT  DS    XL2                                                              
BHLDSTA  DS    XL3                                                              
BHLDMOS  DS    XL2                                                              
BHOLDTKL EQU   *-BHOLDTD                                                        
BHLDGRS  DS    FL4                                                              
BHLDNET  DS    FL4                                                              
BHLDTAX  DS    FL4                                                              
BHLDSTA1 DS    X                   STATUS BYTE                                  
BHLDDONE EQU   X'80'               THIS BHOLD WAS THROWN INTO SORT              
BHOLDTRL EQU   *-BHOLDTD                                                        
         SPACE 3                                                                
BPCTD    DSECT                     TO COVER BILLING % RECS TABLE                
BPCTAM   DS    X                                                                
BPCTCLT  DS    XL2                                                              
BPCTPRD  DS    CL3                                                              
         DS    CL3                 POSSIBLE PIGGY                               
BPCTEST  DS    X                                                                
BPCTMOS  DS    XL2                                                              
BPCTKLQ  EQU   *-BPCTD                                                          
BPCTPCT  DS    XL2                                                              
BPCTRLQ  EQU   *-BPCTD                                                          
         SPACE 3                                                                
BFRTABD  DSECT                                                                  
BFRTRADE DS    XL5                                                              
BFRKLQ   EQU   *-BFRTABD                                                        
BFRCASH  DS    XL5                                                              
BFRTABL  EQU   *-BFRTABD                                                        
         SPACE 3                                                                
AAAELSTD DSECT                     DSECT FOR AAAELIST ENTRIES                   
AAAELEST DS    X                   ESTIMATE NUMBER                              
AAAELFOR DS    0CL5                FORMULA                                      
AAAELBAS DS    X                   BASIS                                        
AAAELCOM DS    XL4                 COMMISSION                                   
AAAELSTL EQU   *-AAAELSTD                                                       
         SPACE 3                                                                
*                                  DSECT FOR AMOUNT LINE                        
ALINED   DSECT                                                                  
ALINE    DS    0CL132                                                           
ALDESC   DS    CL20                                                             
         DS    C                                                                
ALCOL1   DS    CL16                                                             
ALCOL2   DS    CL16                                                             
ALCOL3   DS    CL16                                                             
ALCOL4   DS    CL16                                                             
         DS    CL2                                                              
ALCOL4X  EQU   *                                                                
ALSTRIP  DS    CL16                                                             
         DS    CL29                                                             
         SPACE 3                                                                
ILINED   DSECT                     DSECT FOR INV REG LINE                       
ILINE    DS    0CL132                                                           
ILINV    DS    CL9                                                              
         DS    C                                                                
ILPRD    DS    CL3                                                              
         DS    C                                                                
ILEST    DS    CL3                                                              
         DS    CL4                                                              
ILPER    DS    CL6                                                              
         DS    C                                                                
ILTYPE   DS    CL2                                                              
         DS    C                                                                
ILMKT    DS    CL6                                                              
ILCOL2   DS    CL16                                                             
ILCOL3   DS    CL16                                                             
ILCOL4   DS    CL16                                                             
         DS    CL2                                                              
ILSTRIP  DS    CL16                                                             
ILMISC   DS    CL16                                                             
         DS    CL13                                                             
*        DS    CL29                                                             
         SPACE 3                                                                
INVLD    DSECT                     DSECT FOR INVOICE TABLE                      
INVLYR   DS    X                                                                
INVLMO   DS    X                                                                
INVLINV  DS    XL2                                                              
INVYMIL  EQU   *-INVLD                                                          
INVLPRD  DS    X                                                                
INVLEST  DS    X                                                                
INVLMGR  DS    XL2                                                              
INVLMGRC DS    CL4                 UNPACKED VERSION                             
INVLMKT  DS    XL2                                                              
INVLPER  DS    XL2                                                              
INVLCURR DS    X                                                                
         DS    XL2                 SPARE                                        
INVTABKL EQU   *-INVLD                                                          
INVLGRS  DS    XL4                                                              
INVLNET  DS    XL4                                                              
INVLACT  DS    XL4                                                              
INVTABRL EQU   *-INVLD                                                          
         SPACE 3                                                                
SKPTABD  DSECT                     DSECT FOR PRD/EST/MKT/MOS SKIPS              
SKPPRD   DS    X                                                                
SKPEST   DS    X                                                                
SKPMKT   DS    XL2                                                              
SKPMOS   DS    X                                                                
SKIPKEYL EQU   *-SKPTABD                                                        
SKPCTL   DS    X                                                                
SKIPTABL EQU   *-SKPTABD                                                        
SKIPMAX  EQU   5000                MAX SKIP TAB ENTRIES                         
         SPACE 3                                                                
A2REQTBD DSECT                     DSECT FOR A2 REQUEST TABLE                   
A2MEDIA  DS    C                   MEDIA                                        
A2CLT    DS    CL3                 CLIENT                                       
A2PRD    DS    CL3                 PRODUCT                                      
A2EST    DS    CL3                 ESTIMATE                                     
A2REQKYL EQU   *-A2REQTBD                                                       
A2QUESTR DS    CL12                REQUESTOR                                    
A2REQTBL EQU   *-A2REQTBD                                                       
A2REQMAX EQU   5000                MAX A2 REQUEST TABLE ENTRIES                 
         SPACE 3                                                                
NETTABD  DSECT                     DSECT FOR CANADIAN NETWORK TABLE             
NTBCALL  DS    CL4                                                              
NTBPCKD  DS    XL3                                                              
NTBPSTS  DS    CL(NPROVS)                                                       
NETTABL  EQU   *-NETTABD                                                        
MAXNETS  EQU   128                                                              
         SPACE 3                                                                
ECTAXD   DSECT                     CANADIAN TAX DATA FOR EDI                    
ECTAXT   DS    CL7                 TAX TYPE                                     
ECTAXA   DS    CL16                ACCOUNT NUMBER                               
ECTAXP   DS    XL4                 TAX %                                        
ECTAXB   DS    XL4                 TAX BASIS                                    
ECTAX    DS    XL4                 TAX AMOUNT                                   
         SPACE 3                                                                
*                                  DSECT FOR FORMULA INFO                       
BFORMD   DSECT                                                                  
BFBAS    DS    X                   X'10'=NET BILL BASIS                         
*                                  X'01'=NET COMM BASIS                         
*                                  X'80'=COMM ONLY BILL                         
BFCOMP   DS    XL4                                                              
BFRETSHR DS    XL3                                                              
BFAORPCT DS    XL3                                                              
BFVATCOD DS    0CL1                VAT CODE (OLD TAG)                           
BFVATCDS DS    CL(NPROVS+1)                                                     
BFVATSW  DS    0CL1                VAT SWITCH (OLD TAG)                         
BFVATSWS DS    CL(NPROVS+1)                                                     
BFIND    DS    X                   X'80' - HAS BEEN ROLLED UP                   
BFORML   EQU   *-BFORMD                                                         
         EJECT                                                                  
       ++INCLUDE SPRTLBLK                                                       
         EJECT                                                                  
* BREAK NUMBERS IN BRKEQV                                                       
*                                                                               
PGR1EQ   EQU   1                   PRODUCT GROUP 1                              
PGR2EQ   EQU   2                   PRODUCT GROUP 2                              
PGR3EQ   EQU   3                   PRODUCT GROUP 3                              
PRDEQ    EQU   4                   PRODUCT                                      
ESTEQ    EQU   5                   ESTIMATE                                     
MGR1EQ   EQU   6                   MARKET GROUP 1                               
MGR2EQ   EQU   7                   MARKET GROUP 2                               
MGR3EQ   EQU   8                   MARKET GROUP 3                               
MKTEQ    EQU   9                   MARKET                                       
NETEQ    EQU   10                  CANADIAN NETWORK                             
STAEQ    EQU   11                  STATION                                      
PKGEQ    EQU   12                  PACKAGE                                      
PGMEQ    EQU   13                  PROGRAM                                      
DESCEQ   EQU   14                  SPOT DESCRIPTION                             
PEREQ    EQU   15                  PERIOD                                       
PERGEQ   EQU   16                  PERIOD GROUP                                 
CTYPEQ   EQU   17                  COST TYPE                                    
FLTEQ    EQU   18                  FLIGHT                                       
         SPACE 2                                                                
* DISPLACEMENT TO BREAK LEVEL IN BRKEQV                                         
*                                                                               
PGR1DQ   EQU   L'BRKEQV*(PGR1EQ-1) PRODUCT GROUP 1                              
PGR2DQ   EQU   L'BRKEQV*(PGR2EQ-1) PRODUCT GROUP 2                              
PGR3DQ   EQU   L'BRKEQV*(PGR3EQ-1) PRODUCT GROUP 3                              
PRDDQ    EQU   L'BRKEQV*(PRDEQ-1)  PRODUCT                                      
ESTDQ    EQU   L'BRKEQV*(ESTEQ-1)  ESTIMATE                                     
MGR1DQ   EQU   L'BRKEQV*(MGR1EQ-1) MARKET GROUP 1                               
MGR2DQ   EQU   L'BRKEQV*(MGR2EQ-1) MARKET GROUP 2                               
MGR3DQ   EQU   L'BRKEQV*(MGR3EQ-1) MARKET GROUP 3                               
MKTDQ    EQU   L'BRKEQV*(MKTEQ-1)  MARKET                                       
NETDQ    EQU   L'BRKEQV*(NETEQ-1)  CANADIAN NETWORK                             
STADQ    EQU   L'BRKEQV*(STAEQ-1)  STATION                                      
PKGDQ    EQU   L'BRKEQV*(PKGEQ-1)  PACKAGE                                      
PGMDQ    EQU   L'BRKEQV*(PGMEQ-1)  PROGRAM                                      
DESCDQ   EQU   L'BRKEQV*(DESCEQ-1) SPOT DESCRIPTION                             
PERDQ    EQU   L'BRKEQV*(PEREQ-1)  PERIOD                                       
PERGDQ   EQU   L'BRKEQV*(PERGEQ-1) PERIOD GROUP                                 
CTYPDQ   EQU   L'BRKEQV*(CTYPEQ-1) COST TYPE                                    
FLTDQ    EQU   L'BRKEQV*(FLTEQ-1)  FLIGHT                                       
         EJECT                                                                  
MAXMOS   EQU   25                  MAXIMUM NUMBER OF MONTHS                     
RDMAXMOS EQU   12                  LIMIT RETAIL DRAFT TO ONE YEAR               
*                                                                               
*        DSECT FOR ACCUMULATORS                                                 
*                                                                               
*              NOTE- AMOUT FIELDS CONSIST OF 2 XL4 AMOUNTS                      
*                    ONE FOR EACH CURRENCY                                      
*                    FOR CONSISTENCY, THIS IS TRUE FOR SPOT AND                 
*                    PERCENT FIELDS AS WELL AS $ FIELDS                         
*                                                                               
ACMD     DSECT                                                                  
ACMORD   DS    0D                  ORDERED GROSS, NET, TAX,SPOTS                
ACMORDG  DS    2F                                                               
ACMORDN  DS    2F                                                               
ACMORDT  DS    2F                                                               
ACMORDS  DS    2F                                                               
ACMORDLQ EQU   *-ACMORD                                                         
*                                                                               
ACMBIL   DS    0D                  BILLED GROSS, NET, TAX,SPOTS                 
ACMBILG  DS    2F                                                               
ACMBILN  DS    2F                                                               
ACMBILT  DS    2F                                                               
ACMBILS  DS    2F                                                               
ACMBILLQ EQU   *-ACMBIL                                                         
*                                                                               
ACMEXT   DS    0X                                                               
ACMADJ   DS    2F                  ADJUSTMENT AMOUNT                            
ACMDUE   DS    2F                  DUE AMOUNT (WITHOUT VAT)                     
ACMTAX   DS    2F                  SALES TAX AMOUNT                             
ACMAOR   DS    2F                  AOR AMOUNT                                   
ACMEXTBL EQU   *-ACMEXT            LENGTH OF EXTRAS (BASIC ONES ONLY)           
*                                                                               
ACMRETA  DS    2F                  RETAIL AMOUNT DUE                            
ACMRETG  DS    2F                  RETAIL GROSS                                 
ACMRETN  DS    2F                  RETAIL NET                                   
ACMRETVS DS    ((NPROVS+1)*2)F     RETAIL VATS                                  
ACMRETT  DS    2F                  RETAIL TAX                                   
ACMRETP  DS    2F                  RETAIL PERCENT                               
ACMVATS  DS    ((NPROVS+1)*2)F     VATS (MAIN BILL)                             
ACMVATCS DS    ((NPROVS+1)*2)F     VATS (COMM ADJ BILL)                         
ACMVATAS DS    ((NPROVS+1)*2)F     VATS (AOR)                                   
ACMVTBS  DS    ((NPROVS+1)*2)F     VAT BASIS - MAIN BILL                        
ACMVTRBS DS    ((NPROVS+1)*2)F               - RETAIL                           
ACMVTCBS DS    ((NPROVS+1)*2)F               - COMM ADJ                         
*                                                                               
*        DS    XL8                 SPARE                                        
ACMTRDCR DS    XL4                 TRADE CREDIT                                 
         DS    XL4                 SPARE                                        
ACMEXTL  EQU   *-ACMEXT            LENGTH OF EXTRAS                             
ACMDL    EQU   *-ACMD              LENGTH OF DATA                               
*                                                                               
*                                  NOTE - MONTHLY TOTALS ARE FOLLOWED           
*                                  BY AN AREA FOR FORMULA INFO                  
*                                  SEE BFORMD FOR DSECT                         
*                                                                               
ROWL     EQU   ACMDL               FULL MONTHLY ACCUM LENGTH                    
ROWTL    EQU   ACMORDLQ+ACMBILLQ                                                
ROWHL    EQU   ROWTL/2                                                          
ROW$L    EQU   ACMORDS-ACMORD      $ FIELDS ONLY, NOT SPOTS                     
MAXLEVS  EQU   14                                                               
*                                                                               
EXTDSP   EQU   ACMEXT-ACMD         START OF EXTRAS                              
ADJDSP   EQU   ACMADJ-ACMD                                                      
DUEDSP   EQU   ACMDUE-ACMD                                                      
TRDCDSP  EQU   ACMTRDCR-ACMD       TRADE CREDIT                                 
TAXDSP   EQU   ACMTAX-ACMD         TAX AMT                                      
AORDSP   EQU   ACMAOR-ACMD         AOR AMT                                      
RETADSP  EQU   ACMRETA-ACMD        RETAIL ACTUAL SHARE                          
RETGDSP  EQU   ACMRETG-ACMD        REATIL GROSS SHARE                           
RETNDSP  EQU   ACMRETN-ACMD        RETAIL NET SHARE                             
RETVDSP  EQU   ACMRETVS-ACMD       RETAIL VAT                                   
RETTDSP  EQU   ACMRETT-ACMD        RETAIL TAX                                   
RETPDSP  EQU   ACMRETP-ACMD        RETAIL SHARE PCT                             
VATDSP   EQU   ACMVATS-ACMD        VAT (FOR MAIN BILL)                          
VATCDSP  EQU   ACMVATCS-ACMD       VAT (FOR COMM ADJ BILL)                      
VATADSP  EQU   ACMVATAS-ACMD       VAT (AOR)                                    
VATBDSP  EQU   ACMVTBS-ACMD        VAT BASIS - MAIN BILL                        
VATRBDSP EQU   ACMVTRBS-ACMD                 - RETAIL                           
VATCBDSP EQU   ACMVTCBS-ACMD                 - COMM ADJ                         
*                                                                               
RGRSD    EQU   ACMORDG-ACMORD      GROSS     - ORDERED                          
RGRS2D   EQU   ACMORDG-ACMORD+4    GROSS 2                                      
RNETD    EQU   ACMORDN-ACMORD      NET                                          
RNET2D   EQU   ACMORDN-ACMORD+4    NET   2                                      
RTAXD    EQU   ACMORDT-ACMORD      TAX                                          
RTAX2D   EQU   ACMORDT-ACMORD+4    TAX   2                                      
RSPTD    EQU   ACMORDS-ACMORD      SPOTS                                        
RSPT2D   EQU   ACMORDS-ACMORD+4    SPOTS 2                                      
*                                                                               
RBGRSD   EQU   ACMBILG-ACMORD      GROSS     - BILLED                           
RBGRS2D  EQU   ACMBILG-ACMORD+4    GROSS 2                                      
RBNETD   EQU   ACMBILN-ACMORD      NET                                          
RBNET2D  EQU   ACMBILN-ACMORD+4    NET   2                                      
RBTAXD   EQU   ACMBILT-ACMORD      TAX                                          
RBTAX2D  EQU   ACMBILT-ACMORD+4    TAX   2                                      
RBSPTD   EQU   ACMBILS-ACMORD      SPOTS                                        
RBSPT2D  EQU   ACMBILS-ACMORD+4    SPOTS 2                                      
*                                                                               
TOTSIZE  EQU   (MAXMOS+1)*ROWL+BFORML                                           
VTOTSIZE EQU   (MAXMOS+1)*VBTABL*(NPROVS+1)                                     
*                                                                               
*        DSECT FOR PEPTAB                                                       
*                                                                               
*              NOTE- $ FIELDS CONSIST OF 2 XL4 AMOUNTS                          
*                                                                               
PEPTD    DSECT                                                                  
PEPTMGR  DS    XL2                 MARKET GROUP (IF SEPARATE)                   
PEPTMKT  DS    XL2                 MARKET            ""                         
PEPTNTW  DS    XL3                 NETWORK (CAN)     ""                         
PEPTSTA  DS    XL3                 STATION           ""                         
PEPTPRD  DS    X                   PRODUCT                                      
PEPTEST  DS    X                   ESTIMATE                                     
PEPTMOS  DS    XL2                 MOS                                          
PEPTABKL EQU   *-PEPTD                                                          
*                                                                               
         DS    0F                                                               
PEPTGRS  DS    2F                  GROSS                                        
PEPTNET  DS    2F                  NET                                          
PEPTNETC DS    2F                  NET CALCULATED                               
PEPTTRDC DS    2F                  TRADE CREDIT                                 
PEPTADJ  DS    2F                  ADJ                                          
PEPTDUE  DS    2F                  DUE                                          
PEPTTAX  DS    2F                  TAX                                          
PEPTAOR  DS    2F                  AOR                                          
PEPTRETA DS    2F                  RETAIL ACTUAL                                
PEPTRETG DS    2F                  RETAIL GROSS                                 
PEPTRETN DS    2F                  RETAIL NET                                   
PEPTRETV DS    0XL8                RETAIL VAT - OLD TAG                         
PEPTRTVS DS    ((NPROVS+1)*2)F     RETAIL VATS                                  
PEPTRETT DS    2F                  RETAIL TAX                                   
PEPTVAT  DS    0XL8                OLD TAG                                      
PEPTVTS  DS    ((NPROVS+1)*2)F     VATS (FOR MAIN BILL)                         
PEPTVATC DS    0XL8                OLD TAG                                      
PEPTVTCS DS    ((NPROVS+1)*2)F     VATS (FOR COMM ADJ BILL)                     
PEPTVATA DS    0XL8                OLD TAG                                      
PEPTVTAS DS    ((NPROVS+1)*2)F     VATS (AOR)                                   
PEPTVTB  DS    ((NPROVS+1)*2)F     VAT BASIS - MAIN BILL                        
PEPTRVTB DS    ((NPROVS+1)*2)F               - RETAIL                           
PEPTCVTB DS    ((NPROVS+1)*2)F               - COMM ADJ                         
*                                                                               
PEPTPACT DS    XL4                 PRODUCT ACCOUNT                              
PEPTSTAT DS    X                   STATUS                                       
*                                    X'80'  COMMISSION-ONLY BILL                
*                                    X'60'  USED LOCALLY IN WOBILL              
*                                    X'10'  RETAIL 'ACTIVE MONTH'               
PEPTAORA DS    CL14                AOR RCVBL/PAYABLE ACCT                       
PEPTAORV DS    0CL1                OLD TAG                                      
PEPTAOVS DS    CL(NPROVS+1)        AOR OTHER AGENCY VAT CODES                   
PEPTAORP DS    XL4                 AOR PCT                                      
PEPTAORB DS    X                   AORBAS                                       
PEPTAORD DS    XL4                 AOR RECORD DISK ADDRESS                      
PEPTAORI DS    XL2                 AOR INVOICE NUMBER                           
PEPTMGRN DS    CL24                MGR NAME (LOWEST LEVEL)                      
PEPTBFP  DS    XL4                 BILL FORMULA PCT                             
PEPTBFB  DS    X                   AND BASIS                                    
PEPTBFFL DS    X                   BILL FORMULA BASE FLAGS (B2A)                
PEPTBATX EQU   X'80'               AORTXOPT, INCLUDE TAX IN AOR BASIS           
*                                                                               
PEPTVCD  DS    0CL1                OLD TAG                                      
PEPTVCDS DS    CL(NPROVS+1)        VAT CODE                                     
PEPTVSW  DS    0CL1                OLD TAG                                      
PEPTVSWS DS    CL(NPROVS+1)        Y=BILL ACTUALLY VATABLE                      
         DS    XL2                 SPARE                                        
PEPTFLT  DS    CL10                WB FLIGHT                                    
*                                                                               
PEPTABRL EQU   *-PEPTD                                                          
*                                                                               
PEPTBN   EQU   1000                                                             
INVTBN   EQU   7000                WAS 5000 (CHANGED BY YKVA FEB14/03)          
BHLTBN   EQU   500                                                              
BPCTTBN  EQU   5000                                                             
LINTABN  EQU   2000                USED TO BE 1600                              
NPROVS   EQU   10                  NUMBER OF CANADIAN PROVINCES                 
ADDRLEN  EQU   5*60                5 LINES OF 60 EACH                           
*                                  PRD SPLIT TABLE EQUATES                      
SPLTABRL EQU   2+(SPLTSMAX*SPLTSLEN)   PRD/EST + SHARES                         
SPLTSMAX EQU   20                  MAXIMUM SHARES                               
SPLTSLEN EQU   3                   LENGTH OF SHARE ENTRY                        
SPLTPMAX EQU   2000                MAX PRD/ESTS TO BE SPLIT (WAS 1000)          
         SPACE 2                                                                
*        DSECT FOR VAT CODE TABLE                                               
VCTABD   DSECT                                                                  
VCTPRV   DS    X                   PROVINCE                                     
VCTVCD   DS    C                   VAT CODE                                     
VCTSTRT  DS    XL2                 START MOS                                    
VCTEND   DS    XL2                 END MOS                                      
VCTPCT   DS    XL4                 VAT PCT                                      
VCTABL   EQU   *-VCTABD                                                         
         SPACE 2                                                                
*        DSECT FOR VAT BASE TABLE                                               
*                                                                               
*              DSECT COVERS ENTRY IN TABLE OF PROVINCES                         
*              WITHIN MONTHS WITHIN LEVELS                                      
*                                                                               
VBTABD   DSECT                                                                  
VBTGRS   DS    2F                  GROSS - ROOM FOR 2 CURRENCIES                
VBTNET   DS    2F                  NET                                          
VBTTAX   DS    2F                  TAX (SALES)                                  
VBTBLBN  EQU   (*-VBTABD)/4        COUNT OF BILLABLE FIELDS                     
VBTADJ   DS    2F                  COMMISSION ADJUSTMENT                        
VBTDUE   DS    2F                  DUE AMOUNT                                   
VBTVAT   DS    2F                  VAT AMOUNT                                   
VBTVATB  DS    2F                  VAT BASIS                                    
VBTBLTN  EQU   (*-VBTABD)/4        COUNT OF 'TOTALABLE' FIELDS                  
VBTPCT   DS    XL4                 VAT PERCENT                                  
VBTCOD   DS    C                   VAT CODE                                     
         DS    XL3                 SPARE                                        
VBTABL   EQU   *-VBTABD                                                         
         EJECT                                                                  
         PRINT OFF                                                              
       ++INCLUDE SPBILLEDID                                                     
         EJECT                                                                  
       ++INCLUDE SPREPWORKD                                                     
         PRINT ON                                                               
         ORG   QAREA+35                                                         
QDUEDAYS DS    CL2                                                              
         ORG   QAREA+49                                                         
QMANUAL  DS    CL12                                                             
         ORG   Q2USER                                                           
QINVDATE DS    CL6                 INVOICE DATE                                 
QPROFCLT DS    CL3                 CLIENT CODE TO USE FOR PROFILES              
         DS    CL1                                                              
QFRATE   DS    CL1                 SPECIAL FOR FRATE BUYS                       
QGMITVC  DS    C                   FOR GMI, C=CASH, T=TRADE BILLING)            
QRETCD   DS    C                   SPECIAL RETAIL, C=CREDIT, D=DEBIT            
QRETOUT  DS    CL7                 SPECIAL RETAIL, OUTLET CODE                  
QTRADE   DS    CL1                 FOR GROUP M C=CASH, T=TRADE BILLING          
         DS    CL1                 SPARE                                        
QPRIOR   DS    0CL3                                                             
QPRIORMO DS    CL2                 NUMBER OF PRIOR MONTHS                       
QPRIORMD DS    C                   ONLY 'T' (TOGETHER) SUPPORTED NOW            
         DS    CL3                 SPARE                                        
QINVREG  DS    C                   'R' = GENERATE INVOICE REGISTER              
         DS    CL3                 SPARE                                        
QLMG     DS    CL1                 GM LMG/REGIONAL FLAG                         
QFLT     DS    CL10                WB FLIGHT                                    
QB2OVRD  DS    CL1                 OVERRIDE ADJSEP SETTING                      
         ORG                                                                    
         EJECT                                                                  
BILLRECD DSECT                                                                  
       ++INCLUDE SPGENBILL                                                      
         EJECT                                                                  
       ++INCLUDE SPGENSTAB                                                      
         PRINT OFF                                                              
         EJECT                                                                  
SSBD     DSECT                                                                  
       ++INCLUDE FASSBOFF                                                       
         EJECT                                                                  
AGYHDRD  DSECT                                                                  
       ++INCLUDE SPGENAGY                                                       
         EJECT                                                                  
CLTHDRD  DSECT                                                                  
       ++INCLUDE SPGENCLT                                                       
         EJECT                                                                  
PRDHDRD  DSECT                                                                  
       ++INCLUDE SPGENPRD                                                       
         EJECT                                                                  
ESTHDRD  DSECT                                                                  
       ++INCLUDE SPGENEST                                                       
         EJECT                                                                  
BUYRECD  DSECT                                                                  
       ++INCLUDE SPGENBUY                                                       
         EJECT                                                                  
STARECD  DSECT                                                                  
       ++INCLUDE SPGENSTA                                                       
         EJECT                                                                  
ADDRECD  DSECT                                                                  
       ++INCLUDE SPGENADD                                                       
         EJECT                                                                  
COMHDRD  DSECT                                                                  
       ++INCLUDE SPGENCOM                                                       
         EJECT                                                                  
CLTPHDRD DSECT                                                                  
       ++INCLUDE SPGENCLTO                                                      
         EJECT                                                                  
       ++INCLUDE SPGENAOR                                                       
         EJECT                                                                  
       ++INCLUDE SPGENADR                                                       
         EJECT                                                                  
       ++INCLUDE SPGENBHOLD                                                     
         EJECT                                                                  
       ++INCLUDE SPGENBPCT                                                      
         EJECT                                                                  
       ++INCLUDE SPGENPRG                                                       
         EJECT                                                                  
       ++INCLUDE SPGENMKG                                                       
         EJECT                                                                  
       ++INCLUDE SPREPMODES                                                     
         EJECT                                                                  
       ++INCLUDE SPMEDBLOCK                                                     
         EJECT                                                                  
       ++INCLUDE DDUCOMD                                                        
         EJECT                                                                  
       ++INCLUDE DDTSARD                                                        
         EJECT                                                                  
       ++INCLUDE DMWRKFK                                                        
         EJECT                                                                  
       ++INCLUDE DMWRKFL                                                        
         EJECT                                                                  
       ++INCLUDE DMWRKFD                                                        
         EJECT                                                                  
*INCLUDE DDBUFFALOD                                                             
       ++INCLUDE DDBUFFALOD                                                     
         EJECT                                                                  
         PRINT ON                                                               
       ++INCLUDE SPGENSPBL                                                      
         EJECT                                                                  
       ++INCLUDE SPGENNDEF                                                      
         EJECT                                                                  
       ++INCLUDE DDGETPROFD                                                     
         EJECT                                                                  
       ++INCLUDE DDOFFICED                                                      
         EJECT                                                                  
*                                                                               
*SPGENPRG/DDLOGOD/DDMASTD/DDDICTATED                                            
         PRINT OFF                                                              
       ++INCLUDE DDLOGOD                                                        
         EJECT                                                                  
       ++INCLUDE DDMASTD                                                        
         EJECT                                                                  
       ++INCLUDE DDDICTATED                                                     
         EJECT                                                                  
       ++INCLUDE DDCOMFACSD                                                     
         EJECT                                                                  
       ++INCLUDE DDCOREQUS                                                      
         EJECT                                                                  
       ++INCLUDE FALOCKETD                                                      
         EJECT                                                                  
       ++INCLUDE DDSMTPD                                                        
TIOTD    DSECT                                                                  
         IEFTIOT1                                                               
         PRINT ON                                                               
*                                                                               
SPB102   CSECT                                                                  
         SPACE 3                                                                
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'177SPREPB102 01/19/21'                                      
         END                                                                    
